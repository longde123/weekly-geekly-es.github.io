<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüëß‚Äçüë¶ üë©‚Äçüë©‚Äçüë¶‚Äçüë¶ üèôÔ∏è L√≥gica de neg√≥cios ass√≠ncrona nos dias de hoje üå¥ üë©üèª‚Äç‚úàÔ∏è üí´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Em resumo: 


- A prova j√° est√° implementada em C ++ , JS e PHP , adequada para Java . 
- Mais r√°pido que a corotina e o Promise, mais recursos. 
- N√£...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>L√≥gica de neg√≥cios ass√≠ncrona nos dias de hoje</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/424311/"><p>  Em resumo: </p><br><blockquote><ul><li>  A prova j√° est√° implementada em <strong>C ++</strong> , <strong>JS</strong> e <strong>PHP</strong> , adequada para <strong>Java</strong> . </li><li> <strong>Mais r√°pido</strong> que a corotina e o Promise, mais recursos. </li><li>  N√£o requer uma pilha de software separada. </li><li>  Amiga todas as ferramentas de seguran√ßa e depura√ß√£o. </li><li>  Ele funciona em qualquer arquitetura e n√£o requer sinalizadores especiais do compilador. </li></ul><br></blockquote><a name="habracut"></a><br><hr><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Olhe para tr√°s</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">FutoIn AsyncSteps - uma alternativa √†s corotinas</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Para os n√∫meros</a> </li></ul><br><h2 id="vzglyad-nazad">  Olhe para tr√°s </h2><br><p>  No in√≠cio do computador, havia um √∫nico fluxo de controle com bloqueio na entrada e sa√≠da.  Em seguida, foram adicionadas interrup√ß√µes de ferro.  Agora voc√™ pode efetivamente usar dispositivos lentos e imprevis√≠veis. </p><br><p>  Com o crescimento das capacidades de ferro e sua baixa disponibilidade, tornou-se necess√°rio executar v√°rias tarefas simultaneamente, o que forneceu suporte de hardware.  Portanto, houve processos isolados com interrup√ß√µes abstra√≠das do ferro na forma de sinais. </p><br><p>  O pr√≥ximo est√°gio evolutivo foi o multithreading, implementado com base nos mesmos processos, mas com acesso compartilhado √† mem√≥ria e outros recursos.  Essa abordagem tem suas limita√ß√µes e uma sobrecarga significativa para alternar para um sistema operacional seguro. </p><br><p>  Para comunica√ß√£o entre processos e at√© m√°quinas diferentes, a abstra√ß√£o Promise / Future foi proposta h√° mais de 40 anos. </p><br><p>  As interfaces com o usu√°rio e o rid√≠culo problema do cliente de 10K levaram ao auge das abordagens Event Loop, Reactor e Proactor, mais orientadas a eventos do que uma l√≥gica comercial clara e consistente. </p><br><p>  Finalmente, chegamos √† corotina moderna (corotina), que em ess√™ncia √© uma emula√ß√£o de fluxos sobre as abstra√ß√µes descritas acima, com as correspondentes limita√ß√µes t√©cnicas e transfer√™ncia determin√≠stica de controle. </p><br><p>  Para transmitir eventos, resultados e exce√ß√µes, todos retornaram ao mesmo conceito de Promessa / Futuro.  Alguns escrit√≥rios decidiram nomear um pouco diferente - "Tarefa". </p><br><p> No final, eles ocultaram tudo em um belo pacote <code>async/await</code> , que requer suporte do compilador ou tradutor, dependendo da tecnologia. </p><br><h3 id="problemy-s-tekuschiy-situaciy-asinhronnoy-biznes-logiki">  Problemas com situa√ß√µes atuais de l√≥gica de neg√≥cios ass√≠ncronas </h3><br><p>  Considere apenas corotinas e Promessa, decoradas com <code>async/await</code> , como  a exist√™ncia de problemas em abordagens mais antigas confirma o pr√≥prio processo de evolu√ß√£o. </p><br><p>  Esses dois termos n√£o s√£o id√™nticos.  Por exemplo, no ECMAScript n√£o h√° corotinas, mas h√° um al√≠vio sint√°tico para o uso do <code>Promise</code> , que por sua vez s√≥ organiza o trabalho com o inferno de retorno de chamada.  De fato, mecanismos de script como o V8 v√£o mais longe e fazem otimiza√ß√µes especiais para fun√ß√µes e chamadas puramente <code>async/await</code> . </p><br><p>  Especialistas <code>co_async/co_await</code> que n√£o se enquadrava no C ++ 17 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui no recurso</a> , mas a press√£o das corotinas gigantes de software pode aparecer no padr√£o exatamente em sua forma.  Enquanto isso, a solu√ß√£o tradicionalmente reconhecida √© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Boost.Context</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Boost.Fiber</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Boost.Coroutine2</a> . </p><br><p>  Em Java, ainda n√£o h√° <code>async/await</code> no n√≠vel da linguagem, mas existem solu√ß√µes como o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">EA Async</a> , que, como o Boost.Context, precisam ser customizadas para cada vers√£o da JVM e byte de c√≥digo. </p><br><p>  O Go tem suas pr√≥prias rotinas, mas se voc√™ examinar com aten√ß√£o os artigos e os relat√≥rios de erros de projetos abertos, acontece que aqui tudo n√£o √© t√£o tranquilo.  Talvez perder a interface da corotina como entidade gerenciada n√£o seja uma boa ideia. </p><br><h4 id="mnenie-avtora-soprogrammy-na-golom-zheleze-opasny">  Opini√£o do autor: coroutines bare-metal s√£o perigosas </h4><br><p>  Pessoalmente, o autor tem pouco contra corotinas em linguagens din√¢micas, mas √© extremamente cauteloso com qualquer flerte com a pilha no n√≠vel do c√≥digo da m√°quina. </p><br><p>  Alguns pontos: </p><br><ol><li>  Pilha necess√°ria: <br><ul><li>  a pilha na pilha tem v√°rias desvantagens: problemas de determina√ß√£o oportuna do estouro, danos por vizinhos e outros problemas de confiabilidade / seguran√ßa, </li><li>  uma pilha segura requer pelo menos uma p√°gina de mem√≥ria f√≠sica, uma p√°gina condicional e sobrecarga adicional para cada chamada para fun√ß√µes <code>async</code> : 4 + KB (m√≠nimo) + limites de sistema aumentados, </li><li>  em √∫ltima an√°lise, pode ser que uma parte significativa da mem√≥ria alocada para as pilhas n√£o seja usada durante o tempo de inatividade da corotina. </li></ul></li><li>  √â necess√°rio implementar uma l√≥gica complexa de salvar, restaurar e excluir o estado das corotinas: <br><ul><li>  para todos os casos de arquitetura de processador (modelos pares) e interface bin√°ria (ABI): <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">exemplo</a> , </li><li>  os recursos de arquitetura nova ou opcional apresentam problemas potencialmente latentes (por exemplo, co-processadores Intel TSX, ARM ou MIPS), </li><li>  outros problemas em potencial devido √† documenta√ß√£o fechada dos sistemas propriet√°rios (a documenta√ß√£o do Boost se refere a isso). </li></ul></li><li>  Problemas potenciais com ferramentas de an√°lise din√¢mica e com seguran√ßa em geral: <br><ul><li>  por exemplo, a integra√ß√£o com o Valgrind √© necess√°ria devido √†s mesmas pilhas de salto, </li><li>  √© dif√≠cil falar em antiv√≠rus, mas provavelmente eles n√£o gostam muito do exemplo de problemas com a JVM no passado, </li><li>  Tenho certeza de que novos tipos de ataques aparecer√£o e ser√£o reveladas vulnerabilidades associadas √† implementa√ß√£o de corotinas. </li></ul></li></ol><br><h4 id="mnenie-avtora-generatory-i-yield-principialnoe-zlo">  Opini√£o do autor: geradores e <code>yield</code> mal fundamental </h4><br><p>  Esse tema aparentemente de terceiros est√° diretamente relacionado ao conceito de corotinas e √† propriedade "continue". </p><br><p>  Em resumo, um iterador completo deve existir para qualquer cole√ß√£o.  Por que criar um problema de gerador de iterador recortado n√£o est√° claro.  Por exemplo, um caso com <code>range()</code> em Python √© mais um show exclusivo do que uma desculpa para complica√ß√µes t√©cnicas. </p><br><p>  Se o caso for um gerador infinito, a l√≥gica de sua implementa√ß√£o √© elementar.  Por que criar dificuldades t√©cnicas adicionais para impulsionar um ciclo cont√≠nuo sem fim. </p><br><p>  A √∫nica justificativa sensata que mais tarde surgiu, que os defensores das corotinas d√£o √© todo tipo de analisador de fluxo com controle invertido.  De fato, esse √© um caso especializado restrito para resolver problemas √∫nicos no n√≠vel da biblioteca, n√£o a l√≥gica de neg√≥cios dos aplicativos.  Ao mesmo tempo, existe uma solu√ß√£o elegante, simples e mais descritiva atrav√©s de m√°quinas de estados finitos.  A √°rea desses problemas t√©cnicos √© muito menor que a √°rea da l√≥gica comercial comum. </p><br><p>  De fato, o problema a ser resolvido √© obtido com um dedo e requer esfor√ßos relativamente s√©rios para a implementa√ß√£o inicial e o suporte a longo prazo.  Tanto √© assim que alguns projetos podem introduzir uma proibi√ß√£o no uso de corotinas no n√≠vel de c√≥digo de m√°quina, seguindo o exemplo de uma proibi√ß√£o de <code>goto</code> ou o uso de aloca√ß√£o din√¢mica de mem√≥ria em ind√∫strias individuais. </p><br><h4 id="mnenie-avtora-model-asyncawait-na-promise-iz-ecmascript-bolee-nadyozhna-no-trebuet-adaptacii">  Opini√£o dos autores: O modelo <code>async/await</code> do ECMAScript Promise √© mais confi√°vel, mas requer adapta√ß√£o </h4><br><p>  Diferentemente das corotinas cont√≠nuas, nesse modelo as partes do c√≥digo s√£o secretamente divididas em blocos ininterruptos, projetados como fun√ß√µes an√¥nimas.  No C ++, isso n√£o √© totalmente adequado devido √†s peculiaridades do gerenciamento de mem√≥ria, um exemplo: </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeObject</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Value = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;; <span class="hljs-function"><span class="hljs-function">Promise </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">funcPromise</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Promise.resolved(value_); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">funcCallback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::function&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">()&gt; &amp;&amp;cb, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Value&amp; val)</span></span></span><span class="hljs-function"> </span></span>{ somehow_call_later(cb); } Value value_; }; <span class="hljs-function"><span class="hljs-function">Promise </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">example</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ SomeObject some_obj; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> some_obj.funcPromise() .<span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>([](<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::exception &amp;e){ <span class="hljs-comment"><span class="hljs-comment">// ... }) .then([&amp;](SomeObject::value &amp;&amp;val){ return Promise([&amp;](Resolve&amp;&amp; resolve, Reject&amp;&amp;){ some_obj.funcCallback(resolve, val); }); }); }</span></span></code> </pre> <br><p>  Primeiramente, <code>some_obj</code> ser√° destru√≠do ao sair de <code>example()</code> e antes de chamar fun√ß√µes lambda. </p><br><p>  Em segundo lugar, fun√ß√µes lambda com captura de vari√°veis ‚Äã‚Äãou refer√™ncias s√£o objetos e secretamente adicionam copiar / mover, o que pode afetar negativamente o desempenho com um grande n√∫mero de capturas e a necessidade de alocar mem√≥ria no heap durante o apagamento de tipo na <code>std::function</code> usual. </p><br><p>  Em terceiro lugar, a pr√≥pria interface <code>Promise</code> foi concebida com base no conceito de "promessa" do resultado, e n√£o na execu√ß√£o consistente da l√≥gica de neg√≥cios. </p><br><p>  Uma solu√ß√£o esquem√°tica N√ÉO √≥tima pode ser algo como isto: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Promise </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">example</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LocalContext</span></span></span><span class="hljs-class"> {</span></span> SomeObject some_obj; }; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> ctx = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_shared&lt;LocalContext&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> some_obj.funcPromise() .<span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>([](<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::exception &amp;e){ <span class="hljs-comment"><span class="hljs-comment">// ... }) .then([ctx](SomeObject::Value &amp;&amp;val){ struct LocalContext2 { LocalContext2(std::shared_ptr&lt;LocalContext&gt; &amp;&amp;ctx, SomeObject::Value &amp;&amp;val) : ctx(ctx), val(val) {} std::shared_ptr&lt;LocalContext&gt; ctx; SomeObject::Value val; }; auto ctx2 = std::make_shared&lt;LocalContext2&gt;( std::move(ctx), std::forward&lt;SomeObject::Value&gt;(val) ); return Promise([ctx2](Resolve&amp;&amp; resolve, Reject&amp;&amp;){ ctx2-&gt;ctx-&gt;some_obj.funcCallback([ctx2, resolve](){ resolve(); }, val); }); }); }</span></span></code> </pre> <br><p>  <em>Nota: <code>std::move</code> vez de <code>std::shared_ptr</code> n√£o <code>std::shared_ptr</code> adequado devido √† incapacidade de transferir para v√°rias lambdas de uma s√≥ vez e ao crescimento de seu tamanho.</em> </p><br><p>  Com a adi√ß√£o de <code>async/await</code> os horrores ass√≠ncronos entram em um estado diger√≠vel: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">async </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">example</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ SomeObject some_obj; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { SomeObject::Value val = await some_obj.func(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::exception&amp; e) ( <span class="hljs-comment"><span class="hljs-comment">// ... } // Capture "async context" return Promise([async](Resolve&amp;&amp; resolve, Reject&amp;&amp;){ some_obj.funcCallback([async](){ resolve(); }, val); }); }</span></span></code> </pre> <br><h4 id="mnenie-avtora-planirovschik-soprogramm---eto-perebor">  Opini√£o do autor: planejador de corotina √© um fracasso </h4><br><p>  Alguns cr√≠ticos consideram a falta de um agendador e o uso "desonesto" dos recursos do processador.  Talvez um problema mais s√©rio seja a localidade dos dados e o uso eficiente do cache do processador. </p><br><p>  No primeiro problema: a prioriza√ß√£o no n√≠vel das corotinas individuais parece uma grande sobrecarga.  Em vez disso, eles podem ser operados em comum para uma tarefa unificada espec√≠fica.  √â isso que os fluxos de tr√°fego fazem. </p><br><p>  Isso √© poss√≠vel criando inst√¢ncias separadas do Event Loop com seus pr√≥prios threads "de ferro" e planejando no n√≠vel do SO.  A segunda op√ß√£o √© sincronizar corotinas com uma primitiva relativamente primitiva (Mutex, Throttle) em termos de competi√ß√£o e / ou desempenho. </p><br><p>  A programa√ß√£o ass√≠ncrona n√£o torna os recursos do processador flex√≠veis e requer restri√ß√µes absolutamente normais no n√∫mero de tarefas processadas simultaneamente e limites no tempo total de execu√ß√£o. </p><br><p>  A prote√ß√£o contra bloqueios prolongados em uma rotina exige as mesmas medidas dos retornos de chamada - para evitar o bloqueio de chamadas do sistema e longos ciclos de processamento de dados. </p><br><p>  O segundo problema requer pesquisa, mas pelo menos a rotina se empilha e os detalhes da implementa√ß√£o do Futuro / Promessa j√° violam a localidade dos dados.  Existe a oportunidade de tentar continuar a execu√ß√£o da mesma rotina, se o futuro j√° interessar.  √â necess√°rio um certo mecanismo para calcular o tempo de execu√ß√£o ou o n√∫mero de tais continua√ß√µes, a fim de impedir que uma corotina capture o tempo inteiro do processador.  Isso pode n√£o resultar em resultados duplos, dependendo do tamanho do cache do processador e do n√∫mero de threads. </p><br><p>  H√° tamb√©m um terceiro ponto - muitas implementa√ß√µes de agendadores de corotina permitem execut√°-los em diferentes n√∫cleos de processador, o que, pelo contr√°rio, adiciona problemas devido √† sincroniza√ß√£o obrigat√≥ria ao acessar recursos compartilhados.  No caso de um √∫nico fluxo de Loop de Eventos, essa sincroniza√ß√£o √© necess√°ria apenas no n√≠vel l√≥gico, pois  √â garantido que cada bloco de retorno de chamada s√≠ncrono funcione sem uma corrida com outras pessoas. </p><br><h4 id="mnenie-avtora-vsyo-horosho-v-meru">  Opini√£o do autor: tudo √© bom com modera√ß√£o </h4><br><p>  A presen√ßa de threads em sistemas operacionais modernos n√£o nega o uso de processos individuais.  Al√©m disso, o processamento de um grande n√∫mero de clientes no Event Loop n√£o nega o uso de threads "iron" isolados para outras necessidades. </p><br><p>  De qualquer forma, as corotinas e v√°rias variantes dos Loops de Eventos complicam o processo de depura√ß√£o sem o suporte necess√°rio nas ferramentas, e com as vari√°veis ‚Äã‚Äãlocais na pilha de corotinas, tudo se torna ainda mais dif√≠cil - praticamente n√£o h√° como chegar a elas. </p><br><hr><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2p/pp/lb/2ppplbzrvm8c0yvbasdwrojknss.png" width="326" height="326"></div><br><h2 id="futoin-asyncsteps---alternativa-soprogrammam">  FutoIn AsyncSteps - uma alternativa √†s corotinas </h2><br><p>  Tomamos como base o j√° estabelecido padr√£o de loop de eventos e a organiza√ß√£o de esquemas de retorno de chamada de acordo com o tipo de promessa ECMAScript (JavaScript). </p><br><p>  Em termos de planejamento de execu√ß√£o, estamos interessados ‚Äã‚Äãnas seguintes atividades do Event Loop: </p><br><ol><li>  <code>Handle immediate(callack)</code> exija uma pilha de chamadas limpa. </li><li>  Retorno de chamada <code>Handle deferred(delay, callback)</code> . </li><li>  Cancele o retorno de chamada <code>handle.cancel()</code> . </li></ol><br><p>  Portanto, obtemos uma interface chamada <code>AsyncTool</code> , que pode ser implementada de v√°rias maneiras, inclusive em cima de desenvolvimentos comprovados existentes.  Ele n√£o tem rela√ß√£o direta com a escrita da l√≥gica de neg√≥cios, portanto n√£o entraremos em mais detalhes. </p><br><h3 id="derevo-shagov">  √Årvore de etapas: </h3><br><p>  No conceito AsyncSteps, uma √°rvore abstrata de etapas s√≠ncronas √© alinhada e executada, aprofundando a sequ√™ncia de cria√ß√£o.  As etapas de cada n√≠vel mais profundo s√£o definidas dinamicamente √† medida que essa passagem √© conclu√≠da. </p><br><p>  Toda intera√ß√£o ocorre atrav√©s de uma √∫nica interface <code>AsyncSteps</code> , que, por conven√ß√£o, √© passada como o primeiro par√¢metro para cada etapa.  Por conven√ß√£o, o nome do par√¢metro √© <code>asi</code> ou descontinuado <code>as</code> .  Essa abordagem permite interromper quase completamente a conex√£o entre uma implementa√ß√£o espec√≠fica e escrever a l√≥gica de neg√≥cios em plugins e bibliotecas. </p><br><p>  Nas implementa√ß√µes can√¥nicas, cada etapa recebe sua pr√≥pria inst√¢ncia de um objeto que implementa o <code>AsyncSteps</code> , que permite o rastreamento oportuno de erros l√≥gicos no uso da interface. </p><br><p>  Exemplo abstrato: </p><br><pre> <code class="hljs lua"> asi.add( // Level <span class="hljs-number"><span class="hljs-number">0</span></span> step <span class="hljs-number"><span class="hljs-number">1</span></span> func( asi ){ <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 0 func"</span></span> ) asi.add( // Level <span class="hljs-number"><span class="hljs-number">1</span></span> step <span class="hljs-number"><span class="hljs-number">1</span></span> func( asi ){ <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 1 func"</span></span> ) asi.<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>( <span class="hljs-string"><span class="hljs-string">"MyError"</span></span> ) }, onerror( asi, <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> ){ // Level <span class="hljs-number"><span class="hljs-number">1</span></span> step <span class="hljs-number"><span class="hljs-number">1</span></span> catch <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 1 onerror: "</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> ) asi.<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>( <span class="hljs-string"><span class="hljs-string">"NewError"</span></span> ) } ) }, onerror( asi, <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> ){ // Level <span class="hljs-number"><span class="hljs-number">0</span></span> step <span class="hljs-number"><span class="hljs-number">1</span></span> catch <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 0 onerror: "</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> strequal <span class="hljs-string"><span class="hljs-string">"NewError"</span></span> ) { asi.success( <span class="hljs-string"><span class="hljs-string">"Prm"</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>], <span class="hljs-literal"><span class="hljs-literal">true</span></span>) } } ) asi.add( // Level <span class="hljs-number"><span class="hljs-number">0</span></span> step <span class="hljs-number"><span class="hljs-number">2</span></span> func( asi, str_param, int_param, array_param ){ <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 0 func2: "</span></span> + param ) } )</code> </pre> <br><p>  Resultado da execu√ß√£o: </p><br><pre> <code class="hljs pgsql"> <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> func <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> func <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> onerror <span class="hljs-number"><span class="hljs-number">1</span></span>: MyError <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> onerror <span class="hljs-number"><span class="hljs-number">1</span></span>: NewError <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> func <span class="hljs-number"><span class="hljs-number">2</span></span>: Prm</code> </pre> <br><p>  Em sincronia, ficaria assim: </p><br><pre> <code class="hljs coffeescript"> str_res, int_res, array_res, bool_res <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-literal"><span class="hljs-literal">undefined</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Level <span class="hljs-number"><span class="hljs-number">0</span></span> step <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 0 func 1"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Level <span class="hljs-number"><span class="hljs-number">1</span></span> step <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 1 func 1"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">"MyError"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>( error ){ <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Level <span class="hljs-number"><span class="hljs-number">1</span></span> step <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 1 onerror 1: "</span></span> + error ) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">"NewError"</span></span> } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>( error ){ <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Level <span class="hljs-number"><span class="hljs-number">0</span></span> step <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 0 onerror 1: "</span></span> + error ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( error strequal <span class="hljs-string"><span class="hljs-string">"NewError"</span></span> ) { str_res = <span class="hljs-string"><span class="hljs-string">"Prm"</span></span> int_res = <span class="hljs-number"><span class="hljs-number">123</span></span> array_res = [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>] bool_res = <span class="hljs-literal"><span class="hljs-literal">true</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { re-<span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> } } { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Level <span class="hljs-number"><span class="hljs-number">0</span></span> step <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 0 func 2: "</span></span> + str_res ) }</code> </pre> <br><p>  A imita√ß√£o m√°xima do c√≥digo s√≠ncrono tradicional √© imediatamente vis√≠vel, o que deve ajudar na legibilidade. </p><br><p>  Do ponto de vista da l√≥gica de neg√≥cios, um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">grande n√∫mero de requisitos</a> cresce com o tempo, mas podemos dividi-lo em partes facilmente compreendidas.  Descrito abaixo, o resultado da execu√ß√£o na pr√°tica por quatro anos. </p><br><h3 id="bazovye-api-vremeni-vypolneniya">  APIs de tempo de execu√ß√£o principal: </h3><br><ol><li>  <code>add(func[, onerror])</code> - imita√ß√£o de <code>try-catch</code> . </li><li>  <code>success([args...])</code> - uma indica√ß√£o expl√≠cita da conclus√£o bem-sucedida: <br><ul><li>  impl√≠cito por padr√£o </li><li>  pode passar os resultados para a pr√≥xima etapa. </li></ul></li><li>  <code>error(code[, reason)</code> - interrup√ß√£o da execu√ß√£o com um erro: <br><ul><li>  <code>code</code> - possui um tipo de string para melhor integrar-se aos protocolos de rede na arquitetura de microsservi√ßo, </li><li>  <code>reason</code> - uma explica√ß√£o arbitr√°ria para uma pessoa. </li></ul></li><li>  <code>state()</code> - um an√°logo do Thread Local Storage.  Chaves associativas predefinidas: <br><ul><li>  <code>error_info</code> - explica√ß√£o do √∫ltimo erro de uma pessoa, </li><li>  <code>last_exception</code> - ponteiro para o objeto da √∫ltima exce√ß√£o, </li><li>  <code>async_stack</code> - uma pilha de chamadas ass√≠ncronas, <code>async_stack</code> quanto a tecnologia permitir, </li><li>  o resto √© definido pelo usu√°rio. </li></ul></li></ol><br><p>  O exemplo anterior j√° est√° com c√≥digo C ++ real e alguns recursos adicionais: </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;futoin/iasyncsteps.hpp&gt; using namespace futoin; void some_api(IAsyncSteps&amp; asi) { asi.add( [](IAsyncSteps&amp; asi) { std::cout &lt;&lt; "Level 0 func 1" &lt;&lt; std::endl; asi.add( [](IAsyncSteps&amp; asi) { std::cout &lt;&lt; "Level 1 func 1" &lt;&lt; std::endl; asi.error("MyError"); }, [](IAsyncSteps&amp; asi, ErrorCode code) { std::cout &lt;&lt; "Level 1 onerror 1: " &lt;&lt; code &lt;&lt; std::endl; asi.error("NewError", "Human-readable description"); } ); }, [](IAsyncSteps&amp; asi, ErrorCode code) { std::cout &lt;&lt; "Level 0 onerror 1: " &lt;&lt; code &lt;&lt; std::endl; if (code == "NewError") { // Human-readable error info assert(asi.state().error_info == "Human-readable description"); // Last exception thrown is also available in state std::exception_ptr e = asi.state().last_exception; // NOTE: smart conversion of "const char*" asi.success("Prm", 123, std::vector&lt;int&gt;({1, 2, 3}, true)); } } ); asi.add( [](IAsyncSteps&amp; asi, const futoin::string&amp; str_res, int int_res, std::vector&lt;int&gt;&amp;&amp; arr_res) { std::cout &lt;&lt; "Level 0 func 2: " &lt;&lt; str_res &lt;&lt; std::endl; } ); }</span></span></span></span></code> </pre> <br><h3 id="api-dlya-sozdaniya-ciklov">  API para criar loops: </h3><br><ol><li>  <code>loop( func, [, label] )</code> - avance com um corpo infinitamente repetitivo. </li><li>  <code>forEach( map|list, func [, label] )</code> - itera√ß√£o passo a passo do objeto de cole√ß√£o. </li><li>  <code>repeat( count, func [, label] )</code> - n√∫mero de vezes especificado na itera√ß√£o por etapas. </li><li>  <code>break( [label] )</code> √© um an√°logo da interrup√ß√£o tradicional do loop. </li><li>  <code>continue( [label] )</code> √© um an√°logo da continua√ß√£o tradicional do loop com uma nova itera√ß√£o. </li></ol><br><p>  <em>A especifica√ß√£o oferece nomes alternativos <code>breakLoop</code> , <code>continueLoop</code> e outros em caso de conflito com palavras reservadas.</em> </p><br><p>  Exemplo de C ++: </p><br><pre> <code class="cpp hljs"> asi.loop([](IAsyncSteps&amp; asi) { <span class="hljs-comment"><span class="hljs-comment">// infinite loop asi.breakLoop(); }); asi.repeat(10, [](IAsyncSteps&amp; asi, size_t i) { // range loop from i=0 till i=9 (inclusive) asi.continueLoop(); }); asi.forEach( std::vector&lt;int&gt;{1, 2, 3}, [](IAsyncSteps&amp; asi, size_t i, int v) { // Iteration of vector-like and list-like objects }); asi.forEach( std::list&lt;futoin::string&gt;{"1", "2", "3"}, [](IAsyncSteps&amp; asi, size_t i, const futoin::string&amp; v) { // Iteration of vector-like and list-like objects }); asi.forEach( std::map&lt;futoin::string, futoin::string&gt;(), [](IAsyncSteps&amp; asi, const futoin::string&amp; key, const futoin::string&amp; v) { // Iteration of map-like objects }); std::map&lt;std::string, futoin::string&gt; non_const_map; asi.forEach( non_const_map, [](IAsyncSteps&amp; asi, const std::string&amp; key, futoin::string&amp; v) { // Iteration of map-like objects, note the value reference type });</span></span></code> </pre> <br><h3 id="api-integracii-s-vneshnimi-sobytiyami">  API para integra√ß√£o com eventos externos: </h3><br><ol><li>  <code>setTimeout( timeout_ms )</code> - gera um erro de tempo <code>Timeout</code> ap√≥s um tempo limite, se a etapa e sua sub√°rvore n√£o tiverem conclu√≠do a execu√ß√£o. </li><li>  <code>setCancel( handler )</code> - define o manipulador de cancelamento, que √© chamado quando o encadeamento √© cancelado completamente e quando a pilha de etapas ass√≠ncronas √© expandida durante o processamento de erros. </li><li>  <code>waitExternal()</code> - uma espera simples por um evento externo. <br><ul><li>  <em>Nota: √â seguro usar somente em tecnologias com um coletor de lixo.</em> </li></ul></li></ol><br><p>  Uma chamada para qualquer uma dessas fun√ß√µes torna necess√°ria uma chamada expl√≠cita para <code>success()</code> . </p><br><p>  Exemplo de C ++: </p><br><pre> <code class="cpp hljs"> asi.add([](IAsyncSteps&amp; asi) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> handle = schedule_external_callback([&amp;](<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> err) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { asi.error(<span class="hljs-string"><span class="hljs-string">"ExternalError"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (...) { <span class="hljs-comment"><span class="hljs-comment">// pass } } else { asi.success(); } }); asi.setCancel([=](IAsyncSteps&amp; asi) { external_cancel(handle); }); }); asi.add( [](IAsyncSteps&amp; asi) { // Raises Timeout error after specified period asi.setTimeout(std::chrono::seconds{10}); asi.loop([](IAsyncSteps&amp; asi) { // infinite loop }); }, [](IAsyncSteps&amp; asi, ErrorCode code) { if (code == futoin::errors::Timeout) { asi(); } });</span></span></code> </pre> <br><p>  Exemplo ECMAScript: </p><br><pre> <code class="javascript hljs">asi.add( <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">asi</span></span></span><span class="hljs-function">) =&gt;</span></span> { asi.waitExternal(); <span class="hljs-comment"><span class="hljs-comment">// disable implicit success() some_obj.read( (err, data) =&gt; { if (!asi.state) { // ignore as AsyncSteps execution got canceled } else if (err) { try { asi.error( 'IOError', err ); } catch (_) { // ignore error thrown as there are no // AsyncSteps frames on stack. } } else { asi.success( data ); } } ); } );</span></span></code> </pre> <br><h3 id="api-integracii-s-futurepromise">  API de integra√ß√£o futura / promissora: </h3><br><ol><li>  <code>await(promise_future[, on_error])</code> - aguardando Futuro / Promessa como uma etapa. </li><li>  <code>promise()</code> - transforma todo o fluxo de execu√ß√£o em Futuro / Promessa, usado em vez de <code>execute()</code> . </li></ol><br><p>  Exemplo de C ++: </p><br><pre> <code class="hljs pgsql"> [](IAsyncSteps&amp; asi) { // Proper way <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> AsyncSteps instances // <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> hard dependency <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> implementation. auto new_steps = asi.newInstance(); new_steps-&gt;<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>([](IAsyncSteps&amp; asi) {}); // Can be <span class="hljs-keyword"><span class="hljs-keyword">called</span></span> outside <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> AsyncSteps event <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> // new_steps.promise().wait(); // <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> // new_steps.promise&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt;().<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); // Proper way <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> wait <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> standard std::future asi.await(new_steps-&gt;promise()); // Ensure instance lifetime asi.state()["some_obj"] = std::<span class="hljs-keyword"><span class="hljs-keyword">move</span></span>(new_steps); };</code> </pre> <br><h3 id="api-kontrolya-potoka-vypolneniya-biznes-logiki">  API de controle de fluxo da l√≥gica de neg√≥cios: </h3><br><ol><li>  <code>AsyncSteps(AsyncTool&amp;)</code> √© um construtor que vincula um encadeamento de execu√ß√£o a um loop de evento espec√≠fico. </li><li>  <code>execute()</code> - inicia o thread de execu√ß√£o. </li><li>  <code>cancel()</code> - cancela o encadeamento de execu√ß√£o. </li></ol><br><p>  Uma implementa√ß√£o de interface espec√≠fica j√° √© necess√°ria aqui. </p><br><p>  Exemplo de C ++: </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;futoin/ri/asyncsteps.hpp&gt; #include &lt;futoin/ri/asynctool.hpp&gt; void example() { futoin::ri::AsyncTool at; futoin::ri::AsyncSteps asi{at}; asi.loop([&amp;](futoin::IAsyncSteps &amp;asi){ // Some infinite loop logic }); asi.execute(); std::this_thread::sleep_for(std::chrono::seconds{10}); asi.cancel(); // called in d-tor by fact }</span></span></span></span></code> </pre> <br><h3 id="prochie-api">  outras APIs: </h3><br><ol><li>  <code>newInstance()</code> - permite criar um novo encadeamento de execu√ß√£o sem depend√™ncia direta da implementa√ß√£o. </li><li>  <code>sync(object, func, onerror)</code> - o mesmo, mas com a sincroniza√ß√£o relativa a um objeto que implementa a interface correspondente. </li><li>  <code>parallel([on_error])</code> - <code>add()</code> especial <code>add()</code> , cujas subetapas s√£o fluxos AsyncSteps separados: <br><ul><li>  todos os threads t√™m <code>state()</code> comum <code>state()</code> , </li><li>  o encadeamento pai continua a execu√ß√£o ap√≥s a conclus√£o de todos os filhos </li><li>  um erro n√£o detectado em qualquer filho cancela imediatamente todos os outros threads filhos. </li></ul></li></ol><br><p>  Exemplos de C ++: </p><br><pre> <code class="cpp hljs"> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;futoin/ri/mutex.hpp&gt; using namespace futoin; ri::Mutex mtx_a; void sync_example(IAsyncSteps&amp; asi) { asi.sync(mtx_a, [](IAsyncSteps&amp; asi) { // synchronized section asi.add([](IAsyncSteps&amp; asi) { // inner step in the section // This synchronization is NOOP for already // acquired Mutex. asi.sync(mtx_a, [](IAsyncSteps&amp; asi) { }); }); }); } void parallel_example(IAsyncSteps&amp; asi) { using OrderVector = std::vector&lt;int&gt;; asi.state("order", OrderVector{}); auto&amp; p = asi.parallel([](IAsyncSteps&amp; asi, ErrorCode) { // Overall error handler asi.success(); }); p.add([](IAsyncSteps&amp; asi) { // regular flow asi.state&lt;OrderVector&gt;("order").push_back(1); asi.add([](IAsyncSteps&amp; asi) { asi.state&lt;OrderVector&gt;("order").push_back(4); }); }); p.add([](IAsyncSteps&amp; asi) { asi.state&lt;OrderVector&gt;("order").push_back(2); asi.add([](IAsyncSteps&amp; asi) { asi.state&lt;OrderVector&gt;("order").push_back(5); asi.error("SomeError"); }); }); p.add([](IAsyncSteps&amp; asi) { asi.state&lt;OrderVector&gt;("order").push_back(3); asi.add([](IAsyncSteps&amp; asi) { asi.state&lt;OrderVector&gt;("order").push_back(6); }); }); asi.add([](IAsyncSteps&amp; asi) { asi.state&lt;OrderVector&gt;("order"); // 1, 2, 3, 4, 5 }); };</span></span></span></span></code> </pre> <br><h3 id="standartnye-primitivy-dlya-sinhronizacii">  Primitivas padr√£o para sincroniza√ß√£o </h3><br><ol><li>  <code>Mutex</code> - restringe a execu√ß√£o simult√¢nea de <code>N</code> threads com uma fila em <code>Q</code> , por padr√£o <code>N=1, Q=unlimited</code> . </li><li>  <code>Throttle</code> - limita o n√∫mero de entradas <code>N</code> no per√≠odo <code>P</code> com uma fila em <code>Q</code> , por padr√£o <code>N=1, P=1s, Q=0</code> . </li><li>  <code>Limiter</code> √© uma combina√ß√£o de <code>Mutex</code> e <code>Throttle</code> , que normalmente √© usada na entrada do processamento de solicita√ß√µes externas e ao chamar sistemas externos com a finalidade de opera√ß√£o est√°vel sob carga. </li></ol><br><p>  No caso de <code>DefenseRejected</code> limites <code>DefenseRejected</code> fila, √© <code>DefenseRejected</code> um erro <code>DefenseRejected</code> , cujo significado √© claro na descri√ß√£o do <code>Limiter</code> . </p><br><h3 id="klyuchevye-preimuschestva">  Principais Benef√≠cios </h3><br><p>  O conceito de AsyncSteps n√£o era um fim em si, mas nasceu da necessidade de execu√ß√£o ass√≠ncrona mais controlada de programas em termos de prazo, cancelamento e conectividade geral de retornos de chamada individuais.  Nenhuma das solu√ß√µes universais da √©poca e agora oferece a mesma funcionalidade.  Portanto: </p><br><p> <strong> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> FTN12</a>   </strong> ‚Äî           . </p><br><p> <strong>  <code>setCancel()</code></strong> ‚Äî                    .       ,     .   RAII  <code>atexit()</code>   . </p><br><p> <strong>   <code>cancel()</code></strong> ‚Äî     ,         .   <code>SIGTERM</code>  <code>pthread_cancel()</code> ,       . </p><br><p> <strong>   <code>setTimeout()</code></strong> ‚Äî                 .    ,    "Timeout". </p><br><p> <strong>     </strong> ‚Äî  FutoIn AsyncSteps             . </p><br><p> <strong>      </strong> ‚Äî          ABI     ,    .    Embedded     MMU. </p><br><hr><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yj/8x/wv/yj8xwvibm7tjsj30qhojwbleige.jpeg"></div><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><em> </em></a> </p><br><h2 id="k-cifram">   </h2><br><p>    Intel Xeon E3-1245v2/DDR1333  Debian Stretch    . </p><br><p>   : </p><br><ol><li> Boost.Fiber  <code>protected_fixedsize_stack</code> . </li><li> Boost.Fiber  <code>pooled_fixedsize_stack</code>     . </li><li> FutoIn AsyncSteps   . </li><li> FutoIn AsyncSteps      ( <code>FUTOIN_USE_MEMPOOL=false</code> ). <br><ul><li>      <code>futoin::IMemPool</code> . </li></ul></li><li> FutoIn NitroSteps&lt;&gt; ‚Äî           . <br><ul><li>         . </li></ul></li></ol><br><p>    Boost.Fiber    : </p><br><ol><li>     1 . . </li><li>       30 .   1 . . <br><ul><li>   30 .     <code>mmap()/mprotect()</code>  <code>boost::fiber::protected_fixedsize_stack</code> . </li><li>          . </li></ul></li><li>   30 .   10 .     . <br><ul><li>    ""          . </li></ul></li></ol><br><p>      "" , ..     ,       .        .   . </p><br><p>    GCC 6.3.0.   lang  tcmalloc  ,     . </p><br><p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GitHub</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GitLab</a> . </p><br><h3 id="1-posledovatelnoe-sozdanie"> 1.   </h3><br><table><thead><tr><th>  </th><th>  Tempo </th><th>  </th></tr></thead><tbody><tr><td> Boost.Fiber protected </td><td> 4.8s </td><td> 208333.333Hz </td></tr><tr><td> Boost.Fiber pooled </td><td> 0.23s </td><td> 4347826.086Hz </td></tr><tr><td> FutoIn AsyncSteps </td><td> <strong>0.21s</strong> </td><td> <strong>4761904.761Hz</strong> </td></tr><tr><td> FutoIn AsyncSteps no mempool </td><td> 0.31s </td><td> 3225806.451Hz </td></tr><tr><td> FutoIn NitroSteps </td><td> 0.255s </td><td> 3921568.627Hz </td></tr></tbody></table><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qm/ur/y6/qmury65-mbkth_om8smkfi7vamq.png"></div><br><p> <em> ‚Äî .</em> </p><br><p>     Boost.Fiber -      ,     <code>pooled_fixedsize_stack</code>   ,    AsyncSteps. </p><br><h3 id="2-parallelnoe-sozdanie-i-ispolnenie"> 2.     </h3><br><table><thead><tr><th>  </th><th>  Tempo </th><th>  </th></tr></thead><tbody><tr><td> Boost.Fiber protected </td><td> 6.31s </td><td> 158478.605Hz </td></tr><tr><td> Boost.Fiber pooled </td><td> 1.558s </td><td> 641848.523Hz </td></tr><tr><td> FutoIn AsyncSteps </td><td> <strong>1.13s</strong> </td><td> <strong>884955.752Hz</strong> </td></tr><tr><td> FutoIn AsyncSteps no mempool </td><td> 1.353s </td><td> 739098.300Hz </td></tr><tr><td> FutoIn NitroSteps </td><td> 1.43s </td><td> 699300.699Hz </td></tr></tbody></table><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/0s/gz/lu/0sgzlur2xsrlf-wo4mrcynvzhxi.png"></div><br><p> <em> ‚Äî .</em> </p><br><p>    ,          .    ,        ‚Äî            . </p><br><h3 id="3-parallelnye-cikly"> 3.   </h3><br><table><thead><tr><th>  </th><th>  Tempo </th><th>  </th></tr></thead><tbody><tr><td> Boost.Fiber protected </td><td> 5.096s </td><td> 1962323.390Hz </td></tr><tr><td> Boost.Fiber pooled </td><td> 5.077s </td><td> 1969667.126Hz </td></tr><tr><td> FutoIn AsyncSteps </td><td> 5.361s </td><td> 1865323.633Hz </td></tr><tr><td> FutoIn AsyncSteps no mempool </td><td> 8.288s </td><td> 1206563.706Hz </td></tr><tr><td> FutoIn NitroSteps </td><td> <strong>3.68s</strong> </td><td> <strong>2717391.304Hz</strong> </td></tr></tbody></table><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pb/c1/17/pbc117djqds0d4twh5fzcklsmfc.png"></div><br><p> <em> ‚Äî .</em> </p><br><p>   ,        Boost.Fiber      AsyncSteps,    NitroSteps. </p><br><h3 id="ispolzovanie-pamyati-po-rss">   ( RSS) </h3><br><table><thead><tr><th>  </th><th>  </th></tr></thead><tbody><tr><td> Boost.Fiber protected </td><td> 124M </td></tr><tr><td> Boost.Fiber pooled </td><td> 505M </td></tr><tr><td> FutoIn AsyncSteps </td><td> 124M </td></tr><tr><td> FutoIn AsyncSteps no mempool </td><td> <strong>84M</strong> </td></tr><tr><td> FutoIn NitroSteps </td><td> 115M </td></tr></tbody></table><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ol/w0/6n/olw06nef5wj3ah1lo9u-pby9sfg.png"></div><br><p> <em> ‚Äî .</em> </p><br><p>  , Boost.Fiber  . </p><br><h3 id="bonus-testy-na-nodejs"> :   Node.js </h3><br><p>      -  <code>Promise</code> : +    10 . .   10 .          JIT  <code>NODE_ENV=production</code> ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>@futoin/optihelp</code></a> . </p><br><p>      <a href="">GitHub</a>  <a href="">GitLab</a> .   Node.js v8.12.0  v10.11.0,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">FutoIn CID</a> . </p><br><table><thead><tr><th> Tech </th><th> Simple </th><th> Loop </th></tr></thead><tbody><tr><td> <strong>Node.js v10</strong> </td><td></td><td></td></tr><tr><td> FutoIn AsyncSteps </td><td> <strong>1342899.520Hz</strong> </td><td> 587.777Hz </td></tr><tr><td> async/await </td><td> 524983.234Hz </td><td> <strong>630.863Hz</strong> </td></tr><tr><td> <strong>Node.js v8</strong> </td><td></td><td></td></tr><tr><td> FutoIn AsyncSteps </td><td> <strong>682420.735Hz</strong> </td><td> <strong>588.336Hz</strong> </td></tr><tr><td> async/await </td><td> 365050.395Hz </td><td> 400.575Hz </td></tr></tbody></table><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/x7/-n/b5/x7-nb5v9dfkwn1lttyg67w2b_tk.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gh/yj/9p/ghyj9pczw0smbfksq-aad_tltay.png"></div><br><p> <em> ‚Äî .</em> </p><br><p>   <code>async/await</code> ? ,   V8  Node.js v10       . </p><br><p>  ,   Promise  <code>async/await</code> <strong></strong> Node.js Event Loop.          ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a> ),   FutoIn AsyncSteps   . </p><br><p> <em>   AsyncSteps  Node.js Event Loop      <code>async/await</code>  -  Node.js v10.</em> </p><br><p> <em>,      ++   ‚Äî    .  ,    Node.js    10 .</em> </p><br><h3 id="vyvody">  Conclus√µes </h3><br><p>   C++, FutoIn AsyncSteps  Boost.Fiber       ,     Boost.Fiber         <code>mmap()/mprotect</code> . </p><br><p>       ,      -      ,   .     . </p><br><p> FutoIn AsyncSteps  JavaScript  <code>async/await</code>       Node.js v10. </p><br><p>   ,       -,       .        . </p><br><p>   -                        ""  .     ‚Äî   API. </p><br><hr><br><h2 id="zaklyuchenie">  Conclus√£o </h2><br><p> ,  FutoIn AsyncSteps ,          "" <code>async/await</code> . ,         .      <code>Promise</code>  ECMAScript, AsyncSteps    ""           . </p><br><p>               .        AsyncSteps  NitroSteps   . </p><br><p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a> ,    - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a> . </p><br><p>       Java/JVM         ‚Äî    .    . </p><br><p>      ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GitHub</a> / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GitLab</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt424311/">https://habr.com/ru/post/pt424311/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt424297/index.html">Curso MIT "Seguran√ßa de sistemas de computadores". Aula 9: Seguran√ßa de Aplicativos Web, Parte 3</a></li>
<li><a href="../pt424301/index.html">Algoritmo de filtro de imagem de rede neural adaptativa</a></li>
<li><a href="../pt424305/index.html">RIBs de arquitetura m√≥vel de plataforma cruzada Uber</a></li>
<li><a href="../pt424307/index.html">GitLab 11.3 lan√ßado com reposit√≥rio Maven e ambientes seguros</a></li>
<li><a href="../pt424309/index.html">DevCore: parte do software do projeto DevBoy</a></li>
<li><a href="../pt424313/index.html">EveryLang √© um programa que pode fazer quase tudo</a></li>
<li><a href="../pt424315/index.html">Uma nova rodada de substitui√ß√£o de importa√ß√µes. Para onde correr e o que fazer?</a></li>
<li><a href="../pt424319/index.html">A estrutura da loja online. Parte 2</a></li>
<li><a href="../pt424321/index.html">Colocando o NetFlow barato e irritado</a></li>
<li><a href="../pt424323/index.html">Um exemplo de como trabalhar com o m√©todo ICE do gerente de produto do Google e da Microsoft</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>