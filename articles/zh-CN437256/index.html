<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¤“ ğŸ’€ ğŸ˜¬ éªŒè¯Cortex-M0 / M3 / M4 / M7ä¸Šçš„å†…å­˜åœ°å€ â™£ï¸ ğŸ‘¨â€ğŸ‘¨â€ğŸ‘§ ğŸšŒ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å“ˆHaï¼ 

 å…³äºå‰ä¸€å¤©çš„æ”¿æƒæ”¾æ¾ï¼Œåœ¨ä¸€ä¸ªç›¸é‚»å¸–å­çš„è¯„è®ºä¸­ï¼Œæœ‰å…³å¾®æ§åˆ¶å™¨çš„æ–‡ç« éƒ½åªæ˜¯è¢«LEDé—ªçƒè€Œæ„Ÿåˆ°æ„¤æ…¨ï¼Œä»¥åŠæˆ‘æ‡’å¾—æ¢å¤çš„æˆ‘çš„æ ‡å‡†åšå®¢è¿‡æ—©åœ°æ­»äº†ï¼Œæˆ‘å°†åœ¨è¿™é‡Œä¼ é€’æœ‰å…³ä¸€ä¸ªä»¤äººé—æ†¾çš„å°äº®ç‚¹çš„æœ‰ç”¨ææ–™ã€‚ä½¿ç”¨Cortex-Må†…æ ¸çš„ä¸€ä¸ªæŠ€å·§-æ£€æŸ¥éšæœºåœ°å€çš„æœ‰æ•ˆæ€§ã€‚ 


 ä¸€ç§éå¸¸æœ‰ç”¨ä¸”åŒæ—¶ç”±äºæŸç§åŸå› è€Œ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>éªŒè¯Cortex-M0 / M3 / M4 / M7ä¸Šçš„å†…å­˜åœ°å€</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/437256/"> å“ˆHaï¼ <br><br> å…³äºå‰ä¸€å¤©<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">çš„æ”¿æƒæ”¾æ¾ï¼Œåœ¨</a>ä¸€ä¸ªç›¸é‚»å¸–å­çš„è¯„è®ºä¸­ï¼Œæœ‰å…³å¾®æ§åˆ¶å™¨çš„æ–‡ç« éƒ½åªæ˜¯è¢«LEDé—ªçƒè€Œæ„Ÿåˆ°æ„¤æ…¨ï¼Œä»¥åŠæˆ‘æ‡’å¾—æ¢å¤çš„æˆ‘çš„æ ‡å‡†åšå®¢è¿‡æ—©åœ°æ­»äº†ï¼Œæˆ‘å°†åœ¨è¿™é‡Œä¼ é€’æœ‰å…³ä¸€ä¸ªä»¤äººé—æ†¾çš„å°äº®ç‚¹çš„æœ‰ç”¨ææ–™ã€‚ä½¿ç”¨Cortex-Må†…æ ¸çš„ä¸€ä¸ªæŠ€å·§-æ£€æŸ¥éšæœºåœ°å€çš„æœ‰æ•ˆæ€§ã€‚ <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rl/he/2w/rlhe2wjgxij3ej65fi5t8lverts.jpeg"></div><br> ä¸€ç§éå¸¸æœ‰ç”¨ä¸”åŒæ—¶ç”±äºæŸç§åŸå› è€Œåœ¨Cortex-Må¾®æ§åˆ¶å™¨ï¼ˆå…¨éƒ¨ï¼‰ä¸Šæœªæè¿°çš„ç°æˆåŠŸèƒ½ä¹‹ä¸€æ˜¯èƒ½å¤Ÿæ£€æŸ¥å†…å­˜ä¸­åœ°å€çš„æ­£ç¡®æ€§ã€‚ å€ŸåŠ©å®ƒï¼Œæ‚¨å¯ä»¥ç¡®å®šé—ªå­˜ï¼ŒRAMå’ŒEEPROMçš„å¤§å°ï¼Œç¡®å®šç‰¹å®šå¤–å›´è®¾å¤‡å’Œå¯„å­˜å™¨åœ¨ç‰¹å®šå¤„ç†å™¨ä¸Šçš„å­˜åœ¨ï¼Œæ¶ˆé™¤æ‰è½çš„è¿›ç¨‹ï¼ŒåŒæ—¶ä¿æŒOSçš„æ•´ä½“è¿è¡ŒçŠ¶å†µç­‰ã€‚ <br><a name="habracut"></a><br> åœ¨æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œå½“æ‚¨åˆ°è¾¾Cortex-M3 / M4 / M7ä¸Šä¸å­˜åœ¨çš„åœ°å€æ—¶ï¼Œä¼šæŠ›å‡ºBusFaultå¼‚å¸¸ï¼Œå¹¶ä¸”åœ¨æ²¡æœ‰å…¶å¤„ç†ç¨‹åºçš„æƒ…å†µä¸‹ï¼Œå®ƒä¼šå‡çº§ä¸ºHardFaultã€‚ åœ¨Cortex-M0ä¸Šï¼Œæ²¡æœ‰â€œè¯¦ç»†â€å¼‚å¸¸ï¼ˆMemFaultï¼ŒBusFaultï¼ŒUsageFaultï¼‰ï¼Œå¹¶ä¸”ä»»ä½•æ•…éšœéƒ½ä¼šç«‹å³å‡çº§ä¸ºHardFaultã€‚ <br><br> é€šå¸¸ï¼Œæ‚¨ä¸èƒ½å¿½ç•¥HardFault-ä¾‹å¦‚ï¼Œè¿™å¯èƒ½æ˜¯ç¡¬ä»¶æ•…éšœçš„ç»“æœï¼Œè®¾å¤‡çš„è¿›ä¸€æ­¥è¡Œä¸ºå°†å˜å¾—ä¸å¯é¢„æµ‹ã€‚ ä½†æ˜¯åœ¨ç‰¹å®šæƒ…å†µä¸‹ï¼Œå¯ä»¥å¹¶ä¸”åº”è¯¥è¿™æ ·åšã€‚ <br><br><h4>  Cortex-M3å’ŒCortex-M4ï¼šæœªå®ç°çš„BusFault </h4><br> åœ¨Cortex-M3åŠæ›´é«˜ç‰ˆæœ¬ä¸Šï¼Œæ£€æŸ¥åœ°å€çš„æœ‰æ•ˆæ€§éå¸¸ç®€å•-å¿…é¡»é€šè¿‡FAULTMASKå¯„å­˜å™¨ç¦æ­¢æ‰€æœ‰å¼‚å¸¸ï¼ˆæ˜¾ç„¶ï¼Œä¸å¯å±è”½çš„å¼‚å¸¸é™¤å¤–ï¼‰ï¼Œä¸“é—¨ç¦ç”¨BusFaultå¤„ç†ï¼Œç„¶åæˆ³å…¥è¦æ£€æŸ¥çš„åœ°å€ï¼Œå¹¶æŸ¥çœ‹BFARå¯„å­˜å™¨ä¸­çš„BFARVALIDæ ‡å¿—æ˜¯å¦ï¼Œå³æ€»çº¿æ•…éšœåœ°å€å¯„å­˜å™¨ã€‚ å¦‚æœæ‚¨é€‰æ‹©äº†å®ƒï¼Œé‚£ä¹ˆæ‚¨å°†æ‹¥æœ‰BusFaultï¼Œå³ åœ°å€ä¸æ­£ç¡®ã€‚ <br><br> ä»£ç çœ‹èµ·æ¥åƒè¿™æ ·ï¼Œæ¥è‡ªæ ‡å‡†ï¼ˆéä¾›åº”å•†ï¼‰CMSISçš„æ‰€æœ‰å®šä¹‰å’ŒåŠŸèƒ½ï¼Œå› æ­¤å®ƒå¯ä»¥åœ¨ä»»ä½•M3ï¼ŒM4æˆ–M7ä¸Šè¿è¡Œï¼š <br><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cpu_check_address</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">volatile</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *address)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* Cortex-M3, Cortex-M4, Cortex-M4F, Cortex-M7 are supported */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> BFARVALID_MASK = (<span class="hljs-number"><span class="hljs-number">0x80</span></span> &lt;&lt; SCB_CFSR_BUSFAULTSR_Pos); <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> is_valid = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Clear BFARVALID flag by writing 1 to it */</span></span> SCB-&gt;CFSR |= BFARVALID_MASK; <span class="hljs-comment"><span class="hljs-comment">/* Ignore BusFault by enabling BFHFNMIGN and disabling interrupts */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> mask = __get_FAULTMASK(); __disable_fault_irq(); SCB-&gt;CCR |= SCB_CCR_BFHFNMIGN_Msk; <span class="hljs-comment"><span class="hljs-comment">/* probe address in question */</span></span> *address; <span class="hljs-comment"><span class="hljs-comment">/* Check BFARVALID flag */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((SCB-&gt;CFSR &amp; BFARVALID_MASK) != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/* Bus Fault occured reading the address */</span></span> is_valid = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/* Reenable BusFault by clearing BFHFNMIGN */</span></span> SCB-&gt;CCR &amp;= ~SCB_CCR_BFHFNMIGN_Msk; __set_FAULTMASK(mask); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> is_valid; }</code> </pre> <br><h4>  Cortex-M0å’ŒCortex-M0 + </h4><br> å¦‚å‰æ‰€è¿°ï¼Œä½¿ç”¨Cortex-M0å’ŒCortex-M0 +ï¼Œä¸€åˆ‡éƒ½å˜å¾—æ›´åŠ å¤æ‚ï¼Œå› ä¸ºå®ƒä»¬æ²¡æœ‰BusFaultå’Œæ‰€æœ‰ç›¸åº”çš„å¯„å­˜å™¨ï¼Œå¹¶ä¸”å¼‚å¸¸ä¼šç«‹å³å‡çº§ä¸ºHardFaultã€‚ å› æ­¤ï¼Œåªæœ‰ä¸€ç§å‡ºè·¯-ä½¿HardFaultå¤„ç†ç¨‹åºèƒ½å¤Ÿç†è§£è¯¥å¼‚å¸¸æ˜¯æ•…æ„å¼•èµ·çš„ï¼Œç„¶åè¿”å›è°ƒç”¨å®ƒçš„å‡½æ•°ï¼Œå¹¶åœ¨å…¶ä¸­ä¼ é€’ä¸€ä¸ªæŒ‡ç¤ºHardFaultçš„æ ‡å¿—ã€‚ <br><br> è¿™å®Œå…¨æ˜¯åœ¨æ±‡ç¼–ç¨‹åºä¸­å®Œæˆçš„ã€‚ åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œå¯„å­˜å™¨R5è®¾ç½®ä¸º1ï¼Œå¹¶ä¸”ä¸¤ä¸ªâ€œå¹»æ•°â€è¢«å†™å…¥å¯„å­˜å™¨R1å’ŒR2ã€‚ å¦‚æœåœ¨å°è¯•å°†å€¼åŠ è½½åˆ°è¦æ£€æŸ¥çš„åœ°å€åå‘ç”ŸHardFaultï¼Œåˆ™å®ƒå¿…é¡»æ£€æŸ¥R1å’ŒR2çš„å€¼ï¼Œå¦‚æœå®ƒä»¬æ‰¾åˆ°äº†å¿…è¦çš„æ•°å­—ï¼Œè¯·å°†R5è®¾ç½®ä¸ºé›¶ã€‚  R5çš„å€¼é€šè¿‡ç‰¢å›ºåœ°ç»‘å®šåˆ°è¯¥å¯„å­˜å™¨çš„ç‰¹æ®Šå˜é‡ä¼ è¾“åˆ°syshechä»£ç ä¸­ï¼Œè¦æ±‡ç¼–åˆ°æ±‡ç¼–å™¨ä¸­çš„åœ°å€æ˜¯éšå¼çš„ï¼Œæˆ‘ä»¬åªçŸ¥é“åœ¨arm-none-eabiä¸­ï¼Œå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ä½äºR0ä¸­ã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cpu_check_address</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">volatile</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *address)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* Cortex-M0 doesn't have BusFault so we need to catch HardFault */</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)address; <span class="hljs-comment"><span class="hljs-comment">/* R5 will be set to 0 by HardFault handler */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* to indicate HardFault has occured */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">register</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> result __asm(<span class="hljs-string"><span class="hljs-string">"r5"</span></span>); __<span class="hljs-function"><span class="hljs-function">asm__ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ldr r5, =1 \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* set default R5 value */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ldr r1, =0xDEADF00D \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* set magic number */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ldr r2, =0xCAFEBABE \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* 2nd magic to be sure */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ldrb r3, [r0] \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* probe address */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br>  HardFaultå¤„ç†ç¨‹åºçš„æœ€ç®€å•å½¢å¼çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><pre> <code class="cpp hljs">__attribute__((naked)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hard_fault_default</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* Get stack pointer where exception stack frame lies */</span></span> __<span class="hljs-function"><span class="hljs-function">asm__ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* decide if we need MSP or PSP stack */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"movs r0, #4 \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* r0 = 0x4 */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"mov r2, lr \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* r2 = lr */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"tst r2, r0 \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* if(lr &amp; 0x4) */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"bne use_psp \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* { */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"mrs r0, msp \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* r0 = msp */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"b out \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* } */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">" use_psp: \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* else { */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"mrs r0, psp \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* r0 = psp */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">" out: \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* } */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* catch intended HardFaults on Cortex-M0 to probe memory addresses */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ldr r1, [r0, #0x04] \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* read R1 from the stack */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ldr r2, =0xDEADF00D \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* magic number to be found */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"cmp r1, r2 \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* compare with the magic number */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"bne regular_handler \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* no magic -&gt; handle as usual */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ldr r1, [r0, #0x08] \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* read R2 from the stack */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ldr r2, =0xCAFEBABE \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* 2nd magic number to be found */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"cmp r1, r2 \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* compare with 2nd magic number */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"bne regular_handler \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* no magic -&gt; handle as usual */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ldr r1, [r0, #0x18] \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* read PC from the stack */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"add r1, r1, #2 \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* move to the next instruction */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"str r1, [r0, #0x18] \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* modify PC in the stack */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ldr r5, =0 \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* set R5 to indicate HardFault */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"bx lr \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* exit the exception handler */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">" regular_handler: \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* here comes the rest of the fucking owl */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span></span></code> </pre> <br> ç¦»å¼€å¼‚å¸¸å¤„ç†ç¨‹åºæ—¶ï¼ŒCortexå°†ç¡®ä¿è¢«å¤„ç†ç¨‹åºç ´åçš„å¯„å­˜å™¨ï¼ˆR0-R3ï¼ŒR12ï¼ŒLRï¼ŒPC ...ï¼‰æ‰”åˆ°å †æ ˆä¸Šã€‚ ç¬¬ä¸€ä¸ªç‰‡æ®µ-å®ƒå·²ç»å­˜åœ¨äºå¤§å¤šæ•°ç°æˆçš„HardFaultå¤„ç†ç¨‹åºä¸­ï¼Œé™¤äº†é‚£äº›ç”¨çº¯è£¸æœºç¼–å†™çš„ç‰‡æ®µå¤–-ç¡®å®šå“ªä¸ªå †æ ˆï¼šåœ¨OSä¸­å·¥ä½œæ—¶ï¼Œå®ƒå¯ä»¥æ˜¯MSPæˆ–PSPï¼Œå¹¶ä¸”å®ƒä»¬å…·æœ‰ä¸åŒçš„åœ°å€ã€‚ åœ¨è£¸æœºé¡¹ç›®ä¸­ï¼Œé€šå¸¸å…ˆéªŒåœ°å®‰è£…MSPå †æ ˆï¼ˆä¸»å †æ ˆæŒ‡é’ˆï¼‰ï¼Œè€Œä¸è¿›è¡Œæ£€æŸ¥-å› ä¸ºç”±äºç¼ºå°‘è¿›ç¨‹ï¼ŒPSPï¼ˆè¿›ç¨‹å †æ ˆæŒ‡é’ˆï¼‰æ— æ³•å­˜åœ¨ã€‚ <br><br> ç¡®å®šæ‰€éœ€çš„å †æ ˆå¹¶å°†å…¶åœ°å€æ”¾å…¥R0åï¼Œæˆ‘ä»¬ä»ä¸­è¯»å–å€¼R1ï¼ˆåç§»é‡0x04ï¼‰å’ŒR2ï¼ˆåç§»é‡0x08ï¼‰ï¼Œå¹¶å°†å…¶ä¸é­”æœ¯å­—è¿›è¡Œæ¯”è¾ƒï¼ˆå¦‚æœä¸¤è€…å‡åŒ¹é…ï¼‰-æˆ‘ä»¬ä»å †æ ˆä¸­è¯»å–PCå€¼ï¼ˆåç§»é‡0x18ï¼‰ï¼ŒåŠ 2 ï¼ˆ2ä¸ªå­—èŠ‚-Cortex-M *ä¸ŠæŒ‡ä»¤çš„å¤§å°ï¼‰ï¼Œç„¶åå°†å…¶ä¿å­˜å›å †æ ˆã€‚ å¦‚æœä¸è¿™æ ·åšï¼Œå½“æˆ‘ä»¬ä»å¤„ç†ç¨‹åºä¸­è¿”å›æ—¶ï¼Œæˆ‘ä»¬å°†å‘ç°è‡ªå·±å®é™…ä¸Šæ˜¯åœ¨å¼•èµ·å¼‚å¸¸çš„åŒä¸€æ¡æŒ‡ä»¤ä¸Šï¼Œå¹¶ä¸”å°†å§‹ç»ˆå¾ªç¯è¿è¡Œã€‚ é™„å½•2å°†æˆ‘ä»¬ç§»è‡³è¿”å›æ—¶çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚ <br><br>  <i><b>*æ›´æ–°ã€‚</b></i>  <i>åœ¨è¯„è®ºä¸­ï¼Œå‡ºç°äº†å…³äºCortex-Mä¸ŠæŒ‡ä»¤å¤§å°çš„é—®é¢˜ï¼Œæˆ‘å°†åœ¨æ­¤å¤„åšå‡ºæ­£ç¡®ç­”æ¡ˆï¼šåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå´©æºƒä¼šå¯¼è‡´LDRBæŒ‡ä»¤ï¼Œè¯¥æŒ‡ä»¤åœ¨ARMv7-Mæ¶æ„ä¸­å¯ç”¨ï¼Œæœ‰ä¸¤ç§ç‰ˆæœ¬-16ä½å’Œ32ä½ã€‚</i>  <i>å¦‚æœè‡³å°‘æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ä¹‹ä¸€ï¼Œåˆ™å°†é€‰æ‹©ç¬¬äºŒä¸ªé€‰é¡¹ï¼š</i> <i><br><br></i> <ul><li>  <i>ä½œè€…æ˜ç¡®æŒ‡å‡ºäº†æŒ‡ä»¤LDRB.Wè€Œä¸æ˜¯LDRBï¼ˆæˆ‘ä»¬æ²¡æœ‰ï¼‰</i> </li><li>  <i>ä½¿ç”¨é«˜äºR7çš„å¯„å­˜å™¨ï¼ˆå¯¹äºæˆ‘ä»¬-R0å’ŒR3ï¼‰</i> </li><li>  <i>æŒ‡å®šçš„åç§»é‡å¤§äº31ä¸ªå­—èŠ‚ï¼ˆæˆ‘ä»¬æ²¡æœ‰åç§»é‡ï¼‰</i> </li></ul> <i><br><br></i>  <i>åœ¨æ‰€æœ‰å…¶ä»–æƒ…å†µä¸‹ï¼ˆå³ï¼Œå½“æ“ä½œæ•°ç¬¦åˆæŒ‡ä»¤çš„16ä½ç‰ˆæœ¬çš„æ ¼å¼æ—¶ï¼‰ï¼Œæ±‡ç¼–ç¨‹åº<b>å¿…é¡»</b>é€‰æ‹©16ä½ç‰ˆæœ¬ã€‚</i> <i><br><br></i>  <i>å› æ­¤ï¼Œåœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ï¼Œæ€»æ˜¯ä¼šæœ‰ä¸€ä¸ª2å­—èŠ‚çš„æŒ‡ä»¤éœ€è¦è·³è¿‡ï¼Œä½†æ˜¯å¦‚æœæ‚¨å¼ºçƒˆåœ°ç¼–è¾‘ä»£ç ï¼Œåˆ™å¯ä»¥ä½¿ç”¨é€‰é¡¹ã€‚</i> <br><br> æ¥ä¸‹æ¥ï¼Œåœ¨R5ä¸­å†™å…¥0ï¼Œä»¥ä½œä¸ºè¿›å…¥HardFaultçš„æŒ‡æ ‡ã€‚  R3ä¹‹åçš„å¯„å­˜å™¨ä¸ä¼šåœ¨ç‰¹æ®Šå¯„å­˜å™¨ä¹‹å‰ä¿å­˜åˆ°å †æ ˆä¸­ï¼Œå¹¶ä¸”é€€å‡ºå¤„ç†ç¨‹åºæ—¶ï¼Œå®ƒä»¬ä¸ä¼šä»¥ä»»ä½•æ–¹å¼è¿˜åŸï¼Œå› æ­¤ç ´åæˆ–ä¸ç ´åå®ƒä»¬æ˜¯æˆ‘ä»¬çš„è‰¯å¿ƒã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æœ‰æ„å°†R5ä»1æ›´æ”¹ä¸º0ã€‚ <br><br> ä¸­æ–­å¤„ç†ç¨‹åºçš„è¿”å›ä»…ä»¥ä¸€ç§æ–¹å¼å®Œæˆã€‚ è¿›å…¥å¤„ç†ç¨‹åºæ—¶ï¼Œä¼šåœ¨LRå¯„å­˜å™¨ä¸­å†™å…¥ä¸€ä¸ªç‰¹æ®Šå€¼EXC_RETURNï¼Œè¿™æ˜¯å†™å…¥PCä»¥é€€å‡ºå¤„ç†ç¨‹åºæ‰€å¿…éœ€çš„-ä¸ä»…æ˜¯å†™å…¥å®ƒï¼Œè€Œä¸”è¿˜éœ€è¦ä½¿ç”¨POPæˆ–BXå‘½ä»¤æ¥æ‰§è¡Œï¼ˆä¾‹å¦‚ï¼Œâ€œ mov pcï¼Œlrï¼Œä¸èµ·ä½œç”¨â€ ï¼Œå°½ç®¡åœ¨æ‚¨çœ‹æ¥è¿™æ˜¯ç¬¬ä¸€æ¬¡ï¼Œä½†ç¡®å®å¯è¡Œã€‚  BX LRçœ‹èµ·æ¥åƒæ˜¯å°è¯•å»ä¸€ä¸ªæ— æ„ä¹‰çš„åœ°å€ï¼ˆåœ¨LRä¸­ï¼Œç±»ä¼¼äº0xFFFFFFF1çš„ä¸œè¥¿ä¸æˆ‘ä»¬éœ€è¦è¿”å›çš„è¿‡ç¨‹çš„çœŸå®åœ°å€æ— å…³ï¼‰ï¼Œä½†å®é™…ä¸Šå¤„ç†å™¨åœ¨PCä¸Šçœ‹åˆ°äº†è¯¥å€¼ï¼ˆå®ƒå°†å»å¾€ä½•å¤„ï¼‰è‡ªåŠ¨ï¼‰ï¼Œå®ƒå°†ä»å †æ ˆä¸­æ¢å¤å¯„å­˜å™¨å¹¶ç»§ç»­æ‰§è¡Œæˆ‘ä»¬çš„è¿‡ç¨‹-ç”±äºæˆ‘ä»¬æ‰‹åŠ¨å°†å †æ ˆä¸­PCçš„æ•°é‡å¢åŠ äº†2ï¼Œå› æ­¤åœ¨è°ƒç”¨HardFaultä¹‹åæ‰§è¡Œä¸‹ä¸€ä¸ªè¿‡ç¨‹ã€‚ <br><br> æ‚¨å½“ç„¶å¯ä»¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨å“ªé‡Œæ¸…æ¥šåœ°</a>äº†è§£æ‰€æœ‰åç§»é‡å’Œå‘½ä»¤ã€‚ <br><br> å¥½å§ï¼Œæˆ–è€…å¦‚æœå¹»æ•°ä¸å¯è§ï¼Œåˆ™æ‰€æœ‰å†…å®¹éƒ½å°†ç§»äº¤ç»™regular_handlerï¼Œç„¶åéµå¾ªå¸¸è§„çš„HardFaultå¤„ç†è¿‡ç¨‹-é€šå¸¸ï¼Œè¿™æ˜¯ä¸€ä¸ªå°†å¯„å­˜å™¨å€¼æ‰“å°åˆ°æ§åˆ¶å°ï¼Œå†³å®šä¸‹ä¸€æ­¥å¦‚ä½•å¤„ç†å¤„ç†å™¨çš„å‡½æ•°ï¼Œç­‰ç­‰ã€‚ <br><br><h4>  RAMå¤§å°ç¡®å®š </h4><br> ä½¿ç”¨æ‰€æœ‰è¿™äº›éƒ½éå¸¸ç®€å•æ˜äº†ã€‚ æˆ‘ä»¬è¦ç¼–å†™ä¸€ç§å›ºä»¶ï¼Œè¯¥å›ºä»¶å¯åœ¨å…·æœ‰ä¸åŒRAMæ•°é‡çš„å‡ ä¸ªå¾®æ§åˆ¶å™¨ä¸Šå·¥ä½œï¼Œè€Œæ¯æ¬¡éƒ½åœ¨å®Œæ•´ç¨‹åºä¸­ä½¿ç”¨RAMå—ï¼Ÿ <br><br> æ˜¯çš„ï¼Œå¾ˆç®€å•ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> uint32_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cpu_find_memory_size</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *base, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> block, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> maxsize)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *address = base; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { address += block; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!cpu_check_address(address)) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span>)(address - base) &lt; maxsize); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span>)(address - base); } <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> get_cpu_ram_size(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cpu_find_memory_size((<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *)SRAM_BASE, <span class="hljs-number"><span class="hljs-number">4096</span></span>, <span class="hljs-number"><span class="hljs-number">80</span></span>*<span class="hljs-number"><span class="hljs-number">1024</span></span>); }</code> </pre> <br> é‚£ä¹ˆå°±éœ€è¦maxsizeï¼Œä»¥ä¾¿åœ¨å®ƒä¸ä¸‹ä¸€ä¸ªåœ°å€å—ä¹‹é—´çš„RAMå¯èƒ½è¾¾åˆ°æœ€å¤§æ•°é‡çš„æƒ…å†µä¸‹ï¼Œcpu_check_addressä¸ä¼šä¸­æ–­ã€‚ åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œå®ƒæ˜¯80 KBã€‚ æ¢æŸ¥æ‰€æœ‰åœ°å€ä¹Ÿæ²¡æœ‰ä»»ä½•æ„ä¹‰-åªéœ€çœ‹ä¸€ä¸‹æ•°æ®è¡¨ï¼Œçœ‹çœ‹ä¸¤ä¸ªæ§åˆ¶å™¨æ¨¡å‹ä¹‹é—´çš„æœ€å°å¯èƒ½æ­¥éª¤æ˜¯ä»€ä¹ˆï¼Œå¹¶å°†å…¶è®¾ç½®ä¸ºå—ã€‚ <br><br><h4> ä»¥ç¼–ç¨‹æ–¹å¼è¿‡æ¸¡åˆ°ä½äºä»»ä½•åœ°æ–¹ä¸­é—´çš„å¼•å¯¼åŠ è½½ç¨‹åº </h4><br> æœ‰æ—¶æ‚¨å¯ä»¥åšä¸€äº›æ›´å¤æ‚çš„æŠ€å·§-ä¾‹å¦‚ï¼Œå‡è®¾æ‚¨æƒ³ä»¥ç¼–ç¨‹æ–¹å¼è·³è½¬è‡³å·¥å‚å‡ºå‚çš„å¼•å¯¼åŠ è½½ç¨‹åºSTM32ï¼Œä»¥é€šè¿‡UARTæˆ–USBåˆ‡æ¢è‡³å›ºä»¶æ›´æ–°æ¨¡å¼ï¼Œè€Œä¸å¿…è´¹å¿ƒç¼–å†™å¼•å¯¼åŠ è½½ç¨‹åºã€‚ <br><br>  STM32å¼•å¯¼åŠ è½½ç¨‹åºä½äºæ‚¨éœ€è¦è½¬åˆ°çš„ç§°ä¸ºç³»ç»Ÿå†…å­˜çš„åŒºåŸŸï¼Œä½†æ˜¯å­˜åœ¨ä¸€ä¸ªé—®é¢˜-è¯¥åŒºåŸŸä¸ä»…åœ¨ä¸åŒç³»åˆ—çš„å¤„ç†å™¨ä¸Šè€Œä¸”åœ¨åŒä¸€ç³»åˆ—çš„ä¸åŒå‹å·ä¸Šå…·æœ‰ä¸åŒçš„åœ°å€ï¼ˆå¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">AN2606</a>ä¸Šæ‰¾åˆ°å²è¯—èˆ¬çš„é“­ç‰Œï¼‰ã€‚ç¬¬22è‡³26é¡µï¼‰ã€‚ é€šå¸¸ï¼Œå½“æ‚¨å°†ç›¸åº”åŠŸèƒ½æ·»åŠ åˆ°å¹³å°è€Œä¸æ˜¯ä»…æ·»åŠ åˆ°ç‰¹å®šäº§å“æ—¶ï¼Œæ‚¨éœ€è¦å¤šåŠŸèƒ½æ€§ã€‚ <br><br> åœ¨CMSISæ–‡ä»¶ä¸­ï¼Œç³»ç»Ÿå†…å­˜çš„èµ·å§‹åœ°å€ä¹Ÿä¸¢å¤±äº†ã€‚ æ— æ³•é€šè¿‡Bootloader IDæ¥ç¡®å®šå®ƒï¼Œå› ä¸º è¿™æ˜¯ä¸€ä¸ªéº»çƒ¦çš„é—®é¢˜-Bootloader IDä½äºç³»ç»Ÿå†…å­˜çš„æœ€åä¸€ä¸ªå­—èŠ‚ä¸­ï¼Œè¿™ä½¿æˆ‘ä»¬å›åˆ°äº†åœ°å€é—®é¢˜ã€‚ <br><br> ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬æŸ¥çœ‹STM32å­˜å‚¨å¡ï¼Œå°†ä¼šçœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹å†…å®¹ï¼š <br><br><img src="https://habrastorage.org/webt/l4/nf/b3/l4nfb3xcw87qnsrey9n4mp3t0we.png"><br> åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯¹ç³»ç»Ÿå†…å­˜ç¯å¢ƒæ„Ÿå…´è¶£-ä¾‹å¦‚ï¼Œæœ€ä¸Šé¢æ˜¯ä¸€ä¸ªæ›¾ç»å¯ç¼–ç¨‹çš„åŒºåŸŸï¼ˆå¹¶éæ‰€æœ‰STM32ï¼‰å’Œé€‰é¡¹å­—èŠ‚ï¼ˆå…¨éƒ¨ï¼‰ã€‚ ä¸ä»…åœ¨ä¸åŒçš„æ¨¡å‹ä¸­ï¼Œè€Œä¸”åœ¨ä¸åŒçš„STM32ç³»åˆ—ä¸­ï¼Œéƒ½è§‚å¯Ÿåˆ°è¿™ç§ç»“æ„ï¼Œå”¯ä¸€çš„åŒºåˆ«åœ¨äºOTPçš„å­˜åœ¨ä»¥åŠç³»ç»Ÿå†…å­˜å’Œé€‰ä»¶ä¹‹é—´åœ°å€ä¸­çš„é—´éš™çš„å­˜åœ¨ã€‚ <br><br> ä½†æ˜¯å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œæœ€é‡è¦çš„æ˜¯é€‰é¡¹å­—èŠ‚çš„èµ·å§‹åœ°å€åœ¨å¸¸è§„çš„CMSISæ ‡å¤´ä¸­-åœ¨æ­¤å¤„è¢«ç§°ä¸ºOB_BASEã€‚ <br><br> æ›´ç®€å•ã€‚ æˆ‘ä»¬ç¼–å†™è¯¥å‡½æ•°ä»¥ä»æŒ‡å®šåœ°å€å‘ä¸‹æˆ–å‘ä¸Šæœç´¢ç¬¬ä¸€ä¸ªæœ‰æ•ˆæˆ–æ— æ•ˆåœ°å€ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cpu_find_next_valid_address</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *start, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *stop, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> valid)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *address = start; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (address == stop) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cpu_check_address(address) == valid) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> address; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (stop &gt; start) { address++; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { address--; } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; }</code> </pre> <br> ç„¶åä»Optionå­—èŠ‚å‘ä¸‹çœ‹ï¼Œé¦–å…ˆæ˜¯ç³»ç»Ÿå†…å­˜æˆ–ä¸å…¶ç›¸é‚»çš„OTPçš„æœ«å°¾ï¼Œç„¶åæ˜¯ä¸¤æ¬¡éå†ï¼Œç„¶åæ˜¯ç³»ç»Ÿå†…å­˜çš„å¼€å§‹ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* System memory is the valid area next _below_ Option bytes */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *a, *b, *c; a = (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *)(OB_BASE - <span class="hljs-number"><span class="hljs-number">1</span></span>); b = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Here we have System memory top address */</span></span> c = cpu_find_next_valid_address(a, b, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* Here we have System memory bottom address */</span></span> c = cpu_find_next_valid_address(c, b, <span class="hljs-literal"><span class="hljs-literal">false</span></span>) + <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br> æ¯«ä¸è´¹åŠ›åœ°ï¼Œæˆ‘ä»¬å°†å…¶å®‰æ’åˆ°ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œè¯¥å‡½æ•°æŸ¥æ‰¾ç³»ç»Ÿå†…å­˜çš„å¼€å¤´å¹¶è·³è½¬åˆ°è¯¥å†…å­˜ï¼Œå³å®ƒå¯åŠ¨å¼•å¯¼åŠ è½½ç¨‹åºï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jump_to_bootloader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> __</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">attribute__</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">((noreturn))</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Sets up and jumps to the bootloader */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jump_to_bootloader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* System memory is the valid area next _below_ Option bytes */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *a, *b, *c; a = (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *)(OB_BASE - <span class="hljs-number"><span class="hljs-number">1</span></span>); b = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Here we have System memory top address */</span></span> c = cpu_find_next_valid_address(a, b, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* Here we have System memory bottom address */</span></span> c = cpu_find_next_valid_address(c, b, <span class="hljs-literal"><span class="hljs-literal">false</span></span>) + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!c) { NVIC_SystemReset(); } <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> boot_addr = (<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span>)c; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> boot_stack_ptr = *(<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span>*)(boot_addr); <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> dfu_reset_addr = *(<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span>*)(boot_addr+<span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (*dfu_bootloader)(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) = (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (*))(dfu_reset_addr); <span class="hljs-comment"><span class="hljs-comment">/* Reset the stack pointer */</span></span> __set_MSP(boot_stack_ptr); dfu_bootloader(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br> è¿™å–å†³äºç‰¹å®šçš„å¤„ç†å™¨å‹å·â€¦â€¦ä»€ä¹ˆéƒ½æ²¡æœ‰ã€‚ é€»è¾‘ä¸é€‚ç”¨äºåœ¨OTPå’Œç³»ç»Ÿå†…å­˜ä¹‹é—´å­˜åœ¨æ¼æ´çš„æ¨¡å‹-ä½†æˆ‘æ²¡æœ‰æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•é—®é¢˜ã€‚ å°†ç§¯æä½¿ç”¨OTP-æ£€æŸ¥ã€‚ <br><br> å…¶ä»–æŠ€å·§ä»…é€‚ç”¨äºä»ä»£ç ä¸­è°ƒç”¨å¼•å¯¼åŠ è½½ç¨‹åºçš„é€šå¸¸è¿‡ç¨‹-ä¸è¦åœ¨åˆå§‹åŒ–å¤–å›´è®¾å¤‡ï¼Œæ—¶é’Ÿé€Ÿåº¦ç­‰ä¹‹å‰å¿˜è®°é‡ç½®å †æ ˆæŒ‡é’ˆå¹¶è°ƒç”¨ç¦»å¼€å¼•å¯¼åŠ è½½ç¨‹åºçš„è¿‡ç¨‹ã€‚ç”±äºå…¶æç®€ä¸»ä¹‰ï¼Œå¼•å¯¼åŠ è½½ç¨‹åºå¯ä»¥é˜»å¡åˆå§‹åŒ–å¤–å›´è®¾å¤‡å¹¶æœŸæœ›å®ƒå¤„äºé»˜è®¤çŠ¶æ€ã€‚ ä»ç¨‹åºä¸­çš„ä»»æ„ä½ç½®è°ƒç”¨å¼•å¯¼åŠ è½½ç¨‹åºçš„ä¸€ä¸ªå¥½æ–¹æ³•æ˜¯å†™å…¥RTCå¤‡ä»½å¯„å­˜å™¨æˆ–ç®€å•åœ°å†™å…¥å¹»æ•°å­˜å‚¨å™¨ä¸­çš„å·²çŸ¥åœ°å€ï¼Œç¨‹åºé‡æ–°å¯åŠ¨å¹¶åœ¨åˆå§‹åŒ–è¯¥æ•°çš„æœ€åˆé˜¶æ®µè¿›è¡Œæ£€æŸ¥ã€‚ <br><br>  PSç”±äºå¤„ç†å™¨å­˜å‚¨å¡ä¸­çš„æ‰€æœ‰åœ°å€åœ¨æœ€åçš„æƒ…å†µä¸‹éƒ½æŒ‰4å¯¹é½ï¼Œå› æ­¤é€šè¿‡ä»¥4ä¸ªå­—èŠ‚ï¼ˆè€Œä¸æ˜¯1ä¸ªå­—èŠ‚ï¼‰çš„å¢é‡é€æ­¥è®¿é—®å®ƒä»¬çš„æƒ³æ³•å°†å¤§å¤§åŠ å¿«ä¸Šè¿°è¿‡ç¨‹ã€‚ <br><br><h4> é‡è¦å‘Šç¤º </h4><br> æ³¨æ„ï¼šè¯·æ³¨æ„ï¼Œåœ¨ç‰¹å®šæ§åˆ¶å™¨ä¸Šï¼Œç‰¹å®šåœ°å€çš„æœ‰æ•ˆæ€§å¹¶ä¸ä¸€å®šè¡¨ç¤ºè¯¥åœ°å€å¯èƒ½å®é™…å­˜åœ¨åŠŸèƒ½ã€‚ ä¾‹å¦‚ï¼Œæ§åˆ¶æŸäº›å¯é€‰å¤–å›´æ¨¡å—çš„å¯„å­˜å™¨åœ°å€å¯èƒ½æ˜¯æœ‰æ•ˆçš„ï¼Œå°½ç®¡è¯¥æ¨¡å—æœ¬èº«ä¸å­˜åœ¨è¯¥æ¨¡å—ã€‚ ä»åˆ¶é€ å•†çš„è§’åº¦æ¥çœ‹ï¼Œæœ€æœ‰è¶£çš„æŠ€å·§æ˜¯å¯èƒ½çš„ï¼Œé€šå¸¸æ˜¯å‡ºäºå¯¹ä¸åŒå¤„ç†å™¨å‹å·ä½¿ç”¨ç›¸åŒæ™¶ä½“çš„åŸå› ã€‚ ä½†æ˜¯ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿™äº›ç¨‹åºå¯ä»¥å·¥ä½œå¹¶ä¸”è¯æ˜éå¸¸æœ‰ç”¨ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN437256/">https://habr.com/ru/post/zh-CN437256/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN437244/index.html">Googleæ•™ç”¨æˆ·è¯†åˆ«ç½‘ç»œé’“é±¼ç”µå­é‚®ä»¶</a></li>
<li><a href="../zh-CN437248/index.html">åœ£å½¼å¾—å ¡çš„FPGA mitap</a></li>
<li><a href="../zh-CN437250/index.html">æˆ‘ä»¬å¦‚ä½•åˆ¶ä½œä¸éœ€è¦è®¾è®¡å¸ˆçš„ç§»åŠ¨åº”ç”¨ç¨‹åº</a></li>
<li><a href="../zh-CN437252/index.html">SDL 2.0è¯¾ç¨‹å‘¨æœŸï¼šç¬¬3è¯¾-SDLæ‰©å±•åº“</a></li>
<li><a href="../zh-CN437254/index.html">ä¸‰å…ƒè®¡ç®—ï¼šåŸºç¡€çŸ¥è¯†</a></li>
<li><a href="../zh-CN437258/index.html">CATIA DESIGNå›¢é˜Ÿçš„ç‹¬ç‰¹é¡¹ç›®ï¼šBleuæ¦‚å¿µè½¦</a></li>
<li><a href="../zh-CN437260/index.html">Windows Phone 8.1ï¼šæ€€æ—§åå¼€å‘ã€‚ å•ä¸€ç”³è¯·å†å²</a></li>
<li><a href="../zh-CN437262/index.html">æ²³æ°´å¦‚ä½•é¥®ç”¨ï¼Ÿ</a></li>
<li><a href="../zh-CN437264/index.html">ITä¸“ä¸šå€¦æ€ ï¼ˆâ€œæˆ‘çš„åœˆå­â€ç ”ç©¶ç»“æœï¼‰</a></li>
<li><a href="../zh-CN437270/index.html">æˆ‘ä»¬ä½¿ç”¨QEMUå’ŒIntel GVT-géƒ¨ç½²å…·æœ‰è™šæ‹Ÿè§†é¢‘å¡è½¬å‘åŠŸèƒ½çš„Windowsè™šæ‹Ÿæœº</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>