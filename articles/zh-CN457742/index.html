<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ’° ğŸ¤šğŸ» ğŸ”™ Kuberneteså’ŒPrometheusç‚‰åºŠçš„æ°´å¹³è‡ªåŠ¨æ‰©å±•ï¼Œä»¥å®ç°é«˜å¯ç”¨æ€§å’ŒåŸºç¡€æ¶æ„çš„å¯ç”¨æ€§ ğŸ‘¼ ğŸ¦— ğŸ¥‰</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æ•¬ç¤¼ï¼Œå“ˆå¸ƒé‡Œæ²ƒæ´¾ï¼ ä»¥ä¸‹æ–‡ç« çš„ç¿»è¯‘æ˜¯ä¸“é—¨ä¸ºåŸºäºKubernetesçš„åŸºç¡€è®¾æ–½å¹³å°è¯¾ç¨‹çš„å­¦ç”Ÿå‡†å¤‡çš„ï¼Œè¯¥è¯¾ç¨‹å°†äºæ˜å¤©å¼€å§‹ã€‚ è®©æˆ‘ä»¬å¼€å§‹å§ã€‚ 



 Kubernetesä¸­çš„è‡ªåŠ¨ç¼©æ”¾ 
 è‡ªåŠ¨æ‰©å±•å…è®¸æ‚¨æ ¹æ®èµ„æºçš„ä½¿ç”¨æ¥è‡ªåŠ¨å¢åŠ å’Œå‡å°‘å·¥ä½œé‡ã€‚ 

 Kubernetesè‡ªåŠ¨ç¼©æ”¾å…·æœ‰ä¸¤ä¸ªç»´åº¦ï¼š 



- ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Kuberneteså’ŒPrometheusç‚‰åºŠçš„æ°´å¹³è‡ªåŠ¨æ‰©å±•ï¼Œä»¥å®ç°é«˜å¯ç”¨æ€§å’ŒåŸºç¡€æ¶æ„çš„å¯ç”¨æ€§</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/457742/"> æ•¬ç¤¼ï¼Œå“ˆå¸ƒé‡Œæ²ƒæ´¾ï¼ ä»¥ä¸‹æ–‡ç« çš„ç¿»è¯‘æ˜¯ä¸“é—¨ä¸º<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åŸºäºKubernetesçš„åŸºç¡€è®¾æ–½å¹³å°</a>è¯¾ç¨‹çš„å­¦ç”Ÿå‡†å¤‡çš„ï¼Œè¯¥è¯¾ç¨‹å°†äºæ˜å¤©å¼€å§‹ã€‚ è®©æˆ‘ä»¬å¼€å§‹å§ã€‚ <br><br><img src="https://habrastorage.org/webt/ex/tr/ly/extrlyzx2l86vdau8i-upyejtf4.png"><br><br><h3>  Kubernetesä¸­çš„è‡ªåŠ¨ç¼©æ”¾ </h3><br> è‡ªåŠ¨æ‰©å±•å…è®¸æ‚¨æ ¹æ®èµ„æºçš„ä½¿ç”¨æ¥è‡ªåŠ¨å¢åŠ å’Œå‡å°‘å·¥ä½œé‡ã€‚ <br><br>  Kubernetesè‡ªåŠ¨ç¼©æ”¾å…·æœ‰ä¸¤ä¸ªç»´åº¦ï¼š <br><br><ul><li> é›†ç¾¤è‡ªåŠ¨ç¼©æ”¾å™¨ï¼Œè´Ÿè´£ç¼©æ”¾èŠ‚ç‚¹ï¼› </li><li>  Horizoâ€‹â€‹ntal Pod Autoscalerï¼ˆHPAï¼‰ï¼Œå¯è‡ªåŠ¨ç¼©æ”¾éƒ¨ç½²æˆ–å‰¯æœ¬é›†ä¸­çš„ç‚‰åºŠæ•°é‡ã€‚ </li></ul><br> ç¾¤é›†è‡ªåŠ¨ç¼©æ”¾å¯ä¸æ°´å¹³ç‚‰åºŠè‡ªåŠ¨ç¼©æ”¾ç»“åˆä½¿ç”¨ï¼Œä»¥åŠ¨æ€æ§åˆ¶è®¡ç®—èµ„æºå’Œéµå®ˆæœåŠ¡æ°´å¹³åè®®ï¼ˆSLAï¼‰æ‰€éœ€çš„ç³»ç»Ÿå¹¶å‘ç¨‹åº¦ã€‚ <a name="habracut"></a><br><br> é›†ç¾¤è‡ªåŠ¨æ‰©å±•åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºæ‰˜ç®¡é›†ç¾¤çš„äº‘åŸºç¡€æ¶æ„æä¾›å•†çš„åŠŸèƒ½ï¼Œå¹¶ä¸”HPAå¯ä»¥ç‹¬ç«‹äºIaaS / PaaSæä¾›å•†è¿è¡Œã€‚ <br><br><h3>  HPAå¼€å‘ </h3><br> è‡ªä»å¼•å…¥Kubernetes v1.1ä»¥æ¥ï¼Œæ°´å¹³ç‚‰åºŠè‡ªåŠ¨ç¼©æ”¾å·²å‘ç”Ÿäº†é‡å¤§å˜åŒ–ã€‚  HPAçš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬æ ¹æ®æµ‹é‡çš„CPUæ¶ˆè€—é‡æ¥ç¼©æ”¾ç‚‰åºŠï¼Œç„¶åæ ¹æ®å†…å­˜ä½¿ç”¨é‡æ¥ç¼©æ”¾ç‚‰åºŠã€‚  Kubernetes 1.6å¼•å…¥äº†ä¸€ä¸ªç§°ä¸ºè‡ªå®šä¹‰æŒ‡æ ‡çš„æ–°APIï¼Œè¯¥APIä½¿HPAå¯ä»¥è®¿é—®è‡ªå®šä¹‰æŒ‡æ ‡ã€‚  Kubernetes 1.7æ·»åŠ äº†ä¸€ä¸ªèšåˆçº§åˆ«ï¼Œè¯¥çº§åˆ«å…è®¸ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºé€šè¿‡æ³¨å†Œä¸ºAPIé™„åŠ ç»„ä»¶æ¥æ‰©å±•Kubernetes APIã€‚ <br><br> å¤šäºäº†Custom Metrics APIå’Œèšåˆçº§åˆ«ï¼ŒPrometheusä¹‹ç±»çš„ç›‘æ§ç³»ç»Ÿå¯ä»¥ä¸ºHPAæ§åˆ¶å™¨æä¾›ç‰¹å®šäºåº”ç”¨ç¨‹åºçš„æŒ‡æ ‡ã€‚ <br><br> æ°´å¹³ç‚‰åºŠè‡ªåŠ¨ç¼©æ”¾åŠŸèƒ½æ˜¯ä½œä¸ºæ§åˆ¶å¾ªç¯å®ç°çš„ï¼Œå®ƒä¼šå®šæœŸå‘Resource Metrics APIï¼ˆèµ„æºæŒ‡æ ‡APIï¼‰æŸ¥è¯¢å…³é”®æŒ‡æ ‡ï¼ˆä¾‹å¦‚CPUå’Œå†…å­˜ä½¿ç”¨æƒ…å†µï¼‰ï¼Œå¹¶å‘Custom Metrics APIï¼ˆè‡ªå®šä¹‰æŒ‡æ ‡APIï¼‰æŸ¥è¯¢ç‰¹å®šçš„åº”ç”¨ç¨‹åºæŒ‡æ ‡ã€‚ <br><br><img src="https://habrastorage.org/webt/j3/7c/-b/j37c-bs-leoz4u_a8tg6ov6zflu.png"><br><br> ä»¥ä¸‹æ˜¯ä¸ºKubernetes 1.9å’Œæ›´é«˜ç‰ˆæœ¬é…ç½®HPA v2çš„åˆ†æ­¥æŒ‡å—ã€‚ <br><br><ol><li> å®‰è£…æä¾›å…³é”®æŒ‡æ ‡çš„Metrics ServeråŠ è½½é¡¹ã€‚ </li><li> å¯åŠ¨æ¼”ç¤ºåº”ç”¨ç¨‹åºï¼Œä»¥æŸ¥çœ‹åŸºäºCPUå’Œå†…å­˜ä½¿ç”¨æƒ…å†µçš„ç‚‰è†›è‡ªåŠ¨ç¼©æ”¾å·¥ä½œæ–¹å¼ã€‚ </li><li> éƒ¨ç½²Prometheuså’Œè‡ªå®šä¹‰APIæœåŠ¡å™¨ã€‚ åœ¨èšåˆçº§åˆ«æ³¨å†Œè‡ªå®šä¹‰APIæœåŠ¡å™¨ã€‚ </li><li> ä½¿ç”¨æ¼”ç¤ºåº”ç”¨ç¨‹åºæä¾›çš„è‡ªå®šä¹‰æŒ‡æ ‡é…ç½®HPAã€‚ </li></ol><br> åœ¨å¼€å§‹ä¹‹å‰ï¼Œæ‚¨å¿…é¡»å®‰è£…Goç‰ˆæœ¬1.8ï¼ˆæˆ–æ›´é«˜ç‰ˆæœ¬ï¼‰å¹¶åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GOPATHä¸­</a>å…‹éš†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">k8s-prom-hpaå­˜å‚¨åº“</a> ï¼š <br><br><pre> <code class="go hljs">cd $GOPATH git clone https:<span class="hljs-comment"><span class="hljs-comment">//github.com/stefanprodan/k8s-prom-hpa</span></span></code> </pre> <br><h2>  1.è®¾ç½®æŒ‡æ ‡æœåŠ¡å™¨ </h2><br>  Kubernetes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Metric</a> Serveræ˜¯å–ä»£<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Heapster</a>çš„é›†ç¾¤å†…èµ„æºåˆ©ç”¨æ•°æ®èšåˆ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å™¨</a> ã€‚ æŒ‡æ ‡æœåŠ¡å™¨ä»<code>kubernetes.summary_api</code>æ”¶é›†èŠ‚ç‚¹å’Œç‚‰è†›çš„CPUå’Œå†…å­˜ä½¿ç”¨æƒ…å†µä¿¡æ¯ã€‚  Summary APIæ˜¯ä¸€ç§å†…å­˜é«˜æ•ˆçš„APIï¼Œç”¨äºå°†Kubelet / cAdvisoræ•°æ®æŒ‡æ ‡ä¼ è¾“åˆ°æœåŠ¡å™¨ã€‚ <br><br><img src="https://habrastorage.org/webt/a-/ks/a5/a-ksa5k66aqr8auak_onalu3jki.png"><br><br> åœ¨HPAçš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ä¸­ï¼Œéœ€è¦ä¸€ä¸ªHeapsterèšåˆå™¨æ¥è·å–CPUå’Œå†…å­˜ã€‚ åœ¨HPA v2å’ŒKubernetes 1.8ä¸­ï¼Œä»…å¯ç”¨Metricçš„æœåŠ¡å™¨æ˜¯å¿…éœ€çš„ï¼Œå¹¶ä¸”å¯ç”¨äº†Horizoâ€‹â€‹ntal <code>horizontal-pod-autoscaler-use-rest-clients</code> ã€‚  Kubernetes 1.9é»˜è®¤å¯ç”¨æ­¤é€‰é¡¹ã€‚  GKE 1.9é™„å¸¦äº†ä¸€ä¸ªé¢„å®‰è£…çš„æŒ‡æ ‡æœåŠ¡å™¨ã€‚ <br><br> åœ¨<code>kube-system</code>å‘½åç©ºé—´ä¸­å±•å¼€æŒ‡æ ‡æœåŠ¡å™¨ï¼š <br><br><pre> <code class="go hljs">kubectl create -f ./metrics-server</code> </pre> <br>  1åˆ†é’Ÿåï¼Œ <code>metric-server</code>å°†å¼€å§‹ä¼ è¾“æœ‰å…³èŠ‚ç‚¹å’ŒPodä½¿ç”¨CPUå’Œå†…å­˜çš„æ•°æ®ã€‚ <br><br> æŸ¥çœ‹èŠ‚ç‚¹æŒ‡æ ‡ï¼š <br><br><pre> <code class="go hljs">kubectl get --raw <span class="hljs-string"><span class="hljs-string">"/apis/metrics.k8s.io/v1beta1/nodes"</span></span> | jq .</code> </pre> <br> æŸ¥çœ‹å¿ƒå¾‹æŒ‡æ ‡ï¼š <br><br><pre> <code class="go hljs">kubectl get --raw <span class="hljs-string"><span class="hljs-string">"/apis/metrics.k8s.io/v1beta1/pods"</span></span> | jq .</code> </pre> <br><h2>  2.æ ¹æ®CPUå’Œå†…å­˜ä½¿ç”¨é‡è‡ªåŠ¨ç¼©æ”¾ </h2><br> è¦æµ‹è¯•ç‚‰è†›æ°´å¹³è‡ªåŠ¨ç¼©æ”¾ï¼ˆHPAï¼‰ï¼Œå¯ä»¥ä½¿ç”¨åŸºäºGolangçš„å°å‹Webåº”ç”¨ç¨‹åºã€‚ <br><br> åœ¨<code>default</code>åç§°ç©ºé—´ä¸­å±•å¼€<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">podinfo</a> ï¼š <br><br><pre> <code class="go hljs">kubectl create -f ./podinfo/podinfo-svc.yaml,./podinfo/podinfo-dep.yaml</code> </pre> <br> ä½¿ç”¨NodePortæœåŠ¡é€šè¿‡ä»¥ä¸‹<code>http://&lt;K8S_PUBLIC_IP&gt;:31198</code>è”ç³»<code>podinfo</code> ï¼š <code>http://&lt;K8S_PUBLIC_IP&gt;:31198</code> ã€‚ <br><br> å¦‚æœå¹³å‡CPUåˆ©ç”¨ç‡è¶…è¿‡80ï¼…æˆ–å†…å­˜æ¶ˆè€—è¶…è¿‡200 MiBï¼Œåˆ™æŒ‡å®šä¸€ä¸ªå°†è‡³å°‘æœåŠ¡ä¸¤ä¸ªå‰¯æœ¬çš„HPAï¼Œå¹¶æ‰©å±•åˆ°åä¸ªå‰¯æœ¬ï¼š <br><br><pre> <code class="go hljs">apiVersion: autoscaling/v2beta1 kind: HorizontalPodAutoscaler metadata: name: podinfo spec: scaleTargetRef: apiVersion: extensions/v1beta1 kind: Deployment name: podinfo minReplicas: <span class="hljs-number"><span class="hljs-number">2</span></span> maxReplicas: <span class="hljs-number"><span class="hljs-number">10</span></span> metrics: - <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: Resource resource: name: cpu targetAverageUtilization: <span class="hljs-number"><span class="hljs-number">80</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: Resource resource: name: memory targetAverageValue: <span class="hljs-number"><span class="hljs-number">200</span></span>Mi</code> </pre> <br> åˆ›å»ºHPAï¼š <br><br><pre> <code class="go hljs">kubectl create -f ./podinfo/podinfo-hpa.yaml</code> </pre> <br> å‡ ç§’é’Ÿåï¼ŒHPAæ§åˆ¶å™¨å°†è”ç³»åº¦é‡æœåŠ¡å™¨å¹¶æ¥æ”¶æœ‰å…³CPUå’Œå†…å­˜ä½¿ç”¨æƒ…å†µçš„ä¿¡æ¯ï¼š <br><br><pre> <code class="go hljs">kubectl get hpa NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE podinfo Deployment/podinfo <span class="hljs-number"><span class="hljs-number">2826240</span></span> / <span class="hljs-number"><span class="hljs-number">200</span></span>Mi, <span class="hljs-number"><span class="hljs-number">15</span></span>% / <span class="hljs-number"><span class="hljs-number">80</span></span>% <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>m</code> </pre> <br> è¦å¢åŠ CPUä½¿ç”¨ç‡ï¼Œè¯·ä½¿ç”¨rakyll / heyè¿›è¡Œè´Ÿè½½æµ‹è¯•ï¼š <br><br><pre> <code class="go hljs">#install hey <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> get -u github.com/rakyll/hey #do <span class="hljs-number"><span class="hljs-number">10</span></span>K requests hey -n <span class="hljs-number"><span class="hljs-number">10000</span></span> -q <span class="hljs-number"><span class="hljs-number">10</span></span> -c <span class="hljs-number"><span class="hljs-number">5</span></span> http:<span class="hljs-comment"><span class="hljs-comment">//&lt;K8S_PUBLIC_IP&gt;:31198/</span></span></code> </pre> <br> æ‚¨å¯ä»¥æŒ‰ä»¥ä¸‹æ–¹å¼ç›‘è§†HPAäº‹ä»¶ï¼š <br><br><pre> <code class="go hljs">$ kubectl describe hpa Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal SuccessfulRescale <span class="hljs-number"><span class="hljs-number">7</span></span>m horizontal-pod-autoscaler New size: <span class="hljs-number"><span class="hljs-number">4</span></span>; reason: cpu resource utilization (percentage of request) above target Normal SuccessfulRescale <span class="hljs-number"><span class="hljs-number">3</span></span>m horizontal-pod-autoscaler New size: <span class="hljs-number"><span class="hljs-number">8</span></span>; reason: cpu resource utilization (percentage of request) above target</code> </pre> <br> æš‚æ—¶åˆ é™¤podinfoï¼ˆæ‚¨å¿…é¡»åœ¨æœ¬æŒ‡å—çš„åç»­æ­¥éª¤ä¹‹ä¸€ä¸­é‡æ–°éƒ¨ç½²å®ƒï¼‰ã€‚ <br><br><pre> <code class="go hljs">kubectl <span class="hljs-built_in"><span class="hljs-built_in">delete</span></span> -f ./podinfo/podinfo-hpa.yaml,./podinfo/podinfo-dep.yaml,./podinfo/podinfo-svc.yaml</code> </pre> <br><h2>  3.è‡ªå®šä¹‰æŒ‡æ ‡æœåŠ¡å™¨è®¾ç½® </h2><br> è¦åŸºäºè‡ªå®šä¹‰æŒ‡æ ‡è¿›è¡Œæ‰©å±•ï¼Œéœ€è¦ä¸¤ä¸ªç»„ä»¶ã€‚ ç¬¬ä¸€ä¸ªæ•°æ®åº“<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">-Prometheus</a>æ—¶é—´åºåˆ—æ•°æ®åº“-æ”¶é›†åº”ç”¨ç¨‹åºæŒ‡æ ‡å¹¶ä¿å­˜ã€‚ ç¬¬äºŒä¸ªç»„ä»¶<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">k8s-prometheus-adapter</a>ç”¨æ„å»ºå™¨æä¾›çš„åº¦é‡æ ‡å‡†å¯¹Custom Metrics API Kubernetesè¿›è¡Œè¡¥å……ã€‚ <br><br><img src="https://habrastorage.org/webt/hf/g5/-j/hfg5-js5hf_5ldfgkrhk0dwgfu0.png"><br><br> ä¸“ç”¨åç§°ç©ºé—´ç”¨äºéƒ¨ç½²Prometheuså’Œé€‚é…å™¨ã€‚ <br><br> åˆ›å»ºä¸€ä¸ª<code>monitoring</code>åç§°ç©ºé—´ï¼š <br><br><pre> <code class="go hljs">kubectl create -f ./namespaces.yaml</code> </pre> <br> åœ¨<code>monitoring</code>åç§°ç©ºé—´ä¸­å±•å¼€Prometheus v2ï¼š <br><br><pre> <code class="go hljs">kubectl create -f ./prometheus</code> </pre> <br> ç”ŸæˆPrometheusé€‚é…å™¨æ‰€éœ€çš„TLSè¯ä¹¦ï¼š <br><br><pre> <code class="go hljs"><span class="hljs-built_in"><span class="hljs-built_in">make</span></span> certs</code> </pre> <br> éƒ¨ç½²ç”¨äºè‡ªå®šä¹‰æŒ‡æ ‡APIçš„Prometheusé€‚é…å™¨ï¼š <br><br><pre> <code class="go hljs">kubectl create -f ./custom-metrics-api</code> </pre> <br> è·å–Prometheusæä¾›çš„ç‰¹æ®ŠæŒ‡æ ‡åˆ—è¡¨ï¼š <br><br><pre> <code class="go hljs">kubectl get --raw <span class="hljs-string"><span class="hljs-string">"/apis/custom.metrics.k8s.io/v1beta1"</span></span> | jq .</code> </pre> <br> ç„¶åæå–<code>monitoring</code>åç§°ç©ºé—´ä¸­æ‰€æœ‰podçš„æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨æƒ…å†µæ•°æ®ï¼š <br><br><pre> <code class="go hljs">kubectl get --raw <span class="hljs-string"><span class="hljs-string">"/apis/custom.metrics.k8s.io/v1beta1/namespaces/monitoring/pods/*/fs_usage_bytes"</span></span> | jq .</code> </pre> <br><h2>  4.åŸºäºè‡ªå®šä¹‰æŒ‡æ ‡çš„è‡ªåŠ¨ç¼©æ”¾ </h2><br> åˆ›å»ºNodePort <code>podinfo</code>æœåŠ¡å¹¶éƒ¨ç½²åˆ°<code>default</code>åç§°ç©ºé—´ï¼š <br><br><pre> <code class="go hljs">kubectl create -f ./podinfo/podinfo-svc.yaml,./podinfo/podinfo-dep.yaml</code> </pre> <br>  <code>podinfo</code>åº”ç”¨ç¨‹åºå°†ä¼ é€’ç‰¹æ®ŠæŒ‡æ ‡<code>http_requests_total</code> ã€‚  Prometheusé€‚é…å™¨å°†åˆ é™¤<code>_total</code>åç¼€å¹¶å°†æ­¤åº¦é‡æ ‡å‡†æ ‡è®°ä¸ºè®¡æ•°å™¨ã€‚ <br><br> ä»Custom Metrics APIè·å–æ¯ç§’çš„æŸ¥è¯¢æ€»æ•°ï¼š <br><br><pre> <code class="go hljs">kubectl get --raw <span class="hljs-string"><span class="hljs-string">"/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/*/http_requests"</span></span> | jq . { <span class="hljs-string"><span class="hljs-string">"kind"</span></span>: <span class="hljs-string"><span class="hljs-string">"MetricValueList"</span></span>, <span class="hljs-string"><span class="hljs-string">"apiVersion"</span></span>: <span class="hljs-string"><span class="hljs-string">"custom.metrics.k8s.io/v1beta1"</span></span>, <span class="hljs-string"><span class="hljs-string">"metadata"</span></span>: { <span class="hljs-string"><span class="hljs-string">"selfLink"</span></span>: <span class="hljs-string"><span class="hljs-string">"/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/%2A/http_requests"</span></span> }, <span class="hljs-string"><span class="hljs-string">"items"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"describedObject"</span></span>: { <span class="hljs-string"><span class="hljs-string">"kind"</span></span>: <span class="hljs-string"><span class="hljs-string">"Pod"</span></span>, <span class="hljs-string"><span class="hljs-string">"namespace"</span></span>: <span class="hljs-string"><span class="hljs-string">"default"</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"podinfo-6b86c8ccc9-kv5g9"</span></span>, <span class="hljs-string"><span class="hljs-string">"apiVersion"</span></span>: <span class="hljs-string"><span class="hljs-string">"/__internal"</span></span> }, <span class="hljs-string"><span class="hljs-string">"metricName"</span></span>: <span class="hljs-string"><span class="hljs-string">"http_requests"</span></span>, <span class="hljs-string"><span class="hljs-string">"timestamp"</span></span>: <span class="hljs-string"><span class="hljs-string">"2018-01-10T16:49:07Z"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"901m"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"describedObject"</span></span>: { <span class="hljs-string"><span class="hljs-string">"kind"</span></span>: <span class="hljs-string"><span class="hljs-string">"Pod"</span></span>, <span class="hljs-string"><span class="hljs-string">"namespace"</span></span>: <span class="hljs-string"><span class="hljs-string">"default"</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"podinfo-6b86c8ccc9-nm7bl"</span></span>, <span class="hljs-string"><span class="hljs-string">"apiVersion"</span></span>: <span class="hljs-string"><span class="hljs-string">"/__internal"</span></span> }, <span class="hljs-string"><span class="hljs-string">"metricName"</span></span>: <span class="hljs-string"><span class="hljs-string">"http_requests"</span></span>, <span class="hljs-string"><span class="hljs-string">"timestamp"</span></span>: <span class="hljs-string"><span class="hljs-string">"2018-01-10T16:49:07Z"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"898m"</span></span> } ] }</code> </pre> <br> å­—æ¯<code>m</code>è¡¨ç¤º<code>milli-units</code> ï¼Œå› æ­¤ï¼Œä¾‹å¦‚<code>901m</code>æ˜¯901æ¯«ç§’ã€‚ <br><br> åˆ›å»ºä¸€ä¸ªHPAï¼Œå¦‚æœè¯·æ±‚æ•°é‡è¶…è¿‡æ¯ç§’10ä¸ªè¯·æ±‚ï¼Œå®ƒå°†æ‰©å±•podinfoéƒ¨ç½²ï¼š <br><br><pre> <code class="go hljs">apiVersion: autoscaling/v2beta1 kind: HorizontalPodAutoscaler metadata: name: podinfo spec: scaleTargetRef: apiVersion: extensions/v1beta1 kind: Deployment name: podinfo minReplicas: <span class="hljs-number"><span class="hljs-number">2</span></span> maxReplicas: <span class="hljs-number"><span class="hljs-number">10</span></span> metrics: - <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: Pods pods: metricName: http_requests targetAverageValue: <span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre> <br> åœ¨<code>default</code>åç§°ç©ºé—´ä¸­å±•å¼€HPA <code>podinfo</code> ï¼š <br><br><pre> <code class="go hljs">kubectl create -f ./podinfo/podinfo-hpa-custom.yaml</code> </pre> <br> å‡ ç§’é’Ÿåï¼ŒHPAå°†ä»åº¦é‡æ ‡å‡†APIè·å–<code>http_requests</code>å€¼ï¼š <br><br><pre> <code class="go hljs">kubectl get hpa NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE podinfo Deployment/podinfo <span class="hljs-number"><span class="hljs-number">899</span></span>m / <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>m</code> </pre> <br> ä»¥æ¯ç§’25ä¸ªè¯·æ±‚çš„é€Ÿåº¦ä¸ºpodinfoæœåŠ¡æ–½åŠ è´Ÿè½½ï¼š <br><br><pre> <code class="go hljs">#install hey <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> get -u github.com/rakyll/hey #do <span class="hljs-number"><span class="hljs-number">10</span></span>K requests rate limited at <span class="hljs-number"><span class="hljs-number">25</span></span> QPS hey -n <span class="hljs-number"><span class="hljs-number">10000</span></span> -q <span class="hljs-number"><span class="hljs-number">5</span></span> -c <span class="hljs-number"><span class="hljs-number">5</span></span> http:<span class="hljs-comment"><span class="hljs-comment">//&lt;K8S-IP&gt;:31198/healthz</span></span></code> </pre> <br> å‡ åˆ†é’Ÿåï¼ŒHPAå°†å¼€å§‹æ‰©å±•éƒ¨ç½²ï¼š <br><br><pre> <code class="go hljs">kubectl describe hpa Name: podinfo Namespace: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> Reference: Deployment/podinfo Metrics: ( current / target ) <span class="hljs-string"><span class="hljs-string">"http_requests"</span></span> on pods: <span class="hljs-number"><span class="hljs-number">9059</span></span>m / <span class="hljs-number"><span class="hljs-number">10</span></span>&lt; Min replicas: <span class="hljs-number"><span class="hljs-number">2</span></span> Max replicas: <span class="hljs-number"><span class="hljs-number">10</span></span> Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal SuccessfulRescale <span class="hljs-number"><span class="hljs-number">2</span></span>m horizontal-pod-autoscaler New size: <span class="hljs-number"><span class="hljs-number">3</span></span>; reason: pods metric http_requests above target</code> </pre> <br> ä½¿ç”¨å½“å‰çš„æ¯ç§’è¯·æ±‚æ•°ï¼Œéƒ¨ç½²å°†æ°¸è¿œä¸ä¼šè¾¾åˆ°æœ€å¤š10ä¸ªPodã€‚ ä¸‰ä¸ªå‰¯æœ¬è¶³ä»¥ç¡®ä¿æ¯ä¸ªPodæ¯ç§’çš„è¯·æ±‚æ•°é‡å°‘äº10ã€‚ <br><br> åœ¨å®Œæˆè´Ÿè½½æµ‹è¯•ä¹‹åï¼ŒHPAä¼šå°†éƒ¨ç½²è§„æ¨¡å‡å°åˆ°åˆå§‹å‰¯æœ¬æ•°ï¼š <br><br><pre> <code class="go hljs">Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal SuccessfulRescale <span class="hljs-number"><span class="hljs-number">5</span></span>m horizontal-pod-autoscaler New size: <span class="hljs-number"><span class="hljs-number">3</span></span>; reason: pods metric http_requests above target Normal SuccessfulRescale <span class="hljs-number"><span class="hljs-number">21s</span></span> horizontal-pod-autoscaler New size: <span class="hljs-number"><span class="hljs-number">2</span></span>; reason: All metrics below target</code> </pre> <br> æ‚¨å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼Œè‡ªåŠ¨ç¼©æ”¾å™¨ä¸ä¼šç«‹å³å“åº”æŒ‡æ ‡æ›´æ”¹ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä»¬æ¯30ç§’åŒæ­¥ä¸€æ¬¡ã€‚ æ­¤å¤–ï¼Œä»…åœ¨æœ€è¿‘3-5åˆ†é’Ÿå†…å·¥ä½œè´Ÿè½½æ²¡æœ‰å¢åŠ æˆ–å‡å°‘çš„æƒ…å†µä¸‹ï¼Œæ‰ä¼šè¿›è¡Œæ‰©å±•ã€‚ è¿™æœ‰åŠ©äºé˜²æ­¢å†³ç­–å†²çªï¼Œå¹¶ç•™å‡ºæ—¶é—´æ¥è¿æ¥é›†ç¾¤è‡ªåŠ¨æ‰©å±•ç¨‹åºã€‚ <br><br><h2> ç»“è®º </h2><br> å¹¶éæ‰€æœ‰ç³»ç»Ÿéƒ½å¯ä»¥ä»…åŸºäºCPUæˆ–å†…å­˜åˆ©ç”¨ç‡ï¼ˆæˆ–ä¸¤è€…ï¼‰æ¥å¼ºåˆ¶æ‰§è¡ŒSLAåˆè§„æ€§ã€‚ å¤§å¤šæ•°å¤„ç†æµé‡é«˜å³°çš„WebæœåŠ¡å™¨å’Œç§»åŠ¨æœåŠ¡å™¨éƒ½éœ€è¦æ ¹æ®æ¯ç§’çš„è¯·æ±‚æ•°è¿›è¡Œè‡ªåŠ¨ç¼©æ”¾ã€‚ <br><br> å¯¹äºETLåº”ç”¨ç¨‹åºï¼ˆæ¥è‡ªå·¥ç¨‹æå–è½¬æ¢è´Ÿè½½-â€œæå–ï¼Œè½¬æ¢ï¼ŒåŠ è½½â€ï¼‰ï¼Œä¾‹å¦‚ï¼Œå½“è¶…è¿‡ä½œä¸šé˜Ÿåˆ—çš„æŒ‡å®šé˜ˆå€¼é•¿åº¦æ—¶ï¼Œå¯ä»¥è§¦å‘è‡ªåŠ¨ç¼©æ”¾ã€‚ <br><br> åœ¨æ‰€æœ‰æƒ…å†µä¸‹ï¼Œä½¿ç”¨Prometheusæ¥å¯¹åº”ç”¨ç¨‹åºè¿›è¡Œæ£€æµ‹å¹¶çªå‡ºæ˜¾ç¤ºç”¨äºè‡ªåŠ¨æ‰©å±•çš„å¿…è¦æŒ‡ç¤ºå™¨ï¼Œä½¿æ‚¨å¯ä»¥å¾®è°ƒåº”ç”¨ç¨‹åºä»¥æ”¹å–„æµé‡å³°å€¼çš„å¤„ç†å¹¶ç¡®ä¿åŸºç¡€ç»“æ„çš„é«˜å¯ç”¨æ€§ã€‚ <br><br> æƒ³æ³•ï¼Œé—®é¢˜ï¼Œæ„è§ï¼Ÿ åŠ å…¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Slack</a>çš„è®¨è®ºï¼ <br><br> è¿™æ˜¯è¿™ç§ææ–™ã€‚ æˆ‘ä»¬æ­£åœ¨ç­‰å¾…æ‚¨çš„è¯„è®ºï¼Œå¹¶åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¯¾ç¨‹ä¸­</a>ä¸æ‚¨è§é¢ï¼ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN457742/">https://habr.com/ru/post/zh-CN457742/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN457728/index.html">Goä¸­çš„å“ˆå¸Œè¡¨ã€‚ å®æ–½ç»†èŠ‚</a></li>
<li><a href="../zh-CN457730/index.html">åœ¨åŠå…¬å®¤é‡Œæœ‰ä¸€ç§æ§åˆ¶çš„é”™è§‰-å®ƒä¸åœ¨è¿œç¨‹æ§åˆ¶ä¸­ã€‚ ä¸Devhabçš„å¯¹è¯</a></li>
<li><a href="../zh-CN457734/index.html">æ„å¤§åˆ©å¼€æºé©å‘½å¼€å§‹</a></li>
<li><a href="../zh-CN457736/index.html">â€œå·¥å…·ä¸å¦‚è€ƒè™‘å…¶åˆ›å»ºçš„ç³»ç»Ÿçš„èƒ½åŠ›é‡è¦ã€‚â€ é©¬ä¸Â·å…‹è±æ™®æ›¼ä¸“è®¿</a></li>
<li><a href="../zh-CN457738/index.html">æˆ‘ä»¬å¦‚ä½•å®ç°SD-Accessï¼Œä»¥åŠä¸ºä»€ä¹ˆéœ€è¦å®ƒ</a></li>
<li><a href="../zh-CN457744/index.html">åœ¨Qtåº“ä¸Šåˆ›å»ºæ‰©å±•ç³»ç»Ÿ-ç¬¬2éƒ¨åˆ†</a></li>
<li><a href="../zh-CN457746/index.html">æ°”è±¡å’Œé£è¡Œ</a></li>
<li><a href="../zh-CN457750/index.html">åœ¨Symfony 4ä¸­ä½¿ç”¨JSON RPC</a></li>
<li><a href="../zh-CN457752/index.html">ä¸æ˜¯æœˆäº®æ¼«æ¸¸è€…ï¼Œä¸æ˜¯å°ä¸‘ã€‚ æˆ‘ä»¬å¯¹ç¦å²›çš„æœºå™¨äººäº†è§£å¤šå°‘</a></li>
<li><a href="../zh-CN457754/index.html">å›½å®¶å’ŒTæ€æ‰‹</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>