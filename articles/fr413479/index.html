<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèΩ‚Äçüé§ ‚èπÔ∏è ‚ôêÔ∏è Nous √©crivons notre protocole sur UDP üìö üöø ‚èØÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Les premi√®res √©missions en direct de la sc√®ne sont apparues en Russie il y a pr√®s de 70 ans et ont √©t√© diffus√©es √† partir d'une station de t√©l√©vision ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nous √©crivons notre protocole sur UDP</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/413479/">  Les premi√®res √©missions en direct de la sc√®ne sont apparues en Russie il y a pr√®s de 70 ans et ont √©t√© diffus√©es √† partir d'une station de t√©l√©vision mobile (PTS), qui ressemblait √† un trolleybus et permettait de diffuser depuis l'ext√©rieur du studio.  Et il y a seulement trois ans, Periscope a autoris√© l'utilisation d'un t√©l√©phone mobile au lieu d'un ¬´trolleybus¬ª. <br><br>  Mais cette application pr√©sentait un certain nombre de probl√®mes li√©s, par exemple, aux retards de diffusion, √† l'incapacit√© de regarder des √©missions en haute qualit√©, etc. <br><br><img src="https://habrastorage.org/webt/ah/bx/dh/ahbxdhk3rew0amnby0xhqmwct98.jpeg"><br>  Six mois plus tard, √† l'√©t√© 2016, Odnoklassniki a lanc√© son application mobile de streaming OK Live, dans laquelle ils ont essay√© de r√©soudre ces probl√®mes. <br><br>  Alexander Tobol est responsable de la partie technique de la vid√©o √† Odnoklassniki et √† Highload ++ 2017, il a expliqu√© comment √©crire votre protocole UDP et pourquoi cela pourrait √™tre n√©cessaire. <br><br>  √Ä partir de la transcription de son rapport, vous apprendrez tout sur les autres protocoles de streaming vid√©o, quelles sont les nuances et quelles astuces sont parfois n√©cessaires. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/1Ih0bL2Zp1c" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Ils disent que nous devrions toujours commencer par l'architecture et les savoirs traditionnels - c'est soi-disant impossible sans cela!  Alors faisons-le. <br><a name="habracut"></a><br><h2>  Architecture et savoirs traditionnels </h2><br>  Sur la diapositive ci-dessous se trouve le sch√©ma d'architecture de tout service de streaming: la <strong>vid√©o est envoy√©e √† l'entr√©e, convertie et transmise √† la sortie</strong> .  Nous avons ajout√© un peu plus d'exigences √† cette architecture: la vid√©o doit √™tre fournie par les ordinateurs de bureau et les t√©l√©phones mobiles, et la sortie doit aller aux m√™mes ordinateurs de bureau, t√©l√©phones mobiles, smartTV, Chromcast, AppleTV et autres appareils - tout ce que la vid√©o peut √™tre lu. <br><br><img src="https://habrastorage.org/webt/g2/ju/k_/g2juk_sfrmjcu1hv_4ieulhse44.jpeg"><br>  Ensuite, nous passons au mandat.  Si vous avez un client, vous avez des savoirs traditionnels.  Si vous √™tes un r√©seau social, vous n'avez pas de savoirs traditionnels.  Comment le maquiller? <br><br>  Vous pouvez bien s√ªr interroger les utilisateurs et d√©couvrir tout ce qu'ils veulent.  Mais ce sera tout un tas de d√©sirs qui ne correspondent pas √† ce dont les gens ont vraiment besoin. <br><br>  Nous avons d√©cid√© d'aller dans le sens inverse et avons vu ce que les utilisateurs ne voulaient PAS voir du service de diffusion. <br><br><ul><li>  La premi√®re chose que l'utilisateur ne veut pas est de voir le <strong>retard au d√©but de la diffusion</strong> . <br></li><li>  L'utilisateur ne souhaite pas voir une <strong>image de flux de faible qualit√©</strong> . <br></li><li>  Si la diffusion est interactive lorsque l'utilisateur communique avec son public (retransmissions en direct, appels, etc.), il ne veut pas voir le <strong>d√©lai entre le streamer et le spectateur</strong> . <br></li></ul><br>  Voici √† quoi ressemble un service de streaming normal.  Voyons ce qui peut √™tre fait pour faire un service de streaming r√©gulier au lieu de celui habituel. <br><br><img src="https://habrastorage.org/webt/ik/68/zp/ik68zpbfkto_uh2ukzdpdinqoqi.jpeg"><br>  Vous pouvez commencer par regarder tous les protocoles de streaming, s√©lectionner les plus int√©ressants et les comparer.  Mais nous l'avons fait diff√©remment. <br><br><h2>  Qu'ont les concurrents? </h2><br>  Nous avons commenc√© par explorer les services aux concurrents.  <strong>Open Periscope - qu'est-ce qu'ils ont?</strong> <br><br>  Comme toujours, l'essentiel est l'architecture. <br><br><img src="https://habrastorage.org/webt/ex/-e/xo/ex-exowlx_iyvaq5xvqmpsjnata.jpeg"><br>  Sara Hyder, l'ing√©nieur principal de Periscope, √©crit qu'ils utilisent Wowza pour le backend.  Si nous lisons un peu plus d'articles, nous verrons ce qu'ils diffusent en utilisant le protocole <strong>RTMP</strong> et le distribuerons soit en RTMP soit en HLS.  Voyons ce que sont ces protocoles et comment ils fonctionnent. <br><br>  Nous testons Periscope sur nos trois exigences principales. <br><img src="https://habrastorage.org/webt/i5/6n/y-/i56ny-rn2pymgbg_pujoroehycm.jpeg"><br>  Ils ont une <strong>vitesse de d√©marrage</strong> acceptable (moins d'une seconde sur de bons r√©seaux), une <strong>qualit√©</strong> constante <strong>d'</strong> environ 600 px (pas HD), et en m√™me temps des <strong>retards pouvant aller jusqu'√† 12 secondes</strong> . <br><br>  Au fait, comment mesurer le retard dans la diffusion? <br><img src="https://habrastorage.org/webt/ug/hs/pa/ughspadkdie3xrgpmxt1vjwrmdm.jpeg"><br>  Il s'agit d'une photographie d'une mesure de retard.  Il y a un t√©l√©phone portable avec une minuterie.  Nous activons la diffusion et voyons l'image de ce t√©l√©phone sur l'√©cran.  Pendant 0,15 milliseconde, l'image est tomb√©e sur le capteur de l'appareil photo et a √©t√© supprim√©e de la m√©moire vid√©o sur l'√©cran du t√©l√©phone.  Apr√®s cela, nous activons le navigateur et regardons la diffusion. <br><br>  A√Øe!  Elle est un peu en retard - environ 12 secondes. <br><br>  Pour trouver les raisons du retard, nous profilons le streaming vid√©o. <br><img src="https://habrastorage.org/webt/ce/3u/jg/ce3ujgyeow2snntsekcqqq6xcr4.jpeg"><br>  Donc, il y a un t√©l√©phone portable, la vid√©o sort de la cam√©ra et entre dans le buffer vid√©o.  Ici, les retards sont minimes (‚âà0,15 ms).  Ensuite, l'encodeur code le signal, l'emballe dans un paquet et l'envoie au tampon de socket.  Tout vole sur le Web.  De plus, la m√™me chose se produit sur l'appareil r√©cepteur. <br><br>  Fondamentalement, il y a deux principaux points difficiles √† consid√©rer: <br><br><ul><li>  <strong>encodage / d√©codage vid√©o;</strong> <br></li><li>  <strong>protocoles r√©seau</strong> . <br></li></ul><br><h2>  Encodage / d√©codage vid√©o </h2><br>  Je vais parler un peu du codage.  Vous le rencontrerez de toute fa√ßon si vous effectuez un streaming en direct √† faible latence. <br><img src="https://habrastorage.org/webt/gr/op/o_/gropo_fxvnlubkxnrwdjrbhrj-w.jpeg"><br>  Qu'est-ce qu'une vid√©o?  Il s'agit d'un ensemble de cadres, mais pas tout √† fait simple.  Les cadres sont de trois types: cadres I, P et B: <br><br><ul><li>  <strong>I-frame</strong> est juste jpg.  En fait, c'est un cadre de r√©f√©rence, il ne d√©pend de personne et contient une image claire. <br></li><li>  <strong>La trame P</strong> d√©pend uniquement des trames pr√©c√©dentes. <br></li><li>  La <strong>trame B</strong> d√©licate peut d√©pendre de l'avenir.  Cela signifie que pour calculer l'image b, il est n√©cessaire que les images futures proviennent √©galement de la cam√©ra.  Ce n'est qu'alors qu'une trame b peut √™tre d√©cod√©e avec un certain retard. <br></li></ul><br>  Cela montre que les <strong>trames</strong> <strong>B</strong> <strong>sont nuisibles</strong> .  Essayons de les supprimer. <br><br><ol><li>  Si vous diffusez √† partir d'un appareil mobile, vous pouvez essayer <strong>d'activer le profil de base</strong> .  Cela d√©sactivera le cadre B. <br></li><li>  Vous pouvez essayer de configurer le codec et de r√©duire le d√©lai pour les futures trames afin que les trames arrivent plus rapidement. <br></li><li>  Une autre chose importante dans le r√©glage du codec est l' <strong>inclusion de CBR</strong> (d√©bit binaire constant). <br></li></ol><br><img src="https://habrastorage.org/webt/yu/xr/0t/yuxr0tpvsdyvqzkfxd_c7k4rop4.jpeg"><br>  Le fonctionnement des codecs est illustr√© dans la diapositive ci-dessus.  Dans cet exemple, la vid√©o est une image statique, son encodage √©conomise de l'espace disque, car  presque rien n'y change et le d√©bit vid√©o est faible.  Des changements sont en cours - l'entropie augmente, le d√©bit vid√©o augmente - c'est g√©nial de stocker sur le disque. <br><br>  Mais au moment o√π les changements actifs ont commenc√© et que le d√©bit binaire a augment√©, toutes les donn√©es ne se glisseraient probablement pas dans le r√©seau.  C'est exactement ce qui se passe lorsque vous passez un appel vid√©o et commencez √† tourner, et votre abonn√© ralentit l'image.  Cela est d√ª au fait que le r√©seau n'a pas le temps de s'adapter √† l'√©volution du d√©bit binaire. <br><br>  <strong>Il faut inclure CBR</strong> .  Tous les codecs Android ne le prendront pas correctement en charge, mais ils s'efforceront de le faire.  Autrement dit, vous devez comprendre qu'avec CBR, vous n'obtiendrez pas l'image parfaite du monde, comme dans l'image du bas, mais cela vaut la peine de l'activer. <br><br>  4. Et sur le backend, vous devez ajouter le codec de <strong>z√©rolatence</strong> √† H264 - cela vous permettra de ne pas faire de d√©pendances dans les frames pour le futur. <br><br><h2>  Protocoles de transfert vid√©o </h2><br>  Tenez compte des protocoles de streaming propos√©s par l'industrie.  Je les ai conditionnellement divis√©s en deux types: <br><br><ol><li>  protocoles de streaming; <br></li><li>  protocoles de segment. <br></li></ol><br><img src="https://habrastorage.org/webt/hc/fr/qn/hcfrqnga93h7wofbe6j8ojk1h4g.jpeg"><br>  <strong>Les protocoles de streaming</strong> sont des protocoles issus du monde des appels p2p: <strong>RTMP, webRTC, RTSP / RTP</strong> .  Ils diff√®rent en ce que les utilisateurs conviennent du canal dont ils disposent, s√©lectionnez le d√©bit binaire du codec en fonction du canal.  Et ils ont aussi des √©quipes suppl√©mentaires de ce genre, comme ¬´donnez-moi un coup de r√©f√©rence¬ª.  Si vous avez perdu une trame, dans ces protocoles, vous pouvez la demander √† nouveau. <br><br>  La diff√©rence entre les <strong>protocoles de segment</strong> est que personne ne n√©gocie avec personne.  Ils coupent la vid√©o en segments, stockent chaque segment dans diff√©rentes qualit√©s, et le client peut choisir le segment √† regarder.  Chaque segment commence par un cadre de r√©f√©rence. <br><br>  Examinez les protocoles plus en d√©tail.  Commen√ßons par les protocoles de streaming et voyons quels probl√®mes nous pouvons rencontrer si nous utilisons des protocoles de streaming pour le streaming de diffusion. <br><br><h3>  Protocoles de streaming </h3><br>  Periscope utilise RTMP.  Ce protocole est apparu en 2009, et au d√©but Adobe ne l'a pas enti√®rement sp√©cifi√©.  Il a ensuite eu une certaine difficult√© avec le fait qu'Adobe voulait vendre exclusivement son serveur.  Autrement dit, RTMP d√©velopp√© assez difficile.  Son principal probl√®me est <strong>qu'il utilise TCP</strong> , mais pour une raison quelconque, Periscope l'a choisi. <br><br><img src="https://habrastorage.org/webt/p3/qf/8x/p3qf8x_qmpcxxs1ydjzdrewzpv8.jpeg"><br><br>  Si vous lisez en d√©tail, il s'av√®re que Periscope utilise RTMP pour diffuser avec un petit nombre de t√©l√©spectateurs.  De telles √©missions, si votre cha√Æne est insuffisante, vous ne pourrez probablement pas la regarder. <br><br><img src="https://habrastorage.org/webt/42/cc/oy/42ccoy-bvsta9_1wi47vsetzrpy.jpeg"><br><br>  Prenons un exemple sp√©cifique.  Il y a un utilisateur avec un canal de communication √©troit qui regarde votre √©mission.  Vous √™tes d'accord avec lui sur RTMP sur le faible d√©bit binaire et commencez √† diffuser pour lui personnellement. <br><br>  Un utilisateur avec un internet cool vient √† vous, vous avez aussi un internet cool, mais vous avez d√©j√† convenu d'une mauvaise qualit√© avec quelqu'un, et il s'av√®re que ce troisi√®me avec internet cool regarde un flux de mauvaise qualit√©, malgr√© le fait qu'il puisse bien para√Ætre. <br><br>  Nous avons d√©cid√© de r√©soudre ce probl√®me.  Nous avons permis √† RTMP d'√™tre tronqu√© individuellement pour chaque client, c'est-√†-dire que les streamers n√©gocient avec le serveur, diffusent √† la qualit√© la plus √©lev√©e possible et chaque client re√ßoit la qualit√© que le r√©seau lui permet. <br><br>  Ouah! <br><br>  Mais encore, nous avons RTMP sur TCP, et personne ne nous a assur√© de bloquer le d√©but de la file d'attente. <br><br><img src="https://habrastorage.org/webt/pr/ri/db/prridbql3upjieh2baseexcnkoa.jpeg"><br><br>  Ceci est illustr√© dans la figure: nous recevons des trames audio et vid√©o, RTMP les emballe, peut-√™tre les m√©langent-ils d'une mani√®re ou d'une autre et s'envolent vers le r√©seau. <br><br>  Mais supposons que nous perdions un paquet.  Il est possible que le m√™me paquet jaune perdu - il s'agit g√©n√©ralement d'une trame P de certains pr√©c√©dents - ait pu √™tre supprim√©.  Peut-√™tre, au minimum, on pourrait lire de l'audio.  Mais TCP ne nous donnera pas le reste des paquets, car il <strong>garantit la livraison et la s√©quence des paquets</strong> .  Nous devons en quelque sorte y faire face. <br><br><img src="https://habrastorage.org/webt/me/vz/at/mevzattuvqxtwrbnu61ubb40nm8.jpeg"><br>  Il y a un autre probl√®me avec l'utilisation du protocole TCP en streaming. <br><br>  Disons que nous avons un tampon et une bande passante r√©seau √©lev√©e.  Nous y g√©n√©rons des paquets haute r√©solution √† partir de notre codec.  Alors - op!  - le r√©seau a commenc√© √† mal fonctionner.  Au niveau du codec, nous avons d√©j√† indiqu√© que le d√©bit doit √™tre abaiss√©, mais des paquets pr√™ts √† l'emploi sont d√©j√† dans la file d'attente et <strong>vous ne pouvez en aucun cas les supprimer de l√†</strong> .  TCP est d√©sesp√©r√© de pousser les paquets HD √† travers notre 3G. <br><br>  Nous n'avons pas de gestion de tampon, pas de priorisation, donc <strong>TCP est extr√™mement inappropri√© pour la diffusion en continu</strong> . <br><br><img src="https://habrastorage.org/webt/nh/ed/xr/nhedxrx0krpqjjtcq3txpq4a0_i.jpeg"><br><br>  Jetons maintenant un ≈ìil aux r√©seaux mobiles.  Cela peut √™tre surprenant pour les r√©sidents des capitales, mais notre r√©seau mobile moyen ressemble √† ceci: <br><br><ul><li>  1,1 Mbps de trafic; <br></li><li>  Perte de paquets de 0,1%; <br></li><li>  RTT moyen de 300 ms. <br></li></ul><br>  Et si vous regardez certaines r√©gions et certains op√©rateurs sp√©cifiques, ils ont un <strong>pourcentage de perte de paquets quotidien moyen de plus de 3%</strong> , et le RTT √† partir de 600 ms est normal. <br><br>  TCP est, d'une part, un protocole g√©nial - il est tr√®s difficile d'apprendre √† une voiture √† conduire tout de suite sur les autoroutes et hors route.  Mais lui apprendre alors aussi √† survoler les r√©seaux sans fil √©tait tr√®s difficile. <br><br><img src="https://habrastorage.org/webt/7d/1u/la/7d1ula7h-j6sf-4mb4xyw-pqi_m.jpeg"><br><br><blockquote>  Perdre m√™me 0,001% des paquets entra√Æne une r√©duction de 30% du d√©bit.  Autrement dit, notre utilisateur n'utilise pas le canal de 30% en raison de l'inefficacit√© du protocole TCP dans les r√©seaux avec perte de paquets al√©atoire. <br></blockquote><br>  Dans certaines r√©gions, la perte de paquets atteint 1%, puis l'utilisateur dispose d'environ 10% de la bande passante. <br><br>  Par cons√©quent, <strong>nous ne ferons pas TCP</strong> . <br><br>  Voyons ce qu'il y a d'autre dans le monde du streaming depuis UDP. <br><br>  <strong>Le protocole WebRTC</strong> a tr√®s bien fonctionn√© pour les appels p2p.  Sur des sites tr√®s populaires, ils √©crivent que l'utiliser pour les appels est tr√®s cool, mais pour diffuser des vid√©os et de la musique, ce n'est pas bon. <br><br>  Son principal probl√®me est qu'il <strong>n√©glige les pertes</strong> .  Avec toutes les situations √©tranges, il tombe juste. <br><br>  Il y a toujours un probl√®me dans son attachement aux appels, le fait est qu'il crypte tout.  Par cons√©quent, si vous diffusez des √©missions, et qu'il n'est pas n√©cessaire de crypter l'int√©gralit√© du flux audio / vid√©o en d√©marrant WebRTC, vous aurez quand m√™me une tension sur votre processeur.  Vous n'en aurez peut-√™tre pas besoin. <br><br><img src="https://habrastorage.org/webt/h4/qq/1o/h4qq1o8awojsly2-fo-mggjb30y.jpeg"><br><br>  <strong>Le streaming RTP</strong> est le protocole de base pour la transmission de donn√©es via UDP.  Ci-dessous sur la diapositive √† droite se trouve un ensemble d'extensions et de RFC qui ont d√ª √™tre impl√©ment√©es dans WebRTC afin d'adapter ce protocole pour les appels.  En principe, vous pouvez essayer de faire quelque chose comme √ßa - composer un ensemble d'extensions √† RTP et obtenir le streaming UDP.  <strong>Mais c'est tr√®s difficile</strong> . <br><br>  Le deuxi√®me probl√®me est que si l'un de vos clients ne prend en charge aucune extension, le protocole ne fonctionnera pas. <br><br><img src="https://habrastorage.org/webt/vi/ny/wl/vinywlwh6wfdwrrfznzoiccjjzc.jpeg"><br><br><h3>  Protocoles de segment </h3><br>  <strong>MPEG-Dash</strong> est un bon exemple de protocole vid√©o segment√©.  Il se compose d'un fichier manifeste que vous publiez sur votre portail.  Il contient des liens vers des fichiers de diff√©rentes qualit√©s, au d√©but du fichier, il y a un index qui indique √† quel endroit du fichier quel segment commence. <br><br><img src="https://habrastorage.org/webt/9x/kd/py/9xkdpywmis1cfrdrmx6peob2gag.jpeg"><br><br>  La vid√©o enti√®re est divis√©e en segments, par exemple, pendant 3 secondes, chaque segment commence par une image de r√©f√©rence.  Si vous regardez une telle vid√©o et que votre d√©bit change, alors du c√¥t√© client, vous commencez √† prendre le segment de la qualit√© dont vous avez besoin. <br><br>  Un autre exemple de streaming segment√© est <strong>HLS</strong> . <br><br>  MPEG-Dash est une solution de Google, elle fonctionne bien sous Android, et la solution Apple est plus ancienne, elle pr√©sente un certain nombre d'inconv√©nients. <br><br><img src="https://habrastorage.org/webt/ed/jv/wv/edjvwvr9g_-n_tihydmscth_rym.jpeg"><br><br>  Le premier d'entre eux est que le manifeste principal contient des liens vers des manifestes secondaires, les manifestes secondaires pour chaque qualit√© sp√©cifique contiennent des liens vers chaque segment individuel, et chaque segment individuel est repr√©sent√© par un fichier distinct. <br><br>  Si vous regardez encore plus en d√©tail, alors √† l'int√©rieur de chaque segment se trouve MPEG2-TS.  Ce protocole a √©galement √©t√© con√ßu pour le satellite; sa taille de paquet est de <strong>188 octets</strong> .  Il est tr√®s g√™nant d‚Äôemballer des vid√©os de cette taille, en particulier parce que vous les fournissez tout le temps avec un petit en-t√™te. <br><br>  En fait, cela est difficile non seulement pour les serveurs qui, pour traiter 40 Go de trafic, doivent collecter <strong>26 millions de paquets</strong> , mais cela est √©galement difficile pour le client.  Par cons√©quent, lorsque nous avons r√©√©crit le lecteur iOS sur MPEG-Dash, nous avons m√™me constat√© des gains de performances. <br><br><img src="https://habrastorage.org/webt/li/iy/-b/liiy-bk2b4hbreygtlsrypgykb4.jpeg"><br><br>  Mais Apple ne reste pas immobile.  En 2016, ils ont finalement annonc√© qu'ils avaient la possibilit√© de pousser un fragment de MPEG4 dans HLS.  Ensuite, ils ont promis de l'ajouter uniquement aux d√©veloppeurs, mais il semble que le support de macOS et iOS devrait maintenant appara√Ætre. <br><br>  Autrement dit, il semblerait que le streaming de fragments soit pratique - venez, prenez le fragment souhait√©, commencez par le cadre de r√©f√©rence - cela fonctionne. <br><br>  Moins: il est clair que le cadre de r√©f√©rence √† partir duquel vous avez commenc√© n'est pas le cadre que celui qui diffuse maintenant le poss√®de.  Par cons√©quent, <strong>il y a toujours un retard</strong> . <br><br>  En g√©n√©ral, il est possible de terminer HLS √† des retards de l'ordre de 5 secondes, quelqu'un dit qu'il a r√©ussi √† en obtenir 4, mais en principe, la <strong>d√©cision d'utiliser le streaming de fragments pour la traduction n'est pas tr√®s bonne</strong> . <br><br><img src="https://habrastorage.org/webt/ot/5d/fx/ot5dfxmgkfjri9h6uqxttl7dwoo.jpeg"><br><br><h3>  Difficult√© vs retard </h3><br>  Examinons tous les protocoles disponibles et trions-les selon deux param√®tres: <br><br><ul><li>  la latence qu'ils donnent entre l'√©mission et le spectateur; </li><li>  complexit√© </li></ul><br>  Plus le d√©lai garanti par le protocole est court, plus il est complexe. <br><br><img src="https://habrastorage.org/webt/va/or/jm/vaorjm1gkqcpwvxf1eos4uds90a.jpeg"><br><br><h3>  Que voulons-nous? </h3><br>  Nous voulons faire un protocole UDP pour le streaming de 1 √† N avec un retard comparable √† la communication p2p, avec l'option de cryptage optionnel des paquets selon qu'il s'agit d'une diffusion priv√©e ou publique. <br><br>  <strong>Quelles sont les autres options?</strong>  Vous pouvez attendre, par exemple, lorsque Google publie son QUIC. <br><br>  Je vais vous dire un peu ce que c'est.  Google positionne Google QUIC en remplacement de TCP - une sorte de TCP 2.0.  Il a √©t√© d√©velopp√© depuis 2013, maintenant il n'a pas de sp√©cification, mais il est enti√®rement disponible dans Google Chrome, et il me semble qu'ils l'activent parfois pour certains utilisateurs afin de voir comment cela fonctionne.  En principe, vous pouvez acc√©der aux param√®tres, activer QUIC, acc√©der √† n'importe quel site Google et obtenir cette ressource via UDP. <br><br>  Nous avons d√©cid√© de ne pas attendre qu'ils le pr√©cisent tous et de d√©poser notre d√©cision. <br><br>  Exigences du protocole: <br><br><ol><li>  <strong>Le multithreading</strong> , c'est-√†-dire que nous avons plusieurs flux - contr√¥le, vid√©o, audio. <br></li><li>  <strong>Une garantie de livraison facultative</strong> - le flux de contr√¥le est garanti √† 100%, la vid√©o dont nous avons le moins besoin - nous pouvons y d√©poser l'image, nous aimerions toujours l'audio. <br></li><li>  <strong>Hi√©rarchisation des flux</strong> - pour que l'audio avance, et le gestionnaire a g√©n√©ralement vol√©. <br></li><li>  <strong>Cryptage optionnel</strong> : soit toutes les donn√©es, soit uniquement les en-t√™tes et les donn√©es critiques. <br></li></ol><br><img src="https://habrastorage.org/webt/k6/un/6t/k6un6tc2qxdngdgbjgvycugso80.jpeg"><br><br>  Il s'agit d'un triangle standard: si un bon r√©seau, alors haute qualit√© et faible latence.  D√®s qu'un r√©seau instable appara√Æt, les paquets commencent √† dispara√Ætre, on √©quilibre entre qualit√© et d√©lai.  Nous avons le choix: soit attendre que le r√©seau s'am√©liore et envoyer tout ce qui s'est accumul√©, soit abandonner et vivre avec. <br><br>  Si vous triez les protocoles selon ce principe, il est clair que <strong>plus le temps d'attente est court, plus la qualit√© est mauvaise</strong> - une conclusion assez simple. <br><br>  Nous voulons coincer notre protocole dans la zone o√π les retards sont proches de WebRTC, mais en m√™me temps pouvoir pousser un peu, car apr√®s tout nous n'avons pas d'appels, mais des √©missions.  L'utilisateur souhaite finalement recevoir un flux de qualit√©. <br><br><h2>  D√©veloppement </h2><br>  Commen√ßons √† √©crire le protocole UDP, mais regardons d'abord les statistiques. <br><br><img src="https://habrastorage.org/webt/7f/pa/g2/7fpag2oc-8grjh0sprl-xjok9hg.jpeg"><br><br>  Ce sont nos statistiques sur les r√©seaux mobiles.  On peut voir que l'Internet moyen est l√©g√®rement plus que m√©gabits, une perte de paquets d'environ 1% est normale, et RTT dans la r√©gion de 600 ms - sur 3G, ce ne sont que des valeurs moyennes. <br><br>  Nous nous concentrerons sur cela lors de la r√©daction du protocole - allons-y! <br><br><h2>  Protocole UDP </h2><br>  On ouvre le socket UDP, on retire les donn√©es, on emballe, on envoie.  Nous prenons le deuxi√®me pack du codec, nous envoyons toujours.  Tout semble super! <br><br><img src="https://habrastorage.org/webt/_z/mn/pb/_zmnpbiqjqaylvgxteujqyehvi4.jpeg"><br><br>  Mais nous obtenons l'image suivante: si nous commen√ßons √† envoyer au hasard des paquets UDP √† la socket, selon les statistiques, au 21e paquet, la probabilit√© qu'il atteindra ne sera que de 85%.  Autrement dit, la perte de paquets sera d√©j√† de 15%, ce qui n'est pas bon.  Cela doit √™tre corrig√©. <br><br><img src="https://habrastorage.org/webt/-k/9x/yf/-k9xyfgw5atqxwbfgsoz4hwdzpo.jpeg"><br><br>  Ceci est fix√© en standard.  L'illustration illustre la vie sans Pacer et la vie avec <strong>Pacer</strong> . <br><br>  Pacer est une chose qui r√©partit les paquets dans le temps et contr√¥le leur perte;  Il regarde ce qu'est la perte de paquets maintenant, en fonction de cela, il s'adapte √† la vitesse du canal. <br><br>  Comme nous nous en souvenons, pour les r√©seaux mobiles, la perte de paquets de 1 √† 3% est la norme.  En cons√©quence, nous devons en quelque sorte travailler avec cela.  Et si nous perdons des colis? <br><br><h3>  Retransmettre </h3><br><img src="https://habrastorage.org/webt/rm/6c/sn/rm6csnnevyp8uer3y_88usgnxvi.jpeg"><br><br>  En TCP, comme vous le savez, il existe un algorithme de retransmission rapide: nous envoyons un paquet, le second, si le paquet est perdu, puis apr√®s un certain temps (p√©riode de retransmission), nous envoyons le m√™me paquet. <br><br>  Quels en sont les avantages?  Pas de probl√®mes, pas de redondance, mais il y a un moins - une certaine <strong>p√©riode de retransmission</strong> . <br><br><img src="https://habrastorage.org/webt/wa/91/8x/wa918xscu2p_r9dym0hxtexa-te.jpeg"><br><br>  Cela semble tr√®s simple: apr√®s un certain temps, vous devez r√©p√©ter le colis si vous n'avez pas re√ßu de confirmation √† ce sujet.  Logiquement, cela peut √™tre un temps √©gal au temps de ping.  ping ‚Äî    ,      RTT time ,   ,   . <br><br>  ,    , ,   ,  jitter:       ping-. ,   ,    46 .     jitter ‚Äî 50. <br><br><img src="https://habrastorage.org/webt/tc/ut/qp/tcutqprunmcey5nsfas7jobk1ju.jpeg"><br><br>        .   RTT   ,      ,  acknowledge      .  ,  RFC6298,   TCP ,     . <br><br>     jitter.     jitter  ping  15%. ,  retransmit period  ,  ,  20% ,  RTT. <br><br><img src="https://habrastorage.org/webt/ro/0f/ut/ro0futlozzfwqp7frtgd4-26ufg.jpeg"><br><br>     retransmit.       acknowledge   .    ,  ,    .    retransmit period,       .    ,      . <br><br>       ,   retransmit   .   , , packet loss 5%,    400 ,   400    1      packet-drop,  ,    retransmit period  ,      . <br><br>    ,   .    , ,    acknowledge   . ,   ‚Äî   ,       ,  speculative retransmit   . <br><br>      retransmit,     . <br><br>      .  ,   <strong>Forward Error Correction</strong> ?      , , XOR.    ,       ,       . <br><br><img src="https://habrastorage.org/webt/zd/b1/pe/zdb1pedfxegynl5dx-m7qopdgqw.jpeg"><br><br>  Ouah!     round trip,      . <br><br>  ,     ,   ?   XOR    ‚Äî ,   Reed-Solomon, Fountain codes  ..  :   K ,     N  ,   N   . <br><br>   ! <br><br> ,      ,     ,    Forward Error Correction    negative acknowledgement. <br><br><h3> NACK </h3><br><img src="https://habrastorage.org/webt/yy/6d/uv/yy6duvocxiqc43veskkksrfj7s0.jpeg"><br><br>     ,   parity protection (  )    ,    . <br><br>  NACK: <br><br><ul><li>   ,      negative acknowledgement,    . <br></li><li>    FEC. <br></li></ul><br> ,    : <br><br><ol><li>   , FEC + NACK; <br></li><li>   , Fast retransmit. <br></li></ol><br> ,    . <br><br><img src="https://habrastorage.org/webt/zs/tg/dr/zstgdrqijyhnsnbfx4xfpgfixa8.jpeg"><br><br> ,        ,   (  ).    , ,  11 ,     60-80 .  ,   ,   . <br><br>        6 . <br><br><img src="https://habrastorage.org/webt/7p/bm/1e/7pbm1elkbfopc4zogdohequo4zo.jpeg"><br><br>     ,    ,    .    ,    . , Wi-Fi  22    5 , 3G   34   8 . <br><br><img src="https://habrastorage.org/webt/-1/7_/sg/-17_sgwf_vd6x88lryeyqarozfq.jpeg"><br><br> :   ,    90% packet loss     10 ,     gap  25 ,     ‚Äî FEC + NACK  Fast retransmit? <br><br> , ,  ,  Google,     QUIC  2013 ,  Forward Error Correction  , ,     .   2015   . <br><br>           FEC + NACK,       . <br><br> ,   . <br><br><img src="https://habrastorage.org/webt/vo/vx/en/vovxendpcptrbqle5r-_dsphz7o.jpeg"><br><br>  ,    , c    : <br><br><ul><li> 1 / ; <br></li><li> 1% packet loss; <br></li><li> 300  RTT; <br></li><li> 1 000  ‚Äî   ; <br></li><li> 1 000    . <br></li></ul><br>        10 .   packet loss  1%    1 000   10.  ‚Äî    100   1 ‚Äî  ,        2 ,   . <br><br>     ,     .    500- ,      10 . <br><br>    : <br><br><ul><li>   500      Forward Error Correction.        ,     . <br></li><li>   NACK,   ,    . <br></li><li>      Fast Retransmit,           . <br></li></ul><br>  Forward Error Correction  ,       ‚Äî  gap      200-300     . <br><br><h3> Fast Retransmit </h3><br>   :  ,      10 ,    , ,    retransmit period ,     . <br><br><img src="https://habrastorage.org/webt/uf/8l/vu/uf8lvu8cm-golfpmgpng1rln25y.jpeg"><br><br>    ,  retransmit period     350 ,     packet gap ‚Äî 25-30 ,   100.  ,   ,  retransmit   ,         . <br><br>   ,       . <br><br><h3>   </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lorsque vous √©crivez votre protocole sur UDP et que vous avez la possibilit√© d'envoyer des paquets, vous obtenez des chignons suppl√©mentaires. </font></font><br><br><img src="https://habrastorage.org/webt/rh/lr/nf/rhlrnfukoaeiiy8vxnrku7qbopg.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il y a un tampon d'envoi, il contient une trame de r√©f√©rence, des trames p / b. </font><font style="vertical-align: inherit;">Ils vont r√©guli√®rement en ligne. </font><font style="vertical-align: inherit;">Ensuite, ils ont cess√© d'aller sur le r√©seau, et √† leur tour, d'autres paquets sont arriv√©s. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous comprenez qu'en fait, tous les packages qui sont dans la file d'attente ne sont plus int√©ressants pour le client, car, par exemple, plus de 0,5 s se sont √©coul√©s et il vous suffit de coller l'√©cart sur le client et de continuer √† vivre. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous pouvez, ayant des informations sur ce qui est stock√© dans ces packages, nettoyer non seulement le cadre de r√©f√©rence, mais aussi tous les p / b qui en d√©pendent, et ne laisser que les donn√©es n√©cessaires et compl√®tes dont le client peut alors avoir besoin.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MTU </font></font></h3><br>  Puisque nous √©crivons le protocole nous-m√™mes, nous devrons faire face √† la fragmentation IP.  Je pense que beaucoup de gens le savent, mais juste au cas o√π, je vous le dirai bri√®vement. <br><br><img src="https://habrastorage.org/webt/wy/wy/lt/wywyltg-bw2a3ypzpvmkpz1zcsw.jpeg"><br><br>  Nous avons un serveur, il envoie des paquets au r√©seau, ils arrivent au routeur et √† son niveau le MTU (unit√© de transmission maximale) devient inf√©rieur √† la taille du paquet qui est arriv√©.  Il divise le paquet en grand et petit (ici 1100 et 400 octets) et envoie. <br><br>  En principe, il n'y a pas de probl√®me, tout se rassemblera sur le client et fonctionnera.  Mais si nous perdons 1 paquet, nous supprimons tous les paquets, et nous obtenons des co√ªts suppl√©mentaires pour les en-t√™tes de paquets.  Par cons√©quent, si vous √©crivez votre protocole, il est id√©al de travailler avec la quantit√© de MTU. <br><br>  <strong>Comment le compter?</strong> <br><br>  En fait, Google ne d√©range pas, met environ 1200 octets dans son QUIC et ne le s√©lectionne pas, car alors la fragmentation IP collectera tous les paquets. <br><br><img src="https://habrastorage.org/webt/lj/q0/eu/ljq0eutloqqgituniq6jhfodjwo.jpeg"><br><br>  Nous faisons exactement la m√™me chose - d'abord nous d√©finissons une taille par d√©faut et commen√ßons √† envoyer des paquets - laissez-les les fragmenter. <br><br>  En parall√®le, ex√©cutez un thread s√©par√© et cr√©ez un socket avec l'indicateur d'interdiction de fragmentation pour tous les paquets.  Si le routeur rencontre un tel paquet et ne peut pas fragmenter ces donn√©es, il abandonnera le paquet et vous enverra √©ventuellement via ICMP qu'il y a des probl√®mes, mais tr√®s probablement, ICMP sera ferm√© et cela ne se produira pas.  Par cons√©quent, nous essayons simplement, par exemple, trois fois d'envoyer un paquet d'une certaine taille √† un certain intervalle.  S'il n'atteint pas, nous pensons que le MTU est d√©pass√© et le r√©duisons encore. <br><br>  Ainsi, ayant le MTU de l'interface Internet qui se trouve sur l'appareil et un minimum de MTU, nous s√©lectionnons simplement le MTU correct par une recherche unidimensionnelle.  Apr√®s cela, nous ajustons la taille du paquet dans le protocole. <br><br>  En fait, cela change parfois.  Nous avons √©t√© surpris, mais en train de changer de Wi-Fi, etc. MTU est en train de changer.  Il est pr√©f√©rable de ne pas arr√™ter ce processus parall√®le et de corriger MTU de temps en temps. <br><br><img src="https://habrastorage.org/webt/x5/db/hy/x5dbhy0sbgn990swfjmqp2s9z8w.jpeg"><br><br>  Distribution MTU plus √©lev√©e dans le monde.  Nous avons obtenu environ 1100 octets sur le portail. <br><br><h3>  Cryptage </h3><br>  Nous avons dit que nous voulions √©ventuellement g√©rer le chiffrement.  Nous faisons l'option la plus simple - Diffie-Hellman sur les courbes elliptiques.  Nous le faisons facultativement - nous chiffrons uniquement les paquets de contr√¥le et les en-t√™tes afin que l'homme du milieu ne puisse pas recevoir la cl√© de diffusion, l'intercepter, etc. <br><br><img src="https://habrastorage.org/webt/nn/sv/h3/nnsvh3c3wxoulkrg31ggc8kkvyg.jpeg"><br><br>  Si la diffusion est priv√©e, nous pouvons √©galement ajouter le cryptage de toutes les donn√©es. <br><br>  Les paquets sont chiffr√©s avec AES-256 ind√©pendamment, de sorte que la suppression de paquets n'affecte pas le chiffrement ult√©rieur des paquets. <br><br><h3>  Priorisation </h3><br>  Rappelez-vous, nous voulions plus de priorisation du protocole. <br><br><img src="https://habrastorage.org/webt/cc/ob/hd/ccobhdbwn5xelxwurrvsz7rxttg.jpeg"><br><br>  Nous avons des m√©tadonn√©es, des trames audio et vid√©o, nous les envoyons avec succ√®s sur le r√©seau.  Ensuite, notre r√©seau br√ªle en enfer et pendant longtemps ne fonctionne pas - nous comprenons que nous devons abandonner les paquets. <br><br>  Nous supprimons principalement les paquets vid√©o, puis essayons de supprimer l'audio et de ne jamais toucher aux paquets de contr√¥le, car des donn√©es telles que les changements de r√©solution et d'autres probl√®mes importants peuvent les traverser. <br><br><h3>  Chignon suppl√©mentaire sur UDP </h3><br>  Si vous √©crivez votre protocole UDP, par exemple, avec une communication bidirectionnelle, vous devez comprendre qu'il existe une dissociation NAT et la possibilit√© que vous ne puissiez pas retrouver le client √† partir du serveur. <br><br><img src="https://habrastorage.org/webt/zs/my/ii/zsmyiips__dpgzghjbdeovvz_6g.jpeg"><br><br>  Sur la diapositive, il est parfois impossible d'atteindre le client depuis le serveur via UDP. <br><br>  De nombreux sceptiques affirment que les routeurs sont con√ßus de telle mani√®re que NAT Unbinding √©vince principalement les routes UDP.  Mais ce qui pr√©c√®de montre que si Keep-Alive ou ping est inf√©rieur √† 30 secondes, alors avec une probabilit√© de 99%, il sera possible d'atteindre le client. <br><br><h3>  Disponibilit√© UDP sur les appareils mobiles dans le monde </h3><br><img src="https://habrastorage.org/webt/nt/mv/5u/ntmv5u_uv_pl1jdgabyewmmhk80.jpeg"><br><br>  Google indique 6%, mais il s'est av√©r√© que <strong>7% des utilisateurs mobiles ne peuvent pas utiliser UDP</strong> .  Dans ce cas, nous laissons notre beau protocole avec priorisation, chiffrement et tout, uniquement sur TCP. <br><br>  Sur UDP, VOIP fonctionne d√©sormais sur WebRTC, Google QUIC et de nombreux jeux fonctionnent sur UDP.  Par cons√©quent, je ne pense pas que UDP sera ferm√© sur les appareils mobiles. <br><br>  En cons√©quence, nous: <br><br><ul><li>  R√©duction du d√©lai entre le streamer et l'observateur √† 1 s. <br></li><li>  Nous nous sommes d√©barrass√©s de l'effet cumulatif dans les tampons, c'est-√†-dire que la diffusion n'est pas en retard. <br></li><li>  Le nombre de <strong>stands</strong> dans le public a <strong>diminu√©</strong> . <br></li><li>  Ils ont pu prendre en charge le streaming sur les appareils mobiles FullHD. <br></li></ul><br><img src="https://habrastorage.org/webt/im/ql/le/imqlle87zr_gdvhaflkcxe-25_q.jpeg"><br><ul><li>  Le d√©lai dans notre application mobile OK Live est de 25 ms √† 10 ms plus long que le scanner de la cam√©ra fonctionne, mais ce n'est pas si effrayant. <br></li><li>  La diffusion sur le Web montre un retard de seulement 690 ms - espace! <br></li></ul><br><h2>  Quoi d'autre peut diffuser sur Odnoklassniki </h2><img src="https://habrastorage.org/webt/le/zu/zc/lezuzc64qct36iohbnoyukuab8o.jpeg"><br><br><ul><li>  Accepte notre protocole OKMP √† partir d'appareils mobiles; <br></li><li>  peut accepter RTMP et WebRTC; <br></li><li>  distribue HLS, MPEG-Dash, etc. <br></li></ul><br>  Si vous avez fait attention, vous avez remarqu√© que j'ai dit que nous pouvons prendre, par exemple, WebRTC de l'utilisateur et le convertir en RTMP. <br><br><img src="https://habrastorage.org/webt/me/hc/3c/mehc3cteyxhn2hcsrjd1vmx9z_y.jpeg"><br><br>  Il y a une nuance.  En fait, WebRTC est un protocole orient√© paquets et utilise le codec audio OPUS.  Vous ne pouvez pas utiliser OPUS dans RTMP. <br><br>  Sur les serveurs principaux, nous utilisons RTMP partout.  Par cons√©quent, nous avons d√ª apporter quelques correctifs suppl√©mentaires dans FF MPEG, ce qui nous permet de pousser OPUS en RTMP, de le convertir en AAC et de le donner aux utilisateurs d√©j√† en HLS ou autre chose. <br><br><h2>  √Ä quoi √ßa ressemble en nous? </h2><img src="https://habrastorage.org/webt/v_/s2/z4/v_s2z4ja4xlfcuacadyelfpcdj0.jpeg"><br><br><ul><li>  Les utilisateurs utilisant l'un des protocoles t√©l√©chargent la vid√©o originale sur notre serveur de t√©l√©chargement. <br></li><li>  L√†, nous d√©ployons le protocole. <br></li><li>  Nous envoyons RTMP √† l'un des serveurs de transformation vid√©o. <br></li><li>  L'original est toujours stock√© dans un stockage distribu√© afin que rien ne soit perdu. <br></li><li>  Apr√®s cela, toutes les vid√©os vont au serveur de distribution. <br></li></ul><br>  Pour le fer, nous avons les √©l√©ments suivants: <br><br><img src="https://habrastorage.org/webt/hb/zc/nl/hbzcnl6smz5tevhx5ud_phg0m0q.jpeg"><br>  Je vais vous en dire un peu plus sur la tol√©rance aux pannes: <br><br><ul><li>  Les serveurs de t√©l√©chargement sont distribu√©s dans diff√©rents centres de donn√©es, se tiennent derri√®re diff√©rentes IP. <br></li><li>  Les utilisateurs viennent, re√ßoivent IP sur DNS. <br></li><li>  Upload-server envoie la vid√©o aux serveurs de d√©coupage, ils coupent et donnent aux serveurs de distribution. <br></li><li>  Pour les diffusions plus populaires, nous commen√ßons √† ajouter un plus grand nombre de serveurs de distribution. <br></li><li>  Nous sauvegardons tout ce qui vient de l'utilisateur dans le r√©f√©rentiel, afin que plus tard, nous puissions cr√©er une archive de diffusion et ne rien perdre. <br></li><li>  Stockage tol√©rant aux pannes r√©parti sur trois centres de donn√©es. <br></li></ul><br>  Pour d√©terminer quel serveur est actuellement responsable de la traduction, nous utilisons <strong>ZooKeeper</strong> .  Pour chaque traduction, nous stockons un n≈ìud et cr√©ons des n≈ìuds √©ph√©m√®res pour chaque serveur.  En fait, c'est une telle chose qui permet √† un flux de cr√©er une file d'attente de serveurs √† traiter.  Le leader actuel de cette ligne est toujours engag√© dans le traitement des flux. <br><br>  Nous testerons rapidement la tol√©rance aux pannes.  Nous commen√ßons imm√©diatement par la disparition de l'int√©gralit√© du datacenter. <br><br>  <strong>Que va-t-il se passer?</strong> <br><br><ul><li>  L'utilisateur DNS prendra la prochaine IP d'un autre serveur de t√©l√©chargement. <br></li><li>  √Ä ce moment, ZooKeeper comprendra que le serveur de ce centre de donn√©es est mort et s√©lectionnera le serveur de d√©coupage pour un autre. <br></li><li>  Les serveurs de t√©l√©chargement sauront qui est d√©sormais responsable de la transformation de ce flux et le distribueront. <br></li></ul><br>  En principe, tout cela se produira avec un minimum de retards. <br><br><h2>  Utilisation du protocole dans le produit </h2>  Nous avons cr√©√© l'application mobile de streaming OK Live.  Il est enti√®rement int√©gr√© au portail.  Les utilisateurs peuvent communiquer, effectuer des diffusions en direct, il existe une carte des diffusions, une liste des diffusions populaires - en g√©n√©ral, tout ce que vous pouvez souhaiter. <br><br><img src="https://habrastorage.org/webt/kz/4n/on/kz4nonh4fuveoh5iilwwhipapl8.jpeg"><br><br>  Nous avons √©galement ajout√© la possibilit√© de diffuser en FullHD.  Vous pouvez connecter une cam√©ra d'action sur Android √† un appareil Android. <br><br><img src="https://habrastorage.org/webt/pi/ut/ga/piutgamml44x_nzqt41dlg3t9za.jpeg"><br><br>  Nous avons maintenant un m√©canisme qui permet des diffusions en direct.  Par exemple, nous avons √©tabli une ligne directe avec le pr√©sident via OK Live et l'avons diffus√©e <strong>dans tout le pays</strong> .  Les utilisateurs regardaient et √† travers le flux venant en sens inverse pouvaient se mettre en ondes et poser leurs questions. <br><br>  En fait, deux flux entrants avec un d√©lai minimum fournissent un certain format de conf√©rence publique. <br><br>  En fait, nous nous sommes rencontr√©s quelque part en 2 secondes - une seconde l√†-bas et une seconde de retour.  Rappelez-vous ce ¬´chariot¬ª dont j'ai parl√© au d√©but de l'article - il ressemble maintenant √† 2 √©normes camions.  Pour la diffusion t√©l√©vis√©e, retirer de l'appareil photo et simplement tout m√©langer avec un retard d'environ 1 √† 2 s est tout √† fait normal. <br><br>  En fait, nous avons r√©ussi √† reproduire quelque chose de comparable avec le TCP moderne actuel. <br><br><img src="https://habrastorage.org/webt/si/io/dg/siiodgw1g17mn3b1jt8270ezuo8.jpeg"><br><br>  Les √©missions en direct sont la tendance actuelle.  Depuis un an et demi sur le portail OK, ils ont tripl√© (non sans l'aide de l'application OK Live). <br><br><img src="https://habrastorage.org/webt/lx/sa/4w/lxsa4wk6ltmz8xefbsunlfbqjrq.jpeg"><br><br>  Toutes les √©missions sont enregistr√©es par d√©faut.  Nous avons environ 50 000 flux par jour, ce qui g√©n√®re environ 17 t√©raoctets de trafic par jour, mais en g√©n√©ral, toute la vid√©o sur le portail g√©n√®re environ un p√©taoctet de donn√©es par mois. <br><br><img src="https://habrastorage.org/webt/zg/n3/h6/zgn3h616zrtpcyw7dkgpuwconp4.jpeg"><br><br>  Qu'avons-nous obtenu: <br><br><ul><li>  Pourrait garantir la dur√©e du d√©lai entre le streamer et le public. <br></li><li>  Nous avons cr√©√© la premi√®re application FullHD mobile pour le streaming sur un canal Internet mobile √† √©volution dynamique. <br></li><li>  Nous avons eu la possibilit√© de perdre des centres de donn√©es et en m√™me temps de ne pas interrompre la diffusion <br></li></ul><br>  Qu'avez-vous appris: <br><br><ul><li>  Qu'est-ce qu'une vid√©o et comment la diffuser? <br></li><li>  Que vous pouvez √©crire votre protocole UDP si vous savez avec certitude que vous avez une t√¢che tr√®s sp√©cifique et des utilisateurs sp√©cifiques. <br></li><li>  √Ä propos de l'architecture de tout service de streaming - la vid√©o entre en entr√©e, convertit et quitte. <br></li></ul><br><blockquote>  Chez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Highload ++ Siberia,</a> Alexander Tobol promet de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">parler</a> du service d'appel OK, il sera int√©ressant de savoir ce qui a r√©ussi √† √™tre appliqu√© √† partir de ce qui a √©t√© discut√© dans cet article, et ce qui a d√ª √™tre mis en ≈ìuvre compl√®tement √† nouveau. <br><br>  Dans la m√™me section, des rapports sont pr√©vus sur des sujets hautement sp√©cialis√©s: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Eugene Rossinsky</a> (ivi) sur le syst√®me de collecte de statistiques d√©taill√©es sur le fonctionnement des n≈ìuds CDN. <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Anton Rusakova</a> (Badoo) sur l'int√©gration des syst√®mes de paiement sans utiliser leur propre facturation. <br></li></ul><br></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr413479/">https://habr.com/ru/post/fr413479/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr413465/index.html">AMD annonce Threadripper 2 √† 32 c≈ìurs</a></li>
<li><a href="../fr413467/index.html">Sauvegarde rapide et fiable des donn√©es dans le cloud</a></li>
<li><a href="../fr413469/index.html">Un test de m√©moire tuant des ordinateurs portables est presque une histoire de d√©tective</a></li>
<li><a href="../fr413471/index.html">Vendredi Mini Tomy Fancy Toy Retrospective</a></li>
<li><a href="../fr413473/index.html">D√©veloppement d'un interrupteur tactile Z-Wave sur la batterie avec boutons lumineux</a></li>
<li><a href="../fr413481/index.html">Exporter l'arbre de test de JMeter vers le texte</a></li>
<li><a href="../fr413485/index.html">Sortie de GitLab 10.8: mise en miroir push open source et d√©ploiement incr√©mentiel</a></li>
<li><a href="../fr413487/index.html">√Ä quoi doit s'attendre un d√©veloppeur dans le domaine de la finance: conditions de travail, projets et comp√©tences n√©cessaires</a></li>
<li><a href="../fr413489/index.html">Comment choisir un messager vraiment s√©curis√© et qu'est-ce que la blockchain a √† voir avec lui</a></li>
<li><a href="../fr413491/index.html">Food Design Digest, mai 2018</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>