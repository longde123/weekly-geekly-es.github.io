<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤚🏼 👩🏿‍🤝‍👩🏼 👆🏾 Bagaimana kami mengatur migrasi untuk proses bisnis di Bitrix24 👩🏻‍⚕️ 🍪 👩🏿‍🏫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Untuk mengotomatiskan operasi mereka, bisnis ini sering menggunakan Bitrix24. Pada artikel ini, kita berbicara tentang beberapa masalah yang mungkin t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bagaimana kami mengatur migrasi untuk proses bisnis di Bitrix24</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/simbirsoft/blog/466823/">  Untuk mengotomatiskan operasi mereka, bisnis ini sering menggunakan Bitrix24.  Pada artikel ini, kita berbicara tentang beberapa masalah yang mungkin terjadi ketika mengubah proses bisnis dan bagaimana kita menyelesaikannya. <br><br><img src="https://habrastorage.org/webt/fx/-p/sj/fx-psjbms29rlcnbbytsumkgw0y.jpeg"><br><a name="habracut"></a><br>  Bitrix24 adalah salah satu sistem CRM yang umum.  Ini termasuk desainer visual (desainer) untuk membangun diagram proses bisnis.  Penting untuk diingat bahwa ketika mengedit proses ini, kesulitan mungkin terjadi - terutama pada proyek besar yang ada, di mana setiap perubahan pertama kali diperiksa pada server lokal dan uji.  Dalam kasus seperti itu, ketika mentransfer ke produksi, kami menggunakan mekanisme migrasi proses bisnis (selanjutnya - BP). <br><br>  Perusahaan kecil, sebagai suatu peraturan, dapat melakukannya tanpa migrasi dan hanya menunda proses bisnis tertentu selama 2-3 hari.  Bisnis besar biasanya tidak mampu membelinya, oleh karena itu menggunakan server uji dan penyebaran. <br><br><img src="https://habrastorage.org/webt/bc/-9/2z/bc-92zo3_pb_lszqvilcyr8ifvc.png"><br><br>  <i>Bitrix24 tentang cara kerja templat proses bisnis</i> <br><br>  Bekerja dengan migrasi memiliki karakteristiknya sendiri.  Secara khusus, ini rumit oleh sejumlah besar objek yang terlibat dan ID.  Selain itu, Bitrix24 juga tidak menyediakan migrasi proses bisnis seperti itu - seringkali masalah ini diselesaikan melalui impor dan ekspor, dan mungkin ada berbagai inkonsistensi.  Mari kita pertimbangkan masalah apa yang mungkin terjadi pada saat bersamaan dari sudut pandang pembangunan. <br><br><h2>  Masalah menemukan templat proses bisnis </h2><br>  Saat membuat proses bisnis, Anda hanya dapat menetapkan nama ke templat, bukan kode unik.  Dalam hal ini, ketika memperbarui proses bisnis, itu harus diperoleh dari database dengan nama.  Kadang-kadang nama berubah karena sistem menggunakannya untuk ditampilkan dalam daftar proses saat startup.  Oleh karena itu, mungkin ada situasi ketika selama pemutakhiran tidak mungkin menemukan templat.  Dan secara umum, mencari berdasarkan nama bukanlah ide yang bagus. <br><br>  <b>Solusi:</b> <br><br>  Semua templat proses bisnis yang dibuat dalam sistem disimpan dalam tabel b_bp_workflow_template.  Setelah membuka tabel, di antara bidang yang kita lihat SYSTEM_CODE: ada bidang untuk kode, itu sama sekali bukan keluaran ke antarmuka.  Kita dapat mengatur kode sendiri menggunakan id templat - dapat dilihat di url pada halaman pengeditan proses: <br><br><img src="https://habrastorage.org/webt/4j/x2/re/4jx2redv2qt5vecw6aulrikvvmc.png"><br><br>  Kita perlu membuat fungsi untuk mendapatkan id templat dan kode, melakukan pemeriksaan duplikasi dan kelengkapan bidang agar templat diubah, dan juga mengatur kodenya. <br><br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Bitrix</span></span>\<span class="hljs-title"><span class="hljs-title">Main</span></span>\<span class="hljs-title"><span class="hljs-title">Loader</span></span>; Loader::includeModule(<span class="hljs-string"><span class="hljs-string">"bizproc"</span></span>); $BPloader = CBPWorkflowTemplateLoader::GetLoader(); <span class="hljs-comment"><span class="hljs-comment">// set template CODE field setTemplateCode ($BPloader, 'TEST', '94' ); function setTemplateCode($BPloader, $code, $tempalteId) { if (isCodeExists($BPloader, $code)) { die('   '); } if (!isCodeEmpty($BPloader, $tempalteId)) { die('     ') } $BPloader-&gt;UpdateTemplate($tempalteId, ['SYSTEM_CODE' =&gt; $code]); } // check if $code exists in DB function isCodeExists($BPloader, string $code) { $dbRes = $BPloader-&gt;GetTemplatesList( $arOrder = ['ID' =&gt; 'DESC'], $arFilter = ['CODE' =&gt; $code], $arGroupBy = false, $arNavStartParams = false, $arSelectFields = ['ID'] ); if (intval($dbRes-&gt;SelectedRowsCount()) &gt; 0) { return true; } return false; } // check if the template code is not empty function isCodeEmpty($BPloader, $tempalteId) { $dbRes = $BPloader-&gt;GetTemplatesList( $arOrder = ['ID' =&gt; 'DESC'], $arFilter = ['CODE' =&gt; '', 'ID' =&gt; $tempalteId], $arGroupBy = false, $arNavStartParams = false, $arSelectFields = ['ID'] ); if (intval($dbRes-&gt;SelectedRowsCount()) &gt; 0) { return false; } return true; } return true; }</span></span></code> </pre> <br>  Silakan.  Misalnya, buat proses bisnis pengujian pada daftar: <br><br><img src="https://habrastorage.org/webt/k4/z-/qc/k4z-qcs92cs5g7xcoiyf4dozfs0.png"><br><br>  Untuk mentransfer proses yang dikembangkan secara lokal ke server uji (dan kemudian ke produksi), kami menggunakan mekanisme migrasi. <br><br>  Bitrix24 memungkinkan Anda untuk mengekspor proses bisnis.  Kami akan menggunakan kesempatan ini. <br><br><img src="https://habrastorage.org/webt/0x/ew/1c/0xew1cwrivumtl94pxwpfqvycoy.png"><br><br>  Skema transfer adalah sebagai berikut: <br><br><ul><li>  Mengekspor proses bisnis </li><li>  Kami menulis migrasi, lampirkan file </li><li>  Di stand baru, kami membuat cadangan proses lama </li><li>  Terapkan migrasi </li></ul><br>  Selanjutnya, pertimbangkan bagaimana proses ini terjadi. <br><br><h2>  Buat migrasi </h2><br>  Kami akan menggunakan modul migrasi dari pasar: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://marketplace.1c-bitrix.ru/solutions/ws.migrations/</a> . <br><br>  File migrasi di proyek kami berlokasi di <b>local / migrasi / skenario</b> <b><br></b> <br><br><img src="https://habrastorage.org/webt/dp/pr/g1/dpprg1qs2z8qe_3i03xq87oo1xs.png"><br><br>  Buka halaman templat proses dan ekspor.  Di dalam direktori migrasi, buat direktori file dan letakkan file yang diekspor di sana.  Ternyata seperti ini: <br><br>  <b>lokal / migrasi / skenario / file / bp-94.bpt</b> <br><br>  Buat skenario migrasi: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ws_m_1565783124_approve_task</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WS</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Migrations</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ScriptScenario</span></span></span><span class="hljs-class"> </span></span>{</code> </pre> <br>  Tentukan parameter templat proses bisnis: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ws_m_1565783124_approve_task</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WS</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Migrations</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ScriptScenario</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $arBPFields = [ <span class="hljs-string"><span class="hljs-string">'DOCUMENT_TYPE'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'lists'</span></span>, <span class="hljs-string"><span class="hljs-string">'BizprocDocument'</span></span>, <span class="hljs-string"><span class="hljs-string">'iblock_'</span></span> ], <span class="hljs-string"><span class="hljs-string">'AUTO_EXECUTE'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'NAME'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'CODE'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TEST'</span></span>, ];</code> </pre> <br>  Kami menerapkan fungsi impor dari proses bisnis: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">importBP</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($path)</span></span></span><span class="hljs-function"> </span></span>{ CModule::IncludeModule(<span class="hljs-string"><span class="hljs-string">'bizproc'</span></span>); CModule::IncludeModule(<span class="hljs-string"><span class="hljs-string">'iblock'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//Get iBlock id for which BP is created $this-&gt;arBPFields['DOCUMENT_TYPE'][2] .= $this-&gt;getIblockId(); // Get BP id by the CODE $result = \CBPWorkflowTemplateLoader::GetList( [], [ 'CODE' =&gt; $this-&gt;arBPFields['CODE'], 'MODULE_ID' =&gt; 'lists' ] ); if ($arFields = $result-&gt;GetNext()) { $id = $arFields['ID']; } else { $id = 0; } //read file to a variable $f = fopen($path, 'rb'); $datum = fread($f, filesize($path)); fclose($f); //Update BP if id&gt;0, otherwise add BP \CBPWorkflowTemplateLoader::ImportTemplate( $id, $this-&gt;arBPFields['DOCUMENT_TYPE'], $this-&gt;arBPFields['AUTO_EXECUTE'], $this-&gt;arBPFields['NAME'], '', $datum, $this-&gt;arBPFields['CODE'] ); return $arFields['ID']; }</span></span></code> </pre><br>  Di sini, kami pertama-tama menentukan ID dari blok informasi yang kami lamar proses, dan mendapatkan id dari templat proses dengan kode yang diberikan. <br><br>  Jika templat ditemukan, kami memperbaruinya.  Jika tidak ditemukan - tambahkan. <br>  Fungsi mengembalikan id dari proses yang dibuat atau diperbarui, dan untuk apa yang diperlukan - kami akan memberi tahu lebih lanjut. <br><br>  Kami menetapkan fungsi komit yang akan menambah / memperbarui proses bisnis kami: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">commit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $pathBPElement = <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span> . <span class="hljs-string"><span class="hljs-string">'/files/bp-94-approve-task.bpt'</span></span>; $id = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;importBP($pathBPElement); }</code> </pre> <br>  Jadi, pada langkah ini kami sudah dapat membuat dan memperbarui proses bisnis tertentu melalui modul migrasi. <br><br><h2>  Masalah memperbarui data template </h2><br>  Mari kembali ke proses bisnis kami dan menambahkan tindakan di sana - pemberitahuan pengguna. <br><br><img src="https://habrastorage.org/webt/tf/m0/8k/tfm08kk36ju3xtaonop4vjpr3lo.png"><br><br>  Sebagai pengirim, kami memilih Penulis.  Penerima akan: <br><br><ul><li>  Kelompok pengguna SDM </li><li>  Pengguna Svetlana Kuznetsova </li></ul><br>  Sekarang mari kita lihat bagaimana proses bisnis direkam dalam database.  Untuk melakukan ini, kami mendapatkan dan mencetak template di konsol PHP di panel admin: <br><br><img src="https://habrastorage.org/webt/yi/ug/nx/yiugnxm3nbaflnr1_syuq9_3ljm.png"><br><br><pre> <code class="php hljs">$arFieldsTemplate = \CBPWorkflowTemplateLoader::GetList([], [<span class="hljs-string"><span class="hljs-string">'ID'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">94</span></span>])-&gt;GetNext(); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;pre&gt;'</span></span>; var_dump($arFieldsTemplate);</code> </pre> <br><br>  Dalam array parameter proses, kita melihat kejadian ini: <br><br><img src="https://habrastorage.org/webt/w6/wm/wb/w6wmwbgunucvakqyk_1skuvqwqa.png"><br><br>  Kami melihat baris group_g15.  Berikut 15 adalah ID grup HR. <br>  Kami melihat baris user_579.  Di sini 579 adalah ID pengguna. <br><br>  Ini berarti bahwa jika kami mengimpor proses di situs lain, kami akan memiliki inkonsistensi berkelanjutan. <br><br>  T.O.  kami perlu melakukan penggantian setelah memigrasi ID-ID ini ke ID yang relevan untuk situs tempat kami mengimpor proses. <br><br>  Grup diidentifikasi oleh kode simbolik, pengguna dengan login. <br><br>  Untuk memulainya, di situs tempat proses itu dibuat, kami memperoleh kode simbol dan login pengguna grup.  Jika Anda tidak memiliki kode grup simbolis yang diatur, lebih baik untuk menulis migrasi dan menginstalnya terlebih dahulu. <br><br>  Dalam contoh kita: <br><br><ul><li>  Kode Grup - SDM </li><li>  Login Pengguna - svetlana.kuznetsova </li></ul><br>  Selanjutnya, kami menulis dalam fungsi migrasi yang oleh kode dan login akan memberi kami id grup dan pengguna: <br><br><ul><li>  getUserId ($ login) </li><li>  getGroupId ($ code); </li></ul><br>  Akhirnya, perbarui nilai yang sesuai dalam templat: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Write action by apply scenario. Use method `setData` for save need rollback data **/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">commit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{</code> </pre> <br><br>  Impor proses bisnis: <br><br><pre> <code class="php hljs">$pathBPElement = <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span> . <span class="hljs-string"><span class="hljs-string">'/files/bp-94-approve-task.bpt'</span></span>; $id = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;importBP($pathBPElement);</code> </pre> <br><br>  Kami mendapatkan data templat: <br><br><pre> <code class="php hljs">$arFieldsTemplate = \CBPWorkflowTemplateLoader::GetList([], [<span class="hljs-string"><span class="hljs-string">'ID'</span></span> =&gt; $id])-&gt;GetNext(); $template = $arFieldsTemplate[<span class="hljs-string"><span class="hljs-string">"TEMPLATE"</span></span>];</code> </pre> <br><br>  Ganti id pengguna di dalam proses bisnis: <br><br><pre> <code class="php hljs">$template[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-string"><span class="hljs-string">'Children'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-string"><span class="hljs-string">'Properties'</span></span>][<span class="hljs-string"><span class="hljs-string">"MessageUserTo"</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-string"><span class="hljs-string">'group_g'</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getGroupId(<span class="hljs-string"><span class="hljs-string">'HR'</span></span>); $template[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-string"><span class="hljs-string">'Children'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-string"><span class="hljs-string">'Properties'</span></span>][<span class="hljs-string"><span class="hljs-string">"MessageUserTo"</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-string"><span class="hljs-string">'user_'</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getUserId(<span class="hljs-string"><span class="hljs-string">'svetlana.kuznetsova'</span></span>); $arNewFields = [ “TEMPLATE” =&gt; $template, “VARIABLES” =&gt; $arFieldsTemplate[<span class="hljs-string"><span class="hljs-string">"VARIABLES"</span></span>] ]; $arNewFields[<span class="hljs-string"><span class="hljs-string">"MODIFIER_USER"</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \CBPWorkflowTemplateUser(CBPWorkflowTemplateUser::CurrentUser); \CBPWorkflowTemplateLoader::Update($id, $arNewFields); }</code> </pre><br>  Di sini, ketika memulai migrasi, kami mengunggah file dan membuat / memperbarui proses dengan fungsi importBP.  Selanjutnya, kita mendapatkan struktur templat proses bisnis ke dalam array, ganti ID dan perbarui templat. <br><br><h2>  Untuk meringkas </h2><br>  Dalam artikel ini, kami menyentuh hanya beberapa kasus di mana inkonsistensi dapat terjadi selama transfer antar situs, dan kami menunjukkan apa yang harus dicari.  Secara umum, dalam praktik kami, kami menemukan binding id berikut: <br><br><ul><li>  user_ (mengikat ke pengguna) </li><li>  group_ (mengikat ke grup pengguna) </li><li>  iblock_ (infoblock binding) </li><li>  SequentialWorkflowActivity (memulai proses bisnis dari templat) </li><li>  PROPERTY_ (mengikat ke bidang dokumen dengan kode karakter yang tidak ditentukan) </li></ul><br>  Jika semuanya dilakukan dengan benar, transfer proses bisnis yang di-debug ke produksi cepat dan lancar. <br><br>  Kami berharap pengalaman kami bermanfaat bagi Anda! <br><br><div class="spoiler">  <b class="spoiler_title">Tunjukkan contoh lengkap</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/** * Updates migration scenario actions **/</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ws_m_1565783124_approve_task</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WS</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Migrations</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ScriptScenario</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $arBPFields = [ <span class="hljs-string"><span class="hljs-string">'DOCUMENT_TYPE'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'lists'</span></span>, <span class="hljs-string"><span class="hljs-string">'BizprocDocument'</span></span>, <span class="hljs-string"><span class="hljs-string">'iblock_'</span></span> ], <span class="hljs-string"><span class="hljs-string">'AUTO_EXECUTE'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'NAME'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'CODE'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TEST'</span></span>, ]; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $codeIBlock = <span class="hljs-string"><span class="hljs-string">'APPROVE_TASK'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Name of scenario * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string **/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">name</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'approve task process'</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * Description of scenario * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string **/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">description</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'process to approve task and set task deadline +14 days after approving'</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> array First element is hash, second is owner name */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">version</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-string"><span class="hljs-string">'13ebf9abe69204014459b80a7036b7a0'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>]; } <span class="hljs-comment"><span class="hljs-comment">/** * Return IBlock ID * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> int */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getIblockId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $result = CIBlock::GetList( [], [ <span class="hljs-string"><span class="hljs-string">'TYPE'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'bitrix_processes'</span></span>, <span class="hljs-string"><span class="hljs-string">'=CODE'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;codeIBlock ], <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, [<span class="hljs-string"><span class="hljs-string">'nTopCount'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>] ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($arIBlock = $result-&gt;Fetch()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $arIBlock[<span class="hljs-string"><span class="hljs-string">'ID'</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * Start import BP * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $path * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> mixed */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">importBP</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($path)</span></span></span><span class="hljs-function"> </span></span>{ CModule::IncludeModule(<span class="hljs-string"><span class="hljs-string">'bizproc'</span></span>); CModule::IncludeModule(<span class="hljs-string"><span class="hljs-string">'iblock'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//Get iBlock id for which BP is created $this-&gt;arBPFields['DOCUMENT_TYPE'][2] .= $this-&gt;getIblockId(); // Get BP id by the CODE $result = \CBPWorkflowTemplateLoader::GetList( [], [ 'CODE' =&gt; $this-&gt;arBPFields['CODE'], 'MODULE_ID' =&gt; 'lists' ] ); if ($arFields = $result-&gt;GetNext()) { $id = $arFields['ID']; } else { $id = 0; } //read file to a variable $f = fopen($path, 'rb'); $datum = fread($f, filesize($path)); fclose($f); //Update BP if id&gt;0, otherwise add BP \CBPWorkflowTemplateLoader::ImportTemplate( $id, $this-&gt;arBPFields['DOCUMENT_TYPE'], $this-&gt;arBPFields['AUTO_EXECUTE'], $this-&gt;arBPFields['NAME'], '', $datum, $this-&gt;arBPFields['CODE'] ); return $arFields['ID']; } /** * @param $login * @return mixed */ private function getUserId($login) { $rsUsers = Bitrix\Main\UserTable::getList([ "select" =&gt;['ID'], "filter" =&gt; ['LOGIN' =&gt; $login], ]); $userFields = $rsUsers-&gt;fetch(); return $userFields['ID']; } /** * @param $code * @return mixed */ private function getGroupId($code) { $rsGroups = \Bitrix\Main\GroupTable::getList( [ 'filter' =&gt; ['STRING_ID'=&gt; 'HR'], 'select' =&gt; ['ID'] ]); $arFields = $rsGroups-&gt;fetch(); return $arFields['ID']; } /** * Write action by apply scenario. Use method `setData` for save need rollback data **/ public function commit() { //make BP import $pathBPElement = _DIR_ . '/files/bp-94-approve-task.bpt'; $id = $this-&gt;importBP($pathBPElement); //get template data $arFieldsTemplate = \CBPWorkflowTemplateLoader::GetList([], ['ID' =&gt; $id])-&gt;GetNext(); $template = $arFieldsTemplate['TEMPLATE']; //replace id inside BP tempalte $template[0]['Children'][0]['Properties']['MessageUserTo'][0] = 'group_g' . $this-&gt;getGroupId('HR'); $template[0]['Children'][0]['Properties']['MessageUserTo'][1] = 'user_' . $this-&gt;getUserId('svetlana.kuznetsova'); $arNewFields = [ 'TEMPLATE' =&gt; $template, 'VARIABLES' =&gt; $arFieldsTemplate['VARIABLES'] ]; $arNewFields['MODIFIER_USER'] = new CBPWorkflowTemplateUser(CBPWorkflowTemplateUser::CurrentUser); \CBPWorkflowTemplateLoader::Update($id, $arNewFields); } /** * Write action by rollback scenario. Use method `getData` for getting commit saved data **/ public function rollback() { $pathBPElement = _DIR_ . '/files/bp-wt-old.bpt'; $id = $this-&gt;importBP($pathBPElement); $arFieldsTemplate = \CBPWorkflowTemplateLoader::GetList([], ['ID' =&gt; $id])-&gt;GetNext(); $template = $arFieldsTemplate['TEMPLATE']; $arNewFields = [ 'TEMPLATE' =&gt; $template, 'VARIABLES' =&gt; $arFieldsTemplate['VARIABLES'] ]; $arNewFields['MODIFIER_USER'] = new CBPWorkflowTemplateUser(CBPWorkflowTemplateUser::CurrentUser); \CBPWorkflowTemplateLoader::Update($id, $arNewFields); } }</span></span></code> </pre> <br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id466823/">https://habr.com/ru/post/id466823/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id466813/index.html">Posit-arithmetic: mengalahkan floating point di bidangnya sendiri. Bagian 2</a></li>
<li><a href="../id466815/index.html">Ikhtisar Teknis NEC HYDRAstor HS8 dan banyak lagi</a></li>
<li><a href="../id466817/index.html">Varonis menemukan virus penambangan crypto: penyelidikan kami</a></li>
<li><a href="../id466819/index.html">Implementasi penawaran promosi di iOS. Bagaimana cara menghasilkan lebih dari langganan?</a></li>
<li><a href="../id466821/index.html">Instal 3CX dari Amazon AWS Marketplace</a></li>
<li><a href="../id466829/index.html">Beberapa sentuhan untuk bekerja dengan ID bigint di R</a></li>
<li><a href="../id466831/index.html">Mengembangkan OS seperti Unix yang monolitik - Heap (4)</a></li>
<li><a href="../id466833/index.html">Hal Penting untuk Diketahui Tentang Tensorflow 2.0</a></li>
<li><a href="../id466837/index.html">Akhir pekan di sepeda listrik dengan generator gas</a></li>
<li><a href="../id466839/index.html">Kisah penciptaan Norton Commander. Bagian 1/3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>