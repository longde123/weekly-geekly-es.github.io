<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§¥üèΩ üëåüèΩ üë©üèª‚Äçüé® C√≥mo pronosticar la demanda y automatizar las compras usando el aprendizaje autom√°tico: caso Ozon üçï ‚òÆÔ∏è üôáüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La tienda en l√≠nea de Ozon tiene casi todo: refrigeradores, comida para beb√©s, computadoras port√°tiles por 100,000, etc. Esto significa que todo esto ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo pronosticar la demanda y automatizar las compras usando el aprendizaje autom√°tico: caso Ozon</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ozontech/blog/431950/"><img src="https://habrastorage.org/webt/rl/bh/0z/rlbh0zbeah9dcpem3uio1wdstxs.png" alt="imagen"><br>  La tienda en l√≠nea de Ozon tiene casi todo: refrigeradores, comida para beb√©s, computadoras port√°tiles por 100,000, etc.  Esto significa que todo esto tambi√©n se encuentra en los almacenes de la empresa, y cuanto m√°s tiempo est√©n los productos, m√°s costosa ser√° la empresa.  Para saber cu√°nto y qu√© le gustar√≠a pedir a la gente, y que Ozon necesitar√≠a comprar, utilizamos el aprendizaje autom√°tico. <br><a name="habracut"></a><br><h3>  Pron√≥stico de ventas: desaf√≠os </h3><br>  Antes de profundizar en el enunciado del problema, comenzamos con un ejemplo.  Este es un verdadero calendario de ventas de Ozon por un tiempo.  Pregunta: ¬øa d√≥nde ir√° despu√©s? <br><br><img src="https://habrastorage.org/webt/jl/nk/1j/jlnk1jejwxtqka-skph4hjccxno.png" alt="imagen"><br><br>  Una persona con una educaci√≥n casi t√©cnica para tal formulaci√≥n del problema tendr√° preguntas: ¬øD√≥nde est√°n los ejes?  ¬øY qu√© tipo de producto?  ¬øY en qu√© unidades?  ¬øDe qu√© instituto te graduaste?  - y muchos otros no incluidos en este art√≠culo por razones √©ticas. <br><br>  De hecho, nadie puede responder correctamente la pregunta en tal declaraci√≥n, y si alguien puede, entonces lo m√°s probable es que se equivoque. <br><br>  Agregue m√°s informaci√≥n a este cuadro: ejes y cambios de precios en el sitio web de Ozon (azul) y en el sitio web de la competencia (naranja). <br><br><img src="https://habrastorage.org/webt/n1/m8/ap/n1m8apunf5mos5bid2xs4qsq1ka.png" alt="imagen"><br><br>  Nuestro precio cay√≥ en alg√∫n momento, pero la competencia sigui√≥ siendo la misma, y ‚Äã‚Äãlas ventas de Ozon aumentaron.  Conocemos los planes de precios: nuestro precio se mantendr√° en el mismo nivel, pero el competidor, siguiendo a Ozon, baj√≥ el precio a casi el nuestro. <br><br>  Estos datos son suficientes para hacer una suposici√≥n significativa, por ejemplo, que las ventas volver√°n al nivel anterior.  Y si nos fijamos en el gr√°fico, resulta que ser√° as√≠. <br><br><img src="https://habrastorage.org/webt/rk/mb/aw/rkmbawctxwb2hf4lhs7l025c9y4.png" alt="imagen"><br><br>  El problema es que, de hecho, la demanda de este producto no se ve muy afectada por el precio, y el crecimiento de las ventas fue causado, entre otras cosas, por la ausencia de la mayor√≠a de los competidores de este producto en nuestra tienda.  Todav√≠a hay muchos factores que no tomamos en cuenta: ¬øse anunciaron los productos en la televisi√≥n?  o tal vez son dulces, y pronto el 8 de marzo? <br><br>  Una cosa est√° clara: hacer un pron√≥stico "sobre la rodilla" no funcionar√°.  Seguimos el camino est√°ndar de un <s>rastrillo y muletas para</s> construir cualquier algoritmo de ML.  Y as√≠ es como fue. <br><br><h3>  Selecci√≥n m√©trica </h3><br>  Elegir una m√©trica es donde comenzar si al menos otra persona adem√°s de usted usar√° su pron√≥stico. <br><br>  Considere un ejemplo: tenemos tres opciones de pron√≥stico.  Cual es mejor <br><img src="https://habrastorage.org/webt/ix/zg/gp/ixzggpclvbgaqpmkzaeehzhamb0.png" alt="imagen"><br>  Desde el punto de vista de los especialistas en el almac√©n, necesitamos un pron√≥stico azul: compraremos un poco menos y nos perderemos el pico a mediados de octubre, pero no quedar√° nada en el almac√©n.  Los expertos cuyos KPI est√°n vinculados a las ventas tienen la opini√≥n opuesta: incluso el pron√≥stico turquesa no es del todo correcto, no todos los saltos en la demanda se han reflejado: vaya a modificarlo.  Pero desde el punto de vista de una persona, desde afuera, generalmente se necesita algo mejor, para que todos se sientan bien o viceversa. <br><br>  Por lo tanto, antes de hacer un pron√≥stico, es necesario determinar qui√©n lo usar√° y por qu√©.  Es decir, elija una m√©trica y comprenda qu√© esperar de una previsi√≥n construida sobre dicha m√©trica.  Y espera solo eso. <br><br>  Elegimos MAE, el error absoluto promedio.  Esta m√©trica es adecuada para nuestra muestra de entrenamiento altamente desequilibrada.  Dado que el surtido es muy amplio (1,5 millones de art√≠culos), cada producto individualmente en una regi√≥n particular se vende en peque√±as cantidades.  Y si en total vendemos cientos de vestidos verdes, entonces un vestido verde particular con gatos se vende a 2-3 por d√≠a.  Como resultado, la muestra se desplaza hacia valores peque√±os.  Por otro lado, hay iPhones, hilanderos, un nuevo libro de Olga Buzova (una broma), etc.  - Y se venden en cualquier ciudad en grandes cantidades.  MAE le permite no recibir grandes multas en iPhones condicionales y, en general, funciona bien en la mayor parte de los productos. <br><br><h3>  Primeros pasos </h3><br>  Comenzamos construyendo el pron√≥stico m√°s est√∫pido que podr√≠a ser: un n√∫mero aleatorio de 0 a 1000 se vender√° durante la pr√≥xima semana y obtendr√° la m√©trica MAE = 496. Probablemente, puede ser peor, pero esto ya es muy malo.  Entonces obtuvimos una directriz: si obtenemos un valor tan m√©trico, entonces obviamente estamos haciendo algo mal. <br><br>  Luego comenzamos a interpretar a personas que saben c√≥mo hacer un pron√≥stico sin aprendizaje autom√°tico, e intentamos predecir que las ventas de bienes durante la pr√≥xima semana ser√≠an iguales a las ventas promedio de todas las √∫ltimas semanas, y obtuvimos la m√©trica MAE = 1.45, que es mucho mejor. <br><br>  Continuando con la raz√≥n, decidimos que las ventas de la semana pasada no ser√≠an m√°s relevantes para pronosticar las ventas para la pr√≥xima semana.  Para tal pron√≥stico, el MAE fue de 1.26.  En la siguiente ronda de pensamiento pron√≥stico, decidimos tener en cuenta ambos factores y predecir las ventas para la pr√≥xima semana como la suma del 50% de las ventas promedio y el 50% de las ventas durante la semana pasada: obtuvimos MAE = 1.23. <br><br>  Pero nos pareci√≥ demasiado simple, y decidimos complicar las cosas.  Recolectamos una peque√±a muestra de entrenamiento en la cual los signos eran ventas pasadas y promedio, y los objetivos eran ventas durante la pr√≥xima semana, y entrenamos en ella una regresi√≥n lineal simple.  Obtuvimos pesos de 0.46 y 0.55 para el promedio y las √∫ltimas semanas y el MAE en la muestra de prueba igual a 1.2. <br>  Conclusi√≥n: nuestros datos tienen potencial predictivo. <br><br><h3>  Ingenier√≠a de caracter√≠sticas </h3><br>  Habiendo decidido que construir un pron√≥stico sobre dos bases no es nuestro nivel, nos sentamos para generar nuevas caracter√≠sticas complejas.  Esta es informaci√≥n sobre ventas pasadas: hace 1, 2, 3, 4 semanas, una semana exactamente hace un a√±o, etc.  Y vistas en las √∫ltimas semanas, adiciones a la canasta, conversi√≥n de vistas y adiciones a la canasta en pedidos, y todo esto por diferentes per√≠odos. <br><br>  Necesit√°bamos proporcionar un modelo de conocimiento sobre c√≥mo se vende el producto en su conjunto, c√≥mo ha cambiado la din√°mica de sus ventas √∫ltimamente, c√≥mo est√° evolucionando el inter√©s en √©l, c√≥mo sus ventas dependen de los precios y otros factores que, en nuestra opini√≥n, pueden ser √∫tiles. <br><br>  Cuando nuestras ideas se agotaron, acudimos a los expertos del departamento de ventas.  All√≠, por ejemplo, aprendimos que el pr√≥ximo a√±o es el a√±o del cerdo, por lo tanto, los productos que al menos se parecen remotamente a los cerdos ser√°n muy populares.  O, por ejemplo, que "no se congele" nuestra gente no compra por adelantado, sino exactamente el d√≠a de las primeras heladas, as√≠ que tenga en cuenta el pron√≥stico del tiempo.  En general, todos estaban satisfechos.  Nosotros, debido a que recibimos un mont√≥n de nuevas ideas que nunca hubi√©ramos pensado de nosotros mismos y de los hombres de negocios, que pronto ser√° posible hacer algo m√°s interesante que el pron√≥stico de ventas. <br><br>  Pero a√∫n es demasiado simple, y hemos agregado s√≠ntomas combinados: <br><br><ul><li>  conversi√≥n de vistas a ventas: c√≥mo fue, c√≥mo cambi√≥; </li><li>  la relaci√≥n de ventas durante 4 semanas a ventas durante la √∫ltima semana (si esta cifra es muy diferente de 4, en este momento la demanda de este producto est√° sujeta a "turbulencia"); </li><li>  la relaci√≥n entre ventas de productos y ventas en toda la categor√≠a: si esta cifra es cercana a uno, entonces el producto es un "monopolista". </li></ul><br>  En esta etapa, debe llegar a la mayor cantidad posible: deseche los signos no informativos en la etapa de entrenamiento. <br><br>  Como resultado, obtuvimos 170 signos.  Mirando hacia el futuro, la mayor importancia de la caracter√≠stica ten√≠a <br><br><ul><li>  Ventas de la semana pasada (para dos, tres y cuatro). </li><li>  La disponibilidad del producto la semana pasada es el porcentaje de tiempo que el producto estuvo presente en el sitio. </li><li>  El coeficiente angular del cronograma de ventas de bienes para los √∫ltimos 7 d√≠as. </li><li>  La relaci√≥n entre el precio pasado y el futuro: con un gran descuento, comience a comprar bienes m√°s activamente. </li><li>  El n√∫mero de competidores directos dentro de nuestro sitio.  Si, por ejemplo, este bol√≠grafo es el √∫nico en su categor√≠a, las ventas ser√°n bastante estacionarias. </li><li>  Dimensiones del producto: result√≥ que el largo y el ancho afectan significativamente la previsibilidad de las ventas.  Por alguna raz√≥n, para objetos largos y estrechos, como paraguas o ca√±as de pescar, por ejemplo, el horario es mucho m√°s vol√°til.  Todav√≠a no sabemos c√≥mo explicar esto. </li><li>  N√∫mero de d√≠a del a√±o: muestra si se acerca el A√±o Nuevo, el 8 de marzo, el inicio de un aumento estacional en las ventas, etc. </li></ul><br><h3>  Muestreo </h3><br>  La muestra de entrenamiento es el dolor.  Lo recolectamos durante aproximadamente 4 semanas, dos de las cuales fueron a diferentes custodios de datos y pidieron un vistazo a lo que tienen.  Esto sucede cada vez que necesita datos durante un largo per√≠odo.  Incluso en un sistema de recopilaci√≥n de datos ideal durante mucho tiempo, algo suceder√° con el esp√≠ritu de "sol√≠amos pensar as√≠, pero luego comenzamos a pensar de manera diferente y escribir los datos en la misma columna".  O hace un a√±o o dos, el servidor se bloque√≥, pero nadie escribi√≥ exactamente cu√°ndo, y los ceros ya no significan que no hubo ventas. <br><br>  Como resultado, ten√≠amos informaci√≥n sobre lo que la gente hac√≠a en el sitio, qu√© y en qu√© cantidades, se agregaron a favoritos y una cesta, y se compraron.  Recolectamos una muestra de aproximadamente 15 millones de muestras de 170 caracter√≠sticas cada una, el objetivo era el n√∫mero de ventas para la pr√≥xima semana. <br><br>  Escribimos 2 mil l√≠neas de c√≥digo en Spark.  Funcion√≥ lentamente, pero permiti√≥ masticar grandes cantidades de datos.  Simplemente parece que calcular la pendiente de una l√≠nea recta es simple.  Y hacerlo 10kk veces cuando las ventas se obtienen de varias bases: la tarea no es para los d√©biles de coraz√≥n. <br><br>  Durante otra semana, nos dedicamos a la limpieza de datos para que el modelo no se distrajera con las emisiones y las caracter√≠sticas de muestreo locales, sino que solo extrajera las verdaderas dependencias inherentes a las ventas de Ozon.  Aqu√≠ ir√°n 3 sigma y m√°s m√©todos astutos para buscar anomal√≠as.  El caso m√°s dif√≠cil es restablecer las ventas durante los per√≠odos de falta de bienes en stock.  La soluci√≥n m√°s simple es descartar las semanas en que el producto estuvo fuera durante la semana "objetivo". <br><br><img src="https://habrastorage.org/webt/kk/li/_z/kkli_zozkhocyxgrkur-eocnq3g.png" alt="imagen"><br><br>  Como resultado, de 15 millones de muestras, quedaron 10 millones. Aqu√≠ es importante no dejarse llevar y no perder la integridad de la muestra (de hecho, la falta de productos en el almac√©n es una caracter√≠stica indirecta de su importancia para la empresa; retirar esos productos de la muestra no es lo mismo que tirar muestras aleatorias ) <br><br><h3>  Tiempo de ML </h3><br>  En una muestra limpia y comenz√≥ a entrenar modelos.  Naturalmente, comenzamos con regresi√≥n lineal y obtuvimos MAE = 1.15.  Parece que este es un aumento muy peque√±o, pero cuando tiene una muestra de 10 millones en la que los valores promedio son 5-10, incluso un peque√±o cambio en el valor m√©trico produce un aumento inconmensurable en la calidad visual del pron√≥stico.  Y dado que eventualmente tendr√° que presentar la soluci√≥n a los clientes comerciales, aumentar su nivel de alegr√≠a es un factor importante. <br><br>  El siguiente fue sklearn.ensemble.RandomForestRegressor, que despu√©s de una corta selecci√≥n de hiperpar√°metros mostr√≥ MAE = 1.10.  Luego probamos XGBoost (sin √©l), todo estar√≠a bien y MAE = 1.03, solo un tiempo muy largo.  Desafortunadamente, no ten√≠amos acceso a la GPU para entrenar XGBoost, y en los procesadores un modelo fue entrenado durante mucho tiempo.  Intentamos encontrar algo m√°s r√°pido y nos decidimos por LightGBM: entren√≥ el doble de r√°pido y mostr√≥ MAE incluso un poco menos: 1.01. <br><br>  Dividimos todos los productos en 13 categor√≠as, como en el cat√°logo en el sitio: mesas, computadoras port√°tiles, botellas, y para cada una de las categor√≠as capacitamos modelos con diferentes profundidades de pron√≥stico: de 5 a 16 d√≠as. <br><br>  La capacitaci√≥n tom√≥ alrededor de cinco d√≠as, y para esto creamos enormes grupos de computaci√≥n.  Desarrollamos una tuber√≠a de este tipo: la b√∫squeda aleatoria funciona durante mucho tiempo, proporciona los 10 conjuntos principales de hiperpar√°metros, y luego el cient√≠fico trabaja con ellos manualmente: construye m√©tricas de calidad adicionales (calculamos MAE para diferentes rangos de objetivos), construye curvas de aprendizaje (por ejemplo, eliminamos parte de la capacitaci√≥n muestras y entrenados nuevamente, verificando si los nuevos datos reducen la p√©rdida en la muestra de prueba) y otros gr√°ficos. <br><br>  Un ejemplo de un an√°lisis detallado para uno de los conjuntos de hiperpar√°metros: <br><br><div class="spoiler">  <b class="spoiler_title">M√©trica de calidad detallada</b> <div class="spoiler_text"><table><tbody><tr><td><p>  Conjunto de trenes: </p><br></td><td><p>  Conjunto de prueba: </p><br></td></tr><tr><td>  Para objetivo = 0, MAE = 0.142222484602 </td><td>  Para 0 MAE = 0.141900737761 </td></tr><tr><td>  Para el objetivo&gt; 0, MAPE = 45.168530676 </td><td>  Para&gt; 0 MAPE = 45.5771812826 </td></tr><tr><td>  Errores mayores que 0 - 67.931341691% </td><td>  Errores mayores que 0 - 51.6405939896% </td></tr><tr><td>  Errores mayores que 1 - 19.0346986379% </td><td>  Errores mayores que 1 - 12.1977096603% </td></tr><tr><td>  Errores m√°s de 2 - 8.94313926245% </td><td>  Errores m√°s de 2 - 5.16977226441% </td></tr><tr><td>  Errores m√°s de 3 - 5.42406856507% </td><td>  Errores m√°s de 3 - 3.12760834969% </td></tr><tr><td>  Errores m√°s de 4 - 3.67938161595% <br></td><td>  Errores m√°s de 4 - 2.10263125679% </td></tr><tr><td>  Errores m√°s de 5 - 2.67322988948% <br></td><td>  Errores m√°s de 5 - 1.56473158807% <br></td></tr><tr><td>  Errores m√°s de 6 - 2.0618556701% <br></td><td>  Errores m√°s de 6 - 1.19599209102% <br></td></tr><tr><td>  Errores m√°s de 7 - 1.65887701209% </td><td>  Errores mayores que 7 - 0.949300173983% <br></td></tr><tr><td>  Errores m√°s de 8 - 1.36821095777% <br></td><td>  Errores m√°s de 8 - 0.78310772461% </td></tr><tr><td>  Errores m√°s de 9 - 1.15368611519% </td><td>  Errores mayores que 9 - 0.659205318158% <br></td></tr><tr><td>  Errores m√°s de 10 - 0.99199395014% </td><td>  Errores m√°s de 10 - 0.554593106723% </td></tr><tr><td>  Errores m√°s de 11 - 0.863969667827% </td><td>  Errores m√°s de 11 - 0.490045146476% <br></td></tr><tr><td>  Errores m√°s de 12 - 0.764347266082% <br></td><td>  Errores m√°s de 12 - 0.428835873827% <br></td></tr><tr><td>  Errores m√°s de 13 - 0.68086818247% </td><td>  Errores m√°s de 13 - 0.386545830907% <br></td></tr><tr><td>  Errores m√°s de 14 - 0.613446089087% </td><td>  Errores m√°s de 14 - 0.343884822697% <br></td></tr><tr><td>  Errores m√°s de 15 - 0.556297016335% <br></td><td>  Errores m√°s de 15 - 0.316433391328% <br></td></tr><tr><td>  Para objetivo = 0, MAE = 0.142222484602 <br></td><td>  Para objetivo = 0, MAE = 0.141900737761 <br></td></tr><tr><td>  Para objetivo = 1, MAE = 0.63978556493 <br></td><td>  Para objetivo = 1, MAE = 0.660823509405 </td></tr><tr><td>  Para objetivo = 2, MAE = 1.01528075312 </td><td>  Para objetivo = 2, MAE = 1.01098070566 </td></tr><tr><td>  Para objetivo = 3, MAE = 1.43762342295 </td><td>  Para objetivo = 3, MAE = 1.44836233499 </td></tr><tr><td>  Para objetivo = 4, MAE = 1.82790678437 <br></td><td>  Para objetivo = 4, MAE = 1.86539223382 <br></td></tr><tr><td>  Para objetivo = 5, MAE = 2.15369976552 <br></td><td>  Para objetivo = 5, MAE = 2.16017884573 </td></tr><tr><td>  Para objetivo = 6, MAE = 2.51629758129 <br></td><td>  Para objetivo = 6, MAE = 2.51987403661 <br></td></tr><tr><td>  Para objetivo = 7, MAE = 2.80225497415 <br></td><td>  Para objetivo = 7, MAE = 2.97580015564 <br></td></tr><tr><td>  Para objetivo = 8, MAE = 3.09405048248 <br></td><td>  Para objetivo = 8, MAE = 3.21914648525 <br></td></tr><tr><td>  Para objetivo = 9, MAE = 3.39256765159 <br></td><td>  Para objetivo = 9, MAE = 3.54572928241 <br></td></tr><tr><td>  Para objetivo = 10, MAE = 3.6640339953 </td><td>  Para objetivo = 10, MAE = 3.84409605282 <br></td></tr><tr><td>  Para objetivo = 11, MAE = 4.02797747118 <br></td><td>  Para objetivo = 11, MAE = 4.21828735273 <br></td></tr><tr><td>  Para objetivo = 12, MAE = 4.17163467899 <br></td><td>  Para objetivo = 12, MAE = 3.92536509115 <br></td></tr><tr><td>  Para objetivo = 14, MAE = 4.78590364522 <br></td><td>  Para objetivo = 14, MAE = 5.11290428675 </td></tr><tr><td>  Para objetivo = 15, MAE = 4.89409916994 <br></td><td>  Para objetivo = 15, MAE = 5.20892023117 <br></td></tr></tbody></table><br>  P√©rdida de tren = 0.535842111392 <br>  P√©rdida de prueba = 0.895529959873 <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Predicci√≥n gr√°fica (objetivo) para el conjunto de entrenamiento</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/3m/o6/ho/3mo6hoqfklfc69z55btog7e6q_w.png" alt="imagen"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Predicci√≥n gr√°fica (objetivo) para la muestra de prueba</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/hq/q6/bm/hqq6bm7aqcbngqum8mgdyhjibna.png" alt="imagen"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Error de predicci√≥n de vez en cuando</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/in/mu/be/inmubedyg9b6hzyttimdneuh5-s.png" alt="imagen"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Ordenar error ascendente en muestra de prueba</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/74/h3/kt/74h3ktebx43a9mhmie6sgp5ua_i.png" alt="imagen"><br></div></div><br>  Si ninguno coincide, busque al azar nuevamente.  As√≠ es como entrenamos el modelo durante 5 o 5 d√≠as al ritmo industrial.  Est√°bamos de servicio, alguien por la noche, alguien se despertaba por la ma√±ana, miraba los 10 par√°metros principales, reiniciaba o guardaba el modelo y se acostaba m√°s.  En este modo, trabajamos durante una semana y capacitamos a 130 modelos: 13 tipos de productos y 10 profundidades de pron√≥stico, cada uno con 170 caracter√≠sticas.  El promedio de MAE para la serie temporal de 5 veces cv obtuvimos igual a 1. <br><br>  Puede parecer que esto no es muy bueno, y esto es as√≠, a menos que tenga una gran parte en la selecci√≥n de unidades.  Como lo muestra un an√°lisis de los resultados, se predice que las unidades son las peores de todas: el hecho de que un producto se haya comprado una vez por semana no dice nada acerca de si hay demanda para √©l.  Una vez que se puede vender algo, hay una persona que comprar√° una figura de porcelana en forma de dentista, y esto no dice nada sobre ventas futuras o sobre ventas pasadas.  En general, no nos enojamos mucho por esto. <br><br><h3>  Consejos y trucos. </h3><br>  ¬øQu√© sali√≥ mal y c√≥mo se puede evitar? <br><br>  El primer problema es la selecci√≥n de par√°metros.  Comenzamos a usar RandomizedSearchCV, una herramienta muy conocida de sklearn para ordenar hiperpar√°metros.  Aqu√≠ es donde nos esperaba la primera sorpresa. <br><br><div class="spoiler">  <b class="spoiler_title">Como este</b> <div class="spoiler_text"><code>from sklearn.model_selection import ParameterSampler <br> from sklearn.model_selection import RandomizedSearchCV <br> <br> estimator = lightgbm.LGBMRegressor(application='regression_l1', is_training_metric = True, objective = 'regression_l1', num_threads=72) <br> param_grid = {'boosting_type': boosting_type, 'num_leaves': num_leaves, 'max_depth': max_depth, 'learning_rate':learning_rate, 'n_estimators': n_estimators, 'subsample_for_bin': subsample_for_bin, 'min_child_samples': min_child_samples, 'colsample_bytree': colsample_bytree, 'reg_alpha': reg_alpha, 'max_bin': max_bin} <br> <br> rscv = RandomizedSearchCV(estimator, param_grid, refit=False, n_iter=100, scoring='neg_mean_absolute_error', n_jobs=1, cv=10, verbose=3, pre_dispatch='1*n_jobs', error_score=-1, return_train_score='warn') <br> <br> rscv .fit(X_train.values, y_train['target'].values) <br> print('Best parameters found by grid search are:', rscv.best_params_)</code> <br> </div></div><br>  El c√°lculo simplemente se detiene (lo cual es importante, no cae, pero contin√∫a funcionando, pero en un n√∫mero cada vez menor de n√∫cleos y en alg√∫n momento simplemente se detiene). <br><br><div class="spoiler">  <b class="spoiler_title">Tuve que paralelizar el proceso debido a RandomizedSearchCV</b> <div class="spoiler_text"> <code>estimator = lightgbm.LGBMRegressor(application='regression_l1', is_training_metric = True, objective = 'regression_l1', num_threads=1) <br> <br> rscv = RandomizedSearchCV(estimator, param_grid, refit=False, n_iter=100, scoring='neg_mean_absolute_error', n_jobs=72, cv=10, verbose=3, pre_dispatch='1*n_jobs', error_score=-1, return_train_score='warn') <br> <br> rscv .fit(X_train.values, y_train['target'].values) <br> print('Best parameters found by grid search are:', rscv.best_params_)</code> <br> </div></div><br>  Pero RandomizedSearchCV toma casi todo el conjunto de datos para cada "trabajo".  En consecuencia, es necesario expandir en gran medida la cantidad de RAM, posiblemente sacrificando el n√∫mero de n√∫cleos. <br><br>  ¬°Qui√©n nos dir√≠a sobre cosas tan maravillosas como el hiperm√©trope!  Desde que aprendimos, solo lo usamos. <br><br>  Otro truco que se nos ocurri√≥ cerca del final del proyecto fue elegir modelos que tuvieran el par√°metro colsample_bytree (este es el par√°metro LightGBM, que dice qu√© porcentaje de caracter√≠sticas dar a cada nivel) en la regi√≥n de 0.2-0.3, porque cuando el autom√≥vil Funciona en producci√≥n, puede que no haya tablas y que las caracter√≠sticas individuales no se cuenten correctamente.  Dicha regularizaci√≥n le permite asegurarse de que estas caracter√≠sticas no contabilizadas afecten al menos a no todos los prestamistas dentro del modelo. <br>  Emp√≠ricamente, hemos llegado a la conclusi√≥n de que necesitamos hacer m√°s estimadores y torcer m√°s la regularizaci√≥n.  Esta no es una regla de trabajo con LightGBM, pero tal esquema funcion√≥ para nosotros. <br><br>  Bueno y, por supuesto, Spark.  Por ejemplo, hay un error que Spark mismo conoce: si toma varias columnas de una tabla y crea una nueva, y luego toma otras de la misma tabla y crea una nueva, y luego sintoniza las tablas que recibe, todo se romper√°, aunque no deber√≠a.  Solo puede salvarse al deshacerse de todos los c√°lculos perezosos.  Incluso escribimos una funci√≥n especial: bumb_df, convierte el Marco de datos en un RDD nuevamente en un Marco de datos.  Es decir, restablece todos los c√°lculos perezosos.  Esto puede protegerte de la mayor√≠a de los problemas de Spark. <br><br><div class="spoiler">  <b class="spoiler_title">bumb_df</b> <div class="spoiler_text"> <code>def bump_df(df): <br> # to avoid problem: AnalysisException: resolved attribute(s) <br> df_rdd = df.rdd <br> if df_rdd.isEmpty(): <br> df = df_rdd.toDF(schema=df.schema) <br> return df <br> else: <br> return df_rdd.toDF(schema=df.schema) <br></code> <br></div></div><br><h3>  El pron√≥stico est√° listo: ¬øcu√°nto pediremos? </h3><br>  Pronosticar las ventas es una tarea puramente matem√°tica, y si la distribuci√≥n normal de un error de media cero es una victoria para un matem√°tico, entonces, para los comerciantes que tienen todos los rublos en su cuenta, esto es inaceptable. <br><br>  Si un iPhone adicional o un vestido de moda en el almac√©n no es un problema, sino m√°s bien un stock de seguros, entonces la ausencia del mismo iPhone en el almac√©n es una p√©rdida de al menos un margen, y como m√°ximo de imagen, y esto no puede permitirse. <br><br>  Para ense√±ar el algoritmo a comprar tanto como sea necesario, tuvimos que calcular el costo de recompra y subcompra de cada producto y entrenar un modelo simple para minimizar las posibles p√©rdidas de dinero. <br><br>  El modelo recibe un pron√≥stico de ventas en la entrada, le agrega ruido aleatorio, normalmente distribuido (simulamos las imperfecciones de los proveedores) y aprende a agregar exactamente lo mismo al pron√≥stico para cada producto en particular para minimizar las p√©rdidas de dinero. <br><br>  Por lo tanto, un pedido es un pron√≥stico + stock de seguridad, que garantiza la cobertura del error de pron√≥stico y la imperfecci√≥n del mundo exterior. <br><br><h3>  Como en prod </h3><br>  Ozon tiene su propio cl√∫ster inform√°tico bastante grande, en el que todas las noches se lanza una tuber√≠a (usamos flujo de aire) de m√°s de 15 trabajos.  Se ve as√≠: <br><br><img src="https://habrastorage.org/webt/cc/sq/gb/ccsqgbj2p2xztr9qlllahzgr_4c.png" alt="imagen"><br><br>  Cada noche, se lanza el algoritmo, extrae alrededor de 20 GB de datos de una variedad de fuentes en archivos hdf locales, selecciona un proveedor para cada producto, recopila caracter√≠sticas para cada producto, realiza un pron√≥stico de ventas y genera pedidos basados ‚Äã‚Äãen el cronograma de entrega.  A las 6-7 a.m., entregamos a la mesa personas que son responsables de trabajar con los proveedores de mesas preparadas que se van volando con solo un clic a los proveedores. <br><br><h3>  Ni un solo pron√≥stico </h3><br>  El modelo entrenado sabe sobre la dependencia del pron√≥stico en cualquier caracter√≠stica y, como resultado, si congela los signos N-1 y comienza a cambiar uno, puede observar c√≥mo afecta el pron√≥stico.  Por supuesto, lo m√°s interesante de esto es c√≥mo las ventas dependen del precio. <br><br>  Es importante tener en cuenta que la demanda depende no solo del precio.  Por ejemplo, si hace peque√±os descuentos en trineos en el verano, todav√≠a no les ayuda a vender.  Estamos haciendo un descuento m√°s, y aparecen personas que est√°n "preparando un trineo en el verano".  Pero hasta cierto nivel de descuentos, a√∫n no podemos llegar a la parte del cerebro responsable de la planificaci√≥n.  En invierno, funciona como para cualquier producto: hace un descuento y se vende m√°s r√°pido. <br><br><img src="https://habrastorage.org/webt/zp/by/jg/zpbyjgawjuxfa0pfm3rrp0sb4f0.png" alt="imagen"><br><br><h3>  Planes </h3><br>  Ahora estamos estudiando activamente la agrupaci√≥n de series de tiempo para distribuir productos entre grupos en funci√≥n de la naturaleza de la curva que describe sus ventas.  Por ejemplo, estacional, tradicionalmente popular en verano o, por el contrario, en invierno.  Cuando aprendamos c√≥mo separar productos con un largo historial de ventas, planeamos resaltar las caracter√≠sticas basadas en art√≠culos que le indicar√°n cu√°l ser√° el patr√≥n de ventas para un producto nuevo y reci√©n presentado; por ahora, esta es nuestra tarea principal. <br><br>  Las redes neuronales y los modelos param√©tricos de series de tiempo, y todo esto en el conjunto, seguramente estar√°n m√°s all√°. <br><br>  En particular, gracias al nuevo sistema de pron√≥stico, Ozon cambi√≥ de comprar bienes con stock a entregas c√≠clicas, cuando compramos de un suministro a otro y no almacenamos saldos en stock. <br><br>  Ahora tenemos que decidir c√≥mo ense√±ar el algoritmo para predecir las ventas de nuevos productos y categor√≠as enteras.  El pr√≥ximo a√±o, la compa√±√≠a planea aumentar las ventas x10 en categor√≠as y x2.5 en √°reas de cumplimiento.  Y debemos decirles a los modelos que estos datos antiguos son relevantes, pero para una tienda anterior diferente.  Y mientras estamos pensando c√≥mo hacerlo. <br><br>  La segunda cosa irracional por naturaleza que tenemos que aprender a predecir es la moda.  ¬øC√≥mo podr√≠a uno predecir que una ruleta se vender√≠a as√≠?  ¬øC√≥mo predecir las ventas de libros nuevos de Dan Brown si uno de sus libros est√° agotado y el otro no?  Mientras estamos trabajando en ello. <br><br>  Si sabe c√≥mo hacerlo mejor, o si tiene historias sobre el uso del aprendizaje autom√°tico en la batalla en los comentarios, lo discutiremos. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es431950/">https://habr.com/ru/post/es431950/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es431940/index.html">Las personas se agotan si no sienten su val√≠a. ¬øQu√© hacer al respecto?</a></li>
<li><a href="../es431942/index.html">Inyecci√≥n de dependencia jer√°rquica en React y MobX State Tree como modelo de dominio</a></li>
<li><a href="../es431944/index.html">Yealink Meeting Server 2.0 - Nuevas caracter√≠sticas de videoconferencia</a></li>
<li><a href="../es431946/index.html">Semana de la seguridad 49: pirater√≠a de Dell y Marriott</a></li>
<li><a href="../es431948/index.html">Deep Mind ense√±√≥ a su IA a predecir la estructura de la prote√≠na</a></li>
<li><a href="../es431954/index.html">El ex vicepresidente de Sun y DEC se convierte en presidente de MIPS / Wave, habla sobre Rusia y RISC / V</a></li>
<li><a href="../es431956/index.html">L√≥gica, explicabilidad y comprensi√≥n futura.</a></li>
<li><a href="../es431958/index.html">La estaci√≥n de energ√≠a de bater√≠a virtual de Tesla se expande a 1,000 hogares en Australia</a></li>
<li><a href="../es431960/index.html">Nvidia se vuelve loca y abre PhysX bajo BSD-3</a></li>
<li><a href="../es431964/index.html">Combinar clasificaciones</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>