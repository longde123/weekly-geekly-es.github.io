<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐹 🧝 📃 Mudah dan mudah untuk menerapkan aplikasi pada Tarantool Cartridge (bagian 2) 👩🏿‍🔧 🤔 ✌🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Baru-baru ini, kami berbicara tentang cara menggunakan aplikasi yang ditulis dalam Tarantool Cartridge . Tetapi operasi tidak berakhir pada penyebaran...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mudah dan mudah untuk menerapkan aplikasi pada Tarantool Cartridge (bagian 2)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/484192/"><p><img src="https://habrastorage.org/webt/yc/gm/xx/ycgmxxaqlvyslsrzoo6jnv1vmx0.jpeg"></p><br><p>  Baru-baru ini, kami <a href="https://habr.com/ru/company/mailru/blog/478710/">berbicara</a> tentang cara menggunakan aplikasi yang ditulis dalam <a href="https://habr.com/ru/company/mailru/blog/465503/">Tarantool Cartridge</a> .  Tetapi operasi tidak berakhir pada penyebaran, jadi hari ini kami akan memperbarui aplikasi kami dan memahami bagaimana mengelola topologi, sharding dan otorisasi, serta mengubah konfigurasi peran. </p><br><p>  Ingin tahu silakan potong! </p><a name="habracut"></a><br><h2 id="na-chem-my-ostanovilis">  Di mana kami berhenti </h2><br><p>  Terakhir kali kami mengonfigurasi topologi berikut: </p><br><p><img src="https://habrastorage.org/webt/sw/0z/gm/sw0zgm53me7ft63db8lxrswcxvw.png"></p><br><p> Contoh <a href="https://github.com/dokshina/deploy-tarantool-cartridge-app">repositori</a> berhasil mengubah sedikit, file-file baru muncul di sana, <code>getting-started-app-2.0.0-0.rpm</code> dan <code>hosts.updated.2.yml</code> .  Anda tidak harus menarik versi baru, Anda cukup mengunduh paket dari <a href="">tautan</a> , dan <code>hosts.updated.2.yml</code> hanya diperlukan sehingga Anda dapat mengintip ke sana jika terjadi kesulitan dengan mengubah inventaris saat ini. </p><br><p>  Jika Anda telah menyelesaikan semua langkah dari bagian sebelumnya dari tutorial ini, maka sekarang di <code>hosts.yml</code> hosts.yml Anda ada konfigurasi cluster dengan dua replika <code>storage</code> (dalam repositori ini adalah <code>hosts.updated.yml</code> ). </p><br><p>  Angkat mesin virtual kami: </p><br><pre> <code class="bash hljs">$ vagrant up</code> </pre> <br><p>  Instal versi baru dari Tarantool Cartridge Ansible-role (berhasil mengubah, tentu saja, menjadi lebih baik): </p><br><pre> <code class="bash hljs">$ ansible-galaxy install tarantool.cartridge,1.0.2</code> </pre> <br><p>  Jadi, konfigurasi cluster saat ini: </p><br><pre> <code class="plaintext hljs">--- all: vars: # common cluster variables cartridge_app_name: getting-started-app cartridge_package_path: ./getting-started-app-1.0.0-0.rpm # path to package cartridge_cluster_cookie: app-default-cookie # cluster cookie # common ssh options ansible_ssh_private_key_file: ~/.vagrant.d/insecure_private_key ansible_ssh_common_args: '-o IdentitiesOnly=yes -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no' # INSTANCES hosts: storage-1: config: advertise_uri: '172.19.0.2:3301' http_port: 8181 app-1: config: advertise_uri: '172.19.0.3:3301' http_port: 8182 storage-1-replica: config: advertise_uri: '172.19.0.3:3302' http_port: 8183 storage-2: config: advertise_uri: '172.19.0.3:3303' http_port: 8184 storage-2-replica: config: advertise_uri: '172.19.0.2:3302' http_port: 8185 children: # GROUP INSTANCES BY MACHINES host1: vars: # first machine connection options ansible_host: 172.19.0.2 ansible_user: vagrant hosts: # instances to be started on the first machine storage-1: storage-2-replica: host2: vars: # second machine connection options ansible_host: 172.19.0.3 ansible_user: vagrant hosts: # instances to be started on the second machine app-1: storage-1-replica: storage-2: # GROUP INSTANCES BY REPLICA SETS replicaset_app_1: vars: # replica set configuration replicaset_alias: app-1 failover_priority: - app-1 # leader roles: - 'api' hosts: # replica set instances app-1: replicaset_storage_1: vars: # replica set configuration replicaset_alias: storage-1 weight: 3 failover_priority: - storage-1 # leader - storage-1-replica roles: - 'storage' hosts: # replica set instances storage-1: storage-1-replica: replicaset_storage_2: vars: # replicaset configuration replicaset_alias: storage-2 weight: 2 failover_priority: - storage-2 - storage-2-replica roles: - 'storage' hosts: # replicaset instances storage-2: storage-2-replica:</code> </pre> <br><p>  Buka <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard</a> dan pastikan cluster Anda dalam keadaan yang benar. </p><br><p>  Semuanya sama seperti terakhir kali: kita akan secara bertahap mengubah file ini dan mengamati bagaimana perubahan cluster.  Anda selalu dapat melihat versi final di <code>hosts.updated.2.yml</code> </p><br><p>  Jadi di sini kita mulai! </p><br><h2 id="obnovlyaem-prilozhenie">  Memperbarui aplikasi </h2><br><p>  Untuk memulai, mari perbarui aplikasi kami.  Pastikan Anda memiliki file <code>getting-started-app-2.0.0-0.rpm</code> di direktori saat ini (jika tidak, <a href="">unduh</a> dari repositori). </p><br><p>  Tentukan jalur ke versi baru paket: </p><br><pre> <code class="plaintext hljs">--- all: vars: cartridge_app_name: getting-started-app cartridge_package_path: ./getting-started-app-2.0.0-0.rpm # &lt;== cartridge_enable_tarantool_repo: false # &lt;==</code> </pre> <br><p>  Kami menentukan <code>cartridge_enable_tarantool_repo: false</code> sehingga peran tersebut tidak menghubungkan repositori dengan paket Tarantool, yang sudah kami pasang terakhir kali.  Ini akan sedikit mempercepat proses penyebaran, tetapi sama sekali tidak perlu. </p><br><p>  Luncurkan playbook dengan tag <code>cartridge-instances</code> : </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-instances</code> </pre> <br><p>  Dan kami memeriksa bahwa paket tersebut telah diperbarui: </p><br><pre> <code class="bash hljs">$ vagrant ssh vm1 [vagrant@svm1 ~]$ sudo yum list installed | grep getting-started-app</code> </pre> <br><p>  Periksa apakah versinya telah menjadi <code>2.0.0</code> : </p><br><pre> <code class="bash hljs">getting-started-app.x86_64 2.0.0-0 installed</code> </pre> <br><p>  Sekarang Anda dapat dengan aman bereksperimen dengan versi aplikasi yang baru. </p><br><h2 id="vklyuchaem-shardirovanie">  Hidupkan sharding </h2><br><p>  Mari aktifkan sharding sehingga kita bisa mengendalikan replika <code>storage</code> nanti.  Ini dilakukan dengan sangat sederhana.  Tambahkan variabel <code>cartridge_bootstrap_vshard</code> <code>all.vars</code> : </p><br><pre> <code class="plaintext hljs">--- all: vars: ... cartridge_cluster_cookie: app-default-cookie # cluster cookie cartridge_bootstrap_vshard: true # &lt;== ... hosts: ... children: ...</code> </pre> <br><p>  Kami meluncurkan: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-config</code> </pre> <br><p>  Harap dicatat bahwa kami menetapkan tag <code>cartridge-config</code> untuk menjalankan hanya tugas-tugas yang terlibat dalam konfigurasi cluster. </p><br><p>  Buka Web UI <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard</a> dan lihat bahwa ember kami didistribusikan di seluruh set replika penyimpanan dalam rasio <code>2:3</code> (kami menentukan bobot tersebut untuk set replika kami, ingat?): </p><br><p><img src="https://habrastorage.org/webt/g_/vd/78/g_vd787hpifhrlhk-jfs5sw8iu4.png"></p><br><h2 id="vklyuchaem-avtomaticheskiy-failover">  Aktifkan failover otomatis </h2><br><p>  Dan sekarang kita akan mengaktifkan mode failover otomatis sehingga kita bisa mencari tahu apa itu dan bagaimana cara kerjanya nanti. </p><br><p>  Tambahkan bendera <code>cartridge_failover</code> ke konfigurasi: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... cartridge_cluster_cookie: app-default-cookie # cluster cookie cartridge_bootstrap_vshard: true cartridge_failover: true # &lt;== ... hosts: ... children: ...</code> </pre> <br><p>  Kami kembali memulai tugas manajemen cluster: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-config</code> </pre> <br><p>  Setelah berhasil menyelesaikan playbook, Anda dapat pergi ke UI Web dan memastikan bahwa sakelar <code>Failover</code> di sudut kanan atas diaktifkan.  Untuk mematikan mode failover otomatis, cukup ubah nilai <code>cartridge_failover</code> ke <code>false</code> dan jalankan playbook lagi. </p><br><p>  Sudah waktunya untuk mencari tahu seperti apa rezim ini dan mengapa kami menyalakannya. </p><br><h2 id="razbiraemsya-s-failover-om">  Kami berurusan dengan failover </h2><br><p>  Anda mungkin memperhatikan variabel <code>failover_priority</code> yang kami tentukan untuk setiap replaset.  Mari kita lihat apa itu. </p><br><p>  Tarantool Cartridge menyediakan mode failover otomatis.  Setiap replika memiliki pemimpin - contoh yang sedang direkam.  Jika sesuatu terjadi pada pemimpin, salah satu pernyataan akan mengambil perannya.  Yang mana  Mari kita lihat lebih dekat pada set replika <code>storage-2</code> : </p><br><pre> <code class="plaintext hljs">--- all: ... children: ... replicaset_storage_2: vars: ... failover_priority: - storage-2 - storage-2-replica</code> </pre> <br><p>  Contoh <code>storage-2</code> kami tentukan pertama di <code>failover_priority</code> .  Di UI Web, ini muncul pertama kali dalam daftar instance replaset dan ditandai dengan mahkota hijau.  Ini adalah pemimpin - contoh pertama yang ditentukan dalam <code>failover_priority</code> : </p><br><p><img src="https://habrastorage.org/webt/ge/om/bg/geombgvhy6plfnrwpz0o8jqgnaw.png"></p><br><p>  Sekarang mari kita lihat apa yang terjadi jika sesuatu terjadi pada pemimpin replaset.  Kami masuk ke mesin virtual dan menghentikan instance <code>storage-2</code> : </p><br><pre> <code class="bash hljs">$ vagrant ssh vm2 [vagrant@vm2 ~]$ sudo systemctl stop getting-started-app@storage-2</code> </pre> <br><p>  Kembali ke UI Web: </p><br><p><img src="https://habrastorage.org/webt/iy/b2/ff/iyb2ff_a6dryhg0nik8p48rhqhm.png"></p><br><p>  Mahkota di instance <code>storage-2</code> berubah merah - ini berarti bahwa pemimpin yang ditunjuk tidak sehat.  Tetapi <code>storage-2-replica</code> memiliki mahkota hijau - instance ini mengambil alih tanggung jawab kepemimpinan sampai <code>storage-2</code> kembali ke layanan.  Ini adalah kegagalan otomatis dalam tindakan. </p><br><p>  Mari kita hidupkan kembali <code>storage-2</code> : </p><br><pre> <code class="bash hljs">$ vagrant ssh vm2 [vagrant@vm2 ~]$ sudo systemctl start getting-started-app@storage-2</code> </pre> <br><p>  Semuanya kembali ke titik awal: </p><br><p><img src="https://habrastorage.org/webt/ge/om/bg/geombgvhy6plfnrwpz0o8jqgnaw.png"></p><br><p>  Mari kita mengubah urutan instance dalam prioritas failover.  Kami akan menjadikan instance <code>storage-2-replica</code> sebagai pemimpin, dan menghapus <code>storage-2</code> dari daftar secara umum: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... hosts: ... children: ... replicaset_storage_2: vars: # replicaset configuration ... failover_priority: - storage-2-replica # &lt;== ...</code> </pre> <br><p>  Jalankan <code>cartridge-replicasets</code> untuk instance dari grup <code>replicaset_storage_2</code> : </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> replicaset_storage_2 \ --tags cartridge-replicasets</code> </pre> <br><p>  Kami pergi ke <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard</a> dan melihat bahwa pemimpin telah berubah: </p><br><p><img src="https://habrastorage.org/webt/r_/hq/bm/r_hqbmgxwbkvcycacj7pnotjhjc.png"></p><br><p>  Tapi kami menghapus instance <code>storage-2</code> dari konfigurasi, mengapa masih ada di sini?  Faktanya adalah bahwa Cartridge, menerima nilai baru dari <code>failover_priority</code> mengatur instance sebagai berikut: instance pertama dari daftar menjadi leader, sisa instance yang ditunjukkan akan mengikuti.  Contoh yang tidak disebutkan dalam <code>failover_priority</code> akan dipesan oleh UUID dan ditambahkan sampai akhir. </p><br><h2 id="izgnanie-instansa">  Contoh Pengasingan </h2><br><p>  Tetapi bagaimana jika kita ingin mengecualikan instance dari topologi?  Semuanya sangat sederhana: Anda harus melewati bendera yang <code>expelled</code> untuk <code>expelled</code> .  Mari kita kecualikan instance <code>storage-2-replica</code> .  Dia adalah pemimpin sekarang, jadi Cartridge tidak akan mengizinkan kita untuk melakukan ini.  Tapi kami tidak takut kesulitan, dan masih mencoba: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... hosts: storage-2-replica: config: advertise_uri: '172.19.0.2:3302' http_port: 8185 expelled: true # &lt;== ...</code> </pre> <br><p>  Kami menentukan <code>cartridge-replicasets</code> , karena mengeluarkan instance adalah perubahan topologi: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> replicaset_storage_2 \ --tags cartridge-replicasets</code> </pre> <br><p>  Jalankan playbook dan lihat kesalahannya: </p><br><p><img src="https://habrastorage.org/webt/hf/wf/tc/hfwftcua4yyueyi0qgngr2mveia.png"></p><br><p>  Seperti yang baru saja kita lihat, Cartridge tidak membenarkan membuang pemimpin replika saat ini dari topologi.  Ini cukup logis, karena replikasi asinkron, pengecualian pemimpin cenderung menyebabkan kehilangan data.  Kita perlu menentukan pemimpin lain dan hanya setelah itu mengecualikan instance.  Peran tersebut pertama-tama akan menerapkan konfigurasi replaset baru dan kemudian menangani pengecualian.  Karenanya, kami mengubah <code>failover_priority</code> dan menjalankan playbook lagi: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... hosts: ... children: ... replicaset_storage_2: vars: # replicaset configuration ... failover_priority: - storage-2 # &lt;== ...</code> </pre> <br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> replicaset_storage_2 \ --tags cartridge-replicasets</code> </pre> <br><p>  Voila, instance <code>storage-2-replica</code> telah menghilang dari topologi! </p><br><p><img src="https://habrastorage.org/webt/tl/ao/ue/tlaoue_hclprc1i6tdjuil5efyk.png"></p><br><p>  Perhatikan bahwa pengasingan instance benar-benar final dan tidak dapat dibatalkan.  Setelah menghapus instance dari topologi, peran kita yang mungkin akan menghentikan layanan systemd dan menghapus semua file dari instance ini. </p><br><p><img src="https://habrastorage.org/webt/_7/bp/nx/_7bpnxxuydmfmddneontw1nxexi.png"></p><br><p>  Jika Anda tiba-tiba berubah pikiran dan memutuskan bahwa replika <code>storage-2</code> masih membutuhkan instance kedua, Anda tidak akan dapat mengembalikannya.  Cartridge mengingat UUID dari semua instance yang telah meninggalkan topologi dan tidak akan membiarkan pengasingan kembali.  Anda dapat memunculkan instance baru dengan nama dan konfigurasi yang sama, tetapi jelas akan memiliki UUID yang berbeda, sehingga Cartridge akan mengizinkannya untuk bergabung. </p><br><h2 id="udalenie-replikaseta">  Menghapus Replicaset </h2><br><p>  Kami telah menemukan bahwa kami tidak akan diizinkan untuk mengeluarkan pemimpin dari replika.  Tetapi bagaimana jika kita ingin menghapus replika <code>storage-2</code> secara permanen?  Tentu saja ada jalan keluar. </p><br><p>  Agar tidak kehilangan data, pertama-tama kita harus mentransfer semua ember ke <code>storage-1</code> , untuk ini kita mengatur berat replika <code>storage-2</code> ke <code>0</code> : </p><br><pre> <code class="plaintext hljs">--- all: vars: ... hosts: ... children: ... replicaset_storage_2: vars: # replicaset configuration replicaset_alias: storage-2 weight: 0 # &lt;== ... ...</code> </pre> <br><p>  Luncurkan manajemen topologi: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> replicaset_storage_2 \ --tags cartridge-replicasets</code> </pre> <br><p>  Buka Web UI <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard</a> dan perhatikan bagaimana semua ember mengalir ke <code>storage-1</code> : </p><br><p><img src="https://habrastorage.org/webt/nk/mo/fq/nkmofqnvvoccqfqkyz1myryu4-s.png"></p><br><p>  Kami mengatur pemimpin <code>storage-2</code> ke bendera yang dikeluarkan dan mengucapkan selamat tinggal pada replika ini: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... hosts: ... storage-2: config: advertise_uri: '172.19.0.3:3303' http_port: 8184 expelled: true # &lt;== ...</code> </pre> <br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-replicasets</code> </pre> <br><p>  Harap perhatikan bahwa saat ini kami tidak menentukan opsi <code>limit</code> , karena setidaknya satu contoh dari semua yang kami luncurkan playbook tidak boleh ditandai sebagai <code>expelled</code> . </p><br><p>  Jadi kami kembali ke topologi asli: </p><br><p><img src="https://habrastorage.org/webt/70/zo/vq/70zovqqaeiph6v1bjoenzl_hn1w.png"></p><br><h2 id="avtorizaciya">  Login </h2><br><p>  Saya mengusulkan untuk mengalihkan perhatian dari mengelola set replika dan memikirkan keamanan.  Sekarang setiap pengguna yang tidak sah dapat mengelola cluster melalui UI Web.  Setuju, sepertinya begitu-begitu. </p><br><p>  Cartridge menyediakan kemampuan untuk menghubungkan modul otorisasi Anda sendiri, seperti LDAP (atau apa pun yang Anda miliki di sana), dan menggunakannya untuk mengelola pengguna dan akses mereka ke aplikasi.  Tetapi kami akan menggunakan modul otorisasi bawaan, yang digunakan Cartridge secara default.  Modul ini memungkinkan Anda untuk melakukan operasi dasar dengan pengguna (menghapus, menambah, mengedit) dan mengimplementasikan fungsi verifikasi kata sandi. <br>  Harap perhatikan bahwa peran kami yang memungkinkan membutuhkan backend otorisasi untuk mengimplementasikan semua fungsi ini. </p><br><p>  Jadi, kami beralih dari teori ke praktik.  Pertama, buat otorisasi wajib, atur parameter sesi dan tambahkan pengguna baru: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... # authorization cartridge_auth: # &lt;== enabled: true # enable authorization cookie_max_age: 1000 cookie_renew_age: 100 users: # cartridge users to set up - username: dokshina password: cartridge-rullez fullname: Elizaveta Dokshina email: dokshina@example.com # deleted: true # uncomment to delete user ...</code> </pre> <br><p>  Manajemen otorisasi dilakukan sebagai bagian dari tugas <code>cartridge-config</code> , kami menunjukkan tag ini: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-config</code> </pre> <br><p>  Di <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard</a> kejutan menanti kami: </p><br><p><img src="https://habrastorage.org/webt/a2/t8/pq/a2t8pqil4sxnosey38i-baf3q1k.png"></p><br><p>  Anda dapat masuk dengan <code>username</code> dan <code>password</code> pengguna baru kami atau masuk sebagai <code>admin</code> - pengguna default.  Kata sandinya adalah cookie klaster, kami menetapkan nilai ini dalam variabel <code>cartridge_cluster_cookie</code> (ini adalah <code>app-default-cookie</code> , Anda tidak dapat mengintip). </p><br><p>  Setelah berhasil masuk, buka tab <code>Users</code> untuk memastikan semuanya berjalan dengan baik: </p><br><p><img src="https://habrastorage.org/webt/af/h_/9o/afh_9ofcv7htwplfgomnxejosxo.png"></p><br><p>  Lakukan percobaan dengan menambahkan pengguna baru dan mengubah pengaturan mereka.  Untuk menghapus pengguna, tentukan tanda yang <code>deleted: true</code> untuknya.  Nilai <code>email</code> dan nama <code>fullname</code> tidak digunakan oleh Cartridge dengan cara apa pun, tetapi Anda dapat menentukannya untuk kenyamanan. </p><br><h2 id="konfiguraciya-prilozheniya">  Konfigurasi aplikasi </h2><br><p>  Mari kita ingat bagaimana semuanya dimulai. </p><br><p>  Kami telah menggunakan aplikasi kecil yang menyimpan data tentang pelanggan dan rekening bank mereka.  Seperti yang Anda ingat, aplikasi ini memiliki 2 peran: <code>api</code> dan <code>storage</code> .  Peran <code>storage</code> menangani penyimpanan data dan mengimplementasikan sharding menggunakan peran <code>vshard-storage</code> .  Peran kedua, <code>api</code> , mengimplementasikan server HTTP dengan API untuk manajemen data, ditambah di dalamnya terhubung peran standar lain, <code>vshard-router</code> , yang mengontrol sharding. </p><br><p>  Jadi, kami membuat permintaan pertama ke API aplikasi.  Tambahkan klien baru: </p><br><pre> <code class="bash hljs">$ curl -X POST -H <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> \ -d <span class="hljs-string"><span class="hljs-string">'{"customer_id":1, "name":"Elizaveta", "accounts":[{"account_id": 1}]}'</span></span> \ http://localhost:8182/storage/customers/create</code> </pre> <br><p>  Sebagai tanggapan, kami mendapatkan sesuatu seperti ini: </p><br><pre> <code class="bash hljs">{<span class="hljs-string"><span class="hljs-string">"info"</span></span>:<span class="hljs-string"><span class="hljs-string">"Successfully created"</span></span>}</code> </pre> <br><p>  Harap perhatikan bahwa di URL kami menentukan instance port <code>app-1</code> , <code>8082</code> , karena mengimplementasikan API ini. </p><br><p>  Sekarang mari kita perbarui saldo pengguna baru kami: </p><br><pre> <code class="bash hljs">$ curl -X POST -H <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> \ -d <span class="hljs-string"><span class="hljs-string">"{\"account_id\": 1, \"amount\": \"1000\"}"</span></span> \ http://localhost:8182/storage/customers/1/update_balance</code> </pre> <br><p>  Dalam respons, kami melihat saldo yang diperbarui: </p><br><pre> <code class="bash hljs">{<span class="hljs-string"><span class="hljs-string">"balance"</span></span>:<span class="hljs-string"><span class="hljs-string">"1000.00"</span></span>}</code> </pre> <br><p>  Hebat, semuanya bekerja!  API diterapkan, Cartridge terlibat dalam data sharding, kami telah menetapkan prioritas failover untuk kasus darurat dan bahkan otorisasi yang diaktifkan.  Saatnya untuk mengkonfigurasi aplikasi. </p><br><p>  Konfigurasi cluster saat ini disimpan dalam file konfigurasi terdistribusi.  Setiap instance menyimpan salinan file ini, dan Cartridge memastikan sinkronisasi di antara semua node cluster.  Kita dapat menentukan konfigurasi peran aplikasi kita dalam file ini, dan Cartridge akan mengurus distribusi konfigurasi baru di semua contoh. </p><br><p>  Mari kita lihat isi file ini saat ini.  Buka tab <code>Cofiguration files</code> dan klik tombol <code>Download</code> : </p><br><p><img src="https://habrastorage.org/webt/wx/xw/vc/wxxwvcdusefetrgyaxpnnrvxwya.png"></p><br><p>  Di <code>config.yml</code> config.yml yang diunduh <code>config.yml</code> kami menemukan tabel kosong.  Tidak heran, karena kami belum menentukan parameter apa pun: </p><br><pre> <code class="plaintext hljs">--- [] ...</code> </pre> <br><p>  Bahkan, file konfigurasi cluster kami tidak kosong, itu menyimpan topologi saat ini, pengaturan otorisasi, dan pengaturan sharding.  Tapi Cartridge tidak akan begitu mudah untuk membagikan informasi ini, itu dimaksudkan untuk penggunaan internal, dan karena itu disimpan di bagian sistem tersembunyi, yang tidak dapat kita edit. </p><br><p>  Setiap peran aplikasi dapat menggunakan satu atau beberapa bagian konfigurasi.  Konfigurasi baru dimuat dalam dua tahap: pertama, semua peran memverifikasi bahwa mereka siap menerima parameter baru.  Jika tidak ada keberatan, maka perubahan diterapkan, jika seseorang menentang, maka kemunduran terjadi. </p><br><p>  Mari kita kembali ke aplikasi kita.  Peran <code>api</code> menggunakan bagian <code>max-balance</code> , di mana saldo maksimum yang diijinkan disimpan pada satu akun klien.  Mari kita mengkonfigurasi bagian ini, tetapi, tentu saja, tidak secara manual, tetapi menggunakan peran Ansible kami. </p><br><p>  Jadi, sekarang konfigurasi aplikasi (atau lebih tepatnya, sebagian dari itu tersedia untuk kita) adalah tabel kosong.  Tambahkan bagian <code>max-balance</code> dengan nilai <code>100000</code> .  Kami menulis variabel <code>cartridge_app_config</code> ke file inventaris kami: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... # cluster-wide config cartridge_app_config: # &lt;== max-balance: # section name body: 1000000 # section body # deleted: true # uncomment to delete section max-balance ...</code> </pre> <br><p>  Kami menentukan nama bagian, <code>max-balance</code> , dan kontennya, isi.  Isi suatu bagian tidak hanya berupa angka, tetapi juga bisa berupa tabel atau baris tergantung pada bagaimana peran itu ditulis dan jenis nilai apa yang ingin Anda gunakan. </p><br><p>  Kami meluncurkan: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-config</code> </pre> <br><p>  Dan kami memeriksa bahwa saldo maksimum yang diijinkan telah benar-benar berubah: </p><br><pre> <code class="bash hljs">$ curl -X POST -H <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> \ -d <span class="hljs-string"><span class="hljs-string">"{\"account_id\": 1, \"amount\": \"1000001\"}"</span></span> \ http://localhost:8182/storage/customers/1/update_balance</code> </pre> <br><p>  Sebagai tanggapan, kami mendapatkan kesalahan, seperti yang kami inginkan: </p><br><pre> <code class="bash hljs">{<span class="hljs-string"><span class="hljs-string">"info"</span></span>:<span class="hljs-string"><span class="hljs-string">"Error"</span></span>,<span class="hljs-string"><span class="hljs-string">"error"</span></span>:<span class="hljs-string"><span class="hljs-string">"Maximum is 1000000"</span></span>}</code> </pre> <br><p>  Anda dapat mengunduh ulang file konfigurasi pada tab <code>Configuraion files</code> untuk memastikan bahwa bagian baru muncul di sana: </p><br><pre> <code class="plaintext hljs">--- max-balance: 1000000 ...</code> </pre> <br><p>  Coba tambahkan bagian baru ke konfigurasi aplikasi, ubah isinya atau hapus seluruhnya (untuk ini Anda perlu mengatur flag yang <code>deleted: true</code> di bagian). </p><br><p>  Anda dapat mengetahui cara menggunakan konfigurasi terdistribusi dalam peran dalam <a href="https://www.tarantool.io/ru/rocks/cartridge/1.0/modules/cartridge.clusterwide-config/">dokumentasi</a> Tarantool Cartridge. </p><br><p>  Ingatlah untuk memanggil <code>vagrant halt</code> untuk menghentikan <code>vagrant halt</code> ketika Anda selesai bekerja dengan mereka. </p><br><h2 id="v-zaklyuchenie">  Kesimpulannya </h2><br><p>  Terakhir kali, kami mempelajari cara menggunakan aplikasi Tarantool Cartridge terdistribusi menggunakan peran Ansible khusus.  Hari ini kami memperbarui aplikasi, dan juga menguasai manajemen topologi, sharding, otorisasi, dan konfigurasi aplikasi. </p><br><p>  Jangan berhenti di situ, pelajari <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html">berbagai pendekatan</a> untuk menulis buku pedoman yang dimungkinkan dan gunakan aplikasi Anda dengan kenyamanan maksimal. </p><br><p>  Jika sesuatu tidak berhasil untuk Anda atau jika Anda memiliki ide tentang cara meningkatkan peran yang memungkinkan kami, silakan mulai <a href="https://github.com/tarantool/ansible-cartridge/issues/new">tiket</a> .  Kami akan selalu membantu dengan solusi masalah Anda dan kami akan dengan senang hati menawarkan penawaran menarik! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id484192/">https://habr.com/ru/post/id484192/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id484178/index.html">Saklar Ethernet Cerdas untuk Planet Bumi</a></li>
<li><a href="../id484180/index.html">Rostelecom virtual PBX: apa dan bagaimana bisa dilakukan melalui API</a></li>
<li><a href="../id484182/index.html">Xenobots: nanorobots hidup dari sel katak</a></li>
<li><a href="../id484186/index.html">LDAP - "otentikasi" adalah antipattern</a></li>
<li><a href="../id484188/index.html">Standar Desain Basis Data</a></li>
<li><a href="../id484194/index.html">Kubernet diterjemahkan menjadi anak-anak</a></li>
<li><a href="../id484196/index.html">Merekam suara JS dari mikrofon atau komentar suara</a></li>
<li><a href="../id484198/index.html">Sisi sebaliknya dari koin: siapa yang menang dan kalah pada pertumbuhan saham Tesla</a></li>
<li><a href="../id484200/index.html">Cara menetapkan tujuan untuk mencapainya</a></li>
<li><a href="../id484202/index.html">Pembelajaran Mesin dalam Analisis Statis Kode Sumber Program</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>