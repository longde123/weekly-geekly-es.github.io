<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêú üè¢ üò∂ C√≥mo pusimos la gesti√≥n de la infraestructura en Terraform y comenzamos a vivir üïë üë©üèº‚Äçü§ù‚Äçüë®üèΩ ‚ú®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ten√≠amos 4 cuentas de Amazon, 9 VPC y 30 entornos de desarrollo, etapas y regresiones m√°s potentes, en total m√°s de 1000 instancias EC2 de todos los c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo pusimos la gesti√≥n de la infraestructura en Terraform y comenzamos a vivir</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dins/blog/470543/"><img src="https://habrastorage.org/webt/os/gu/yk/osguyk_s9ckyitafq3rayiqhxw0.png" alt="imagen"><br>  Ten√≠amos 4 cuentas de Amazon, 9 VPC y 30 entornos de desarrollo, etapas y regresiones m√°s potentes, en total m√°s de 1000 instancias EC2 de todos los colores y sombras.  Desde que comenc√© a recopilar soluciones en la nube para empresas, necesito ir a mi hobby hasta el final y pensar en c√≥mo automatizar todo esto. <br><br>  Hola  Mi nombre es Kirill Kazarin, trabajo como ingeniero en DINS.  Estamos desarrollando soluciones de comunicaciones empresariales basadas en la nube.  En nuestro trabajo, utilizamos activamente Terraform, con el que gestionamos de manera flexible nuestra infraestructura.  Compartir√© mi experiencia con esta soluci√≥n. <br><br>  El art√≠culo es largo, ¬°as√≠ que abastecerse de t√© de <s>palomitas</s> de <s>ma√≠z</s> y listo! <br><br>  Y un matiz m√°s: el art√≠culo fue escrito sobre la base de la versi√≥n 0.11, en la versi√≥n 0.12 mucho ha cambiado, pero las principales pr√°cticas y consejos siguen siendo relevantes.  ¬°El tema de la migraci√≥n de 0.11 a 0.12 merece un art√≠culo separado! <br><a name="habracut"></a><br><h3>  ¬øQu√© es Terraform? </h3><br>  <b>Terraform</b> es una herramienta popular de Hashicorp que apareci√≥ en 2014. <br><br>  Esta utilidad le permite administrar su infraestructura de nube en la <i>infraestructura como un</i> paradigma de <i>c√≥digo</i> en un lenguaje declarativo muy amigable y f√°cil de leer.  Su aplicaci√≥n le proporciona un tipo unificado de recursos y aplicaci√≥n de pr√°cticas de c√≥digo para la gesti√≥n de la infraestructura, desarrolladas durante mucho tiempo por la comunidad de desarrolladores.  Terraform es compatible con todas las plataformas modernas en la nube, le permite cambiar de manera segura y previsible la infraestructura. <br><br>  Cuando se inicia, Terraform lee el c√≥digo y, utilizando los complementos proporcionados por los proveedores de servicios en la nube, lleva su infraestructura al estado descrito haciendo las llamadas API necesarias. <br><br>  Nuestro proyecto est√° ubicado completamente en Amazon, implementado sobre la base de los servicios de AWS, y por lo tanto escribo sobre el uso de Terraform en esta l√≠nea.  Por separado, observo que se puede usar no solo para Amazon.  Le permite administrar todo lo que tiene una API. <br><br>  Adem√°s, gestionamos la configuraci√≥n de VPC, las pol√≠ticas de IAM y los roles.  Gestionamos tablas de enrutamiento, certificados, ACL de red.  Gestionamos la configuraci√≥n de nuestro firewall de aplicaciones web, S3-bucket, colas SQS, todo lo que nuestro servicio puede usar en Amazon.  Todav√≠a no he visto caracter√≠sticas con Amazon que Terraform no podr√≠a describir en t√©rminos de infraestructura. <br><br>  Resulta una infraestructura bastante grande, con sus manos es f√°cil de soportar.  Pero con Terraform es conveniente y simple. <br><br><h3>  De qu√© est√° hecho Terraform </h3><br>  <b>Los proveedores</b> son complementos para trabajar con la API de un servicio.  Los cont√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">m√°s de 100</a> .  Entre ellos se encuentran proveedores para Amazon, Google, DigitalOcean, VMware Vsphere, Docker.  ¬°Incluso encontr√© un proveedor en esta lista oficial que le permite <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">administrar las reglas para Cisco ASA</a> ! <br><br>  Entre otras cosas, puedes controlar: <br><br><ul><li>  Cuadros de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">mando, fuente de</a> datos y alertas en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Grafana</a> . </li><li>  Proyectos en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GitHub</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GitLab</a> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">RabbitMQ</a> . </li><li>  Bases de datos, usuarios y derechos en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">MySQL</a> . </li></ul><br>  Y estos son solo proveedores oficiales, hay a√∫n m√°s proveedores no oficiales.  Durante los experimentos, me encontr√© en GitHub con un tercero, no incluido en el proveedor de la lista oficial, que me <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">permiti√≥ trabajar con DNS de GoDaddy</a> , as√≠ como con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">recursos de Proxmox</a> . <br><br>  Dentro de un proyecto de Terraform, puede usar diferentes proveedores y, en consecuencia, los recursos de diferentes proveedores de servicios o tecnolog√≠as.  Por ejemplo, puede administrar su infraestructura en AWS, con DNS externo de GoDaddy.  Y ma√±ana, su empresa compr√≥ una startup que estaba alojada en DO o Azure.  Y si bien decide migrar esto a AWS o no, ¬°tambi√©n puede admitir esto con la misma herramienta! <br><br>  <b>Recursos.</b>  Estas son entidades de nube que puede crear usando Terraform.  Su lista, sintaxis y propiedades dependen del proveedor utilizado, de hecho, de la nube utilizada.  O no solo nubes. <br><br>  <b>M√≥dulos</b>  Estas son las entidades con las que Terraform le permite modelar su configuraci√≥n.  Por lo tanto, las plantillas le permiten hacer su c√≥digo m√°s peque√±o, le permiten reutilizarlo.  Bueno, ayudan a trabajar c√≥modamente con √©l. <br><br><h3>  Por qu√© elegimos Terraform </h3><br>  Para nosotros, identificamos 5 razones principales.  Quiz√°s desde su punto de vista, no todos parecer√°n significativos: <br><br><ul><li>  <b>Terraform es una utilidad de soporte de m√∫ltiples nubes de <s>Cloud Agnostic</s> (gracias por el valioso comentario en los comentarios)</b> .  Cuando seleccionamos esta herramienta, pensamos: - ¬øQu√© suceder√° si la administraci√≥n nos llega ma√±ana o dentro de una semana y dice: " <i>Chicos, y pensamos? No solo desplieguemos en Amazon. Tenemos alg√∫n tipo de proyecto, donde necesitaremos obtener la infraestructura en Google Cloud. O en Azure, bueno, nunca se sabe</i> ".  Decidimos que nos gustar√≠a tener una herramienta que no est√© r√≠gidamente vinculada a ning√∫n servicio en la nube. </li><li>  <b>C√≥digo abierto</b>  Terraform es una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">soluci√≥n de c√≥digo abierto</a> .  El repositorio del proyecto tiene una calificaci√≥n de m√°s de 16 mil estrellas, esta es una buena confirmaci√≥n de la reputaci√≥n del proyecto. <br><br>  Hemos encontrado m√°s de una o dos veces el hecho de que en algunas versiones hay errores o un comportamiento no entendible.  Tener un repositorio abierto le permite asegurarse de que esto sea realmente un error, y podemos resolver el problema simplemente actualizando el motor o la versi√≥n del complemento.  O que esto es un error, pero "Chicos, esperen, literalmente dos d√≠as despu√©s se lanzar√° una nueva versi√≥n y la arreglaremos".  O: "S√≠, esto es algo incomprensible, extra√±o, lo solucionan, pero hay una soluci√≥n".  Es muy conveniente. </li><li>  <b>Control</b> .  Terraform como una utilidad est√° completamente bajo su control.  Se puede instalar en una computadora port√°til, en un servidor, se puede integrar f√°cilmente en su tuber√≠a, lo que se puede hacer sobre la base de cualquier herramienta.  Por ejemplo, lo usamos en GitLab CI. </li><li>  <b>Comprobaci√≥n del estado de la infraestructura</b> .  Terraform puede y hace un buen control del estado de su infraestructura. <br><br>  Suponga que comenz√≥ a usar Terraform en su equipo.  Cree una descripci√≥n de alg√∫n recurso en Amazon, por ejemplo, Grupo de seguridad, apl√≠quelo: est√° creado para usted, todo est√° bien.  Y aqu√≠, ¬°bam!  Su colega, que regres√≥ ayer de vacaciones y a√∫n no sabe que ha organizado todo tan bien aqu√≠, o incluso un colega de otro departamento entra y cambia la configuraci√≥n de este grupo de seguridad a mano. <br><br>  Y sin reunirse con √©l, sin hablar, o sin asumir m√°s adelante cierto problema, nunca lo sabr√° en una situaci√≥n normal.  Pero, si usa Terraform, incluso ejecutar un plan inactivo en este recurso le mostrar√° que hay cambios en el entorno de trabajo. <br><br>  Cuando Terraform mira su c√≥digo, simult√°neamente llama a la API del proveedor de la nube, recibe el estado de los objetos y compara: "Y ahora hay lo mismo que hice antes, ¬øqu√© recuerdo?"  Luego lo compara con el c√≥digo, mira qu√© m√°s necesita ser cambiado.  Y, por ejemplo, si todo es igual en su historia, en su memoria y en su c√≥digo, pero hay cambios all√≠, √©l lo mostrar√° y ofrecer√° revertirlo.  En mi opini√≥n, tambi√©n es una muy buena propiedad.  Por lo tanto, este es otro paso, personalmente para nosotros, para garantizar que tenemos una infraestructura inmutable. </li><li>  Otra caracter√≠stica muy importante son <b>los m√≥dulos</b> que mencion√©, y cuenta.  Hablar√© de esto un poco m√°s tarde.  Cuando voy a comparar con las herramientas. </li></ul><br>  Y tambi√©n una guinda al pastel: Terraform tiene una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">lista bastante grande de funciones integradas</a> .  Estas funciones, a pesar del lenguaje declarativo, nos permiten implementar algunas, por no decir program√°ticas, sino l√≥gicas. <br><br>  Por ejemplo, algunos c√°lculos autom√°ticos, l√≠neas divididas, conversi√≥n a may√∫sculas y min√∫sculas, eliminaci√≥n de caracteres de esta l√≠nea.  Lo estamos usando bastante activamente.  Hacen la vida mucho m√°s f√°cil, especialmente cuando escribes un m√≥dulo que luego se reutilizar√° en diferentes entornos. <br><br><h3>  Terraform vs CloudFormation </h3><br>  La red a menudo compara Terraform con CloudFormation.  Tambi√©n hicimos esta pregunta al elegirla.  Y aqu√≠ est√° el resultado de nuestra comparaci√≥n. <br><br><div class="scrollable-table"><table><tbody><tr><th>  Comparaci√≥n </th><th>  Terraforma </th><th>  Formaci√≥n en la nube </th></tr><tr><td>  Soporte en la nube m√∫ltiple </td><td>  Mediante el uso de varios proveedores, los complementos pueden funcionar con cualquier proveedor de nube grande. <br></td><td>  Firmemente unido a Amazon. </td></tr><tr><td>  Seguimiento de cambios </td><td>  Si tienes un cambio <br>  no en el c√≥digo TF, sino en el recurso que cre√≥, TF podr√° detectar esto y le permitir√° corregir la situaci√≥n <br></td><td>  Funci√≥n similar apareci√≥ <br>  solo en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">noviembre de 2018</a> . <br></td></tr><tr><td>  Condiciones </td><td>  No hay soporte para condiciones (solo <br>  en forma de operadores ternarios). </td><td>  Las condiciones son compatibles. </td></tr><tr><td>  Almacenamiento <br>  estados </td><td>  Le permite seleccionar varios tipos de backend, por ejemplo, localmente <br>  en su m√°quina (este es el comportamiento predeterminado), en un recurso compartido de archivos, <br>  en S3 y en otros lugares. <br><br>  Esto a veces es √∫til porque tfstate Terraform se presenta como un archivo de texto grande con una estructura similar a JSON.  Y a veces es √∫til entrar, leerlo, y al menos poder hacer una copia de seguridad, porque nunca se sabe qu√©.  Personalmente, por ejemplo, estoy m√°s tranquilo por el hecho de que esto est√° en alg√∫n lugar controlado por m√≠. <br></td><td>  Almacenamiento de estado solo en alg√∫n lugar dentro de AWS </td></tr><tr><td>  Importaci√≥n de recursos </td><td>  Terraform facilita la importaci√≥n de recursos.  Puede tomar todos los recursos bajo su control.  Simplemente escriba el c√≥digo que caracterizar√° este objeto, o use <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Terraforming</a> . <br>  Ella va a la misma Amazon√≠a, toma informaci√≥n sobre el medio ambiente desde all√≠ y luego la descarga en forma de c√≥digo. <br>  Es generado por la m√°quina, no est√° optimizado, pero este es un buen primer paso para comenzar la migraci√≥n.  Y luego solo le das el comando de importaci√≥n.  Terraform compara, trae este entorno a su estado, y ahora lo controla. <br></td><td>  CloudFormation no sabe c√≥mo.  Si <br>  has hecho algo antes con tus manos, lo golpeas y lo recreas usando CloudFormation, o sigues vivo.  Lamentablemente, no hay opciones. </td></tr></tbody></table></div><br><h3>  C√≥mo comenzar con Terraform </h3><br>  En t√©rminos generales, comenzar es bastante simple.  Aqu√≠ est√°n los primeros pasos brevemente: <br><br><ol><li>  En primer lugar, cree un repositorio Git e inmediatamente comience a almacenar todos sus cambios, experimentos y todo. </li><li>  Lea la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">gu√≠a de inicio</a> .  Es peque√±o, simple, bastante detallado y describe bien c√≥mo comenzar con esta utilidad. </li><li>  Escriba alguna demostraci√≥n, c√≥digo de trabajo.  Incluso puedes copiar alg√∫n tipo de ejemplo para jugar m√°s tarde. </li></ol><br><h3>  Nuestra pr√°ctica con Terraform </h3><br><h4>  C√≥digo fuente </h4><br>  Comenz√≥ su primer proyecto y guard√≥ todo en un gran archivo main.tf.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Aqu√≠ hay un ejemplo t√≠pico</a> (honestamente tom√© el primero que obtuve de GitHub). <br><br>  No pasa nada, pero el tama√±o de la base del c√≥digo tiende a crecer con el tiempo.  Las dependencias entre los recursos tambi√©n est√°n creciendo.  Despu√©s de un tiempo, el archivo se vuelve enorme, complejo, ilegible, mal mantenido, y un cambio descuidado en un lugar puede causar problemas. <br><br>  Lo primero que recomiendo es resaltar el llamado repositorio central, o estado central de su proyecto, su entorno.  Tan pronto como comience a crear una infraestructura usando Terraform, o import√°ndola, inmediatamente se dar√° cuenta de que tiene algunas entidades que, una vez implementadas, configuradas, rara vez cambian.  Por ejemplo, estas son configuraciones de VPC, o VPC en s√≠.  Estas son redes, grupos de seguridad b√°sicos y generales, como el acceso SSH: puede compilar una lista bastante grande. <br><br>  No tiene sentido mantener esto en el mismo repositorio que los servicios que cambia con frecuencia.  Selecci√≥nelos en un repositorio separado y con√©ctelos a trav√©s de una funci√≥n Terraform, como el estado remoto. <br><br><ul><li>  Est√° reduciendo la base de c√≥digo de esa parte del proyecto con la que a menudo trabaja directamente. </li><li>  En lugar de un gran archivo tfstate que contiene una descripci√≥n del estado de su infraestructura, dos archivos m√°s peque√±os y, en un momento determinado, est√° trabajando con uno de ellos. </li></ul><br>  Cual es el truco  Cuando Terraform hace un plan, es decir, calcula, calcula lo que deber√≠a cambiar, aplica: relata completamente este estado, verifica el c√≥digo, verifica el estado en AWS.  Cuanto m√°s grande sea su estado, m√°s tiempo llevar√° el plan. <br><br>  Llegamos a esta pr√°ctica cuando nos llev√≥ 20 minutos elaborar un plan para todo el entorno en producci√≥n.  Debido al hecho de que incluimos en un n√∫cleo separado todo lo que no estamos sujetos a cambios frecuentes, redujimos el tiempo para construir un plan a la mitad.  Tenemos una idea de c√≥mo puede reducirse a√∫n m√°s, desglos√°ndose no solo en n√∫cleo y no n√∫cleo, sino tambi√©n por subsistemas, porque los tenemos conectados y generalmente cambiamos juntos.  Por lo tanto, decimos que convertiremos 10 minutos en 3. Pero todav√≠a estamos en el proceso de implementar tal soluci√≥n. <br><br><h4>  Menos c√≥digo - m√°s f√°cil de leer </h4><br>  El c√≥digo peque√±o es m√°s f√°cil de entender y m√°s conveniente para trabajar.  Si tiene un equipo grande y tiene personas con diferentes niveles de experiencia, saque lo que rara vez cambia, pero a nivel mundial, en un nabo separado y br√≠ndele un acceso m√°s estrecho. <br><br>  Supongamos que tiene juniors en su equipo y no les da acceso al repositorio global que describe la configuraci√≥n de VPC, de esta manera se asegura contra errores.  Si un ingeniero comete un error al escribir la instancia, y algo se crea mal, no da miedo.  Y si comete un error en las opciones que est√°n instaladas en todas las m√°quinas, se rompe o hace algo con la configuraci√≥n de las subredes, con el enrutamiento, esto es mucho m√°s doloroso. <br><br>  La selecci√≥n del repositorio principal se realiza en varios pasos. <br><br>  <b>Etapa 1</b>  Crea un repositorio separado.  Almacene todo el c√≥digo en √©l, por separado, y describa aquellas entidades que deber√≠an reutilizarse en un repositorio de terceros utilizando esta salida.  Supongamos que creamos un recurso de subred de AWS en el que describimos d√≥nde se encuentra, qu√© zona de disponibilidad, espacio de direcciones. <br><br><pre><code class="go hljs">resource <span class="hljs-string"><span class="hljs-string">"aws_subnet"</span></span> <span class="hljs-string"><span class="hljs-string">"lab_pub1a"</span></span> { vpc_id = <span class="hljs-string"><span class="hljs-string">"${aws_vpc.lab.id}"</span></span> cidr_block = <span class="hljs-string"><span class="hljs-string">"10.10.10.0/24"</span></span> Availability_zone = <span class="hljs-string"><span class="hljs-string">"us-east-1a"</span></span> ... } output <span class="hljs-string"><span class="hljs-string">"sn_lab_pub1a-id"</span></span> { value = <span class="hljs-string"><span class="hljs-string">"${aws_subnet.lab_pub1a.id}"</span></span> }</code> </pre> <br>  Y luego decimos que enviamos la identificaci√≥n de este objeto a la salida.  Puede hacer la salida para cada par√°metro que necesite. <br><br>  ¬øCu√°l es el truco aqu√≠?  Cuando describe un valor, Terraform lo guarda por separado en tfstate core.  Y cuando recurras a √©l, no necesitar√° sincronizar, contar: podr√° darte este asunto inmediatamente desde este estado.  Adem√°s, en el repositorio, que no es n√∫cleo, usted describe dicha conexi√≥n con el estado remoto: tiene un estado remoto tal y tal, se encuentra en el cubo S3 tal y tal, tal y tal clave y regi√≥n. <br><br>  <b>Etapa 2</b>  En un proyecto no b√°sico, creamos un enlace al estado del proyecto principal, para que podamos referirnos a los par√°metros exportados a trav√©s de la salida. <br><br><pre> <code class="go hljs">data <span class="hljs-string"><span class="hljs-string">"terraform_remote_state"</span></span> <span class="hljs-string"><span class="hljs-string">"lab_core"</span></span> { backend = <span class="hljs-string"><span class="hljs-string">"s3"</span></span> config { bucket = <span class="hljs-string"><span class="hljs-string">"lab-core-terraform-state"</span></span> key = <span class="hljs-string"><span class="hljs-string">"terraform.tfstate"</span></span> region = <span class="hljs-string"><span class="hljs-string">"us-east-1"</span></span> } }</code> </pre><br>  <b>Etapa 3</b>  Empezando  Cuando necesito implementar una nueva interfaz de red para una instancia en una subred espec√≠fica, digo: aqu√≠ est√° el estado remoto de datos, encuentre el nombre de este estado en √©l, encuentre este par√°metro en √©l, que, de hecho, coincide con este nombre. <br><br><pre> <code class="go hljs">resource <span class="hljs-string"><span class="hljs-string">"aws_network_interface"</span></span> <span class="hljs-string"><span class="hljs-string">"fwl01"</span></span> { ... subnet_id = <span class="hljs-string"><span class="hljs-string">"${data.terraform_remote_state.lab_core.sn_lab_pub1a-id}"</span></span> }</code> </pre><br>  Y cuando construyo un plan de cambios en mi repositorio no central, este valor para Terraform se convertir√° en una constante para √©l.  Si desea cambiarlo, debe hacerlo en el repositorio de este, por supuesto, n√∫cleo.  Pero como esto rara vez cambia, no te molesta mucho. <br><br><h4>  M√≥dulos </h4><br>  Perm√≠tame recordarle que un m√≥dulo es una configuraci√≥n aut√≥noma que consta de uno o m√°s recursos relacionados.  Se gestiona como un grupo: <br><br>  Un m√≥dulo es algo extremadamente conveniente debido al hecho de que rara vez se crea un recurso as√≠, en el vac√≠o, generalmente est√° l√≥gicamente conectado con algo. <br><br><pre> <code class="go hljs">module <span class="hljs-string"><span class="hljs-string">"AAA"</span></span> { source = <span class="hljs-string"><span class="hljs-string">"..."</span></span> count = <span class="hljs-string"><span class="hljs-string">"3"</span></span> count_offset = <span class="hljs-string"><span class="hljs-string">"0"</span></span> host_name_prefix = <span class="hljs-string"><span class="hljs-string">"XXX-YYY-AAA"</span></span> ami_id = <span class="hljs-string"><span class="hljs-string">"${data.terraform_remote_state.lab_core.ami-base-ami_XXXX-id}"</span></span> subnet_ids = [<span class="hljs-string"><span class="hljs-string">"${data.terraform_remote_state.lab_core.sn_lab_pub1a-id}"</span></span>, <span class="hljs-string"><span class="hljs-string">"${data.terraform_remote_state.lab_core.sn_lab_pub1b-id}"</span></span>] instance_type = <span class="hljs-string"><span class="hljs-string">"t2.large"</span></span> sgs_ids = [ <span class="hljs-string"><span class="hljs-string">"${data.terraform_remote_state.lab_core.sg_ssh_lab-id}"</span></span>, <span class="hljs-string"><span class="hljs-string">"${aws_security_group.XXX_lab.id}"</span></span> ] boot_device = {volume_size = <span class="hljs-string"><span class="hljs-string">"50"</span></span> volume_type = <span class="hljs-string"><span class="hljs-string">"gp2"</span></span>} root_device = {device_name = <span class="hljs-string"><span class="hljs-string">"/dev/sdb"</span></span> volume_size = <span class="hljs-string"><span class="hljs-string">"50"</span></span> volume_type = <span class="hljs-string"><span class="hljs-string">"gp2"</span></span> encrypted = <span class="hljs-string"><span class="hljs-string">"true"</span></span>} tags = <span class="hljs-string"><span class="hljs-string">"${var.gas_tags}"</span></span> }</code> </pre><br>  Por ejemplo: cuando implementamos una nueva instancia de EC2, creamos una interfaz de red y datos adjuntos, a menudo creamos una direcci√≥n IP el√°stica, creamos el registro de la ruta 53 y algo m√°s.  Es decir, obtenemos al menos 4 entidades. <br><br>  Cada vez, describirlos en cuatro partes de c√≥digo es inconveniente.  Adem√°s, son bastante t√≠picos.  Suplica: haga una plantilla y luego simplemente refi√©rase a esta plantilla, pas√°ndole par√°metros: alg√∫n nombre, en qu√© cuadr√≠cula para empujar, qu√© grupo de seguridad colgar en ella.  Es muy conveniente. <br><br>  Terraform tiene una funci√≥n de conteo, que le permite reducir a√∫n m√°s su estado.  Puede describir un gran paquete de instancias con una sola pieza de c√≥digo.  Digamos que necesito implementar 20 m√°quinas del mismo tipo.  No escribir√© 20 piezas de c√≥digo incluso desde una plantilla, escribir√© 1 pieza de c√≥digo, indicar√© Count y el n√∫mero que contiene, cu√°nto necesito hacer. <br><br>  Por ejemplo, hay algunos m√≥dulos que hacen referencia a una plantilla.  Solo paso par√°metros espec√≠ficos: ID de subred;  AMI para desplegar con;  tipo de instancia;  configuraci√≥n de grupo de seguridad;  cualquier otra cosa e indique cu√°ntas de estas cosas me van a hacer.  ¬°Genial, los tom√≥ y les dio la vuelta! <br><br>  Ma√±ana, los desarrolladores acuden a m√≠ y me dicen: "Escucha, queremos experimentar con la carga, por favor danos dos m√°s".  Lo que necesito hacer: cambio un d√≠gito a 5. La cantidad de c√≥digo permanece exactamente igual. <br><br>  Convencionalmente, los m√≥dulos se pueden dividir en dos tipos: recursos e infraestructura.  Desde el punto de vista del c√≥digo, no hay diferencia, sino m√°s bien los conceptos de nivel superior que el propio operador introduce. <br>  Los m√≥dulos de recursos proporcionan una colecci√≥n de recursos estandarizada y parametrizada, relacionada l√≥gicamente.  El ejemplo anterior es un m√≥dulo de recursos t√≠pico.  C√≥mo trabajar con ellos: <br><br><ul><li>  Indicamos la ruta al m√≥dulo, la fuente de su configuraci√≥n, a trav√©s de la directiva Source. </li><li>  Indicamos la versi√≥n, s√≠, y la operaci√≥n seg√∫n el principio de "√∫ltimo y mejor" no es la mejor opci√≥n aqu√≠.  ¬øNo incluye la √∫ltima versi√≥n de la biblioteca cada vez en su proyecto?  Pero m√°s sobre eso m√°s tarde. </li><li>  Le pasamos argumentos. </li></ul><br>  Estamos conectados a la versi√≥n del m√≥dulo, y solo tomamos el √∫ltimo: la infraestructura debe ser versionada (los recursos no pueden ser versionados, pero el c√≥digo s√≠).  Se puede crear un recurso eliminado o recreado.  Eso es todo!  Tambi√©n debemos saber claramente qu√© versi√≥n hemos creado para cada pieza de infraestructura. <br><br>  Los m√≥dulos de infraestructura son bastante simples.  Consisten en recursos e incluyen est√°ndares de la compa√±√≠a (por ejemplo, etiquetas, listas de valores est√°ndar, valores predeterminados aceptados, etc.). <br><br>  En cuanto a nuestro proyecto y nuestra experiencia, hemos pasado mucho tiempo y firmemente al uso de m√≥dulos de recursos para todo lo que es posible con un proceso de revisi√≥n y versiones muy estricto.  Y ahora estamos introduciendo activamente la pr√°ctica de m√≥dulos de infraestructura a nivel de laboratorio y puesta en escena. <br><br>  Recomendaciones para usar m√≥dulos <br><br><ol><li>  Si no puede escribir, pero usa los ya hechos, no escriba.  Especialmente si eres nuevo en esto.  Conf√≠e en los m√≥dulos ya preparados, o al menos vea c√≥mo se lo hicieron.  Sin embargo, si a√∫n necesita escribir la suya, no use la llamada a los proveedores internamente y tenga cuidado con los proveedores de servicios. </li><li>  Compruebe que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Terraform Registry</a> no contenga un m√≥dulo de recursos listo para usar. </li><li>  Si est√° escribiendo su m√≥dulo, oculte los detalles debajo del cap√≥.  El usuario final no tiene que preocuparse por qu√© y c√≥mo implementarlo internamente. </li><li>  Realice los par√°metros de entrada y los valores de salida de su m√≥dulo.  Y es mejor si son archivos separados.  Muy conveniente </li><li>  Si escribe sus m√≥dulos, gu√°rdelos en el repositorio y la versi√≥n.  Mejor un repositorio separado para el m√≥dulo. </li><li>  No utilice m√≥dulos locales, no est√°n versionados ni reutilizados. </li><li>  Evite usar descripciones de proveedores en el m√≥dulo, porque las credenciales de conexi√≥n se pueden configurar y aplicar de manera diferente para diferentes personas.  Alguien usa variables de entorno para esto, y alguien implica almacenar sus claves y secretos en archivos con rutas de prescripci√≥n para ellos.  Esto debe indicarse en un nivel superior. </li><li>  Use el aprovisionador local con cuidado.  Se ejecuta localmente, en la m√°quina en la que se ejecuta Terraform, pero el entorno de ejecuci√≥n para diferentes usuarios puede ser diferente.  Hasta que lo incruste en CI, puede encontrar varios artefactos: por ejemplo, ejecutivo local y ejecutando ansible.  Y alguien tiene una distribuci√≥n diferente, otro shell, una versi√≥n diferente de ansible, o incluso Windows. </li></ol><br>  Se√±ales de un buen m√≥dulo (aqu√≠ hay un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">poco m√°s detallado</a> ): <br><br><ul><li>  Los buenos m√≥dulos tienen documentaci√≥n y ejemplos.  Si cada uno est√° dise√±ado como un repositorio separado, esto es m√°s f√°cil de hacer. </li><li>  No tienen configuraciones codificadas (por ejemplo, regi√≥n de AWS). </li><li>  Utilice valores predeterminados razonables, dise√±ados como valores predeterminados.  Por ejemplo, el m√≥dulo para la instancia EC2 por defecto no crear√° una m√°quina virtual del tipo m5d.24xlarge para usted, utiliza uno de los tipos m√≠nimos t2 o t3 para esto. </li><li>  El c√≥digo es "limpio": estructurado, provisto de comentarios, no confundido innecesariamente, dise√±ado con el mismo estilo. </li><li>  Es altamente deseable que est√© equipado con pruebas, aunque es dif√≠cil.  Desafortunadamente, a√∫n no hemos llegado a esto. </li></ul><br><h4>  Etiquetado </h4><br>  Las etiquetas son importantes. <br><br>  Etiquetar es facturar.  AWS tiene herramientas que le permiten ver cu√°nto dinero gasta en su infraestructura.  Y nuestra gerencia realmente quer√≠a tener una herramienta en la que pudieran verla de manera determinista.  Por ejemplo, cu√°nto dinero consumen tales y tales componentes, o tal y tal subsistema, tal y tal equipo, tal y tal entorno <br><br><img src="https://habrastorage.org/webt/3q/mn/9e/3qmn9ej1ao0cmn8irggvgl8ztj4.png" alt="imagen"><br><br>  El etiquetado es la documentaci√≥n de su sistema.  Con ella, simplificas tu b√∫squeda.  Incluso solo en la consola de AWS, donde estas etiquetas se muestran claramente en su pantalla, le resulta m√°s f√°cil comprender a qu√© se refiere este o aquel tipo de instancia.  Si vienen nuevos colegas, es m√°s f√°cil para usted explicar esto mostrando: "Mira, aqu√≠ est√°".  Comenzamos a crear etiquetas de la siguiente manera: creamos una matriz de etiquetas para cada tipo de recurso. <br><br>  Un ejemplo: <br><br><pre> <code class="go hljs">variable <span class="hljs-string"><span class="hljs-string">"XXX_tags"</span></span> { description = <span class="hljs-string"><span class="hljs-string">"The set of XXX tags."</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> = <span class="hljs-string"><span class="hljs-string">"map"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> = { <span class="hljs-string"><span class="hljs-string">"TerminationDate"</span></span> = <span class="hljs-string"><span class="hljs-string">"03.23.2018"</span></span>, <span class="hljs-string"><span class="hljs-string">"Environment"</span></span> = <span class="hljs-string"><span class="hljs-string">"env_name_here"</span></span>, <span class="hljs-string"><span class="hljs-string">"Department"</span></span> = <span class="hljs-string"><span class="hljs-string">"dev"</span></span>, <span class="hljs-string"><span class="hljs-string">"Subsystem"</span></span> = <span class="hljs-string"><span class="hljs-string">"subsystem_name"</span></span>, <span class="hljs-string"><span class="hljs-string">"Component"</span></span> = <span class="hljs-string"><span class="hljs-string">"XXX"</span></span>, <span class="hljs-string"><span class="hljs-string">"Type"</span></span> = <span class="hljs-string"><span class="hljs-string">"application"</span></span>, <span class="hljs-string"><span class="hljs-string">"Team"</span></span> = <span class="hljs-string"><span class="hljs-string">"team_name"</span></span> } }</code> </pre><br>  Dio la casualidad de que en nuestra empresa m√°s de uno de nuestros equipos usa AWS, y hay una lista de etiquetas requeridas. <br><br><ol><li>  Equipo: qu√© equipo usa cu√°ntos recursos. </li><li>  Departamento: similar a un departamento. </li><li>  Entorno: los recursos funcionan en "entornos", pero usted, por ejemplo, puede reemplazarlo con un proyecto o algo as√≠. </li><li>  Subsistema: el subsistema al que pertenece el componente.  Los componentes pueden pertenecer a un subsistema.  Por ejemplo, queremos ver cu√°nto tenemos que este subsistema y sus entidades comenzaron a consumir.  De repente, por ejemplo, para el mes anterior, ha crecido significativamente.  Necesitamos ir a los desarrolladores y decirles: ‚ÄúChicos, es costoso.  El presupuesto ya est√° cerca el uno del otro, optimicemos la l√≥gica de alguna manera ". </li><li>  Tipo: tipo de componente: equilibrador, almacenamiento, aplicaci√≥n o base de datos. </li><li>  Componente: el componente en s√≠, su nombre en notaci√≥n interna. </li><li>  Fecha de finalizaci√≥n: hora en que debe eliminarse, en formato de fecha.  Si no se espera su eliminaci√≥n, config√∫relo como "Permanente".  Lo presentamos porque en entornos de desarrollo, e incluso en algunos entornos de etapa, tenemos una etapa de prueba de estr√©s que aumenta durante las sesiones de estr√©s, es decir, no mantenemos estas m√°quinas regularmente.  Indicamos la fecha en que el recurso debe ser destruido.  Adem√°s de esto, puede ajustar la automatizaci√≥n basada en lambda, algunos scripts externos que funcionan a trav√©s de la interfaz de l√≠nea de comandos de AWS, que destruir√° estos recursos autom√°ticamente. </li></ol><br>  Ahora, c√≥mo etiquetar. <br><br>  Decidimos que har√≠amos nuestro propio mapa de etiquetas para cada componente, en el que enumerar√≠amos todas las etiquetas especificadas: cu√°ndo terminarlo, a qu√© se refiere.  R√°pidamente se dieron cuenta de que era inconveniente.  Porque la base del c√≥digo est√° creciendo, porque tenemos m√°s de 30 componentes, y 30 de esos c√≥digos son inconvenientes.  Si necesitas cambiar algo, entonces corres y cambias. <br><br>  Para etiquetar bien, utilizamos la entidad <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Local</a> . <br><br><pre> <code class="go hljs">locals { common_tags = {<span class="hljs-string"><span class="hljs-string">"TerminationDate"</span></span> = <span class="hljs-string"><span class="hljs-string">"XX.XX.XXXX"</span></span>, <span class="hljs-string"><span class="hljs-string">"Environment"</span></span> = <span class="hljs-string"><span class="hljs-string">"env_name"</span></span>, <span class="hljs-string"><span class="hljs-string">"Department"</span></span> = <span class="hljs-string"><span class="hljs-string">"dev"</span></span>, <span class="hljs-string"><span class="hljs-string">"Team"</span></span> = <span class="hljs-string"><span class="hljs-string">"team_name"</span></span>} subsystem_1_tags = <span class="hljs-string"><span class="hljs-string">"${merge(local.common_tags, map("</span></span>Subsystem<span class="hljs-string"><span class="hljs-string">", "</span></span>subsystem_1_name<span class="hljs-string"><span class="hljs-string">"))}"</span></span> subsystem_2_tags = <span class="hljs-string"><span class="hljs-string">"${merge(local.common_tags, map("</span></span>Subsystem<span class="hljs-string"><span class="hljs-string">", "</span></span>subsystem_2_name<span class="hljs-string"><span class="hljs-string">"))}"</span></span> }</code> </pre><br>  En √©l puede enumerar un subconjunto y luego usarlos entre s√≠. <br><br>  Por ejemplo, eliminamos algunas etiquetas comunes en dicha estructura, y luego las espec√≠ficas por subsistemas.  Decimos: "Tome este bloque y agregue, por ejemplo, el subsistema 1. Y para el subsistema 2, agregue el subsistema 2".  Decimos: "Etiquetas, por favor, tome las generales y agregue tipo, aplicaci√≥n, nombre, componente y qui√©n es para ellos".  Resulta un cambio muy breve, claro y centralizado, si de repente se requiere. <br><br><pre> <code class="go hljs">module <span class="hljs-string"><span class="hljs-string">"ZZZ02"</span></span> { count = <span class="hljs-number"><span class="hljs-number">1</span></span> count_offset = <span class="hljs-number"><span class="hljs-number">1</span></span> name = <span class="hljs-string"><span class="hljs-string">"XXX-YYY-ZZZ"</span></span> ... tags = <span class="hljs-string"><span class="hljs-string">"${merge(local.core_tags, map("</span></span>Type<span class="hljs-string"><span class="hljs-string">", "</span></span>application<span class="hljs-string"><span class="hljs-string">", "</span></span>Component<span class="hljs-string"><span class="hljs-string">", "</span></span>XXX<span class="hljs-string"><span class="hljs-string">"))}"</span></span> }</code> </pre><br><img src="https://habrastorage.org/webt/ka/sq/4o/kasq4ocxxl3hht59z9p6o5bzjfs.png" alt="imagen"><br><br><h4>  Control de versiones </h4><br>  Sus m√≥dulos de plantilla, si los usa, deben almacenarse en alg√∫n lugar.  La forma m√°s sencilla de que todo el mundo comience es el almacenamiento local.  Justo en el mismo directorio, solo un subdirectorio en el que describe, por ejemplo, una plantilla para alg√∫n tipo de servicio.  Esta no es una buena manera.  Es conveniente, se puede arreglar y probar r√°pidamente, pero es dif√≠cil reutilizarlo m√°s tarde y controlarlo. <br><br><pre> <code class="go hljs">module <span class="hljs-string"><span class="hljs-string">"ZZZ02"</span></span> { source = <span class="hljs-string"><span class="hljs-string">"./modules/srvroles/ZZZ"</span></span> name = <span class="hljs-string"><span class="hljs-string">"XXX-YYY-ZZZ"</span></span> }</code> </pre><br>  Supongamos que los desarrolladores vinieron a usted y le dijeron: "Entonces, necesitamos tal o cual entidad en tal y tal configuraci√≥n, en nuestra infraestructura".  Lo escribiste, lo hiciste en forma de un m√≥dulo local en el repositorio de su proyecto.  Desplegado - excelente.  Lo probaron y dijeron: "¬°Lo har√°!  En producci√≥n ".  Llegamos al escenario, pruebas de estr√©s, producci√≥n.  Cada vez Ctrl-C, Ctrl-V;  Ctrl-C, Ctrl-V.  Mientras llegamos a la venta, nuestro colega lo tom√≥, copi√≥ el c√≥digo del entorno del laboratorio, lo transfiri√≥ a otro lugar y lo cambi√≥ all√≠.  Y obtenemos un estado ya inconsistente.  Con el escalado horizontal, cuando tiene tantos entornos de laboratorio como nosotros, es solo una sorpresa. <br><br>  Por lo tanto, una buena manera es crear un repositorio Git separado para cada uno de sus m√≥dulos, y luego simplemente consultarlo.  Cambiamos todo en un solo lugar: bueno, conveniente, controlado. <br><br><pre> <code class="go hljs">module <span class="hljs-string"><span class="hljs-string">"ZZZ"</span></span> { source = <span class="hljs-string"><span class="hljs-string">"git::ssh://git@GIT_SERVER_FQDN/terraform/modules/general-vm/2-disks.git"</span></span> host_name_prefix = <span class="hljs-string"><span class="hljs-string">"XXX-YYY-ZZZ"</span></span></code> </pre><br>  Anticipando la pregunta, ¬øc√≥mo llega su c√≥digo a la producci√≥n?  Para esto, se crea un proyecto separado que reutiliza los m√≥dulos preparados y probados. <br><br>  Genial, tenemos una fuente de c√≥digo que cambia centralmente.  Tom√©, escrib√≠, prepar√© y me propuse que ma√±ana por la ma√±ana me voy a desplegar en producci√≥n.  Constru√≠ un plan, lo prob√©, genial, v√°monos.  En este momento, mi colega, guiado exclusivamente por buenas intenciones, fue y optimiz√≥ algo, agreg√≥ a este m√≥dulo.  Y sucedi√≥ que estos cambios rompen la compatibilidad con versiones anteriores. <br><br>  Por ejemplo, agreg√≥ los par√°metros necesarios, que debe pasar, de lo contrario el m√≥dulo no se ensamblar√°.  O cambi√≥ los nombres de estos par√°metros.  Entro en la ma√±ana, tengo un tiempo estrictamente limitado para los cambios, comienzo a construir un plan, y Terraform saca los m√≥dulos de estado de Git, comienza a construir un plan y dice: "Vaya, no puedo.  No es suficiente para ti, cambiaste de nombre ".  Estoy sorprendido: "Pero no lo hice, ¬øc√≥mo lidiar con eso?"  Y si este es un recurso que se cre√≥ hace mucho tiempo, luego de dichos cambios, tendr√° que ejecutar todos los entornos, cambiar de alguna manera y dar un vistazo.  Esto es inconveniente. <br><br>  Esto se puede solucionar con etiquetas Git.  Decidimos por nosotros mismos que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">usar√≠amos la notaci√≥n SemVer</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">elaboramos</a> una regla simple: tan pronto como la configuraci√≥n de nuestro m√≥dulo alcanza un cierto estado estable, es decir, podemos usarlo, colocamos una etiqueta en este commit.  Si hacemos cambios y no rompen la compatibilidad con versiones anteriores, cambiamos el n√∫mero menor en la etiqueta, si se rompen, cambiamos el n√∫mero mayor. <br><br>  Por lo tanto, en la direcci√≥n de origen, adjunte a una etiqueta espec√≠fica y si al menos proporciona algo que ten√≠a antes, siempre se recopilar√°.  Deje que la versi√≥n del m√≥dulo siga adelante, pero en el momento adecuado iremos, y cuando realmente la necesitemos, la cambiaremos.  Y lo que funcionaba antes de eso, al menos no se romper√°.  Esto es conveniente  As√≠ es como se ve en nuestro GitLab. <br><br><img src="https://habrastorage.org/webt/qb/vc/yh/qbvcyhrhgdblv8ewvwlr1gkxsmc.png" alt="imagen"><br><br><h4>  Ramificaci√≥n </h4><br>  Usar la ramificaci√≥n es otra pr√°ctica importante.  Hemos desarrollado una regla para nosotros que debe hacer cambios solo desde el maestro.  Pero para cualquier cambio que desee hacer y probar, haga una rama por separado, juegue con ella, experimente, haga planes y vea c√≥mo va.  Y luego haga una solicitud de fusi√≥n, y deje que un colega mire el c√≥digo y le ayude. <br><br><img src="https://habrastorage.org/webt/ty/vf/je/tyvfjel4g_uhzcrf7ifnkdxd230.png" alt="imagen"><br><br><h4>  D√≥nde almacenar tfstate </h4><br>  No debe almacenar su estado localmente.  No debes almacenar tu estado en Git. <br><br>  Nos quemamos en esto cuando alguien, cuando despliega las ramas de un no maestro, obtiene su estado, en el que se guarda el estado, luego lo enciende mediante la fusi√≥n, alguien agrega el suyo, resulta conflictos de fusi√≥n.  O resulta que sin ellos, pero un estado inconsistente, porque "√©l ya lo tiene, todav√≠a no lo tengo", y luego arreglarlo todo es una pr√°ctica desagradable.  Por lo tanto, decidimos que lo almacenar√≠amos en un lugar seguro, versionado, pero que estar√≠a fuera de Git. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">S3</a> encaja perfectamente debajo de esto: est√° disponible, tiene HA, por lo que recuerdo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">exactamente cuatro nueves, tal vez cinco</a> .  Da versiones fuera de la caja, incluso si rompe su estado, siempre puede retroceder.  Y tambi√©n da una cosa muy importante en combinaci√≥n con DynamoDB, que, en mi opini√≥n, ha aprendido este Terraform desde la versi√≥n 0.8.  En DynamoDB, tiene una placa de identificaci√≥n en la que Terraform registra que est√° bloqueando el estado. <br><br>  Es decir, supongamos que quiero hacer algunos cambios.  Estoy comenzando a construir un plan o comenzando a aplicarlo, Terraform va a DynamoDB y dice que en esta placa se informa que este estado est√° bloqueado;  usuario, computadora, tiempo.  En este momento, mi colega, que trabaja de forma remota o tal vez en un par de mesas de m√≠, pero se centr√≥ en el trabajo y no ve lo que estoy haciendo, tambi√©n decidi√≥ que hay que cambiar algo.  √âl hace un plan, pero lo lanza un poco m√°s tarde. <br><br>  Terraform entra en la din√°mica, ve: Lock, se interrumpe y le dice al usuario: "Lo siento, el estado est√° bloqueado por algo".  Un colega ve que estoy trabajando ahora, puede acercarse a m√≠ y decirme: "Escucha, mi cambiador es m√°s importante, entr√©gate a m√≠, por favor".  Digo: "Bien", cancelo el plan, elimino el bloque, m√°s bien, incluso se elimina autom√°ticamente si lo hace correctamente, sin interrumpir Ctrl-C.  Un colega va y lo hace.  Por lo tanto, nos aseguramos contra una situaci√≥n en la que ustedes dos est√°n cambiando algo. <br><br><h4>  Solicitud de fusi√≥n </h4><br>  Usamos ramificaciones en Git.  Asignamos nuestras solicitudes de fusi√≥n a colegas.  Adem√°s, en Gitlab usamos casi todas las herramientas disponibles para que trabajemos juntos, para solicitudes de fusi√≥n o incluso solo algunos grupos: discutir su c√≥digo, revisarlo, establecer un progreso o problema, algo m√°s como eso.  Es muy √∫til, ayuda en el trabajo. <br><br>  Adem√°s, en este caso, la reversi√≥n tambi√©n es m√°s f√°cil, puede volver a la confirmaci√≥n anterior, o si, por ejemplo, decide que no solo aplicar√≠a los cambios desde el asistente, simplemente puede cambiar a una rama estable.  Por ejemplo, hizo una rama de caracter√≠sticas y decidi√≥ que primero har√≠a los cambios desde la rama de caracter√≠sticas.  Y luego los cambios, despu√©s de que todo funcion√≥ bien, le hacen al maestro.  Usted aplic√≥ los cambios en su rama, se dio cuenta de que algo andaba mal, cambi√≥ al maestro, sin cambios, dijo aplicar, regres√≥. <br><br><h4>  Tuber√≠as </h4><br><img src="https://habrastorage.org/webt/qx/g1/ex/qxg1exw6vesornrgdhc7ynmjg80.png" alt="imagen"><br><br>  Decidimos que necesit√°bamos usar el proceso de CI para aplicar nuestros cambios.  Para hacer esto, basado en Gitlab CI, estamos escribiendo una tuber√≠a que automatiza la aplicaci√≥n de cambios.  Hasta ahora, tenemos dos tipos de ellos: <br><br><ul><li>  Tuber√≠a para la rama maestra (tuber√≠a maestra) </li><li>  Tuber√≠a para todas las otras ramas (tuber√≠a de rama) </li></ul><br>  ¬øQu√© hace la tuber√≠a de brunch?      (   , ).     .  ,     merge-request,           ‚Äî   ,   .         .    . <br><br><img src="https://habrastorage.org/webt/vt/0_/hq/vt0_hqcdpurvppbglcxwgwtqiyi.png" alt="imagen"><br><br>       .   ,       ,       .      Terraform-  ,       ,    . ,   merge-request   .        .       .   ,       ,        ,      . <br><br><img src="https://habrastorage.org/webt/67/9z/ub/679zubdsyvuldaiwzcpimtbvjmu.png" alt="imagen"><br><br>          ,   .         . <br><br><h3>  Terraform </h3><br> <b>.</b>      Terraform     ,      ,     . <br><br>     ,  ¬´¬ª ‚Äî              ,   . <br><br> ,   ,    count ‚Äî   ,  , ,  ,   availability-. , ,  ,  .          .    ,    AZ  .      ,  count      . <br><br> ,    4 AZ    5 ,       AZ ‚Äî   4,     , .    : ¬´    ¬ª.    !  ,      .        Terraform  . <br><br> <b> .</b>  ‚Äî  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="> </a> .     .   - -   If  Else. ,    ‚Äî , . <br><br> <b>  </b> .     ,   ,    ,     , Terraform-    ,    CI. <br><br>  CI           .       ,      , ,    ‚Äî    merge,   .  . <br><br> ,         .        .     ,   , Terraform  , ,   tfstate   Terraform   : ¬´,  ,  ¬ª.        ,   ,      . <br><br>     CI,    ,    pipeline  ‚Äî   ,         . <br><br>   ,        .         ,      .    ,       target    ,   . ,      : ¬´Terraform apply target instance¬ª,  -.        -  (,  - ),        . <br><br>          ,      .     .   CI ‚Äî      ,  Terraform    ,   .      ,     - .  ,  ,       ,     .  . <br><br><h3> Terraform ‚Äî    </h3><br>      : <br><br><ul><li> Terraform       ,      .  , ,  .    ,        ,   ,   .       ,    ,  ,         . <br><br>  ,      ‚Äî       Tfstate,       ,        .         .   ¬´   ,    ¬ª ‚Äî  . <br><br>                 , -,  ,  - ‚Äî   .      ,          .     ,               ‚Äî    . </li><li> Terraform    ,      .  Terraform    .  Por qu√©           ,    .     . ,   ,    AZ    - -. ,   North Virginia,     6  .          .    ,   ,  : ¬´,   ¬ª.       ‚Äî .   ‚Äî      ,  , Terraform     . </li><li> Terraform        . ,    ‚Äî 200 ,    198 ,    5.    .       ,         API .  Por desgracia </li><li>     ,      . ,    S3 bucket.     ,              ‚Äî  ,     - .         Terraform ‚Äì    ,   ,   : ¬´,  -   ¬ª.     .      -  ,      . </li></ul><br>   , Terraform ‚Äî ,   .     ,     . <br></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/470543/">https://habr.com/ru/post/470543/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../470529/index.html">C√≥mo tradujimos el proyecto heredado a GraphQL</a></li>
<li><a href="../470531/index.html">El neurofisi√≥logo discute el proyecto Neuralink y habla sobre el trabajo del cerebro "en los dedos"</a></li>
<li><a href="../470535/index.html">Formas de crear gr√°ficos de barras con Python</a></li>
<li><a href="../470537/index.html">Nuevo paquete de validaci√≥n para React on Mobx @ quantumart / mobx-form-validation-kit</a></li>
<li><a href="../470541/index.html">Conceptos b√°sicos de trabajar con Neo4j en un navegador</a></li>
<li><a href="../470547/index.html">Tareas de apio: nuevo decorador, nuevas caracter√≠sticas</a></li>
<li><a href="../470549/index.html">TSMC espera seguir la ley de Moore en las pr√≥ximas d√©cadas</a></li>
<li><a href="../470553/index.html">Integral de Euler-Poisson. Detalles sobre m√©todos de c√°lculo</a></li>
<li><a href="../470555/index.html">Revisi√≥n de Joker 2019: Planet Parade, o lo que nos espera</a></li>
<li><a href="../470557/index.html">Control de luz: un nuevo tipo de elementos √≥pticos basados ‚Äã‚Äãen metamateriales</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>