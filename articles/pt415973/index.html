<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï∫üèΩ üé± üë®‚Äçüé® Como n√£o quebrar o cluster do Apache Ignite desde o in√≠cio üßù üë©üèæ‚Äçüè´ üë®üèø‚Äçüé®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Oi Abaixo est√° uma transcri√ß√£o do v√≠deo do discurso no com√≠cio da comunidade Apache Ignite em S√£o Petersburgo, em 20 de junho. Voc√™ pode baixar os sli...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como n√£o quebrar o cluster do Apache Ignite desde o in√≠cio</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/gridgain/blog/415973/"><p>  Oi  Abaixo est√° uma transcri√ß√£o do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">v√≠deo do</a> discurso no com√≠cio da comunidade Apache Ignite em S√£o Petersburgo, em 20 de junho.  Voc√™ pode baixar os slides <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/zrMWgNyvQVI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  H√° toda uma classe de problemas que os usu√°rios iniciantes enfrentam.  Eles acabaram de baixar o Apache Ignite, executam as duas, tr√™s, dez primeiras e chegam at√© n√≥s com perguntas que s√£o resolvidas de maneira semelhante.  Portanto, proponho a cria√ß√£o de uma lista de verifica√ß√£o que poupar√° muito tempo e nervos quando voc√™ criar seus primeiros aplicativos Apache Ignite.  Falaremos sobre os preparativos para o lan√ßamento;  como fazer o cluster montar;  como iniciar alguns c√°lculos na grade de computa√ß√£o;  Como preparar um modelo e c√≥digo de dados para que voc√™ possa gravar seus dados no Ignite e depois l√™-los com sucesso.  E o mais importante: como n√£o quebrar nada desde o in√≠cio. </p><a name="habracut"></a><br><h2>  Prepara√ß√£o para o lan√ßamento - configurar o log </h2><br><p>  Precisamos de logs.  Se voc√™ j√° fez uma pergunta na lista de correspond√™ncia do Apache Ignite ou no StackOverflow, como "por que tudo desligou", provavelmente a primeira coisa que voc√™ foi solicitado a enviar foi todos os logs de todos os n√≥s. </p><br><p> Naturalmente, o registro do Apache Ignite √© ativado por padr√£o.  Mas existem nuances.  Primeiro, o Apache Ignite escreve um pouco no <code>stdout</code> .  Por padr√£o, ele inicia no chamado modo silencioso.  No <code>stdout</code> voc√™ ver√° apenas os erros mais terr√≠veis e tudo o mais ser√° salvo em um arquivo, o caminho no qual o Apache Ignite exibe no in√≠cio (por padr√£o - <code>${IGNITE_HOME}/work/log</code> ).  Voc√™ n√£o apaga e mant√©m os logs mais longos, pode ser muito √∫til. </p><br><p>  <b><code>stdout</code> inflama na inicializa√ß√£o padr√£o</b> </p><br><p><img src="https://habrastorage.org/webt/dg/wf/4r/dgwf4rf9on5vckayvxqzcbtr5tk.png"></p><br><p>  Para facilitar a descoberta de problemas sem entrar em arquivos separados e configurar o monitoramento separado para o Apache Ignite, voc√™ pode execut√°-lo no modo detalhado com o comando </p><br><pre> <code class="bash hljs">ignite.sh -v</code> </pre> <br><p>  e o sistema come√ßar√° a escrever sobre todos os eventos no <code>stdout</code> junto com o restante do log do aplicativo. </p><br><p>  Verifique os logs!  Muitas vezes, voc√™ pode encontrar solu√ß√µes para seus problemas.  Se o cluster entrou em colapso, muitas vezes no log, voc√™ pode ver mensagens como ‚ÄúAumente esse tempo limite em tal configura√ß√£o.  Ca√≠mos por causa dele.  Ele √© muito pequeno.  A rede n√£o √© boa o suficiente. ‚Äù </p><br><h2>  Montagem de cluster </h2><br><h3>  Convidados n√£o convidados </h3><br><p>  O primeiro problema que muitos enfrentam s√£o os convidados n√£o convidados no seu cluster.  Ou voc√™ acaba sendo um convidado n√£o convidado: inicie um novo cluster e, de repente, ver√° que, na primeira captura instant√¢nea de topologia, em vez de um n√≥, voc√™ tem dois servidores desde o in√≠cio.  Como assim?  Voc√™ lan√ßou apenas um. </p><br><p>  <b>Uma mensagem indicando que o cluster possui dois n√≥s</b> </p><br><p><img src="https://habrastorage.org/webt/l9/fd/kd/l9fdkdt9vvoaryo1fk84agizhvi.png"></p><br><p>  O fato √© que, por padr√£o, o Apache Ignite usa Multicast e, na inicializa√ß√£o, ele procura todos os outros Apache Ignite que est√£o na mesma sub-rede, no mesmo grupo Multicast.  E se isso acontecer, ele tentar√° se conectar.  E, no caso de uma conex√£o malsucedida, ela n√£o ser√° iniciada.  Portanto, no cluster do meu laptop de trabalho, n√≥s extras do cluster no laptop do colega aparecem regularmente regularmente, o que obviamente n√£o √© muito conveniente. </p><br><p>  Como se proteger disso?  A maneira mais f√°cil de configurar o IP est√°tico.  Em vez de <code>TcpDiscoveryMulticastIpFinder</code> , que √© usado por padr√£o, existe <code>TcpDiscoveryVmIpFinder</code> .  L√°, anote todos os IP e portas √†s quais voc√™ est√° se conectando.  Isso √© muito mais conveniente e o proteger√° de um grande n√∫mero de problemas, especialmente em ambientes de desenvolvimento e teste. </p><br><h3>  Muitos endere√ßos </h3><br><p>  O pr√≥ximo problema.  Voc√™ desabilitou o Multicast, inicia o cluster, em uma √∫nica configura√ß√£o, define uma quantidade decente de IP de diferentes ambientes.  E acontece que voc√™ inicia o primeiro n√≥ em um cluster novo por 5 a 10 minutos, embora todos os subseq√ºentes se conectem a ele em 5 a 10 segundos. </p><br><p>  Fa√ßa uma lista de tr√™s endere√ßos IP.  Para cada um, prescrevemos intervalos de 10 portas.  No total, 30 endere√ßos TCP s√£o obtidos.  Como o Apache Ignite deve tentar se conectar a um cluster existente antes de criar um novo cluster, ele verificar√° cada IP sucessivamente.  Pode n√£o causar danos ao seu laptop, mas a prote√ß√£o de varredura de portas geralmente est√° inclu√≠da em alguns ambientes nublados.  Ou seja, ao acessar uma porta privada em algum endere√ßo IP, voc√™ n√£o receber√° nenhuma resposta at√© que o tempo limite termine.  Por padr√£o, s√£o 10 segundos.  E se voc√™ tiver 3 endere√ßos de 10 portas, ter√° 3 * 10 * 10 = 300 segundos de espera - os mesmos 5 minutos para se conectar. </p><br><p>  A solu√ß√£o √© √≥bvia: n√£o registre portas desnecess√°rias.  Se voc√™ possui tr√™s IPs, dificilmente precisar√° de um intervalo padr√£o de 10 portas.  Isso √© conveniente quando voc√™ testa algo na m√°quina local e executa 10 n√≥s.  Mas em sistemas reais, uma √∫nica porta geralmente √© suficiente.  Ou desative a prote√ß√£o contra a varredura de portas na rede interna, se voc√™ tiver essa oportunidade. </p><br><p>  O terceiro problema comum √© o IPv6.  Voc√™ pode ver mensagens de erro de rede estranhas: n√£o foi poss√≠vel conectar, n√£o foi poss√≠vel enviar uma mensagem, n√≥ segmentado.  Isso significa que voc√™ caiu do cluster.  Muitas vezes, esses problemas s√£o causados ‚Äã‚Äãpor ambientes mistos do IPv4 e IPv6.  Isso n√£o quer dizer que o Apache Ignite n√£o suporte IPv6, mas no momento existem alguns problemas. </p><br><p>  A solu√ß√£o mais f√°cil √© passar a op√ß√£o para a m√°quina Java </p><br><pre> <code class="hljs objectivec">-Djava.net.preferIPv4Stack=<span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre> <br><p>  O Java e o Apache Ignite n√£o usar√£o o IPv6.  Isso resolve uma parte significativa dos problemas com agrupamentos em colapso. </p><br><h2>  Prepara√ß√£o da base de c√≥digo - serializamos corretamente </h2><br><p>  O cluster se reuniu, √© necess√°rio iniciar algo nele.  Um dos elementos mais importantes na intera√ß√£o do seu c√≥digo com o c√≥digo Apache Ignite √© o Marshaller, ou serializa√ß√£o.  Para escrever algo na mem√≥ria, persist√™ncia e enviar pela rede, o Apache Ignite primeiro serializa seus objetos.  Voc√™ pode ver as mensagens que come√ßam com as palavras: "n√£o pode ser escrito em formato bin√°rio" ou "n√£o pode ser serializado usando o BinaryMarshaller".  Haver√° apenas um aviso no log, mas percept√≠vel.  Isso significa que voc√™ precisa ajustar um pouco mais o seu c√≥digo para fazer amizade com o Apache Ignite. </p><br><p>  O Apache Ignite usa tr√™s mecanismos para serializa√ß√£o: </p><br><ul><li>  <code>JdkMarshaller</code> - serializa√ß√£o Java regular; </li><li>  <code>OptimizedMarshaller</code> - serializa√ß√£o Java ligeiramente otimizada, mas os mecanismos s√£o os mesmos; </li><li>  <code>BinaryMarshaller</code> √© uma serializa√ß√£o escrita especificamente para o Apache Ignite, usada em todos os lugares.  Ela tem v√°rias vantagens.  Em algum lugar, podemos evitar serializa√ß√£o e desserializa√ß√£o adicionais e, em algum lugar, podemos at√© obter um objeto n√£o desserializado na API, trabalhar com ele diretamente em formato bin√°rio, como em algo como JSON. </li></ul><br><p>  <code>BinaryMarshaller</code> poder√° serializar e desserializar seus POJOs que n√£o possuem nada al√©m de campos e m√©todos simples.  Mas se voc√™ tiver serializa√ß√£o personalizada via <code>readObject()</code> e <code>writeObject()</code> , se voc√™ usar <code>Externalizable</code> , o <code>BinaryMarshaller</code> n√£o suportar√°.  Ele ver√° que seu objeto n√£o pode ser serializado pela grava√ß√£o usual de campos n√£o transit√≥rios e desistir√° - ele reverter√° para o <code>OptimizedMarshaller</code> . </p><br><p>  Para fazer amizade com esses objetos com o Apache Ignite, voc√™ precisa implementar a interface <code>Binarylizable</code> .  Ele √© muito simples. </p><br><p>  Por exemplo, existe um <code>TreeMap</code> padr√£o de Java.  Possui serializa√ß√£o e desserializa√ß√£o personalizadas via objeto de leitura e grava√ß√£o.  Primeiro descreve alguns campos e, em seguida, grava o comprimento e os pr√≥prios dados no <code>OutputStream</code> . </p><br><p>  <b>Implementa√ß√£o de <code>TreeMap.writeObject()</code></b> </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(java.io.ObjectOutputStream s)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> java.io.IOException </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Write out the Comparator and any hidden stuff s.defaultWriteObject(); // Write out size (number of Mappings) s.writeInt(size); // Write out keys and values (alternating) for (Iterator&lt;Map.Entry&lt;K,V&gt;&gt; i = entrySet().iterator(); i.hasNext(); ) { Map.Entry&lt;K,V&gt; e = i.next(); s.writeObject(e.getKey()); s.writeObject(e.getValue()); } }</span></span></code> </pre> <br><p>  <code>writeBinary()</code> e <code>readBinary()</code> de <code>Binarylizable</code> funcionam exatamente da mesma maneira: <code>BinaryTreeMap</code> envolve em um <code>BinaryTreeMap</code> regular e grava-o em <code>OutputStream</code> .  Esse m√©todo √© f√°cil de escrever e aumentar√° bastante a produtividade. </p><br><p>  <b><code>BinaryTreeMap.writeBinary()</code></b> </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeBinary</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BinaryWriter writer)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> BinaryObjectException </span></span>{ BinaryRawWriter rewriter = writer. rewrite (); rawWriter.writeObject(map.comparator()); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> size = map.size(); rawWriter.writeInt(size); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Map.Entry&lt;Object, Object&gt; entry : ((TreeMap&lt;Object, Object&gt;)map).entrySet()) { rawWriter.writeObject(entry.getKey()); rawWriter.writeObject(entry.getValue()); } }</code> </pre> <br><h2>  Iniciar na grade de computa√ß√£o </h2><br><p>  O Ignite n√£o apenas permite armazenar dados, mas tamb√©m executar computa√ß√£o distribu√≠da.  Como executamos algum tipo de lambda para dispersar todos os servidores e executar? <br>  Para iniciantes, qual √© o problema com esses exemplos de c√≥digo? </p><br><p>  <b>Qual √© o problema?</b> </p><br><pre> <code class="java hljs">Foo foo = ‚Ä¶; Bar bar = ...; ignite.compute().broadcast( () -&gt; doStuffWithFooAndBar(foo, bar) );</code> </pre> <br><p>  <b>E se sim?</b> </p><br><pre> <code class="java hljs">Foo foo = ‚Ä¶; Bar bar = ...; ignite.compute().broadcast(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IgniteRunnable() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ doStuffWithFooAndBar(foo, bar); } });</code> </pre> <br><p>  Como voc√™ pode imaginar, muitos familiarizados com as armadilhas de lambdas e classes an√¥nimas, o problema est√° em capturar vari√°veis ‚Äã‚Äãde fora.  Por exemplo, enviamos lambda.  Ele usa algumas vari√°veis ‚Äã‚Äãdeclaradas fora do lambda.  Isso significa que essas vari√°veis ‚Äã‚Äãviajam com ela e voam pela rede para todos os servidores.  E ent√£o surgem as mesmas perguntas: esses objetos s√£o amig√°veis ‚Äã‚Äãcom o <code>BinaryMarshaller</code> ?  Qual o tamanho deles?  Em geral, queremos que eles sejam transferidos para algum lugar ou esses objetos s√£o t√£o grandes que √© melhor passar algum tipo de ID e recriar os objetos dentro do lambda que j√° est√£o do outro lado? </p><br><p>  A classe an√¥nima √© ainda pior.  Se o lambda n√£o puder levar isso com voc√™, jogue-o fora, se n√£o for usado, a classe an√¥nima o levar√° com certeza, e isso geralmente n√£o leva a nada de bom. </p><br><p>  O exemplo a seguir.  Lambda novamente, mas que usa a API Apache Ignite um pouco. </p><br><p>  <b>Usar igni√ß√£o no fechamento da computa√ß√£o est√° <em>errado</em></b> </p><br><pre> <code class="java hljs">ignite.compute().broadcast(() -&gt; { IgniteCache foo = ignite.cache(<span class="hljs-string"><span class="hljs-string">"foo"</span></span>); String sql = <span class="hljs-string"><span class="hljs-string">"where id = 42"</span></span>; SqlQuery qry = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlQuery(<span class="hljs-string"><span class="hljs-string">"Foo"</span></span>, sql).setLocal(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> foo.query(qry); });</code> </pre> <br><p>  Na vers√£o original, ele pega o cache e faz localmente algum tipo de consulta SQL.  Esse √© um padr√£o quando voc√™ precisa enviar uma tarefa que funciona apenas com dados locais em n√≥s remotos. </p><br><p>  Qual √© o problema aqui?  O lambda novamente captura o link, mas agora n√£o para o objeto, mas para o Ignite local no n√≥ com o qual o enviamos.  E at√© funciona, porque o objeto Ignite possui um m√©todo <code>readResolve()</code> , que permite que a desserializa√ß√£o substitua o Ignite que veio pela rede pelo local no n√≥ para onde o enviamos.  Mas isso tamb√©m √†s vezes leva a consequ√™ncias indesej√°veis. </p><br><p>  Basicamente, voc√™ est√° simplesmente transferindo mais dados pela rede do que gostaria.  Se voc√™ precisar obter algum c√≥digo que n√£o controla a inicializa√ß√£o no Apache Ignite ou algumas de suas interfaces, o mais simples √© usar o m√©todo <code>Ignintion.localIgnite()</code> .  Voc√™ pode cham√°-lo a partir de qualquer thread que o Apache Ignite criou e obter um link para um objeto local.  Se voc√™ tem lambdas, servi√ßos, qualquer coisa e entende que precisa do Ignite aqui, recomendo este m√©todo. </p><br><p>  <strong>Usamos Ignite corretamente no fechamento da computa√ß√£o - atrav√©s de <code>localIgnite()</code></strong> </p><br><pre> <code class="java hljs">ignite.compute().broadcast(() -&gt; { IgniteCache foo = Ignition.localIgnite().cache(<span class="hljs-string"><span class="hljs-string">"foo"</span></span>); String sql = <span class="hljs-string"><span class="hljs-string">"where id = 42"</span></span>; SqlQuery qry = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlQuery(<span class="hljs-string"><span class="hljs-string">"Foo"</span></span>, sql).setLocal(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> foo.query(qry); });</code> </pre><br><p>  E o √∫ltimo exemplo nesta parte.  O Apache Ignite possui uma Service Grid que pode ser usada para implantar microsservi√ßos diretamente em um cluster, e o Apache Ignite ajudar√° a manter on-line o n√∫mero certo de inst√¢ncias.  Digamos que neste servi√ßo tamb√©m precisamos de um link para o Apache Ignite.  Como conseguir isso?  Poder√≠amos usar <code>localIgnite()</code> , mas esse link dever√° ser salvo manualmente no campo. </p><br><p>  <strong>O servi√ßo armazena Ignite em um campo <em>incorretamente</em> - leva isso como argumento para o construtor</strong> </p><br><pre> <code class="java hljs">MyService s = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyService(ignite) ignite.services().deployClusterSingleton(<span class="hljs-string"><span class="hljs-string">"svc"</span></span>, s); ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Service</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Ignite ignite; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Ignite ignite)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ignite = ignite; } ... }</code> </pre> <br><p>  Existe uma maneira mais simples.  Ainda temos classes completas, e n√£o lambda, para que possamos anotar o campo como <code>@IgniteInstanceResource</code> .  Quando o servi√ßo √© criado, o Apache Ignite se coloca l√° e voc√™ pode us√°-lo com seguran√ßa.  Eu recomendo fortemente que voc√™ fa√ßa exatamente isso, e n√£o tente passar o Apache Ignite e seus filhos para o construtor. </p><br><p>  <strong>O servi√ßo usa <code>@IgniteInstanceResource</code></strong> </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Service</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@IgniteInstanceResource</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Ignite ignite; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } ... }</code> </pre> <br><h2>  Escrevendo e lendo dados </h2><br><h3>  Observando a linha de base </h3><br><p>  Agora temos um cluster Apache Ignite e um c√≥digo preparado. </p><br><p>  Vamos imaginar este cen√°rio: </p><br><ul><li>  Um cache <code>REPLICATED</code> - c√≥pias de dados est√£o dispon√≠veis em todos os n√≥s; </li><li>  A persist√™ncia nativa est√° ativada - escreve no disco. </li></ul><br><p>  Come√ßamos um n√≥.  Como a persist√™ncia nativa est√° ativada, precisamos ativar o cluster antes de trabalhar com ele.  Ative.  Em seguida, lan√ßamos mais alguns n√≥s. <br>  Tudo parece estar funcionando: escrever e ler est√£o bem.  Todos os n√≥s t√™m c√≥pias dos dados; voc√™ pode parar com seguran√ßa um n√≥.  Mas se voc√™ parar o primeiro n√≥ a partir do qual voc√™ iniciou o lan√ßamento, tudo ser√° interrompido: os dados desaparecem e as opera√ß√µes param de passar. </p><br><p>  O motivo disso √© a topologia de linha de base - os muitos n√≥s que armazenam dados de persist√™ncia neles.  Todos os outros n√≥s n√£o ter√£o dados persistentes. </p><br><p>  Este conjunto de n√≥s pela primeira vez √© determinado no momento da ativa√ß√£o.  E os n√≥s que voc√™ adicionou posteriormente n√£o s√£o mais inclu√≠dos no n√∫mero de n√≥s da linha de base.  Ou seja, muita topologia de linha de base consiste em apenas um, o primeiro n√≥, quando para, tudo quebra.  Para impedir que isso aconte√ßa, inicie todos os n√≥s primeiro e, em seguida, ative o cluster.  Se voc√™ precisar adicionar ou remover um n√≥ usando o comando </p><br><pre> <code class="bash hljs">control.sh --baseline</code> </pre> <br><p>  Voc√™ pode ver quais n√≥s est√£o listados l√°.  O mesmo script pode atualizar a linha de base para seu estado atual. </p><br><p>  <b>Exemplo <code>control.sh</code></b> </p><br><p><img src="https://habrastorage.org/webt/nw/6d/fy/nw6dfy5onsssvkwsw1vmwaxczm4.png"></p><br><h3>  Coloca√ß√£o de dados </h3><br><p>  Agora sabemos que os dados s√£o salvos, tente l√™-los.  Temos suporte SQL, voc√™ pode fazer o <code>SELECT</code> - quase como no Oracle.  Mas, ao mesmo tempo, podemos escalar e executar em qualquer n√∫mero de n√≥s, os dados s√£o armazenados de maneira distribu√≠da.  Vejamos esse modelo: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@QuerySqlField</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@QuerySqlField</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Long orgId; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Organization</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@QuerySqlField</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; }</code> </pre> <br><p>  Pedido </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Person <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Organization</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> o <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> p.orgId = o.id</code> </pre> <br><p>  n√£o retornar√° todos os dados.  O que est√° errado? </p><br><p>  Pessoa ( <code>Person</code> ) refere-se √† organiza√ß√£o ( <code>Organization</code> ) por ID.  Esta √© uma chave estrangeira cl√°ssica.  Mas se tentarmos combinar as duas tabelas e enviar essa consulta SQL, com v√°rios n√≥s no cluster, n√£o receberemos todos os dados. </p><br><p>  O fato √© que, por padr√£o, o SQL <code>JOIN</code> funciona apenas em um √∫nico n√≥.  Se o SQL constantemente percorresse todo o cluster para coletar dados e retornar o resultado completo, seria incrivelmente lento.  Perder√≠amos todos os benef√≠cios de um sistema distribu√≠do.  Portanto, o Apache Ignite analisa apenas os dados locais. </p><br><p>  Para obter os resultados corretos, precisamos colocar os dados juntos (colocation).  Ou seja, para a combina√ß√£o correta de Pessoa e Organiza√ß√£o, os dados de ambas as tabelas devem ser armazenados no mesmo n√≥. </p><br><p>  Como fazer isso?  A solu√ß√£o mais f√°cil √© declarar uma chave de afinidade.  Este √© um valor que determina em qual n√≥, em qual parti√ß√£o, em qual grupo de registros esse ou aquele valor ser√° localizado.  Se declararmos o ID da organiza√ß√£o em <code>Person</code> como uma chave de afinidade, isso significa que as pessoas com esse ID da organiza√ß√£o devem estar no mesmo n√≥ que a organiza√ß√£o com o mesmo ID. </p><br><p>  Se, por algum motivo, voc√™ n√£o puder fazer isso, existe outra solu√ß√£o menos eficaz - habilite as jun√ß√µes distribu√≠das.  Isso √© feito por meio da API e o procedimento depende do que voc√™ usa - Java, JDBC ou qualquer outra coisa.  <code>JOIN</code> ser√£o executados mais lentamente, mas retornar√£o os resultados corretos. </p><br><p>  Vamos considerar como trabalhar com chaves de afinidade.  Como entendemos que tal e tal ID, tal e tal campo s√£o adequados para determinar a afinidade?  Se dissermos que todas as pessoas com o mesmo <code>orgId</code> ser√£o armazenadas juntas, o <code>orgId</code> √© um grupo indivis√≠vel.  N√£o podemos distribu√≠-lo entre v√°rios n√≥s.  Se o banco de dados contiver 10 organiza√ß√µes, haver√° 10 grupos indivis√≠veis que podem ser colocados em 10 n√≥s.  Se houver mais n√≥s no cluster, todos os n√≥s "extras" permanecer√£o sem grupos.  Isso √© muito dif√≠cil de definir em tempo de execu√ß√£o, ent√£o pense nisso antes. </p><br><p>  Se voc√™ tem uma organiza√ß√£o grande e 9 pequenas, o tamanho dos grupos ser√° diferente.  Mas o Apache Ignite n√£o analisa o n√∫mero de registros nos grupos de afinidade quando os distribui pelos n√≥s.  Portanto, ele n√£o colocar√° um grupo em um n√≥, mas outros 9 em outro para, de alguma forma, nivelar a distribui√ß√£o.  Em vez disso, ele os colocar√° 5 e 5 (ou 6 e 4, ou mesmo 7 e 3). </p><br><p>  Como tornar os dados distribu√≠dos uniformemente?  Que possamos ter </p><br><ul><li>  Teclas K; </li><li>  Uma variedade de chaves de afinidade; </li><li>  Parti√ß√µes P, ou seja, grandes grupos de dados que o Apache Ignite distribuir√° entre n√≥s; </li><li>  N n√≥s. </li></ul><br><p>  Ent√£o √© necess√°rio que a condi√ß√£o </p><br><pre> <code class="hljs ruby">K <span class="hljs-meta"><span class="hljs-meta">&gt;&gt; </span></span>A &gt;&gt; P &gt;&gt; N</code> </pre> <br><p>  onde <code>&gt;&gt;</code> √© "muito mais" e os dados ser√£o distribu√≠dos de maneira relativamente uniforme. </p><br><p>  A prop√≥sito, o padr√£o √© P = 1024. </p><br><p>  Muito provavelmente voc√™ n√£o ter√° sucesso em uma distribui√ß√£o uniforme.  Este foi o caso no Apache Ignite 1.x a 1.9.  Isso foi chamado <code>FairAffinityFunction</code> e n√£o funcionou muito bem - resultou em muito tr√°fego entre os n√≥s.  Agora, o algoritmo √© chamado <code>RendezvousAffinityFunction</code> .  Ele n√£o fornece uma distribui√ß√£o absolutamente honesta, o erro entre os n√≥s ser√° mais ou menos 5-10%. </p><br><h2>  Lista de verifica√ß√£o para novos usu√°rios do Apache Ignite </h2><br><ol><li>  Configurar, ler, armazenar logs </li><li>  Desative o multicast, anote apenas os endere√ßos e portas que voc√™ usa </li><li>  Desativar IPv6 </li><li>  Prepare suas aulas para o <code>BinaryMarshaller</code> </li><li>  Acompanhe sua linha de base </li><li>  Configurar disposi√ß√£o de afinidade </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt415973/">https://habr.com/ru/post/pt415973/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt415961/index.html">Armazenamento distribu√≠do russo. Como funciona</a></li>
<li><a href="../pt415963/index.html">Naive Bayes, ou como a matem√°tica permite filtrar spam</a></li>
<li><a href="../pt415965/index.html">O que ler em julho: 19 novos livros para profissionais digitais</a></li>
<li><a href="../pt415967/index.html">SolidFire - Armazenamento para aqueles ** que odeiam armazenamento</a></li>
<li><a href="../pt415969/index.html">HyperX Pulsefire Surge RGB - um assassino natural</a></li>
<li><a href="../pt415975/index.html">Os chineses introduziram uma arma laser com alcance de quase um quil√¥metro</a></li>
<li><a href="../pt415977/index.html">T√∫neis e VPNs resistentes a DPI</a></li>
<li><a href="../pt415979/index.html">Semana de Seguran√ßa 24: Rowhammer no Android e a complexidade das vulnerabilidades de hardware</a></li>
<li><a href="../pt415981/index.html">Google e HTTP</a></li>
<li><a href="../pt415983/index.html">Universo primitivo 5. Redshift cosmol√≥gico e din√¢mica de um universo em expans√£o uniforme, parte 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>