<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐ ๐ง ๐จ๐ฟโ๐ป ุชุชุจุน ุฏููุงูููู ูุงูู ูุชููุฒ ุนูู ูุธุงู Linux ุจุงุณุชุฎุฏุงู eBPF ู bpftrace โญ๏ธ ๐ โ๏ธ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content=""ูู ูุถุน ุงูุชุชุจุน ุ ูุฑู ุงููุจุฑูุฌ ุชุณูุณู ุชูููุฐ ุงูุฃูุงูุฑ ูููู ุงููุชุบูุฑุงุช ูู ูุฐู ุงูุฎุทูุฉ ูู ุชูููุฐ ุงูุจุฑูุงูุฌ ุ ููุง ูุฌุนู ูู ุงูุณูู ุงูุชุดุงู ุงูุฃุฎุทุงุก" ุ ููุง ูุฎุจุฑูุง ููููุจ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ุชุชุจุน ุฏููุงูููู ูุงูู ูุชููุฒ ุนูู ูุธุงู Linux ุจุงุณุชุฎุฏุงู eBPF ู bpftrace</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/itsumma/blog/441258/" style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/gd/t6/e_/gdt6e_wwaanx1prvqkhdhj5ptss.jpeg"><br><br>  "ูู ูุถุน ุงูุชุชุจุน ุ ูุฑู ุงููุจุฑูุฌ ุชุณูุณู ุชูููุฐ ุงูุฃูุงูุฑ ูููู ุงููุชุบูุฑุงุช ูู ูุฐู ุงูุฎุทูุฉ ูู ุชูููุฐ ุงูุจุฑูุงูุฌ ุ ููุง ูุฌุนู ูู ุงูุณูู ุงูุชุดุงู ุงูุฃุฎุทุงุก" ุ ููุง ูุฎุจุฑูุง ููููุจูุฏูุง.  ูุธุฑูุง ูุฃู ูุธุงู Linux ูุดุฌุนูุง ุนูู ุฃููุณูุง ุ ููุญู ูุชูุญุต ุจุงูุชุธุงู ูุณุฃูุฉ ุงูุฃุฏูุงุช ุงููุญุฏุฏุฉ ุงูุฃูุถู ูุชูููุฐูุง.  ููุฑูุฏ ุฃู ูุดุงุฑู ูู ุชุฑุฌูุฉ ููุงู ูููุจุฑูุฌ ูููุฌูู ูุงู ุงูุฐู ููุตู ุจู bpftrace.  ุจุงููุธุฑ ุฅูู ุงููุณุชูุจู ุ ุฃููู ุฅู ุงูููุงูุฉ ุชูุชูู ุจุฅูุฌุงุฒ: "bpftrace ูู ุงููุณุชูุจู".  ูููุงุฐุง ุฃุซุงุฑ ุฅุนุฌุงุจ ุฒููู ูุงูุ  ุฅุฌุงุจุฉ ููุตูุฉ ุชุญุช ุงูุฎูุถ. <br><a name="habracut"></a><br>  ููุงู ููุนุงู ูู ุฃุฏูุงุช ุงูุชุชุจุน ุงูุฑุฆูุณูุฉ ุนูู Linux: <br>  ูุชูุญ ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">strace</a> ูุนุฑูุฉ ููุงููุงุช ุงููุธุงู ุงูุชู ูุชู ุฅุฌุฑุงุคูุง ุ <br>  ูุชูุญ ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ltrace</a> ูุนุฑูุฉ ุงูููุชุจุงุช ุงูุฏููุงููููุฉ ุงูุชู ูุชู ุงุณุชุฏุนุงุคูุง. <br><br>  ุนูู ุงูุฑุบู ูู ูุงุฆุฏุชูุง ุ ุฅูุง ุฃู ูุฐู ุงูุฃุฏูุงุช ูุญุฏูุฏุฉ.  ูุฅุฐุง ููุช ุจุญุงุฌุฉ ููุนุฑูุฉ ูุง ูุญุฏุซ ุฏุงุฎู ูุธุงู ุฃู ููุงููุฉ ููุชุจุฉุ  ูุฅุฐุง ููุช ูุง ุชุญุชุงุฌ ููุท ุฅูู ุชุฌููุน ูุงุฆูุฉ ุงูููุงููุงุช ุ ูููู ุฃูุถูุง ุ ุนูู ุณุจูู ุงููุซุงู ุ ุฌูุน ุฅุญุตุงุฆูุงุช ุญูู ุณููู ูุนููุ  ูุฅุฐุง ููุช ุจุญุงุฌุฉ ุฅูู ุชุชุจุน ุงูุนุฏูุฏ ูู ุงูุนูููุงุช ูููุงุฑูุฉ ุงูุจูุงูุงุช ูู ุนุฏุฉ ูุตุงุฏุฑุ <br><br>  ูู ุนุงู 2019 ุ ุญุตููุง ูู ุงูููุงูุฉ ุนูู ุฅุฌุงุจุฉ ููุงุณุจุฉ ููุฐู ุงูุฃุณุฆูุฉ ุนูู ูุธุงู Linux: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">bpftrace</a> ุนูู ุฃุณุงุณ ุชูููุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">eBPF</a> .  ูุณูุญ ูู Bpftrace ุจูุชุงุจุฉ ุงูุจุฑุงูุฌ ุงูุตุบูุฑุฉ ุงูุชู ุชุนูู ูู ูู ูุฑุฉ ูุญุฏุซ ูููุง ุญุฏุซ. <br><br>  ูู ูุฐู ุงูููุงูุฉ ุณูู ุฃุตู ููููุฉ ุชุซุจูุช bpftrace ูุชุนููู ุชุทุจููู ุงูุฃุณุงุณู.  ุณุฃูุฏู ุฃูุถูุง ูุธุฑุฉ ุนุงูุฉ ุนูู ูุง ูุจุฏู ุนููู ุงููุธุงู ุงูุจูุฆู ููุชุชุจุน (ุนูู ุณุจูู ุงููุซุงู ุ "ูุง ูู eBPFุ") ูููู ุชุทูุฑุช ุฅูู ูุง ูุฏููุง ุงูููู. <br><br><img src="https://habrastorage.org/webt/v9/vp/di/v9vpdivpv8a6roolw_kiz7wtnfs.png"><br><br><h3 style=";text-align:right;direction:rtl">  ูุง ูู ุงูุฃุซุฑุ </h3><br>  ููุง ุฐูุฑูุง ุณุงุจููุง ุ ูุณูุญ ูู bpftrace ุจูุชุงุจุฉ ุจุฑุงูุฌ ุตุบูุฑุฉ ูุชู ุชุดุบูููุง ูู ูู ูุฑุฉ ูุญุฏุซ ูููุง ุญุฏุซ. <br><br>  ูุง ูู ุงูุญุฏุซุ  ูุฏ ุชููู ููุงููุฉ ูุธุงู ุฃู ููุงููุฉ ูุธูููุฉ ุฃู ุญุชู ุดูุก ูุญุฏุซ ุฏุงุฎู ูุซู ูุฐู ุงูุทูุจุงุช.  ูููู ุฃู ูููู ุฃูุถูุง ูุคูุชูุง ุฃู ุญุฏุซูุง ููุฌูุงุฒ ุ ุนูู ุณุจูู ุงููุซุงู ุ "ูุฑุช 50 ูููู ุซุงููุฉ ููุฐ ุขุฎุฑ ุงูุฃุญุฏุงุซ ููุณูุง" ุฃู "ุญุฏุซ ูุดู ูู ุงูุตูุญุฉ" ุฃู "ุญุฏุซ ุชุจุฏูู ููุณูุงู" ุฃู "ุญุฏุซ cashe-miss". <br><br>  ูุง ุงูุฐู ูููู ุงูููุงู ุจู ุงุณุชุฌุงุจุฉ ูุญุฏุซ ูุงุ  ููููู ุงูุชุนูุฏ ุจุดูุก ูุง ุ ูุฌูุน ุงูุฅุญุตุงุกุงุช ูุชูููุฐ ุฃูุงูุฑ shell ุงูุชุนุณููุฉ.  ุณูููู ูุฏูู ุงููุตูู ุฅูู ูุฎุชูู ุงููุนูููุงุช ุงูุณูุงููุฉ ุ ูุซู PID ุงูุญุงูู ุ ุชุชุจุน ุงูููุฏุณ ุ ุงูููุช ุ ูุณุงุฆุท ุงูุงุชุตุงู ุ ููู ุงูุฅุฑุฌุงุน ุ ุฅูุฎ. <br><br>  ูุชู ุชุณุชุฎุฏูุ  ูู ูุซูุฑ.  ููููู ูุนุฑูุฉ ุณุจุจ ุจุทุก ุงูุชุทุจูู ูู ุฎูุงู ุชุฌููุน ูุงุฆูุฉ ูู ุฃุจุทุฃ ุงูููุงููุงุช.  ููููู ุชุญุฏูุฏ ูุง ุฅุฐุง ูุงู ููุงู ุชุณุฑุจ ููุฐุงูุฑุฉ ูู ุงูุชุทุจูู ุ ูุฅุฐุง ูุงู ุงูุฃูุฑ ูุฐูู ุ ูุฃูู.  ุฃูุง ุงุณุชุฎุฏุงููุง ูููู ููุงุฐุง ูุณุชุฎุฏู ุฑูุจู ุงููุซูุฑ ูู ุงูุฐุงูุฑุฉ. <br><br>  ุงูุฅุถุงูุฉ ุงููุจูุฑุฉ ูู bpftrace ูู ุฃูู ูุณุช ุจุญุงุฌุฉ ุฅูู ุฅุนุงุฏุฉ ุชุฑุฌูุฉ ุงูุชุทุจูู.  ููุณุช ููุงู ุญุงุฌุฉ ููุชุงุจุฉ ููุงููุงุช ุงูุทุจุงุนุฉ ูุฏูููุง ุฃู ุฃู ููุฏ ุชุตุญูุญ ุฃุฎุทุงุก ุขุฎุฑ ูู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุงููุตุฏุฑ ููุชุทุจูู ููุฏ ุงูุฏุฑุงุณุฉ.  ููุณุช ููุงู ุญุงุฌุฉ ุญุชู ูุฅุนุงุฏุฉ ุชุดุบูู ุงูุชุทุจููุงุช.  ููู ูุฐุง ูุน ุงูุฎูุงุถ ุงููููุงุช ุงูุนุงูุฉ ููุบุงูุฉ.  ูุฐุง ูุฌุนู bpftrace ูููุฏูุง ุจุดูู ุฎุงุต ูุฃูุธูุฉ ุชุตุญูุญ ุงูุฃุฎุทุงุก ูุจุงุดุฑุฉ ุนูู prod ุฃู ูู ูููู ุขุฎุฑ ุญูุซ ุชูุฌุฏ ุตุนูุจุงุช ูู ุฅุนุงุฏุฉ ุงูุชุญููู. <br><br><h3 style=";text-align:right;direction:rtl">  DTrace: ูุงูุฏ ุงูุชุชุจุน </h3><br>  ููุชุฑุฉ ุทูููุฉ ุ ูุงูุช ุฃูุถู ุฃุฏุงุฉ ุชุชุจุน ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">DTrace</a> ุ ููู ุฅุทุงุฑ ุชุชุจุน ุฏููุงูููู ูุงูู ุชู ุชุทููุฑู ูู ุงูุฃุตู ุจูุงุณุทุฉ Sun Microsystems (ุตูุงุน Java).  ูุซู bpftrace ุ ูุณูุญ ูู DTrace ุจูุชุงุจุฉ ุจุฑุงูุฌ ุตุบูุฑุฉ ูุชู ุชุดุบูููุง ุงุณุชุฌุงุจุฉ ููุฃุญุฏุงุซ.  ูู ุงููุงูุน ุ ุชู ุชุทููุฑ ุงูุนุฏูุฏ ูู ุงูุนูุงุตุฑ ุงูุฑุฆูุณูุฉ ูููุธุงู ุงูุฅูููููุฌู ุฅูู ุญุฏ ูุจูุฑ ุจูุงุณุทุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Brendan Gregg</a> ุ ููู ุฎุจูุฑ ูุดููุฑ ูู DTrace ูุนูู ุญุงูููุง ูู Netflix.  ููู ูุง ููุณุฑ ุฃูุฌู ุงูุชุดุงุจู ุจูู DTrace ู bpftrace. <br><br><img src="https://habrastorage.org/webt/2p/wc/4w/2pwc4wawnfzibvlwt7ia0xibodc.jpeg"><br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุฏูุฉ ููุฏูุฉ Solaris DTrace (2009) ูู</a> ุชุฃููู S. Tripathi ุ ุดุฑูุฉ ุตู ูุงููุฑูุณูุณุชูุฒ</i> <br><br>  ูู ูุฑุญูุฉ ูุง ุ ูุชุญุช ุตู ูุตุฏุฑ DTrace.  ุงูููู ุ ูุชููุฑ DTrace ุนูู Solaris ู FreeBSD ู macOS (ุนูู ุงูุฑุบู ูู ุฃู ุฅุตุฏุงุฑ macOS ุบูุฑ ูุงุจู ููุชุดุบูู ุจุดูู ุนุงู ูุฃู ุญูุงูุฉ ุชูุงูู ุงููุธุงู (SIP) ูุฏ ุฎุฑูุช ุงูุนุฏูุฏ ูู ุงููุจุงุฏุฆ ุงูุชู ูุนูู ุนูููุง DTrace). <br><br>  ูุนู ุ ููุฏ ูุงุญุธุช ุจุดูู ุตุญูุญ ... Linux ููุณ ูู ูุฐู ุงููุงุฆูุฉ.  ูุฐู ููุณุช ูุดููุฉ ููุฏุณูุฉ ุ ุฅููุง ูุดููุฉ ุชุฑุฎูุต.  ุชู ูุชุญ DTrace ุชุญุช CDDL ุจุฏูุงู ูู GPL.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุฃุตุจุญ ูููุฐ Linux DTrace</a> ูุชุงุญูุง ููุฐ ุนุงู 2011 ุ ูููู ูู ูุชู ุฏุนูู ูู ููุจู ูุทูุฑู Linux ุงูุฑุฆูุณููู.  ูู ุฃูุงุฆู ุนุงู 2018 ุ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุฃุนุงุฏุช Oracle ูุชุญ DTrace ุชุญุช ุฑุฎุตุฉ GPL</a> ุ ูููู ุจุญููู ุฐูู ุงูููุช ูุงู ูุฏ ูุงุช ุงูุฃูุงู. <br><br><h3 style=";text-align:right;direction:rtl">  ุชุชุจุน ูุธุงู ููููุณ ุงูุจูุฆู </h3><br>  ูุง ุดู ุฃู ุงูุชุชุจุน ูููุฏ ููุบุงูุฉ ุ ููุฏ ุณุนู ูุฌุชูุน Linux ุฅูู ุชุทููุฑ ุญูููู ุงูุฎุงุตุฉ ููุฐุง ุงูููุถูุน.  ูููู ุ ุนูู ุนูุณ Solaris ุ ูุง ูุฎุถุน ูุธุงู Linux ููุฑูุงุจุฉ ุจูุงุณุทุฉ ุจุงุฆุน ูุงุญุฏ ุ ูุจุงูุชุงูู ูู ููู ููุงู ุฌูุฏ ูุชุนูุฏ ูุชุทููุฑ ุจุฏูู ูุธููู ุจุงููุงูู ูู DTrace.  ุชุทูุฑ ูุธุงู ุงูุชุชุจุน ุงูุจูุฆู ููุธุงู Linux ุจุจุทุก ูุจุทุจูุนุฉ ุงูุญุงู ุ ููุง ุฃุฏู ุฅูู ุญู ุงููุดููุงุช ุนูุฏ ูุดูุฆูุง.  ููุคุฎุฑุง ููุท ููุง ูุฐุง ุงููุธุงู ุงูุจูุฆู ุจูุง ูููู ูููุงูุณุฉ DTrace ุจุฌุฏูุฉ. <br><br>  ุจุณุจุจ ุงูููู ุงูุทุจูุนู ุ ูุฏ ูุจุฏู ูุฐุง ุงููุธุงู ุงูุฅูููููุฌู ููุถูููุง ููููุงู ุ ููุชุฃูู ูู ุงูุนุฏูุฏ ูู ุงูููููุงุช ุงููุฎุชููุฉ.  ูุญุณู ุงูุญุธ ุ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุชุจุช</a> ุฌูููุง ุฅููุงูุฒ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุฑุงุฌุนุฉ ููุฐุง ุงููุธุงู ุงูุจูุฆู</a> (ุงูุงูุชุจุงู ุ ุชุงุฑูุฎ ุงููุดุฑ - 2017 ุ ูุจู ุธููุฑ bpftrace). <br><br><img src="https://habrastorage.org/webt/io/km/zq/iokmzq2fmqyechm1boqeks-w2za.png"><br>  <i>ูุธุงู ููููุณ ุชุชุจุน ุงููุธุงู ุงูุจูุฆู ุงูุฐู ูุตูุชู ุฌูููุง ุฅููุงูุฒ</i> <br><br>  ููุณุช ูู ุงูุนูุงุตุฑ ูุชุณุงููุฉ ูู ุงูุฃูููุฉ.  ุงุณูุญูุง ูู ุฃู ุฃูุฎุต ุจุฅูุฌุงุฒ ุงูุนูุงุตุฑ ุงูุชู ุฃุนุชุจุฑูุง ุฃูู. <br><br>  <b>ูุตุงุฏุฑ ุงูุญุฏุซ</b> <br><br>  ูููู ุฃู ุชุฃุชู ุจูุงูุงุช ุงูุฃุญุฏุงุซ ุฅูุง ูู ูุณุงุญุฉ ุงููุณุชุฎุฏู ุฃู ุงูููุงุฉ (ุงูุชุทุจููุงุช ูุงูููุชุจุงุช).  ุจุนุถูุง ูุชุงุญ ุชููุงุฆููุง ุ ุฏูู ุจุฐู ุฌููุฏ ุฅุถุงููุฉ ูููุทูุฑ ุ ุจูููุง ูุญุชุงุฌ ุงูุจุนุถ ุงูุขุฎุฑ ุฅูู ุงูุฅุนูุงู ุงููุฏูู. <br><br><img src="https://habrastorage.org/webt/2t/xm/mm/2txmmm6rz5xfcwcglsxy8zopr6q.jpeg"><br>  <i>ูุธุฑุฉ ุนุงูุฉ ุนูู ุฃูู ูุตุงุฏุฑ ุงูุฃุญุฏุงุซ ุงููุชุนูุจุฉ ูู Linux</i> <br><br>  ุนูู ุฌุงูุจ kernel ุ ุชูุฌุฏ kprobes ( <i>ูู "probes kernel" ุ "kernel sensor" ุ ุชูุฑูุจูุง ููู.</i> ) - ููู ุขููุฉ ุชุณูุญ ูู ุจุชุชุจุน ุฃู ููุงููุฉ ูุธููุฉ ุฏุงุฎู kernel.  ูุน ุฐูู ุ ููููู ุชุชุจุน ููุณ ููุท ุงููุธุงู ูุฏุนู ุฃููุณูู ุ ูููู ุฃูุถุง ูุง ูุญุฏุซ ุฏุงุฎููุง (ูุฃู ููุงุท ุฏุฎูู ููุงููุงุช ุงููุธุงู ุงุณุชุฏุนุงุก ูุธุงุฆู ุฏุงุฎููุฉ ุฃุฎุฑู).  ููููู ุฃูุถูุง ุงุณุชุฎุฏุงู kprobes ูุชุชุจุน ุฃุญุฏุงุซ kernel ุงูุชู ููุณุช ููุงููุงุช ุงููุธุงู ุ ุนูู ุณุจูู ุงููุซุงู ุ "ุชุชู ูุชุงุจุฉ ุงูุจูุงูุงุช ุงููุฎุฒูุฉ ูุคูุชูุง ุนูู ุงููุฑุต" ุฃู "ูุชู ุฅุฑุณุงู ุญุฒูุฉ TCP ุนุจุฑ ุงูุดุจูุฉ" ุฃู "ุชุจุฏูู ุงูุณูุงู ููุฏ ุงูุชูุฏู". <br><br>  ุชุณูุญ ููุงุท ุชุชุจุน Kernel ุจุชุชุจุน ุงูุฃุญุฏุงุซ ุบูุฑ ุงูููุงุณูุฉ ุงููุนุฑูุฉ ูู ูุจู ูุทูุฑู kernel.  ูุฐู ุงูุฃุญุฏุงุซ ููุณุช ุนูู ูุณุชูู ุงุณุชุฏุนุงุกุงุช ุงููุธุงุฆู.  ูุฅูุดุงุก ูุซู ูุฐู ุงูููุงุท ุ ูุถุน ูุทูุฑู kernel ูุฏูููุง ุงููุงูุฑู TRACE_EVENT ูู ุฑูุฒ kernel. <br><br>  ููุง ุงููุตุงุฏุฑ ููุง ุฅูุฌุงุจูุงุช ูุณูุจูุงุช.  Kprobes ูุนูู "ุชููุงุฆูุง" ู  ูุง ูุชุทูุจ ูู ูุทูุฑู kernel ุฑูุฒ ุงูููุฏ ูุฏูููุง.  ูููู ูููู ุฃู ุชุชุบูุฑ ุฃุญุฏุงุซ kprobe ุจุดูู ุชุนุณูู ูู ุฅุตุฏุงุฑ ูุงุญุฏ ูู ุงูููุงุฉ ุฅูู ุฃุฎุฑู ุ ูุฃู ุงููุธุงุฆู ุชุชุบูุฑ ุจุงุณุชูุฑุงุฑ - ูุชู ุฅุถุงูุชูุง ุฃู ุญุฐููุง ุฃู ุฅุนุงุฏุฉ ุชุณููุชูุง. <br><br>  ุชููู ููุงุท ุชุชุจุน Kernel ุนููููุง ุฃูุซุฑ ุซุจุงุชูุง ุจูุฑูุฑ ุงูููุช ููุฏ ุชููุฑ ูุนูููุงุช ูููุฏุฉ ููุณูุงู ูุฏ ูุง ุชููู ูุชุงุญุฉ ูู ุญุงูุฉ ุงุณุชุฎุฏุงู kprobes.  ุจุงุณุชุฎุฏุงู kprobes ุ ููููู ุงููุตูู ุฅูู ูุณูุทุงุช ุงุณุชุฏุนุงุก ุงููุธููุฉ.  ูููู ุจูุณุงุนุฏุฉ ููุงุท ุงูุชุชุจุน ุ ููููู ุงูุญุตูู ุนูู ุฃู ูุนูููุงุช ููุฑุฑ ุงููุทูุฑ kernel ูุตููุง ูุฏูููุง. <br><br>  ูู ูุณุงุญุฉ ุงููุณุชุฎุฏู ุ ููุฌุฏ ุชูุงุธุฑ ุจูู kprobes ู urobes.  ููู ูุตููุฉ ูุชุชุจุน ุงูููุงููุงุช ูุธููุฉ ูู ูุณุงุญุฉ ุงููุณุชุฎุฏู. <br><br>  ุฃุฌูุฒุฉ ุงุณุชุดุนุงุฑ USDT ("ุขุซุงุฑ ูุณุงุญุฉ ุงููุณุชุฎุฏู ุงููุญุฏุฏุฉ ุจุดูู ุซุงุจุช") ูู ุชูุซูููุฉ ูููุงุท ุงูุชุชุจุน kernel ูู ูุณุงุญุฉ ุงููุณุชุฎุฏู.  ูุญุชุงุฌ ูุทูุฑู ุงูุชุทุจููุงุช ุฅูู ุฅุถุงูุฉ ูุณุชุดุนุฑุงุช USDT ูุฏูููุง ุฅูู ุงูููุฏ ุงูุฎุงุต ุจูู. <br><br>  ุญูููุฉ ูุซูุฑุฉ ููุงูุชูุงู: ููุฏ ููุฑุช DTrace ููุฐ ูุชุฑุฉ ุทูููุฉ ูุงุฌูุฉ ุจุฑูุฌุฉ ุงูุชุทุจููุงุช (API) ูุชุญุฏูุฏ ุงูุชูุงุซู ุงูุฎุงุต ุจูุง ููุณุชุดุนุฑุงุช USDT (ุจุงุณุชุฎุฏุงู ุงููุงูุฑู DTRACE_PROBE).  ูุฑุฑ ูุทูุฑู ูุธุงู ุงูุชุชุจุน ุนูู ูุธุงู Linux ุชุฑู ุงูููุฏ ุงููุตุฏุฑู ูุชูุงูููุง ูุน ูุงุฌูุฉ ุจุฑูุฌุฉ ุงูุชุทุจููุงุช ูุฐู ุ ูุจุงูุชุงูู ูุชู ุชุญููู ุฃู ูุญุฏุงุช ูุงูุฑู DTRACE_PROBE ุชููุงุฆููุง ุฅูู ูุณุชุดุนุฑุงุช USDT! <br><br>  ูุฐูู ุ ูู ุงููุงุญูุฉ ุงููุธุฑูุฉ ุ ูููู ุชูููุฐ ุงูุดุฑุงุฆุท ุจุงุณุชุฎุฏุงู kprobes ุ ููููู ุชูููุฐ ltrace ุจุงุณุชุฎุฏุงู uprobes.  ูุณุช ูุชุฃูุฏูุง ููุง ุฅุฐุง ูุงูุช ูุฐู ุชูุงุฑุณ ุจุงููุนู ุฃู ูุง. <br><br>  <b>ูุงุฌูุงุช</b> <br><br>  ูุงุฌูุงุช ูู ุงูุชุทุจููุงุช ุงูุชู ุชุณูุญ ูููุณุชุฎุฏููู ุจุณูููุฉ ุงุณุชุฎุฏุงู ูุตุงุฏุฑ ุงูุญุฏุซ. <br><br>  ุฏุนููุง ููุธุฑ ูู ููููุฉ ุนูู ูุตุงุฏุฑ ุงูุญุฏุซ.  ุณูุฑ ุงูุนูู ุนูู ุงููุญู ุงูุชุงูู: <br><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ููุซู kernel ุขููุฉ - ุนุงุฏุฉู ููู / proc ุฃู / sys ููุชูุญูุง ูููุชุงุจุฉ - ูุณุฌู ูู ูู ููุฉ ุชุชุจุน ุงูุญุฏุซ ููุง ูุฌุจ ุฃู ูุชุจุน ุงูุญุฏุซ. </li><li style=";text-align:right;direction:rtl">  ุจุนุฏ ุงูุชุณุฌูู ุ ูููู kernel ุจุชุฑุฌูุฉ kernel / function ูู ุงูุฐุงูุฑุฉ / ููุงุท ุงูุชุชุจุน / ูุฌุณุงุช USDT ูุชุบููุฑ ุงูููุฏ ุงูุฎุงุต ุจูู ุญุชู ูุญุฏุซ ุดูุก ุขุฎุฑ. </li><li style=";text-align:right;direction:rtl">  ูููู ุฌูุน ูุชูุฌุฉ "ุดูุก ุขุฎุฑ" ูุงุญููุง ุจุงุณุชุฎุฏุงู ุจุนุถ ุงูุขููุงุช. </li></ol><br>  ูุง ุฃุฑูุฏ ุฃู ุฃูุนู ูู ูุฐุง ูุฏูููุง!  ูุฐูู ุ ุชุฃุชู ุงูุณุทูุญ ุงูุจูููุฉ: ููู ุชูุนู ูู ุฐูู ูู ุฃุฌูู. <br><br>  ููุงู ูุงุฌูุงุช ููู ุฐูู ูููู.  ูู ูุฌุงู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงููุงุฌูุงุช ุงููุณุชูุฏุฉ ุฅูู eBPF ุ</a> ููุงู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุงุฌูุงุช</a> ููุฎูุถุฉ ุงููุณุชูู ุชุชุทูุจ ููููุง ุนููููุง ูููููุฉ ุงูุชูุงุนู ูุน ูุตุงุฏุฑ ุงูุฃุญุฏุงุซ ูููููุฉ ุนูู ููุฏ eBPF bytecode.  ูููุงู ูุณุชูู ุนุงูู ูุณูู ุงูุชุดุบูู ุ ุนูู ุงูุฑุบู ูู ุฃููุง ูู ุชูุธูุฑ ูุฑููุฉ ูุจูุฑุฉ ุฃุซูุงุก ูุฌูุฏูุง. <br><br>  ููุฐุง ุงูุณุจุจ ูุฅู bpftrace - ุฃุญุฏุซ ูุงุฌูุฉ - ูู ุงูููุถูุฉ ูุฏู.  ุงููุง ุณููุฉ ุงูุงุณุชุฎุฏุงู ููุฑูุฉ ูุซู DTrace.  ูููู ุฌุฏูุฏ ุชูุงููุง ููุชุทูุจ ุชูููุนูุง. <br><br><h3 style=";text-align:right;direction:rtl">  eBPF </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">eBPF</a> ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุฌู ุชุชุจุน Linux ุงูุฌุฏูุฏ</a> ุงูุฐู ุชููู ุนููู bpftrace.  ุนูุฏูุง ุชุชุนูุจ ุญุฏุซูุง ุ ูุฃูุช ุชุฑูุฏ ุญุฏูุซ ุดูุก ูุง ูู ุงูููุงุฉ.  ููู ุทุฑููุฉ ูุฑูุฉ ูุชุญุฏูุฏ ูุง ูู ูุฐุง "ุดูุก"ุ  ุจุงูุทุจุน ุ ุจุงุณุชุฎุฏุงู ูุบุฉ ุงูุจุฑูุฌุฉ (ุฃู ุจุงุณุชุฎุฏุงู ุฑูุฒ ุงูุฌูุงุฒ). <br><br>  eBPF (ูุณุฎุฉ ูุญุณูุฉ ูู ูุฑุดุญ ุญุฒู Berkeley).  ูุฐุง ุฌูุงุฒ ุธุงูุฑู ุนุงูู ุงูุฃุฏุงุก ูุนูู ูู kernel ููุญุชูู ุนูู ุงูุฎุตุงุฆุต / ุงููููุฏ ุงูุชุงููุฉ: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุชุญุฏุซ ุฌููุน ุชูุงุนูุงุช ูุณุงุญุฉ ุงููุณุชุฎุฏู ูู ุฎูุงู "ุจุทุงูุงุช" eBPF ุ ููู ุนุจุงุฑุฉ ุนู ุชุฎุฒูู ุจูุงูุงุช ุฐู ูููุฉ ููุชุงุญ. </li><li style=";text-align:right;direction:rtl">  ูุง ุชูุฌุฏ ุฏูุฑุงุช ุจุญูุซ ููุชูู ูู ุจุฑูุงูุฌ eBPF ูู ููุช ูุญุฏุฏ. </li><li style=";text-align:right;direction:rtl">  ุงูุชุธุฑ ุ ูููุง Batch Filterุ  ุฃูุช ุนูู ุญู: ููุฏ ุชู ุชุตููููุง ูู ุงูุฃุตู ูุชุตููุฉ ุญุฒู ุงูุดุจูุฉ.  ูุฐู ูููุฉ ูุดุงุจูุฉ: ุนูุฏ ุฅุนุงุฏุฉ ุชูุฌูู ุงูุญุฒู (ุญุฏูุซ ุญุฏุซ) ุ ููุฒูู ุชูููุฐ ุจุนุถ ุงูุฅุฌุฑุงุกุงุช ุงูุฅุฏุงุฑูุฉ (ูุจูู ุฃู ุชุฌุงูู ุฃู ุชุนููู ุฃู ุฅุนุงุฏุฉ ุชูุฌูู ุญุฒูุฉ ุ ููุง ุฅูู ุฐูู). ุชู ุงุฎุชุฑุงุน ุฌูุงุฒ ุงูุชุฑุงุถู ูุชุณุฑูุน ูุฐู ุงูุฅุฌุฑุงุกุงุช (ูุน ุฅููุงููุฉ JIT) ุชุฌููุน).  ุชุนุชุจุฑ ุงููุณุฎุฉ "ุงูููุณุนุฉ" ูุธุฑูุง ูุญูููุฉ ุฃูู ุ ููุงุฑูุฉู ุจุงูุฅุตุฏุงุฑ ุงูุฃุตูู ูู ูุฑุดุญ ุญุฒู Berkeley ุ ูููู ุงุณุชุฎุฏุงู eBPF ุฎุงุฑุฌ ุณูุงู ุงูุดุจูุฉ. </li></ul><br>  ูุง ุฃูุช ุฐุง.  ุจุงุณุชุฎุฏุงู bpftrace ุ ููููู ุชุญุฏูุฏ ุงูุฃุญุฏุงุซ ุงูุชู ูุฌุจ ุชุชุจุนูุง ููุง ุงูุฐู ูุฌุจ ุฃู ูุญุฏุซ ูู ุงูุงุณุชุฌุงุจุฉ.  ูููู Bpftrace ุจุชุฌููุน ุจุฑูุงูุฌ bpftrace ุนุงูู ุงููุณุชูู ุงูุฎุงุต ุจู ุฅูู eBPF bytecode ุ ููุชุชุจุน ุงูุฃุญุฏุงุซ ุ ููููู ุจุชุญููู ุงูููุฏ ุงูุซุงูู ูู kernel. <br><br><h3 style=";text-align:right;direction:rtl">  ุงูุฃูุงู ุงููุธููุฉ ูุจู eBPF </h3><br>  ูุจู eBPF ุ ูุงูุช ุฎูุงุฑุงุช ุงูุญู ุ ุจุนุจุงุฑุฉ ููุทูุฉ ุ ูุญุฑุฌุฉ.  ูุนุฏ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">SystemTap</a> ุฌุฒุกูุง ูู ุงูุณูู "ุงูุฃูุซุฑ ุฎุทูุฑุฉ" ูู bpftrace ูู ุนุงุฆูุฉ Linux.  ูุชู ุชุฑุฌูุฉ ุงูุจุฑุงูุฌ ุงููุตูุฉ SystemTap ุฅูู ุงููุบุฉ C ูุชุญููููุง ูู kernel ููุญุฏุงุช ููุทูุฉ.  ุซู ูุชู ุชุญููู ูุญุฏุฉ ุงูููุงุฉ ุงููุงุชุฌุฉ. <br><br>  ูุงู ูุฐุง ุงูููุฌ ูุดูุง ููุบุงูุฉ ูุณูุก ุงูุฏุนู ุฎุงุฑุฌ ุฑูุฏ ูุงุช ุฅูุชุฑุจุฑุงูุฒ ูููููุณ.  ุจุงููุณุจุฉ ูู ุ ูู ูุนูู ุจุดูู ุฌูุฏ ุนูู Ubuntu ุ ูุงูุฐู ูุงู ูููู ุฅูู ูุณุฑ SystemTap ุนูู ูู ุชุญุฏูุซ kernel ุจุณุจุจ ุชุบููุฑ ูู ุจููุฉ ุจูุงูุงุช kernel.  ูููุงู ุฃูุถูุง ุฃูู ูู ุงูุฃูุงู ุงูุฃููู ูู ูุฌูุฏู ุ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุฃุฏู</a> SystemTap <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุจุณูููุฉ ุฅูู</a> ููุจุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูุฐุนุฑ</a> . <br><br><h3 style=";text-align:right;direction:rtl">  ุชุฑููุจ Bpftrace </h3><br>  ุญุงู ุงูููุช ููุดูุฑ ุนู ุณูุงุนุฏู!  ูู ูุฐุง ุงูุฏููู ุ ุณููุธุฑ ูู ุชุซุจูุช bpftrace ุนูู Ubuntu 18.04.  ุงูุฅุตุฏุงุฑุงุช ุงูุฃุญุฏุซ ูู ุงูุชูุฒูุน ุบูุฑ ูุฑุบูุจ ูููุง ุ ูุฃู  ุฃุซูุงุก ุงูุชุซุจูุช ุ ุณูุญุชุงุฌ ุฅูู ุญุฒู ูู ูุชู ุชุฌููุนูุง ุจุนุฏ. <br><br>  <b>ุชุฑููุจ ุงูุชุจุนูุฉ</b> <br><br>  ุฃููุงู ุ ูู ุจุชุซุจูุช Clang 5.0 ู lbclang 5.0 ู LLVM 5.0 ุ ุจูุง ูู ุฐูู ุฌููุน ูููุงุช ุงูุฑุฃุณ.  ุณูุณุชุฎุฏู ุงูุญุฒู ุงูุชู ุชููุฑูุง llvm.org ุ ูุฃู ุงูุญุฒู ุงูููุฌูุฏุฉ ูู ูุณุชูุฏุนุงุช Ubuntu ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุดููุฉ</a> . <br><br><pre style=";text-align:right;direction:rtl"><code class="plaintext hljs">wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add - cat &lt;&lt;EOF | sudo tee -a /etc/apt/sources.list deb http://apt.llvm.org/xenial/ llvm-toolchain-xenial main deb-src http://apt.llvm.org/xenial/ llvm-toolchain-xenial main deb http://apt.llvm.org/xenial/ llvm-toolchain-xenial-5.0 main deb-src http://apt.llvm.org/xenial/ llvm-toolchain-xenial-5.0 main EOF sudo apt update sudo apt install clang-5.0 libclang-5.0-dev llvm-5.0 llvm-5.0-dev</code> </pre> <br>  ุงูุชุงูู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">sudo apt install bison cmake flex g++ git libelf-dev zlib1g-dev libfl-dev</code> </pre> <br>  ูุฃุฎูุฑูุง ุ ูู ุจุชุซุจูุช libbfcc-dev ูู ุงูููุจุน ุ ูููุณ ูู ูุณุชูุฏุน Ubuntu.  ูุง <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุชูุฌุฏ ูููุงุช ุฑุฃุณ</a> ูู ุงูุญุฒูุฉ ุงูููุฌูุฏุฉ ูู ุฃูุจููุชู.  ููุฐู ุงููุดููุฉ ูู ุชุญู ุญุชู ุงูุณุงุนุฉ 18.10. <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 4052245BD4284CDD echo "deb https://repo.iovisor.org/apt/$(lsb_release -cs) $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/iovisor.list sudo apt update sudo apt install bcc-tools libbcc-examples linux-headers-$(uname -r)</code> </pre> <br>  <b>Bpftrace ุงูุชุซุจูุช ุงูุฑุฆูุณู</b> <br><br>  ุญุงู ุงูููุช ูุชุซุจูุช bpftrace ููุณู ูู ุงููุตุฏุฑ!  ุฏุนููุง ุงุณุชูุณุงุฎูุง ูุชุฌููุนูุง ูุชุซุจูุชูุง ูู / usr / local: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">git clone https://github.com/iovisor/bpftrace cd bpftrace mkdir build &amp;&amp; cd build cmake -DCMAKE_BUILD_TYPE=DEBUG .. make -j4 sudo make install</code> </pre> <br>  ูุงูุชููุช!  ุณูุชู ุชุซุจูุช ุงูููู ุงูุชูููุฐู ูู / usr / local / bin / bpftrace.  ููููู ุชุบููุฑ ุงููุฌูุฉ ุจุงุณุชุฎุฏุงู ูุณูุทุฉ cmake ุ ูุงูุชู ุชุจุฏู ููุฐุง ุงูุชุฑุงุถููุง: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">DCMAKE_INSTALL_PREFIX=/usr/local.</code> </pre> <br>  <b>ุฃูุซูุฉ ุณุทุฑ ูุงุญุฏ</b> <br><br>  ุฏุนูุง ูุฏูุฑ ุจุนุถ bpftrace ุฃุญุงุฏูุฉ ุงูุณุทุญ ูููู ูุฏุฑุงุชูุง.  ุฃุฎุฐุช ูุฐู ูู <a href="">ุฏููู ุจุฑููุฏุงู ุฌุฑูุฌ</a> ุ ุงูุฐู ูุญุชูู ุนูู ูุตู ููุตู ููู ูููู. <br><br>  # 1.ุนุฑุถ ูุงุฆูุฉ ูู ุฃุฌูุฒุฉ ุงูุงุณุชุดุนุงุฑ <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">bpftrace -l 'tracepoint:syscalls:sys_enter_*'</code> </pre> <br>  # 2.ุงูุชูุงูู <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">bpftrace -e 'BEGIN { printf("hello world\n"); }'</code> </pre> <br>  # 3.ูุชุญ ููู <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">bpftrace -e 'tracepoint:syscalls:sys_enter_open { printf("%s %s\n", comm, str(args-&gt;filename)); }'</code> </pre> <br>  # 4.ุนุฏุฏ ููุงููุงุช ุงููุธุงู ููู ุนูููุฉ <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">bpftrace -e 'tracepoint:raw_syscalls:sys_enter { @[comm] = count(); }'</code> </pre> <br>  # 5.ุชูุฒูุน ููุงููุงุช ุงููุฑุงุกุฉ () ุญุณุจ ุนุฏุฏ ุงูุจุงูุชุงุช <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">bpftrace -e 'tracepoint:syscalls:sys_exit_read /pid == 18644/ { @bytes = hist(args-&gt;retval); }'</code> </pre> <br>  # 6.ุชุชุจุน ุฏููุงูููู ูููุฑุงุกุฉ () ุงููุญุชูู <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">bpftrace -e 'kretprobe:vfs_read { @bytes = lhist(retval, 0, 2000, 200); }'</code> </pre> <br>  # 7.ุงูููุช ุงูุฐู ููุถูู ูู ูุฑุงุกุฉ () ุงูููุงููุงุช <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">bpftrace -e 'kprobe:vfs_read { @start[tid] = nsecs; } kretprobe:vfs_read /@start[tid]/ { @ns[comm] = hist(nsecs - @start[tid]); delete(@start[tid]); }'</code> </pre> <br>  # 8.ุนุฏ ุงูุฃุญุฏุงุซ ูุณุชูู ุงูุนูููุฉ <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">bpftrace -e 'tracepoint:sched:sched* { @[name] = count(); } interval:s:5 { exit(); }'</code> </pre> <br>  # 9.ูุญุงุช ุงูุชูููุท ูุฏุงุฎู ุงูุนูู <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">bpftrace -e 'profile:hz:99 { @[stack] = count(); }'</code> </pre> <br>  # 10. ูุฎุทุท ุงูุชุชุจุน <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">bpftrace -e 'tracepoint:sched:sched_switch { @[stack] = count(); }'</code> </pre> <br>  # 11.ุชุชุจุน ุนุฑููุฉ I / O <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">bpftrace -e 'tracepoint:block:block_rq_complete { @ = hist(args-&gt;nr_sector * 512); }'</code> </pre> <br>  ุชุญูู ูู ูููุน Brendan Gregg ููุนุฑูุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุน ุงููุฎุฑุฌุงุช ุงูุชู ูููู ุฃู ุชูุชุฌูุง ุงููุฑู ุงููุฐููุฑุฉ ุฃุนูุงู</a> . <br><br>  <b>ุจูุงุก ุฌููุฉ ุงูุจุฑูุงูุฌ ุงููุตู ููุซุงู ุชูููุช ุงูุฅุฏุฎุงู / ุงูุฅุฎุฑุงุฌ</b> <br><br>  ุงูุณูุณูุฉ ุงูุชู ูุชู ุชูุฑูุฑูุง ุนุจุฑ ุฑูุฒ ุงูุชุจุฏูู '-e' ูู ูุญุชููุงุช ุงูุจุฑูุงูุฌ ุงููุตู bpftrace.  ุจูุงุก ุงูุฌููุฉ ูู ูุฐู ุงูุญุงูุฉ ูู ุ ุจุดูู ูุดุฑูุท ุ ูุฌููุนุฉ ูู ุงูุฅูุดุงุกุงุช: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">&lt;event source&gt; /&lt;optional filter&gt;/ { &lt;program body&gt; }</code> </pre> <br>  ุฏุนููุง ูููู ูุธุฑุฉ ุนูู ุงููุซุงู ุงูุณุงุจุน ุ ุญูู ุชูููุช ุนูููุงุช ูุฑุงุกุฉ ูุธุงู ุงููููุงุช: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">kprobe:vfs_read { @start[tid] = nsecs; } &lt;- 1 -&gt;&lt;-- 2 -&gt; &lt;---------- 3 ---------&gt;</code> </pre> <br>  ูุญู ูุชุชุจุน ุงูุญุฏุซ ูู ุขููุฉ <i>kprobe</i> ุ ุนูู ุณุจูู ุงููุซุงู ุ ูุญู ูุชุชุจุน ุจุฏุงูุฉ ูุธููุฉ kernel. <br>  ุฅู ูุธููุฉ kernel ููุชุชุจุน ูู <i>vfs_read</i> ุ <i>ูุชุณูู</i> ูุฐู ุงููุธููุฉ ุนูุฏูุง ุชููู kernel ุจุฅุฌุฑุงุก ุนูููุฉ ูุฑุงุกุฉ ูู ูุธุงู ุงููููุงุช (VFS ูู "Virtual FileSystem" ุ ุงูุชุฌุฑูุฏ ูู ูุธุงู ุงููููุงุช ุฏุงุฎู kernel). <br><br>  ุนูุฏูุง ูุจุฏุฃ <i>ุชูููุฐ vfs_read</i> (ุฃู ูุจู ุฃู ุชููู ุงููุธููุฉ ุจุฃู ุนูู ูููุฏ) ุ ูุจุฏุฃ ุจุฑูุงูุฌ bpftrace.  ุฅูู ูุญูุธ ุงูุทุงุจุน ุงูุฒููู ุงูุญุงูู (ุจุงููุงููุซุงููุฉ) ููุฌููุนุฉ ูุตูููุฉ ุนุงูููุฉ ุชุณูู <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" class="user_link">st</a> art</i> .  ุงูููุชุงุญ ูู <i>tid</i> ุ ูู ุฅุดุงุฑุฉ ุฅูู ูุนุฑู ูุคุดุฑ ุงูุชุฑุงุจุท ุงูุญุงูู. <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">kretprobe:vfs_read /@start[tid]/ { @ns[comm] = hist(nsecs - @start[tid]); delete(@start[tid]); } &lt;-- 1 --&gt; &lt;-- 2 -&gt; &lt;---- 3 ----&gt; &lt;----------------------------- 4 -----------------------------&gt;</code> </pre> <br>  1. ูููู ุจุชุชุจุน ุงูุญุฏุซ ูู ุขููุฉ <i>kretprobe</i> ุ ุงูุชู ุชุดุจู <i>kprobe</i> ุ ูููุง ุนุฏุง ูุง ูุทูู ุนููู ุนูุฏูุง ุชุฑุฌุน ุงูุฏุงูุฉ ูุชูุฌุฉ ุชูููุฐู. <br><br>  2. ูุธููุฉ kernel ููุชุชุจุน ูู <i>vfs_read</i> . <br><br>  3. ูุฐุง ูู ูุฑุดุญ ุงุฎุชูุงุฑู.  ูุชุญูู ูุง ุฅุฐุง ูุงู ูุฏ ุชู ุชุณุฌูู ููุช ุงูุจุฏุก ูุณุจูุงู.  ุจุฏูู ูุฐุง ุงููุฑุดุญ ุ ูููู ุชุดุบูู ุงูุจุฑูุงูุฌ ุฃุซูุงุก ุงููุฑุงุกุฉ <i>ูุงูุชูุงุท</i> ุงูููุงูุฉ ููุท ุ ููุง ูุคุฏู ุฅูู ููุช <i>nsecs ููุฏูุฑ - 0</i> ุ ุจุฏูุงู ูู <i>nsecs - ูุจุฏุฃ</i> . <br><br>  4. ูุต ุงูุจุฑูุงูุฌ. <br><br>  <i>ุชุญุณุจ nsecs - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" class="user_link">st</a> art [tid]</i> ููุฏุงุฑ ุงูููุช ุงูุฐู ุงููุถู ููุฐ ุจุฏุก ูุธููุฉ vfs_read. <br>  <i>ูุถููns [comm] = hist (...)</i> ุงูุจูุงูุงุช ุงููุญุฏุฏุฉ ุฅูู ุงูุฑุณู ุงูุจูุงูู ุซูุงุฆู ุงูุฃุจุนุงุฏ ุงููุฎุฒู ูู <i>ns</i> .  ูุดูุฑ ุงูููุชุงุญ <i>comm</i> ุฅูู ุงุณู ุงูุชุทุจูู ุงูุญุงูู.  ูุฐูู ุณูููู ูุฏููุง ุฃูุฑ ุงููุฏุฑุฌ ุงูุฅุญุตุงุฆู ุนู ุทุฑูู ุงูุฃูุฑ. <br><br>  <i>ุญุฐู (...)</i> ูุญุฐู ููุช ุงูุจุฏุก ูู ุงููุตูููุฉ ุงูุชุฑุงุจุทูุฉ ุ ูุฃููุง ูู ูุนุฏ ุจุญุงุฌุฉ ุฅูููุง. <br><br>  ูุฐุง ูู ุงูุงุณุชูุชุงุฌ ุงูููุงุฆู.  ูุฑุฌู ููุงุญุธุฉ ุฃู ุฌููุน ุงูุฑุณูู ุงูุจูุงููุฉ ูุชู ุนุฑุถูุง ุชููุงุฆูุง.  ุงูุงุณุชุฎุฏุงู ุงููุงุถุญ ูุฃูุฑ ุทุจุงุนุฉ ุงูุฑุณู ุงูุจูุงูู ุบูุฑ ูุทููุจ.  <i>ns</i> ููุณ ูุชุบูุฑูุง ุฎุงุตูุง ุ ูุฐูู ูุง ูุชู ุนุฑุถ ุงูุฑุณู ุงูุจูุงูู ุจุณุจุจู. <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">@ns[snmp-pass]: [0, 1] 0 | | [2, 4) 0 | | [4, 8) 0 | | [8, 16) 0 | | [16, 32) 0 | | [32, 64) 0 | | [64, 128) 0 | | [128, 256) 0 | | [256, 512) 27 |@@@@@@@@@ | [512, 1k) 125 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ | [1k, 2k) 22 |@@@@@@@ | [2k, 4k) 1 | | [4k, 8k) 10 |@@@ | [8k, 16k) 1 | | [16k, 32k) 3 |@ | [32k, 64k) 144 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@| [64k, 128k) 7 |@@ | [128k, 256k) 28 |@@@@@@@@@@ | [256k, 512k) 2 | | [512k, 1M) 3 |@ | [1M, 2M) 1 | |</code> </pre> <br><br>  <b>ูุซุงู ุงุณุชุดุนุงุฑ USDT</b> <br><br>  ููุฃุฎุฐ ูุฐุง ุงูุฑูุฒ C ูุญูุธู ูู ููู <i>tracetest.c</i> : <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">#include &lt;sys/sdt.h&gt; #include &lt;sys/time.h&gt; #include &lt;unistd.h&gt; #include &lt;stdio.h&gt; static long myclock() { struct timeval tv; gettimeofday(&amp;tv, NULL); DTRACE_PROBE1(tracetest, testprobe, tv.tv_sec); return tv.tv_sec; } int main(int argc, char **argv) { while (1) { myclock(); sleep(1); } return 0; }</code> </pre> <br>  ูุนูู ูุฐุง ุงูุจุฑูุงูุฌ ุฅูู ูุง ูุง ููุงูุฉ ุนู ุทุฑูู ุงุณุชุฏุนุงุก <i>myclock ()</i> ูุฑุฉ ูุงุญุฏุฉ ูู ุงูุซุงููุฉ.  <i>ูุณุชุนูู myclock ()</i> ุงูููุช ุงูุญุงูู ููุนูุฏ ุนุฏุฏ ุงูุซูุงูู ููุฐ ุจุฏุงูุฉ ุงูุนุตุฑ. <br><br>  ุชุญุฏุฏ ุงูุฏุนูุฉ ุฅูู <i>DTRACE_PROBE1</i> ููุง ููุทุฉ ุชุชุจุน <i>USDT</i> ุซุงุจุชุฉ. <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูุชู ุฃุฎุฐ ุงููุงูุฑู <i>DTRACE_PROBE1</i> ูู <i>sys / sdt.h.</i>  ููุทูู ุนูู ูุงูุฑู USDT ุงูุฑุณูู ุ ุงูุฐู ููุนู ุงูุดูุก ููุณู ุ <i>STAP_PROBE1</i> (STAP ูู SystemTap ุ ูุงูุฐู ูุงู ุฃูู ุขููุฉ Linux ูุฏุนููุฉ ูู USDT).  ูููู ูุธุฑูุง ูุฃู USDT ูุชูุงูู ูุน ุฃุฌูุฒุฉ ุงุณุชุดุนุงุฑ ูุณุงุญุฉ ูุณุชุฎุฏู <i>DTrace</i> ุ ูุฅู <i>DTRACE_PROBE1</i> ูู ูุฌุฑุฏ ุฅุดุงุฑุฉ ุฅูู <i>STAP_PROBE1</i> . </li><li style=";text-align:right;direction:rtl">  ุงููุนููุฉ ุงูุฃููู ูู ุงุณู ุงููููุฑ.  ุฃุนุชูุฏ ุฃู ูุฐุง ุจูุงูุง ุฃุซุฑูุฉ ูู DTrace ุ ูุฃู bpftrace ูุง ูุจุฏู ุฃูู ููุนู ุฃู ุดูุก ูููุฏ ูุนูุง.  ููุน ุฐูู ุ ููุงู ูุงุฑู ุจุณูุท ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูุชุดูุชู ุนูุฏ ุชุตุญูุญ ุงููุดููุฉ ุนูุฏ ุงูุทูุจ 328</a> ): ูุฌุจ ุฃู ูููู ุงุณู ุงููููุฑ ูุทุงุจููุง ูุงุณู ุงูููู ุงูุซูุงุฆู ููุชุทุจูู ุ ูุฅูุง ููู ูุชููู bpftrace ูู ุงูุนุซูุฑ ุนูู ููุทุฉ ุงูุชุชุจุน. </li><li style=";text-align:right;direction:rtl">  ุงููุนููุฉ ุงูุซุงููุฉ ูู ุงุณู ููุทุฉ ุงูุชุชุจุน. </li><li style=";text-align:right;direction:rtl">  ุฃู ูุนููุงุช ุฅุถุงููุฉ ูู ุงูุณูุงู ุงูููุฏู ูู ูุจู ุงููุทูุฑูู.  ุงูุฑูู <i>1</i> ูู <i>DTRACE_PROBE1</i> ูุนูู ุฃููุง ูุฑูุฏ ุชูุฑูุฑ ูุนููุฉ ุฅุถุงููุฉ ูุงุญุฏุฉ. </li></ul><br>  ุฏุนูุง ูุชุฃูุฏ ูู ุชููุฑ sys / sdt.h ููุง ุ ููุถุน ุงูุจุฑูุงูุฌ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">sudo apt install systemtap-sdt-dev gcc tracetest.c -o tracetest -Wall -g</code> </pre> <br>  ูุทูุจ bpftrace ูุฅุฎุฑุงุฌ PID ู "ุงูููุช ูู [ุงูุนุฏุฏ]" ูููุง <i>ุชู</i> ุงููุตูู ุฅูู <i>testprobe</i> : <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">sudo bpftrace -e 'usdt:/full-path-to/tracetest:testprobe { printf("%d: time is %d\n", pid, arg0); }'</code> </pre> <br>  ุชูุงุตู Bpftrace ุงูุนูู ุจูููุง ูุถุบุท ุนูู Ctrl-C.  ูุฐูู ุ ุงูุชุญ ูุญุทุฉ ุฌุฏูุฏุฉ ููู ุจุชุดุบูู <i>tracetest</i> ููุงู: <br><br>  # ูู ุงููุญุทุฉ ุงูุฌุฏูุฏุฉ <br>  . / ุงุฎุชุจุงุฑ <br><br>  ุงูุนูุฏุฉ ุฅูู ุงููุญุทุฉ ุงูุฃููู ูุน bpftrace ุ ููุงู ูุฌุจ ุฃู ุชุฑู ุดูุก ูุซู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">Attaching 1 probe... 30909: time is 1549023215 30909: time is 1549023216 30909: time is 1549023217 ... ^C</code> </pre> <br>  <b>ูุซุงู ุชุฎุตูุต ุงูุฐุงูุฑุฉ ุจุงุณุชุฎุฏุงู glibc ptmalloc</b> <br><br>  ูููููู ุงุณุชุฎุฏุงู bpftrace ูููู ููุงุฐุง ูุณุชุฎุฏู ุฑูุจู ุงููุซูุฑ ูู ุงูุฐุงูุฑุฉ.  ููุฌุฒุก ูู ุจุญุซู ุ ุฃุญุชุงุฌ ุฅูู ููู ููููุฉ ุงุณุชุฎุฏุงู ุฃุฏุงุฉ ุชุฎุตูุต ุงูุฐุงูุฑุฉ ุงูุฎุงุตุฉ ุจู glibc <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูููุงุทู ุงูุฐุงูุฑุฉ</a> . <br><br>  ูู ุฃุฌู ุชุญุณูู ุงูุฃุฏุงุก ูุชุนุฏุฏ ุงูููุงุฉ ุ ูุฎุตุต ูุฎุตุต ุฐุงูุฑุฉ glibc ุนุฏุฉ "ููุงุทู" ูู ูุธุงู ุงูุชุดุบูู.  ุนูุฏูุง ูุณุฃู ุงูุชุทุจูู ุนู ุชุฎุตูุต ุงูุฐุงูุฑุฉ ุ ูููู ุงูููุฎุตุต ุจุชุญุฏูุฏ ููุทูุฉ ุบูุฑ ูุณุชุฎุฏูุฉ ููููุฒ ุฌุฒุกูุง ูู ูุฐู ุงูููุทูุฉ ูู "ูุณุชุฎุฏู".  ูุธุฑูุง ูุฃู ุงูุฎููุท ุชุณุชุฎุฏู ูุณุงุญุงุช ูุฎุชููุฉ ุ ูุชู ุชูููู ุนุฏุฏ ุงูุฃููุงู ุ ููุง ูุคุฏู ุฅูู ุชุญุณูู ุงูุฃุฏุงุก ูุชุนุฏุฏ ุงูุฎููุท. <br><br>  ูููู ูุฐุง ุงูููุฌ ูููุฏ ุงููุซูุฑ ูู ุงูููุงูุฉ ุ ููุจุฏู ุฃู ูุฐุง ุงูุงุณุชููุงู ุงููุจูุฑ ููุฐุงูุฑุฉ ูู ุฑูุจู ูู ุจุงูุถุจุท ุจุณุจุจ ุฐูู.  ูู ุฃุฌู ููู ุทุจูุนุฉ ูุฐู ุงูููุงูุฉ ุจุดูู ุฃูุถู ุ ุชุณุงุกูุช: ูุง ูุนูู "ุงุฎุชูุงุฑ ููุทูุฉ ุบูุฑ ูุณุชุฎุฏูุฉ"ุ  ูุฐุง ูุฏ ูุนูู ูุงุญุฏุฉ ูู: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูู ูู ูุฑุฉ <i>ูุชู</i> ุงุณุชุฏุนุงุก <i>malloc ()</i> ุ ูุชูุฑูุฑ ุงูููุฒุน ูู ุฌููุน ุงูููุงุทู ููุฌุฏ ุงูููุทูุฉ ุบูุฑ ุงููุคูููุฉ ุญุงูููุง.  ูููุท ุฅุฐุง ุชู ุญุธุฑูู ุฌููุนูุง ุ ูุณูุญุงูู ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ. </li><li style=";text-align:right;direction:rtl">  ูู ุงููุฑุฉ ุงูุฃููู ุงูุชู <i>ูุชู ูููุง</i> ุงุณุชุฏุนุงุก <i>malloc ()</i> ุนูู ูุคุดุฑ ุชุฑุงุจุท ูุญุฏุฏ (ุฃู ุนูุฏ ุจุฏุก ุชุดุบูู ูุคุดุฑ ุงูุชุฑุงุจุท) ุ ุณูุฎุชุงุฑ ุงูููุฎุตุต ุงูุฎูุท ุบูุฑ ุงููุญุธูุฑ ุญุงูููุง.  ูุฅุฐุง ุชู ุญุธุฑูุง ุฌููุนูุง ุ ูุณูุญุงูู ุฅูุดุงุก ูุงุญุฏุฉ ุฌุฏูุฏุฉ. </li><li style=";text-align:right;direction:rtl">  ูู ุงููุฑุฉ ุงูุฃููู ุงูุชู <i>ูุชู ูููุง</i> ุงุณุชุฏุนุงุก <i>malloc ()</i> ุนูู ูุคุดุฑ ุชุฑุงุจุท ูุญุฏุฏ (ุฃู ุนูุฏ ุจุฏุก ุชุดุบูู ูุคุดุฑ ุงูุชุฑุงุจุท) ุ ุณูุญุงูู ุงูููุฎุตุต ุฅูุดุงุก ููุทูุฉ ุฌุฏูุฏุฉ ุ ุจุบุถ ุงููุธุฑ ุนูุง ุฅุฐุง ูุงูุช ููุงู ููุงุทู ุบูุฑ ูุคููุฉ.  ููุท ุฅุฐุง ุชุนุฐุฑ ุฅูุดุงุก ููุทูุฉ ุฌุฏูุฏุฉ (ุนูู ุณุจูู ุงููุซุงู ุ ุนูุฏ ุงุณุชููุงุฏ ุงูุญุฏ) ุ ูุณูุชู ุฅุนุงุฏุฉ ุงุณุชุฎุฏุงู ุงูููุทูุฉ ุงูุญุงููุฉ. </li><li style=";text-align:right;direction:rtl">  ุฑุจูุง ููุงู ุงููุฒูุฏ ูู ุงูุฎูุงุฑุงุช ุงูุชู ูู ุฃููุฑ ูููุง. </li></ul><br>  ูุง ุชูุฌุฏ ุฅุฌุงุจุฉ ูุญุฏุฏุฉ ูู ุงููุซุงุฆู ุ ุฃู ูู ูุฐู ุงูููุฒุงุช ุชุณูุญ ูู ุจุชุญุฏูุฏ ููุทูุฉ ุบูุฑ ูุณุชุฎุฏูุฉ.  ููุฏ ุฏุฑุณุช ุงูููุฏ ุงููุตุฏุฑู ูู glibc ุ ูุงูุฐู ุงูุชุฑุญ ุฃู ุงูุฎูุงุฑ 3 ููููู ุงูููุงู ุจู.  ููููู ุฃุฑุฏุช ุงูุชุญูู ุจุดูู ุชุฌุฑูุจู ูู ุฃููู ููุช ุจุชูุณูุฑ ุงูููุฏ ุงููุตุฏุฑู ุจุดูู ุตุญูุญ ุ ุฏูู ุงูุญุงุฌุฉ ุฅูู ุชุตุญูุญ ุงูููุฏ ูู glibc. <br><br>  ูุฐู ูู ูุธููุฉ ุชุฎุตูุต ุฐุงูุฑุฉ glibc ุงูุชู ุชูุดุฆ ูุณุงุญุฉ ุฌุฏูุฏุฉ.  ูููู ููููู ุฃู ุชุณูููุง ููุท ุจุนุฏ ุงูุชุญูู ูู ุงูุญุฏ. <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">static mstate _int_new_arena(size_t size) { mstate arena; size = calculate_how_much_memory_to_ask_from_os(size); arena = do_some_stuff_to_allocate_memory_from_os(); LIBC_PROBE(memory_arena_new, 2, arena, size); do_more_stuff(); return arena; }</code> </pre> <br>  ูู ูููููู ุงุณุชุฎุฏุงู <i>uprobes</i> ูุชุชุจุน ูุธููุฉ <i>_int_new_arena</i> ุ  ูุณูุก ุงูุญุธ ุ ูุง.  ูุณุจุจ ูุง ุ ูุง ูุชููุฑ ูุฐุง ุงูุฑูุฒ ูู glibc Ubuntu 18.04.  ุญุชู ุจุนุฏ ุชุซุจูุช ุฑููุฒ ุงูุชุตุญูุญ. <br><br>  ูุญุณู ุงูุญุธ ุ ููุงู ุฌูุงุฒ ุงุณุชุดุนุงุฑ USDT ูู ูุฐู ุงููุธููุฉ.  <i>LIBC_PROBE</i> ูู ุงุณู ูุณุชุนุงุฑ ููุงูุฑู ูู <i>STAP_PROBE</i> . <br>  ุงุณู ุงููุฒูุฏ ูู libc. <br>  ุงุณู ุงููุณุชุดุนุฑ ูู memory_arena_new. <br>  ุงูุฑูู 2 ูุนูู ุฃู ููุงู ูุณูุทูู ุฅุถุงูููู ุชู ุชุญุฏูุฏููุง ุจูุงุณุทุฉ ุงููุทูุฑ. <br>  ุงูุณุงุญุฉ ูู ุนููุงู ุงูููุทูุฉ ุงูุชู ุชู ุงุณุชุฎุฑุงุฌูุง ูู ูุธุงู ุงูุชุดุบูู ุ ูุงูุญุฌู ูู ุญุฌููุง. <br><br>  ูุจู ุฃู ูุชููู ูู ุงุณุชุฎุฏุงู ูุฐุง ุงููุณุชุดุนุฑ ุ ูุญุชุงุฌ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุฅูู ุญู ุงููุดููุฉ 328</a> .  ูุญุชุงุฌ ุฅูู ุฅูุดุงุก ุงุฑุชุจุงุท ูุน glibc ูู ููุงู ูุง ุจุงุณู <i>libc</i> ุ ูุฃู bpftrace ุชุชููุน ุฃู ูููู ุงุณู ุงูููุชุจุฉ (ูุงูุฐู ุณูููู ุนูู ุฎูุงู ุฐูู <i>libc-2.27.so</i> ) ูุทุงุจููุง ูุงุณู ุงููููุฑ <i>(libc)</i> . <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">ln -s /lib/x86_64-linux-gnu/libc-2.27.so /tmp/libc</code> </pre> <br>  ูุญู ูุทูุจ ุงูุขู ูู bpftrace ุฑุจุท ุฌูุงุฒ ุงุณุชุดุนุงุฑ USDT memory_arena_new ุ ูุงุณู ุงูุจุงุฆุน ูู <i>libc</i> : <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">sudo bpftrace -e 'usdt:/tmp/libc:memory_arena_new { printf("PID %d: created new arena at %p, size %d\n", pid, arg0, arg1); }'</code> </pre> <br>  ูู ูุญุทุฉ ุฃุฎุฑู ุ ุณูููู ุจุชุดุบูู ุฑูุจู ุ ูุงูุฐู ุณูุฎูู ุซูุงุซุฉ ุฎููุท ูุง ุชูุนู ุดูุฆูุง ูุชูุชูู ูู ุงูุซุงููุฉ.  ูุธุฑูุง ููุญุธุฑ ุงูุดุงูู ูููุชุฑุฌู <i>ุงูููุฑู ุ</i> ูุฌุจ ุฃูุง ูุชู ุงุณุชุฏุนุงุก Ruby <i>malloc ()</i> ูู ููุณ ุงูููุช ุจูุงุณุทุฉ ูุคุดุฑุงุช ุชุฑุงุจุท ูุฎุชููุฉ. <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">ruby -e '3.times { Thread.new { } }; sleep 1'</code> </pre> <br>  ุจุงูุนูุฏุฉ ุฅูู ุงููุญุทุฉ ูุน bpftrace ุ ุณูุฑู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">Attaching 1 probe... PID 431: created new arena at 0x7f40e8000020, size 576 PID 431: created new arena at 0x7f40e0000020, size 576 PID 431: created new arena at 0x7f40e4000020, size 576</code> </pre> <br>  ููุง ูู ุงูุฌูุงุจ ุนูู ุณุคุงููุง!  ูู ูู ูุฑุฉ ุชููู ุจุฅูุดุงุก ุณูุณูุฉ ุฌุฏูุฏุฉ ูู ุฑูุจู ุ ูุณูุท glibc ุงูุถูุก ุนูู ููุทูุฉ ุฌุฏูุฏุฉ ุจุบุถ ุงููุธุฑ ุนู ุงููุฏุฑุฉ ุงูุชูุงูุณูุฉ. <br><br>  <b>ูุง ูู ููุงุท ุงูุชุชุจุน ุงููุชุงุญุฉุ</b>  <b>ูุง ุงูุฐู ูุฌุจ ุนูู ุชุชุจุนูุ</b> <br><br>  ููููู ุณุฑุฏ ุฌููุน ููุงุท ุชุชุจุน ุงูุฃุฌูุฒุฉ ุ ุฃุฌูุฒุฉ ุถุจุท ุงูููุช ุ kprobe ุ ูุชุชุจุน kernel ุงูุซุงุจุช ุนู ุทุฑูู ุชุดุบูู ุงูุฃูุฑ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">sudo bpftrace -l</code> </pre> <br>  ููููู ุณุฑุฏ ุฌููุน ููุงุท ุงูุชุชุจุน uprobe (ุงูุฃุญุฑู ุงููุธูููุฉ) ููุชุทุจูู ุฃู ุงูููุชุจุฉ ุนู ุทุฑูู ุงูููุงู ุจูุง ููู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">nm /path-to-binary</code> </pre> <br>  ููููู ุณุฑุฏ ุฌููุน ููุงุท ุงูุชุชุจุน ูุชุทุจูู ุฃู ููุชุจุฉ USDT ุนู ุทุฑูู ุชุดุบูู ุงูุฃูุฑ ุงูุชุงูู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">/usr/share/bcc/tools/tplist -l /path-to/binary</code> </pre> <br>  ูููุง ูุชุนูู ุจููุงุท ุงูุชุชุจุน ุงูุชู ูุฌุจ ุงุณุชุฎุฏุงููุง: ูู ูุถุฑ ุจููู ุดูุฑุฉ ุงููุตุฏุฑ ููุง ุณุชููู ุจุชุชุจุนู.  ุฃูุตุญู ุจุฏุฑุงุณุฉ ุงูููุฏ ุงููุตุฏุฑู. <br><br>  <b>ูุตูุญุฉ: ุชูุณูู ููููู ูููุงุท ุงูุชุชุจุน ูู ุงูููุงุฉ</b> <br><br>  ุฅููู ูุตูุญุฉ ูููุฏุฉ ุญูู ููุงุท ุชุชุจุน kernel.  ููููู ุงูุชุญูู ูู ุญููู ุงููุณูุทุฉ ุงููุชููุฑุฉ ูู ุฎูุงู ูุฑุงุกุฉ ุงูููู / sys / kernel / debug / tracing / events! <br><br>  ุนูู ุณุจูู ุงููุซุงู ุ ุงูุชุฑุถ ุฃูู ุชุฑูุฏ ุชุชุจุน ุงูููุงููุงุช ุฅูู <i>madvise (... ุ MADV_DONTNEED)</i> : <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">sudo bpftrace -l | grep madvise</code> </pre> <br>  - ุณูู ูุฎุจุฑูุง ุฃูู ูููููุง ุงุณุชุฎุฏุงู tracepoint: syscalls: sys_enter_madvise. <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">sudo cat /sys/kernel/debug/tracing/events/syscalls/sys_enter_madvise/format</code> </pre> <br>  - ุณูู ุชูุฏู ููุง ุงููุนูููุงุช ุงูุชุงููุฉ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">name: sys_enter_madvise ID: 569 format: field:unsigned short common_type; offset:0; size:2; signed:0; field:unsigned char common_flags; offset:2; size:1; signed:0; field:unsigned char common_preempt_count; offset:3; size:1; signed:0; field:int common_pid; offset:4; size:4; signed:1; field:int __syscall_nr; offset:8; size:4; signed:1; field:unsigned long start; offset:16; size:8; signed:0; field:size_t len_in; offset:24; size:8; signed:0; field:int behavior; offset:32; size:8; signed:0; print fmt: "start: 0x%08lx, len_in: 0x%08lx, behavior: 0x%08lx", ((unsigned long)(REC-&gt;start)), ((unsigned long)(REC-&gt;len_in)), ((unsigned long)(REC-&gt;behavior))</code> </pre> <br>  Madvise ุงูุชูููุน ูููุง ูุฏููู: <i>(ุจุงุทู * addr ุ size_t ุทูู ุ ูุตูุญุฉ ูุซุงูุฉ ุงูุนูููุงุช)</i> .  ุงูุญููู ุงูุซูุงุซุฉ ุงูุฃุฎูุฑุฉ ูู ูุฐุง ุงููููู ุชุชูุงูู ูุน ูุฐู ุงููุนุงููุฑ! <br><br>  ูุง ูุนูู MADV_DONTNEEDุ  ุงุฐุง ุญูููุง ูู ุฎูุงู grep MADV_DONTNEED / usr / include ุ ูุณุงูู 4: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">/usr/include/x86_64-linux-gnu/bits/mman-linux.h:80:# define MADV_DONTNEED 4 /* Don't need these pages. */</code> </pre> <br>  ูุฐูู ูุตุจุญ ูุฑูู bpftrace ูุฏููุง: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">sudo bpftrace -e 'tracepoint:syscalls:sys_enter_madvise /args-&gt;behavior == 4/ { printf("madvise DONTNEED called\n"); }'</code> </pre> <br><h3 style=";text-align:right;direction:rtl">  ุงูุฎุงุชูุฉ </h3><br>  Bpftrace ุฑุงุฆุน!  Bpftrace ูู ุงููุณุชูุจู! <br><br>  ุฅุฐุง ููุช ุชุฑุบุจ ูู ูุนุฑูุฉ ุงููุฒูุฏ ุนูู ุ ูุฅููู ุฃูุตูู ุจุฃู ุชุชุนุฑู <a href="">ุนูู ููุงุฏุชู</a> ุ ุจุงูุฅุถุงูุฉ ุฅูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงููุดุงุฑูุฉ ุงูุฃููู ูุนุงู 2019</a> ุนูู ูุฏููุฉ ุจุฑููุฏุงู ุฌุฑูุฌ. <br><br>  ุชุตุญูุญ ุฌูุฏ! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar441258/">https://habr.com/ru/post/ar441258/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar441244/index.html">ุชุณูุญ ูู ูุดููุฉ ุนุฏู ุญุตุงูุฉ WinRar ุ ุงูุชู ูู ูุชู ุฅุบูุงููุง ููุฏุฉ 19 ุนุงููุง ุ ุจูุถุน ุงูููู ุงูุฐู ุชู ูู ุญุฒูู ูู ุฃู ููุงู</a></li>
<li><a href="../ar441248/index.html">ุงุญุชูุช ุฑูุณูุง ุงููุฑุชุจุฉ ุงูุชุงุณุนุฉ ูู ุชุตููู SSL ุงูุนุงููู ุ ูุชูุฏูุฉ ุนูู ุงูุตูู ูุงูุฏููุงุฑู ูุณููุณุฑุง</a></li>
<li><a href="../ar441250/index.html">ุจุฏุงูุฉ ุณุฑูุนุฉ: Go + Apache Kafka + Redis</a></li>
<li><a href="../ar441252/index.html">"ููุงู ุนู ุงููุณุงู": ุนุงูุฌ ุงูุนููุงุก 109 ุณุงุนุงุช ูู ููุงุฑุณุฉ ุงูุฌูุณ ุนู ุทุฑูู ุงููู ูุชุทููุฑ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุงูุฐู ุชูุชุต ุฏูู</a></li>
<li><a href="../ar441254/index.html">ูุฏูุฉ "ููุงุฐุง ุชูุงุตููุง ูุน Kubernetes ููุง ูุญุตู ุนููู" ุ 28 ูุจุฑุงูุฑ ุ ููุณูู</a></li>
<li><a href="../ar441260/index.html">ููู ุณุงุนุฏุช ุฑุณููุงุช ุงูุดุจูุฉ ุงูุนุตุจูุฉ</a></li>
<li><a href="../ar441262/index.html">ุชุนูู ุงูููุงู ุงูุจุณูุทุฉ ูุงูุทูููุฉ ุนูู ุงูุชุฎูุต ูู ุงููุฑุดุญูู ุจุดูู ุฃูุถู ูู ุงููุฑุดุญูู ุงููุนูููู</a></li>
<li><a href="../ar441264/index.html">Kibana ุฏููู ุงููุณุชุฎุฏู. ุงูุชุตูุฑ. ุงูุฌุฒุก 2</a></li>
<li><a href="../ar441266/index.html">ููู ูุนูู ุฅุทุงุฑ tiOPF ูุฏููู / ูุงุฒุงุฑูุณ. ูุงูุจ ุฒุงุฆุฑ</a></li>
<li><a href="../ar441268/index.html">Ceedling + Eclipse ุฃู ุงุฎุชุจุงุฑุงุช ุงููุญุฏุฉ ูููููุฑููููุชุฑููุฑ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>