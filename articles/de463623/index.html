<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï∂Ô∏è üë®üèª‚Äçüè≠ ‚ÜïÔ∏è Wir werden aus dem Dschungel der Tests ausgew√§hlt: Wir bauen einen kurzen Weg von den Vorrichtungen zum Testen üõÑ ‚úçüèº üòö</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In diesem Artikel m√∂chte ich eine Alternative zum traditionellen Testdesignstil unter Verwendung der funktionalen Programmierkonzepte von Scala anbiet...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wir werden aus dem Dschungel der Tests ausgew√§hlt: Wir bauen einen kurzen Weg von den Vorrichtungen zum Testen</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/2gis/blog/463623/"><p><img src="https://habrastorage.org/webt/mu/ll/ar/mullaroquhqtdb05ygvb82nmghu.jpeg"></p><br><p>  In diesem Artikel m√∂chte ich eine Alternative zum traditionellen Testdesignstil unter Verwendung der funktionalen Programmierkonzepte von Scala anbieten.  Der Ansatz wurde von den vielen Monaten des Schmerzes inspiriert, die durch die Unterst√ºtzung von Dutzenden und Hunderten von Falltests und dem brennenden Wunsch entstanden waren, sie einfacher und verst√§ndlicher zu machen. </p><br><p>  Trotz der Tatsache, dass der Code in Scala geschrieben ist, sind die vorgeschlagenen Ideen f√ºr Entwickler und Tester in allen Sprachen relevant, die das Paradigma der funktionalen Programmierung unterst√ºtzen.  Einen Link zu Github mit einer vollst√§ndigen L√∂sung und einem Beispiel finden Sie am Ende des Artikels. </p><a name="habracut"></a><br><h2 id="problema">  Das Problem </h2><br><p>  Wenn Sie sich jemals mit Tests befasst haben (es spielt keine Rolle - Komponententests, Integration oder Funktionstests), wurden sie h√∂chstwahrscheinlich als sequentielle Anweisungen geschrieben.  Z.B: </p><br><pre><code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">//     .     //  ,      ,  //     . "   = 'customer'" - { import TestHelper._ "    &lt; 250    -  " in { val db: Database = Database.forURL(TestConfig.generateNewUrl()) migrateDb(db) insertUser(db, id = 1, name = "test", role = "customer") insertPackage(db, id = 1, name = "test", userId = 1, status = "new") insertPackageItems(db, id = 1, packageId = 1, name = "test", price = 30) insertPackageItems(db, id = 2, packageId = 1, name = "test", price = 20) insertPackageItems(db, id = 3, packageId = 1, name = "test", price = 40) val svc = new SomeProductionLogic(db) val result = svc.calculatePrice(packageId = 1) result shouldBe 90 } "    &gt;= 250    -  10%" in { val db: Database = Database.forURL(TestConfig.generateNewUrl()) migrateDb(db) insertUser(db, id = 1, name = "test", role = "customer") insertPackage(db, id = 1, name = "test", userId = 1, status = "new") insertPackageItems(db, id = 1, packageId = 1, name = "test", price = 100) insertPackageItems(db, id = 2, packageId = 1, name = "test", price = 120) insertPackageItems(db, id = 3, packageId = 1, name = "test", price = 130) insertBonus(db, id = 1, packageId = 1, bonusAmount = 40) val svc = new SomeProductionLogic(db) val result = svc.calculatePrice(packageId = 1) result shouldBe 279 } } "   = 'vip'" - {/*...*/}</span></span></code> </pre> <br><p>  Dies ist die bevorzugte Methode zur Beschreibung von Tests, die keine Entwicklung erfordert.  Unser Projekt umfasst etwa 1000 Tests auf verschiedenen Ebenen (Komponententests, Integrationstests, End-to-End-Tests), die bis vor kurzem alle in einem √§hnlichen Stil geschrieben wurden.  Als das Projekt wuchs, versp√ºrten wir mit der Unterst√ºtzung solcher Tests erhebliche Probleme und eine Verlangsamung: Die Reihenfolge der Tests dauerte nicht weniger als das Schreiben von gesch√§ftsrelevantem Code. </p><br><p>  Beim Schreiben neuer Tests musste man immer von Grund auf √ºberlegen, wie die Daten vorbereitet werden sollen.  Oft Kopieren-Einf√ºgen-Schritte aus benachbarten Tests.  Als sich das Datenmodell in der Anwendung √§nderte, brach das Kartenhaus zusammen und musste in jedem Test auf eine neue Weise gesammelt werden: im besten Fall nur eine √Ñnderung der Helferfunktionen, im schlimmsten Fall ein tiefes Eintauchen in den Test und ein Umschreiben. </p><br><p>  Wenn der Test ehrlich abst√ºrzte - das hei√üt, aufgrund eines Fehlers in der Gesch√§ftslogik und nicht aufgrund von Problemen im Test selbst - war es unm√∂glich zu verstehen, wo etwas schief gelaufen ist, ohne zu debuggen.  Aufgrund der Tatsache, dass es lange gedauert hat, die Tests zu verstehen, war niemand vollst√§ndig √ºber die Anforderungen informiert - wie sich das System unter bestimmten Bedingungen verhalten sollte. </p><br><p>  All dieser Schmerz ist das Symptom f√ºr zwei tiefere Probleme dieses Entwurfs: </p><br><ol><li>  Der Inhalt des Tests ist in zu lockerer Form zul√§ssig.  Jeder Test ist einzigartig, wie eine Schneeflocke.  Die Notwendigkeit, die Details des Tests zu lesen, nimmt viel Zeit in Anspruch und demotiviert.  Nicht wichtige Details lenken von der Hauptsache ab - den durch den Test verifizierten Anforderungen.  Kopieren Einf√ºgen wird zur Hauptmethode zum Schreiben neuer Testf√§lle. </li><li>  Tests helfen dem Entwickler nicht, Fehler zu lokalisieren, sondern signalisieren nur ein Problem.  Um den Status zu verstehen, in dem der Test durchgef√ºhrt wird, m√ºssen Sie ihn in Ihrem Kopf wiederherstellen oder eine Verbindung mit einem Debugger herstellen. </li></ol><br><h2 id="modelirovanie">  Modellierung </h2><br><p>  K√∂nnen wir es besser machen?  (Spoiler: Wir k√∂nnen.) Schauen wir uns an, woraus dieser Test besteht. </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> db: <span class="hljs-type"><span class="hljs-type">Database</span></span> = <span class="hljs-type"><span class="hljs-type">Database</span></span>.forURL(<span class="hljs-type"><span class="hljs-type">TestConfig</span></span>.generateNewUrl()) migrateDb(db) insertUser(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, role = <span class="hljs-string"><span class="hljs-string">"customer"</span></span>) insertPackage(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, userId = <span class="hljs-number"><span class="hljs-number">1</span></span>, status = <span class="hljs-string"><span class="hljs-string">"new"</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">30</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">2</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">20</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">3</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">40</span></span>)</code> </pre> <br><p>  Der getestete Code wartet in der Regel auf die Eingabe einiger expliziter Parameter - Bezeichner, Gr√∂√üen, Volumes, Filter usw. Au√üerdem werden h√§ufig Daten aus der realen Welt ben√∂tigt - wir sehen, dass sich die Anwendung auf die Men√ºs und Men√ºvorlagen bezieht Datenbank.  F√ºr eine zuverl√§ssige Testausf√ºhrung ben√∂tigen wir eine <em>Vorrichtung</em> - den Zustand, in dem sich das System und / oder die Datenanbieter befinden sollten, bevor der Test beginnt, und die Eingabeparameter, die h√§ufig mit dem Zustand zusammenh√§ngen. </p><br><p>  Wir werden <em>Abh√§ngigkeiten mit</em> diesem Ger√§t vorbereiten - f√ºllen Sie die Datenbank (Warteschlange, externer Dienst usw.).  Mit der vorbereiteten Abh√§ngigkeit initialisieren wir die getestete Klasse (Dienste, Module, Repositorys usw.). </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> svc = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">SomeProductionLogic</span></span>(db) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> result = svc.calculatePrice(packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br><p>  Durch Ausf√ºhren des Testcodes f√ºr einige Eingabeparameter erhalten wir ein gesch√§ftsrelevantes <em>Ergebnis</em> ( <em>Ausgabe</em> ) - sowohl explizit (von der Methode zur√ºckgegeben) als auch implizit - eine √Ñnderung des ber√ºchtigten Status: Datenbank, externer Dienst usw. </p><br><pre> <code class="scala hljs">result shouldBe <span class="hljs-number"><span class="hljs-number">90</span></span></code> </pre> <br><p>  Schlie√ülich √ºberpr√ºfen wir, ob die Ergebnisse genau den Erwartungen entsprechen, und fassen den Test mit einer oder mehreren <em>Aussagen zusammen</em> . </p><br><p><img src="https://habrastorage.org/webt/em/aa/rb/emaarb5ltmnme4-wpda0ebakueq.jpeg"></p><br><p>  Es kann gefolgert werden, dass der Test im Allgemeinen aus denselben Phasen besteht: Vorbereiten von Eingabeparametern, Ausf√ºhren des Testcodes auf diesen und Vergleichen der Ergebnisse mit den erwarteten.  Wir k√∂nnen diese Tatsache nutzen, um das <strong>erste Problem im Test</strong> zu <strong>beseitigen</strong> - eine zu lockere Form, die den Test klar in Stufen unterteilt.  Diese Idee ist nicht neu und wird seit langem in Tests im BDD-Stil ( <em>verhaltensgesteuerte Entwicklung</em> ) verwendet. </p><br><p>  Was ist mit Erweiterbarkeit?  Jeder der Schritte im Testprozess kann so viele Zwischenschritte enthalten, wie Sie m√∂chten.  Mit Blick auf die Zukunft k√∂nnten wir ein Fixture bilden, indem wir zuerst eine Art von lesbarer Struktur erstellen und sie dann in Objekte konvertieren, die die Datenbank f√ºllen.  Der Testprozess ist unendlich erweiterbar, aber letztendlich kommt es immer auf die Hauptphasen an. </p><br><p><img src="https://habrastorage.org/webt/55/qf/zl/55qfzlhkl99txyyhizbvzg48yhs.jpeg"></p><br><h2 id="zapusk-testov">  Ausf√ºhren von Tests </h2><br><p>  Lassen Sie uns versuchen, die Idee der Aufteilung des Tests in Stufen zu verwirklichen, aber zuerst bestimmen wir, wie wir das Endergebnis sehen m√∂chten. </p><br><p>  Im Allgemeinen m√∂chten wir das Schreiben und Unterst√ºtzen von Tests zu einem weniger arbeitsintensiven und unterhaltsamen Prozess machen.  Je weniger explizite, nicht eindeutige (an anderer Stelle wiederholte) Anweisungen im Testk√∂rper, desto weniger √Ñnderungen m√ºssen an den Tests vorgenommen werden, nachdem Vertr√§ge ge√§ndert oder umgestaltet wurden, und desto weniger Zeit wird zum Lesen des Tests ben√∂tigt.  Das Design des Tests sollte die Wiederverwendung h√§ufig verwendeter Codeteile f√∂rdern und ein gedankenloses Kopieren verhindern.  Es w√§re sch√∂n, wenn die Tests ein einheitliches Aussehen h√§tten.  Vorhersagbarkeit verbessert die Lesbarkeit und spart Zeit - stellen Sie sich vor, wie viel Zeit Physikstudenten ben√∂tigen w√ºrden, um jede neue Formel zu beherrschen, wenn sie nicht in mathematischer Sprache, sondern in Freiformw√∂rtern beschrieben w√ºrden. </p><br><p>  Unser Ziel ist es daher, alles ablenkend und √ºberfl√ºssig zu verbergen und nur die Informationen zu belassen, die f√ºr das Verst√§ndnis der Anwendung entscheidend sind: Was wird getestet, was wird am Eingang erwartet und was wird am Ausgang erwartet. </p><br><p><img src="https://habrastorage.org/webt/em/aa/rb/emaarb5ltmnme4-wpda0ebakueq.jpeg"></p><br><p>  Kehren wir zum Modell des Testger√§ts zur√ºck.  Technisch gesehen kann jeder Punkt in diesem Diagramm durch einen Datentyp dargestellt werden und von einem zum anderen √ºbergehen - Funktionen.  Sie k√∂nnen vom urspr√ºnglichen zum endg√ºltigen Datentyp wechseln, indem Sie die folgende Funktion nacheinander auf das Ergebnis des vorherigen anwenden.  Mit anderen Worten: Verwenden einer <em>Funktionszusammensetzung</em> : Vorbereiten von Daten (nennen wir sie <code>prepare</code> ), Ausf√ºhren des Testcodes ( <code>execute</code> ) und √úberpr√ºfen des erwarteten Ergebnisses ( <code>check</code> ).  Wir werden den ersten Punkt des Diagramms, Fixture, an die Eingabe dieser Komposition √ºbergeben.  Die resultierende <strong>Funktion</strong> h√∂herer Ordnung wird als <strong>Testlebenszyklusfunktion bezeichnet</strong> . </p><br><div class="spoiler">  <b class="spoiler_title">Lebenszyklusfunktion</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runTestCycle</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">FX</span></span>, <span class="hljs-type"><span class="hljs-type">DEP</span></span>, <span class="hljs-type"><span class="hljs-type">OUT</span></span>, <span class="hljs-type"><span class="hljs-type">F</span></span>[_]]( fixture: <span class="hljs-type"><span class="hljs-type">FX</span></span>, prepare: <span class="hljs-type"><span class="hljs-type">FX</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">DEP</span></span>, execute: <span class="hljs-type"><span class="hljs-type">DEP</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">OUT</span></span>, check: <span class="hljs-type"><span class="hljs-type">OUT</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">F</span></span>[<span class="hljs-type"><span class="hljs-type">Assertion</span></span>] ): <span class="hljs-type"><span class="hljs-type">F</span></span>[<span class="hljs-type"><span class="hljs-type">Assertion</span></span>] = <span class="hljs-comment"><span class="hljs-comment">//  Scala  ,   check(execute(prepare(fixture))) //        andThen: (prepare andThen execute andThen check) (fixture)</span></span></code> </pre> </div></div><br><p>  Die Frage ist, woher kommen die internen Funktionen?  Wir werden die Daten auf eine begrenzte Anzahl von Arten vorbereiten - um die Datenbank zu f√ºllen, nass zu werden usw. - daher sind die Optionen f√ºr die Vorbereitungsfunktion allen Tests gemeinsam.  Infolgedessen wird es einfacher sein, spezielle Lebenszyklusfunktionen zu erstellen, die die spezifische Implementierung der Datenaufbereitung verbergen.  Da die Methoden zum Aufrufen des zu √ºberpr√ºfenden und zu √ºberpr√ºfenden Codes f√ºr jeden Test relativ eindeutig sind, werden <code>execute</code> und <code>check</code> explizit bereitgestellt. </p><br><div class="spoiler">  <b class="spoiler_title">Lebenszyklusfunktion angepasst f√ºr Integrationstests in der Datenbank</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">//    ‚Äî     def prepareDatabase[DB](db: Database): DbFixture =&gt; DB def testInDb[DB, OUT]( fixture: DbFixture, execute: DB =&gt; OUT, check: OUT =&gt; Future[Assertion], db: Database = getDatabaseHandleFromSomewhere(), ): Future[Assertion] = runTestCycle(fixture, prepareDatabase(db), execute, check)</span></span></code> </pre> </div></div><br><p>  Indem wir alle administrativen Nuancen an die Lebenszyklusfunktion delegieren, erhalten wir die M√∂glichkeit, den Testprozess zu erweitern, ohne in einen bereits schriftlichen Test einzusteigen.  Aufgrund der Zusammensetzung k√∂nnen wir √ºberall im Prozess infiltrieren, dort Daten extrahieren oder hinzuf√ºgen. </p><br><p>  Um die M√∂glichkeiten dieses Ansatzes besser zu veranschaulichen, werden wir das <strong>zweite Problem</strong> unseres ersten Tests l√∂sen - den Mangel an unterst√ºtzenden Informationen zur Lokalisierung von Problemen.  F√ºgen Sie die Protokollierung hinzu, wenn Sie eine Antwort von der getesteten Methode erhalten.  Unsere Protokollierung √§ndert nicht den Datentyp, sondern erzeugt nur einen <em>Nebeneffekt</em> - das Anzeigen einer Nachricht auf der Konsole.  Daher werden wir es nach dem Nebeneffekt so zur√ºckgeben, wie es ist. </p><br><div class="spoiler">  <b class="spoiler_title">Protokollierung der Lebenszyklusfunktion</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">logged</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>](<span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> loggedT: <span class="hljs-type"><span class="hljs-type">Logged</span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>]): <span class="hljs-type"><span class="hljs-type">T</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">T</span></span> = (that: <span class="hljs-type"><span class="hljs-type">T</span></span>) =&gt; { <span class="hljs-comment"><span class="hljs-comment">//       Logged  T, //    ‚Äú‚Äù  that  log(). //    - . loggedT.log(that) //    : that.log() that //    } def runTestCycle[FX, DEP, OUT, F[_]]( fixture: FX, prepare: FX =&gt; DEP, execute: DEP =&gt; OUT, check: OUT =&gt; F[Assertion] )(implicit loggedOut: Logged[OUT]): F[Assertion] = //  logged     -  execute (prepare andThen execute andThen logged andThen check) (fixture)</span></span></code> </pre> </div></div><br><p>  Mit einer so einfachen Bewegung haben wir <strong>in jedem Test die</strong> Protokollierung des zur√ºckgegebenen Ergebnisses und den Status der Datenbank hinzugef√ºgt.  Der Vorteil dieser kleinen Funktionen besteht darin, dass sie leicht zu verstehen, leicht zur Wiederverwendung zusammenzustellen und leicht zu entfernen sind, wenn sie nicht mehr ben√∂tigt werden. </p><br><p><img src="https://habrastorage.org/webt/ti/2t/l9/ti2tl9pk8wkd4hp8pqevf74hdn4.jpeg"></p><br><p>  Infolgedessen sieht unser Test folgenderma√üen aus: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> fixture: <span class="hljs-type"><span class="hljs-type">SomeMagicalFixture</span></span> = ??? <span class="hljs-comment"><span class="hljs-comment">//  -    def runProductionCode(id: Int): Database =&gt; Double = (db: Database) =&gt; new SomeProductionLogic(db).calculatePrice(id) def checkResult(expected: Double): Double =&gt; Future[Assertion] = (result: Double) =&gt; result shouldBe expected //    Database   testInDb "   = 'customer'" in testInDb( state = fixture, execute = runProductionCode(id = 1), check = checkResult(90) )</span></span></code> </pre> <br><p>  Der Testk√∂rper ist knapp geworden, Fixtures und Checks k√∂nnen in anderen Tests wiederverwendet werden, und wir bereiten die Datenbank nirgendwo anders manuell vor.  Es bleibt nur ein Problem ... </p><br><h2 id="podgotovka-fikstur">  Ger√§tevorbereitung </h2><br><p>  Im obigen Code haben wir die Annahme verwendet, dass das Ger√§t von einem vorgefertigten Ort stammt und nur in die Lebenszyklusfunktion √ºbertragen werden muss.  Da Daten ein wesentlicher Bestandteil einfacher und unterst√ºtzter Tests sind, k√∂nnen wir nur darauf eingehen, wie sie erstellt werden sollen. </p><br><p>  Angenommen, unser Testspeicher verf√ºgt √ºber eine typische mittelgro√üe Datenbank (der Einfachheit halber ein Beispiel mit 4 Tabellen, in Wirklichkeit k√∂nnen es jedoch Hunderte sein).  Ein Teil enth√§lt Hintergrundinformationen, ein Teil - direktes Gesch√§ft, und alles in allem kann es zu mehreren vollwertigen logischen Entit√§ten verbunden werden.  Tabellen sind durch Schl√ºssel ( <em>Fremdschl√ºssel</em> ) miteinander verbunden. Um eine <code>Bonus</code> Entit√§t zu erstellen, ben√∂tigen Sie die <code>Package</code> Entit√§t und damit den <code>User</code> .  Usw. </p><br><p><img src="https://habrastorage.org/webt/3z/of/sy/3zofsyjoygierusjtmlu_okrmh0.png"></p><br><p>  Umst√§nde von Schaltungsbeschr√§nkungen und allerlei Hacks f√ºhren zu Inkonsistenzen und damit zu Testinstabilit√§t und stundenlangem aufregendem Debuggen.  Aus diesem Grund werden wir die Datenbank ehrlich f√ºllen. </p><br><p>  Wir k√∂nnten milit√§rische Methoden zum F√ºllen verwenden, aber selbst bei einer oberfl√§chlichen Untersuchung dieser Idee stellen sich viele schwierige Fragen.  Was bereitet die Daten in Tests f√ºr diese Methoden selbst vor?  Muss ich die Tests neu schreiben, wenn sich der Vertrag √§ndert?  Was ist, wenn die Daten von einer nicht getesteten Anwendung geliefert werden (z. B. von einer anderen Person importiert)?  Wie viele verschiedene Abfragen m√ºssen durchgef√ºhrt werden, um eine von vielen anderen abh√§ngige Entit√§t zu erstellen? </p><br><div class="spoiler">  <b class="spoiler_title">F√ºllen Sie die Basis im ersten Test</b> <div class="spoiler_text"><pre> <code class="scala hljs">insertUser(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, role = <span class="hljs-string"><span class="hljs-string">"customer"</span></span>) insertPackage(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, userId = <span class="hljs-number"><span class="hljs-number">1</span></span>, status = <span class="hljs-string"><span class="hljs-string">"new"</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">30</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">2</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">20</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">3</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">40</span></span>)</code> </pre> </div></div><br><p>  Verstreute Hilfsmethoden wie im urspr√ºnglichen Beispiel sind das gleiche Problem, jedoch mit einer anderen Sauce.  Sie √ºbertragen uns die Verantwortung f√ºr die Verwaltung abh√§ngiger Objekte und ihrer Beziehungen, und wir m√∂chten dies vermeiden. </p><br><p>  Im Idealfall h√§tte ich gerne diese Art von Daten, von denen ein Blick ausreicht, um allgemein zu verstehen, in welchem ‚Äã‚ÄãZustand sich das System w√§hrend des Tests befindet.  Einer der guten Kandidaten f√ºr die Statusvisualisierung ist eine Tabelle (a la <em>Datasets</em> in PHP und Python), in der nichts √ºberfl√ºssig ist, au√üer f√ºr Felder, die f√ºr die Gesch√§ftslogik kritisch sind.  Wenn sich die Gesch√§ftslogik in einem Feature √§ndert, wird die gesamte Testunterst√ºtzung auf die Aktualisierung der Zellen im Dataset reduziert.  Zum Beispiel: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> dataTable: <span class="hljs-type"><span class="hljs-type">Seq</span></span>[<span class="hljs-type"><span class="hljs-type">DataRow</span></span>] = <span class="hljs-type"><span class="hljs-type">Table</span></span>( (<span class="hljs-string"><span class="hljs-string">"Package ID"</span></span>, <span class="hljs-string"><span class="hljs-string">"Customer's role"</span></span>, <span class="hljs-string"><span class="hljs-string">"Item prices"</span></span>, <span class="hljs-string"><span class="hljs-string">"Bonus value"</span></span>, <span class="hljs-string"><span class="hljs-string">"Expected final price"</span></span>) , (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>.empty , <span class="hljs-number"><span class="hljs-number">90.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">250</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>.empty , <span class="hljs-number"><span class="hljs-number">225.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) , <span class="hljs-number"><span class="hljs-number">210.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>) , <span class="hljs-number"><span class="hljs-number">279.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">"vip"</span></span> , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>), <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>), <span class="hljs-number"><span class="hljs-number">252.0</span></span>) )</code> </pre> <br><p><img src="https://habrastorage.org/webt/5j/dt/2p/5jdt2pdn7hdzhepaut_bhukkcgm.jpeg"></p><br><p>  Aus unserer Tabelle generieren wir <em>Schl√ºssel-</em> Entit√§ts-Beziehungen nach ID.  In diesem Fall wird ein Schl√ºssel f√ºr die Abh√§ngigkeit gebildet, wenn die Entit√§t von einer anderen abh√§ngt.  Es kann vorkommen, dass zwei verschiedene Entit√§ten eine Abh√§ngigkeit mit demselben Bezeichner generieren, was zu einer Verletzung der Einschr√§nkung des Prim√§rschl√ºssels der Datenbank ( <em>Prim√§rschl√ºssel</em> ) f√ºhren kann.  In dieser Phase ist die Deduplizierung der Daten jedoch √§u√üerst kosteng√ºnstig. Da die Schl√ºssel nur Bezeichner enthalten, k√∂nnen wir sie in eine Sammlung einf√ºgen, die beispielsweise in <code>Set</code> eine Deduplizierung erm√∂glicht.  Wenn sich dies als unzureichend herausstellt, k√∂nnen wir immer eine intelligentere Deduplizierung in Form einer zus√§tzlichen Funktion durchf√ºhren, die in eine Lebenszyklusfunktion kompiliert wird. </p><br><div class="spoiler">  <b class="spoiler_title">Schl√ºsselbeispiel</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PackageKey</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, userId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PackageItemKey</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, packageId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserKey</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BonusKey</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, packageId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span></span></code> </pre> </div></div><br><p>  Wir delegieren die Generierung von gef√§lschten Inhalten an Felder (z. B. Namen) an eine separate Klasse.  Wenn wir dann auf die Hilfe dieser Klasse und die Regeln zum Konvertieren von Schl√ºsseln zur√ºckgreifen, erhalten wir Zeichenfolgenobjekte, die direkt zum Einf√ºgen in die Datenbank bestimmt sind. </p><br><div class="spoiler">  <b class="spoiler_title">Linienbeispiel</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SampleData</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">name</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">"test name"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">role</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">"customer"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">price</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Int</span></span> = <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bonusAmount</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Int</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">status</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">"new"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PackageRow</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, userId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, status: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PackageItemRow</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, packageId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, price: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserRow</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, role: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BonusRow</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, packageId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, bonusAmount: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span></span></code> </pre> </div></div><br><p>  Die standardm√§√üigen gef√§lschten Daten reichen in der Regel nicht aus, daher m√ºssen wir in der Lage sein, bestimmte Felder neu zu definieren.  Wir k√∂nnen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><em>Linsen verwenden</em></a> - durchlaufen Sie alle erstellten Linien und √§ndern Sie nur die Felder der ben√∂tigten.  Da die Linsen am Ende gew√∂hnliche Funktionen sind, k√∂nnen sie zusammengesetzt werden, und dies ist ihre N√ºtzlichkeit. </p><br><div class="spoiler">  <b class="spoiler_title">Linsenbeispiel</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">changeUserRole</span></span></span></span>(userId: <span class="hljs-type"><span class="hljs-type">Int</span></span>, newRole: <span class="hljs-type"><span class="hljs-type">String</span></span>): <span class="hljs-type"><span class="hljs-type">Set</span></span>[<span class="hljs-type"><span class="hljs-type">Row</span></span>] =&gt; <span class="hljs-type"><span class="hljs-type">Set</span></span>[<span class="hljs-type"><span class="hljs-type">Row</span></span>] = (rows: <span class="hljs-type"><span class="hljs-type">Set</span></span>[<span class="hljs-type"><span class="hljs-type">Row</span></span>]) =&gt; rows.modifyAll(_.each.when[<span class="hljs-type"><span class="hljs-type">UserRow</span></span>]) .using(r =&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (r.id == userId) r.modify(_.role).setTo(newRole) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> r)</code> </pre> </div></div><br><p>  Dank der Zusammensetzung k√∂nnen wir innerhalb des gesamten Prozesses verschiedene Optimierungen und Verbesserungen anwenden - beispielsweise Gruppenzeilen in Tabellen, damit sie mit einer <code>insert</code> eingef√ºgt werden k√∂nnen, wodurch die Testzeit verk√ºrzt oder der endg√ºltige Status der Datenbank gesichert wird, um das Auffangen von Problemen zu vereinfachen. </p><br><div class="spoiler">  <b class="spoiler_title">Vorrichtungsformungsfunktion</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeFixture</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">STATE</span></span>, <span class="hljs-type"><span class="hljs-type">FX</span></span>, <span class="hljs-type"><span class="hljs-type">ROW</span></span>, <span class="hljs-type"><span class="hljs-type">F</span></span>[_]]( state: <span class="hljs-type"><span class="hljs-type">STATE</span></span>, applyOverrides: <span class="hljs-type"><span class="hljs-type">F</span></span>[<span class="hljs-type"><span class="hljs-type">ROW</span></span>] =&gt; <span class="hljs-type"><span class="hljs-type">F</span></span>[<span class="hljs-type"><span class="hljs-type">ROW</span></span>] = x =&gt; x ): <span class="hljs-type"><span class="hljs-type">FX</span></span> = (extractKeys andThen deduplicateKeys andThen enrichWithSampleData andThen applyOverrides andThen logged andThen buildFixture) (state)</code> </pre> </div></div><br><p>  Alles zusammen ergibt eine Einrichtung, die die Abh√§ngigkeit f√ºr den Test ausf√ºllt - die Datenbank.  Im Test selbst wird au√üer dem Originaldatensatz nichts √úberfl√ºssiges angezeigt - alle Details werden in der Zusammensetzung der Funktionen verborgen. </p><br><p><img src="https://habrastorage.org/webt/b3/wz/cq/b3wzcqmqj3gomn-s-zycrakuegy.jpeg"></p><br><p>  Unsere Testsuite sieht nun folgenderma√üen aus: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> dataTable: <span class="hljs-type"><span class="hljs-type">Seq</span></span>[<span class="hljs-type"><span class="hljs-type">DataRow</span></span>] = <span class="hljs-type"><span class="hljs-type">Table</span></span>( (<span class="hljs-string"><span class="hljs-string">"Package ID"</span></span>, <span class="hljs-string"><span class="hljs-string">"Customer's role"</span></span>, <span class="hljs-string"><span class="hljs-string">"Item prices"</span></span>, <span class="hljs-string"><span class="hljs-string">"Bonus value"</span></span>, <span class="hljs-string"><span class="hljs-string">"Expected final price"</span></span>) , (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>.empty , <span class="hljs-number"><span class="hljs-number">90.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">250</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>.empty , <span class="hljs-number"><span class="hljs-number">225.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) , <span class="hljs-number"><span class="hljs-number">210.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>) , <span class="hljs-number"><span class="hljs-number">279.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">"vip"</span></span> , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>), <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>), <span class="hljs-number"><span class="hljs-number">252.0</span></span>) ) <span class="hljs-string"><span class="hljs-string">"   -"</span></span> - { <span class="hljs-string"><span class="hljs-string">"'customer'"</span></span> - { <span class="hljs-string"><span class="hljs-string">"   "</span></span> - { <span class="hljs-string"><span class="hljs-string">"&lt; 250    -  "</span></span> - { <span class="hljs-string"><span class="hljs-string">"(:  )"</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"(:  )"</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">3</span></span>) } <span class="hljs-string"><span class="hljs-string">"&gt;= 250   "</span></span> - { <span class="hljs-string"><span class="hljs-string">"   -  10%  "</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"   -  10%     "</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">4</span></span>) } } } <span class="hljs-string"><span class="hljs-string">"'vip' -    20%      ,       "</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">5</span></span>) }</code> </pre> <br><p>  Ein Hilfecode: </p><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">//    def calculatePriceFor(table: Seq[DataRow], idx: Int) = testInDb( state = makeState(table.row(idx)), execute = runProductionCode(table.row(idx)._1), check = checkResult(table.row(idx)._5) ) def makeState(row: DataRow): Logger =&gt; DbFixture = { val items: Map[Int, Int] = ((1 to row._3.length) zip row._3).toMap val bonuses: Map[Int, Int] = ((1 to row._4.length) zip row._4).toMap MyFixtures.makeFixture( state = PackageRelationships .minimal(id = row._1, userId = 1) .withItems(items.keys) .withBonuses(bonuses.keys), overrides = changeRole(userId = 1, newRole = row._2) andThen items.map { case (id, newPrice) =&gt; changePrice(id, newPrice) }.foldPls andThen bonuses.map { case (id, newBonus) =&gt; changeBonus(id, newBonus) }.foldPls ) } def runProductionCode(id: Int): Database =&gt; Double = (db: Database) =&gt; new SomeProductionLogic(db).calculatePrice(id) def checkResult(expected: Double): Double =&gt; Future[Assertion] = (result: Double) =&gt; result shouldBe expected</span></span></code> </pre></div></div><br><p>  Das Hinzuf√ºgen neuer Testf√§lle zur Tabelle wird zu einer trivialen Aufgabe, bei der Sie sich darauf konzentrieren k√∂nnen <strong>, die maximale Anzahl von Randbedingungen abzudecken</strong> , anstatt sich auf eine Kesselplatte zu konzentrieren. </p><br><h2 id="pereispolzovanie-koda-podgotovki-fikstur-na-drugih-proektah">  Wiederverwendung des Vorrichtungsvorbereitungscodes f√ºr andere Projekte </h2><br><p>  Nun, wir haben viel Code f√ºr die Vorbereitung von Fixtures in einem bestimmten Projekt geschrieben und viel Zeit damit verbracht.  Was ist, wenn wir mehrere Projekte haben?  Sind wir dazu verdammt, das Rad jedes Mal neu zu erfinden und zu kopieren und einzuf√ºgen? </p><br><p>  Wir k√∂nnen die Vorbereitung von Fixtures von einem bestimmten Dom√§nenmodell abstrahieren.  In der Welt von FP gibt es das Konzept einer <em>Typklasse</em> .  Kurz gesagt, Typklassen sind keine Klassen aus OOP, sondern so etwas wie Schnittstellen, sie definieren ein Verhalten von Typgruppen.  Der grundlegende Unterschied besteht darin, dass diese Gruppe von Typen nicht wie gew√∂hnliche Variablen durch Klassenvererbung, sondern durch Instanziierung bestimmt wird.  Wie bei der Vererbung erfolgt das Aufl√∂sen von Instanzen von Typklassen (√ºber <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Implizite</a> ) <em>statisch</em> in der Kompilierungsphase.  Der Einfachheit halber k√∂nnen Typklassen f√ºr unsere Zwecke als <em>Erweiterungen</em> von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Kotlin</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">C # betrachtet werden</a> . </p><br><p>  Um ein Objekt zu verpf√§nden, m√ºssen wir nicht wissen, was dieses Objekt enth√§lt, welche Felder und Methoden es enth√§lt.  F√ºr uns ist es nur wichtig, dass das <code>log</code> mit einer bestimmten Signatur daf√ºr definiert wird.  Es w√§re <code>Logged</code> , in jeder Klasse eine bestimmte <code>Logged</code> Schnittstelle zu implementieren, und dies ist nicht immer m√∂glich - beispielsweise in Bibliotheks- oder Standardklassen.  Bei Typklassen ist alles viel einfacher.  Wir k√∂nnen eine Instanz der protokollierten <code>Logged</code> beispielsweise f√ºr Fixtures erstellen und in lesbarer Form anzeigen.  Erstellen Sie f√ºr alle anderen Typen eine Instanz f√ºr den <code>Any</code> Typ und verwenden Sie die Standard- <code>toString</code> Methode, um alle Objekte in ihrer internen Darstellung kostenlos zu protokollieren. </p><br><div class="spoiler">  <b class="spoiler_title">Ein Beispiel f√ºr die Tagged-Klasse und die dazugeh√∂rigen Instanzen</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Logged</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">A</span></span></span><span class="hljs-class">] </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">log</span></span></span></span>(a: <span class="hljs-type"><span class="hljs-type">A</span></span>)(<span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> logger: <span class="hljs-type"><span class="hljs-type">Logger</span></span>): <span class="hljs-type"><span class="hljs-type">A</span></span> } <span class="hljs-comment"><span class="hljs-comment">//   Future implicit def futureLogged[T]: Logged[Future[T]] = new Logged[Future[T]] { override def log(futureT: Future[T])(implicit logger: Logger): Future[T] = { futureT.map { t =&gt; // map  Future       ,   //  logger.info(t.toString()) t } } } // ,        implicit def anyNoLogged[T]: Logged[T] = new Logged[T] { override def log(t: T)(implicit logger: Logger): T = { logger.info(t.toString()) t } }</span></span></code> </pre> </div></div><br><p>  Zus√§tzlich zur Protokollierung k√∂nnen wir diesen Ansatz auf den gesamten Prozess der Vorbereitung von Vorrichtungen ausweiten.  Die Testl√∂sung bietet eigene Zeitklassen und die darauf basierende abstrakte Implementierung von Funktionen.  Die Verantwortung des Projekts, das es verwendet, besteht darin, eine eigene Instanz von Typklassen f√ºr Typen zu schreiben. </p><br><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">//    def makeFixture[STATE, FX, ROW, F[_]]( state: STATE, applyOverrides: F[ROW] =&gt; F[ROW] = x =&gt; x ): FX = (extractKeys andThen deduplicateKeys andThen enrichWithSampleData andThen applyOverrides andThen logged andThen buildFixture) (state) override def extractKeys(implicit toKeys: ToKeys[DbState]): DbState =&gt; Set[Key] = (db: DbState) =&gt; db.toKeys() override def enrichWithSampleData(implicit enrich: Enrich[Key]): Key =&gt; Set[Row] = (key: Key) =&gt; key.enrich() override def buildFixture(implicit insert: Insertable[Set[Row]]): Set[Row] =&gt; DbFixture = (rows: Set[Row]) =&gt; rows.insert() // ,   - (, )   trait ToKeys[A] { def toKeys(a: A): Set[Key] // Something =&gt; Set[Key] } // ...    trait Enrich[A] { def enrich(a: A): Set[Row] // Set[Key] =&gt; Set[Row] } // ...     trait Insertable[A] { def insert(a: A): DbFixture // Set[Row] =&gt; DbFixture } //      (.     ) implicit val toKeys: ToKeys[DbState] = ??? implicit val enrich: Enrich[Key] = ??? implicit val insert: Insertable[Set[Row]] = ???</span></span></code> </pre> <br><p>  Bei der Entwicklung des Vorrichtungsgenerators habe ich mich auf die Umsetzung der Prinzipien der Programmierung und des SOLID-Entwurfs als Indikator f√ºr seine Stabilit√§t und Anpassungsf√§higkeit an verschiedene Systeme konzentriert: </p><br><ul><li>  <em>Das Prinzip der Einzelverantwortung</em> : Jede Typklasse beschreibt genau einen Aspekt des Typverhaltens. </li><li>  <em>Das Open-Closed-Prinzip</em> : Wir √§ndern den vorhandenen Kampftyp nicht f√ºr Tests, sondern erweitern ihn um Instanzen von Tymplass. </li><li>  <em>Das Liskov-Substitutionsprinzip</em> spielt in diesem Fall keine Rolle, da wir keine Vererbung verwenden. </li><li>  <em>Das Prinzip der Schnittstellentrennung</em> : Wir verwenden viele spezialisierte Zeitklassen anstelle einer einzigen globalen. </li><li>  <em>Das Prinzip der Abh√§ngigkeitsinversion</em> : Die Implementierung des Fixture Generators h√§ngt nicht von bestimmten Kampftypen ab, sondern von abstrakten Zeitklassen. </li></ul><br><p>  Nachdem sichergestellt wurde, dass alle Prinzipien erf√ºllt sind, kann argumentiert werden, dass unsere L√∂sung ausreichend unterst√ºtzt und erweiterbar erscheint, um sie in verschiedenen Projekten zu verwenden. </p><br><p>  Nachdem wir die Funktionen des Lebenszyklus, die Generierung von Fixtures und die Konvertierung von Datens√§tzen in Fixtures sowie die Abstraktion von einem bestimmten Dom√§nenmodell der Anwendung geschrieben haben, sind wir endlich bereit, unsere L√∂sung auf alle Tests zu skalieren. </p><br><h2 id="itogi">  Zusammenfassung </h2><br><p>  Wir sind vom traditionellen (schrittweisen) Stil des Testdesigns zum funktionalen √ºbergegangen.  Ein schrittweiser Stil ist in der Anfangsphase und bei kleinen Projekten insofern gut, als er keinen zus√§tzlichen Arbeitsaufwand erfordert und den Entwickler nicht einschr√§nkt, aber zu verlieren beginnt, wenn viele Tests f√ºr das Projekt durchgef√ºhrt werden.  Der Funktionsstil ist nicht darauf ausgelegt, alle Probleme beim Testen zu l√∂sen, kann jedoch die Skalierung und Unterst√ºtzung von Tests in Projekten, deren Anzahl Hunderte oder Tausende betr√§gt, erheblich erleichtern.  Funktionsstiltests sind kompakter und konzentrieren sich auf das, was wirklich wichtig ist (Daten, testbarer Code und erwartetes Ergebnis), und nicht auf Zwischenschritte. </p><br><p>  Dar√ºber hinaus haben wir uns ein lebendiges Beispiel daf√ºr angesehen, wie leistungsf√§hig die Konzepte von Komposition und Typklassen in der funktionalen Programmierung sind.  Mit ihrer Hilfe ist es einfach, L√∂sungen zu entwerfen, deren Erweiterbarkeit und Wiederverwendbarkeit ein wesentlicher Bestandteil sind. </p><br><p>      ,         ,     ,    .    ,   ,     ,     -.    ,        .   ! </p><br><hr><br><p>     : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Github</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de463623/">https://habr.com/ru/post/de463623/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de463609/index.html">Empfehlungssystem f√ºr Directum Club. Erster Teil, kollaborativ</a></li>
<li><a href="../de463611/index.html">Fantastische Plugins, vol. 2. √úben</a></li>
<li><a href="../de463613/index.html">Docker-Images k√∂nnen auch mit der √ºblichen Docker-Datei in werf erstellt werden</a></li>
<li><a href="../de463617/index.html">Funktionen zum Testen von mobilem MMO</a></li>
<li><a href="../de463619/index.html">Fernarbeit: unsere Erfahrung</a></li>
<li><a href="../de463625/index.html">Netzwerk√ºberwachung und Erkennung abnormaler Netzwerkaktivit√§ten mithilfe von Flowmon Networks-L√∂sungen</a></li>
<li><a href="../de463627/index.html">Assembler-Codegenerator-Bibliothek f√ºr AVR-Mikrocontroller. Teil 4</a></li>
<li><a href="../de463629/index.html">Konfigurieren von NextCloud + ONLYOFFICE auf demselben Server mit Docker</a></li>
<li><a href="../de463631/index.html">Dialoge √ºber Briefe</a></li>
<li><a href="../de463637/index.html">Testen Sie Ihre Infrastruktur als Code mit Pulumi. Teil 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>