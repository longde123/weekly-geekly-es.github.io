<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§µüèæ üöì ü§üüèΩ RabbitMQ - SQL Server üåæ üë©üèª‚Äçüç≥ üßõ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il y a une semaine ou deux, j'ai vu un message sur le forum des utilisateurs de RabbitMQ expliquant comment configurer l'envoi de messages de SQL Serv...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>RabbitMQ - SQL Server</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/419457/">  Il y a une semaine ou deux, j'ai vu un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">message</a> sur le forum des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utilisateurs de RabbitMQ expliquant</a> comment configurer l'envoi de messages de SQL Server √† RabbitMQ.  Puisque nous travaillons en √©troite collaboration avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Derivco</a> , j'ai laiss√© quelques suggestions l√†-bas et j'ai √©galement dit que j'√©crivais un blog sur la fa√ßon de proc√©der.  Une partie de mon message n'√©tait pas enti√®rement vraie - du moins jusqu'√† ce moment (d√©sol√©, Bro, il √©tait tr√®s occup√©). <br><br>  Chose g√©niale, c'est votre <b>SQL Server</b> .  Son utilisation est tr√®s simple pour mettre des informations dans une base de donn√©es.  La r√©cup√©ration des donn√©es d'une base de donn√©es √† l'aide d'une requ√™te est tout aussi simple.  Mais obtenir les donn√©es juste mises √† jour ou coll√©es est d√©j√† un peu plus difficile.  Pensez aux √©v√©nements en temps r√©el;  un achat est effectu√© - quelqu'un doit en √™tre inform√© d√®s que cela se produit.  Peut-√™tre que quelqu'un dira que ces donn√©es ne doivent pas √™tre extraites de la base de donn√©es, mais ailleurs.  Bien s√ªr, c'est le cas, mais bien souvent, nous n'avons tout simplement pas le choix. <br><a name="habracut"></a><br>  Nous avions une t√¢che: envoyer des √©v√©nements de la base de donn√©es √† l'ext√©rieur pour un traitement ult√©rieur, et la question √©tait - comment faire cela? <br><br><h3>  SQL Server et communications externes </h3><br>  Au cours de l'existence de SQL Server, plusieurs tentatives ont √©t√© organis√©es pour organiser les communications en dehors de la base de donn√©es;  <b>SQL Server Notification Services</b> (NS), qui est apparu dans SQL Server 2000, et plus tard, dans SQL Server 2005, <b>SQL Server Service Broker</b> (SSB) est apparu.  Je les ai d√©crits dans mon livre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">A First Look at SQL Server 2005 for Developers</a> , avec Bob Boshemen et Dan Sullivan.  NS est apparu dans SQL Server 2000, comme je l'ai dit, et a √©t√© repens√© dans la version b√™ta de SQL Server 2005. Cependant, NS a √©t√© <s>compl√®tement</s> exclu de la version pr√™te √† la vente (RTM) de SQL Server 2005. <br><blockquote>  <b>Remarque:</b> Si vous lisez le livre, vous y trouverez un certain nombre de fonctionnalit√©s qui n'√©taient pas dans la version RTM. </blockquote>  SSB a surv√©cu et Microsoft a introduit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Service Broker External Activator</a> (EA) dans son pack de fonctionnalit√©s SQL Server 2008.  Il permet via la SSB d'interagir en dehors de la base de donn√©es locale.  Th√©oriquement, cela sonne bien, mais dans la pratique - c'est lourd et d√©routant.  Nous avons fait quelques tests et avons rapidement r√©alis√© qu'il ne faisait pas ce dont nous avions besoin.  De plus, SSB ne nous a pas donn√© les performances n√©cessaires, nous avons donc d√ª inventer autre chose. <br><br><h3>  SQLCLR </h3><br>  Ce √† quoi nous sommes parvenus √©tait bas√© sur la technologie SQLCLR.  SQLCLR est une plate-forme .NET qui est int√©gr√©e au noyau SQL Server et peut √™tre utilis√©e pour ex√©cuter du code .NET √† l'int√©rieur du noyau.  Puisque nous ex√©cutons du code .NET, nous pouvons presque tout faire comme dans une application .NET standard. <br><blockquote>  <b>Remarque:</b> j'ai √©crit ¬´presque¬ª ci-dessus, car il y a en fait quelques limitations.  Dans ce contexte, ces restrictions n'ont presque aucun effet sur ce que nous allons faire. <br></blockquote>  Le principe de fonctionnement de SQLCLR est le suivant: le code est compil√© dans une biblioth√®que dll, puis cette biblioth√®que est enregistr√©e √† l'aide des outils SQL Server: <br><br>  Build Assembly <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ASSEMBLY</span></span> [RabbitMQ.SqlServer] AUTHORIZATION rmq <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">'F:\some_path\RabbitMQSqlClr4.dll'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> PERMISSION_SET = <span class="hljs-keyword"><span class="hljs-keyword">UNSAFE</span></span>; GO</code> </pre> <br>  <b>Extrait de code 1:</b> cr√©ation d'un assemblage le long d'un chemin absolu <br><br>  Le code effectue les actions suivantes: <br><br><ul><li>  <code>CREATE ASSEMBLY</code> - Cr√©e un assemblage avec le nom donn√© (quel qu'il soit). </li><li>  <code>AUTHORIZATION</code> - Indique le propri√©taire de l'assemblage.  Dans ce cas, rmq est un r√¥le SQL Server pr√©d√©fini. </li><li>  <code>FROM</code> - D√©termine l'emplacement de l'assemblage d'origine.  Dans la <code>FROM</code> , vous pouvez √©galement sp√©cifier le chemin au format binaire ou UNC.  Les fichiers d'installation de ce projet utilisent une repr√©sentation binaire. </li><li>  <code>WITH PERMISSION_SET</code> - D√©finit les autorisations.  <code>UNSAFE</code> est le moins strict et est requis dans ce cas. </li></ul><br><blockquote>  <b>Remarque:</b> ind√©pendamment du r√¥le ou de la connexion utilis√©s dans la clause AUTHORIZATION, la classe appdomain doit √™tre cr√©√©e avec le m√™me nom que lors du chargement de l'assembly dans le domaine.  Il est recommand√© de s√©parer les assemblys avec des noms diff√©rents de classes de domaine d'application afin que lorsqu'un assemblage √©choue, les autres ne tombent pas.  Cependant, si les assemblages d√©pendent les uns des autres, ils ne peuvent pas √™tre divis√©s en diff√©rentes classes. <br></blockquote>  Lorsque l'assembly est cr√©√©, nous y faisons des wrappers de m√©thodes .NET: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> rmq.pr_clr_PostRabbitMsg @EndpointID <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, @Message <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXTERNAL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> [RabbitMQ.SqlServer].[RabbitMQSqlClr.RabbitMQSqlServer].[pr_clr_PostRabbitMsg]; GO</code> </pre><br>  <b>Extrait de code 2:</b> wrapper de m√©thode .NET <br><br>  Le code effectue les actions suivantes: <br><br><ul><li>  Cr√©e une proc√©dure stock√©e T-SQL nomm√©e <code>rmq.pr_clr_PostRabbitMsg</code> qui prend deux param√®tres;  <code>@EndpointID</code> et <code>@Message</code> . </li><li>  Au lieu du corps de la proc√©dure, une source externe est utilis√©e, qui se compose de: <br><ul><li>  Un assembly nomm√© <code>RabbitMQ.SqlServer</code> , c'est-√†-dire l'agr√©gat que nous avons cr√©√© ci-dessus dans l' <b>extrait de code 1</b> . </li><li>  Type complet (espace de noms et classe): <code>RabbitMQSqlClr.RabbitMQSqlServer</code> </li><li>  La m√©thode de l'espace de noms et de la classe ci-dessus est: <code>pr_clr_PostRabbitMsg</code> . </li></ul></li></ul><br>  Lorsque <code>rmq.pr_clr_PostRabbitMsg</code> , la m√©thode <code>pr_clr_PostRabbitMsg</code> sera appel√©e. <br><blockquote>  <b>Remarque:</b> lors de la cr√©ation d'une proc√©dure, le nom de l'assembly n'est pas sensible √† la casse, contrairement au nom complet du type et de la m√©thode.  Il n'est pas n√©cessaire que le nom de la proc√©dure en cours de cr√©ation corresponde au nom de la m√©thode.  Cependant, les types de donn√©es finaux pour les param√®tres doivent correspondre. </blockquote>  Comme je l'ai dit plus t√¥t, chez Derivco, nous devons envoyer des donn√©es en dehors de SQL Server, nous utilisons donc SQLCLR et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RabbitMQ</a> (RMQ). <br><br><h3>  Rabbitmq </h3><br>  RMQ est un courtier de messages open source qui impl√©mente le protocole AMQP (Advanced Message Queuing Protocol) et est √©crit en Erlang. <br><br>  √âtant donn√© que RMQ est un courtier de messages, les biblioth√®ques clientes AMQP sont requises pour s'y connecter.  L'application fait r√©f√©rence aux biblioth√®ques clientes et, avec leur aide, ouvre une connexion et envoie des messages - comme, par exemple, il y a un appel via ADO.NET √† SQL Server.  Mais contrairement √† ADO.NET, o√π, tr√®s probablement, la connexion s'ouvre √† chaque fois que vous acc√©dez √† la base de donn√©es, ici, la connexion reste ouverte pour toute la p√©riode de l'application. <br><br>  Ainsi, afin de pouvoir interagir √† partir de la base de donn√©es avec RabbitMQ, nous avons besoin de l'application et de la biblioth√®que cliente .NET pour RabbitMQ. <br><blockquote>  <b>Remarque:</b> dans la prochaine partie de cet article, des fragments de code RabbitMQ seront trouv√©s, mais sans explication d√©taill√©e de ce qu'ils font.  Si vous d√©butez avec RabbitMQ, je vous sugg√®re de consulter les diff√©rents <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">didacticiels RabbitMQ</a> pour comprendre le but du code.  Le tutoriel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Hello World</a> C # est un bon d√©but.  L'une des diff√©rences entre les manuels et les exemples de code est que les √©changeurs ne sont pas d√©clar√©s dans les exemples.  Ils sont cens√©s √™tre pr√©d√©finis. </blockquote><h3>  RabbitMQ.SqlServer </h3><br>  <b>RabbitMQ.SqlServer</b> est un assemblage utilisant la biblioth√®que cliente .NET pour RabbitMQ et offre la possibilit√© d'envoyer des messages de la base de donn√©es √† un ou plusieurs points de terminaison RabbitMQ (VHosts et √©changeurs).  Le code peut √™tre t√©l√©charg√© / fork√© depuis mon r√©f√©rentiel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RabbitMQ-SqlServer</a> sur GitHub.  Il contient les sources d'assemblage et les fichiers d'installation (c'est-√†-dire que vous n'avez pas √† les compiler vous-m√™me). <br><blockquote>  <b>Remarque:</b> ce n'est qu'un exemple pour montrer comment SQL Server peut interagir avec RabbitMQ.  Ce n'est PAS un produit fini ou m√™me une partie de celui-ci.  Si ce code vous brise le cerveau - ne me bl√¢mez pas, car ce n'est qu'un exemple. <br></blockquote><h3>  Fonctionnalit√© </h3><br>  Lorsque l'assembly est charg√©, ou lorsque son initialisation est explicitement appel√©e, ou lorsqu'elle est appel√©e indirectement, au moment de l'appel de la proc√©dure wrapper, l'assembly charge la cha√Æne de connexion dans la base de donn√©es locale dans laquelle il a √©t√© install√©, ainsi que les points de terminaison RabbitMQ auxquels il se connecte: <br><br>  Connexion <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InternalConnect</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { connFactory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConnectionFactory(); connFactory.Uri = connString; connFactory.AutomaticRecoveryEnabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; connFactory.TopologyRecoveryEnabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; RabbitConn = connFactory.CreateConnection(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = <span class="hljs-number"><span class="hljs-number">0</span></span>; x &lt; channels; x++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ch = RabbitConn.CreateModel(); rabbitChannels.Push(ch); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }</code> </pre> <br>  <b>Extrait de code 3:</b> connexion au point de terminaison <br><br>  Dans le m√™me temps, une partie de la connexion au point de terminaison cr√©e √©galement des IModels sur la connexion, et ils sont utilis√©s lors de l'envoi (ajout √† la file d'attente) de messages: <br><br>  Envoi de message <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Post</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> exchange, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] msg, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> topic</span></span></span><span class="hljs-function">)</span></span> { IModel <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> channelTryCount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((!rabbitChannels.TryPop(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>)) &amp;&amp; channelTryCount &lt; <span class="hljs-number"><span class="hljs-number">100</span></span>) { channelTryCount += <span class="hljs-number"><span class="hljs-number">1</span></span>; Thread.Sleep(<span class="hljs-number"><span class="hljs-number">50</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (channelTryCount == <span class="hljs-number"><span class="hljs-number">100</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> errMsg = <span class="hljs-string"><span class="hljs-string">$"Channel pool blocked when trying to post message to Exchange: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{exchange}</span></span></span><span class="hljs-string">."</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApplicationException(errMsg); } <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.BasicPublish(exchange, topic, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, msg); rabbitChannels.Push(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { _rabbitChannels.Push(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; } }</code> </pre> <br>  La m√©thode <code>Post</code> est appel√©e √† partir de la m√©thode <code>pr_clr_PostRabbitMsg(int endPointId, string msgToPost)</code> , qui a √©t√© pr√©sent√©e comme une proc√©dure utilisant la clause <code>CREATE PROCEDURE</code> dans le fragment de code 2: <br><br>  M√©thode post-appel <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pr_clr_PostRabbitMsg</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> endPointId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> msgToPost</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(endPointId == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApplicationException(<span class="hljs-string"><span class="hljs-string">"EndpointId cannot be 0"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isInitialised) { pr_clr_InitialiseRabbitMq(); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> msg = Encoding.UTF8.GetBytes(msgToPost); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (endPointId == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rep <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> remoteEndpoints) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> exch = rep.Value.Exchange; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> topic = rep.Value.RoutingKey; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pub <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> rabbitPublishers.Values) { pub.Post(exch, msg, topic); } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { RabbitPublisher pub; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rabbitPublishers.TryGetValue(endPointId, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> pub)) { pub.Post(remoteEndpoints[endPointId].Exchange, msg, remoteEndpoints[endPointId].RoutingKey); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApplicationException(<span class="hljs-string"><span class="hljs-string">$"EndpointId: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{endPointId}</span></span></span><span class="hljs-string">, does not exist"</span></span>); } } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; } }</code> </pre> <br>  <b>Extrait de code 5:</b> repr√©sentation d'une m√©thode en tant que proc√©dure <br><br>  Lorsque la m√©thode est ex√©cut√©e, il est suppos√© que l'appelant envoie l'identifiant du point d'extr√©mit√© auquel le message doit √™tre transmis, et, en fait, le message lui-m√™me.  Si la valeur -1 est transmise comme identifiant du point de terminaison, nous it√©rons sur tous les points et envoyons un message √† chacun d'eux.  Le message se pr√©sente sous la forme d'une cha√Æne √† partir de laquelle nous obtenons des octets √† l'aide d' <code>Encoding.UTF8.GetBytes</code> .  Dans un environnement de production, l'appel <code>Encoding.UTF8.GetBytes</code> doit √™tre remplac√© par la s√©rialisation. <br><br><h3>  L'installation </h3><br>  Pour installer et ex√©cuter l'exemple, vous avez besoin de tous les fichiers du dossier <code>src\SQL</code> .  Pour installer, proc√©dez comme suit: <br><br><ul><li>  Ex√©cutez le script <code>01.create_database_and_role.sql</code> .  Il cr√©era: <br><ul><li>  Base de donn√©es de test <code>RabbitMQTest</code> o√π l'assembly sera cr√©√©. </li><li>  r√¥le <code>rmq</code> √† affecter en tant que propri√©taire de l'assembly </li><li>  , qui sera √©galement appel√© <code>rmq</code> .  Dans ce diagramme, divers objets de base de donn√©es sont cr√©√©s. <br></li></ul><br></li><li>  Ex√©cutez le fichier <code>02.create_database_objects.sql</code> .  Il cr√©era: <br><br><ul><li>  la table <code>rmq.tb_RabbitSetting</code> , qui stockera la cha√Æne de connexion dans la base de donn√©es locale. </li><li>  La table <code>rmq.tb_RabbitEndpoint</code> , dans laquelle un ou plusieurs points de terminaison <code>RabbitMQ</code> seront stock√©s. </li></ul><br></li><li>  Dans le fichier <code>03.create_localhost_connstring.sql</code> remplacez la valeur de la variable <code>@connString</code> par la cha√Æne de connexion correcte pour la base de donn√©es <code>RabbitMQTest</code> cr√©√©e √† l'√©tape 1 et ex√©cutez le script. <br></li></ul><br>  Avant de continuer, vous devez avoir une instance en cours d'ex√©cution du courtier RabbitMQ et de VHost (par d√©faut, VHost est repr√©sent√© par /).  En r√®gle g√©n√©rale, nous avons plusieurs VHost, juste pour l'isolement.  Cet h√¥te a √©galement besoin d'un √©changeur, dans l'exemple que nous utilisons <code>amq.topic</code> .  Lorsque votre courtier RabbitMQ est pr√™t, modifiez les <code>rmq.pr_UpsertRabbitEndpoint</code> proc√©dure <code>rmq.pr_UpsertRabbitEndpoint</code> , qui se trouve dans le fichier <code>04.upsert_rabbit_endpoint.sql</code> : <br><br>  Endpoint RabbitMQ <br><br><pre> <code class="cs hljs">EXEC rmq.pr_UpsertRabbitEndpoint @Alias = <span class="hljs-string"><span class="hljs-string">'rabbitEp1'</span></span>, @ServerName = <span class="hljs-string"><span class="hljs-string">'RabbitServer'</span></span>, @Port = <span class="hljs-number"><span class="hljs-number">5672</span></span>, @VHost = <span class="hljs-string"><span class="hljs-string">'testHost'</span></span>, @LoginName = <span class="hljs-string"><span class="hljs-string">'rabbitAdmin'</span></span>, @LoginPassword = <span class="hljs-string"><span class="hljs-string">'some_secret_password'</span></span>, @Exchange = <span class="hljs-string"><span class="hljs-string">'amq.topic'</span></span>, @RoutingKey = <span class="hljs-string"><span class="hljs-string">'#'</span></span>, @ConnectionChannels = <span class="hljs-number"><span class="hljs-number">5</span></span>, @IsEnabled = <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  <b>Extrait de code 6:</b> cr√©ation d'un point de terminaison dans RabbitMQ <br><br>  √Ä ce stade, il est temps de d√©ployer des assemblys.  Il existe des diff√©rences dans les options de d√©ploiement pour les versions de SQL Server ant√©rieures √† SQL Server 2014 (2005, 2008, 2008R2, 2012) et pour 2014 et ult√©rieur.  La diff√©rence r√©side dans la version prise en charge du CLR.  Avant SQL Server 2014, la plate-forme .NET fonctionnait dans la version 2 du CLR et dans SQL Server 2014 et versions ult√©rieures, la version 4 √©tait utilis√©e. <br><br><h3>  SQL Server 2005 - 2012 </h3><br>  Commen√ßons par les versions de SQL Server qui s'ex√©cutent sur CLR 2, car elles ont leurs propres caract√©ristiques.  Nous devons d√©ployer l'assembly cr√©√© et d√©ployer en m√™me temps la biblioth√®que .NET du client <code>RabbitMQ.Client</code> ( <code>RabbitMQ.Client</code> ).  De notre assemblage, nous ferons r√©f√©rence √† la biblioth√®que client RabbitMQ.  Parce que  Puisque nous pr√©voyons d'utiliser CLR 2, notre assemblage et <code>RabbitMQ.Client</code> devraient √™tre compil√©s sur la base de .NET 3.5.  Il y a des probl√®mes. <br><br>  Toutes les derni√®res versions de la biblioth√®que <code>RabbitMQ.Client</code> sont compil√©es pour l'environnement CLR 4, elles ne peuvent donc pas √™tre utilis√©es dans notre assemblage.  La derni√®re version des biblioth√®ques clientes pour CLR 2 est compil√©e sur .NET 3.4.3.  Mais m√™me si nous essayons de d√©ployer cet assembly, nous obtenons un message d'erreur: <br><br><img src="https://habrastorage.org/webt/db/yo/uj/dbyouj4az0fzhnwpkvtdkgj6i-q.png"><br>  <i><b>Figure 1:</b> assemblage System.ServiceModel manquant</i> <br><br>  Cette version de <code>RabbitMQ.Client</code> fait r√©f√©rence √† un assembly qui ne fait pas partie du CLR SQL Server.  Il s'agit d'un assembly WCF, et c'est l'une des limitations de SQLCLR que j'ai mentionn√©es ci-dessus: cet assembly particulier est destin√© aux types de t√¢ches qui ne peuvent pas √™tre ex√©cut√©es dans SQL Server.  Les versions r√©centes de <code>RabbitMQ.Client</code> n'ont pas ces d√©pendances, elles peuvent donc √™tre utilis√©es sans aucun probl√®me, √† l'exception des exigences g√™nantes du CLR 4. Que dois-je faire? <br><br>  Comme vous le savez, RabbitMQ est open source, mais nous sommes des d√©veloppeurs, non?  ;) Alors recompilons!  Dans la version ant√©rieure aux derni√®res versions (c'est-√†-dire la version &lt;3.5.0) de <code>RabbitMQ.Client</code> j'ai supprim√© les liens vers <code>System.ServiceModel</code> et recompil√©.  J'ai d√ª modifier quelques lignes de code √† l'aide de la fonctionnalit√© <code>System.ServiceModel</code> , mais il s'agissait de modifications mineures. <br><br>  Dans cet exemple, je n'ai pas utilis√© la version client 3.4.3, mais j'ai pris la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">version stable 3.6.6</a> et recompil√© √† l'aide de .NET 3.5 (CLR 2).  Cela a presque fonctionn√© :), sauf que les versions ult√©rieures de <code>RabbitMQ.Client</code> utilisent <code>Task</code> 'et qui ne font pas partie √† l'origine de .NET 3.5. <br><br>  Heureusement, il existe une version de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>System.Threading.dll</code></a> pour .NET 3.5 qui inclut la <code>Task</code> .  Je l'ai t√©l√©charg√©, mis en place les liens et tout s'est pass√©!  Ici, l'astuce principale est que <code>System.Threading.dll</code> doit √™tre install√© avec l'assembly. <br><blockquote>  <b>Remarque: la</b> source de <code>RabbitMQ.Client</code> , √† partir de laquelle j'ai compil√© une version de .NET 3.5, se trouve dans mon r√©f√©rentiel sur GitHub <a href="">RabbitMQ Client 3.6.6 .NET 3.5</a> .  Le fichier binaire DLL avec <code>System.Threading.dll</code> pour .NET 3.5 se trouve √©galement dans le <code>lib\NET3.5</code> r√©f√©rentiel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">(RabbitMQ-SqlServer)</a> . <br></blockquote>  Pour installer les assemblys n√©cessaires ( <code>System.Threading</code> , <code>RabbitMQ.Client</code> et <code>RabbitMQ.SqlServer</code> ), ex√©cutez les scripts d'installation √† partir du r√©pertoire <code>src\sql</code> dans l'ordre suivant: <br><br><ol><li>  <code>05.51.System.Threading.sql2k5-12.sql</code> - System.Threading </li><li>  <code>05.52.RabbitMQ.Client.sql2k5-12.sql</code> - RabbitMQ.Client </li><li>  <code>05.53.RabbitMQ.SqlServer.sql2k5-12.sql</code> - RabbitMQ.SqlServer </li></ol><br><h3>  SQL Server 2014+ </h3><br>  Dans SQL Server 2014 et versions ult√©rieures, l'assembly se compile sous .NET 4.XX (mon exemple est sur 4.5.2), et vous pouvez r√©f√©rencer n'importe laquelle des derni√®res versions de <code>RabbitMQ.Client</code> , qui peuvent √™tre obtenues √† l'aide de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NuGet</a> .  Dans mon exemple, j'utilise 4.1.1.  <code>RabbitMQ.Client</code> , qui se trouve √©galement dans le <code>lib\NET4</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©f√©rentiel (RabbitMQ-SqlServer)</a> . <br><br>  Pour installer, ex√©cutez les scripts √† partir du r√©pertoire <code>src\sql</code> dans l'ordre suivant: <br><br><ol><li>  <code>05.141.RabbitMQ.Client.sql2k14+.sql</code> - RabbitMQ.Client </li><li>  <code>05.142.RabbitMQ.SqlServer.sql2k14+.sql</code> - RabbitMQ.SqlServer </li></ol><br><h3>  Wrappers de m√©thode SQL </h3><br>  Pour cr√©er des proc√©dures qui seront utilis√©es √† partir de notre assembly (3.5 ou 4), ex√©cutez le script <code>06.create_sqlclr_procedures.sql</code> .  Il cr√©era des proc√©dures T-SQL pour trois m√©thodes .NET: <br><br><ul><li>  <code>rmq.pr_clr_InitialiseRabbitMq</code> appelle <code>pr_clr_InitialiseRabbitMq</code> .  Utilis√© pour charger et initialiser l'assembly RabbitMQ.SqlServer. </li><li>  <code>rmq.pr_clr_ReloadRabbitEndpoints</code> appelle <code>pr_clr_ReloadRabbitEndpoints</code> .  Charge diff√©rents points de terminaison RabbitMQ. </li><li>  <code>rmq.pr_clr_PostRabbitMsg</code> appelle <code>pr_clr_PostRabbitMsg</code> .  Utilis√© pour envoyer des messages √† RabbitMQ. </li></ul><br>  Le script cr√©e √©galement une proc√©dure T-SQL simple - <code>rmq.pr_PostRabbitMsg</code> , qui s'applique √† <code>rmq.pr_clr_PostRabbitMsg</code> .  Il s'agit d'une proc√©dure d'encapsulation qui sait quoi faire avec les donn√©es, g√®re les exceptions, etc.  Dans un environnement de production, nous avons plusieurs proc√©dures similaires qui traitent diff√©rents types de messages.  En savoir plus √† ce sujet ci-dessous. <br><br><h3>  Utiliser </h3><br>  De tout ce qui pr√©c√®de, il est clair que pour envoyer des messages √† RabbitMQ, nous appelons <code>rmq.pr_PostRabbitMsg</code> ou <code>rmq.pr_clr_PostRabbitMsg</code> , en transmettant dans les param√®tres l'identifiant du point de terminaison et le message lui-m√™me sous forme de cha√Æne.  Tout cela, bien s√ªr, est cool, mais j'aimerais voir comment cela fonctionnera en r√©alit√©. <br><br>  Ce que nous faisons dans les environnements de production, c'est que dans les proc√©dures stock√©es qui traitent les donn√©es qui doivent √™tre envoy√©es √† RabbitMQ, nous collectons les donn√©es √† envoyer et dans le bloc de connexion, nous appelons une proc√©dure comme <code>rmq.pr_PostRabbitMsg</code> .  Voici un exemple tr√®s simplifi√© d'une telle proc√©dure: <br><br>  Proc√©dure de traitement des donn√©es <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> dbo.pr_SomeProcessingStuff @<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY <span class="hljs-comment"><span class="hljs-comment">--     DECLARE @endPointId int; --    DECLARE @msg nvarchar(max) = '{' --        SET @msg = @msg + '"Id":' + CAST(@id AS varchar(10)) + ',' --  -  SET @msg = @msg + '"FName":"Hello",'; SET @msg = @msg + '"LName":"World"'; SET @msg = @msg + '}'; -- -  --     -,  -  SELECT @endPointId = 1; --    --     EXEC rmq.pr_PostRabbitMsg @Message = @msg, @EndpointID = @endPointId; END TRY BEGIN CATCH DECLARE @errMsg nvarchar(max); DECLARE @errLine int; SELECT @errMsg = ERROR_MESSAGE(), @errLine = ERROR_LINE(); RAISERROR('Error: %s at line: %d', 16, -1, @errMsg, @errLine); END CATCH END</span></span></code> </pre> <br>  Dans le <b>fragment de code 7,</b> nous voyons comment les donn√©es n√©cessaires sont captur√©es et trait√©es dans la proc√©dure et envoy√©es apr√®s le traitement.  Pour utiliser cette proc√©dure, ex√©cutez le script <code>07.create_processing_procedure.sql</code> partir du r√©pertoire <code>src\SQL</code> . <br><br><h3>  Courons tout </h3><br>  √Ä ce stade, vous devez √™tre pr√™t √† envoyer des messages.  Avant de tester, assurez-vous que des files d'attente dans RabbitMQ sont attach√©es √† l'√©changeur de noeud final dans <code>rmq.tb_RabbitEndpoint</code> . <br><br>  Donc, pour commencer, vous devez faire ce qui suit: <br>  Ouvrez le fichier <code>99.test_send_message.sql</code> . <br>  Ex√©cuter <br><br><pre> <code class="sql hljs">EXEC rmq.pr_clr_InitialiseRabbitMq;</code> </pre> <br>  pour initialiser l'assemblage et charger les points de terminaison RabbitMQ.  Cela n'est pas obligatoire, mais il est recommand√© de pr√©charger l'assemblage apr√®s sa cr√©ation ou sa modification. <br><br>  Ex√©cuter <br><br><pre> <code class="sql hljs">EXEC dbo.pr_SomeProcessingStuff @id = 101</code> </pre> <br>  (vous pouvez utiliser tout autre identifiant que vous aimez). <br><br>  Si tout a fonctionn√© sans erreur, un message devrait appara√Ætre dans la file d'attente RabbitMQ!  Vous avez donc utilis√© SQLCLR pour envoyer un message √† RabbitMQ. <br><br>  F√©licitations! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr419457/">https://habr.com/ru/post/fr419457/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr419443/index.html">La NASA s'envolera √† nouveau vers la lune, rendant tous les √©l√©ments de l'avion</a></li>
<li><a href="../fr419445/index.html">Tests unitaires pour les projets Arduino</a></li>
<li><a href="../fr419449/index.html">API de contexte Redux vs React</a></li>
<li><a href="../fr419451/index.html">Cr√©ez pas √† pas un bundle pour Symfony 4</a></li>
<li><a href="../fr419453/index.html">M√©thodes num√©riques pour r√©soudre des syst√®mes d'√©quations non lin√©aires</a></li>
<li><a href="../fr419459/index.html">Batteries au plomb: alphabet de charge d'impulsion</a></li>
<li><a href="../fr419461/index.html">Ventilation des toilettes</a></li>
<li><a href="../fr419467/index.html">De l'ampoule √† l'aspirateur et au drone - comment nous avons appris √† Alice √† g√©rer des centaines d'appareils</a></li>
<li><a href="../fr419469/index.html">UE4 | Le cycle du jour et de la nuit | Modification de SkySphere</a></li>
<li><a href="../fr419471/index.html">Option de migration de jQuery vers javascript pur</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>