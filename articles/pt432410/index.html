<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëéüèæ üë©üèª‚Äç‚úàÔ∏è üóÑÔ∏è Entidades no estilo DDD com Entity Framework Core ü¶Å üèÇüèª ü¶ç</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este artigo √© sobre como aplicar os princ√≠pios DDD (Domain-Driven Design) √†s classes mapeadas pelo Entity Framework Core (EF Core) no banco de dados e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Entidades no estilo DDD com Entity Framework Core</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/432410/">  Este artigo √© sobre como aplicar os princ√≠pios DDD (Domain-Driven Design) √†s classes mapeadas pelo Entity Framework Core (EF Core) no banco de dados e por que isso pode ser √∫til. <br><br><h3>  TLDR </h3><br>  H√° muitas vantagens na abordagem DDD, mas o principal √© que o DDD transfere o c√≥digo das opera√ß√µes de cria√ß√£o / modifica√ß√£o dentro da classe da entidade.  Isso reduz significativamente as chances de um desenvolvedor entender / interpretar mal as regras para criar, inicializar e usar inst√¢ncias de classe. <br><a name="habracut"></a><br><ol><li>  O livro de Eric Evans e seus discursos n√£o t√™m muita informa√ß√£o sobre esse assunto: </li><li>  Forne√ßa ao cliente um modelo simples para obter objetos persistentes (classes) e gerenciar seu ciclo de vida. </li><li>  Suas classes de entidade devem declarar explicitamente se podem ser alteradas, como e por quais regras. </li><li> No DDD, existe o conceito de agregado.  Agregado √© uma √°rvore de entidades relacionadas.  De acordo com as regras do DDD, o trabalho com agregados deve ser realizado atrav√©s da ‚Äúraiz de agrega√ß√£o‚Äù (a ess√™ncia da raiz da √°rvore). </li></ol><br>  Eric menciona reposit√≥rios em seus discursos.  N√£o recomendo implementar um reposit√≥rio com o EF Core, porque o EF j√° implementa o reposit√≥rio e os padr√µes de unidade de trabalho em si.  Vou falar mais sobre isso em um artigo separado: " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Vale a pena usar um reposit√≥rio com o EF Core</a> ?" <br><br><h3>  Entidades no estilo DDD </h3><br>  Come√ßarei mostrando o c√≥digo da entidade no estilo DDD e comparando-o com o modo como as entidades com o EF Core s√£o geralmente criadas (nota do tradutor. O autor chama a palavra "geralmente" de um modelo an√™mico.) Neste exemplo, utilizarei o banco de dados da Internet livraria (uma vers√£o muito simplificada da Amazon. ‚ÄùA estrutura do banco de dados √© mostrada na imagem abaixo. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7e3/03d/4be/7e303d4bea08c1f34afa0d9848a2ff72.png" alt="imagem"><br><br>  As quatro primeiras tabelas representam tudo sobre os livros: os pr√≥prios livros, seus autores, resenhas.  As duas tabelas abaixo s√£o usadas no c√≥digo de l√≥gica de neg√≥cios.  Este t√≥pico √© descrito em detalhes em um artigo separado. <br><blockquote>  Todo o c√≥digo deste artigo foi carregado no reposit√≥rio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GenericBizRunner no GitHub</a> .  Al√©m do c√≥digo da biblioteca GenericBizRunner, h√° outro exemplo de um aplicativo ASP.NET Core que usa o GenericBizRunner para trabalhar com a l√≥gica de neg√≥cios.  Mais sobre isso est√° escrito no artigo " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Biblioteca para trabalhar com l√≥gica de neg√≥cios e Entity Framework Core</a> ". </blockquote>  E aqui est√° o c√≥digo da entidade correspondente √† estrutura do banco de dados. <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Book</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> PromotionalTextLength = <span class="hljs-number"><span class="hljs-number">200</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> BookId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//‚Ä¶ all other properties have a private set //These are the DDD aggregate propties: Reviews and AuthorLinks public IEnumerable&lt;Review&gt; Reviews =&gt; _reviews?.ToList(); public IEnumerable&lt;BookAuthor&gt; AuthorsLink =&gt; _authorsLink?.ToList(); //private, parameterless constructor used by EF Core private Book() { } //public constructor available to developer to create a new book public Book(string title, string description, DateTime publishedOn, string publisher, decimal price, string imageUrl, ICollection&lt;Author&gt; authors) { //code left out } //now the methods to update the book's properties public void UpdatePublishedOn(DateTime newDate)‚Ä¶ public IGenericErrorHandler AddPromotion(decimal newPrice, string promotionalText)‚Ä¶ public void RemovePromotion()‚Ä¶ //now the methods to update the book's aggregates public void AddReview(int numStars, string comment, string voterName, DbContext context)‚Ä¶ public void RemoveReview(Review review)‚Ä¶ }</span></span></code> </pre> <br>  O que procurar: <br><br><ol><li>  Linha 5: defina o acesso a todas as propriedades da entidade declaradas privadas.  Isso significa que os dados podem ser modificados usando o construtor ou os m√©todos p√∫blicos descritos mais adiante neste artigo. </li><li>  As linhas 9 e 10. As cole√ß√µes relacionadas (os mesmos agregados do DDD) fornecem acesso p√∫blico a IEnumerable &lt;T&gt;, n√£o ICollection &lt;T&gt;.  Isso significa que voc√™ n√£o pode adicionar ou remover itens da cole√ß√£o diretamente.  Voc√™ precisar√° usar m√©todos especializados da classe Book. </li><li>  Linha 13. O EF Core requer um construtor sem par√¢metros, mas pode ter acesso privado.  Isso significa que outro c√≥digo de aplicativo n√£o poder√° ignorar a inicializa√ß√£o e criar inst√¢ncias de classes usando um construtor n√£o param√©trico (coment√°rio de um tradutor. A menos, √© claro, que voc√™ crie entidades usando apenas reflex√£o) </li><li>  Linhas 16-20: A √∫nica maneira de criar uma inst√¢ncia da classe Book √© usar o construtor p√∫blico.  Este construtor cont√©m todas as informa√ß√µes necess√°rias para inicializar o objeto.  Assim, √© garantido que o objeto esteja em um estado v√°lido. </li><li>  Linhas 23-25: Essas linhas cont√™m m√©todos para alterar o estado de um livro. </li><li>  Linhas 28 a 29: esses m√©todos permitem alterar entidades relacionadas (agregadas) </li></ol><br>  Os m√©todos nas linhas 23-39, continuarei chamando os "m√©todos que fornecem acesso".  Esses m√©todos s√£o a √∫nica maneira de alterar as propriedades e os relacionamentos dentro de uma entidade.  A conclus√£o √© que a classe Book est√° "fechada".  Ele √© criado por meio de um construtor especial e pode ser modificado apenas parcialmente por m√©todos especiais com nomes adequados.  Essa abordagem cria um contraste n√≠tido com a abordagem padr√£o para criar / modificar entidades no EF Core, na qual todas as entidades cont√™m um construtor padr√£o vazio e todas as propriedades s√£o declaradas p√∫blicas.  A pr√≥xima pergunta √©: por que a primeira abordagem √© melhor? <br><br><h3>  Compara√ß√£o de cria√ß√£o de entidades </h3><br>  Vamos comparar o c√≥digo para obter dados sobre v√°rios livros do json e criar inst√¢ncias das classes Book com base. <br><br><h3>  a.  Abordagem padr√£o </h3><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> price = (<span class="hljs-keyword"><span class="hljs-keyword">decimal</span></span>) (bookInfoJson.saleInfoListPriceAmount ?? DefaultBookPrice) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> book = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Book { Title = bookInfoJson.title, Description = bookInfoJson.description, PublishedOn = DecodePubishDate(bookInfoJson.publishedDate), Publisher = bookInfoJson.publisher, OrgPrice = price, ActualPrice = price, ImageUrl = bookInfoJson.imageLinksThumbnail }; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; book.AuthorsLink = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;BookAuthor&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> author <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> bookInfoJson.authors) { book.AuthorsLink.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BookAuthor { Book = book, Author = authorDict[author], Order = i++ }); }</code> </pre><br><h3>  b.  Estilo DDD </h3><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> authors = bookInfoJson.authors.Select(x =&gt; authorDict[x]).ToList(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> book = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Book(bookInfoJson.title, bookInfoJson.description, DecodePubishDate(bookInfoJson.publishedDate), bookInfoJson.publisher, ((<span class="hljs-keyword"><span class="hljs-keyword">decimal</span></span>?)bookInfoJson.saleInfoListPriceAmount) ?? DefaultBookPrice, bookInfoJson.imageLinksThumbnail, authors);</code> </pre><br>  C√≥digo do construtor da classe Book <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Book</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> title, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> description, DateTime publishedOn, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> publisher, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">decimal</span></span></span></span><span class="hljs-function"><span class="hljs-params"> price, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> imageUrl, ICollection&lt;Author&gt; authors</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(title)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(title)); Title = title; Description = description; PublishedOn = publishedOn; Publisher = publisher; ActualPrice = price; OrgPrice = price; ImageUrl = imageUrl; _reviews = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;Review&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (authors == <span class="hljs-literal"><span class="hljs-literal">null</span></span> || !authors.Any()) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException( <span class="hljs-string"><span class="hljs-string">"You must have at least one Author for a book"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(authors)); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> order = <span class="hljs-number"><span class="hljs-number">0</span></span>; _authorsLink = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;BookAuthor&gt;( authors.Select(a =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BookAuthor(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, a, order++))); }</code> </pre><br>  O que procurar: <br><br><ol><li>  Linhas 1-2: o construtor obriga a passar todos os dados necess√°rios para a inicializa√ß√£o adequada. </li><li>  Linhas 5, 6 e 17-9: O c√≥digo cont√©m v√°rias verifica√ß√µes de regras de neg√≥cios.  Nesse caso espec√≠fico, uma viola√ß√£o das regras √© considerada um erro no c√≥digo; portanto, em caso de viola√ß√£o, uma exce√ß√£o ser√° lan√ßada.  Se o usu√°rio pudesse corrigir esses erros, talvez eu usasse uma f√°brica est√°tica que retorne Status &lt;T&gt; (tradutor de coment√°rios. Usaria Option &lt;T&gt; ou Result &lt;T&gt; como um nome mais comum).  Status √© um tipo que retorna uma lista de erros. </li><li>  Linhas 21-23: A liga√ß√£o BookAuthor √© criada no construtor.  O construtor BookAuthor pode ser declarado com o n√≠vel de acesso interno.  Dessa forma, podemos impedir a cria√ß√£o de relacionamentos fora do DAL. </li></ol><br>  Como voc√™ deve ter notado, a quantidade de c√≥digo para criar uma entidade √© aproximadamente a mesma nos dois casos.  Ent√£o, por que o estilo DDD √© melhor?  O estilo DDD √© melhor nisso: <br><br><ol><li>  Controla o acesso.  Mudan√ßa acidental de propriedade √© exclu√≠da.  Qualquer altera√ß√£o ocorre atrav√©s do construtor ou m√©todo p√∫blico com o nome correspondente.  Obviamente o que est√° acontecendo. </li><li>  Corresponde a DRY (n√£o se repita).  Pode ser necess√°rio criar inst√¢ncias do livro em v√°rios lugares.  O c√≥digo de atribui√ß√£o est√° no construtor e voc√™ n√£o precisa repeti-lo em v√°rios locais. </li><li>  Oculta complexidade.  A classe Book possui duas propriedades: ActualPrice e OrgPrice.  Esses dois valores devem ser iguais ao criar um novo livro.  Em uma abordagem padr√£o, todo desenvolvedor deve estar ciente disso.  Na abordagem DDD, √© suficiente para o desenvolvedor da classe Book saber sobre isso.  O restante aprender√° sobre essa regra porque est√° explicitamente escrita no construtor. </li><li>  Oculta a cria√ß√£o agregada.  Em uma abordagem padr√£o, o desenvolvedor deve criar manualmente uma inst√¢ncia do BookAuthor.  No estilo DDD, essa complexidade √© encapsulada para o c√≥digo de chamada. </li><li>  Permite que as propriedades tenham acesso de grava√ß√£o privado </li><li>  Um dos motivos para usar o DDD √© bloquear a entidade, ou seja,  N√£o permita alterar diretamente as propriedades.  Vamos comparar a opera√ß√£o de altera√ß√£o com e sem DDD. </li></ol><br><h3>  Compara√ß√£o de altera√ß√µes de propriedade </h3><br>  Uma das principais vantagens das entidades no estilo DDD, Eric Evans chama o seguinte: "Eles comunicam decis√µes de design sobre acesso a objetos". <br><blockquote>  Nota  tradutor.  A frase original √© dif√≠cil de traduzir para o russo.  Nesse caso, decis√µes de design s√£o decis√µes tomadas sobre como o software deve funcionar.  Isso significa que as decis√µes foram discutidas e confirmadas.  O c√≥digo com construtores que inicializam corretamente entidades e m√©todos com nomes corretos que refletem o significado das opera√ß√µes informa explicitamente ao desenvolvedor que as atribui√ß√µes de determinados valores foram feitas com inten√ß√£o, e n√£o por engano, e n√£o s√£o um capricho de outro desenvolvedor ou detalhes de implementa√ß√£o. </blockquote>  Eu entendo esta frase da seguinte maneira. <br><br><ol><li>  Torne √≥bvio como modificar dados dentro de uma entidade e quais dados devem ser alterados juntos. </li><li>  Torne √≥bvio quando voc√™ n√£o deve modificar determinados dados na entidade. </li></ol>  Vamos comparar as duas abordagens.  O primeiro exemplo √© simples e o segundo √© mais complicado. <br><br><h3>  1. Altera√ß√£o da data de publica√ß√£o </h3><br>  Suponha que queremos primeiro trabalhar com um rascunho de um livro e s√≥ depois public√°-lo.  No momento da reda√ß√£o do rascunho, √© definida uma data estimada de publica√ß√£o, que provavelmente ser√° alterada durante o processo de edi√ß√£o.  Para armazenar a data de publica√ß√£o, usaremos a propriedade PublishedOn. <br><br><h3>  a.  Entidade com propriedades p√∫blicas </h3><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> book = context.Find&lt;Book&gt;(dto.BookId); book.PublishedOn = dto.PublishedOn; context.SaveChanges();</code> </pre><br><h3>  b.  Entidade de estilo DDD </h3><br>  No estilo DDD, o configurador da propriedade √© declarado privado, portanto, usaremos um m√©todo de acesso especializado. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> book = context.Find&lt;Book&gt;(dto.BookId); book.UpdatePublishedOn( dto.PublishedOn); context.SaveChanges();</code> </pre><br>  Esses dois casos s√£o quase os mesmos.  A vers√£o DDD √© ainda mais longa.  Mas ainda h√° uma diferen√ßa.  No estilo DDD, voc√™ tem certeza de que a data de publica√ß√£o pode ser alterada porque existe um m√©todo com um nome √≥bvio.  Voc√™ tamb√©m sabe que n√£o pode alterar o publicador porque a propriedade Publisher n√£o possui um m√©todo apropriado para alterar.  Esta informa√ß√£o ser√° √∫til para qualquer programador que trabalhe com uma aula de livro. <br><br><h3>  2. Gerenciar o desconto para o livro </h3><br>  Outro requisito √© que devemos ser capazes de gerenciar descontos.  O desconto consiste em um novo pre√ßo e um coment√°rio, por exemplo, "50% antes do final desta semana!" <br><br>  A implementa√ß√£o desta regra √© simples, mas n√£o muito √≥bvia. <br><br><ol><li>  A propriedade OrgPrice √© o pre√ßo sem desconto. </li><li>  Pre√ßo atual - O pre√ßo atual pelo qual o livro est√° sendo vendido.  Se o desconto for v√°lido, o pre√ßo atual ser√° diferente do OrgPrice pelo tamanho do desconto.  Caso contr√°rio, o valor das propriedades ser√° igual. </li><li>  A propriedade PromotionText deve conter o texto do desconto se o desconto for aplicado ou nulo se o desconto n√£o for aplicado no momento. </li></ol><br>  As regras s√£o bastante √≥bvias para a pessoa que as implementou.  No entanto, para outro desenvolvedor, digamos, desenvolvendo uma interface do usu√°rio para adicionar um desconto.  Adicionar os m√©todos AddPromotion e RemovePromotion √† classe de entidade oculta os detalhes da implementa√ß√£o.  Agora outro desenvolvedor tem m√©todos p√∫blicos com os nomes correspondentes.  A sem√¢ntica do uso de m√©todos √© √≥bvia. <br><br>  D√™ uma olhada na implementa√ß√£o dos m√©todos AddPromotion e RemovePromotion. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IGenericErrorHandler </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddPromotion</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">decimal</span></span></span></span><span class="hljs-function"><span class="hljs-params"> newPrice, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> promotionalText</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> status = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GenericErrorHandler(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(promotionalText)) { status.AddError( <span class="hljs-string"><span class="hljs-string">"You must provide some text to go with the promotion."</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(PromotionalText)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> status; } ActualPrice = newPrice; PromotionalText = promotionalText; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> status; }</code> </pre><br>  O que procurar: <br><br><ol><li>  Linhas 4-10: √© necess√°rio adicionar um coment√°rio de texto promocional.  O m√©todo verifica se o texto n√£o est√° vazio.  Porque  O usu√°rio pode corrigir esse erro.O m√©todo retorna uma lista de erros para corre√ß√£o. </li><li>  Linhas 12, 13: o m√©todo define os valores das propriedades de acordo com a implementa√ß√£o que o desenvolvedor escolheu.  O usu√°rio do m√©todo AddPromotion n√£o precisa conhec√™-los.  Para adicionar um desconto, basta escrever: </li></ol><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> book = context.Find&lt;Book&gt;(dto.BookId); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> status = book.AddPromotion(newPrice, promotionText); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!status.HasErrors) context.SaveChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> status;</code> </pre><br>  O m√©todo RemovePromotion √© muito mais simples: n√£o envolve tratamento de erros.  Portanto, o valor de retorno √© nulo. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemovePromotion</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ActualPrice = OrgPrice; PromotionalText = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }</code> </pre><br>  Esses dois exemplos s√£o muito diferentes um do outro.  No primeiro exemplo, alterar a propriedade PublishOn √© t√£o simples que a implementa√ß√£o padr√£o √© boa.  No segundo exemplo, os detalhes da implementa√ß√£o n√£o s√£o √≥bvios para algu√©m que n√£o trabalhou com a classe Book.  No segundo caso, o estilo DDD com m√©todos de acesso especializados oculta os detalhes da implementa√ß√£o e facilita a vida de outros desenvolvedores.  Al√©m disso, no segundo exemplo, o c√≥digo cont√©m l√≥gica de neg√≥cios.  Embora a quantidade de l√≥gica seja pequena, podemos armazen√°-la diretamente nos m√©todos de acesso e retornar uma lista de erros se o m√©todo n√£o for usado corretamente. <br><br><h3>  3. Trabalhar com o agregado - cole√ß√£o de propriedades </h3><br>  O DDD se oferece para trabalhar com a unidade somente atrav√©s da raiz.  No nosso caso, a propriedade Reviews cria problemas.  Mesmo se o setter for declarado privado, o desenvolvedor ainda poder√° adicionar ou remover objetos usando os m√©todos add e remove, ou at√© mesmo chamar o m√©todo clear para limpar a cole√ß√£o inteira.  Aqui, o novo recurso EF Core, nos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">campos de apoio,</a> nos ajudar√°. <br><br>  O campo de suporte permite que o desenvolvedor encapsule a cole√ß√£o real e forne√ßa acesso p√∫blico ao link da interface IEnumerable &lt;T&gt;.  A interface IEnumerable &lt;T&gt; n√£o fornece m√©todos de adi√ß√£o, remo√ß√£o ou limpeza.  No c√≥digo abaixo, h√° um exemplo do uso de campos de apoio. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Book</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> HashSet&lt;Review&gt; _reviews; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IEnumerable&lt;Review&gt; Reviews =&gt; _reviews?.ToList(); <span class="hljs-comment"><span class="hljs-comment">//‚Ä¶ rest of code not shown }</span></span></code> </pre><br>  Para que isso funcione, √© necess√°rio informar ao EF Core que, ao ler no banco de dados, voc√™ precisa gravar em um campo privado, n√£o em uma propriedade p√∫blica.  O c√≥digo de configura√ß√£o √© mostrado abaixo. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnModelCreating</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ModelBuilder modelBuilder</span></span></span><span class="hljs-function">)</span></span> { modelBuilder.Entity&lt;Book&gt;() .FindNavigation(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(Book.Reviews)) .SetPropertyAccessMode(PropertyAccessMode.Field); <span class="hljs-comment"><span class="hljs-comment">//‚Ä¶ other non-review configurations left out }</span></span></code> </pre><br>  Para trabalhar com resenhas, adicionei dois m√©todos: AddReview e RemoveReview √† classe de livros.  O m√©todo AddReview √© mais interessante.  Aqui est√° o c√≥digo dele: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddReview</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> numStars, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> comment, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> voterName, DbContext context = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_reviews != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { _reviews.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Review(numStars, comment, voterName)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (context == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(context), <span class="hljs-string"><span class="hljs-string">"You must provide a context if the Reviews collection isn't valid."</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (context.Entry(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).IsKeySet) { context.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Review(numStars, comment, voterName, BookId)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException(<span class="hljs-string"><span class="hljs-string">"Could not add a new review."</span></span>); } }</code> </pre><br>  O que procurar: <br><br><ol><li>  Linhas 4-7: intencionalmente n√£o inicializo o campo _reviews em um construtor privado sem par√¢metros que o EF Core usa ao carregar entidades do banco de dados.  Isso permite que meu c√≥digo determine se a cole√ß√£o foi carregada usando o m√©todo .Include (p =&gt; p.Reviews).  No construtor p√∫blico, eu inicializo o campo, para que o NRE n√£o aconte√ßa ao trabalhar com a entidade criada. </li><li>  Linhas 8-12: Se a cole√ß√£o Reviews n√£o foi carregada, o c√≥digo deve usar DbContext para inicializar. </li><li>  Linhas 13-16: Se o livro foi criado com sucesso e cont√©m um ID, utilizo outra t√©cnica para adicionar uma revis√£o: simplesmente instalo a chave estrangeira em uma inst√¢ncia da classe Review e a escrevo no banco de dados.  Isso √© descrito em mais detalhes na se√ß√£o 3.4.5 do meu livro. </li><li>  Linha 19: Se estamos aqui, h√° algum tipo de problema com a l√≥gica do c√≥digo.  Ent√£o, eu lancei uma exce√ß√£o. </li></ol><br>  Eu projetei todos os meus m√©todos de acesso para casos invertidos em que apenas a entidade raiz √© carregada.  Como atualizar a unidade fica a crit√©rio dos m√©todos.  Pode ser necess√°rio carregar entidades adicionais. <br><br><h3>  Conclus√£o </h3><br>  Para criar entidades no estilo DDD com o EF Core, voc√™ deve seguir as seguintes regras: <br><br><ol><li>  Crie construtores p√∫blicos para criar inst√¢ncias de classe inicializadas corretamente.  Se ocorrerem erros durante o processo de cria√ß√£o que o usu√°rio possa corrigir, crie o objeto n√£o usando o construtor p√∫blico, mas usando o m√©todo de f√°brica que retorna Status &lt;T&gt;, em que T √© o tipo de entidade que est√° sendo criada </li><li>  Todas as propriedades s√£o configuradoras de propriedades.  I.e.  todas as propriedades s√£o somente leitura fora da classe. </li><li>  Para propriedades de navega√ß√£o de cole√ß√£o, declare campos de apoio e tipo de propriedade p√∫blica declare IEnumerable &lt;T&gt;.  Isso impedir√° que outros desenvolvedores alterem cole√ß√µes incontrolavelmente. </li><li>  Em vez de setters p√∫blicos, crie m√©todos p√∫blicos para todas as opera√ß√µes de altera√ß√£o de objeto permitidas.  Esses m√©todos devem retornar nulos se a opera√ß√£o n√£o puder falhar com um erro que o usu√°rio possa corrigir ou Status &lt;T&gt; se puder. </li><li>  O escopo do passivo da entidade √© importante.  Eu acho que √© melhor limitar as entidades a mudar a pr√≥pria classe e outras classes dentro do agregado, mas n√£o fora.  As regras de valida√ß√£o devem se limitar √† verifica√ß√£o da corre√ß√£o da cria√ß√£o e altera√ß√£o do estado das entidades.  I.e.  N√£o verifico regras comerciais, como saldos de a√ß√µes.  Existe um c√≥digo de l√≥gica de neg√≥cios especial para isso. </li><li>  Os m√©todos de altera√ß√£o de estado devem assumir que apenas a raiz de agrega√ß√£o √© carregada.  Se um m√©todo precisar carregar outros dados, ele dever√° cuidar dele por conta pr√≥pria. </li><li>  Os m√©todos de altera√ß√£o de estado devem assumir que apenas a raiz de agrega√ß√£o √© carregada.  Se um m√©todo precisar carregar outros dados, ele dever√° cuidar dele por conta pr√≥pria.  Essa abordagem simplifica o uso de entidades por outros desenvolvedores. </li></ol><br><h3>  Pr√≥s e contras das entidades DDD ao trabalhar com o EF Core </h3><br>  Gosto da abordagem cr√≠tica de qualquer padr√£o ou arquitetura.  Aqui est√° o que penso sobre o uso de entidades DDD. <br><br><h3>  Pr√≥s </h3><br><ol><li>  Usar m√©todos especializados para mudar de estado √© uma abordagem mais limpa.  Essa √© definitivamente uma boa solu√ß√£o, simplesmente porque os m√©todos nomeados adequadamente revelam inten√ß√µes de c√≥digo muito melhores e tornam √≥bvio o que pode e n√£o pode ser alterado.  Al√©m disso, os m√©todos podem retornar uma lista de erros se o usu√°rio puder corrigi-los. </li><li>  Alterar agregados apenas atrav√©s da raiz tamb√©m funciona bem </li><li>  Detalhes do relacionamento um para muitos entre as classes Livro e Revis√£o agora est√£o ocultos para o usu√°rio.  Encapsulamento √© um princ√≠pio b√°sico de POO. </li><li>  O uso de construtores especializados permite garantir que as entidades sejam criadas e garantidas para serem inicializadas corretamente. </li><li>  Mover o c√≥digo de inicializa√ß√£o para o construtor reduz significativamente a probabilidade de o desenvolvedor n√£o interpretar corretamente como a classe deve ser inicializada. </li></ol><br><h3>  Contras </h3><br><ol><li>  Minha abordagem cont√©m depend√™ncias na implementa√ß√£o do EF Core. </li><li>  Algumas pessoas at√© chamam isso de antipadr√£o.  O problema √© que agora as entidades do modelo de assunto dependem do c√≥digo de acesso ao banco de dados.  Em termos de DDD, isso √© ruim.  Percebi que, se n√£o tivesse feito isso, teria que confiar no chamador para saber o que deveria ser carregado.  Essa abordagem quebra o princ√≠pio da separa√ß√£o de preocupa√ß√µes. </li><li>  O DDD for√ßa voc√™ a escrever mais c√≥digo. </li></ol><br>  Realmente vale a pena em casos simples, como atualizar a data de publica√ß√£o de um livro? <br>  Como voc√™ pode ver, eu gosto da abordagem DDD.  No entanto, demorei um pouco para estrutur√°-lo corretamente, mas no momento a abordagem j√° foi resolvida e estou aplicando nos projetos em que estou trabalhando.  J√° consegui experimentar esse estilo em pequenos projetos e estou satisfeito, mas todos os pr√≥s e contras ainda n√£o foram descobertos quando o uso em grandes projetos. <br><br>  Minha decis√£o de permitir o uso de c√≥digo espec√≠fico da EFCore nos argumentos dos m√©todos de entidade do modelo de entidade n√£o foi simples.  Tentei evitar isso, mas no final cheguei √† conclus√£o de que o c√≥digo de chamada tinha que carregar muitas propriedades de navega√ß√£o.  E se isso n√£o for feito, a altera√ß√£o simplesmente n√£o ser√° aplicada sem erros (especialmente em um relacionamento individual).  Isso n√£o era aceit√°vel para mim, ent√£o permiti o uso do EF Core dentro de alguns m√©todos (mas n√£o nos construtores). <br><br>  Outro lado ruim √© que o DDD obriga a escrever significativamente mais c√≥digo para opera√ß√µes CRUD.  Ainda n√£o tenho certeza se vou continuar comendo um cacto e escrever m√©todos separados para todas as propriedades ou, em alguns casos, vale a pena se afastar de um puritanismo t√£o radical.  Eu sei que h√° apenas uma carruagem e um caminh√£o pequeno de CRUD chato, que √© mais f√°cil escrever diretamente.  Somente o trabalho em projetos reais mostrar√° o que √© melhor. <br><br><h3>  Outros aspectos do DDD n√£o abordados neste artigo </h3><br>  O artigo acabou sendo muito longo, ent√£o vou terminar aqui.  Mas isso significa que ainda h√° muito material n√£o divulgado.  Eu j√° escrevi sobre algo, sobre algo que escreverei em um futuro pr√≥ximo.  Aqui est√° o que sobrou: <br><br><ol><li>  <b>L√≥gica de neg√≥cios e DDD.</b>  Uso v√°rios conceitos de DDD no c√≥digo de l√≥gica de neg√≥cios h√° v√°rios anos e, usando os novos recursos do EF Core, espero poder transferir parte da l√≥gica para o c√≥digo de entidade.  Leia o artigo ‚ÄúNovamente sobre a arquitetura da camada l√≥gica de neg√≥cios com o Entity Framework (Core e v6)‚Äù </li><li>  <b>DDD e o padr√£o do reposit√≥rio.</b>  Eric Evans recomenda usar um reposit√≥rio para abstrair o acesso a dados.    ,    ¬´¬ª   EF Core ‚Äì  .  Porque   -  . </li><li> <b> DBContext' /   (bounded contexts).</b>          DbContext'. ,   BookContext      Book        OrderContext,   . ,  ¬´ ¬ª  ,      .         ,         . </li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todo o c√≥digo deste artigo est√° dispon√≠vel no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reposit√≥rio GenericBizRunner no GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Este reposit√≥rio cont√©m um exemplo de aplicativo ASP.NET Core com m√©todos de acesso especializados para modificar a classe Book. </font><font style="vertical-align: inherit;">Voc√™ pode clonar o reposit√≥rio e executar o aplicativo localmente. </font><font style="vertical-align: inherit;">Ele usa o Sqlite na mem√≥ria como um banco de dados, portanto deve ser executado em qualquer infraestrutura. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Feliz desenvolvimento!</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt432410/">https://habr.com/ru/post/pt432410/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../In146152/index.html">‡§ü‡•à‡§≤‡•á‡§Ç‡§ü ‡§Æ‡•à‡§™ ‡§∞‡§ø‡§ú‡•ç‡§Ø‡•Ç‡§Æ‡•á ‡§µ‡§ø‡§ú‡§º‡•Å‡§Ö‡§≤‡§æ‡§á‡§ú‡§º‡§∞ - ‡§∞‡§ø‡§≤‡•Ä‡§ú‡§º ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§∞‡§æ‡§∏‡•ç‡§§‡•á ‡§™‡§∞ ‡§è‡§°‡§µ‡•á‡§Ç‡§ö‡§∞‡•ç‡§∏</a></li>
<li><a href="../pt432400/index.html">CS: GO agora √© gratuito</a></li>
<li><a href="../pt432402/index.html">Ei RH, onde est√° minha lembran√ßa?</a></li>
<li><a href="../pt432404/index.html">O backup para Linux n√£o escreve letras</a></li>
<li><a href="../pt432408/index.html">Resumo da Fintech: prepara√ß√£o para desconectar pequenos bancos da Visa e Mastercard, uma calculadora de pens√µes e n√£o apenas</a></li>
<li><a href="../pt432412/index.html">Highload ++: Como ajudar o sistema ERP a lidar com 500.000 solicita√ß√µes por segundo</a></li>
<li><a href="../pt432414/index.html">Segredos antigos para depura√ß√£o r√°pida: Animando c√≥digo fonte</a></li>
<li><a href="../pt432416/index.html">Tipos dependentes - o futuro das linguagens de programa√ß√£o</a></li>
<li><a href="../pt432418/index.html">Analisando Express√µes Lambda em Java</a></li>
<li><a href="../pt432420/index.html">Introdu√ß√£o ao Git Merge e Git Rebase: Por que e quando us√°-los</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>