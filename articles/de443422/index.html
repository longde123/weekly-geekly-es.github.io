<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüöí ‚ñ´Ô∏è üë∂üèø Flexible Datenspeicherung in MySQL (JSON) üõÄüèº üç≥ üõÅ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Alexander Rubin arbeitet bei Percona und hat mehr als einmal bei HighLoad ++ gespielt , was den Teilnehmern als Experte f√ºr MySQL bekannt ist. Es ist ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Flexible Datenspeicherung in MySQL (JSON)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/443422/">  Alexander Rubin arbeitet bei Percona und hat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">mehr</a> als einmal bei <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">HighLoad ++ gespielt</a> , was den Teilnehmern als Experte f√ºr MySQL bekannt ist.  Es ist logisch anzunehmen, dass wir heute √ºber etwas im Zusammenhang mit MySQL sprechen werden.  Dies ist so, aber nur teilweise, weil wir auch √ºber das <strong>Internet der Dinge</strong> sprechen werden.  Die Geschichte wird halb unterhaltsam sein, insbesondere der erste Teil, in dem wir uns das Ger√§t ansehen, das Alexander f√ºr die Ernte von Aprikosen entwickelt hat.  Das ist die Natur eines echten Ingenieurs - wenn Sie Obst wollen, kaufen Sie eine Geb√ºhr. <br><br><img src="https://habrastorage.org/webt/71/jf/vp/71jfvpzudizjhoc1ikzgfuakds8.jpeg"><br><br><h2>  Hintergrund <br></h2><br>  Alles begann mit dem einfachen Wunsch, einen Obstbaum in seiner Gegend zu pflanzen.  Es scheint sehr einfach zu sein, dies zu tun - Sie kommen in den Laden und kaufen einen S√§mling.  Aber in Amerika ist die erste Frage, die Verk√§ufer stellen, wie viel Sonnenlicht der Baum erhalten wird.  F√ºr Alexander stellte sich heraus, dass dies ein riesiges R√§tsel war - es ist v√∂llig unbekannt, wie viel Sonnenlicht auf dem Gel√§nde ist. <br><br>  Um das herauszufinden, konnte ein Sch√ºler jeden Tag auf den Hof gehen, sehen, wie viel Sonnenschein es gibt, und es in ein Notizbuch schreiben.  Dies ist jedoch nicht der Fall - es ist notwendig, alles auszur√ºsten und zu automatisieren. <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/X5iLzmyZcto" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <em>W√§hrend der Pr√§sentation wurden viele Beispiele live aufgef√ºhrt und gespielt.</em>  <em>Wenn Sie ein vollst√§ndigeres Bild als im Text w√ºnschen, wechseln Sie zum Ansehen des Videos.</em> <br><br>  Um Wetterbeobachtungen nicht in einem Notebook aufzuzeichnen, gibt es eine gro√üe Anzahl von Ger√§ten f√ºr Internet-Dinge - Raspberry Pi, den neuen Raspberry Pi, Arduino - Tausende verschiedener Plattformen.  Aber ich habe f√ºr dieses Projekt ein Ger√§t namens <b>Particle Photon</b> ausgew√§hlt.  Es ist sehr einfach zu bedienen und kostet auf der offiziellen Website 19 US-Dollar. <br><br>  Das Gute an Particle Photon ist: <br><br><ol><li>  100% Cloud-L√∂sung; </li><li>  Alle Sensoren eignen sich beispielsweise f√ºr Arduino.  Sie kosten alle weniger als einen Dollar. </li></ol><br>  Ich habe ein solches Ger√§t hergestellt und es auf der Baustelle ins Gras gelegt.  Es hat eine Partikelwolke und eine Konsole.  Dieses Ger√§t stellt eine Verbindung √ºber einen WLAN-Hotspot her und sendet Daten: Licht, Temperatur und Luftfeuchtigkeit.  Der Tester hat 24 Stunden mit einer kleinen Batterie gedauert, was ziemlich gut ist. <br><br>  Au√üerdem muss ich nicht nur die Beleuchtung usw. messen und auf das Telefon √ºbertragen (was wirklich gut ist - ich kann in Echtzeit sehen, welche Art von Beleuchtung ich habe), sondern auch <strong>Daten speichern</strong> .  Daf√ºr habe ich mich nat√ºrlich als MySQL-Veteran f√ºr MySQL entschieden. <br><br><h2>  Wie schreiben wir Daten in MySQL? <br></h2><br>  Ich habe ein ziemlich kompliziertes Schema gew√§hlt: <br><br><ul><li>  Ich erhalte Daten von der Partikelkonsole. <br></li><li>  Ich benutze Node.js, um sie in MySQL zu schreiben. <br></li></ul><br>  Ich verwende die Partikel-JS-API, die von der Partikel-Website heruntergeladen werden kann.  Ich stelle eine Verbindung mit MySQL her und schreibe, das hei√üt, ich mache nur INSERT INTO-Werte.  Eine solche Pipeline. <br><br>  Somit liegt das Ger√§t auf dem Hof, stellt √ºber WLAN eine Verbindung zum Heimrouter her und √ºbertr√§gt mithilfe des MQTT-Protokolls Daten an Partikel.  Dann genau das Schema: Das Programm auf Node.js l√§uft auf der virtuellen Maschine, die Daten von Particle empf√§ngt und in MySQL schreibt. <br><br>  Zu Beginn habe ich die Diagramme aus den Rohdaten in R erstellt. Die Diagramme zeigen, dass die Temperatur und die Beleuchtung tags√ºber steigen, nachts fallen und die Luftfeuchtigkeit steigt - das ist nat√ºrlich.  Es gibt aber auch Rauschen in der Grafik, was typisch f√ºr Internet of Things-Ger√§te ist.  Wenn beispielsweise ein Fehler auf ein Ger√§t kriecht und es schlie√üt, kann der Sensor v√∂llig irrelevante Daten √ºbertragen.  Dies wird f√ºr weitere √úberlegungen wichtig sein. <br><br>  Lassen Sie uns nun √ºber MySQL und JSON sprechen, die sich in der Arbeit mit JSON von MySQL 5.7 auf MySQL 8 ge√§ndert haben. Dann werde ich eine Demo zeigen, f√ºr die ich MySQL 8 verwende (zum Zeitpunkt des Berichts war diese Version noch nicht produktionsbereit, eine stabile Version wurde bereits ver√∂ffentlicht). <br><br><h2>  MySQL-Datenspeicherung <br></h2><br>  Wenn wir versuchen, von Sensoren empfangene Daten zu speichern, besteht unser erster Gedanke <strong>darin, eine Tabelle in MySQL zu erstellen</strong> : <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">'sensor_wide'</span></span> ( <span class="hljs-string"><span class="hljs-string">'id'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> (<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">'light'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> (<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">'temp'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">'humidity'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">'id'</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span></code> </pre> <br>  Hier gibt es f√ºr jeden Sensor und f√ºr jeden Datentyp eine Spalte: Licht, Temperatur, Luftfeuchtigkeit. <br><br>  Das ist logisch genug, aber <strong>es gibt ein Problem - es ist nicht flexibel</strong> .  Angenommen, wir m√∂chten einen weiteren Sensor hinzuf√ºgen und etwas anderes messen.  Zum Beispiel messen einige Leute das restliche Bier in einem Fass.  Was ist in diesem Fall zu tun? <br><br><pre> <code class="plaintext hljs">alter table sensor_wide add water level double ...;</code> </pre><br>  Wie pervers, um etwas zur Tabelle hinzuzuf√ºgen?  Sie m√ºssen eine √Ñnderungstabelle erstellen, aber wenn Sie eine √Ñnderungstabelle in MySQL erstellt haben, wissen Sie, wovon ich spreche - das ist v√∂llig schwierig.  Das √Ñndern der Tabelle in MySQL 8 und MariaDB ist viel einfacher, aber historisch gesehen ist dies ein gro√ües Problem.  Wenn wir also beispielsweise eine Spalte mit dem Namen des Bieres hinzuf√ºgen m√ºssen, ist dies nicht so einfach. <br><br>  Wieder erscheinen die Sensoren, verschwinden, was sollen wir mit den alten Daten machen?  Zum Beispiel erhalten wir keine Informationen mehr √ºber Beleuchtung.  Oder erstellen wir eine neue Spalte - wie speichert man, was vorher nicht da war?  Der Standardansatz ist null, aber f√ºr die Analyse ist er nicht sehr praktisch. <br><br>  Eine weitere Option ist ein Schl√ºssel- / Wertspeicher. <br><br><h3>  MySQL-Datenspeicherung: Schl√ºssel / Wert <br></h3><br>  Dies wird <strong>flexibler</strong> : In Schl√ºssel / Wert gibt es einen Namen, zum Beispiel Temperatur und dementsprechend Daten. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">'cloud_data'</span></span> ( <span class="hljs-string"><span class="hljs-string">'id'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> (<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">'name'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">'data'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">'updated_at'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">'id'</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span></code> </pre><br>  In diesem Fall tritt ein <strong>anderes Problem</strong> auf <strong>- es gibt keine Typen</strong> .  Wir wissen nicht, was wir im Feld "Daten" speichern.  Wir m√ºssen es als Textfeld deklarieren.  Wenn ich mein Internet-of-Things-Ger√§t erstelle, wei√ü ich, welche Art von Sensor es gibt und welchen Typ es hat. Wenn Sie jedoch die Daten einer anderen Person in derselben Tabelle speichern m√ºssen, wei√ü ich nicht, welche Daten erfasst werden. <br><br>  Sie k√∂nnen viele Tabellen speichern, aber das Erstellen einer neuen Tabelle f√ºr jeden Sensor ist nicht sehr gut. <br><br>  Was kann getan werden?  - Verwenden Sie JSON. <br><br><h3>  MySQL-Datenspeicher: JSON <br></h3><br>  Die gute Nachricht ist, dass Sie in MySQL 5.7 JSON als Feld speichern k√∂nnen. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">'cloud_data_json'</span></span> ( <span class="hljs-string"><span class="hljs-string">'id'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> (<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">'name'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">'data'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JSON</span></span>, <span class="hljs-string"><span class="hljs-string">'updated_at'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">'id'</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span>;</code> </pre><br>  Bevor MySQL 5.7 erschien, wurde JSON ebenfalls gespeichert, jedoch als Textfeld.  Mit dem JSON-Feld in MySQL k√∂nnen Sie JSON selbst am effizientesten speichern.  Dar√ºber hinaus k√∂nnen Sie basierend auf JSON virtuelle Spalten und Indizes erstellen, die darauf basieren. <br><br>  Das einzige kleine Problem ist, <strong>dass die Tabelle w√§hrend der Lagerung gr√∂√üer wird</strong> .  Aber dann bekommen wir viel mehr Flexibilit√§t. <br><br>  Das JSON-Feld eignet sich besser zum Speichern von JSON als das Textfeld, weil: <br><br><ul><li>  Bietet <strong>automatische Dokumenten√ºberpr√ºfung</strong> .  Das hei√üt, wenn wir versuchen, etwas zu schreiben, das dort nicht g√ºltig ist, tritt ein Fehler auf. <br></li><li>  Dies ist ein <strong>optimiertes Speicherformat</strong> .  JSON wird im Bin√§rformat gespeichert, sodass Sie von einem JSON-Dokument zu einem anderen wechseln k√∂nnen - das sogenannte √úberspringen. <br></li></ul><br>  Um Daten in JSON zu speichern, k√∂nnen wir einfach SQL verwenden: Einf√ºgen einf√ºgen, dort 'Daten' einf√ºgen und Daten vom Ger√§t abrufen. <br><br><pre> <code class="sql hljs">‚Ä¶ stream.on('event', function(data) { var query = connection.query( '<span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> cloud_data_json (client_name, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (?, ?)<span class="hljs-string"><span class="hljs-string">', ['</span></span>particle<span class="hljs-string"><span class="hljs-string">', JSON.stringify(data)] ) ‚Ä¶ (demo)</span></span></code> </pre><br><h3>  Demo <br></h3><br>  Um zu demonstrieren ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> der Anfang im Video), verwendet das Beispiel eine virtuelle Maschine, in der sich SQL befindet. <br><br><img src="https://habrastorage.org/webt/r1/mb/po/r1mbpoyh-czzxtsbz2f_umippjc.jpeg"><br><br>  Unten ist ein Fragment des Programms. <br><br><img src="https://habrastorage.org/webt/ap/fm/pq/apfmpqvjrdx5k8f9z6thallawri.jpeg"><br><br>  Ich mache <code>INSERT INTO cloud_data (name, data)</code> , bekomme die Daten bereits im JSON-Format und kann sie direkt in MySQL schreiben, ohne dar√ºber nachzudenken, was sich darin befindet. <br><br>  Wie sich herausstellte, k√∂nnen Sie mit dieser Cloud nicht nur auf die Daten meines Ger√§ts zugreifen, sondern im Allgemeinen auf <strong>alle Daten</strong> , die dieses Partikel verwendet.  Es scheint soweit zu funktionieren.  Menschen, die auf der ganzen Welt Teilchenphoton verwenden, senden einige Daten: Die T√ºr zur Garage ist offen, oder der Rest des Bieres ist so und so oder etwas anderes.  Es ist nicht bekannt, wo sich diese Ger√§te befinden, aber solche Daten k√∂nnen erhalten werden.  Der einzige Unterschied besteht darin, dass ich beim <code>deviceId: 'mine'</code> meiner Daten <code>deviceId: 'mine'</code> schreibe: <code>deviceId: 'mine'</code> . <br><br>  Wenn wir den Code ausf√ºhren, erhalten wir einen Datenstrom von Ger√§ten anderer Personen, die etwas tun. <br><br><img src="https://habrastorage.org/webt/sw/wk/c5/swwkc5xibzuqncd-kuuo_figddg.jpeg"><br><br>  Wir wissen absolut nicht, was diese Daten sind: TTL, Published_at, Coreid, T√ºrstatus (T√ºr offen), Relais ein. <br><br>  Dies ist ein gro√üartiges Beispiel.  Angenommen, ich versuche, dies in MySQL in eine normale Datenstruktur zu integrieren.  Ich sollte wissen, was die T√ºr dort ist, warum sie offen ist und welche allgemeinen Parameter sie annehmen kann.  Wenn ich JSON habe, schreibe ich es als JSON-Feld direkt in MySQL. <br><br><img src="https://habrastorage.org/webt/9o/pi/k4/9opik4nqfqiand6n4fhae0zi31u.jpeg"><br><br>  Bitte, alles wurde aufgezeichnet. <br><br><img src="https://habrastorage.org/webt/wz/n0/ph/wzn0phesbal_lwsjutyiy3569jq.jpeg"><br><br><h3>  Dokumentenspeicher <br></h3><br>  Der Dokumentenspeicher ist ein Versuch in MySQL, Speicher f√ºr JSON zu erstellen.  Ich liebe SQL wirklich, bin gut damit vertraut, kann jede SQL-Abfrage machen usw.  Aber viele Leute m√∂gen SQL aus verschiedenen Gr√ºnden nicht, und der Document Store kann eine L√∂sung f√ºr sie sein, da Sie damit von SQL abstrahieren, eine Verbindung zu MySQL herstellen und JSON direkt dort schreiben k√∂nnen. <br><img src="https://habrastorage.org/webt/w5/9z/5y/w59z5ykdgg9nqfnuuzjdhgrfcmu.jpeg"><br><br>  In MySQL 5.7 ist eine weitere M√∂glichkeit aufgetreten: Verwenden Sie ein anderes Protokoll, einen anderen Port, und es wird auch ein anderer Treiber ben√∂tigt.  F√ºr Node.js (in der Tat f√ºr jede Programmiersprache - PHP, Java usw.) stellen wir √ºber ein anderes Protokoll eine Verbindung zu MySQL her und k√∂nnen Daten im JSON-Format √ºbertragen.  Auch hier wei√ü ich nicht, was ich in diesem JSON habe - Informationen √ºber T√ºren oder etwas anderes. Ich speichere die Daten einfach in MySQL und dann werden wir es herausfinden. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> mysqlx = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'@mysql/xdevapi*); // MySQL Connection var mySession = mysqlx.gctSession({ host: '</span></span>localhost<span class="hljs-string"><span class="hljs-string">', port: 33060, dbUser: '</span></span>photon* }); ‚Ä¶ session.getSchema(<span class="hljs-string"><span class="hljs-string">"particle"</span></span>).getCollection(<span class="hljs-string"><span class="hljs-string">"cloud_data_docstore"</span></span>) .add( data ) .execute(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">row</span></span></span><span class="hljs-function">) </span></span>{ }).catch(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(err); }) .then( -<span class="hljs-built_in"><span class="hljs-built_in">Function</span></span> (notices) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Wrote to MySQL"</span></span>) }); ...https:<span class="hljs-comment"><span class="hljs-comment">//dev.mysql.com/doc/dev/connector-nodejs/</span></span></code> </pre><br>  Wenn Sie damit experimentieren m√∂chten, k√∂nnen Sie MySQL 5.7 so konfigurieren, dass es den entsprechenden Port Document Store oder X DevAPI versteht und √ºberwacht.  Ich habe Connector-Nodejs verwendet. <br><br>  Dies ist ein Beispiel f√ºr das, was ich dort aufschreibe: Bier usw. Ich wei√ü absolut nicht, was da ist.  Jetzt schreiben wir es einfach auf und analysieren es sp√§ter. <br><br><img src="https://habrastorage.org/webt/vo/cw/jn/vocwjnriy8x0mgrsepta-nrcpcm.jpeg"><br><br>  Der n√§chste Punkt unseres Programms ist, wie man sieht, was da ist. <br><br><h3>  MySQL-Datenspeicherung: JSON + -Indizes <br></h3><br>  In JSON und MySQL 5.7 gibt es eine gro√üartige Funktion, mit der Felder aus JSON gezogen werden k√∂nnen.  Dies ist ein solcher syntaktischer Zucker in der Funktion JSON_EXTRACT.  Ich finde das sehr praktisch. <br><br>  Daten sind in unserem Fall der Name der Spalte, in der JSON gespeichert ist, und Name ist unser Feld.  Name, Daten, Published_at - das ist alles, was wir auf diese Weise herausholen k√∂nnen. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.name'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> data_name, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.data'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.published_at'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> published <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;<span class="hljs-string"><span class="hljs-string">'$.published_at'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>;</code> </pre><br>  In diesem Beispiel m√∂chte ich sehen, was ich in die MySQL-Tabelle und die letzten 10 Datens√§tze geschrieben habe.  Ich mache eine solche Anfrage und versuche sie auszuf√ºhren.  Leider wird <strong>dies sehr lange funktionieren</strong> . <br><br>  In logischer Weise verwendet MySQL in diesem Fall keine Indizes.  Wir ziehen die Daten aus JSON heraus und versuchen, eine Art Filter und Sortierung anzuwenden.  In diesem Fall erhalten wir Using filesort. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXPLAIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.name'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> data_name ... <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.published_at'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> select_type: SIMPLE <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>: cloud_data_json possible_keys: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>: <span class="hljs-number"><span class="hljs-number">101589</span></span> filtered: <span class="hljs-number"><span class="hljs-number">100.00</span></span> Extra: <span class="hljs-keyword"><span class="hljs-keyword">Using</span></span> filesort</code> </pre><br>  Die Verwendung von filesort ist sehr schlecht, es handelt sich um eine externe Sortierung. <br><br>  Die gute Nachricht ist, dass Sie zwei Schritte unternehmen k√∂nnen, um dies zu beschleunigen. <br><br><h4>  Schritt 1. Erstellen Sie eine virtuelle Spalte <br></h4><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> cloud_data_json -&gt; <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> published_at DATETIME(<span class="hljs-number"><span class="hljs-number">6</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">GENERATED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALWAYS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">STR_TO_DATE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.published_at'</span></span>,<span class="hljs-string"><span class="hljs-string">"%Y-%m-%dT%T.%fZ"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">VIRTUAL</span></span>; Query OK, 0 rows affected (0.01 sec) Records: 0 Duplicates: 0 Warnings: 0</code> </pre><br>  Ich mache EXTRACT, das hei√üt, ich ziehe Daten aus JSON und erstelle darauf basierend eine virtuelle Spalte.  Die virtuelle Spalte wird nicht in MySQL 5.7 und in MySQL 8 gespeichert - es ist lediglich die M√∂glichkeit, eine separate Spalte zu erstellen. <br><br>  Sie fragen, wie es ist, Sie sagten, dass ALTER TABLE eine so lange Operation ist.  Aber hier ist es nicht so schlimm.  <strong>Das Erstellen einer virtuellen Spalte ist schnell</strong> .  Dort gibt es eine Sperre, aber tats√§chlich gibt es in MySQL eine Sperre f√ºr alle DDL-Operationen.  ALTER TABLE ist eine ziemlich schnelle Operation und erstellt nicht die gesamte Tabelle neu. <br><br>  Wir haben hier eine virtuelle Spalte erstellt.  Ich musste das Datum konvertieren, da es in JSON im ISO-Format gespeichert ist, aber hier verwendet MySQL ein v√∂llig anderes Format.  Um eine Spalte zu erstellen, habe ich sie benannt, ihr einen Typ gegeben und gesagt, dass ich dort aufnehmen w√ºrde. <br><br>  Um die urspr√ºngliche Abfrage zu optimieren, m√ºssen Sie "public_at" und "name" herausziehen.  Published_at existiert bereits, der Name ist einfacher - erstellen Sie einfach eine virtuelle Spalte. <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> cloud_data_json -&gt; <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> data_name <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">GENERATED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALWAYS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.name'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VIRTUAL</span></span>; Query OK, 0 rows affected (0.01 sec) Records: 0 Duplicates: 0 Warnings: 0</code> </pre><br><h4>  Schritt 2. Erstellen eines Index <br></h4><br>  Im folgenden Code erstelle ich einen Index f√ºr shared_at und f√ºhre die Abfrage aus: <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> (published_at); Query OK, 0 rows affected (0.31 sec) Records: 0 Duplicates: 0 Warnings: 0 mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> data_name, published_at, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.data'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> published_at <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>\G <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>: cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> possible_keys: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>: published_at key_len: <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> filtered: <span class="hljs-number"><span class="hljs-number">100.00</span></span> Extra: Backward <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">scan</span></span></code> </pre><br>  Sie k√∂nnen sehen, dass MySQL den Index tats√§chlich verwendet.  Dies ist eine Optimierung auf Bestellung.  In diesem Beispiel werden Daten und Name nicht indiziert.  MySQL verwendet die Reihenfolge nach Daten, und da wir einen Index f√ºr Publish_at haben, wird dieser verwendet. <br><br>  Au√üerdem k√∂nnte ich die gleiche Syntax Zucker <code>STR_TO_DATE(data-&gt;&gt;'$.published_at',"%Y-%m-%dT%T.%fZ")</code> anstelle von "Published_at" in der angegebenen Reihenfolge verwenden.  MySQL w√ºrde immer noch verstehen, dass es einen Index f√ºr diese Spalte gibt, und ihn verwenden. <br><br>  Es gibt tats√§chlich ein kleines Problem damit.  Angenommen, ich m√∂chte Daten nicht nur nach publiziertem_at, sondern auch nach Namen sortieren. <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> data_name, published_at, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.data'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> published_at <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>, data_name <span class="hljs-keyword"><span class="hljs-keyword">asc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>\G select_type: SIMPLE <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>: cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">partitions</span></span>: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: ALL possible_keys: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> key_len: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span>: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>: <span class="hljs-number"><span class="hljs-number">101589</span></span> filtered: <span class="hljs-number"><span class="hljs-number">100.00</span></span> Extra: <span class="hljs-keyword"><span class="hljs-keyword">Using</span></span> filesort</code> </pre><br>  Wenn Ihr Ger√§t Zehntausende von Ereignissen pro Sekunde verarbeitet, gibt publiziert_at keine gute Sortierung aus, da es Duplikate gibt.  Daher f√ºgen wir eine weitere Sortierung nach Datenname hinzu.  Dies ist eine typische Abfrage nicht nur f√ºr das Internet der Dinge: Geben Sie mir die letzten 10 Ereignisse, sondern sortieren Sie sie nach Datum und dann beispielsweise nach dem Nachnamen der Person in aufsteigender Reihenfolge.  Zu diesem Zweck gibt es im obigen Beispiel zwei Felder und zwei Sortierschl√ºssel: absteigend und aufsteigend. <br><br>  In diesem Fall verwendet MySQL zun√§chst keine Indizes.  In diesem speziellen Fall entscheidet MySQL, dass ein vollst√§ndiger Tabellenscan rentabler ist als die Verwendung eines Index, und wiederum wird die sehr langsame Dateisortierungsoperation verwendet. <br><br><h2>  Neu in MySQL 8.0 <br></h2><br><h3>  <strong>absteigend / aufsteigend</strong> <br></h3><br>  In MySQL 5.7 kann eine solche Abfrage nicht optimiert werden, wenn auch nur auf Kosten anderer Dinge.  In MySQL 8 gab es eine echte M√∂glichkeit, die Sortierung f√ºr jedes Feld festzulegen. <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> published_at_data_name (published_at <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>, data_name <span class="hljs-keyword"><span class="hljs-keyword">asc</span></span>); Query OK, 0 rows affected (0.44 sec) Records: 0 Duplicates: 0 Warnings: 0</code> </pre><br>  Das Interessanteste ist, dass der absteigende / aufsteigende Schl√ºssel nach dem Indexnamen schon lange in SQL ist.  Bereits in der allerersten Version von MySQL 3.23 k√∂nnen Sie "publiziert_absteigend" oder "ver√∂ffentlicht_at aufsteigend" angeben.  MySQL akzeptierte dies, <strong>tat aber nichts</strong> , das hei√üt, es wurde immer in eine Richtung sortiert. <br><br>  In MySQL 8 wurde dies behoben und jetzt gibt es eine solche Funktion.  Sie k√∂nnen ein Feld in absteigender Reihenfolge und mit Standardsortierung erstellen. <br><br>  Lassen Sie uns eine Sekunde zur√ºckgehen und das Beispiel aus Schritt 2 noch einmal betrachten. <br><br>  Warum funktioniert es, sonst nicht?  Dies funktioniert, weil es sich bei MySQL-Indizes um einen B-Baum handelt und B-Baum-Indizes sowohl vom Anfang als auch vom Ende gelesen werden k√∂nnen.  In diesem Fall liest MySQL den Index vom Ende und alles ist gut.  Aber wenn wir absteigen und aufsteigen, k√∂nnen Sie nicht lesen.  Sie k√∂nnen in derselben Reihenfolge lesen, aber <strong>Sie k√∂nnen nicht zwei Sortierungen kombinieren</strong> - Sie m√ºssen neu sortieren. <br><br>  Da wir einen ganz bestimmten Fall optimieren, k√∂nnen wir einen Index daf√ºr erstellen und eine bestimmte Sortierung angeben: Hier ist "public_at" absteigend, "data_name" aufsteigend.  MySQL verwendet diesen Index und alles wird gut und schnell. <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> data_name, published_at, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.data'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> published_at <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>\G select_type: SIMPLE <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>: cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">partitions</span></span>: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> possible_keys: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>: published_at_data_name key_len: <span class="hljs-number"><span class="hljs-number">267</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span>: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> filtered: <span class="hljs-number"><span class="hljs-number">100.00</span></span> Extra: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span></code> </pre><br>  Dies ist eine Funktion von MySQL 8, das zum Zeitpunkt der Ver√∂ffentlichung bereits verf√ºgbar und f√ºr die Produktion bereit ist. <br><br><h3>  Ausgabeergebnisse <br></h3><br>  Es gibt zwei weitere interessante Dinge, die ich zeigen m√∂chte: <br><br>  1. H√ºbscher Druck, dh eine sch√∂ne Ausgabe von Daten auf dem Bildschirm.  Mit normalem SELECT wird JSON nicht formatiert. <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> json_pretty(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.data'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%beer%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>\G ‚Ä¶ json_pretty(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>): { <span class="hljs-string"><span class="hljs-string">"ttl"</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-string"><span class="hljs-string">"data"</span></span>: <span class="hljs-string"><span class="hljs-string">"FvGav,tagkey=beer-store spFridge=7.00,pvFridge=7.44"</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"LOG_DATA_DEBUG"</span></span>, <span class="hljs-string"><span class="hljs-string">"coreid"</span></span>: <span class="hljs-string"><span class="hljs-string">"3600...."</span></span>, <span class="hljs-string"><span class="hljs-string">"published_at"</span></span>: <span class="hljs-string"><span class="hljs-string">"2017-09-28T18:21:16.517Z"</span></span> }</code> </pre><br>  2. Wir k√∂nnen sagen, dass MySQL das Ergebnis in Form eines JSON-Arrays oder eines JSON-Objekts ausgibt, die Felder angibt und die Ausgabe dann als JSON formatiert wird. <br><br><h2>  Volltextsuche in JSON-Dokumenten <br></h2><br>  Wenn wir ein flexibles Speichersystem verwenden und nicht wissen, was sich in unserem JSON befindet, w√§re es logisch, die Volltextsuche zu verwenden. <br><br>  Leider hat die <strong>Volltextsuche ihre Grenzen</strong> .  Das erste, was ich versuchte, war, einen Volltextschl√ºssel zu erstellen.  Ich habe versucht so etwas zu tun: <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> cloud_data_json_indexes <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> fulltext <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>); ERROR 3152 (42000): JSON column 'data' supports indexing only via generated columns on a specified ISON path.</code> </pre><br>  Leider funktioniert das nicht.  Selbst in MySQL 8 ist es leider unm√∂glich, einen Volltextindex einfach √ºber das JSON-Feld zu erstellen.  Nat√ºrlich h√§tte ich gerne eine solche Funktion - die M√∂glichkeit, zumindest nach JSON-Schl√ºsseln zu suchen, w√§re sehr n√ºtzlich. <br><br>  Wenn dies jedoch noch nicht m√∂glich ist, erstellen wir eine virtuelle Spalte.  In unserem Fall gibt es ein Datenfeld, und es w√§re interessant f√ºr uns zu sehen, was sich darin befindet. <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> cloud_data_json_indexes -&gt; <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> data_data <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">GENERATED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALWAYS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.data'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VIRTUAL</span></span>; Query OK, 0 rows affected (0.01 sec) Records: 0 Duplicates: 0 Warnings: 0 mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> cloud_data_json_indexes <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> fulltext <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> ft_json(data_name, data_data); ERROR 3106 (HY000): 'Fulltext index on virtual generated column' is not supported for generated columns.</code> </pre><br>  Leider funktioniert dies auch nicht - <strong>Sie k√∂nnen keinen Volltextindex f√ºr eine virtuelle Spalte erstellen</strong> . <br><br>  Wenn ja, erstellen wir eine gespeicherte Spalte.  Mit MySQL 5.7 k√∂nnen Sie eine Spalte als gespeichertes Feld deklarieren. <br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> cloud_data_json_indexes -&gt; <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> data_name <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">CHARACTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> UTF8MB4 -&gt; <span class="hljs-keyword"><span class="hljs-keyword">GENERATED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALWAYS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.name'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">STORED</span></span>; Query OK, 123518 rows affected (1.75 sec) Records: 123518 Duplicates: 0 Warnings: 0 mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> cloud_data_json_indexes <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> fulltext <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> ft_json(data_name); Query OK, 0 rows affected, 1 warning (3.78 sec) Records: 0 Duplicates: 0 Warnings: 1 mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-keyword"><span class="hljs-keyword">warnings</span></span>; +<span class="hljs-comment"><span class="hljs-comment">------------+--------+---------------------------------------------------+ | Level | Code | Message | +------------+--------+---------------------------------------------------+ | Warning | 124 | InnoDB rebuilding table to add column FTS_DOC_ID | +------------+--------+---------------------------------------------------+</span></span></code> </pre><br>  In den vorherigen Beispielen haben wir virtuelle Spalten erstellt, die nicht gespeichert werden, aber Indizes werden erstellt und gespeichert.  In diesem Fall musste ich MySQL mitteilen, dass dies eine STORED-Spalte ist, dh, sie wird erstellt und die Daten werden darauf kopiert.  Danach hat MySQL einen Volltextindex erstellt, daf√ºr mussten wir die Tabelle neu erstellen.  Diese Einschr√§nkung gilt jedoch f√ºr die InnoDB- und InnoDB-Volltextsuche: Sie m√ºssen die Tabelle neu erstellen, um eine spezielle Volltextsuchkennung hinzuzuf√ºgen. <br><br>  Interessanterweise gab es in MySQL 8 eine <strong>neue</strong> <strong>UTF8</strong> <strong>MB4-</strong> <strong>Codierung</strong> <strong>f√ºr Emoticons</strong> .  Nat√ºrlich nicht ganz f√ºr sie, aber weil es in UTF8MB3 einige Probleme mit Russisch, Chinesisch, Japanisch und anderen Sprachen gibt. <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> cloud_data_json_indexes -&gt; <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> data_data <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CHARACTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> UTF8MB4 -&gt; <span class="hljs-keyword"><span class="hljs-keyword">GENERATED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALWAYS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.data'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> UTF8MB4) ) <span class="hljs-keyword"><span class="hljs-keyword">STORED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Query</span></span> OK, <span class="hljs-number"><span class="hljs-number">123518</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> affected (<span class="hljs-number"><span class="hljs-number">3.14</span></span> sec) <span class="hljs-keyword"><span class="hljs-keyword">Records</span></span>: <span class="hljs-number"><span class="hljs-number">123518</span></span> Duplicates: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Warnings</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  Dementsprechend sollte MySQL 8 JSON-Daten in UTF8MB4 speichern.  Aber ob aufgrund der Tatsache, dass Node.js eine Verbindung zur Device Cloud herstellt und dort etwas falsch geschrieben ist oder es sich um einen Beta-Versionsfehler handelt, ist dies nicht geschehen.  Daher musste ich die Daten konvertieren, bevor ich sie in eine gespeicherte Spalte schrieb. <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> cloud_data_json_indexes <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> ft_json, <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> FULLTEXT <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> ft_json(data_name, data_data); Query OK, 0 rows affected (1.85 sec) Records: 0 Duplicates: 0 Warnings: 0</code> </pre><br>  Danach konnte ich eine Volltextsuche f√ºr zwei Felder erstellen: f√ºr den JSON-Namen und f√ºr die JSON-Daten. <br><br><h2>  Nicht nur IoT <br></h2><br>  JSON ist nicht nur das Internet der Dinge.  Es kann f√ºr andere interessante Dinge verwendet werden: <br><br><ul><li>  Benutzerdefinierte Felder (CMS); </li><li>  Komplexe Strukturen usw.; </li></ul><br>  Einige Dinge k√∂nnen mit einem flexiblen Datenspeicherungsschema viel bequemer implementiert werden.  Ein hervorragendes Beispiel lieferte Oracle OpenWorld: Kinoreservierungen.  Es ist sehr schwierig, dies im relationalen Modell zu implementieren - Sie erhalten viele abh√§ngige Tabellen, Verkn√ºpfungen usw.  Auf der anderen Seite k√∂nnen wir den gesamten Raum als JSON-Struktur speichern, in andere Tabellen in MySQL schreiben und auf die √ºbliche Weise verwenden: Indizes basierend auf JSON erstellen usw.  <b>Komplexe Strukturen werden bequem im JSON-Format gespeichert.</b> <br><br><img src="https://habrastorage.org/webt/9m/i3/th/9mi3thcaas9caominanputmpaua.jpeg"><br><br>  Dies ist ein Baum, der erfolgreich gepflanzt wurde.  Leider a√üen es einige Jahre sp√§ter Hirsche, aber das ist eine ganz andere Geschichte. <br><br><blockquote>  Dieser Bericht ist ein hervorragendes Beispiel daf√ºr, wie ein ganzer Abschnitt bei einer gro√üen Konferenz aus einem Thema und dann aus einer separaten Veranstaltung hervorgeht.  Im Fall des Internet der Dinge haben wir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">InoThings ++</a> - eine Konferenz f√ºr Fachleute auf dem Internet der Dinge, die am 4. April zum zweiten Mal stattfinden wird. <br><br>  Das zentrale Ereignis der Konferenz wird anscheinend der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Runde Tisch</a> ‚ÄûBrauchen wir nationale Standards im Internet der Dinge?‚Äú Sein, der organisch durch umfassende angewandte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Berichte</a> erg√§nzt wird.  Kommen Sie, wenn Ihre stark ausgelasteten Systeme korrekt auf IIoT umgestellt werden. <br></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de443422/">https://habr.com/ru/post/de443422/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de443408/index.html">Photonen, Quanten und Fock-Zustand: Manipulationen auf Quantenebene mit einem Hochfrequenzresonator</a></li>
<li><a href="../de443412/index.html">Warum Programmierer weiterhin ausf√ºhrliches Java verwenden, obwohl es pr√§gnantes Python gibt</a></li>
<li><a href="../de443414/index.html">Wegweiser: Wenn Haltepunkte nicht ausreichen</a></li>
<li><a href="../de443416/index.html">Winnti: ein Angriff auf Lieferketten - asiatische Spieleentwickler stehen an vorderster Front</a></li>
<li><a href="../de443418/index.html">Software-Testmethoden</a></li>
<li><a href="../de443424/index.html">Umschreiben des Testfalls f√ºr das Junior-Frontend auf TypeScript und React-Hooks</a></li>
<li><a href="../de443426/index.html">Schwarze Markierung - wie OpenShift mit SELinux vor Container-Schwachstellen sch√ºtzt</a></li>
<li><a href="../de443428/index.html">Palmer Lucky, der "Vater" von Oculus Rift, entwickelt ein virtuelles Schlachtfeldsystem f√ºr das Pentagon</a></li>
<li><a href="../de443430/index.html">Warum ist es schlecht, wenn das Internet alles √ºber Sie wei√ü?</a></li>
<li><a href="../de443432/index.html">Blazor 0.9.0 ver√∂ffentlicht</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>