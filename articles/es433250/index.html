<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèª‚Äçüî¨ üë®‚Äç‚ù§Ô∏è‚Äçüë® üë©üèº‚Äç‚öñÔ∏è OpenVPN con autenticaci√≥n y autorizaci√≥n avanzadas üö• üÖ±Ô∏è üë©üèΩ‚Äçü§ù‚Äçüë®üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El art√≠culo analiza la configuraci√≥n de OpenVPN con caracter√≠sticas adicionales: 



- Certificados de token para autenticaci√≥n primaria (Rutoken como...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>OpenVPN con autenticaci√≥n y autorizaci√≥n avanzadas</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/433250/">  El art√≠culo analiza la configuraci√≥n de OpenVPN con caracter√≠sticas adicionales: <br><br><ul><li>  Certificados de token para autenticaci√≥n primaria (Rutoken como ejemplo) </li><li>  Servidor de fondo LDAP para autenticaci√≥n secundaria (usando ActiveDirectory como ejemplo) </li><li>  filtrado de recursos internos disponibles para los usuarios (a trav√©s de iptables) </li></ul><br>  Tambi√©n describe c√≥mo configurar clientes para Linux, Windows y MacOS. <br><a name="habracut"></a><br><h3>  Configuraci√≥n del servidor </h3><br><h4>  Instalar OpenVPN </h4><br>  Tome el script <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Nyr / openvpn-install</a> , ejecute desde la ra√≠z. <br><br><pre><code class="plaintext hljs">git clone https://github.com/Nyr/openvpn-install.git cd openvpn-install</code> </pre> <br>  El proceso de inicio har√° algunas preguntas. <br><br><ul><li>  protocolo udp </li><li>  puerto 1194 </li><li>  Servidores DNS - Local </li><li>  ip externa: direcci√≥n de puerta de enlace en Internet a trav√©s de la cual estar√° disponible el servidor vpn </li></ul><br>  Tambi√©n hay una versi√≥n de seguridad mejorada del script original: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/Angristan/OpenVPN-install</a> .  Tiene m√°s configuraciones de cifrado con explicaciones de por qu√©. <br><br><h4>  Gesti√≥n de usuarios </h4><br>  <b>Agregando</b> <br>  Si no se usan tokens, el usuario se agrega a trav√©s del mismo script.  El script esencialmente genera una configuraci√≥n ovpn personalizada e inserta un certificado firmado por el certificado ra√≠z all√≠. <br><br>  Si se utilizan tokens (consulte la secci√≥n sobre tokens a continuaci√≥n), el certificado se redacta manualmente en funci√≥n de la solicitud del certificado que se genera en el token.  La configuraci√≥n del usuario debe realizarse manualmente desde la plantilla existente (desde la misma desde la que se genera el script de configuraci√≥n).  La plantilla est√° aqu√≠ <code>/etc/openvpn/client-common.txt</code> .  No est√° incluido en el paquete openvpn y es generado por el script durante el proceso de configuraci√≥n. <br><br>  <b>Eliminar</b> <br>  La eliminaci√≥n de usuarios se realiza a trav√©s del mismo script de instalaci√≥n.  El certificado se agrega a la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">CRL</a> , la nueva CRL se env√≠a al servidor vpn.  El servidor considera que todos los certificados que est√°n en CRL no son v√°lidos y se niega a aceptar. <br><br>  C√≥mo revocar un certificado manualmente: <br><br><pre> <code class="plaintext hljs">cd /etc/openvpn/easyrsa #   ./easyrsa revoke $CLIENT #   crl ./easyrsa gen-crl #   crl rm -rf /etc/openvpn/crl.pem #    cp /etc/openvpn/easy-rsa/pki/crl.pem /etc/openvpn/crl.pem # openvpn    crl,       nobody chown nobody:nobody /etc/openvpn/crl.pem</code> </pre><br><h4>  Filtrado de hosts disponibles para clientes </h4><br>  Los clientes deben estar limitados por los hosts a los que pueden acceder en la red cuando se conectan a openvpn. <br><br>  <b>Manualmente</b> <br><br>  La idea es capturar paquetes incluso en la interfaz <code>tun0</code> , en la que provienen de los clientes y filtrarlos antes de que entren en NAT.  Despu√©s de NAT, no habr√° raz√≥n para filtrarlos: todos tendr√°n una direcci√≥n IP de servidor openvpn en la red interna.  Antes de ingresar a NAT, los paquetes para cada usuario tienen su propia direcci√≥n IP √∫nica (para la correspondencia de direcciones IP y usuarios, consulte el archivo <code>/etc/openvpn/ipp.txt</code> ). <br><br>  Los paquetes que pasan a trav√©s del sistema (no provienen directamente de √©l y no son entrantes, es decir, de hecho son enrutados por el sistema) son procesados ‚Äã‚Äãpor la tabla FORWARD.  Las tablas en iptables se procesan de arriba a abajo, si ninguna de las reglas de la tabla llev√≥ a una decisi√≥n sobre el destino del paquete, entonces se activa la regla predeterminada. <br><br>  Preparando la tabla ADELANTE: <br><br><pre> <code class="plaintext hljs">#   iptables -F FORWARD #     FORWARD -    iptables -P FORWARD DROP #     iptables -I FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT</code> </pre><br>  Reglas de ejemplo para un cliente espec√≠fico.  Dado que la regla predeterminada para la tabla es DROP, solo queda permitir esos pares de host + puerto donde pueda.  Permita el acceso al puerto en el host + haga ping al host en s√≠: <br><br><pre> <code class="plaintext hljs">iptables -I FORWARD -s 10.8.0.3 -i tun0 -d 10.0.2.3 -p tcp --dport 443 -j ACCEPT iptables -I FORWARD -s 10.8.0.3 -i tun0 -d 10.0.2.3 -p icmp --icmp-type echo-request -j ACCEPT</code> </pre><br>  En el ejemplo anterior, el host 10.8.0.3 tiene acceso permitido al puerto 443 del host 10.0.2.3. <br><br>  C√≥mo cerrar el acceso: <br><br><pre> <code class="plaintext hljs">#         iptables -L FORWARD --line-numbers #     iptables -D FORWARD { }</code> </pre><br>  Luego debe encontrar todas las reglas para un cliente en particular y eliminarlas. <br><br>  Durante la depuraci√≥n, es conveniente observar qu√© reglas funcionan.  Cada regla tiene un contador de paquetes procesados. <br><br><pre> <code class="plaintext hljs">#  ,      watch iptables -nvL FORWARD #     iptables -Z FORWARD</code> </pre><br>  <b>Autom√°ticamente</b> <br><br>  Un servidor openvpn tiene la capacidad de ejecutar scripts para ciertas acciones.  En particular, al conectar y desconectar clientes.  Los scripts se pueden escribir en cualquier cosa si solo son ejecutables.  Dentro del script, las variables de entorno pasan todo tipo de par√°metros a la conexi√≥n actual.  Nos interesan las variables: <br><br><ul><li>  <code>common_name</code> (nombre del propietario del certificado; lo que conduce al campo de nombre com√∫n al crear el certificado) </li><li>  <code>ifconfig_pool_remote_ip</code> (direcci√≥n IP del cliente en tun0) </li><li>  <code>script_type</code> (qu√© evento ocurri√≥: conectar o desconectar). </li></ul><br>  Necesita privilegios de root para administrar iptables.  Openvpn despu√©s de conectarse restablece los derechos a nadie y ejecuta scripts desde √©l.  Es malo no permitir que nadie haga algo por debajo de sudo, y es mejor no usar un asterisco en las reglas, pero de alguna manera debes permitir que el usuario controle iptables. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /etc/sudoers.d/50_openvpn # #    nobody ALL = NOPASSWD: /sbin/iptables -A FORWARD* #     nobody ALL = NOPASSWD: /sbin/iptables -L FORWARD* #    nobody ALL = NOPASSWD: /sbin/iptables -D FORWARD*</span></span></code> </pre><br>  En la configuraci√≥n del servidor, debe agregar permiso para ejecutar archivos de terceros y habilitar dos enlaces responsables de conectar y desconectar al usuario. <br><br><pre> <code class="bash hljs">script-security 2 client-connect /etc/openvpn/bin/hosts.rb client-disconnect /etc/openvpn/bin/hosts.rb</code> </pre><br>  El script en s√≠, que lee las configuraciones y aplica las reglas para iptables.  El gui√≥n funciona con los mismos principios que se describen en la secci√≥n anterior. <br><br><div class="spoiler">  <b class="spoiler_title">/openvpn/bin/hosts.rb</b> <div class="spoiler_text"><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/ruby # -*- coding: utf-8 -*- require 'pp' def log(string) puts 'hosts.rb: ' + string end def parse_config_file(name) config_path = "hosts/#{name}" unless File.exist?(config_path) puts "There is no specific configuration for #{name}." p name exit 0 end config_source = IO.read(config_path).split("\n") config = config_source.inject([]) do |result,line| ip, port, protocol = line.split(/\s+/) result &lt;&lt; { ip: ip, port: port, protocol: protocol || 'tcp' } end end def get_config(name) user_config = parse_config_file(name) if user_config everybody_config = parse_config_file('everybody') end everybody_config + user_config end def apply_rule(rule) command = "sudo iptables #{rule}" log(command) system(command) end def remove_rule(number) command = "sudo iptables -D FORWARD #{number}" log(command) system(command) end def allow_target(source_ip, options) #         . apply_rule("-A FORWARD -s #{source_ip} -i tun0 -d #{options[:ip]} -p #{options[:protocol]} --dport #{options[:port]} -j ACCEPT") #       apply_rule("-A FORWARD -s #{source_ip} -i tun0 -d #{options[:ip]} -p icmp --icmp-type echo-request -j ACCEPT") end def clear_targets(source_ip) #      FORWARD,  source_ip. rules_exist = true while rules_exist table = `sudo iptables -L FORWARD --line-number`.split("\n") the_line = table.find do |line| fields = line.split(/\s+/) ip = fields[4] ip == source_ip end if the_line number = the_line.split(/\s+/)[0] remove_rule(number) else rules_exist = false end end end ################################################################################ script_type = ENV['script_type'] log(script_type) name = ENV['common_name'] source_ip = ENV['ifconfig_pool_remote_ip'] case script_type when 'client-connect' config = get_config(name) config.each{|target| allow_target(source_ip, target)} when 'client-disconnect' clear_targets(source_ip) else puts "Unknown script type #{script_type}." end</span></span></code> </pre></div></div><br>  Las reglas se almacenan en archivos correspondientes al nombre com√∫n de los certificados en la carpeta <code>/etc/openvpn/hosts</code> .  Especifican exactamente qu√© direcciones IP est√°n disponibles para un cliente en particular.  Separador: un n√∫mero arbitrario de espacios.  La direcci√≥n IP, el puerto y el protocolo (tcp o udp) se escriben a trav√©s del separador. <br><br><pre> <code class="bash hljs">10.0.0.24 53 udp 10.0.0.25 53 udp 10.0.2.3 443 tcp</code> </pre><br>  Como resultado, la siguiente estructura deber√≠a <code>/etc/openvpn</code> en la carpeta <code>/etc/openvpn</code> <br><br>  ‚îú‚îÄ‚îÄ bin <br>  ‚îÇ ‚îî‚îÄ‚îÄ hosts.rb <br>  ‚îú‚îÄ‚îÄ anfitriones <br>  ‚îÇ ‚îú‚îÄ‚îÄ usuario1 <br>  ‚îÇ ‚îú‚îÄ‚îÄ usuario2 <br>  ‚îÇ ‚îî‚îÄ‚îÄ todos <br>  ‚îú‚îÄ‚îÄ server.conf <br>  ‚îî‚îÄ‚îÄ ... <br><br>  <code>User1</code> y <code>user2</code> son archivos en el formato anterior.  Describen a qu√© hosts tiene acceso el usuario con el nombre com√∫n correspondiente. <br><br>  Existe otro archivo adicional para <code>everybody</code> , que contiene reglas que se aplican a todos los clientes, siempre que haya un archivo de configuraci√≥n separado para estos clientes.  Es decir, si el usuario tiene una lista de hosts a los que puede ir, <code>everybody</code> aplicar√° esta lista y los hosts que figuran en <code>everybody</code> .  Si no, entonces no <code>everybody</code> aplicables.  Por ejemplo, es conveniente colocar un servidor DNS en este archivo. <br><br>  <b>Registro</b> <br><br>  El script de instalaci√≥n incluye solo el registro de las conexiones actuales (par√°metro de <code>status)</code> .  Para que aparezca un registro regular, debe agregar una l√≠nea a la configuraci√≥n del servidor ( <code>/etc/openvpn/server.conf</code> ): <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-append /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/openvpn.log</code> </pre> <br><br>  <b>LDAP</b> <br><br>  Existe un complemento <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">openvpn-auth-ldap</a> que le permite autenticar a un usuario nuevamente a trav√©s de LDAP. <br><br>  Entregar paquete: <br><br><pre> <code class="plaintext hljs">sudo yum install openvpn-auth-ldap</code> </pre> <br>  A√±adir a server.conf: <br><br><pre> <code class="plaintext hljs">plugin /usr/lib64/openvpn/plugin/lib/openvpn-auth-ldap.so "/etc/openvpn/ldap.conf"</code> </pre> <br>  Cree una configuraci√≥n para ldap en <code>/etc/openvpn/ldap.conf</code> : <br><pre> <code class="plaintext hljs">&lt;LDAP&gt; URL ldaps://{LDAP_DOMAIN_HERE} Timeout 15 TLSEnable no FollowReferrals yes BindDN "BIND_DN_HERE" Password "BIND_PASSWORD_HERE" &lt;/LDAP&gt; &lt;Authorization&gt; BaseDN "{BASE_DN_HERE}" SearchFilter "(&amp;(sAMAccountName=%u)(objectClass=organizationalPerson)(objectCategory=person)(!(userAccountControl:1.2.840.113556.1.4.803:=2)))" RequireGroup false &lt;/Authorization&gt;</code> </pre><br>  Agregue la l√≠nea a la configuraci√≥n personalizada de ovpn: <br><br><pre> <code class="plaintext hljs">auth-user-pass</code> </pre> <br>  Por lo tanto, primero se le pedir√° al usuario el nombre de usuario y la contrase√±a del dominio, luego el PIN del token.  Si uno de estos pasos falla, la conexi√≥n no se establecer√°. <br><br>  La descripci√≥n de las opciones para ldap.conf <a href="">est√° en el repositorio de complementos</a> .  Es compatible con la autenticaci√≥n por membres√≠a de grupo, pero no lo he probado. <br><br><h4>  Velocidad </h4><br>  El mayor aumento de velocidad da la inclusi√≥n del modo udp.  Esto se recomienda en todos los manuales.  El punto es que no tiene sentido iniciar una conexi√≥n de cliente tcp en un canal tcp.  Un tcp en el cliente es suficiente para hacer la entrega correcta de paquetes.  Si se pierden paquetes en el canal udp, la conexi√≥n tcp del cliente controlar√° el ajuste de entrega. <br><br>  La velocidad aumentar√° al menos porque no hay necesidad de esperar la confirmaci√≥n de la entrega de cada paquete en el canal.  Hay un segundo problema con tcp: un paquete tcp de cliente probablemente no cabe en un paquete del canal vpn.  MTU es igual, pero se deben agregar encabezados al paquete del cliente.  Como resultado, debe enviar dos paquetes dentro del canal vpn por paquete de usuario. <br><br>  TCP tiene sentido usar cuando es imposible de otra manera.  Por ejemplo, cuando vpn funciona a trav√©s del canal ssh. <br><br><h4>  Ejemplo de una configuraci√≥n completa del servidor </h4><br><div class="spoiler">  <b class="spoiler_title">ejemplo-servidor.conf</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">port 1194 proto tcp dev tun sndbuf 0 rcvbuf 0 ca ca.crt cert server.crt key server.key dh dh.pem tls-auth ta.key 0 topology subnet server 10.8.0.0 255.255.255.0 ifconfig-pool-persist ipp.txt push "redirect-gateway def1 bypass-dhcp" push "dhcp-option DNS 10.0.0.25" push "dhcp-option DNS 10.0.0.24" keepalive 10 120 cipher AES-256-CBC comp-lzo user nobody group nobody persist-key persist-tun status openvpn-status.log verb 3 crl-verify crl.pem log-append /var/log/openvpn.log script-security 2 client-connect /etc/openvpn/bin/hosts.rb client-disconnect /etc/openvpn/bin/hosts.rb</code> </pre><br></div></div><br><h3>  Configuraci√≥n de token </h3><br><h4>  Biblioteca PKCS # 11 </h4><br>  Para trabajar con tokens, necesitas una biblioteca especial.  La biblioteca es necesaria tanto para crear pares de claves como para la conexi√≥n real.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Descargar para todas las plataformas por el enlace</a> . <br><br>  Dondequiera que se encuentre librtpkcs11ecp.so m√°s adelante, esta es la biblioteca que debe descargarse y colocarse en un lugar conveniente. <br><br><h4>  Crear un certificado en un token </h4><br>  Genere un par de claves en el token.  El par√°metro id aqu√≠ es el n√∫mero de serie de la ranura en el token donde encaja el par de claves. <br><br><pre> <code class="plaintext hljs">pkcs11-tool --module /usr/lib64/librtpkcs11ecp.so --keypairgen --key-type rsa:2048 -l --id 01</code> </pre><br>  Realice una solicitud de certificado para la clave p√∫blica.  En el proceso de creaci√≥n de una solicitud de certificado, se establece la duraci√≥n del certificado y el nombre com√∫n, que se utiliza para filtrar las direcciones IP disponibles dentro de la red.  El nombre com√∫n debe coincidir con el inicio de sesi√≥n en ActiveDirectory para que no haya confusi√≥n. <br><br><pre> <code class="plaintext hljs">openssl openssl&gt; engine -t dynamic -pre SO_PATH:/usr/lib64/openssl/engines/pkcs11.so -pre ID:pkcs11 -pre LIST_ADD:1 -pre LOAD -pre MODULE_PATH:/usr/lib64/librtpkcs11ecp.so openssl&gt; req -engine pkcs11 -new -key slot_0-id_01 -keyform engine -out /home/john/good.req</code> </pre><br>  La solicitud recibida se debe mover a la <code>/etc/openvpn/easy-rsa/pki/reqs/</code> .  La extensi√≥n del archivo debe ser <code>req</code> . <br>  Convertir una solicitud en un certificado: <br><br><pre> <code class="plaintext hljs">cd /etc/openvpn/easy-rsa/ ./easyrsa sign-req client good</code> </pre><br>  Despu√©s de eso, aparecer√° un certificado con el mismo nombre pero con la extensi√≥n <code>crt</code> en la carpeta <code>/etc/openvpn/easy-rsa/pki/issued/</code> . <br><br>  Antes de grabar, el certificado debe convertirse a DER: <br><br><pre> <code class="plaintext hljs">openssl x509 -in /home/user/user-cert.pem -out /home/user/user-cert.crt -outform DER</code> </pre><br>  Escribir un certificado para un token: <br><br><pre> <code class="plaintext hljs">pkcs11-tool --module /usr/lib/librtpkcs11ecp.so -l -y cert -w /home/user/user-cert.crt --id 45 --label TEST</code> </pre> <br>  Est√° escrito sobre la base del art√≠culo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"Uso de Rutoken EDS con OpenSSL (RSA)"</a> . <br><br><h4>  Uso de token para autenticaci√≥n </h4><br>  Encuentre la identificaci√≥n del certificado que se presentar√° al servidor: <br><br><pre> <code class="plaintext hljs">$ openvpn --show-pkcs11-ids /usr/lib64/librtpkcs11ecp.so The following objects are available for use. Each object shown below may be used as parameter to --pkcs11-id option please remember to use single quote mark. Certificate DN: /CN=User1 Serial: 490B82C4000000000075 Serialized id: aaaa/bbb/41545F5349474E415455524581D2A1A1B23C4AA4CB17FAF7A4600</code> </pre><br>  Estamos interesados ‚Äã‚Äãen la identificaci√≥n serializada aqu√≠. <br><br>  Opciones que deben ingresarse en la configuraci√≥n de ovpn para que los tokens recojan: <br><br><pre> <code class="plaintext hljs">pkcs11-providers /usr/lib64/librtpkcs11ecp.so pkcs11-id 'aaaa/bbb/41545F5349474E415455524581D2A1A1B23C4AA4CB17FAF7A4600'</code> </pre> <br>  La opci√≥n <code>pkcs11-id</code> <b>debe estar entre comillas simples.</b> <br><br>  Este manual tiene sentido en todas las plataformas.  Debe especificar la ruta a la biblioteca y la identificaci√≥n del certificado en el token.  La biblioteca puede llamarse de manera un poco diferente, ser <code>.dll</code> , no <code>.so</code> , pero el significado es el mismo. <br><br>  En este caso, debe eliminar las secciones <code>cert</code> y <code>key</code> del archivo ovpn, ya que el certificado y la clave privada se tomar√°n del token. <br><br>  La configuraci√≥n completa del cliente (para Windows) se ve as√≠: <br><br><div class="spoiler">  <b class="spoiler_title">cliente.ovpn</b> <div class="spoiler_text"> <code>client <br> dev tun <br> proto tcp <br> sndbuf 0 <br> rcvbuf 0 <br> remote 78.47.37.247 22222 <br> resolv-retry infinite <br> nobind <br> persist-key <br> persist-tun <br> remote-cert-tls server <br> cipher AES-256-CBC <br> comp-lzo <br> setenv opt block-outside-dns <br> key-direction 1 <br> verb 3 <br> <br> pkcs11-providers "c://Windows//System32//rtPKCS11ECP.dll" <br> pkcs11-id 'Aktiv\x20Co\x2E/Rutoken\x20ECP/342b871d/Rutoken/01' <br> <br> -----BEGIN CERTIFICATE----- <br> {CERT_HERE} <br> -----END CERTIFICATE----- <br> <br> <br> &lt;tls-auth&gt; <br> # <br> # 2048 bit OpenVPN static key <br> # <br> -----BEGIN OpenVPN Static key V1----- <br> {KEY_HERE} <br> -----END OpenVPN Static key V1----- <br> &lt;/tls-auth&gt;</code> <br> </div></div><br>  Escrito en base a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"C√≥mo agregar autenticaci√≥n de doble factor a una configuraci√≥n de OpenVPN usando tarjetas inteligentes del lado del cliente"</a> . <br><br><h3>  Configuraci√≥n del cliente </h3><br><h4>  Linux </h4><br>  Openvpn tiene un error que impide que el usuario ingrese el c√≥digo PIN del token si el paquete est√° construido con soporte systemd.  Como systemd ha estado en todas partes √∫ltimamente, todos los paquetes que ya est√°n disponibles en los repositorios se compilan con su soporte.  Los clientes en Linux necesitan recolectar el paquete por su cuenta.  Aqu√≠ hay un ejemplo de configuraci√≥n que funcion√≥ para m√≠ en Arch Linux: <br><br><pre> <code class="plaintext hljs">./configure \ --prefix=/usr \ --sbindir=/usr/bin \ --enable-iproute2 \ --enable-pkcs11 \ --enable-plugins \ --enable-x509-alt-username</code> </pre><br>  Puede verificar que openvpn se compila con o sin systemd utilizando el siguiente comando: <br><br><pre> <code class="plaintext hljs">openvpn --version | grep --color enable_systemd</code> </pre><br><h4>  Mas os </h4><br>  En Mac OS, solo hay un cliente gratuito: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Tunnelblink</a> . <br><br>  No sabe c√≥mo ingresar un c√≥digo PIN desde un token desde la interfaz gr√°fica de usuario.  El error se describe, por ejemplo, aqu√≠: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://groups.google.com/forum/#!topic/tunnelblick-discuss/f_Rp_2nV-x8 Se</a> omite al iniciar openvpn desde la consola.  Esto no es sorprendente, dado que el cliente oficial para Windows tampoco lo sabe. <br><br>  Tambi√©n en Mac OS (a diferencia de Windows) se requieren scripts adicionales para configurar la red.  Si simplemente ejecuta openvpn desde la consola, entonces DNS no funcionar√° (quiz√°s algo m√°s, solo aparecer√° DNS). <br><br>  TunnelBlick tiene estos scripts de configuraci√≥n de red, solo es necesario invocarlos al establecer y desconectar la conexi√≥n.  Lo que necesita agregar a la configuraci√≥n de ovpn: <br><br><pre> <code class="bash hljs">script-security 2 up <span class="hljs-string"><span class="hljs-string">"/Applications/Tunnelblick.app/Contents/Resources/client.up.tunnelblick.sh -9 -d -f -m -w -ptADGNWradsgnw"</span></span> down <span class="hljs-string"><span class="hljs-string">"/Applications/Tunnelblick.app/Contents/Resources/client.down.tunnelblick.sh -9 -d -f -m -w -ptADGNWradsgnw"</span></span></code> </pre> <br>  Un script de ejemplo para iniciar una conexi√≥n openvpn, que se puede colocar en el escritorio y pinchar con el mouse: <br><br><pre> <code class="plaintext hljs">#!/bin/bash tunnelblick=/Applications/Tunnelblick.app/Contents/Resources/openvpn/openvpn-2.4.2-openssl-1.0.2k sudo $tunnelblick/openvpn --config $tunnelblick/user.ovpn</code> </pre><br><h4>  Ventanas </h4><br>  Debajo de Windows, todo parece funcionar.  El cliente oficial no sabe c√≥mo ingresar el c√≥digo PIN desde el token, logra abrir vpn manualmente desde la consola. <br><br>  Lo m√°s importante es hacer todo desde debajo del administrador.  Ejecute el instalador del cliente como administrador.  Inicie un terminal en el que openvpn se inicie tambi√©n con derechos de administrador; de lo contrario, no podr√° controlar la interfaz de red. <br><br>  En Windows, la ruta a la biblioteca para trabajar con tokens se debe registrar mediante barras diagonales dobles.  Esto se aplica tanto a la configuraci√≥n de ovpn como a la opci√≥n <code>--show-pkcs11-ids</code> en la l√≠nea de comandos. <br><br><pre> <code class="bash hljs">pkcs11-providers <span class="hljs-string"><span class="hljs-string">"c://Windows//System32//rtPKCS11ECP.dll"</span></span> pkcs11-id <span class="hljs-string"><span class="hljs-string">'Aktiv\x20Co\x2E/Rutoken\x20ECP/342b871d/Rutoken/01'</span></span></code> </pre></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es433250/">https://habr.com/ru/post/es433250/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es433234/index.html">Se requiere una ni√±era perfecta; aseg√∫rese de realizar un an√°lisis de IA para evaluar el respeto y los buenos modales</a></li>
<li><a href="../es433236/index.html">El jefe de Google cree que el miedo a la IA est√° "completamente justificado"</a></li>
<li><a href="../es433242/index.html">M√°scara t√≥xica</a></li>
<li><a href="../es433246/index.html">Marco: an√°lisis de sistemas DLT</a></li>
<li><a href="../es433248/index.html">An√°lisis de la memoria forense con OtterCTF e introducci√≥n del marco de volatilidad</a></li>
<li><a href="../es433252/index.html">Maniqu√≠ en un helic√≥ptero h√≠brido turborreactor el√©ctrico</a></li>
<li><a href="../es433254/index.html">Solo estamos luchando contra la muerte, ¬øy t√∫? O empresas que desarrollan una medicina fant√°stica.</a></li>
<li><a href="../es433256/index.html">Desarrollo de UI con Flutter</a></li>
<li><a href="../es433258/index.html">Puede comprar componentes electr√≥nicos en Europa incluso de vacaciones. Experiencia de compra en Mouser en Bulgaria</a></li>
<li><a href="../es433260/index.html">Lectura de fin de semana: materiales sobre el trabajo con DP, revisiones de hierro en el centro de datos y la "cocina" del proveedor de IaaS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>