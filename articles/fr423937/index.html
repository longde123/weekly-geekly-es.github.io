<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî∑ üë®üèº üîë El√©vation de privil√®ges Windows üè∏ üå∂Ô∏è üíáüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pratique de gestion de la s√©curit√© de l'information: pentest 
 Augmentation des privil√®ges utilisateur au niveau administrateur de domaine Windows 

 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>El√©vation de privil√®ges Windows</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/423937/"><h2>  Pratique de gestion de la s√©curit√© de l'information: pentest </h2><br>  <b>Augmentation des privil√®ges utilisateur au niveau administrateur de domaine Windows</b> <br><br><h4>  Pr√©sentation </h4><br>  Un bon syst√®me de gestion de la s√©curit√© de l'information (SMSI) n√©cessite une √©valuation r√©guli√®re de son efficacit√©.  Il existe diff√©rentes m√©thodes d'√©valuation, dont l'une des vari√©t√©s est la soi-disant.  "Test de p√©n√©tration" ou pentest - une simulation autoris√©e d'une attaque de pirate informatique sur un syst√®me d'information afin d'identifier les vuln√©rabilit√©s de sa protection avant qu'elles ne soient d√©tect√©es par un v√©ritable attaquant.  Dans ce cas, tous les outils de piratage, exploits, m√©thodes, etc. disponibles dans la vie r√©elle peuvent √™tre utilis√©s. <br><br>  Cet article d√©crit l'une de ces pratiques anti-piratage, qui visait √† augmenter les privil√®ges d'un utilisateur de domaine Microsoft Windows ordinaire au niveau d'un administrateur de domaine.  L'article √©tait bas√© sur un rapport sur les r√©sultats d'un test mis en pratique.  Pour des raisons de confidentialit√©, toutes les informations permettant d'identifier le lieu (noms de domaine et d'h√¥te, comptes, etc.) sont supprim√©es ou modifi√©es.  L'article montre les techniques de base, pour une meilleure compr√©hension, j'ai donn√© les fondements th√©oriques et les vuln√©rabilit√©s utilis√©s pour des versions sp√©cifiques de syst√®mes d'exploitation, ainsi que des recommandations g√©n√©rales pour la protection.  Et bien que la plupart de ces versions de Windows soient consid√©r√©es comme obsol√®tes au moment de la publication, cet article peut √™tre utile aux administrateurs syst√®me d√©butants pour mieux comprendre les m√©thodes de protection des informations d'identification dans un environnement Windows. <br><a name="habracut"></a><br><h4>  Description de l'objet de test </h4><br>  L'objet de test est assez standard - le syst√®me d'information d'une petite entreprise (moins de 200 employ√©s) sp√©cialis√©e dans le d√©veloppement de logiciels.  Le r√©seau interne de l'entreprise est √©galement typique: Ethernet Gigabit par ligne commut√©e, domaine Microsoft Windows (nous l'appellerons CORP.LOCAL).  Les h√¥tes internes sont divis√©s en sous-r√©seaux IP en fonction de leur affiliation fonctionnelle (tels que: un groupe de d√©veloppeurs, des ing√©nieurs qualit√©, le service des ressources humaines, la comptabilit√©, le marketing, la direction, les installations, etc.), toute la segmentation est effectu√©e sur le commutateur L3 .  Il existe √©galement un parc de serveurs internes d√©di√© √† un sous-r√©seau IP distinct et contenant: deux contr√¥leurs de domaine Windows Server 2008 avec DNS int√©gr√©, un serveur de messagerie interne ex√©cutant Exchange, un serveur de fichiers, un serveur de terminaux et certains autres serveurs auxiliaires ex√©cutant Windows et Linux.  Par ailleurs, il convient de noter un laboratoire de test avec une flotte de machines ex√©cutant diff√©rentes versions de Microsoft Windows (√† la fois de bureau et de serveur) et con√ßues pour tester le logiciel d√©velopp√©.  L'acc√®s aux h√¥tes du laboratoire de test est accessible √† tous les employ√©s.  La version principale du syst√®me d'exploitation de bureau est Windows 7. Un logiciel antivirus mal configur√© de diff√©rents fabricants est install√© sur les ordinateurs de bureau et les serveurs (de Symantec, Kaspersky et Trend Micro, pourquoi un syst√®me mal configur√© sera discut√© plus tard). <br><br><h4>  Mod√®le d'intrus </h4><br>  Intrus - un employ√© interne qui poss√®de un compte d'utilisateur non privil√©gi√© dans le domaine, un ordinateur de bureau, un acc√®s physique aux ordinateurs de test (peut-√™tre un ordinateur portable d'entreprise), mais qui n'a aucun privil√®ge d'administrateur local sur aucun d'entre eux.  De plus, le compte d'intrus n'a pas la possibilit√© de modifier les param√®tres du logiciel antivirus.  L'attaquant a pour objectif d'obtenir un acc√®s √©quivalent √† l'acc√®s de l'administrateur au contr√¥leur de domaine et / ou au serveur de fichiers. <br><br>  Comme nous le voyons, le mod√®le de l'intrus et la description de l'entreprise sont tout √† fait typiques. <br><br><h3>  Impl√©mentation d'attaque </h3><br><h4>  √âtape 0. Collecte d'informations sur le r√©seau interne </h4><br>  Donc, nous agissons au nom du contrevenant.  √Ä cette √©tape, nous devons collecter des informations sur: <br><br><ul><li>  adressage interne et sous-r√©seau </li><li>  noms d'h√¥te et adresses IP, tout d'abord nous sommes int√©ress√©s par une liste de serveurs </li><li>  en utilisant le protocole NetBIOS. </li></ul><br>  Tout d'abord, en utilisant l'utilitaire ipconfig, nous obtenons les adresses IP des serveurs DNS: 192.168.12.1 et 192.168.12.2.  Parce que  DNS est int√©gr√© √† Active Directory, ce qui nous donne des raisons de croire que nous connaissons les adresses IP des contr√¥leurs de domaine.  Ensuite, en utilisant l'utilitaire nslookup en mode interactif, nous essayons d'obtenir une liste de tous les h√¥tes dans la zone corp.local: <br><br>  <i>&gt; ls ‚Äìd corp.local&gt; fichier</i> <br><br>  En fait, cette commande lance un transfert de zone DNS complet, l'enregistrant dans un fichier.  De nombreux administrateurs oublient de d√©finir des restrictions sur le transfert de zone pour le r√©seau interne, ce qui permet √† un attaquant potentiel de collecter plus facilement des informations sur l'infrastructure de l'entreprise, pour plus de d√©tails, voir [12]. <br><br>  <b>R√©sultat.</b>  Succ√®s.  Un transfert de zone non prot√©g√© nous a donn√© une liste compl√®te des noms d'h√¥tes internes, y compris les serveurs, et leurs adresses IP.  En utilisant les utilitaires nbtstat, telnet, ainsi que n'importe lequel des scanners de vuln√©rabilit√© courants, un attaquant peut collecter des informations sur la plate-forme, l'ex√©cution des services, les versions du syst√®me d'exploitation sur les h√¥tes qui l'int√©ressent. <br><br><h4>  √âtape 1. Obtention des privil√®ges d'administrateur local </h4><br>  <b>Th√©orie</b>  Pour obtenir le mot de passe administrateur local, une attaque est appliqu√©e √† la valeur de hachage de ce mot de passe stock√© dans le registre syst√®me.  Malgr√© le fait que la fonction de hachage est math√©matiquement irr√©versible, le calcul du mot de passe est possible par √©num√©ration directe de ses valeurs avec une attaque par dictionnaire.  Windows a historiquement utilis√© deux algorithmes pour calculer une fonction de hachage de mot de passe: l'algorithme LM h√©rit√© et l'algorithme NT plus r√©cent (parfois aussi appel√© NTLM).  La fonction de hachage LM est vuln√©rable en raison de sa faible complexit√© de calcul, ce qui permet d'√©num√©rer ses valeurs m√™me sur un ordinateur faible.  La pr√©sence de hachages de mot de passe LM et NT dans le registre syst√®me garantit que l'attaquant peut le casser dans un d√©lai acceptable.  La valeur de hachage LM aux param√®tres par d√©faut est stock√©e dans le registre de Windows XP / 2003, ce qui rend ces syst√®mes particuli√®rement attrayants pour le pirate.  La fonction de hachage NT est plus complexe sur le plan des calculs, cependant, l'√©num√©ration de ses valeurs est grandement simplifi√©e par le fait qu'il existe des tables de valeurs pr√©calcul√©es disponibles (appel√©es tables Rainbow) - elles r√©duisent le calcul de la valeur de hachage √† la recherche du hachage souhait√© parmi valeurs pr√©-calcul√©es. <br><br>  <b>Objet d'attaque.</b>  Mot de passe hach√© dans la base de donn√©es SAM (registre).  Dans notre cas, ce sont toutes des machines auxquelles nous avons un acc√®s physique.  Tout d'abord, il s'agit de notre bureau de travail et, deuxi√®mement, des h√¥tes pour effectuer des tests. <br><br>  <b>Mise en ≈ìuvre.</b>  Avec les machines qui ont un acc√®s physique, nous effectuons l'op√©ration suivante: d√©marrer √† partir d'un support externe (√† l'aide d'un CD d'environnement de pr√©installation Windows ou d'un CD Linux Live), monter la partition syst√®me NTFS et copier les branches de registre HKLM \ SYSTEM et HKLM \ SAM (fichiers% WINDIR % \ System32 \ Config \ System et% WINDIR% \ System32 \ Config \ Sam respectivement).  Nous accordons une attention particuli√®re aux machines ex√©cutant Windows XP \ Windows 2003, sur lesquelles le hachage LM est susceptible d'√™tre trouv√©.  Pour vider les mots de passe des fichiers de registre copi√©s, nous utilisons les outils [1], [2] (tous les liens √† la fin de l'article).  R√©sultat: <br><br><img src="https://habrastorage.org/webt/kn/jq/wm/knjqwm1nlf7ljjd99ndwh60bngg.png" alt="image"><br><br>  La derni√®re ligne contient le hachage NT requis de l'administrateur local.  Sur les h√¥tes du laboratoire de test (appelons ces h√¥tes LAB1 et LAB2), nous trouvons un hachage LM non nul: <br><br><img src="https://habrastorage.org/webt/sz/wi/30/szwi30d1cje8gsfkiok70xtnuyy.png" alt="image"><br><br><img src="https://habrastorage.org/webt/1j/g5/l-/1jg5l-dgphti0eayxdcozs-onts.png" alt="image"><br><br>  Nous avons donc obtenu des hachages NT et LM.  Mais comment r√©cup√©rer le mot de passe d'eux?  Pour ce faire, nous utiliserons les m√™mes outils [1], [2] ainsi que les services invers√©s de hachage en ligne [8] - [11]: <br><br><img src="https://habrastorage.org/webt/qx/dk/70/qxdk70sdc94zqcuzmxkavjeu4tg.png" alt="image"><br><br>  Remarque: le vrai mot de passe √©tait compos√© du nom de l'entreprise avec un petit modificateur et s'est rapidement cass√© sous une attaque de dictionnaire). <br><br>  <b>R√©sultat.</b>  Succ√®s.  Les mots de passe (qu'ils soient ¬´Pa $$ word1¬ª et ¬´Pa $$ word2¬ª) du compte administrateur local de notre bureau de travail et de deux ordinateurs de test ont √©t√© re√ßus.  Mais aideront-ils √† obtenir les droits d'administrateur de domaine?  √Ä ce sujet plus loin. <br><br><h4>  √âtape 2. Obtention des informations d'identification d'administrateur de domaine </h4><br>  <b>Th√©orie</b>  Dans la plupart des cas, il suffit d'obtenir la valeur du hachage NT du mot de passe pour l'administrateur de domaine.  Cela est d√ª au fait que lorsqu'un utilisateur est v√©rifi√© √† l'aide du protocole NTLM, le syst√®me authentifi√© pr√©sente uniquement le hachage NT √† l'authentificateur et la v√©rification du mot de passe ne se produit pas.  Le hachage NT peut √™tre obtenu √† partir du soi-disant  Stockage LSA en se r√©f√©rant √† la soi-disant  Sessions de connexion de l'administrateur (la session de connexion est une zone de donn√©es sp√©ciale cr√©√©e par le processus Winlogon o√π le nom d'utilisateur, le domaine de connexion et la valeur de hachage du mot de passe NT sont stock√©s, collectivement, c'est ce qu'on appelle le LSA-secret).  Ce hachage NT est utilis√© par le processus NTLMSSP pour l'authentification NTLM.  La session de connexion est enregistr√©e tout le temps pendant que le compte est connect√© au syst√®me.  Vous pouvez √©galement intercepter un hachage NT √† partir d'une session d'authentification d'administrateur NTLM.  De plus, il est possible d'obtenir un mot de passe administrateur √† partir du cache DCC (Domain Cached Credentials).  DCC est un cache local qui se remplit lorsqu'un utilisateur ouvre une session avec succ√®s sur un domaine.  L'objectif du cache DCC est de pouvoir authentifier l'utilisateur lorsque le contr√¥leur de domaine n'est pas disponible. <br><br>  <b>Objets d'attaque:</b> <br><br><ul><li>  Hachage DCC (branche de registre HKLM \ Security). </li><li>  Session de connexion de l'administrateur de domaine (LSA-secret). </li><li>  Interception des sessions NTLM (non envisag√©e en raison d'une plus grande complexit√© pratique). </li></ul><br>  <b>Pratique.</b>  De nombreux administrateurs Windows utilisent un compte d'administrateur de domaine pour effectuer diff√©rents types d'op√©rations sur les ordinateurs des utilisateurs.  Dans le m√™me temps, ses donn√©es tombent dans le cache DCC.  Par cons√©quent, essayez d'abord d'obtenir le mot de passe √† partir du cache DCC.  Nous allons sur notre poste de travail, enregistrons la branche de registre HKLM \ Security et l'importons dans [1].  Parce que  nous avons un mot de passe administrateur local, nous n'avons plus besoin de d√©marrer la machine √† partir d'un support externe pour enregistrer le registre: <br><br><img src="https://habrastorage.org/webt/up/6p/v3/up6pv3qirtuto8wcxfk6lkofkqq.png" alt="image"><br><br>  Le cache contient les donn√©es de mot de passe de trois comptes.  Le dernier compte (*** utilisateur) ne nous int√©resse pas, le deuxi√®me compte n'a pas les privil√®ges requis, mais l'utilisateur shadmin ressemble √† l'administrateur que vous recherchez.  Malheureusement, l'algorithme MS-CACHE2 a une grande complexit√© de calcul et une attaque directe par force brute sur celui-ci est inefficace.  La fonction MS-CACHEv2 contient un ¬´secret de calcul¬ª - sel (le nom du compte est utilis√© comme ¬´sel¬ª), ce qui la rend prot√©g√©e contre les attaques sur les tables Rainbow.  Cependant, √† l'avenir, des tables de valeurs de hachage peuvent appara√Ætre pour les comptes standard - ¬´Administrateur¬ª, ¬´Administrateur¬ª, etc.  Par souci d'int√©r√™t, nous envoyons le ¬´hachage de cache¬ª trouv√© au service cloud [8] - [11] (sur les r√©sultats et l'efficacit√© de ces services √† la fin de l'article).  Pendant que le cloud r√©fl√©chit, nous essayons de trouver d'autres DCC.  Nous analysons la liste d'h√¥tes obtenue √† l'√©tape 0, v√©rifions √† quels serveurs nous pouvons acc√©der sous l'administrateur local en utilisant les mots de passe obtenus √† l'√©tape 1. √âtant donn√© que l'administrateur local est bloqu√© sur le contr√¥leur de domaine et que le serveur de messagerie est g√©n√©ralement mieux prot√©g√©, vous devez exp√©rimenter avec serveurs secondaires.  Dans notre cas, un serveur avec le nom discret Upd a √©t√© trouv√© dans la liste des serveurs.  La connexion avec le mot de passe ¬´Pa $$ word2¬ª trouv√©e √† l'√©tape 1 a r√©ussi.  Nous constatons que sur l'h√¥te Upd: <br><br><ol><li>  Aucun logiciel antivirus install√©. </li><li>  Il ex√©cute Apache, qui est le serveur de gestion des antivirus d'entreprise (cela signifie qu'il existe √©galement un mot de passe pour le compte utilis√© pour installer le logiciel antivirus √† distance et, th√©oriquement, vous pouvez le retirer). </li><li>  L'h√¥te n'audit pas les tentatives de connexion ayant √©chou√©. </li><li>  Version du syst√®me d'exploitation - Windows 2008 R2. </li></ol><br>  Apr√®s avoir vid√© le registre HKLM \ Security, nous obtenons le hachage DCC du compte CORP.LOCAL \ Administrator (et plusieurs autres): <br><br><img src="https://habrastorage.org/webt/a5/3t/--/a53t--0v2fycjxm29xiytiqri3g.png" alt="image"><br><br>  Th√©oriquement, vous pouvez essayer de trouver le mot de passe de l'administrateur via un service cloud.  Cependant, comme je l'ai mentionn√© ci-dessus, une attaque par force brute sur MS-CACHEv2 est inutile (bien qu'il soit possible que dans quelques ann√©es la situation change).  Laissez DCC tranquille et passez √† la recherche de sessions de connexion.  V√©rifiez quel utilisateur est connect√© √† l'h√¥te Upd: <br><br><img src="https://habrastorage.org/webt/57/ri/fa/57rifa8peyelwyvtbw6d4nwrofu.png" alt="image"><br><br>  Nous voyons que deux sessions inactives se bloquent sur la machine Upd - l'administrateur et l'utilisateur Shadmin, qui nous sont d√©j√† familiers, ce qui signifie que nous pouvons obtenir des hachages NT de leurs mots de passe en volant le secret LSA.  C'est la cl√© pour d√©terminer le succ√®s de toute l'attaque.  Pour voler un hachage, utilisez l'exploit Lslsass [3].  Pour l'ex√©cuter, vous avez besoin des droits d'administrateur local (ou plut√¥t, des droits de d√©bogage des processus), que nous avons d√©j√†.  Nous obtenons la liste des secrets LSA (au format "domaine \ compte: Hachage LM: Hachage NT :::"): <br><br><pre><code class="hljs pgsql">lslsass v1<span class="hljs-number"><span class="hljs-number">.0</span></span> - Copyright (C) <span class="hljs-number"><span class="hljs-number">2010</span></span> Bjorn Brolin, Truesec (www.truesec.com) <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> Lsass pid: <span class="hljs-number"><span class="hljs-number">520</span></span> Lsass process <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token UPD\Administrator::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:&lt;i&gt;<span class="hljs-number"><span class="hljs-number">8833</span></span>c58febc977799520e7536bb2011e&lt;/i&gt;::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token UPD\Administrator::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">8833</span></span>c58febc977799520e7536bb2011e::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token UPD\Administrator::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">8833</span></span>c58febc977799520e7536bb2011e::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span>\UPD$::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">68987</span></span>a0fb5529dbf99d5eac3bfce773b::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> \UPD$::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">68987</span></span>a0fb5529dbf99d5eac3bfce773b::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> \UPD$::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">68987</span></span>a0fb5529dbf99d5eac3bfce773b::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> \Administrator::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>: &lt;b&gt; c690e441dc78bc5da8b389e78daa6392 &lt;/b&gt;::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> \shadmin::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>: &lt;b&gt; <span class="hljs-number"><span class="hljs-number">5794</span></span>cba8b464364eacf366063ff70e78 &lt;/b&gt; :::</code> </pre> <br>  Les lignes surlign√©es en gras contiennent les hachages de mot de passe requis.  Notez √©galement le hachage en italique dans la sixi√®me ligne.  Nous l'avons d√©j√† vu quelque part, non? <br><br>  <b>R√©sultat.</b>  Succ√®s.  Nous avons le hachage de mot de passe NT du compte d'administrateur de domaine entre nos mains.  Mais √† quoi sert un hachage si la restauration du mot de passe d'origine √† partir de celui-ci dans un d√©lai acceptable n'est pas possible?  √Ä ce sujet √† l'√©tape suivante. <br><br><h4>  √âtape 3. Trichez la session d'authentification NTLM </h4><br>  <b>Th√©orie</b>  Windows n'utilise jamais un mot de passe pur pour l'authentification, le syst√®me authentifi√© pr√©sente toujours un hachage.  Cela donne naissance √† l'id√©e: en rempla√ßant le nom d'utilisateur, le domaine de connexion et le hachage NT dans la session de connexion de l'utilisateur connect√© par les valeurs appropri√©es d'administrateur de domaine, nous pouvons nous authentifier en utilisant le protocole NTLM avant le syst√®me distant en tant qu'administrateur de domaine.  Cette attaque [7] n'est possible qu'avec une authentification utilisant le protocole NTLM.  Malgr√© l'utilisation r√©pandue du protocole Kerberos, NTLM est le seul moyen possible d'authentifier un client lors de l'acc√®s √† un partage r√©seau n'est pas par nom symbolique, mais par adresse IP [13]. <br><br>  <b>Objet d'attaque.</b>  Session d'ouverture de session de l'administrateur local. <br><br>  <b>Pratique.</b>  Il existe plusieurs exploits qui vous permettent de mettre en ≈ìuvre une attaque sur les plates-formes Windows Server 2008 x86 et x64.  L'exploit principal est l'√©diteur d'informations d'identification Windows [4].  Pour ex√©cuter l'attaque, nous allons √† l'h√¥te LAB2 en utilisant les informations d'identification "Administrateur" \ "Pa $$ word2".  √Ä l'aide de [4], nous rempla√ßons le nom de compte, le domaine de connexion et les donn√©es de hachage NT dans la session d'ouverture de session par les valeurs Shadmin correspondantes que nous avons obtenues √† l'√©tape pr√©c√©dente: <br><br><img src="https://habrastorage.org/webt/ww/kp/hc/wwkphcbxcv5fjhsrlk_1ydcakze.png" alt="image"><br><br>  Le nom du compte d'administrateur de domaine et son hachage NT sont pass√©s √† la commande wce comme argument √† partir de la ligne de commande.  R√©sultat - le hachage a √©t√© modifi√© avec succ√®s.  Je note que l'appartenance de l'utilisateur au groupe et le jeton d'acc√®s ne changent pas pendant l'attaque: <br><br><img src="https://habrastorage.org/webt/jg/jn/ym/jgjnymw3o3j8yv9cfd1sjojagbe.png" alt="image"><br><br>  Nous sommes toujours l'administrateur local, le nom d'h√¥te en vert dans la capture d'√©cran ci-dessus est enduit de vert - LAB2.  Cependant, lors de l'authentification NTLM, le syst√®me distant recevra le nom de domaine CORP.LOCAL, le nom d'utilisateur Shadmin et le hachage du mot de passe Shadmin.  Voici un vidage d'un seul paquet r√©seau contenant une session blob de s√©curit√© NTLM: <br><br><img src="https://habrastorage.org/webt/tt/c7/_x/ttc7_xrvp9e81zvathjqultz5sc.png" alt="image"><br><br>  Le nom de domaine (CORP.LOCAL) et le nom d'h√¥te (LAB2) sont gris√©s en vert), un compte est pr√©sent√© - Shadmin.  Maintenant, nous essayons de nous connecter √† la partition racine du volume syst√®me sur le contr√¥leur de domaine avec la commande net use en utilisant l'adresse IP du contr√¥leur de domaine: <br><br><img src="https://habrastorage.org/webt/ja/ga/2h/jaga2h8xrnj_wbn5acv-fe6zlqs.png" alt="image"><br><br>  Avec succ√®s.  Pour v√©rifier l'acc√®s, j'ai cr√©√© un fichier texte √† la racine (trouvez-le dans la capture d'√©cran).  Apr√®s avoir cr√©√© un fichier batch sur le disque du contr√¥leur de domaine avec la s√©quence de commandes dont nous avons besoin, nous pouvons, en utilisant [5], effectuer l'op√©ration n√©cessaire sur le contr√¥leur de domaine (par exemple, ajouter l'utilisateur au groupe d'administrateurs de domaine).  L'op√©ration sera effectu√©e avec les droits du compte Shadmin.  Pour illustrer, cr√©ez un fichier de commandes simple sur un h√¥te distant qui ajoute un utilisateur local: <br><br>  <i>utilisateur net TstUsr Pa $$ mot / ajouter</i> <br><br>  Ex√©cutez-le √† distance √† partir de l'h√¥te LAB2: <br><br><img src="https://habrastorage.org/webt/q3/3l/qf/q33lqf4cb4u9rw8zwqpcfpwhw-c.png" alt="image"><br><br>  Il sera ex√©cut√© sur le syst√®me distant 192.168.13.125 avec les privil√®ges de l'utilisateur de notre session actuelle - shadmin (c'est-√†-dire, administrateur de domaine).  Nous v√©rifions: <br><br><img src="https://habrastorage.org/webt/cq/oj/wp/cqojwpt8bb1c0volgimww9gsv-c.png" alt="image"><br><br>  La deuxi√®me sortie de la commande net user montre le nouvel utilisateur.  Malgr√© l'impossibilit√© de lancer des applications qui n√©cessitent une interaction utilisateur interactive de cette mani√®re (par exemple, des composants logiciels enfichables MMC), un large √©ventail d'actions peut √™tre effectu√© √† l'aide de scripts. <br><br>  <b>R√©sultat.</b>  Succ√®s.  Acc√®s au syst√®me de fichiers et au shell du contr√¥leur de domaine. <br><br><h4>  R√©sum√© </h4><br>  En bref, la cha√Æne d'attaque ressemblait √† ceci: Collecte d'informations sur la structure du r√©seau -&gt; Obtention d'un mot de passe administrateur local -&gt; Utilisation de ce mot de passe pour se connecter √† l'un des serveurs secondaires -&gt; Vol des informations d'identification d'administrateur de domaine ¬´laiss√© sans surveillance¬ª -&gt; Modification de votre session de connexion et √©l√©vation de privil√®ges. <br><br>  Le succ√®s de l'attaque a √©t√© facilit√© par: <br><br><ol><li>  Faible protection de la zone DNS contre le transfert vers des h√¥tes non approuv√©s. </li><li>  Politique de mot de passe faible.  La plupart des ordinateurs de domaine ont utilis√© le m√™me mot de passe pour le compte d'administrateur local, qui √©tait vuln√©rable √† une attaque par dictionnaire. </li><li>  L'absence ou la faible configuration du logiciel antivirus sur les h√¥tes critiques. </li><li>  Protection contre les hachages de mot de passe faible - deux sessions de connexion administrateur inactives sur l'h√¥te Upd, hachages LM dans la base de donn√©es SAM. </li><li>  Mauvaise politique d'audit. </li></ol><br><br>  Sur cette base, des recommandations g√©n√©rales de protection peuvent √™tre d√©riv√©es: <br><br>  0. Cacher compl√®tement la structure interne du r√©seau aux attaquants potentiels.  Par cons√©quent, les utilisateurs ne devraient pas pouvoir obtenir le contenu complet du fichier de zone DNS.  Utilisateurs non fiables (par exemple, stagiaires, employ√©s qui n'ont pas termin√© la p√©riode d'essai, etc.), il est logique de transf√©rer vers un sous-r√©seau distinct en utilisant NAT pour usurper des adresses (y compris, par exemple, la modification des r√©ponses DNS). <br><br>  1. La strat√©gie correcte pour attribuer des mots de passe √† l'administrateur local.  Le mot de passe administrateur local doit √™tre diff√©rent sur les h√¥tes qui ont diff√©rents degr√©s de protection contre les acc√®s non autoris√©s.  Compromettre le mot de passe administrateur local sur l'un des h√¥tes du domaine devrait minimiser la possibilit√© qu'un attaquant utilise ce mot de passe. <br><br>  2. Le stockage du hachage LM dans SAM doit √™tre interdit par les politiques de s√©curit√©. <br><br>  3. N'utilisez pas le nom de l'entreprise ou de son domaine dans le mot de passe administrateur). Il sera donc difficile pour un attaquant d'attaquer le dictionnaire.  Mais m√™me en utilisant un mot de passe complexe, ne vous oubliez pas et v√©rifiez r√©guli√®rement la durabilit√© de son hachage en utilisant les services en ligne. <br><br>  4. Il n'est pas recommand√© d'effectuer des op√©rations de routine sur des ordinateurs de domaine sous le compte d'administrateur de domaine.  Cela emp√™chera le compte d'intercepter les donn√©es de session d'ouverture de session et d'obtenir le hachage du mot de passe dans le cache DCC. <br><br>  5. Faites-en une r√®gle pour ne pas laisser la session d'ouverture de session de l'administrateur de domaine sans surveillance.  Meilleure pratique: travail termin√© - d√©connectez-vous. <br><br>  6. Les utilitaires d'usurpation LSA sont assez petits.  Il est logique de suivre leur √©volution et de v√©rifier leur d√©tection r√©ussie par un logiciel antivirus d'entreprise. <br><br>  7. Un utilisateur, m√™me avec des droits d'administrateur local, ne devrait pas pouvoir modifier les param√®tres d'un antivirus d'entreprise.  La d√©sactivation du service antivirus sur les postes de travail de domaine devrait entra√Æner une notification de l'administrateur de domaine (dans ce sens, Symantec Endpoint Protection a bien fonctionn√© pendant le test). <br><br><h4>  Annexe 1. Comportement antivirus </h4><br>  Les ordinateurs de la soci√©t√© utilisaient trois types d'antivirus: KAV, en vigueur au moment du test Symantec Endpoint Protection, et un produit obsol√®te de Trend Micro.  Dans la plupart des cas, les outils utilis√©s pendant l'attaque ont √©t√© identifi√©s comme Hack Tool / Rootkit / Trojan.  KAV les a supprim√©s sans avertissement, et SEP (m√™me d√©sactiv√©) a √©mis un avertissement et l'a d√©plac√© en quarantaine l'emp√™chant de d√©marrer.  Cependant, avoir des droits d'administrateur local vous permet de d√©sactiver KAV, et la protection SEP a √©t√© contourn√©e en d√©finissant manuellement un chemin d'exception pour la v√©rification, en utilisant √† nouveau le compte d'administrateur local.  L'antivirus de Trend Micro install√© sur certains h√¥tes n'a pas r√©agi du tout au lancement d'exploits. <br><br><h4>  Addendum 2. Efficacit√© de l'utilisation des services de v√©rification de hachage en ligne </h4><br>  De nombreux services en ligne sont disponibles pour tester la solidit√© des hachages de mot de passe.  Ils vous permettent de travailler avec les hachages les plus courants - LM, NTLM, MD4, MD5, WPA, avec des hachages utilisant du sel, etc.  Pour v√©rifier le hachage, l'√©num√©ration directe est utilis√©e en utilisant la puissance de traitement des GPU modernes, l'√©num√©ration des dictionnaires, les attaques hybrides, etc.  Une fois ouvert, le hachage peut reconstituer la base de donn√©es et √™tre utilis√© √† l'avenir.  Le service peut √™tre gratuit pour v√©rifier un mot de passe court (moins de 8 caract√®res) ou prendre un petit suppl√©ment.  Pendant le test, j'ai utilis√© quatre de ces services, les liens sont donn√©s √† la fin de l'article.  J'ai envoy√© plusieurs hachages trouv√©s √† l'√©tape 2 et apr√®s 15 mois, j'ai re√ßu une notification du service On-line Hash Crack [9] concernant la restauration r√©ussie de l'un d'eux) <br><br><h4>  Les r√©f√©rences </h4><br>  <b>Outils utilis√©s</b> <br><br>  [1] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Cain &amp; Abel</a> - un outil de r√©cup√©ration de mot de passe pour les syst√®mes d'exploitation Microsoft.  Il permet de r√©cup√©rer facilement plusieurs types de mots de passe en reniflant le r√©seau, en d√©chiffrant les mots de passe crypt√©s √† l'aide des attaques Dictionnaire, Brute-Force et Cryptanalysis, en enregistrant les conversations VoIP, en d√©codant les mots de passe brouill√©s, en r√©cup√©rant les cl√©s de r√©seau sans fil, en r√©v√©lant les bo√Ætes de mot de passe, en d√©couvrant les mots de passe mis en cache et en analysant le routage protocoles. <br>  [2] Fissure L0pht. <br>  [3] Exploitation Lslsass.  Vide les hachages de mot de passe de session d'ouverture de session active du processus lsass. <br>  [4] Post-exploit de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Windows Credentials Editor</a> .  Outil pour modifier les informations d'identification de connexion. <br>  [5] PsExec de PS Tools <br><br>  <b>Descriptions d√©taill√©es des vuln√©rabilit√©s</b> <br><br>  [6] S√©rie d'articles ¬´Obtention effective d'un hachage de mot de passe sous Windows¬ª sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">www.securitylab.ru</a> <br>  [7] Pass-the-Hash, une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">description d'une attaque</a> sur un syst√®me distant en lui fournissant un hachage compromis. <br><br>  <b>Services de piratage Cloud Hash</b> <br>  [8] Question-defense.com (semble √™tre hors service au moment de la publication () <br>  [9] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">www.onlinehashcrack.com</a> <br>  [10] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">www.cloudcracker.com</a> <br>  [11] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tueur de hachage en ligne</a> <br><br>  <b>Mat√©riel suppl√©mentaire</b> <br><br>  [12] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">S√©curit√© et optimisation DNS dans Windows Server</a> <br>  [13] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Kerberos n'est pas utilis√© lorsque vous vous connectez aux partages SMB √† l'aide de l'adresse IP</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr423937/">https://habr.com/ru/post/fr423937/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr423925/index.html">Webinaire ouvert "Mod√®le r√©cursif √©trange"</a></li>
<li><a href="../fr423927/index.html">10 moteurs de recherche prometteurs pour am√©liorer le r√©f√©rencement</a></li>
<li><a href="../fr423931/index.html">Comment contourner l'authentification SMS lors de la connexion aux r√©seaux Wi-Fi publics?</a></li>
<li><a href="../fr423933/index.html">S√©curit√© de Microsoft Office: objets int√©gr√©s</a></li>
<li><a href="../fr423935/index.html">Embox r√©pond aux questions les plus courantes du festival TechTrain IT</a></li>
<li><a href="../fr423939/index.html">Programmation dynamique ou Diviser pour mieux r√©gner</a></li>
<li><a href="../fr423941/index.html">Rapports d'iOS mitap Redmadrobot</a></li>
<li><a href="../fr423943/index.html">Optimisation des prix de d√©tail hors ligne</a></li>
<li><a href="../fr423945/index.html">La Cour supr√™me a pr√©cis√© la proc√©dure √† suivre pour examiner les cas de reposts et de likes</a></li>
<li><a href="../fr423947/index.html">Nos donn√©es personnelles ne vous co√ªtent rien</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>