<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏽‍💼 🌵 🤮 Über den Missbrauch der Verwendung des Betriebssystems in Projekten für Mikrocontroller 🙆🏿 👇🏽 👳🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Moderne Mikrocontroller haben eine ziemlich hohe Leistung, und dies gibt vielen Programmierern die Möglichkeit, ungefähr so ​​zu denken: - „Es ist in ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Über den Missbrauch der Verwendung des Betriebssystems in Projekten für Mikrocontroller</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461265/">  Moderne Mikrocontroller haben eine ziemlich hohe Leistung, und dies gibt vielen Programmierern die Möglichkeit, ungefähr so ​​zu denken: - „Es ist in Ordnung, wenn 1-5% der Leistung für die Wartung des Betriebssystems verwendet werden.  Aber mein Code wird leicht zu debuggen und explizit sein! “  Diese Überlegungen werden durch eine große Menge nichtflüchtigen Speichers (Flash) zum Speichern des Betriebssystemcodes und eines Arbeitsspeichers (RAM / SRAM) zum Zuweisen eines eigenen Stapels für jede Aufgabe unterstützt.  In den meisten Fällen ist diese Idee jedoch falsch.  Und in diesem Artikel werde ich Ihnen sagen, warum. <a name="habracut"></a><br><br><h2>  Über die Projekte, mit denen ich arbeite </h2><br>  In meiner Praxis muss ich oft mit einem „Designer“ arbeiten.  Ich habe diesen Ansatz in meinem vorherigen Artikel über die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Verwendung von C ++ in Mikrocontrollern</a> ausführlich beschrieben.  Dann habe ich nicht das Wichtigste gesagt.  Die meisten "Blöcke" dieses "Konstruktors" sind irgendwie an ein Echtzeitbetriebssystem gebunden.  Die meisten „Blöcke“ haben ihren eigenen Ablauf (Aufgabe in Bezug auf das verwendete FreeRTOS-Echtzeitbetriebssystem).  Und dass das Projekt im Durchschnitt etwa 10-15 Aufgaben hat.  Manchmal erreicht dieser Wert 35-40. <br><br>
<h2>  Wo so viel? </h2><br>  Hier ist eine kurze Liste der Aufgaben, die <b>in jedem</b> Projekt auftreten: <ul><li>  ADC-Wartung (jedes Modul wird von seinem eigenen Ablauf gewartet); </li><li>  wdt-Wartung (wenn das Betriebssystem abstürzt, wird es von der Task nicht zurückgesetzt und das Gerät wird neu gestartet); </li><li>  Arbeiten mit Einstellungsseiten (ein separater Stream steuert die Arbeit mit dem Flash-Speicher); </li><li>  Aufrechterhaltung des Interaktionsprotokolls mit der Außenwelt (stromabwärts der Schnittstelle. Zum Beispiel uart); </li></ul><br>  Dann gibt es bereits spezifische Dinge für jedes Gerät, wie zum Beispiel einen Strom für die Wartung von Thermistoren (Empfangen von Daten aus dem ADC-Messstrom und Konvertieren dieser Daten in Temperatur), Abfragen der externen Peripheriegeräte und so weiter. <br><br><h2>  Scheinbare Einfachheit </h2><br>  Trotz der Tatsache, dass das Projekt viele Aufgaben enthält, ist jede davon in einem Objekt der entsprechenden Klasse "versteckt" (denken Sie daran, dass sich der Konstruktor in C ++ befindet, dies kann jedoch auch in C nachgeahmt werden, indem "Programmieren in C in einem objektorientierten Stil" verwendet wird. Es ist <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">jedoch besser, dies nicht zu tun notwendig</a> ).  Da die Objekte dieses „Konstruktors“ global sind und FreeRTOS 9 in Projekten verwendet wird, wodurch die Erstellung eigener Entitäten in vom Benutzer zugewiesenen Puffern unterstützt wird, kann die Speichernutzung zum Zeitpunkt der Verknüpfung gesteuert werden.  Unter dem Gesichtspunkt der Überwachung von Speicherlecks ist also alles mehr oder weniger normal.  Es gibt jedoch folgende Nuancen: <br><ul><li>  Es muss klar sein, wie viel ein Stapel für jeden Thread benötigt wird.  Dabei: <ul><li>  kritische Fälle müssen berücksichtigt werden (z. B. Verschachtelung mit einem bestimmten Verhalten); </li><li>  Wenn Funktionen aus Standardbibliotheken verwendet werden, wissen Sie auch, wie sie angeordnet sind, oder haben zumindest eine Vorstellung davon, wie viel sie den Stapel verbrauchen werden. </li></ul></li></ul><br>  Abgesehen von dieser Tatsache scheint die Verwendung des Betriebssystems nur die Logik des Codes zu verbessern und ihn klarer zu machen. <br><br><h2>  Missbrauch der Betriebssystemfunktionalität </h2><br>  Die Hauptprobleme beginnen in dem Moment, in dem Sie vergessen, was Sie speziell für den Mikrocontroller schreiben.  Das Betriebssystem erhebt seine Kosten für die Arbeit mit eigenen Entitäten (wie Semaphoren, Mutexen, Warteschlangen).  Hier ist ein Beispiel einer <a href="">UART-Klasse zum Implementieren einer Terminalfunktion</a> .  In dem Interrupt wird ein Byte empfangen. Wenn es den Bereich durch gültige Eingabezeichen überschreitet, wird es mit den entsprechenden Ersetzungen zur Warteschlange hinzugefügt (z. B. '\ n' ändert sich in die Sequenz "\ n \ r").  Dies wurde durchgeführt, um den Port für das Senden zu sichern (da der Port nicht nur als Terminal fungieren kann. Protokolldaten können auch über ihn gesendet werden).  Dies stellt einerseits sicher, dass die Antwort so schnell wie möglich gesendet wird und das Senden von Daten mit höherer Priorität nicht beeinträchtigt (während Daten mit höherer Priorität gesendet werden, sammeln sie sich im Puffer an, wodurch DMA zum Senden der Antwort verwendet werden kann).  Ab diesem Moment geraten Sie jedoch auf eine rutschige Strecke.  Anstatt einen Haufen durch die Warteschlange zu schreiben, könnte man die Unterbrechung einfach korrekt in einem nicht leeren Puffer konfigurieren, der derzeit nicht auf dem UART arbeitet und wenn der DMA endet.  Dieser Ansatz erfordert ein klares Verständnis der Funktionsweise von Peripheriegeräten.  Es reduziert jedoch die Kosten auf ein absolutes Minimum, wodurch die Notwendigkeit einer solchen Lösung gleich Null wird. <br><br><h2>  Ignorieren der Hardwarefunktionalität des Mikrocontrollers </h2><br>  In meiner Praxis traf ich ein Projekt mit 18 Betriebssystem-Software-Timern, die auf dieselbe Frequenz eingestellt waren.  Zur gleichen Zeit gab es ungefähr 10 Zeitgeber im Mikrocontroller, von denen nur systische verwendet wurden.  Um den Scheduler des Betriebssystems zu takten.  Diese Entscheidung wurde durch den fehlenden Wunsch erklärt, "mit der Hardware" des Mikrocontrollers herumzuspielen.  Gleichzeitig wurden dem Stapel etwa 10 kb für die vom Software-Timer aufgerufene Funktion zugewiesen.  Tatsächlich wurde ungefähr 1 kb verwendet (kurz).  Dies lag an der "Mehrdeutigkeit dessen, was in den genannten Bibliotheken geschieht". <br>  In diesem Fall war es möglich, TIM6 sicher auszuwählen (im Fall der Verwendung von stm32f4), was einen Interrupt mit einer bestimmten Frequenz erzeugen und darin einfach die erforderlichen Funktionen aufrufen würde. <br><br><h2>  Verwenden einer Endlosschleife anstelle einer Zustandsmaschine </h2><br>  Als separate Spalte würde ich die Unfähigkeit einiger Programmierer herausgreifen, kompakte Finite-State-Maschinen zu schreiben, und stattdessen einen Stream erstellen, in dem es eine Endlosschleife gibt, die ihre Arbeit beginnt, indem sie etwas aus der Warteschlange holt.  Interessanterweise wird in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">diesem Artikel beschrieben</a> , wie kompakte Finite-State-Maschinen mithilfe der Sprache selbst erstellt werden. <br><br><h2>  Ignorieren des "Hardware-Schedulers" </h2><br>  Viele 32-Bit-Mikrocontroller verfügen über einen durchdachten Interrupt-Controller mit einem anpassbaren Prioritätssystem.  Im Fall von stm32f4 hat es den Namen NVIC und kann Interrupt-Prioritäten mit 16 Ebenen festlegen (ohne Berücksichtigung von Unterebenen). <br>  Die meisten Anwendungen unter FreeRTOS, mit denen ich mich befassen musste, konnten als Zustandsmaschinen geschrieben werden, die in Interrupts mit korrekt konfigurierten Prioritäten aufgerufen wurden.  Und falls der Prozessor zur "normalen Ausführung" zurückkehrt, gehen Sie in den "Ruhezustand".  In diesem Fall wäre es nicht erforderlich, den Zugriff auf die meisten Ressourcen (Variablen und andere) zu blockieren.  Anwendungen würden eine zusätzliche Abstraktionsebene verlieren.  Und in diesem Fall - alles andere als kostenlos.  Dieser Ansatz erfordert jedoch eine sorgfältige Architekturplanung für jedes Projekt.  In Projekten "Designer" - alle Interrupts haben eine Priorität und werden tatsächlich benötigt, um die Daten zu "filtern".  Stellen Sie dann die Reste in die Warteschlange, von wo aus der Objektstrom der entsprechenden Klasse sie nimmt. <br><br><h2>  Zusammenfassung </h2><br>  In diesem Artikel habe ich über die grundlegenden Probleme gesprochen, mit denen Sie bei der Verwendung des Betriebssystems in Projekten für Mikrocontroller konfrontiert sind, und auch häufige Fälle der Verwendung des Betriebssystems untersucht, bei denen dies hätte vermieden werden können, ohne die Lesbarkeit und Logik des Codes zu verlieren. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de461265/">https://habr.com/ru/post/de461265/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de461253/index.html">Wie man sich in C und C ++ in den Fuß schießt. Haiku OS Kochbuch</a></li>
<li><a href="../de461255/index.html">Wie man sich in C und C ++ in den Fuß schießt. Haiku OS Rezeptsammlung</a></li>
<li><a href="../de461257/index.html">Wie berechnet man den ROI aus der Testautomatisierung mit Selen?</a></li>
<li><a href="../de461259/index.html">Lagerparty, 8. August, Moskau</a></li>
<li><a href="../de461261/index.html">Checkliste nützlicher RRC-Webinare zu RRC-Produkten</a></li>
<li><a href="../de461267/index.html">Neue Intel-Technologien für Chip-Verpackungen</a></li>
<li><a href="../de461269/index.html">Die Joblösung mit pwnable.kr 08 ist leg und 10 ist shellshock. ARM-Assembler. Bash-Schwachstelle</a></li>
<li><a href="../de461271/index.html">So bewerben Sie eine mobile Anwendung im Jahr 2019: 4 praktische Möglichkeiten + nützliche Tools</a></li>
<li><a href="../de461273/index.html">Gieriger Ansatz und Spielautomaten. Analyse der Aufgaben der ML-Strecke der Programmiermeisterschaft</a></li>
<li><a href="../de461277/index.html">Übersicht über das kostenlose SQLIndexManager-Tool</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>