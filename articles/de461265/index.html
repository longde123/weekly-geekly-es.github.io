<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘©ğŸ½â€ğŸ’¼ ğŸŒµ ğŸ¤® Ãœber den Missbrauch der Verwendung des Betriebssystems in Projekten fÃ¼r Mikrocontroller ğŸ™†ğŸ¿ ğŸ‘‡ğŸ½ ğŸ‘³ğŸ¿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Moderne Mikrocontroller haben eine ziemlich hohe Leistung, und dies gibt vielen Programmierern die MÃ¶glichkeit, ungefÃ¤hr so â€‹â€‹zu denken: - â€Es ist in ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ãœber den Missbrauch der Verwendung des Betriebssystems in Projekten fÃ¼r Mikrocontroller</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461265/">  Moderne Mikrocontroller haben eine ziemlich hohe Leistung, und dies gibt vielen Programmierern die MÃ¶glichkeit, ungefÃ¤hr so â€‹â€‹zu denken: - â€Es ist in Ordnung, wenn 1-5% der Leistung fÃ¼r die Wartung des Betriebssystems verwendet werden.  Aber mein Code wird leicht zu debuggen und explizit sein! â€œ  Diese Ãœberlegungen werden durch eine groÃŸe Menge nichtflÃ¼chtigen Speichers (Flash) zum Speichern des Betriebssystemcodes und eines Arbeitsspeichers (RAM / SRAM) zum Zuweisen eines eigenen Stapels fÃ¼r jede Aufgabe unterstÃ¼tzt.  In den meisten FÃ¤llen ist diese Idee jedoch falsch.  Und in diesem Artikel werde ich Ihnen sagen, warum. <a name="habracut"></a><br><br><h2>  Ãœber die Projekte, mit denen ich arbeite </h2><br>  In meiner Praxis muss ich oft mit einem â€Designerâ€œ arbeiten.  Ich habe diesen Ansatz in meinem vorherigen Artikel Ã¼ber die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Verwendung von C ++ in Mikrocontrollern</a> ausfÃ¼hrlich beschrieben.  Dann habe ich nicht das Wichtigste gesagt.  Die meisten "BlÃ¶cke" dieses "Konstruktors" sind irgendwie an ein Echtzeitbetriebssystem gebunden.  Die meisten â€BlÃ¶ckeâ€œ haben ihren eigenen Ablauf (Aufgabe in Bezug auf das verwendete FreeRTOS-Echtzeitbetriebssystem).  Und dass das Projekt im Durchschnitt etwa 10-15 Aufgaben hat.  Manchmal erreicht dieser Wert 35-40. <br><br>
<h2>  Wo so viel? </h2><br>  Hier ist eine kurze Liste der Aufgaben, die <b>in jedem</b> Projekt auftreten: <ul><li>  ADC-Wartung (jedes Modul wird von seinem eigenen Ablauf gewartet); </li><li>  wdt-Wartung (wenn das Betriebssystem abstÃ¼rzt, wird es von der Task nicht zurÃ¼ckgesetzt und das GerÃ¤t wird neu gestartet); </li><li>  Arbeiten mit Einstellungsseiten (ein separater Stream steuert die Arbeit mit dem Flash-Speicher); </li><li>  Aufrechterhaltung des Interaktionsprotokolls mit der AuÃŸenwelt (stromabwÃ¤rts der Schnittstelle. Zum Beispiel uart); </li></ul><br>  Dann gibt es bereits spezifische Dinge fÃ¼r jedes GerÃ¤t, wie zum Beispiel einen Strom fÃ¼r die Wartung von Thermistoren (Empfangen von Daten aus dem ADC-Messstrom und Konvertieren dieser Daten in Temperatur), Abfragen der externen PeripheriegerÃ¤te und so weiter. <br><br><h2>  Scheinbare Einfachheit </h2><br>  Trotz der Tatsache, dass das Projekt viele Aufgaben enthÃ¤lt, ist jede davon in einem Objekt der entsprechenden Klasse "versteckt" (denken Sie daran, dass sich der Konstruktor in C ++ befindet, dies kann jedoch auch in C nachgeahmt werden, indem "Programmieren in C in einem objektorientierten Stil" verwendet wird. Es ist <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">jedoch besser, dies nicht zu tun notwendig</a> ).  Da die Objekte dieses â€Konstruktorsâ€œ global sind und FreeRTOS 9 in Projekten verwendet wird, wodurch die Erstellung eigener EntitÃ¤ten in vom Benutzer zugewiesenen Puffern unterstÃ¼tzt wird, kann die Speichernutzung zum Zeitpunkt der VerknÃ¼pfung gesteuert werden.  Unter dem Gesichtspunkt der Ãœberwachung von Speicherlecks ist also alles mehr oder weniger normal.  Es gibt jedoch folgende Nuancen: <br><ul><li>  Es muss klar sein, wie viel ein Stapel fÃ¼r jeden Thread benÃ¶tigt wird.  Dabei: <ul><li>  kritische FÃ¤lle mÃ¼ssen berÃ¼cksichtigt werden (z. B. Verschachtelung mit einem bestimmten Verhalten); </li><li>  Wenn Funktionen aus Standardbibliotheken verwendet werden, wissen Sie auch, wie sie angeordnet sind, oder haben zumindest eine Vorstellung davon, wie viel sie den Stapel verbrauchen werden. </li></ul></li></ul><br>  Abgesehen von dieser Tatsache scheint die Verwendung des Betriebssystems nur die Logik des Codes zu verbessern und ihn klarer zu machen. <br><br><h2>  Missbrauch der BetriebssystemfunktionalitÃ¤t </h2><br>  Die Hauptprobleme beginnen in dem Moment, in dem Sie vergessen, was Sie speziell fÃ¼r den Mikrocontroller schreiben.  Das Betriebssystem erhebt seine Kosten fÃ¼r die Arbeit mit eigenen EntitÃ¤ten (wie Semaphoren, Mutexen, Warteschlangen).  Hier ist ein Beispiel einer <a href="">UART-Klasse zum Implementieren einer Terminalfunktion</a> .  In dem Interrupt wird ein Byte empfangen. Wenn es den Bereich durch gÃ¼ltige Eingabezeichen Ã¼berschreitet, wird es mit den entsprechenden Ersetzungen zur Warteschlange hinzugefÃ¼gt (z. B. '\ n' Ã¤ndert sich in die Sequenz "\ n \ r").  Dies wurde durchgefÃ¼hrt, um den Port fÃ¼r das Senden zu sichern (da der Port nicht nur als Terminal fungieren kann. Protokolldaten kÃ¶nnen auch Ã¼ber ihn gesendet werden).  Dies stellt einerseits sicher, dass die Antwort so schnell wie mÃ¶glich gesendet wird und das Senden von Daten mit hÃ¶herer PrioritÃ¤t nicht beeintrÃ¤chtigt (wÃ¤hrend Daten mit hÃ¶herer PrioritÃ¤t gesendet werden, sammeln sie sich im Puffer an, wodurch DMA zum Senden der Antwort verwendet werden kann).  Ab diesem Moment geraten Sie jedoch auf eine rutschige Strecke.  Anstatt einen Haufen durch die Warteschlange zu schreiben, kÃ¶nnte man die Unterbrechung einfach korrekt in einem nicht leeren Puffer konfigurieren, der derzeit nicht auf dem UART arbeitet und wenn der DMA endet.  Dieser Ansatz erfordert ein klares VerstÃ¤ndnis der Funktionsweise von PeripheriegerÃ¤ten.  Es reduziert jedoch die Kosten auf ein absolutes Minimum, wodurch die Notwendigkeit einer solchen LÃ¶sung gleich Null wird. <br><br><h2>  Ignorieren der HardwarefunktionalitÃ¤t des Mikrocontrollers </h2><br>  In meiner Praxis traf ich ein Projekt mit 18 Betriebssystem-Software-Timern, die auf dieselbe Frequenz eingestellt waren.  Zur gleichen Zeit gab es ungefÃ¤hr 10 Zeitgeber im Mikrocontroller, von denen nur systische verwendet wurden.  Um den Scheduler des Betriebssystems zu takten.  Diese Entscheidung wurde durch den fehlenden Wunsch erklÃ¤rt, "mit der Hardware" des Mikrocontrollers herumzuspielen.  Gleichzeitig wurden dem Stapel etwa 10 kb fÃ¼r die vom Software-Timer aufgerufene Funktion zugewiesen.  TatsÃ¤chlich wurde ungefÃ¤hr 1 kb verwendet (kurz).  Dies lag an der "Mehrdeutigkeit dessen, was in den genannten Bibliotheken geschieht". <br>  In diesem Fall war es mÃ¶glich, TIM6 sicher auszuwÃ¤hlen (im Fall der Verwendung von stm32f4), was einen Interrupt mit einer bestimmten Frequenz erzeugen und darin einfach die erforderlichen Funktionen aufrufen wÃ¼rde. <br><br><h2>  Verwenden einer Endlosschleife anstelle einer Zustandsmaschine </h2><br>  Als separate Spalte wÃ¼rde ich die UnfÃ¤higkeit einiger Programmierer herausgreifen, kompakte Finite-State-Maschinen zu schreiben, und stattdessen einen Stream erstellen, in dem es eine Endlosschleife gibt, die ihre Arbeit beginnt, indem sie etwas aus der Warteschlange holt.  Interessanterweise wird in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">diesem Artikel beschrieben</a> , wie kompakte Finite-State-Maschinen mithilfe der Sprache selbst erstellt werden. <br><br><h2>  Ignorieren des "Hardware-Schedulers" </h2><br>  Viele 32-Bit-Mikrocontroller verfÃ¼gen Ã¼ber einen durchdachten Interrupt-Controller mit einem anpassbaren PrioritÃ¤tssystem.  Im Fall von stm32f4 hat es den Namen NVIC und kann Interrupt-PrioritÃ¤ten mit 16 Ebenen festlegen (ohne BerÃ¼cksichtigung von Unterebenen). <br>  Die meisten Anwendungen unter FreeRTOS, mit denen ich mich befassen musste, konnten als Zustandsmaschinen geschrieben werden, die in Interrupts mit korrekt konfigurierten PrioritÃ¤ten aufgerufen wurden.  Und falls der Prozessor zur "normalen AusfÃ¼hrung" zurÃ¼ckkehrt, gehen Sie in den "Ruhezustand".  In diesem Fall wÃ¤re es nicht erforderlich, den Zugriff auf die meisten Ressourcen (Variablen und andere) zu blockieren.  Anwendungen wÃ¼rden eine zusÃ¤tzliche Abstraktionsebene verlieren.  Und in diesem Fall - alles andere als kostenlos.  Dieser Ansatz erfordert jedoch eine sorgfÃ¤ltige Architekturplanung fÃ¼r jedes Projekt.  In Projekten "Designer" - alle Interrupts haben eine PrioritÃ¤t und werden tatsÃ¤chlich benÃ¶tigt, um die Daten zu "filtern".  Stellen Sie dann die Reste in die Warteschlange, von wo aus der Objektstrom der entsprechenden Klasse sie nimmt. <br><br><h2>  Zusammenfassung </h2><br>  In diesem Artikel habe ich Ã¼ber die grundlegenden Probleme gesprochen, mit denen Sie bei der Verwendung des Betriebssystems in Projekten fÃ¼r Mikrocontroller konfrontiert sind, und auch hÃ¤ufige FÃ¤lle der Verwendung des Betriebssystems untersucht, bei denen dies hÃ¤tte vermieden werden kÃ¶nnen, ohne die Lesbarkeit und Logik des Codes zu verlieren. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de461265/">https://habr.com/ru/post/de461265/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de461253/index.html">Wie man sich in C und C ++ in den FuÃŸ schieÃŸt. Haiku OS Kochbuch</a></li>
<li><a href="../de461255/index.html">Wie man sich in C und C ++ in den FuÃŸ schieÃŸt. Haiku OS Rezeptsammlung</a></li>
<li><a href="../de461257/index.html">Wie berechnet man den ROI aus der Testautomatisierung mit Selen?</a></li>
<li><a href="../de461259/index.html">Lagerparty, 8. August, Moskau</a></li>
<li><a href="../de461261/index.html">Checkliste nÃ¼tzlicher RRC-Webinare zu RRC-Produkten</a></li>
<li><a href="../de461267/index.html">Neue Intel-Technologien fÃ¼r Chip-Verpackungen</a></li>
<li><a href="../de461269/index.html">Die JoblÃ¶sung mit pwnable.kr 08 ist leg und 10 ist shellshock. ARM-Assembler. Bash-Schwachstelle</a></li>
<li><a href="../de461271/index.html">So bewerben Sie eine mobile Anwendung im Jahr 2019: 4 praktische MÃ¶glichkeiten + nÃ¼tzliche Tools</a></li>
<li><a href="../de461273/index.html">Gieriger Ansatz und Spielautomaten. Analyse der Aufgaben der ML-Strecke der Programmiermeisterschaft</a></li>
<li><a href="../de461277/index.html">Ãœbersicht Ã¼ber das kostenlose SQLIndexManager-Tool</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>