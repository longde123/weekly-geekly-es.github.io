<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üé≥ üì∂ üèûÔ∏è Analyse des journaux Nginx √† l'aide d'Amazon Athena et Cube.js üë©üèæ‚Äçüç≥ üßòüèª üï¥Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En r√®gle g√©n√©rale, Nginx utilise des produits commerciaux ou des alternatives open source, telles que Prometheus + Grafana, pour surveiller et analyse...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Analyse des journaux Nginx √† l'aide d'Amazon Athena et Cube.js</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/447886/"><p>  En r√®gle g√©n√©rale, Nginx utilise des produits commerciaux ou des alternatives open source, telles que Prometheus + Grafana, pour surveiller et analyser les performances de Nginx.  C'est une bonne option pour la surveillance ou l'analyse en temps r√©el, mais pas trop pratique pour l'analyse historique.  Sur toute ressource populaire, la quantit√© de donn√©es des journaux nginx augmente rapidement et il est logique d'utiliser quelque chose de plus sp√©cialis√© pour analyser une grande quantit√© de donn√©es. </p><br><p> Dans cet article, je vais vous expliquer comment utiliser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Athena</a> pour analyser les journaux en utilisant Nginx comme exemple, et montrer comment compiler un tableau de bord analytique √† partir de ces donn√©es en utilisant le framework open source <a href="">cube.js.</a>  Voici l'architecture compl√®te de la solution: </p><br><p><img src="https://habrastorage.org/webt/km/xo/3i/kmxo3izommuyzgajw20t6-aolcg.png" alt="L'architecture"></p><br><p>  TL: DR; <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lien vers le tableau de bord termin√©</a> . </p><a name="habracut"></a><br><p>  Nous utilisons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Fluentd</a> pour collecter des informations, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">AWS Kinesis Data Firehose</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">AWS Glue</a> pour le traitement et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">AWS S3</a> pour le stockage.  En utilisant cet ensemble, vous pouvez stocker non seulement les journaux nginx, mais √©galement d'autres √©v√©nements, ainsi que les journaux d'autres services.  Vous pouvez remplacer certaines pi√®ces par des pi√®ces similaires pour votre pile, par exemple, vous pouvez √©crire des journaux dans kinesis directement √† partir de nginx, en contournant fluentd, ou utiliser logstash pour ce faire. </p><br><h2 id="sobiraem-logi-nginx">  Collecte des journaux Nginx </h2><br><p>  Par d√©faut, les journaux Nginx ressemblent √† ceci: </p><br><pre><code class="bash hljs">4/9/2019 12:58:17 PM1.1.1.1 - - [09/Apr/2019:09:58:17 +0000] <span class="hljs-string"><span class="hljs-string">"GET /sign-up HTTP/2.0"</span></span> 200 9168 <span class="hljs-string"><span class="hljs-string">"https://example.com/sign-in"</span></span> <span class="hljs-string"><span class="hljs-string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.86 Safari/537.36"</span></span> <span class="hljs-string"><span class="hljs-string">"-"</span></span> 4/9/2019 12:58:17 PM1.1.1.1 - - [09/Apr/2019:09:58:17 +0000] <span class="hljs-string"><span class="hljs-string">"GET /sign-in HTTP/2.0"</span></span> 200 9168 <span class="hljs-string"><span class="hljs-string">"https://example.com/sign-up"</span></span> <span class="hljs-string"><span class="hljs-string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.86 Safari/537.36"</span></span> <span class="hljs-string"><span class="hljs-string">"-"</span></span></code> </pre> <br><p>  Ils peuvent √™tre analys√©s, mais il est beaucoup plus facile de corriger la configuration Nginx afin qu'elle affiche les journaux en JSON: </p><br><pre> <code class="plaintext hljs">log_format json_combined escape=json '{ "created_at": "$msec", ' '"remote_addr": "$remote_addr", ' '"remote_user": "$remote_user", ' '"request": "$request", ' '"status": $status, ' '"bytes_sent": $bytes_sent, ' '"request_length": $request_length, ' '"request_time": $request_time, ' '"http_referrer": "$http_referer", ' '"http_x_forwarded_for": "$http_x_forwarded_for", ' '"http_user_agent": "$http_user_agent" }'; access_log /var/log/nginx/access.log json_combined;</code> </pre> <br><h3 id="s3-dlya-hraneniya">  S3 pour le stockage </h3><br><p>  Pour stocker les journaux, nous utiliserons S3.  Cela vous permet de stocker et d'analyser les journaux en un seul endroit, car Athena peut travailler directement avec les donn√©es dans S3.  Plus loin dans l'article, je vous dirai comment plier et traiter correctement les journaux, mais nous avons d'abord besoin d'un seau propre dans S3, dans lequel rien d'autre ne sera stock√©.  Il est utile de penser √† l'avance dans quelle r√©gion vous allez cr√©er le bucket, car Athena n'est pas disponible dans toutes les r√©gions. </p><br><h3 id="sozdaem-shemu-v-konsoli-athena">  Cr√©er un diagramme dans la console Athena </h3><br><p>  Cr√©ez une table dans Athena pour les journaux.  Il est n√©cessaire √† la fois pour l'√©criture et la lecture, si vous pr√©voyez d'utiliser Kinesis Firehose.  Ouvrez la console Athena et cr√©ez une table: </p><br><div class="spoiler">  <b class="spoiler_title">Cr√©ation de table SQL</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXTERNAL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`kinesis_logs_nginx`</span></span>( <span class="hljs-string"><span class="hljs-string">`created_at`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>, <span class="hljs-string"><span class="hljs-string">`remote_addr`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-string"><span class="hljs-string">`remote_user`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-string"><span class="hljs-string">`request`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-string"><span class="hljs-string">`status`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, <span class="hljs-string"><span class="hljs-string">`bytes_sent`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, <span class="hljs-string"><span class="hljs-string">`request_length`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, <span class="hljs-string"><span class="hljs-string">`request_time`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>, <span class="hljs-string"><span class="hljs-string">`http_referrer`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-string"><span class="hljs-string">`http_x_forwarded_for`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-string"><span class="hljs-string">`http_user_agent`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FORMAT</span></span> SERDE <span class="hljs-string"><span class="hljs-string">'org.apache.hadoop.hive.ql.io.orc.OrcSerde'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STORED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> INPUTFORMAT <span class="hljs-string"><span class="hljs-string">'org.apache.hadoop.hive.ql.io.orc.OrcInputFormat'</span></span> OUTPUTFORMAT <span class="hljs-string"><span class="hljs-string">'org.apache.hadoop.hive.ql.io.orc.OrcOutputFormat'</span></span> LOCATION <span class="hljs-string"><span class="hljs-string">'s3://&lt;YOUR-S3-BUCKET&gt;'</span></span> TBLPROPERTIES (<span class="hljs-string"><span class="hljs-string">'has_encrypted_data'</span></span>=<span class="hljs-string"><span class="hljs-string">'false'</span></span>);</code> </pre> </div></div><br><h3 id="sozdaem-kinesis-firehose-stream">  Cr√©er un flux Firehose Kinesis </h3><br><p>  Kinesis Firehose √©crira les donn√©es re√ßues de Nginx vers S3 dans le format s√©lectionn√©, divis√©es en r√©pertoires au format AAAA / MM / JJ / HH.  Ceci est utile lors de la lecture de donn√©es.  Vous pouvez, bien s√ªr, √©crire directement sur S3 √† partir de fluentd, mais dans ce cas, vous devez √©crire JSON, ce qui est inefficace en raison de la grande taille du fichier.  De plus, lorsque vous utilisez PrestoDB ou Athena, JSON est le format de donn√©es le plus lent.  Alors ouvrez la console Kinesis Firehose, cliquez sur "Cr√©er un flux de livraison", s√©lectionnez "PUT direct" dans le champ "livraison": </p><br><p><img src="https://habrastorage.org/webt/xe/vb/mc/xevbmcpntl3aqkgg50lh844gxe4.png" alt="Console Firehose Kinesis 1"></p><br><p>  Dans l'onglet suivant, s√©lectionnez "Conversion de format d'enregistrement" - "Activ√©" et s√©lectionnez "Apache ORC" comme format d'enregistrement.  Selon certains <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Owen O'Malley</a> , c'est le format optimal pour PrestoDB et Athena.  Sous forme de diagramme, nous indiquons le tableau que nous avons cr√©√© ci-dessus.  Veuillez noter que vous pouvez sp√©cifier n'importe quel emplacement S3 dans kinesis, seul le sch√©ma est utilis√© dans le tableau.  Mais si vous sp√©cifiez un autre emplacement S3, la lecture de ces enregistrements de cette table ne fonctionnera pas. </p><br><p><img src="https://habrastorage.org/webt/vu/y1/ro/vuy1royrwm3pb3jle5nvclzskd0.png" alt="Console Firehose Kinesis 2"></p><br><p>  Nous choisissons S3 pour le stockage et le seau que nous avons cr√©√© pr√©c√©demment.  Aws Glue Crawler, dont je parlerai un peu plus tard, ne sait pas comment travailler avec les pr√©fixes dans le compartiment S3, il est donc important de le laisser vide. </p><br><p><img src="https://habrastorage.org/webt/jq/0u/bs/jq0ubs7jvqmehbfqaaycrmxryso.png" alt="Console Firehose Kinesis 3"></p><br><p>  Les options restantes peuvent √™tre modifi√©es en fonction de votre charge, j'utilise g√©n√©ralement celles par d√©faut.  Notez que la compression S3 n'est pas disponible, mais ORC utilise la compression native par d√©faut. </p><br><h3 id="fluentd">  Fluentd </h3><br><p>  Maintenant que nous avons configur√© le stockage et la r√©ception des journaux, vous devez configurer l'envoi.  Nous utiliserons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Fluentd</a> parce que j'aime Ruby, mais vous pouvez utiliser Logstash ou envoyer des journaux directement √† kin√©sis.  Vous pouvez d√©marrer le serveur Fluentd de plusieurs mani√®res, je vais parler de docker, car il est simple et pratique. </p><br><p>  Tout d'abord, nous avons besoin du fichier de configuration fluent.conf.  Cr√©ez-le et ajoutez la source: </p><br><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">taper en</a> avant <br>  port 24224 <br>  lier 0.0.0.0 </p><br><br><p>  Vous pouvez maintenant d√©marrer le serveur Fluentd.  Si vous avez besoin d'une configuration plus avanc√©e, le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Docker Hub</a> dispose d'un guide d√©taill√©, y compris comment assembler votre image. </p><br><pre> <code class="bash hljs">$ docker run \ -d \ -p 24224:24224 \ -p 24224:24224/udp \ -v /data:/fluentd/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> \ -v &lt;PATH-TO-FLUENT-CONF&gt;:/fluentd/etc fluentd \ -c /fluentd/etc/fluent.conf fluent/fluentd:stable</code> </pre> <br><p>  Cette configuration utilise le <code>/fluentd/log</code> pour mettre en cache les journaux avant l'envoi.  Vous pouvez vous en passer, mais lorsque vous red√©marrez, vous pouvez tout perdre mis en cache par un travail excessif.  N'importe quel port peut √©galement √™tre utilis√©, 24224 est le port Fluentd par d√©faut. </p><br><p>  Maintenant que Fluentd est en cours d'ex√©cution, nous pouvons y envoyer des journaux Nginx.  Nous ex√©cutons g√©n√©ralement Nginx dans un conteneur Docker, auquel cas Docker a un pilote de journal natif pour Fluentd: </p><br><pre> <code class="bash hljs">$ docker run \ --<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-driver=fluentd \ --<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-opt fluentd-address=&lt;FLUENTD-SERVER-ADDRESS&gt;\ --<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-opt tag=\<span class="hljs-string"><span class="hljs-string">"{{.Name}}\" \ -v /some/content:/usr/share/nginx/html:ro \ -d \ nginx</span></span></code> </pre> <br><p>  Si vous ex√©cutez Nginx diff√©remment, vous pouvez utiliser les fichiers journaux, Fluentd a un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plugin file tail</a> . </p><br><p>  Ajoutez l'analyse de journal configur√©e ci-dessus √† la configuration Fluent: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">YOUR-NGINX-TAG.</span></span></span><span class="hljs-tag">*&gt;</span></span> @type parser key_name log emit_invalid_record_to_error false <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">parse</span></span></span><span class="hljs-tag">&gt;</span></span> @type json <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">parse</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Et l'envoi de journaux √† Kinesis √† l'aide du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plugin firehose kinesis</a> : </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">match</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">YOUR-NGINX-TAG.</span></span></span><span class="hljs-tag">*&gt;</span></span> @type kinesis_firehose region region delivery_stream_name <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">YOUR-KINESIS-STREAM-NAME</span></span></span><span class="hljs-tag">&gt;</span></span> aws_key_id <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">YOUR-AWS-KEY-ID</span></span></span><span class="hljs-tag">&gt;</span></span> aws_sec_key <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">YOUR_AWS-SEC_KEY</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">match</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><h2 id="athena">  Ath√©na </h2><br><p>  Si vous avez tout configur√© correctement, apr√®s un certain temps (par d√©faut, Kinesis √©crit les donn√©es re√ßues toutes les 10 minutes), vous devriez voir les fichiers journaux dans S3.  Dans le menu "Surveillance" de Kinesis Firehose, vous pouvez voir la quantit√© de donn√©es √©crites sur S3, ainsi que les erreurs.  N'oubliez pas de donner un acc√®s en √©criture au compartiment S3 pour le r√¥le Kinesis.  Si Kinesis n'a pas pu analyser quelque chose, il ajoutera des erreurs dans le m√™me compartiment. </p><br><p>  Vous pouvez maintenant voir les donn√©es dans Athena.  Trouvons quelques nouvelles requ√™tes auxquelles nous avons donn√© des erreurs: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">"db_name"</span></span>.<span class="hljs-string"><span class="hljs-string">"table_name"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> &gt; <span class="hljs-number"><span class="hljs-number">499</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> created_at <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>;</code> </pre> <br><h3 id="skanirovanie-vseh-zapisey-na-kazhdyy-zapros">  Analyser tous les enregistrements pour chaque demande </h3><br><p>  Maintenant, nos journaux sont trait√©s et empil√©s dans S3 en ORC, compress√©s et pr√™ts √† √™tre analys√©s.  Kinesis Firehose les a m√™me plac√©s dans des r√©pertoires toutes les heures.  Cependant, bien que la table ne soit pas partitionn√©e, Athena chargera des donn√©es absolues pour chaque requ√™te, √† de rares exceptions pr√®s.  C'est un gros probl√®me pour deux raisons: </p><br><ul><li>  La quantit√© de donn√©es augmente constamment, ce qui ralentit les requ√™tes; </li><li>  Athena est factur√©e en fonction de la quantit√© de donn√©es analys√©es, avec un minimum de 10 Mo pour chaque demande. </li></ul><br><p>  Pour r√©soudre ce probl√®me, nous utilisons AWS Glue Crawler, qui analysera les donn√©es dans S3 et enregistrera les informations de partition dans Glue Metastore.  Cela nous permettra d'utiliser des partitions comme filtre pour les demandes dans Athena, et il analysera uniquement les r√©pertoires sp√©cifi√©s dans la demande. </p><br><h3 id="nastraivaem-amazon-glue-crawler">  Personnaliser Amazon Glue Crawler </h3><br><p>  Amazon Glue Crawler analyse toutes les donn√©es du compartiment S3 et cr√©e des tables de partition.  Cr√©ez un robot Glue √† partir de la console AWS Glue et ajoutez le compartiment dans lequel vous stockez les donn√©es.  Vous pouvez utiliser un robot pour plusieurs compartiments, dans ce cas, il cr√©era des tables dans la base de donn√©es sp√©cifi√©e avec des noms qui correspondent aux noms des compartiments.  Si vous pr√©voyez d'utiliser ces donn√©es tout le temps, assurez-vous d'ajuster le calendrier de lancement du robot en fonction de vos besoins.  Nous utilisons un robot pour toutes les tables, qui s'ex√©cute toutes les heures. </p><br><h3 id="particirovannye-tablicy">  Tables partitionn√©es </h3><br><p>  Apr√®s le premier d√©marrage du robot, les tables de chaque compartiment analys√© doivent appara√Ætre dans la base de donn√©es sp√©cifi√©e dans les param√®tres.  Ouvrez la console Athena et trouvez la table avec les journaux Nginx.  Essayons de lire quelque chose: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">"default"</span></span>.<span class="hljs-string"><span class="hljs-string">"part_demo_kinesis_bucket"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span>( partition_0 = <span class="hljs-string"><span class="hljs-string">'2019'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> partition_1 = <span class="hljs-string"><span class="hljs-string">'04'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> partition_2 = <span class="hljs-string"><span class="hljs-string">'08'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> partition_3 = <span class="hljs-string"><span class="hljs-string">'06'</span></span> );</code> </pre> <br><p>  Cette requ√™te s√©lectionnera tous les enregistrements re√ßus de 6 h √† 7 h le 8 avril 2019.  Mais combien plus efficace que la simple lecture d'une table non partitionn√©e?  D√©couvrons et s√©lectionnons les m√™mes enregistrements en les filtrant par horodatage: </p><br><p><img src="https://habrastorage.org/webt/mu/bg/me/mubgmef262bxyte5dsqsa1q_hag.png" alt="Demande sans partitions"></p><br><p>  3,59 secondes et 244,34 m√©gaoctets de donn√©es sur l'ensemble de donn√©es, dans lequel il n'y a qu'une semaine de journaux.  Essayons le filtre par partitions: </p><br><p><img src="https://habrastorage.org/webt/9-/n4/dc/9-n4dczjdvcrspm0zbypq-ul5cs.png" alt="Demande de filtre de partition"></p><br><p>  Un peu plus vite, mais surtout - seulement 1,23 m√©gaoctets de donn√©es!  Ce serait beaucoup moins cher sans le minimum de 10 m√©gaoctets par demande de prix.  Mais c'est bien mieux de toute fa√ßon, et sur de grands ensembles de donn√©es, la diff√©rence sera beaucoup plus impressionnante. </p><br><h2 id="sobiraem-deshbord-s-pomoschyu-cubejs">  Cr√©ez un tableau de bord √† l'aide de Cube.js </h2><br><p>  Pour cr√©er un tableau de bord, nous utilisons le cadre analytique Cube.js.  Il a plusieurs fonctions, mais nous nous int√©ressons √† deux: la possibilit√© d'utiliser automatiquement des filtres sur les partitions et la pr√©-agr√©gation des donn√©es.  Il utilise un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sch√©ma de donn√©es</a> √©crit en Javascript pour g√©n√©rer du SQL et ex√©cuter une requ√™te de base de donn√©es.  Il nous suffit d'indiquer comment utiliser le filtre de partition dans le sch√©ma de donn√©es. </p><br><p>  Cr√©ons une nouvelle application Cube.js.  Comme nous utilisons d√©j√† AWS-stack, il est logique d'utiliser Lambda pour le d√©ploiement.  Vous pouvez utiliser le mod√®le express pour la g√©n√©ration si vous pr√©voyez d'h√©berger le backend Cube.js dans Heroku ou Docker.  La documentation d√©crit d'autres <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">m√©thodes d'h√©bergement</a> . </p><br><pre> <code class="bash hljs">$ npm install -g cubejs-cli $ cubejs create nginx-log-analytics -t serverless -d athena</code> </pre> <br><p>  Les variables d'environnement sont utilis√©es pour configurer l'acc√®s √† la base de donn√©es dans cube.js.  Le g√©n√©rateur cr√©era un fichier .env dans lequel vous pourrez sp√©cifier vos cl√©s pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Athena</a> . </p><br><p>  Nous avons maintenant besoin d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un sch√©ma de donn√©es</a> dans lequel nous indiquons comment nos journaux sont stock√©s.  Vous pouvez y sp√©cifier comment lire les m√©triques des tableaux de bord. </p><br><p>  Dans le r√©pertoire du <code>schema</code> , cr√©ez le fichier <code>Logs.js</code>  Voici un exemple de mod√®le de donn√©es pour nginx: </p><br><div class="spoiler">  <b class="spoiler_title">Code mod√®le</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> partitionFilter = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">from</span></span></span></span><span class="hljs-function"><span class="hljs-params">, to</span></span></span><span class="hljs-function">) =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">` date(from_iso8601_timestamp(</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">from</span></span></span></span><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class="hljs-string">)) &lt;= date_parse(partition_0 || partition_1 || partition_2, '%Y%m%d') AND date(from_iso8601_timestamp(</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${to}</span></span></span><span class="hljs-string">)) &gt;= date_parse(partition_0 || partition_1 || partition_2, '%Y%m%d') `</span></span> cube(<span class="hljs-string"><span class="hljs-string">`Logs`</span></span>, { <span class="hljs-attr"><span class="hljs-attr">sql</span></span>: <span class="hljs-string"><span class="hljs-string">` select * from part_demo_kinesis_bucket WHERE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${FILTER_PARAMS.Logs.createdAt.filter(partitionFilter)}</span></span></span><span class="hljs-string"> `</span></span>, <span class="hljs-attr"><span class="hljs-attr">measures</span></span>: { <span class="hljs-attr"><span class="hljs-attr">count</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">`count`</span></span>, }, <span class="hljs-attr"><span class="hljs-attr">errorCount</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">`count`</span></span>, <span class="hljs-attr"><span class="hljs-attr">filters</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">sql</span></span>: <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${CUBE.isError}</span></span></span><span class="hljs-string"> = 'Yes'`</span></span> } ] }, <span class="hljs-attr"><span class="hljs-attr">errorRate</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">`number`</span></span>, <span class="hljs-attr"><span class="hljs-attr">sql</span></span>: <span class="hljs-string"><span class="hljs-string">`100.0 * </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${errorCount}</span></span></span><span class="hljs-string"> / </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${count}</span></span></span><span class="hljs-string">`</span></span>, <span class="hljs-attr"><span class="hljs-attr">format</span></span>: <span class="hljs-string"><span class="hljs-string">`percent`</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">dimensions</span></span>: { <span class="hljs-attr"><span class="hljs-attr">status</span></span>: { <span class="hljs-attr"><span class="hljs-attr">sql</span></span>: <span class="hljs-string"><span class="hljs-string">`status`</span></span>, <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">`number`</span></span> }, <span class="hljs-attr"><span class="hljs-attr">isError</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">`string`</span></span>, <span class="hljs-attr"><span class="hljs-attr">case</span></span>: { <span class="hljs-attr"><span class="hljs-attr">when</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">sql</span></span>: <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${CUBE}</span></span></span><span class="hljs-string">.status &gt;= 400`</span></span>, <span class="hljs-attr"><span class="hljs-attr">label</span></span>: <span class="hljs-string"><span class="hljs-string">`Yes`</span></span> }], <span class="hljs-attr"><span class="hljs-attr">else</span></span>: { <span class="hljs-attr"><span class="hljs-attr">label</span></span>: <span class="hljs-string"><span class="hljs-string">`No`</span></span> } } }, <span class="hljs-attr"><span class="hljs-attr">createdAt</span></span>: { <span class="hljs-attr"><span class="hljs-attr">sql</span></span>: <span class="hljs-string"><span class="hljs-string">`from_unixtime(created_at)`</span></span>, <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">`time`</span></span> } } });</code> </pre> </div></div><br><p>  Ici, nous utilisons la variable <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">FILTER_PARAMS</a> pour g√©n√©rer une requ√™te SQL avec un filtre de partition. </p><br><p>  Nous sp√©cifions √©galement les m√©triques et les param√®tres que nous voulons afficher sur le tableau de bord et sp√©cifions les pr√©-agr√©gations.  Cube.js cr√©era des tables suppl√©mentaires avec des donn√©es pr√©-agr√©g√©es et mettra automatiquement √† jour les donn√©es d√®s qu'elles seront disponibles.  Cela acc√©l√®re non seulement les demandes, mais r√©duit √©galement le co√ªt d'utilisation d'Athena. </p><br><p>  Ajoutez ces informations au fichier de sch√©ma de donn√©es: </p><br><pre> <code class="javascript hljs">preAggregations: { <span class="hljs-attr"><span class="hljs-attr">main</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">`rollup`</span></span>, <span class="hljs-attr"><span class="hljs-attr">measureReferences</span></span>: [count, errorCount], <span class="hljs-attr"><span class="hljs-attr">dimensionReferences</span></span>: [isError, status], <span class="hljs-attr"><span class="hljs-attr">timeDimensionReference</span></span>: createdAt, <span class="hljs-attr"><span class="hljs-attr">granularity</span></span>: <span class="hljs-string"><span class="hljs-string">`day`</span></span>, <span class="hljs-attr"><span class="hljs-attr">partitionGranularity</span></span>: <span class="hljs-string"><span class="hljs-string">`month`</span></span>, <span class="hljs-attr"><span class="hljs-attr">refreshKey</span></span>: { <span class="hljs-attr"><span class="hljs-attr">sql</span></span>: FILTER_PARAMS.Logs.createdAt.filter(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">from</span></span></span></span><span class="hljs-function"><span class="hljs-params">, to</span></span></span><span class="hljs-function">) =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">`select CASE WHEN from_iso8601_timestamp(</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${to}</span></span></span><span class="hljs-string">) + interval '3' day &gt; now() THEN date_trunc('hour', now()) END`</span></span> ) } } }</code> </pre> <br><p>  Dans ce mod√®le, nous indiquons qu'il est n√©cessaire de pr√©-agr√©ger les donn√©es pour toutes les m√©triques utilis√©es et d'utiliser un partitionnement mensuel.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le partitionnement des pr√©-agr√©gations</a> peut acc√©l√©rer consid√©rablement la collecte et la mise √† jour des donn√©es. </p><br><p>  Nous pouvons maintenant cr√©er un tableau de bord! </p><br><p>  Le backend Cube.js fournit une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">API REST</a> et un ensemble de biblioth√®ques client pour les frameworks frontaux populaires.  Nous utiliserons la version React du client pour construire le tableau de bord.  Cube.js ne fournit que des donn√©es, nous avons donc besoin d'une biblioth√®que de visualisations - j'aime les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">recharges</a> , mais vous pouvez en utiliser n'importe quelle. </p><br><p>  Le serveur Cube.js accepte la demande au <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">format JSON</a> , qui indique les mesures n√©cessaires.  Par exemple, pour calculer le nombre d'erreurs Nginx par jour, vous devez envoyer la demande suivante: </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"measures"</span></span>: [<span class="hljs-string"><span class="hljs-string">"Logs.errorCount"</span></span>], <span class="hljs-attr"><span class="hljs-attr">"timeDimensions"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"dimension"</span></span>: <span class="hljs-string"><span class="hljs-string">"Logs.createdAt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dateRange"</span></span>: [<span class="hljs-string"><span class="hljs-string">"2019-01-01"</span></span>, <span class="hljs-string"><span class="hljs-string">"2019-01-07"</span></span>], <span class="hljs-attr"><span class="hljs-attr">"granularity"</span></span>: <span class="hljs-string"><span class="hljs-string">"day"</span></span> } ] }</code> </pre> <br><p>  Installez le client Cube.js et la biblioth√®que de composants React via NPM: </p><br><pre> <code class="bash hljs">$ npm i --save @cubejs-client/core @cubejs-client/react</code> </pre> <br><p>  Nous importons des composants <code>cubejs</code> et QueryRenderer pour d√©charger les donn√©es et collecter le tableau de bord: </p><br><div class="spoiler">  <b class="spoiler_title">Code du tableau de bord</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { LineChart, Line, XAxis, YAxis } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'recharts'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cubejs <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@cubejs-client/core'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { QueryRenderer } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@cubejs-client/react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> cubejsApi = cubejs( <span class="hljs-string"><span class="hljs-string">'YOUR-CUBEJS-API-TOKEN'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">apiUrl</span></span>: <span class="hljs-string"><span class="hljs-string">'http://localhost:4000/cubejs-api/v1'</span></span> }, ); <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> &lt;QueryRenderer query={{ measures: [</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'Logs.errorCount'</span></span></span></span><span class="hljs-function"><span class="hljs-params">], timeDimensions: [{ dimension: </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'Logs.createdAt'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, dateRange: [</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'2019-01-01'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'2019-01-07'</span></span></span></span><span class="hljs-function"><span class="hljs-params">], granularity: </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'day'</span></span></span></span><span class="hljs-function"><span class="hljs-params"> }] }} cubejsApi={cubejsApi} render={({ resultSet }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!resultSet) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'Loading...'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ( &lt;LineChart data={resultSet.rawData()}&gt; &lt;XAxis dataKey="Logs.createdAt"/&gt; &lt;YAxis/&gt; &lt;Line type="monotone" dataKey="Logs.errorCount" stroke="#8884d8"/&gt; &lt;/LineChart&gt; ); }} /&gt; ) }</code> </pre> </div></div><br><p>  Les sources du tableau de bord sont disponibles sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CodeSandbox</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr447886/">https://habr.com/ru/post/fr447886/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr447876/index.html">Tout est tr√®s mauvais ou un nouveau type d'interception du trafic</a></li>
<li><a href="../fr447878/index.html">V√©rification de rdesktop et xrdp avec PVS-Studio</a></li>
<li><a href="../fr447880/index.html">Validation de rdesktop et xrdp √† l'aide de l'analyseur PVS-Studio</a></li>
<li><a href="../fr447882/index.html">Outils r√©seau, ou par o√π commencer le pentester?</a></li>
<li><a href="../fr447884/index.html">Nous d√©couvrons comment la 5G fonctionnera au millim√®tre pr√®s dans la rue et √† l'int√©rieur</a></li>
<li><a href="../fr447890/index.html">Dieu merci, je ne suis pas manager</a></li>
<li><a href="../fr447892/index.html">Deux nouveaux concours PHDays: contournement IDS et piratage d'usine</a></li>
<li><a href="../fr447894/index.html">MODX Digest # 3 (25 mars - 8 avril 2019)</a></li>
<li><a href="../fr447896/index.html">Images d'esquisses: exactement comment fonctionne le r√©seau neuronal NVIDIA GAUGAN</a></li>
<li><a href="../fr447898/index.html">Des philosophes bien nourris ou une programmation .NET comp√©titive</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>