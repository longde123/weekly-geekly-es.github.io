<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üññüèø üë®‚Äçüë©‚Äçüëß üö∂üèæ Sin servidor y React 2: juego de manos y sin fraude üë®üèæ‚Äçüç≥ üòë ‚úäüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¬øPuedo decirles a los desarrolladores front-end sobre la arquitectura sin servidor sin nube dentro de AWS (Amazon Web Services) de una manera simple? ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sin servidor y React 2: juego de manos y sin fraude</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/417943/"> ¬øPuedo decirles a los desarrolladores front-end sobre la arquitectura sin servidor sin nube dentro de AWS (Amazon Web Services) de una manera simple?  Por qu√© no  Presentemos la aplicaci√≥n AWS React / Redux y luego hablemos sobre los pros y los contras de las lambdas de AWS. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/wJcXVjemrEY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <i>El material se basa en la transcripci√≥n del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">informe</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Marina</a> Mironovich de nuestra conferencia de primavera HolyJS 2018 en San Petersburgo.</i> <br><a name="habracut"></a><br>  Oficialmente, Marina es un desarrollador l√≠der de EPAM.  Ahora trabaja en un grupo de arquitectos de soluciones para un cliente y por eso participa en una gran cantidad de proyectos.  Por lo tanto, ser√° m√°s f√°cil para nosotros esbozar el c√≠rculo de sus intereses actuales que enumerar todas las tecnolog√≠as con las que trabaja. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0e6/caf/b0d/0e6cafb0de05d040b8b7bc30ab969b34.jpg" align="left">  <i>En primer lugar, estoy interesado en todas las tecnolog√≠as en la nube, en particular, AWS, porque trabajo mucho con esto en producci√≥n.</i>  <i>Pero trato de mantenerme al d√≠a con todo lo dem√°s.</i> <i><br><br></i>  <i>Frontend es mi primer amor y parece para siempre.</i>  <i>En particular, actualmente estoy trabajando con React y React Native, as√≠ que s√© un poco m√°s al respecto.</i>  <i>Tambi√©n trato de hacer un seguimiento de todo lo dem√°s.</i>  <i>Estoy interesado en todo lo relacionado con la documentaci√≥n del proyecto, por ejemplo, diagramas UML.</i>  <i>Como soy miembro del grupo de arquitectos de soluciones, tengo que hacer mucho.</i> <i><br><br></i> <br><br><h2>  Parte 1. Antecedentes </h2><br>  La idea de hablar sobre Serverless se me ocurri√≥ hace aproximadamente un a√±o.  Quer√≠a hablar sobre Serverless para desarrolladores front-end de manera f√°cil y natural.  Para que no necesite ning√∫n conocimiento adicional para usarlo, las tecnolog√≠as ahora le permiten hacerlo. <br><br>  Hasta cierto punto, la idea se realiz√≥: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">habl√© de Serverless</a> en FrontTalks 2017. Pero result√≥ que 45 minutos no son suficientes para una historia simple y comprensible.  Por lo tanto, el informe se dividi√≥ en dos partes, y ahora ante ustedes est√° la segunda "serie".  Qui√©n no vio lo primero: no se preocupe, esto no le har√° da√±o a entender lo que est√° escrito a continuaci√≥n.  Como en los programas de TV decentes, comenzar√© con un resumen de la parte anterior.  Luego pasar√© al jugo en s√≠ mismo: presentaremos la aplicaci√≥n React / Redux.  Y finalmente, hablar√© sobre los pros y los contras de las funciones de la nube en principio (en particular, AWS lambdas) y qu√© m√°s se puede hacer con ellas.  Espero que esta parte sea √∫til para todos aquellos que ya est√°n familiarizados con la AWS lambda.  Lo m√°s importante es que el mundo no termina con Amazon, as√≠ que hablemos sobre qu√© m√°s hay en el campo de las funciones en la nube. <br><br><h3>  Lo que usar√© </h3><br>  Para representar la aplicaci√≥n, utilizar√© muchos servicios de Amazon: <br><br><ol><li>  S3 es un sistema de archivos en las nubes.  All√≠ almacenaremos activos est√°ticos. <br></li><li>  IAM (derechos de acceso para usuarios y servicios): impl√≠citamente, pero se utilizar√° en segundo plano para que los servicios se comuniquen entre s√≠. <br></li><li>  API Gateway (URL para acceder al sitio): ver√° la URL donde podemos llamar a nuestra lambda. <br></li><li>  CloudFormation (para implementaci√≥n): se utilizar√° impl√≠citamente en segundo plano. <br></li><li>  AWS Lambda: vinimos aqu√≠ para esto. <br></li></ol><br><h3>  ¬øQu√© es sin servidor y qu√© es AWS Lambda? </h3><br>  En realidad, Serverless es un gran fraude, porque por supuesto hay servidores: en alg√∫n lugar, todo comienza.  ¬øPero qu√© est√° pasando all√≠? <br><br>  Estamos escribiendo una funci√≥n, y esta funci√≥n se ejecuta en los servidores.  Por supuesto, comienza no solo as√≠, sino en alg√∫n tipo de contenedor.  Y, de hecho, esta funci√≥n en el contenedor del servidor se llama lambda. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6ad/2c6/ff1/6ad2c6ff181236d39a29121e8b607a96.png"></div><br>  En el caso de lambda, podemos olvidarnos de los servidores.  Incluso dir√≠a esto: cuando escribes la funci√≥n lambda, es da√±ino pensar en ellas.  No trabajamos con lambda como lo hacemos con un servidor. <br><br><h3>  C√≥mo implementar lambda </h3><br>  Surge una pregunta l√≥gica: si no tenemos un servidor, ¬øc√≥mo lo implementamos?  Hay SSH en el servidor, subimos el c√≥digo, lo lanzamos, todo est√° bien.  ¬øQu√© hacer con lambda? <br><br>  <b>Opci√≥n 1. No podemos implementarlo.</b> <br><br>  AWS en la consola hizo un IDE agradable y gentil para nosotros, donde podemos venir y escribir una funci√≥n all√≠ mismo. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/08e/1cd/f73/08e1cdf73c5d5fec2c6315e0207e51ed.png"><br><br>  Es agradable, pero no muy extensible. <br><br>  <b>Opci√≥n 2. Podemos hacer un zip y descargarlo desde la l√≠nea de comando</b> <br><br>  ¬øC√≥mo hacemos un archivo zip? <br><br> <code>zip -r build/lambda.zip index.js [node_modules/] [package.json] <br></code> <br>  Si usa node_modules, todo esto se comprime en un archivo. <br>  Adem√°s, dependiendo de si est√° creando una nueva funci√≥n o si ya la tiene, puede <br><br> <code>aws lambda create-function... <br></code> <br>  cualquiera <br><br> <code>aws lambda update-function-code... <br></code> <br>  Cual es el problema  Primero, la AWS CLI quiere saber si se est√° creando una funci√≥n o si ya tiene una.  Estos son dos equipos diferentes.  Si desea actualizar no solo el c√≥digo, sino tambi√©n algunos atributos de esta funci√≥n, comienzan los problemas.  El n√∫mero de estos comandos est√° creciendo, y debe sentarse con un directorio y pensar qu√© comando usar. <br><br>  Podemos hacerlo mejor y m√°s f√°cil.  Para esto, tenemos marcos. <br><br><h3>  Marcos de trabajo de AWS Lambda </h3><br>  Hay muchos de esos marcos.  Esto es principalmente AWS CloudFormation, que funciona en conjunto con la AWS CLI.  CloudFormation es un archivo Json que describe sus servicios.  Los describe en un archivo Json, luego a trav√©s de la CLI de AWS dice "ejecutar", y autom√°ticamente crear√° todo para usted en el servicio de AWS. <br><br>  Pero a√∫n es dif√≠cil para una tarea tan simple como renderizar algo.  Aqu√≠ el umbral de entrada es demasiado grande: debe leer qu√© estructura tiene CloudFormation, etc. <br><br>  Tratemos de simplificarlo.  Y aqu√≠ aparecen varios marcos: APEX, Zappa (solo para Python), Claudia.js.  Enumer√© solo unos pocos, al azar. <br><br>  El problema y la fortaleza de estos marcos es que son altamente especializados.  Por lo tanto, son muy buenos para hacer una tarea simple.  Por ejemplo, Claudia.js es muy bueno para crear una API REST.  Ella har√° que AWS llame a API Gateway, crear√° una lambda para usted, todo estar√° bellamente bloqueado.  Pero si necesita desplegar un poco m√°s, comienzan los problemas: tiene que agregar algo, ayuda, mirar, etc. <br><br>  Zappa fue escrito solo para Python.  Y quiero algo m√°s ambicioso.  Y aqu√≠ viene Terraform y mi amor sin servidor. <br><br>  Sin servidor se encuentra en un punto intermedio entre la gran CloudFormation, que puede hacer casi todo, y estos marcos altamente especializados.  Casi todo se puede implementar en √©l, pero hacerlo todo sigue siendo bastante f√°cil.  Tambi√©n tiene una sintaxis muy ligera. <br><br>  Terraform es, en cierta medida, un an√°logo de CloudFormation.  Terraform es de c√≥digo abierto, en √©l puedes implementar todo, bueno, o casi todo.  Y cuando AWS crea los servicios, puede agregar algo nuevo all√≠.  Pero es grande y complicado. <br><br>  Para ser honesto, en producci√≥n usamos Terraform, porque con Terraform todo lo que tenemos sube m√°s f√°cilmente: Serverless no describir√° todo esto.  Pero Terraform es muy complejo.  Y cuando escribo algo para el trabajo, primero lo escribo en Serverless, lo pruebo para el rendimiento, y solo despu√©s de probar y resolver mi configuraci√≥n, lo reescribo en Terraform (esto es "divertido" por un par de d√≠as m√°s). <br><br><h3>  Sin servidor </h3><br>  ¬øPor qu√© amo Serverless? <br><br><ol><li>  Sin servidor tiene un sistema que le permite crear complementos.  En mi opini√≥n, esta es una salvaci√≥n de todo.  Sin servidor: c√≥digo abierto.  Pero agregar algo al c√≥digo abierto no siempre es f√°cil.  Debe comprender lo que est√° sucediendo en el c√≥digo existente, observar las pautas, al menos el estilo de c√≥digo, enviar un RP, se olvidar√°n de este RP y acumular√° polvo durante tres a√±os.  De acuerdo con los resultados, se bifurca, y esto ser√° un lugar para usted por separado.  Todo esto no es muy saludable.  Pero cuando hay complementos, todo se simplifica.  Necesita agregar algo: est√° de rodillas creando su propio peque√±o complemento.  Para hacer esto, ya no necesita comprender lo que est√° sucediendo dentro de Serverless (si esta no es una pregunta s√∫per personalizada).  Simplemente use la API disponible, guarde el complemento o implem√©ntelo para todos.  Y todo te funciona.  Adem√°s, ya hay un gran zool√≥gico de complementos y personas que escriben estos complementos.  Es decir, tal vez ya se haya decidido algo por usted. <br></li><li>  Sin servidor ayuda a ejecutar lambda localmente.  La desventaja lo suficientemente grande del lambda es que AWS no pens√≥ en c√≥mo lo depuraremos y probaremos.  Pero Serverless le permite ejecutar todo localmente, ver qu√© sucede (incluso lo hace junto con la API de Gateway). <br></li></ol><br><h3>  Demostraci√≥n </h3><br>  Ahora mostrar√© c√≥mo funciona todo esto realmente.  Durante los pr√≥ximos uno y medio o dos minutos, podremos crear un servicio que representar√° nuestra p√°gina HTML. <br>  Primero, en una nueva carpeta, ejecuto SLS Create template: <br><br> <code><br> mkdir sls-holyjs <br> cd sls-holyjs <br> sls create --template aws-nodejs-ecma-script <br></code> <br><img src="https://habrastorage.org/getpro/habr/post_images/4d2/620/2e5/4d26202e5337684014e9f43fb25771d3.png"><br><br> <code>npm install <br></code> <br><img src="https://habrastorage.org/getpro/habr/post_images/bee/67c/81f/bee67c81fbb0b19e21432a73b69751dc.png"><br><br>  Los desarrolladores sin servidor se encargaron de nosotros: hicieron posible crear servicios a partir de plantillas.  En este caso, uso la plantilla <code>nodejs-ecma-script</code> , que crear√° algunos archivos para m√≠, como la configuraci√≥n del paquete web, package.json, algunas funciones y serverless.yml: <br><br> <code>ls <br></code> <br><img src="https://habrastorage.org/getpro/habr/post_images/35b/6c6/86a/35b6c686a1fbe3e323ddb939147d1b3d.png"><br><br>  No necesito todas las funciones.  Eliminar√© el primer, segundo cambio de nombre en holyjs: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/030/599/ae0/030599ae094881637ae09ee3daf33ffd.png"><br><br>  Ajustar√© un poco serveless.yml, donde tengo una descripci√≥n de todos los servicios necesarios: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/85d/0ba/f9b/85d0baf9bad8e2918866f5a97c096017.png"><br><br>  Bueno, entonces arreglar√© la respuesta que devuelve la funci√≥n: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e13/07a/d85/e1307ad8550ea44532f79e6db27d561c.png"><br><br>  Har√© el HTML "Hola HolyJS" y agregar√© el identificador para la representaci√≥n. <br><br>  Siguiente: <br><br> <code>sls deploy <br></code> <br>  Y voila!  Hay una URL donde puedo ver en acceso p√∫blico lo que se est√° representando: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/228/4f3/b94/2284f3b9487a8d70a9244652d99874ff.png"><br><br>  Conf√≠a, pero verifica.  Ir√© a la consola de AWS y verificar√© que he creado una funci√≥n holyjs: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e62/458/e98/e62458e98369c7022c280c419f79be55.png"><br><br>  Como puede ver, antes de implementarlo, Serverless lo compilar√° utilizando webpack.  Adem√°s, se crear√° el resto de la infraestructura que se describe all√≠: API Gateway, etc. <br><br>  Cuando quiero eliminar esto: <br><br> <code>sls remove <br></code> <br>  Toda la infraestructura que se describe en serverless.yml se eliminar√°. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ad7/8fb/f2d/ad78fbf2d65cbcaef9094673bcca4026.png"><br><br>  Si alguien est√° detr√°s del proceso descrito aqu√≠, lo invito a que simplemente revise mi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">informe anterior</a> . <br><br><h3>  Ejecute lambda localmente </h3><br>  Mencion√© que lambda se puede ejecutar localmente.  Hay dos opciones de lanzamiento aqu√≠. <br><br>  <b>Opci√≥n 1. Simplemente ejecutamos todo en la terminal</b> <br><br>  Obtenemos lo que devuelve nuestra funci√≥n. <br><br> <code><br> sls invoke local -f [fn_name] <br></code> <br>  <b>Opci√≥n 2. Inicie lambda localmente sin servidor-fuera de l√≠nea</b> <br><br>  No lo olviden, estamos haciendo una aplicaci√≥n isomorfa, ser√° HTML y CSS, por lo que en la terminal de alguna manera no es muy interesante mirar largas l√≠neas HTML.  All√≠ puede verificar que la funci√≥n funciona.  Pero me gustar√≠a ejecutar y renderizar esto en el navegador.  En consecuencia, necesito un mont√≥n de puerta de enlace API con lambda. <br><br>  Para hacer esto, hay un complemento separado sin servidor sin conexi√≥n que iniciar√° su lambda en alg√∫n puerto (esto est√° escrito), luego mostrar√° una URL en el terminal donde puede acceder. <br><br> <code>sls offline --port 8000 start <br></code> <br>  La mejor parte es que hay una recarga en caliente.  Es decir, usted escribe el c√≥digo de la funci√≥n, actualiza su navegador y se actualiza lo que devuelve la funci√≥n.  No tiene que reiniciar todo. <br><br>  Este fue un resumen de la primera parte del informe.  Ahora pasamos a la parte principal. <br><br><h2>  Parte 2. Renderizado con AWS </h2><br>  El proyecto descrito a continuaci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ya</a> est√° en GitHub.  Si est√° interesado, puede descargar el c√≥digo all√≠. <br><br>  Comencemos con c√≥mo funciona todo. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f03/f9d/a97/f03f9da976ac1723c15aad19dd631689.png"><br><br>  Supongamos que hay un usuario: yo. <br><br><ul><li>  Abro el sitio. <br></li><li>  En una determinada URL, accedemos a la API de la puerta de enlace.  Quiero se√±alar que la API de Gateway ya es un servicio de AWS, ya estamos en las nubes. <br></li><li>  Gateway API llamar√° a lambda. <br></li><li>  La lambda representar√° el sitio y todo esto volver√° al navegador. <br></li><li>  El navegador comenzar√° a renderizarse y se dar√° cuenta de que faltan algunos archivos est√°ticos.  Luego, recurrir√° al dep√≥sito S3 (nuestro sistema de archivos, donde almacenaremos todas las estad√≠sticas; en el dep√≥sito S3 puede poner todo: fuentes, im√°genes, CSS, JS). <br></li><li>  Los datos del dep√≥sito S3 volver√°n al navegador. <br></li><li>  El navegador mostrar√° la p√°gina. <br></li><li>  Todos son felices <br></li></ul><br>  Hagamos una peque√±a revisi√≥n de c√≥digo de lo que escrib√≠. <br><br>  Si va a GitHub, ver√° la siguiente estructura de archivos: <br><br> <code><b>lambda-react</b> <br> README.md <br> <b>config <br> package.json</b> <br> public <br> scripts <br> <b>serverless.yml <br> src</b> <br> yarn.lock <br></code> <br>  Todo esto se genera autom√°ticamente en el kit de herramientas React / Redux.  De hecho, aqu√≠ nos interesar√°n solo un par de archivos y deber√°n corregirse ligeramente: <br><br><ul><li>  config <br></li><li>  package.json <br></li><li>  serverless.yml: porque implementaremos, <br></li><li>  src: en ninguna parte sin ella. <br></li></ul><br><h3>  Comencemos con la configuraci√≥n </h3><br>  Para reunir todo en el servidor, necesitamos agregar otro webpack.config: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6c0/990/786/6c099078652d80adcdcb70518187644f.png"><br><br>  Este webpack.config ya se generar√° si utiliza la plantilla.  Y all√≠ la variable <code>slsw.lib.entries</code> se sustituye autom√°ticamente, lo que apuntar√° a sus controladores lambda.  Si lo desea, puede cambiarlo usted mismo especificando algo m√°s. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/535/90e/c6a/53590ec6ae4247d42bab7deca58a0b62.png"><br><br>  Necesitaremos renderizar todo para el nodo ( <code>target: 'node'</code> ).  En principio, todos los dem√°s cargadores siguen siendo los mismos que para una aplicaci√≥n React normal. <br><br><h3>  Adem√°s de package.json </h3><br>  Solo agregaremos un par de scripts: el inicio y la compilaci√≥n ya se han generado con React / Redux, nada cambia.  Agregue un script para iniciar el lambda y un script para implementar el lambda. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4e2/822/8c4/4e28228c43ebd1548ff77f0f2d3421a2.png"><br><br><h3>  serverless.yml </h3><br>  Un archivo muy peque√±o: solo 17 l√≠neas, todas a continuaci√≥n: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0c5/404/6fa/0c54046fa5a2461532d6f7638aaf650b.png"><br><br>  ¬øQu√© nos interesa en √©l?  En primer lugar, manejador.  <code>src/lambda/handler</code> se <code>src/lambda/handler</code> la ruta completa al archivo ( <code>src/lambda/handler</code> ) y la funci√≥n del controlador se especifica a trav√©s del punto. <br><br>  Si realmente lo desea, puede registrar varios controladores en un archivo.  Tambi√©n aqu√≠ est√° el camino a webpack, que deber√≠a recopilar todo esto.  B√°sicamente, todo: el resto ya se genera autom√°ticamente. <br><br><h3>  Lo m√°s interesante es src </h3><br>  Aqu√≠ hay una gran aplicaci√≥n React / Redux (en mi caso no es enorme, para la p√°gina).  En la carpeta lambda adicional hay todo lo que necesitamos para representar el lambda: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3f4/b29/61a/3f4b2961a0c6f9218b715d6f013c53bf.png"><br><br>  Estos son 2 archivos: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f10/df3/485/f10df348528805e990f1d781a2406226.png"><br><br>  Comencemos con el controlador.  Lo m√°s importante es la l√≠nea 13.  Este es el renderizador, que es la misma lambda que se llamar√° en las nubes: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3dd/d02/4a2/3ddd024a27fe4ccd1d919885f56f1009.png"><br><br>  Como puede ver, la funci√≥n <code>render ()</code> devuelve una promesa, de la cual deben capturarse todas las excepciones.  Esta es la peculiaridad de la lambda, de lo contrario, la lambda no terminar√° de inmediato, sino que funcionar√° hasta el tiempo de espera.  Tendr√° que pagar dinero extra por un c√≥digo que ya ha ca√≠do.  Para evitar que esto suceda, debe terminar la lambda lo antes posible; en primer lugar, capturar y manejar todas las excepciones.  M√°s tarde volveremos a esto. <br><br>  Si no tenemos ning√∫n error o excepci√≥n, llamamos a la funci√≥n <code>createResponse</code> , que toma literalmente cinco l√≠neas.  Solo agregamos todos los encabezados para que se muestre correctamente en el navegador: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1c3/15c/025/1c315c025f85e3d63a70a9843cb0a8d3.png"><br><br>  Lo m√°s interesante aqu√≠ es la funci√≥n de <code>render</code> , que renderizar√° nuestra p√°gina: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d3d/336/0b8/d3d3360b83d7d5c329c5177719029ba8.png"><br><br>  Esta funci√≥n nos viene de renderer.js.  Veamos que hay ah√≠. <br><br>  All√≠ se presenta una aplicaci√≥n isom√≥rfica.  Adem√°s, se procesa en cualquier servidor, no importa si es lambda o no. <br><br>  No le dir√© en detalle sobre qu√© es una aplicaci√≥n isomorfa, c√≥mo representarla, porque este es un tema completamente diferente, y hay personas que lo dijeron mejor que yo.  Aqu√≠ hay algunos tutoriales que encontr√© buscando en Google en solo un par de minutos: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1e3/366/3d0/1e33663d08624d7649ae4cb084571b98.png"><br><br>  Si conoce otros informes, puede aconsejar, les dar√© enlaces en mi Twitter. <br><br>  Para no perder a nadie, solo subo las escaleras para contar lo que est√° sucediendo all√≠. <br>  En primer lugar, necesitamos renderizar esto con HTML / React / Redux. <br><br>  Esto se hace a trav√©s del m√©todo est√°ndar React - <code>renderToString</code> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/81f/69f/3e8/81f69f3e89005f3ff76e389a65a6d731.png"><br><br>  A continuaci√≥n, necesitamos renderizar estilos para que nuestro contenido no parpadee.  Esta no es una tarea muy trivial.  Hay varios paquetes npm que lo resuelven.  Por ejemplo, us√© <code>node-style-loader</code> , que unir√° todo en <code>styleTag</code> , y luego podr√° pegarlo en HTML. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/509/827/653/509827653575b822318cc8746c893b1b.png"><br><br>  Si hay mejores paquetes, es a su discreci√≥n. <br><br>  Luego necesitamos pasar el estado de Redux.  Dado que est√° procesando en el servidor, probablemente desee obtener algunos datos y no desea que Redux vuelva a preguntar y volver a procesarlos.  Esta es una tarea bastante est√°ndar.  Hay ejemplos en el sitio web principal de Redux sobre c√≥mo hacer esto: creamos un objeto y luego lo pasamos a trav√©s de una variable global: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/732/726/151/7327261516c4747f0994c83f5237668b.png"><br>  Ahora un poco m√°s cerca de la lambda. <br><br>  Es necesario hacer un manejo de errores.  Queremos atrapar todo y hacer algo con ellos, al menos detener el desarrollo de lambda.  Por ejemplo, hice esto a trav√©s de la <code>promise</code> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fe4/eb4/827/fe4eb4827fd43e48c17a84767612da2d.png"><br><br>  A continuaci√≥n, debemos sustituir nuestras URL por archivos est√°ticos.  Y para esto necesitamos descubrir d√≥nde corre la lambda, localmente o en alg√∫n lugar de las nubes.  ¬øC√≥mo averiguarlo? <br><br>  Lo haremos a trav√©s de variables de entorno: <br><br> <code><br> <br> ‚Ä¶ <br> const bundleUrl = process.env.NODE_ENV === 'AWS' ? <br> AWS_URL : LOCAL_URL; <br></code> <br>  Una pregunta interesante: c√≥mo las variables de entorno se unen en una lambda.  En realidad lo suficientemente f√°cil.  En yml, puede pasar cualquier variable al <code>environment</code> .  Cuando est√© bloqueado, estar√°n disponibles: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6bf/a6d/083/6bfa6d083ab79f39cf033342e7e1cec6.png"><br><br>  Bueno, una ventaja: despu√©s de implementar una lambda, queremos implementar todos los activos est√°ticos.  Para hacer esto, ya hemos escrito un complemento en el que puede designar la cesta S3 donde desea implementar algo: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/784/43d/2a3/78443d2a3bcfbf351429efa9f98e9965.png"><br>  En total, realizamos una aplicaci√≥n isom√≥rfica en aproximadamente cinco minutos para demostrar que todo esto es f√°cil. <br><br>  Ahora hablemos un poco sobre la teor√≠a: los pros y los contras de lambda. <br><br>  Comencemos con lo malo. <br><br><h3>  Contras funciones lambda </h3><br>  Los inconvenientes pueden incluir (o tal vez no) el momento de un arranque en fr√≠o.  Por ejemplo, para el lambda en Node.js que estamos escribiendo ahora, la hora de inicio en fr√≠o no significa mucho. <br><br>  El siguiente gr√°fico muestra el tiempo de arranque en fr√≠o.  Y esto puede ser un gran problema, especialmente para Java y C # (preste atenci√≥n a los puntos naranjas): no desea que le tome solo cinco o seis segundos comenzar a ejecutar el c√≥digo. <br><br>  Para Node.js, el tiempo de inicio es casi cero - 30 - 50 ms.  Por supuesto, para algunos esto tambi√©n puede ser un problema.  Pero las funciones se pueden calentar (aunque este no es el tema de este informe).  Si alguien est√° interesado en c√≥mo se llevaron a cabo estas pruebas, bienvenido a acloud.guru, le contar√°n todo ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en el art√≠culo</a> ). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cb7/11b/185/cb711b1856839c3b9ee9d0a268e0b4cc.png"><br><br>  ¬øCu√°les son las desventajas? <br><br><h3>  Limitaciones de tama√±o del c√≥digo de funci√≥n </h3><br>  El c√≥digo debe tener menos de 50 MB.  ¬øEs posible escribir una funci√≥n tan grande?  Por favor, no te olvides de node_modules.  Si conecta algo, especialmente si hay archivos binarios all√≠, realmente puede superar f√°cilmente los 50 MB, incluso para archivos zip.  He tenido tales casos.  Pero esta es una raz√≥n adicional para ver lo que est√° conectando a node_modules. <br><br><h3>  Limitaciones de tiempo de ejecuci√≥n </h3><br>  Por defecto, la funci√≥n se ejecuta por un segundo.  Si no termina despu√©s de un segundo, tendr√° un tiempo de espera.  Pero este tiempo se puede aumentar en la configuraci√≥n.  Al crear una funci√≥n, puede establecer el valor en cinco minutos.  Cinco minutos es una fecha l√≠mite dif√≠cil.  Esto no es un problema para el sitio.  Pero si desea hacer algo m√°s interesante en lambdas, por ejemplo, procesar im√°genes, convertir texto en sonido o sonido en texto, etc., dichos c√°lculos pueden tomar f√°cilmente m√°s de cinco minutos.  Y eso ser√° un problema.  ¬øQu√© hacer al respecto?  Optimizar o no usar lambda. <br><br>  Otra cosa interesante que surge en relaci√≥n con el l√≠mite de tiempo para la ejecuci√≥n de lambda.  Recordemos el dise√±o de nuestro sitio.  Todo funcion√≥ perfectamente hasta que el producto lleg√≥ y dese√≥ en el sitio en tiempo real, para mostrar noticias en tiempo real.  Sabemos que esto se implementa con WebSockets.  Pero los WebSockets no funcionan durante cinco minutos, deben mantenerse m√°s tiempo.  Y aqu√≠ el l√≠mite de cinco minutos se convierte en un problema. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4a3/baa/e78/4a3baae784a50a373e56e5e3652187c9.png"><br><br>  Un peque√±o comentario.  Para AWS, esto ya no es un problema.  Encontraron c√≥mo evitar esto.  Pero hablando en general, tan pronto como aparecen los enchufes web, lambda no es una soluci√≥n para usted.  Necesita cambiar a los viejos servidores buenos nuevamente. <br><br><h3>  El n√∫mero de funciones paralelas por minuto. </h3><br>  Arriba hay un l√≠mite de 500 a 3,000, dependiendo de la regi√≥n donde se encuentre.  En mi opini√≥n, en Europa casi 500. 3000 es compatible con los Estados Unidos. <br><br>  Si tiene un sitio ocupado y espera m√°s de tres mil solicitudes por minuto (lo cual es f√°cil de imaginar), esto se convierte en un problema.  Pero antes de hablar sobre este signo negativo, hablemos un poco sobre c√≥mo escala lambda. <br><br>  Nos llega una solicitud y recibimos una lambda.  Mientras se ejecuta esta lambda, nos llegan dos solicitudes m√°s: comenzamos dos lambdas m√°s.  La gente comienza a venir a nuestro sitio, aparecen solicitudes y se lanzan lambdas, cada vez m√°s. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4a1/58e/a49/4a158ea4922c44333fbe590440dde1b3.png"><br><br>  Al hacerlo, paga el tiempo en que se ejecuta la lambda.  Supongamos que paga un centavo por un segundo de ejecuci√≥n lambda.  Si tiene 10 lambdas por segundo, pagar√° 10 centavos por este segundo.  Si tiene un mill√≥n de lambdas funcionando por segundo, eso es alrededor de 10 mil d√≥lares.  Figura desagradable. <br><br>  Por lo tanto, AWS decidi√≥ que no quieren vaciar su billetera en un segundo si realiz√≥ sus pruebas de manera incorrecta e inici√≥ DDOS usted mismo, causando lambdas o alguien m√°s vino a hacer DDOS.  Por lo tanto, se estableci√≥ un l√≠mite de tres mil, para que tenga la oportunidad de responder a la situaci√≥n. <br><br>  Si la carga de 3000 solicitudes es regular para usted, puede escribir en AWS y aumentar√°n el l√≠mite. <br><br><h3>  Ap√°trida </h3><br>  Este es el √∫ltimo, nuevamente, un menos controvertido. <br><br>  ¬øQu√© es ap√°trida?  Aqu√≠ surge una broma sobre peces de colores: simplemente no mantienen el contexto: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b03/c26/620/b03c26620417a57fec13f48b896c7ef9.png"><br><br>  La lambda, llamada por segunda vez, no sabe nada sobre la primera llamada. <br><br>  D√©jame mostrarte un ejemplo.  Digamos que tengo un sistema: una gran caja negra.  Y este sistema, entre otras cosas, puede enviar SMS. <br><br>  El usuario viene y dice: env√≠e el n√∫mero de plantilla de SMS 1. Y el sistema lo env√≠a a un dispositivo real. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ad0/1e9/dea/ad01e9dead7ca1c6a23788c5179f1b3f.png"><br><br>  En alg√∫n momento, el producto expresa el deseo de descubrir qu√© ir√° all√≠ y verificar que nada se rompi√≥ en este sistema en ninguna parte.  Para hacer esto, reemplazaremos el dispositivo real con alg√∫n tipo de n√∫mero de prueba; por ejemplo, Twilio puede hacer esto.  √âl llamar√° a Webhook, enviar√° el texto SMS, procesaremos este texto SMS en la aplicaci√≥n (debemos verificar que nuestra plantilla se haya convertido en el SMS correcto). <br><br>  Para verificar, necesitamos saber qu√© se envi√≥; lo haremos a trav√©s de una aplicaci√≥n de prueba.  Queda por comparar y mostrar los resultados. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5be/881/81f/5be88181fc05100d0f9000d2eb3be124.png"><br><br>  Intentemos hacer lo mismo en lambda. <br><br>  Lambda enviar√° SMS, SMS llegar√° a Twilio. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bce/e3d/499/bcee3d4993dc73090829810748f97ea4.png"><br><br>  Dibuj√© la l√≠nea discontinua no por accidente, porque los SMS pueden retroceder en minutos, horas o d√≠as; depende de su operador, es decir, esta no es una llamada s√≠ncrona.  En este momento, la lambda olvidar√° todo y no podremos verificar los SMS. <br><br>  Yo dir√≠a que esto no es menos, sino una caracter√≠stica.  El esquema se puede rehacer.  Hay varias opciones para hacer esto, ofrecer√© la m√≠a.  Si tenemos ap√°tridas y queremos guardar algo, entonces definitivamente necesitamos usar el almacenamiento, por ejemplo, una base de datos, S3, pero cualquier cosa que almacene nuestro contexto. <br><br>  En el esquema con el almacenamiento de SMS, se enviar√° al n√∫mero de prueba.  Y cuando Webhook lo llama, sugiero llamar, por ejemplo, a la segunda lambda, porque esta es una funci√≥n ligeramente diferente.  Y el segundo lambda ya podr√° ir y recoger el SMS-ku que sali√≥ de la base de datos, verificarlo y mostrar los resultados. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d7f/fdc/2c3/d7ffdc2c3761dbadd4d2500daadd68db.png"><br><br>  Bingo! <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al principio, dije que debes olvidarte de los servidores si escribes lambda. Conoc√≠ a personas que escriben en node.js y se utilizan para expresar servidores. Les gusta confiar en el cach√©, y el cach√© permanece en lambdas. Y a veces, cuando prueban, funcionar√°, y a veces no. ¬øC√≥mo es esto posible?</font></font><br><br> ,    ,     .   ‚Äî    . , -,   .   ,    ,        .      ,   ,   AWS ,       . AWS   ,     ,   .   . -,  node   ,  Java     12-15 .   ,      ,           .   -  node cache ‚Äî     .. ‚Äî     ,    .      ,      ,      .   . <br><br><h3>  - </h3><br>  ,      . <br><br><ul><li>      ,   .  ,     javascript,  .  ,        javascript-,        . <br></li><li>      ,   ,   . ,   ,  .   ,             . <br></li><li>    AWS- ‚Äî            (DynamoDB, Alexa, API Gateway,  . .). <br></li></ul><br><h3>      ? </h3><br>      ‚Äî      ,       ,   REST API.        ,     ,         . <br><br>  ,     ,  ‚Ä¶  . <br><br><ul><li> HTTP Services ‚Äî     . REST API,  API endpoint ‚Äî  .   .    ,   enterprise   node.js   middleware.    java,    ,     js ,     .         . <br></li><li> IoT ‚Äî ,   Alexa      - -,         ,  . <br></li><li> Chat Bots ‚Äî    ,   IoT. <br></li><li> Image/Video conversions. <br></li><li> Machine learning. <br></li><li> Batch Jobs ‚Äî -  ,  Batch Job     . <br></li></ul><br>   Amazon, Google, Azure, IBM, Twillio ‚Äî         cloud functions.     ,               .     open source (      ,  open source ‚Äî ).  open source    .        .         ‚Äî Docker Swarm, Kubernetes ‚Äî    . <br><br>  , , -,      .       AWS   ,    open source    . <br><br>      .      .   :         : <br><br><ul><li> Iron functions <br></li><li> Fnproject <br></li><li> Openfaas <br></li><li> Apache OpenWhisk <br></li><li> Kubeless <br></li><li> Fission <br></li><li> Funktion <br></li></ul><br>   Fnproject     ,       Fnproject       Kubernetes-. <br><br>     .     API Gateway (,   ),     URL,   .          ,   ,   ,          Kubernetes,       . <br><br><blockquote>  .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a>  HolyJS 2018 Moscow,   24-25   .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a>      ,     Early Bird-. </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es417943/">https://habr.com/ru/post/es417943/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es417933/index.html">Semana de la seguridad 27: iPhone falso y precio de seguridad</a></li>
<li><a href="../es417935/index.html">Notas sobre inteligencia artificial, aprendizaje autom√°tico, aprendizaje profundo y Big Data</a></li>
<li><a href="../es417937/index.html">¬øEst√°n las personas "de hierro" haciendo software?</a></li>
<li><a href="../es417939/index.html">Optimizaci√≥n de la representaci√≥n de una escena de la caricatura de Disney "Moana". Partes 4 y 5</a></li>
<li><a href="../es417941/index.html">¬øD√≥nde desaparece el agua en la tetera?</a></li>
<li><a href="../es417945/index.html">¬øQu√© herramientas tiene la sonda solar Parker?</a></li>
<li><a href="../es417947/index.html">Visualizaci√≥n de datos para su proyecto web.</a></li>
<li><a href="../es417949/index.html">¬øC√≥mo escrib√≠ la biblioteca est√°ndar de C ++ 11 o por qu√© boost es tan aterrador? Cap√≠tulo 4.2</a></li>
<li><a href="../es417951/index.html">Escribir c√≥digo Kotlin amigable con Java</a></li>
<li><a href="../es417953/index.html">Tendencias en el dise√±o de FPGA. Traducci√≥n</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>