<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>â˜ğŸ½ ğŸ‘ğŸ» â–ªï¸ Sensor Jendela Nirkabel Buatan Rumah: STM32L051 + RFM69 + Android ğŸ¬ ğŸ‘©ğŸ¾â€ğŸŒ¾ ğŸ‘¢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Selamat siang, Khabrovit sayang! Beberapa tahun yang lalu, saya membeli iklan zWave yang berwarna-warni dan memasang sensor jendela berdasarkan protok...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sensor Jendela Nirkabel Buatan Rumah: STM32L051 + RFM69 + Android</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482858/"> Selamat siang, Khabrovit sayang!  Beberapa tahun yang lalu, saya membeli iklan zWave yang berwarna-warni dan memasang sensor jendela berdasarkan protokol ini.  USB zWave-Stick terhubung ke server rumah, yang memainkan peran sebagai pengontrol, modul Java kecil ditulis yang menerima data dari pengontrol ini, dan sebuah aplikasi kecil untuk Android ditulis yang dengan indah menampilkan status semua sensor.  Baterai dimasukkan, sensor terdaftar pada controller, semuanya berfungsi.  Tetapi setelah beberapa bulan ada kekecewaan yang mengerikan.  Pertama, sensor zWave ini bekerja berdasarkan prinsip "kirim pesan dan tertidur tanpa menunggu konfirmasi."  Dalam kasus saya, ini mengarah pada fakta bahwa sinyal dari sensor terjauh dari controller tidak mencapai controller.  Bahkan pemasangan repeater zWave tambahan tidak membantu.  Kedua, mereka menghabiskan baterai begitu cepat sehingga setelah sekitar enam bulan semua sensor berhenti bekerja.  Alasannya adalah bahwa mereka bangun setiap jam untuk memberi tahu pengontrol tentang kondisi mereka.  Nonaktifkan atau ubah opsi ini tidak berfungsi, karena perangkat lunak standar tidak mengizinkannya.  Setelah dua tahun tersiksa oleh teknologi yang mentah, tidak dapat diandalkan, dan tidak ramah ini, saya memutuskan bahwa saya sudah cukup.  Tapi alih-alih menyimpan semuanya dan membuangnya, saya mendapat ide untuk meninggalkan kasing, tetapi mengubah elektronik di dalamnya.  Pilihannya jatuh pada transceiver RFM69 yang cukup sederhana (433 MHz), atas dasar itu dimungkinkan untuk membuat papan untuk sensor dan pengontrol yang terhubung melalui USB ke server.  Sistem baru telah beroperasi selama 5 bulan, keandalan mendekati 100% (tetapi masih ada beberapa kegagalan), baterai belum berpikir untuk menjadi kosong.  Artinya, sudah terlihat bahwa semua kekurangan sistem lama berdasarkan zWave telah dihilangkan, dan saya ingin berbagi rincian teknis dari artikel saya ini, lihat gambar. <br><br><img src="https://habrastorage.org/webt/n-/gz/rd/n-gzrd4pxnz2h38utebhqhtakjg.png"><br><br>  Siapa yang peduli, tolong, di bawah kucing. <br><a name="habracut"></a><br>  Sepertinya saya bahwa zWave dalam kasus saya ternyata tidak beroperasi karena dua alasan: rumah memiliki dua lantai dengan lantai beton bertulang dan area yang luas (yaitu, pemindahan beberapa sensor dari pengontrol secara signifikan).  Nah, kelemahan dalam perangkat lunak berpemilik, yang tidak memungkinkan untuk menonaktifkan sensor berkala, yang menyebabkan baterai cepat habis.  Ketika menjadi jelas bahwa saya tidak dalam perjalanan dengan zWave, saya mulai mencari opsi lain yang bisa dimasukkan ke rumah sensor yang sama. <br><br>  Prototipe sensor pertama saya didasarkan pada ESP8266.  Kontroler - berdasarkan pembayaran saya yang sudah saya <a href="https://habr.com/en/post/413101">tulis di HabrÃ©</a> .  Sistem itu bahkan berfungsi sebagai prototipe, tetapi saya harus meninggalkannya karena dua alasan.  Alasan pertama adalah sama - di rumah ada sudut dengan tingkat sinyal WiFi yang sangat rendah, yang menyebabkan waktu aktivasi ESP8266 yang sangat lama pada saat bangun dan, sebagai akibatnya, keluarnya baterai yang kuat.  Meskipun saya akui bahwa saya tidak tahu cara memasak ESP8266 ini (artikel <a href="https://habr.com/ru/post/480316">seperti ini</a> mengkonfirmasi tesis ini).  Tapi alasan kedua lebih serius.  Karena saya memutuskan untuk meninggalkan tidak hanya casing, tetapi juga kompartemen baterai, saya terbatas pada baterai CR123A, yaitu 3,0 volt.  Artinya, harga dan kompleksitas sensor meningkat karena meningkatnya konverter DC / DC.  Meskipun <a href="https://habr.com/ru/post/304936">ada artikel bagus</a> tentang topik ini di HabrÃ©.  Tetapi, bagaimanapun juga, kedua alasan ini telah melebihi dan saya menolak ESP8266. <br><br>  Prototipe kedua ditransfer.  Saya membuat prototipe sensor dan pengontrol USB, saya menambahkan modul server sehingga dia mengerti pengontrol ini selain zWave-Stick.  Ada ide untuk secara bertahap menarik kabel dan sensor setelah sensor untuk mengubah zWave-board ke yang kabel.  Namun pada akhirnya, ia tidak memetik tembok dan prototipe ini juga dibuang. <br><br>  Kemudian ia memutuskan untuk melihat ke arah modul radio pada 433 dan 868 MHz dan memesan beberapa modul untuk percobaan: <a href="https://www.sparkfun.com/products/13910" rel="nofollow">RFM69HCW</a> , <a href="https://www.mouser.de/datasheet/2/21/A110LR09A_ProductBrief-1511797.pdf" rel="nofollow">A110LR09A</a> dan <a href="https://www.mouser.de/datasheet/2/268/70651A-60467.pdf" rel="nofollow">MRF89XAM8A</a> .  Dalam hal ukuran modul, harga, dan juga karena ketersediaan perpustakaan dan <a href="https://learn.sparkfun.com/tutorials/rfm69hcw-hookup-guide" rel="nofollow">contoh-contoh yang baik, saya</a> memilih RFM69HCW, yang membentuk dasar sistem. <br><br>  Sistem ini hanya memiliki empat komponen: <br><br><ul><li>  sensor nirkabel (433 MHz, baterai CR123A 3.0V), </li><li>  pengontrol jaringan (433 MHz, ditenagai melalui USB dari server) </li><li>  server (yang sudah saya tulis di HabrÃ© <a href="https://habr.com/en/post/268197">dalam artikel ini</a> ) dan modul program server </li><li>  klien seluler (aplikasi Android) </li></ul><br>  Di bawah ini saya akan menjelaskan setiap modul secara terperinci, dan pada akhirnya saya akan memberikan statistik operasi sistem selama beberapa bulan terakhir operasi. <br><br><h3>  Sensor </h3><br>  Sensor menggunakan <a href="https://www.sparkfun.com/products/13910" rel="nofollow">modul</a> radio <a href="https://www.sparkfun.com/products/13910" rel="nofollow">RFM69HCW</a> .  Ini memiliki rentang tegangan operasi yang luas (1.8V-2.4V 17dBm, 2.4V-3.6V 20dBm) dan dikendalikan melalui SPI.  Artinya, Anda membutuhkan mikrokontroler.  Beberapa waktu lalu saya berkenalan dengan seri STM32L dan memesan STM32L051 untuk percobaan.  Itu menyuap saya sebagai arus kecil dalam mode tidur (0,27 Î¼A), dan tegangan operasi, hampir identik dengan tegangan modul radio (1,65V-3,6V).  Ditambah harga murah. <br><br>  Ternyata skema berikut: <br><br><img src="https://habrastorage.org/webt/0b/xx/kb/0bxxkbtvavy113lz23izewdi4yk.png" alt="gambar"><br><br>  Tegangan suplai baik mikrokontroler dan modul radio sedemikian rupa sehingga mereka dapat langsung didukung dari elemen CR123A.  STM32L051 memiliki sumber tegangan referensi internal yang terhubung ke saluran 17 dari ADC, serta nilai kalibrasi dari sumber ini, yang memungkinkan Anda untuk mengukur nilai arus dari tegangan suplai VDD.  Modul radio terhubung ke daya melalui perangkat bidang Q1, yang memungkinkan Anda untuk mengontrol daya dari mikrokontroler. <br><br>  Mode tidur diimplementasikan dengan mentransfer mikrokontroler ke "Siaga".  Dalam mode ini, STM32L051 memiliki inti yang dinonaktifkan, hampir semua periferal dan regulator tegangan internal, yang memastikan konsumsi pada tingkat 0,29 Î¼A (ketika jam waktu nyata dinonaktifkan).  Tetapi dalam mode ini ada fitur - mikrokontroler hanya terbangun di sepanjang tepi sinyal yang naik pada pin WKUP (A0).  Karena sakelar magnet digunakan, yang hidup / mati (tertutup atau terbuka), Anda memerlukan blok kecil yang menghasilkan pulsa berdurasi pendek baik saat menutup maupun saat membuka kontak magnetik.  Denyut ini diumpankan ke input A0 dari mikrokontroler dan membangunkannya.  Konverter semacam itu diterapkan pada IC3 chip OR-eksklusif dari seri 74AUP hemat energi (74AUP1G86), yang beroperasi pada kisaran tegangan 0,8V-3,6V dan mengkonsumsi 0,2 Î¼A.  Dengan demikian, total konsumsi dalam mode tidur harus sekitar 0,5 Î¼A, yang dikonfirmasi oleh pengukuran pada sensor yang dirakit sepenuhnya. <br><br>  Ketika mikrokontroler bangun, pertama-tama mengukur tegangan suplai dan, jika kurang dari 1,8 volt, maka itu bukan takdir - pemancar tidak dapat dimulai dan mikrokontroler jatuh tertidur kembali. <br><br>  Jika tegangan baterai lebih besar dari 1,8 volt, maka mikrokontroler menyala dan menginisialisasi modul radio, mentransfer status ke pengontrol jaringan dan menunggu konfirmasi.  Paket data mencakup nomor (acara) paket 32-bit yang unik, tegangan baterai, suhu, status kontak magnetik, byte kontrol (CRC7).  Jika konfirmasi berhasil, mikrokontroler tertidur kembali.  Jika tidak, maka kirim status lagi, tetapi maksimal 10 kali.  Saya menetapkan batas ini sehingga sensor tidak mencoba menunggu tanpa batas waktu untuk respons dalam situasi di mana pengontrol jaringan dimatikan.  Nomor peristiwa unik yang terakhir ditransmisikan disimpan dalam EEPROM internal mikrokontroler. <br><br>  Selama transfer data, mikrokontroler berkedip LED (di mana tanpa itu).  LED dihidupkan menggunakan PWM, di mana siklus kerjanya tergantung pada nilai tegangan saat ini, yang memungkinkan Anda untuk memiliki kecerahan yang hampir sama di hampir seluruh rentang tegangan operasi. <br><br>  Papan dirancang di EagleCAD, desain papan <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/pcb" rel="nofollow">tersedia di sini</a> .  Papan dua sisi: mikrokontroler dan harness-nya terletak di sisi atas menghadap bingkai jendela, dan modul radio dan LED berada di sisi bawah menghadap ruangan.  Saya memesan di Cina, menyolder sendiri dalam oven dapur konvensional (lapisan atas) dan pengering rambut (lapisan bawah). <br><br><img src="https://habrastorage.org/webt/rj/io/9l/rjio9lhfs3psrwyw8_xefn1lcmi.jpeg" alt="gambar"><br><br>  Modul radio membutuhkan antena.  Ini hanya sepotong kawat dengan panjang 164 mm. <br><br>  Setelah instalasi, masing-masing sensor harus diprogram, untuk itu disediakan konektor SWD.  Saya meninggalkan kontak yang tersisa di papan untuk kemungkinan percobaan di masa depan. <br>  Firmware ditulis dalam C ++, bagian dari kode ini dilakukan dalam kelas dasar yang cukup universal yang merangkum panggilan ke perpustakaan ST HAL.  Kode sumber <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/src" rel="nofollow">ada di sini</a> .  Untuk pengembangan, System Workbench untuk STM32 digunakan.  Ukuran file firmware biner terakhir adalah 22 kB. <br><br>  Dan ini sensornya: <br><br><img src="https://habrastorage.org/webt/91/fx/ap/91fxapzu7uwnpr0wp2cjydbpwaa.jpeg" alt="gambar"><br><br>  Tergantung pada posisi sensor, untuk beberapa sensor saya meninggalkan antena di luar (dengan latar belakang bingkai putih, namun, itu tidak terlihat), dan untuk beberapa sensor saya membengkokkan kawat ke dalam bingkai dan benar-benar memasukkannya ke dalam case. <br><br>  Demi kepentingan, saya menghitung biaya komponen untuk satu sensor (dengan harga katalog Mouser, harga dan harga total dalam euro) <br><table cellspacing="0" border="0"><tbody><tr><td align="left">  <b><font>Barang</font></b> </td><td align="left">  <b><font>Deskripsi</font></b> </td><td align="left">  <b><font>Nilai</font></b> </td><td align="left">  <b><font>Nomor MOUSER</font></b> </td><td align="left">  <b><font>Jumlah</font></b> </td><td align="left">  <b><font>Biaya</font></b> </td></tr><tr><td align="left">  <font>IC3</font> </td><td align="left">  <font>Eksklusif ATAU</font> </td><td align="left">  <font>1G86</font> </td><td align="left">  <font>771-74AUP1G86GW-G</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,254</font> </td></tr><tr><td align="left">  <font>IC1</font> </td><td align="left">  <font>Mikrokontroler</font> </td><td align="left">  <font>STM32L051</font> </td><td align="left">  <font>511-STM32L051K6T6</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>2.14</font> </td></tr><tr><td align="left">  <font>SV1</font> </td><td align="left">  <font>Konektor</font> </td><td align="left">  <font>Swd</font> </td><td align="left">  <font>68602-406HLF</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,157</font> </td></tr><tr><td align="left">  <font>LED1</font> </td><td align="left">  <font>LED 3 mm</font> </td><td align="left">  <font>3mm</font> </td><td align="left">  <font>630-HLMP-K155</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,351</font> </td></tr><tr><td align="left">  <font>Q1</font> </td><td align="left">  <font>P-MOSFET</font> </td><td align="left">  <font>BSH205</font> </td><td align="left">  <font>771-BSH205G2R</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,276</font> </td></tr><tr><td align="left">  <font>S1</font> </td><td align="left">  <font>Kontak magnetik</font> </td><td align="left">  <font>ORD211-0810</font> </td><td align="left">  <font>876-ORD211-0810</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,625</font> </td></tr><tr><td align="left">  <font>IC2</font> </td><td align="left">  <font>Modul radio RFM69HCW</font> </td><td align="left">  <font>RFM69HCW</font> </td><td align="left">  <font>474-COM-13910</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>5.36</font> </td></tr><tr><td align="left">  <font>C1, C2, C3, C6</font> </td><td align="left">  <font>Kapasitor SMD</font> </td><td align="left">  <font>0.1 uF</font> </td><td align="left">  <font>80-C0805C104J5RAC</font> </td><td align="left">  <font>4</font> </td><td align="left">  <font>0,1</font> </td></tr><tr><td align="left">  <font>C5</font> </td><td align="left">  <font>Kapasitor SMD</font> </td><td align="left">  <font>0.4nF</font> </td><td align="left">  <font>C0805C471K8HACTU</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,021</font> </td></tr><tr><td align="left">  <font>C4</font> </td><td align="left">  <font>Kapasitor SMD (tantalum)</font> </td><td align="left">  <font>47 uF</font> </td><td align="left">  <font>581-TAJR225K016RNJ</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,334</font> </td></tr><tr><td align="left">  <font>R1</font> </td><td align="left">  <font>SMD resistor</font> </td><td align="left">  <font>10 rb</font> </td><td align="left">  <font>660-RK73H2ATTDD1002F</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,01</font> </td></tr><tr><td align="left">  <font>R10</font> </td><td align="left">  <font>SMD resistor</font> </td><td align="left">  <font>330</font> </td><td align="left">  <font>660-RK73H2ATTDD3300F</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,01</font> </td></tr><tr><td align="left">  <font>R3, R4, R6, R7, R8, R11</font> </td><td align="left">  <font>SMD resistor</font> </td><td align="left">  <font>47 rb</font> </td><td align="left">  <font>660-RK73H2ATTDD4702F</font> </td><td align="left">  <font>6</font> </td><td align="left">  <font>0,06</font> </td></tr><tr><td align="left">  <font>R5</font> </td><td align="left">  <font>SMD resistor</font> </td><td align="left">  <font>56</font> </td><td align="left">  <font>660-RK73H2ATTD56R0F</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,013</font> </td></tr><tr><td align="left">  <font>R9</font> </td><td align="left">  <font>SMD resistor</font> </td><td align="left">  <font>56 jt</font> </td><td align="left">  <font>603-RC0805JR-0756ML</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,037</font> </td></tr><tr><td align="left"></td><td align="left"></td><td align="left"></td><td align="left"></td><td align="left"></td><td align="left">  <b><font>9,748</font></b> </td></tr></tbody></table><br>  Omong-omong, ternyata persis tiga kali lebih murah daripada sensor zWave asli.  Meskipun ini hanya biaya suku cadang tidak termasuk kasing.  Tapi, menurut saya, di retail zWave sensor harganya mahal. <br><br><h3>  Pengontrol jaringan </h3><br>  Untuk pengontrol, modul radio yang sama dan mikrokontroler yang sama digunakan untuk sensor.  Ini memungkinkan penggunaan kembali sebagian besar kode firmware.  Untuk pengontrol, saya memilih faktor bentuk papan ini untuk menggunakan kasing siap pakai dari Raspberry Pi.  Dibandingkan dengan sensor, konektor antena eksternal dan loop USB berdasarkan isolator FT232RL dan SI-8621 ditambahkan.  Tentu saja, sebagai gantinya, seseorang dapat mengambil beberapa STM32 dengan USB di papan.  Tetapi kemudian, pertama-tama, perlu untuk memisahkan kode firmware dan, kedua, untuk melakukan implementasi perangkat lunak dari USB itu sendiri.  Opsi dengan FT232RL eksternal, meskipun lebih mahal, lebih andal dan lebih cepat untuk diterapkan.  Hasilnya adalah <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/pcb" rel="nofollow">skema berikut</a> : <br><br><img src="https://habrastorage.org/webt/wh/ij/_k/whij_k04j8jqetojnlz0hblpnom.png" alt="gambar"><br><br>  Dan dalam bentuk rakitan ternyata seperti ini: <br><br><img src="https://habrastorage.org/webt/f2/-4/io/f2-4iog6apig6hfmq-6zhhxmzno.jpeg" alt="gambar"><br><br><img src="https://habrastorage.org/webt/dp/gg/cu/dpggcuqsrdegbwobtujrbf1rlck.jpeg" alt="gambar"><br><br>  Mikrokontroler tidak tidur di sini, modul radio berfungsi untuk penerimaan, tetapi setelah berhasil menerima paket dari salah satu sensor, modul beralih ke mode transmisi dan mengirimkan pemberitahuan.  Selain itu, setiap paket yang berhasil diterima dikirim melalui USB ke server.  Format paket adalah serangkaian nilai yang dipisahkan oleh simbol ";": <br>  GW; 3; 12; -57; 0; 146; 30; 18 <br>  dimana: <br><br><ul><li>  posisi pertama adalah label paket (selalu "GW") </li><li>  posisi kedua - tipe data (status sensor atau kode kesalahan) </li><li>  posisi ketiga - nomor sensor </li><li>  posisi keempat - kualitas sinyal di sisi pengontrol jaringan (RFM69HCW menjaga kualitas sinyal selama penerimaan dan memungkinkan Anda untuk menginterogasinya ketika penerimaan selesai) </li><li>  posisi kelima - keadaan jendela (0 terbuka, 1 tertutup) </li><li>  posisi keenam - nomor unik dari paket (acara) dari sensor.  Nomor ini memungkinkan Anda untuk mengontrol di sisi server apakah semua peristiwa diterima oleh server atau satu atau lebih peristiwa hilang. </li><li>  posisi ketujuh - tegangan baterai saat ini (30 sesuai dengan 3.0V) </li><li>  Posisi kedelapan yang terakhir adalah suhu dari sensor internal mikrokontroler.  Saya belum menemukan cara menggunakannya </li></ul><br>  Kode sumber untuk firmware berada <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/src" rel="nofollow">di tempat yang sama dengan sensor</a> .  Mereka memiliki file utama umum dan perpustakaan umum kelas dasar.  Opsi firmware (sensor atau pengontrol) dipilih menggunakan directive define dalam file main.cpp. <br><br>  Biaya pengontrol jaringan lebih tinggi karena sirkuit USB, antena, dan konektor tambahan.  Tetapi aditif ini dapat diabaikan, karena hanya ada satu pengontrol.  Tetapi bahkan dengan suplemen ini, ternyata juga tiga kali lebih murah daripada zWave-Stick, yang sebelumnya ada di tempatnya. <br><br><h3>  Modul server </h3><br>  Pengontrol jaringan terhubung ke server yang menjalankan CentOS 7. Server menjalankan program yang ditulis dalam Java.  Dan dalam strukturnya, dan dalam implementasi, dan dalam tugas-tugas, program ini cukup sederhana: <br><br><ul><li>  Menggunakan pustaka <a href="http://rxtx.qbang.org/wiki/index.php/Main_Page" rel="nofollow">RxTx yang</a> sangat lama dan tampaknya tidak lagi didukung, port USB yang ditentukan dalam konfigurasi dipantau (dalam kasus saya / dev / ttyUSB0).  Saat ini, ini adalah bagian yang paling tidak optimal dari seluruh sistem, karena perpustakaan memuat prosesor server. </li><li>  Jika data diterima dari port USB, mereka direkam dalam file log dan disimpan dalam kelas status sensor.  Ketika Anda me-restart server, statusnya hilang.  Untuk mengembalikannya, Anda harus berkeliling rumah dan membuka dan menutup semua jendela secara manual.  Ini mungkin kelemahan terbesar dari sistem saya, tetapi saya cukup sadar menolak untuk secara berkala mengumpulkan sensor demi menghemat baterai mereka. </li><li>  Aplikasi ini juga merupakan server TCP / IP kecil dan mendengarkan pada port TCP / IP yang ditentukan dalam konfigurasi.  Pada port ini, ia dapat menerima koneksi dari klien seluler. </li><li>  Jika klien seluler terhubung ke server, ia mengirim status saat ini dari semua sensor.  Menggunakan pesan heartbit berkala, server juga memonitor aktivitas koneksi. </li><li>  Server dan klien seluler bertukar pesan dalam format XML.  Pesan-pesan ini diimplementasikan dalam bentuk <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/zNetMonitor/common" rel="nofollow">perpustakaan Java</a> kecil, yang dibagikan baik di sisi server dan di sisi aplikasi mobile Android. </li><li>  Meskipun ini tidak masuk akal, demi kepentingan, saya menambahkan fungsi otorisasi klien seluler melalui IMEI, serta enkripsi pesan AES antara server dan klien menggunakan kunci yang dijahit ke dalam kode sumber (paket javax.crypto Java).  Tapi ini murni untuk percobaan, karena port TCP / IP modul server ini hanya dapat diakses dari jaringan internal dan tidak terlihat dari luar.  Meskipun, jika saya ingin membuka port ini ke dunia besar, sekarang tidak akan begitu menakutkan untuk melakukannya. </li></ul><br>  Siapa peduli, kode sumber modul server ada di <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/zNetMonitor/server" rel="nofollow">sini</a> . <br><br><h3>  Klien seluler (aplikasi Android) </h3><br>  Anda tidak akan menulis banyak di sini, meskipun aplikasi ini adalah hasil akhir dari seluruh proyek.  Ini adalah aplikasi Java standar dan sangat sederhana dengan tiga tab: keadaan jendela lantai pertama, keadaan lantai dua, dan telemetri kecil server (lihat <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/zNetMonitor/app" rel="nofollow">kode sumber di sini</a> ): <br><br><img src="https://habrastorage.org/webt/j5/hz/hd/j5hzhduedoxedwhuuhrpe0e4s8e.png" alt="gambar"><br><br>  Grafik didasarkan pada satu set file SVG, yang ditumpuk di atas satu sama lain tergantung pada keadaan sensor.  Tekan lama didukung di area masing-masing jendela, yang menurutnya petunjuk ditampilkan dengan waktu kapan jendela ini dibuka: <br><br><img src="https://habrastorage.org/webt/4e/_z/42/4e_z42j_o2j11j7tl9lzzefeffi.png" alt="gambar"><br><br>  Pada prinsipnya, tidak ada yang mencegah Anda menambahkan ikon baterai ke tooltip ini, tetapi tangan Anda belum mencapainya. <br><br><h3>  Pengalaman operasi </h3><br>  "Setiap bersin" direkam dalam file log di sisi server.  Analisis file-file ini selama 5 bulan terakhir memungkinkan kita untuk memahami sedikit lebih detail bagaimana perasaan sistem ini. <br><br>  Analisisnya sangat sederhana - cukup letakkan di folder file log di server. <br><br>  Berapa banyak kesalahan dalam pengiriman data di saluran radio?  Lebih dari 5 bulan, 8 kesalahan dicatat ketika pesan diterima dalam ukuran yang salah dan 25 kesalahan dalam CRC yang salah.  Dalam kedua kasus, Anda tidak dapat langsung mengatakan sensor mana yang bermasalah, karena paket data dalam kasus ini benar-benar rusak.  Karena pengontrol jaringan tidak mengkonfirmasi penerimaan data dalam semua kasus ini, sensor harus mengirim data dengan cara baru, yang dalam kebanyakan kasus memperbaiki kesalahan ini. <br><br>  Dan di sini adalah tabel ringkasan tentang pengoperasian sensor selama 5 bulan. <br><table cellspacing="0" border="0"><tbody><tr><td align="center">  <b><font>Lantai</font></b> </td><td align="center">  <b><font>Sensor</font></b> </td><td align="center">  <b><font>Jumlah</font></b> <b><font><br></font></b>  <b><font>Peristiwa</font></b> </td><td align="center">  <b><font>Dari yang tersesat</font></b> <b><font><br></font></b>  <b><font>Peristiwa</font></b> </td><td align="center">  <b><font>Tegangan</font></b> <b><font><br></font></b>  <b><font>Baterai</font></b> </td><td align="center">  <b><font>Median</font></b> <b><font><br></font></b>  <b><font>Kekuasaan</font></b> <b><font><br></font></b>  <b><font>Sinyal</font></b> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>10</font> </td><td align="center">  <font>105</font> </td><td align="center">  <font>0</font> </td><td align="center">  <font color="#800000">3.1</font> </td><td align="center">  <font>-66</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>11</font> </td><td align="center">  <font>52</font> </td><td align="center">  <font>0</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-70</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>12</font> </td><td align="center">  <font>122</font> </td><td align="center">  <font>0</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-61</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>13</font> </td><td align="center">  <font>89</font> </td><td align="center">  <font>0</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-74</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>14</font> </td><td align="center">  <font>2573</font> </td><td align="center">  <font>0</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-68</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>15</font> </td><td align="center">  <font>261</font> </td><td align="center">  <font>0</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-60</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>16</font> </td><td align="center">  <font>543</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-70</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>17</font> </td><td align="center">  <font>156</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-74</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>18</font> </td><td align="center">  <font>177</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3.2</font> </td><td align="center">  <font>-68</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>19</font> </td><td align="center">  <font>384</font> </td><td align="center">  <font color="#800000">3</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-56</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>3</font> </td><td align="center">  <font>368</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-62</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>4</font> </td><td align="center">  <font>86</font> </td><td align="center">  <font>0</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-71</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>5</font> </td><td align="center">  <font>521</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-59</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>6</font> </td><td align="center">  <font>115</font> </td><td align="center">  <font>0</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-62</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>7</font> </td><td align="center">  <font>316</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-63</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>8</font> </td><td align="center">  <font>419</font> </td><td align="center">  <font color="#800000">1</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-60</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>9</font> </td><td align="center">  <font>89</font> </td><td align="center">  <font>0</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-68</font> </td></tr></tbody></table><br>  Sensor No. 10 membeku sekali.  Ini tampaknya menyebabkan penurunan signifikan dalam tegangan baterai.  Alasan pembekuan itu belum jelas.  Menggantung lagi, Anda harus mencari tahu. <br><br>  Sensor No. 14 dipasang di pintu depan, itulah sebabnya ia memiliki sejumlah besar tanggapan.  Tetapi sejumlah besar perjalanan belum mempengaruhi tegangan baterai. <br><br>  Peristiwa yang hilang adalah ketika sensor mencoba mengirim keadaan, tetapi server tidak mengonfirmasinya.  Semua kejadian yang hilang disebabkan oleh fakta bahwa saya mematikan server selama sekitar setengah hari untuk pembersihan. <br><br>  Kolom Median Kekuatan Sinyal Median menunjukkan nilai RSSI median (dalam dBm), di mana setiap nilai individu diperoleh setelah setiap paket diterima.  Sensor dengan sinyal terbaik (No. 19, -56 dBm) terletak pada jarak 2 meter dalam visibilitas langsung dari pengontrol jaringan, tetapi antena dalam sensor ini dilipat dengan bingkai di dalam kasing.  Pengontrol jaringan itu sendiri terletak di lantai dasar.  Namun, sinyal dari sensor lantai dua sangat bagus.  Hal ini disebabkan oleh fakta bahwa pada semua sensor lantai dua antena dilepaskan dari rumah sensor. <br><br><h3>  Alih-alih kata penutup </h3><br>  Di satu sisi, saya senang bahwa saya sendiri, sebagai hobi, ternyata dari awal untuk merancang, merakit dan menjalankan sistem tingkat ini.  Dan bahkan lebih senang bahwa itu bekerja lebih baik daripada sistem "berpemilik" yang didasarkan pada teknologi hype zWave.  Ada juga ruang untuk mengembangkan dan meningkatkan sistem ini.  Saya hanya digerogoti oleh keraguan kecil.  Yaitu, bahwa seseorang tanpa pendidikan listrik khusus mengumpulkan sesuatu di lututnya yang bekerja lebih andal daripada produk bermerek yang dikenal di kalangan sempit merek IOT.  Mungkin, kemajuan berubah di suatu tempat ke arah yang salah. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id482858/">https://habr.com/ru/post/id482858/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id482848/index.html">Bot langsung, bagian 2</a></li>
<li><a href="../id482850/index.html">Prospek untuk biofuel dalam penerbangan</a></li>
<li><a href="../id482852/index.html">Era audio ringkas: bagaimana kaset masuk ke mobil</a></li>
<li><a href="../id482854/index.html">Tentang Perkiraan</a></li>
<li><a href="../id482856/index.html">Orang Asing Ilahi</a></li>
<li><a href="../id482860/index.html">Saya adalah kepala hubungan internasional di Google. Itu sebabnya saya pergi</a></li>
<li><a href="../id482862/index.html">Apakah ada GameDev di Sakhalin? 1.V</a></li>
<li><a href="../id482864/index.html">Video pengawasan rumah. Skema menjaga arsip video tanpa pendaftar rumah</a></li>
<li><a href="../id482866/index.html">Apakah layak membeli Bitcoin tahun depan dan berapa biayanya</a></li>
<li><a href="../id482870/index.html">Bagaimana saya membeli laptop yang terkunci di eBay dan mencoba membuat AntiTheft saya berdasarkan IntelAMT</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>