<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßóüèΩ üóìÔ∏è üêÖ La lutte pour les ressources, partie 6: cpuset ou partage n'est pas toujours juste üñïüèæ üîÜ üî∑</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Lorsqu'ils parlent de cgroups, les utilisateurs de Red Hat posent souvent la m√™me question: ¬´J'ai une application qui est tr√®s sensible en termes de r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>La lutte pour les ressources, partie 6: cpuset ou partage n'est pas toujours juste</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/redhatrussia/blog/430748/">  Lorsqu'ils parlent de cgroups, les utilisateurs de Red Hat posent souvent la m√™me question: ¬´J'ai une application qui est tr√®s sensible en termes de retards.  Est-il possible d'utiliser des cgroups pour isoler cette application des autres en la liant √† certains c≈ìurs de processeur? ¬ª <br><br><img src="https://habrastorage.org/webt/hj/ig/zd/hjigzdvn7vwbunpdkqiqjcdmqde.png" width="100%"><br><br>  Bien s√ªr que vous le pouvez.  Sinon, nous ne choisirions pas cette question comme sujet de l'article d'aujourd'hui. <br><a name="habracut"></a><br>  Dans l'enfance, on nous disait souvent que le partage est bon et juste.  En gros, c'est comme √ßa.  Mais il y a des exceptions. <br><br>  Comme nous l'avons √©crit dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">premier article de cette s√©rie</a> , par d√©faut, Red Hat Enterprise Linux 7 se comporte comme une grand-m√®re aimable sph√©rique.  En ce sens qu'elle essaie de r√©partir √©quitablement les ressources du syst√®me entre tous ceux qui les demandent.  Cependant, dans la vraie vie, les grands-m√®res ont des animaux de compagnie qui en obtiennent plus.  Traduit en sysadmin, cela signifie qu'il existe des situations o√π certaines applications ou certains services sont plus importants que d'autres, il convient donc de leur accorder toute l'attention possible afin qu'ils soient aussi r√©actifs que possible. <br><br>  Red Hat Enterprise Linux 7 le fait en deux √©tapes: <br><br><ol><li>  Nous isolons une partie des c≈ìurs de processeur afin de les transf√©rer √† l'usage exclusif d'une telle application. </li><li>  Nous cr√©ons des groupes de cgroups et des fichiers d'unit√© qui lient cette application √† des noyaux isol√©s. </li></ol><br><h3>  Une petite digression concernant les exemples de ces articles </h3><br>  Hat Enterprise Linux 7.4 a modifi√© le fonctionnement des tranches de courte dur√©e, telles que les sessions utilisateur.  Par cons√©quent, ils ne peuvent plus modifier les param√®tres de groupe de contr√¥le √† la vol√©e, apporter des modifications permanentes √† la configuration ou cr√©er des fichiers de d√©p√¥t √† l'aide de la commande systemctl set-property.  Oui, c'est dommage, mais la communaut√© de d√©veloppement Linux en a d√©cid√© ainsi.  La bonne nouvelle est que ces changements n'ont pas affect√© le service.  Autrement dit, si les applications d√©marrent et s'arr√™tent via des fichiers d'unit√© (fonctionnent comme des d√©mons), alors tous nos exemples fonctionnent.  De plus, il reste possible de cr√©er vos propres groupes de contr√¥le √† l'aide d'outils anciens tels que cgcreate et cgset, puis de placer des sessions et des processus utilisateur dans ces groupes pour utiliser des boules de processeur et d'autres contr√¥les.  Dans la vie, tout change, nous ne pouvons donc qu'adapter et inventer de nouvelles techniques.  Et maintenant, nous passons au sujet d'aujourd'hui. <br><br><h3>  Construire le s√©paratisme avec Isolcpus </h3><br>  L'un des composants les plus importants du noyau Linux est le planificateur de processus.  S'il est un peu plus profond, un processus est un code ex√©cutable qui fait partie d'une application ou d'un service.  En fait, le processus consiste en une s√©rie d'instructions que l'ordinateur ex√©cute, faisant tel ou tel travail, qu'il s'agisse de sceaux ou de quelque chose de plus s√©rieux. <br><br>  Ces instructions sont g√©r√©es par le processeur central, alias CPU.  Sur les ordinateurs modernes, le processeur se compose g√©n√©ralement de plusieurs processeurs appel√©s c≈ìurs. <br><br>  Par d√©faut, l'ordonnanceur consid√®re chaque c≈ìur de processeur comme l'un des modules ex√©cutifs auxquels il affecte de nouveaux processus √† mesure qu'ils apparaissent.  Dans ce cas, l'ordonnanceur essaie de r√©partir plus ou moins uniform√©ment les processus √©mergents entre les c≈ìurs, en tenant compte de la charge.  Malheureusement, le planificateur ne peut pas √™tre inform√© que ce processus particulier finira par donner lieu √† un groupe entier de processus, et ce groupe devra √™tre ex√©cut√© ind√©pendamment des autres processus, dans le sens o√π ils ne devraient pas avoir de c≈ìurs de processeur communs. <br><br>  Par cons√©quent, nous devons en quelque sorte dire au planificateur de sorte qu'il ne touche pas une partie des c≈ìurs de processeur, c'est-√†-dire ne leur donne aucun processus qui frappe.  Et puis nous-m√™mes (ou avec l'aide d'un autre processus) allons forcer ces processus que nous consid√©rons n√©cessaires pour √™tre isol√©s du planificateur du noyau.  Cela peut √™tre fait en utilisant le param√®tre isolcpus dans la ligne de d√©marrage du noyau dans le fichier de configuration grub.  Dans l'exemple ci-dessous, nous avons une machine avec quatre noyaux sur laquelle il y a deux fichiers grub: l'un se trouve dans / etc / default et s'appelle grub.noiso (c'est la sauvegarde de configuration par d√©faut), et le second se trouve l√† et est simplement appel√© grub pour qu'il ramass√© grub2-mkconfig.  Ce deuxi√®me fichier a √©t√© modifi√© pour isoler les noyaux 1-3 du planificateur de processus. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/lx/ch/jj/lxchjjgcltehlxpbltbyfr5xark.png"></div><br>  AVERTISSEMENT: sur Red Hat Enterprise Linux 7, vous n'avez jamais besoin de modifier manuellement le fichier grub.conf dans le dossier / boot.  √Ä la place, apportez les modifications n√©cessaires √† / etc / default / grub, puis reconstruisez le fichier grub.conf √† l'aide de l'utilitaire appropri√©, par exemple, comme ceci: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/w8/au/gp/w8augp_6vfuutouvjdv8imw5way.png"></div><br>  Lorsque vous utilisez le param√®tre isolcpus, il est n√©cessaire de r√©pertorier les c≈ìurs de processeur lib√©r√©s s√©par√©s par des virgules, la num√©rotation commence √† 0. Apr√®s le red√©marrage du syst√®me, le planificateur de processus n'utilisera ces c≈ìurs pour rien, sauf pour certains processus de niveau syst√®me qui DOIVENT √äTRE sur chaque c≈ìur.  Pour v√©rifier si notre m√©thode a fonctionn√©, nous allons d√©marrer plusieurs processus de chargement puis nous verrons le chargement de chaque noyau au moyen de la commande top. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/y_/0u/qh/y_0uqhre8j6tbm4mvaef0tdctms.png"></div><br>  Comme vous pouvez le voir, tous les processus de chargement reposaient sur le CPU 0, au lieu d'√™tre r√©partis uniform√©ment sur les quatre c≈ìurs.  Nous avons donc enregistr√© le param√®tre de d√©marrage correctement. <br><br><h3>  Lier les processus aux noyaux √† l'aide de cpuset </h3><br>  Nous passons maintenant √† des choses <b>qu'il vaut mieux ne pas faire si vous ne comprenez pas pourquoi vous faites cela, et qui sont mieux d√©ploy√©es en production qu'apr√®s des tests approfondis</b> . <br><br>  √Ä quoi servent ces avertissements?  Au fait que nous ferons, en g√©n√©ral, des choses simples en utilisant la bo√Æte √† outils libcgroup, qui a √©t√© d√©crite dans un article pr√©c√©dent.  Si vous vous souvenez, ce n'est qu'un ensemble de commandes pour cr√©er, modifier et d√©truire des groupes de contr√¥le.  En fait, ils font partie de Red Hat Enterprise Linux 6, mais ils peuvent √©galement √™tre install√©s sur Red Hat Enterprise Linux 7, bien qu'il soit possible que cette possibilit√© disparaisse √† l'avenir.  Rappelez bri√®vement les principales recommandations d'utilisation de libcgroup: <br><br><ol><li>  Utilisez systemd pour contr√¥ler les contr√¥leurs cgroup qui sont sous le contr√¥le de systemd lui-m√™me (ce sont le CPU, la m√©moire et les E / S de bloc). </li><li>  Utilisez les outils libcgroup pour g√©rer tous les autres contr√¥leurs cgroup. </li><li>  Faites tr√®s attention aux cons√©quences impr√©vues de vos actions. </li></ol><br>  Tout est simple avec le concept cpuset - c'est une liste de c≈ìurs de processeur (num√©rotation, rappel, commence √† 0), qui accepte les t√¢ches qui seront ex√©cut√©es UNIQUEMENT sur ces c≈ìurs.  Ce sont les c≈ìurs de processeur les plus courants, ils peuvent √™tre contr√¥l√©s par un planificateur de processus (c'est ainsi que le syst√®me est configur√© par d√©faut), ou, inversement, ils peuvent √™tre isol√©s du planificateur (comme nous l'avons fait dans l'exemple ci-dessus). <br><br>  V√©rifions le r√©pertoire / sys / fs / cgroup sur le syst√®me de notre exemple.  Comme vous pouvez le voir, le r√©pertoire cpuset existe d√©j√†, car ce contr√¥leur fait partie du noyau (bien qu'il ne soit pas sous le contr√¥le de systemd).  Cependant, il n'a pas encore de groupes de contr√¥le, donc nous ne voyons que les param√®tres par d√©faut dans ce r√©pertoire. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yp/wy/md/ypwymdstnktxg_kjxosbhx1ilsa.png"></div><br>  V√©rifiez que la bo√Æte √† outils libcgroup est install√©e sur notre machine: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/vn/rn/oh/vnrnoheqhc2xzziafvhnbfx1f2o.png"></div><br>  S'il n'est pas install√©, cela peut √™tre facilement r√©solu avec la commande yum install libcgroup, m√™me un red√©marrage n'est pas n√©cessaire. <br><br>  Maintenant, cr√©ez cpuset.  Pour ce faire, nous utiliserons les commandes suivantes pour cr√©er un nouveau groupe de contr√¥le pour cpuset et enregistrer ses propri√©t√©s: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bx/mv/kn/bxmvknuvxcxadwvboxizn__0hcg.png"></div><br>  La commande Cgcreate cr√©e un groupe de contr√¥le appel√© testset et le place √† l'int√©rieur du contr√¥leur cpuset.  Ensuite, nous attribuons le troisi√®me noyau de notre machine virtuelle √† ce nouveau cpuset et lui attribuons la zone NUMA 0. M√™me si votre syst√®me n'utilise pas NUMA (et le n√¥tre ne l'utilise tout simplement pas), vous devez toujours enregistrer la zone, sinon vous ne pouvez pas assigner de t√¢ches au groupe cgroup .  V√©rifiez maintenant que le r√©pertoire testset a √©t√© cr√©√© sur le syst√®me de fichiers et voyez ce qu'il contient. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ts/uu/ow/tsuuowh_2c5fsqu3hulepjgwtb0.png"></div><br>  Comme vous pouvez le voir, nos modifications sont en place, mais jusqu'√† pr√©sent aucun processus n'a √©t√© ex√©cut√© sur ce cpuset.  Comment planter un processus ici? <br><br>  Il existe plusieurs fa√ßons de proc√©der: <br><br><ul><li>  Vous pouvez conduire le PID d'un processus existant dans le fichier de t√¢ches.  Cela fonctionne, mais pas tr√®s joli. </li><li>  Vous pouvez utiliser cgexec et sp√©cifier le groupe au d√©marrage du processus.  Cela fonctionne si l'application n'est pas un d√©mon;  De plus, tout cela peut √™tre magnifiquement √©crit dans le script de lancement de l'application. </li><li>  Pour une application qui s'ex√©cute en tant que d√©mon ex√©cutant systemd, vous pouvez cr√©er un fichier de service. </li></ul><br>  Voyons l'option cgexec. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/-w/ha/1y/-wha1yvoitn2e7-r_mlaqlunr-a.png"></div><br>  Nous avons lanc√© foo.exe, √† son tour, il a lanc√© un processus enfant, qui ne fait que charger activement le processeur.  L'option --sticky de la commande cgexec indique que "tout processus enfant doit rester dans le m√™me groupe de contr√¥le que le processus parent".  C'est donc une option importante, et il faut s'en souvenir.  Nous voyons maintenant que deux processus tournent dans notre groupe de contr√¥le et nous connaissons leurs PID.  Jetez un ≈ìil en haut: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tr/x5/83/trx583ix3zsq-c6gawy27bmxibq.png"></div><br>  Comme vous pouvez le voir, le CPU 3 est maintenant charg√© dans les globes oculaires, et le reste se refroidit. <br><br>  Et voici √† quoi ressemble un fichier unit√© pour ex√©cuter la m√™me application qu'un service systemd: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/kx/wn/hv/kxwnhvb_6gwemks5fsoeoi37zpy.png"></div><br>  Il y a trois commandes ExecStartPre dans le fichier d'unit√© qui effectuent les r√©glages que nous avons d√©j√† r√©ussi √† faire avec nos mains.  Vient ensuite la commande ExecStart, qui lance l'application.  Et lorsque l'application s'arr√™te, la commande ExecStopPost se nettoie apr√®s elle-m√™me, supprimant cgroup. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/p2/wy/iw/p2wyiwogovccla42as0jpvwdemk.png"></div><br>  Comme vous pouvez le voir, dans le dernier exemple, nous avons cr√©√© un nouveau groupe de contr√¥le nomm√© set1.  Nous l'avons fait pour montrer que vous pouvez avoir plusieurs groupes de contr√¥le actifs qui partagent le m√™me processeur.  √Ä qui cela peut sembler utile, mais au contraire de confondre quelqu'un. <br><br>  Eh bien, √ßa marche?  Il semble que oui! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pu/8x/7j/pu8x7jr-xhhtk6vayzkfqr0gcou.png"></div><br>  Et maintenant, nous allons terminer le travail de notre service et v√©rifier que cgroup est d√©truit: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cd/qm/et/cdqmetsjwaodwhutwl5okmwob08.png"></div><br>  ATTENTION: les groupes cgroup cr√©√©s √† l'aide de cgcreate ne sont pas enregistr√©s apr√®s le red√©marrage.  Par cons√©quent, la cr√©ation de tels groupes doit √™tre prescrite dans les scripts de d√©marrage et les fichiers d'unit√©. <br><br>  Alors maintenant, dans votre arsenal, il y a quelques autres outils pour travailler avec des groupes de contr√¥le.  Nous esp√©rons qu'ils vous seront utiles! <br><br>  D'autres articles cgroups de notre s√©rie Resource Fight sont disponibles sur: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 1</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">2e partie</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">3e partie</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 4</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 5</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr430748/">https://habr.com/ru/post/fr430748/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr430736/index.html">D√©veloppez votre navigateur √† partir de z√©ro. Premi√®re partie: HTML</a></li>
<li><a href="../fr430738/index.html">Soyez un ninja de la s√©curit√©: niveau secret</a></li>
<li><a href="../fr430740/index.html">Comment traire des vaches avec des robots et faire une startup industrielle dessus. Historique de d√©veloppement de R-SEPT</a></li>
<li><a href="../fr430742/index.html">Olympiade √©tudiante "Je suis un professionnel": direction "Programmation et technologies de l'information"</a></li>
<li><a href="../fr430746/index.html">Pourquoi les batteries Tesla ne fonctionneront pas dans un taxi a√©rien</a></li>
<li><a href="../fr430750/index.html">Les contr√¥leurs quantiques</a></li>
<li><a href="../fr430752/index.html">DEV Labs 2018. Mitap en ligne pour les d√©veloppeurs Web. 1er d√©cembre</a></li>
<li><a href="../fr430754/index.html">Ajoutez de la profondeur aux sprites 2D en utilisant des cartes normales dessin√©es √† la main</a></li>
<li><a href="../fr430756/index.html">Fabrication de la souris WX dans le Nova Slider 600</a></li>
<li><a href="../fr430762/index.html">Comment choisir un onduleur pour optimiser les co√ªts</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>