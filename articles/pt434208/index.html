<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïØÔ∏è üíáüèΩ üñïüèΩ Como foi salvo nossa sexta-feira negra üóæ üöå üë∏üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Anteriormente, falamos sobre como, √† medida que a carga cresceu, abandonamos gradualmente o uso do Python no back-end de servi√ßos cr√≠ticos de produ√ß√£o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como foi salvo nossa sexta-feira negra</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/lamoda/blog/434208/">  Anteriormente, falamos sobre como, √† medida que a carga cresceu, abandonamos gradualmente o uso do Python no back-end de servi√ßos cr√≠ticos de produ√ß√£o, substituindo-o pelo Go.  E hoje eu, Denis Girko, l√≠der da equipe de desenvolvimento Madmin, quero compartilhar detalhes: como e por que isso aconteceu no exemplo de um dos servi√ßos mais importantes para o nosso neg√≥cio - calcular o pre√ßo considerando descontos em cupons. <br><br><img src="https://habrastorage.org/webt/8q/bo/y4/8qboy4stjrxnm432zasibweeyqe.jpeg"><br><a name="habracut"></a><br>  A mec√¢nica de trabalhar com cupons provavelmente √© representada por quem j√° fez compras pelo menos uma vez em lojas on-line.  Em uma p√°gina especial ou diretamente na cesta, voc√™ insere o n√∫mero do cupom e os pre√ßos s√£o recalculados de acordo com o desconto prometido.  O c√°lculo depende do tipo de desconto que o cupom oferece - em porcentagem, na forma de um valor fixo ou usando alguma outra matem√°tica (por exemplo, levamos em considera√ß√£o pontos do programa de fidelidade, promo√ß√µes de lojas, tipos de mercadorias etc.).  Naturalmente, o pedido j√° √© emitido com novos pre√ßos. <br><br>  Os neg√≥cios est√£o encantados com todos esses mecanismos de trabalho com pre√ßos, mas queremos falar sobre o servi√ßo de um ponto de vista um pouco diferente. <br><br><h2>  Como isso funciona </h2><br>  Para os pre√ßos, considerando todas essas dificuldades no back-end, agora temos um servi√ßo separado.  No entanto, ele nem sempre foi independente.  O servi√ßo apareceu um ou dois anos ap√≥s o in√≠cio da loja online e, em 2016, fazia parte de um grande mon√≥lito Python que inclu√≠a uma grande variedade de componentes para atividades de marketing (Madmin).  Posteriormente, ele se destacou como um "bloco" independente, enquanto avan√ßava para a arquitetura de microsservi√ßo. <br><br>  Como √© geralmente o caso dos mon√≥litos, Madmin foi modificado e correspondeu parcialmente a um grande n√∫mero de desenvolvedores.  Bibliotecas de terceiros foram integradas l√°, o que simplificou o desenvolvimento, mas muitas vezes n√£o teve o melhor efeito no desempenho.  No entanto, naquela √©poca, n√£o nos preocup√°vamos realmente com a resist√™ncia a cargas pesadas durante as vendas, pois o servi√ßo fazia um excelente trabalho.  Mas 2016 mudou tudo. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e40/3a3/3e1/e403a33e16fea41905491776c8b0c26e.jpg"><br><br>  Nos EUA, a "Black Friday" √© conhecida desde os anos 60 do s√©culo passado.  Na R√∫ssia, come√ßou a ser lan√ßado na d√©cada de 2010, enquanto a a√ß√£o tinha que ser criada do zero - o mercado n√£o estava pronto para isso.  No entanto, os esfor√ßos dos organizadores n√£o foram em v√£o e, a cada ano, o tr√°fego de usu√°rios em nosso site aumentava durante os dias de vendas.  E, portanto, nossa colis√£o com a carga, excessiva para essa vers√£o do servi√ßo de c√°lculo de pre√ßos, era apenas uma quest√£o de tempo. <br><br><h2>  Sexta-feira negra de 2016. E n√≥s dormimos demais com ela </h2><br>  Como a ideia de venda funcionou em todo o seu potencial, a ‚ÄúBlack Friday‚Äù difere de qualquer outro dia do ano em que, √† meia-noite, uma audi√™ncia semanal aproximadamente do site chega √† loja.  Este √© um per√≠odo dif√≠cil para todos os servi√ßos.  Mesmo naqueles que operam sem problemas ao longo do ano, √†s vezes surgem problemas. <br><br>  Agora estamos nos preparando para cada nova ‚ÄúBlack Friday‚Äù, imitando a carga esperada, mas em 2016 ainda agimos de forma diferente.  Ao testar o Madmin antes de um dia importante, testamos a resist√™ncia √† carga usando cen√°rios de comportamento do usu√°rio em dias regulares.  Como se viu, esse teste n√£o reflete bem a situa√ß√£o real, porque na "Black Friday" h√° muitas pessoas com o mesmo cupom.  Como resultado, o servi√ßo de c√°lculo de pre√ßos que leva em considera√ß√£o esse desconto, incapaz de lidar com uma carga de tr√™s vezes (em compara√ß√£o com os dias normais), bloqueou nossa capacidade de atender os clientes por duas horas no pico mais quente da venda. <br><br>  O servi√ßo "foi" uma hora antes da meia-noite.  Tudo come√ßou com uma interrup√ß√£o na conex√£o com o banco de dados (MySQL naquela √©poca), ap√≥s o qual nem todas as c√≥pias em execu√ß√£o do servi√ßo de c√°lculo de pre√ßos puderam se conectar novamente.  E aqueles que ainda estavam conectados n√£o suportaram a carga e pararam de responder, ficando presos nas travas da base. <br><br>  Por coincid√™ncia, o j√∫nior permaneceu de servi√ßo na √©poca, que no momento da queda do servi√ßo estava a caminho da casa do escrit√≥rio.  Ele s√≥ poderia se conectar ao problema quando chegasse ao local e chamasse a "artilharia pesada" - o oficial de servi√ßo de emerg√™ncia.  Juntos, eles normalizaram a situa√ß√£o, por√©m, somente ap√≥s duas horas. <br><br>  Quando o processo come√ßou, come√ßaram a se abrir detalhes sobre qu√£o sub√≥ptimo era o servi√ßo.  Por exemplo, descobriu-se que, para calcular um cupom, foram feitas 28 consultas no banco de dados (n√£o √© de surpreender que tudo funcionasse com 100% de utiliza√ß√£o da CPU).  Os usu√°rios mencionados acima com o mesmo cupom Black Friday n√£o simplificaram a situa√ß√£o, principalmente porque t√≠nhamos um contador de aplicativos para todos os cupons - portanto, cada uso aumentava a carga consultando esse contador. <br><br>  O ano de 2016 nos proporcionou muita reflex√£o - principalmente sobre como ajustar nosso trabalho com cupons e testes para que essa situa√ß√£o n√£o ocorra novamente.  E em n√∫meros que sexta-feira √© melhor descrita por esta figura: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/75e/310/1fc/75e3101fca74fc4e8b220673619eaada.jpg"><br>  <i>Os resultados da sexta-feira negra de 2016</i> <br><br><h2>  Sexta-feira negra de 2017. Est√°vamos nos preparando seriamente, mas ... </h2><br>  Tendo recebido uma boa li√ß√£o, nos preparamos com anteced√™ncia para a pr√≥xima ‚ÄúBlack Friday‚Äù, reconstruindo e otimizando seriamente o servi√ßo.  Por exemplo, finalmente criamos dois tipos de cupons: limit e ilimitado - para evitar bloqueios no acesso simult√¢neo ao banco de dados, removemos a entrada do banco de dados do script para aplicar o cupom popular.  Paralelamente, 1 a 2 meses antes da Black Friday, passamos do MySQL para o PostgreSQL no servi√ßo, que, juntamente com a otimiza√ß√£o do c√≥digo, reduziu o n√∫mero de chamadas do banco de dados de 28 para 4 a 5. Essas melhorias nos permitiram estender o servi√ßo de teste aos requisitos do SLA - resposta em 3 segundos, percentil 95 a 600 RPS. <br><br>  N√£o tendo id√©ia de quanto nossas melhorias aceleraram o trabalho da vers√£o antiga do servi√ßo em produ√ß√£o, na √©poca duas vers√µes do c√≥digo Python estavam sendo preparadas para a Black Friday de uma s√≥ vez - uma vers√£o existente altamente otimizada e um c√≥digo completamente novo escrito do zero.  Na produ√ß√£o, o segundo foi lan√ßado, que foi testado antes deste dia e noite.  No entanto, como se viu "em batalha", um pouco sub-testado. <br><br>  No dia da "emerg√™ncia", com a chegada do fluxo principal de clientes, a carga no servi√ßo come√ßou a crescer exponencialmente.  Alguns pedidos foram processados ‚Äã‚Äãat√© dois minutos.  Devido ao longo processamento de algumas solicita√ß√µes, a carga em outros trabalhadores aumentou. <br><br>  Nossa principal tarefa era servir um tr√°fego t√£o valioso para os neg√≥cios.  Mas ficou √≥bvio que "fundi√ß√£o com ferro" n√£o resolve o problema e a qualquer momento o n√∫mero de trabalhadores ocupados chegar√° a 100%.  N√£o sabendo ent√£o o que exatamente est√°vamos enfrentando, decidimos ativar o harakiri no uWSGI e simplesmente definir solicita√ß√µes longas (que s√£o processadas por mais de 6 segundos) para liberar recursos para as normais.  E realmente ajudou a resistir - os trabalhadores come√ßaram a ser libertados apenas alguns minutos antes de ficarem completamente exaustos. <br><br>  Um pouco mais tarde, descobrimos a situa√ß√£o ... Aconteceu que eram pedidos com cestas muito grandes - de 40 a 100 mercadorias - e com um cupom espec√≠fico com restri√ß√µes no intervalo.  Essa situa√ß√£o foi mal resolvida pelo novo c√≥digo.  Ele mostrou um trabalho incorreto com a matriz, que se transformou em recurs√£o infinita.  √â curioso que testemos um caso com cestas grandes, mas n√£o em combina√ß√£o com um cupom complicado.  Como solu√ß√£o, simplesmente mudamos para uma vers√£o diferente do c√≥digo.  √â verdade que isso aconteceu tr√™s horas antes do final da sexta-feira negra.  A partir desse momento, todas as cestas come√ßaram a ser processadas corretamente.  E, apesar de termos conclu√≠do o plano de vendas na √©poca, evitamos problemas globais milagrosos devido √† carga cinco vezes no dia normal. <br><br><h2>  Black Friday 2018 </h2><br>  Em 2018, para servi√ßos altamente carregados que atendem ao site, gradualmente come√ßamos a implementar o Go.  Dado o hist√≥rico das sextas-feiras anteriores, o servi√ßo de c√°lculo de descontos foi um dos primeiros candidatos ao processamento. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2f2/257/86a/2f225786a88b927c087c904c36702203.jpg"><br><br>  √â claro que poder√≠amos salvar a vers√£o do Python que j√° foi "testada em batalha" e, antes da nova "Black Friday", poder√≠amos desativar bibliotecas pesadas e lan√ßar c√≥digo n√£o ideal.  No entanto, Golang j√° havia se enraizado nessa √©poca e parecia mais promissor. <br><br>  Mudamos para um novo servi√ßo neste ver√£o; portanto, antes da pr√≥xima venda, conseguimos test√°-lo bem, inclusive com um perfil de carga crescente. <br><br>  Durante os testes, verificou-se que a fraqueza em termos de altas cargas continua sendo nossa base.  Transa√ß√µes muito longas levaram ao fato de que selecionamos todo o conjunto de conex√µes e as solicita√ß√µes foram enfileiradas.  Portanto, tivemos que refazer um pouco a l√≥gica do aplicativo, reduzindo ao m√≠nimo o uso do banco de dados (referindo-se a ele apenas quando n√£o h√° nada a ver sem ele) e armazenando em cache os diret√≥rios do banco de dados e os dados dos cupons populares na Black Friday. <br><br>  √â verdade que este ano nos enganamos com as previs√µes de carga para cima: est√°vamos nos preparando para um aumento de 6 a 8 vezes nos picos e obtivemos um bom trabalho de servi√ßos apenas para esse volume de solicita√ß√µes (caches adicionais, fun√ß√µes experimentais desativadas antecipadamente, simplificamos algumas coisas, implementamos n√≥s adicionais do Kubernetes e at√© servidores de banco de dados para r√©plicas, que no final n√£o eram necess√°rias).  De fato, o aumento no interesse do usu√°rio foi menor, ent√£o tudo correu normalmente.  O tempo de resposta do servi√ßo n√£o excedeu 50 ms no percentil 95. <br><br>  Para n√≥s, uma das caracter√≠sticas mais importantes √© como o aplicativo √© escalado quando n√£o h√° recursos suficientes para uma c√≥pia.  O Go usa recursos de hardware com mais efici√™ncia, portanto, com a mesma carga, voc√™ precisa executar menos c√≥pias (atendendo a mais solicita√ß√µes nos mesmos recursos de hardware).  Este ano, no auge da venda, estavam funcionando 16 inst√¢ncias do aplicativo, que processavam uma m√©dia de 300 solicita√ß√µes por segundo com picos de at√© 400 solicita√ß√µes por segundo, aproximadamente duas vezes maior que a carga usual.  Observe que no ano passado, um servi√ßo Python exigiu 102 inst√¢ncias. <br><br>  Parece que o servi√ßo Go desde a primeira abordagem fechou todas as nossas necessidades.  Mas Golang n√£o √© uma "solu√ß√£o completa para todos os problemas".  N√£o poderia prescindir de alguns recursos.  Por exemplo, tivemos que limitar o n√∫mero de encadeamentos que o servi√ßo pode iniciar no n√≥ do multiprocessador Kubernetes, para que, ao dimension√°-lo, n√£o interfira nos aplicativos "vizinhos" na produ√ß√£o (por padr√£o, o Go n√£o tem limite de quantos processadores ser√£o necess√°rios).  Para isso, definimos o GOMAXPROCS em todos os aplicativos em movimento.  Teremos o maior prazer em comentar o qu√£o √∫til isso foi - em nossa equipe, essa foi apenas uma das hip√≥teses sobre como lidar com a degrada√ß√£o dos "vizinhos". <br><br>  Outra "configura√ß√£o" √© o n√∫mero de conex√µes mantidas como Keep-Alive.  Clientes HTTP e DB regulares no Go, por padr√£o, mant√™m apenas duas conex√µes; portanto, se houver muitas solicita√ß√µes simult√¢neas e voc√™ precisar economizar no tr√°fego da configura√ß√£o da conex√£o TCP, faz sentido aumentar esse valor configurando MaxIdleConnsPerHost e SetMaxIdleConns, respectivamente. <br><br>  No entanto, mesmo com essas ‚Äúreviravoltas‚Äù manuais, a Golang nos forneceu uma grande margem de desempenho para vendas futuras. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt434208/">https://habr.com/ru/post/pt434208/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt434196/index.html">3CX v16 Alpha 2 e planos para o novo ano</a></li>
<li><a href="../pt434198/index.html">Escolhendo um modo operacional de servidor da Web com base na experi√™ncia pessoal</a></li>
<li><a href="../pt434200/index.html">A ferrugem √© t√£o terr√≠vel quanto √© pintada</a></li>
<li><a href="../pt434202/index.html">4 segredos sobre como n√£o perder o emprego na ci√™ncia de dados</a></li>
<li><a href="../pt434206/index.html">Distribuidor de jato ok.ru/music</a></li>
<li><a href="../pt434210/index.html">An√°lise do concurso de question√°rios Android do estande do HeadHunter no Mobius 2018 Moscow</a></li>
<li><a href="../pt434212/index.html">Torre Tesla. O que acontece dentro e perto de um arranha-c√©u quando um raio cai?</a></li>
<li><a href="../pt434214/index.html">Proxy din√¢mico Java: o que √© e como us√°-lo?</a></li>
<li><a href="../pt434216/index.html">Ataques de for√ßa bruta usando o Kali Linux</a></li>
<li><a href="../pt434218/index.html">Simples clicker bot Java no exemplo do jogo World of Warcraft 3.3.5a</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>