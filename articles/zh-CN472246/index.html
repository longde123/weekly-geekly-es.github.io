<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ“¯ ğŸŒƒ ğŸ‘¾ React + IndexDb +è‡ªåŠ¨æ›´æ–°=å‡ ä¹æ˜¯AsyncRedux ğŸ–¤ ğŸ§šğŸ¿ ğŸµï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†é€æ­¥å‘Šè¯‰æ‚¨å¦‚ä½•å‡†å¤‡IndexDBï¼ˆä»»ä½•ç°ä»£æµè§ˆå™¨ä¸­å†…ç½®çš„æ•°æ®åº“ï¼‰ä»¥ç”¨äºç”¨ReactJSç¼–å†™çš„é¡¹ç›®ä¸­ã€‚ ç»“æœï¼Œæ‚¨å¯ä»¥åƒä½¿ç”¨åº”ç”¨ç¨‹åºçš„Reduxå­˜å‚¨ä¸€æ ·æ–¹ä¾¿åœ°ä½¿ç”¨IndexDBä¸­çš„æ•°æ®ã€‚ 

 IndexDBæ˜¯é¢å‘æ–‡æ¡£çš„ DBMSï¼Œè¿™æ˜¯ä¸€ç§æ–¹ä¾¿çš„å·¥å…·ï¼Œç”¨äºåœ¨æµè§ˆå™¨ç«¯ä¸´æ—¶å­˜å‚¨ç›¸å¯¹å°‘é‡ï¼ˆå•ä½å’Œ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>React + IndexDb +è‡ªåŠ¨æ›´æ–°=å‡ ä¹æ˜¯AsyncRedux</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472246/"><img width="300" align="right" src="https://habrastorage.org/webt/ak/5r/t4/ak5rt4e4mavxwvxlaidpfgiie0g.jpeg"> åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†é€æ­¥å‘Šè¯‰æ‚¨å¦‚ä½•å‡†å¤‡IndexDBï¼ˆä»»ä½•ç°ä»£æµè§ˆå™¨ä¸­å†…ç½®çš„æ•°æ®åº“ï¼‰ä»¥ç”¨äºç”¨ReactJSç¼–å†™çš„é¡¹ç›®ä¸­ã€‚ ç»“æœï¼Œæ‚¨å¯ä»¥åƒä½¿ç”¨åº”ç”¨ç¨‹åºçš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">Reduxå­˜å‚¨</a>ä¸€æ ·æ–¹ä¾¿åœ°ä½¿ç”¨IndexDBä¸­çš„æ•°æ®ã€‚ <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">IndexDB</a>æ˜¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">é¢å‘</a>æ–‡æ¡£<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">çš„</a> DBMSï¼Œè¿™æ˜¯ä¸€ç§æ–¹ä¾¿çš„å·¥å…·ï¼Œç”¨äºåœ¨æµè§ˆå™¨ç«¯ä¸´æ—¶å­˜å‚¨ç›¸å¯¹å°‘é‡ï¼ˆå•ä½å’Œæ•°<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">åå…†</a>å­—èŠ‚ï¼‰çš„ç»“æ„åŒ–æ•°æ®ã€‚ æˆ‘å¿…é¡»ä½¿ç”¨IndexDBçš„æ ‡å‡†ä»»åŠ¡åŒ…æ‹¬åœ¨å®¢æˆ·ç«¯ç¼“å­˜ä¸šåŠ¡ç›®å½•çš„æ•°æ®ï¼ˆå›½å®¶/åœ°åŒºåç§°ï¼ŒåŸå¸‚åç§°ï¼ŒæŒ‰ä»£ç æ˜¾ç¤ºçš„è´§å¸ç­‰ï¼‰ã€‚ å°†å®ƒä»¬å¤åˆ¶åˆ°å®¢æˆ·ç«¯åï¼Œæ‚¨åªèƒ½å¶å°”ä»æœåŠ¡å™¨ï¼ˆæˆ–æ•´ä¸ªç›®å½•-å¾ˆå°ï¼‰ä»è¿™äº›ç›®å½•ä¸‹è½½æ›´æ–°ï¼Œè€Œä¸æ˜¯æ¯æ¬¡æ‰“å¼€æµè§ˆå™¨çª—å£æ—¶éƒ½æ‰§è¡Œæ­¤æ“ä½œã€‚ <br><a name="habracut"></a><br> æœ‰ä¸€äº›éæ ‡å‡†çš„ï¼Œå¾ˆæœ‰äº‰è®®çš„ä½†ä½¿ç”¨IndexDBçš„å¯è¡Œæ–¹æ³•ï¼š <br><br><ul><li> ç¼“å­˜æœ‰å…³<b>æ‰€æœ‰</b>ä¸šåŠ¡å¯¹è±¡çš„æ•°æ®ï¼Œä»¥ä¾¿åœ¨æµè§ˆå™¨ç«¯ä½¿ç”¨å¹¿æ³›çš„æ’åºå’Œè¿‡æ»¤åŠŸèƒ½ </li><li> å°†åº”ç”¨ç¨‹åºçŠ¶æ€å­˜å‚¨åœ¨IndexDBä¸­è€Œä¸æ˜¯Redux Storeä¸­ </li></ul><br>  IndexDBå’ŒRedux Storeä¹‹é—´çš„ä¸‰ä¸ªä¸»è¦åŒºåˆ«å¯¹æˆ‘ä»¬å¾ˆé‡è¦ï¼š <br><br><ol><li>  IndexDBæ˜¯ä¸€ä¸ªå¤–éƒ¨å­˜å‚¨ï¼Œç¦»å¼€é¡µé¢æ—¶ä¸ä¼šæ¸…é™¤ã€‚ æ­¤å¤–ï¼Œå¤šä¸ªæ‰“å¼€çš„æ ‡ç­¾é¡µä¹Ÿæ˜¯ä¸€æ ·çš„ï¼ˆæœ‰æ—¶ä¼šå¯¼è‡´æŸäº›æ„å¤–æƒ…å†µï¼‰ </li><li>  IndexDBæ˜¯ä¸€ä¸ªå®Œå…¨å¼‚æ­¥çš„DBMSã€‚ æ‰€æœ‰æ“ä½œ-æ‰“å¼€ï¼Œè¯»å–ï¼Œå†™å…¥ï¼Œæœç´¢-å¼‚æ­¥ã€‚ </li><li>  IndexDBä¸èƒ½ï¼ˆä»¥ç®€å•çš„æ–¹å¼ï¼‰å­˜å‚¨åœ¨JSONä¸­ï¼Œå¹¶ä¸”ä¸èƒ½ä½¿ç”¨Reduxçš„è„‘åŠ›æ¿€è¡æŠ€æœ¯æ¥åˆ›å»ºSnapshotsï¼Œè°ƒè¯•æ–¹ä¾¿ä»¥åŠè¿‡å»çš„æ—…ç¨‹ã€‚ </li></ol><br><h2> æ­¥éª¤0ï¼šä»»åŠ¡åˆ—è¡¨ </h2><br> å·²ç»æ˜¯å¸¦æœ‰ä»»åŠ¡åˆ—è¡¨çš„ç»å…¸ç¤ºä¾‹ã€‚ åœ¨å½“å‰å’Œå”¯ä¸€ç»„ä»¶çš„çŠ¶æ€ä¸‹å…·æœ‰çŠ¶æ€å­˜å‚¨çš„å˜ä½“ <br><br><div class="spoiler">  <b class="spoiler_title">ä»»åŠ¡åˆ—è¡¨ç»„ä»¶çš„å®ç°ï¼Œè¯¥ä»»åŠ¡åˆ—è¡¨ç»„ä»¶ä»¥ç»„ä»¶çŠ¶æ€å­˜å‚¨åˆ—è¡¨</b> <div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React, { PureComponent } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Button <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-bootstrap/Button'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> counter <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'common/counter'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Form <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-bootstrap/Form'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Table <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-bootstrap/Table'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Step0</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PureComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>( ...arguments ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state = { <span class="hljs-attr"><span class="hljs-attr">newTaskText</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: counter(), <span class="hljs-attr"><span class="hljs-attr">text</span></span>: <span class="hljs-string"><span class="hljs-string">'Sample task'</span></span> }, ], }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleAdd = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function"> =&gt;</span></span> ( { <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: [ ...state.tasks, { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: counter(), <span class="hljs-attr"><span class="hljs-attr">text</span></span>: state.newTaskText } ], <span class="hljs-attr"><span class="hljs-attr">newTaskText</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, } ) ); }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleDeleteF = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">idToDelete</span></span></span><span class="hljs-function"> =&gt;</span></span> () =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function"> =&gt;</span></span> ( { <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: state.tasks.filter( <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> { id } </span></span></span><span class="hljs-function">) =&gt;</span></span> id !== idToDelete ), } ) ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleNewTaskTextChange = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> { target: { value } } </span></span></span><span class="hljs-function">) =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( { <span class="hljs-attr"><span class="hljs-attr">newTaskText</span></span>: value || <span class="hljs-string"><span class="hljs-string">''</span></span>, } ); } render() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Table</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">bordered</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">hover</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">striped</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">thead</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">th</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">#</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">th</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">th</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Text</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">th</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">th</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">thead</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">tbody</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> { this.state.tasks.map( task =&gt; </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{task.id}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">{task.id}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">{task.text}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.handleDeleteF(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">task.id</span></span></span></span><span class="xml"><span class="hljs-tag"> )} </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"button"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">variant</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"danger"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ) } </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"+1"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Form.Control</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onChange</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.handleNewTaskTextChange}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">placeholder</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"  "</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.state.newTaskText</span></span></span></span><span class="xml"><span class="hljs-tag"> || ''} /&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.handleAdd}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"button"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">variant</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"primary"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">tbody</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Table</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">; } }</span></span></code> </pre>  ï¼ˆ <a href="" rel="nofollow">githubæºä»£ç </a> ï¼‰ </div></div><br> åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ‰€æœ‰å¸¦ä»»åŠ¡çš„æ“ä½œéƒ½æ˜¯åŒæ­¥çš„ã€‚ å¦‚æœæ·»åŠ ä»»åŠ¡éœ€è¦3ç§’é’Ÿï¼Œé‚£ä¹ˆæµè§ˆå™¨å°†å†»ç»“3ç§’é’Ÿã€‚ å½“ç„¶ï¼Œè™½ç„¶æˆ‘ä»¬å°†æ‰€æœ‰å†…å®¹éƒ½ä¿ç•™åœ¨å†…å­˜ä¸­ï¼Œä½†æˆ‘ä»¬æ— æ³•è€ƒè™‘å®ƒã€‚ å½“æˆ‘ä»¬ä½¿ç”¨æœåŠ¡å™¨æˆ–æœ¬åœ°æ•°æ®åº“è¿›è¡Œå¤„ç†æ—¶ï¼Œæˆ‘ä»¬è¿˜å¿…é¡»æ³¨æ„å¼‚æ­¥å¤„ç†çš„ä¼˜ç¾æ€§ã€‚ ä¾‹å¦‚ï¼Œåœ¨æ·»åŠ æˆ–åˆ é™¤å…ƒç´ æ—¶é˜»æ­¢ä½¿ç”¨è¡¨ï¼ˆæˆ–å•ä¸ªå…ƒç´ ï¼‰ã€‚ <br><br> ä¸ºäº†ä»¥åä¸å†é‡å¤å¯¹UIçš„æè¿°ï¼Œæˆ‘ä»¬å°†å…¶æ”¾ç½®åœ¨å•ç‹¬çš„TaskListç»„ä»¶ä¸­ï¼Œè¯¥ç»„ä»¶çš„å”¯ä¸€ä»»åŠ¡å°†ä¸ºä»»åŠ¡åˆ—è¡¨ç”ŸæˆHTMLä»£ç ã€‚ åŒæ—¶ï¼Œæˆ‘ä»¬å°†ç”¨å¼•å¯¼ç¨‹åºæŒ‰é’®å‘¨å›´çš„ç‰¹æ®ŠåŒ…è£…æ›¿æ¢å¸¸è§„æŒ‰é’®ï¼Œè¯¥åŒ…è£…å°†é˜»å¡æŒ‰é’®ï¼Œç›´åˆ°æŒ‰é’®å¤„ç†ç¨‹åºå®Œæˆå…¶æ‰§è¡Œï¼Œå³ä½¿è¯¥å¤„ç†ç¨‹åºæ˜¯å¼‚æ­¥å‡½æ•°ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">å®ç°ä»¥ååº”çŠ¶æ€å­˜å‚¨ä»»åŠ¡åˆ—è¡¨çš„ç»„ä»¶</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React, { PureComponent } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> counter <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'common/counter'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TaskList <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/TaskList'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Step01</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PureComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>( ...arguments ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state = { <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: counter(), <span class="hljs-attr"><span class="hljs-attr">text</span></span>: <span class="hljs-string"><span class="hljs-string">'Sample task'</span></span> }, ] }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleAdd = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newTaskText</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function"> =&gt;</span></span> ( { <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: [ ...state.tasks, { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: counter(), <span class="hljs-attr"><span class="hljs-attr">text</span></span>: newTaskText } ], } ) ); }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleDelete = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">idToDelete</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function"> =&gt;</span></span> ( { <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: state.tasks.filter( <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> { id } </span></span></span><span class="hljs-function">) =&gt;</span></span> id !== idToDelete ), } ) ); } render() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> &lt;&gt; &lt;h1&gt;      &lt;/h1&gt; &lt;h2&gt;       &lt;/h2&gt; &lt;TaskList onAdd={this.handleAdd} onDelete={this.handleDelete} tasks={this.state.tasks} /&gt; &lt;/&gt;; } }</code> </pre>  ï¼ˆ <a href="" rel="nofollow">githubæºä»£ç </a> ï¼‰ </div></div><br><div class="spoiler">  <b class="spoiler_title">ä¸€ä¸ªç»„ä»¶çš„å®ç°ï¼Œè¯¥ç»„ä»¶æ˜¾ç¤ºä»»åŠ¡åˆ—è¡¨å¹¶åŒ…å«ç”¨äºæ·»åŠ æ–°ä»»åŠ¡çš„è¡¨å•</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React, { PureComponent } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Button <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./AutoDisableButtonWithSpinner'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Form <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-bootstrap/Form'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Table <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-bootstrap/Table'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TaskList</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PureComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>( ...arguments ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state = { <span class="hljs-attr"><span class="hljs-attr">newTaskAdding</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">newTaskText</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleAdd = <span class="hljs-keyword"><span class="hljs-keyword">async</span></span>() =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( { <span class="hljs-attr"><span class="hljs-attr">newTaskAdding</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } ); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">//   ,     await this.props.onAdd( this.state.newTaskText ); this.setState( { newTaskText: '' } ); } finally { this.setState( { newTaskAdding: false } ); } }; this.handleDeleteF = idToDelete =&gt; async() =&gt; await this.props.onDelete( idToDelete ); this.handleNewTaskTextChange = ( { target: { value } } ) =&gt; this.setState( { newTaskText: value || '', } ); } render() { return &lt;Table bordered hover striped&gt; &lt;thead&gt;&lt;tr&gt; &lt;th&gt;#&lt;/th&gt;&lt;th&gt;Text&lt;/th&gt;&lt;th /&gt; &lt;/tr&gt;&lt;/thead&gt; &lt;tbody&gt; { this.props.tasks.map( task =&gt; &lt;tr key={task.id}&gt; &lt;td&gt;{task.id}&lt;/td&gt; &lt;td&gt;{task.text}&lt;/td&gt; &lt;td&gt;&lt;Button onClick={this.handleDeleteF( task.id )} type="button" variant="danger"&gt;&lt;/Button&gt;&lt;/td&gt; &lt;/tr&gt; ) } &lt;tr key="+1"&gt; &lt;td /&gt; &lt;td&gt;&lt;Form.Control disabled={this.state.newTaskAdding} onChange={this.handleNewTaskTextChange} placeholder="  " type="text" value={this.state.newTaskText || ''} /&gt;&lt;/td&gt; &lt;td&gt;&lt;Button onClick={this.handleAdd} type="button" variant="primary"&gt;&lt;/Button&gt;&lt;/td&gt; &lt;/tr&gt; &lt;/tbody&gt; &lt;/Table&gt;; } }</span></span></code> </pre>  ï¼ˆ <a href="" rel="nofollow">githubæºä»£ç </a> ï¼‰ </div></div><br> åœ¨ç¤ºä¾‹ä»£ç ä¸­ï¼Œæ‚¨å·²ç»å¯ä»¥çœ‹åˆ°å…³é”®å­—async / awaitã€‚ å¼‚æ­¥/ç­‰å¾…æ„é€ å¯ä»¥å¤§å¤§å‡å°‘å¯ç”¨äºPromisesçš„ä»£ç é‡ã€‚ å…³é”®å­—awaitå…è®¸æ‚¨ç­‰å¾…è¿”å›Promiseçš„å‡½æ•°çš„å“åº”ï¼Œå°±å¥½åƒå®ƒæ˜¯å¸¸è§„å‡½æ•°ä¸€æ ·ï¼ˆè€Œä¸æ˜¯åœ¨thenï¼ˆï¼‰ä¸­ç­‰å¾…ç»“æœï¼‰ã€‚ å½“ç„¶ï¼Œå¼‚æ­¥å‡½æ•°ä¸ä¼šç¥å¥‡åœ°å˜æˆåŒæ­¥å‡½æ•°ï¼Œä¾‹å¦‚ï¼Œå½“ä½¿ç”¨awaitæ—¶ï¼Œæ‰§è¡Œçº¿ç¨‹å°†è¢«ä¸­æ–­ã€‚ ä½†æ˜¯éšåä»£ç å˜å¾—æ›´åŠ ç®€æ´æ˜“æ‡‚ï¼Œå¹¶ä¸”å¯ä»¥åœ¨å¾ªç¯å’Œtry / catch / finallyç»“æ„ä¸­ä½¿ç”¨awaitã€‚ <br><br> ä¾‹å¦‚ï¼Œ <a href="" rel="nofollow"><code> TaskList</code>è°ƒç”¨</a> <code>this.props.onAdd</code>å¤„ç†ç¨‹åºï¼Œè€Œä¸”ä½¿ç”¨<code>await</code>å…³é”®å­—è¿›è¡Œ<a href="" rel="nofollow">è°ƒç”¨</a> ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœå¤„ç†ç¨‹åºæ˜¯å°†ä¸è¿”å›ä»»ä½•å†…å®¹æˆ–è¿”å›é™¤<code>Promise</code>ä¹‹å¤–çš„ä»»ä½•å€¼çš„æ™®é€šå‡½æ•°ï¼Œåˆ™<code>TaskList</code>ç»„ä»¶<code>TaskList</code> <code>handleAdd</code>å¸¸è§„æ–¹å¼ç»§ç»­æ‰§è¡Œ<code>handleAdd</code>æ–¹æ³•ã€‚ ä½†æ˜¯ï¼Œå¦‚æœå¤„ç†ç¨‹åºè¿”å›<code>Promise</code> ï¼ˆåŒ…æ‹¬å¦‚æœå°†å¤„ç†ç¨‹åºå£°æ˜ä¸ºå¼‚æ­¥å‡½æ•°ï¼‰ï¼Œåˆ™<code>TaskList</code>å°†ç­‰å¾…å¤„ç†ç¨‹åºå®Œæˆæ‰§è¡Œï¼Œç„¶åæ‰é‡ç½®<code>newTaskAdding</code>å’Œ<code>newTaskText</code> ã€‚ <br><br><h2> æ­¥éª¤1ï¼šå°†IndexDBæ·»åŠ åˆ°Reactç»„ä»¶ </h2><br> ä¸ºäº†ç®€åŒ–æˆ‘ä»¬çš„å·¥ä½œï¼Œé¦–å…ˆæˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ªç®€å•çš„ç»„ä»¶æ¥å®ç°Promiseæ–¹æ³•ï¼š <br><br><ul><li> æ‰“å¼€æ•°æ®åº“ä»¥åŠç®€å•çš„é”™è¯¯å¤„ç† </li><li> åœ¨æ•°æ®åº“ä¸­æœç´¢é¡¹ç›® </li><li> å°†é¡¹ç›®æ·»åŠ åˆ°æ•°æ®åº“ </li></ul><br> ç¬¬ä¸€ä¸ªæ˜¯æœ€â€œå¹³å‡¡çš„â€-å¤šè¾¾5ä¸ªäº‹ä»¶å¤„ç†ç¨‹åºã€‚ ä½†æ˜¯ï¼Œæ²¡æœ‰ç«ç®­ç§‘å­¦ï¼š <br><br><div class="spoiler">  <b class="spoiler_title">openDatabasePromiseï¼ˆï¼‰-æ‰“å¼€æ•°æ®åº“</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">openDatabasePromise</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> keyPath </span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>( <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> resolve, reject </span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> dbOpenRequest = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.indexedDB.open( DB_NAME, <span class="hljs-string"><span class="hljs-string">'1.0.0'</span></span> ); dbOpenRequest.onblocked = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { reject( <span class="hljs-string"><span class="hljs-string">'    ,    , '</span></span> + <span class="hljs-string"><span class="hljs-string">'      .'</span></span> ); }; dbOpenRequest.onerror = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log( <span class="hljs-string"><span class="hljs-string">'Unable to open indexedDB '</span></span> + DB_NAME ); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log( err ); reject( <span class="hljs-string"><span class="hljs-string">'   ,       .'</span></span> + <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> err.message ? </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">' : '</span></span></span></span><span class="hljs-function"><span class="hljs-params"> + err.message : </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">) ); }; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dbOpenRequest</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">onupgradeneeded</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> db = event.target.result; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { db.deleteObjectStore( OBJECT_STORE_NAME ); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> ( err ) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log( err ); } db.createObjectStore( OBJECT_STORE_NAME, { keyPath } ); }; dbOpenRequest.onsuccess = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.info( <span class="hljs-string"><span class="hljs-string">'Successfully open indexedDB connection to '</span></span> + DB_NAME ); resolve( dbOpenRequest.result ); }; dbOpenRequest.onerror = reject; } ); }</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">getAllPromise / getPromise / putPromise-Promiseä¸­çš„åŒ…è£…å™¨IndexDbè°ƒç”¨</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    ObjectStore,   IDBRequest //     Promise function wrap( methodName ) { return function() { const [ objectStore, ...etc ] = arguments; return new Promise( ( resolve, reject ) =&gt; { const request = objectStore[ methodName ]( ...etc ); request.onsuccess = () =&gt; resolve( request.result ); request.onerror = reject; } ); }; } const deletePromise = wrap( 'delete' ); const getAllPromise = wrap( 'getAll' ); const getPromise = wrap( 'get' ); const putPromise = wrap( 'put' ); }</span></span></code> </pre></div></div><br> å°†æ‰€æœ‰å†…å®¹æ”¾åˆ°ä¸€ä¸ªIndexedDbRepositoryç±»ä¸­ <br><br><div class="spoiler">  <b class="spoiler_title">IndexedDbRepository-IDBDatabaseçš„åŒ…è£…å™¨</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DB_NAME = <span class="hljs-string"><span class="hljs-string">'objectStore'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> OBJECT_STORE_NAME = <span class="hljs-string"><span class="hljs-string">'objectStore'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IndexedDbRepository</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( keyPath ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.error = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.keyPath = keyPath; <span class="hljs-comment"><span class="hljs-comment">//     async //      this.openDatabasePromise = this._openDatabase(); } async _openDatabase( keyPath ) { try { this.dbConnection = await openDatabasePromise( keyPath ); } catch ( error ) { this.error = error; throw error; } } async _tx( txMode, callback ) { await this.openDatabasePromise; // await db connection const transaction = this.dbConnection.transaction( [ OBJECT_STORE_NAME ], txMode ); const objectStore = transaction.objectStore( OBJECT_STORE_NAME ); return await callback( objectStore ); } async findAll() { return this._tx( 'readonly', objectStore =&gt; getAllPromise( objectStore ) ); } async findById( key ) { return this._tx( 'readonly', objectStore =&gt; getPromise( objectStore, key ) ); } async deleteById( key ) { return this._tx( 'readwrite', objectStore =&gt; deletePromise( objectStore, key ) ); } async save( item ) { return this._tx( 'readwrite', objectStore =&gt; putPromise( objectStore, item ) ); } }</span></span></code> </pre>  ï¼ˆ <a href="" rel="nofollow">githubæºä»£ç </a> ï¼‰ </div></div><br> ç°åœ¨æ‚¨å¯ä»¥ä»ä»£ç è®¿é—®IndexDBï¼š <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IndexedDbRepository( <span class="hljs-string"><span class="hljs-string">'id'</span></span> ); <span class="hljs-comment"><span class="hljs-comment">// ,     await db.save( { id: 42, text: 'Task text' } ); const item = await db.findById( 42 ); const items = await db.findAll();</span></span></code> </pre><br> å°†æ­¤â€œå­˜å‚¨åº“â€è¿æ¥åˆ°æˆ‘ä»¬çš„ç»„ä»¶ã€‚ æ ¹æ®ååº”è§„åˆ™ï¼Œå¯¹æœåŠ¡å™¨çš„è°ƒç”¨åº”åœ¨componentDidMountï¼ˆï¼‰æ–¹æ³•ä¸­ï¼š <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> IndexedDbRepository <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/IndexedDbRepository'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> componentDidMount() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repository = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IndexedDbRepository( <span class="hljs-string"><span class="hljs-string">'id'</span></span> ); <span class="hljs-comment"><span class="hljs-comment">//     this.repository.findAll().then( tasks =&gt; this.setState( { tasks } ) ); }</span></span></code> </pre><br> ä»ç†è®ºä¸Šè®²ï¼Œå¯ä»¥å°†<code>componentDidMount()</code>å‡½æ•°å£°æ˜ä¸ºå¼‚æ­¥ï¼Œç„¶åå¯ä»¥ä½¿ç”¨async / awaitæ„é€ ä»£æ›¿thenï¼ˆï¼‰ã€‚ ä½†æ˜¯<code>componentDidMount()</code>ä»ç„¶ä¸æ˜¯â€œæˆ‘ä»¬çš„â€å‡½æ•°ï¼Œè€Œæ˜¯è¢«Reactè°ƒç”¨ã€‚ è°çŸ¥é“react 17.xåº“å°†å¦‚ä½•å“åº”å°è¯•è¿”å›<code>Promise</code>è€Œä¸æ˜¯<code>undefined</code> ï¼Ÿ <br><br> ç°åœ¨åœ¨æ„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å°†ç”¨nullå¡«å……å®ƒï¼Œè€Œä¸æ˜¯ç”¨ç©ºæ•°ç»„ï¼ˆæˆ–åŒ…å«æµ‹è¯•æ•°æ®çš„æ•°ç»„ï¼‰å¡«å……å®ƒã€‚ åœ¨æ¸²æŸ“ä¸­ï¼Œå®ƒå°†æ ¹æ®éœ€è¦ç­‰å¾…æ•°æ®å¤„ç†çš„æƒ…å†µæ¥å¤„ç†æ­¤nullã€‚ åŸåˆ™ä¸Šå¸Œæœ›è¿™æ ·åšçš„äººå¯ä»¥å°†å…¶æ”¾åœ¨å•ç‹¬çš„æ ‡è®°ä¸­ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆè¦äº§ç”Ÿå®ä½“ï¼Ÿ <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>( ...arguments ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state = { <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> }; <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> } <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> render() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state.tasks === <span class="hljs-literal"><span class="hljs-literal">null</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> &lt;&gt;&lt;Spinner animation="border" aria-hidden="true" as="span" role="status" /&gt;&lt;span&gt;  ...&lt;/span&gt;&lt;/&gt;; /* ... */ }</code> </pre><br> å®ƒä»ç„¶éœ€è¦å®ç°<code>handleAdd</code> / <code>handleDelete</code> ï¼š <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleAdd = <span class="hljs-keyword"><span class="hljs-keyword">async</span></span>( newTaskText ) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repository.save( { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: counter(), <span class="hljs-attr"><span class="hljs-attr">text</span></span>: newTaskText } ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( { <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> } ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( { <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repository.findAll() } ); }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleDelete = <span class="hljs-keyword"><span class="hljs-keyword">async</span></span>( idToDelete ) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repository.deleteById( idToDelete ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( { <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> } ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( { <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repository.findAll() } ); }; }</code> </pre><br> åœ¨è¿™ä¸¤ä¸ªå¤„ç†ç¨‹åºä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆè½¬åˆ°å­˜å‚¨åº“ä»¥æ·»åŠ æˆ–åˆ é™¤é¡¹ç›®ï¼Œç„¶åæ¸…é™¤å½“å‰ç»„ä»¶çš„çŠ¶æ€ï¼Œç„¶åå†æ¬¡ä»å­˜å‚¨åº“ä¸­è¯·æ±‚æ–°åˆ—è¡¨ã€‚ ä¼¼ä¹å¯¹setStateï¼ˆï¼‰çš„è°ƒç”¨å°†ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°è¿›è¡Œã€‚ ä½†æ˜¯ï¼Œå¤„ç†ç¨‹åºæœ€åå‡ è¡Œä¸­çš„awaitå…³é”®å­—ä»…åœ¨ä»findAllï¼ˆï¼‰æ–¹æ³•è·å¾—çš„Promiseï¼ˆï¼‰è¢«è§£æä¹‹åæ‰å¯¼è‡´ç¬¬äºŒä¸ªsetStateï¼ˆï¼‰è°ƒç”¨å‘ç”Ÿã€‚ <br><br><h2> æ­¥éª¤2.è†å¬å˜æ›´ </h2><br> ä¸Šé¢ä»£ç ä¸­çš„ä¸€ä¸ªå¤§ç¼ºé™·æ˜¯ï¼Œé¦–å…ˆï¼Œå­˜å‚¨åº“è¿æ¥åœ¨æ¯ä¸ªç»„ä»¶ä¸­ã€‚ å…¶æ¬¡ï¼Œå¦‚æœä¸€ä¸ªç»„ä»¶æ›´æ”¹äº†å­˜å‚¨åº“çš„å†…å®¹ï¼Œé‚£ä¹ˆå¦ä¸€ç»„ä»¶å°†ä¸çŸ¥é“å®ƒï¼Œç›´åˆ°å®ƒç”±äºä»»ä½•ç”¨æˆ·æ“ä½œè€Œé‡æ–°è¯»å–çŠ¶æ€ä¸ºæ­¢ã€‚ è¿™å¾ˆä¸æ–¹ä¾¿ã€‚ <br><br> ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°†å¼•å…¥æ–°çš„RepositoryListenerç»„ä»¶ï¼Œå¹¶ä½¿å…¶åšä¸¤ä»¶äº‹ã€‚ é¦–å…ˆï¼Œè¯¥ç»„ä»¶å°†èƒ½å¤Ÿè®¢é˜…å­˜å‚¨åº“ä¸­çš„æ›´æ”¹ã€‚ å…¶æ¬¡ï¼ŒRepositoryListenerå°†è¿™äº›æ›´æ”¹é€šçŸ¥åˆ›å»ºå®ƒçš„ç»„ä»¶ã€‚ <br><br> é¦–å…ˆï¼Œæ·»åŠ äº†åœ¨IndexedDbRepositoryä¸­æ³¨å†Œå¤„ç†ç¨‹åºçš„åŠŸèƒ½ï¼š <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IndexedDbRepository</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( keyPath ) { <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.stamp = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> } <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> addListener( listener ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners.add( listener ); } onChange() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.stamp++; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners.forEach( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">listener</span></span></span><span class="hljs-function"> =&gt;</span></span> listener( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.stamp ) ); } removeListener( listener ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners.delete( listener ); } }</code> </pre><br>  ï¼ˆ <a href="" rel="nofollow">githubæºä»£ç </a> ï¼‰ <br><br> æˆ‘ä»¬å°†å‘å¤„ç†ç¨‹åºä¼ é€’ä¸€ä¸ªæˆ³è®°ï¼Œè¯¥æˆ³è®°å°†åœ¨æ¯æ¬¡è°ƒç”¨onChangeï¼ˆï¼‰æ—¶æ›´æ”¹ã€‚ ç„¶åï¼Œæˆ‘ä»¬ä¿®æ”¹_txæ–¹æ³•ï¼Œä»¥ä¾¿åœ¨å…·æœ‰<code>readwrite</code>æ¨¡å¼çš„äº‹åŠ¡ä¸­ä¸ºæ¯ä¸ªè°ƒç”¨è°ƒç”¨<code>onChange()</code> ï¼š <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> _tx( txMode, callback ) { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.openDatabasePromise; <span class="hljs-comment"><span class="hljs-comment">// await db connection try { const transaction = this.dbConnection.transaction( [ OBJECT_STORE_NAME ], txMode ); const objectStore = transaction.objectStore( OBJECT_STORE_NAME ); return await callback( objectStore ); } finally { if ( txMode === 'readwrite' ) this.onChange(); // notify listeners } }</span></span></code> </pre><br>  ï¼ˆ <a href="" rel="nofollow">githubæºä»£ç </a> ï¼‰ <br><br> å¦‚æœæˆ‘ä»¬ä»ç„¶ä½¿ç”¨<code>then()</code> / <code>catch()</code>æ¥ä¸Promiseä¸€èµ·ä½¿ç”¨ï¼Œæˆ‘ä»¬å°†ä¸å¾—ä¸å¤åˆ¶å¯¹<code>onChange()</code>çš„è°ƒç”¨ï¼Œæˆ–è€…å¯¹Promiseï¼ˆï¼‰ä½¿ç”¨æ”¯æŒ<code>final()</code>ç‰¹æ®Špolyfillsã€‚ å¹¸è¿çš„æ˜¯ï¼Œå¼‚æ­¥/ç­‰å¾…å…è®¸æ‚¨ç®€å•åœ°æ‰§è¡Œæ­¤æ“ä½œï¼Œè€Œæ— éœ€ä¸å¿…è¦çš„ä»£ç ã€‚ <br><br>  RepositoryListenerç»„ä»¶æœ¬èº«åœ¨componentDidMountå’ŒcomponentWillUnmountæ–¹æ³•ä¸­è¿æ¥äº‹ä»¶ä¾¦å¬å™¨ï¼š <br><br><div class="spoiler">  <b class="spoiler_title">RepositoryListenerä»£ç </b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> IndexedDbRepository <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./IndexedDbRepository'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { PureComponent } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RepositoryListener</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PureComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>( ...arguments ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevRepository = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repositoryListener = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">repositoryStamp</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props.onChange( repositoryStamp ); } componentDidMount() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.subscribe(); } componentDidUpdate() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.subscribe(); } componentWillUnmount() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.unsubscribe(); } subscribe() { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { repository } = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( repository <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> IndexedDbRepository &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevRepository !== repository ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevRepository !== <span class="hljs-literal"><span class="hljs-literal">null</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevRepository.removeListener( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repositoryListener ); } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevRepository = repository; repository.addListener( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repositoryListener ); } } unsubscribe( ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevRepository !== <span class="hljs-literal"><span class="hljs-literal">null</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevRepository.removeListener( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repositoryListener ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevRepository = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } } render() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props.children || <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> </pre>  ï¼ˆ <a href="" rel="nofollow">githubæºä»£ç </a> ï¼‰ </div></div><br> ç°åœ¨ï¼Œæˆ‘ä»¬å°†åœ¨ä¸»ç»„ä»¶ä¸­åŒ…æ‹¬å­˜å‚¨åº“æ›´æ”¹çš„å¤„ç†ï¼Œå¹¶ä¸”<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">åœ¨DRYåŸåˆ™çš„</a>æŒ‡å¯¼<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">ä¸‹</a> ï¼Œæˆ‘ä»¬å°†ä»<code>handleAdd</code> / <code>handleDelete</code>åˆ é™¤ç›¸åº”çš„ä»£ç ï¼š <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>( ...arguments ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state = { <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleAdd = <span class="hljs-keyword"><span class="hljs-keyword">async</span></span>( newTaskText ) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repository.save( { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: counter(), <span class="hljs-attr"><span class="hljs-attr">text</span></span>: newTaskText } ); }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleDelete = <span class="hljs-keyword"><span class="hljs-keyword">async</span></span>( idToDelete ) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repository.deleteById( idToDelete ); }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleRepositoryChanged = <span class="hljs-keyword"><span class="hljs-keyword">async</span></span>() =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( { <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> } ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( { <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repository.findAll() } ); }; } componentDidMount() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repository = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IndexedDbRepository( <span class="hljs-string"><span class="hljs-string">'id'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleRepositoryChanged(); <span class="hljs-comment"><span class="hljs-comment">// initial load }</span></span></code> </pre><br>  ï¼ˆ <a href="" rel="nofollow">githubæºä»£ç </a> ï¼‰ <br><br> ç„¶åï¼Œä»è¿æ¥çš„RepositoryListenerä¸­æ·»åŠ å¯¹handleRepositoryChangedçš„è°ƒç”¨ï¼š <br><br><pre> <code class="javascript hljs"> render() { <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">RepositoryListener</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onChange</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.handleRepoChanged}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">repository</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.repository}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">TaskList</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onAdd</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.handleAdd}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onDelete</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.handleDelete}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tasks</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.state.tasks}</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">RepositoryListener</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">; }</span></span></code> </pre><br>  ï¼ˆ <a href="" rel="nofollow">githubæºä»£ç </a> ï¼‰ <br><br><h2> æ­¥éª¤3.åœ¨å•ç‹¬çš„ç»„ä»¶ä¸­è¿›è¡Œæ•°æ®çš„åŠ è½½å’Œæ›´æ–° </h2><br> æˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ªç»„ä»¶ï¼Œè¯¥ç»„ä»¶å¯ä»¥ä»å­˜å‚¨åº“æ¥æ”¶æ•°æ®ï¼Œå¯ä»¥æ›´æ”¹å­˜å‚¨åº“ä¸­çš„æ•°æ®ã€‚ ä½†æ˜¯ï¼Œå¦‚æœæ‚¨æƒ³è±¡ä¸€ä¸ªåŒ…å«100å¤šä¸ªç»„ä»¶çš„å¤§å‹é¡¹ç›®ï¼Œé‚£ä¹ˆäº‹å®è¯æ˜ï¼Œæ˜¾ç¤ºå­˜å‚¨åº“ä¸­æ•°æ®çš„<b>æ¯ä¸ª</b>ç»„ä»¶éƒ½å°†è¢«è¿«æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š <br><br><ul><li> ç¡®ä¿ä»å•ä¸ªç‚¹æ­£ç¡®è¿æ¥å­˜å‚¨åº“ </li><li> åœ¨<code>componentDidMount()</code>æ–¹æ³•ä¸­æä¾›åˆå§‹æ•°æ®åŠ è½½ </li><li> è¿æ¥<code>RepositoryListener</code>ç»„ä»¶ï¼Œè¯¥ç»„ä»¶æä¾›å¤„ç†ç¨‹åºè°ƒç”¨ä»¥é‡æ–°åŠ è½½æ›´æ”¹ </li></ul><br> æ˜¯å¦æœ‰å¤ªå¤šé‡å¤çš„åŠ¨ä½œï¼Ÿ ä¼¼ä¹å¹¶éå¦‚æ­¤ã€‚ å¦‚æœå¿˜è®°äº†ä»€ä¹ˆï¼Ÿ è¿·ç³Šå¤åˆ¶ç²˜è´´ï¼Ÿ <br><br> ç¡®ä¿ä»¥æŸç§æ–¹å¼ç¡®ä¿ä¸€æ—¦ç¼–å†™äº†ä»å­˜å‚¨åº“ä¸­è·å–ä»»åŠ¡åˆ—è¡¨çš„è§„åˆ™ï¼Œè¿™å¾ˆå¦™ï¼Œå¹¶ä¸”ç¥å¥‡åœ°æ‰§è¡Œäº†è¿™äº›æ–¹æ³•ï¼Œä¸ºæˆ‘ä»¬æä¾›äº†æ•°æ®ï¼Œå¤„ç†äº†å­˜å‚¨åº“ä¸­çš„æ›´æ”¹ï¼Œå¹¶ä¸”å¯¹äºå †ï¼Œå®ƒè¿˜å¯ä»¥å°†å…¶è¿æ¥èµ·æ¥èµ„æ–™åº“ã€‚ <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.doFindAllTasks = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> repo </span></span></span><span class="hljs-function">) =&gt;</span></span> repo.findAll(); <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> &lt;DataProvider doCalc={ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.doFindAllTasks }&gt; {(data) =&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">span</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">...   -,   data...</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">span</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>} &lt;<span class="hljs-regexp"><span class="hljs-regexp">/DataProvider&gt;</span></span></code> </pre><br> è¯¥ç»„ä»¶å®ç°ä¸­å”¯ä¸€ä¸å¹³å‡¡çš„æ—¶åˆ»æ˜¯doFindAllTaskâ€‹â€‹sï¼ˆï¼‰æ˜¯Promiseã€‚ ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬çš„å·¥ä½œï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ç»„ä»¶ï¼Œç­‰å¾…Promiseæ‰§è¡Œå¹¶è°ƒç”¨å…·æœ‰è®¡ç®—å€¼çš„åä»£ï¼š <br><br><div class="spoiler">  <b class="spoiler_title">PromiseComponentä»£ç </b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { PureComponent } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PromiseComponent</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PureComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>( ...arguments ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state = { <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevPromise = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } componentDidMount() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.subscribe(); } componentDidUpdate( ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.subscribe(); } componentWillUnmount() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.unsubscribe(); } subscribe() { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { cleanOnPromiseChange, promise } = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( promise <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevPromise !== promise ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( cleanOnPromiseChange ) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( { <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> } ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevPromise = promise; promise.then( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">value</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevPromise === promise ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( { <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, value } ); } } ) .catch( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevPromise === promise ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( { error, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> } ); } } ); } } unsubscribe( ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevPromise !== <span class="hljs-literal"><span class="hljs-literal">null</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevPromise = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } } render() { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { children, fallback } = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { error, value } = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( error !== <span class="hljs-literal"><span class="hljs-literal">null</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> error; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( value === <span class="hljs-literal"><span class="hljs-literal">undefined</span></span> || value === <span class="hljs-literal"><span class="hljs-literal">null</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fallback || <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> children( value ); } }</code> </pre><br>  ï¼ˆ <a href="" rel="nofollow">githubæºä»£ç </a> ï¼‰ <br></div></div><br> è¯¥ç»„ä»¶çš„é€»è¾‘å’Œå†…éƒ¨ç»“æ„ä¸RepositoryListeneréå¸¸ç›¸ä¼¼ã€‚ å› ä¸ºå½¼æ­¤éƒ½å¿…é¡»â€œç­¾åâ€ï¼Œâ€œç›‘å¬â€äº‹ä»¶å¹¶ä»¥æŸç§æ–¹å¼å¤„ç†å®ƒä»¬ã€‚ å¦å¤–è¯·è®°ä½ï¼Œæ‚¨éœ€è¦å¬çš„äº‹ä»¶å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚ <br><br> æ­¤å¤–ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œéå¸¸ç¥å¥‡çš„ç»„ä»¶DataProviderçœ‹èµ·æ¥éå¸¸ç®€å•ï¼š <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> repository <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./RepositoryHolder'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataProvider</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PureComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>( ...arguments ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleRepoChanged = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.forceUpdate(); } render() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">RepositoryListener</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onChange</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.handleRepoChanged}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">repository</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{repository}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">PromiseComponent</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">promise</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.props.doCalc(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">repository</span></span></span></span><span class="xml"><span class="hljs-tag"> )}&gt;</span></span></span><span class="xml"> {data =&gt; this.props.children( data )} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">PromiseComponent</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">RepositoryListener</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>; } }</code> </pre><br>  ï¼ˆ <a href="" rel="nofollow">githubæºä»£ç </a> ï¼‰ <br><br> å®é™…ä¸Šï¼Œæˆ‘ä»¬é‡‡ç”¨äº†åä¸ºdoCalcçš„å­˜å‚¨åº“ï¼ˆä»¥åŠç°åœ¨æ­£åœ¨å¯¼å…¥çš„å•ç‹¬çš„singlenton RepositoryHolderï¼‰ï¼Œè¿™å°†ä½¿æˆ‘ä»¬èƒ½å¤Ÿå°†ä»»åŠ¡æ•°æ®ä¼ è¾“åˆ°this.props.childrenï¼Œä»è€Œç»˜åˆ¶ä»»åŠ¡åˆ—è¡¨ã€‚  Singlentonçœ‹èµ·æ¥ä¹Ÿå¾ˆç®€å•ï¼š <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> repository = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IndexedDbRepository( <span class="hljs-string"><span class="hljs-string">'id'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> repository;</code> </pre><br> ç°åœ¨ï¼Œå°†ä¸»ç»„ä»¶ä¸­çš„æ•°æ®åº“è°ƒç”¨æ›¿æ¢ä¸ºDataProviderè°ƒç”¨ï¼š <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> repository <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./RepositoryHolder'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Step3</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PureComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>( ...arguments ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.doFindAllTasks = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">repository</span></span></span><span class="hljs-function"> =&gt;</span></span> repository.findAll(); <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> } render() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> &lt;DataProvider doCalc={this.doFindAllTasks} fallback={&lt;&gt;&lt;Spinner animation="border" aria-hidden="true" as="span" role="status" /&gt;&lt;span&gt;  ...&lt;/span&gt;&lt;/&gt;}&gt; { tasks =&gt; &lt;TaskList onAdd={this.handleAdd} onDelete={this.handleDelete} tasks={tasks} /&gt; } &lt;/DataProvider&gt;; } }</code> </pre><br>  ï¼ˆ <a href="" rel="nofollow">githubæºä»£ç </a> ï¼‰ <br><br> è¿™å¯èƒ½ä¼šåœæ­¢ã€‚ ç»“æœéå¸¸å¥½ï¼šæˆ‘ä»¬æè¿°äº†æ¥æ”¶æ•°æ®çš„è§„åˆ™ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªå•ç‹¬çš„ç»„ä»¶ç›‘è§†æ­¤æ•°æ®çš„å®é™…æ¥æ”¶ä»¥åŠæ›´æ–°ã€‚ ä»å­—é¢ä¸Šçœ‹ï¼Œæœ‰å‡ ä»¶äº‹ï¼š <br><br><ul><li> å¯¹äºæ¯ä¸ªæ•°æ®è¯·æ±‚ï¼Œæ‚¨éœ€è¦åœ¨ä»£ç ä¸­çš„æŸä¸ªåœ°æ–¹ï¼ˆè€Œä¸æ˜¯<code>render()</code>æ–¹æ³•ä¸­<code>render()</code> ï¼Œæè¿°è®¿é—®å­˜å‚¨åº“çš„åŠŸèƒ½ï¼Œç„¶åå°†æ­¤åŠŸèƒ½ä¼ é€’ç»™DataProvider </li><li> å¯¹DataProviderçš„è°ƒç”¨éå¸¸æ£’ï¼Œå®Œå…¨ç¬¦åˆReactçš„ç²¾ç¥ï¼Œä½†æ˜¯ä»JSXçš„è§’åº¦æ¥çœ‹éå¸¸éš¾çœ‹ã€‚ å¦‚æœæ‚¨æœ‰å¤šä¸ªç»„ä»¶ï¼Œåˆ™ä¸åŒçš„DataProviderçš„ä¸¤ä¸ªæˆ–ä¸‰ä¸ªåµŒå¥—çº§åˆ«å°†ä½¿æ‚¨éå¸¸å›°æƒ‘ã€‚ </li><li> ä»¤äººé—æ†¾çš„æ˜¯ï¼Œæ•°æ®çš„æ¥æ”¶æ˜¯åœ¨ä¸€ä¸ªç»„ä»¶ï¼ˆDataProviderï¼‰ä¸­å®Œæˆçš„ï¼Œè€Œå®ƒä»¬çš„æ›´æ”¹æ˜¯åœ¨å¦ä¸€ä¸ªç»„ä»¶ï¼ˆä¸»ç»„ä»¶ï¼‰ä¸­å®Œæˆçš„ã€‚ æˆ‘æƒ³ç”¨ç›¸åŒçš„æœºåˆ¶æ¥æè¿°å®ƒã€‚ </li></ul><br><h2> æ­¥éª¤4.è¿æ¥ï¼ˆï¼‰ </h2><br> ç†Ÿæ‚‰react-reduxçš„æ ‡é¢˜å·²ç»çŒœåˆ°äº†æ ‡é¢˜ã€‚ æˆ‘å°†å¯¹å…¶ä½™å†…å®¹è¿›è¡Œä»¥ä¸‹æç¤ºï¼šå¦‚æœDataProvideræœåŠ¡ç»„ä»¶æ ¹æ®è§„åˆ™å¡«å……äº†ç»„ä»¶çš„å±æ€§ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å‚æ•°è°ƒç”¨childrenï¼ˆï¼‰ï¼Œé‚£å°†æ˜¯å¾ˆå¥½çš„ã€‚ å¹¶ä¸”ï¼Œå¦‚æœå­˜å‚¨åº“ä¸­å‘ç”Ÿäº†æŸäº›æ›´æ”¹ï¼Œåˆ™åªéœ€ä½¿ç”¨æ ‡å‡†Reactæœºåˆ¶æ›´æ”¹å±æ€§å³å¯ã€‚ <br><br> ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨é«˜é˜¶ç»„ä»¶ã€‚ å®é™…ä¸Šï¼Œè¿™å¹¶ä¸å¤æ‚ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªå°†ç»„ä»¶ç±»ä½œä¸ºå‚æ•°å¹¶æä¾›å¦ä¸€ä¸ªæ›´å¤æ‚çš„ç»„ä»¶çš„å‡½æ•°ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬ç¼–å†™çš„å‡½æ•°å°†æ˜¯ï¼š <br><br><ul><li> ä»¥ç»„ä»¶ç±»ä½œä¸ºå‚æ•°ä¼ é€’å‚æ•° </li><li> æ¥å—ä¸€ç»„è§„åˆ™ï¼Œå¦‚ä½•ä»å­˜å‚¨åº“ä¸­è·å–æ•°æ®ä»¥åŠå°†å…¶æ”¾å…¥å“ªäº›å±æ€§ä¸­ </li><li> åœ¨ä½¿ç”¨ä¸­ï¼Œå®ƒå°†ç±»ä¼¼äº<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">react-reduxçš„connectï¼ˆï¼‰å‡½æ•°</a> ã€‚ </li></ul><br> å¯¹è¯¥å‡½æ•°çš„è°ƒç”¨å°†å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> mapRepoToProps = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">repository</span></span></span><span class="hljs-function"> =&gt;</span></span> ( { <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: repository.findAll(), } ); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> mapRepoToActions = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">repository</span></span></span><span class="hljs-function"> =&gt;</span></span> ( { <span class="hljs-attr"><span class="hljs-attr">doAdd</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> newTaskText </span></span></span><span class="hljs-function">) =&gt;</span></span> repository.save( { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: counter(), <span class="hljs-attr"><span class="hljs-attr">text</span></span>: newTaskText } ), <span class="hljs-attr"><span class="hljs-attr">doDelete</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> idToDelete </span></span></span><span class="hljs-function">) =&gt;</span></span> repository.deleteById( idToDelete ), } ); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Step4Connected = connect( mapRepoToProps, mapRepoToActions )( Step4 );</code> </pre><br> ç¬¬ä¸€è¡Œ<code>Step4</code>ç»„ä»¶çš„å±æ€§åç§°å’Œå°†ä»å­˜å‚¨åº“åŠ è½½çš„å€¼ä¹‹é—´<code>Step4</code>æ˜ å°„ã€‚ æ¥ä¸‹æ¥æ˜¯æ“ä½œæ˜ å°„ï¼šå¦‚æœä»<code>Step4</code>ç»„ä»¶ä¸­è°ƒç”¨<code>this.props.doAdd(...)</code>æˆ–<code>this.props.doDelete(...)</code> ï¼Œå°†ä¼šå‘ç”Ÿä»€ä¹ˆã€‚ æœ€åä¸€è¡Œå°†æ‰€æœ‰å†…å®¹ç»„åˆåœ¨ä¸€èµ·ï¼Œå¹¶è°ƒç”¨connectå‡½æ•°ã€‚ ç»“æœæ˜¯ä¸€ä¸ªæ–°çš„ç»„ä»¶ï¼ˆè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå°†æ­¤æŠ€æœ¯ç§°ä¸ºâ€œé«˜é˜¶ç»„ä»¶â€çš„åŸå› ï¼‰ã€‚ è€Œä¸”æˆ‘ä»¬å°†ä¸å†ä»æ–‡ä»¶ä¸­å¯¼å‡ºåŸå§‹Step4ç»„ä»¶ï¼Œè€Œæ˜¯å›´ç»•å®ƒçš„åŒ…è£…å™¨ï¼š <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Step4</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PureComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> } <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Step4Connected = connect( <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> )( Step4 ); <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> Step4Connected;</code> </pre><br> ç°åœ¨ï¼Œä½¿ç”¨TaskListçš„ç»„ä»¶çœ‹èµ·æ¥åƒä¸€ä¸ªç®€å•çš„åŒ…è£…å™¨ï¼š <br><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Step4</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PureComponent</span></span></span><span class="hljs-class"> </span></span>{ render() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props.tasks === <span class="hljs-literal"><span class="hljs-literal">undefined</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props.tasks === <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? &lt;&gt;&lt;Spinner animation="border" aria-hidden="true" as="span" role="status" /&gt;&lt;span&gt;  ...&lt;/span&gt;&lt;/&gt; : &lt;TaskList onAdd={this.props.doAdd} onDelete={this.props.doDelete} tasks={this.props.tasks} /&gt;; } }</code> </pre><br>  ï¼ˆ <a href="" rel="nofollow">githubæºä»£ç </a> ï¼‰ <br><br> å°±æ˜¯è¿™æ ·ã€‚ æ²¡æœ‰æ„é€ å‡½æ•°ï¼Œæ²¡æœ‰å…¶ä»–å¤„ç†ç¨‹åº-ä¸€åˆ‡éƒ½ç”±connectï¼ˆï¼‰å‡½æ•°æ”¾ç½®åœ¨ç»„ä»¶çš„propsä¸­ã€‚ <br><br> å‰©ä¸‹çš„è¦çœ‹connectï¼ˆï¼‰å‡½æ•°çš„å¤–è§‚äº†ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">è¿æ¥ï¼ˆï¼‰ä»£ç </b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> repository <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./RepositoryHolder'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Connected</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PureComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>( ...arguments ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleRepoChanged = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.forceUpdate(); } render() { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { childClass, childProps, mapRepoToProps, mapRepoToActions } = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> promises = mapRepoToProps( repository, childProps ); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> actions = mapRepoToActions( repository, childProps ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">RepositoryListener</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onChange</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.handleRepoChanged}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">repository</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{repository}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">PromisesComponent</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">promises</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{promises}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> { values =&gt; React.createElement( childClass, { ...childProps, ...values, ...actions, } )} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">PromisesComponent</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">RepositoryListener</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connect</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> mapRepoToProps, mapRepoToActions </span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">childClass</span></span></span><span class="hljs-function"> =&gt;</span></span> props =&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Connected</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">childClass</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{childClass}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">childProps</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{props}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mapRepoToActions</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{mapRepoToActions}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mapRepoToProps</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{mapRepoToProps}</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml">; }</span></span></code> </pre>  ï¼ˆ <a href="" rel="nofollow">githubæºä»£ç </a> ï¼‰ </div></div><br> è¯¥ä»£ç ä¼¼ä¹ä¹Ÿä¸æ˜¯å¾ˆå¤æ‚...å°½ç®¡å¦‚æœæ‚¨å¼€å§‹æ½œæ°´ï¼Œåˆ™ä¼šå‡ºç°é—®é¢˜ã€‚ æ‚¨éœ€è¦ä»å¤´å¼€å§‹é˜…è¯»ã€‚ åœ¨é‚£é‡Œå®šä¹‰äº†<code>connect()</code>å‡½æ•°ã€‚ å®ƒéœ€è¦ä¸¤ä¸ªå‚æ•°ï¼Œç„¶åè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°åˆè¿”å›...ä¸€ä¸ªå‡½æ•°ï¼Ÿ ä¸å®Œå…¨æ˜¯ æœ€åçš„<code>props =&gt; &lt;Connected...</code>æ„é€ ä¸ä»…è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè€Œä¸”è¿”å›<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">ä¸€ä¸ªReactå‡½æ•°ç»„ä»¶</a> ã€‚<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> å› æ­¤ï¼Œå½“æˆ‘ä»¬å°†ConnectedStep4åµŒå…¥è™šæ‹Ÿæ ‘ä¸­æ—¶ï¼Œå®ƒå°†åŒ…æ‹¬ï¼š </font></font><br><br><ul><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çˆ¶-&gt;</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åŒ¿ååŠŸèƒ½ç»„ä»¶-&gt;è¿æ¥-&gt; RepositoryListener-&gt; PromisesComponent-&gt; Step4</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¤šè¾¾4ä¸ªä¸­é—´ç±»ï¼Œä½†æ¯ä¸ªéƒ½æ‰§è¡Œå…¶åŠŸèƒ½ã€‚æœªå‘½åçš„ç»„ä»¶é‡‡ç”¨ä¼ é€’ç»™å‡½æ•°çš„å‚æ•°</font></font><code>connect()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ŒåµŒå¥—ç»„ä»¶çš„ç±»ï¼Œåœ¨è°ƒç”¨æ—¶ä¼ é€’ç»™ç»„ä»¶æœ¬èº«çš„å±æ€§ï¼ˆpropsï¼‰ï¼Œå¹¶å°†å…¶å·²ç»ä¼ é€’ç»™ç»„ä»¶</font></font><code>Connect</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚è¯¥ç»„ä»¶</font></font><code>Connect</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è´Ÿè´£ä»ä¼ é€’çš„å‚æ•°</font></font><code>Promise</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆå…·æœ‰è¡Œé”®å’ŒPromiseå€¼çš„å­—å…¸å¯¹è±¡ï¼‰ä¸­</font><font style="vertical-align: inherit;">è·å–é›†åˆ</font><font style="vertical-align: inherit;">ã€‚</font></font><code>PromisesComponent</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æä¾›å€¼çš„è®¡ç®—ï¼Œå¹¶å°†å…¶ä¼ é€’å›Connectç»„ä»¶ï¼ŒConnectç»„ä»¶ä¸åŸå§‹ä¼ è¾“çš„å±æ€§ï¼ˆpropsï¼‰ï¼Œè®¡ç®—çš„å±æ€§ï¼ˆå€¼ï¼‰å’Œactionå±æ€§ï¼ˆactionsï¼‰ä¸€èµ·ï¼Œå°†å®ƒä»¬ä¼ é€’ç»™ç»„ä»¶</font></font><code>Step4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆé€šè¿‡call </font></font><code>React.createElement(...)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰ã€‚å¥½å§ï¼Œç»„ä»¶</font></font><code>RepositoryListener</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ›´æ–°ç»„ä»¶ï¼Œå¦‚æœå­˜å‚¨åº“ä¸­å‘ç”Ÿäº†æŸäº›æ›´æ”¹ï¼Œåˆ™å¼ºåˆ¶é‡æ–°è®¡ç®—æœ‰å¿ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç»“æœï¼Œå¦‚æœä»»ä½•ç»„ä»¶éƒ½æƒ³ä½¿ç”¨IndexDbä¸­çš„å­˜å‚¨åº“ï¼Œé‚£ä¹ˆä»–åªè¦è¿æ¥ä¸€ä¸ªåŠŸèƒ½</font></font><code>connect()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œå®šä¹‰å±æ€§ä¸ä»å­˜å‚¨åº“ä¸­è·å–å±æ€§çš„åŠŸèƒ½ä¹‹é—´çš„æ˜ å°„ï¼Œå°±å¯ä»¥ä½¿ç”¨å®ƒä»¬è€Œä¸ä¼šé€ æˆä»»ä½•å…¶ä»–éº»çƒ¦ã€‚</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ­¥éª¤5. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@ vlsergey / react-indexdb-repo</font></font></a> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æœ€åï¼Œæˆ‘ä»¬ä»¥åº“çš„å½¢å¼å®‰æ’æ‰€æœ‰è¿™äº›å†…å®¹ï¼Œä»¥ä¾¿å…¶ä»–å¼€å‘äººå‘˜å¯ä»¥åœ¨å…¶é¡¹ç›®ä¸­ä½¿ç”¨å®ƒã€‚</font><font style="vertical-align: inherit;">æ­¤æ­¥éª¤çš„ç»“æœæ˜¯ï¼š</font></font><br><br><ul><li><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@ Vlsergey / react-promise</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åº“</font><font style="vertical-align: inherit;">-PromiseComponentå’ŒPromisesComponentçš„å®ç°ï¼Œæ”¯æŒè®°å¿†ç»“æœï¼ˆè¿™æ ·ï¼Œå½“æˆ‘ä»¬ä¸æ„Ÿå…´è¶£çš„æ›´æ”¹æ—¶ï¼ŒUIä¸ä¼šâ€œæŠ½æâ€ï¼‰</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å›¾ä¹¦é¦†</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@ vlsergey /çš„é˜µè¥ï¼ŒINDEXDB -å›è´­</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -å®æ–½IndexedDbRepositoryï¼ŒåŠŸèƒ½connectï¼ˆï¼‰å’Œä¸€äº›å·¥å…·ç±»</font></font></li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½¿ç”¨æ­¤åº“æ„å»ºä»»åŠ¡åˆ—è¡¨çš„ç¤ºä¾‹</font></font></a> </li></ul><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> è€Œä¸æ˜¯å¾—å‡ºç»“è®ºï¼šä»€ä¹ˆéƒ½é—å¿˜äº† </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸Šé¢çš„ä»£ç å·²ç»è¶³å¤Ÿå®ç”¨ï¼Œå¯ä»¥åœ¨å·¥ä¸šè§£å†³æ–¹æ¡ˆä¸­ä½¿ç”¨ã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯ï¼Œè¯·ä¸è¦å¿˜è®°è¿™äº›é™åˆ¶ï¼š</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¹¶éæ€»æ˜¯æ›´æ”¹å±æ€§åº”è¯¥å¸¦æ¥æ–°çš„å¸Œæœ›ã€‚</font><font style="vertical-align: inherit;">åœ¨è¿™é‡Œï¼Œæ‚¨éœ€è¦ä½¿ç”¨å¤‡å¿˜å½•åŠŸèƒ½ï¼Œä½†è¦è€ƒè™‘æ•°æ®åº“æ›´æ”¹æ ‡å¿—ã€‚</font><font style="vertical-align: inherit;">è¿™æ˜¯æ¥è‡ªIndexedDbRepositoryçš„æˆ³è®°æ´¾ä¸Šç”¨åœºçš„åœ°æ–¹ï¼ˆå¯¹äºæŸäº›è¿™æ®µä»£ç æ¥è¯´ä¼¼ä¹æœ‰äº›å¤šä½™ï¼‰ã€‚</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å³ä½¿åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œé€šè¿‡å¯¼å…¥è¿æ¥å­˜å‚¨åº“ä¹Ÿæ˜¯é”™è¯¯çš„ã€‚</font><font style="vertical-align: inherit;">æœ‰å¿…è¦è€ƒè™‘ä½¿ç”¨ä¸Šä¸‹æ–‡ã€‚</font></font></li><li>     ,     IndexedDB      . </li><li>            :     .     .   IndexDB      Â«Â»   ,    â€”       . </li><li>  ,  IndexDB    Redux Storage.      IndexDB    ,            . </li></ul><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">   </a> <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">Online-</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN472246/">https://habr.com/ru/post/zh-CN472246/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN472230/index.html">MLèŠ¯ç‰‡-è°ˆè®ºæ–°äº§å“</a></li>
<li><a href="../zh-CN472232/index.html">ä»â€œ ZXå…‰è°±å¢è‰²å‰‚â€åˆ°ZX-Poly</a></li>
<li><a href="../zh-CN472234/index.html">åŠ å¯†è´§å¸ï¼šå®ƒä»ç„¶æ˜¯å…è´¹ä¸‹è½½å™¨è¿˜æ˜¯åˆä½œä¼™ä¼´ï¼Ÿ</a></li>
<li><a href="../zh-CN472240/index.html">å…³äºæ¸¸æˆåŒ–ã€‚ è¿™æ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆä»¥åŠå¦‚ä½•åšï¼Ÿ å¼€å‘äººå‘˜å¤–è§‚</a></li>
<li><a href="../zh-CN472242/index.html">æˆ‘ä»¬å·²ç»åæ¬¡åŠ é€Ÿäº†Tokioè°ƒåº¦ç¨‹åº</a></li>
<li><a href="../zh-CN472248/index.html">æˆ‘ä»¬å¦‚ä½•åˆå¹¶ç¼–ç¨‹IT-Planet Final</a></li>
<li><a href="../zh-CN472252/index.html">10æœˆ21æ—¥è‡³28æ—¥åœ¨è«æ–¯ç§‘ä¸¾è¡Œçš„æ•°å­—æ´»åŠ¨</a></li>
<li><a href="../zh-CN472254/index.html">10æœˆ21æ—¥è‡³28æ—¥åœ¨åœ£å½¼å¾—å ¡ä¸¾è¡Œçš„æ•°å­—æ´»åŠ¨</a></li>
<li><a href="../zh-CN472258/index.html">å¦‚ä½•â€œå­¦ä¼šå­¦ä¹ â€-æé«˜æ­£å¿µ</a></li>
<li><a href="../zh-CN472262/index.html">ï¼ƒ318ç§»åŠ¨å¼€å‘äººå‘˜çš„æœ‰è¶£ææ–™æ‘˜è¦ï¼ˆ10æœˆ14æ—¥è‡³20æ—¥ï¼‰</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>