<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïí ‚úèÔ∏è üïµüèΩ Visualiza√ß√£o do tempo de renascimento de Roshan üôå üíü ü§æüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este artigo discute a intercepta√ß√£o de fun√ß√µes gr√°ficas da API usando o exemplo do DirectX 9 para x64 em rela√ß√£o ao jogo Dota 2 . 

 Ser√° descrito em ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Visualiza√ß√£o do tempo de renascimento de Roshan</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/446516/">  Este artigo discute a intercepta√ß√£o de fun√ß√µes gr√°ficas da API usando o exemplo do DirectX 9 para x64 em rela√ß√£o ao jogo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Dota 2</a> . <br><br>  Ser√° descrito em detalhes como se infiltrar no processo do jogo, como alterar o fluxo de execu√ß√£o, uma breve descri√ß√£o da l√≥gica implementada.  No final, falaremos sobre outros recursos de renderiza√ß√£o que o mecanismo fornece. <br><br><img src="https://habrastorage.org/webt/b0/rp/kn/b0rpknk7iobhh3darfcrte8ncmo.jpeg"><br><br><blockquote>  <b>Isen√ß√£o de responsabilidade: O autor n√£o √© respons√°vel pelo uso dos conhecimentos adquiridos neste artigo ou por danos resultantes do uso.</b>  <b>Todas as informa√ß√µes aqui apresentadas s√£o apenas para fins educacionais.</b>  <b>Especialmente para empresas que desenvolvem MOBA para ajud√°-las a lidar com trapaceiros.</b>  <b>E, √© claro, o autor do artigo √© um motorista de bot, um trapaceiro, e sempre foi.</b> </blockquote><a name="habracut"></a>  Vale a pena explicar a √∫ltima frase - sou a favor da concorr√™ncia justa.  Uso truques apenas como interesse esportivo, aprimoro as habilidades reversas, estudo o trabalho de anti-truques e apenas fora das competi√ß√µes de classifica√ß√£o. <br><br><h2>  1. Introdu√ß√£o </h2><br>  Este artigo √© planejado como o primeiro de uma s√©rie e fornece uma id√©ia de como voc√™ pode usar a API gr√°fica para seus pr√≥prios fins, descreve a funcionalidade necess√°ria para entender a pr√≥xima parte.  Pretendo dedicar o segundo artigo a procurar um ponteiro para a lista de entidades na Origem 2 (tamb√©m usando o Dota 2 como exemplo) e us√°-lo em conjunto com o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Source2Gen</a> para escrever l√≥gica "adicional" (algo como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">isso</a> provavelmente mostrar√° "map hack" (verifique aten√ß√£o √†s cita√ß√µes, o que est√° em jogo pode ser visto no v√≠deo) ou a automa√ß√£o do primeiro artigo).  O terceiro artigo √© planejado na forma de escrever um driver, comunicar-se com ele (IOCTL), us√°-lo para ignorar a prote√ß√£o VAC (algo semelhante a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">isso</a> ). <br><br><h2>  2. Por que eu preciso disso </h2><br>  Eu precisava do uso da API gr√°fica para depurar visualmente meu bot, que escrevi para o Dota 2 (informa√ß√µes visualizadas em tempo real s√£o muito convenientes).  Eu sou um estudante de gradua√ß√£o e estou envolvido na reconstru√ß√£o de cabe√ßas 3D e morphing usando imagens e uma c√¢mera de profundidade - o t√≥pico √© bastante interessante, mas n√£o o meu favorito.  Desde que fa√ßo isso pelo quinto ano (come√ßando pelo programa de mestrado), entendi uma coisa - sim, estudei bastante essa √°rea, estudo facilmente artigos com m√©todos e abordagens e os implemento.  Mas √© tudo, eu mesmo s√≥ posso otimizar o pr√≥ximo algoritmo aprendido, compar√°-lo com os j√° estudados e implementados e decidir se deve us√°-lo em uma tarefa espec√≠fica.  √â o fim da otimiza√ß√£o, n√£o √© poss√≠vel inventar algo novo, o que √© muito importante para a p√≥s-gradua√ß√£o (a novidade do estudo).  Comecei a pensar - enquanto h√° tempo, voc√™ pode encontrar um novo t√≥pico.  Voc√™ j√° precisa entender bem o t√≥pico (no n√≠vel atual) ou pode pux√°-lo rapidamente. <br><br>  Ao mesmo tempo, trabalhei no game dev, e este √© provavelmente o mais interessante do que um programador pode fazer (opini√£o pessoal) e estava muito interessado no t√≥pico da IA, bots.  Naquela √©poca, havia dois t√≥picos que eu conhecia bastante bem - ent√£o eu estava construindo uma malha de navega√ß√£o din√¢mica (cliente-servidor) e estudando a parte da rede de um shooter din√¢mico.  Um t√≥pico com um navegador din√¢mico n√£o se encaixou imediatamente - eu fiz isso durante o hor√°rio de trabalho, tive que pedir permiss√£o √† ger√™ncia para uso no diploma; al√©m disso, o t√≥pico da novidade estava aberto - tamb√©m estudei e implementei as abordagens por artigo, mas isso n√£o era novo.  O t√≥pico com a parte de rede do shooter din√¢mico (planejei us√°-lo para intera√ß√£o em realidade virtual) voltou a se dividir tanto pelo fato de estar fazendo isso durante o hor√°rio de trabalho quanto pela novidade, voc√™ pode ler uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">s√©rie de artigos</a> da Pixonic, onde o pr√≥prio autor diz que o t√≥pico isso √© interessante, apenas abordagens foram inventadas h√° 30 anos e n√£o mudaram muito. <br><br>  Por volta dessa √©poca, a OpenAI lan√ßou seu bot.  Certamente n√£o √© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">5 por 5</a> , mas foi incr√≠vel!  N√£o consegui pensar fora para tentar criar um bot e, antes de tudo, comecei a pensar em como us√°-lo como disserta√ß√£o, sobre novidade e como apresent√°-lo a um l√≠der.  Com a novidade a esse respeito, tudo ficou muito melhor - com certeza foi poss√≠vel criar algo para os dois t√≥picos anteriores, mas aparentemente o bot me fez pensar, me apegar, desenvolver e procurar id√©ias muito mais fortes.  Ent√£o, eu decidi fazer um bot 1-on-1 (uma batalha no meio, como a OpenAI), apresent√°-lo ao l√≠der, dizer o qu√£o legal √©, quantas abordagens diferentes, matem√°tica e, o mais importante, a nova. <br><br>  A coisa mais necess√°ria que o bot precisa no primeiro est√°gio √© o conhecimento do ambiente em que ele est√° - pretendi tirar o estado do mundo da mem√≥ria do jogo e passei o primeiro est√°gio procurando um ponteiro para a Lista de Entidades e integra√ß√£o com a ideia da ora√ß√£o Dog2 Source2Gen - isso gera a estrutura do mecanismo Source2, que √© retirada dos circuitos.  A principal id√©ia e pr√©-requisito para o surgimento de esquemas √© a replica√ß√£o de estado entre o cliente e o servidor, mas aparentemente os desenvolvedores realmente gostaram da id√©ia e a distribu√≠ram muito mais amplamente, aconselho que voc√™ leia <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br>  Eu tinha experi√™ncia em engenharia reversa: fiz truques para Silent Storm, fiz geradores de chaves (o mais interessante foi para Black &amp; White) - o que √© keygen pode ser lido no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">DrMefistO</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> , execu√ß√£o de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">combo</a> no Cabal Online (tudo foi complicado pelo fato de este jogo ser protegido pelo Game Guard , protegeu-o do ring0 (sob o driver no modo kernel), ocultando o processo (que pelo menos n√£o facilita a infiltra√ß√£o) - mais detalhes podem ser lidos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> ). <br>  Conseq√ºentemente, eu tive desenvolvimentos nessa √°rea, o bot teve acesso ao ambiente pelo tempo planejado.  √â incr√≠vel a quantidade de informa√ß√µes que o servidor bunker replica atrav√©s do delta para o cliente, por exemplo, o cliente tem informa√ß√µes sobre qualquer teleportador, sa√∫de e suas mudan√ßas entre os agentes (exceto Roshan, ele n√£o replica) - tudo isso est√° no nevoeiro da guerra.  Embora tenha encontrado algumas dificuldades, √© sobre isso que vou falar no pr√≥ximo artigo. <br>  Se voc√™ tiver alguma d√∫vida sobre por que n√£o usei o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Dota Bot Scripting</a> , responderei com um trecho da documenta√ß√£o: <br><blockquote>  A API √© restrita, de modo que os scripts n√£o podem trapacear - as unidades no FoW n√£o podem ser consultadas, os comandos n√£o podem ser emitidos para as unidades que o script n√£o controla etc. </blockquote>  Esta s√©rie de artigos √© direcionada a iniciantes interessados ‚Äã‚Äãno t√≥pico de engenharia reversa. <br><br><h2>  3. Por que estou escrevendo sobre isso </h2><br>  Como resultado, enfrentei muitos problemas na implementa√ß√£o do bot do ml, com os quais dediquei tempo suficiente para entender que dois anos antes do final do treinamento eu n√£o conseguia superar meu conhecimento e experi√™ncia no t√≥pico atual.  No Dota 2, n√£o jogo desde o lan√ßamento do costume Dota Auto Chess, agora passo meu tempo livre no diploma e no verso do Apex Legend (cuja estrutura √© bastante semelhante ao Dota 2, como me parece).  Consequentemente, o √∫nico benef√≠cio do trabalho realizado √© a publica√ß√£o de um artigo t√©cnico sobre esse assunto. <br><br><h2>  4. Dota 2 </h2><br>  Eu pretendo mostrar esses princ√≠pios em um jogo real - Dota 2. O jogo usa o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">anti-</a> cheat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Valve Anti Cheat</a> .  Eu realmente gosto da Valve como empresa: produtos muito legais, diretor, atitude para com os jogadores, Steam, Source Engine 2, ... VAC.  O VAC funciona no modo de usu√°rio (ring3), n√£o verifica tudo e √© inofensivo em compara√ß√£o com outros anti-cheats (tudo o que o esea faz (especificamente o anti-cheat) faz desaparecer todo o desejo de usar esta plataforma).  Tenho certeza de que o VAC faz seu trabalho de maneira t√£o poupadora - n√£o monitora no modo kernel, n√£o bane hardware (apenas uma conta), n√£o insere marcas d'√°gua em capturas de tela - gra√ßas √† atitude da Valve em rela√ß√£o aos jogadores, eles n√£o instalam um antiv√≠rus completo para voc√™, como fazem Game Guard, BattlEye, Warden e outros, porque tudo √© hackeado e gasta os recursos do processador que o jogo pode levar (mesmo que isso seja feito periodicamente), h√° falsos positivos (especialmente para jogadores em laptops).  N√£o existe um hack de parede, aimbot, speed hack, ESP em PUBG, Apex, Fortnite? <br><br>  Na verdade, sobre o Dota 2. O jogo roda a uma frequ√™ncia de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">40Hz</a> (25 ms), o cliente interpola o estado do jogo, a previs√£o de entrada n√£o √© usada - se voc√™ tiver um atraso, um jogo - √© importante nem mesmo um jogo, unidades controladas - ficarem completamente congelados.  O servidor de mec√¢nica de jogos troca mensagens criptografadas com o cliente via RUDP (UDP confi√°vel), o cliente basicamente envia entradas (se voc√™ hospedar o lobby, os comandos podem ser enviados), o servidor envia uma r√©plica do mundo do jogo e da equipe.  A navega√ß√£o √© realizada em uma grade 3D, cada c√©lula possui seu pr√≥prio tipo de permeabilidade.  O movimento √© realizado usando a navega√ß√£o e a f√≠sica (a impossibilidade de passar pela fissura de um shaker, kogi clokverka, etc.). <br><br>  O estado do mundo com todas as entidades est√° na mem√≥ria em sua forma mais pura, sem criptografia - voc√™ pode estudar a mem√≥ria do jogo usando o Cheat Engine.  Ofusca√ß√£o n√£o se aplica a seq√º√™ncias de caracteres e c√≥digo. <br><br><div class="spoiler">  <b class="spoiler_title">DirectX9, DirectX11, Vulkan, OpenGL est√£o dispon√≠veis na API gr√°fica.</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/xc/xq/kl/xcxqkl2qpwy3gved7_jblzsqumo.png"><br></div></div><br><h2>  5. Declara√ß√£o do problema </h2><br>  No jogo Dota 2, h√° um "antigo" neutro, cuja matan√ßa d√° uma boa recompensa: experi√™ncia, ouro, a capacidade de reverter as recargas de habilidades e objetos, Aegis (second life), seu nome √© Roshan.  Conseguir Aegis pode fundamentalmente mudar o jogo ou dar uma vantagem ainda maior ao lado mais forte, respectivamente, os jogadores tentam se lembrar / registrar o tempo de sua morte para planejar quando ficarem juntos e atac√°-lo, ou estar perto para sua prote√ß√£o.  Todos os dez jogadores s√£o notificados da morte de Roshan, independentemente de ele estar escondido no nevoeiro da guerra.  O tempo de reaparecimento tem oito minutos obrigat√≥rios, ap√≥s os quais Roshan pode aparecer aleatoriamente no intervalo de tr√™s minutos. <br><br>  <i>A tarefa √© a seguinte</i> : fornecer ao jogador informa√ß√µes sobre o estado atual de Roshan (vivo-vivo, ressurect_base-revive o tempo base, ressurect_extra-revive o tempo extra). <br><br> <a href=""><img src="https://habrastorage.org/webt/qf/ef/3s/qfef3s2h4a6l_pfageiblxwqhd8.png"></a> <br>  <i>Figura 1 - Condi√ß√µes para transi√ß√µes entre estados e a√ß√µes durante a transi√ß√£o</i> <br><br>  Para condi√ß√µes nas quais Roshan est√° morto, exiba o hor√°rio final da estadia nesse estado.  A transi√ß√£o do estado ativo para o ressurect_base deve ser feita pelo jogador no modo manual pelo bot√£o.  No caso de detec√ß√£o / morte de Roshan no estado ressurect_extra (por exemplo, uma equipe inimiga entrou furtivamente no esconderijo e o matou), a transi√ß√£o para o estado vivo / ressurect_base tamb√©m √© realizada manualmente pelo bot√£o.  O status de Roshan (e a hora final de um estado de reavivamento) deve ser mostrado em forma de texto, a entrada necess√°ria (interrup√ß√£o e interrup√ß√£o do estado de ressurect_extra) deve ser fornecida com um bot√£o. <br><br><img src="https://habrastorage.org/webt/cb/xw/ne/cbxwneudadwlvbx4ch2gwumlona.png"><br>  <i>Figura 2 - Elementos da interface - etiqueta, bot√£o e tela</i> <br><br>  Esta √© a √∫nica tarefa que eu pude realizar para n√£o precisar trabalhar com a mem√≥ria do jogo e haver pelo menos algum valor para o jogador - mesmo para derivar quaisquer caracter√≠sticas elementares, como sa√∫de, mana e posi√ß√µes de entidades, voc√™ precisa encontr√°-las antecipadamente ajude o Cheat Engine na mem√≥ria do jogo, que precisa ser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">explicado</a> adicionalmente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">por um</a> longo per√≠odo de tempo, ou com a ajuda do Source2Gen, que ser√° o pr√≥ximo artigo.  A afirma√ß√£o do problema for√ßa o jogador a seguir Roshan, mudando muitas a√ß√µes para ele, o que √© bastante inconveniente - mas haver√° algo em que confiar na segunda parte. <br><br>  Escreveremos nosso injected.dll, que conter√° a l√≥gica comercial baseada no MVC e a implementar√° no processo do Dota 2. A DLL usar√° nossa biblioteca silk_way.lib, que conter√° a l√≥gica de intercepta√ß√£o para alterar o fluxo de execu√ß√£o, o criador de logs, o scanner de mem√≥ria e as estruturas de dados. . <br><br><h2>  6. Injetor </h2><br>  Crie um projeto C ++ vazio, chame NativeInjector.  O c√≥digo principal est√° na fun√ß√£o Injetar. <br><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Inject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp; dllPath, </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp; processName)</span></span></span><span class="hljs-function"> </span></span>{ DWORD processId = GetProcessIdentificator(processName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (processId == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> invalid_argument(<span class="hljs-string"><span class="hljs-string">"Process dont existed"</span></span>); HANDLE hProcess = OpenProcess(PROCESS_CREATE_THREAD | PROCESS_QUERY_INFORMATION | PROCESS_VM_OPERATION | PROCESS_VM_READ | PROCESS_VM_WRITE, FALSE, processId); HMODULE hModule = GetModuleHandle(<span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span>); FARPROC address = GetProcAddress(hModule, <span class="hljs-string"><span class="hljs-string">"LoadLibraryA"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> payloadSize = <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>) * dllPath.length() + <span class="hljs-number"><span class="hljs-number">1</span></span>; LPVOID allocAddress = VirtualAllocEx( hProcess, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, payloadSize, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE); SIZE_T written; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> writeResult = WriteProcessMemory(hProcess, allocAddress, dllPath.c_str(), payloadSize, &amp; written); DWORD treadId; CreateRemoteThread(hProcess, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, (LPTHREAD_START_ROUTINE) address, allocAddress, <span class="hljs-number"><span class="hljs-number">0</span></span>, &amp; treadId); CloseHandle(hProcess); }</code> </pre> <br>  A fun√ß√£o obt√©m o caminho e o nome do processo, procura seu ID pelo nome do processo usando GetProcessIdentificator. <br><br><div class="spoiler">  <b class="spoiler_title">fun√ß√£o GetProcessIdentificator</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">DWORD </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetProcessIdentificator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp; processName)</span></span></span><span class="hljs-function"> </span></span>{ PROCESSENTRY32 processEntry; processEntry.dwSize = <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(PROCESSENTRY32); HANDLE snapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); DWORD processId = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Process32First(snapshot, &amp; processEntry)) { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Process32Next(snapshot, &amp; processEntry)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_stricmp(processEntry.szExeFile, processName.c_str())) { processId = processEntry.th32ProcessID; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } CloseHandle(snapshot); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> processId; }</code> </pre> <br></div></div><br>  Em resumo, GetProcessIdentificator executa todos os processos em execu√ß√£o e procura um processo com o nome apropriado. <br><br><img src="https://habrastorage.org/webt/du/za/p1/duzap1ptnhys_gyk_e1zrjm436e.png"><br>  <i>Figura 3 - o estado inicial do processo</i> <br><br>  Em seguida, a implementa√ß√£o direta da biblioteca, criando um fluxo remoto. <br><br><div class="spoiler">  <b class="spoiler_title">Explica√ß√£o detalhada da fun√ß√£o Injetar</b> <div class="spoiler_text">  Com base no ID encontrado, o processo √© aberto usando a fun√ß√£o OpenProcess com os direitos de criar um encadeamento, receber informa√ß√µes do processo, recursos de grava√ß√£o e leitura.  A fun√ß√£o GetModuleHandle recupera o m√≥dulo da biblioteca kernel32; isso √© feito para obter o endere√ßo da fun√ß√£o LoadLibraryA contida nela pela fun√ß√£o GetProcAddress.  O objetivo do LoadLibrary √© carregar nosso injected.dll no processo especificado.  Ou seja, precisamos chamar o LoadLibrary a partir do processo de seu interesse (‚ÄúDota2.exe‚Äù), para isso criamos remotamente um novo thread usando CreateRemoteThread.  Como um ponteiro para a fun√ß√£o a partir da qual o novo thread inicia, passamos o endere√ßo da fun√ß√£o LoadLibraryA.  Se voc√™ observar a assinatura da fun√ß√£o LoadLibraryA, ser√° necess√°rio o caminho para a biblioteca carregada como argumento - HMODULE LoadLibraryA (LPCSTR lpLibFileName).  Entregamos esse argumento da seguinte maneira: CreateRemoteThread nos par√¢metros ap√≥s o endere√ßo da fun√ß√£o start levar um ponteiro para seus par√¢metros, formamos um ponteiro para lpLibFileName gravando o valor na mem√≥ria do processo usando a fun√ß√£o WriteProcessMemory (depois de alocar mem√≥ria usando o VirtualAllocEx). <br></div></div><br><img src="https://habrastorage.org/webt/wx/8r/5v/wx8r5viycrlhjarivk-02dgh124.png"><br>  <i>Figura 4 - Criando um fluxo remoto</i> <br><br>  Certifique-se de fechar o manipulador de processos no final com a fun√ß√£o CloseHandle; tamb√©m √© poss√≠vel liberar a mem√≥ria alocada.  Nosso injetor est√° pronto e esperando que gravemos a l√≥gica de neg√≥cios em injected.dll com a biblioteca silk_way.lib. <br><br><img src="https://habrastorage.org/webt/no/8c/tr/no8ctrxtn_vz31nad0uj25tb8zs.png"><br>  <i>Figura 5 - Concluindo a implementa√ß√£o da biblioteca</i> <br><br>  Para uma melhor compreens√£o do princ√≠pio, voc√™ pode assistir ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">v√≠deo</a> .  Concluindo, direi que √© uma abordagem mais segura com a implementa√ß√£o direta de c√≥digo no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">thread principal do</a> processo. <br><br><h2>  7. Caminho da Seda </h2><br>  Vamos come√ßar a implementar o silk_way.lib, uma biblioteca est√°tica que cont√©m estruturas de dados, um registrador, um scanner de mem√≥ria e traps.  De fato, peguei uma pequena parte do meu trabalho, algo que pode ser explicado de maneira mais simples, que n√£o est√° muito ligada ao resto, mas ao mesmo tempo resolve o problema. <br><br><h3>  7.1  Estruturas de dados. </h3><br>  Brevemente sobre estruturas de dados: Vetor - lista cl√°ssica, tempo de inser√ß√£o e exclus√£o O (N), pesquisa O (N), mem√≥ria O (N);  Fila - uma fila circular, o tempo de inser√ß√£o e exclus√£o de O (1), sem pesquisa, mem√≥ria O (N);  RBTree - √°rvore vermelho-preta, tempo de inser√ß√£o e exclus√£o O (logN), pesquisa O (logN), mem√≥ria O (N).  Prefiro o hash usado para implementar dicion√°rios em C # e Python, as √°rvores vermelho-pretas que a biblioteca C ++ padr√£o usa.  O motivo √© que um hash √© mais dif√≠cil de implementar corretamente em compara√ß√£o com uma √°rvore (eu encontro e tento variedades de hashes a cada meio ano) e geralmente um hash ocupa mais mem√≥ria (embora funcione mais r√°pido).  Essas estruturas s√£o usadas para criar cole√ß√µes na l√≥gica de neg√≥cios e nas armadilhas. <br><br>  Eu tento n√£o usar estruturas da biblioteca padr√£o e implement√°-las eu mesmo, especificamente n√£o importa no nosso caso, mas √© importante se a sua DLL for depurada ou se o assembly estiver claro (isso √© mais prov√°vel para truques comerciais, que condenamos )  Aconselho voc√™ a escrever todas as estruturas voc√™ mesmo, isso oferece mais oportunidades. <br>  Como exemplo, se voc√™ cria um jogo e n√£o deseja que os ‚Äúalunos‚Äù o fa√ßam a varredura usando o Cheat Engine, √© poss√≠vel criar inv√≥lucros para tipos primitivos e armazenar o valor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">criptografado</a> na mem√≥ria.  De fato, isso n√£o √© uma salva√ß√£o, mas pode eliminar alguns daqueles que est√£o tentando ler e mudar a mem√≥ria do jogo. <br><br><h3>  7.2  Logger </h3><br>  Sa√≠da implementada no console e gravada em um arquivo.  Interface: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ILogger</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>: ILogger(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * _path) { path = path; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~ILogger() {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Log</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * format, ...)</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * path; };</code> </pre> <br>  Implementa√ß√£o para sa√≠da em um arquivo: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MemoryLogger</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ILogger { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: MemoryLogger(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * _path): ILogger(_path) { fopen_s( &amp; fptr, _path, <span class="hljs-string"><span class="hljs-string">"w+"</span></span>); } ~MemoryLogger() { fclose(fptr); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Log</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * format, ...)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>[MAX_LOG_SIZE]; <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>[MAX_LOG_SIZE - <span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; va_list args; va_start(args, format); vsprintf_s(<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>, MAX_LOG_SIZE, format, args); va_end(args); <span class="hljs-built_in"><span class="hljs-built_in">fprintf</span></span>(fptr, <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>: FILE * fptr; };</code> </pre> <br>  A implementa√ß√£o para sa√≠da no console √© a mesma.  Se quisermos usar o log, √© necess√°rio definir a interface ILogger *, declarar o logger necess√°rio, chamar a fun√ß√£o Log com o formato necess√°rio, por exemplo: <br><br><pre> <code class="cpp hljs">ILogger* logger = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MemoryLogger(filename); logger-&gt;Log(<span class="hljs-string"><span class="hljs-string">"(%llu)%s: %d\n"</span></span>, GetCurrentThreadId(), <span class="hljs-string"><span class="hljs-string">"EnumerateThread result"</span></span>, result);</code> </pre> <br><h3>  7.3  Scanner </h3><br>  O scanner est√° comprometido com o fato de exibir o valor da mem√≥ria apontado pelo ponteiro transferido e compar√°-lo com a amostra na mem√≥ria.  A compara√ß√£o funcional com o padr√£o ser√° considerada posteriormente. <br><br>  Interface: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IScanner</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>: IScanner() {} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~IScanner() {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PrintMemory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * title, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * memPointer, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; };</code> </pre> <br>  Implementa√ß√£o de arquivo de cabe√ßalho: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FileScanner</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IScanner { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: FileScanner(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* _path) : IScanner() { fopen_s(&amp;fptr, _path, <span class="hljs-string"><span class="hljs-string">"w+"</span></span>); } ~FileScanner() { fclose(fptr); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PrintMemory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* title, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* memPointer, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>: FILE* fptr; };</code> </pre> <br>  Implementa√ß√£o do arquivo de origem: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> FileScanner::PrintMemory(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* title, <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* memPointer, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> size) { <span class="hljs-built_in"><span class="hljs-built_in">fprintf</span></span>(fptr, <span class="hljs-string"><span class="hljs-string">"%s:\n"</span></span>, title); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; size; i++) <span class="hljs-built_in"><span class="hljs-built_in">fprintf</span></span>(fptr, <span class="hljs-string"><span class="hljs-string">"%x "</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)(*(memPointer + i))); <span class="hljs-built_in"><span class="hljs-built_in">fprintf</span></span>(fptr, <span class="hljs-string"><span class="hljs-string">"\n"</span></span>, title); }</code> </pre> <br>  Para us√°-lo, voc√™ precisa definir a interface IScanner *, declarar o scanner desejado e chamar a fun√ß√£o PrintMemory, onde √© poss√≠vel definir o t√≠tulo, o ponteiro e o comprimento, por exemplo: <br><br><pre> <code class="cpp hljs">IScanner* scan = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConsoleScanner(); scan-&gt;PrintMemory(<span class="hljs-string"><span class="hljs-string">"source orig"</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*)source, <span class="hljs-number"><span class="hljs-number">30</span></span>);</code> </pre> <br><h3>  7.4  Armadilhas </h3><br>  A parte mais interessante da biblioteca silk_way.lib.  Ganchos s√£o usados ‚Äã‚Äãpara alterar o fluxo de execu√ß√£o do programa.  Crie um projeto execut√°vel chamado Sandbox. <br><br><div class="spoiler">  <b class="spoiler_title">A classe Device ser√° o nosso manequim para investigar a opera√ß√£o de armadilhas.</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Unknown</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>: Unknown() {} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: ~Unknown() {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> HRESULT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">QueryInterface</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> ULONG </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddRef</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> ULONG </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Release</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Device</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Unknown { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: Device() : Unknown() {} ~Device() {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> HRESULT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">QueryInterface</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> ULONG </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddRef</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> ULONG </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Release</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Present</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Present()"</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">" "</span></span> &lt;&lt; i &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> i; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EndScene</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> j)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"EndScene()"</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">" "</span></span> &lt;&lt; i &lt;&lt; <span class="hljs-string"><span class="hljs-string">" "</span></span> &lt;&lt; j &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Dispose</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Dispose()"</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">" "</span></span> &lt;&lt; i &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i; };</code> </pre> <br></div></div><br>  A classe Device √© herdada da interface IUnknown, nossa tarefa √© interceptar a chamada das fun√ß√µes Present e EndScene de qualquer inst√¢ncia do Device e chamar as fun√ß√µes originais no receptor.  N√£o sabemos o local no c√≥digo onde e por que essas fun√ß√µes s√£o chamadas, em qual thread. <br><br>  Observando as fun√ß√µes Present e EndScene, vemos que elas s√£o virtuais.  Fun√ß√µes virtuais s√£o necess√°rias para substituir o comportamento da classe pai.  Fun√ß√µes virtuais, assim como n√£o virtuais, s√£o um ponteiro para uma mem√≥ria na qual os c√≥digos de opcodes e argumentos s√£o gravados.  Como as fun√ß√µes virtuais diferem entre herdeiros e pais, elas t√™m ponteiros diferentes (s√£o fun√ß√µes completamente diferentes) e s√£o armazenadas na Tabela de m√©todo virtual (VMT).  Esta tabela √© armazenada na mem√≥ria e √© um ponteiro para um ponteiro de classe. Encontramos para Device: <br><br><pre> <code class="cpp hljs">Device* device = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Device(); <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> vmt = **(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>**)&amp;device;</code> </pre> <br>  O VMT armazena ponteiros para fun√ß√µes virtuais; se quisermos herdar do dispositivo, o herdeiro conter√° seu VMT.  O VMT armazena ponteiros de fun√ß√£o sequencialmente com uma etapa igual ao tamanho do ponteiro (para x86 √© 4 bytes, para x64 √© 8), correspondendo √† ordem em que a fun√ß√£o √© definida na classe.  Encontre os ponteiros para as fun√ß√µes Present e EndScene, localizadas nos terceiro e quarto lugares: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*pPresent)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Device*)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*pEndScene)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Device*, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> j)</span></span></span></span>; pPresent ptrPresent = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; pEndScene ptrEndScene = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//declare Device and find pointer vmt ptrPresent = (pPresent)(*(unsigned long long*)(vmt + 8 * 3)); ptrEndScene = (pEndScene)(*(unsigned long long*)(vmt + 8 * 4)); }</span></span></code> </pre> <br>  Tamb√©m √© importante que o ponteiro para o m√©todo de classe contenha o primeiro argumento como refer√™ncia √† inst√¢ncia da classe.  Em C ++, C #, isso est√° oculto para n√≥s, e o compilador sabe disso - no Python self √© explicitamente indicado pelo primeiro par√¢metro no m√©todo de classe.  Mais sobre a conven√ß√£o de chamadas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> , voc√™ precisa procurar por essa chamada. <br><br>  Considere a instru√ß√£o e9 ff 3a fd ff - aqui e9 √© um c√≥digo de opera√ß√£o (com mnem√¥nicos JMP) que instrui o processador a mudar o ponteiro para a instru√ß√£o (EIP para x86, RIP para x64), pule do endere√ßo atual para FFFD3AFF (4294785791).  Tamb√©m √© importante notar que na mem√≥ria os n√∫meros s√£o armazenados "vice-versa".  As fun√ß√µes t√™m um pr√≥logo e um ep√≠logo e s√£o armazenadas na se√ß√£o .code.  Vamos ver o que √© armazenado com o ponteiro para a fun√ß√£o Present usando o scanner: <br><br><pre> <code class="cpp hljs">IScanner* scan = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConsoleScanner(); scan-&gt;PrintMemory(<span class="hljs-string"><span class="hljs-string">"Present"</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*)ptrPresent, <span class="hljs-number"><span class="hljs-number">30</span></span>);</code> </pre> <br>  No console, vemos: <br><br><pre> <code class="plaintext hljs">Present: 48 89 4c 24 8 48 83 ec 28 48 8d 15 40 4a 0 0 48 8b d 71 47 0 0 e8 64 10 0 0 48 8d</code> </pre> <br>  Para entender o conjunto desses c√≥digos, voc√™ pode olhar para a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tabela</a> ou usar os desmontadores dispon√≠veis.  Vamos usar um desmontador pronto - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">hde</a> (mecanismo de desmontagem de hackers).  Voc√™ tamb√©m pode olhar para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">distorm</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">capstone</a> para compara√ß√£o.  Passe um ponteiro para uma fun√ß√£o para qualquer desmontador e ele dir√° quais c√≥digos de c√≥digo ele usa, os valores dos argumentos e assim por diante. <br><br><h4>  7.4.1 Gancho Opcode </h4><br>  Agora estamos prontos para ir diretamente √†s armadilhas.  Veremos o gancho Opcode e o ponto de interrup√ß√£o do hardware.  As <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">armadilhas</a> mais <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">comuns</a> que eu recomendo implementar e explorar. <br><br>  Provavelmente, a armadilha mais comumente usada e simples √© o Opcode Hook (no artigo que lista as armadilhas, √© chamado de patch de byte) - observe que ele √© facilmente reconhecido pelo anti-cheat quando usado incorretamente (sem entender como o anti-cheat funciona, sem saber em que √°rea e se√ß√£o da mem√≥ria ele √© varrido). o momento atual e outras coisas que a proibi√ß√£o n√£o diminuir√° a espera).  Quando usada com habilidade, √© uma √≥tima armadilha, r√°pida e f√°cil de entender. <br>  Se, ao ler um artigo, voc√™ estiver reproduzindo c√≥digo simultaneamente e estiver no modo Debug, mude para Release - isso √© importante. <br><br>  Ent√£o, deixe-me lembr√°-lo, precisamos interceptar a execu√ß√£o das fun√ß√µes Present e EndScene. <br>  Implementamos interceptores - fun√ß√µes nas quais queremos transferir o controle: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PresentHook</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Device* device)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"PresentHook"</span></span> &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EndSceneHook</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Device* device, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> j)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"EndSceneHook"</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">" "</span></span> &lt;&lt; j &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; }</code> </pre> <br>  Vamos pensar nas abstra√ß√µes que precisamos.  Precisamos de uma interface que nos permita definir uma armadilha, remov√™-la e fornecer informa√ß√µes sobre ela.  As informa√ß√µes sobre a armadilha devem conter um ponteiro para a fun√ß√£o interceptada, o receptor e as fun√ß√µes de trampolim (o fato de termos interceptado a fun√ß√£o n√£o significa que ela n√£o √© mais necess√°ria, tamb√©m queremos poder us√°-la - o trampolim ajudar√° a chamar a fun√ß√£o interceptada original). <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> pack(push, 1) struct HookRecord { HookRecord() { reservationLen = 0; sourceReservation = new void*[RESERV_SIZE](); } ~HookRecord() { reservationLen = 0; delete[] sourceReservation; } void* source; void* destination; void* pTrampoline; int reservationLen; void* sourceReservation; }; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> pack(pop) class IHook { protected: IHook() {} public: virtual ~IHook() {} virtual void SetExceptionHandler( PVECTORED_EXCEPTION_HANDLER pVecExcHandler) = 0; virtual int SetHook(void* source, void* destination) = 0; virtual int UnsetHook(void* source) = 0; virtual silk_data::Vector</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;HookRecord*&gt;* GetInfo() = 0; virtual HookRecord* GetRecordBySource(void* source) = 0; };</span></span></span></span></code> </pre> <br>  A interface do IHook nos fornece esses recursos.  Queremos que quando qualquer inst√¢ncia da classe Device chama as fun√ß√µes Present e EndScene (ou seja, o ponteiro RIP vai para esses endere√ßos), nossas fun√ß√µes PresentHook e EndSceneHook s√£o executadas de acordo. <br><br>  Imagine visualmente como a fun√ß√£o interceptada, o receptor e o trampolim est√£o localizados na mem√≥ria (se√ß√£o .code) no momento em que o controle entra na fun√ß√£o interceptada: <br><br><img src="https://habrastorage.org/webt/rc/sz/dw/rcszdw_mh77t0jlxithbmseq5i8.png"><br>  <i>Figura 6 - O estado inicial da mem√≥ria, a execu√ß√£o entra na fun√ß√£o interceptada</i> <br><br>  Agora queremos que o RIP (seta vermelha) v√° da origem at√© o in√≠cio do destino.  Como fazer isso?  Como j√° foi dito acima, a mem√≥ria de origem cont√©m um c√≥digo operacional que o processador executar√° quando a execu√ß√£o chegar √† fonte.  Em ess√™ncia, precisamos pular de uma parte para outra, redirecionar o ponteiro do RIP.  Como voc√™ deve ter adivinhado, existe um c√≥digo de opera√ß√£o que permite transferir o controle do endere√ßo atual para o desejado, esses mnem√¥nicos JMP s√£o chamados. <br><br>  Voc√™ pode pular diretamente para o endere√ßo desejado ou, em rela√ß√£o ao endere√ßo atual, esses saltos podem ser encontrados na placa - ff e e9, respectivamente.  Crie estruturas para estas instru√ß√µes: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> pack(push, 1) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// 32-bit relative jump. typedef struct { unsigned char opcode; unsigned int delta; } JMP_REL; // 64-bit absolute jump. typedef struct { unsigned char opcode1; unsigned char opcode2; unsigned int dummy; unsigned long long address; } JMP_ABS; #pragma pack(pop)</span></span></span></span></code> </pre> <br>  A instru√ß√£o de salto relativa √© mais curta, mas h√° uma limita√ß√£o - unsigned int diz que voc√™ pode pular dentro de 4.294.967.295, o que n√£o √© suficiente para x64. <br>  Assim, o endere√ßo da fun√ß√£o de destino do receptor de destino pode facilmente exceder esse valor e ficar fora do int n√£o assinado, o que √© bastante poss√≠vel para o processo x64 (para x86 tudo √© muito mais simples e voc√™ pode limitar-se a esse salto relativamente relativo para implementar o gancho Opcode).  Um salto direto leva 14 bytes; para compara√ß√£o, um salto relativo √© de apenas 5 (empacotamos as estruturas, preste aten√ß√£o ao pacote #pragma (push, 1)). <br><br>  Precisamos reescrever o valor na fonte para uma dessas instru√ß√µes de salto. <br>  Antes de capturar uma fun√ß√£o, voc√™ deve estud√°-la - a maneira mais f√°cil de fazer isso √© com um depurador (mostrarei como fazer isso com o x64dbg posteriormente) ou com um desmontador.  No momento, j√° produzimos 30 bytes desde o in√≠cio, a instru√ß√£o 48 89 4c 24 8 ocupa 5 bytes. <br>  Vamos implementar um salto relativo.  Eu gosto mais dessa op√ß√£o por causa do comprimento da instru√ß√£o.  A id√©ia √© a seguinte: substitu√≠mos os 5 primeiros bytes da fun√ß√£o original, preservando os bytes alterados, substituindo-os por um salto relativo para o endere√ßo da instru√ß√£o, que fica dentro do int n√£o assinado. <br><br><img src="https://habrastorage.org/webt/sp/vm/gs/spvmgsf5iymwkeyncackpgaldty.png"><br>  <i>Figura 7 - Os 5 bytes de origem da fun√ß√£o de origem s√£o substitu√≠dos por um salto relativo</i> <br><br>  O que nos d√° um salto para a mem√≥ria alocada (regi√£o roxa), como nos aproximamos da transfer√™ncia do controle para o destino com esta a√ß√£o?  Na mem√≥ria alocada por n√≥s, h√° um salto direto, que mover√° o RIP para o destino. <br><br><img src="https://habrastorage.org/webt/nl/-c/u2/nl-cu2sfhlsg-7nvfdmkzmlz8fq.png"><br>  <i>Figura 8 - Alternando o RIP para a fun√ß√£o receptor</i> <br><br>  Resta descobrir como chamar a fun√ß√£o capturada.  Precisamos executar as instru√ß√µes atoladas e iniciar a execu√ß√£o da parte intocada da fonte.  N√≥s procedemos da seguinte maneira - salve as instru√ß√µes danificadas no in√≠cio do trampolim, lembre-se de quantos bytes foram danificados e pule diretamente para source + corruptLen, para as instru√ß√µes "saud√°veis". <br><br>  Execu√ß√£o de instru√ß√µes salvas apagadas por um salto relativo: <br><br><img src="https://habrastorage.org/webt/ea/yt/yc/eaytyckn1czk5ud3iid3fagbey0.png"><br>  <i>Figura 9 - Usando um trampolim para chamar uma fun√ß√£o interceptada</i> <br><br>  Execu√ß√£o adicional de instru√ß√µes que n√£o afetaram o mashing: <br><br><img src="https://habrastorage.org/webt/mh/7f/-w/mh7f-wck4tzh20cj7jefie3yl3q.png"><br>  <i>Figura 10 - Continua√ß√£o da execu√ß√£o das instru√ß√µes da fun√ß√£o interceptada</i> <br><br><div class="spoiler">  <b class="spoiler_title">C√≥digo que implementa a ideia descrita acima</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> OpcodeHook::SetHook(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* source, <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* destination) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> record = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HookRecord(); record-&gt;source = source; record-&gt;destination = destination; info-&gt;PushBack(record); JMP_ABS pattern = {<span class="hljs-number"><span class="hljs-number">0xFF</span></span>, <span class="hljs-number"><span class="hljs-number">0x25</span></span>, <span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-comment"><span class="hljs-comment">// JMP[RIP + 6] empty 0x0000000000000000 }; // absolute address pattern.address = (ULONG_PTR)source; int currentLen = 0; int redLine = sizeof(JMP_REL); while (currentLen &lt; redLine) { hde64s context; const void* pSource = (void*)((unsigned char*)source + currentLen); hde64_disasm(pSource, &amp;context); memcpy((unsigned char*)record-&gt;sourceReservation + currentLen, pSource, context.len); record-&gt;reservationLen += context.len; currentLen += context.len; } int trampolineMemorySize = 2 * sizeof(JMP_ABS) + record-&gt;reservationLen; record-&gt;pTrampoline = AllocateMemory(source, trampolineMemorySize); pattern.address = (unsigned long long)(unsigned char*)source + record-&gt;reservationLen; memcpy((unsigned char*)record-&gt;pTrampoline, record-&gt;sourceReservation, record-&gt;reservationLen); int offset = record-&gt;reservationLen; memcpy((unsigned char*)record-&gt;pTrampoline + offset, &amp;pattern, sizeof(JMP_ABS)); pattern.address = (ULONG_PTR)destination; ULONG_PTR relay = (ULONG_PTR)record-&gt;pTrampoline + sizeof(pattern) + record-&gt;reservationLen; memcpy((void*)relay, &amp;pattern, sizeof(pattern)); DWORD oldProtect = 0; VirtualProtect(source, sizeof(JMP_REL), PAGE_EXECUTE_READWRITE, &amp;oldProtect); JMP_REL* pJmpRelPattern = (JMP_REL*)source; pJmpRelPattern-&gt;opcode = 0xE9; pJmpRelPattern-&gt;delta = (unsigned int)((LPBYTE)relay - ((LPBYTE)source + sizeof(JMP_REL))); VirtualProtect(source, sizeof(JMP_REL), oldProtect, &amp;oldProtect); return SUCCESS_CODE; }</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Explica√ß√£o da fun√ß√£o SetHook</b> <div class="spoiler_text">  √â criado um registro que armazena informa√ß√µes sobre a intercepta√ß√£o, ap√≥s o que o registro √© adicionado √† cole√ß√£o.  As instru√ß√µes s√£o rastreadas desde o in√≠cio do endere√ßo de origem at√© que a instru√ß√£o de salto relativo possa ser completamente inserida (5 bytes), as instru√ß√µes bloqueadas s√£o copiadas para a reserva e seu comprimento √© lembrado. <br><blockquote>  Um ponto muito importante √© que precisamos alocar mem√≥ria para o trampolim e para a retransmiss√£o, na qual armazenaremos instru√ß√µes para redirecionar o fluxo da origem para o destino, e o endere√ßo dessa mem√≥ria deve estar dentro dos limites que um salto relativo pode se dar ao luxo de pular (sem sinal) int). </blockquote><br>  Essa funcionalidade implementa a fun√ß√£o AllocateMemory. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* OpcodeHook::AllocateMemory(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* origin, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> size) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEMORY_RANGE = <span class="hljs-number"><span class="hljs-number">0x40000000</span></span>; SYSTEM_INFO sysInfo; GetSystemInfo(&amp;sysInfo); ULONG_PTR minAddr = (ULONG_PTR)sysInfo.lpMinimumApplicationAddress; ULONG_PTR maxAddr = (ULONG_PTR)sysInfo.lpMaximumApplicationAddress; ULONG_PTR castedOrigin = (ULONG_PTR)origin; ULONG_PTR minDesired = castedOrigin - MEMORY_RANGE; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (minDesired &gt; minAddr &amp;&amp; minDesired &lt; castedOrigin) minAddr = minDesired; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> test = <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(ULONG_PTR); ULONG_PTR maxDesired = castedOrigin + MEMORY_RANGE - size; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (maxDesired &lt; maxAddr &amp;&amp; maxDesired &gt; castedOrigin) maxAddr = maxDesired; DWORD granularity = sysInfo.dwAllocationGranularity; ULONG_PTR freeMemory = <span class="hljs-number"><span class="hljs-number">0</span></span>; ULONG_PTR ptr = castedOrigin; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (ptr &gt;= minAddr) { ptr = FindPrev(ptr, minAddr, granularity, size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ptr == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; LPVOID pAlloc = VirtualAlloc((LPVOID)ptr, size, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pAlloc != <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pAlloc; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (ptr &lt; maxAddr) { ptr = FindNext(ptr, maxAddr, granularity, size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ptr == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; LPVOID pAlloc = VirtualAlloc((LPVOID)ptr, size, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pAlloc != <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pAlloc; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; }</code> </pre> <br>  A id√©ia √© simples - vamos partir da mem√≥ria, come√ßando de um determinado endere√ßo (no nosso caso, um ponteiro para a fonte) para cima e para baixo at√© encontrarmos um peda√ßo adequado de tamanho livre. <br><br>  Voltar para a fun√ß√£o SetHook.  Copie os bytes gastos da origem para a mem√≥ria alocada e insira imediatamente um salto direto na origem + corrompido para continuar a execu√ß√£o com instru√ß√µes n√£o danificadas. <br><br>  A seguir, √© a instala√ß√£o do ponteiro de retransmiss√£o, respons√°vel por redirecionar o encadeamento de execu√ß√£o para o destino, saltando diretamente para o endere√ßo do receptor.  No final, alteramos a fonte - configuramos as permiss√µes de grava√ß√£o para o local da mem√≥ria em que a fun√ß√£o est√° localizada e substitu√≠mos os primeiros 5 bytes por um salto relativo que leva ao endere√ßo do rel√©. <br></div></div><br>  Montamos uma armadilha, mas ela tamb√©m precisa ser capaz de limpar.  Quebrando - n√£o criando, a id√©ia √© simples - retornaremos os bytes gastos da fonte, excluiremos o registro sobre a intercepta√ß√£o da cole√ß√£o e liberaremos a mem√≥ria alocada: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> OpcodeHook::UnsetHook(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* source) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> record = GetRecordBySource(source); DWORD oldProtect = <span class="hljs-number"><span class="hljs-number">0</span></span>; VirtualProtect(source, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(JMP_REL), PAGE_EXECUTE_READWRITE, &amp;oldProtect); <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(source, record-&gt;sourceReservation, record-&gt;reservationLen); VirtualProtect(source, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(JMP_REL), oldProtect, &amp;oldProtect); info-&gt;Erase(record); FreeMemory(record); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SUCCESS_CODE; }</code> </pre> <br>  Testando o trabalho.  Troque imediatamente nossos receptores para que eles possam chamar as fun√ß√µes interceptadas usando o trampolim: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PresentHook</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Device* device)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> record = hook-&gt;GetRecordBySource(ptrPresent); pPresent pTrampoline = (pPresent)record-&gt;pTrampoline; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> result = pTrampoline(device); <span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"PresentHook"</span></span> &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EndSceneHook</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Device* device, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> j)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> record = hook-&gt;GetRecordBySource(ptrEndScene); pEndScene pTrampoline = (pEndScene)record-&gt;pTrampoline; pTrampoline(device, <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"EndSceneHook"</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">" "</span></span> &lt;&lt; j &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; }</code> </pre> <br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Testamos se fizemos tudo corretamente, se a mem√≥ria est√° fluindo, se tudo est√° sendo executado corretamente.</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { Device* device = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Device(); device-&gt;i = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> vmt = **(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>**)&amp;device; ptrPresent = (pPresent)(*(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>*)(vmt + <span class="hljs-number"><span class="hljs-number">8</span></span> * <span class="hljs-number"><span class="hljs-number">3</span></span>)); ptrEndScene = (pEndScene)(*(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>*)(vmt + <span class="hljs-number"><span class="hljs-number">8</span></span> * <span class="hljs-number"><span class="hljs-number">4</span></span>)); IScanner* scan = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConsoleScanner(); scan-&gt;PrintMemory(<span class="hljs-string"><span class="hljs-string">"Present"</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*)ptrPresent, <span class="hljs-number"><span class="hljs-number">30</span></span>); hook = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OpcodeHook(); hook-&gt;SetHook(ptrPresent, &amp;PresentHook); hook-&gt;SetHook(ptrEndScene, &amp;EndSceneHook); device-&gt;Present(); device-&gt;EndScene(<span class="hljs-number"><span class="hljs-number">7</span></span>); device-&gt;Present(); device-&gt;EndScene(<span class="hljs-number"><span class="hljs-number">7</span></span>); device-&gt;i = <span class="hljs-number"><span class="hljs-number">5</span></span>; ptrPresent(device); ptrEndScene(device, <span class="hljs-number"><span class="hljs-number">9</span></span>); hook-&gt;UnsetHook(ptrPresent); hook-&gt;UnsetHook(ptrEndScene); ptrPresent(device); ptrEndScene(device, <span class="hljs-number"><span class="hljs-number">7</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> hook; <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> device; } }</code> </pre> <br></div></div><br>  Isso funciona.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voc√™ tamb√©m pode verificar x64dgb. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lembre-se, no come√ßo eu pedi para voc√™ trabalhar na vers√£o Release? </font><font style="vertical-align: inherit;">Agora v√° para Debug e execute o programa. </font><font style="vertical-align: inherit;">O programa trava ... A armadilha √© acionada, mas uma tentativa de chamar o trampolim gera uma exce√ß√£o, que diz que o endere√ßo no qual chamamos trampolim n√£o √© para execu√ß√£o. </font><font style="vertical-align: inherit;">Do que perdemos? </font><font style="vertical-align: inherit;">Qual √© o problema da compila√ß√£o de depura√ß√£o? </font><font style="vertical-align: inherit;">Come√ßamos e olhamos para o c√≥digo de opera√ß√£o da fun√ß√£o Presente:</font></font><br><br><pre> <code class="plaintext hljs">Present: e9 f4 36 0 0 e9 df 8d 0 0 e9 aa b0 0 0 e9 75 3e 0 0 e9 80 38 0 0 e9 da 81 0 0</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ao executar em x64dbg, voc√™ pode ver o seguinte. </font><i><font style="vertical-align: inherit;">Figura 11 - Instru√ß√µes de constru√ß√£o de depura√ß√£o</font></i><font style="vertical-align: inherit;"> No Debug, o c√≥digo de opera√ß√£o mudou, agora o compilador adiciona o salto relativo e9 f4 36 0. Todas as fun√ß√µes s√£o agrupadas no salto, incluindo o principal e o ponto de entrada no mainCRTStartup. Outro c√≥digo de opera√ß√£o, bem, ok, ele teve que ser copiado para o trampolim, quando o trampolim foi chamado, esse salto relativo deveria ser chamado, depois um salto direto para a parte n√£o danificada da fonte. </font><font style="vertical-align: inherit;">Aqui fica claro que tudo √© feito conforme implementamos, apenas o salto relativo a esse e ao relativo, que sua execu√ß√£o a partir de diferentes endere√ßos, fonte e trampolim, exp√µe o RIP a valores completamente diferentes.</font></font><br><br> <a href=""><img src="https://habrastorage.org/webt/sq/ql/ea/sqqlealqgipytxtvqo65agm9ky8.png"></a> <br> <i><font style="vertical-align: inherit;"></font></i> <br><br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Na minha humilde experi√™ncia, a implementa√ß√£o do caso de salto relativo cobre 99% do uso. Existem v√°rios outros c√≥digos de opera√ß√£o que devem ser tratados separadamente. Lembre-se de que antes de colocar uma armadilha em uma fun√ß√£o, voc√™ n√£o deve ser muito pregui√ßoso e estud√°-la. N√£o vou incomod√°-lo e acrescentarei funcionalidade √† vers√£o 100% (novamente, na minha humilde experi√™ncia); se voc√™ precisar ou estiver interessado, poder√° ver como essas bibliotecas s√£o organizadas e especificamente quais outros casos eles verificam - ser√° f√°cil fazer isso. se voc√™ descobriu do que se trata.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um salto relativo √© realmente bastante comum, ent√£o proponho implement√°-lo. </font><font style="vertical-align: inherit;">Um salto relativo consiste no c√≥digo de opera√ß√£o e9 e no valor que voc√™ precisa para saltar em rela√ß√£o ao endere√ßo atual. </font><font style="vertical-align: inherit;">Dessa forma, voc√™ pode descobrir onde pular e pular direto do trampolim com um pulo direto. </font><font style="vertical-align: inherit;">Mesmo se encontrarmos um novo salto relativo l√°, ele j√° ser√° do endere√ßo correto.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementa√ß√£o da instala√ß√£o da armadilha levando em considera√ß√£o o salto relativo</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> OpcodeHook::SetHook(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* source, <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* destination) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> record = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HookRecord(); record-&gt;source = source; record-&gt;destination = destination; info-&gt;PushBack(record); JMP_ABS pattern = {<span class="hljs-number"><span class="hljs-number">0xFF</span></span>, <span class="hljs-number"><span class="hljs-number">0x25</span></span>, <span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-comment"><span class="hljs-comment">// JMP[RIP + 6] empty 0x0000000000000000 }; // address pattern.address = (ULONG_PTR)source; int currentLen = 0; bool isJmpOpcode = false; int redLine = sizeof(JMP_REL); while (currentLen &lt; redLine &amp;&amp; !isJmpOpcode) { hde64s context; const void* pSource = (void*)((unsigned char*)source + currentLen); hde64_disasm(pSource, &amp;context); if (context.opcode == 0xE9) { ULONG_PTR ripPtr = (ULONG_PTR)pSource + context.len + (INT32)context.imm.imm32; pattern.address = ripPtr; isJmpOpcode = true; } memcpy((unsigned char*)record-&gt;sourceReservation + currentLen, pSource, context.len); record-&gt;reservationLen += context.len; currentLen += context.len; } int trampolineMemorySize = isJmpOpcode ? 2 * sizeof(JMP_ABS) : 2 * sizeof(JMP_ABS) + record-&gt;reservationLen; record-&gt;pTrampoline = AllocateMemory(source, trampolineMemorySize); if (!isJmpOpcode) { pattern.address = (unsigned long long)(unsigned char*)source + record-&gt;reservationLen; memcpy((unsigned char*)record-&gt;pTrampoline, record-&gt;sourceReservation, record-&gt;reservationLen); } int offset = isJmpOpcode ? 0 : record-&gt;reservationLen; memcpy((unsigned char*)record-&gt;pTrampoline + offset, &amp;pattern, sizeof(JMP_ABS)); pattern.address = (ULONG_PTR)destination; ULONG_PTR relay = (ULONG_PTR)record-&gt;pTrampoline + sizeof(pattern) + record-&gt;reservationLen; memcpy((void*)relay, &amp;pattern, sizeof(pattern)); DWORD oldProtect = 0; VirtualProtect(source, sizeof(JMP_REL), PAGE_EXECUTE_READWRITE, &amp;oldProtect); JMP_REL* pJmpRelPattern = (JMP_REL*)source; pJmpRelPattern-&gt;opcode = 0xE9; pJmpRelPattern-&gt;delta = (unsigned int)((LPBYTE)relay - ((LPBYTE)source + sizeof(JMP_REL))); VirtualProtect(source, sizeof(JMP_REL), oldProtect, &amp;oldProtect); return SUCCESS_CODE; }</span></span></code> </pre> <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se o desmontador retornar informa√ß√µes de que o c√≥digo de opera√ß√£o deste comando √© e9, calculamos o endere√ßo para ir para (ULONG_PTR ripPtr = (ULONG_PTR) pSource + context.len + (INT32) context.imm.imm32) e gravamos o endere√ßo no trampolim como o valor do argumento de salto direto. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tamb√©m observo que em um ambiente com v√°rios threads, uma situa√ß√£o pode surgir quando, no momento da instala√ß√£o / remo√ß√£o de um gancho, um dos threads pode come√ßar a executar a fun√ß√£o que capturamos - como resultado, o processo ir√° cair. Parte de como lidar com isso ser√° descrita em Hardware Breakpoint.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se voc√™ precisar de uma ferramenta comprovada, quer ter certeza de que sua armadilha funcionar√°, n√£o ter√° suas pr√≥prias id√©ias e n√£o estudar√° o pr√≥logo de fun√ß√µes - use solu√ß√µes prontas, por exemplo, a Microsoft oferece sua pr√≥pria biblioteca de desvio. </font><font style="vertical-align: inherit;">Eu n√£o uso essas bibliotecas e uso uma solu√ß√£o criada por v√°rios motivos; portanto, n√£o posso aconselhar algo, s√≥ posso nomear as bibliotecas que estudei para descobrir algo novo e us√°-lo: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PolyHook</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MinHook</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EasyHook</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (especialmente se voc√™ precisar de ganchos em C #).</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.4.2 </font><font style="vertical-align: inherit;">Ponto de interrup√ß√£o do hardware</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O Opcode Hook √© uma armadilha simples e r√°pida, mas n√£o a mais eficiente. Um anti-cheat pode rastrear facilmente uma altera√ß√£o em uma parte da mem√≥ria, mas o Gancho Opcode pode ser usado com rela√ß√£o ao pr√≥prio anti-cheat ou √† intercepta√ß√£o de chamadas do sistema (por exemplo, NtSetInformationThread) que ele usa. O ponto de interrup√ß√£o do hardware √© uma armadilha que n√£o altera a mem√≥ria do processo. Vi t√≥picos em f√≥runs perguntando se o VAC estava seguindo essa armadilha - as respostas geralmente s√£o variadas. Pessoalmente, o VAC n√£o me proibiu de us√°-los e n√£o redefiniu os registros (foi h√° pouco menos de seis meses atr√°s, talvez algo tenha mudado).</font></font><br><blockquote>    ,   ,  VAC   DR      /,  -      ,    .    HWBP  ,  -  ,     ,   ,        DR0-DR7    . </blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O HWBP usa registros especiais do processador para interromper a execu√ß√£o do encadeamento. Se o contexto do fluxo contiver os registradores DR0-DR7 definidos de uma certa maneira e o RIP for para um dos quatro endere√ßos armazenados em DR0-DR3, √© lan√ßada uma exce√ß√£o que pode ser capturada pelo tipo de exce√ß√£o e pelo estado do contexto, determinar em qual endere√ßo o controle lan√ßou a exce√ß√£o e concluir - uma armadilha ou n√£o. Uma limita√ß√£o significativa dessa abordagem √© que voc√™ pode usar apenas quatro fun√ß√µes por vez e defini-las separadamente para cada encadeamento, o que gera inconvenientes se a intercepta√ß√£o for configurada e uma nova for criada, ou se for criada uma nova / se o encadeamento antigo for recriado, causando a intercepta√ß√£o. Este n√£o √© um obst√°culo especial e √© governado pela intercepta√ß√£o da fun√ß√£o BaseThreadInitThunk; a restri√ß√£o no uso de 4 traps n√£o me incomodou pessoalmente.Se o n√∫mero de ganchos for cr√≠tico para voc√™, observe a abordagem do PageGuard.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Portanto, a tarefa √© a mesma - como estamos na sandbox (projeto Sandbox), √© necess√°rio interceptar os m√©todos da classe Device Present e EndScene na qual chamar os m√©todos originais. </font><font style="vertical-align: inherit;">J√° temos uma interface pronta para armadilhas - IHook, vamos lidar com o trabalho de pontos de interrup√ß√£o "de ferro". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O princ√≠pio √© o seguinte: existem quatro registradores DR0-DR3 "ativos" nos quais o endere√ßo pode ser gravado, dependendo da configura√ß√£o do registro de controle DR7 ao tentar escrever, ler ou executar no endere√ßo especificado, uma exce√ß√£o no tipo EXCEPTION_SINGLE_STEP ocorrer√°, que dever√° ser processada em um manipulador registrado anteriormente . </font><font style="vertical-align: inherit;">Voc√™ pode usar o manipulador SEH e VEH - n√≥s o usaremos, pois ele tem uma prioridade mais alta. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Percebemos esta ideia:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> HardwareBPHook::SetHook(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* source, <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* destination, HANDLE* hThread, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>* reg) { CONTEXT context; ZeroMemory(&amp;context, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(context)); context.ContextFlags = CONTEXT_DEBUG_REGISTERS; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!GetThreadContext(*hThread, &amp;context)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ERROR_GET_CONTEXT; *(&amp;context.Dr0 + *reg) = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)source; context.Dr7 |= <span class="hljs-number"><span class="hljs-number">1U</span></span>LL &lt;&lt; (<span class="hljs-number"><span class="hljs-number">2</span></span> * (*reg)); context.Dr7 |= HW_EXECUTE &lt;&lt; ((*reg) * <span class="hljs-number"><span class="hljs-number">4</span></span> + <span class="hljs-number"><span class="hljs-number">16</span></span>); context.Dr7 |= HW_LENGTH &lt;&lt; ((*reg) * <span class="hljs-number"><span class="hljs-number">4</span></span> + <span class="hljs-number"><span class="hljs-number">18</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!SetThreadContext(*hThread, &amp;context)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ERROR_SET_CONTEXT; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SUCCESS_CODE; }</code> </pre> <br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que acontece no c√≥digo</font></font></b> <div class="spoiler_text"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esse c√≥digo recebe o contexto de um encadeamento espec√≠fico, ap√≥s o recebimento bem-sucedido, insere o endere√ßo da fun√ß√£o que est√° sendo interceptada em um registro livre, define o registro de controle DR7. </font><font style="vertical-align: inherit;">Finalmente, o contexto alterado √© definido.</font></font><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em mais detalhes sobre o que s√£o DR6 e DR7, bem como a abordagem PageGuard, posso aconselhar o Gray Hat Python: programa√ß√£o em Python para hackers e engenheiros reversos. Em suma, o DR7 ativa / desativa o uso de um registro "ativo" - mesmo se algum dos registros DR0-DR3 contiver um endere√ßo, mas no DR7 o sinalizador do registro correspondente estiver desativado, o ponto de interrup√ß√£o n√£o funcionar√°. O DR7 tamb√©m define o tipo de trabalho com o endere√ßo no qual √© necess√°rio gerar uma exce√ß√£o - se o endere√ßo foi lido, se o registro foi feito ou se o endere√ßo √© usado para executar a instru√ß√£o (estamos interessados ‚Äã‚Äãna √∫ltima op√ß√£o). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A remo√ß√£o de uma armadilha tamb√©m √© bastante simples e √© feita atrav√©s do registro de controle DR7.</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> HardwareBPHook::UnsetHook(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* source, HANDLE* hThread) { CONTEXT context; ZeroMemory(&amp;context, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(context)); context.ContextFlags = CONTEXT_DEBUG_REGISTERS; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!GetThreadContext(*hThread, &amp;context)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ERROR_GET_CONTEXT; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; DEBUG_REG_COUNT; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)source == *(&amp;context.Dr0 + i)) { info-&gt;GetItem(i)-&gt;source = <span class="hljs-number"><span class="hljs-number">0</span></span>; *(&amp;context.Dr0 + i) = <span class="hljs-number"><span class="hljs-number">0</span></span>; context.Dr7 &amp;= ~(<span class="hljs-number"><span class="hljs-number">1U</span></span>LL &lt;&lt; (<span class="hljs-number"><span class="hljs-number">2</span></span> * i)); context.Dr7 &amp;= ~(<span class="hljs-number"><span class="hljs-number">3</span></span> &lt;&lt; (i * <span class="hljs-number"><span class="hljs-number">4</span></span> + <span class="hljs-number"><span class="hljs-number">16</span></span>)); context.Dr7 &amp;= ~(<span class="hljs-number"><span class="hljs-number">3</span></span> &lt;&lt; (i * <span class="hljs-number"><span class="hljs-number">4</span></span> + <span class="hljs-number"><span class="hljs-number">18</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!SetThreadContext(*hThread, &amp;context)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ERROR_SET_CONTEXT; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SUCCESS_CODE; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resta lidar com os threads - a intercepta√ß√£o deve ser configurada para os threads que chamam a fun√ß√£o interceptada. </font><font style="vertical-align: inherit;">N√≥s n√£o vamos nos preocupar com isso.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Montamos uma armadilha para todos os threads do processo.</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> HardwareBPHook::SetHook(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* source, <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* destination) { THREADENTRY32 te32; HANDLE hThread = CreateToolhelp32Snapshot(TH32CS_SNAPTHREAD, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hThread == INVALID_HANDLE_VALUE) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ERROR_ENUM_THREAD_START; te32.dwSize = <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(THREADENTRY32); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Thread32First(hThread, &amp;te32)) { CloseHandle(hThread); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ERROR_ENUM_THREAD_START; } DWORD dwOwnerPID = GetCurrentProcessId(); <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> isRegDefined = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> freeReg = <span class="hljs-number"><span class="hljs-number">-1</span></span>; Freeze(); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (te32.th32OwnerProcessID == dwOwnerPID) { HANDLE openThread = OpenThread(THREAD_ALL_ACCESS, FALSE, te32.th32ThreadID); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isRegDefined) { CONTEXT context; ZeroMemory(&amp;context, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(context)); context.ContextFlags = CONTEXT_DEBUG_REGISTERS; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!GetThreadContext(openThread, &amp;context)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ERROR_GET_CONTEXT; freeReg = GetFreeReg(&amp;context.Dr7); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (freeReg == <span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ERROR_GET_FREE_REG; isRegDefined = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } SetHook(source, destination, &amp;openThread, &amp;freeReg); CloseHandle(openThread); } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Thread32Next(hThread, &amp;te32)); CloseHandle(hThread); Unfreeze(); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> record = info-&gt;GetItem(freeReg); record-&gt;source = source; record-&gt;destination = destination; record-&gt;pTrampoline = source; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SUCCESS_CODE; }</code> </pre> <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O c√≥digo acima ignora todos os processos vis√≠veis e procura o processo atual. </font><font style="vertical-align: inherit;">No processo encontrado para o pr√≥ximo encadeamento, obtemos o manipulador de fluxo, localizamos um dos quatro registradores livres e configuramos uma armadilha. </font><font style="vertical-align: inherit;">Vale a pena prestar aten√ß√£o nas fun√ß√µes Congelar e Descongelar - foi o que o Opcode Hook falou sobre multithreading - elas interrompem completamente a execu√ß√£o de threads desse processo (exceto o atual), para que n√£o haja situa√ß√£o em que um dos threads entre na fun√ß√£o interceptada.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Protegendo os threads de chamar uma fun√ß√£o de gancho</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> IHook::Freeze() { THREADENTRY32 te32; HANDLE hThread = CreateToolhelp32Snapshot(TH32CS_SNAPTHREAD, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hThread == INVALID_HANDLE_VALUE) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ERROR_ENUM_THREAD_START; te32.dwSize = <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(THREADENTRY32); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Thread32First(hThread, &amp;te32)) { CloseHandle(hThread); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ERROR_ENUM_THREAD_START; } DWORD dwOwnerPID = GetCurrentProcessId(); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (te32.th32OwnerProcessID == dwOwnerPID &amp;&amp; te32.th32ThreadID != GetCurrentThreadId()) { HANDLE openThread = OpenThread(THREAD_ALL_ACCESS, FALSE, te32.th32ThreadID); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (openThread != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { SuspendThread(openThread); CloseHandle(openThread); } } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Thread32Next(hThread, &amp;te32)); CloseHandle(hThread); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SUCCESS_CODE; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> IHook::Unfreeze() { <span class="hljs-comment"><span class="hljs-comment">// equal { HANDLE openThread = OpenThread(THREAD_ALL_ACCESS, FALSE, te32.th32ThreadID); if (openThread != NULL) { ResumeThread(openThread); CloseHandle(openThread); } } // equal return 0; }</span></span></code> </pre> <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Necessidades semelhantes devem ser implementadas na fun√ß√£o de remover a armadilha. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resta adicionar um manipulador de exce√ß√£o VEH. </font><font style="vertical-align: inherit;">A adi√ß√£o e remo√ß√£o √© feita pelas fun√ß√µes AddVectoredExceptionHandler e RemoveVectoredExceptionHandler de qualquer fluxo.</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> HardwareBPHook::SetExceptionHandler(PVECTORED_EXCEPTION_HANDLER pVecExcHandler) { pException = AddVectoredExceptionHandler(<span class="hljs-number"><span class="hljs-number">1</span></span>, pVecExcHandler); } ~HardwareBPHook() { info-&gt;Clear(); <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> info; RemoveVectoredExceptionHandler(pException); }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O manipulador deve verificar o tipo de exce√ß√£o (EXCEPTION_SINGLE_STEP √© necess√°rio), verificar a correspond√™ncia do endere√ßo no qual a exce√ß√£o ocorreu com o que est√° nos registradores e, se esse endere√ßo for encontrado, reorganiza o ponteiro RIP para o endere√ßo do destinat√°rio. </font><font style="vertical-align: inherit;">O estado da pilha √© preservado, para que, ap√≥s uma execu√ß√£o adicional do receptor, todos os par√¢metros na pilha estejam intactos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementamos o manipulador descrito na sandbox:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">LONG </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnExceptionHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( EXCEPTION_POINTERS* exceptionPointers)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (exceptionPointers-&gt;ExceptionRecord-&gt;ExceptionCode != EXCEPTION_SINGLE_STEP) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> EXCEPTION_CONTINUE_EXECUTION; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; DEBUG_REG_COUNT; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (exceptionPointers-&gt;ContextRecord-&gt;Rip == (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)hook-&gt;GetInfo()-&gt;GetItem(i)-&gt;source) { exceptionPointers-&gt;ContextRecord-&gt;Rip = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)hook-&gt;GetInfo()-&gt;GetItem(i)-&gt;destination; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> EXCEPTION_CONTINUE_EXECUTION; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em teoria, tudo est√° pronto, rodamos o programa, esperando exatamente o mesmo trabalho que o OpcodeHook. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso n√£o acontece, nosso programa congela - mais precisamente, ele entra constantemente no PresentHook e, no momento em que o trampolim deve ser chamado, a fun√ß√£o √© chamada novamente. O fato √© que o ponto de interrup√ß√£o "de ferro" n√£o desapareceu, porque quando voc√™ chama o trampolim (que, no caso de pontos de interrup√ß√£o de "ferro", indica a fun√ß√£o original), novamente alarme o mesmo endere√ßo e criamos uma exce√ß√£o. A solu√ß√£o √© a seguinte: removeremos o ponto de interrup√ß√£o quando ele for encontrado no manipulador de um encadeamento espec√≠fico e, no momento certo, o definiremos novamente. O local da atualiza√ß√£o escolher√° o momento em que a fun√ß√£o do receptor termina.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso √© implementado da seguinte maneira - no manipulador, junto com a remo√ß√£o do ponto de interrup√ß√£o, um comando pendente √© adicionado, cujo significado √© atualizar o ponto de interrup√ß√£o no fluxo especificado. </font><font style="vertical-align: inherit;">O comando √© executado no final da fun√ß√£o do receptor.</font></font><br><br><pre> <code class="cpp hljs">IDeferredCommands* hookCommands; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PresentHook</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Device* device)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> record = hook-&gt;GetRecordBySource(ptrPresent); pPresent pTrampoline = (pPresent)record-&gt;pTrampoline; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> result = pTrampoline(device); <span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"PresentHook"</span></span> &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; hookCommands-&gt;Run(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EndSceneHook</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Device* device, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> j)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> record = hook-&gt;GetRecordBySource(ptrEndScene); pEndScene pTrampoline = (pEndScene)record-&gt;pTrampoline; pTrampoline(device, <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"EndSceneHook"</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">" "</span></span> &lt;&lt; j &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; hookCommands-&gt;Run(); } <span class="hljs-function"><span class="hljs-function">LONG </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnExceptionHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(EXCEPTION_POINTERS* exceptionPointers)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (exceptionPointers-&gt;ExceptionRecord-&gt;ExceptionCode != EXCEPTION_SINGLE_STEP) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> EXCEPTION_CONTINUE_EXECUTION; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; DEBUG_REG_COUNT; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (exceptionPointers-&gt;ContextRecord-&gt;Rip == (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)hook-&gt;GetInfo()-&gt;GetItem(i)-&gt;source) { exceptionPointers-&gt;ContextRecord-&gt;Dr7 &amp;= ~(<span class="hljs-number"><span class="hljs-number">1U</span></span>LL &lt;&lt; (<span class="hljs-number"><span class="hljs-number">2</span></span> * i)); exceptionPointers-&gt;ContextRecord-&gt;Rip = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)hook-&gt;GetInfo()-&gt;GetItem(i)-&gt;destination; IDeferredCommand* cmd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SetD7Command(hook, GetCurrentThreadId(), i); hookCommands-&gt;Enqueue(cmd); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> EXCEPTION_CONTINUE_EXECUTION; }</code> </pre> <br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementa√ß√£o de comando pendente</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> silk_way { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IDeferredCommand</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>: IDeferredCommand(silk_way::IHook* _hook) { hook = _hook; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~IDeferredCommand() { hook = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>: silk_way::IHook* hook; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SetD7Command</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IDeferredCommand { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: SetD7Command(silk_way::IHook* _hook, <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> _threadId, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _reg) : IDeferredCommand(_hook) { threadId = _threadId; reg = _reg; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ HANDLE hThread = OpenThread(THREAD_ALL_ACCESS, FALSE, threadId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hThread != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> res = SetD7(&amp;hThread); CloseHandle(hThread); } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetD7</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HANDLE* hThread)</span></span></span><span class="hljs-function"> </span></span>{ CONTEXT context; ZeroMemory(&amp;context, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(context)); context.ContextFlags = CONTEXT_DEBUG_REGISTERS; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!GetThreadContext(*hThread, &amp;context)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; *(&amp;context.Dr0 + reg) = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)hook-&gt;GetInfo()-&gt;GetItem(reg)-&gt;source; context.Dr7 |= <span class="hljs-number"><span class="hljs-number">1U</span></span>LL &lt;&lt; (<span class="hljs-number"><span class="hljs-number">2</span></span> * reg); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!SetThreadContext(*hThread, &amp;context)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> threadId; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> reg; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IDeferredCommands</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> silk_data::Queue&lt;IDeferredCommand*&gt;, <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IDeferredCommand { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>: IDeferredCommands() : Queue(), IDeferredCommand(<span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) {} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~IDeferredCommands() {} }; }</code> </pre> <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Imagine visualmente o trabalho de pontos de interrup√ß√£o "de ferro". </font></font><br><br><img src="https://habrastorage.org/webt/jv/p-/zz/jvp-zzjqnzwyp2ykl_99ujnhw0y.png"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figura 12 - Estado inicial</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> N√≥s configuramos uma armadilha, adicionamos um manipulador VEH, aguardamos o controle alcan√ßar a fun√ß√£o de origem: </font></font><br><br><img src="https://habrastorage.org/webt/5q/-e/eu/5q-eeucl59ysseiioktygfzl9bc.png"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figura 13 - Est√°gio de prepara√ß√£o para intercepta√ß√£o</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Uma exce√ß√£o √© lan√ßada, um manipulador √© chamado que redireciona o RIP para o receptor e redefine o ponto de interrup√ß√£o: </font></font><br><br><img src="https://habrastorage.org/webt/te/rv/iw/terviwiealxn6xn1xvylzvfuhfe.png"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figura 14 - Redireciona o thread de execu√ß√£o no receptor de fun√ß√µes</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Neste t√≥pico, as interrup√ß√µes podem ser conclu√≠das, a biblioteca est√°tica silk_way.lib est√° pronta. </font><font style="vertical-align: inherit;">Por experi√™ncia pr√≥pria, posso dizer que costumo usar OpcodeHook, VMT Hook, Forced Exception Hook (provavelmente a armadilha mais "hemorr√≥ida"), HardwareBreakpoint e PageGuard (quando o tempo de execu√ß√£o n√£o √© cr√≠tico, intercepta√ß√µes √∫nicas).</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 8. Arquitetura da l√≥gica </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A base da l√≥gica √© apresentada na forma de MVC (model-view-controller). Todas as entidades principais herdam da interface ISilkObject.</font></font><br><br><h3>  8.1  Modelo </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ao desenvolver um bot na biblioteca, primeiro implementei o ECS (voc√™ pode ler sobre essa abordagem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Quando percebi que lan√ßar um bot com jogadores reais era uma tarefa bastante longa, escrevi uma simula√ß√£o em que testamos as bibliotecas ml (com uma grade tridimensional para navega√ß√£o (o Dota 2 usa apenas uma </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">grade 3D</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para navega√ß√£o) e f√≠sica 2D simplificada para um bloco corporal). Quando a necessidade de simula√ß√£o desapareceu e eu descobri como e o que registrar, quais informa√ß√µes coletar durante a batalha, o ECS n√£o era mais necess√°rio e os modelos simplesmente come√ßaram a conter um dicion√°rio de componentes (para representar algo como os caras do SkyForge, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se√ß√£o ‚ÄúAvatares e mobs</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), que continha, de fato, wrappers sobre estruturas do Source2Gen. </font><font style="vertical-align: inherit;">Para este artigo, n√£o transferi essa implementa√ß√£o para simplificar o material. </font><font style="vertical-align: inherit;">O modelo cont√©m Esquema, no qual sua descri√ß√£o √© armazenada (este ponto √© simplificado e, nesta implementa√ß√£o, o modelo n√£o √© criado de acordo com o esquema, apenas o esquema o descreve (armazena os valores predefinidos que podem ser codificados) - isso pode ser comparado ao armazenamento do conte√∫do do jogo em xml / json ) </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esquematicamente, o dispositivo modelo pode ser representado da seguinte forma: </font><i><font style="vertical-align: inherit;">Figura 15 - Representa√ß√£o esquem√°tica da</font></i><font style="vertical-align: inherit;"> implementa√ß√£o </font><i><font style="vertical-align: inherit;">do modelo</font></i><font style="vertical-align: inherit;"> no c√≥digo:</font></font><br><br> <a href=""><img src="https://habrastorage.org/webt/ci/of/ip/ciofipyg9fa-rcm0bavzy4ninb0.png"></a> <br> <i><font style="vertical-align: inherit;"></font></i> <br><br><font style="vertical-align: inherit;"></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">S</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SILK_OBJ</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IModel</span></span></span><span class="hljs-class">) {</span></span> ACCESSOR(IIdentity, Id) ACCESSOR(S, Schema) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: IModel(IIdentity * id, ISchema * schema) { Id = id; Schema = <span class="hljs-keyword"><span class="hljs-keyword">dynamic_cast</span></span>&lt;S*&gt;(schema); components = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> silk_data::RBTree&lt;SILK_STRING*, IComponent&gt;( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringCompareStrategy()); } ~IModel() { <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> Id; Schema = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; components-&gt;Clear(); <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> components; } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Get</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SILK_STRING</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">key</span></span></span><span class="hljs-class">) {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (T*)components-&gt;Find(key); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: silk_data::RBTree&lt;SILK_STRING*, IComponent&gt;* components; };</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O esquema inclui uma descri√ß√£o de um modelo espec√≠fico e cont√©m o contexto que o modelo pode usar. </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IModelSchema</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> BaseSchema { ACCESSOR(ModelContext, Context) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: IModelSchema(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* type, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* name, IContext* context) : BaseSchema(type, name) { Context = <span class="hljs-keyword"><span class="hljs-keyword">dynamic_cast</span></span>&lt;ModelContext*&gt;(context); } ~IModelSchema() { Context = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; } }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ModelContext</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> SilkContext { ACCESSOR(ILogger, Logger) ACCESSOR(IChrono, Clock) ACCESSOR(GigaFactory, Factory) ACCESSOR(IGameModel*, Model) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: ModelContext(SILK_GUID* guid, ILogger* logger, IChrono* clock, GigaFactory* factory, IGameModel** model) : SilkContext(guid) { Logger = logger; Clock = clock; Factory = factory; Model = model; } ~ModelContext() { Logger = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; Clock = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; Factory = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; Model = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; } };</code> </pre> <br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cole√ß√£o de modelos e cole√ß√£o de esquemas</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">S</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IModelCollection</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> silk_data::Vector&lt;T*&gt;, <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IModel&lt;S&gt; { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>: IModelCollection(IIdentity* id, ISchema* schema) : Vector(), IModel(id, schema) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> factory = Schema-&gt;GetContext()-&gt;GetFactory(); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> guid = Schema-&gt;GetContext()-&gt;GetGuid(); foreach (Schema-&gt;Length()) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> itemSchema = Schema-&gt;GetItem(i); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> item = factory-&gt;Build&lt;T&gt;(itemSchema-&gt;GetType()-&gt;GetValue(), guid-&gt;Get(), itemSchema); PushBack(item); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: ~IModelCollection() { Clear(); } <span class="hljs-function"><span class="hljs-function">T* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetByName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* name)</span></span></span><span class="hljs-function"> </span></span>{ foreach (Length()) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GetItem(i)-&gt;GetSchema()-&gt;CheckName(name)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetItem(i); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; } };</code> </pre> <br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por exemplo, a interface e implementa√ß√£o de um modelo que armazena o status de Roshan se parece com</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs">DEFINE_IMODEL(IRoshanStatusModel, IRoshanStatusSchema) { VIRTUAL_COMPONENT(IStatesModel, States) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Resolve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>: IRoshanStatusModel(IIdentity * id, ISchema * schema) : IModel(id, schema) {} }; DEFINE_MODEL(RoshanStatusModel, IRoshanStatusModel) { COMPONENT(IStatesModel, States) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> : RoshanStatusModel(IIdentity * id, ISchema* schema) : IRoshanStatusModel( id, schema) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> factory = Schema-&gt;GetContext()-&gt;GetFactory(); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> guid = Schema -&gt; GetContext() -&gt; GetGuid(); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> statesSchema = Schema -&gt; GetStates(); States = factory-&gt;Build&lt;IStatesModel&gt;( statesSchema-&gt;GetType()-&gt;GetValue(), guid-&gt;Get(), statesSchema); } ~RoshanStatusModel() { <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> States; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Resolve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> currentStateSchema = States-&gt;GetCurrent()-&gt;GetSchema(); Schema-&gt;GetContext()-&gt;GetLogger()-&gt;Log(<span class="hljs-string"><span class="hljs-string">"RESOLVE\n"</span></span>); foreach (currentStateSchema-&gt;GetTransitions()-&gt;Length()) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> transition = currentStateSchema-&gt;GetTransitions()-&gt;GetItem(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (transition-&gt;GetRequirement()-&gt;Check()) { transition-&gt;GetAction()-&gt;Make(); States-&gt;SetCurrent(States-&gt;GetByName( transition-&gt;GetTo()-&gt;GetValue())); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } };</code> </pre> <br></div></div><br><h3>  8.2<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Exibir, exibir status e controlador </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o h√° muito a dizer sobre Apresenta√ß√£o, Estado da Apresenta√ß√£o e Controlador, a implementa√ß√£o √© semelhante a Modelos. </font><font style="vertical-align: inherit;">Eles tamb√©m consistem em esquema e contexto. </font><font style="vertical-align: inherit;">Para resolver o problema de View, Canvas, ViewCollection, Label e Button, s√£o implementados, nos dois √∫ltimos, estados correspondentes aos estados em que Roshan est√° localizado.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vis√£o esquem√°tica</font></font></b> <div class="spoiler_text"> <a href=""><img src="https://habrastorage.org/webt/an/l2/_n/anl2_n7qxsihaoohxu4oa-kq2jm.png"></a> <br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figura 16 - Representa√ß√£o esquem√°tica da vista</font></font></i> <br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Representa√ß√£o esquem√°tica do estado de exibi√ß√£o</font></font></b> <div class="spoiler_text"> <a href=""><img src="https://habrastorage.org/webt/zi/mz/pi/zimzpip_arq-gwgl87-lwriknmq.png"></a> <br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figura 17 - Representa√ß√£o esquem√°tica do estado de exibi√ß√£o</font></font></i> <br></div></div><br><h3>  8.3<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A f√°brica </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os objetos s√£o criados usando a f√°brica. </font><font style="vertical-align: inherit;">As f√°bricas usam um tipo de interface como chave, convertendo-o em uma string usando typeid (T) .raw_name (). </font><font style="vertical-align: inherit;">Em geral, isso √© ruim, por que e como ler corretamente em Andrei Alexandrescu, Design Moderno em C ++: Programa√ß√£o Gen√©rica. </font><font style="vertical-align: inherit;">Implementa√ß√£o de f√°brica:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SilkFactory</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: SilkFactory() { items = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> silk_data::RBTree&lt;SILK_STRING*, IImplementator&gt;( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringCompareStrategy()); } ~SilkFactory() { items-&gt;Clear(); <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> items; } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">... </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Args</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ISILK_WAY_OBJECT</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Build</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">char</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Args</span></span></span><span class="hljs-class">... </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">args</span></span></span><span class="hljs-class">) {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> key = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_STRING(type); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> impl = items-&gt;Find(key)-&gt;payload; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> impl-&gt;Build(args...); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Register</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* type, IImplementator* impl)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> key = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_STRING(type); items-&gt;Insert(*items-&gt;MakeNode(key, impl)); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>: silk_data::RBTree&lt;SILK_STRING*, IImplementator&gt;* items; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GigaFactory</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: GigaFactory() { items = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> silk_data::RBTree&lt;SILK_STRING*, SilkFactory&gt;( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringCompareStrategy()); } ~GigaFactory() { items-&gt;Clear(); <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> items; } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">... </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Args</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Build</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">char</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">concreteType</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Args</span></span></span><span class="hljs-class">... </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">args</span></span></span><span class="hljs-class">) {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> key = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_STRING(<span class="hljs-keyword"><span class="hljs-keyword">typeid</span></span>(T).raw_name()); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> factory = items-&gt;Find(key)-&gt;payload; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (T*)factory-&gt;Build(concreteType, args...); } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Register</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SilkFactory</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">) {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> key = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_STRING(<span class="hljs-keyword"><span class="hljs-keyword">typeid</span></span>(T).raw_name()); items-&gt;Insert(*items-&gt;MakeNode(key, factory)); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>: silk_data::RBTree&lt;SILK_STRING*, SilkFactory&gt;* items; };</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Antes de usar a f√°brica para construir objetos, voc√™ precisa se registrar. </font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemplo de registro de modelo</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ModelRegistrator::Register( GigaFactory* factory) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> requirement = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SilkFactory(); requirement-&gt;Register(<span class="hljs-string"><span class="hljs-string">"true"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SchemaImplementator&lt;TrueRequirement&gt;); requirement-&gt;Register(<span class="hljs-string"><span class="hljs-string">"false"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SchemaImplementator&lt;FalseRequirement&gt;); requirement-&gt;Register(<span class="hljs-string"><span class="hljs-string">"roshan_killed"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SchemaImplementator&lt;RoshanKilledRequirement&gt;); requirement-&gt;Register(<span class="hljs-string"><span class="hljs-string">"roshan_alive_manual"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SchemaImplementator&lt;RoshanAliveManualRequirement&gt;); requirement-&gt;Register(<span class="hljs-string"><span class="hljs-string">"time"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SchemaImplementator&lt;TimeRequirement&gt;); requirement-&gt;Register(<span class="hljs-string"><span class="hljs-string">"roshan_state"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SchemaImplementator&lt;RoshanStateRequirement&gt;); factory-&gt;Register&lt;IRequirement&gt;(requirement); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> action = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SilkFactory(); action-&gt;Register(<span class="hljs-string"><span class="hljs-string">"action"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SchemaImplementator&lt;EmptyAction&gt;); action-&gt;Register(<span class="hljs-string"><span class="hljs-string">"set_current_time"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SchemaImplementator&lt;SetCurrentTimeAction&gt;); factory-&gt;Register&lt;IAction&gt;(action); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> transition = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SilkFactory(); transition-&gt;Register(<span class="hljs-string"><span class="hljs-string">"transition"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SchemaImplementator&lt;TransitionSchema&gt;); factory-&gt;Register&lt;ITransitionSchema&gt;(transition); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> transitions = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SilkFactory(); transitions-&gt;Register(<span class="hljs-string"><span class="hljs-string">"transitions"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SchemaImplementator&lt;TransitionsSchema&gt;); factory-&gt;Register&lt;ITransitionsSchema&gt;(transitions); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> stateSchema = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SilkFactory(); stateSchema-&gt;Register(<span class="hljs-string"><span class="hljs-string">"state"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SchemaImplementator&lt;StateSchema&gt;); factory-&gt;Register&lt;IStateSchema&gt;(stateSchema); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> statesSchema = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SilkFactory(); statesSchema-&gt;Register(<span class="hljs-string"><span class="hljs-string">"states"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SchemaImplementator&lt;StatesSchema&gt;); factory-&gt;Register&lt;IStatesSchema&gt;(statesSchema); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> roshanStatusSchema = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SilkFactory(); roshanStatusSchema-&gt;Register(<span class="hljs-string"><span class="hljs-string">"roshan_status"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SchemaImplementator&lt;RoshanStatusSchema&gt;); factory-&gt;Register&lt;IRoshanStatusSchema&gt;(roshanStatusSchema); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> triggerSchema = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SilkFactory(); triggerSchema-&gt;Register(<span class="hljs-string"><span class="hljs-string">"trigger"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SchemaImplementator&lt;TriggerSchema&gt;); factory-&gt;Register&lt;ITriggerSchema&gt;(triggerSchema); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> triggersSchema = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SilkFactory(); triggersSchema-&gt;Register(<span class="hljs-string"><span class="hljs-string">"triggers"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SchemaImplementator&lt;TriggersSchema&gt;); factory-&gt;Register&lt;ITriggersSchema&gt;(triggersSchema); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> resourceSchema = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SilkFactory(); resourceSchema-&gt;Register(<span class="hljs-string"><span class="hljs-string">"resource"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SchemaImplementator&lt;ResourceSchema&gt;); factory-&gt;Register&lt;IResourceSchema&gt;(resourceSchema); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> resourcesSchema = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SilkFactory(); resourcesSchema-&gt;Register(<span class="hljs-string"><span class="hljs-string">"resources"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SchemaImplementator&lt;ResourcesSchema&gt;); factory-&gt;Register&lt;IResourcesSchema&gt;(resourcesSchema); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> gameSchema = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SilkFactory(); gameSchema-&gt;Register(<span class="hljs-string"><span class="hljs-string">"game"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SchemaImplementator&lt;GameSchema&gt;); factory-&gt;Register&lt;IGameSchema&gt;(gameSchema); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> gameModel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SilkFactory(); gameModel-&gt;Register(<span class="hljs-string"><span class="hljs-string">"game"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcreteImplementator&lt;GameModel&gt;); factory-&gt;Register&lt;IGameModel&gt;(gameModel); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> resources = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SilkFactory(); resources-&gt;Register(<span class="hljs-string"><span class="hljs-string">"resources"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcreteImplementator&lt;ResourceCollection&gt;); factory-&gt;Register&lt;IResourceCollection&gt;(resources); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> resource = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SilkFactory(); resource-&gt;Register(<span class="hljs-string"><span class="hljs-string">"resource"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcreteImplementator&lt;Resource&gt;); factory-&gt;Register&lt;IResource&gt;(resource); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> triggers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SilkFactory(); triggers-&gt;Register(<span class="hljs-string"><span class="hljs-string">"triggers"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcreteImplementator&lt;TriggerCollection&gt;); factory-&gt;Register&lt;ITriggerCollection&gt;(triggers); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> trigger = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SilkFactory(); trigger-&gt;Register(<span class="hljs-string"><span class="hljs-string">"trigger"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcreteImplementator&lt;Trigger&gt;); factory-&gt;Register&lt;ITrigger&gt;(trigger); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> roshanStatus = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SilkFactory(); roshanStatus-&gt;Register(<span class="hljs-string"><span class="hljs-string">"roshan_status"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcreteImplementator&lt;RoshanStatusModel&gt;); factory-&gt;Register&lt;IRoshanStatusModel&gt;(roshanStatus); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> states = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SilkFactory(); states-&gt;Register(<span class="hljs-string"><span class="hljs-string">"states"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcreteImplementator&lt;StatesModel&gt;); factory-&gt;Register&lt;IStatesModel&gt;(states); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> state = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SilkFactory(); state-&gt;Register(<span class="hljs-string"><span class="hljs-string">"state"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcreteImplementator&lt;StateModel&gt;); factory-&gt;Register&lt;IStateModel&gt;(state); }</code> </pre> <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O esquema pode ser preenchido de qualquer maneira - voc√™ pode usar json, diretamente no c√≥digo. </font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Op√ß√£o para preencher o esquema para Modelos em json</font></font></b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"game"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"roshan_status"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"states"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"alive"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"transitions"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"from"</span></span>: <span class="hljs-string"><span class="hljs-string">"alive"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"to"</span></span>: <span class="hljs-string"><span class="hljs-string">"ressurect_base"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"requirement"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"typename"</span></span>: <span class="hljs-string"><span class="hljs-string">"roshan_killed"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"action"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"typename"</span></span>: <span class="hljs-string"><span class="hljs-string">"set_current_time"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"resource"</span></span>: <span class="hljs-string"><span class="hljs-string">"roshan_killed_ts"</span></span> } } } ] }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"ressurect_base"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"transitions"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"from"</span></span>: <span class="hljs-string"><span class="hljs-string">"ressurect_base"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"to"</span></span>: <span class="hljs-string"><span class="hljs-string">"ressurect_extra"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"requirement"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"typename"</span></span>: <span class="hljs-string"><span class="hljs-string">"time"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"resource"</span></span>: <span class="hljs-string"><span class="hljs-string">"roshan_killed_ts"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"offset"</span></span>: <span class="hljs-number"><span class="hljs-number">480</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"action"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"typename"</span></span>: <span class="hljs-string"><span class="hljs-string">"action"</span></span> } } ] }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"ressurect_extra"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"transitions"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"from"</span></span>: <span class="hljs-string"><span class="hljs-string">"ressurect_extra"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"to"</span></span>: <span class="hljs-string"><span class="hljs-string">"alive"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"requirement"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"typename"</span></span>: <span class="hljs-string"><span class="hljs-string">"time"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"resource"</span></span>: <span class="hljs-string"><span class="hljs-string">"roshan_killed_ts"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"offset"</span></span>: <span class="hljs-number"><span class="hljs-number">660</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"action"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"typename"</span></span>: <span class="hljs-string"><span class="hljs-string">"action"</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"from"</span></span>: <span class="hljs-string"><span class="hljs-string">"ressurect_extra"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"to"</span></span>: <span class="hljs-string"><span class="hljs-string">"alive"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"requirement"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"typename"</span></span>: <span class="hljs-string"><span class="hljs-string">"roshan_alive_manual"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"action"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"typename"</span></span>: <span class="hljs-string"><span class="hljs-string">"action"</span></span> } } ] } ] }, <span class="hljs-attr"><span class="hljs-attr">"triggers"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"roshan_killed"</span></span>: {}, <span class="hljs-attr"><span class="hljs-attr">"roshan_alive_manual"</span></span>: {} }, <span class="hljs-attr"><span class="hljs-attr">"resources"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"roshan_killed_ts"</span></span>: {} } } }</code> </pre> <br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Op√ß√£o para preencher um esquema para envio de c√≥digo</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> GameController::InitViewSchema(ICanvasSchema** schema) { *schema = factory-&gt;Build&lt;ICanvasSchema&gt;(<span class="hljs-string"><span class="hljs-string">"canvas_d9"</span></span>, <span class="hljs-string"><span class="hljs-string">"canvas_d9"</span></span>, <span class="hljs-string"><span class="hljs-string">"canvas_d9"</span></span>, viewContext); IViewCollectionSchema* elements = factory-&gt;Build&lt;IViewCollectionSchema&gt;( <span class="hljs-string"><span class="hljs-string">"elements"</span></span>, <span class="hljs-string"><span class="hljs-string">"elements"</span></span>, <span class="hljs-string"><span class="hljs-string">"elements"</span></span>, viewContext); (*schema)-&gt;SetElements(elements); ILabelSchema* labelSchema = factory-&gt;Build&lt;ILabelSchema&gt;( <span class="hljs-string"><span class="hljs-string">"label_d9"</span></span>, <span class="hljs-string"><span class="hljs-string">"label_d9"</span></span>, <span class="hljs-string"><span class="hljs-string">"roshan_status_label"</span></span>, viewContext); labelSchema-&gt;SetRecLeft(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_INT(<span class="hljs-number"><span class="hljs-number">30</span></span>)); labelSchema-&gt;SetRecTop(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_INT(<span class="hljs-number"><span class="hljs-number">100</span></span>)); labelSchema-&gt;SetRecRight(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_INT(<span class="hljs-number"><span class="hljs-number">230</span></span>)); labelSchema-&gt;SetRecDown(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_INT(<span class="hljs-number"><span class="hljs-number">250</span></span>)); labelSchema-&gt;SetColorR(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_FLOAT(<span class="hljs-number"><span class="hljs-number">1.0f</span></span>)); labelSchema-&gt;SetColorG(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_FLOAT(<span class="hljs-number"><span class="hljs-number">1.0f</span></span>)); labelSchema-&gt;SetColorB(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_FLOAT(<span class="hljs-number"><span class="hljs-number">1.0f</span></span>)); labelSchema-&gt;SetColorA(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_FLOAT(<span class="hljs-number"><span class="hljs-number">1.0f</span></span>)); labelSchema-&gt;SetText(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_STRING(<span class="hljs-string"><span class="hljs-string">"Roshan status: alive\0"</span></span>)); elements-&gt;PushBack((IViewSchema*&amp;)labelSchema); IButtonSchema* buttonSchema = factory-&gt;Build&lt;IButtonSchema&gt;( <span class="hljs-string"><span class="hljs-string">"button_d9"</span></span>, <span class="hljs-string"><span class="hljs-string">"button_d9"</span></span>, <span class="hljs-string"><span class="hljs-string">"roshan_kill_button"</span></span>, viewContext); ILabelSchema* buttonLabelSchema = factory-&gt;Build&lt;ILabelSchema&gt;( <span class="hljs-string"><span class="hljs-string">"label_d9"</span></span>, <span class="hljs-string"><span class="hljs-string">"label_d9"</span></span>, <span class="hljs-string"><span class="hljs-string">"button_text"</span></span>, viewContext); buttonLabelSchema-&gt;SetRecLeft(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_INT(<span class="hljs-number"><span class="hljs-number">30</span></span>)); buttonLabelSchema-&gt;SetRecTop(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_INT(<span class="hljs-number"><span class="hljs-number">115</span></span>)); buttonLabelSchema-&gt;SetRecRight(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_INT(<span class="hljs-number"><span class="hljs-number">110</span></span>)); buttonLabelSchema-&gt;SetRecDown(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_INT(<span class="hljs-number"><span class="hljs-number">130</span></span>)); buttonLabelSchema-&gt;SetColorR(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_FLOAT(<span class="hljs-number"><span class="hljs-number">1.0f</span></span>)); buttonLabelSchema-&gt;SetColorG(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_FLOAT(<span class="hljs-number"><span class="hljs-number">0.0f</span></span>)); buttonLabelSchema-&gt;SetColorB(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_FLOAT(<span class="hljs-number"><span class="hljs-number">0.0f</span></span>)); buttonLabelSchema-&gt;SetColorA(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_FLOAT(<span class="hljs-number"><span class="hljs-number">1.0f</span></span>)); buttonLabelSchema-&gt;SetText(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_STRING(<span class="hljs-string"><span class="hljs-string">"Kill Roshan\0"</span></span>)); buttonSchema-&gt;SetLabel(buttonLabelSchema); buttonSchema-&gt;SetBorderColorR(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_INT(<span class="hljs-number"><span class="hljs-number">0</span></span>)); buttonSchema-&gt;SetBorderColorG(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_INT(<span class="hljs-number"><span class="hljs-number">0</span></span>)); buttonSchema-&gt;SetBorderColorB(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_INT(<span class="hljs-number"><span class="hljs-number">0</span></span>)); buttonSchema-&gt;SetBorderColorA(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_INT(<span class="hljs-number"><span class="hljs-number">70</span></span>)); buttonSchema-&gt;SetFillColorR(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_INT(<span class="hljs-number"><span class="hljs-number">255</span></span>)); buttonSchema-&gt;SetFillColorG(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_INT(<span class="hljs-number"><span class="hljs-number">119</span></span>)); buttonSchema-&gt;SetFillColorB(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_INT(<span class="hljs-number"><span class="hljs-number">0</span></span>)); buttonSchema-&gt;SetFillColorA(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_INT(<span class="hljs-number"><span class="hljs-number">150</span></span>)); buttonSchema-&gt;SetPushColorR(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_INT(<span class="hljs-number"><span class="hljs-number">0</span></span>)); buttonSchema-&gt;SetPushColorG(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_INT(<span class="hljs-number"><span class="hljs-number">0</span></span>)); buttonSchema-&gt;SetPushColorB(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_INT(<span class="hljs-number"><span class="hljs-number">0</span></span>)); buttonSchema-&gt;SetPushColorA(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_INT(<span class="hljs-number"><span class="hljs-number">70</span></span>)); buttonSchema-&gt;SetBorder(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SILK_FLOAT(<span class="hljs-number"><span class="hljs-number">5</span></span>)); elements-&gt;PushBack((IViewSchema*&amp;)buttonSchema); }</code> </pre> <br></div></div><br><h3>  8.4  Eventos </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A visualiza√ß√£o aprende sobre a mudan√ßa no modelo atrav√©s de eventos. </font><font style="vertical-align: inherit;">Voc√™ pode obter feedback sobre m√©todos de classe e fun√ß√µes comuns.</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VIRTUAL_EVENT(e) public: virtual IEvent* Get##e() = 0; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> EVENT(e) private: IEvent* e; public: IEvent* Get##e() { return e; } const int MAX_EVENT_CALLBACKS = 1024; class IEventArgs {}; class ICallback { public: virtual void Invoke(IEventArgs* args) = 0; }; template </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;class A&gt; class Callback : public ICallback { typedef void (*f)(A*); public: Callback(f _pFunc) { ptr = _pFunc; } ~Callback() { delete ptr; } void Invoke(IEventArgs* args) { ptr((A*)args); } private: f ptr = nullptr; }; template &lt;typename T, class A&gt; class MemberCallback : public ICallback { typedef void (T::*f)(A*); public: MemberCallback(f _pFunc, T* _obj) { ptr = _pFunc; obj = _obj; } ~MemberCallback() { delete ptr; obj = nullptr; } void Invoke(IEventArgs* args) { (obj-&gt;*(ptr))((A*)args); } private: f ptr = nullptr; T* obj; }; class IEvent { public: virtual void Invoke(IEventArgs* args) = 0; virtual void Add(ICallback* callback) = 0; virtual bool Remove(ICallback* callback) = 0; virtual ~IEvent() {} };</span></span></span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se um objeto deseja relatar eventos que ocorrem dentro dele, voc√™ precisa adicionar o IEvent * para cada evento. </font><font style="vertical-align: inherit;">Outro objeto interessado em eventos que ocorram dentro desse objeto deve criar ICallback * e pass√°-lo para o IEvent * (assinar o evento).</font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assinaturas de exemplo que ocorrem no controlador</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Attach</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ statesChangedCallback = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MemberCallback&lt;GameController, IEventArgs&gt;( &amp;GameController::OnStatesChanged, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); Model-&gt;GetRoshanStatus()-&gt;GetStates()-&gt;GetCurrentChanged()-&gt;Add( statesChangedCallback); buttonClickedCallback = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MemberCallback&lt;GameController, IEventArgs&gt;( &amp;GameController::OnKillRoshanClicked, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); killButton-&gt;GetClickedEvent()-&gt;Add(buttonClickedCallback); }</code> </pre> <br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um exemplo de declara√ß√£o de um evento dentro de uma classe - com cada ocorr√™ncia do rel√≥gio (chamando o m√©todo Tick), um evento StruckEvent √© gerado</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IChrono</span></span></span><span class="hljs-class"> {</span></span> VIRTUAL_EVENT(Struck) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Tick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetStamp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetDiffS</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ts)</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Chrono</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IChrono { EVENT(Struck) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: Chrono() { start = time(<span class="hljs-number"><span class="hljs-number">0</span></span>); Struck = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Event(); } ~Chrono() { <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> Struck; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Tick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> cur = clock(); worked += cur - savepoint; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> isStriking = savepoint &lt; cur; savepoint = cur; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isStriking) Struck-&gt;Invoke(<span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetStamp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> start * CLOCKS_PER_SEC + worked; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetDiffS</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ts)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (GetStamp() - ts) / CLOCKS_PER_SEC; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> worked = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">time_t</span></span> start; <span class="hljs-keyword"><span class="hljs-keyword">time_t</span></span> savepoint; };</code> </pre> <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Os tipos primitivos b√°sicos (SILK_INT, SILT_FLOAT, SILK_STRING, ...) s√£o implementados no Core.h. </font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 9. DirectX 9 </font></font></h2><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O DirectX 9</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© uma das APIs gr√°ficas suportadas pelo Dota 2. Device √© uma classe herdada de IUnknown e cont√©m fun√ß√µes virtuais. Assim, tendo recebido um ponteiro para uma tabela de m√©todo virtual, podemos obter ponteiros para as fun√ß√µes que precisamos. As fun√ß√µes de classe n√£o virtual n√£o est√£o inclu√≠das na tabela e est√£o no segmento .code, pois s√£o as √∫nicas que n√£o podem ser substitu√≠das. A prop√≥sito, no OpenGL e no Vulkan, a intercepta√ß√£o de fun√ß√µes do dispositivo √© muito mais f√°cil, pois elas n√£o s√£o virtuais e voc√™ pode obter um ponteiro usando GetProcAddress (). A arquitetura DirectX 11 √© mais complexa que 9, mas n√£o muito.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para interceptar o m√©todo da classe virtual (assim como o n√£o virtual), precisamos de uma inst√¢ncia dessa classe, qualquer inst√¢ncia. Usando a inst√¢ncia, obtemos a tabela de m√©todos virtuais e obtemos os ponteiros necess√°rios para as fun√ß√µes. A maneira mais f√°cil de encontrar uma inst√¢ncia de uma classe √© cri√°-la. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para fazer isso, precisamos criar um objeto com a interface IDirect3D9 usando a fun√ß√£o Direct3DCreate9, e criaremos o dispositivo usando esse objeto chamando o m√©todo CreateDevice. Podemos chamar essas fun√ß√µes diretamente da biblioteca DirectX, mas, para consolidar o material, as chamaremos atrav√©s de ponteiros. Como pode ser visto no d3d9.h, o Direct3DCreate9 √© uma fun√ß√£o regular e um ponteiro para ele pode ser obtido atrav√©s do GetProcAddress (como fizemos no NativeInjector para obter um ponteiro no LoadLibrary).</font></font><br><br> <a href=""><img src="https://habrastorage.org/webt/nr/fq/ai/nrfqai6vps7fc9lx_crerpvsbhq.png"></a> <br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figura 18 - Descri√ß√£o do CreateDevice no d3d9.h</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Crie uma inst√¢ncia do IDirect3D9:</font></font><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> IDirect3D9* (WINAPI *SILK_Direct3DCreate9) (UINT SDKVersion); <span class="hljs-comment"><span class="hljs-comment">//IDirect3D9* pD3D = Direct3DCreate9(D3D_SDK_VERSION); SILK_Direct3DCreate9 Silk_Direct3DCreate9 = (SILK_Direct3DCreate9)GetProcAddress(GetModuleHandle("d3d9.dll"), "Direct3DCreate9"); IDirect3D9* pD3D = Silk_Direct3DCreate9(D3D_SDK_VERSION);</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando o IDirect3D9, podemos criar um dispositivo chamando pD3D-&gt; CreateDevice (...). </font><font style="vertical-align: inherit;">Para obter um ponteiro para as fun√ß√µes necess√°rias do VMT, precisamos descobrir o procedimento para determinar esses m√©todos. </font><i><font style="vertical-align: inherit;">Figura 19 - Pesquisa de √≠ndice pelo m√©todo CreateDevice da interface IDirect3D9 Obtenha o</font></i><font style="vertical-align: inherit;"> 16¬∫ √≠ndice. </font><font style="vertical-align: inherit;">Al√©m de CreateDevice, tamb√©m precisamos dos m√©todos Release e GetAdapterDisplayMode.</font></font><br><br> <a href=""><img src="https://habrastorage.org/webt/ro/ap/ug/roapuggoav9xtztltqu8gs6zqiw.png"></a> <br> <i><font style="vertical-align: inherit;"></font></i> <br><br><font style="vertical-align: inherit;"></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementamos a cria√ß√£o do dispositivo em c√≥digo</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HRESULT</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WINAPI *SILK_GetAdapterDisplayMode)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IDirect3D9* direct3D9, UINT Adapter, D3DDISPLAYMODE* pMode)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HRESULT</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WINAPI *SILK_CreateDevice)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IDirect3D9* direct3D9, UINT Adapter, D3DDEVTYPE DeviceType, HWND hFocusWindow, DWORD BehaviorFlags, D3DPRESENT_PARAMETERS* pPresentationParameters, IDirect3DDevice9** ppReturnedDeviceInterface)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ULONG</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WINAPI *SILK_Release)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IDirect3D9* direct3D9)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> RELEASE_INDEX = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> GET_ADAPTER_DISPLAY_MODE_INDEX = <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CREATE_DEVICE_INDEX = <span class="hljs-number"><span class="hljs-number">16</span></span>; <span class="hljs-function"><span class="hljs-function">BOOL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateSearchDevice</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IDirect3D9** d3d, IDirect3DDevice9** device)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!d3d || !device) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FALSE; *d3d = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; *device = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-comment"><span class="hljs-comment">//IDirect3D9* pD3D = Direct3DCreate9(D3D_SDK_VERSION); SILK_Direct3DCreate9 Silk_Direct3DCreate9 = (SILK_Direct3DCreate9)GetProcAddress(GetModuleHandle("d3d9.dll"), "Direct3DCreate9"); IDirect3D9* pD3D = Silk_Direct3DCreate9(D3D_SDK_VERSION); if (!pD3D) return FALSE; D3DDISPLAYMODE displayMode; int pointerSize = sizeof(unsigned long long); unsigned long long vmt = **(unsigned long long **)&amp;pD3D; SILK_GetAdapterDisplayMode pGetAdapderDisplayMode = (SILK_GetAdapterDisplayMode)((*(unsigned long long *) (vmt + pointerSize * GET_ADAPTER_DISPLAY_MODE_INDEX))); pGetAdapderDisplayMode(pD3D, D3DADAPTER_DEFAULT, &amp;displayMode); //pD3D-&gt;GetAdapterDisplayMode(D3DADAPTER_DEFAULT, &amp;displayMode); HWND hWindow = GetDesktopWindow(); D3DPRESENT_PARAMETERS pp; ZeroMemory(&amp;pp, sizeof(pp)); pp.Windowed = TRUE; pp.hDeviceWindow = hWindow; pp.BackBufferCount = 0; pp.BackBufferWidth = 0; pp.BackBufferHeight = 0; pp.BackBufferFormat = displayMode.Format; pp.SwapEffect = D3DSWAPEFFECT_DISCARD; IDirect3DDevice9* pDevice = NULL; SILK_CreateDevice pCreateDevice = (SILK_CreateDevice) ((*(unsigned long long *)(vmt + pointerSize * CREATE_DEVICE_INDEX))); if(SUCCEEDED(pCreateDevice(pD3D, D3DADAPTER_DEFAULT, D3DDEVTYPE_HAL, hWindow, D3DCREATE_SOFTWARE_VERTEXPROCESSING | D3DCREATE_DISABLE_DRIVER_MANAGEMENT, &amp;pp, &amp;pDevice))) { //if (SUCCEEDED(pD3D-&gt;CreateDevice(D3DADAPTER_DEFAULT, D3DDEVTYPE_HAL, hWindow, D3DCREATE_SOFTWARE_VERTEXPROCESSING | D3DCREATE_DISABLE_DRIVER_MANAGEMENT, &amp;pp, &amp;pDevice))) { if (pDevice != NULL) { *d3d = pD3D; *device = pDevice; } } BOOL result = (*d3d != NULL); if (result == FALSE) if (pD3D) { SILK_Release pRelease= (SILK_Release)((*(unsigned long long *)(vmt + pointerSize * RELEASE_INDEX))); pRelease(pD3D); //pD3D-&gt;Release(); } return result; }</span></span></code> </pre> <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bem, criamos o dispositivo DirectX 9, agora precisamos entender quais fun√ß√µes s√£o usadas para renderizar a cena, o que precisamos interceptar. Precisamos responder √† pergunta: "Como o DirectX 9 nos mostra a cena?" A fun√ß√£o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Presente</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© usada para exibir a cena </font><font style="vertical-align: inherit;">. Tamb√©m vale a pena introduzir conceitos como buffer frontal (um buffer que armazena o que √© exibido (a√ß√£o de longo prazo) na tela), buffer traseiro - cont√©m o que est√° pronto para exibi√ß√£o e est√° se preparando para se tornar um buffer frontal, cadeia de troca - na verdade, um conjunto de buffers que invers√£o da frente para tr√°s (o DirectX 9 possui apenas 1 cadeia de troca). Antes de chamar Present, algumas fun√ß√µes </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BeginScene</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">EndScene</font></a><font style="vertical-align: inherit;"> s√£o </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">chamadas</font></a><font style="vertical-align: inherit;"> , onde voc√™ pode modificar o buffer de fundo.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vamos interceptar duas fun√ß√µes (de fato, para executar a l√≥gica de neg√≥cios, uma √© suficiente para n√≥s): EndScene e Present. </font><font style="vertical-align: inherit;">Para fazer isso, observe o local dessas fun√ß√µes na classe IDirect3DDevice9 </font><i><font style="vertical-align: inherit;">Figura 20 - Declarando a interface IDirect3DDevice9 Declare os</font></i><font style="vertical-align: inherit;"> ponteiros com as seguintes assinaturas de fun√ß√£o:</font></font><br><br> <a href=""><img src="https://habrastorage.org/webt/xa/ev/tk/xaevtkzg4h4whv7aejsfp025yr0.png"></a> <br> <i><font style="vertical-align: inherit;"></font></i> <br><br><font style="vertical-align: inherit;"></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HRESULT</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*VirtualOverloadPresent)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IDirect3DDevice9* pd3dDevice, CONST RECT* pSourceRect, CONST RECT* pDestRect, HWND hDestWindowOverride, CONST RGNDATA* pDirtyRegion)</span></span></span></span>; VirtualOverloadPresent oOverload = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HRESULT</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*VirtualOverloadEndScene)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IDirect3DDevice9* pd3dDevice)</span></span></span></span>; VirtualOverloadEndScene oOverloadEndScene = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> PRESENT_INDEX = <span class="hljs-number"><span class="hljs-number">17</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> END_SCENE_INDEX = <span class="hljs-number"><span class="hljs-number">42</span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Declararemos uma armadilha imediatamente com um manipulador de erros, pois o HardwareBreakpoint √©, na verdade, a nossa √∫nica op√ß√£o de intercepta√ß√£o segura implementada que n√£o rastreia o VAC (voc√™ tamb√©m pode testar com o Opcode Hook, mas √© prov√°vel que sua conta seja banida): </font></font><br><br><pre> <code class="cpp hljs">silk_way::IDeferredCommands* deferredCommands; silk_way::IHook* hook; <span class="hljs-function"><span class="hljs-function">LONG </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnExceptionHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(EXCEPTION_POINTERS* exceptionPointers)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (exceptionPointers-&gt;ExceptionRecord-&gt;ExceptionCode != EXCEPTION_SINGLE_STEP) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> EXCEPTION_EXIT_UNWIND; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; silk_way::DEBUG_REG_COUNT; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (exceptionPointers-&gt;ContextRecord-&gt;Rip == (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>) hook-&gt;GetInfo()-&gt;GetItem(i)-&gt;source) { exceptionPointers-&gt;ContextRecord-&gt;Dr7 &amp;= ~(<span class="hljs-number"><span class="hljs-number">1U</span></span>LL &lt;&lt; (<span class="hljs-number"><span class="hljs-number">2</span></span> * i)); exceptionPointers-&gt;ContextRecord-&gt;Rip = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>) hook-&gt;GetInfo()-&gt;GetItem(i)-&gt;destination; silk_way::IDeferredCommand* cmd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> silk_way::SetD7Command(hook, GetCurrentThreadId(), i); deferredCommands-&gt;Enqueue(cmd); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> EXCEPTION_CONTINUE_EXECUTION; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Toque as fun√ß√µes designadas de qualquer uma de nossas duas armadilhas: </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">BOOL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HookDevice</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IDirect3DDevice9* pDevice)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> vmt = **(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> **)&amp;pDevice; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pointerSize = <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>); VirtualOverloadPresent pointerPresent= (VirtualOverloadPresent) ((*(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> *)(vmt + pointerSize * PRESENT_INDEX))); VirtualOverloadEndScene pointerEndScene = (VirtualOverloadEndScene) ((*(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> *)(vmt + pointerSize * END_SCENE_INDEX))); oOverload = pointerPresent; oOverloadEndScene = pointerEndScene; deferredCommands = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> silk_way::DeferredCommands(); <span class="hljs-comment"><span class="hljs-comment">//hook = new silk_way::HardwareBPHook(); hook = new silk_way::OpcodeHook(); hook-&gt;SetExceptionHandler(OnExceptionHandler); hook-&gt;SetHook(pointerPresent, &amp;PresentHook); hook-&gt;SetHook(pointerEndScene, &amp;EndSceneHook); return TRUE; }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Receptores de fun√ß√£o: </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">HRESULT WINAPI </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PresentHook</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IDirect3DDevice9* pd3dDevice, CONST RECT* pSourceRect, CONST RECT* pDestRect, HWND hDestWindowOverride, CONST RGNDATA* pDirtyRegion)</span></span></span><span class="hljs-function"> </span></span>{ Capture(pd3dDevice); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> record = hook-&gt;GetRecordBySource(oOverload); VirtualOverloadPresent pTrampoline = (VirtualOverloadPresent) record-&gt;pTrampoline; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> result = pTrampoline(pd3dDevice, pSourceRect, pDestRect, hDestWindowOverride, pDirtyRegion); deferredCommands-&gt;Run(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-function"><span class="hljs-function">HRESULT WINAPI </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EndSceneHook</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IDirect3DDevice9* pd3dDevice)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (controller == <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) { controller = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GameController(); controller-&gt;SetDevice(pd3dDevice); } controller-&gt;Update(); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> record = hook-&gt;GetRecordBySource(oOverloadEndScene); VirtualOverloadEndScene pTrampoline = (VirtualOverloadEndScene) record-&gt;pTrampoline; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> result = pTrampoline(pd3dDevice); deferredCommands-&gt;Run(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No presente, cada chamada faz uma captura de tela do buffer da placa de v√≠deo (para verifica√ß√£o) usando a fun√ß√£o Capturar</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">VOID WINAPI </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Capture</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IDirect3DDevice9* pd3dDevice)</span></span></span><span class="hljs-function"> </span></span>{ IDirect3DSurface9 *renderTarget = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; IDirect3DSurface9 *destTarget = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; HRESULT res1 = pd3dDevice-&gt;GetRenderTarget(<span class="hljs-number"><span class="hljs-number">0</span></span>, &amp;renderTarget); D3DSURFACE_DESC descr; HRESULT res2 = renderTarget-&gt;GetDesc(&amp;descr); HRESULT res3 = pd3dDevice-&gt;CreateOffscreenPlainSurface( descr.Width, descr.Height, <span class="hljs-comment"><span class="hljs-comment">/*D3DFMT_A8R8G8B8*/</span></span>descr.Format, D3DPOOL_SYSTEMMEM, &amp;destTarget, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); HRESULT res4 = pd3dDevice-&gt;GetRenderTargetData(renderTarget, destTarget); D3DLOCKED_RECT lockedRect; ZeroMemory(&amp;lockedRect, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(lockedRect)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (destTarget == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; HRESULT res5 = destTarget-&gt;LockRect(&amp;lockedRect, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, D3DLOCK_READONLY); HRESULT res7 = destTarget-&gt;UnlockRect(); HRESULT res6 = D3DXSaveSurfaceToFile(screenshootPath, D3DXIFF_BMP, destTarget, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); renderTarget-&gt;Release(); destTarget-&gt;Release(); }</code> </pre> <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EndScene cria um controlador de l√≥gica de neg√≥cios. </font><font style="vertical-align: inherit;">Ap√≥s a cria√ß√£o, a atualiza√ß√£o do controlador √© chamada, onde toda a l√≥gica √© atualizada. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Observo que agora implementamos o trabalho com o DirectX 9. Se queremos criar algum tipo de modifica√ß√£o, trapa√ßa etc., todas as quatro APIs devem ser suportadas. </font><font style="vertical-align: inherit;">Isso se justifica se o arsenal j√° tiver suas bibliotecas favoritas, espa√ßos em branco para a interface do usu√°rio; caso contr√°rio, voc√™ poder√° usar outra maneira - a funcionalidade que usa o mecanismo para renderizar o jogo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tamb√©m vale a pena dizer que chamar atualiza√ß√µes l√≥gicas do EndScene () n√£o √© a melhor op√ß√£o - voc√™ pode encontrar chamadas peri√≥dicas para fun√ß√µes do mecanismo ou l√≥gica de chamada no seu fluxo. </font><font style="vertical-align: inherit;">Se, no entanto, voc√™ estiver satisfeito com a chamada do EndScene, √© melhor fazer isso com o lockstep. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agora, implementamos tudo o que planejamos.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recomenda√ß√µes de teste</font></font></b> <div class="spoiler_text">       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DirectX SDK</a> ,    ,  DirectX 9  DirectX 11.           DirectX 11,    -      SDK,     (  ,         )   ,     ,     DXUT,      ,      ‚Äî   ,   FPS   . <br><br> <a href=""><img src="https://habrastorage.org/webt/o-/hq/zg/o-hqzgthdamhzrum5h8upaenqly.png"></a> <br> <i> 21 ‚Äî     DirectX SDK   StateManager.exe</i> <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agora voc√™ pode criar uma conta falsa no Steam e injetar o injected.dll no processo do Dota 2. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Direi imediatamente que n√£o sei como √© a situa√ß√£o atual dos pontos de interrup√ß√£o "de ferro" - usando o Opcode Hook (da maneira que fazemos na atual ), voc√™ definitivamente receber√° uma proibi√ß√£o. Fiz isso cerca de seis meses atr√°s - n√£o havia proibi√ß√£o para o Hardware Breakpoint, qual √© a situa√ß√£o atual que n√£o posso dizer. Antes de preparar o artigo, peguei duas contas e tentei o Opcode Hook e o HWBP nelas, a primeira entrou na proibi√ß√£o (cerca de duas semanas se passaram), a segunda n√£o (tr√™s semanas se passaram). Mas ainda n√£o h√° garantias de que a proibi√ß√£o n√£o ser√° no futuro. Ent√£o n√£o se ofenda se acidentalmente fizer uma introdu√ß√£o a partir da sua conta principal ou se esquecer de fazer login na conta falsa - ent√£o j√° se cuide e tenha cuidado.</font></font></b> <br><br><div class="spoiler"> <b class="spoiler_title">    ( )</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/d9/tw/44/d9tw44gqefmz8pvwr1c7y-ppbhq.png"><br> <i> 22 ‚Äî  </i> <br></div></div><br><div class="spoiler"> <b class="spoiler_title">     </b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/nk/v4/za/nkv4zafl57fjog_vqnsf5k1q-va.png"><br> <i> 23 ‚Äî    </i> <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementa√ß√£o no modo 1x1. </font><i><font style="vertical-align: inherit;">Figura 24 - Inje√ß√£o em uma partida</font></i><font style="vertical-align: inherit;"> Tamb√©m vale ressaltar que existe outra maneira de renderizar - renderiza√ß√£o de superf√≠cie criando uma segunda janela com o tamanho apropriado. Infelizmente, n√£o pude perceber a possibilidade de usar uma abordagem de superf√≠cie para o caso do modo de tela cheia, mas a abordagem descrita no artigo permite implementar a renderiza√ß√£o nos modos de tela inteira e janela sem problemas. </font><font style="vertical-align: inherit;">Nossa interface do usu√°rio incorporada cont√©m apenas um r√≥tulo de texto e um bot√£o implementado no DirectX 9 puro - isso √© tudo o que √© necess√°rio para resolver a tarefa. Voc√™ pode implementar tabelas complexas, belos menus e diagramas - em geral, uma interface do usu√°rio de qualquer complexidade, em uma API pura e usando bibliotecas prontas. Claro, n√£o apenas 2D.</font></font><br> <a href=""><img src="https://habrastorage.org/webt/r2/6v/ix/r26vixlwxtaspaykchnffmpwexm.png"></a> <br> <i><font style="vertical-align: inherit;"></font></i> <br><br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 10. Usando fun√ß√µes do motor </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A implementa√ß√£o da mesma funcionalidade para cada API √© bastante sombria; os desenvolvedores fazem wrappers convenientes, fornecendo fun√ß√µes para desenho, interface do usu√°rio etc., que o jogo usa diretamente. </font><font style="vertical-align: inherit;">A Valve tamb√©m fornece APIs do Dota 2 para </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Javascript</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lua</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Isso √© feito para facilitar a vida de moderadores e designers de jogos para quem o C ++ √© complicado (nem mesmo o C ++ em si, mas o uso adequado no contexto do mecanismo). </font><font style="vertical-align: inherit;">Aqui existem fun√ß√µes para renderiza√ß√£o e para a l√≥gica do jogo - voc√™ pode prescrever o comportamento da unidade, por exemplo, selecionando itens, usando habilidades e muito mais. </font><font style="vertical-align: inherit;">Na verdade, com a ajuda disso, cartas personalizadas s√£o escritas.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estaremos interessados ‚Äã‚Äãna fun√ß√£o DoIncludeScript, que permite executar seus scripts em Lua e usar a API de script l√°. Eu n√£o o usei no meu projeto, porque n√£o vi o valor nele, usando fun√ß√µes diretamente do C ++, vi a ideia de us√°-lo com </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or_75</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e decidi inclu√≠-lo no artigo. Isso apresentar√° o que estar√° na segunda parte e economizar√° espa√ßo; n√£o √© necess√°rio explicar certos aspectos do depurador.</font></font><br><br>  Vamos come√ßar.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A tarefa √© a seguinte: voc√™ precisa encontrar um ponteiro para a fun√ß√£o DoIncludeScript, que leva o nome do script e manipulador, para estud√°-lo. Procuraremos a fun√ß√£o usando o scanner da nossa biblioteca silk_way.lib. As fun√ß√µes, como j√° descobrimos, s√£o codificadas na mem√≥ria usando a tabela opcode - vamos examinar esta fun√ß√£o e tentar identificar seu padr√£o de armazenamento na mem√≥ria. Agora, o scanner n√£o possui a funcionalidade necess√°ria, precisamos da capacidade de procurar um modelo na mem√≥ria do processo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para acelerar a pesquisa, n√£o procuraremos um padr√£o na mem√≥ria do processo, mas em um m√≥dulo espec√≠fico (nossa fun√ß√£o est√° em client.dll, isso ser√° visto no depurador e ser√° discutido abaixo). Procuraremos o m√≥dulo usando tlHelp32 pelo nome, enumerando todos os m√≥dulos do processo, para os quais criaremos uma fun√ß√£o para localizar o m√≥dulo no processo GetModuleInfo atual.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo da fun√ß√£o GetModuleInfo</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> IScanner::GetModuleInfo(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* name, MODULEENTRY32* entry) { HANDLE snapshot = CreateToolhelp32Snapshot(TH32CS_SNAPMODULE32 | TH32CS_SNAPMODULE, GetCurrentProcessId()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (snapshot == INVALID_HANDLE_VALUE) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; entry-&gt;dwSize = <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(MODULEENTRY32); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Module32First(snapshot, entry)) { CloseHandle(snapshot); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_stricmp(entry-&gt;szModule, name)) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Module32Next(snapshot, entry)); CloseHandle(snapshot); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O padr√£o √© uma sequ√™ncia com um valor de bytes; pular um byte √© indicado pelo s√≠mbolo "??" </font><font style="vertical-align: inherit;">- por exemplo, "j9 ?? </font><font style="vertical-align: inherit;">?? </font><font style="vertical-align: inherit;">?? </font><font style="vertical-align: inherit;">?? </font><font style="vertical-align: inherit;">48 03 08 ?? </font><font style="vertical-align: inherit;">f1 ff ‚Äù. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analisando a string, por conveni√™ncia, transferiremos o padr√£o da representa√ß√£o da string para a lista de valores de caracteres n√£o assinados, definiremos os sinalizadores de bytes a serem ignorados.</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* IScanner::Parse(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&amp; len, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* strPattern, <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* skipByteMask) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> strPatternLen = <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(strPattern); <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* pattern = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[strPatternLen]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; strPatternLen; i++) pattern[i] = <span class="hljs-number"><span class="hljs-number">0</span></span>; len = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; strPatternLen; i += <span class="hljs-number"><span class="hljs-number">2</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> code = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strPattern[i] == SKIP_SYMBOL) skipByteMask[len] = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> code = Parse(strPattern[i]) * <span class="hljs-number"><span class="hljs-number">16</span></span> + Parse(strPattern[i + <span class="hljs-number"><span class="hljs-number">1</span></span>]); i++; pattern[len++] = code; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pattern; } <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> IScanner::Parse(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> byte) { <span class="hljs-comment"><span class="hljs-comment">// some magic values if (byte &gt;= '0' &amp;&amp; byte &lt;= '9') return byte - '0'; else if (byte &gt;= 'a' &amp;&amp; byte &lt;= 'f') return byte - 'a' + 10; else if (byte &gt;= 'A' &amp;&amp; byte &lt;= 'F') return byte - 'A' + 10; return 0; }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O n√∫cleo da pesquisa √© implementado na fun√ß√£o FindPattern, onde, com base nas informa√ß√µes recebidas sobre o m√≥dulo, s√£o definidos os endere√ßos inicial e final da pesquisa. </font><font style="vertical-align: inherit;">As informa√ß√µes sobre a mem√≥ria que ser√° pesquisada s√£o solicitadas pela fun√ß√£o VirtualQuery, existem v√°rios requisitos de mem√≥ria - ela deve estar ocupada (ser√° um erro procurar na mem√≥ria livre), a mem√≥ria deve ser leg√≠vel, execut√°vel e n√£o conter o sinalizador PageGuard:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* pStart = moduleEntry.modBaseAddr; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* pFinish = moduleEntry.modBaseAddr + moduleEntry.modBaseSize; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* current = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*)pStart; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (; current &lt; pFinish &amp;&amp; j &lt; patternLen; current++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!VirtualQuery((LPCVOID)current, &amp;info, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(info))) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> protectMask = PAGE_READONLY | PAGE_READWRITE | PAGE_EXECUTE_READWRITE | PAGE_EXECUTE | PAGE_EXECUTE_READ; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info.State == MEM_COMMIT &amp;&amp; info.Protect &amp; protectMask &amp;&amp; !(info.Protect &amp; PAGE_GUARD)) { <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> finish = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)pFinish &lt; (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)info.BaseAddress + info.RegionSize ? (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)pFinish : (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>) info.BaseAddress + info.RegionSize; current = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*)info.BaseAddress; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* rip = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> k = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)info.BaseAddress; k &lt; finish &amp;&amp; j &lt; patternLen; k++, current++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (skipByteMask[j] || pattern[j] == *current) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (j == <span class="hljs-number"><span class="hljs-number">0</span></span>) rip = current; j++; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { j = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pattern[<span class="hljs-number"><span class="hljs-number">0</span></span>] == *current) { rip = current; j = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (j == patternLen) { current = rip; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> current += sysInfo.dwPageSize; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agora somos capazes de procurar o modelo desejado na mem√≥ria do processo, mas ainda n√£o sabemos o que procurar. Execute o Steam na conta Fake e abra seu depurador favorito (vamos concordar que, durante a leitura do artigo, x64dbg tamb√©m √© para voc√™ - n√£o tenho uma licen√ßa paga para o IDA Pro), execute o dota2.exe no diret√≥rio ... \ Steam \ steamapps \ comum \ dota 2 beta \ jogo \ bin \ win64. Em princ√≠pio, n√£o percebi que o VAC n√£o era indiferente ao Cheat Engine e ao x64dbg, n√£o me lembro que ao usar essas ferramentas a conta foi banida. A prop√≥sito, o depurador possui um </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plug-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">ScyllaHide</font></a><font style="vertical-align: inherit;"> que intercepta fun√ß√µes do sistema como NtCreateThreadEx, NtSetInformationThread, etc., ocultando o fato de seu trabalho, voc√™ pode instalar esse plug-in.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A cada parada (haver√° 10 a 15), continuamos executando usando Run (F9). Quando o jogo come√ßar, veremos o menu e podemos come√ßar a pesquisar. Depois de iniciar o jogo, fa√ßa uma pesquisa nas linhas (Procurar-&gt; Todos os M√≥dulos-&gt; Refer√™ncias de String), defina o filtro ‚ÄúDoIncludeScript‚Äù. </font><i><font style="vertical-align: inherit;">Figura 25 - Pesquisando as linhas na mem√≥ria do processo do jogo</font></i><font style="vertical-align: inherit;"> Vamos para o desmontador (guia CPU) clicando duas vezes no primeiro resultado. Este ser√° o nosso endere√ßo inicial, j√° que est√° no client.dll, o restante dos resultados est√° no server.dll e no animationsystem.dll. </font><font style="vertical-align: inherit;">Constru√≠mos um gr√°fico de chamadas a partir do endere√ßo recebido. </font><i><font style="vertical-align: inherit;">Figura 26 - Gr√°fico de chamadas</font></i><font style="vertical-align: inherit;"> Ap√≥s a descompila√ß√£o, encontramos o ponto de entrada onde o DoIncludeScript √© usado - o quarto n√≥ do gr√°fico. Na verdade, a pr√≥pria fun√ß√£o.</font></font><br><br> <a href=""><img src="https://habrastorage.org/webt/nl/t2/x7/nlt2x7qovaunasqqpd6hqojgclw.png"></a> <br> <i><font style="vertical-align: inherit;"></font></i> <br><br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br> <a href=""><img src="https://habrastorage.org/webt/om/os/zo/omoszo_tqtleqsulp5c97sp7iwo.png"></a> <br> <i><font style="vertical-align: inherit;"></font></i> <br><br><font style="vertical-align: inherit;"></font><br><br> <a href=""><img src="https://habrastorage.org/webt/ja/pp/zo/jappzokowbi-si2zm8zchka3pjk.png"></a> <br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figura 27 - A fun√ß√£o DoIncludeScript</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Graph. </font><i><font style="vertical-align: inherit;">Figura 28 - Gr√°fico de chamada do DoIncludeScript A descompila√ß√£o</font></i><font style="vertical-align: inherit;"> do uso da fun√ß√£o mostra o c√≥digo a seguir e o local da chamada (a descompila√ß√£o √© feita no gr√°fico, n√£o no desmontador). </font><i><font style="vertical-align: inherit;">Figura 29 - Descompilando uma chamada para a fun√ß√£o DoIncludeScript Vamos</font></i><font style="vertical-align: inherit;"> compor um modelo a partir das instru√ß√µes na Figura 27 da chamada para a fun√ß√£o DoIncludeScript. Os argumentos podem mudar, respectivamente. Queremos pular os argumentos do modelo ao pesquisar, os denotamos por "??". Eu tenho o seguinte: 40 57 48 81 EC ?? ?? ?? ?? 48 83 3D ?? ?? ?? ?? ?? 48 8B F9 0F 84. Para compilar o modelo, usamos o primeiro n√≥ do gr√°fico da Figura 28, cujas instru√ß√µes podem ser encontradas na Figura 27.</font></font><br><br> <a href=""><img src="https://habrastorage.org/webt/ji/q0/w9/jiq0w96b8mmvbuh7un7iyiffq_8.png"></a> <br> <i><font style="vertical-align: inherit;"></font></i> <br><br><font style="vertical-align: inherit;"></font><br><br> <a href=""><img src="https://habrastorage.org/webt/pb/rl/8h/pbrl8hdsnnowxoyfq-lz1xbq3xg.png"></a> <br> <i><font style="vertical-align: inherit;"></font></i> <br><br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Crie um script em Lua silk_way.lua, coloque-o em "... \ Steam \ steamapps \ common \ dota 2 beta \ game \ dota \ scripts \ vscripts". </font></font><br><br><pre> <code class="lua hljs"><span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"SILK_WAY START"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> first = Entities:First() <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (first ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> position = first:GetAbsOrigin() <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> strInfo = <span class="hljs-string"><span class="hljs-string">"["</span></span> .. <span class="hljs-string"><span class="hljs-string">"pos:"</span></span> .. <span class="hljs-built_in"><span class="hljs-built_in">tostring</span></span>(position.x) .. <span class="hljs-string"><span class="hljs-string">","</span></span> .. <span class="hljs-built_in"><span class="hljs-built_in">tostring</span></span>(position.y) .. <span class="hljs-string"><span class="hljs-string">","</span></span> .. <span class="hljs-built_in"><span class="hljs-built_in">tostring</span></span>(position.z) .. <span class="hljs-string"><span class="hljs-string">"]"</span></span> DebugDrawText(position, strInfo, <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-number"><span class="hljs-number">300.0</span></span>) first = Entities:Next(first) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"SILK_WAY FINISH"</span></span>) <span class="hljs-comment"><span class="hljs-comment">--[[ListenToGameEvent("dota_roshan_kill",roshan_kill,nil)]]</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esse script ignora todas as entidades e exibe as coordenadas de acordo com sua posi√ß√£o. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Declare a fun√ß√£o usando a documenta√ß√£o acima e o c√≥digo descompilado da Figura 29.</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bool</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*fDoIncludeScript)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">*, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>;</code> </pre> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Chamada de fun√ß√£o. </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">HRESULT WINAPI </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EndSceneHook</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IDirect3DDevice9* pd3dDevice)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (controller == <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) { controller = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GameController(); controller-&gt;SetDevice(pd3dDevice); fDoIncludeScript DoIncludeScript = (fDoIncludeScript) scanner-&gt;FindPattern(<span class="hljs-string"><span class="hljs-string">"client.dll"</span></span>, <span class="hljs-string"><span class="hljs-string">"40 57 48 81 EC ?? ?? ?? ?? 48 83 3D ?? ?? ?? ?? ?? 48 8B F9 0F 84"</span></span>); DoIncludeScript(<span class="hljs-string"><span class="hljs-string">"silk_way"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-comment"><span class="hljs-comment">//... }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ap√≥s a implementa√ß√£o, veremos informa√ß√µes sobre a posi√ß√£o das entidades do jogo. </font><i><font style="vertical-align: inherit;">Figura 30 - Resultado da implementa√ß√£o</font></i><font style="vertical-align: inherit;"> Agora somos capazes de executar nossos scripts. </font><font style="vertical-align: inherit;">Mas eles s√£o executados em Lua, e digamos que o evento que Roshan morreu seja necess√°rio para n√≥s no c√≥digo C ++ (j√° que temos a l√≥gica principal escrita nele), o que devemos fazer? </font><font style="vertical-align: inherit;">Teremos que encontrar indicadores para as fun√ß√µes necess√°rias da mesma maneira (como fizemos para DoIncludeScript), fun√ß√µes de mecanismo e outras funcionalidades de seu interesse usando o Source SDK e o Source2Gen. </font><font style="vertical-align: inherit;">Mas mais sobre isso na pr√≥xima parte, onde encontraremos um ponteiro para uma lista de entidades e escreveremos a l√≥gica mais pr√≥xima da mec√¢nica do jogo. </font><font style="vertical-align: inherit;">Se voc√™ quer tudo de uma vez, pode tentar, estou anexando </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">isto</font></a><font style="vertical-align: inherit;"> , </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">isto</font></a><font style="vertical-align: inherit;"> , </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">isto</font></a><font style="vertical-align: inherit;"> e </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">isto</font></a><font style="vertical-align: inherit;"> como sua ajuda</font></font><br><br> <a href=""><img src="https://habrastorage.org/webt/en/x2/4l/enx24lrbff5j_6l0v4ydxhecm84.png"></a> <br> <i><font style="vertical-align: inherit;"></font></i> <br><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> links. </font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 11. Conclus√£o </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Concluindo, gostaria de agradecer a todos que compartilham suas melhores pr√°ticas e conhecimentos no campo da revers√£o, compartilhando sua experi√™ncia com outras pessoas. Falando apenas sobre o Dota 2 sem um </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√£o de ora√ß√£o,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> eu teria </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">gastado</font></a><font style="vertical-align: inherit;"> muito tempo para obter a estrutura de dados do jogo usando o Cheat Engine, e as realiza√ß√µes feitas poderiam quebrar com qualquer atualiza√ß√£o da Valve. As atualiza√ß√µes quebram os ponteiros est√°ticos encontrados e ocasionalmente alteram a estrutura das entidades. No </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or75,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vi o uso da fun√ß√£o DoIncludeScript e, com sua ajuda, mostrei um exemplo de sa√≠da de texto usando o mecanismo de jogo.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em busca da simplicidade da apresenta√ß√£o, pude perder alguma coisa, omitir v√°rios casos que considero indignos de aten√ß√£o, ou vice-versa, inflar a explica√ß√£o - se um leitor atento encontrar tais erros, terei o prazer de corrigi-los e ouvir os coment√°rios. </font><font style="vertical-align: inherit;">O c√≥digo fonte pode ser encontrado no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obrigado a todos que tiveram tempo para ler o artigo.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt446516/">https://habr.com/ru/post/pt446516/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt446506/index.html">Cinco perguntas-chave para o varejo ao migrar para nossas nuvens</a></li>
<li><a href="../pt446508/index.html">Trabalhadores do .NET Core como Servi√ßos do Windows</a></li>
<li><a href="../pt446510/index.html">CLRium # 5: Coletor de Lixo. Maior Workshop .NET</a></li>
<li><a href="../pt446512/index.html">Trabalhadores do .NET Core como Servi√ßos do Windows</a></li>
<li><a href="../pt446514/index.html">O Gmail tem 15 anos</a></li>
<li><a href="../pt446518/index.html">Firewalls de aplicativos da Web</a></li>
<li><a href="../pt446520/index.html">Como tudo come√ßou: a hist√≥ria dos drones voadores</a></li>
<li><a href="../pt446522/index.html">Swift 5.1 - o que h√° de novo?</a></li>
<li><a href="../pt446530/index.html">Word2vec em imagens</a></li>
<li><a href="../pt446532/index.html">Upwork introduz uma taxa pelo direito de escrever para um cliente em potencial</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>