<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòá üßóüèª üî≤ Aventuras en una corriente separada. Informe Yandex ü¶Ü üîå ü§ôüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¬øC√≥mo trabajar con im√°genes en el cliente, manteniendo una interfaz de usuario fluida? El desarrollador de interfaces Pavel Smirnov habl√≥ sobre esto s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Aventuras en una corriente separada. Informe Yandex</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/453626/"> ¬øC√≥mo trabajar con im√°genes en el cliente, manteniendo una interfaz de usuario fluida?  El desarrollador de interfaces Pavel Smirnov habl√≥ sobre esto sobre la base de la experiencia de desarrollar la b√∫squeda de fotograf√≠as en el mercado.  A partir del informe, puede aprender a usar Web Workers y OffscreenCanvas correctamente. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/t_/ku/-u/t_ku-uoatzm936x50sn7rzjab5w.jpeg"></a> <br><br>  - Durante esta media hora hablaremos de aventuras.  Te contar√© sobre mi aventura y realmente espero que mi informe te inspire y que tomes y hagas lo mismo en casa. <br><br><a name="habracut"></a>  Al principio, quer√≠a hablar sobre algunas tecnolog√≠as nuevas o no muy nuevas que nuestros navegadores nos brindan y que nos permiten hacer cosas geniales.  Pero me parece que no ser√≠a muy divertido, porque todos pueden ir a MDN y leer algo.  Por lo tanto, contar√© la historia de una caracter√≠stica que hice con el equipo de Market. <br><br>  Vamos a presentarme de nuevo primero.  Mi nombre es Pasha, soy un desarrollador de interfaces en el equipo de Market. <br><br><img src="https://habrastorage.org/webt/bc/vy/s_/bcvys_xxtyt4hekvl26k-9zdlga.jpeg"><br><br>  Principalmente trato con interfaces m√≥viles: b√∫squeda de mapas, tarjeta de oferta.  Tambi√©n reescribo el c√≥digo de la pila anterior a la nueva, y luego de la nueva a una pila a√∫n m√°s nueva.  Y trato de hacer que mis interfaces sean buenas.  Aqu√≠ vale la pena decir qu√© es una buena interfaz. <br><br>  Las buenas interfaces tienen diferentes caracter√≠sticas.  En primer lugar, es conveniente; en segundo lugar, es hermoso; en tercer lugar, es asequible.  Pero una de las caracter√≠sticas de las que quiero hablar hoy es la velocidad.  Y la velocidad a menudo se manifiesta en la suavidad de su trabajo.  Incluso los frisos peque√±os pueden cambiar en gran medida la experiencia del usuario de nuestras interfaces. <br><br><img src="https://habrastorage.org/webt/p-/ww/kw/p-wwkw03iuh5yrgyfc-fjvubma8.jpeg"><br><br>  Pasemos al plan para mi conversaci√≥n de hoy.  Primero hablaremos sobre la tarea que hice: encontrar una imagen en el mercado.  A continuaci√≥n, te dir√© qu√© problemas tuve que resolver para implementar esta funcionalidad.  Aqu√≠ recordamos un poco c√≥mo funciona su script en el navegador, y veamos las tecnolog√≠as que me ayudaron.  Peque√±o spoiler: estos son Web Workers y OffscreenCanvas. <br><br>  Volvamos a la tarea.  Hace unos meses, Luba, nuestro gerente de producto, se me acerc√≥.  Lyuba aborda los problemas de elegir un producto en el mercado.  Ahora tenemos varias opciones para encontrar productos.  Una de ellas es ingresar algo en la barra de b√∫squeda. <br><br><img src="https://habrastorage.org/webt/ul/m6/tn/ulm6tnl0vt8kdewxzrr1ofgfch0.jpeg"><br><br>  Por ejemplo, "compre un iPhone X rojo en Samara".  Y encontraremos algo.  O podemos usar el √°rbol de cat√°logo.  En este cat√°logo tenemos categor√≠as y subcategor√≠as. <br><br>  Pero, ¬øqu√© pasa si quiero encontrar algo en el mercado, sin saber c√≥mo se llama, pero o tengo una foto de esta cosa o la veo en la fiesta de alguien? <br><br><img src="https://habrastorage.org/webt/hz/0t/ne/hz0tnecdwmrqd4slxosbd4ghtgs.jpeg"><br><br>  Te dir√© un caso real.  Una vez fui con mis amigos a un caf√©.  Pedimos limonada all√≠, ya sabes, en una jarra as√≠, y esta jarra ten√≠a algo muy extra√±o.  Incluso guard√© una foto.  Fue dise√±ado para que cuando vierta limonada en un vaso, el hielo no entre en √©l.  Pensamos que era algo genial, pero ten√≠amos opiniones diferentes sobre c√≥mo se llamaba y, en general, para qu√© estaba destinado.  Por lo tanto, lo encontramos en Yandex.Pictures. <br><br>  Pero pens√©: ser√≠a genial si no solo pudiera buscar esta cosa, sino tambi√©n comprarla de inmediato o al menos averiguar el precio, leer rese√±as, especificaciones, etc. En este punto, nuestros sue√±os coincidieron con Any, y decidimos hacer tal funcionalidad en el mercado. <br><br>  ¬øC√≥mo es esta funcionalidad?  Permite al usuario cargar una foto o una foto, incluso puede tomar una foto de inmediato y enviarla al mercado.  Analizamos esta foto usando las tecnolog√≠as de b√∫squeda de Yandex, encontramos un producto en ella y mostramos al usuario los resultados con estos productos.  Parece simple, pero si fuera as√≠ de simple, no har√≠a mi informe.  Para asegurarme de qu√© tipo de caracter√≠stica es esta, d√©jame mostrarte. <br><br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Mira la primera demo</a></i> <br><br>  Lo mostrar√© en producci√≥n.  Primero, cargue lo que est√°bamos buscando y veamos qu√© sucede. <br><br>  Encontramos algunos bienes y espec√≠ficamente esta cosa.  Esta cosa se llama colador.  Para encontrar algo m√°s, ayer fotografi√© un libro en el escritorio de un colega, vamos a buscarlo.  Aqu√≠ hay un libro as√≠, tal vez alguien lo lea.  Se llama "C√≥digo perfecto".  Tambi√©n lo encuentra de alguna manera, y por alguna raz√≥n con un l√≠mite de 18+.  Esto es probablemente un poco extra√±o. <br><br>  Volvamos a nuestro informe.  ¬øQu√© problemas he encontrado?  El primer problema es que el usuario comienza a descargar cualquier cosa, incluidas im√°genes enormes.  Por ejemplo, mi tel√©fono toma fotos de tres a cuatro megabytes de tama√±o, lo cual es bastante.  Enviar tales fotos al backend es ineficiente.  Toma mucho tiempo, toma mucho tiempo analizarlos, por lo que debe hacer algo al respecto.  Pero aqu√≠ todo es simple: recortaremos, comprimiremos, redimensionaremos esta foto en el cliente. <br><br><img src="https://habrastorage.org/webt/gs/qm/fo/gsqmfoelkfhdlcmhijbrpl1u3b8.jpeg"><br><br>  ¬øC√≥mo haremos esto?  Tenemos un archivo  Y de alguna manera leeremos este archivo.  Leeremos usando la API FileReader.  Te dir√© brevemente de qu√© se trata. <br><br><img src="https://habrastorage.org/webt/ii/c0/ip/iic0ipw8vjdg5mpre0x6yw3ye_q.jpeg"><br><br>  Esta es una API de navegador que nos permite leer el archivo descargado y hacer algo con √©l.  Puedes leer de diferentes maneras, lo veremos ahora.  Estas son sus caracter√≠sticas, y tenemos alg√∫n tipo de objeto que nos devolvi√≥ de la entrada del evento de cambio.  Tratemos de leerlo. <br><br><img src="https://habrastorage.org/webt/dd/t6/ya/ddt6yaay0twlpecj1rkwxhzob1w.jpeg"><br><br>  El c√≥digo se ver√° as√≠.  No hay nada complicado aqu√≠ todav√≠a.  Tenemos un objeto Reader creado a partir del constructor FileReader, en el que colgamos al desarrollador del evento de carga.  A continuaci√≥n, leeremos este archivo como DataURL.  DataURL: una cadena que representa el contenido del archivo codificado a trav√©s de Base64.  Como leemos, necesitamos cortarlo de alguna manera.  Primero, carguemos todo en una imagen.  Tenemos una etiqueta o elemento img, y lo cargamos all√≠ mismo. <br><br><img src="https://habrastorage.org/webt/38/fo/oe/38fooeukiuqzgzmprkjqvpelgfw.jpeg"><br><br>  El c√≥digo se ver√° m√°s o menos as√≠.  Creamos un elemento img, mediante el evento load Reader cargamos nuestra l√≠nea en el atributo src y haremos todo m√°s cuando nuestra l√≠nea termine de cargarse en img. <br><br>  Haremos lo que quisi√©ramos: recortar la imagen.  Lo comprimiremos, y aqu√≠ algo como Canvas nos ayudar√°, una herramienta muy poderosa.  Te permite hacer mucho.  Pero aqu√≠ solo dibujamos nuestra imagen en este lienzo, y si los tama√±os de la imagen exceden el m√°ximo permitido, los ajustaremos un poco.  Adem√°s, podemos recoger esta imagen con Canvas de la relaci√≥n de compresi√≥n deseada. <br><br><img src="https://habrastorage.org/webt/if/zs/ny/ifzsnym6-fi7xyx8evc-_dvv4ni.jpeg"><br><br>  Algo asi.  Otro peque√±o descargo de responsabilidad: el c√≥digo aqu√≠ est√° muy simplificado, no especifico todo.  Tenemos manejo de errores y otras cosas, pero para que todo encaje en la diapositiva y quede claro en el informe, omit√≠ algunos detalles. <br><br>  Tenemos tama√±os de imagen, solo los miramos.  Hay algunas constantes permitidas para nosotros.  Si el tama√±o de las im√°genes excede nuestras constantes, simplemente las recortamos debajo de ellas y configuramos nuestro Canvas en estos mismos tama√±os. <br><br>  A continuaci√≥n dibujaremos nuestra imagen en este lienzo. <br><br><img src="https://habrastorage.org/webt/3n/c1/gr/3nc1gr71oyygkviglnhv9hwfzeg.jpeg"><br><br>  Tome el contexto 2d, necesitamos una imagen 2d e intente dibujar usando el m√©todo drawImage.  DrawImage es un m√©todo interesante que acepta, si no me equivoco, nueve par√°metros.  Pero no todos son obligatorios, usaremos solo cinco.  Tomamos Imagen y esos dos ceros, esto es desplazamiento o sangr√≠a de la imagen.  Necesitamos el punto superior izquierdo.  Dibuja con las dimensiones que necesitamos. <br><br>  Adem√°s, a partir de este lienzo, tomaremos nuestra cadena Base64 codificada por DataURL exactamente de la misma manera y la convertiremos en blob, un objeto especial que nos conviene enviar al servidor.  Parece ser todo.  Todo funciona  La imagen se recorta, se env√≠a la imagen, se reconoce la imagen. <br><br>  Pero luego comenc√© a notar algo.  Cuando prob√© esta soluci√≥n, cuando cargu√© una imagen, especialmente en dispositivos d√©biles, mi interfaz se ralentiz√≥ un poco.  O no se presion√≥ el bot√≥n, entonces el elemento no se desplaz√≥ as√≠.  ¬øTuviste la sensaci√≥n de que tu c√≥digo funciona en el 99% de los casos y funciona bien, pero a veces simplemente no funciona?  Y puede d√°rselo para probar, y probablemente nadie lo notar√°.  Y los usuarios, probablemente, no lo notar√°n, especialmente en dispositivos d√©biles. <br><br>  Esto nunca me ha pasado, y decid√≠ arreglarlo.  Esto result√≥ ser un problema.  Si la imagen es grande, entonces, durante las manipulaciones con recorte, compresi√≥n, nos tom√≥ algo de tiempo, y en este peque√±o, peque√±o tiempo, nuestra interfaz no respondi√≥. <br><br>  Al principio descubr√≠ por qu√© sucede esto.  Aqu√≠ vale la pena recordar un poco c√≥mo funciona JavaScript en el navegador.  No entrar√© en detalles, este es un tema para un gran informe.  Solo recuerda algunos puntos. <br><br><img src="https://habrastorage.org/webt/rx/bq/-n/rxbq-nzhacdcemzt89xme0h331w.jpeg"><br><br>  Tenemos JavaScript ejecut√°ndose en un solo hilo, llam√©moslo principal.  Y tenemos tal cosa en el navegador como un bucle de eventos.  Aqu√≠ inmediatamente decimos que este es un modelo.  En algunos navegadores, el bucle de eventos est√° organizado de manera diferente, pero como su nombre lo indica, en general es un bucle.  Procesa ciertas tareas en la cola en orden. <br><br>  Un momento desagradable: hasta que procese una tarea, no pasar√° a la siguiente.  Mostrar√© la demostraci√≥n que vi, ella lo muestra.  Ella es un clasico. <br><br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Mira la segunda demostraci√≥n</a></i> <br><br>  Tengo una imagen GIF y una animaci√≥n CSS realizada de diferentes maneras: una que usa translatex, la otra que usa posici√≥n: relativa a la izquierda, la tercera que usa JavaScript, es decir, requestAnimationFrame.  Aqu√≠ es donde gira el erizo.  Que har√© <br><br>  Bloquear√© el hilo principal durante cinco segundos.  Ya sabes, por lo general, los tipos duros calculan el en√©simo n√∫mero de Fibonacci, pero escrib√≠ un bucle sin fin con un descanso en cinco segundos. <br><br>  Que va a pasar  Inmediatamente not√≥ que el erizo dej√≥ de girar, y el gato inferior, que est√° animado usando translatex, tambi√©n dej√≥ de montar.  Pero veamos la misma demostraci√≥n en otro navegador, por ejemplo Safari.  El gato GIF dej√≥ de correr. <br><br>  ¬øPor qu√© estoy mostrando todo esto?  En primer lugar, los navegadores son diferentes, debes tener esto en cuenta.  En segundo lugar, cuando algo bloquea nuestro flujo, algunas cosas dejar√°n de funcionar.  Por ejemplo, animaci√≥n JavaScript.  O demostremos que el texto ya no se destacar√°, los botones ya no se presionar√°n. <br><br>  Este es un ejemplo muy abstracto.  No bloqueemos el flujo durante cinco segundos, tome nuestra tarea, cargue una foto, rec√≥rtela, expr√≠mala y dibuje aqu√≠.  No lo enviaremos a ning√∫n lado, no ser√° muy revelador. <br><br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Mira la tercera demostraci√≥n</a></i> <br><br>  Tengo una MacBook poderosa aqu√≠, y para que todo parezca m√°s convincente, ralentizaremos el procesador seis veces.  Esto le permite hacer DevTools.  Sube nuestra foto.  El C√≥digo Perfecto nos ayudar√° nuevamente.  Como vemos, sucede lo mismo que cuando se bloquea el hilo principal. <br><br>  Regresemos a nuestra tarea y pensemos c√≥mo trataremos esto. <br><br><img src="https://habrastorage.org/webt/us/bk/y1/usbky1tcsqcmijlpm7yvhzqejxu.jpeg"><br><br>  Por cierto, si nos fijamos en el generador de perfiles, veremos esto.  En el marco rojo est√° nuestra microtask, que bloquea el hilo principal.  Vemos que lo bloquea por casi cinco segundos.  Est√° en una computadora bastante poderosa, y en dispositivos m√°s d√©biles ser√° a√∫n m√°s notable. <br><br>  Pasemos a la soluci√≥n.  Dir√© de inmediato lo que us√© y lo que hice, y luego analizaremos todas estas cosas.  Primero, utilic√© Web Workers.  Nos permiten poner algunas tareas en un hilo separado.  Y en segundo lugar, en el contexto de Web Workers, el DOM no est√° disponible para nosotros.  Para hacer frente a esta situaci√≥n, utilizaremos otras herramientas.  La imagen no estar√° disponible para nosotros, el Canvas cl√°sico est√° disponible y, por lo tanto, usamos Canvas y algunos otros trucos. <br><br><img src="https://habrastorage.org/webt/fy/vw/f1/fyvwf1psmu5-m4szo28ffv7qykm.jpeg"><br><br>  Recordemos r√°pidamente qu√© son los trabajadores, para qu√© sirven.  Le permiten ejecutar JavaScript en un hilo separado, no principalmente.  Y el flujo de trabajo no interfiere con el flujo de representaci√≥n de la interfaz principal.  Por lo tanto, podemos realizar algunas tareas computacionales complejas sin ralentizar nuestra interfaz. <br><br>  Tenemos una herramienta que le permite transferir algo a los trabajadores y devolver algo de los trabajadores.  Veamos un ejemplo. <br><br><img src="https://habrastorage.org/webt/tl/3n/gt/tl3ngt03saazi4u4c-jrw2qpsjs.jpeg"><br><br>  Entonces creamos nuestro Worker usando el constructor.  All√≠ debe transferir la ruta al archivo.  Incluso podemos pasar blob.  Y tenemos un controlador de eventos de mensajes.  En este caso, simplemente mostrar√° algo en la pantalla.  Entonces podemos enviar algunos datos a nuestro trabajador. <br><br><img src="https://habrastorage.org/webt/dz/d4/zq/dzd4zq9kr9xsjub1pznwor1m0cy.jpeg"><br><br>  ¬øCu√°l es el soporte?  Todo est√° bien aqu√≠.  Trabajadores es una herramienta bien conocida, no nueva, pero muchos de mis amigos piensan que no siempre son compatibles.  Esto no es asi. <br><br><img src="https://habrastorage.org/webt/qq/0p/iq/qq0piq8knelh8flsttmdu3nvmxc.jpeg"><br><br>  Ahora echemos un vistazo a OffscreenCanvas.  Como ya hemos visto, Canvas es una herramienta muy poderosa, pero, desafortunadamente, no est√° disponible para nosotros en el contexto de Web Workers, por lo que utilizaremos una alternativa.  Esta es una cosa bastante nueva llamada OffscreenCanvas.  Le permite hacer casi las mismas cosas que Canvas, solo fuera de la pantalla, es decir, en el contexto de Web Workers.  Por supuesto, podemos hacer esto tambi√©n en el contexto de la ventana, pero ahora no lo haremos. <br><br><img src="https://habrastorage.org/webt/g4/26/zz/g426zzs7plg7015gze3pivfyedc.jpeg"><br><br>  ¬øQu√© hay con el apoyo?  Como puede ver, hay mucho rojo.  OffscreenCanvas normalmente solo es compatible con Chrome.  Tambi√©n hay una opci√≥n con Firefox, pero hasta ahora hay una bandera, y Canvas solo funciona con contexto WebGL.  Aqu√≠ puedes preguntar: ¬øpor qu√© estoy hablando de algo tan genial como OffscreenCanvas, que no funciona en ning√∫n lado? <br><br><img src="https://habrastorage.org/webt/ut/pg/po/utpgpozecg0ufn847t-jpfuleqe.jpeg"><br><br>  Una peque√±a digresi√≥n.  Tenemos algunos niveles de soporte de navegador en el mercado.  Y tenemos dos cantidades.  Un valor caracteriza el navegador, que no admitimos en absoluto.  Esto es aproximadamente la mitad del porcentaje de popularidad del navegador. <br><br>  Y hay una segunda cantidad.  Incluye los navegadores que admitimos, pero solo la funcionalidad cr√≠tica.  Aqu√≠, sin Trabajadores, toda la funcionalidad de b√∫squeda funciona, pero con peque√±os frisos.  Creo que est√° bien, y nuestro equipo cree que est√° bien.  Veamos c√≥mo implementaremos esto. <br><br><img src="https://habrastorage.org/webt/eo/p7/0l/eop70llp8tzton82fokyhi9c17e.jpeg"><br><br>  Aqu√≠ hay un diagrama de lo que haremos.  Incluso tenemos archivos que leeremos a trav√©s de FileReader.  Pero en la transmisi√≥n principal, lo enviaremos a Web Workers, donde se cortar√°, comprimir√° y volver√° a nosotros, y ya lo enviaremos al servidor. <br><br><img src="https://habrastorage.org/webt/uq/zx/x_/uqzxx_ifbctkux0m1o1ogw5pauu.jpeg"><br><br>  Veamos el c√≥digo de nuestro trabajador.  Primero, creamos una instancia OffscreenCanvas con el ancho y la altura que necesitamos. <br><br>  Adem√°s, como dije, el elemento Imagen no est√° disponible para nosotros en el contexto Trabajadores, por lo que aqu√≠ usamos el m√©todo createImageBitmap, que nos har√° la estructura de datos que caracteriza nuestra imagen. <br><br>  De lo interesante: nos vemos aqu√≠ a uno mismo.  Aquellos que no est√°n familiarizados con Web Workers, esto apunta al contexto de ejecuci√≥n.  No nos importa aqu√≠, ventana o esto, usamos self.  Este m√©todo es as√≠ncrono, lo he usado aqu√≠ para ser compacto y conveniente, ¬øpor qu√© no? <br><br>  Luego, obtenemos la misma imagen y hacemos lo mismo que hicimos antes.  Dibuja en el lienzo y vuelve. <br><br>  De lo simple.  Sol√≠amos tomar DataURL y convertir todo a blob.  Pero aqu√≠ el m√©todo convertToBlob est√° disponible de inmediato para nosotros.  ¬øPor qu√© no lo he usado antes?  Porque el apoyo fue peor.  Pero dado que fuimos hasta aqu√≠ y usamos OffscreenCanvas, ¬øqu√© nos impide usar convertToBlob? <br><br><img src="https://habrastorage.org/webt/a2/c-/bs/a2c-bssaaa8knh26p10fdta__zc.jpeg"><br><br>  Devolveremos este blob b√°sicamente una secuencia, desde donde lo enviaremos al servidor.  O, como en las demos, dibujarlo. <br><br>  Entonces creamos un Trabajador en el hilo principal, escuchamos algunos mensajes y dibujaremos o enviaremos al servidor.  No hay nada importante aqu√≠.  El trabajador aceptar√° nuestros archivos. <br><br>  Volvamos a nuestra demo. <br><br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Mira la cuarta demostraci√≥n</a></i> <br><br>  La misma demostraci√≥n, los mismos tres gatos y un erizo.  Encender√© el acelerador nuevamente, ralentizando el procesador seis veces.  Subir√© la misma foto.  Como vemos, en el momento en que se dibuj√≥ la imagen, las animaciones no se detuvieron, el erizo continu√≥ girando, la interfaz permaneci√≥ y logramos lo que quer√≠amos. <br><br>  ¬øPero se puede mejorar esta decisi√≥n? <br><br><img src="https://habrastorage.org/webt/sc/jo/x0/scjox0apap-ojlx03_gfvauava8.jpeg"><br><br>  Aqu√≠, por cierto, el perfilador.  Aqu√≠ no vemos las enormes Microtasks durante los cinco segundos que vimos antes. <br><br>  La mejora es posible.  Utilizando objetos transferibles.  Aqu√≠ vale la pena volver de nuevo.  Cuando pasamos nuestro DataURL o blob a trav√©s del mecanismo postMessage, copiamos estos datos.  Esto probablemente no sea muy efectivo.  Ser√≠a genial evitarlo.  Por lo tanto, tenemos un mecanismo que le permite transferir datos a Web Workers como si estuviera en un paquete. <br><br>  ¬øPor qu√© digo "me gusta"?  Cuando transferimos estos datos a los trabajadores, perdemos el control sobre ellos en la transmisi√≥n principal; no podemos interactuar con ellos de ninguna manera.  Hay una segunda limitaci√≥n aqu√≠.  No podemos transferir todos los tipos de datos a Web Workers.  No podemos hacer esto con una cadena; lo haremos de manera diferente. <br><br><img src="https://habrastorage.org/webt/7s/ai/ml/7saimltvcz1_i2iwgxbfeoyqaxq.jpeg"><br><br>  Miremos el c√≥digo.  En primer lugar, transmitimos los datos de manera un poco diferente.  Aqu√≠ est√° nuestro postMessage.  Ver√°, hay una matriz con loadEvent.target.result.  Dicha interfaz nos permite transferir nuestros datos como objetos transferibles, perdiendo el control sobre ellos. <br><br>  Por cierto, cualquiera que escriba en Rust probablemente escuchar√° algo familiar.  Y leeremos nuestro archivo no como una cadena, sino como un ArrayBuffer.  Esta es una secuencia de datos binarios lidar a los que no hay acceso directo.  Por lo tanto, tendremos que hacer algo m√°s con ellos. <br><br><img src="https://habrastorage.org/webt/5j/o6/t8/5jo6t8mnnnnlquvzvnsnluqs__4.jpeg"><br><br>  De vuelta a nuestros ImageWorkers.  Aqu√≠ se volvi√≥ mucho m√°s interesante.  Primero, tomamos nuestro b√∫fer y hacemos algo tan terrible como Uint8ClampedArray.  Esta es una matriz con tipo.  Como su nombre lo indica, los datos que contiene son los n√∫meros de signos, es decir, n√∫meros del cero al 255 que representar√°n el p√≠xel de nuestra imagen. <br><br>  El tercer argumento, pasamos algo tan extra√±o, como el ancho, multiplicado por la altura, multiplicado por cuatro.  ¬øPor qu√© exactamente cuatro?  Exactamente, RGBA.  Hay tres valores por color y uno por canal alfa. <br><br>  A continuaci√≥n, crearemos ImageData a partir de esta matriz, un tipo de datos especial que se puede dibujar f√°cilmente en el lienzo.  Nada interesante aqu√≠  Simplemente tomamos una matriz y la pasamos al constructor.  Adem√°s, de la misma manera dibujamos nuestra imagen en el lienzo, pero usando un m√©todo diferente, en ImageData.  Adem√°s, todo sigue igual que antes. <br><br>  Pasemos a las conclusiones.  Hoy te cont√© sobre una tarea que no hice hace mucho tiempo.  ¬øQu√© not√© en √©l? <br><br><img src="https://habrastorage.org/webt/0l/ay/mp/0laympqckrdgl8mbdfc7zozrgfa.jpeg"><br><br>  La suavidad de la interfaz es muy importante.  Cuando el usuario se retrasa un poco, se congela un poco, no se presiona el bot√≥n, esto puede conducir a un deterioro severo en UX.  Los navegadores funcionan de manera diferente.  Observamos un ejemplo esf√©rico con Safari y Yandex.Browser.  Vemos que si verific√≥ la suavidad de su interfaz en un navegador, deber√≠a mirar los otros. <br><br>  Debe hacer algo con los scripts de bloqueo si contin√∫an durante mucho tiempo.  En mi caso, lo puse en Web Workers.  Pero probablemente hay otros enfoques, de alguna manera puedes dividirlos en otros m√°s peque√±os, aqu√≠ tienes que pensar.            ,  Web Workers,        . <br><br>   ?        .   .     .    ,      200     ,       . <br><br>     Web Workers  .   ,   ,         . <br><br>    : <br><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">How Browsers Work: Behind the scenes of modern web browsers</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="> WebGL/Three.js   OffscreenCanvas  -</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">OffscreenCanvas ‚Äî Speed up Your Canvas Operations with a Web Worker</a> </li></ul><br>  . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/453626/">https://habr.com/ru/post/453626/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../453612/index.html">F√∫tbol en las nubes: ¬ømoda o necesidad?</a></li>
<li><a href="../453614/index.html">Repositorio local (fuera de l√≠nea) npm</a></li>
<li><a href="../453616/index.html">¬øQu√© tiene de malo la ley federal "sobre firmas electr√≥nicas" (63-FZ) y c√≥mo solucionarla?</a></li>
<li><a href="../453618/index.html">C√≥mo trabajamos con ideas y c√≥mo naci√≥ LANBIX</a></li>
<li><a href="../453622/index.html">Programador de chips G-Shield: escritura de certificados digitales en chips en la etapa de producci√≥n</a></li>
<li><a href="../453628/index.html">¬øQu√© pagar√° en 20 a√±os?</a></li>
<li><a href="../453634/index.html">Alfa Bank School of System Analysis</a></li>
<li><a href="../453642/index.html">Analizador inteligente para un n√∫mero escrito en palabras</a></li>
<li><a href="../453644/index.html">Entrevista: 10 preguntas sobre Swift. Parte 3</a></li>
<li><a href="../453646/index.html">Normalizaci√≥n de datos en una base de datos distribuida, microservicios y ERP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>