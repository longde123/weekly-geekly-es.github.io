<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘©ğŸ¿â€ğŸ¤â€ğŸ‘©ğŸ½ ã€°ï¸ ğŸ’‡ğŸ¾ å†…æ ¸-æ¡¥æ¥æ¡†æ¶ï¼šRing0ä¸­çš„æ¡¥æ¥ ğŸ‘©ğŸ¾â€ğŸ¤â€ğŸ‘¨ğŸ» ğŸ‘©ğŸ¾â€ğŸŒ¾ ğŸ®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æ‚¨æ˜¯å¦æ›¾ç»æƒ³è¿‡çœ‹ä¸€ä¸‹æ“ä½œç³»ç»Ÿçš„å†…å¹•ï¼Œçœ‹ä¸€ä¸‹å…¶æœºåˆ¶çš„å†…éƒ¨ç»“æ„ï¼Œæ‹§ç´§èºé’‰å¹¶çœ‹ä¸€ä¸‹å·²ç»æ‰“å¼€çš„æœºä¼šï¼Ÿ ä¹Ÿè®¸ä»–ä»¬ç”šè‡³æƒ³ç›´æ¥ä½¿ç”¨ç¡¬ä»¶ï¼Œä½†è®¤ä¸ºé©±åŠ¨ç¨‹åºæ˜¯ç«ç®­ç§‘å­¦ï¼Ÿ 

 æˆ‘å»ºè®®æ²¿ç€æ¡¥èµ°åˆ°æ ¸å¿ƒï¼Œçœ‹çœ‹å…”å­æ´æœ‰å¤šæ·±ã€‚ 

 å› æ­¤ï¼Œæˆ‘ä»‹ç»äº†ç”¨C ++ 17ç¼–å†™çš„å†…æ ¸é»‘å®¢é©±åŠ¨ç¨‹åºæ¡†æ¶ï¼Œå¹¶åœ¨å¯èƒ½çš„æƒ…å†µä¸‹è®¾è®¡äº†è¯¥æ¡†æ¶ï¼Œä»¥æ¶ˆé™¤å†…...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å†…æ ¸-æ¡¥æ¥æ¡†æ¶ï¼šRing0ä¸­çš„æ¡¥æ¥</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/429198/"> æ‚¨æ˜¯å¦æ›¾ç»æƒ³è¿‡çœ‹ä¸€ä¸‹æ“ä½œç³»ç»Ÿçš„å†…å¹•ï¼Œçœ‹ä¸€ä¸‹å…¶æœºåˆ¶çš„å†…éƒ¨ç»“æ„ï¼Œæ‹§ç´§èºé’‰å¹¶çœ‹ä¸€ä¸‹å·²ç»æ‰“å¼€çš„æœºä¼šï¼Ÿ ä¹Ÿè®¸ä»–ä»¬ç”šè‡³æƒ³ç›´æ¥ä½¿ç”¨ç¡¬ä»¶ï¼Œä½†è®¤ä¸ºé©±åŠ¨ç¨‹åºæ˜¯ç«ç®­ç§‘å­¦ï¼Ÿ <br><br> æˆ‘å»ºè®®æ²¿ç€æ¡¥èµ°åˆ°æ ¸å¿ƒï¼Œçœ‹çœ‹å…”å­æ´æœ‰å¤šæ·±ã€‚ <br><br> å› æ­¤ï¼Œæˆ‘ä»‹ç»äº†ç”¨C ++ 17ç¼–å†™çš„å†…æ ¸é»‘å®¢é©±åŠ¨ç¨‹åºæ¡†æ¶ï¼Œå¹¶åœ¨å¯èƒ½çš„æƒ…å†µä¸‹è®¾è®¡äº†è¯¥æ¡†æ¶ï¼Œä»¥æ¶ˆé™¤å†…æ ¸å’Œç”¨æˆ·æ¨¡å¼ä¹‹é—´çš„éšœç¢æˆ–å°½å¯èƒ½åœ°æ¶ˆé™¤å®ƒä»¬çš„å­˜åœ¨ã€‚ æ­¤å¤–ï¼Œè¿˜æä¾›äº†ä¸€ç»„ç”¨æˆ·æ¨¡å¼å’Œå†…æ ¸APIå’ŒåŒ…è£…å™¨ï¼Œä»¥ä¾›åˆå­¦è€…å’Œé«˜çº§ç¨‹åºå‘˜åœ¨Ring0ä¸­å¿«é€Ÿä¾¿æ·åœ°è¿›è¡Œå¼€å‘ã€‚ <br><br> ä¸»è¦ç‰¹ç‚¹ï¼š <br><br><ul><li> è®¿é—®I / Oç«¯å£ï¼Œä»¥åŠé€šè¿‡IOPLå°†<i>in</i> ï¼Œ <i>out</i> ï¼Œ <i>cli</i>å’Œ<i>sti</i>æŒ‡ä»¤è½¬å‘åˆ°ç”¨æˆ·æ¨¡å¼ </li><li> ç¯ç»•ç³»ç»Ÿé«˜éŸ³æ‰¬å£°å™¨ </li><li> è®¿é—®<i>MSR</i> ï¼ˆç‰¹å®šäºæ¨¡å‹çš„å¯„å­˜å™¨ï¼‰ </li><li>ä¸€ç»„ç”¨äºè®¿é—®å…¶ä»–è¿›ç¨‹çš„ç”¨æˆ·æ¨¡å¼å†…å­˜å’Œå†…æ ¸å†…å­˜çš„å‡½æ•° </li><li> ä½¿ç”¨ç‰©ç†å†…å­˜ï¼Œ <i>DMI / SMBIOS</i> </li><li> åˆ›å»ºç”¨æˆ·æ¨¡å¼å’Œæ ¸æµé‡ï¼ŒAPCäº¤ä»˜ </li><li> ç”¨æˆ·æ¨¡å¼<i>Ob ***</i>å’Œ<i>Ps ***</i>å›è°ƒä»¥åŠæ–‡ä»¶ç³»ç»Ÿè¿‡æ»¤å™¨ </li><li> ä¸‹è½½æœªç­¾åçš„é©±åŠ¨ç¨‹åºå’Œå†…æ ¸åº“ </li></ul><br>  ...è¿˜æœ‰æ›´å¤šã€‚ <br><a name="habracut"></a><br> æˆ‘ä»¬å°†ä»åŠ è½½æ¡†æ¶å¹¶å°†å…¶è¿æ¥åˆ°æˆ‘ä»¬çš„C ++é¡¹ç›®å¼€å§‹ã€‚ <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><b>Github</b></a> <br><br> å¯¹äºç»„è£…ï¼Œå¼ºçƒˆå»ºè®®ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„Visual Studioå’Œæœ€æ–°å¯ç”¨çš„WDKï¼ˆWindowsé©±åŠ¨ç¨‹åºå·¥å…·åŒ…ï¼‰ï¼Œå¯ä»¥ä»<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Microsoftå®˜æ–¹ç½‘ç«™ä¸Š</a>ä¸‹è½½è¿™äº›æ–‡ä»¶ã€‚ <br><br> å¯¹äºæµ‹è¯•ï¼Œä»»ä½•å®¹é‡çš„å…è´¹VMwareæ’­æ”¾å™¨éƒ½å®‰è£…äº†Windowsï¼Œä½†ä¸ä½äºWindows 7ï¼Œæ˜¯å®Œç¾çš„ã€‚ <br><br> è¯¥ç¨‹åºé›†å¾ˆç®€å•ï¼Œä¸ä¼šå¼•èµ·ä»»ä½•é—®é¢˜ï¼š <br><br><ol><li> æ‰“å¼€<i>å†…æ ¸æ¡¥</i> </li><li> é€‰æ‹©æ‰€éœ€çš„ä½æ·±åº¦ </li><li>  Ctrl + Shift + B </li></ol><br> ç»“æœï¼Œæˆ‘ä»¬è·å¾—äº†é©±åŠ¨ç¨‹åºï¼Œç”¨æˆ·æ¨¡å¼åº“ä»¥åŠç›¸å…³çš„å®ç”¨ç¨‹åºæ–‡ä»¶ï¼ˆç”¨äºæ‰‹åŠ¨å®‰è£…çš„<i>* .inf</i> ï¼Œç”¨äºåœ¨Microsoft Hardware Certification Publisherä¸Šå¯¹é©±åŠ¨ç¨‹åºè¿›è¡Œç­¾åçš„<i>* .cab</i>ç­‰ï¼‰ã€‚ <br><br> è¦å®‰è£…é©±åŠ¨ç¨‹åºï¼ˆå¦‚æœx64ä¸éœ€è¦æ•°å­—ç­¾å-ç›¸åº”çš„EVè¯ä¹¦ï¼‰ï¼Œåˆ™éœ€è¦å°†ç³»ç»Ÿç½®äºæµ‹è¯•æ¨¡å¼ï¼Œè€Œå¿½ç•¥é©±åŠ¨ç¨‹åºçš„æ•°å­—ç­¾åã€‚ ä¸ºæ­¤ï¼Œä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œå‘½ä»¤è¡Œï¼š <br><br> <code>bcdedit.exe /set loadoptions DISABLE_INTEGRITY_CHECKS <br> bcdedit.exe /set TESTSIGNING ON <br></code> <br>  ...ç„¶åé‡æ–°å¯åŠ¨è®¡ç®—æœºã€‚ å¦‚æœä¸€åˆ‡æ“ä½œæ­£ç¡®ï¼ŒWindowså¤„äºæµ‹è¯•æ¨¡å¼çš„å³ä¸‹è§’å°†å‡ºç°ä¸€ä¸ªé¢˜è¯ã€‚ <br><br> å®Œæˆæµ‹è¯•ç¯å¢ƒçš„è®¾ç½®ï¼Œè®©æˆ‘ä»¬å¼€å§‹åœ¨é¡¹ç›®ä¸­ä½¿ç”¨APIâ€‹â€‹ã€‚ <br><br> è¯¥æ¡†æ¶å…·æœ‰ä»¥ä¸‹å±‚æ¬¡ç»“æ„ï¼š <br><br>  <i>/ Kernel-Bridge / API-</i>ä¸€ç»„ç”¨äºé©±åŠ¨ç¨‹åºå’Œ<i>å†…æ ¸</i>æ¨¡å—çš„å‡½æ•°ï¼Œæ²¡æœ‰å¤–éƒ¨ä¾èµ–æ€§ï¼Œå¯ä»¥åœ¨ç¬¬ä¸‰æ–¹é¡¹ç›®ä¸­è‡ªç”±ä½¿ç”¨ <br>  <i>/ User-Bridge / API-</i>é©±åŠ¨ç¨‹åºå’Œå®ç”¨ç¨‹åºåŠŸèƒ½ä¸Šçš„ä¸€ç»„ç”¨æˆ·æ¨¡å¼åŒ…è£…å™¨ï¼Œç”¨äºå¤„ç†PEæ–‡ä»¶ï¼ŒPDBå­—ç¬¦ç­‰ã€‚ <br>  <i>/ SharedTypes /</i> -ç”¨æˆ·æ¨¡å¼å’Œæ ¸å¤´å‡åŒ…å«å¿…è¦çš„é€šç”¨ç±»å‹ <br><br> é©±åŠ¨ç¨‹åºå¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼åŠ è½½ï¼šä½œä¸ºå¸¸è§„é©±åŠ¨ç¨‹åºå’Œä½œä¸ºå¾®å‹è¿‡æ»¤å™¨ã€‚ é¦–é€‰ç¬¬äºŒç§æ–¹æ³•ï¼Œå› ä¸º å…è®¸è®¿é—®ç³»ç»Ÿäº‹ä»¶çš„ç­›é€‰å™¨å’Œç”¨æˆ·æ¨¡å¼å›è°ƒçš„é«˜çº§åŠŸèƒ½ã€‚ <br><br> å› æ­¤ï¼Œåœ¨C ++ä¸­åˆ›å»ºä¸€ä¸ªæ§åˆ¶å°é¡¹ç›®ï¼Œè¿æ¥å¿…è¦çš„å¤´æ–‡ä»¶å¹¶åŠ è½½é©±åŠ¨ç¨‹åºï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Windows.h&gt; #include "WdkTypes.h" //    x32/x64    WDK #include "CtlTypes.h" //   IOCTL-   #include "User-Bridge.h" // API,   int main() { using namespace KbLoader; BOOL Status = KbLoadAsFilter( L"X:\\Folder\\Path\\To\\Kernel-Bridge.sys", L"260000" //       ); if (!Status) return 0; //   ! //     API ... // : KbUnload(); return 0; }</span></span></span></span></code> </pre><br> å¤ªå¥½äº†ï¼ ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨APIâ€‹â€‹å¹¶ä¸å†…æ ¸è¿›è¡Œäº¤äº’ã€‚ <br> è®©æˆ‘ä»¬ä»ä½œå¼Šå¼€å‘äººå‘˜ç¯å¢ƒä¸­æœ€æµè¡Œçš„åŠŸèƒ½å¼€å§‹-è¯»å†™å¦ä¸€ä¸ªè¿›ç¨‹çš„å†…å­˜ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> Processes::MemoryManagement; <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Size = <span class="hljs-number"><span class="hljs-number">64</span></span>; BYTE Buffer[Size] = {}; BOOL Status = KbReadProcessMemory( <span class="hljs-comment"><span class="hljs-comment">//  KbWriteProcessMemory,   ProcessId, 0x7FFF0000, //     ProcessId &amp;Buffer, Size );</span></span></code> </pre><br> æ²¡ä»€ä¹ˆå¤æ‚çš„ï¼ è®©æˆ‘ä»¬ä¸‹ä¸€ä¸ªå±‚æ¬¡-è¯»å†™æ ¸å­˜å‚¨å™¨ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> VirtualMemory; <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Size = <span class="hljs-number"><span class="hljs-number">64</span></span>; BYTE Buffer[Size]; <span class="hljs-comment"><span class="hljs-comment">//  "",  ""    , //       : BOOL Status = KbCopyMoveMemory( reinterpret_cast&lt;WdkTypes::PVOID&gt;(Buffer), //  0xFFFFF80000C00000, //  Size, FALSE //  ,     );</span></span></code> </pre><br> ä¸é“ç›¸äº’ä½œç”¨çš„åŠŸèƒ½å¦‚ä½•ï¼Ÿ ä¾‹å¦‚ï¼ŒI / Oç«¯å£ã€‚ <br><br> æˆ‘ä»¬é€šè¿‡åœ¨EFlagså¯„å­˜å™¨ä¸­é”å®š2ä¸ªIOPLä½å°†å®ƒä»¬è½¬å‘åˆ°ç”¨æˆ·æ¨¡å¼ï¼Œè¿™äº›ä½è´Ÿè´£<i>in</i> / <i>out</i> / <i>cli</i> / <i>sti</i>æŒ‡ä»¤å¯ç”¨çš„ç‰¹æƒçº§åˆ«ã€‚ <br><br> å› æ­¤ï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿåœ¨ç”¨æˆ·æ¨¡å¼ä¸‹æ‰§è¡Œå®ƒä»¬è€Œä¸ä¼šå‡ºç°â€œç‰¹æƒæŒ‡ä»¤â€é”™è¯¯ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;intrin.h&gt; using namespace IO::Iopl; //  ,   ! KbRaiseIopl(); //  in/out/cli/sti   ! ULONG Frequency = 1000; // 1 kHz ULONG Divider = 1193182 / Frequency; __outbyte(0x43, 0xB6); //     //      : __outbyte(0x42, static_cast&lt;unsigned char&gt;(Divider)); __outbyte(0x42, static_cast&lt;unsigned char&gt;(Divider &gt;&gt; 8)); __outbyte(0x61, __inbyte(0x61) | 3); //   (   ) for (int i = 0; i &lt; 5000; i++); //   Sleep(),  IOPL      ! __outbyte(0x61, __inbyte(0x61) &amp; 252); //   KbResetIopl();</span></span></span></span></code> </pre><br> ä½†æ˜¯çœŸæ­£çš„è‡ªç”±å‘¢ï¼Ÿ æ¯•ç«Ÿï¼Œäººä»¬ç»å¸¸æƒ³ç”¨å†…æ ¸ç‰¹æƒæ‰§è¡Œä»»æ„ä»£ç ã€‚ æˆ‘ä»¬åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹ç¼–å†™æ‰€æœ‰å†…æ ¸ä»£ç ï¼Œç„¶åä»å†…æ ¸è½¬ç§»æ§åˆ¶æƒï¼ˆSMEPè‡ªåŠ¨å…³é—­ï¼Œåœ¨è°ƒç”¨é©±åŠ¨ç¨‹åºä¹‹å‰ä¿å­˜FPUä¸Šä¸‹æ–‡ï¼Œå¹¶ä¸”è°ƒç”¨æœ¬èº«åœ¨<i>try..except</i>å—å†…è¿›è¡Œï¼‰ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> KernelShells; <span class="hljs-comment"><span class="hljs-comment">//    KeStallExecutionProcessor: ULONG Result = 1337; KbExecuteShellCode( []( _GetKernelProcAddress GetKernelProcAddress, PVOID Argument ) -&gt; ULONG { //      Ring0 //     : using _KeStallExecutionProcessor = VOID(WINAPI*)(ULONG Microseconds); auto Stall = reinterpret_cast&lt;_KeStallExecutionProcessor&gt;( GetKernelProcAddress(L"KeStallExecutionProcessor") ); Stall(1000 * 1000); //      ULONG Value = *static_cast&lt;PULONG&gt;(Argument); return Value == 1337 ? 0x1EE7C0DE : 0; }, &amp;Result, // Argument &amp;Result // Result ); //   Result = 0x1EE7C0DE</span></span></code> </pre><br> ä½†æ˜¯ï¼Œé™¤äº†çºµå®¹å¤–å£³ç¨‹åºå¤–ï¼Œè¿˜æœ‰ä¸€é¡¹ä¸¥è‚ƒçš„åŠŸèƒ½ï¼Œå¯è®©æ‚¨åŸºäºæ–‡ä»¶ï¼Œå¯¹è±¡å’Œè¿›ç¨‹è¿‡æ»¤å™¨çš„å­ç³»ç»Ÿåˆ›å»ºç®€å•çš„DLPã€‚ <br><br> è¯¥æ¡†æ¶å…è®¸è¿‡æ»¤<i>CreateFile</i> / <i>ReadFile</i> / <i>WriteFile</i> / <i>DeviceIoControl</i> ï¼Œä»¥åŠæ‰“å¼€/å¤åˆ¶å¥æŸ„çš„äº‹ä»¶ï¼ˆ <i>ObRegisterCallbacks</i> ï¼‰ä»¥åŠå¯åŠ¨è¿›ç¨‹/çº¿ç¨‹å’Œæ¨¡å—åŠ è½½çš„äº‹ä»¶ï¼ˆ <i>PsSet *** NotifyRoutine</i> ï¼‰ã€‚ ä¾‹å¦‚ï¼Œè¿™å°†å…è®¸é˜»æ­¢è®¿é—®ä»»æ„æ–‡ä»¶æˆ–æ›¿æ¢æœ‰å…³ç¡¬ç›˜åºåˆ—å·çš„ä¿¡æ¯ã€‚ <br><br> å·¥ä½œåŸç†ï¼š <br><br><ol><li> é©±åŠ¨ç¨‹åºæ³¨å†Œæ–‡ä»¶è¿‡æ»¤å™¨å¹¶å®‰è£…<i>Ob ***</i> / <i>Ps ***</i>å›è°ƒ </li><li> é©±åŠ¨ç¨‹åºæ‰“å¼€ä¸€ä¸ª<i>é€šè®¯</i>ç«¯å£ï¼Œå¸Œæœ›è®¢é˜…äº‹ä»¶çš„å®¢æˆ·ç«¯å¯ä»¥è¿æ¥åˆ°è¯¥ç«¯å£ </li><li> ç”¨æˆ·æ¨¡å¼åº”ç”¨ç¨‹åºè¿æ¥åˆ°ç«¯å£ï¼Œå¹¶ä»é©±åŠ¨ç¨‹åºæ¥æ”¶æœ‰å…³å‘ç”Ÿçš„äº‹ä»¶çš„æ•°æ®ï¼Œæ‰§è¡Œè¿‡æ»¤ï¼ˆæˆªæ–­æƒé™ä¸­çš„å¥æŸ„ï¼Œé˜»æ­¢å¯¹æ–‡ä»¶çš„è®¿é—®ç­‰ï¼‰ï¼Œç„¶åå°†äº‹ä»¶è¿”å›å†…æ ¸ </li><li> é©±åŠ¨ç¨‹åºå°†åº”ç”¨æ”¶åˆ°çš„æ›´æ”¹ã€‚ </li></ol><br> è®¢é˜…<i>ObRegisterCallbacks</i>å¹¶å‡å°‘å¯¹å½“å‰è¿›ç¨‹çš„è®¿é—®çš„ç¤ºä¾‹ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Windows.h&gt; #include &lt;fltUser.h&gt; #include "CommPort.h" #include "WdkTypes.h" #include "FltTypes.h" #include "Flt-Bridge.h" ... //   ObRegisterCallbacks: CommPortListener&lt;KB_FLT_OB_CALLBACK_INFO, KbObCallbacks&gt; ObCallbacks; //        PROCESS_VM_READ: Status = ObCallbacks.Subscribe([]( CommPort&amp; Port, MessagePacket&lt;KB_FLT_OB_CALLBACK_INFO&gt;&amp; Message ) -&gt; VOID { auto Data = static_cast&lt;PKB_FLT_OB_CALLBACK_INFO&gt;(Message.GetData()); if (Data-&gt;Target.ProcessId == GetCurrentProcessId()) { Data-&gt;CreateResultAccess &amp;= ~PROCESS_VM_READ; Data-&gt;DuplicateResultAccess &amp;= ~PROCESS_VM_READ; } ReplyPacket&lt;KB_FLT_OB_CALLBACK_INFO&gt; Reply(Message, ERROR_SUCCESS, *Data); Port.Reply(Reply); //   });</span></span></span></span></code> </pre><br> å› æ­¤ï¼Œæˆ‘ä»¬ç®€è¦ä»‹ç»äº†è¯¥æ¡†æ¶çš„ç”¨æˆ·æ¨¡å¼éƒ¨åˆ†çš„è¦ç‚¹ï¼Œä½†æ ¸å¿ƒAPIä»ç„¶å¤„äºå¹•åã€‚ <br><br> æ‰€æœ‰APIå’ŒåŒ…è£…å™¨éƒ½ä½äºç›¸åº”çš„æ–‡ä»¶å¤¹ä¸­ï¼š <i>/ Kernel-Bridge / API /</i> <br> å®ƒä»¬åŒ…æ‹¬ä½¿ç”¨å†…å­˜ï¼Œä½¿ç”¨è¿›ç¨‹ï¼Œä½¿ç”¨å­—ç¬¦ä¸²å’Œé”ä»¥åŠæ›´å¤šå†…å®¹ï¼Œä»è€Œå¤§å¤§ç®€åŒ–äº†è‡ªå·±çš„é©±åŠ¨ç¨‹åºçš„å¼€å‘ã€‚  APIå’ŒåŒ…è£…å™¨ä»…ä¾èµ–äºå®ƒä»¬è‡ªå·±ï¼Œè€Œä¸ä¾èµ–äºå¤–éƒ¨ç¯å¢ƒï¼šæ‚¨å¯ä»¥åœ¨è‡ªå·±çš„é©±åŠ¨ç¨‹åºä¸­è‡ªç”±ä½¿ç”¨å®ƒä»¬ã€‚ <br><br> åœ¨å†…æ ¸ä¸­ä½¿ç”¨å­—ç¬¦ä¸²çš„ä¸€ä¸ªç¤ºä¾‹æ˜¯æ‰€æœ‰åˆå­¦è€…çš„ç»Šè„šçŸ³ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;wdm.h&gt; #include &lt;ntstrsafe.h&gt; #include &lt;stdarg.h&gt; #include "StringsAPI.h" WideString wString = L"Some string"; AnsiString aString = wString.GetAnsi().GetLowerCase() + " and another string!"; if (aString.Matches("*another*")) DbgPrint("%s\r\n", aString.GetData());</span></span></span></span></code> </pre><br> å¦‚æœè¦ä¸ºè‡ªå·±çš„IOCTLä»£ç å®ç°è‡ªå·±çš„å¤„ç†ç¨‹åºï¼Œåˆ™å¯ä»¥æ ¹æ®ä»¥ä¸‹æ–¹æ¡ˆå¾ˆå®¹æ˜“åœ°åšåˆ°è¿™ä¸€ç‚¹ï¼š <br><br><ol><li> åœ¨<i>/Kernel-Bridge/Kernel-Bridge/IOCTLHandlers.cppä¸­</i>ç¼–å†™å¤„ç†ç¨‹åº </li><li> åœ¨åŒä¸€æ–‡ä»¶ä¸­ï¼Œå‘<i>DispatchIOCTL</i>å‡½æ•°ä¸­<i>Handlers</i>æ•°ç»„çš„æœ«å°¾æ·»åŠ ä¸€ä¸ªå¤„ç†<i>ç¨‹åº</i> ã€‚ </li><li> å°†æŸ¥è¯¢ç´¢å¼•æ·»åŠ åˆ°SAME POSITIONä¸­<i>CtlTypes.h</i>ä¸­çš„<i>Ctls :: KbCtlIndicesæšä¸¾</i>ä¸­ï¼Œå¦‚é¡¹ç›®2ä¸­çš„<i>Handlers</i>æ•°ç»„ä¸­æ‰€ç¤º </li><li> é€šè¿‡åœ¨<i>User-Bridge.cppä¸­</i>ç¼–å†™åŒ…è£…å™¨ï¼Œä»ç”¨æˆ·æ¨¡å¼è°ƒç”¨å¤„ç†ç¨‹åºï¼Œå¹¶ä½¿ç”¨<i>KbSendRequest</i>å‡½æ•°è¿›è¡Œè°ƒç”¨ </li></ol><br> æ”¯æŒæ‰€æœ‰ä¸‰ç§ç±»å‹çš„I / Oï¼ˆMETHOD_BUFFEREDï¼ŒMETHOD_NEITHERå’ŒMETHOD_IN_DIRECT / METHOD_OUT_DIRECTï¼‰ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨METHOD_NEITHERã€‚ <br><br> ä»…æ­¤è€Œå·²ï¼ æœ¬æ–‡ä»…æ¶µç›–æ‰€æœ‰å¯èƒ½æ€§çš„ä¸€å°éƒ¨åˆ†ã€‚ æˆ‘å¸Œæœ›è¯¥æ¡†æ¶å¯¹å†…æ ¸ç»„ä»¶çš„æ–°æ‰‹ï¼Œé€†å‘å·¥ç¨‹å¸ˆï¼Œä½œå¼Šï¼Œåä½œå¼Šå’Œé˜²æŠ¤çš„å¼€å‘äººå‘˜æœ‰ç”¨ã€‚ <br><br> å¹¶ä¸”ï¼Œæ¯ä¸ªäººéƒ½åº”é‚€å‚ä¸å¼€å‘ã€‚ åœ¨æœªæ¥çš„è®¡åˆ’ä¸­ï¼š <br><br><ul><li> ç”¨äºç›´æ¥å¤„ç†PTEè®°å½•å¹¶å°†æ ¸å†…å­˜è½¬å‘åˆ°ç”¨æˆ·æ¨¡å¼çš„åŒ…è£…å™¨ </li><li> åŸºäºç°æœ‰APCæµç¨‹åˆ›å»ºå’Œä¼ é€’åŠŸèƒ½çš„æ³¨å…¥å™¨ </li><li> ç”¨äºå®æ—¶é€†å‘å·¥ç¨‹å’ŒWindowså†…æ ¸ç ”ç©¶çš„GUIå¹³å° </li><li> ç”¨äºæ‰§è¡Œéƒ¨åˆ†å†…æ ¸ä»£ç çš„è„šæœ¬å¼•æ“ </li><li> åœ¨åŠ¨æ€åŠ è½½çš„æ¨¡å—ä¸­æ”¯æŒSEH </li><li> é€šè¿‡HLKæµ‹è¯• </li></ul><br> æ„Ÿè°¢æ‚¨çš„å…³æ³¨ï¼ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN429198/">https://habr.com/ru/post/zh-CN429198/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN429188/index.html">PICASO 3D Designer XLæ¦‚è¿°</a></li>
<li><a href="../zh-CN429190/index.html">åˆ¶ä½œè‡ªå·±çš„ç”µå­æ¤å…¥ç‰©</a></li>
<li><a href="../zh-CN429192/index.html">è¿™äº›æ–°æŠ€å·§ä»ç„¶èƒ½å¤Ÿèƒœè¿‡Deepfakeè§†é¢‘ã€‚</a></li>
<li><a href="../zh-CN429194/index.html">7ä¸ªKotlinä¸Šç”¨äºAndroidå¼€å‘çš„åº“</a></li>
<li><a href="../zh-CN429196/index.html">å¸¦æœ‰Objectionçš„iOSè¿è¡Œæ—¶ç§»åŠ¨æµè§ˆï¼Œæˆ–ç ´è§£æˆ‘ä»¬è‡ªå·±çš„åº”ç”¨ç¨‹åº</a></li>
<li><a href="../zh-CN429202/index.html">æ˜‚è´µçš„è¯¾ç¨‹ï¼šå€¼å¾—å—ï¼Ÿ</a></li>
<li><a href="../zh-CN429204/index.html">æœ‰å…³æ¸¸æˆå¼€å‘çš„æœ€é‡è¦è¯¯è§£</a></li>
<li><a href="../zh-CN429210/index.html">ä¸¥å³»çš„ç°å®ï¼šæ‚¨çš„åˆ©ç›Šç›¸å…³è€…ä¸å¸Œæœ›è¿›è¡Œä¸šåŠ¡åˆ†æ</a></li>
<li><a href="../zh-CN429212/index.html">Microsoftå·²ç»ç¡®è®¤Windows 10æ¿€æ´»å­˜åœ¨ï¼ˆå¤§é‡ï¼‰é—®é¢˜</a></li>
<li><a href="../zh-CN429214/index.html">Laravelä¸­çš„ä¸­é—´ä»¶å’Œç®¡é“åŠŸèƒ½</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>