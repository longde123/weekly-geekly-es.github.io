<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏽‍🎤 🚼 🦖 如何在iOS中检查介绍性产品的可用性 🤚🏾 👩🏽‍🤝‍👨🏾 ✔️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="如果在订阅应用程序中使用介绍性优惠（试用，使用时付款或预付款），那么在付款屏幕上显示价格之前，您需要确定介绍性优惠对用户的可用性。 如果用户已经草拟了试用版，那么您必须显示其全价。 





大家好，我与Apphud的 Renat 联系 ，该服务简化了iOS应用程序中的订阅工作。 今天，我将告诉您...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>如何在iOS中检查介绍性产品的可用性</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/apphud/blog/471492/"><p> 如果在订阅应用程序中使用介绍性优惠（试用，使用时付款或预付款），那么在付款屏幕上显示价格之前，您需要确定介绍性优惠对用户的可用性。 如果用户已经草拟了试用版，那么您必须显示其全价。 </p><br><p><img src="https://habrastorage.org/webt/if/dt/bv/ifdtbvunalbndzwrl1uesyv9-9m.png" alt="图片"></p><br><p>大家好，我与<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Apphud的</a> Renat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">联系</a> ，该服务简化了iOS应用程序中的订阅工作。 今天，我将告诉您如何确定单个用户是否有权激活介绍性句子。 <a name="habracut"></a></p><br><p> 促销优惠在同一订阅组中有效。 这意味着用户可以在不进行试用的情况下发布常规的每周订阅，可以取消订阅，之后再发布对每月订阅的试用。 </p><br><p>  Apple文档中有一个图表，显示用户何时可以使用介绍性句子： </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/370/0fb/494/3700fb494140a08886656f52e6c8f493.png"></p><br><p> 事实证明，在以下情况下，用户可以使用介绍性句子： </p><br><ul><li> 他以前没有用过开场白 </li></ul><br><p>  <strong>和</strong> </p><br><ul><li> 订阅尚未发出或已过期 </li></ul><br><p> 要检查介绍性句子的可用性，您需要执行3个步骤： </p><br><p>  1）验证App Store-检查并拉出交易数组。 如果没有交易，那么我们不检查任何内容，可以使用介绍性句子。 如果存在事务，请执行以下两个步骤。 </p><br><p>  2）检查介绍性句子是否曾经被使用过 </p><br><p>  3）检查当前订阅状态 </p><br><p> 让我们更详细地考虑这些步骤。 </p><br><h3 id="1-validaciya-app-store-cheka">  1.验证App Store支票 </h3><br><p>要验证支票，您需要向Apple发送一个请求，并传递<code>receiptData</code>和<code>sharedSecret</code> 。 用您自己的值替换<code>sharedSecret</code>值。 如果您不知道<code>sharedSecret</code> ，则<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在此处</a>说明如何获取它。 </p><br><pre> <code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isEligibleForIntroductory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(callback: @escaping </span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(Bool)</span></span></span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Void</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">guard</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> receiptUrl = <span class="hljs-type"><span class="hljs-type">Bundle</span></span>.main.appStoreReceiptURL <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { callback(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-type"><span class="hljs-type">DEBUG</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> urlString = <span class="hljs-string"><span class="hljs-string">"https://sandbox.itunes.apple.com/verifyReceipt"</span></span> #<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> urlString = <span class="hljs-string"><span class="hljs-string">"https://buy.itunes.apple.com/verifyReceipt"</span></span> #endif <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> receiptData = <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>? <span class="hljs-type"><span class="hljs-type">Data</span></span>(contentsOf: receiptUrl).base64EncodedString() <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> sharedSecret = <span class="hljs-string"><span class="hljs-string">"YOUR_SHARED_SECRET"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> requestData = [<span class="hljs-string"><span class="hljs-string">"receipt-data"</span></span> : receiptData ?? <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span> : sharedSecret, <span class="hljs-string"><span class="hljs-string">"exclude-old-transactions"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-type"><span class="hljs-type">String</span></span> : <span class="hljs-type"><span class="hljs-type">Any</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = <span class="hljs-type"><span class="hljs-type">URLRequest</span></span>(url: <span class="hljs-type"><span class="hljs-type">URL</span></span>(string: urlString)!) request.httpMethod = <span class="hljs-string"><span class="hljs-string">"POST"</span></span> request.setValue(<span class="hljs-string"><span class="hljs-string">"Application/json"</span></span>, forHTTPHeaderField: <span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> httpBody = <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>? <span class="hljs-type"><span class="hljs-type">JSONSerialization</span></span>.data(withJSONObject: requestData, options: []) request.httpBody = httpBody <span class="hljs-type"><span class="hljs-type">URLSession</span></span>.shared.dataTask(with: request) { (data, response, error) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-comment"><span class="hljs-comment">// continue here }.resume() }</span></span></code> </pre> <br><blockquote> 上面的示例使用<code>#if DEBUG</code>宏来确定订阅类型： <code>sandbox</code>或<code>production</code> 。 如果使用其他宏，则需要在此位置更新代码。 </blockquote><br><h3 id="2-proverka-ispolzovalos-li-vvodnoe-predlozhenie-ranee">  2.检查之前是否使用过介绍性句子 </h3><br><p> 收到Apple的回应后，我们将其翻译成<code>Dictionary</code>并获得了一系列交易： </p><br><pre> <code class="swift hljs"><span class="hljs-comment"><span class="hljs-comment">// paste this code after "continue here" comment guard let data = data, let json = try? JSONSerialization.jsonObject(with: data, options: .allowFragments) as? [String : AnyHashable], let receipts_array = json["latest_receipt_info"] as? [[String : AnyHashable]] else { callback(true) return } // continue here</span></span></code> </pre> <br><p> 我们遍历事务数组，并查看<code>is_trial_period</code>和<code>is_in_intro_offer_period</code>的值。 如果值之一为<code>true</code> ，则用户已经草拟了一个介绍性句子。 这些值以字符串形式出现，因此出于可靠性考虑，我们将尝试同时转换Bool和string中的值。 </p><br><pre> <code class="swift hljs"><span class="hljs-comment"><span class="hljs-comment">// paste this code after "continue here" comment var latestExpiresDate = Date(timeIntervalSince1970: 0) let formatter = DateFormatter() for receipt in receipts_array { let used_trial : Bool = receipt["is_trial_period"] as? Bool ?? false || (receipt["is_trial_period"] as? NSString)?.boolValue ?? false let used_intro : Bool = receipt["is_in_intro_offer_period"] as? Bool ?? false || (receipt["is_in_intro_offer_period"] as? NSString)?.boolValue ?? false if used_trial || used_intro { callback(false) return } // continue here</span></span></code> </pre> <br><h3 id="3-proverka-tekuschego-statusa-podpiski">  3.检查订阅的当前状态 </h3><br><p> 要了解订阅的当前状态，我们需要找到最新的<code>expires_date</code>并与当前日期进行比较。 如果订阅尚未过期，则该促销优惠不可用： </p><br><pre> <code class="swift hljs"><span class="hljs-comment"><span class="hljs-comment">// paste this code after "continue here" comment formatter.dateFormat = "yyyy-MM-dd HH:mm:ss VV" if let expiresDateString = receipt["expires_date"] as? String, let date = formatter.date(from: expiresDateString) { if date &gt; latestExpiresDate { latestExpiresDate = date } } } if latestExpiresDate &gt; Date() { callback(false) } else { callback(true) }</span></span></code> </pre> <br><p> 您可以在文章末尾找到该方法的完整代码的链接，但是，此方法中有很多“ But”。 </p><br><h2 id="podvodnye-kamni"> 陷阱 </h2><br><ul><li><p> 在此示例中，我们仅查看一个订阅组的情况。 如果在一个应用程序中使用多个订阅组，则必须将订阅组标识符传递给此方法，并通过<code>subscription_group_identifier</code>中的<code>subscription_group_identifier</code>的值进行验证。 </p><br></li><li><p> 在此示例中，不考虑订阅退款的情况。 为此，请检查<code>cancellation_date</code>字段是否存在： </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> receipt[<span class="hljs-string"><span class="hljs-string">"cancellation_date"</span></span>] != <span class="hljs-literal"><span class="hljs-literal">nil</span></span>{ <span class="hljs-comment"><span class="hljs-comment">// if user made a refund, no need to check for eligibility callback(false) return }</span></span></code> </pre> <br></li><li><p> 在此不考虑宽限期（计费宽限期）。 如果用户在检查通过时处于宽限期，则<code>pending_renewal_info</code>将具有<code>grace_period_expires_date</code>字段。 在这种情况下，您作为开发人员必须在不显示付款屏幕的情况下向用户提供高级功能。 因此，检查介绍性句子的可用性是没有意义的。 </p><br></li><li><p> 检查到期日期存在问题。 可以拧松iOS设备上的系统时间，然后我们的代码将给出错误的结果：订阅将被视为活动状态。 </p><br></li><li><p> 苹果不建议对设备本身进行检查验证。 他们<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在WWDC</a> （从5:50开始）多次谈论了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">这一点，</a>并且在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">文档中</a>对此进行了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">说明</a> 。 这是不安全的，因为攻击者可以使用中间人攻击来拦截数据。  Apple建议使用您的服务器来验证检查。 </p><br></li></ul><br><h2 id="proverka-dostupnosti-promo-predlozheniya"> 查看促销优惠的可用性 </h2><br><p> 提供促销优惠的条件比较简单-主要是用户具有有效或过期的订阅。 为此，请为您的订阅组查找<code>pending_renewal_info</code> 。 </p><br><h2 id="kak-eto-realizovano-v-apphud-sdk"> 如何在Apphud SDK中实现 </h2><br><p> 调用一个方法，将您的<code>product</code>传递给其中，这将足以将结果返回给您： </p><br><pre> <code class="swift hljs"><span class="hljs-type"><span class="hljs-type">Apphud</span></span>.checkEligibilityForIntroductoryOffer(product: myProduct) { result <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> result { <span class="hljs-comment"><span class="hljs-comment">// User is eligible to purchase introductory offer } }</span></span></code> </pre> <br><p> 以及类似的促销优惠： </p><br><pre> <code class="swift hljs"><span class="hljs-type"><span class="hljs-type">Apphud</span></span>.checkEligibilityForPromotionalOffer(product: myProduct) { result <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> result { <span class="hljs-comment"><span class="hljs-comment">// User is eligible to purchase promotional offer } }</span></span></code> </pre> <br><p> 还有一种可以一次检查多个产品可用性的方法： </p><br><pre> <code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkEligibilitiesForIntroductoryOffers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(products: [SKProduct], callback: ApphudEligibilityCallback)</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkEligibilitiesForPromotionalOffers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(products: [SKProduct], callback: ApphudEligibilityCallback)</span></span></span></span></code> </pre> <br><h2 id="zaklyuchenie"> 结论 </h2><br><p> 完整的方法代码可在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此处</a>下载。 </p><br><blockquote>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Apphud的</a>我们已经在便利的开源SDK中对导入和促销优惠的可用性进行了检查。  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Apphud还</a>可以帮助您跟踪订阅状态，分析关键指标，自动为未订阅的用户提供折扣等等。 如果您在使用订阅时遇到麻烦，请免费试用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">我们的解决方案</a> 。 </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN471492/">https://habr.com/ru/post/zh-CN471492/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN471472/index.html">安全周42：硬件后门，英特尔NUC中的漏洞</a></li>
<li><a href="../zh-CN471474/index.html">生活黑客-免费在云端编写和托管带有访客留言簿的网站</a></li>
<li><a href="../zh-CN471480/index.html">如何建立有效的产品团队？</a></li>
<li><a href="../zh-CN471482/index.html">CLRium＃6：并发与并行。 两天：从处理器到异步/等待</a></li>
<li><a href="../zh-CN471484/index.html">足球转移的模式：深入研究</a></li>
<li><a href="../zh-CN471496/index.html">关于App Store订阅模式的一点点</a></li>
<li><a href="../zh-CN471498/index.html">道路固定摄像机的地图公开了：是欢喜还是哭泣？</a></li>
<li><a href="../zh-CN471500/index.html">回拨或“提高客户忠诚度”</a></li>
<li><a href="../zh-CN471502/index.html">创意农场</a></li>
<li><a href="../zh-CN471504/index.html">二维二重奏：创建硼芬-石墨烯异质结构</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>