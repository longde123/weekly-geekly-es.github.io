<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ– ğŸ¦ ğŸ¯ Data Lake yang berorientasi pelanggan di perusahaan game ğŸ™†ğŸ¾ ğŸ§€ ğŸ§‘ğŸ¾â€ğŸ¤â€ğŸ§‘ğŸ½</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sumber 

 Halo, Habr! Nama saya Maxim Pchelin, dan saya memimpin pengembangan BI-DWH di MyGames (divisi permainan dari Mail.ru Group). Pada artikel in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Data Lake yang berorientasi pelanggan di perusahaan game</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/479900/"><img src="https://habrastorage.org/webt/ic/em/yw/icemywxszsrmzmrife7stz9ltpg.jpeg"><br>  <a href="https://www.filthymonkeymen.com/2016/06/16/neanderthal-hunting-strategy/">Sumber</a> <br><br>  Halo, Habr!  Nama saya Maxim Pchelin, dan saya memimpin pengembangan BI-DWH di MyGames (divisi permainan dari Mail.ru Group).  Pada artikel ini saya akan berbicara tentang bagaimana dan mengapa kami membangun penyimpanan DataLake yang berorientasi klien. <br><br>  Artikel ini terdiri dari tiga bagian.  Pertama, saya akan menjelaskan mengapa kami memutuskan untuk mengimplementasikan DataLake.  Pada bagian kedua saya akan menjelaskan teknologi dan solusi apa yang kami gunakan sehingga penyimpanan dapat bekerja dan diisi dengan data.  Dan pada bagian ketiga saya akan menjelaskan apa yang kami lakukan untuk meningkatkan kualitas layanan kami. <br><a name="habracut"></a><br><h1>  Apa yang membawa kami ke DataLake </h1><br>  Kami di <a href="https://my.games/">MyGames</a> bekerja di departemen BI-DWH dan membuat layanan dari dua kategori: repositori untuk analis data dan layanan pelaporan reguler untuk pengguna bisnis (manajer, pemasar, pengembang game, dan lainnya). <br><br><h3>  Mengapa penyimpanan non-standar seperti itu? </h3><br>  Biasanya, BI-DWH tidak menyiratkan implementasi penyimpanan DataLake, ini tidak bisa disebut solusi khas.  Dan bagaimana layanan seperti itu dibangun? <br><br>  Biasanya perusahaan memiliki proyek - dalam kasus kami, ini adalah permainan.  Proyek ini memiliki sistem logging yang paling sering menulis data ke database.  Di atas dasar ini, etalase dibuat untuk agregat, metrik, dan entitas lain untuk analitik mendatang.  Pelaporan rutin dibuat berdasarkan etalase menggunakan alat BI yang cocok, serta sistem analitik Ad-Hoc, dimulai dengan pertanyaan SQL sederhana dan tabel Excel, dan berakhir dengan Jupyter Notebook untuk DS dan ML.  Seluruh sistem didukung oleh satu tim pengembangan. <br><br>  Misalkan perusahaan lain lahir di sebuah perusahaan.  Memiliki tim pengembangan dan infrastruktur lain di bawahnya menarik, tetapi mahal.  Jadi, proyek ini perlu "dihubungkan".  Ini dapat dilakukan dengan berbagai cara: di tingkat basis data, di tingkat etalase, atau setidaknya di tingkat tampilan - masalah terpecahkan. <br><br>  Dan jika perusahaan memiliki proyek ketiga?  â€œBerbagiâ€ mungkin sudah berakhir buruk: mungkin ada masalah dengan alokasi sumber daya atau hak akses.  Misalnya, salah satu proyek dilakukan oleh tim eksternal yang tidak perlu tahu apa-apa tentang dua proyek pertama.  Situasi menjadi lebih berisiko. <br><br>  Sekarang bayangkan bahwa tidak ada tiga proyek, tetapi lebih dari itu.  Dan kebetulan inilah kasus kami. <br><br>  MyGames adalah salah satu divisi terbesar dari Grup Mail.ru, kami memiliki 150 proyek dalam portofolio kami.  Selain itu, mereka semua sangat berbeda: pengembangan mereka sendiri dan dibeli untuk operasi di Rusia.  Mereka bekerja pada berbagai platform: PC, Xbox, Playstation, iOS dan Android.  Proyek-proyek ini dikembangkan di sepuluh kantor di seluruh dunia dengan ratusan pembuat keputusan. <br><br><img src="https://habrastorage.org/webt/6y/33/c5/6y33c5pfbswcdiqeikzuptzbs9k.jpeg"><br><br>  Untuk bisnis, ini hebat, tetapi menyulitkan tugas untuk tim BI-DWH. <br><br>  Dalam permainan kami, banyak aksi pemain dicatat: ketika dia memasuki permainan, di mana dan bagaimana dia mendapatkan level, dengan siapa dan seberapa sukses dia bertarung, apa dan untuk mata uang apa yang dia beli.  Kami perlu mengumpulkan semua data ini untuk setiap game. <br><br>  Kami membutuhkan ini sehingga bisnis dapat menerima jawaban atas pertanyaannya tentang proyek.  Apa yang terjadi minggu lalu setelah peluncuran aksi?  Apa perkiraan kami untuk pendapatan atau penggunaan kapasitas server game untuk bulan berikutnya?  Apa yang bisa dilakukan untuk memengaruhi ramalan ini? <br><br>  Adalah penting bahwa MyGames tidak memaksakan paradigma pembangunan pada proyek.  Setiap studio game mencatat data yang dianggap lebih efisien.  Beberapa proyek menghasilkan log di sisi klien, beberapa di sisi server.  Beberapa proyek menggunakan RDBMS untuk mengumpulkannya, sementara yang lain menggunakan alat yang sama sekali berbeda: Kafka, Elasticsearch, Hadoop, Tarantool atau Redis.  Dan kita beralih ke sumber data ini untuk mengunggahnya ke repositori. <br><br><h3>  Apa yang Anda inginkan dari BI-DWH kami? </h3><br>  Pertama-tama, dari departemen BI-DWH mereka ingin menerima data pada semua game kami untuk menyelesaikan tugas operasional harian dan yang strategis.  Mulai dari berapa banyak nyawa untuk memberikan monster yang mengerikan di akhir level, dan diakhiri dengan cara mendistribusikan sumber daya dengan baik dalam perusahaan: proyek mana yang harus memberi lebih banyak pengembang atau siapa yang harus mengalokasikan anggaran pemasaran. <br><br>  Keandalan juga diharapkan dari kami.  Kami bekerja di sebuah perusahaan besar dan tidak bisa hidup dengan prinsip "Kemarin kami bekerja, tapi hari ini sistemnya sudah ada, dan itu hanya akan naik dalam seminggu jika kami menemukan sesuatu." <br><br>  Mereka menginginkan penghematan dari kita.  Kami akan dengan senang hati menyelesaikan semua masalah dengan membeli besi atau mempekerjakan orang.  Tetapi kami adalah organisasi komersial dan tidak mampu membelinya.  Kami mencoba membuat keuntungan perusahaan. <br><br>  Yang penting, mereka menginginkan fokus pelanggan dari kami.  Klien dalam hal ini adalah konsumen kami, pelanggan: manajer, analis, dll. Kami harus beradaptasi dengan permainan kami dan bekerja sedemikian rupa sehingga nyaman bagi pelanggan untuk bekerja sama dengan kami.  Sebagai contoh, dalam beberapa kasus, ketika kita membeli proyek di pasar Asia untuk operasi, bersama dengan permainan kita bisa mendapatkan pangkalan dengan nama dalam bahasa Cina.  Dan dokumentasi untuk pangkalan-pangkalan ini dalam bahasa Mandarin.  Kita bisa mencari pengembang ETL dengan pengetahuan bahasa Cina atau menolak untuk mengunduh data pada permainan, tetapi sebaliknya, tim dan saya mengunci diri di ruang rapat, mengambil waktu dan mulai bermain.  Masuk dan keluar dari game, beli, tembak, mati.  Dan kita melihat, apa dan kapan muncul di tabel ini atau itu.  Kemudian kami menulis dokumentasi dan atas dasar itu kami membangun ETL. <br><br>  Dalam hal ini, penting untuk merasakan ujungnya.  Menggali permainan unik logging dengan DAU 50 orang, ketika Anda perlu membantu proyek dengan DAU 500.000 di dekatnya, adalah kemewahan yang tidak dapat diterima.  Jadi, tentu saja, kita dapat menghabiskan banyak upaya untuk membangun solusi khusus, tetapi hanya jika bisnis benar-benar membutuhkannya. <br><br>  Namun, begitu pengembang, terutama pemula, mendengar bahwa mereka harus beradaptasi dengan cara ini, mereka memiliki keinginan untuk tidak pernah melakukan itu.  Setiap pengembang ingin membuat arsitektur yang ideal, tidak pernah mengubahnya dan menulis artikel tentang itu di Habr. <br><br>  Tetapi apa yang terjadi jika kita berhenti menyesuaikan diri dengan permainan kita?  Misalkan kita mulai meminta mereka untuk mengirim data ke satu input API?  Hasilnya akan menjadi satu - semua orang akan mulai menyebar. <br><br><ul><li>  Beberapa proyek akan mulai memotong solusi BI-DWH mereka, dengan preferensi dan penyair.  Ini akan menyebabkan duplikasi sumber daya dan kesulitan dalam pertukaran data antar sistem. <br></li><li>  Proyek-proyek lain tidak akan menarik pembuatan BI-DWH mereka, tetapi mereka juga tidak ingin beradaptasi dengan proyek kami.  Dan yang lain akan berhenti menggunakan data, yang bahkan lebih buruk. <br></li><li>  Baik dan yang paling penting, manajemen tidak akan memiliki informasi sistematis terkini tentang apa yang terjadi dalam proyek. <br></li></ul><br><h3>  Bisakah kita menerapkan penyimpanan dengan cara yang sederhana? </h3><br>  150 proyek banyak.  Untuk mengimplementasikan solusi segera untuk semuanya terlalu lama.  Bisnis tidak akan menunggu satu tahun untuk hasil pertama muncul.  Oleh karena itu, kami mengambil 3 proyek yang menghasilkan pendapatan maksimum, dan mengimplementasikan prototipe pertama untuk mereka.  Kami ingin mengumpulkan data utama darinya dan membuat dasbor dasar dengan metrik paling populer - DAU, MAU, Pendapatan, registrasi, retensi, serta sedikit ekonomi dan prakiraan. <br><br>  Kami tidak dapat menggunakan basis permainan dari proyek itu sendiri untuk ini.  Pertama, ini akan membuat analisis lintas-desain lebih sulit karena kebutuhan untuk mengumpulkan data dari beberapa basis data.  Kedua, permainan itu sendiri bekerja di atas database ini, yang penting agar master dan replika tidak kelebihan beban.  Akhirnya, semua game pada suatu titik menghapus semua riwayat data yang tidak mereka butuhkan dalam database mereka, yang tidak dapat diterima untuk analitik. <br><br>  Karena itu, satu-satunya pilihan adalah mengumpulkan semua yang Anda butuhkan untuk analisis di satu tempat.  Pada titik ini, setiap basis data relasional atau repositori teks biasa cocok untuk kita.  Kami akan mengacaukan BI dan membangun dasbor.  Ada banyak opsi untuk kombinasi solusi tersebut: <br><br><img src="https://habrastorage.org/webt/vx/1e/hm/vx1ehmdjxzv-nimt1x3_ivm3sd8.jpeg"><br><br>  Tapi kami mengerti bahwa nanti kami harus mencakup semua 150 pertandingan lainnya.  Mungkin beberapa basis data relasional cluster dapat menangani jumlah data yang dihasilkan.  Tetapi sumber tidak hanya terletak di sistem yang sama sekali berbeda, tetapi juga memiliki struktur data yang sangat berbeda.  Kami bertemu dengan struktur relasional, Data Vault, dan lainnya.  Ini tidak akan berhasil untuk menempatkan semua ini dalam satu database tanpa trik yang rumit dan melelahkan. <br><br>  Semua ini membuat kami mengerti bahwa kami perlu membangun DataLake. <br><br><h1>  Implementasi DataLake </h1><br>  Pertama-tama, penyimpanan DataLake cocok untuk kondisi kami, karena memungkinkan kami untuk menyimpan data yang tidak terstruktur.  DataLake dapat menjadi titik masuk tunggal untuk semua sumber yang beragam, dari tabel dari RDBMS ke JSON, yang kami kirimkan dari Kafka atau Mongo.  Akibatnya, DataLake dapat menjadi dasar untuk analitik desain-silang yang diimplementasikan berdasarkan antarmuka untuk berbagai konsumen: SQL, Python, R, Spark dan sebagainya. <br><br><h3>  Beralih ke Hadoop </h3><br>  Untuk DataLake, kami memilih solusi yang jelas - Hadoop.  Secara khusus, perakitannya dari Cloudera.  Hadoop memungkinkan Anda untuk bekerja dengan data yang tidak terstruktur dan mudah diskalakan dengan menambahkan node data.  Selain itu, produk ini telah dipelajari dengan baik, sehingga jawaban atas pertanyaan apa pun dapat ditemukan di Stackoverflow, dan tidak menghabiskan sumber daya untuk R&amp;D. <br><br>  Setelah menerapkan Hadoop, kami mendapatkan diagram berikut dari penyimpanan terpadu pertama kami: <br><br><img src="https://habrastorage.org/webt/95/fn/2u/95fn2uesgfvlgfqrxdohrfnltsa.jpeg"><br><br>  Data dikumpulkan ke Hadoop dari sejumlah kecil sumber, dan kemudian beberapa antarmuka diadu di dalamnya: alat dan layanan BI untuk analitik Ad-Hoc. <br><br>  Peristiwa lebih lanjut berkembang secara tak terduga: Hadoop kami mulai dengan sempurna, dan konsumen yang datanya mengalir ke toko meninggalkan sistem analisis lama dan mulai menggunakan produk baru setiap hari untuk pekerjaan mereka. <br><br>  Tetapi muncul masalah: semakin banyak Anda lakukan, semakin banyak yang mereka inginkan dari Anda.  Dengan sangat cepat, proyek-proyek yang sudah terintegrasi ke Hadoop mulai meminta lebih banyak data.  Dan proyek-proyek yang belum ditambahkan, mulai memintanya.  Persyaratan stabilitas mulai tumbuh dengan tajam. <br><br>  Pada saat yang sama, tidak masuk akal untuk hanya meningkatkan tim secara linear.  Jika dua pengembang DWH mengatasi dua proyek, maka untuk empat proyek kami tidak dapat mempekerjakan dua pengembang lagi.  Karena itu, pertama-tama kami pergi ke arah yang lain. <br><br><h3>  Proses pendirian </h3><br>  Dengan sumber daya terbatas, solusi termurah adalah menyesuaikan proses.  Selain itu, di perusahaan besar tidak mungkin untuk hanya datang dengan arsitektur penyimpanan dan mengimplementasikannya.  Harus bernegosiasi dengan sejumlah besar orang. <br><br><ul><li>  Pertama-tama, dengan perwakilan bisnis yang mengalokasikan sumber daya untuk analitik.  Anda harus membuktikan bahwa Anda hanya perlu mengimplementasikan tugas-tugas dari pelanggan Anda yang akan menguntungkan bisnis. <br></li><li>  Anda juga perlu bernegosiasi dengan analis sehingga mereka memberi Anda sesuatu sebagai imbalan atas layanan yang Anda berikan kepada mereka - analisis sistem, analisis bisnis, pengujian.  Sebagai contoh, kami memberikan analisis sistem sumber data kami kepada analis.  Tentu saja, mereka tidak bahagia, tetapi jika tidak maka tidak akan ada orang yang melakukannya. <br></li><li>  Last but not least, Anda harus bernegosiasi dengan pengembang game: pasang SLA dan setujui struktur data.  Jika bidang terus-menerus menghilang, muncul dan berganti nama, maka tidak peduli ukuran tim, Anda akan selalu merindukan tangan Anda. <br></li><li>  Anda juga perlu bernegosiasi dengan tim Anda sendiri: mencari kompromi antara solusi ideal yang ingin dibuat semua pengembang, dan solusi standar yang tidak begitu menarik, tetapi yang dapat dipaku dengan murah dan cepat. <br></li><li>  Penting untuk menyetujui dengan administrator tentang pemantauan infrastruktur.  Meskipun, segera setelah Anda memiliki sumber daya tambahan, lebih baik untuk menyewa spesialis DevOps Anda sendiri dalam tim penyimpanan. <br></li></ul><br>  Pada titik ini, saya bisa menyelesaikan artikel jika versi repositori seperti itu akan memenuhi semua tujuan yang ditetapkan untuk itu.  Tapi ini tidak benar.  Mengapa <br><br>  Sebelum Hadoop, kami dapat menyediakan data dan statistik untuk lima proyek.  Dengan implementasi Hadoop dan tanpa peningkatan tim, kami dapat mencakup 10 proyek.  Setelah menetapkan proses, tim kami telah melayani 15 proyek.  Ini keren, tapi kami punya 150 proyek. Kami butuh sesuatu yang baru. <br><br><h3>  Implementasi aliran udara </h3><br>  Awalnya, kami mengumpulkan data dari sumber menggunakan Cron.  Dua proyek normal.  10 - sakit, tapi ok.  Namun, sekarang sekitar 12 ribu proses dimuat setiap hari untuk memuat dari 150 proyek ke DataLake.  Cron tidak lagi cocok.  Untuk melakukan ini, kita memerlukan alat yang ampuh untuk mengelola aliran unduhan data. <br><br>  Kami memilih Pengelola Tugas Aliran Udara sumber terbuka.  Ia lahir di usus Airbnb, setelah itu ia dipindahkan ke Apache.  Ini adalah alat untuk ETL berbasis kode.  Artinya, Anda menulis skrip dengan Python, dan itu dikonversi ke DAG (grafik asiklik langsung).  DAG sangat bagus untuk menjaga dependensi antar tugas - Anda tidak dapat membangun etalase menggunakan data yang belum dimuat. <br><br>  Airflow memiliki penangan kesalahan yang hebat.  Jika suatu proses macet atau ada masalah dengan jaringan, operator mengirim ulang proses berapa kali Anda tentukan.  Jika ada banyak kegagalan, misalnya, tabel di sumber telah berubah, maka pesan pemberitahuan tiba. <br><br>  Airflow memiliki UI yang hebat: ini menampilkan dengan mudah proses mana yang sedang berjalan, mana yang telah berhasil diselesaikan atau dengan kesalahan.  Jika tugas mengalami kesalahan, Anda dapat memulai kembali dari antarmuka dan mengontrol proses melalui pemantauan tanpa masuk ke dalam kode. <br><br>  Aliran Udara yang Dapat Disesuaikan, dibangun di atas operator - ini adalah plugin untuk bekerja dengan sumber tertentu.  Beberapa operator keluar dari kotak, banyak yang menulis komunitas Airflow.  Jika mau, Anda dapat membuat operator sendiri, antarmuka untuk ini sangat sederhana. <br><br><h3>  Bagaimana kita menggunakan aliran udara? </h3><br>  Sebagai contoh, kita perlu memuat tabel dari PostgreSQL ke Hadoop.  Tugas <code>sql_sensor_battle_log</code> memeriksa untuk melihat apakah sumber memiliki data yang kami butuhkan untuk kemarin.  Jika demikian, tugas <code>load_stg_data_from_battle_log</code> data dari PG dan menambahkannya ke Hadoop.  Akhirnya, <code>load_oda_data_from_battle_log</code> melakukan pemrosesan awal: katakanlah, mengubah dari Unix Time ke waktu yang dapat dibaca manusia. <br><br>  Dalam rantai tugas seperti itu, data diambil dari satu entitas dalam satu sumber: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/347/38d/4af/34738d4afc911f105891070f97f90097.png"><br><br>  Jadi - dari semua entitas yang kita butuhkan dari satu sumber: <br><br><img src="https://habrastorage.org/webt/bs/2i/ne/bs2ines-6me7a6f677u7rc4wgac.jpeg"><br><br>  Kumpulan unduhan ini adalah DAG.  Dan saat ini kami memiliki 250 DAG untuk memuat data mentah, memproses, mengubah dan membuat etalase di dalamnya. <br><br>  Skema penyimpanan terpadu yang diperbarui adalah sebagai berikut: <br><br><img src="https://habrastorage.org/webt/a4/9m/ag/a49magbaiqyrtasd2awg6mqnjmk.jpeg"><br><br><ol><li>  Setelah pengenalan Airflow, kami mampu meningkatkan jumlah sumber yang tajam - hingga 400 buah.  Sumber data adalah internal (dari game kami) dan eksternal: sistem statistik yang dibeli, API heterogen.  Airflow-lah yang memungkinkan kita untuk mengeksekusi dan mengendalikan 12 ribu proses setiap hari yang memproses data dari 150 game kita. <br></li><li>  Secara lebih rinci tentang Aliran Udara kami, Dean Safina menulis dalam artikelnya ( <a href="https://habr.com/ru/company/mailru/blog/344398/">https://habr.com/ru/company/mailru/blog/344398/</a> ).  Dan juga bergabung dengan komunitas Airflow di Telegram ( <a href="https://t.me/ruairflow">https://t.me/ruairflow</a> ).  Banyak pertanyaan tentang Aliran Udara dapat diselesaikan dengan bantuan dokumentasi, tetapi kadang-kadang lebih banyak permintaan khusus muncul: bagaimana saya bisa mengemas Aliran Udara ke buruh pelabuhan, mengapa tidak bekerja pada hari ketiga dan semua itu.  Ini bisa dijawab di komunitas ini. <br></li></ol><br><h1>  Apa yang harus diperbaiki di DataLake </h1><br>  Pada titik ini, pengembang DWH yakin bahwa semuanya sudah siap dan sekarang Anda bisa tenang.  Sayangnya atau untungnya, masih ada sesuatu untuk diperketat di DataLake. <br><br><h3>  Kualitas data </h3><br>  Dengan sejumlah besar tabel di DataLake, kualitas data adalah yang pertama kali menderita.  Misalnya, ambil tabel dengan pembayaran.  Berisi user_id, jumlah, tanggal dan waktu pembayaran: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/998/c18/2df/998c182df294a894a55c0c7822eead23.png" width="400"></div><br>  Sekitar 10 ribu pembayaran terjadi setiap hari: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b46/115/a01/b46115a0116d11be5373b93fc4d872e8.png" width="400"><br><br>  Setelah di meja untuk hari itu datang hanya 28 entri.  Ya, dan user_id semuanya kosong: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/606/7c2/d84/6067c2d840a71002e83364d5c0aef2ae.png" width="200"></div><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6b5/055/af6/6b5055af6affe4417834ee051947e57c.png" width="400"></div><br><br>  Jika sesuatu tiba-tiba pecah di sumber kami, maka, berkat Airflow, kami akan segera mengetahuinya.  Tetapi jika secara formal ada data, dan bahkan dalam format yang tepat, maka kita tidak segera belajar tentang gangguan dan sudah dari data konsumen.  Tidak realistis untuk memeriksa 5000 meja kami dengan tangan kami sendiri. <br><br>  Untuk mencegah hal ini, kami telah mengembangkan sistem kontrol kualitas data (DQ) kami sendiri.  Setiap hari ia memonitor unduhan kunci ke repositori kami: ia melacak perubahan mendadak dalam jumlah baris, mencari bidang kosong, dan memeriksa duplikasi data.  Sistem ini juga menerapkan pemeriksaan khusus dari analis.  Berdasarkan ini, dia mengirim pemberitahuan ke surat tentang apa yang salah dan di mana.  Analis pergi ke proyek dan mencari tahu mengapa, misalnya, ada terlalu sedikit data, menghilangkan alasan, dan kami memuat ulang data. <br><br><h3>  Prioritaskan unduhan </h3><br>  Dengan meningkatnya jumlah tugas untuk memuat data ke DataLake, konflik prioritas dengan cepat muncul.  Situasi yang biasa: beberapa proyek yang tidak terlalu penting mengambil semua sumber daya dengan unduhannya di malam hari, dan tabel yang diperlukan untuk menghitung metrik untuk manajemen puncak tidak punya waktu untuk memuat pada awal hari kerja.  Kami menangani ini dalam beberapa cara. <br><br><ul><li>  Memantau unduhan kunci.  Airflow memiliki sistem SLA sendiri, yang memungkinkan Anda untuk menentukan apakah semua kunci tepat waktu.  Jika beberapa data tidak dimuat, maka kami akan mengetahuinya beberapa jam lebih awal dari pengguna dan punya waktu untuk memperbaikinya. <br></li><li>  Pengaturan prioritas.  Untuk melakukan ini, kami menggunakan antrian Aliran Udara dan sistem prioritas.  Hal ini memungkinkan kami untuk menentukan urutan pemuatan DAG dan jumlah proses paralel di dalamnya.  Tidak masuk akal untuk mengunggah log yang dianalisis sebulan sekali, sebelum mengunduh data untuk metrik manajemen puncak. <br></li></ul><br><h3>  Memantau durasi batch malam </h3><br>  Kami memiliki penyimpanan batch.  Pada malam hari, kami sedang dalam proses membangunnya, dan penting bagi kami untuk memastikan bahwa ada cukup malam untuk memproses batch harian.  Jika tidak, selama jam kerja, analis tidak akan memiliki sumber daya penyimpanan yang cukup untuk bekerja.  Kami secara teratur menyelesaikan masalah ini dengan beberapa cara: <br><br><ul><li>  Membalikkan penskalaan.  Kami tidak mengirimkan semua data, tetapi hanya apa yang dibutuhkan analis.  Kami memantau semua tabel yang dimuat, dan jika salah satunya tidak digunakan selama enam bulan, maka kami mematikan pemuatannya. <br></li><li>  Pembangunan kapasitas.  Jika kami memahami bahwa kami dibatasi oleh kemampuan jaringan, jumlah core atau kapasitas disk, maka kami menambahkan node data ke Hadoop. <br></li><li>  Optimalisasi Aliran Udara Pekerja.  Kami melakukan semuanya sehingga setiap bagian dari sistem kami digunakan secara maksimal pada setiap saat waktu konstruksi penyimpanan. <br></li><li>  Refactoring dari proses yang tidak optimal.  Misalnya, kami mempertimbangkan ekonomi permainan baru, dan kami membutuhkan waktu 5 menit.  Tetapi setelah satu tahun, data tumbuh, dan permintaan yang sama diproses selama 2 jam.  Pada titik tertentu, kita harus menyesuaikan kembali dengan perhitungan ulang bertahap, meskipun pada awalnya ini mungkin tampak seperti komplikasi yang tidak perlu. <br></li></ul><br><h3>  Kontrol Sumberdaya </h3><br>  Penting tidak hanya memiliki waktu untuk menyelesaikan persiapan repositori di awal hari kerja, tetapi juga untuk memantau ketersediaan sumber dayanya setelah itu.  Dengan ini, kesulitan mungkin timbul seiring waktu.  Pertama-tama, alasannya adalah bahwa analis menulis kueri yang tidak optimal.  Sekali lagi, para analis itu sendiri menjadi semakin banyak.  Hal paling sederhana dalam hal ini: meningkatkan kapasitas perangkat keras.  Namun, permintaan yang tidak optimal masih akan mengambil semua sumber daya yang tersedia.  Artinya, cepat atau lambat Anda akan mulai menghabiskan uang untuk besi tanpa manfaat yang signifikan.  Oleh karena itu, kami menggunakan beberapa pendekatan lain. <br><br><ul><li>  Kutipan: kami menyerahkan kepada pengguna setidaknya sedikit sumber daya.  Ya, permintaan akan dieksekusi perlahan, tetapi setidaknya mereka akan melakukannya. <br></li><li>  Pemantauan sumber daya yang dikonsumsi: berapa banyak inti yang digunakan oleh permintaan pengguna, yang lupa untuk menggunakan partisi di Hadoop dan mengambil semua RAM, dll ... Selain itu, pemantauan ini dapat dilihat oleh para analis sendiri, dan ketika sesuatu tidak bekerja untuk mereka, mereka sendiri menemukan pelakunya dan berurusan dengan dia.  Jika kami memiliki beberapa proyek, kami akan melacak sendiri konsumsi sumber daya.  Tetapi dengan begitu banyak, kami harus menyewa tim pemantau yang terpisah dan terus berkembang.  Dan dalam jangka panjang, ini tidak masuk akal. <br></li><li>  Pelatihan pengguna sukarela-wajib.  Tugas analis bukanlah menulis kueri berkualitas ke repositori Anda.  Tugas mereka adalah menjawab pertanyaan bisnis.  Dan selain diri kita sendiri - tim repositori - tidak ada yang peduli dengan kualitas permintaan analis.  Oleh karena itu, kami membuat FAQ dan presentasi, mengadakan kuliah untuk analis kami, menjelaskan bagaimana kami dapat bekerja dengan DataLake kami, dan bagaimana tidak. <br></li></ul><br>  Faktanya, menghabiskan waktu untuk menyediakan data jauh lebih penting daripada mengisinya.  Jika ada data dalam penyimpanan, tetapi tidak tersedia, maka dari sudut pandang bisnis itu masih ada, dan upaya Anda untuk mengunduh telah dikeluarkan. <br><br><h3>  Fleksibilitas arsitektur </h3><br>  Penting untuk tidak melupakan fleksibilitas dari DataLake yang dibangun dan jangan takut untuk mengubah arsitektur ketika mengubah faktor input: data apa yang perlu diunggah ke penyimpanan, siapa yang menggunakannya dan bagaimana.  Kami tidak percaya bahwa arsitektur kami akan selalu tetap tidak berubah. <br><br>  Misalnya, kami meluncurkan game seluler baru.  Dia menulis JSON ke Nginx dari klien, Nginx melempar data ke Kafka, kami menguraikannya menggunakan Spark dan memasukkannya ke Hadoop.  Semuanya berfungsi, tugas ditutup. <br><br><img src="https://habrastorage.org/webt/mj/2i/cq/mj2icqljg45ckemxfjwjp1idafy.jpeg"><br><br>  Beberapa bulan berlalu, dan dalam penyimpanan semua proses batch malam mulai berjalan lebih lama.  Kami mulai mencari tahu apa masalahnya: ternyata game itu "menembak", 50 kali lebih banyak data dihasilkan dan Spark tidak dapat mengatasi analisis JSON, menyeret setengah dari sumber daya penyimpanan.  Awalnya, semua data dikirim ke satu topik Kafka, dan Spark mengurutkannya menjadi entitas yang berbeda.  Kami meminta pengembang game untuk berbagi data tentang klien dengan entitas yang berbeda dan menuangkannya ke dalam topik Kafka yang terpisah.  Itu menjadi lebih mudah, tetapi tidak lama.  Kemudian kami memutuskan untuk beralih dari analisis JSON setiap hari menjadi setiap jam.  Namun, fasilitas penyimpanan mulai dibangun tidak hanya pada malam hari, tetapi sekitar jam, yang tidak diinginkan bagi kami.  Setelah upaya tersebut, untuk mengatasi masalah ini, kami meninggalkan Spark dan menerapkan ClickHouse. <br><br><img src="https://habrastorage.org/webt/wv/xw/bo/wvxwbo1pgsxynb8u3lif75uttfw.jpeg"><br><br>  Ini memiliki mesin parsing JSON hebat yang secara instan menguraikan data ke dalam tabel.  Kami pertama kali mengirim informasi dari Kafka ke ClickHouse, dan dari sana kami mengambilnya di Hadoop.  Ini sepenuhnya menyelesaikan masalah kami. <br><br>  Tentu saja, kami mencoba untuk tidak membiakkan sistem kebun binatang di penyimpanan DataLake kami, tetapi kami mencoba untuk memilih teknologi yang paling cocok untuk tugas tertentu. <br><br><h1>  Apakah itu sepadan? </h1><br>  Apakah layak untuk menggunakan Hadoop, sistem kontrol kualitas, berurusan dengan Airflow, dan membangun proses bisnis?  Tentu saja itu layak: <br><br><ul><li>  Bisnis memiliki informasi terkini tentang semua proyek, yang tersedia dalam layanan tunggal. <br></li><li>  Pengguna sistem kami, mulai dari perancang game hingga manajer, berhenti membuat keputusan hanya berdasarkan intuisi dan beralih ke pendekatan Berbasis Data. <br></li><li>  Kami memberi analis alat untuk membuat ilmu roket mereka sendiri.  Sekarang mereka menjawab pertanyaan bisnis yang kompleks, membangun model peramalan, sistem rekomendasi, meningkatkan permainan.  Sebenarnya, untuk ini kami bekerja di BI-DWH. <br></li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id479900/">https://habr.com/ru/post/id479900/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id479890/index.html">Masalah dan tugas penerapan konsep Internet of Things</a></li>
<li><a href="../id479892/index.html">Tentang plugin Gradle, multithreading dalam sistem terdistribusi dan pemantauan otomasi: video dari Yandex.Money metap</a></li>
<li><a href="../id479894/index.html">Dari Hyper-V ke VMware dan sebaliknya: mengubah disk virtual</a></li>
<li><a href="../id479896/index.html">Sabtu: Pikiran Pemrogram tentang Ekonomi, Marx, Lenin, dan Modal</a></li>
<li><a href="../id479898/index.html">Kebenaran telanjang</a></li>
<li><a href="../id479902/index.html">IntelliJ IDEA 2019.3: optimasi kinerja dan peningkatan kualitas</a></li>
<li><a href="../id479904/index.html">Apa itu NFC dan bagaimana cara kerjanya. Segarkan kembali dasar-dasarnya?</a></li>
<li><a href="../id479906/index.html">Tinjauan industri FinTech: teknologi keuangan paling menjanjikan di akhir 2019</a></li>
<li><a href="../id479908/index.html">Bagaimana AR / VR Apple menghadapi kenyataan brutal</a></li>
<li><a href="../id479910/index.html">Cara membuka terowongan di Kubernetes pod atau wadah dengan tcpserver dan netcat</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>