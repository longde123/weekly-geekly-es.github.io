<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⚙️ 👩‍❤️‍👨 🎋 Remplacement de disques plus petits par des disques plus grands sous Linux 👸🏻 🐮 👩🏻‍🌾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour à tous. En prévision du début d'un nouveau groupe de cours Administrateur Linux, nous publions du matériel utile rédigé par notre étudiant, ai...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Remplacement de disques plus petits par des disques plus grands sous Linux</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/486084/">  <i>Bonjour à tous.</i>  <i>En prévision du début d'un nouveau groupe de cours <a href="https://otus.pw/RDsq/">Administrateur Linux, nous</a> publions du matériel utile rédigé par notre étudiant, ainsi que par le mentor du cours, Roman Travin, spécialiste du support technique des produits d'entreprise REG.RU.</i> <br><br>  Dans cet article, nous considérerons 2 cas de remplacement de disques et de transfert d'informations vers de nouveaux disques d'un volume plus important avec une expansion supplémentaire de la baie et du système de fichiers.  Le premier cas concernera le remplacement de disques avec le même balisage MBR / MBR ou GPT / GPT, le deuxième cas concernera le remplacement de disques avec marquage MBR sur des disques d'une capacité supérieure à 2 To, sur lesquels un balisage GPT avec la partition de démarrage biologique sera requis.  Dans les deux cas, les disques vers lesquels nous transférons les données sont déjà installés sur le serveur.  Le système de fichiers utilisé pour la partition racine est ext4. <br><br><hr><a name="habracut"></a><br><h3>  Cas 1: remplacement de disques plus petits par des disques plus grands (jusqu'à 2 To) </h3><br>  <b>Tâche:</b> remplacer les disques actuels par des disques plus gros (jusqu'à 2 To) par transfert d'informations.  Dans ce cas, nous avons 2 disques SSD (RAID-1) de 240 Go avec le système installé et 2 disques SATA de 1 To sur lesquels vous devez transférer le système. <br><br>  Tenez compte de la disposition actuelle du disque. <br><br><pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 223,6G 0 disk ├─sda1 8:1 0 1G 0 part │ └─md126 9:126 0 1023M 0 raid1 /boot └─sda2 8:2 0 222,5G 0 part └─md127 9:127 0 222,4G 0 raid1 ├─vg0-root 253:0 0 206,4G 0 lvm / └─vg0-swap 253:1 0 16G 0 lvm [SWAP] sdb 8:16 0 223,6G 0 disk ├─sdb1 8:17 0 1G 0 part │ └─md126 9:126 0 1023M 0 raid1 /boot └─sdb2 8:18 0 222,5G 0 part └─md127 9:127 0 222,4G 0 raid1 ├─vg0-root 253:0 0 206,4G 0 lvm / └─vg0-swap 253:1 0 16G 0 lvm [SWAP] sdc 8:32 0 931,5G 0 disk sdd 8:48 0 931,5G 0 disk</span></span></code> </pre> <br>  Vérifiez l'espace actuel du système de fichiers utilisé. <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># df -h      % C  devtmpfs 32G 0 32G 0% /dev tmpfs 32G 0 32G 0% /dev/shm tmpfs 32G 9,6M 32G 1% /run tmpfs 32G 0 32G 0% /sys/fs/cgroup /dev/mapper/vg0-root 204G 1,3G 192G 1% / /dev/md126 1007M 120M 837M 13% /boot tmpfs 6,3G 0 6,3G 0% /run/user/0</span></span></code> </pre> <br>  La taille du système de fichiers avant de remplacer les disques est de 204 Go, 2 baies logicielles md126 sont utilisées, qui est montée dans <code>/boot</code> et <code>md127</code> , qui est utilisé comme <i>volume physique</i> pour le groupe VG <i>vg0</i> . <br><br><h4>  1. Suppression de partitions de disque des baies </h4><br>  Vérifiez l'état de la baie <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># cat /proc/mdstat Personalities : [raid1] md126 : active raid1 sda1[0] sdb1[1] 1047552 blocks super 1.2 [2/2] [UU] bitmap: 0/1 pages [0KB], 65536KB chunk md127 : active raid1 sda2[0] sdb2[1] 233206784 blocks super 1.2 [2/2] [UU] bitmap: 0/2 pages [0KB], 65536KB chunk unused devices: &lt;none&gt;</span></span></code> </pre> <br>  Le système utilise 2 tableaux: <code>md126</code> (point de montage <code>/boot</code> ) - se compose des <code>md127</code> <code>/dev/sda1</code> et <code>/dev/sdb1</code> , <code>md127</code> (LVM pour l' <i>échange</i> et la racine du système de fichiers) - se compose de <code>/dev/sda2</code> et <code>/dev/sdb2</code> . <br><br>  Nous marquons les partitions du premier disque, qui sont utilisées dans chaque baie, comme mauvaises. <br><br><pre> <code class="bash hljs">mdadm /dev/md126 --fail /dev/sda1 mdadm /dev/md127 --fail /dev/sda2</code> </pre><br>  Nous supprimons des sections du bloc périphérique / dev / sda des tableaux. <br><br><pre> <code class="bash hljs">mdadm /dev/md126 --remove /dev/sda1 mdadm /dev/md127 --remove /dev/sda2</code> </pre> <br>  Après avoir supprimé le disque de la baie, les informations sur les périphériques de bloc ressembleront à ceci. <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 223,6G 0 disk ├─sda1 8:1 0 1G 0 part └─sda2 8:2 0 222,5G 0 part sdb 8:16 0 223,6G 0 disk ├─sdb1 8:17 0 1G 0 part │ └─md126 9:126 0 1023M 0 raid1 /boot └─sdb2 8:18 0 222,5G 0 part └─md127 9:127 0 222,4G 0 raid1 ├─vg0-root 253:0 0 206,4G 0 lvm / └─vg0-swap 253:1 0 16G 0 lvm [SWAP] sdc 8:32 0 931,5G 0 disk sdd 8:48 0 931,5G 0 disk</span></span></code> </pre> <br>  L'état des baies après la suppression des disques. <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># cat /proc/mdstat Personalities : [raid1] md126 : active raid1 sdb1[1] 1047552 blocks super 1.2 [2/1] [_U] bitmap: 0/1 pages [0KB], 65536KB chunk md127 : active raid1 sdb2[1] 233206784 blocks super 1.2 [2/1] [_U] bitmap: 1/2 pages [4KB], 65536KB chunk unused devices: &lt;none&gt;</span></span></code> </pre> <br><h4>  2. Copie de la table de partition sur un nouveau disque </h4><br>  Vous pouvez vérifier la table de partition utilisée sur le disque avec la commande suivante. <br><br><pre> <code class="bash hljs">fdisk -l /dev/sdb | grep <span class="hljs-string"><span class="hljs-string">'Disk label type'</span></span></code> </pre><br>  La sortie pour le MBR sera: <br><br><pre> <code class="bash hljs">Disk label <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: dos</code> </pre> <br>  pour GPT: <br><br><pre> <code class="bash hljs">Disk label <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: gpt</code> </pre> <br>  <b>Copier la table de balisage pour MBR:</b> <b><br></b> <br><pre> <code class="bash hljs">sfdisk -d /dev/sdb | sfdisk /dev/sdc</code> </pre> <br>  Dans cette commande, le <b>premier</b> est le lecteur à <b>partir</b> <b>duquel le</b> balisage <b>est</b> copié, le <b>second est l'endroit où</b> copier. <br><br><blockquote>  <b>ATTENTION</b> : Pour GPT, le lecteur <b>sur</b> lequel copier le balisage est le <b>premier à être</b> indiqué, le lecteur <b>sur</b> lequel copier le balisage à partir du <b>deuxième</b> lecteur.  Si vous mélangez les disques, le balisage initialement sain sera écrasé et détruit. <br></blockquote><br>  <b>Copie de la table de balisage pour le GPT:</b> <b><br></b> <br><pre> <code class="bash hljs">sgdisk -R /dev/sd /dev/sdb</code> </pre> <br>  Ensuite, attribuez un UUID aléatoire au disque (pour GPT). <br><br><pre> <code class="bash hljs">sgdisk -G /dev/sdc</code> </pre> <br>  Une fois la commande exécutée, les partitions doivent apparaître sur le disque <code>/dev/sdc</code> . <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 223,6G 0 disk ├─sda1 8:1 0 1G 0 part └─sda2 8:2 0 222,5G 0 part sdb 8:16 0 223,6G 0 disk ├─sdb1 8:17 0 1G 0 part │ └─md126 9:126 0 1023M 0 raid1 /boot └─sdb2 8:18 0 222,5G 0 part └─md127 9:127 0 222,4G 0 raid1 ├─vg0-root 253:0 0 206,4G 0 lvm / └─vg0-swap 253:1 0 16G 0 lvm [SWAP] sdc 8:32 0 931,5G 0 disk ├─sdc1 8:33 0 1G 0 part └─sdc2 8:34 0 222,5G 0 part sdd 8:48 0 931,5G 0 disk</span></span></code> </pre> <br>  Si, après l'action effectuée, les partitions du système sur le disque <code>/dev/sdc</code> ne sont pas définies, nous exécutons la commande pour relire la table des partitions. <br><br><pre> <code class="bash hljs">sfdisk -R /dev/sdc</code> </pre> <br>  Si les disques actuels utilisent la table MBR et que les informations doivent être transférées vers des disques d'une capacité supérieure à 2 To, les nouveaux disques devront créer manuellement un balisage GPT à l'aide de la section de démarrage biologique.  Ce cas sera examiné dans la partie 2 de cet article. <br><br><h4>  3. Ajout de partitions du nouveau disque à la baie </h4><br>  Ajoutez des partitions de disque aux tableaux correspondants. <br><br><pre> <code class="bash hljs">mdadm /dev/md126 --add /dev/sdc1 mdadm /dev/md127 --add /dev/sdc2</code> </pre> <br>  Vérifiez que des sections ont été ajoutées. <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 223,6G 0 disk ├─sda1 8:1 0 1G 0 part └─sda2 8:2 0 222,5G 0 part sdb 8:16 0 223,6G 0 disk ├─sdb1 8:17 0 1G 0 part │ └─md126 9:126 0 1023M 0 raid1 /boot └─sdb2 8:18 0 222,5G 0 part └─md127 9:127 0 222,4G 0 raid1 ├─vg0-root 253:0 0 206,4G 0 lvm / └─vg0-swap 253:1 0 16G 0 lvm [SWAP] sdc 8:32 0 931,5G 0 disk ├─sdc1 8:33 0 1G 0 part │ └─md126 9:126 0 1023M 0 raid1 /boot └─sdc2 8:34 0 222,5G 0 part └─md127 9:127 0 222,4G 0 raid1 ├─vg0-root 253:0 0 206,4G 0 lvm / └─vg0-swap 253:1 0 16G 0 lvm [SWAP] sdd 8:48 0 931,5G 0 disk</span></span></code> </pre> <br>  Après cela, nous attendons la synchronisation des tableaux. <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># cat /proc/mdstat Personalities : [raid1] md126 : active raid1 sdc1[2] sdb1[1] 1047552 blocks super 1.2 [2/2] [UU] bitmap: 0/1 pages [0KB], 65536KB chunk md127 : active raid1 sdc2[2] sdb2[1] 233206784 blocks super 1.2 [2/1] [_U] [==&gt;..................] recovery = 10.6% (24859136/233206784) finish=29.3min speed=118119K/sec bitmap: 2/2 pages [8KB], 65536KB chunk unused devices: &lt;none&gt;</span></span></code> </pre> <br>  Vous pouvez surveiller en continu le processus de synchronisation à l'aide de l'utilitaire de <code>watch</code> . <br><br><pre> <code class="bash hljs">watch -n 2 cat /proc/mdstat</code> </pre> <br>  L' <code>-n</code> spécifie à quels intervalles en secondes la commande doit être exécutée pour vérifier la progression. <br><br>  <b>Répétez les étapes 1 à 3 pour le lecteur de remplacement suivant.</b> <br><br>  Nous marquons les partitions du deuxième disque, qui sont utilisées dans chaque baie, comme mauvaises. <br><br><pre> <code class="bash hljs">mdadm /dev/md126 --fail /dev/sdb1 mdadm /dev/md127 --fail /dev/sdb2</code> </pre><br>  Nous supprimons des sections du bloc périphérique <code>/dev/sdb</code> des tableaux. <br><br><pre> <code class="bash hljs">mdadm /dev/md126 --remove /dev/sdb1 mdadm /dev/md127 --remove /dev/sdb2</code> </pre> <br>  Après avoir supprimé le disque de la baie, les informations sur les périphériques de bloc ressembleront à ceci. <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 223,6G 0 disk ├─sda1 8:1 0 1G 0 part └─sda2 8:2 0 222,5G 0 part sdb 8:16 0 223,6G 0 disk ├─sdb1 8:17 0 1G 0 part └─sdb2 8:18 0 222,5G 0 part sdc 8:32 0 931,5G 0 disk ├─sdc1 8:33 0 1G 0 part │ └─md126 9:126 0 1023M 0 raid1 /boot └─sdc2 8:34 0 222,5G 0 part └─md127 9:127 0 222,4G 0 raid1 ├─vg0-root 253:0 0 206,4G 0 lvm / └─vg0-swap 253:1 0 16G 0 lvm [SWAP] sdd 8:48 0 931,5G 0 disk</span></span></code> </pre><br>  L'état des baies après la suppression des disques. <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># cat /proc/mdstat Personalities : [raid1] md126 : active raid1 sdc1[2] 1047552 blocks super 1.2 [2/1] [U_] bitmap: 0/1 pages [0KB], 65536KB chunk md127 : active raid1 sdc2[2] 233206784 blocks super 1.2 [2/1] [U_] bitmap: 1/2 pages [4KB], 65536KB chunk unused devices: &lt;none&gt;</span></span></code> </pre> <br>  Copiez la table de balisage MBR du lecteur <code>/dev/sd</code> vers le lecteur <code>/dev/sdd</code> . <br><br><pre> <code class="bash hljs">sfdisk -d /dev/sd | sfdisk /dev/sdd</code> </pre> <br>  Une fois la commande exécutée, les partitions doivent apparaître sur le lecteur <code>/dev/sdd</code> . <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 223,6G 0 disk ├─sda1 8:1 0 1G 0 part └─sda2 8:2 0 222,5G 0 part sdb 8:16 0 223,6G 0 disk ├─sdb1 8:17 0 1G 0 part └─sdb2 8:18 0 222,5G 0 part sdc 8:32 0 931,5G 0 disk ├─sdc1 8:33 0 1G 0 part │ └─md126 9:126 0 1023M 0 raid1 /boot └─sdc2 8:34 0 222,5G 0 part └─md127 9:127 0 222,4G 0 raid1 ├─vg0-root 253:0 0 206,4G 0 lvm / └─vg0-swap 253:1 0 16G 0 lvm [SWAP] sdd 8:48 0 931,5G 0 disk ├─sdd1 8:49 0 1G 0 part └─sdd2 8:50 0 222,5G 0 part</span></span></code> </pre> <br>  Ajoutez des partitions de disque aux tableaux. <br><br><pre> <code class="bash hljs">mdadm /dev/md126 --add /dev/sdd1 mdadm /dev/md127 --add /dev/sdd2</code> </pre> <br>  Vérifiez que des sections ont été ajoutées. <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 223,6G 0 disk ├─sda1 8:1 0 1G 0 part └─sda2 8:2 0 222,5G 0 part sdb 8:16 0 223,6G 0 disk ├─sdb1 8:17 0 1G 0 part └─sdb2 8:18 0 222,5G 0 part sdc 8:32 0 931,5G 0 disk ├─sdc1 8:33 0 1G 0 part │ └─md126 9:126 0 1023M 0 raid1 /boot └─sdc2 8:34 0 222,5G 0 part └─md127 9:127 0 222,4G 0 raid1 ├─vg0-root 253:0 0 206,4G 0 lvm / └─vg0-swap 253:1 0 16G 0 lvm [SWAP] sdd 8:48 0 931,5G 0 disk ├─sdd1 8:49 0 1G 0 part │ └─md126 9:126 0 1023M 0 raid1 /boot └─sdd2 8:50 0 222,5G 0 part └─md127 9:127 0 222,4G 0 raid1 ├─vg0-root 253:0 0 206,4G 0 lvm / └─vg0-swap 253:1 0 16G 0 lvm [SWAP]</span></span></code> </pre> <br>  Après cela, nous attendons la synchronisation des tableaux. <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># cat /proc/mdstat Personalities : [raid1] md126 : active raid1 sdd1[3] sdc1[2] 1047552 blocks super 1.2 [2/2] [UU] bitmap: 0/1 pages [0KB], 65536KB chunk md127 : active raid1 sdd2[3] sdc2[2] 233206784 blocks super 1.2 [2/1] [U_] [&gt;....................] recovery = 0.5% (1200000/233206784) finish=35.4min speed=109090K/sec bitmap: 2/2 pages [8KB], 65536KB chunk unused devices: &lt;none&gt;</span></span></code> </pre><br><h4>  5. Installez GRUB sur de nouveaux disques </h4><br>  Pour CentOS: <br><br><pre> <code class="bash hljs">grub2-install /dev/sdX</code> </pre> <br>  Pour Debian / Ubuntu: <br><br><pre> <code class="bash hljs">grub-install /dev/sdX</code> </pre> <br>  où <code>X</code> est la lettre du périphérique de bloc.  Dans ce cas, installez GRUB sur <code>/dev/sdc</code> et <code>/dev/sdd</code> . <br><br><h4>  6. Extension du système de fichiers (ext4) de la partition racine </h4><br>  931,5 Go sont disponibles sur les nouveaux <code>/dev/sdc</code> et <code>/dev/sdd</code> .  Étant donné que la table de partition est copiée à partir de disques plus petits, 222,5 Go sont disponibles sur les <code>/dev/sdc2</code> et <code>/dev/sdd2</code> . <br><br><pre> <code class="bash hljs">sdc 8:32 0 931,5G 0 disk ├─sdc1 8:33 0 1G 0 part │ └─md126 9:126 0 1023M 0 raid1 /boot └─sdc2 8:34 0 222,5G 0 part └─md127 9:127 0 222,4G 0 raid1 ├─vg0-root 253:0 0 206,4G 0 lvm / └─vg0-swap 253:1 0 16G 0 lvm [SWAP] sdd 8:48 0 931,5G 0 disk ├─sdd1 8:49 0 1G 0 part │ └─md126 9:126 0 1023M 0 raid1 /boot └─sdd2 8:50 0 222,5G 0 part └─md127 9:127 0 222,4G 0 raid1 ├─vg0-root 253:0 0 206,4G 0 lvm / └─vg0-swap 253:1 0 16G 0 lvm [SWAP]</code> </pre> <br>  Il faut: <br><br><ol><li>  Étendez la section 2 sur chaque lecteur, </li><li>  Étendez le tableau md127, </li><li>  Développez PV (volume physique), </li><li>  Étendre LV (volume logique) vg0-root, </li><li>  Étendez le système de fichiers. </li></ol><br>  À l'aide de l'utilitaire <i>parted,</i> développez la <code>/dev/sdc2</code> à la valeur maximale.  <code>parted /dev/sdc</code> commande <code>parted /dev/sdc</code> (1) et visualisons la table de partition actuelle avec la commande <code>p</code> (2). <br><br><img src="https://habrastorage.org/webt/ao/zx/xc/aozxxc_zhq42me4qblnij5bib4y.png"><br><br>  Comme vous pouvez le voir, la fin de la section 2 se termine avec 240 Go.  Développons la section avec la commande <code>resizepart</code> <code>2</code> , où 2 est le numéro de section (3).  Nous indiquons la valeur au format numérique, par exemple 1000 Go, ou nous utilisons l'indication du partage de disque - 100%.  Encore une fois, nous vérifions que la section a une nouvelle taille (4). <br><br>  Répétez les étapes ci-dessus pour le lecteur <code>/dev/sdd</code> .  Après avoir étendu les partitions, <code>/dev/sdc2</code> et <code>/dev/sdd2</code> devenus égaux à 930,5 Go. <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 223,6G 0 disk ├─sda1 8:1 0 1G 0 part └─sda2 8:2 0 222,5G 0 part sdb 8:16 0 223,6G 0 disk ├─sdb1 8:17 0 1G 0 part └─sdb2 8:18 0 222,5G 0 part sdc 8:32 0 931,5G 0 disk ├─sdc1 8:33 0 1G 0 part │ └─md126 9:126 0 1023M 0 raid1 /boot └─sdc2 8:34 0 930,5G 0 part └─md127 9:127 0 222,4G 0 raid1 ├─vg0-root 253:0 0 206,4G 0 lvm / └─vg0-swap 253:1 0 16G 0 lvm [SWAP] sdd 8:48 0 931,5G 0 disk ├─sdd1 8:49 0 1G 0 part │ └─md126 9:126 0 1023M 0 raid1 /boot └─sdd2 8:50 0 930,5G 0 part └─md127 9:127 0 222,4G 0 raid1 ├─vg0-root 253:0 0 206,4G 0 lvm / └─vg0-swap 253:1 0 16G 0 lvm [SWAP]</span></span></code> </pre> <br>  Après cela, nous développons le tableau <i>md127</i> au maximum. <br><br><pre> <code class="bash hljs">mdadm --grow /dev/md127 --size=max</code> </pre> <br>  Vérifiez que le tableau s'est étendu.  Maintenant, sa taille est devenue 930,4 Go. <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 223,6G 0 disk ├─sda1 8:1 0 1G 0 part └─sda2 8:2 0 222,5G 0 part sdb 8:16 0 223,6G 0 disk ├─sdb1 8:17 0 1G 0 part └─sdb2 8:18 0 222,5G 0 part sdc 8:32 0 931,5G 0 disk ├─sdc1 8:33 0 1G 0 part │ └─md126 9:126 0 1023M 0 raid1 /boot └─sdc2 8:34 0 930,5G 0 part └─md127 9:127 0 930,4G 0 raid1 ├─vg0-root 253:0 0 206,4G 0 lvm / └─vg0-swap 253:1 0 16G 0 lvm [SWAP] sdd 8:48 0 931,5G 0 disk ├─sdd1 8:49 0 1G 0 part │ └─md126 9:126 0 1023M 0 raid1 /boot └─sdd2 8:50 0 930,5G 0 part └─md127 9:127 0 930,4G 0 raid1 ├─vg0-root 253:0 0 206,4G 0 lvm / └─vg0-swap 253:1 0 16G 0 lvm [SWAP]</span></span></code> </pre> <br>  Nous effectuons l'expansion du <i>volume physique</i> .  Avant l'extension, vérifiez l'état actuel de la PV. <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># pvscan PV /dev/md127 VG vg0 lvm2 [222,40 GiB / 0 free] Total: 1 [222,40 GiB] / in use: 1 [222,40 GiB] / in no VG: 0 [0 ]</span></span></code> </pre><br>  Comme vous pouvez le voir, PV <code>/dev/md127</code> utilise <code>/dev/md127</code> Go d'espace. <br><br>  Développez PV avec la commande suivante. <br><br><pre> <code class="bash hljs">pvresize /dev/md127</code> </pre> <br>  Vérifiez le résultat de l'extension PV. <br><br>  [ <pre> <code class="bash hljs">root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># pvscan PV /dev/md127 VG vg0 lvm2 [930,38 GiB / 707,98 GiB free] Total: 1 [930,38 GiB] / in use: 1 [930,38 GiB] / in no VG: 0 [0 ]</span></span></code> </pre> <br>  Extension du <i>volume logique</i> .  Avant l'extension, vérifiez l'état actuel de LV (1). <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># lvscan ACTIVE '/dev/vg0/swap' [&lt;16,00 GiB] inherit ACTIVE '/dev/vg0/root' [&lt;206,41 GiB] inherit</span></span></code> </pre> <br>  LV <code>/dev/vg0/root</code> utilise 206,41 Go. <br><br>  Nous développons LV avec la commande suivante (2). <br><br><pre> <code class="bash hljs">lvextend -l +100%FREE /dev/mapper/vg0-root</code> </pre> <br><br>  Vérifiez l'action effectuée (3). <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># lvscan ACTIVE '/dev/vg0/swap' [&lt;16,00 GiB] inherit ACTIVE '/dev/vg0/root' [&lt;914,39 GiB] inherit</span></span></code> </pre><br>  Comme vous pouvez le voir, après l'extension LV, le volume d'espace disque occupé est devenu 914,39 Go. <br><br><img src="https://habrastorage.org/webt/vd/6r/qh/vd6rqhe3wvbukzdfachz7xf4ehk.png"><br><br>  Le volume LV a augmenté (4), mais le système de fichiers occupe toujours 204 Go (5). <br><br>  <i>1. Effectuez l'extension du système de fichiers.</i> <br><br><pre> <code class="bash hljs">resize2fs /dev/mapper/vg0-root</code> </pre> <br>  Nous vérifions après la commande exécutée la taille du système de fichiers. <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># df -h      % C  devtmpfs 32G 0 32G 0% /dev tmpfs 32G 0 32G 0% /dev/shm tmpfs 32G 9,5M 32G 1% /run tmpfs 32G 0 32G 0% /sys/fs/cgroup /dev/mapper/vg0-root 900G 1,3G 860G 1% / /dev/md126 1007M 120M 837M 13% /boot tmpfs 6,3G 0 6,3G 0% /run/user/0</span></span></code> </pre> <br>  La taille du système de fichiers racine passera à 900 Go.  Après avoir terminé les étapes, vous pouvez retirer les anciens disques. <br><br><h3>  Cas 2: remplacement de disques plus petits par des disques plus grands (plus de 2 To) </h3><br>  <b>Tâche:</b> remplacer les disques actuels par des disques plus gros (2 x 3 To) avec des informations d'enregistrement.  Dans ce cas, nous avons 2 disques SSD (RAID-1) de 240 Go avec le système installé et 2 disques SATA de 3 To sur lesquels vous devez transférer le système.  Les lecteurs actuels utilisent la table de partition MBR.  Étant donné que les nouveaux disques ont une capacité supérieure à 2 To, ils devront utiliser la table GPT, car MBR ne peut pas fonctionner avec des disques supérieurs à 2 To. <br><br>  Affichez la disposition actuelle du disque. <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 223,6G 0 disk ├─sda1 8:1 0 1G 0 part │ └─md126 9:126 0 1023M 0 raid1 /boot └─sda2 8:2 0 222,5G 0 part └─md127 9:127 0 222,4G 0 raid1 ├─vg0-root 253:0 0 206,4G 0 lvm / └─vg0-swap 253:1 0 16G 0 lvm [SWAP] sdb 8:16 0 223,6G 0 disk ├─sdb1 8:17 0 1G 0 part │ └─md126 9:126 0 1023M 0 raid1 /boot └─sdb2 8:18 0 222,5G 0 part └─md127 9:127 0 222,4G 0 raid1 ├─vg0-root 253:0 0 206,4G 0 lvm / └─vg0-swap 253:1 0 16G 0 lvm [SWAP] sdc 8:32 0 2,7T 0 disk sdd 8:48 0 2,7T 0 disk</span></span></code> </pre> <br>  Vérifiez la table de partition utilisée sur le lecteur <code>/dev/sda</code> . <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># fdisk -l /dev/sda | grep 'Disk label type' Disk label type: dos</span></span></code> </pre> <br>  Le lecteur <code>/dev/sdb</code> utilise une table de partition similaire.  Vérifiez l'espace disque utilisé dans le système. <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># df -h      % C  devtmpfs 16G 0 16G 0% /dev tmpfs 16G 0 16G 0% /dev/shm tmpfs 16G 9,5M 16G 1% /run tmpfs 16G 0 16G 0% /sys/fs/cgroup /dev/mapper/vg0-root 204G 1,3G 192G 1% / /dev/md126 1007M 120M 837M 13% /boot tmpfs 3,2G 0 3,2G 0% /run/user/0</span></span></code> </pre> <br>  Comme vous pouvez le voir, la racine du système de fichiers est de 204 Go.  Vérifiez l'état actuel du RAID logiciel. <br><br><h4>  1. Installer la table de partition GPT et le partitionnement de disque </h4><br>  Vérifiez la disposition du disque par secteur. <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># parted /dev/sda print : ATA KINGSTON SVP200S (scsi)  /dev/sda: 240GB   (./.): 512B/512B  : msdos Disk Flags:         1 1049kB 1076MB 1075MB primary , raid 2 1076MB 240GB 239GB primary raid</span></span></code> </pre><br>  Sur le nouveau disque de 3 To, nous devrons créer 3 partitions: <br><br><ol><li>  <code>bios_grub</code> pour la compatibilité GPT avec le BIOS, </li><li>  La partition pour la matrice RAID à monter dans <code>/boot</code> . </li><li>  La partition de la matrice RAID sur laquelle seront la <i>racine</i> <i>LV</i> et le <i>swap LV</i> . </li></ol><br>  Installez l'utilitaire <i>parted avec la</i> commande <code>yum install -y parted</code> (pour CentOS), <code>apt install -y parted</code> (pour Debian / Ubuntu). <br><br>  En utilisant <i>parted,</i> exécutez les commandes suivantes pour partitionner le disque. <br><br>  <code>parted /dev/sdc</code> commande <code>parted /dev/sdc</code> au mode d'édition de la disposition du disque. <br><br>  Créez une table de partition GPT. <br><br><pre> <code class="bash hljs">(parted) mktable gpt</code> </pre> <br>  Créez une section <code>bios_grub</code> et définissez un indicateur pour celle-ci. <br><br><pre> <code class="bash hljs">(parted) mkpart primary 1MiB 3MiB (parted) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> 1 bios_grub on</code> </pre> <br>  Créez une section 2 et définissez un indicateur pour celle-ci.  La partition utilisera comme bloc pour la matrice RAID et la montera dans <code>/boot</code> . <br><br><pre> <code class="bash hljs">(parted) mkpart primary ext2 3MiB 1028MiB (parted) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> 2 boot on</code> </pre> <br>  Créez une section 3, qui sera également utilisée comme bloc de tableau dans lequel se trouvera LVM. <br><br><pre> <code class="bash hljs">(parted) mkpart primary 1028MiB 100%</code> </pre> <br>  Dans ce cas, la définition de l'indicateur n'est pas nécessaire, mais si nécessaire, il est possible de le définir avec la commande suivante. <br><br><pre> <code class="bash hljs">(parted) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> 3 raid on</code> </pre> <br>  Vérifiez la table créée. <br><br><pre> <code class="bash hljs">(parted) p : ATA TOSHIBA DT01ACA3 (scsi)  /dev/sdc: 3001GB   (./.): 512B/4096B  : gpt Disk Flags:         1 1049kB 3146kB 2097kB primary bios_grub 2 3146kB 1077MB 1074MB primary  3 1077MB 3001GB 3000GB primary</code> </pre><br>  Attribuez au lecteur un nouveau GUID aléatoire. <br><br><pre> <code class="bash hljs">sgdisk -G /dev/sdd</code> </pre><br><h4>  2. Suppression des partitions du premier disque des baies </h4><br>  Vérifiez l'état de la baie <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># cat /proc/mdstat Personalities : [raid1] md126 : active raid1 sda1[0] sdb1[1] 1047552 blocks super 1.2 [2/2] [UU] bitmap: 0/1 pages [0KB], 65536KB chunk md127 : active raid1 sda2[0] sdb2[1] 233206784 blocks super 1.2 [2/2] [UU] bitmap: 0/2 pages [0KB], 65536KB chunk unused devices: &lt;none&gt;</span></span></code> </pre> <br>  Le système utilise 2 tableaux: md126 (point de montage / démarrage) - se compose de <code>/dev/sda1</code> et <code>/dev/sdb1</code> , <code>md127</code> (LVM pour <code>swap</code> et la racine du système de fichiers) - se compose de <code>/dev/sda2</code> et <code>/dev/sdb2</code> . <br><br>  Nous marquons les partitions du premier disque, qui sont utilisées dans chaque baie, comme mauvaises. <br><br><pre> <code class="bash hljs">mdadm /dev/md126 --fail /dev/sda1 mdadm /dev/md127 --fail /dev/sda2</code> </pre> <br>  Nous supprimons des sections du bloc périphérique <code>/dev/sda</code> des tableaux. <br><br><pre> <code class="bash hljs">mdadm /dev/md126 --remove /dev/sda1 mdadm /dev/md127 --remove /dev/sda2</code> </pre><br>  Vérifiez l'état de la baie après avoir retiré le disque. <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># cat /proc/mdstat Personalities : [raid1] md126 : active raid1 sdb1[1] 1047552 blocks super 1.2 [2/1] [_U] bitmap: 0/1 pages [0KB], 65536KB chunk md127 : active raid1 sdb2[1] 233206784 blocks super 1.2 [2/1] [_U] bitmap: 2/2 pages [8KB], 65536KB chunk unused devices: &lt;none&gt;</span></span></code> </pre><br><h4>  3. Ajout de partitions du nouveau disque à la baie </h4><br>  L'étape suivante consiste à ajouter les partitions du nouveau disque aux baies pour la synchronisation.  Nous regardons l'état actuel de la disposition du disque. <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 223,6G 0 disk ├─sda1 8:1 0 1G 0 part └─sda2 8:2 0 222,5G 0 part sdb 8:16 0 223,6G 0 disk ├─sdb1 8:17 0 1G 0 part │ └─md126 9:126 0 1023M 0 raid1 /boot └─sdb2 8:18 0 222,5G 0 part └─md127 9:127 0 222,4G 0 raid1 ├─vg0-root 253:0 0 206,4G 0 lvm / └─vg0-swap 253:1 0 16G 0 lvm [SWAP] sdc 8:32 0 2,7T 0 disk ├─sdc1 8:33 0 2M 0 part ├─sdc2 8:34 0 1G 0 part └─sdc3 8:35 0 2,7T 0 part sdd 8:48 0 2,7T 0 disk</span></span></code> </pre> <br>  La <code>/dev/sdc1</code> est une partition <code>bios_grub</code> et n'est pas impliquée dans la création de tableaux.  <code>/dev/sdc2</code> utiliseront uniquement <code>/dev/sdc2</code> et <code>/dev/sdc3</code> .  Ajoutez ces sections aux tableaux correspondants. <br><br><pre> <code class="bash hljs">mdadm /dev/md126 --add /dev/sdc2 mdadm /dev/md127 --add /dev/sdc3</code> </pre> <br>  Ensuite, nous attendons la synchronisation du tableau. <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># cat /proc/mdstat Personalities : [raid1] md126 : active raid1 sdc2[2] sdb1[1] 1047552 blocks super 1.2 [2/2] [UU] bitmap: 0/1 pages [0KB], 65536KB chunk md127 : active raid1 sdc3[2] sdb2[1] 233206784 blocks super 1.2 [2/1] [_U] [&gt;....................] recovery = 0.2% (619904/233206784) finish=31.2min speed=123980K/sec bitmap: 2/2 pages [8KB], 65536KB chunk unused devices: &lt;none&gt;</span></span></code> </pre> <br>  Partitionnement des disques après l'ajout de partitions à une baie. <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 223,6G 0 disk ├─sda1 8:1 0 1G 0 part └─sda2 8:2 0 222,5G 0 part sdb 8:16 0 223,6G 0 disk ├─sdb1 8:17 0 1G 0 part │ └─md126 9:126 0 1023M 0 raid1 /boot └─sdb2 8:18 0 222,5G 0 part └─md127 9:127 0 222,4G 0 raid1 ├─vg0-root 253:0 0 206,4G 0 lvm / └─vg0-swap 253:1 0 16G 0 lvm [SWAP] sdc 8:32 0 2,7T 0 disk ├─sdc1 8:33 0 2M 0 part ├─sdc2 8:34 0 1G 0 part │ └─md126 9:126 0 1023M 0 raid1 /boot └─sdc3 8:35 0 2,7T 0 part └─md127 9:127 0 222,4G 0 raid1 ├─vg0-root 253:0 0 206,4G 0 lvm / └─vg0-swap 253:1 0 16G 0 lvm [SWAP] sdd 8:48 0 2,7T 0 disk</span></span></code> </pre> <br><h4>  4. Suppression de partitions du deuxième disque des baies </h4><br>  Nous marquons les partitions du deuxième disque, qui sont utilisées dans chaque baie, comme mauvaises. <br><br><pre> <code class="bash hljs">mdadm /dev/md126 --fail /dev/sdb1 mdadm /dev/md127 --fail /dev/sdb2</code> </pre><br>  Nous supprimons des sections du bloc périphérique <code>/dev/sda</code> des tableaux. <br><br><pre> <code class="bash hljs">mdadm /dev/md126 --remove /dev/sdb1 mdadm /dev/md127 --remove /dev/sdb2</code> </pre><br><h4>  5. Copiez la table de balisage GPT et synchronisez le tableau </h4><br>  Pour copier la table de balisage GPT, nous utilisons l'utilitaire <code>sgdisk</code> , qui est inclus dans le package pour travailler avec les partitions de disque et la table GPT - <code>gdisk</code> . <br><br>  Installez <code>gdisk</code> pour CentOS: <br><br><pre> <code class="bash hljs">yum install -y gdisk</code> </pre> <br>  Installez <code>gdisk</code> pour Debian / Ubuntu: <br><br><pre> <code class="bash hljs">apt install -y gdisk</code> </pre> <br><blockquote>  <b>ATTENTION</b> : pour GPT, le disque <b>sur lequel le</b> balisage est copié est indiqué en <b>premier</b> , le <b>deuxième</b> disque est le disque à <b>partir duquel le</b> balisage <b>est</b> copié.  Si vous mélangez les disques, le balisage initialement sain sera écrasé et détruit. <br></blockquote><br>  Copiez la table de balisage GPT. <br><br><pre> <code class="bash hljs">sgdisk -R /dev/sdd /dev/sdc</code> </pre> <br>  Partitionnement des disques après le transfert d'une table vers le lecteur <code>/dev/sdd</code> . <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 223,6G 0 disk ├─sda1 8:1 0 1G 0 part └─sda2 8:2 0 222,5G 0 part sdb 8:16 0 223,6G 0 disk ├─sdb1 8:17 0 1G 0 part └─sdb2 8:18 0 222,5G 0 part sdc 8:32 0 2,7T 0 disk ├─sdc1 8:33 0 2M 0 part ├─sdc2 8:34 0 1G 0 part │ └─md126 9:126 0 1023M 0 raid1 /boot └─sdc3 8:35 0 2,7T 0 part └─md127 9:127 0 222,4G 0 raid1 ├─vg0-root 253:0 0 206,4G 0 lvm / └─vg0-swap 253:1 0 16G 0 lvm [SWAP] sdd 8:48 0 2,7T 0 disk ├─sdd1 8:49 0 2M 0 part ├─sdd2 8:50 0 1G 0 part └─sdd3 8:51 0 2,7T 0 part</span></span></code> </pre> <br>  Ensuite, nous ajoutons chacune des partitions participant aux matrices RAID logicielles. <br><br><pre> <code class="bash hljs">mdadm /dev/md126 --add /dev/sdd2 mdadm /dev/md127 --add /dev/sdd3</code> </pre> <br>  Nous attendons la synchronisation du tableau. <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># cat /proc/mdstat Personalities : [raid1] md126 : active raid1 sdd2[3] sdc2[2] 1047552 blocks super 1.2 [2/2] [UU] bitmap: 1/1 pages [4KB], 65536KB chunk md127 : active raid1 sdd3[3] sdc3[2] 233206784 blocks super 1.2 [2/1] [U_] [&gt;....................] recovery = 0.0% (148224/233206784) finish=26.2min speed=148224K/sec bitmap: 2/2 pages [8KB], 65536KB chunk unused devices: &lt;none&gt;</span></span></code> </pre> <br>  Après avoir copié le balisage GPT sur un deuxième nouveau disque, le balisage ressemblera à ceci. <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 223,6G 0 disk ├─sda1 8:1 0 1G 0 part └─sda2 8:2 0 222,5G 0 part sdb 8:16 0 223,6G 0 disk ├─sdb1 8:17 0 1G 0 part └─sdb2 8:18 0 222,5G 0 part sdc 8:32 0 2,7T 0 disk ├─sdc1 8:33 0 2M 0 part ├─sdc2 8:34 0 1G 0 part │ └─md126 9:126 0 1023M 0 raid1 /boot └─sdc3 8:35 0 2,7T 0 part └─md127 9:127 0 222,4G 0 raid1 ├─vg0-root 253:0 0 206,4G 0 lvm / └─vg0-swap 253:1 0 16G 0 lvm [SWAP] sdd 8:48 0 2,7T 0 disk ├─sdd1 8:49 0 2M 0 part ├─sdd2 8:50 0 1G 0 part │ └─md126 9:126 0 1023M 0 raid1 /boot └─sdd3 8:51 0 2,7T 0 part └─md127 9:127 0 222,4G 0 raid1 ├─vg0-root 253:0 0 206,4G 0 lvm / └─vg0-swap 253:1 0 16G 0 lvm [SWAP]</span></span></code> </pre> <br>  Ensuite, installez GRUB sur les nouveaux disques. <br><br>  Installation pour CentOS: <br><br><pre> <code class="bash hljs">grub2-install /dev/sdX</code> </pre> <br>  Installation pour Debian / Ubuntu: <br><br><pre> <code class="bash hljs">grub-install /dev/sdX</code> </pre> <br>  où <code>X</code> est la lettre de lecteur, dans notre cas, les lecteurs <code>/dev/sdc</code> et <code>/dev/sdd</code> . <br><br>  Mise à jour des informations sur la baie. <br><br>  Pour CentOS: <br><br><pre> <code class="bash hljs">mdadm --detail --scan --verbose &gt; /etc/mdadm.conf</code> </pre> <br>  Pour Debian / Ubuntu: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"DEVICE partitions"</span></span> &gt; /etc/mdadm/mdadm.conf mdadm --detail --scan --verbose | awk <span class="hljs-string"><span class="hljs-string">'/ARRAY/ {print}'</span></span> &gt;&gt; /etc/mdadm/mdadm.conf</code> </pre> <br>  Mise à jour de l'image <code>initrd</code> : <br>  Pour CentOS: <br><br><pre> <code class="bash hljs">dracut -f -v --regenerate-all</code> </pre> <br>  Pour Debian / Ubuntu: <br><br><pre> <code class="bash hljs">update-initramfs -u -k all</code> </pre> <br>  Mise à jour de la configuration GRUB. <br><br>  Pour CentOS: <br><br><pre> <code class="bash hljs">grub2-mkconfig -o /boot/grub2/grub.cfg</code> </pre><br>  Pour Debian / Ubuntu: <br><br><pre> <code class="bash hljs">update-grub</code> </pre> <br>  Une fois les étapes terminées, les anciens disques peuvent être retirés. <br><br><h4>  6. Extension du système de fichiers (ext4) de la partition racine </h4><br>  Partitionner les disques avant d'étendre le système de fichiers après avoir déplacé le système vers des disques 2 x 3 To (RAID-1). <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 223,6G 0 disk sdb 8:16 0 223,6G 0 disk sdc 8:32 0 2,7T 0 disk ├─sdc1 8:33 0 2M 0 part ├─sdc2 8:34 0 1G 0 part │ └─md127 9:127 0 1023M 0 raid1 /boot └─sdc3 8:35 0 2,7T 0 part └─md126 9:126 0 222,4G 0 raid1 ├─vg0-root 253:0 0 206,4G 0 lvm / └─vg0-swap 253:1 0 16G 0 lvm [SWAP] sdd 8:48 0 2,7T 0 disk ├─sdd1 8:49 0 2M 0 part ├─sdd2 8:50 0 1G 0 part │ └─md127 9:127 0 1023M 0 raid1 /boot └─sdd3 8:51 0 2,7T 0 part └─md126 9:126 0 222,4G 0 raid1 ├─vg0-root 253:0 0 206,4G 0 lvm / └─vg0-swap 253:1 0 16G 0 lvm [SWAP]</span></span></code> </pre> <br>  Les <code>/dev/sdc3</code> et <code>/dev/sdd3</code> occupent <code>/dev/sdd3</code> 2,7 To.  Comme nous avons créé un nouveau partitionnement des disques avec une table GPT, la taille des 3 partitions a été immédiatement définie sur l'espace disque maximal possible, dans ce cas, l'extension de la partition n'est pas nécessaire. <br><br>  Il faut: <br><br><ol><li>  Étendez le tableau md126, </li><li>  Développez PV (volume physique), </li><li>  Étendre LV (volume logique) vg0-root, </li><li>  Étendez le système de fichiers. </li></ol><br>  <i>1. <code>md126</code> tableau <code>md126</code> au maximum.</i> <br><br><pre> <code class="bash hljs">mdadm --grow /dev/md126 --size=max</code> </pre><br>  Après avoir étendu la matrice <code>md126</code> taille de l'espace occupé est passée à 2,7 To. <br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 223,6G 0 disk sdb 8:16 0 223,6G 0 disk sdc 8:32 0 2,7T 0 disk ├─sdc1 8:33 0 2M 0 part ├─sdc2 8:34 0 1G 0 part │ └─md127 9:127 0 1023M 0 raid1 /boot └─sdc3 8:35 0 2,7T 0 part └─md126 9:126 0 2,7T 0 raid1 ├─vg0-root 253:0 0 206,4G 0 lvm / └─vg0-swap 253:1 0 16G 0 lvm [SWAP] sdd 8:48 0 2,7T 0 disk ├─sdd1 8:49 0 2M 0 part ├─sdd2 8:50 0 1G 0 part │ └─md127 9:127 0 1023M 0 raid1 /boot └─sdd3 8:51 0 2,7T 0 part └─md126 9:126 0 2,7T 0 raid1 ├─vg0-root 253:0 0 206,4G 0 lvm / └─vg0-swap 253:1 0 16G 0 lvm [SWAP]</span></span></code> </pre><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Augmenter </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le volume physique</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avant expansion, nous vérifions la valeur actuelle de l'espace occupé PV / </font></font><code>dev/md126</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># pvs PV VG Fmt Attr PSize PFree /dev/md126 vg0 lvm2 a-- 222,40g 0</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Développez PV avec la commande suivante. </font></font><br><br><pre> <code class="bash hljs">pvresize /dev/md126</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vérifiez l'action terminée. </font></font><br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># pvs PV VG Fmt Attr PSize PFree /dev/md126 vg0 lvm2 a-- &lt;2,73t 2,51t</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L' expansion </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">classe volume logique vg0-racine</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Après avoir étendu PV, nous vérifions l'espace occupé de VG.</font></font><br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># vgs VG #PV #LV #SN Attr VSize VFree vg0 1 2 0 wz--n- &lt;2,73t 2,51t</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vérifiez l'espace occupé par LV. </font></font><br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># lvs LV VG Attr LSize Pool Origin Data% Meta% Move Log Cpy%Sync Convert root vg0 -wi-ao---- &lt;206,41g swap vg0 -wi-ao---- &lt;16,00g</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le volume racine vg0 occupe 206,41 Go. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Développez LV à l'espace disque maximal.</font></font><br><br><pre> <code class="bash hljs">lvextend -l +100%FREE /dev/mapper/vg0-root</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vérification de l'espace BT après expansion. </font></font><br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># lvs LV VG Attr LSize Pool Origin Data% Meta% Move Log Cpy%Sync Convert root vg0 -wi-ao---- 2,71t swap vg0 -wi-ao---- &lt;16,00g</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Extension du système de fichiers (ext4). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vérifiez la taille actuelle du système de fichiers.</font></font><br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># df -h      % C  devtmpfs 16G 0 16G 0% /dev tmpfs 16G 0 16G 0% /dev/shm tmpfs 16G 9,6M 16G 1% /run tmpfs 16G 0 16G 0% /sys/fs/cgroup /dev/mapper/vg0-root 204G 1,4G 192G 1% / /dev/md127 1007M 141M 816M 15% /boot tmpfs 3,2G 0 3,2G 0% /run/user/0</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le volume / dev / mapper / vg0-root occupe 204 Go après l'extension LV. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Extension du système de fichiers.</font></font><br><br><pre> <code class="bash hljs">resize2fs /dev/mapper/vg0-root</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vérifiez la taille du système de fichiers après son expansion. </font></font><br><br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># df -h      % C  devtmpfs 16G 0 16G 0% /dev tmpfs 16G 0 16G 0% /dev/shm tmpfs 16G 9,6M 16G 1% /run tmpfs 16G 0 16G 0% /sys/fs/cgroup /dev/mapper/vg0-root 2,7T 1,4G 2,6T 1% / /dev/md127 1007M 141M 816M 15% /boot tmpfs 3,2G 0 3,2G 0% /run/user/0</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La taille du système de fichiers est augmentée de tout le volume du volume. </font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr486084/">https://habr.com/ru/post/fr486084/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr486062/index.html">Rendu simple sans copie de la vidéo avec accélération matérielle en QML</a></li>
<li><a href="../fr486064/index.html">Créez un diaporama animé en CSS pur.</a></li>
<li><a href="../fr486066/index.html">Dans la zone d'accès. Trouvez la distance d'un point à une zone et réduisez les demandes de géocodage inversé</a></li>
<li><a href="../fr486070/index.html">Les commutateurs ACL en détail</a></li>
<li><a href="../fr486080/index.html">Permettez-moi de vous présenter: Veeam Availability Suite v10</a></li>
<li><a href="../fr486094/index.html">Un démocrate se bat contre la Silicon Valley</a></li>
<li><a href="../fr486104/index.html">MVCC dans PostgreSQL-7. Autovacuum</a></li>
<li><a href="../fr486106/index.html">Rétroéclairage adaptatif pour téléviseur Raspberry Pi - Ambilight Analog</a></li>
<li><a href="../fr486114/index.html">Des scientifiques de premier plan dans le domaine des neurosciences se réuniront lors du congrès annuel du Neuronet Industry Union</a></li>
<li><a href="../fr486116/index.html">Tests de simplicité de Fermat et Miller-Rabin</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>