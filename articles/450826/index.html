<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßîüèæ üë∂üèæ ‚ñ´Ô∏è C√≥mo hablar con el microcontrolador de JS ü§ôüèª üëà üçæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¬øPor qu√© se necesita un microcontrolador? Por ejemplo, para configurar una cervecer√≠a en casa. Si su cervecer√≠a no es suficiente, entonces puede hacer...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo hablar con el microcontrolador de JS</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/450826/">  ¬øPor qu√© se necesita un microcontrolador?  Por ejemplo, para configurar una cervecer√≠a en casa.  Si su cervecer√≠a no es suficiente, entonces puede hacer algo m√°s grande: construir una sala de b√∫squeda, organizar una presentaci√≥n, una fuente interactiva que pinta una imagen con gotas o un puesto de exhibici√≥n para una gran empresa.  Puedes hacer cualquier cosa con un microcontrolador: todo depende de tu imaginaci√≥n. <br><br>  Existe la idea err√≥nea de que para crear sus propias gl√°ndulas necesita conocer el ensamblador, C / C ++, poder administrar la memoria y comprender profundamente la electricidad.  Una vez lo fue, pero la tecnolog√≠a se est√° desarrollando y ahora para la implementaci√≥n completa de su proyecto, ¬°solo JS es suficiente! <br><br><img src="https://habrastorage.org/webt/cc/wc/ou/ccwcoucl5o2c-9xayxy04jc8fsq.jpeg"><br><br>  Ok, sabemos JavaScript, pero ¬øc√≥mo conectarlo al hardware?  ¬øQu√© tipo de hierro hay y qu√© puede hacer?  ¬øC√≥mo configurar todo el sistema?  En la transcripci√≥n del informe, Victor Nakoryakova en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">FrontendConf</a> aprender√°: c√≥mo, utilizando solo JS, controlar los servos, c√≥mo combinar f√≠sicamente el sistema con una PC y sobre las opciones de comunicaci√≥n para la aplicaci√≥n en JS.  Analizaremos los paquetes de puerto serie y Firmata, puerto serie con firmware autoescrito en C ++, Espruino y la programaci√≥n del controlador directamente en JS, Raspberry Pi, HTTP en la red local y HTTP y MQTT a trav√©s de la nube. <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/yqeTaf44vNk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  <strong>Victor Nakoryakov</strong> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">nailxx</a> ) - director t√©cnico, cofundador de Amperka.  Le gustan las tecnolog√≠as avanzadas de desarrollo, la programaci√≥n funcional y la inform√°tica f√≠sica.  Amperka fabrica y vende m√≥dulos electr√≥nicos para que los no profesionales creen dispositivos inteligentes con sus propias manos, kits de entrenamiento y bloques de construcci√≥n individuales que se pueden agregar a su dispositivo: motores, GPS, SMS. <br><br><h2>  Donde escribir JavaScript </h2><br>  <strong>Espruino tiene un microcontrolador independiente con JavaScript.</strong>  La plataforma Espruino le permite escribir JS directamente en el microcontrolador.  Esto es algo aut√≥nomo en s√≠ mismo: conectado a una computadora, flasheado y luego funciona de manera independiente. <br><br>  <strong>La Raspberry Pi</strong> es una computadora peque√±a con GPIO. <br><br>  <strong>En una aplicaci√≥n web</strong> , para el frontend o el backend. <br><br>  Mostrar√© el funcionamiento del sistema usando un ejemplo de rana.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Vaya</a> a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">toad.amperka.ru</a> desde su tel√©fono; aparecer√° una interfaz web simple. <br><br><img src="https://habrastorage.org/webt/pd/ya/be/pdyabe5bjmklkee0jjco7nontue.jpeg"><br><br>  La columna izquierda controla el ojo izquierdo, el derecho, el derecho.  El principio es simple: presion√© el bot√≥n, el servomotor gira el ojo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/oc/z5/re/ocz5rert1d774i6ic7dzkaahjpa.gif" width="350"></div><br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Video de</a> demostraci√≥n de un puesto con una rana durante el informe. <br><br><h2>  Como funciona la rana </h2><br>  Cuando abre toad.amperka.ru, obtiene una p√°gina web est√°tica con JS est√°tico, que utiliza la biblioteca <a href="">MQTT.js.</a>  Esta biblioteca se pone en contacto con el agente MQTT en la nube. <br><br><img src="https://habrastorage.org/webt/5r/7h/it/5r7hit4db5ds9369m2fgmsua8t4.jpeg"><br><br>  Si conoce Redis, Publicar / Suscribir, RabbitMQ u otras colas de mensajes, entendi√≥ inmediatamente de qu√© se trataba.  <strong>MQTT es un agente de mensajes de m√°quina a m√°quina</strong> .  Ligero y simple para que incluso las gl√°ndulas d√©biles puedan usarlo. <br><br>  MQTT requiere un intermediario en el servidor.  Pero ni siquiera tiene que levantarlo, alquilarlo.  Por un par de d√≥lares al mes, tendr√° su propio corredor MQTT.  No se necesita backend. <br><br>  Por otro lado, hay un controlador del corredor MQTT.  Hay muchos dispositivos diferentes con este rol, por ejemplo, la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ranura</a> para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Wi-Fi</a> .  Este es un controlador que puede conectarse a Internet. <br><br><img src="https://habrastorage.org/webt/th/dz/jc/thdzjcdluwlertps_bl5lbkdjui.jpeg"><br><br>  Funciona sobre la base del popular chip ESP8266.  Se agreg√≥ la capacidad de alimentar a trav√©s de micro-USB y conectar perif√©ricos externos a trav√©s de contactos triples para conectarse a otros dispositivos. <br><br><h2>  C√≥mo programar hardware en JS </h2><br>  Nada fuera de lo com√∫n, JS regular, casi completo ES6.  Algunas funciones y objetos para trabajar en un nivel bajo con se√±ales el√©ctricas se han agregado a la biblioteca est√°ndar.  Por ejemplo, funciones para lectura y escritura digital simple. <br><br>  <strong>digitalRead - lectura digital</strong> .  Esta es una pregunta para el controlador: "¬øHay tres voltios en el pin n√∫mero 4?"  Si hay voltaje, devolver√° VERDADERO; si no, FALSO.  Esto implementa la lectura de sensores binarios simples: botones, interruptores, cerraduras de l√°minas y sensores de movimiento infrarrojos. <br><br>  <strong>digitalWrite es una simple grabaci√≥n digital</strong> .  Decimos digitalWrite TRUE - 3V va con pin.  Decimos digitalWrite FALSE - 0V.  Usando este principio simple, puede encender / apagar una tira de LED o lanzar un misil nuclear.  Enviamos una se√±al d√©bil al rel√©, conmuta una carga grande y el cohete vol√≥. <br><br>  Tambi√©n hay funciones para trabajar con valores intermedios entre 0 y 3V: <br><br><ul><li>  analogRead; </li><li>  analogWrite; </li><li>  setWatch; </li><li>  digitalPulse. </li></ul><br>  Los comandos le permiten interrogar todo tipo de giros y proporcionar funciones para la grabaci√≥n difusa. <br><br>  Luego vienen los objetos para trabajar con interfaces que son aceptadas en el mundo de los microcontroladores.  Si en la web entendemos y estamos familiarizados con HTTP, WebSocket, TCP, para un microcontrolador esto es: <br><br><ul><li>  Serie - puerto serie; </li><li>  Bus I2C </li><li>  Bus SPI </li><li>  Autob√∫s OneWire. </li></ul><br><h2>  C√≥mo patear un servomotor </h2><br>  Por ejemplo, te dir√© c√≥mo controlar un motor que se encuentra en una hipod√©rmica.  El protocolo motor es simple.  Se aplica 0V al pin de control, el l√≠mite inferior.  Una vez cada 20 Œºs, debe patearse, dando una unidad estable de 3V y, despu√©s de un tiempo, restablecer a 0. <br><br><img src="https://habrastorage.org/webt/io/1t/aj/io1tajdpojik7cxsab0mrddw0bi.jpeg"><br><br>  Entonces todo se repite nuevamente.  Dependiendo de la longitud de la unidad, obtenemos diferentes velocidades de rotaci√≥n.  Con una longitud de pulso de 1,500 Œºs, el motor se detiene.  Cuando se desv√≠a en una direcci√≥n u otra, gira en sentido horario o antihorario.  La magnitud de la desviaci√≥n afecta la velocidad de rotaci√≥n. <br><br><h2>  Como programar </h2><br>  La programaci√≥n de la plataforma Espruino se realiza en el IDE de Espruino del mismo nombre.  La placa del microcontrolador est√° conectada a la computadora con un cable micro-USB.  Lo √∫nico es que tienes que instalar el controlador, que lleva 1,5 minutos.  El controlador est√° instalado para MAC y Windows, y en Linux todo funciona de inmediato. <br><br>  Aqu√≠ hay un ejemplo de un programa que se carga en el entorno con un solo clic.  Parpadea un LED una vez por segundo: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> on = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; setInterval(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ on = !on; LED1.write(on); },<span class="hljs-number"><span class="hljs-number">500</span></span>);</code> </pre> <br>  A la izquierda en el entorno est√° el int√©rprete REPL.  Ingrese "1 + 1".  El programa da la respuesta "2".  Milagro! <br><br>  El milagro es que cuando presiona los botones, el n√∫mero "1", el signo "+" y la siguiente unidad pasan por el cable al controlador.  Cuando presiona ENTRAR, la expresi√≥n se ejecuta dentro del microcontrolador, no en la computadora.  El microcontrolador obtuvo el resultado "2" y lo devolvi√≥ por cable a la computadora.  Se visualiz√≥ "2" en el monitor. <br><br><blockquote>  JavaScript se ejecuta dentro del hardware. </blockquote><br>  Adem√°s del entretenimiento con la aritm√©tica, puede girar los motores.  Necesitar√° la funci√≥n analogWrite, que env√≠a una onda cuadrada.  Hablamos sobre qu√© alfiler dar una ola.  Por ejemplo, en mi tablero est√° firmado como A7.  Luego indicamos la duraci√≥n; por ejemplo, 1300 Œºs de 20 000 Œºs serviremos uno.  Tambi√©n se requiere una opci√≥n que establezca la frecuencia de esta patada: 50 veces por segundo, esto es 20,000 Œºs. <br><br><pre> <code class="javascript hljs">&gt;analogWrite(A7, <span class="hljs-number"><span class="hljs-number">1300</span></span> / <span class="hljs-number"><span class="hljs-number">2000</span></span>, {<span class="hljs-attr"><span class="hljs-attr">freq</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span>}} =<span class="hljs-literal"><span class="hljs-literal">undefined</span></span> &gt;</code> </pre> <br>  Pasaremos por 1500, nos veremos obligados a girar en la otra direcci√≥n con mayor velocidad. <br><br><pre> <code class="javascript hljs">&gt;analogWrite(A7, <span class="hljs-number"><span class="hljs-number">2300</span></span> / <span class="hljs-number"><span class="hljs-number">2000</span></span>, {<span class="hljs-attr"><span class="hljs-attr">freq</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span>}} =<span class="hljs-literal"><span class="hljs-literal">undefined</span></span> &gt;</code> </pre> <br>  O di parada. <br><br><pre> <code class="javascript hljs">&gt;digitalWrite(A7, <span class="hljs-number"><span class="hljs-number">0</span></span>) =<span class="hljs-literal"><span class="hljs-literal">undefined</span></span> &gt;</code> </pre> <br>  Con las mismas funciones, puede escribir un programa completo que, dependiendo de factores externos (presionar botones, lecturas del sensor) har√° lo que desee. <br><br><h3>  Bibliotecas </h3><br>  No siempre es conveniente recordar los detalles de la implementaci√≥n del protocolo.  Por lo tanto, para todo tipo de hierro, se han creado muchas bibliotecas, desde peque√±as hasta gigantes.  Contienen todas las caracter√≠sticas t√©cnicas.  Las bibliotecas utilizan m√©todos claros: leer datos de una etiqueta nfc, leer la concentraci√≥n de di√≥xido de carbono en ppm o enviar un mensaje a Telegram. <br><ul><li>  servo.write; </li><li>  barometer.init; </li><li>  barometer.read; </li><li>  temperatura del bar√≥metro; </li><li>  nfc.listen; </li><li>  nfc.on ('etiqueta', ...); </li><li>  nfc.readPage; </li><li>  nfc.writePage; </li><li>  rel√©.turnOn; </li><li>  relay.turnOff; </li><li>  gas.calibrate; </li><li>  gas.read ('CO2'); </li><li>  telegram.sendMessage. </li></ul><br>  Es √∫til comprender los comandos de bajo nivel, pero para comenzar a crearlo no es necesario saberlo. <br><br><h2>  C√≥digo de cliente </h2><br>  Entonces, cuando hacemos clic en uno de los botones de la columna izquierda o derecha de nuestra rana, el valor que queremos establecer en el servo correspondiente se env√≠a al tema sapo / ojo / izquierda o derecha. <br><br><img src="https://habrastorage.org/webt/y1/3e/mt/y13emt_fcb-qdw2j_tihccn8ukm.jpeg"><br><br><pre> <code class="javascript hljs">&lt;button <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"toad__eye__control"</span></span> data-queue=<span class="hljs-string"><span class="hljs-string">"left"</span></span> data-payload=<span class="hljs-string"><span class="hljs-string">"1300"</span></span>&gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> &lt;<span class="hljs-regexp"><span class="hljs-regexp">/button&gt;</span></span></code> </pre> <br>  1300 es la duraci√≥n del pulso.  ¬øDe d√≥nde vienen la izquierda y 1300?  Acabo de agregarlos al HTML como atributos de datos. <br><br>  En JS, escribimos c√≥digo simple. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> mqtt <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'mqtt'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> client = mqtt.connect(<span class="hljs-string"><span class="hljs-string">`ws://</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${location.hostname}</span></span></span><span class="hljs-string">:9001`</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onEyeControlClick</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { queue, payload } = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dataset; client.publish(<span class="hljs-string"><span class="hljs-string">`toad/eye/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${queue}</span></span></span><span class="hljs-string">`</span></span>, payload); } <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.querySelectorAll(<span class="hljs-string"><span class="hljs-string">".toad__eye__control"</span></span>) .forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function"> =&gt;</span></span> e.addEventListener(<span class="hljs-string"><span class="hljs-string">'click'</span></span>, onEyeControlClick));</code> </pre> <br>  Analicemos el c√≥digo en partes.  Al inicio, nos conectamos al intermediario, que por defecto funciona en el puerto 9001: <code>const client = mqtt.connect(`ws://${location.hostname}:9001`);</code>  . <br><br>  Al hacer clic en cualquiera de los botones, publicamos un nuevo mensaje con carga √∫til, que obtuvimos del atributo de datos: <code>client.publish(`toad/eye/${queue}`, payload);</code>  . <br><br>  A continuaci√≥n, publicamos sobre el tema, que tambi√©n se forma sobre la base de atributos de datos.  Este es todo nuestro c√≥digo JS en el navegador. <br><br><h2>  C√≥digo de la Junta </h2><br>  Cuando se inicia la ranura de Wi-Fi, se suscribe a los temas de inter√©s y recibe los datos.  Cuando llegan, la ranura responde y hace que los motores funcionen. <br><br><img src="https://habrastorage.org/webt/5r/7h/it/5r7hit4db5ds9369m2fgmsua8t4.jpeg"><br><br>  El c√≥digo en el tablero se divide convencionalmente en varias partes.  Para comenzar, estamos conectando bibliotecas.  En particular, esta es solo la <strong>biblioteca que ejecuta Servo</strong> para no recordar detalles.  Est√°n en el √°mbito de amperka. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ssid = <span class="hljs-string"><span class="hljs-string">"Droidxx"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> password = <span class="hljs-string"><span class="hljs-string">"****"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> brokerHostname = <span class="hljs-string"><span class="hljs-string">"toad.amperka.ru"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> leftEye = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"@amperka/servo"</span></span>).connect(A5); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> rightEye = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"@amperka/servo"</span></span>).connect(A7).</code> </pre> <br>  Todos pueden crear y publicar sus propias bibliotecas.  Hemos creado varias docenas para nuestros propios m√≥dulos y otros populares.  Todo de c√≥digo abierto: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">entra, √∫salo</a> . <br><br>  Luego, necesitamos <strong>bibliotecas para trabajar con agentes de Wi-Fi y MQTT</strong> . <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> wifi = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"Wifi"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> mqtt = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"tinyMQTT"</span></span>).create(brokerHostname);</code> </pre> <br>  No hay sistema operativo, por lo que incluso conectarse a Wi-Fi es una operaci√≥n manual.  El cuidado de la conexi√≥n es tuyo, pero no es tan dif√≠cil.  Para conectarse a la red, simplemente llamamos al m√©todo "conectar", que, si tiene √©xito o no, llamar√° a "devoluci√≥n de llamada" e informar√° los resultados de la operaci√≥n. <br><br><pre> <code class="javascript hljs">wifi.connect(ssid, { <span class="hljs-attr"><span class="hljs-attr">password</span></span>: password }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Error connecting:"</span></span>, e); wifi.disconnect(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Wi-Fi OK, connecting to broker ..."</span></span>); mqtt.connect(); } });</code> </pre> <br>  Si todo est√° bien, con√©ctese al agente MQTT. <br><br>  Tras una conexi√≥n exitosa, nos suscribimos a temas interesantes, es decir, todo lo que comienza con sapo / ojo. <br><br><pre> <code class="javascript hljs">mqtt.on(<span class="hljs-string"><span class="hljs-string">"connected"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ mqtt.subscribe(<span class="hljs-string"><span class="hljs-string">"toad/eye/*"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Connected to broker"</span></span>, brokerHostname); });</code> </pre> <br>  Cuando recibimos un mensaje, descubrimos de d√≥nde vino.  Esto es muy similar a un an√°lisis de URL simple.  Dependiendo del tema, decidimos en qu√© ojo influiremos.  Si obtiene algo consciente, entonces en este ojo escribimos lo que vino en "carga √∫til" en microsegundos. <br><br><pre> <code class="javascript hljs">mqtt.on(<span class="hljs-string"><span class="hljs-string">"message"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">msg</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> eye = (msg.topic === <span class="hljs-string"><span class="hljs-string">"toad/eye/left"</span></span>) ? leftEye : (msg.topic === <span class="hljs-string"><span class="hljs-string">"toad/eye/right"</span></span>) ? rightEye : <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (eye) { eye.write(<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>(msg.message), <span class="hljs-string"><span class="hljs-string">"us"</span></span>); } });</code> </pre> <br>  Esa es toda la magia de una rana. <br><br><h2>  Limitaciones de Espruino JS </h2><br>  Repasamos la plataforma Espruino.  Retorcer las ranas no es su √∫nica opci√≥n.  Pero la plataforma tiene sus propios baj√≠os, lo que nos hace considerar otras opciones. <br><br>  <strong>"Total" 1‚Äì4 Mb de RAM</strong> .  Hay una limitaci√≥n en la RAM.  En el c√≥digo y los datos al mismo tiempo, solo se dan unos pocos megabytes.  Puede parecer que en una era en la que los conciertos miden la RAM, esto no es suficiente.  Pero para un grupo de dispositivos peque√±os esto es suficiente.  A 2 Mb puedes hacer cosas maravillosas, suficientes para la fuente. <br><br>  <strong>No es tan simple con NPM</strong> .  Este problema se aplica al IDE de Espruino.  Si escribimos "require", Espruino busca en un lugar, en otro, y si no, produce un retroceso en NPM.  En este punto, puede disminuir la velocidad.  Espruino no siempre puede lidiar con paquetes complejos.  Su poder en este sentido es mucho m√°s bajo que el del mismo paquete web o paquete.  Esto es una molestia, pero si configura la cadena de herramientas usted mismo, con una comprensi√≥n de lo que est√° sucediendo dentro de la plancha, entonces no hay problema. <br><br>  <strong>Surtido de hierro.</strong>  No todas las piezas de hardware llamadas plataformas de desarrollo extraer√°n a Espruino.  Seg√∫n los est√°ndares del mundo de los microcontroladores, Espruino es voraz: necesita 500 Kb de RAM.  Este recuerdo no dar√° ninguna pieza de hierro.  El can√≥nico Arduino Uno o Arduino Nano tiene solo 2 Kb de RAM, por lo tanto, es imposible all√≠.  Es posible trabajar con Espruino en hardware, lo que hacemos en el hardware oficial de Espruino. <br><br><img src="https://habrastorage.org/webt/gb/fx/9-/gbfx9-t4nskmti1hepnxlkz-lx0.png"><br><br>  Espruino es una compa√±√≠a unipersonal que a menudo va a Kickstarter con nuevos productos y siempre recolecta con √©xito.  Si desea apoyar la plataforma, compre oficialmente. <br><br>  Hay una tercera opci√≥n: tomar un devboard suficientemente potente pero de terceros.  Por ejemplo, la empresa ST, que produce "Nuclear" y "Discovery".  Es probable que el hierro etiquetado como STM32 tire del Espruino. <br><br>  Repasemos dos opciones alternativas.  El primero es el Raspberry Pi. <br><br><h2>  Raspberry pi </h2><br><blockquote>  Esta es una computadora Linux completa del tama√±o de una tarjeta de negocios. </blockquote><br><br><img src="https://habrastorage.org/webt/y_/af/ws/y_afwsgmlr9e7fvkesyrwlvobak.jpeg"><br><br>  Adem√°s, hay pines de entrada / salida.  Si tiene Raspberry Pi a su disposici√≥n, use la siguiente topolog√≠a de dispositivo. <br><br><img src="https://habrastorage.org/webt/if/1a/jf/if1ajfsmxsvwwcap7ac_cpu8i2k.jpeg"><br><br>  Aqu√≠ la nube es opcional: un dispositivo m√≥vil puede conectarse directamente al dispositivo a trav√©s del nombre de host, API o un sistema para detectar autom√°ticamente un dispositivo en la red.  Tengo un televisor inteligente y un disco duro de respaldo en casa.  Son accesibles desde todos los dem√°s dispositivos simplemente porque est√°n en la misma LAN. <br><br>  El principio es el mismo.  Coloque el dispositivo en la Raspberry Pi en la red y cree el cliente para que se conecte directamente a √©l a trav√©s de HTTP o WebSocket, sin pasar por intermediarios.  La nube utiliza la aplicaci√≥n en Raspberry Pi para sus prop√≥sitos: registra sensores o transmite pron√≥sticos del tiempo. <br><br>  La siguiente topolog√≠a posible con un backend completo. <br><br><img src="https://habrastorage.org/webt/if/1a/jf/if1ajfsmxsvwwcap7ac_cpu8i2k.jpeg"><br><br>  El servidor se eleva en la nube.  Su cliente es la misma aplicaci√≥n m√≥vil que mantiene una conexi√≥n a trav√©s de HTTP o WebSocket.  Por otro lado, la conexi√≥n ya se mantiene a trav√©s de Raspberry Pi, usando HTTP o el mismo MQTT. <br><br>  En este enfoque, la ventaja es el control total: validaci√≥n, autorizaci√≥n, negaci√≥n a los clientes.  Al mismo tiempo, la disponibilidad mundial es un dispositivo en Mosc√∫, y la comunicaci√≥n con √©l est√° disponible desde Vladivostok. <br><br><h3>  Limitaciones de Raspberry Pi </h3><br>  <strong>Larga carga.</strong>  Raspberry Pi es una computadora completa y toma tiempo iniciarla.  Como disco duro, se utiliza una tarjeta SD.  Incluso la tarjeta m√°s r√°pida a√∫n pierde un HDD normal, sin mencionar el SSD.  Con el tiempo, la carga se acerca a un minuto. <br><br>  <strong>El siguiente inconveniente es el consumo de energ√≠a</strong> .  En t√©rminos de eficiencia energ√©tica, hablemos de Raspberry Pi como dispositivo m√≥vil.  La bater√≠a no durar√° mucho: la factura se va al reloj.  Para que el dispositivo funcione durante seis meses o un a√±o, se requiere un programa competente para el microcontrolador y un conjunto de bater√≠as. <br><br>  <strong>El pobre GPIO es de entrada / salida de prop√≥sito general</strong> .  Las caracter√≠sticas de alimentaci√≥n de onda, lectura de onda, trabajo con se√±ales anal√≥gicas en Raspberry Pi son mucho m√°s d√©biles que las de los microcontroladores, para lo cual esta es la tarea principal.  Por ejemplo, fuera de la caja en una Raspberry Pi, no ser√° posible controlar el servo en modo hardware. <br><br><img src="https://habrastorage.org/webt/0r/sz/oj/0rszojmbxar2o-zhp26divehxj4.jpeg"><br><br>  La restricci√≥n es condicional, ya que puede ser burlada por la extensi√≥n.  Por ejemplo, la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pieza de</a> hierro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Troyka Cap</a> , que toma todo el control de bajo nivel de trabajar con se√±ales en s√≠ mismo.  Raspberry Pi se comunica con ella a trav√©s de un paquete de alto nivel.  Da comandos para torcer el servo y funciona.  Con estas tarjetas de expansi√≥n, puede conectar lo que desee. <br><br><h2>  Arduino </h2><br>  Puedes tomar el <strong>Arduino</strong> habitual, del que todos est√°n cansados.  Pero JavaScript tendr√° que moverse a alg√∫n lugar que pueda convertir el Nodo JS, una computadora vieja o la misma Raspberry Pi. <br><br><img src="https://habrastorage.org/webt/fc/z2/gx/fcz2gxhtqtz7gsoqbopfki6tlqm.jpeg"><br><br>  Conectamos una vieja computadora innecesaria a Arduino a trav√©s de un cable USB.  En Arduino, complete el firmware est√°ndar de <a href="">Firmata</a> una <a href="">vez</a> .  Ella convierte a Arduino en un zombie que sigue las instrucciones de un maestro: una computadora vieja.  El maestro dice que transmita tal y tal se√±al a tal y tal pin, y Arduino transmite. <br><br>  Para la comunicaci√≥n, se utilizan bibliotecas con NPM: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">SerialPort</a> y Firmata con una API clara.  Entonces, nuevamente est√°s en el mundo JS, escribiendo un programa de alto nivel que env√≠as a tu servidor.  Conf√≠as en Arduino para trabajar con se√±ales, y ella lo realiza. <br><br>  No siempre con Firmata lograr√° administrar todo.  Es capaz de proporcionar interacci√≥n con el hardware para el que est√° destinado: servos, tiras de LED, controladores de medios.  Pero si no se incorpora la capacidad de leer un giroscopio o aceler√≥metro muy espec√≠fico, no funcionar√°.  Luego tienes que escribir un programa en C en un Arduino normal. <br><br>  Pero eso no es todo: si no desea escribir en C, use la herramienta de c√≥digo abierto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">XOD.io.</a> <br><br><img src="https://habrastorage.org/webt/-p/-9/j0/-p-9j0ex1ngdm7pfdq-lv5dej9u.jpeg"><br><br>  Este es un entorno de programaci√≥n visual donde el gr√°fico que est√° creando se convierte en c√≥digo, y ya puede compilarlo y completarlo.  XOD.io permite a las personas que no est√°n familiarizadas con las complejidades y los matices de la programaci√≥n de microcontroladores crear r√°pidamente programas simples.  Si creci√≥ de Firmata, pero a√∫n no siente la fuerza para escribir en un nivel bajo, use XOD.io. <br><br><blockquote>  La pr√≥xima conferencia <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">FrontendConf</a> se llevar√° a cabo en octubre.  Si conoce JavaScript que la mayor√≠a de los desarrolladores front-end no conocen, desarrolle interfaces que sean convenientes de usar o encuentre el rendimiento b√°sico y est√© listo para decir d√≥nde est√°, estamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">esperando solicitudes</a> de informes. <br><br>  Recopilamos informes interesantes en el programa, noticias de la conferencia, videos y art√≠culos en el bolet√≠n regular: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">suscr√≠base</a> . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/450826/">https://habr.com/ru/post/450826/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../450816/index.html">Encabezados HTTP para el desarrollador responsable</a></li>
<li><a href="../450818/index.html">Desde alta latencia de ceph hasta parche de kernel con eBPF / BCC</a></li>
<li><a href="../450820/index.html">Comit√© del programa FrontendConf: marcos, horizontes, experiencia mundial y misi√≥n de la conferencia.</a></li>
<li><a href="../450822/index.html">Marcos desaparecidos</a></li>
<li><a href="../450824/index.html">El estado de css</a></li>
<li><a href="../450828/index.html">Cuando la ciudad se duerme ...</a></li>
<li><a href="../450830/index.html">Nikita Dubko sobre conferencias, s√≠ndrome de impostor y reportajes</a></li>
<li><a href="../450832/index.html">La historia de una animaci√≥n.</a></li>
<li><a href="../450834/index.html">An√°lisis de sitios, ¬øy es generalmente legal en Rusia?</a></li>
<li><a href="../450836/index.html">En rieles detr√°s de las nubes: c√≥mo lavar el vidrio en un rascacielos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>