<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ôøÔ∏è üîñ üë©üèº‚Äçüè´ Otra raz√≥n por la que los contenedores Docker se ralentizan üéüÔ∏è üë§ üè¥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En la √∫ltima publicaci√≥n, habl√© sobre Kubernetes, c√≥mo ThoughtSpot lo usa para sus propias necesidades de soporte de desarrollo. Hoy me gustar√≠a conti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Otra raz√≥n por la que los contenedores Docker se ralentizan</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/429788/"><p>  En la √∫ltima <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">publicaci√≥n,</a> habl√© sobre Kubernetes, c√≥mo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ThoughtSpot lo</a> usa para sus propias necesidades de soporte de desarrollo.  Hoy me gustar√≠a continuar la conversaci√≥n sobre un breve, pero a partir de ese no menos interesante historial de depuraci√≥n, que ocurri√≥ recientemente.  El art√≠culo se basa en el hecho de que containerizaci√≥n! = Virtualizaci√≥n.  Adem√°s, se muestra c√≥mo los procesos en contenedores compiten por los recursos incluso con restricciones √≥ptimas en cgroup y alto rendimiento de la m√°quina. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/297/09a/dfa/29709adfa1fa1830ee869e441e343fcf.png" alt="imagen"></p><a name="habracut"></a><br><p> Anteriormente, lanzamos una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">serie de operaciones relacionadas con el desarrollo de b CI / CD</a> en el cl√∫ster interno de Kubernetes.  Todo estar√≠a bien, pero cuando inicia una aplicaci√≥n "acoplada", el rendimiento de repente cae dr√°sticamente.  No √©ramos taca√±os: en cada uno de los contenedores hab√≠a limitaciones en el poder de c√≥mputo y la memoria (5 CPU / 30 GB de RAM) configurados a trav√©s de la configuraci√≥n del Pod.  En una m√°quina virtual con tales par√°metros, todas nuestras solicitudes de un peque√±o conjunto de datos (10 Kb) para pruebas volar√≠an.  Sin embargo, en Docker &amp; Kubernetes con 72 CPU / 512 GB de RAM, logramos lanzar 3-4 copias del producto, y luego comenzaron los frenos.  Las solicitudes que sol√≠an completarse en un par de milisegundos ahora se bloquearon durante 1-2 segundos, y esto caus√≥ todo tipo de fallas en la canalizaci√≥n de tareas de CI.  Tuve que tratar de cerca con la depuraci√≥n. </p><br><p>  Como regla general, se sospecha todo tipo de errores de configuraci√≥n al empaquetar una aplicaci√≥n en Docker.  Sin embargo, no encontramos nada que pudiera causar al menos alg√∫n tipo de desaceleraci√≥n (en comparaci√≥n con las instalaciones en hardware desnudo o m√°quinas virtuales).  Todo parece estar bien.  Luego, probamos todo tipo de pruebas del paquete <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Sysbench</a> .  Verificamos el rendimiento de la CPU, el disco y la memoria: todo era igual que en metal desnudo.  Algunos servicios de nuestro producto almacenan informaci√≥n detallada sobre todas las acciones: luego se puede usar para perfilar el rendimiento.  Como regla general, cuando hay una escasez de un recurso (CPU, RAM, disco, red) en algunas llamadas, se observa una falla significativa en el tiempo, por lo que descubrimos qu√© se ralentiza exactamente y d√≥nde.  Sin embargo, no pas√≥ nada en este caso.  Las proporciones temporales no difer√≠an de la configuraci√≥n de trabajo, con la √∫nica diferencia de que cada llamada era mucho m√°s lenta que en metal desnudo.  Nada indica la fuente real del problema.  Est√°bamos listos para rendirnos cuando de repente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">encontramos esto</a> . </p><br><p>  En este art√≠culo, el autor analiza un caso misterioso similar cuando dos, en principio, procesos ligeros se matan entre s√≠ cuando se ejecutan dentro de Docker en la misma m√°quina, y los l√≠mites de recursos se establecen en valores muy modestos.  Llegamos a dos conclusiones importantes: </p><br><ol><li> La raz√≥n principal radica en el n√∫cleo de Linux.  Debido a la estructura de los objetos de cach√© de dentry en el kernel, el comportamiento de un proceso ralentiz√≥ la <code>__d_lookup_loop</code> kernel <code>__d_lookup_loop</code> , lo que afect√≥ directamente el rendimiento de otro. </li><li>  El autor utiliz√≥ <code>perf</code> para detectar errores en el n√∫cleo.  Una gran herramienta de depuraci√≥n que nunca hemos usado antes (¬°lo cual es una pena!). </li></ol><br><blockquote>  perf (a veces llamado perf_events o herramientas de perf; anteriormente conocido como Performance Counters for Linux, PCL) es una herramienta de an√°lisis de rendimiento de Linux disponible desde la versi√≥n del kernel 2.6.31.  La utilidad de gesti√≥n de espacio de usuario, perf, est√° disponible desde la l√≠nea de comandos y es una colecci√≥n de subcomandos. </blockquote><br><blockquote>  Realiza perfiles estad√≠sticos de todo el sistema (kernel y espacio de usuario).  Esta herramienta admite plataformas de contadores de rendimiento de hardware y software (por ejemplo, hrtimer), puntos de rastreo y muestras din√°micas (por ejemplo, kprobes o uprobes).  En 2012, dos ingenieros de IBM reconocieron a perf (junto con OProfile) como una de las dos herramientas de perfilado de contador de rendimiento m√°s utilizadas en Linux. </blockquote><p>  Entonces pensamos: ¬øquiz√°s tengamos lo mismo?  Comenzamos cientos de procesos diferentes en contenedores, y todos ten√≠an el mismo n√∫cleo.  ¬°Sentimos que hab√≠amos atacado el camino!  Armados con <code>perf</code> , <code>perf</code> la depuraci√≥n, y al final est√°bamos esperando el descubrimiento m√°s interesante. </p><br><p>  A continuaci√≥n se muestran las entradas de <code>perf</code> de los primeros 10 segundos de ThoughtSpot ejecut√°ndose en una m√°quina saludable (r√°pida) (izquierda) y dentro del contenedor (derecha). <br><img src="https://habrastorage.org/getpro/habr/post_images/82a/5a4/2a3/82a5a42a3c8de024901a4d21108469a4.png" alt="imagen"></p><br><p>  Est√° claro de inmediato que a la derecha las primeras 5 llamadas est√°n conectadas con el n√∫cleo.  El tiempo se dedica principalmente al espacio del kernel, mientras que a la izquierda, la mayor parte del tiempo se dedica a nuestros propios procesos que se ejecutan en el espacio del usuario.  Pero lo m√°s interesante es que la llamada <code>posix_fadvise</code> toma todo el tiempo. </p><br><blockquote>  Los programas usan posix_fadvise (), declarando su intenci√≥n de acceder a los datos del archivo de acuerdo con un patr√≥n espec√≠fico en el futuro.  Esto le da al n√∫cleo la oportunidad de llevar a cabo la optimizaci√≥n necesaria. </blockquote><p>  La llamada se usa para cualquier situaci√≥n, por lo tanto, no indica la fuente del problema expl√≠citamente.  Sin embargo, al profundizar en el c√≥digo, encontr√© solo un lugar que, en teor√≠a, afectaba a todos los procesos del sistema: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/12d/2ef/c14/12d2efc144b5e9e9babfb05180726c7b.png" alt="imagen"></p><br><p>  Esta es una biblioteca de registro de terceros llamada <code>glog</code> .  Lo usamos para el proyecto.  Espec√≠ficamente, esta l√≠nea (en <code>LogFileObject::Write</code> ) es probablemente la ruta m√°s cr√≠tica de toda la biblioteca.  Se llama a todos los eventos "registro a archivo" (registro a archivo), y muchas instancias de nuestro producto registran con bastante frecuencia.  Un vistazo r√°pido al c√≥digo fuente sugiere que la parte fadvise se puede desactivar configurando el par√°metro <code>--drop_log_memory=false</code> : </p><br><pre> <code class="hljs php"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (file_length_ &gt;= logging::kPageSize) { <span class="hljs-comment"><span class="hljs-comment">// don't evict the most recent page uint32 len = file_length_ &amp; ~(logging::kPageSize ‚Äî 1); posix_fadvise(fileno(file_), 0, len, POSIX_FADV_DONTNEED); } }</span></span></code> </pre> <br><p>  lo cual, por supuesto, hicimos y ... ¬°en la diana! </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/07c/945/bb2/07c945bb2d23ede3c4bf64823120d2a3.png" alt="imagen"></p><br><p>  Lo que sol√≠a tomar un par de segundos ahora se hace en <b>8</b> (¬°ocho!) Milisegundos.  Un poco en Google, encontramos esto: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://issues.apache.org/jira/browse/MESOS-920</a> y tambi√©n esto: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/google/glog/pull/145</a> , que una vez m√°s confirm√≥ nuestra corazonada sobre la verdadera causa de la inhibici√≥n.  Lo m√°s probable es que sucediera lo mismo en la m√°quina virtual / bare metal, pero como ten√≠amos 1 copia del proceso por m√°quina / kernel, la intensidad de la llamada de Fadvise era mucho menor, lo que explicaba la falta de consumo de recursos adicionales.  Al aumentar los procesos de registro en 3-4 veces y resaltar un n√∫cleo com√∫n para ellos, vimos que realmente se estanc√≥. </p><br><p>  Y en conclusi√≥n: </p><br><p>  Esta informaci√≥n no es nueva, pero por alguna raz√≥n muchas personas olvidan lo principal: en casos con contenedores, los procesos "aislados" compiten por <b>todos los recursos centrales</b> , y no solo por <b>CPU</b> , <b>RAM</b> , <b>espacio en disco</b> y <b>red</b> .  Y dado que el n√∫cleo es una estructura extremadamente compleja, pueden producirse bloqueos en cualquier lugar (como, por ejemplo, en <code>__d_lookup_loop</code> del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo de Sysdig</a> ).  Sin embargo, esto no significa que los contenedores sean peores o mejores que la virtualizaci√≥n tradicional.  Son una excelente herramienta que resuelve sus tareas.  Solo recuerde: el n√∫cleo es un recurso compartido y prep√°rese para depurar conflictos inesperados en el espacio del n√∫cleo.  Adem√°s, tales conflictos son una gran oportunidad para que los atacantes rompan el aislamiento "reducido" y creen canales ocultos entre los contenedores.  Y finalmente, hay <code>perf</code> : una excelente herramienta que mostrar√° lo que est√° sucediendo en el sistema y ayudar√° a depurar cualquier problema de rendimiento.  Si planea ejecutar aplicaciones altamente cargadas en Docker, aseg√∫rese de tomarse el tiempo para aprender <code>perf</code> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es429788/">https://habr.com/ru/post/es429788/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es429776/index.html">Sinopsis del informe "Monolito para cientos de versiones de clientes" (HL2018, Badoo, Vladimir Yants)</a></li>
<li><a href="../es429778/index.html">Concepto de interfaz de voz del sistema inform√°tico para ayudar a las personas con impedimentos del habla</a></li>
<li><a href="../es429780/index.html">Modern C ++! = (La mayor√≠a) Nuevo est√°ndar</a></li>
<li><a href="../es429782/index.html">La historia de c√≥mo aceleramos las pruebas 12 veces</a></li>
<li><a href="../es429786/index.html">Fast Sin y Cos en ASM integrado para Delphi</a></li>
<li><a href="../es429790/index.html">Julia y el movimiento de una part√≠cula cargada en un campo electromagn√©tico</a></li>
<li><a href="../es429792/index.html">La inteligencia artificial basada en la f√≠sica puede inferir las leyes de los universos imaginarios.</a></li>
<li><a href="../es429794/index.html">Google habla sobre el crecimiento exponencial de la IA que cambia la naturaleza misma de la inform√°tica</a></li>
<li><a href="../es429796/index.html">C√≥mo DeviceLock DLP previene las fugas de datos confidenciales en GitHub</a></li>
<li><a href="../es429798/index.html">Ventas de veh√≠culos el√©ctricos enchufables en los Estados Unidos (con gr√°ficos): octubre de 2018</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>