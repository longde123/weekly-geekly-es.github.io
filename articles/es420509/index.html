<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title> 梆  Un problema obvio con el uso de afirmar   硷</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Las pruebas unitarias son una parte importante de cualquier proyecto lo suficientemente grande. Quiero compartir con ustedes una peque帽a historia de d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Un problema obvio con el uso de afirmar</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/420509/">  Las pruebas unitarias son una parte importante de cualquier proyecto lo suficientemente grande.  Quiero compartir con ustedes una peque帽a historia de detectives relacionada con su ca铆da en masa no obvia. <br><br>  Comienza con el hecho de que, como resultado de un cierto compromiso inofensivo, alrededor de 150 pruebas cayeron en el proyecto, mientras que el conjunto de pruebas de ca铆da no fue estable.  Las pruebas no estaban interconectadas, las pruebas se realizaron secuencialmente.  La base de datos h2 en memoria se utiliza como fuente de datos para las pruebas.  La ca铆da de la gran mayor铆a de estas 150 pruebas estuvo acompa帽ada por un error en el registro: "No se puede obtener una conexi贸n, error de agrupaci贸n Tiempo de espera en espera de objeto inactivo".  Debe decirse que el tama帽o del grupo de conexiones al realizar pruebas en el proyecto es 1. <br><a name="habracut"></a><br>  Una peque帽a digresi贸n l铆rica: en el c贸digo del proyecto, la transacci贸n se desconecta del flujo peri贸dicamente, luego el c贸digo se ejecuta en una transacci贸n separada y, finalmente, la transacci贸n se vincula.  Para tales casos, se ha escrito una clase auxiliar, cuyo uso se parece a esto: <br><br><pre><code class="java hljs">TransactionRunner.run(dbDataManager(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MethodTransaction() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ExecutionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runInTransaction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ,       return result; } );</span></span></code> </pre> <br>  Como resultado del an谩lisis, se revel贸 que el error comienza a aparecer despu茅s de una prueba fallida que contiene una llamada de c贸digo en una transacci贸n: <br><br><pre> <code class="java hljs">TransactionRunner.run(dbDataManager(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MethodTransaction() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ExecutionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runInTransaction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ...   // assert   assert( 1, result.getSomeNotEqualOneIntValue() ); return result; } );</span></span></code> </pre> <br>  Eche un vistazo dentro de la clase TransactionRunner, una llamada al m茅todo conduce al siguiente c贸digo: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> ExecutionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> CommonException </span></span>{ Transaction outerTr = getThreadTransaction(); bindThreadTransaction(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { beginTransaction(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { setResult(transactionCode.runInTransaction()); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { dbDataManager().rollbackTransaction(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (transaction.onException(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, e)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> e; } dbDataManager().commitTransaction(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getResult(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> ExceptionUtil.createCommonException(e); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { bindThreadTransaction(outerTr); } }</code> </pre> <br>  Entonces, 驴cu谩l es el problema aqu铆?  Y el problema es que el AssertionError que surge como resultado de la ejecuci贸n del c贸digo de prueba no se hereda de Exception, lo que significa que la transacci贸n anidada no se revierte ni se confirma.  Dado que el tama帽o de la agrupaci贸n de conexiones es igual a uno, obtenemos el mismo error "No se puede obtener una conexi贸n, error de agrupaci贸n Se agot贸 el tiempo de espera del objeto inactivo" al intentar obtener el objeto de conexi贸n mediante pruebas posteriores. <br><br>  Moraleja: es necesario colocar las afirmaciones en las pruebas con precauci贸n, y en el caso de fallas no obvias y, en particular, masivas, una de las soluciones es verificar si el manejo de excepciones tiene en cuenta los objetos que no se heredan de Exception. <br><br>  El caso me pareci贸 digno de arreglo, tal vez esta experiencia sea 煤til para alguien. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es420509/">https://habr.com/ru/post/es420509/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es420499/index.html">Anatom铆a de los sistemas de recomendaci贸n. Primera parte</a></li>
<li><a href="../es420501/index.html">Linux en RAM: debirf way 2018</a></li>
<li><a href="../es420503/index.html">JS Developer Day, diferentes ciudades y comunidades: un d铆a festivo</a></li>
<li><a href="../es420505/index.html">OpenAI Five ganar谩 el equipo profesional en The International</a></li>
<li><a href="../es420507/index.html">Antecedentes: Internet global para todos y sus creadores.</a></li>
<li><a href="../es420511/index.html">Trabajar como especialista en TI en el Lejano Oriente - Regi贸n de Amur</a></li>
<li><a href="../es420513/index.html">Una copia pirateada de un servicio pago en 39 l铆neas de c贸digo Python</a></li>
<li><a href="../es420515/index.html">Diarizaci贸n basada en el modelo GMM-UBM y el algoritmo de adaptaci贸n MAP</a></li>
<li><a href="../es420517/index.html">Implementaci贸n FPGA Integer FFT</a></li>
<li><a href="../es420519/index.html">Popularizaci贸n de la ciencia.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>