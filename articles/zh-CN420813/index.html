<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>â™ˆï¸ ğŸ‘©ğŸ¾â€ğŸ¤â€ğŸ‘¨ğŸ¼ ğŸ˜ª Kubernetesçš„åå°ç½‘ç»œ ğŸš´ğŸ¾ ğŸ‘« ğŸ‘©ğŸ½â€ğŸ¤â€ğŸ‘¨ğŸ¼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æ³¨æ„äº‹é¡¹ ä½©é›·å¤« ï¼šåŸå§‹æ–‡ç« çš„ä½œè€…Nicolas Leivaæ˜¯ä¸€ä½æ€ç§‘è§£å†³æ–¹æ¡ˆæ¶æ„å¸ˆï¼Œä»–å†³å®šä¸ä»–çš„åŒè¡Œç½‘ç»œå·¥ç¨‹å¸ˆåˆ†äº«Kubernetesç½‘ç»œåœ¨å†…éƒ¨çš„å·¥ä½œæ–¹å¼ã€‚ ä¸ºæ­¤ï¼Œä»–ç§¯æåˆ©ç”¨å¸¸è¯†ï¼Œç½‘ç»œçŸ¥è¯†å’Œæ ‡å‡†Linux / Kuberneteså®ç”¨ç¨‹åºï¼Œæ¢ç´¢äº†é›†ç¾¤ä¸­æœ€ç®€å•çš„é…ç½®ã€‚ ç»“æœå¾ˆå¤šï¼Œä½†æ˜¯å¾ˆæ¸…æ¥šã€‚ 


...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Kubernetesçš„åå°ç½‘ç»œ</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/420813/">  <i><b>æ³¨æ„äº‹é¡¹</b></i>  <i><b>ä½©é›·å¤«</b></i>  <i>ï¼šåŸå§‹æ–‡ç« çš„ä½œè€…Nicolas Leivaæ˜¯ä¸€ä½æ€ç§‘è§£å†³æ–¹æ¡ˆæ¶æ„å¸ˆï¼Œä»–å†³å®šä¸ä»–çš„åŒè¡Œç½‘ç»œå·¥ç¨‹å¸ˆåˆ†äº«Kubernetesç½‘ç»œåœ¨å†…éƒ¨çš„å·¥ä½œæ–¹å¼ã€‚</i>  <i>ä¸ºæ­¤ï¼Œä»–ç§¯æåˆ©ç”¨å¸¸è¯†ï¼Œç½‘ç»œçŸ¥è¯†å’Œæ ‡å‡†Linux / Kuberneteså®ç”¨ç¨‹åºï¼Œæ¢ç´¢äº†é›†ç¾¤ä¸­æœ€ç®€å•çš„é…ç½®ã€‚</i>  <i>ç»“æœå¾ˆå¤šï¼Œä½†æ˜¯å¾ˆæ¸…æ¥šã€‚</i> <br><br><img src="https://habrastorage.org/webt/gr/qw/d4/grqwd4putslwaijltw9yojfzjes.png"><br><br> é™¤äº†Kelsey Hightowerçš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetes The Hard Way</a>æŒ‡å—å¯ä»¥æ­£å¸¸å·¥ä½œï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç”šè‡³åœ¨AWSä¸Šï¼</a> ï¼‰ä¹‹å¤–ï¼Œæˆ‘è¿˜å–œæ¬¢ç½‘ç»œä¿æŒå¹²å‡€ç®€å•ã€‚ è¿™æ˜¯äº†è§£å®¹å™¨ç½‘ç»œæ¥å£ï¼ˆ <a href="">CNI</a> ï¼‰è§’è‰²çš„ç»ä½³æœºä¼šã€‚ è¯è™½å¦‚æ­¤ï¼Œæˆ‘è¿˜è¦è¡¥å……è¯´ï¼ŒKubernetesç½‘ç»œå®é™…ä¸Šå¹¶ä¸æ˜¯å¾ˆç›´è§‚ï¼Œå°¤å…¶æ˜¯å¯¹äºåˆå­¦è€…æ¥è¯´â€¦â€¦è€Œä¸”ä¹Ÿä¸è¦å¿˜è®°â€œæ ¹æœ¬<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å°±æ²¡æœ‰</a>å®¹å™¨ç½‘ç»œâ€ã€‚ <a name="habracut"></a><br><br> å°½ç®¡æœ‰å…³è¯¥ä¸»é¢˜çš„ææ–™å·²ç»å¾ˆä¸°å¯Œï¼ˆè¯·å‚é˜…<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ­¤å¤„çš„</a>é“¾æ¥ï¼‰ï¼Œä½†æˆ‘æ‰¾ä¸åˆ°è¿™æ ·çš„ç¤ºä¾‹ï¼Œæ— æ³•å°†æ‰€æœ‰å¿…è¦çš„å†…å®¹ä¸ç½‘ç»œå·¥ç¨‹å¸ˆå–œæ¬¢å’Œè®¨åŒçš„å›¢é˜Ÿçš„ç»“è®ºç›¸ç»“åˆï¼Œä»¥è¯´æ˜å¹•åçš„å®é™…æƒ…å†µã€‚ å› æ­¤ï¼Œæˆ‘å†³å®šä»è®¸å¤šæ¥æºæ”¶é›†ä¿¡æ¯-å¸Œæœ›è¿™å¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ï¼Œå¹¶ä¸”æ‚¨å¯ä»¥æ›´å¥½åœ°äº†è§£ä¸€åˆ‡ä¹‹é—´çš„è”ç³»ã€‚ è¿™äº›çŸ¥è¯†ä¸ä»…å¯¹æµ‹è¯•è‡ªå·±å¾ˆé‡è¦ï¼Œè€Œä¸”å¯¹ç®€åŒ–è¯Šæ–­é—®é¢˜çš„è¿‡ç¨‹ä¹Ÿå¾ˆé‡è¦ã€‚ æ‚¨å¯ä»¥ä»<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetes The Hard Wayä¸­</a>éµå¾ªé›†ç¾¤ä¸­çš„ç¤ºä¾‹ï¼šæ‰€æœ‰IPåœ°å€å’Œè®¾ç½®éƒ½ä»é‚£é‡Œè·å–ï¼ˆæˆªè‡³2018å¹´5æœˆçš„æäº¤ï¼Œä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Nablaå®¹å™¨</a>ä¹‹å‰ï¼‰ã€‚ <br><br> æˆ‘ä»¬å°†ä»å¤´å¼€å§‹ï¼Œå½“æˆ‘ä»¬æœ‰ä¸‰ä¸ªæ§åˆ¶å™¨å’Œä¸‰ä¸ªå·¥ä½œèŠ‚ç‚¹æ—¶ï¼š <br><br><img src="https://habrastorage.org/webt/am/vs/6j/amvs6jnhsuxzwhyoyod6vjk8cby.png"><br><br> æ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°ï¼Œè¿™é‡Œè‡³å°‘è¿˜æœ‰ä¸‰ä¸ªä¸“ç”¨å­ç½‘ï¼ æœ‰ç‚¹è€å¿ƒï¼Œä»–ä»¬éƒ½ä¼šè¢«è€ƒè™‘åœ¨å†…ã€‚ è¯·è®°ä½ï¼Œå³ä½¿æˆ‘ä»¬æåˆ°éå¸¸ç‰¹å®šçš„IPå‰ç¼€ï¼Œå®ƒä»¬ä¹Ÿä»…å–è‡ª<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetes The Hard Way</a> ï¼Œå› æ­¤å®ƒä»¬ä»…å…·æœ‰æœ¬åœ°æ„ä¹‰ï¼Œå¹¶ä¸”æ‚¨å¯ä»¥æ ¹æ®<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">RFC 1918</a>ä¸ºæ‚¨çš„ç¯å¢ƒè‡ªç”±é€‰æ‹©ä»»ä½•å…¶ä»–åœ°å€å—ã€‚ å¯¹äºIPv6ï¼Œå°†æœ‰å•ç‹¬çš„åšå®¢æ–‡ç« ã€‚ <br><br><h2> ä¸»æœºç½‘ç»œï¼ˆ10.240.0.0/24ï¼‰ </h2><br> è¿™æ˜¯ä¸€ä¸ªå†…éƒ¨ç½‘ç»œï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯å…¶ä¸­çš„ä¸€éƒ¨åˆ†ã€‚ åˆ†é…è®¡ç®—èµ„æºæ—¶ï¼Œç”±<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GCPä¸­</a>çš„<code>--private-network-ip</code>æ ‡å¿—æˆ–<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">AWSä¸­</a>çš„<code>--private-ip-address</code>é€‰é¡¹å®šä¹‰ã€‚ <br><br><h3> åœ¨GCPä¸­åˆå§‹åŒ–æ§åˆ¶å™¨èŠ‚ç‚¹ </h3><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0 1 2; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> gcloud compute instances create controller-<span class="hljs-variable"><span class="hljs-variable">${i}</span></span> \ <span class="hljs-comment"><span class="hljs-comment"># ... --private-network-ip 10.240.0.1${i} \ # ... done</span></span></code> </pre> <br>  ï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>controllers_gcp.sh</code></a> ï¼‰ <br><br><h3> åœ¨AWSä¸­åˆå§‹åŒ–æ§åˆ¶å™¨èŠ‚ç‚¹ </h3><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0 1 2; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">declare</span></span> controller_id<span class="hljs-variable"><span class="hljs-variable">${i}</span></span>=`aws ec2 run-instances \ <span class="hljs-comment"><span class="hljs-comment"># ... --private-ip-address 10.240.0.1${i} \ # ... done</span></span></code> </pre> <br>  ï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>controllers_aws.sh</code></a> ï¼‰ <br><br><img src="https://habrastorage.org/webt/gt/cj/p6/gtcjp6fgkqbv1nvs2ea9d9hhueo.png"><br><br> æ¯ä¸ªå®ä¾‹å°†å…·æœ‰ä¸¤ä¸ªIPåœ°å€ï¼šä¸»æœºç½‘ç»œçš„ç§æœ‰IPåœ°å€ï¼ˆæ§åˆ¶å™¨<code>10.240.0.1${i}/24</code> ï¼Œå·¥ä½œäººå‘˜<code>10.240.0.2${i}/24</code> ï¼‰ï¼‰å’Œç”±äº‘æä¾›å•†æŒ‡å®šçš„å…¬å…±IPåœ°å€ï¼Œæˆ‘ä»¬å°†åœ¨åé¢è®¨è®ºã€‚å¦‚ä½•åˆ°è¾¾<code>NodePorts</code> ã€‚ <br><br><h3> æ§åˆ¶ç‚¹ </h3><br><pre> <code class="bash hljs">$ gcloud compute instances list NAME ZONE MACHINE_TYPE PREEMPTIBLE INTERNAL_IP EXTERNAL_IP STATUS controller-0 us-west1-c n1-standard-1 10.240.0.10 35.231.XXX.XXX RUNNING worker-1 us-west1-c n1-standard-1 10.240.0.21 35.231.XX.XXX RUNNING ...</code> </pre> <br><br><h3>  ws </h3><br><pre> <code class="bash hljs">$ aws ec2 describe-instances --query <span class="hljs-string"><span class="hljs-string">'Reservations[].Instances[].[Tags[?Key==`Name`].Value[],PrivateIpAddress,PublicIpAddress]'</span></span> --output text | sed <span class="hljs-string"><span class="hljs-string">'$!N;s/\n/ /'</span></span> 10.240.0.10 34.228.XX.XXX controller-0 10.240.0.21 34.173.XXX.XX worker-1 ...</code> </pre> <br> å¦‚æœ<a href="">å®‰å…¨ç­–ç•¥æ­£ç¡®</a> ï¼ˆå¹¶ä¸”ä¸»æœºä¸Š<code>ping</code>å®‰è£…<code>ping</code> ï¼Œåˆ™æ‰€æœ‰èŠ‚ç‚¹å¿…é¡»èƒ½å¤Ÿç›¸äº’pingé€šã€‚ <br><br><h2> ç‚‰åºŠç½‘ç»œï¼ˆ10.200.0.0/16ï¼‰ </h2><br> è¿™æ˜¯Podæ‰€åœ¨çš„ç½‘ç»œã€‚ æ¯ä¸ªå·¥ä½œèŠ‚ç‚¹éƒ½ä½¿ç”¨è¯¥ç½‘ç»œçš„ä¸€ä¸ªå­ç½‘ã€‚ åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œ <code>POD_CIDR=10.200.${i}.0/24</code>å¯¹äº<code>worker-${i}</code> ã€‚ <br><br><img src="https://habrastorage.org/webt/6i/yz/ih/6iyzihbxbzwugs4amvhfa9ysp5s.png"><br><br> è¦äº†è§£æ‰€æœ‰å†…å®¹çš„é…ç½®æ–¹å¼ï¼Œè¯·é€€åä¸€æ­¥ï¼Œçœ‹çœ‹<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetesç½‘ç»œæ¨¡å‹</a> ï¼Œè¯¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ¨¡å‹</a>éœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š <br><br><ul><li> æ‰€æœ‰å®¹å™¨éƒ½å¯ä»¥åœ¨ä¸ä½¿ç”¨NATçš„æƒ…å†µä¸‹ä¸ä»»ä½•å…¶ä»–å®¹å™¨é€šä¿¡ã€‚ </li><li> æ‰€æœ‰èŠ‚ç‚¹éƒ½å¯ä»¥ä¸æ‰€æœ‰å®¹å™¨é€šä¿¡ï¼ˆåä¹‹äº¦ç„¶ï¼‰ï¼Œè€Œæ— éœ€ä½¿ç”¨NATã€‚ </li><li> å®¹å™¨çœ‹åˆ°çš„IPå¿…é¡»ä¸å…¶ä»–äººçœ‹åˆ°çš„IPç›¸åŒã€‚ </li></ul><br> æ‰€æœ‰è¿™äº›éƒ½å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼å®ç°ï¼ŒKuberneteså°†ç½‘ç»œè®¾ç½®ä¼ é€’ç»™<a href="">CNIæ’ä»¶</a> ã€‚ <br><br><blockquote>  â€œ CNIæ’ä»¶è´Ÿè´£å°†ç½‘ç»œæ¥å£æ·»åŠ åˆ°å®¹å™¨çš„<b>ç½‘ç»œåç§°ç©ºé—´</b> ï¼ˆä¾‹å¦‚ï¼Œ <b>vethå¯¹çš„</b>ä¸€ç«¯ï¼‰ï¼Œå¹¶åœ¨ä¸»æœºä¸Šè¿›è¡Œå¿…è¦çš„æ›´æ”¹ï¼ˆä¾‹å¦‚ï¼Œå°†vethçš„å¦ä¸€ç«¯è¿æ¥åˆ°ç½‘æ¡¥ï¼‰ã€‚ ç„¶åï¼Œä»–å¿…é¡»é€šè¿‡è°ƒç”¨æ‰€éœ€çš„IPAMæ’ä»¶æ¥åˆ†é…IPæ¥å£å¹¶æ ¹æ®IPåœ°å€ç®¡ç†éƒ¨åˆ†é…ç½®è·¯ç”±ã€‚â€  <i>ï¼ˆæ¥è‡ª<a href="">å®¹å™¨ç½‘ç»œæ¥å£è§„èŒƒ</a> ï¼‰</i> </blockquote><br><img src="https://habrastorage.org/webt/5q/fs/vw/5qfsvwg2iuduy0q3doco11hbf-g.png"><br><br><h3> ç½‘ç»œåç§°ç©ºé—´ </h3><br><blockquote>  â€œåç§°ç©ºé—´å°†å…¨å±€ç³»ç»Ÿèµ„æºåŒ…è£…æˆä¸€ä¸ªæŠ½è±¡ï¼Œè¯¥åç§°ç©ºé—´ä¸­çš„è¿›ç¨‹å¯ä»¥é€šè¿‡è¿™ç§æŠ½è±¡çœ‹åˆ°å®ƒä»¬ï¼Œä½¿å®ƒä»¬æ‹¥æœ‰è‡ªå·±çš„éš”ç¦»çš„å…¨å±€èµ„æºå®ä¾‹ã€‚ å…¨å±€èµ„æºä¸­çš„æ›´æ”¹å¯¹äºæ­¤åç§°ç©ºé—´ä¸­åŒ…å«çš„å…¶ä»–è¿›ç¨‹å¯è§ï¼Œä½†å¯¹å…¶ä»–è¿›ç¨‹ä¸å¯è§ã€‚â€  <i>ï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ¥è‡ªåç§°ç©ºé—´æ‰‹å†Œé¡µ</a> ï¼‰</i> </blockquote><br>  Linuxæä¾›äº†ä¸ƒä¸ªä¸åŒçš„åç§°ç©ºé—´ï¼ˆ <code>Cgroup</code> ï¼Œ <code>IPC</code> ï¼Œ <code>Network</code> ï¼Œ <code>Mount</code> ï¼Œ <code>PID</code> ï¼Œ <code>User</code> ï¼Œ <code>UTS</code> ï¼‰ã€‚ ç½‘ç»œåç§°ç©ºé—´ï¼ˆ <code>CLONE_NEWNET</code> ï¼‰å®šä¹‰äº†è¯¥è¿‡ç¨‹å¯è®¿é—®çš„ç½‘ç»œèµ„æºï¼šâ€œæ¯ä¸ªç½‘ç»œåç§°ç©ºé—´éƒ½æœ‰è‡ªå·±çš„ç½‘ç»œè®¾å¤‡ï¼ŒIPåœ°å€ï¼ŒIPè·¯ç”±è¡¨ï¼Œ <code>/proc/net</code>ç›®å½•ï¼Œç«¯å£å·ç­‰â€ <i>ï¼ˆæ‘˜è‡ªâ€œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ“ä½œä¸­çš„å‘½åç©ºé—´</a> â€ä¸€æ–‡</i> ã€‚ <br><br><h3> è™šæ‹Ÿä»¥å¤ªç½‘è®¾å¤‡ï¼ˆVethï¼‰ </h3><br><blockquote>  â€œè™šæ‹Ÿç½‘ç»œå¯¹ï¼ˆvethï¼‰ä»¥â€œç®¡é“â€çš„å½¢å¼æä¾›æŠ½è±¡ï¼Œå¯ç”¨äºåœ¨ç½‘ç»œåç§°ç©ºé—´ä¹‹é—´åˆ›å»ºéš§é“æˆ–åœ¨å¦ä¸€ä¸ªç½‘ç»œç©ºé—´ä¸­åˆ›å»ºåˆ°ç‰©ç†ç½‘ç»œè®¾å¤‡çš„æ¡¥æ¥ã€‚ é‡Šæ”¾å‘½åç©ºé—´åï¼Œå…¶ä¸­çš„æ‰€æœ‰vethè®¾å¤‡éƒ½å°†è¢«é”€æ¯ã€‚â€  <i>ï¼ˆæ¥è‡ª<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç½‘ç»œåç§°ç©ºé—´æ‰‹å†Œé¡µ</a> ï¼‰</i> </blockquote><br> æ·±å…¥åœ°é¢ï¼Œçœ‹çœ‹å®ƒä»¬ä¸é›†ç¾¤ä¹‹é—´çš„å…³ç³»ã€‚ é¦–å…ˆï¼ŒKubernetesä¸­çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç½‘ç»œæ’ä»¶</a>æ˜¯å¤šç§å¤šæ ·çš„ï¼Œè€ŒCNIæ’ä»¶å°±æ˜¯å…¶ä¸­ä¹‹ä¸€ï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¸ºä»€ä¹ˆä¸æ˜¯CNMï¼Ÿ</a> ï¼‰ã€‚ æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubelet</a>å‘Šè¯‰å®¹å™¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¿è¡Œæ—¶ä½¿ç”¨</a>å“ªä¸ª<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç½‘ç»œæ’ä»¶</a> ã€‚ å®¹å™¨ç½‘ç»œæ¥å£ï¼ˆ <a href="">CNI</a> ï¼‰åœ¨å®¹å™¨è¿è¡Œæ—¶å’Œç½‘ç»œå®ç°ä¹‹é—´ã€‚  CNIæ’ä»¶å·²ç»å»ºç«‹äº†ç½‘ç»œã€‚ <br><br><blockquote>  â€œé€šè¿‡å°†å‘½ä»¤è¡Œ<code>--network-plugin=cni</code>ä¼ é€’ç»™Kubeletï¼Œå¯ä»¥é€‰æ‹©CNIæ’ä»¶ã€‚  Kubeletä»<code>--cni-conf-dir</code> ï¼ˆé»˜è®¤å€¼ä¸º<code>/etc/cni/net.d</code> ï¼‰ä¸­è¯»å–æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨è¯¥æ–‡ä»¶ä¸­çš„CNIé…ç½®ä¸ºæ¯ä¸ªæ–‡ä»¶é…ç½®ç½‘ç»œã€‚  <i>ï¼ˆæ ¹æ®<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç½‘ç»œæ’ä»¶è¦æ±‚</a> ï¼‰</i> </blockquote><br>  CNIæ’ä»¶çš„çœŸå®äºŒè¿›åˆ¶æ–‡ä»¶ä½äº<code>-- cni-bin-dir</code> ï¼ˆé»˜è®¤å€¼ä¸º<code>/opt/cni/bin</code> ï¼‰ã€‚ <br><br> è¯·æ³¨æ„ï¼Œ <a href=""><code>kubelet.service</code></a>è°ƒç”¨<a href=""><code>kubelet.service</code></a>åŒ…æ‹¬<code>--network-plugin=cni</code> ï¼š <br><br><pre> <code class="plaintext hljs">[Service] ExecStart=/usr/local/bin/kubelet \\ --config=/var/lib/kubelet/kubelet-config.yaml \\ --network-plugin=cni \\ ...</code> </pre> <br> é¦–å…ˆï¼Œç”šè‡³åœ¨è°ƒç”¨ä»»ä½•æ’ä»¶ä¹‹å‰ï¼ŒKuberneteséƒ½ä¼šä¸ºå£ç‚‰åˆ›å»ºä¸€ä¸ªç½‘ç»œåç§°ç©ºé—´ã€‚ è¿™æ˜¯é€šè¿‡ä½¿ç”¨ç‰¹æ®Šçš„<code>pause</code>å®¹å™¨æ¥å®ç°çš„ï¼Œè¯¥å®¹å™¨â€œå……å½“æ‰€æœ‰ç‚‰è†›å®¹å™¨çš„â€œçˆ¶å®¹å™¨â€ <i>ï¼ˆæ¥è‡ªâ€œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å…¨èƒ½æš‚åœå®¹å™¨</a> â€ä¸€æ–‡ï¼‰</i> ã€‚ ç„¶åKubernetesæ‰§è¡ŒCNIæ’ä»¶ä»¥å°†<code>pause</code>å®¹å™¨è¿æ¥åˆ°ç½‘ç»œã€‚ æ‰€æœ‰podå®¹å™¨éƒ½ä½¿ç”¨æ­¤<code>pause</code>å®¹å™¨çš„<code>netns</code> ã€‚ <br><br><pre> <code class="plaintext hljs">{ "cniVersion": "0.3.1", "name": "bridge", "type": "bridge", "bridge": "cnio0", "isGateway": true, "ipMasq": true, "ipam": { "type": "host-local", "ranges": [ [{"subnet": "${POD_CIDR}"}] ], "routes": [{"dst": "0.0.0.0/0"}] } }</code> </pre> <br>  <a href="">ç”¨äºCNI</a>çš„<a href="">é…ç½®</a>è¡¨ç¤ºä½¿ç”¨<code>bridge</code>æ’ä»¶åœ¨åä¸º<code>cnio0</code>çš„æ ¹åç§°ç©ºé—´ä¸­é…ç½®Linuxï¼ˆL2ï¼‰è½¯ä»¶ç½‘æ¡¥ï¼ˆ <a href="">é»˜è®¤åç§°</a>ä¸º<code>cni0</code> ï¼‰ï¼Œè¯¥ç½‘å…³å……å½“ç½‘å…³ï¼ˆ <code>"isGateway": true</code> ï¼‰ã€‚ <br><br><img src="https://habrastorage.org/webt/bo/to/jp/botojpqu0f7fascfrbk-gen27a8.png"><br><br>  vethå¯¹è¿˜å°†é…ç½®ä¸ºå°†ç‚‰åºŠè¿æ¥åˆ°æ–°åˆ›å»ºçš„æ¡¥ï¼š <br><br><img src="https://habrastorage.org/webt/-6/tt/e7/-6tte7essirvuraiuypuln_syvm.png"><br><br> è¦åˆ†é…L3ä¿¡æ¯ï¼ˆä¾‹å¦‚IPåœ°å€ï¼‰ï¼Œå°†è°ƒç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">IPAM</a> ï¼ˆ <code>ipam</code> ï¼‰ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ’ä»¶</a> ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†ä½¿ç”¨<code>host-local</code>ç±»å‹ï¼Œâ€œå°†çŠ¶æ€æœ¬åœ°å­˜å‚¨åœ¨ä¸»æœºæ–‡ä»¶ç³»ç»Ÿä¸Šï¼Œä»¥ç¡®ä¿ä¸€å°ä¸»æœºä¸ŠIPåœ°å€çš„å”¯ä¸€æ€§â€ <i>ï¼ˆæ¥è‡ª<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code> host-local</code></a>çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code> host-local</code></a> ï¼‰</i> ã€‚  IPAMæ’ä»¶å°†æ­¤ä¿¡æ¯è¿”å›åˆ°å…ˆå‰çš„æ’ä»¶ï¼ˆ <code>bridge</code> ï¼‰ï¼Œä»¥ä¾¿å¯ä»¥é…ç½®é…ç½®ä¸­æŒ‡å®šçš„æ‰€æœ‰è·¯ç”±ï¼ˆ <code>"routes": [{"dst": "0.0.0.0/0"}]</code> ï¼‰ã€‚ å¦‚æœæœªæŒ‡å®š<code>gw</code> ï¼Œ <a href="">åˆ™ä»å­ç½‘ä¸­è·å–</a> ã€‚ è¿˜åœ¨ç‚‰åºŠçš„ç½‘ç»œåç§°ç©ºé—´ä¸­é…ç½®é»˜è®¤â€‹â€‹è·¯ç”±ï¼ŒæŒ‡å‘æ¡¥ï¼ˆæ¡¥è¢«é…ç½®ä¸ºç‚‰åºŠçš„ç¬¬ä¸€ä¸ªIPå­ç½‘ï¼‰ã€‚ <br><br> æœ€åä¸€ä¸ªé‡è¦ç»†èŠ‚ï¼šæˆ‘ä»¬è¦æ±‚å¯¹æ¥è‡ªå£ç‚‰ç½‘ç»œçš„æµé‡è¿›è¡Œä¼ªè£…ï¼ˆ <code>"ipMasq": true</code> ï¼‰ã€‚ æˆ‘ä»¬è¿™é‡Œå®é™…ä¸Šå¹¶ä¸éœ€è¦NATï¼Œä½†è¿™æ˜¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetes The Hard Wayä¸­</a>çš„é…ç½®ã€‚ å› æ­¤ï¼Œä¸ºäº†å®Œæ•´èµ·è§ï¼Œæˆ‘å¿…é¡»æåˆ°<code>bridge</code>æ’ä»¶çš„<code>iptables</code>çš„æ¡ç›®æ˜¯ä¸ºæ­¤ç‰¹å®šç¤ºä¾‹é…ç½®çš„ã€‚ æ¥è‡ªç‚‰åºŠçš„æ‰€æœ‰æ•°æ®åŒ…ï¼ˆå…¶æ¥æ”¶è€…ä¸åœ¨<code>224.0.0.0/4</code>èŒƒå›´å†…ï¼‰ <a href="">å°†ä½äºNATåé¢ï¼ŒNAT</a>ä¸èƒ½å®Œå…¨æ»¡è¶³â€œæ‰€æœ‰å®¹å™¨éƒ½å¯ä»¥ä¸ä»»ä½•å…¶ä»–å®¹å™¨é€šä¿¡è€Œæ— éœ€ä½¿ç”¨NATâ€çš„è¦æ±‚ã€‚ å¥½å§ï¼Œæˆ‘ä»¬å°†è¯æ˜ä¸ºä»€ä¹ˆä¸éœ€è¦NAT ... <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/webt/y-/hy/ub/y-hyubecllmzx9go5ehai4shl78.jpeg"></a> <br><br><h3> ç‚‰è†›è·¯ç”± </h3><br> ç°åœ¨æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰è±†èšäº†ã€‚ è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å…¶ä¸­ä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹åç§°çš„æ‰€æœ‰ç½‘ç»œç©ºé—´ï¼Œå¹¶åœ¨<a href="">ä»æ­¤å¤„</a>åˆ›å»º<code>nginx</code>éƒ¨ç½²ä¹‹ååˆ†æå…¶ä¸­ä¸€ä¸ªã€‚ æˆ‘ä»¬å°†ä½¿ç”¨å¸¦æœ‰<code>-t</code>é€‰é¡¹çš„<code>lsns</code>é€‰æ‹©æ‰€éœ€çš„åç§°ç©ºé—´ç±»å‹ï¼ˆå³<code>net</code> ï¼‰ï¼š <br><br><pre> <code class="bash hljs">ubuntu@worker-0:~$ sudo lsns -t net NS TYPE NPROCS PID USER COMMAND 4026532089 net 113 1 root /sbin/init 4026532280 net 2 8046 root /pause 4026532352 net 4 16455 root /pause 4026532426 net 3 27255 root /pause</code> </pre> <br> ä½¿ç”¨<code>-i</code>é€‰é¡¹å¯ä»¥æ‰¾åˆ°å®ƒä»¬çš„inodeå·ï¼š <br><br><pre> <code class="bash hljs">ubuntu@worker-0:~$ ls -1i /var/run/netns 4026532352 cni-1d85bb0c-7c61-fd9f-2adc-f6e98f7a58af 4026532280 cni-7cec0838-f50c-416a-3b45-628a4237c55c 4026532426 cni-912bcc63-712d-1c84-89a7-9e10510808a0</code> </pre> <br> æ‚¨è¿˜å¯ä»¥ä½¿ç”¨<code>ip netns</code>åˆ—å‡ºæ‰€æœ‰ç½‘ç»œåç§°ç©ºé—´ï¼š <br><br><pre> <code class="bash hljs">ubuntu@worker-0:~$ ip netns cni-912bcc63-712d-1c84-89a7-9e10510808a0 (id: 2) cni-1d85bb0c-7c61-fd9f-2adc-f6e98f7a58af (id: 1) cni-7cec0838-f50c-416a-3b45-628a4237c55c (id: 0)</code> </pre> <br> è¦æŸ¥çœ‹åœ¨ç½‘ç»œç©ºé—´<code>cni-912bcc63â€“712d-1c84â€“89a7â€“9e10510808a0</code> ï¼ˆ <code>4026532426</code> ï¼‰ä¸­è¿è¡Œçš„æ‰€æœ‰è¿›ç¨‹ï¼Œæ‚¨å¯ä»¥è¿è¡Œä¾‹å¦‚ä»¥ä¸‹å‘½ä»¤ï¼š <br><br><pre> <code class="bash hljs">ubuntu@worker-0:~$ sudo ls -l /proc/[1-9]*/ns/net | grep 4026532426 | cut -f3 -d<span class="hljs-string"><span class="hljs-string">"/"</span></span> | xargs ps -p PID TTY STAT TIME COMMAND 27255 ? Ss 0:00 /pause 27331 ? Ss 0:00 nginx: master process nginx -g daemon off; 27355 ? S 0:00 nginx: worker process</code> </pre> <br> å¯ä»¥çœ‹å‡ºï¼Œé™¤äº†åœ¨æ­¤podä¸­<code>pause</code>ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯åŠ¨äº†<code>nginx</code> ã€‚  <code>pause</code>å®¹å™¨ä¸æ‰€æœ‰å…¶ä»–å®¹å™¨å®¹å™¨å…±äº«<code>net</code>å’Œ<code>ipc</code>åç§°ç©ºé—´ã€‚ è®°ä½<code>pause</code>çš„PID-27255; æˆ‘ä»¬å°†å›åˆ°å®ƒã€‚ <br><br> ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹<code>kubectl</code>è®²è¿°äº†è¿™ä¸ªpodï¼š <br><br><pre> <code class="bash hljs">$ kubectl get pods -o wide | grep nginx nginx-65899c769f-wxdx6 1/1 Running 0 5d 10.200.0.4 worker-0</code> </pre> <br> æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼š <br><br><pre> <code class="bash hljs">$ kubectl describe pods nginx-65899c769f-wxdx6</code> </pre> <br><pre> <code class="plaintext hljs">Name: nginx-65899c769f-wxdx6 Namespace: default Node: worker-0/10.240.0.20 Start Time: Thu, 05 Jul 2018 14:20:06 -0400 Labels: pod-template-hash=2145573259 run=nginx Annotations: &lt;none&gt; Status: Running IP: 10.200.0.4 Controlled By: ReplicaSet/nginx-65899c769f Containers: nginx: Container ID: containerd://4c0bd2e2e5c0b17c637af83376879c38f2fb11852921b12413c54ba49d6983c7 Image: nginx ...</code> </pre> <br> æˆ‘ä»¬çœ‹åˆ°äº†Podçš„åç§°<code>nginx-65899c769f-wxdx6</code>åŠå…¶å®¹å™¨ä¹‹ä¸€ï¼ˆ <code>nginx</code> ï¼‰çš„IDï¼Œä½†æ˜¯å…³äº<code>pause</code>å¹¶æ²¡æœ‰è¯´ä»€ä¹ˆã€‚ æŒ–æ˜æ›´æ·±çš„å·¥ä½œèŠ‚ç‚¹ä»¥åŒ¹é…æ‰€æœ‰æ•°æ®ã€‚ è¯·è®°ä½ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetes The Hard Way</a>ä¸ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Docker</a> ï¼Œå› æ­¤æœ‰å…³å®¹å™¨çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…æ§åˆ¶å°å®ç”¨ç¨‹åº<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">containerd</a> -ctr <i>ï¼ˆå¦è¯·å‚è§æ–‡ç« <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">``å°†å®¹å™¨åŒ–ä¸Kubernetesé›†æˆï¼Œæ›¿æ¢Dockerï¼Œå‡†å¤‡æŠ•å…¥ç”Ÿäº§</a> ''- <b>å¤§çº¦Transfer</b> ï¼‰</i> ï¼š <br><br><pre> <code class="bash hljs">ubuntu@worker-0:~$ sudo ctr namespaces ls NAME LABELS k8s.io</code> </pre> <br> äº†è§£å®¹å™¨åŒ–ï¼ˆ <code>k8s.io</code> ï¼‰ <code>k8s.io</code> ï¼Œæ‚¨å¯ä»¥è·å¾—<code>nginx</code>å®¹å™¨IDï¼š <br><br><pre> <code class="bash hljs">ubuntu@worker-0:~$ sudo ctr -n k8s.io containers ls | grep nginx 4c0bd2e2e5c0b17c637af83376879c38f2fb11852921b12413c54ba49d6983c7 docker.io/library/nginx:latest io.containerd.runtime.v1.linux</code> </pre> <br>  ...å¹¶<code>pause</code>ä¸€ä¸‹ï¼š <br><br><pre> <code class="bash hljs">ubuntu@worker-0:~$ sudo ctr -n k8s.io containers ls | grep pause 0866803b612f2f55e7b6b83836bde09bd6530246239b7bde1e49c04c7038e43a k8s.gcr.io/pause:3.1 io.containerd.runtime.v1.linux 21640aea0210b320fd637c22ff93b7e21473178de0073b05de83f3b116fc8834 k8s.gcr.io/pause:3.1 io.containerd.runtime.v1.linux d19b1b1c92f7cc90764d4f385e8935d121bca66ba8982bae65baff1bc2841da6 k8s.gcr.io/pause:3.1 io.containerd.runtime.v1.linux</code> </pre> <br> ä»¥<code>â€¦983c7</code>ç»“å°¾çš„<code>nginx</code>å®¹å™¨IDä¸æˆ‘ä»¬ä»<code>kubectl</code>è·å¾—çš„<code>kubectl</code> ã€‚ è®©æˆ‘ä»¬çœ‹çœ‹æ˜¯å¦å¯ä»¥ç¡®å®šå“ªä¸ª<code>pause</code>å®¹å™¨å±äº<code>nginx</code> podï¼š <br><br><pre> <code class="bash hljs">ubuntu@worker-0:~$ sudo ctr -n k8s.io task ls TASK PID STATUS ... d19b1b1c92f7cc90764d4f385e8935d121bca66ba8982bae65baff1bc2841da6 27255 RUNNING 4c0bd2e2e5c0b17c637af83376879c38f2fb11852921b12413c54ba49d6983c7 27331 RUNNING</code> </pre> <br> è¿˜è®°å¾—<code>cni-912bcc63â€“712d-1c84â€“89a7â€“9e10510808a0</code>ç½‘ç»œåç§°ç©ºé—´ä¸­è¿è¡Œçš„PIDä¸º27331å’Œ27355çš„è¿›ç¨‹å—ï¼Ÿ <br><br><pre> <code class="bash hljs">ubuntu@worker-0:~$ sudo ctr -n k8s.io containers info d19b1b1c92f7cc90764d4f385e8935d121bca66ba8982bae65baff1bc2841da6 { <span class="hljs-string"><span class="hljs-string">"ID"</span></span>: <span class="hljs-string"><span class="hljs-string">"d19b1b1c92f7cc90764d4f385e8935d121bca66ba8982bae65baff1bc2841da6"</span></span>, <span class="hljs-string"><span class="hljs-string">"Labels"</span></span>: { <span class="hljs-string"><span class="hljs-string">"io.cri-containerd.kind"</span></span>: <span class="hljs-string"><span class="hljs-string">"sandbox"</span></span>, <span class="hljs-string"><span class="hljs-string">"io.kubernetes.pod.name"</span></span>: <span class="hljs-string"><span class="hljs-string">"nginx-65899c769f-wxdx6"</span></span>, <span class="hljs-string"><span class="hljs-string">"io.kubernetes.pod.namespace"</span></span>: <span class="hljs-string"><span class="hljs-string">"default"</span></span>, <span class="hljs-string"><span class="hljs-string">"io.kubernetes.pod.uid"</span></span>: <span class="hljs-string"><span class="hljs-string">"0b35e956-8080-11e8-8aa9-0a12b8818382"</span></span>, <span class="hljs-string"><span class="hljs-string">"pod-template-hash"</span></span>: <span class="hljs-string"><span class="hljs-string">"2145573259"</span></span>, <span class="hljs-string"><span class="hljs-string">"run"</span></span>: <span class="hljs-string"><span class="hljs-string">"nginx"</span></span> }, <span class="hljs-string"><span class="hljs-string">"Image"</span></span>: <span class="hljs-string"><span class="hljs-string">"k8s.gcr.io/pause:3.1"</span></span>, ...</code> </pre> <br>  ...å’Œï¼š <br><br><pre> <code class="bash hljs">ubuntu@worker-0:~$ sudo ctr -n k8s.io containers info 4c0bd2e2e5c0b17c637af83376879c38f2fb11852921b12413c54ba49d6983c7 { <span class="hljs-string"><span class="hljs-string">"ID"</span></span>: <span class="hljs-string"><span class="hljs-string">"4c0bd2e2e5c0b17c637af83376879c38f2fb11852921b12413c54ba49d6983c7"</span></span>, <span class="hljs-string"><span class="hljs-string">"Labels"</span></span>: { <span class="hljs-string"><span class="hljs-string">"io.cri-containerd.kind"</span></span>: <span class="hljs-string"><span class="hljs-string">"container"</span></span>, <span class="hljs-string"><span class="hljs-string">"io.kubernetes.container.name"</span></span>: <span class="hljs-string"><span class="hljs-string">"nginx"</span></span>, <span class="hljs-string"><span class="hljs-string">"io.kubernetes.pod.name"</span></span>: <span class="hljs-string"><span class="hljs-string">"nginx-65899c769f-wxdx6"</span></span>, <span class="hljs-string"><span class="hljs-string">"io.kubernetes.pod.namespace"</span></span>: <span class="hljs-string"><span class="hljs-string">"default"</span></span>, <span class="hljs-string"><span class="hljs-string">"io.kubernetes.pod.uid"</span></span>: <span class="hljs-string"><span class="hljs-string">"0b35e956-8080-11e8-8aa9-0a12b8818382"</span></span> }, <span class="hljs-string"><span class="hljs-string">"Image"</span></span>: <span class="hljs-string"><span class="hljs-string">"docker.io/library/nginx:latest"</span></span>, ...</code> </pre> <br> ç°åœ¨ï¼Œæˆ‘ä»¬ç¡®åˆ‡åœ°çŸ¥é“æ­¤å®¹å™¨ï¼ˆ <code>nginx-65899c769f-wxdx6</code> ï¼‰å’Œç½‘ç»œåç§°ç©ºé—´ï¼ˆ <code>cni-912bcc63â€“712d-1c84â€“89a7â€“9e10510808a0</code> ï¼‰ä¸­æ­£åœ¨è¿è¡Œçš„å®¹å™¨ï¼š <br><br><ul><li>  nginxï¼ˆIDï¼š <code>4c0bd2e2e5c0b17c637af83376879c38f2fb11852921b12413c54ba49d6983c7</code> ï¼‰; </li><li> æš‚åœï¼ˆIDï¼š <code>d19b1b1c92f7cc90764d4f385e8935d121bca66ba8982bae65baff1bc2841da6</code> ï¼‰ã€‚ </li></ul><br><img src="https://habrastorage.org/webt/3h/cx/qq/3hcxqqv-mwlrm8ax9lu9jl0fixy.png"><br><br>  ï¼ˆ <code>nginx-65899c769f-wxdx6</code> ï¼‰ä¸‹çš„è¯¥å¦‚ä½•è¿æ¥åˆ°ç½‘ç»œï¼Ÿ æˆ‘ä»¬ä½¿ç”¨å…ˆå‰ä»<code>pause</code>æ¥æ”¶åˆ°çš„PID 27255åœ¨å…¶ç½‘ç»œåç§°ç©ºé—´ï¼ˆ <code>cni-912bcc63â€“712d-1c84â€“89a7â€“9e10510808a0</code> ï¼‰ä¸­è¿è¡Œå‘½ä»¤ï¼š <br><br><pre> <code class="bash hljs">ubuntu@worker-0:~$ sudo ip netns identify 27255 cni-912bcc63-712d-1c84-89a7-9e10510808a0</code> </pre> <br> ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†<code>nsenter</code>ä¸<code>-t</code>é€‰é¡¹ä¸€èµ·ä½¿ç”¨ï¼Œè¯¥é€‰é¡¹å®šä¹‰äº†ç›®æ ‡PIDï¼Œè€Œ<code>-n</code>æ²¡æœ‰æŒ‡å®šæ–‡ä»¶ä»¥è¿›å…¥ç›®æ ‡è¿›ç¨‹çš„ç½‘ç»œåç§°ç©ºé—´ï¼ˆ27255ï¼‰ã€‚ è¿™æ˜¯<code>ip link show</code>å†…å®¹ï¼š <br><br><pre> <code class="bash hljs">ubuntu@worker-0:~$ sudo nsenter -t 27255 -n ip link show 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 3: eth0@if7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default link/ether 0a:58:0a:c8:00:04 brd ff:ff:ff:ff:ff:ff link-netnsid 0</code> </pre> <br>  ...å’Œ<code>ifconfig eth0</code> ï¼š <br><br><pre> <code class="bash hljs">ubuntu@worker-0:~$ sudo nsenter -t 27255 -n ifconfig eth0 eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500 inet 10.200.0.4 netmask 255.255.255.0 broadcast 0.0.0.0 inet6 fe80::2097:51ff:fe39:ec21 prefixlen 64 scopeid 0x20&lt;link&gt; ether 0a:58:0a:c8:00:04 txqueuelen 0 (Ethernet) RX packets 540 bytes 42247 (42.2 KB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 177 bytes 16530 (16.5 KB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0</code> </pre> <br> è¿™ç¡®è®¤å…ˆå‰åœ¨<code>eth0</code>æ¥å£ä¸Šé…ç½®äº†é€šè¿‡<code>kubectl get pod</code>è·å¾—çš„IPåœ°å€ã€‚ æ­¤æ¥å£æ˜¯<b>vethå¯¹çš„</b>ä¸€éƒ¨åˆ†ï¼Œå…¶ä¸€ç«¯åœ¨ç‚‰è†›ä¸­ï¼Œå¦ä¸€ç«¯åœ¨æ ¹åç§°ç©ºé—´ä¸­ã€‚ ä¸ºäº†æ‰¾åˆ°ç¬¬äºŒç«¯çš„æ¥å£ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>ethtool</code> ï¼š <br><br><pre> <code class="bash hljs">ubuntu@worker-0:~$ sudo ip netns <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> cni-912bcc63-712d-1c84-89a7-9e10510808a0 ethtool -S eth0 NIC statistics: peer_ifindex: 7</code> </pre> <br> æˆ‘ä»¬çœ‹åˆ°<code>ifindex</code>ç››å®´çš„<code>ifindex</code>ä¸º7ã€‚æ£€æŸ¥å®ƒæ˜¯å¦åœ¨æ ¹åç§°ç©ºé—´ä¸­ã€‚ è¿™å¯ä»¥ä½¿ç”¨<code>ip link</code>å®Œæˆï¼š <br><br><pre> <code class="bash hljs">ubuntu@worker-0:~$ ip link | grep <span class="hljs-string"><span class="hljs-string">'^7:'</span></span> 7: veth71f7d238@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master cnio0 state UP mode DEFAULT group default</code> </pre> <br> æœ€åè¦ç¡®å®šè¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ï¼š <br><br><pre> <code class="bash hljs">ubuntu@worker-0:~$ sudo cat /sys/class/net/veth71f7d238/ifindex 7</code> </pre> <br> å¤ªå¥½äº†ï¼Œè™šæ‹Ÿé“¾æ¥ç°åœ¨ä¸€åˆ‡éƒ½æ¸…æ™°äº†ã€‚ ä½¿ç”¨<code>brctl</code>è®©æˆ‘ä»¬çœ‹çœ‹è¿˜æœ‰è°è¿æ¥åˆ°Linuxç½‘æ¡¥ï¼š <br><br><pre> <code class="bash hljs">ubuntu@worker-0:~$ brctl show cnio0 bridge name bridge id STP enabled interfaces cnio0 8000.0a580ac80001 no veth71f7d238 veth73f35410 vethf273b35f</code> </pre> <br> å› æ­¤ï¼Œå›¾ç‰‡å¦‚ä¸‹ï¼š <br><br><img src="https://habrastorage.org/webt/yu/gc/t6/yugct6efi7ztep277en4msjuzv4.png"><br><br><h3> è·¯ç”±æ£€æŸ¥ </h3><br> æˆ‘ä»¬å®é™…ä¸Šå¦‚ä½•è½¬å‘æµé‡ï¼Ÿ è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ç½‘ç»œåç§°ç©ºé—´çª—æ ¼ä¸­çš„è·¯ç”±è¡¨ï¼š <br><br><pre> <code class="bash hljs">ubuntu@worker-0:~$ sudo ip netns <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> cni-912bcc63-712d-1c84-89a7-9e10510808a0 ip route show default via 10.200.0.1 dev eth0 10.200.0.0/24 dev eth0 proto kernel scope link src 10.200.0.4</code> </pre> <br> è‡³å°‘æˆ‘ä»¬çŸ¥é“å¦‚ä½•åˆ°è¾¾æ ¹åç§°ç©ºé—´ï¼ˆ <code>default via 10.200.0.1</code> ï¼‰ã€‚ ç°åœ¨è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸»æœºè·¯ç”±è¡¨ï¼š <br><br><pre> <code class="bash hljs">ubuntu@worker-0:~$ ip route list default via 10.240.0.1 dev eth0 proto dhcp src 10.240.0.20 metric 100 10.200.0.0/24 dev cnio0 proto kernel scope link src 10.200.0.1 10.240.0.0/24 dev eth0 proto kernel scope link src 10.240.0.20 10.240.0.1 dev eth0 proto dhcp scope link src 10.240.0.20 metric 100</code> </pre> <br> æˆ‘ä»¬çŸ¥é“å¦‚ä½•å°†æ•°æ®åŒ…è½¬å‘åˆ°VPCè·¯ç”±å™¨ï¼ˆVPC <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å…·æœ‰</a> â€œéšå¼â€è·¯ç”±å™¨ï¼Œè¯¥è·¯ç”±å™¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é€šå¸¸å…·æœ‰</a>å­ç½‘ä¸»IPåœ°å€ç©ºé—´ä¸­çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç¬¬äºŒä¸ªåœ°å€</a> ï¼‰ã€‚ ç°åœ¨ï¼šVPCè·¯ç”±å™¨çŸ¥é“å¦‚ä½•è®¿é—®æ¯ä¸ªç‚‰åºŠçš„ç½‘ç»œå—ï¼Ÿ ä¸ï¼Œä»–æ²¡æœ‰ï¼Œå› æ­¤ï¼Œå‡å®šè·¯ç”±å°†ç”±CNIæ’ä»¶é…ç½®æˆ–<a href="">æ‰‹åŠ¨é…ç½®</a> ï¼ˆå¦‚æ‰‹å†Œä¸­æ‰€è¿°ï¼‰ã€‚ æ˜¾ç„¶ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">AWS CNIæ’ä»¶</a>æ­£æ˜¯åœ¨AWSä¸Šä¸ºæˆ‘ä»¬å®Œæˆçš„ã€‚ è¯·è®°ä½ï¼Œæœ‰<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¾ˆå¤šCNIæ’ä»¶</a> ï¼Œæˆ‘ä»¬æ­£åœ¨è€ƒè™‘ä¸€ä¸ª<b>ç®€å•çš„ç½‘ç»œé…ç½®</b>ç¤ºä¾‹ï¼š <br><br><img src="https://habrastorage.org/webt/cn/v7/v_/cnv7v_qjfkidbtuljkbgkuzuaag.png"><br><br><h3> æ·±æµ¸åœ¨NATä¸­ </h3><br>  <code>kubectl create -f busybox.yaml</code>ä½¿ç”¨Replication Controlleråˆ›å»ºä¸¤ä¸ªç›¸åŒçš„<code>busybox</code>å®¹å™¨ï¼š <br><br><pre> <code class="plaintext hljs">apiVersion: v1 kind: ReplicationController metadata: name: busybox0 labels: app: busybox0 spec: replicas: 2 selector: app: busybox0 template: metadata: name: busybox0 labels: app: busybox0 spec: containers: - image: busybox command: - sleep - "3600" imagePullPolicy: IfNotPresent name: busybox restartPolicy: Always</code> </pre> <br>  ï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>busybox.yaml</code></a> ï¼‰ <br><br> æˆ‘ä»¬å¾—åˆ°ï¼š <br><br><pre> <code class="bash hljs">$ kubectl get pods -o wide NAME READY STATUS RESTARTS AGE IP NODE busybox0-g6pww 1/1 Running 0 4s 10.200.1.15 worker-1 busybox0-rw89s 1/1 Running 0 4s 10.200.0.21 worker-0 ...</code> </pre> <br> ä»ä¸€ä¸ªå®¹å™¨åˆ°å¦ä¸€ä¸ªå®¹å™¨çš„pingæ“ä½œåº”è¯¥æˆåŠŸï¼š <br><br><pre> <code class="bash hljs">$ kubectl <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> -it busybox0-rw89s -- ping -c 2 10.200.1.15 PING 10.200.1.15 (10.200.1.15): 56 data bytes 64 bytes from 10.200.1.15: seq=0 ttl=62 time=0.528 ms 64 bytes from 10.200.1.15: seq=1 ttl=62 time=0.440 ms --- 10.200.1.15 ping statistics --- 2 packets transmitted, 2 packets received, 0% packet loss round-trip min/avg/max = 0.440/0.484/0.528 ms</code> </pre> <br> è¦äº†è§£æµé‡çš„ç§»åŠ¨ï¼Œå¯ä»¥ä½¿ç”¨<code>tcpdump</code>æˆ–<code>conntrack</code>æŸ¥çœ‹æ•°æ®åŒ…ï¼š <br><br><pre> <code class="bash hljs">ubuntu@worker-0:~$ sudo conntrack -L | grep 10.200.1.15 icmp 1 29 src=10.200.0.21 dst=10.200.1.15 <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=8 code=0 id=1280 src=10.200.1.15 dst=10.240.0.20 <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=0 code=0 id=1280 mark=0 use=1</code> </pre> <br> æ¥è‡ªPod 10.200.0.21çš„æºIPè¢«è½¬æ¢ä¸ºä¸»æœº10.240.0.20çš„IPåœ°å€ã€‚ <br><br><pre> <code class="bash hljs">ubuntu@worker-1:~$ sudo conntrack -L | grep 10.200.1.15 icmp 1 28 src=10.240.0.20 dst=10.200.1.15 <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=8 code=0 id=1280 src=10.200.1.15 dst=10.240.0.20 <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=0 code=0 id=1280 mark=0 use=1</code> </pre> <br> åœ¨iptablesä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°è®¡æ•°åœ¨å¢åŠ ï¼š <br><br><pre> <code class="bash hljs">ubuntu@worker-0:~$ sudo iptables -t nat -Z POSTROUTING -L -v Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes) pkts bytes target prot opt <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> out <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> destination ... 5 324 CNI-be726a77f15ea47ff32947a3 all -- any any 10.200.0.0/24 anywhere /* name: <span class="hljs-string"><span class="hljs-string">"bridge"</span></span> id: <span class="hljs-string"><span class="hljs-string">"631cab5de5565cc432a3beca0e2aece0cef9285482b11f3eb0b46c134e457854"</span></span> */ Zeroing chain `POSTROUTING<span class="hljs-string"><span class="hljs-string">'</span></span></code> </pre> <br> å¦ä¸€æ–¹é¢ï¼Œå¦‚æœä»CNIæ’ä»¶é…ç½®ä¸­åˆ é™¤<code>"ipMasq": true</code> ï¼Œåˆ™å¯ä»¥çœ‹åˆ°ä»¥ä¸‹å†…å®¹ï¼ˆæ­¤æ“ä½œä»…å‡ºäºæ•™è‚²ç›®çš„è€Œæ‰§è¡Œ-æˆ‘ä»¬ä¸å»ºè®®åœ¨å·¥ä½œé›†ç¾¤ä¸Šæ›´æ”¹é…ç½®ï¼ï¼‰ï¼š <br><br><pre> <code class="bash hljs">$ kubectl get pods -o wide NAME READY STATUS RESTARTS AGE IP NODE busybox0-2btxn 1/1 Running 0 16s 10.200.0.15 worker-0 busybox0-dhpx8 1/1 Running 0 16s 10.200.1.13 worker-1 ...</code> </pre> <br>  Pingåº”è¯¥ä»ç„¶é€šè¿‡ï¼š <br><br><pre> <code class="bash hljs">$ kubectl <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> -it busybox0-2btxn -- ping -c 2 10.200.1.13 PING 10.200.1.6 (10.200.1.6): 56 data bytes 64 bytes from 10.200.1.6: seq=0 ttl=62 time=0.515 ms 64 bytes from 10.200.1.6: seq=1 ttl=62 time=0.427 ms --- 10.200.1.6 ping statistics --- 2 packets transmitted, 2 packets received, 0% packet loss round-trip min/avg/max = 0.427/0.471/0.515 ms</code> </pre> <br> åœ¨è¿™ç§æƒ…å†µä¸‹-ä¸ä½¿ç”¨NATï¼š <br><br><pre> <code class="bash hljs">ubuntu@worker-0:~$ sudo conntrack -L | grep 10.200.1.13 icmp 1 29 src=10.200.0.15 dst=10.200.1.13 <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=8 code=0 id=1792 src=10.200.1.13 dst=10.200.0.15 <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=0 code=0 id=1792 mark=0 use=1</code> </pre> <br> å› æ­¤ï¼Œæˆ‘ä»¬æ£€æŸ¥äº†â€œæ‰€æœ‰å®¹å™¨éƒ½å¯ä»¥åœ¨ä¸ä½¿ç”¨NATçš„æƒ…å†µä¸‹ä¸ä»»ä½•å…¶ä»–å®¹å™¨è¿›è¡Œé€šä¿¡â€ã€‚ <br><br><pre> <code class="bash hljs">ubuntu@worker-1:~$ sudo conntrack -L | grep 10.200.1.13 icmp 1 27 src=10.200.0.15 dst=10.200.1.13 <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=8 code=0 id=1792 src=10.200.1.13 dst=10.200.0.15 <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=0 code=0 id=1792 mark=0 use=1</code> </pre> <br><h2> ç¾¤é›†ç½‘ç»œï¼ˆ10.32.0.0/24ï¼‰ </h2><br> æ‚¨å¯èƒ½å·²ç»åœ¨<code>busybox</code>ç¤ºä¾‹ä¸­æ³¨æ„åˆ°ï¼Œåˆ†é…ç»™<code>busybox</code>çš„IPåœ°å€åœ¨æ¯ç§æƒ…å†µä¸‹éƒ½æ˜¯ä¸åŒçš„ã€‚ å¦‚æœæˆ‘ä»¬æƒ³ä½¿è¿™äº›å®¹å™¨å¯ç”¨äºå…¶ä»–ç‚‰åºŠä¹‹é—´çš„é€šä¿¡å‘¢ï¼Ÿ ä¸€ä¸ªäººå¯èƒ½ä¼šä½¿ç”¨Podçš„å½“å‰IPåœ°å€ï¼Œä½†æ˜¯å®ƒä»¬ä¼šæ”¹å˜ã€‚ å› æ­¤ï¼Œæ‚¨éœ€è¦é…ç½®<code>Service</code>èµ„æºï¼Œè¯¥èµ„æºä¼šå°†è¯·æ±‚ä»£ç†åˆ°è®¸å¤šçŸ­æš‚çš„ç‚‰è†›ã€‚ <br><br><blockquote>  â€œ Kubernetesä¸­çš„æœåŠ¡æ˜¯ä¸€ç§æŠ½è±¡ï¼Œå®šä¹‰äº†ç‚‰è†›çš„é€»è¾‘é›†å’Œå¯è®¿é—®å®ƒä»¬çš„ç­–ç•¥ã€‚â€  <i>ï¼ˆæ¥è‡ª<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetes Services</a>æ–‡æ¡£ï¼‰</i> </blockquote><br> æœ‰å¤šç§å‘å¸ƒæœåŠ¡çš„æ–¹å¼ã€‚ é»˜è®¤ç±»å‹ä¸º<code>ClusterIP</code> ï¼Œå®ƒä»ç¾¤é›†çš„CIDRå—è®¾ç½®IPåœ°å€ï¼ˆå³åªèƒ½ä»ç¾¤é›†è®¿é—®ï¼‰ã€‚ ä¸€ä¸ªè¿™æ ·çš„ç¤ºä¾‹æ˜¯åœ¨Kubernetes The Hard Wayä¸­é…ç½®çš„DNSç¾¤é›†é™„åŠ ç»„ä»¶ã€‚ <br><br><pre> <code class="plaintext hljs"># ... apiVersion: v1 kind: Service metadata: name: kube-dns namespace: kube-system labels: k8s-app: kube-dns kubernetes.io/cluster-service: "true" addonmanager.kubernetes.io/mode: Reconcile kubernetes.io/name: "KubeDNS" spec: selector: k8s-app: kube-dns clusterIP: 10.32.0.10 ports: - name: dns port: 53 protocol: UDP - name: dns-tcp port: 53 protocol: TCP # ...</code> </pre> <br>  ï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>kube-dns.yaml</code></a> ï¼‰ <br><br>  <code>kubectl</code>è¡¨æ˜<code>Service</code>è®°ä½ç«¯ç‚¹å¹¶è¿›è¡Œè½¬æ¢ï¼š <br><br><pre> <code class="bash hljs">$ kubectl -n kube-system describe services ... Selector: k8s-app=kube-dns Type: ClusterIP IP: 10.32.0.10 Port: dns 53/UDP TargetPort: 53/UDP Endpoints: 10.200.0.27:53 Port: dns-tcp 53/TCP TargetPort: 53/TCP Endpoints: 10.200.0.27:53 ...</code> </pre> <br> ç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Ÿ.. <code>iptables</code>åˆä¸€æ¬¡ã€‚ è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸ºè¯¥ç¤ºä¾‹åˆ›å»ºçš„è§„åˆ™ã€‚ å¯ä»¥ä½¿ç”¨<code>iptables-save</code>å‘½ä»¤æŸ¥çœ‹å…¶å®Œæ•´åˆ—è¡¨ã€‚ <br><br> ä¸€æ—¦æ•°æ®åŒ…ç”±è¿›ç¨‹ï¼ˆ <code>OUTPUT</code> ï¼‰åˆ›å»ºæˆ–åˆ°è¾¾ç½‘ç»œæ¥å£ï¼ˆ <code>PREROUTING</code> ï¼‰ï¼Œå®ƒä»¬ä¾¿é€šè¿‡ä»¥ä¸‹<code>iptables</code>é“¾ï¼š <br><br><pre> <code class="bash hljs">-A PREROUTING -m comment --comment <span class="hljs-string"><span class="hljs-string">"kubernetes service portals"</span></span> -j KUBE-SERVICES -A OUTPUT -m comment --comment <span class="hljs-string"><span class="hljs-string">"kubernetes service portals"</span></span> -j KUBE-SERVICES</code> </pre> <br> ä»¥ä¸‹ç›®æ ‡å¯¹åº”äºå‘é€åˆ°10.32.0.10å¤„çš„ç¬¬53ä¸ªç«¯å£çš„TCPæ•°æ®åŒ…ï¼Œå¹¶é€šè¿‡ç¬¬53ä¸ªç«¯å£å‘é€ç»™æ¥æ”¶è€…10.200.0.27ï¼š <br><br><pre> <code class="bash hljs">-A KUBE-SERVICES -d 10.32.0.10/32 -p tcp -m comment --comment <span class="hljs-string"><span class="hljs-string">"kube-system/kube-dns:dns-tcp cluster IP"</span></span> -m tcp --dport 53 -j KUBE-SVC-ERIFXISQEP7F7OF4 -A KUBE-SVC-ERIFXISQEP7F7OF4 -m comment --comment <span class="hljs-string"><span class="hljs-string">"kube-system/kube-dns:dns-tcp"</span></span> -j KUBE-SEP-32LPCMGYG6ODGN3H -A KUBE-SEP-32LPCMGYG6ODGN3H -p tcp -m comment --comment <span class="hljs-string"><span class="hljs-string">"kube-system/kube-dns:dns-tcp"</span></span> -m tcp -j DNAT --to-destination 10.200.0.27:53</code> </pre> <br> å¯¹äºUDPæ•°æ®åŒ…ä¹Ÿæ˜¯å¦‚æ­¤ï¼ˆæ”¶ä»¶äºº10.32.0.10:53â†’10.200.0.27:53ï¼‰ï¼š <br><br><pre> <code class="bash hljs">-A KUBE-SERVICES -d 10.32.0.10/32 -p udp -m comment --comment <span class="hljs-string"><span class="hljs-string">"kube-system/kube-dns:dns cluster IP"</span></span> -m udp --dport 53 -j KUBE-SVC-TCOU7JCQXEZGVUNU -A KUBE-SVC-TCOU7JCQXEZGVUNU -m comment --comment <span class="hljs-string"><span class="hljs-string">"kube-system/kube-dns:dns"</span></span> -j KUBE-SEP-LRUTK6XRXU43VLIG -A KUBE-SEP-LRUTK6XRXU43VLIG -p udp -m comment --comment <span class="hljs-string"><span class="hljs-string">"kube-system/kube-dns:dns"</span></span> -m udp -j DNAT --to-destination 10.200.0.27:53</code> </pre> <br>  Kubernetesä¸­è¿˜æœ‰å…¶ä»–ç±»å‹çš„<code>Services</code> ã€‚ ç‰¹åˆ«æ˜¯ï¼ŒKubernetes The Hard Way <code>NodePort</code>äº†<code>NodePort</code> ï¼Œè¯·å‚é˜…<a href="">Smoke Testï¼šServices</a> ã€‚ <br><br><pre> <code class="bash hljs">kubectl expose deployment nginx --port 80 --<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> NodePort</code> </pre> <br>  <code>NodePort</code>åœ¨æ¯ä¸ªèŠ‚ç‚¹çš„IPåœ°å€ä¸Šå‘å¸ƒæœåŠ¡ï¼Œå¹¶å°†å…¶æ”¾ç½®åœ¨é™æ€ç«¯å£ï¼ˆç§°ä¸º<code>NodePort</code> ï¼‰ä¸Šã€‚  <code>NodePort</code>å¯ä»¥ä»ç¾¤é›†å¤–éƒ¨è®¿é—®<code>NodePort</code> ã€‚ æ‚¨å¯ä»¥ä½¿ç”¨<code>kubectl</code>æ£€æŸ¥ä¸“ç”¨ç«¯å£ï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸º31088ï¼‰ï¼š <br><br><pre> <code class="bash hljs">$ kubectl describe services nginx ... Type: NodePort IP: 10.32.0.53 Port: &lt;<span class="hljs-built_in"><span class="hljs-built_in">unset</span></span>&gt; 80/TCP TargetPort: 80/TCP NodePort: &lt;<span class="hljs-built_in"><span class="hljs-built_in">unset</span></span>&gt; 31088/TCP Endpoints: 10.200.1.18:80 ...</code> </pre> <br>  Underç°åœ¨å¯ä»¥ä»Internetä¸Šè·å¾—ï¼Œç½‘å€ä¸º<code>http://${EXTERNAL_IP}:31088/</code> ã€‚ æ­¤å¤„<code>EXTERNAL_IP</code>æ˜¯<b>ä»»ä½•å·¥ä½œå®ä¾‹</b>çš„å…¬å…±IPåœ°å€ã€‚ åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä½¿ç”¨<b>worker-0</b>çš„å…¬å…±IPåœ°å€ã€‚ å†…éƒ¨IPåœ°å€ä¸º10.240.0.20çš„ä¸»æœºï¼ˆäº‘æä¾›å•†ä»äº‹å…¬å…±NATï¼‰æ¥æ”¶åˆ°è¯¥è¯·æ±‚ï¼Œä½†æ˜¯ï¼Œè¯¥æœåŠ¡å®é™…ä¸Šæ˜¯åœ¨å¦ä¸€å°ä¸»æœºä¸Šå¯åŠ¨çš„ï¼ˆ <b>worker-1</b> ï¼Œå¯ä»¥é€šè¿‡ç«¯ç‚¹çš„IPåœ°å€-10.200.1.18çœ‹åˆ°ï¼‰ï¼š <br><br><pre> <code class="bash hljs">ubuntu@worker-0:~$ sudo conntrack -L | grep 31088 tcp 6 86397 ESTABLISHED src=173.38.XXX.XXX dst=10.240.0.20 sport=30303 dport=31088 src=10.200.1.18 dst=10.240.0.20 sport=80 dport=30303 [ASSURED] mark=0 use=1</code> </pre> <br> æ•°æ®åŒ…ä»<b>worker-0</b>å‘é€åˆ°<b>worker-1</b> ï¼Œåœ¨å…¶ä¸­æ‰¾åˆ°æ¥æ”¶è€…ï¼š <br><br><pre> <code class="bash hljs">ubuntu@worker-1:~$ sudo conntrack -L | grep 80 tcp 6 86392 ESTABLISHED src=10.240.0.20 dst=10.200.1.18 sport=14802 dport=80 src=10.200.1.18 dst=10.240.0.20 sport=80 dport=14802 [ASSURED] mark=0 use=1</code> </pre> <br> è¿™æ ·çš„ç”µè·¯ç†æƒ³å—ï¼Ÿ ä¹Ÿè®¸ä¸è¡Œï¼Œä½†æ˜¯è¡Œå¾—é€šã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå·²ç¼–ç¨‹çš„<code>iptables</code>è§„åˆ™å¦‚ä¸‹ï¼š <br><br><pre> <code class="bash hljs">-A KUBE-NODEPORTS -p tcp -m comment --comment <span class="hljs-string"><span class="hljs-string">"default/nginx:"</span></span> -m tcp --dport 31088 -j KUBE-SVC-4N57TFCL4MD7ZTDA -A KUBE-SVC-4N57TFCL4MD7ZTDA -m comment --comment <span class="hljs-string"><span class="hljs-string">"default/nginx:"</span></span> -j KUBE-SEP-UGTFMET44DQG7H7H -A KUBE-SEP-UGTFMET44DQG7H7H -p tcp -m comment --comment <span class="hljs-string"><span class="hljs-string">"default/nginx:"</span></span> -m tcp -j DNAT --to-destination 10.200.1.18:80</code> </pre> <br> æ¢å¥è¯è¯´ï¼Œå¸¦æœ‰ç«¯å£31088çš„æ•°æ®åŒ…æ¥æ”¶æ–¹çš„åœ°å€åœ¨10.200.1.18ä¸Šå¹¿æ’­ã€‚ è¯¥æ¸¯å£è¿˜åœ¨å¹¿æ’­ï¼Œä»31088åˆ°80ã€‚ <br><br> æˆ‘ä»¬æ²¡æœ‰æ¶‰åŠå¦ä¸€ç§ç±»å‹çš„æœåŠ¡<code>LoadBalancer</code> ï¼Œå®ƒä½¿ç”¨äº‘æä¾›å•†çš„è´Ÿè½½å¹³è¡¡å™¨ä½¿è¯¥æœåŠ¡å…¬å¼€å¯ç”¨ï¼Œä½†äº‹å®è¯æ˜è¿™ç¯‡æ–‡ç« å¾ˆå¤§ã€‚ <br><br><h2> ç»“è®º </h2><br> ä¼¼ä¹æœ‰å¾ˆå¤šä¿¡æ¯ï¼Œä½†æˆ‘ä»¬åªè§¦åŠåˆ°äº†å†°å±±ä¸€è§’ã€‚ å°†æ¥ï¼Œæˆ‘å°†è®¨è®ºIPv6ï¼ŒIPVSï¼ŒeBPFå’Œå‡ ä¸ªå½“å‰æœ‰è¶£çš„CNIæ’ä»¶ã€‚ <br><br><h2> è¯‘è€…çš„PS </h2><br> å¦è¯·å‚é˜…æˆ‘ä»¬çš„åšå®¢ï¼š <br><br><ul><li>  â€œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetesç½‘ç»œæ’å›¾æŒ‡å—</a> â€ï¼› </li><li>  â€œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetesçš„ç½‘ç»œæ€§èƒ½æ¯”è¾ƒ</a> â€ï¼› </li><li>  â€œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨kubernetesä¸­è¿›è¡Œkube-proxyå’Œä¸»æœºä¸å¯è®¿é—®æ€§çš„å®éªŒ</a> â€ï¼› </li><li>  â€œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ”¹å–„Kubernetesçš„å¯é æ€§ï¼šå¦‚ä½•å¿«é€Ÿæ³¨æ„åˆ°ä¸€ä¸ªèŠ‚ç‚¹å·²ç»å´©æºƒ</a> â€ï¼› </li><li> Â« <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Play with Kubernetes â€”      K8s</a> Â»; </li><li> Â« <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">   Kubernetes   </a> Â» <i>( ,        Kubernetes)</i> ; </li><li> Â« <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Container Networking Interface (CNI) â€”      Linux-</a> Â». </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN420813/">https://habr.com/ru/post/zh-CN420813/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN420799/index.html">MPS 2018.2ï¼šç”Ÿæˆå™¨æµ‹è¯•ï¼ŒGitHubæ’ä»¶ï¼ŒVCS Aspectï¼Œè¿ç§»é€šçŸ¥ç­‰</a></li>
<li><a href="../zh-CN420803/index.html">3Dæ‰“å°è¯¾ç¨‹ã€‚ ä»3Dtoolæ‰“å°éåŠŸèƒ½æ€§æ¨¡å‹æ—¶èŠ‚çœå¡‘æ–™</a></li>
<li><a href="../zh-CN420805/index.html">[ç¿»è¯‘]ä½•æ—¶ä½¿ç”¨å¹¶è¡Œæµ</a></li>
<li><a href="../zh-CN420809/index.html">å®‰å…¨å‘¨31ï¼šäº”åç§ä¸å®‰å…¨çš„Androidé˜´å½±</a></li>
<li><a href="../zh-CN420811/index.html">æ–°ä¸€ä»£åˆ†æ•£ä¿¡ä½¿å’Œç”µè¯ç½‘ç»œ</a></li>
<li><a href="../zh-CN420815/index.html">â€œè§£ç æ•°å­—ä¸–ç•Œâ€æ˜¯å¦‚ä½•çˆ†ç‚¸çš„ï¼šDotNext 2018 Piterçš„åå¤§æŠ¥é“</a></li>
<li><a href="../zh-CN420819/index.html">ç”¨äºæœºå™¨å­¦ä¹ å’Œæ•°æ®ç§‘å­¦çš„åå¤§Pythonå·¥å…·</a></li>
<li><a href="../zh-CN420821/index.html">è§„åˆ™10ï¼šç¼–ç¨‹å’Œå†™ä½œä¸º1</a></li>
<li><a href="../zh-CN420825/index.html">ä»Šå¤©å°†æ˜¯OpenAIå’ŒDota 2ä¸“ä¸šäººå£«ä¹‹é—´çš„é¦–æ¬¡è¾ƒé‡ï¼ˆè·èƒœè€…ï¼‰ã€‚ æˆ‘ä»¬äº†è§£æœºå™¨äººçš„å·¥ä½œåŸç†</a></li>
<li><a href="../zh-CN420827/index.html">ä½¿ç”¨Java EE + WildFly10 + JPAï¼ˆHibernateï¼‰+ Postgresql + EJB + IntelliJ IDEAåˆ›å»ºä¸€ä¸ªç®€å•çš„Mavené¡¹ç›®</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>