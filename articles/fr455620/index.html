<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßëüèø‚Äçü§ù‚Äçüßëüèª üìú üïú CAN ou pas CAN? Ou pourquoi ai-je besoin d'un r√©seau de microcontr√¥leurs? üì∫ üö™ üë®‚Äç‚ù§Ô∏è‚Äçüë®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="J'ai d√ª me poser cette question il y a une dizaine d'ann√©es ou plus. Le travail qui devait √™tre fait √©tait de donner une seconde vie √† la r√©gie. C'est...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>CAN ou pas CAN? Ou pourquoi ai-je besoin d'un r√©seau de microcontr√¥leurs?</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/455620/"><p>  J'ai d√ª me poser cette question il y a une dizaine d'ann√©es ou plus.  Le travail qui devait √™tre fait √©tait de donner une seconde vie √† la r√©gie.  C'est une telle chose dans tout le mur, compos√© d'ampoules et d'interrupteurs avec interrupteurs.  Je pense que je ne me tromperai pas en supposant que les boucliers fonctionnent depuis l'apparition des ampoules, car les interrupteurs √† cette √©poque √©taient probablement d√©j√† connus.  Et l'envie de beaut√©, en g√©n√©ral, est venue aux gens de l'antiquit√© lointaine. </p><br><p>  Maintenant, beaucoup pr√©f√©reront les panneaux d'affichage aux boucliers.  Mais s'il y aura une majorit√© de fans d'affichage d√©pend de beaucoup de choses qui nous sont inconnues.  Mais maintenant, ce n'est pas √ßa. </p><br><p>  Quiconque peut parler de c√¢blage √©lectrique pendant cinq minutes me dira imm√©diatement que le bouclier est compos√© d'√©crans plats sur lesquels sont plac√©s des interrupteurs et des ampoules, ainsi que d'une bo√Æte avec de nombreux fils.  Apr√®s tout, une ampoule sans fil ne convient que pour la casser stupidement ou, si vous montez de mani√®re cr√©ative et excitez votre imagination, placez-la au plus curieux dans votre bouche et d√©couvrez rapidement o√π se trouve la salle d'urgence. </p><a name="habracut"></a><br><p>  C'√©tait tout, un tas de fils laissant la bo√Æte aux interrupteurs et aux ampoules, seules les ampoules √©taient petites.  Apparemment, la petite-fille de la c√©l√®bre ampoule Ilyich. </p><br><p>  Et maintenant, je me souviens, j'ai regard√© par la fen√™tre, et il y a le 21e si√®cle.  Par cons√©quent, il est n√©cessaire de tout recommencer et d'une mani√®re diff√©rente.  Au lieu des ampoules - LED √©conomiques.  Au lieu de fils - c√¢blage.  Au lieu d'un seul tiroir - beaucoup, beaucoup de petits tiroirs, des contr√¥leurs, donc. </p><br><p>  Il s'est av√©r√© que si chaque contr√¥leur peut desservir quatre LED et deux commutateurs, cela semblera optimal.  Je veux dire, pas si terrifiant.  Et si le bus d'alimentation et le bus d'informations passent par tous les contr√¥leurs, il n'y a que quatre fils, alors une certaine gr√¢ce appara√Ætra.  Il s'est √©galement av√©r√© que les contr√¥leurs auraient besoin de 104 pi√®ces.  De mani√®re amicale, il faudrait ici poser et r√©soudre le probl√®me du voyageur de commerce.  Et puis, peut-√™tre, les contr√¥leurs auraient d√©pens√© moins.  Mais ce n'√©tait pas √† la hauteur. </p><br><p>  √Ä ce moment-l√†, je savais d√©j√† ce qu'est le CAN et le niveau de mon respect pour Bosch √©tait beaucoup plus √©lev√© que celui d'un chef de restaurant d√©cent ou d'une femme au foyer bien rang√©e.  Et les constructeurs automobiles BMW, je suis s√ªr, sont m√™me all√©s voir les ing√©nieurs Bosch. </p><br><p>  Le Controller Area Network, comme diraient les √©trangers, √† mon avis, comme solution technique, est n√© du d√©sir de faire enfin quelque chose de bien.  Je ne me cacherai pas, vous ne ressentirez pas tout de suite les charmes des r√©sultats du travail des ing√©nieurs lorsque vous ma√Ætriserez deux volumes de la norme, mais bien plus tard.  Lorsque vous parlez √† des t√©moins oculaires, interrogez des t√©moins.  Maintenant, il y a plus de volumes, mais vous pouvez peut-√™tre commencer imm√©diatement √† partir du troisi√®me, car maintenant il s'appelle CAN_FD.  Mais permettez-moi de continuer. </p><br><p>  M√™me avant la collision avec le bouclier, j'ai d√ª rencontrer des d√©cisions d'ing√©nierie d'autres personnes sur l'utilisation du CAN, ainsi que commettre mes erreurs.  Des erreurs apparaissent g√©n√©ralement entre la lecture des instructions et l'√©tude des descriptions.  Eh bien, c'est seulement la deuxi√®me fois qu'ils ressemblent √† un r√¢teau. </p><br><p>  Maintenant quelques milliers de mots pour le lecteur, qui tol√®re les nerds et ne les consid√®re pas comme des ennemis. </p><br><p>  CAN peut √™tre install√© l√† o√π RS485 fonctionnait auparavant sur un c√¢ble √† paire torsad√©e.  La paire torsad√©e n'est pas une condition indispensable, elle est simplement pratique √† comparer.  √Ä l'aide d'un c√¢ble √† paire torsad√©e, via CAN, ainsi que via RS485, vous pouvez envoyer des messages du contr√¥leur de commande √† l'esclave et recevoir une r√©ponse.  La similitude est frappante, mais concentrons-nous davantage sur les diff√©rences.  Certaines des diff√©rences peuvent porter un signe moins pour certains lecteurs.  Mais je leur conseillerais de ne pas √™tre contrari√©, mais de rappeler la loi de Lomonosov. </p><br><p>  Gr√¢ce √† l'organisation synchrone du protocole, la r√©solution des collisions sur le bus est impl√©ment√©e en hardware, √† la vol√©e, pour ainsi dire.  Il est not√© ci-dessous √† quoi cela conduit et ce qui donne √† l'ing√©nieur agit√©. </p><br><p>  Vous pouvez recevoir un message sans demande. <br>  Pas besoin d'attendre que la r√©ponse soit pr√™te, vous pouvez demander √† quelqu'un d'autre √† ce moment. <br>  Le contr√¥leur esclave peut √©galement demander et obtenir une r√©ponse. <br>  En raison du fonctionnement synchrone, la longueur du bus CAN est inversement proportionnelle √† la vitesse de transmission ou quelque chose du genre. <br>  La vitesse maximale est de 1 MBaud (10 - en cours de route). <br>  L'exp√©diteur sait que le message n'a pas √©t√© d√©form√© pendant la transmission imm√©diatement apr√®s le dernier bit.  Plus pr√©cis√©ment, tout le monde dans le bus le sait. <br>  Si le message est d√©form√© pour un, la tentative n'est pas compt√©e par tous. <br>  Si le message a √©t√© envoy√© au bus, l'abonn√© ne le recevra pas √† condition qu'il soit rompu. <br>  Le nombre de contr√¥leurs sur le bus ne doit pas d√©passer 127. </p><br><p>  La dur√©e des messages est limit√©e.  Ils sont constitu√©s d'un identifiant, d'un indicateur de longueur en octets et d'un bloc de donn√©es, avec exactement autant d'octets qu'indiqu√©.  Il y a quelques bits de service suppl√©mentaires, mais restons silencieux √† leur sujet, car le service doit √™tre discret.  L'identifiant peut avoir une taille de 11 ou 29 bits.  Un bloc de donn√©es peut contenir de 0 √† 8 octets (64 - en cours de route). </p><br><p>  Pour plus de d√©tails, je vais donner quelques chiffres.  Si vous voulez travailler √† une vitesse de 1Mbaud, la longueur du bus ne doit pas d√©passer 35 m√®tres (certains pr√©f√®rent 40, c'est-√†-dire plus chaud).  Si vous devez transmettre quelque chose sur une distance de 8 km, la vitesse ne doit pas d√©passer 5 kbaud.  Soit dit en passant, le lecteur a le droit de demander pourquoi kilobod, et non kilobit?  Parce que tous les bauds ne deviennent pas des bits.  Quelque chose comme √ßa. </p><br><p>  Comment puis-je disposer de tous ces ingr√©dients top secrets?  Ceux qui voient le jeu de d√©s dans tout se souviendront imm√©diatement qu'il existe une chose aussi merveilleuse que CANopen et bien d'autres combinaisons et abr√©viations magnifiques et qu'il n'y a rien pour r√©inventer la roue.  Je veux donc souvent r√©pondre: ¬´Cet ≈ìuf au plat de deux ≈ìufs, que beaucoup cuisinent pour le petit-d√©jeuner, ne ressemble-t-il pas √† un v√©lo?  Pourquoi ne pas aller √† la restauration et prendre une omelette? ¬ª  Mais je ferais mieux de garder le silence et de continuer sans √™tre distrait par les cris du public. </p><br><p>  √Ä cette √©poque, alors que les identifiants 29 bits n'avaient pas encore √©t√© invent√©s, il n'y avait que 11 bits.  Certains ont commenc√© √† l'utiliser pour y entasser le nom (num√©ro) du type de donn√©es souhait√©.  D'autres sont utilis√©es comme adresse du contr√¥leur auquel vous acc√©dez.  Les deux avaient du sens.  Par exemple, vous pourriez demander ceci: </p><br><ul><li>  Et donnez-nous, ma ch√®re, un ch√¢teau de la treizi√®me ann√©e dans un litre de papier d'emballage. </li></ul><br><p>  Ou alors: </p><br><ul><li><p>  Enveloppez-moi, s'il vous pla√Æt, de ce qui est cach√© dans votre √©tag√®re du bas √† droite. <br>  Soit dit en passant, dans CAN, cette conception peut √©galement fonctionner: </p><br></li><li><p>  Mentez √† tout le monde!  Et tu as rapidement tout mis des √©tag√®res dans mon sac. <br>  Mais cette conception n'est souvent pas utilis√©e, car apr√®s il faut attendre un peu. <br>  Attendez que toutes les r√©ponses soient align√©es une par une et disponibles pour le contr√¥leur demandeur.  Nous avons d√©j√† quitt√© le film, si cela. <br>  Dans mon cas, je serais satisfait de la variante de l'identifiant comme adresse.  Sur les 11 bits, 7 √©taient n√©cessaires, et 4 autres restaient pour rendre certains messages plus urgents que d'autres, ainsi que pour marquer certains des contr√¥leurs comme √©tant les principaux. <br>  Certains inconv√©nients ont migr√© ici √† partir de RS485, √† savoir que les adresses devaient √™tre d√©finies manuellement sur chaque contr√¥leur.  Ensuite, v√©rifiez et r√©installez.  Et peut-√™tre revenir √† l'√©tape pr√©c√©dente et r√©p√©ter. <br>  Heureusement, √† cette √©poque, deux circonstances existaient d√©j√†. </p><br></li></ul><br><p>  Tout d'abord, un identifiant 29 bits est d√©j√† apparu.  Et le second est que de nombreux fabricants de microcontr√¥leurs ont commenc√© √† consid√©rer la condition que chaque puce a son propre num√©ro unique et plut√¥t long comme une bonne forme. </p><br><p>  D√©sormais, dans un identifiant long, 24 bits peuvent √™tre allou√©s en toute s√©curit√© pour une adresse unique.  Il en restait 5 autres, pour s'assurer que les trains diff√©raient en urgence, en direction (l√†, en arri√®re), en pr√©sence d'un wagon-restaurant et de voitures avec un confort accru. </p><br><p>  Si vous cessez de vous amuser et que vous devenez s√©rieux, appelez les agents des contr√¥leurs subordonn√©s et les autres patrons, alors vous pouvez cr√©er une table.  Elle sera montr√©e un peu plus tard. </p><br><p>  Un peu plus sur l'adressage.  Un num√©ro de puce unique, en r√®gle g√©n√©rale, occupe un nombre de bits bien sup√©rieur √† 24, par exemple 96 avec STM32FXXX.  Par cons√©quent, vous devez en quelque sorte obtenir 24 sur 96. J'ai choisi l'op√©ration XOR.  Vous pouvez choisir autre chose, mais un petit probl√®me subsistera.  Ce sont des correspondances d'adresses apr√®s r√©duction. </p><br><p>  La probabilit√© de ce probl√®me est extr√™mement faible, mais elle l'est.  Il est r√©soluble, mais ajoute du travail aux installateurs.  Ici, il faut se rappeler que les messages CAN peuvent ne pas contenir du tout de donn√©es.  Cela nous est utile pour d√©cider.  Il se compose des actions suivantes. </p><br><p>  Le contr√¥leur de contr√¥le (patron) envoie une demande de diffusion √† laquelle tous les agents doivent r√©pondre (il s'agit d'une demande avec une adresse nulle).  Les messages de r√©ponse avec une longueur de donn√©es nulle et des adresses correspondantes ne se g√¢teront pas, mais atteindront le patron sous la forme d'un. </p><br><p>  Il reste maintenant √† calculer combien de r√©ponses ont √©t√© re√ßues et combien elles devraient √™tre.  Si ces deux nombres co√Øncident, alors tout est en ordre.  S'il y a moins de r√©ponses que de contr√¥leurs, alors il y a une co√Øncidence d'adresses et il y a du travail pour les ajusteurs.  Et s'il y a plus de r√©ponses que de contr√¥leurs, alors vous devez penser √† une th√®se, car vous √™tes sur le point de d√©couvrir. </p><br><p>  Si le changement dans la longueur du message est consid√©r√© comme une variation de sa signification, vous pouvez obtenir des fonctionnalit√©s suppl√©mentaires, dont je parlerai plus tard si ma m√®re n'appelle pas √† manger. </p><br><p>  Un autre point int√©ressant est que si vous utilisez des identifiants courts et longs en m√™me temps, vous pouvez obtenir, par exemple, un adressage de groupe ou des requ√™tes partiellement diffus√©es.  Mais nous n'irons pas encore loin. </p><br><p>  Revenons au codage de l'identifiant. </p><br><p>  √Ä des fins d'adressage, 24 bits sont allou√©s dans l'identifiant √©tendu et six dans l'identifiant standard.  Une adresse avec une valeur de 0x000000 est diffus√©e pour l'identifiant √©tendu.  Pour un identifiant standard, une adresse nulle (ses 6 bits) est √©galement consid√©r√©e comme diffus√©e.  Les cinq bits de t√™te (hauts) des identificateurs long et court sont appel√©s en-t√™te, affectent la signification du message et sont d√©sign√©s par les lettres NVADR: </p><br><p><img src="https://habrastorage.org/webt/5a/ir/yt/5airytjd4ojg3bn15xhoh9qo5jw.jpeg"></p><br><p>  Bien s√ªr, pour le panneau de contr√¥le, il √©tait n√©cessaire de ne mettre en ≈ìuvre qu'une partie de ce sch√©ma.  Dans le premier projet avec un bouclier (ou sur le bouclier, √† quel point?) Des puces Cortex de NXP ont √©t√© utilis√©es, et dans les projets suivants (il y en avait), M0 de STMicroelectronics √©tait d√©j√† utilis√©. </p><br><p>  Quelques mots sur l'utilisation des identifiants courts.  Ces six bits qui sont allou√©s pour l'adressage ne s'adressent pas au contr√¥leur, mais au groupe.  Au d√©but, ce groupe a z√©ro pour tout le monde.  Ensuite, les agents sont configur√©s, apr√®s quoi certains ou tous deviennent des membres de leur groupe.  Maintenant une demande au groupe, nous obtenons les r√©ponses des agents que nous avons collect√©s dans ce groupe. </p><br><p>  Maintenant, un peu sur ce qui est ajout√© si vous interpr√©tez les messages avec diff√©rentes longueurs de donn√©es diff√©remment.  Par exemple, une requ√™te de longueur nulle aide beaucoup lors du d√©bogage, comme mentionn√© ci-dessus.  Une demande d'une longueur de 3 dessert l'espace variable de 1 638 octets. Une demande d'une longueur de 4 fait de m√™me, mais est destin√©e √† un agent de passerelle qui dessert un bus CAN de deuxi√®me niveau.  Ce bus peut √™tre compos√© d'un ou deux agents, mais √† quelques kilom√®tres de l√†. </p><br><p>  Les requ√™tes de longueur 5 et 6 sont √©galement destin√©es √† un espace de variables √† deux octets de taille 4194304. Deux bits ne sont pas utilis√©s pour l'adressage.  Un bit contr√¥le l'√©criture-lecture.  Un autre signale une erreur. </p><br><p>  Ensuite, 7 et 8 servent des mots de quatre octets.  Il y en a √©galement 4 194 304. </p><br><p>  Ces espaces sont communs √† tous les agents.  Chacun d'eux, selon le but, n'utilise qu'un segment de l'espace des variables.  Le contr√¥leur pour mesurer la temp√©rature en deux points est montr√© sur la photo.  C'est pour le d√©bogage et les tests. </p><br><p><img src="https://habrastorage.org/webt/eq/tc/8z/eqtc8z-q-gmhha4cyzqqceqdtjc.jpeg"></p><br><p>  Les contr√¥leurs sont connect√©s avec un c√¢ble plat pour 6 c≈ìurs.  Dual sont utilis√©s pour la nourriture.  La puce de vingt pieds est le STM32F042. </p><br><p>  Au dos se trouve le MAX3051, un pilote CAN dans le package SOT23-8. <br>  Eh bien, maman appelle pour manger. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr455620/">https://habr.com/ru/post/fr455620/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr455610/index.html">Intel Core i7-2600K l√©gendaire: test de Sandy Bridge en 2019 (partie 1)</a></li>
<li><a href="../fr455612/index.html">Nous r√©fl√©chissons aux personnages de jeux et dialogues sur les conseils d'√©crivains et sur l'exemple des partisans de la th√©orie d'une Terre plate</a></li>
<li><a href="../fr455614/index.html">FFI: √©crire en Rust dans un programme PHP</a></li>
<li><a href="../fr455616/index.html">Pourquoi aller √† "Programmation industrielle" au HSE de Saint-P√©tersbourg?</a></li>
<li><a href="../fr455618/index.html">DevOps LEGO: comment nous avons con√ßu un pipeline sur des cubes</a></li>
<li><a href="../fr455622/index.html">Intel Core i7-2600K l√©gendaire: test de Sandy Bridge en 2019 (partie 2)</a></li>
<li><a href="../fr455624/index.html">Hyper-victimes et ce que les concepteurs de jeux peuvent en tirer</a></li>
<li><a href="../fr455626/index.html">Wallarm Offzone2019 HackQuest</a></li>
<li><a href="../fr455630/index.html">√âv√©nements num√©riques √† Moscou du 11 au 16 juin</a></li>
<li><a href="../fr455632/index.html">Attention! Bogue dangereux dans l'impl√©mentation C ++ std :: map :: merge et std :: set :: merge dans Visual Studio 2017</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>