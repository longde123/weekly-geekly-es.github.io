<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåî üôãüèº üêó Flexible VerticalSwipeBehavior schreiben üßõüèª üêü üè≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo habr Mein Name ist Ilya Osintsev, ich bin ein Android-Entwickler bei Apiqa. Unter der Katze finden Sie ein Beispiel f√ºr die Verwendung von ViewD...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Flexible VerticalSwipeBehavior schreiben</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481910/"><p>  Hallo habr  Mein Name ist Ilya Osintsev, ich bin ein Android-Entwickler bei Apiqa.  Unter der Katze finden Sie ein Beispiel f√ºr die Verwendung von ViewDragHelper zum Erstellen einer Benutzeroberfl√§chenkomponente, die SwipeDismissBehavior √§hnelt, jedoch vertikal arbeitet. </p><br><p>  Mit dem Aufkommen von Material Design sind Anwendungen zu interaktiveren Elementen geworden, die auf Benutzeraktionen reagieren.  Sie sparen nicht nur Platz, sondern erm√∂glichen auch unterhaltsame Mikrointeraktionen.  In einigen unserer Projekte haben wir uns dazu entschlossen, vertikal bewegte Banner f√ºr die Mechanik zum Abweisen von Streichen zu verwenden.  Um der Oberfl√§che Lebendigkeit zu verleihen, m√ºssen Banner die Geschwindigkeit des Zeigers ber√ºcksichtigen und die Transparenz in Abh√§ngigkeit von der Richtung des Versatzes √§ndern. </p><a name="habracut"></a><br><h2 id="ocenivaem-zadachu">  Bewerten Sie die Aufgabe </h2><br><div class="scrollable-table"><table><thead><tr><th>  Pers√∂nliches B√ºro </th><th>  Kabinetttechniker </th></tr></thead><tbody><tr><td><img src="https://habrastorage.org/webt/au/bz/ma/aubzmap7axgperiid2fkvvttt20.jpeg" alt="Pers√∂nliches B√ºro"></td><td><img src="https://habrastorage.org/webt/c6/n6/ox/c6n6oxsscnhr7elqtgullowpjte.jpeg" alt="Kabinetttechniker"></td></tr></tbody></table></div><br><p>  In unserer Anwendung <a href="https://apiqa.io/case_pik_app">"Mein Konto" dient der</a> Banner als schnelle M√∂glichkeit, eine Anfrage f√ºr einen Mietersuchdienst f√ºr Ihre Wohnung zu hinterlassen.  In der Anwendung ‚ÄûAppliance Technique‚Äú k√∂nnen Sie mit dem Banner den Kontext der Arbeit des Benutzers mit der Aufgabe speichern, wenn Sie von einer Informationskarte zu Kommentaren wechseln.  Im ersten Fall betonen wir die Optionalit√§t des PIK-Rent-Dienstes und lassen den Kunden sich in der Anwendung wie zu Hause f√ºhlen.  In einem anderen Fall implementieren wir Swipe an der Eingabeaufforderung, sodass die Nachrichtenzeile zwischen dem Dispatcher und den Ausf√ºhrenden nicht √ºberlappt. </p><br><p>  Zu Beginn habe ich eine einfache Demo zusammengestellt, die auf SwipeDismissBehavior basiert, um zu lernen, wie es funktioniert, und um den Umfang der √Ñnderungen abzusch√§tzen.  Der Versuch, es im XML-Markup anzugeben, l√∂st bei der Ausf√ºhrung eine Ausnahme aus: </p><br><pre><code class="plaintext hljs">E/AndroidRuntime: FATAL EXCEPTION: main Process: io.apiqa.android.example, PID: 1024 android.view.InflateException: Binary XML file line #115: Could not inflate Behavior subclass com.google.android.material.behavior.SwipeDismissBehavior</code> </pre> <br><p>  Die Entwickler haben gegen den Behaviour-Vertrag versto√üen und vergessen, den <a href="">Klassenkonstruktor</a> aus dem Kontext und dem AttributeSet zu √ºberschreiben.  Sie k√∂nnen dieses Verhalten jetzt nur verwenden, indem Sie eine Instanz davon in Ihrem Code erstellen. Das Ansichtsverhalten entspricht jedoch auch dann grunds√§tzlich nicht unseren Anforderungen, auch wenn die horizontale Richtung nicht ber√ºcksichtigt wird. </p><br><p><img src="https://habrastorage.org/webt/sb/ud/5b/sbud5byhw9ufcoj7hpqdjg2lcbq.gif" alt="SwipeDismissBehavior sofort einsatzbereit"></p><br><p>  In den Protokollen der Demo-Anwendung wurden Meldungen angezeigt, die besagten, dass einige der Ber√ºhrungsereignisse nicht in den Handler fielen. </p><br><blockquote>  E / ViewDragHelper: PointerId = -1 wird ignoriert, da ACTION_DOWN f√ºr diesen Zeiger nicht vor ACTION_MOVE empfangen wurde.  Dies ist wahrscheinlich darauf zur√ºckzuf√ºhren, dass ViewDragHelper nicht alle Ereignisse im Ereignisstrom empfangen hat. </blockquote><p>  Als Alternative gab es eine auf <code>OnTouchListener</code> basierende <code>OnTouchListener</code> , die uns die M√∂glichkeit nahm, OnClickListener zu verwenden, was bedeutet, dass wir das Bewegungsgesetz des Banners in der Aktivit√§t beschreiben m√ºssen.  Wir m√∂chten die Bewegungsparameter (z. B. Empfindlichkeit) w√§hrend der Bewegung nicht √§ndern, und die Verwendung von OnTouchListener scheint hier √ºberfl√ºssig.  Au√üerdem wurden in beiden Projekten Banner in CoordinatorLayout platziert. </p><br><p>  Wenn Sie die Getters und Setter der optionalen Parameter nicht ber√ºcksichtigen, ist das SwipeDismissBehavior selbst ziemlich kurz und verwendet <code>ViewDragHelper</code> .  Ich habe <a href="https://medium.com/android-development-p-ractises/dragging-panel-with-viewdraghelper-6df8dd980082">mehrere</a> <a href="https://newfivefour.com/android-viewdraghelper-example-tutorial.html">Ver√∂ffentlichungen</a> √ºber ihn im Netzwerk gefunden und beschlossen, meine eigene Implementierung der erforderlichen Komponente zu schreiben. </p><br><h2 id="koordiniruem-s-viewdraghelper">  Wir koordinieren mit ViewDragHelper </h2><br><p>  <a href="https://developer.android.com/reference/androidx/customview/widget/ViewDragHelper.html">ViewDragHelper</a> ist eine Utility-Klasse, die die Drag &amp; Drop-Unterst√ºtzung auf der View-Ebene erleichtert.  Es verfolgt die Position von Widgets und enth√§lt mehrere n√ºtzliche Funktionen zum Animieren entlang einer oder zweier Achsen innerhalb der √ºbergeordneten ViewGroup.  F√ºr die Arbeit ben√∂tigt er einen Handler, der <a href="https://developer.android.com/reference/androidx/customview/widget/ViewDragHelper.Callback.html">ViewDragHelper.Callback</a> implementiert.  Der Handler hat eine obligatorische Methode, und damit sich das Banner zu bewegen beginnt, gen√ºgt es, ein paar weitere neu zu definieren.  Im Allgemeinen ist dieser Helfer einfach zu bedienen und in jedem Projekt verf√ºgbar, da er mit appcompat geliefert wird.  Um einen Helfer zu erstellen, ist ein Verweis auf das √ºbergeordnete CoordinatorLayout erforderlich, sodass eine verz√∂gerte Initialisierung organisiert wird.  In <code>onInterceptTouchEvent</code> und <code>onTouchEvent</code> wir die entsprechenden <code>onTouchEvent</code> aufrufen, der Rest der Logik befindet sich im Handler. </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VerticalSwipeBehavior</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">V: View</span></span></span><span class="hljs-class">&gt;: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CoordinatorLayout.Behavior</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">V</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">companion</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> { <span class="hljs-meta"><span class="hljs-meta">@Suppress(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"UNCHECKED_CAST"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">&lt;V: View&gt;</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">from</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(v: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">V</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: VerticalSwipeBehavior&lt;V&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> lp = v.layoutParams require(lp <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> CoordinatorLayout.LayoutParams) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> behavior = lp.behavior requireNotNull(behavior) require(behavior <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> VerticalSwipeBehavior) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> behavior <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> VerticalSwipeBehavior&lt;V&gt; } } <span class="hljs-meta"><span class="hljs-meta">@Suppress(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"unused"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() : <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>() <span class="hljs-meta"><span class="hljs-meta">@Suppress(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"unused"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(context: Context, attrs: AttributeSet) : <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(context, attrs) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dragHelper: ViewDragHelper? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> interceptingEvents = <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onInterceptTouchEvent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(parent: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">CoordinatorLayout</span></span></span></span><span class="hljs-function"><span class="hljs-params">, child: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">V</span></span></span></span><span class="hljs-function"><span class="hljs-params">, ev: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">MotionEvent</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> isIntercept = interceptingEvents <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (ev.actionMasked) { MotionEvent.ACTION_DOWN -&gt; { isIntercept = parent.isPointInChildBounds(child, ev.x.toInt(), ev.y.toInt()) interceptingEvents = isIntercept } MotionEvent.ACTION_UP, MotionEvent.ACTION_CANCEL -&gt; { interceptingEvents = <span class="hljs-literal"><span class="hljs-literal">false</span></span> } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isIntercept) { helper(parent).shouldInterceptTouchEvent(ev) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onTouchEvent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(parent: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">CoordinatorLayout</span></span></span></span><span class="hljs-function"><span class="hljs-params">, child: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">V</span></span></span></span><span class="hljs-function"><span class="hljs-params">, ev: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">MotionEvent</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> helper = helper(parent) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> isViewUnder = helper.isViewUnder(child, ev.x.toInt(), ev.y.toInt()) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (helper.capturedView == child || isViewUnder ) { helper.processTouchEvent(ev) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">helper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(parent: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">ViewGroup</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: ViewDragHelper { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> h = dragHelper <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (h == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { h = ViewDragHelper.create(parent, callback) dragHelper = h <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> h } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> h } }</code> </pre> <br><p>  In der erforderlichen <code>tryCaptureView</code> m√ºssen wir entscheiden, ob eine bestimmte Ansicht verschoben werden soll.  Damit der Helfer die notwendigen Ereignisse nicht verpasst, geben wir den zuvor empfangenen Zeiger zu.  Um die flexibelste L√∂sung zu erhalten, werden drei zus√§tzliche Schnittstellen eingef√ºhrt, √ºber die Sie das Banner-Design detailliert steuern k√∂nnen: </p><br><ul><li>  <code>SideEffect</code> spiegelt den <code>SideEffect</code> in den Ansichtseigenschaften wider </li><li>  <code>VerticalClamp</code> entwickelt, um die vertikale Bewegung der Ansicht zu begrenzen </li><li>  <code>PostAction</code> wird aufgerufen, nachdem der Benutzer das Wischen beendet hat. Hier k√∂nnen wir die Ansichtsbewegung fortsetzen. </li></ul><br><p>  In jedem von ihnen ist die Methode <code>onViewCaptured(View)</code> , hier k√∂nnen Client-Implementierungen die Anfangswerte der View-Eigenschaften extrahieren.  Die Reihenfolge der Aufrufe dieser Methode ist nicht garantiert. </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sideEffect: SideEffect = AlphaElevationSideEffect() <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> clamp: VerticalClamp = FractionConstraintWithTopMargin(<span class="hljs-number"><span class="hljs-number">1f</span></span>, <span class="hljs-number"><span class="hljs-number">1f</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> settle: PostAction = OriginSettleAction() <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> callback = <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>: ViewDragHelper.Callback() { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> INVALID_POINTER_ID = -<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> currentPointer = INVALID_POINTER_ID <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> originTop: <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tryCaptureView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(child: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">, pointerId: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentPointer == INVALID_POINTER_ID || pointerId == currentPointer } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onViewCaptured</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(child: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">, activePointerId: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { originTop = child.top currentPointer = activePointerId sideEffect.onViewCaptured(child) settle.onViewCaptured(child) clamp.onViewCaptured(child.top) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onViewReleased</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(child: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">, xvel: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Float</span></span></span></span><span class="hljs-function"><span class="hljs-params">, yvel: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// TODO currentPointer = INVALID_POINTER_ID } override fun clampViewPositionHorizontal(child: View, left: Int, dx: Int) = child.left // TODO }</span></span></code> </pre> <br><p>  Obwohl sich unsere Ansicht nicht vertikal bewegt, m√ºssen wir daran denken, <code>clampViewPositionHorizontal</code> im Handler zu implementieren, um visuelle Fehler zu vermeiden.  Eine einfache Implementierung gibt die linke Koordinate zur√ºck, was bedeutet, dass sich das Widget nicht horizontal bewegt. </p><br><p>  In unserem Fall wird der Aufruf des <code>clampViewPositionVertical</code> an die <em>VerticalClamp-</em> Schnittstelle delegiert.  Die <code>constraint</code> sollte eine H√∂henkoordinate zur√ºckgeben, die durch die maximale und / oder minimale Ansichtsposition begrenzt ist.  Wenn es erreicht ist, begrenzt ViewDragHelper die Bewegung.  Die <code>upCast(distance, top, height, dy)</code> und <code>downCast</code> haben dieselbe Signatur und geben einen Bruchteil der zur√ºckgelegten Strecke zur√ºck, wobei die urspr√ºngliche Position der Ansicht ber√ºcksichtigt wird.  In der <code>onViewPositionChanged</code> wir den Fortschritt des Verschiebens und √ºbergeben ihn an <code>SideEffect#apply(View, Float)</code> , in dem Sie die Transparenz oder andere Ansichtseigenschaften abh√§ngig vom Fortschritt der Geste √§ndern k√∂nnen.  Ist die aktuelle Position der Ansicht h√∂her als die urspr√ºngliche, wird der Fortschritt mit einem Minuszeichen √ºbertragen. </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clampViewPositionVertical</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(child: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">, top: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, dy: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> clamp.constraint(child.height, top, dy) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onViewPositionChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(child: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">, left: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, top: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, dx: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, dy: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> factor = <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (top &lt; originTop) { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> diff = originTop - top -clamp.bottomCast(diff, top, child.height, dy) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> diff = top - originTop clamp.topCast(diff, top, child.height, dy) } sideEffect.apply(child, factor) }</code> </pre> <br><p>  Standardm√§√üig wird <code>FractionClamp</code> verwendet, wodurch die Bewegung der Ansicht um eine H√∂he nach oben und unten begrenzt wird (die Koeffizienten werden im Konstruktor festgelegt). <code>AlphaElevationSideEffect</code> √§ndert die Transparenz und H√∂he des Banners.  Um die Aufgabe als erledigt zu betrachten, m√ºssen Sie die F√§higkeit zum animierten Verschieben des Banners hinzuf√ºgen, nachdem der Benutzer es freigegeben hat. </p><br><p>  Wenn der Benutzer die Ansicht freigibt, merkt sich der Helfer die Geschwindigkeit des Zeigers und ruft <code>onViewReleased</code> auf dem Handler auf.  Darin k√∂nnen wir die Bewegungsanimation mit <code>settleCapturedViewAt</code> oder <code>smoothSlideViewTo</code> .  Gem√§√ü dem Vertrag sollte <code>continueSettling</code> nach einem erfolgreichen Aufruf in jedem n√§chsten Frame aufgerufen werden, damit sich die Ansicht weiter bewegt.  In diesem Fall kann <em>settleCapturedViewAt</em> nur von der onViewReleased-Methode aufgerufen werden, wenn das interne Flag des mReleaseInProgress- <em>Helfers</em> auf true festgelegt ist.  Ein weiterer Unterschied besteht darin, dass <em>smoothSlideViewTo</em> die Geschwindigkeit des Zeigers nicht ber√ºcksichtigt. </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onViewReleased</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(child: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">, xvel: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Float</span></span></span></span><span class="hljs-function"><span class="hljs-params">, yvel: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> diff = child.top - originTop <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (abs(yvel) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> settled = dragHelper?.let { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (diff &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { settle.releasedBelow(it, diff, child) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { settle.releasedAbove(it, diff, child) } } ?: <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (settled) { listener?.onPreSettled(diff) child.postOnAnimation(RecursiveSettle(child, diff)) } } currentPointer = INVALID_POINTER_ID }</code> </pre> <br><p>  Diese Logik ist in der <code>PostAction</code> Schnittstelle gekapselt.  Die Methoden <code>releasedAbove</code> und <code>releasedBelow</code> k√∂nnen so implementiert werden, dass sich das Banner beim Hochfahren mit der gleichen Geschwindigkeit weiter bewegt, den Bildschirm verl√§sst und beim Herunterfahren an seine urspr√ºngliche Position zur√ºckkehrt.  Wenn eine der Methoden true zur√ºckgibt, wurde die Animation ausgel√∂st und der Ansichtsereigniswarteschlange wird ein RecursiveSettle hinzugef√ºgt, der in der Warteschlange verbleibt, bis die Animation beendet ist.  Standardm√§√üig wird <code>OriginSettleAction</code> verwendet, wenn die Ansicht an einem beliebigen Versatz zum Startpunkt zur√ºckkehrt.  Eine weitere Option - <code>SettleOnTopAction</code> beim Verschieben der Ansicht nach unten zum Startpunkt und beim Verschieben nach oben vom Bildschirm weg. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SettleOnTopAction</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostAction</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> originTop: Int = -<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onViewCaptured</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(child: View)</span></span></span><span class="hljs-function"> </span></span>{ originTop = child.top } <span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">releasedAbove</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(helper: ViewDragHelper, child: View)</span></span></span><span class="hljs-function">: Boolean </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> helper.settleCapturedViewAt(child.left, originTop) } <span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">releasedBelow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(helper: ViewDragHelper, child: View)</span></span></span><span class="hljs-function">: Boolean </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> helper.settleCapturedViewAt(child.left, -child.height) } }</code> </pre> <br><p>  Bei Bedarf k√∂nnen Sie Ereignisse abonnieren, indem Sie die <code>VerticalSwipeBehavior.SwipeListener</code> Schnittstelle implementieren.  Es gibt zwei symmetrische Methoden, eine vor dem Start der Verschiebungsanimation und die andere nach dem Ende.  Das Argument gibt die Richtung und Entfernung an, in der der Benutzer das Banner freigegeben hat.  Das resultierende Ergebnis erf√ºllt unsere Anforderungen. </p><br><p><img src="https://habrastorage.org/webt/fw/er/9e/fwer9eaidf1vlmzsym0wyygdbvm.gif" alt="Das resultierende Ergebnis"></p><br><p>  Um das Ergebnis zu erhalten, m√ºssen Sie die Eigenschaften wie folgt definieren: </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> drag = findViewById&lt;View&gt;(R.id.drag) VerticalSwipeBehavior.from(drag).apply { settle = SettleOnTopAction() sideEffect = NegativeFactorFilterSideEffect(AlphaElevationSideEffect()) clamp = BelowFractionalClamp() }</code> </pre> <br><p>  √úbrigens bietet der Helfer auch andere Bewegungssteuerungsfunktionen.  Mit der Methode <code>setMinVelocity(Float)</code> k√∂nnen Sie beispielsweise die Mindestgeschwindigkeit f√ºr das Verschieben der Ansicht begrenzen.  Der Helfer unterst√ºtzt auch die Erkennung von Wischbewegungen an den R√§ndern des Bildschirms. Dazu m√ºssen Sie sie in der <code>setEdgeTrackingEnabled(Int)</code> -Methode angeben.  Es sollte beachtet werden, dass eine Instanz von ViewDragHelper die Bewegung von nur einer Ansicht steuern kann und nur einen Zeiger ber√ºcksichtigt. </p><br><h2 id="delaem-vyvody">  Schl√ºsse ziehen </h2><br><p>  Ich habe die Erfahrung gemacht, dass ViewDragHelper das Erstellen von Drag &amp; Drop oder das Verschieben von Bedienfeldern in einer Anwendung vereinfacht.  Helper ist einfach in Behavior zu verwenden oder ViewGroup zu √ºberschreiben.  Es verf√ºgt √ºber mehrere n√ºtzliche Methoden zum Animieren der Ansicht und zum Steuern ihrer Bewegung.  Das Studium der internen Implementierung von Material Design-Komponenten ist eine gute Erfahrung in der Karriere eines Android-Entwicklers.  Solche Aufgaben von Designern motivieren mich, neue Ans√§tze zum Aufbau einer Anwendungsschnittstelle zu untersuchen und Wissen mit Kollegen und der Community zu teilen. </p><br><p>  Sie k√∂nnen die resultierende Bibliothek in Ihren Projekten verwenden.  <code>build.gradle</code> zum <code>build.gradle</code> die Abh√§ngigkeit in der Datei <code>build.gradle</code> </p><br><pre> <code class="plaintext hljs">dependencies { implementation 'io.apiqa.android:verticalswipebehavior:1.0.0' }</code> </pre> <br><p>  <code>app:layout_behavior="io.apiqa.android.verticalswipe.VerticalSwipeBehavior"</code> f√ºr eine geeignete Ansicht im CoordinatorLayout die <code>app:layout_behavior="io.apiqa.android.verticalswipe.VerticalSwipeBehavior"</code> Eigenschaft an <code>app:layout_behavior="io.apiqa.android.verticalswipe.VerticalSwipeBehavior"</code> im Markup.  Sie k√∂nnen das Banner mithilfe von Einz√ºgen innerhalb des √ºbergeordneten Elements positionieren.  Durch die Koordination der <em>Implementierungen</em> von <em>SideEffect</em> , <em>VerticalClamp</em> und <em>PostAction k√∂nnen</em> Sie das <em>gew√ºnschte</em> Banner-Verhalten erzielen.  Im <a href="https://github.com/pik-software/android-verticalSwipeBehavior">Repository</a> sind jeweils Arbeitsversionen verf√ºgbar. </p><br><p>  <em>Frohes neues Jahr!</em> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de481910/">https://habr.com/ru/post/de481910/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de481896/index.html">PHP gegen ASP.NET: Wie man das rechte w√§hlt?</a></li>
<li><a href="../de481898/index.html">Einfacher Webserver f√ºr SPA / PWA in 5 Minuten</a></li>
<li><a href="../de481902/index.html">Modellierung des Betriebs eines realen W√§rmekraftwerks zur Optimierung der Modi: Dampf und Mathematik</a></li>
<li><a href="../de481904/index.html">Vladimir Marshinin aka mavl: "Mit dem Aufruf" Keine anderen Karten kopieren "k√∂nnen Sie OpenStreetMap-Lizenzprobleme vermeiden"</a></li>
<li><a href="../de481906/index.html">Chinesisches Gehirn oder zur Verteidigung des Fr√ºhlings</a></li>
<li><a href="../de481912/index.html">Ich war eine Woche lang Praktikant bei SRE-engineer. Beobachten Sie mit den Augen eines Software-Ingenieurs</a></li>
<li><a href="../de481914/index.html">Spring Boot vs Spring MVC vs Spring - Wie vergleichen sie?</a></li>
<li><a href="../de481916/index.html">Woran hat sich das Jahr 2019 in der Entwicklung erinnert?</a></li>
<li><a href="../de481922/index.html">Neujahr IMaskjs 6 - Reagieren Sie Native, Pipes, ESM</a></li>
<li><a href="../de481924/index.html">Apache Spark, Lazy Evaluation und mehrseitige SQL-Abfragen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>