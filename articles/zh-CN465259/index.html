<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘¨ğŸ¾â€ğŸ¨ ğŸ§œğŸ» ğŸ¦‰ ValueTask <TResult>-ä¸ºä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆä»¥åŠå¦‚ä½•ï¼Ÿ ğŸ‘” ğŸ™ŒğŸ½ ğŸ¤¸ğŸ¼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ç¿»è¯‘åºè¨€ 


 ä¸ç§‘å­¦æ–‡ç« ä¸åŒï¼Œè¿™ç±»æ–‡ç« å¾ˆéš¾â€œæ¥è¿‘æ–‡æœ¬â€åœ°ç¿»è¯‘ï¼Œå› æ­¤å¿…é¡»è¿›è¡Œå¤§é‡æ”¹ç¼–ã€‚ å› æ­¤ï¼Œå¯¹äºå¤„ç†åŸå§‹æ–‡ç« çš„æ–‡å­—æ–¹é¢çš„æŸäº›è‡ªç”±ï¼Œæˆ‘æ·±è¡¨æ­‰æ„ã€‚ æˆ‘çš„ç›®æ ‡åªæœ‰ä¸€ä¸ª-ä½¿ç¿»è¯‘æ˜“äºç†è§£ï¼Œå³ä½¿åœ¨æŸäº›åœ°æ–¹å®ƒä¸åŸå§‹æ–‡ç« æœ‰å¾ˆå¤§å‡ºå…¥ã€‚ å¯¹äºå»ºè®¾æ€§çš„æ‰¹è¯„ä»¥åŠå¯¹è¯‘æ–‡çš„ä¿®æ­£/è¡¥å……ï¼Œæˆ‘å°†ä¸èƒœæ„Ÿæ¿€ã€‚ 
 å¼•è¨€ 


 Sy...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ValueTask <TResult>-ä¸ºä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆä»¥åŠå¦‚ä½•ï¼Ÿ</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/clrium/blog/465259/"><h3 id="predislovie-k-perevodu">  <em>ç¿»è¯‘åºè¨€</em> </h3><br><p>  <em>ä¸ç§‘å­¦æ–‡ç« ä¸åŒï¼Œè¿™ç±»æ–‡ç« å¾ˆéš¾â€œæ¥è¿‘æ–‡æœ¬â€åœ°ç¿»è¯‘ï¼Œå› æ­¤å¿…é¡»è¿›è¡Œå¤§é‡æ”¹ç¼–ã€‚</em>  <em>å› æ­¤ï¼Œå¯¹äºå¤„ç†åŸå§‹æ–‡ç« çš„æ–‡å­—æ–¹é¢çš„æŸäº›è‡ªç”±ï¼Œæˆ‘æ·±è¡¨æ­‰æ„ã€‚</em>  <em>æˆ‘çš„ç›®æ ‡åªæœ‰ä¸€ä¸ª-ä½¿ç¿»è¯‘æ˜“äºç†è§£ï¼Œå³ä½¿åœ¨æŸäº›åœ°æ–¹å®ƒä¸åŸå§‹æ–‡ç« æœ‰å¾ˆå¤§å‡ºå…¥ã€‚</em>  <em>å¯¹äºå»ºè®¾æ€§çš„æ‰¹è¯„ä»¥åŠå¯¹è¯‘æ–‡çš„ä¿®æ­£/è¡¥å……ï¼Œæˆ‘å°†ä¸èƒœæ„Ÿæ¿€ã€‚</em> </p><br><h2 id="vvedenie"> å¼•è¨€ </h2><br><p> <code>System.Threading.Tasks</code>å‘½åç©ºé—´å’Œ<code>Task</code>ç±»é¦–å…ˆæ˜¯åœ¨.NET Framework 4ä¸­å¼•å…¥çš„ã€‚æ­¤åï¼Œæ­¤ç±»å‹åŠå…¶æ´¾ç”Ÿç±»<code>Task&lt;TResult&gt;</code>ç‰¢å›ºåœ°è¿›å…¥äº†.NETç¼–ç¨‹çš„å®è·µï¼Œå¹¶æˆä¸ºå¼‚æ­¥æ¨¡å‹çš„å…³é”®æ–¹é¢ã€‚åœ¨Cï¼ƒ5ä¸­å®ç°ï¼Œå…¶<code>async/await</code> ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†è®¨è®ºå¼•å…¥æ–°ç±»å‹çš„<code>ValueTask/ValueTask&lt;TResult&gt;</code> ï¼Œå…¶ç›®çš„æ˜¯åœ¨å¤„ç†å†…å­˜çš„å¼€é”€èµ·å…³é”®ä½œç”¨çš„æƒ…å†µä¸‹æé«˜å¼‚æ­¥ä»£ç çš„æ€§èƒ½ã€‚ </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/webt/f4/7b/3c/f47b3cblzfyn77xgh1odpwfgy5i.jpeg"></a> </p><a name="habracut"></a><br><h2 id="task"> å·¥ä½œä»»åŠ¡ </h2><br><p>  <code>Task</code>å¤šç§ç”¨é€”ï¼Œä½†ä¸»è¦ç›®çš„æ˜¯â€œæ‰¿è¯ºâ€-è¡¨ç¤ºç­‰å¾…æ“ä½œå®Œæˆçš„èƒ½åŠ›çš„å¯¹è±¡ã€‚ æ‚¨å¯åŠ¨æ“ä½œå¹¶è·å–<code>Task</code> ã€‚ æ“ä½œæœ¬èº«å®Œæˆåï¼Œå°†å®Œæˆæ­¤<code>Task</code> ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæœ‰ä¸‰ä¸ªé€‰é¡¹ï¼š </p><br><ol><li> è¯¥æ“ä½œåœ¨å¯åŠ¨å™¨çº¿ç¨‹ä¸­åŒæ­¥å®Œæˆã€‚  <em>ä¾‹å¦‚ï¼Œå½“è®¿é—®ä¸€äº›å·²ç»åœ¨bufferä¸­çš„æ•°æ®æ—¶</em> ã€‚ </li><li> è¯¥æ“ä½œæ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œä½†æ˜¯è®¾æ³•<em>åœ¨</em>å‘èµ·æ–¹æ”¶åˆ°<code>Task</code> ã€‚  <em>ä¾‹å¦‚ï¼Œå½“æ‰§è¡Œå¯¹å°šæœªç¼“å†²çš„æ•°æ®çš„å¿«é€Ÿè®¿é—®æ—¶</em> </li><li> è¯¥æ“ä½œæ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œå¹¶<em>åœ¨</em>å¯åŠ¨ç¨‹åºæ¥æ”¶åˆ°<code>Task</code> <em>ä¹‹å</em>ç»“æŸ<em>ï¼Œ</em> <em>ä¾‹å¦‚é€šè¿‡ç½‘ç»œæ¥æ”¶æ•°æ®</em> ã€‚ </li></ol><br><p> ä¸ºäº†è·å¾—å¼‚æ­¥è°ƒç”¨çš„ç»“æœï¼Œå®¢æˆ·ç«¯å¯ä»¥åœ¨ç­‰å¾…å®Œæˆæ—¶é˜»å¡è°ƒç”¨çº¿ç¨‹ï¼Œè¿™é€šå¸¸ä¸å¼‚æ­¥çš„æ¦‚å¿µç›¸æŠµè§¦ï¼Œæˆ–è€…æä¾›ä¸€ç§å°†åœ¨å¼‚æ­¥æ“ä½œå®Œæˆåæ‰§è¡Œçš„å›è°ƒæ–¹æ³•ã€‚ ä½¿ç”¨<code>Task</code>ç±»çš„å¯¹è±¡çš„<code>ContinueWith</code>æ–¹æ³•æ˜¾å¼å‘ˆç°.NET 4ä¸­çš„å›è°ƒæ¨¡å‹ï¼Œè¯¥æ–¹æ³•æ¥æ”¶ä¸€ä¸ªå§”æ‰˜ï¼Œè¯¥å§”æ‰˜åœ¨å¼‚æ­¥æ“ä½œå®Œæˆæ—¶è¢«è°ƒç”¨ã€‚ </p><br><pre> <code class="plaintext hljs">SomeOperationAsync().ContinueWith(task =&gt; { try { TResult result = task.Result; UseResult(result); } catch (Exception e) { HandleException(e); } });</code> </pre> <br><p> ä½¿ç”¨.NET Frmaework 4.5å’ŒCï¼ƒ5ï¼Œé€šè¿‡å¼•å…¥<code>async/await</code>å…³é”®å­—åŠå…¶èƒŒåçš„æœºåˆ¶ï¼Œç®€åŒ–äº†å¼‚æ­¥æ“ä½œçš„ç»“æœã€‚ è¿™ç§æœºåˆ¶ï¼ˆç”Ÿæˆçš„ä»£ç ï¼‰èƒ½å¤Ÿä¼˜åŒ–ä¸Šè¿°æ‰€æœ‰æƒ…å†µï¼Œå³ä½¿åˆ°è¾¾ç›®æ ‡è·¯å¾„ä¹Ÿèƒ½æ­£ç¡®å¤„ç†å®Œæˆã€‚ </p><br><pre> <code class="plaintext hljs">TResult result = await SomeOperationAsync(); UseResult(result);</code> </pre> <br><p>  <code>Task</code>ç±»éå¸¸çµæ´»ï¼Œå¹¶å…·æœ‰å¤šä¸ªä¼˜ç‚¹ã€‚ ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥å¤šæ¬¡â€œæœŸæœ›â€æ­¤ç±»çš„å¯¹è±¡ï¼Œå¯ä»¥ç”±ä»»æ„æ•°é‡çš„æ¶ˆè´¹è€…ç«äº‰æ€§åœ°é¢„æœŸç»“æœã€‚ å¯ä»¥å°†ä¸€ä¸ªç±»çš„å®ä¾‹å­˜å‚¨åœ¨å­—å…¸ä¸­ï¼Œä»¥ç”¨äºä»»ä½•æ•°é‡çš„åç»­è°ƒç”¨ï¼Œå…¶ç›®æ ‡æ˜¯å°†æ¥â€œç­‰å¾…â€ã€‚ æ‰€æè¿°çš„æ–¹æ¡ˆä½¿æ‚¨å¯ä»¥å°†<code>Task</code>å¯¹è±¡è§†ä¸ºä¸€ç§å¼‚æ­¥è·å–ç»“æœçš„ç¼“å­˜ã€‚ æ­¤å¤–ï¼Œå¦‚æœè„šæœ¬éœ€è¦ï¼Œ <code>Task</code>è¿˜å¯ä»¥é˜»æ­¢ç­‰å¾…çº¿ç¨‹ï¼Œç›´åˆ°æ“ä½œå®Œæˆã€‚ ä¹Ÿæœ‰æ‰€è°“çš„ã€‚ ç»„åˆå™¨ï¼Œç”¨äºç­‰å¾…ä»»åŠ¡é›†å®Œæˆçš„å„ç§ç­–ç•¥ï¼Œä¾‹å¦‚â€œ Task.WhenAnyâ€-å¼‚æ­¥ç­‰å¾…è®¸å¤šä»»åŠ¡ä¸­ç¬¬ä¸€ä¸ªä»»åŠ¡çš„å®Œæˆã€‚ </p><br><p> ä½†æ˜¯ï¼Œå°½ç®¡å¦‚æ­¤ï¼Œæœ€å¸¸è§çš„ç”¨ä¾‹åªæ˜¯å¯åŠ¨å¼‚æ­¥æ“ä½œï¼Œç„¶åç­‰å¾…å…¶æ‰§è¡Œç»“æœã€‚ è¿™ç§ç®€å•çš„æƒ…å†µéå¸¸æ™®éï¼Œä¸éœ€è¦ä¸Šé¢çš„çµæ´»æ€§ï¼š </p><br><pre> <code class="plaintext hljs">TResult result = await SomeOperationAsync(); UseResult(result);</code> </pre> <br><p> è¿™ä¸æˆ‘ä»¬ç¼–å†™åŒæ­¥ä»£ç çš„æ–¹å¼éå¸¸ç›¸ä¼¼ï¼ˆä¾‹å¦‚<code>TResult result = SomeOperation();</code> ï¼‰ã€‚ æ­¤é€‰é¡¹è‡ªç„¶è½¬æ¢ä¸º<code>async/await</code> ã€‚ </p><br><p> æ­¤å¤–ï¼Œå°½ç®¡å…·æœ‰æ‰€æœ‰ä¼˜ç‚¹ï¼Œä½†<code>Task</code>ç±»å‹å…·æœ‰æ½œåœ¨çš„ç¼ºé™·ã€‚  <code>Task</code>æ˜¯ä¸€ä¸ªç±»ï¼Œè¿™æ„å‘³ç€æ¯ä¸ªåˆ›å»ºä»»åŠ¡å®ä¾‹çš„æ“ä½œéƒ½ä¼šåœ¨å †ä¸Šåˆ†é…ä¸€ä¸ªå¯¹è±¡ã€‚ æˆ‘ä»¬åˆ›å»ºçš„å¯¹è±¡è¶Šå¤šï¼ŒGCæ‰€éœ€çš„å·¥ä½œå°±è¶Šå¤šï¼Œåƒåœ¾å›æ”¶å™¨çš„å·¥ä½œå°±èŠ±è´¹äº†æ›´å¤šçš„èµ„æºï¼Œè¿™äº›èµ„æºå¯ç”¨äºå…¶ä»–ç›®çš„ã€‚ è¿™å¯¹äºä»£ç æ¥è¯´æ˜¯ä¸€ä¸ªæ˜æ˜¾çš„é—®é¢˜ï¼Œå…¶ä¸­ä¸€æ–¹é¢ç»å¸¸åˆ›å»º<code>Task</code>å®ä¾‹ï¼Œå¦ä¸€æ–¹é¢åˆå¢åŠ äº†å¯¹ååé‡å’Œæ€§èƒ½çš„è¦æ±‚ã€‚ </p><br><p> åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œè¿è¡Œæ—¶åº“å’Œä¸»åº“å¯ä»¥å‡è½»è¿™ç§å½±å“ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨ç¼–å†™ä»¥ä¸‹æ–¹æ³•ï¼š </p><br><pre> <code class="plaintext hljs">public async Task WriteAsync(byte value) { if (_bufferedCount == _buffer.Length) { await FlushAsync(); } _buffer[_bufferedCount++] = value; }</code> </pre> <br><p> å¹¶ä¸”é€šå¸¸ï¼Œç¼“å†²åŒºä¸­å°†æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œæ“ä½œå°†åŒæ­¥ç»“æŸã€‚ å¦‚æœæ˜¯è¿™æ ·ï¼Œåˆ™è¿”å›çš„ä»»åŠ¡æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œæ²¡æœ‰è¿”å›å€¼ï¼Œå¹¶ä¸”è¯¥æ“ä½œå·²ç»å®Œæˆã€‚ æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬æ­£åœ¨å¤„ç†<code>Task</code> ï¼Œå®ƒç­‰æ•ˆäºåŒæ­¥<code>void</code>æ“ä½œã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿è¡Œæ—¶ä»…ç¼“å­˜<code>Task</code>å¯¹è±¡ï¼Œå¹¶ä¸”æ¯æ¬¡å°†å…¶ç”¨ä½œä»»ä½•<code>async Task</code>çš„ç»“æœ-åŒæ­¥å®Œæˆçš„æ–¹æ³•ï¼ˆ <code>Task.ComletedTask</code> ï¼‰ã€‚ å†ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå‡è®¾æ‚¨ç¼–å†™ï¼š </p><br><pre> <code class="plaintext hljs">public async Task&lt;bool&gt; MoveNextAsync() { if (_bufferedCount == 0) { await FillBuffer(); } return _bufferedCount &gt; 0; }</code> </pre> <br><p> ä»¥åŒæ ·çš„æ–¹å¼ï¼Œå‡è®¾å¤§å¤šæ•°æƒ…å†µä¸‹ç¼“å†²åŒºä¸­æœ‰ä¸€äº›æ•°æ®ã€‚ è¯¥æ–¹æ³•æ£€æŸ¥<code>_bufferedCount</code> ï¼ŒæŸ¥çœ‹è¯¥å˜é‡å¤§äºé›¶ï¼Œç„¶åè¿”å›<code>true</code> ã€‚ ä»…åœ¨éªŒè¯æ—¶æœªç¼“å†²æ•°æ®æ—¶ï¼Œæ‰éœ€è¦å¼‚æ­¥æ“ä½œã€‚ å°½ç®¡å¦‚æ­¤ï¼Œåªæœ‰ä¸¤ä¸ªå¯èƒ½çš„é€»è¾‘ç»“æœï¼ˆ <code>true</code>å’Œ<code>false</code> ï¼‰ï¼Œä»¥åŠé€šè¿‡<code>Task&lt;bool&gt;</code>ä¸¤ä¸ªå¯èƒ½çš„è¿”å›çŠ¶æ€ã€‚ åŸºäºåŒæ­¥å®Œæˆæˆ–å¼‚æ­¥ï¼Œä½†åœ¨é€€å‡ºæ–¹æ³•ä¹‹å‰ï¼Œè¿è¡Œæ—¶å°†ç¼“å­˜<code>Task&lt;bool&gt;</code>ä¸¤ä¸ªå®ä¾‹ï¼ˆä¸€ä¸ªè¡¨ç¤º<code>true</code> ï¼Œå¦ä¸€ä¸ªè¡¨ç¤º<code>false</code> ï¼‰ï¼Œå¹¶è¿”å›æ‰€éœ€çš„ä¸€ä¸ªï¼Œä»è€Œé¿å…äº†å…¶ä»–åˆ†é…ã€‚ å½“æ‚¨å¿…é¡»åˆ›å»ºä¸€ä¸ªæ–°çš„<code>Task&lt;bool&gt;</code>å¯¹è±¡æ—¶ï¼Œå”¯ä¸€çš„é€‰æ‹©æ˜¯å¼‚æ­¥æ‰§è¡Œï¼Œè¿™ç§æƒ…å†µåœ¨â€œè¿”å›â€ä¹‹åç»“æŸã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯¥æ–¹æ³•å¿…é¡»åˆ›å»ºä¸€ä¸ªæ–°çš„<code>Task&lt;bool&gt;</code>å¯¹è±¡ï¼Œå› ä¸º åœ¨é€€å‡ºè¯¥æ–¹æ³•æ—¶ï¼Œå°šä¸çŸ¥é“æ“ä½œå®Œæˆçš„ç»“æœã€‚ è¿”å›çš„å¯¹è±¡å¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œå› ä¸º å®ƒå°†æœ€ç»ˆå­˜å‚¨å¼‚æ­¥æ“ä½œçš„ç»“æœã€‚ </p><br><p> ä»è¿è¡Œæ—¶è¿˜æœ‰å…¶ä»–ç±»ä¼¼çš„ç¼“å­˜ç¤ºä¾‹ã€‚ ä½†æ˜¯ï¼Œè¿™ç§ç­–ç•¥å¹¶éåœ¨æ‰€æœ‰åœ°æ–¹éƒ½é€‚ç”¨ã€‚ ä¾‹å¦‚ï¼Œæ–¹æ³•ï¼š </p><br><pre> <code class="plaintext hljs">public async Task&lt;int&gt; ReadNextByteAsync() { if (_bufferedCount == 0) { await FillBuffer(); } if (_bufferedCount == 0) { return -1; } _bufferedCount--; return _buffer[_position++]; }</code> </pre> <br><p> ä¹Ÿç»å¸¸åŒæ­¥ç»“æŸã€‚ ä½†æ˜¯ï¼Œä¸å‰é¢çš„ç¤ºä¾‹ä¸åŒï¼Œæ­¤æ–¹æ³•è¿”å›çš„æ•´æ•°ç»“æœå¤§çº¦æœ‰40äº¿ä¸ªå¯èƒ½å€¼ã€‚ è¦ç¼“å­˜<code>Task&lt;int&gt;</code> ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†éœ€è¦æ•°ç™¾GBçš„å†…å­˜ã€‚ æ­¤å¤„çš„ç¯å¢ƒè¿˜æ”¯æŒ<code>Task&lt;int&gt;</code>çš„å°å‹ç¼“å­˜ï¼Œå…¶ä¸­åŒ…å«å‡ ä¸ªè¾ƒå°çš„å€¼ã€‚ å› æ­¤ï¼Œä¾‹å¦‚ï¼Œå¦‚æœæ“ä½œåŒæ­¥å®Œæˆï¼ˆç¼“å†²åŒºä¸­å­˜åœ¨æ•°æ®ï¼‰ï¼Œç»“æœä¸º4ï¼Œåˆ™å°†ä½¿ç”¨ç¼“å­˜ã€‚ ä½†æ˜¯ï¼Œå¦‚æœç»“æœæ˜¯åŒæ­¥çš„ï¼Œä½†å®Œæˆæ˜¯42ï¼Œåˆ™å°†åˆ›å»ºä¸€ä¸ªæ–°çš„<code>Task&lt;int&gt;</code>å¯¹è±¡ï¼Œç±»ä¼¼äºè°ƒç”¨<code>Task.FromResult(42)</code> ã€‚ </p><br><p> è®¸å¤šåº“å®ç°éƒ½å°è¯•é€šè¿‡æ”¯æŒè‡ªå·±çš„ç¼“å­˜æ¥ç¼“è§£è¿™äº›æƒ…å†µã€‚ ä¸€ä¸ªç¤ºä¾‹æ˜¯<code>MemoryStream.ReadAsync</code>çš„é‡è½½ã€‚  .NET Framework 4.5ä¸­å¼•å…¥çš„æ­¤æ“ä½œå§‹ç»ˆåŒæ­¥ç»“æŸï¼Œå› ä¸º è¿™åªæ˜¯ä»å†…å­˜ä¸­è¯»å–ã€‚  <code>ReadAsync</code>è¿”å›ä¸€ä¸ª<code>Task&lt;int&gt;</code> ï¼Œå…¶ä¸­æ•´æ•°ç»“æœè¡¨ç¤ºè¯»å–çš„å­—èŠ‚æ•°ã€‚ åœ¨ä»£ç ä¸­ï¼Œç»å¸¸åœ¨å¾ªç¯ä¸­ä½¿ç”¨<code>ReadAsync</code>æ—¶å‘ç”Ÿè¿™ç§æƒ…å†µã€‚ æ­¤å¤–ï¼Œæ˜¯å¦å­˜åœ¨ä»¥ä¸‹ç—‡çŠ¶ï¼š </p><br><ul><li> åœ¨å¾ªç¯çš„å¤§å¤šæ•°è¿­ä»£ä¸­ï¼Œè¯·æ±‚çš„å­—èŠ‚æ•°ä¸ä¼šæ”¹å˜ã€‚ </li><li> åœ¨å¤§å¤šæ•°è¿­ä»£ä¸­ï¼Œ <code>ReadAsync</code>å¯ä»¥è¯»å–è¯·æ±‚çš„å­—èŠ‚æ•°ã€‚ </li></ul><br><p> ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºé‡å¤è°ƒç”¨ï¼Œ <code>ReadAsync</code>åŒæ­¥è¿è¡Œå¹¶è¿”å›<code>Task&lt;int&gt;</code>å¯¹è±¡ï¼Œ <code>ReadAsync</code>è¿­ä»£çš„ç»“æœç›¸åŒã€‚ ä»é€»è¾‘<code>MemoryStream</code> ï¼Œ <code>MemoryStream</code>ç¼“å­˜ä¸Šä¸€ä¸ªæˆåŠŸå®Œæˆçš„ä»»åŠ¡ï¼Œå¯¹äºæ‰€æœ‰åç»­è°ƒç”¨ï¼Œå¦‚æœæ–°ç»“æœä¸ä¸Šä¸€ä¸ªåŒ¹é…ï¼Œåˆ™ä»ç¼“å­˜ä¸­è¿”å›ä¸€ä¸ªå®ä¾‹ã€‚ å¦‚æœç»“æœä¸åŒ¹é…ï¼Œåˆ™ä½¿ç”¨<code>Task.FromResult</code>åˆ›å»ºä¸€ä¸ªæ–°å®ä¾‹ï¼Œè¯¥å®ä¾‹åˆå°†åœ¨è¿”å›ä¹‹å‰è¿›è¡Œç¼“å­˜ã€‚ </p><br><p> ä½†æ˜¯ï¼Œå°½ç®¡å¦‚æ­¤ï¼Œåœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œå³ä½¿åŒæ­¥å®Œæˆï¼Œä¹Ÿå¿…é¡»å¼ºåˆ¶æ“ä½œåˆ›å»ºæ–°çš„<code>Task&lt;TResult&gt;</code>å¯¹è±¡ã€‚ </p><br><h2 id="valuetasktresult-i-sinhronnoe-zavershenie">  ValueTask &lt;TResult&gt;å’ŒåŒæ­¥å®Œæˆ </h2><br><p> æœ€ç»ˆï¼Œæ‰€æœ‰è¿™äº›éƒ½æ˜¯å°†æ–°å‹<code>ValueTask&lt;TResult&gt;</code>å¼•å…¥.NET Core 2.0çš„åŠ¨æœºã€‚ åŒæ ·ï¼Œé€šè¿‡nugetåŒ…<code>System.Threading.Tasks.Extensions</code> ï¼Œå…¶ä»–.NETç‰ˆæœ¬ä¸­ä¹Ÿæä¾›äº†æ­¤ç±»å‹ã€‚ </p><br><p>  .NET Core 2.0ä¸­å¼•å…¥<code>ValueTask&lt;TResult&gt;</code>ä½œä¸ºèƒ½å¤ŸåŒ…è£…<code>TResult</code>æˆ–<code>Task&lt;TResult&gt;</code> ã€‚ è¿™æ„å‘³ç€å¯ä»¥ä»<code>async</code>æ–¹æ³•è¿”å›æ­¤ç±»å‹çš„å¯¹è±¡ã€‚ è¿™ç§ç±»å‹çš„å¼•å…¥çš„ç¬¬ä¸€ä¸ª<code>ValueTask&lt;TResult&gt;</code>æ˜¯ç«‹å³å¯è§çš„ï¼šå¦‚æœè¯¥æ–¹æ³•æˆåŠŸä¸”åŒæ­¥å®Œæˆï¼Œåˆ™æ— éœ€åœ¨å †ä¸Šåˆ›å»ºä»»ä½•å†…å®¹ï¼Œåªéœ€åˆ›å»ºä¸€ä¸ªå¸¦æœ‰ç»“æœå€¼çš„<code>ValueTask&lt;TResult&gt;</code>å®ä¾‹<code>ValueTask&lt;TResult&gt;</code> ã€‚ ä»…å½“æ–¹æ³•å¼‚æ­¥é€€å‡ºæ—¶ï¼Œæˆ‘ä»¬æ‰éœ€è¦åˆ›å»º<code>Task&lt;TResult&gt;</code> ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ <code>ValueTask&lt;TResult&gt;</code>ç”¨ä½œ<code>Task&lt;TResult&gt;</code>çš„åŒ…è£…ã€‚  <code>ValueTask&lt;TResult&gt;</code>ä¼˜åŒ–ç›®çš„ï¼Œå†³å®šä½¿<code>ValueTask&lt;TResult&gt;</code>èƒ½å¤Ÿèšåˆ<code>Task&lt;TResult&gt;</code> ï¼šåœ¨æˆåŠŸå’Œå¤±è´¥çš„æƒ…å†µä¸‹ï¼Œå¼‚æ­¥æ–¹æ³•åˆ›å»º<code>Task&lt;TResult&gt;</code> ï¼Œä»å†…å­˜ä¼˜åŒ–çš„è§’åº¦æ¥çœ‹ï¼Œæœ€å¥½èšåˆ<code>Task&lt;TResult&gt;</code>å¯¹è±¡æœ¬èº«<code>Task&lt;TResult&gt;</code> ï¼Œä»¥ä¾¿åœ¨<code>ValueTask&lt;TResult&gt;</code>ä¿ç•™å…¶ä»–å­—æ®µä»¥ç”¨äºå„ç§å®Œæˆæƒ…å†µï¼ˆä¾‹å¦‚ï¼Œå­˜å‚¨å¼‚å¸¸ï¼‰ã€‚ </p><br><p> é‰´äºä»¥ä¸Šæ‰€è¿°ï¼Œä¸å†éœ€è¦åœ¨è¯¸å¦‚ä¸Šè¿°<code>MemoryStream.ReadAsync</code>æ–¹æ³•ä¸­è¿›è¡Œç¼“å­˜ï¼Œè€Œæ˜¯å¯ä»¥æŒ‰ä»¥ä¸‹æ–¹å¼å®ç°ï¼š </p><br><pre> <code class="plaintext hljs">public override ValueTask&lt;int&gt; ReadAsync(byte[] buffer, int offset, int count) { try { int bytesRead = Read(buffer, offset, count); return new ValueTask&lt;int&gt;(bytesRead); } catch (Exception e) { return new ValueTask&lt;int&gt;(Task.FromException&lt;int&gt;(e)); } }</code> </pre> <br><h2 id="valuetasklttresultgt-i-asinhronnoe-zavershenie">  ValueTask &lt;TResult&gt;å’Œå¼‚æ­¥ç»ˆæ­¢ </h2><br><p> èƒ½å¤Ÿç¼–å†™ä¸éœ€è¦ä¸ºç»“æœåˆ†é…é¢å¤–å†…å­˜çš„å¼‚æ­¥æ–¹æ³•ï¼Œå¹¶å…·æœ‰åŒæ­¥å®ŒæˆåŠŸèƒ½ï¼Œè¿™ç¡®å®æ˜¯ä¸€å¤§ä¼˜åŠ¿ã€‚ å¦‚ä¸Šæ‰€è¿°ï¼Œè¿™æ˜¯åœ¨.NET Core 2.0ä¸­å¼•å…¥æ–°çš„<code>ValueTask&lt;TResult&gt;</code>çš„ä¸»è¦ç›®æ ‡ã€‚ ç°åœ¨ï¼Œé¢„æœŸå°†åœ¨â€œçƒ­é“è·¯â€ä¸Šä½¿ç”¨çš„æ‰€æœ‰æ–°æ–¹æ³•éƒ½å°†ä½¿ç”¨<code>ValueTask&lt;TResult&gt;</code>è€Œä¸æ˜¯<code>Task&lt;TResult&gt;</code>ä½œä¸ºè¿”å›ç±»å‹ã€‚ ä¾‹å¦‚ï¼Œ.NET Core 2.1ï¼ˆä½¿ç”¨<code>Memory&lt;byte&gt;</code>è€Œä¸æ˜¯<code>byte[]</code>ä½œä¸ºå‚æ•°ï¼‰ä¸­<code>Stream</code>çš„<code>ReadAsync</code>æ–¹æ³•çš„æ–°é‡è½½è¿”å›<code>ValueTask&lt;int&gt;</code>çš„å®ä¾‹ã€‚ è¿™æ ·å¯ä»¥å¤§å¤§å‡å°‘ä½¿ç”¨æµæ—¶çš„åˆ†é…æ•°é‡ï¼ˆé€šå¸¸ï¼Œ <code>ReadAsync</code>æ–¹æ³•æ˜¯åŒæ­¥å®Œæˆçš„ï¼Œä¾‹å¦‚<code>MemoryStream</code>çš„ç¤ºä¾‹ï¼‰ã€‚ </p><br><p> ä½†æ˜¯ï¼Œå½“å¼€å‘å…·æœ‰é«˜å¸¦å®½çš„æœåŠ¡æ—¶ï¼Œå¼‚æ­¥ç»ˆæ­¢å¹¶ä¸å°‘è§ï¼Œæˆ‘ä»¬éœ€è¦å°½åŠ›é¿å…é¢å¤–çš„åˆ†é…ã€‚ </p><br><p> å¦‚å‰æ‰€è¿°ï¼Œåœ¨<code>async/await</code>æ¨¡å‹ä¸­ï¼Œä»»ä½•å¼‚æ­¥å®Œæˆçš„æ“ä½œéƒ½å¿…é¡»è¿”å›å”¯ä¸€çš„å¯¹è±¡æ‰èƒ½ç­‰å¾…å®Œæˆã€‚ ç‹¬ç‰¹æ˜¯å› ä¸º å®ƒå°†ç”¨ä½œæ‰§è¡Œå›è°ƒçš„æ¸ é“ã€‚ ä½†æ˜¯è¯·æ³¨æ„ï¼Œæ­¤æ„é€ å¹¶æœªè¯´æ˜åœ¨å¼‚æ­¥æ“ä½œå®Œæˆä¹‹åæ˜¯å¦å¯ä»¥<em>é‡ç”¨</em>è¿”å›çš„ç­‰å¾…å¯¹è±¡ã€‚ å¦‚æœå¯ä»¥é‡ç”¨å¯¹è±¡ï¼Œåˆ™APIå¯ä»¥ä¸ºè¿™äº›ç±»å‹çš„å¯¹è±¡ç»´æŠ¤ä¸€ä¸ªæ± ã€‚ ä½†æ˜¯ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ­¤æ± æ— æ³•æ”¯æŒå¹¶å‘è®¿é—®-æ± ä¸­çš„å¯¹è±¡å°†ä»â€œå·²å®Œæˆâ€çŠ¶æ€å˜ä¸ºâ€œæœªå®Œæˆâ€çŠ¶æ€ï¼Œåä¹‹äº¦ç„¶ã€‚ </p><br><p> ä¸ºäº†æ”¯æŒä½¿ç”¨æ­¤ç±»æ± çš„å¯èƒ½æ€§ï¼Œåœ¨.NET Core 2.1ä¸­æ·»åŠ äº†<code>IValueTaskSource&lt;TResult&gt;</code>æ¥å£ï¼Œå¹¶æ‰©å±•äº†<code>ValueTask&lt;TResult&gt;</code>ç»“æ„ï¼šç°åœ¨ï¼Œè¿™ç§ç±»å‹çš„å¯¹è±¡ä¸ä»…å¯ä»¥åŒ…è£…<code>TResult</code>æˆ–<code>Task&lt;TResult&gt;</code>å¯¹è±¡ï¼Œè¿˜å¯ä»¥åŒ…è£…<code>IValueTaskSource&lt;TResult&gt;</code>å®ä¾‹ã€‚ æ–°æ¥å£æä¾›äº†åŸºæœ¬åŠŸèƒ½ï¼Œå…è®¸<code>ValueTask&lt;TResult&gt;</code>å¯¹è±¡ä»¥ä¸<code>IValueTaskSource&lt;TResult&gt;</code>ç›¸åŒçš„æ–¹å¼ä¸<code>IValueTaskSource&lt;TResult&gt;</code>ä¸€èµ·<code>Task&lt;TResult&gt;</code> ï¼š </p><br><pre> <code class="plaintext hljs">public interface IValueTaskSource&lt;out TResult&gt; { ValueTaskSourceStatus GetStatus(short token); void OnCompleted( Action&lt;object&gt; continuation, object state, short token, ValueTaskSourceOnCompletedFlags flags); TResult GetResult(short token); }</code> </pre> <br><p>  <code>GetStatus</code>æ—¨åœ¨åœ¨<code>ValueTask&lt;TResult&gt;.IsCompleted/IsCompletedSuccessfully</code> -å…è®¸æ‚¨ç¡®å®šæ“ä½œæ˜¯å¦å·²å®Œæˆï¼ˆæˆåŠŸï¼‰ã€‚ åœ¨<code>ValueTask&lt;TResult&gt;</code>ä½¿ç”¨<code>ValueTask&lt;TResult&gt;</code>è§¦å‘å›è°ƒã€‚  <code>GetResult</code>ç”¨äºè·å–ç»“æœæˆ–å¼•å‘å¼‚å¸¸ã€‚ </p><br><p> å¤§å¤šæ•°å¼€å‘äººå‘˜ä¸å¤ªå¯èƒ½éœ€è¦å¤„ç†<code>IValueTaskSource&lt;TResult&gt;</code>æ¥å£ï¼Œå› ä¸º å¼‚æ­¥æ–¹æ³•è¿”å›æ—¶ï¼Œå°†å…¶éšè—åœ¨<code>ValueTask&lt;TResult&gt;</code>å®ä¾‹åé¢ã€‚ æ¥å£æœ¬èº«ä¸»è¦æ˜¯ä¸ºé‚£äº›å¼€å‘é«˜æ€§èƒ½APIçš„äººè®¾è®¡çš„ï¼Œæ—¨åœ¨é¿å…ä¸å¿…è¦çš„å·¥ä½œã€‚ </p><br><p> åœ¨.NET Core 2.1ä¸­ï¼Œæœ‰å‡ ç§æ­¤ç±»APIçš„ç¤ºä¾‹ã€‚ å…¶ä¸­æœ€è‘—åçš„æ˜¯<code>Socket.ReceiveAsync</code>å’Œ<code>Socket.SendAsync</code>æ–¹æ³•çš„æ–°é‡è½½ã€‚ ä¾‹å¦‚ï¼š </p><br><pre> <code class="plaintext hljs">public ValueTask&lt;int&gt; ReceiveAsync( Memory&lt;byte&gt; buffer, SocketFlags socketFlags, CancellationToken cancellationToken = default);</code> </pre> <br><p>  <code>ValueTask&lt;int&gt;</code>ç±»å‹çš„å¯¹è±¡ç”¨ä½œè¿”å›å€¼ã€‚ <br> å¦‚æœè¯¥æ–¹æ³•åŒæ­¥é€€å‡ºï¼Œåˆ™å®ƒå°†è¿”å›å¸¦æœ‰ç›¸åº”å€¼çš„<code>ValueTask&lt;int&gt;</code> ï¼š </p><br><pre> <code class="plaintext hljs">int result = â€¦; return new ValueTask&lt;int&gt;(result);</code> </pre> <br><p> å¦‚æœæ“ä½œå¼‚æ­¥å®Œæˆï¼Œåˆ™ä½¿ç”¨ä¸€ä¸ªç¼“å­˜å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å®ç°<code>IValueTaskSource&lt;TResult&gt;</code>æ¥å£ï¼š </p><br><pre> <code class="plaintext hljs">IValueTaskSource&lt;int&gt; vts = â€¦; return new ValueTask&lt;int&gt;(vts);</code> </pre> <br><p>  <code>Socket</code>å®ç°æ”¯æŒä¸€ä¸ªç¼“å­˜çš„å¯¹è±¡ç”¨äºæ¥æ”¶ï¼Œè€Œä¸€ä¸ªç¼“å­˜çš„å¯¹è±¡ç”¨äºå‘é€æ•°æ®ï¼Œåªè¦æ¯ä¸ªå¯¹è±¡åœ¨æ²¡æœ‰ç«äº‰çš„æƒ…å†µä¸‹ä½¿ç”¨ï¼ˆä¾‹å¦‚ï¼Œæ²¡æœ‰ç«äº‰æ€§çš„æ•°æ®å‘é€ï¼‰ã€‚ å³ä½¿åœ¨å¼‚æ­¥æ‰§è¡Œçš„æƒ…å†µä¸‹ï¼Œè¯¥ç­–ç•¥ä¹Ÿä¼šå‡å°‘åˆ†é…çš„é¢å¤–å†…å­˜é‡ã€‚ <br> æè¿°çš„.NET Core 2.1ä¸­çš„<code>Socket</code>ä¼˜åŒ–å¯¹<code>NetworkStream</code>çš„æ€§èƒ½äº§ç”Ÿäº†ç§¯æå½±å“ã€‚ å®ƒçš„é‡è½½æ˜¯<code>Stream</code>ç±»çš„<code>ReadAsync</code>æ–¹æ³•ï¼š </p><br><pre> <code class="plaintext hljs">public virtual ValueTask&lt;int&gt; ReadAsync( Memory&lt;byte&gt; buffer, CancellationToken cancellationToken);</code> </pre> <br><p> åªæ˜¯å°†å·¥ä½œå§”æ‰˜ç»™<code>Socket.ReceiveAsync</code>æ–¹æ³•ã€‚ å°±ä½¿ç”¨å†…å­˜è€Œè¨€ï¼Œæé«˜å¥—æ¥å­—æ–¹æ³•çš„æ•ˆç‡å¯ä»¥æé«˜<code>NetworkStream</code>æ–¹æ³•çš„æ•ˆç‡ã€‚ </p><br><h2 id="non-generic-valuetask"> éé€šç”¨ValueTask </h2><br><p> æ—©äº›æ—¶å€™ï¼Œæˆ‘å¤šæ¬¡æåˆ°.NET Core 2.0ä¸­<code>ValueTask&lt;T&gt;</code>çš„æœ€åˆç›®æ ‡æ˜¯ä¼˜åŒ–å…·æœ‰â€œéç©ºâ€ç»“æœçš„æ–¹æ³•çš„åŒæ­¥å®Œæˆæƒ…å†µã€‚ è¿™æ„å‘³ç€ä¸éœ€è¦éç±»å‹çš„<code>ValueTask</code> ï¼šåœ¨åŒæ­¥å®Œæˆçš„æƒ…å†µä¸‹ï¼Œæ–¹æ³•é€šè¿‡<code>Task.CompletedTask</code>å±æ€§ä½¿ç”¨å•ä¾‹ï¼Œå¹¶ä¸”è¿˜éšå¼æ¥æ”¶<code>async Task</code>æ–¹æ³•çš„è¿è¡Œæ—¶ã€‚ </p><br><p> ä½†æ˜¯ï¼Œéšç€é¿å…ä¸å¿…è¦åˆ†é…çš„èƒ½åŠ›çš„å‡ºç°ä»¥åŠå¼‚æ­¥æ‰§è¡Œçš„å‡ºç°ï¼Œå¯¹éç±»å‹åŒ–<code>ValueTask</code>å†æ¬¡å˜å¾—é‡è¦èµ·æ¥ã€‚ å› æ­¤ï¼Œåœ¨.NET Core 2.1ä¸­ï¼Œæˆ‘ä»¬å¼•å…¥äº†<code>ValueTask</code>å’Œ<code>IValueTaskSource</code> ã€‚ å®ƒä»¬æ˜¯å¯¹åº”æ³›å‹ç±»å‹çš„ç±»ä¼¼ç‰©ï¼Œå¹¶ä¸”ä»¥ç›¸åŒçš„æ–¹å¼ä½¿ç”¨ï¼Œä½†æ˜¯ç”¨äºè¿”å›ç©ºï¼ˆ <code>void</code> ï¼‰çš„æ–¹æ³•ã€‚ </p><br><h2 id="realizaciya-ivaluetasksource--ivaluetasksourcelttgt"> å®æ–½IValueTaskSource / IValueTaskSource &lt;T&gt; </h2><br><p> å¤§å¤šæ•°å¼€å‘äººå‘˜å°†ä¸éœ€è¦å®ç°è¿™äº›æ¥å£ã€‚ è€Œä¸”è¦å®ç°å®ƒä»¬å¹¶éæ˜“äº‹ã€‚ å¦‚æœæ‚¨å†³å®šéœ€è¦è‡ªå·±å®ç°å®ƒä»¬ï¼Œé‚£ä¹ˆåœ¨.NET Core 2.1å†…ï¼Œå¯ä»¥ä½œä¸ºç¤ºä¾‹çš„å‡ ç§å®ç°ï¼š </p><br><ul><li>  <a href="">AwaitableSocketAsyncEventArgs</a> </li><li>  <a href="">AsyncOperation &lt;TResult&gt;</a> </li><li>  <a href="">DefaultPipeReader</a> </li></ul><br><p> ä¸ºäº†ç®€åŒ–è¿™äº›ä»»åŠ¡ï¼ˆ <code>IValueTaskSource / IValueTaskSource&lt;T&gt;</code> ï¼‰ï¼Œæˆ‘ä»¬è®¡åˆ’åœ¨.NET Core 3.0ä¸­å¼•å…¥ç±»å‹<code>ManualResetValueTaskSourceCore&lt;TResult&gt;</code> ã€‚ è¿™ç§ç»“æ„å°†å°è£…æ‰€æœ‰å¿…è¦çš„é€»è¾‘ã€‚  <code>ManualResetValueTaskSourceCore&lt;TResult&gt;</code>å®ä¾‹å¯ä»¥åœ¨å®ç°<code>IValueTaskSource&lt;TResult&gt;</code>å’Œ/æˆ–<code>IValueTaskSource</code>å¦ä¸€ä¸ªå¯¹è±¡ä¸­ä½¿ç”¨ï¼Œå¹¶å°†å¤§éƒ¨åˆ†å·¥ä½œå§”æ‰˜ç»™å®ƒã€‚ æ‚¨å¯ä»¥åœ¨ttpsä¸Šäº†è§£æœ‰å…³æ­¤çš„æ›´å¤šä¿¡æ¯ï¼š//github.com/dotnet/corefx/issues/32664ã€‚ </p><br><h2 id="pravilnaya-model-ispolzovaniya-valuetasks"> ä½¿ç”¨ValueTasksçš„æ­£ç¡®æ¨¡å‹ </h2><br><p> ç”šè‡³ç²—ç•¥åœ°æ£€æŸ¥ä¹Ÿ<code>ValueTask</code>å’Œ<code>ValueTask&lt;TResult&gt;</code>æ¯”<code>Task</code>å’Œ<code>Task&lt;TResult&gt;</code> <code>ValueTask&lt;TResult&gt;</code>æ›´å¤šçš„é™åˆ¶ã€‚ è¿™æ˜¯æ­£å¸¸çš„ï¼Œç”šè‡³æ˜¯å¯å–çš„ï¼Œå› ä¸ºå®ƒä»¬çš„ä¸»è¦ç›®æ ‡æ˜¯ç­‰å¾…å¼‚æ­¥æ‰§è¡Œå®Œæˆã€‚ </p><br><p> å°¤å…¶æ˜¯ï¼Œç”±äº<code>ValueTask</code>å’Œ<code>ValueTask&lt;TResult&gt;</code>å¯ä»¥èšåˆå¯é‡ç”¨å¯¹è±¡çš„äº‹å®è€Œäº§ç”Ÿäº†æ˜æ˜¾çš„é™åˆ¶ã€‚ é€šå¸¸ï¼Œ <em>åœ¨ä½¿ç”¨</em> <code>ValueTask</code> / <code>ValueTask&lt;TResult&gt;</code> * <em>æ—¶ï¼Œç»ä¸è¦æ‰§è¡Œ</em>ä»¥ä¸‹æ“ä½œ* <em>ï¼ˆ</em>è®©æˆ‘é€šè¿‡â€œ Neverâ€ *é‡æ–°åˆ¶å®šï¼‰ï¼š </p><br><ul><li>  <strong>åˆ‡å‹¿é‡å¤ä½¿ç”¨åŒä¸€<code>ValueTask</code> / <code>ValueTask&lt;TResult&gt;</code>å¯¹è±¡</strong> </li></ul><br><p>  <em>åŠ¨æœºï¼š</em> <code>Task</code>å’Œ<code>Task&lt;TResult&gt;</code>å®ä¾‹æ°¸è¿œä¸ä¼šä»â€œå·²å®Œæˆâ€çŠ¶æ€å˜ä¸ºâ€œæœªå®Œæˆâ€çŠ¶æ€ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦å¤šæ¬¡ä½¿ç”¨å®ƒä»¬ç­‰å¾…ç»“æœ-å®Œæˆåï¼Œæˆ‘ä»¬å°†å§‹ç»ˆè·å¾—ç›¸åŒçš„ç»“æœã€‚ ç›¸åï¼Œç”±äº<code>ValueTask</code> / <code>ValueTask&lt;TResult&gt;</code> ï¼Œå®ƒä»¬å¯ä»¥å……å½“é‡ç”¨å¯¹è±¡çš„åŒ…è£…å™¨ï¼Œè¿™æ„å‘³ç€å®ƒä»¬çš„çŠ¶æ€å¯ä»¥æ›´æ”¹ï¼Œå› ä¸º é‡ç”¨å¯¹è±¡çš„çŠ¶æ€æ ¹æ®å®šä¹‰å‘ç”Ÿäº†å˜åŒ–-ä»â€œå®Œæˆâ€å˜ä¸ºâ€œæœªå®Œæˆâ€ï¼Œåä¹‹äº¦ç„¶ã€‚ </p><br><ul><li>  <strong>&lt;ä»ä¸<code>ValueTask</code> / <code>ValueTask&amp;lt;TResult&amp;gt;</code></strong>  <strong>åœ¨ç«äº‰æ¨¡å¼ä¸‹ã€‚</strong> </li></ul><br><p>  <em>åŠ¨æœºï¼šä¸€ä¸ª</em>åŒ…è£…çš„å¯¹è±¡å¸Œæœ›ä¸€æ¬¡åªèƒ½ä»ä¸€ä¸ªä½¿ç”¨è€…ä½¿ç”¨ä¸€ä¸ªå›è°ƒï¼Œå¹¶ä¸”è¯•å›¾ç«äº‰ç«äº‰å¾ˆå®¹æ˜“å¯¼è‡´ç«äº‰çŠ¶å†µå’Œç»†å¾®çš„ç¼–ç¨‹é”™è¯¯ã€‚ ç«äº‰æœŸæœ›ï¼Œè¿™æ˜¯ä¸Šè¿°<strong>å¤šé‡æœŸæœ›ä¸­</strong>æè¿°çš„é€‰é¡¹ä¹‹ä¸€ã€‚ è¯·æ³¨æ„ï¼Œ <code>Task</code> / <code>Task&lt;TResult&gt;</code>å…è®¸ä»»ä½•æ•°é‡çš„ç«äº‰æœŸæœ›ã€‚ </p><br><ul><li>  <strong>åœ¨æ“ä½œå®Œæˆä¹‹å‰ï¼Œåˆ‡å‹¿ä½¿ç”¨<code>.GetAwaiter().GetResult()</code></strong> ã€‚ </li></ul><br><p>  <em>åŠ¨æœºï¼š</em>åœ¨æ“ä½œå®Œæˆä¹‹å‰ï¼Œ <code>IValueTaskSource</code> / <code>IValueTaskSource&lt;TResult&gt;</code>ä¸åº”æ”¯æŒé”å®šã€‚ å®é™…ä¸Šï¼Œé˜»å¡ä¼šå¯¼è‡´ç«äº‰çŠ¶å†µï¼Œè¿™ä¸å¤ªå¯èƒ½æ˜¯æ¶ˆè´¹è€…æ–¹é¢çš„é¢„æœŸè¡Œä¸ºã€‚ ä½¿ç”¨<code>Task</code> / <code>Task&lt;TResult&gt;</code>å¯ä»¥æ‰§è¡Œæ­¤æ“ä½œï¼Œä»è€Œé˜»å¡è°ƒç”¨çº¿ç¨‹ï¼Œç›´åˆ°æ“ä½œå®Œæˆã€‚ </p><br><p> ä½†æ˜¯ï¼Œå¦‚æœæ‚¨ä»ç„¶éœ€è¦æ‰§è¡Œä¸Šè¿°æ“ä½œä¹‹ä¸€ï¼Œå¹¶ä¸”è¢«è°ƒç”¨çš„æ–¹æ³•è¿”å›<code>ValueTask</code> / <code>ValueTask&lt;TResult&gt;</code>å®ä¾‹ï¼Œ <code>ValueTask</code>æ€ä¹ˆåŠï¼Ÿ å¯¹äºè¿™ç§æƒ…å†µï¼Œ <code>ValueTask</code> / <code>ValueTask&lt;TResult&gt;</code>æä¾›äº†<code>.AsTask()</code>æ–¹æ³•ã€‚ é€šè¿‡è°ƒç”¨æ­¤æ–¹æ³•ï¼Œæ‚¨å°†è·å¾—<code>Task</code> / <code>Task&lt;TResult&gt;</code>çš„å®ä¾‹ï¼Œå¹¶ä¸”æ‚¨å·²ç»å¯ä»¥å¯¹å…¶æ‰§è¡Œå¿…è¦çš„æ“ä½œã€‚  <em>ä¸å…è®¸</em>åœ¨è°ƒç”¨<code>.AsTask()</code>ä¹‹åé‡ç”¨åŸå§‹å¯¹è±¡ã€‚ </p><br><p> <strong>  </strong> : <em>    <code>ValueTask</code> / <code>ValueTask&lt;TResult&gt;</code>  ,   ( <code>await</code> )   (,    <code>.ConfigureAwait(false)</code> ),   <code>.AsTask()</code> ,        <code>ValueTask</code> / <code>ValueTask&lt;TResult&gt;</code> .</em> </p><br><pre> <code class="plaintext hljs">// Given this ValueTask&lt;int&gt;-returning methodâ€¦ public ValueTask&lt;int&gt; SomeValueTaskReturningMethodAsync(); â€¦ // GOOD int result = await SomeValueTaskReturningMethodAsync(); // GOOD int result = await SomeValueTaskReturningMethodAsync().ConfigureAwait(false); // GOOD Task&lt;int&gt; t = SomeValueTaskReturningMethodAsync().AsTask(); // WARNING ValueTask&lt;int&gt; vt = SomeValueTaskReturningMethodAsync(); ... // storing the instance into a local makes it much more likely it'll be misused, // but it could still be ok // BAD: awaits multiple times ValueTask&lt;int&gt; vt = SomeValueTaskReturningMethodAsync(); int result = await vt; int result2 = await vt; // BAD: awaits concurrently (and, by definition then, multiple times) ValueTask&lt;int&gt; vt = SomeValueTaskReturningMethodAsync(); Task.Run(async () =&gt; await vt); Task.Run(async () =&gt; await vt); // BAD: uses GetAwaiter().GetResult() when it's not known to be done ValueTask&lt;int&gt; vt = SomeValueTaskReturningMethodAsync(); int result = vt.GetAwaiter().GetResult();</code> </pre> <br><p>    , "",  ,       (    ,      ). </p><br><p>   <code>ValueTask</code> / <code>ValueTask&lt;TResult&gt;</code>  ,       .  ,  <code>IsCompleted</code>  <code>true</code> ,    (   ,  ),    â€” <code>false</code> ,  <code>IsCompletedSuccessfully</code>  <code>true</code>     .   " " ,   , ,    ,    ,    .            <code>await</code> / <code>.AsTask()</code>     <code>.Result</code> .  ,   <code>SocketsHttpHandler</code>  .NET Core 2.1,     <code>.ReadAsync</code> ,   <code>ValueTask&lt;int&gt;</code> .    ,       , ,  .      ,         ..   . å› ä¸º    ,     , ,  ,    : </p><br><pre> <code class="plaintext hljs">int bytesRead; { ValueTask&lt;int&gt; readTask = _connection.ReadAsync(buffer); if (readTask.IsCompletedSuccessfully) { bytesRead = readTask.Result; } else { using (_connection.RegisterCancellation()) { bytesRead = await readTask; } } }</code> </pre> <br><p>    , .. <code>ValueTask&lt;int&gt;</code> ,     <code>.Result</code> ,    <code>await</code> ,     . </p><br><h2 id="dolzhny-li-vse-novye-asinhronnye-api-vozvraschat-valuetask--valuetasklttresultgt">      API  ValueTask / ValueTask&lt;TResult&gt;? </h2><br><p>  ,  .      <code>Task</code> / <code>ValueTask&lt;TResult&gt;</code> . </p><br><p>    ,   <code>Task</code> / <code>Task&lt;TResult&gt;</code>     .   ,       ""  / ,    <code>Task</code> / <code>Task&lt;TResult&gt;</code> . ,  ,      <code>ValueTask&lt;TResult&gt;</code>  <code>Task&lt;TResult&gt;</code> : ,   ,  <code>await</code>     <code>Task&lt;TResult&gt;</code>   <code>ValueTask&lt;TResult&gt;</code> .  ,       (,  API  <code>Task</code>  <code>Task&lt;bool&gt;</code> ), ,    ,   <code>Task</code> ( <code>Task&lt;bool&gt;</code> ).  , <code>ValueTask</code> / <code>ValueTask&lt;TResult&gt;</code>    .  ,    async-,              <code>ValueTask</code> / <code>ValueTask&lt;TResult&gt;</code> ,       . </p><br><p>     , <code>ValueTask</code> / <code>ValueTask&lt;TResult&gt;</code>   , : </p><br><ol><li>  ,    API    , </li><li>  API        ,  </li><li>   ,      ,         ,    . </li></ol><br><p>  ,     <code>abstract</code> / <code>virtual</code>  ,    ,           /  ? </p><br><h2 id="chto-dalshe"> æ¥ä¸‹æ¥æ˜¯ä»€ä¹ˆï¼Ÿ </h2><br><p>    .NET,     API,  <code>Task</code> / <code>Task&lt;TResult&gt;</code> . ,  ,     API c <code>ValueTask</code> / <code>ValueTask&lt;TResult&gt;</code> ,     .         <code>IAsyncEnumerator&lt;T&gt;</code> ,      .NET Core 3.0.  <code>IEnumerator&lt;T&gt;</code>   <code>MoveNext</code> ,    .   â€” <code>IAsyncEnumerator&lt;T&gt;</code>   <code>MoveNextAsync</code> .      ,        <code>Task&lt;bool&gt;</code> ,        ,    .  ,       ,       ,      (        ),   ,   ,         <code>await foreach</code> -,  ,      <code>MoveNextAsync</code> ,  <code>ValueTask&lt;bool&gt;</code> .         , ,   ,     " " ,         . ,  C#      ,           . </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/97f/1d3/cf0/97f1d3cf0e2a6bf007066eb60a789c31.png"></a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN465259/">https://habr.com/ru/post/zh-CN465259/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN465247/index.html">è§’åº¦çš„ äº†è§£@ Inputï¼Œ@ Outputå’ŒEventEmitter</a></li>
<li><a href="../zh-CN465249/index.html">ç†æŸ¥å¾·Â·æ–¯æ‰˜æ›¼ï¼ˆRichard Stallmanï¼‰åœ¨è«æ–¯ç§‘å·¥ä¸šå¤§å­¦çš„æ¼”è®²ã€‚ 2019å¹´å…«æœˆ</a></li>
<li><a href="../zh-CN465251/index.html">å¤å¤©å¿«ç»“æŸäº†ã€‚ å‡ ä¹æ²¡æœ‰æ•°æ®æ³„æ¼</a></li>
<li><a href="../zh-CN465255/index.html">ä½¿ç”¨HttpClientFactoryçš„.Net Core WCFè¿æ¥æ± å®ç°</a></li>
<li><a href="../zh-CN465257/index.html">â€œå½“å¿ƒï¼ŒFASï¼â€ï¼šéº¦å½“åŠ³çš„è¯¡è®¡ï¼Œç¥åœ£çš„æ²™å¨ç›ï¼Œè™šå‡çš„å…‹é²å°¼å’Œä¸€äº›è¡—å¤´é­”æœ¯</a></li>
<li><a href="../zh-CN465261/index.html">å®çš„é­”åŠ›ï¼Œæˆ–å¦‚ä½•ä½¿AVRæ±‡ç¼–ç¨‹åºç¨‹åºå‘˜çš„å·¥ä½œæ›´è½»æ¾</a></li>
<li><a href="../zh-CN465263/index.html">åœ¨PostgreSQLä¸­é”å®šï¼š3.é”å®šå…¶ä»–å¯¹è±¡</a></li>
<li><a href="../zh-CN465267/index.html">æ‰“å­—ç¨¿ è¡¨è¾¾é­”æœ¯</a></li>
<li><a href="../zh-CN465269/index.html">åŸ¹è®­Cisco 200-125 CCNA v3.0ã€‚ ç¬¬26å¤©ã€‚DNSå’ŒDHCP</a></li>
<li><a href="../zh-CN465271/index.html">é»‘å®¢é€šè¿‡é€é¤å’Œé…’åº—é¢„è®¢æœåŠ¡æ¥çªƒå–å’Œæ´—é’±ã€‚</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>