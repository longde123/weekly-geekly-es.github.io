<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐮 👲🏼 🚟 Pengantar Lapisan 3 Firewall MikroTik 🔜 🛁 👨🏻‍🎓</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Firewall (atau filter paket) adalah topik besar dan kompleks baik secara teoritis maupun praktis. Paket filter dalam berbagai sistem operasi dapat mem...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pengantar Lapisan 3 Firewall MikroTik</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435070/"><p>  Firewall (atau filter paket) adalah topik besar dan kompleks baik secara teoritis maupun praktis.  Paket filter dalam berbagai sistem operasi dapat memiliki pro dan kontra dibandingkan dengan implementasi lainnya.  Pada artikel ini, saya secara eksklusif akan mempertimbangkan Firewall di RouterOS dengan memperhatikan iptables nenek moyangnya. </p><a name="habracut"></a><br><h3 id="predislovie">  Kata Pengantar </h3><br><h4 id="dlya-kogo-eta-statya">  Untuk siapa artikel ini? </h4><br><p>  Jika Anda tahu cara bekerja dengan iptables, maka lanjutkan dan konfigurasikan firewall, tidak akan ada yang baru untuk Anda dalam artikel ini (well, kecuali bahwa rantai dengan nama lain digunakan dalam tabel NAT).  Jika ini pertama kalinya Anda melihat firewall di RouterOS dan ingin mendapatkan skrip siap pakai untuk konfigurasi, maka Anda tidak akan menemukannya di sini.  Materi ini ditujukan untuk mereka yang ingin mendapatkan ide <strong>dasar</strong> tentang bagaimana firewall bekerja dan apa yang terjadi dengan paket ip pada berbagai tahap pemrosesan.  Pemahaman yang lebih dalam akan datang dengan pengalaman dan pemecahan masalah sehari-hari dan tidak biasa menggunakan filter paket. </p><br><h3 id="teoreticheskaya-chast">  Bagian teoretis </h3><br><h4 id="chto-takoe-layer3-firewall">  Apa itu Layer3 Firewall? </h4><br><p><img src="https://habrastorage.org/webt/ai/xt/od/aixtod5yvn-bvirxxdvwmnm2m30.png"></p><br><p>  Misalkan Anda memiliki router dengan akses Internet dan dua antarmuka jembatan: bridge-lan (ether2-ether5) dan bridge-dmz (ether6-ether10). </p><br><p>  Di dalam antarmuka Bridge, perangkat secara independen menemukan tetangga dari subnet dan paket pertukaran mereka, router bertindak sebagai saklar dan tidak memantau lalu lintas seperti itu di tingkat jaringan (tentu saja, Anda dapat memaksanya untuk melakukan ini, tetapi kita akan membicarakan tentang Layer2 Firewall di lain waktu). </p><br><p>  Jika perlu, hubungi perangkat yang terhubung ke antarmuka jembatan lain atau terletak di jaringan global, perangkat mengirimkan paket ke router, yang menentukan rute dan memprosesnya di tingkat jaringan (Layer 3). </p><br><h4 id="packet-flow-diagram">  Diagram Alur Paket </h4><br><p>  Jalur lalu lintas lengkap dijelaskan dalam Diagram Alur Paket, ada beberapa versi resmi (v5, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">v6</a> ), mereka perlu diketahui dan digunakan dalam pekerjaan sehari-hari, tetapi untuk memahami operasi filter paket, mereka kelebihan beban, jadi saya akan menjelaskan dalam versi ringan. </p><br><p><img src="https://habrastorage.org/webt/cb/fr/uu/cbfruui7ydb8lqm19myzozfotbo.png"></p><br><p>  Input / Output Interface adalah antarmuka router Layer 3 (fisik atau virtual) apa saja.  Paket yang pergi dari jaringan lokal ke Internet sampai ke antarmuka input, dan meninggalkan antarmuka output.  Paket dari Internet ke jaringan lokal juga sampai ke antarmuka input, dan meninggalkan antarmuka output.  Packet Flow selalu dibaca dalam input satu arah -&gt; output. </p><br><h4 id="osobennosti-terminologii">  Fitur terminologi </h4><br><p>  Mempelajari aliran paket untuk iptables, Anda dapat menemukan deskripsi melalui "rantai dalam tabel" atau "tabel dalam rantai".  Diagram menunjukkan tabel dalam rantai, saat menambahkan aturan ke firewall, semuanya akan menjadi sebaliknya. </p><br><p>  Namun pada kenyataannya, paket bergerak di antara blok [rantai + tabel], misalnya, jika Anda melakukan terima di blok [prerouting + mangle], paket transit masih akan diproses dalam [forward + mangle].  Ini penting untuk diingat dalam konfigurasi kompleks dengan pbr dan antrian. </p><br><p>  Dokumentasi iptables memiliki definisi yang lebih tepat, tetapi dengan kata-kata sederhana: <br>  <strong>Chains</strong> bertanggung jawab atas di mana paket diproses dan urutan aturan. <br>  <strong>Tabel</strong> menentukan tindakan yang dapat dilakukan pada suatu paket. </p><br><h4 id="bazovye-varianty-sledovaniya-paketa">  Paket Dasar Mengikuti Opsi </h4><br><p><img src="https://habrastorage.org/webt/1d/tm/6j/1dtm6j1wiiolczrm215gcz_imss.png"></p><br><p>  <strong>Transit</strong> </p><br><p><img src="https://habrastorage.org/webt/rj/9z/_w/rj9z_w8s9pc4valiwixtkrwpdke.png"></p><br><ol><li>  Paket dari jaringan datang ke salah satu antarmuka router </li><li>  Dalam rantai PREROUTING, administrator dapat memengaruhi rute paket: menentukan antarmuka keluaran (perutean basis kebijakan) atau mengalihkan ke alamat lain (dst-nat). </li><li>  Sesuai dengan tabel routing untuk paket, antarmuka keluar ditentukan. </li><li>  Rantai FORWARD adalah tempat penyaringan utama untuk lalu lintas yang lewat. </li><li>  Item terakhir sebelum memasuki jaringan adalah rantai POSTROUTING, di mana Anda dapat mengubah alamat pengirim (src-nat). </li><li>  Paket itu online. </li></ol><br><p>  <strong>Masuk</strong> </p><br><p><img src="https://habrastorage.org/webt/qn/l8/gd/qnl8gdad6vpxhgdjnhvhpzngcau.png"></p><br><ol><li>  Paket dari jaringan datang ke salah satu antarmuka router </li><li>  Tekan rantai PREROUTING. </li><li>  Menurut tabel routing, paket itu dikirim untuk diproses ke proses lokal. </li><li>  Rantai INPUT menyaring lalu lintas masuk oleh administrator. </li><li>  Paket diproses oleh proses lokal. </li></ol><br><p>  <strong>Keluar</strong> </p><br><p><img src="https://habrastorage.org/webt/jh/qr/sd/jhqrsd8rq3lt8x1s3jzjuup_m-8.png"></p><br><ol><li>  Salah satu proses router menghasilkan paket ip (baru atau respons - tidak masalah). </li><li>  Sesuai dengan tabel routing, antarmuka output didefinisikan untuk paket tersebut. </li><li>  Administrator dapat menyaring lalu lintas keluar atau mengubah rute dalam rantai OUTPUT. </li><li>  Untuk paket, keputusan akhir pada antarmuka output dibuat. </li><li>  Paket jatuh ke POSTROUTING, seperti halnya <em>lalu</em> lintas yang <em>lewat</em> . </li><li>  Paket itu online. </li></ol><br><h4 id="connection-tracker">  Pelacak koneksi </h4><br><p>  Pertama, Anda perlu memahami apa filter paket stateful dan stateless. </p><br><p><img src="https://habrastorage.org/webt/8c/lg/7z/8clg7zcfasexwuw3e3utjyhypl8.png"></p><br><p>  Sebuah contoh  Komputer 192.168.100.10 membuka koneksi tcp ke server 192.0.2.10.  Di sisi klien, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">port dinamis</a> 49149 digunakan, di sisi server 80. Sebelum konten diterima, klien dan server harus bertukar paket untuk membuat sesi tcp. </p><br><p>  Dalam <em>keadaan stateless, Anda</em> perlu membuka lalu lintas dari jaringan lokal ke Internet dan dari Internet ke jaringan lokal (setidaknya untuk kisaran port dinamis).  Yang secara keseluruhan adalah lubang. </p><br><p>  Dalam router <em>stateful</em> , ia menganalisis paket-paket dan, setelah menerima tcp syn dari 192.168.100.10:49149 untuk 192.0.2.10:80, menganggap ini sebagai awal dari koneksi baru.  Semua paket lebih lanjut (ke segala arah) antara 192.168.100.10:49149 dan 192.0.2.10:80 akan dianggap sebagai bagian dari koneksi yang ada sampai sesi tcp ditutup atau timer berakhir. </p><br><p>  Untuk UDP / ICMP dan jenis lalu lintas lainnya, di mana awal dan akhir koneksi tidak dapat dibedakan dengan jelas, paket pertama adalah yang pertama, sisanya dianggap sebagai bagian dari koneksi yang dibuat dan memperbarui timer, router lupa tentang koneksi tersebut setelah timer berakhir. </p><br><p>  Pelacak koneksi membagi paket menjadi beberapa jenis: </p><br><p><img src="https://habrastorage.org/webt/j2/do/3f/j2do3fsdj1-t-hq7p2wnf0pnqte.png"></p><br><p>  <em>baru</em> - paket yang membuka koneksi, misalnya <em>syn</em> untuk tcp atau paket pertama dalam aliran udp. <br>  <em>didirikan</em> - paket yang terkait dengan koneksi yang dikenal. <br>  <em>related</em> - package terkait dengan koneksi tambahan dalam multiprotocol (sip, pptp, ftp, ...). <br>  <em>tidak valid</em> - paket dari koneksi yang tidak dikenal. <br>  <em>untracked</em> - paket tidak dilacak pelacak koneksi. </p><br><p>  <strong>Konfigurasi pelacak koneksi</strong> <br>  diaktifkan = ya - diaktifkan. <br>  diaktifkan = tidak - dinonaktifkan. <br>  enabed = auto-disable hingga aturan yang menggunakan kapabilitas conntrack muncul di firewall.  Ini digunakan secara default. </p><br><p><img src="https://habrastorage.org/webt/a9/2b/tl/a92btlt5yfxh9fhf7-wmpgrohbu.png"></p><br><p>  Parameter yang tersisa adalah timer yang berbeda dan biasanya tidak memerlukan penyetelan. </p><br><p>  Administrator dapat melihat dan menghapus koneksi, misalnya, koneksi ke NAT terlihat seperti ini: </p><br><p><img src="https://habrastorage.org/webt/mb/i7/7x/mbi77x9oinpcys1ohb516glu4mc.png"></p><br><p>  Menggunakan conntrack memengaruhi kinerja dan konsumsi sumber daya (terutama dengan sejumlah besar koneksi), tetapi itu tidak akan berfungsi di sebagian besar konfigurasi, karena  Anda akan memiliki firewall stateless tanpa NAT. </p><br><div class="spoiler">  <b class="spoiler_title">Daftar fungsi tergantung pelacak koneksi</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/la/td/kz/latdkzskcwi9cx2o4lkdwtehps8.png"></p></div></div><br><h4 id="ttl">  TTL </h4><br><p>  Time To Live - bidang dalam header paket IP yang menentukan jumlah router tempat paket dapat pergi sebelum dihancurkan, melindungi terhadap penerusan paket tanpa akhir selama loop routing. </p><br><p><img src="https://habrastorage.org/webt/gp/qi/js/gpqijsw0wgsu2yqrkcamd3z0mhk.png"></p><br><p>  Saat meneruskan, router mengurangi nilai TTL sebanyak 1, jika TTL = 0.  Dalam hal ini, paket dengan TTL = 1 akan menuju ke proses lokal router. </p><br><p>  Beberapa operator menggunakan trik TTL untuk mencegah penggunaan router.  Semua batasan ini sepadan dengan peningkatan nilai ttl dalam tabel mangle. </p><br><h4 id="nat">  NAT </h4><br><p>  Terjemahan Alamat Jaringan - teknologi untuk mengubah alamat dalam header paket ip.  Seperti linux, NAT adalah bagian dari filter paket.  NAT bekerja berdasarkan pelacak koneksi. </p><br><p>  Awalnya, NAT dirancang sebagai solusi cepat untuk masalah kelelahan alamat IPv4, untuk jaringan lokal, diusulkan untuk menggunakan subnet dari rentang: 10.0.0.0/8;  172.16.0.0/12;  192.168.0.0/16 dan menerjemahkannya menjadi satu (atau beberapa) alamat yang dapat dirutekan.  Bahkan, ada beberapa subnet layanan yang dapat digunakan pada jaringan pribadi dan router, pada prinsipnya, sama dengan cara NAT, tetapi disarankan untuk mengikuti standar. </p><br><p>  Hanya proses NAT: tcp, udp, icmp dan beberapa multi-protokol dari [IP] -&gt; [Firewall] -&gt; [Service Port].  Hanya paket pertama (koneksi-negara = baru) dalam koneksi yang diproses, paket-paket yang tersisa diproses secara otomatis tanpa partisipasi tabel NAT.  Ini bisa dilacak oleh perubahan penghitung dalam aturan. </p><br><p>  Header paket masing-masing berisi Sumber dan tujuan, dan NAT dibagi menjadi Sumber dan Tujuan NAT. </p><br><p>  <strong>Sumber NAT</strong> - alamat pengirim spoofing, hadir di sebagian besar router rumah dan perusahaan di dunia. </p><br><p><img src="https://habrastorage.org/webt/2s/ej/or/2sejor290wkc26agkonobacposa.png"></p><br><p>  Ini memungkinkan banyak perangkat dengan alamat "abu-abu" di jaringan lokal untuk berkomunikasi dengan Internet menggunakan satu (atau beberapa) alamat asli. </p><br><p><img src="https://habrastorage.org/webt/hh/hi/du/hhhidurhkrsiiuflmg6dakupph8.png"></p><br><p>  Kembali ke Packet Flow, kita melihat bahwa SRC-NAT dalam Postrouting, setelah memutuskan apakah akan merutekan paket. </p><br><p>  Paket respons melewati DST-NAT <em>implisit</em> di mana alamat penerima diubah menjadi lokal. </p><br><p>  <strong>NAT Tujuan</strong> - penggantian alamat penerima. </p><br><p><img src="https://habrastorage.org/webt/id/rb/l9/idrbl9jdlfgfvbftjkgwoorszae.png"></p><br><p>  Digunakan, jika perlu, untuk meneruskan paket ke alamat lain, biasanya digunakan untuk "meneruskan port" dari jaringan eksternal ke jaringan lokal. </p><br><p><img src="https://habrastorage.org/webt/ju/uv/ly/juuvlyxr74gi8qykxx80vzhyvg4.png"></p><br><p>  Menurut Packet Flow, operasi DST-NAT terjadi sebelum keputusan tentang perutean di Prerouting dibuat, SRC-NAT <em>implisit</em> hadir untuk lalu lintas respons. </p><br><p>  NAT adalah alat manajemen lalu lintas yang cukup kuat, tetapi harus digunakan terakhir (ketika alat lain tidak dapat membantu). </p><br><h4 id="cepochkichains-bazovye-i-polzovatelskie">  Rantai (rantai) dasar dan pengguna </h4><br><p>  Rantai terdiri dari aturan dan memaksa logika pemrosesan paket. <br>  Ada beberapa rantai dasar yang dipetakan ke aliran paket: <br>  <strong>Prerouting (dstnat)</strong> - pemrosesan paket sebelum memutuskan rute <br>  Paket pemrosesan <strong>input</strong> ditujukan untuk proses lokal router <br>  <strong>Keluaran</strong> - pemrosesan paket paket yang dihasilkan oleh proses lokal router <br>  <strong>Maju</strong> - Memproses Passing Traffic <br>  <strong>Postrouting (srcnat)</strong> - Memproses lalu lintas yang siap untuk dikirim ke antarmuka </p><br><p>  <em>Semuanya seperti di iptables, tetapi rantai di nat diganti nama.</em>  <em>Apa yang terhubung dengan ini (kemungkinan besar dengan hotspot atau pembongkaran perangkat keras nat) tidak diketahui oleh saya, tetapi tidak mengubah apa pun.</em> </p><br><p>  Paket melewati aturan dalam rantai secara berurutan, jika cocok untuk semua kondisi, maka tindakan diterapkan ke paket.  Jika tindakan mengakhiri dan tidak menjatuhkan paket, maka diteruskan ke blok aliran paket berikutnya. </p><br><p>  Semua rantai dasar memiliki tindakan default (jika paket tidak sesuai dengan salah satu aturan) - <em>terima</em> . </p><br><p>  Rantai kustom diperlukan untuk mengurangi jumlah aturan yang dilewati setiap paket dan membuat aturan yang rumit untuk memproses lalu lintas.  Semua rantai pengguna memiliki tindakan default - <em>kembali</em> . </p><br><p><img src="https://habrastorage.org/webt/bk/rg/sk/bkrgskh5wudzzf54mueqiy9oehk.png"></p><br><p>  Di dalam tabel, Anda bisa meneruskan aturan dari beberapa rantai basis (dan pengguna) yang berbeda ke rantai pengguna, tetapi paket tersebut akan kembali ke rantai dari mana asalnya. </p><br><p><img src="https://habrastorage.org/webt/_8/kw/oi/_8kwoirut9mtd67elbejqkzdsek.png"></p><br><h4 id="usloviya-v-pravilah">  Syarat dan Ketentuan </h4><br><p>  Rantai terdiri dari aturan, setiap aturan terdiri dari kondisi dan tindakan.  Ada banyak kondisi, tetapi tidak semua dari Anda akan menggunakan dalam konfigurasi nyata.  Sebagian besar kondisi dapat diawali dengan "tidak" (tanda "!").  Agar sesuai dengan aturan, paket harus cocok untuk semua kondisi ini. </p><br><p><img src="https://habrastorage.org/webt/la/dh/or/ladhorisauzv81cnmffmkjo6_hi.png"></p><br><div class="spoiler">  <b class="spoiler_title">Beberapa kondisinya</b> <div class="spoiler_text"><table><thead><tr><th>  Ketentuan </th><th>  Deskripsi </th></tr></thead><tbody><tr><td>  src-address </td><td>  Alamat Sumber </td></tr><tr><td>  alamat pertama </td><td>  Alamat penerima </td></tr><tr><td>  src-address-list </td><td>  Alamat sumber tercantum. </td></tr><tr><td>  dst-address-list </td><td>  Alamat penerima terdaftar </td></tr><tr><td>  protokol </td><td>  Protokol lapisan transport </td></tr><tr><td>  src-port </td><td>  Port sumber </td></tr><tr><td>  port pertama </td><td>  Port Penerima </td></tr><tr><td>  pelabuhan </td><td>  Sumber atau port tujuan </td></tr><tr><td>  dalam antarmuka </td><td>  Antarmuka tempat paket itu datang </td></tr><tr><td>  out-interface </td><td>  Antarmuka dari mana paket akan dikirim ke jaringan </td></tr><tr><td>  dalam-antarmuka-daftar </td><td>  Antarmuka tempat paket datang terdaftar </td></tr><tr><td>  keluar-antarmuka-daftar </td><td>  Antarmuka dari mana paket akan dikirim ke jaringan terdaftar </td></tr><tr><td>  layer7-protokol </td><td>  Analisis isi dari 10 paket pertama dalam suatu koneksi </td></tr><tr><td>  konten </td><td>  Cari string yang diberikan dalam batch </td></tr><tr><td>  tls-host </td><td>  Host pencarian di tls header </td></tr><tr><td>  kebijakan-IPSec </td><td>  Periksa apakah paket cocok dengan kebijakan ipsec atau tidak </td></tr><tr><td>  ukuran paket </td><td>  ukuran paket dalam byte </td></tr><tr><td>  src-mac-address </td><td>  alamat sumber paket mac </td></tr><tr><td>  tanda koneksi </td><td>  Label koneksi </td></tr><tr><td>  tanda paket </td><td>  Label paket </td></tr><tr><td>  Routing-mark </td><td>  Paket Waypoint </td></tr><tr><td>  kondisi koneksi </td><td>  Status paket koneksi </td></tr><tr><td>  tcp-flags </td><td>  Paket panji tcp </td></tr><tr><td>  opsi icmp </td><td>  Opsi paket Icmp </td></tr><tr><td>  acak </td><td>  Aturan dipicu (ketika kondisi lain bertepatan) dengan probabilitas yang diberikan </td></tr><tr><td>  waktu </td><td>  Anda dapat menentukan jam kerja aturan, sayangnya tanpa konversi tanggal </td></tr><tr><td>  ttl </td><td>  Nilai bidang TTT dalam paket </td></tr><tr><td>  dscp </td><td>  Nilai bidang DSCP (ToS) dalam paket </td></tr><tr><td>  - // - </td><td>  - // - </td></tr><tr><td>  tempat-sebelumnya </td><td>  Opsi konsol (tanpa syarat), memungkinkan Anda menambahkan aturan sebelum ditentukan </td></tr><tr><td>  dinonaktifkan </td><td>  Opsi konsol (bukan kondisi), memungkinkan Anda untuk menonaktifkan aturan </td></tr></tbody></table><br><p>  <strong>Catatan</strong> <br>  Sebagai Alamat src. (Dst.), Anda dapat menentukan: ip tunggal, rentang alamat melalui tanda hubung, atau subnet. <br>  Daftar alamat diperlukan untuk menggabungkan beberapa ip yang tidak terhubung dengan nama yang sama.  Tidak seperti ipset di netfilter, entri dalam daftar MikroTik dapat dihapus setelah jangka waktu tertentu.  Anda dapat melihat daftar dan membuat perubahan dalam [IP] -&gt; [Firewall] -&gt; [Daftar Alamat]. <br>  Sebagai nomor port (port, src-port, dst-port), Anda dapat menentukan satu port, beberapa port dipisahkan oleh koma, atau rentang port melalui tanda hubung. </p></div></div><br><p>  Pada MUM terakhir di MSC, ada presentasi yang baik tentang efek berbagai kondisi pada kecepatan pemrosesan paket (di sana Anda akan belajar cara menggunakan tabel mentah untuk mengurangi beban pada router), yang tertarik pada: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">perekaman</a> dan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">presentasi</a> . </p><br><h4 id="deystviya-v-tablicah">  Tindakan Tabel </h4><br><p>  Serangkaian tindakan yang tersedia pada paket tergantung pada tabel di mana ia diproses. <br><img src="https://habrastorage.org/webt/i3/ba/xj/i3baxjyyz-fnswxpanh_qek5kq8.png"><br>  <strong>Filter</strong> - tabel pemfilteran lalu lintas, salah satu dari dua tempat di mana Anda dapat menjatuhkan paket. </p><br><p>  <strong>NAT</strong> - tabel untuk memodifikasi alamat dan port ip (tpc, udp) di header paket ip. </p><br><p>  <strong>Mangle</strong> - tabel untuk memodifikasi bidang lain dari paket ip dan mengatur berbagai label. </p><br><p><img src="https://habrastorage.org/webt/w0/dc/n3/w0dcn3uinajpugbflfjha0pt5jy.png"></p><br><p>  Ada tiga jenis label paket internal: koneksi, paket, rute.  Label hanya ada di dalam router dan tidak pergi ke jaringan.  Suatu paket dapat memiliki satu label dari masing-masing jenis, sementara melewati beberapa aturan mark-* secara berurutan, label ditimpa. <br>  Label rute hanya dapat ditetapkan di rantai prerouting dan output, sisanya di rantai apa pun. </p><br><p>  Merupakan praktik yang baik untuk menandai koneksi terlebih dahulu, kemudian paket (paket) atau rute (rute).  Memeriksa label lebih cepat daripada bidang paket.  Dalam praktiknya, ini tidak selalu terjadi dalam antrian kompleks atau pbr menandai tambahan koneksi tidak berguna. </p><br><p>  <strong>RAW</strong> - tabel yang memungkinkan paket untuk memotong pelacak koneksi.  Ini digunakan untuk menangkal DoS dan mengurangi beban pada cpu (misalnya, menghilangkan lalu lintas multicast).  Memungkinkan Anda menjatuhkan paket. </p><br><p>  Mengakhiri tindakan menyelesaikan pemrosesan paket dalam rantai dan meneruskannya ke blok berikutnya dalam aliran paket, atau membuangnya. </p><br><div class="spoiler">  <b class="spoiler_title">Tindakan</b> <div class="spoiler_text"><table><thead><tr><th>  Meja </th><th>  Aksi </th><th>  Deskripsi </th><th>  Mengakhiri? </th></tr></thead><tbody><tr><td>  Semua </td><td>  terima </td><td>  Hentikan pemrosesan paket dan transfer ke blok aliran Pakcet berikutnya </td><td>  Ya </td></tr><tr><td>  Semua </td><td>  log </td><td>  Informasi paket log. Dalam versi modern, Anda dapat menambahkan log ke tindakan lain apa pun. </td><td>  Tidak </td></tr><tr><td>  Semua </td><td>  passtrough </td><td>  Hitung jumlah paket.  Digunakan untuk debugging </td><td>  Tidak </td></tr><tr><td>  Semua </td><td>  tambahkan src ke daftar alamat dan tambahkan dst ke daftar alamat </td><td>  Tambahkan alamat (tujuan) sumber dari paket ke daftar yang diberikan </td><td>  Tidak </td></tr><tr><td>  Semua </td><td>  lompat </td><td>  Buka rantai pengguna </td><td>  Ya </td></tr><tr><td>  Semua </td><td>  kembali </td><td>  Kembali ke rantai induk.  Dalam rantai dasar berfungsi seperti menerima </td><td>  Ya </td></tr><tr><td>  Filter dan Raw </td><td>  jatuh </td><td>  Hentikan aliran paket pada aliran paket dan buang </td><td>  Ya </td></tr><tr><td>  Filter dan Prerouting </td><td>  jalur cepat </td><td>  Paket flag untuk aliran paket yang cepat </td><td>  Ya </td></tr><tr><td>  Saring </td><td>  tolak </td><td>  Seperti drop, tetapi pengirim paket mengirim pemberitahuan (tcp atau icmp) tentang paket yang dijatuhkan </td><td>  Ya </td></tr><tr><td>  Saring </td><td>  trapit </td><td>  Meniru kehadiran port terbuka.  Digunakan untuk perlindungan terhadap DoS, menyesatkan dan (terkadang) debugging </td><td>  Ya </td></tr><tr><td>  NAT </td><td>  src-nat </td><td>  Pergantian alamat pengirim ke yang ditentukan </td><td>  Ya </td></tr><tr><td>  NAT </td><td>  topeng </td><td>  Kasus khusus src-nat, menggantikan alamat pengirim dengan salah satu alamat dari antarmuka, digunakan pada antarmuka dinamis (dhcp, vpn).  Tidak disarankan untuk menggunakan jika ada beberapa ip pada antarmuka </td><td>  Ya </td></tr><tr><td>  NAT </td><td>  sama </td><td>  Kasus khusus src-nat.  Mengganti alamat pengirim dengan alamat dari rentang yang ditentukan </td><td>  Ya </td></tr><tr><td>  NAT </td><td>  dst-nat </td><td>  Mengganti alamat penerima dengan yang ditentukan </td><td>  Ya </td></tr><tr><td>  NAT </td><td>  redirect </td><td>  Kasus khusus dst-nat, menggantikan alamat penerima dengan alamat antarmuka router tempat paket itu datang </td><td>  Ya </td></tr><tr><td>  NAT </td><td>  netmap </td><td>  Bukan pengganti dst-nat.  Digunakan untuk terjemahan jaringan-ke-jaringan, lihat contoh </td><td>  Ya </td></tr><tr><td>  Mangle </td><td>  tandai koneksi </td><td>  Label koneksi </td><td>  Tidak </td></tr><tr><td>  Mangle </td><td>  tandai paket </td><td>  Label paket diterapkan dalam antrian </td><td>  Tidak </td></tr><tr><td>  Mangle </td><td>  menandai rute </td><td>  Label rute diterapkan dalam perutean basis Kebijakan </td><td>  Tidak </td></tr><tr><td>  Mangle </td><td>  ubah ttl </td><td>  Edit ttl </td><td>  Tidak </td></tr><tr><td>  Mangle </td><td>  ubah dcsp (tos) </td><td>  Ubah desimal dcsp </td><td>  Tidak </td></tr><tr><td>  Mangle </td><td>  ubah mss </td><td>  Ubah mss ke tcp syn </td><td>  Tidak </td></tr><tr><td>  Mangle </td><td>  hapus df </td><td>  Hapus jangan bendera terfragmentasi </td><td>  Tidak </td></tr><tr><td>  Mangle </td><td>  menghapus opsi ipv4 </td><td>  Hapus opsi lanjutan ipv4 </td><td>  Tidak </td></tr><tr><td>  Mangle </td><td>  tetapkan prioritas </td><td>  Tetapkan prioritas untuk CoS </td><td>  Tidak </td></tr><tr><td>  Mangle </td><td>  rute </td><td>  Setel gateway untuk paket.  Versi PBR yang sederhana </td><td>  Tidak </td></tr><tr><td>  Mangle </td><td>  mengendus tzsp </td><td>  Enkapsulasi paket dalam udp dan kirim ke ip yang ditentukan </td><td>  Tidak </td></tr><tr><td>  Mangle </td><td>  mengendus pc </td><td>  Analog tzsp, tetapi dengan tipe enkapsulasi yang berbeda.  Di wiki jika menggunakan case dengan calea </td><td>  Tidak </td></tr><tr><td>  Mangle </td><td>  passtrough </td><td>  Secara default, sebagian besar aturan di mangle tidak menghentikan paket agar tidak lewat, Anda bisa mengubah perilaku ini dengan mengatur passtrough = tidak </td><td>  Tidak </td></tr><tr><td>  Mentah </td><td>  notrack </td><td>  Jangan melacak paket dalam pelacak koneksi </td><td>  Ya </td></tr></tbody></table><br><p>  <em>Jika ada yang menginginkannya, saya dapat menulis lebih banyak tentang FastTrack dan FastPath, tetapi Anda seharusnya tidak mengharapkan keajaiban dari teknologi ini.</em> </p></div></div><br><h4 id="para-slov-pro-dpi">  Beberapa kata tentang DPI </h4><br><p>  Ada beberapa kemungkinan untuk melihat ke dalam paket sedikit lebih dalam dari header layer transport: <br>  <em>content</em> - mencari string yang diberikan dalam suatu paket. <br>  <em>layer7-protocol</em> - buffer 10 paket pertama (atau 2KiB) dari koneksi dan mencari regexp dalam data buffered.  Sejumlah besar aturan layer7 secara signifikan mempengaruhi kinerja. <br>  <em>tls-host</em> adalah alamat nama host di header TLS / SNI koneksi HTTPS. </p><br><h3 id="primery">  Contohnya </h3><br><p>  Jangan menyalin contoh tanpa berpikir, lebih baik untuk mengambil perangkat dan mencoba untuk menulis sendiri konfigurasi (atau menulis ulang contoh, tetapi untuk memahami apa yang masing-masing aturan lakukan).  Jika Anda tidak tahu cara melengkapi aturan: di konfigurasi rumah default dan minimum tidak ada akses ke router dari antarmuka yang lemah, tambahkan dengan penyaringan berdasarkan daftar alamat. </p><br><h4 id="defoltnyy-firewall-routeros">  RouterOS Firewall Default </h4><br><p>  Konfigurasi yang cukup aman, tetapi di tempat-tempat sangat membingungkan: </p><br><pre><code class="plaintext hljs">/ip firewall filter #     (established, related)   (untracked)  add action=accept chain=input connection-state=established,related,untracked #    (invalid)  add action=drop chain=input connection-state=invalid #  icmp  add action=accept chain=input protocol=icmp #          add action=drop chain=input in-interface-list=!LAN #   ipsec    add action=accept chain=forward ipsec-policy=in,ipsec add action=accept chain=forward ipsec-policy=out,ipsec #          add action=fasttrack-connection chain=forward connection-state=established,related #       add action=accept chain=forward connection-state=established,related,untracked #    add action=drop chain=forward connection-state=invalid #     wan ,     dstnat (,      src-nat   dst-nat) add action=drop chain=forward connection-nat-state=!dstnat connection-state=new in-interface-list=WAN /ip firewall nat #Source NAT      ipsec,      WAN add action=masquerade chain=srcnat ipsec-policy=out,none out-interface-list=WAN</code> </pre> <br><p>  Saya tidak pernah menggunakan konfigurasi default, tetapi sebelum firewall default jauh lebih buruk. </p><br><h4 id="minimalnyy-domashniy-firewall">  Firewall Rumah Minimal </h4><br><p>  Hal termudah untuk muncul.  Ya, lalu lintas yang tidak dilacak tidak diizinkan di dalamnya (tetapi pada tahap studi dasar firewall Anda masih tidak membutuhkannya) dan akan ada masalah dengan tunnel ipsec (sekali lagi, jika Anda dapat mengkonfigurasi ipsec, Anda sendiri tahu apa yang harus dilakukan). </p><br><pre> <code class="plaintext hljs">/ip firewall filter #     (established, related)  add chain=input connection-state=established,related action=accept #  icmp  add chain=input connection-state=new protocol=icmp action=accept #      add chain=input connection-state=new in-interface-list=LAN action=accept #     add chain=input action=drop #       add chain=forward connection-state=established,related action=accept #         add chain=forward connection-state=new in-interface-list=LAN action=accept #     add chain=forward action=drop /ip firewall nat #Source NAT        WAN add chain=srcnat out-interface-list=WAN action=masquerade</code> </pre> <br><h4 id="primer-s-dmz">  Contoh DMZ </h4><br><p>  Pada router "home", DMZ akronim suka memanggil komputer di subnet lokal tempat semua port dari jaringan eksternal diteruskan. </p><br><p>  Bahkan, ini tidak demikian dan salah satu opsi DMZ adalah untuk memisahkan sumber daya yang Anda harus memberikan akses dari Internet dan serangan yang berhasil dapat dilakukan (server web dengan cms di mana lubang selalu ditemukan adalah target yang baik untuk penyerang).  Dalam hal peretasan, penyerang tidak akan dapat mempengaruhi peserta di jaringan lokal. </p><br><p><img src="https://habrastorage.org/webt/bb/pp/9g/bbpp9gbe7k4owuef7hxuzisrurg.png"></p><br><pre> <code class="plaintext hljs">#  /ip firewall nat add chain=dstnat dst-port=80,443 action=dst-nat to-address=192.168.200.2 /ip firewall filter #   icmp   add chain=input connection-state=established,related action=accept add chain=input protocol=icmp connection-state=new action=accept #      add chain=input in-interface=ether2-lan action=accept #    add chain=input action=drop #    add chain=forward connection-state=established,related action=accept #        add chain=forward in-interface=ether2-lan connection-state=new action=accept #    web  add chain=forward out-interface=ether3-dmz dst-address=192.168.200.2 dst-port=80,443 connection-state=new action=accept #   add chain=forward action=drop</code> </pre> <br><h4 id="hairpin-nat">  Jepit Rambut NAT </h4><br><p><img src="https://habrastorage.org/webt/r5/ms/wv/r5mswv8kwtp0m3amzpl--bd5fn0.png"></p><br><pre> <code class="plaintext hljs">/ip firewall nat add chain=dstnat dst-port=80 action=dst-nat to-address=192.168.100.2</code> </pre> <br><p>  Situasi umum adalah ketika Anda meneruskan port ke server di jaringan lokal dan semuanya bekerja dari luar, tetapi di dalam jaringan lokal server tidak dapat diakses di alamat eksternal. </p><br><p>  Mari kita lihat apa yang terjadi: </p><br><ol><li>  Komputer 192.168.100.10 mengirim permintaan ke 192.0.2.100 </li><li>  Ia melakukan DST-NAT pada router dan paket diteruskan ke 192.168.100.2 </li><li>  Server melihat bahwa paket dari 192.168.100.10 telah sampai di alamat 192.168.100.2 dan merespons dari alamat lokal </li><li>  Komputer menerima paket tak terduga dari 192.168.100.2 dan membuangnya. </li></ol><br><p>  Solusinya adalah menambahkan aturan tambahan yang mengubah alamat sumber ke alamat router, sehingga server akan mengembalikan paket ke router, yang akan mengirimkannya ke komputer penginisialisasi. </p><br><pre> <code class="plaintext hljs">/ip firewall nat #  add chain=dstnat dst-port=80 action=dst-nat to-address=192.168.100.2 # ,      add chain=srcnat src-address=192.168.100.0/24 dst-address=192.168.100.2 action=masquerade</code> </pre> <br><p>  Dalam praktiknya, skema ini tidak sering digunakan, tetapi sebagai contoh debugging firewall, saya sangat menyukainya. </p><br><h4 id="pravilnoe-ispolzovanie-netmap">  Penggunaan netmap dengan benar </h4><br><p><img src="https://habrastorage.org/webt/l9/xa/ox/l9xaoxkyat1phpmy6tnnhau6nls.png"><br>  Netmap adalah teknologi untuk menerjemahkan alamat dari satu subnet ke alamat subnet lainnya. <br>  Alamat IP (dalam entri mask) terdiri dari dua bagian: jaringan (jumlah bit yang ditentukan dalam subnet mask) dan host (bit yang tersisa).  Netmap mengubah bagian jaringan dari alamat, tetapi tidak menyentuh bagian host. </p><br><p><img src="https://habrastorage.org/webt/jy/eh/xh/jyehxh3hok1l5-wfw6c8n4czdlu.png"></p><br><p>  Ada dua router yang terhubung oleh saluran VPN.  Router melayani subnet dengan pengalamatan yang sama.  Hal ini diperlukan untuk membuat akses antar subnet. </p><br><p>  Anda tidak dapat melakukannya tanpa pengalamatan tambahan. </p><br><p>  Pengguna dari subnet kiri akan mengetuk ke kanan melalui subnet 192.168.102.0/24 <br>  Pengguna dari subnet kanan akan mengetuk ke kiri melalui subnet 192.168.101.0/24 </p><br><p>  Konfigurasi pada MikroTik 1. </p><br><pre> <code class="plaintext hljs">#     /ip route add distance=1 dst-address=192.168.102.0/24 gateway /ip firewall nat #       add action=netmap chain=srcnat dst-address=192.168.102.0/24 out-interface=ipip src-address=192.168.100.0/24 to-address=192.168.101.0/24 #       add action=netmap chain=dstnat dst-address=192.168.101.0/24 in-interface=ipip src-address=192.168.102.0/24 to-address=192.168.100.0/24</code> </pre> <br><p>  Konfigurasi MikroTik2 hampir sama: </p><br><pre> <code class="plaintext hljs">/ip route add distance=1 dst-address=192.168.101.0/24 gateway=10.10.10.1 /ip firewall nat add action=netmap chain=srcnat dst-address=192.168.101.0/24 out-interface=ipip src-address=192.168.100.0/24 to-address=192.168.102.0/24 add action=netmap chain=dstnat dst-address=192.168.102.0/24 in-interface=ipip src-address=192.168.101.0/24 to-address=192.168.100.0/24</code> </pre> <br><p>  Ada konfigurasi yang lebih kompleks menggunakan netmap, misalnya, jika Anda memiliki banyak koneksi ke titik-titik jarak jauh dengan subnet berpotongan dan tidak ada cara untuk mengubah pengaturan pada peralatan jarak jauh, tetapi ini sudah routing yang maju. </p><br><p>  Jika Anda tidak mengerti apa-apa (tentang netmap), maka Anda tidak membutuhkannya dan tidak menggunakan tindakan ini saat meneruskan port. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id435070/">https://habr.com/ru/post/id435070/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id435054/index.html">Universitas ITMO "dalam praktiknya": dengan perusahaan teknologi mana kita bekerja sama</a></li>
<li><a href="../id435056/index.html">Samsung SSD 860 QVO 1 TB dan 4 TB: konsumen pertama SATA QLC (3 bagian)</a></li>
<li><a href="../id435060/index.html">2018 adalah tahun skuter. Apa selanjutnya</a></li>
<li><a href="../id435062/index.html">Panduan: Thymeleaf + Spring. Bagian 1</a></li>
<li><a href="../id435064/index.html">Kami mengendarai Xiaomi Vacuum Cleaner</a></li>
<li><a href="../id435072/index.html">Memori analog 8-bit untuk bekerja dengan jaringan saraf</a></li>
<li><a href="../id435074/index.html">Kerentanan Kyivstar: 1) analisis posting sebelumnya tentang kata sandi + 2) info tentang pembelian yang melewati layanan Kyivstar</a></li>
<li><a href="../id435076/index.html">Bagaimana pemasar bekerja dengan Google memonetisasi ketidaknyamanan kami</a></li>
<li><a href="../id435078/index.html">Bagaimana jika kecerdasan buatan membuat aktor abadi?</a></li>
<li><a href="../id435080/index.html">Panduan: Thymeleaf + Spring. Bagian 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>