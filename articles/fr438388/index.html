<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎳 🙏🏼 🍩 Serveur de messages push 👶 🔂 💟</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans tout service Internet moderne, il n'y a que deux fonctions principales: 



- Le premier est l'autorisation de l'utilisateur. 
- Le second est l'...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Serveur de messages push</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/438388/">  Dans tout service Internet moderne, il n'y a que deux fonctions principales: <br><br><ul><li>  Le premier est l'autorisation de l'utilisateur. </li><li>  Le second est l'envoi instantané d'un événement du serveur au client. </li></ul><br>  Le premier point, je pense, n'a pas besoin d'explication. <br><br>  Le deuxième point est la technologie client-serveur, mais vice versa.  Le client ne fait pas périodiquement de demande au serveur - y a-t-il de nouveaux messages.  Le serveur, lorsqu'un certain événement se produit, envoie immédiatement le message au client. <br><br>  Pour une meilleure compréhension, le service n'est pas une certaine sphère dans le vide.  Le service peut être représenté comme: <br><br><ul><li>  Un dossier avec des fichiers dans le cloud.  Les informations sur la modification, l'ajout et la suppression sont envoyées à d'autres utilisateurs ou à l'utilisateur actuel, mais à d'autres appareils. </li><li>  Un programme informatique pour lire les journaux du serveur, lorsque des enregistrements «d'erreur» apparaissent, envoyer le contenu de l'enregistrement à l'utilisateur sur un téléphone mobile. </li><li>  Judas vidéo (caméra) prenant des photos lorsque vous vous approchez de la porte de l'appartement. </li><li>  Un service recevant la télémétrie d'une application android-auto. </li><li>  Un service similaire au paragraphe précédent, qui vous permet de savoir si un enfant a atteint l'école ou est rentré de l'école. </li></ul><br>  La liste peut être étendue indéfiniment; à titre d'exemple, seuls les cas d'utilisation les plus connus sont donnés. <br><br>  Presque tous les exemples de services peuvent être présentés sous la forme d'un "messager".  Une partie des exemples a été décrite exactement de cette façon; j'ai vu des articles sur la façon de connecter l'appareil photo et d'envoyer des photos à un célèbre messager. <br><br>  Il n'y a pas si longtemps, il y avait un article selon lequel des étrangers regardaient le service de caméra dans les yeux de la porte, au lieu de l'intelligence artificielle.  Je ne me concentrerai pas sur les services gratuits des grandes "bonnes" sociétés.  Comme on dit dans le célèbre proverbe «Le fromage gratuit arrive dans une souricière» et guidé par un autre proverbe «Votre chemise est plus proche de votre corps», votre «service» est meilleur. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le code de script du serveur est ouvert et gratuit</a> <br><br><img src="https://habrastorage.org/webt/wx/2d/a4/wx2da4acw9c3g_x0a_mxj8dukju.png"><br><a name="habracut"></a><br>  J'ai choisi node.js socket.io postgreSQL pour l'implémentation, j'ai implémenté la première version il y a plus de deux ans, et le service était étroitement lié à 1c <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://infostart.ru/public/545047/</a> , ils n'avaient encore annoncé de serveur d'interaction nulle part.  Mais il y a longtemps, à l'heure actuelle, la partie serveur n'est en aucun cas connectée au programme mentionné, la partie client peut être intégrée en tant que traitement externe ou extension. <br><br>  Le nom choisi est significatif - «push0k».  La première partie est tirée de l'expression "push message", le deuxième anglais bien connu sous forme abrégée, mais il est écrit par zéro pour le plus significatif. <br><br>  Dans ce cas, ce n'est pas un «fromage gratuit dans une souricière», car il nécessite un ordinateur Windows, Linux, macOS (serveur) pour fonctionner via Internet, vous avez besoin d'une adresse IP externe, éventuellement transmise.  De préférence le nom de domaine associé à l'adresse IP externe.  En outre, il est souhaitable, mais pas nécessaire, pas un certificat auto-signé associé à un nom de domaine. <br><br>  Il n'y a aucune configuration matérielle en tant que telle, il peut fonctionner sur le NAS domestique, où il y a docker.  Docker dans nas signifie architecture x86-64, et postgreSQL ne peut pas être installé dans un tel nas sans docker.  Une compréhension précise du nombre de clients qu'un tel serveur peut prendre en charge dépend des tâches - la logique du service et le trafic transmis entre les clients. <br><br><h4>  Description du serveur: </h4><br>  Le serveur utilise des modules supplémentaires: <br><br><ul><li>  socket.io - le module ajoute un protocole websocket avec une tonne d'ext.  opportunités. </li><li>  node-postgres - module de communication avec le serveur de base de données postgreSQL. </li><li>  pm2 est un module permettant de démarrer plusieurs processus serveur avec un équilibreur de charge. </li></ul><br><h4>  Fichiers serveur: </h4><br><ul><li>  starter.js - service http (s), vous pouvez dire le panneau d'administration du serveur.  Grâce à ce service, les paramètres sont modifiés et les processus du serveur Websocket principal sont lancés. </li><li>  push0k.js est le serveur websocket principal. </li><li>  starter_cfg.js - paramètres de script d'administration du serveur.  Connexion à postgreSQL et fichiers pour la connexion https.  Les fichiers pour les connexions https, ainsi que le nom de domaine, peuvent différer du serveur principal, pour plus de sécurité.  Il est modifié manuellement au premier démarrage. </li><li>  config.js - les paramètres de base de l'ensemble du serveur. </li><li>  package.js - modules auteur de la description du fichier nécessaires au travail. </li><li>  push0kStructure.sql - description du fichier de la base de données postgreSQL pour l'initialisation initiale, une base de données vide. </li></ul><br><h4>  Installation: </h4><br>  1. Initialement, vous devez installer node.js <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nodejs.org/en/download</a> <br><br>  2. PostgreSQL doit également être installé sur l'ordinateur du réseau local ou le même <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">postgrespro.ru/products/download</a> <br><br>  Sur le serveur postgreSQL, il est nécessaire d'exécuter le fichier «push0kStructure.sql» ou presque toutes les requêtes de ce fichier pour créer une base de données avec les tables nécessaires. <br><br>  3. Téléchargez les cinq premiers fichiers du serveur, à l'exception de push0kStructure.sql, dans n'importe quel répertoire d'ordinateur. <br><br>  4. Dans n'importe quel éditeur de texte, modifiez le fichier "starter_cfg.js".  Il est important de spécifier les paramètres de connexion au serveur postgreSQL et de définir le port de connexion à la partie administrative du serveur push0k. <br><br>  5. Démarrez le terminal (console) et utilisez la commande «cd / chemin / votre / répertoire /» pour accéder au répertoire de fichiers du serveur.  Le chemin spécifié dans la commande de terminal doit être à partir du point 3. <br><br>  6. Exécutez la commande dans le terminal «npm install» pour installer des modules supplémentaires. <br>  Exécutez la commande dans le terminal «node starter.js» pour démarrer le service d'administration. <br><br>  7. Téléchargez et installez le programme d'administration push0k.  Dans "push0k admin", les paramètres de base du websocket, le port du serveur, le nombre de processus et bien d'autres sont configurés.  Vous pouvez contrôler le démarrage et l'arrêt des processus serveur, créer et gérer les utilisateurs et leurs salles (groupes). <br><br><h4>  Application d'administration Push0k </h4><br><img src="https://habrastorage.org/webt/fk/fo/go/fkfogovxziochbj901ouycltfjq.png"><br><br>  L'application se fait sur électron en utilisant vue.js.  À l'intérieur, une sorte de système de fenêtres est implémenté, de petites boîtes de dialogue modales peuvent être glissées et déposées comme des fenêtres, les titres de fenêtres pour les fenêtres sont similaires à Windows 10, pour Mac OS comme dans les dernières versions, mais jusqu'à présent sans prendre en compte le thème sombre.  Pour linux, je vais compiler plus tard, c'est un peu plus compliqué avec les en-têtes de dialogue, je pense que ce sera comme dans ubuntu et, si ce n'est pas ubuntu, alors gagner 10 styles.  La consommation de mémoire dans Win 10 et Mac OS de plus de 150 mégaoctets n'a pas vu. <br><br>  Dans les versions précédentes, il n'était pas possible d'ajouter de l'animation, faisait un peu sans fanatisme.  Les boîtes de dialogue décrites précédemment - les fenêtres apparaissent à partir du centre de la fenêtre de l'application, augmentant progressivement, lorsqu'elles sont fermées, volent vers le centre, diminuant.  De plus, les pressions sur les boutons et les champs obligatoires sont animés. <br><br><img src="https://habrastorage.org/webt/rn/ts/vr/rntsvrtjjhvvsnpu6vf_oyguwou.gif"><br><br>  Lors de la mise en œuvre, il y avait un grand désir de faire un thème sombre, mais comme il n'y avait pas encore de thème clair, je devais me contenter du panneau de boutons à droite.  Sous Mac OS, cette seule partie sombre a un effet de dynamisme, c'est-à-dire qu'elle est partiellement transparente, semblable à la plupart des fenêtres de l'interface standard.  Malheureusement, sous Windows, un effet similaire appelé fluent design n'a pas pu être effectué car il n'y a pas de fonctionnalité similaire dans Windows pour électron. <br><br>  Comme mentionné précédemment, le contrôle utilise les protocoles http et ws (websocket).  Il est possible d'utiliser des connexions https et wss sécurisées.  Avec des connexions sécurisées, vous pouvez voir les données des certificats utilisés.  De la même manière que pour les navigateurs, l'icône «Lock» est utilisée - la connexion est sécurisée, «Open lock» - la connexion n'est pas sûre.  Et sans icônes, respectivement - une connexion sécurisée n'est pas utilisée. <br><br><img src="https://habrastorage.org/webt/xz/mt/ew/xzmtew2kpyuhppeugz2fth2lxvm.png"><br><br><h4>  Logique générale </h4><br>  Je n'ai jamais vu une telle application.  Pendant le développement, j'ai été guidé par le fait que je serais moi-même intéressé par le suivi et les paramètres à voir dans les statistiques. <br><br>  Par exemple, dans la table de connexion pour chaque connexion, il y a des données «heure de connexion», «heure d'autorisation», «heure de synchronisation».  Le premier vous permet de comprendre à quelle vitesse la connexion «ws: //» ou le «wss: //» protégé est établi.  La seconde - après la connexion, un message avec les données d'autorisation est envoyé séparément, pendant l'autorisation, une demande de vérification de l'utilisateur est effectuée et une vérification du hachage du mot de passe est unique pour chaque connexion.  Troisièmement, il est temps de recevoir de nouveaux messages et des données de référence nouvelles ou mises à jour.  De plus, les versions de node.js, socket.io et d'autres données décrites sont généralement enregistrées, ce qui permet de comprendre comment la mise à jour de node.js ou du module a affecté séparément la vitesse, ou un raffinement du serveur aurait pu affecter. <br><br><img src="https://habrastorage.org/webt/xs/_h/ak/xs_haktlpy5r-gb_6ktxpf9_osa.png"><br><br>  Dans l'exemple ci-dessus, seule une petite partie de ces données est décrite.  De plus, dans un tableau séparé, le temps, la taille et la vitesse des Mo / s sont enregistrés.  Téléchargez la synchronisation des données.  Le même tableau stocke les données de téléchargement des fichiers joints sur le serveur et de téléchargement de ces données depuis le serveur. <br><br>  Le temps de calcul de la vitesse est calculé sur le client ou le serveur, selon la situation.  Il est impossible d'utiliser l'heure du serveur et du client car elle ne peut pas être parfaitement synchronisée.  Cela impose un petit retard de taille de ping (confirmation de livraison) entre le client et le serveur.  Lors du téléchargement ou du téléchargement de fichiers volumineux, le décalage décrit n'est pas significatif. <br><br>  Dans le tableau de connexion, vous pouvez voir la connexion fermée avec les données «octet transmis», «octet reçu» et «taille» des données de synchronisation plus que «l'octet transmis».  Lors de la synchronisation des données, la compression automatique est utilisée par socket.io, lors du téléchargement ou du téléchargement de pièces jointes, la compression automatique est désactivée, car la compression déjà compressée a souvent un effet négatif sur la vitesse. <br><br>  Comme écrit au début de l'article, il n'a jamais été question de créer un service commun et d'y connecter autant d'utilisateurs que possible.  Mais il était toujours intéressant de savoir combien il peut y avoir théoriquement d'utilisateurs et quel type de charge le serveur supportera. <br><br>  Pour ce faire, j'ai fait un test simple: en ligne aux clients d'une certaine pièce (groupe), un message est envoyé avec des paramètres de test (dans les paramètres il n'y a qu'un seul paramètre principal - le nombre de messages), que chaque client enverra à d'autres clients en ligne.  Après la distribution de test, la durée totale de tous les messages, notifications, entrées dans les tables postgresql, le nombre de tous les messages, notifications et entrées sont calculés et, par conséquent, la vitesse est calculée, y compris le total de toutes les opérations sur le serveur. <br><br><img src="https://habrastorage.org/webt/mj/ir/eo/mjireosal4qxzjintjlz4rddhao.png"><br><br>  <i>Exemple de la capture d'écran:</i> <i><br><br></i>  <i>C'est parfois le plus surprenant, seulement 10 000 messages et 390 000 gestes,</i> <i><br></i>  <i>envoi de 50 000 messages: Processus serveur: 4 Utilisateurs: 3</i> <i><br></i>  <i>Total des messages reçus 10 000 * 3 = 30 000</i> <i><br></i>  <i>Transfert vers d'autres processus serveur 30 000 * Processus serveur: 4 - 1 = 90 000</i> <i><br></i>  <i>Envoyé aux destinataires 30000 * Utilisateurs: 3 - 1 = 60000</i> <i><br></i>  <i>Les messages sont écrits dans la table postgreSQL 30 000</i> <i><br></i>  <i>90 000 notifications de livraison reçues</i> <i><br></i>  <i>Enregistré dans le tableau des notifications de livraison postgreSQL 90 000</i> <i><br></i>  <i>Toutes opérations 390 000</i> <br><br><h4>  Logique des données dans push0k admin </h4><br>  A chaque connexion, toutes les données de référence sont obtenues: utilisateurs, salles, appareils, bases de données, ainsi que les 300 dernières entrées du «journal-statistique»: Connexions, Synchronisation des données, Transmission des pièces jointes, Messages, Journal. <br><br>  Les messages répètent pratiquement le tableau postgresql et n'ont pas de filtres, de paramètres et un formulaire où vous pouvez voir le message complètement.  La logique de la table est le débogage, il est possible de voir rapidement pendant le développement si le message a atteint la table ou non. <br><br><img src="https://habrastorage.org/webt/6y/ra/gj/6yragjyt0ycnvzmiy8cvbspfpsc.png"><br><br>  Les tableaux «Utilisateurs», «Salles (groupes)», «Connexions» et «Journal» sont mis à jour automatiquement.  Pour le reste des données, la mise à jour en ligne est inutile. <br><br>  L'application d'administration push0k peut être téléchargée ici: <br><br>  Windows: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">installation de push0kadmin 19.1.11.exe</a> <br>  Mac OS: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">push0kadmin-19.1.11.dmg</a> <br><br>  C'est gratuit, mais contrairement au serveur, je ne prévois pas encore d'ouvrir le code source. <br><br>  Dans le prochain article, je décrirai la partie client du client push0k desctop, ainsi qu'un petit exemple, du code et comment se connecter, se connecter et recevoir des données du serveur. <br><br>  Pour les versions précédentes mentionnées précédemment, il y avait également un client Android, vivant immortellement en arrière-plan sur les 7e et 8e versions d'Android.  Mais pour l'instant, je pense que je n'ai pas pris de retard depuis longtemps.  Plus tard, je pense qu'il y aura un troisième article avec un client Android, et là vous regardez et iOS n'est pas loin. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr438388/">https://habr.com/ru/post/fr438388/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr438376/index.html">Rétro-ingénierie. L'histoire. Le mien</a></li>
<li><a href="../fr438380/index.html">Homme, pause sur les exceptions capturées</a></li>
<li><a href="../fr438382/index.html">Organisation d'une recherche sur une page web en JavaScript (sans jQuery)</a></li>
<li><a href="../fr438384/index.html">Leçon de chimie: comment exposer le cristal d'une puce électronique pour la photographie</a></li>
<li><a href="../fr438386/index.html">En route vers les principes physiques de l'évolution biologique</a></li>
<li><a href="../fr438390/index.html">Pourquoi les développeurs coûtent plus cher que l'argent, comment les économiser et les augmenter</a></li>
<li><a href="../fr438392/index.html">Une brève histoire d'une «bande intelligente»</a></li>
<li><a href="../fr438394/index.html">Yii 2.0.16</a></li>
<li><a href="../fr438396/index.html">Pourquoi vous devriez penser à la programmation fonctionnelle</a></li>
<li><a href="../fr438398/index.html">Lancement de Keras en C ++</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>