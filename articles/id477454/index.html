<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎪 👩🏼 🐔 File konfigurasi. Perpustakaan Libconfig dan definisi pengaturan yang tidak digunakan 🕎 🧙🏼 ⏳</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pendahuluan 


 Aplikasi besar menggunakan konfigurasi untuk mentransfer pengaturan. Dan sering terjadi bahwa pengeditan dan penghapusan fitur mengara...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>File konfigurasi. Perpustakaan Libconfig dan definisi pengaturan yang tidak digunakan</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/477454/"><h3 id="vvedenie">  Pendahuluan </h3><br><p>  Aplikasi besar menggunakan konfigurasi untuk mentransfer pengaturan.  Dan sering terjadi bahwa pengeditan dan penghapusan fitur mengarah ke sinkronisasi antara kode aplikasi dan apa yang disimpan dalam pengaturan yang sama.  Sederhananya, dalam data terakhir yang tidak akan pernah Anda gunakan lagi puas.  Pengaturan seperti itu, idealnya, saya ingin melacak dan menandai sebagai usang, atau sepenuhnya dihapus. </p><br><h3 id="problema">  Masalah </h3><br><p>  Kebetulan sebagian besar konfigurasi di dalam proyek kami ditulis dalam campuran json dan yaml dan diuraikan menggunakan perpustakaan <a href="https://github.com/hyperrealm/libconfig" rel="nofollow">libconfig</a> .  Tidak ada keinginan untuk menulis ulang kode yang sesuai dan konten konfigurasi, misalnya, pada yaml, terutama ketika ada banyak tugas menarik dan lebih kompleks lainnya.  Dan bagian dari pustaka yang ditulis dalam C itu bagus: itu stabil dan kaya fungsionalitas (dalam pembungkus C ++ semuanya tidak begitu sederhana). </p><br><p> Suatu hari, kami berhati-hati untuk mencari tahu berapa banyak sampah yang telah kami kumpulkan dalam file konfigurasi.  Sayangnya, libconfig tidak memiliki opsi seperti itu.  Pertama, kami mencoba fork proyek pada github dan membuat perubahan pada bagian yang ditulis dalam C ++ (semua jenis metode pencarian dan operator), mengotomatiskan proses pengaturan flag yang dikunjungi untuk node.  Tapi ini akan mengarah ke tambalan yang sangat besar, adopsi yang mungkin akan tertunda.  Dan kemudian pilihan jatuh ke arah penulisan pembungkus Anda sendiri di C ++, tanpa mempengaruhi inti libconfig. </p><a name="habracut"></a><br><p>  Dari sudut pandang menggunakan output, kami memiliki yang berikut: </p><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;variti/util/config.hpp&gt; #include &lt;iostream&gt; #include &lt;cassert&gt; int main(int argc, char* argv[]) { using namespace variti; using namespace variti::util; assert(argc = 2); config conf( [](const config_setting&amp; st) { if (!st.visited()) std::cerr &lt;&lt; "config not visited: " &lt;&lt; st.path() &lt;&lt; "\n"; }); conf.load(argv[1]); auto root = conf.root(); root["module"]["name"].to_string(); return 0; }</span></span></span></span></code> </pre> <br><pre> <code class="plaintext hljs">laptop :: work/configpp/example ‹master*› % cat config_example1.conf version = "1.0"; module: { name = "module1"; submodules = ( { name = "submodule1"; }, { name = "submodule2"; } ); }; laptop :: work/configpp/example ‹master*› % ./config-example1 config_example1.conf config not visited: root.module.submodules.0.name config not visited: root.module.submodules.1.name</code> </pre> <br><p>  Dalam kode contoh, kami beralih ke pengaturan module.name.  Module.submodules.0.name pengaturan dan module.submodules.1.name tidak diakses.  Inilah yang dilaporkan kepada kami di log. </p><br><h3 id="obertyvanie">  Bungkus </h3><br><p>  Bagaimana menerapkan ini jika flag yang dikunjungi atau sesuatu seperti itu tidak ada di dalam libconfig?  Pengembang perpustakaan berpikir sebelumnya dan menambahkan kemampuan untuk menghubungkan hook ke simpul config_setting_t, yang diatur menggunakan fungsi config_setting_set_hook dan membaca menggunakan config_setting_get_hook. </p><br><p>  Definisikan kait ini sebagai: </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config_setting_hook</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> visited{<span class="hljs-literal"><span class="hljs-literal">false</span></span>}; };</code> </pre> <br><p>  Ada dua struktur utama di dalam libconfig: config_t dan config_setting_t.  Yang pertama memberikan akses ke seluruh konfigurasi sebagai keseluruhan dan mengembalikan pointer ke simpul root config_setting_t, yang kedua - akses ke simpul induk dan anak, serta nilai di dalam simpul saat ini. </p><br><p>  Kami membungkus kedua struktur di kelas yang sesuai - pegangan. </p><br><p>  Tangani sekitar config_t: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> config_notify = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::function&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> config_setting&amp;)&gt;; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class"> :</span></span> boost::noncopyable { config(config_notify n = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>); ~config(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&amp; filename)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">config_setting </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">root</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; config_notify n; <span class="hljs-keyword"><span class="hljs-keyword">config_t</span></span>* h; };</code> </pre> <br><p>  Perhatikan bahwa suatu fungsi diteruskan ke konstruktor konfigurasi, yang akan dipanggil dalam destruktor pada saat traversal semua node ekstrim.  Cara penggunaannya bisa dilihat pada contoh di atas. </p><br><p>  Tangani config_setting_t: </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config_setting</span></span></span><span class="hljs-class"> :</span></span> boost::noncopyable { config_setting(<span class="hljs-keyword"><span class="hljs-keyword">config_setting_t</span></span>* h, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> visit = <span class="hljs-literal"><span class="hljs-literal">false</span></span>); ~config_setting(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">to_bool</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span> to_int32() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span> to_int64() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">to_double</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">to_string</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_bool</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_int32</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_int64</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_double</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_string</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_group</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_array</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_list</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_scalar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_root</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">path</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exists</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&amp; name)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">config_setting </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">config_setting </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lookup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&amp; name, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> visit = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">false</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">config_setting </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lookup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> indx, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> visit = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">false</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; config_setting <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>[](<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&amp; name) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>; config_setting <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>[](<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> indx) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">filename</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> fileline() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visited</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">config_setting_t</span></span>* h; };</code> </pre> <br><p>  Sihir utama terletak pada metode pencarian.  Diasumsikan bahwa flag node yang dikunjungi diatur melalui argumen terakhir yang disebut kunjungan, yang secara default salah.  Anda memiliki hak untuk menunjukkan nilai ini sendiri.  Tetapi karena akses yang paling sering ke node masih melalui operator [], di dalamnya metode pencarian dipanggil dengan kunjungan sama dengan true.  Dengan demikian, node yang Anda panggil operator [] akan secara otomatis ditandai sebagai dikunjungi.  Selain itu, seperti yang dikunjungi, seluruh rantai node dari arus ke root akan ditandai. </p><br><p>  Mari beralih ke implementasi.  Kami menunjukkannya sepenuhnya untuk kelas konfigurasi: </p><br><pre> <code class="cpp hljs">config::config(config_notify n) : n(n) { h = (<span class="hljs-keyword"><span class="hljs-keyword">config_t</span></span>*)<span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">config_t</span></span>)); config_init(h); config_set_destructor(h, [](<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* p) { <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;config_setting_hook*&gt;(p); }); } config::~config() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n) for_each(root(), n); config_destroy(h); <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(h); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> config::load(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&amp; filename) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!config_read_file(h, filename.c_str())) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::runtime_error(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>(<span class="hljs-string"><span class="hljs-string">"config read file error: "</span></span>) + filename); } config_setting config::root() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> config_setting(config_root_setting(h)); }</code> </pre> <br><p>  Dan sebagian untuk config_setting: </p><br><pre> <code class="cpp hljs">config_setting::config_setting(<span class="hljs-keyword"><span class="hljs-keyword">config_setting_t</span></span>* h, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> visit) : h(h) { assert(h); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!config_setting_get_hook(h)) hook(h, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> config_setting_hook()) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (visit) visit_up(h); } config_setting::~config_setting() { h = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> config_setting::size() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> config_setting_length(h); } config_setting config_setting::parent() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> config_setting(config_setting_parent(h)); } <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> config_setting::exists(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&amp; name) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!is_group()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> config_setting_get_member(h, name.c_str()); } config_setting config_setting::lookup(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&amp; name, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> visit) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { assert(is_group()); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> p = config_setting_get_member(h, name.c_str()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!p) throw_not_found(*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> config_setting(p, visit); } config_setting config_setting::lookup(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> indx, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> visit) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { assert(is_group() || is_array() || is_list()); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> p = config_setting_get_elem(h, indx); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!p) throw_not_found(*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> config_setting(p, visit); } config_setting config_setting::<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>[](<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&amp; name) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lookup(name, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); } config_setting config_setting::<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>[](<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> indx) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lookup(indx, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> config_setting::visited() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> boost::algorithm::starts_with(path(), <span class="hljs-string"><span class="hljs-string">"root"</span></span>) || boost::algorithm::starts_with(path(), <span class="hljs-string"><span class="hljs-string">"root.version"</span></span>) || hook(h)-&gt;visited; }</code> </pre> <br><p>  Kami akan secara terpisah mempertimbangkan pembantu untuk bekerja dengan hook: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hook</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">config_setting_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* h, config_setting_hook* k)</span></span></span><span class="hljs-function"> </span></span>{ config_setting_set_hook(h, k); } <span class="hljs-function"><span class="hljs-function">config_setting_hook* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hook</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">config_setting_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* h)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;config_setting_hook*&gt;(config_setting_get_hook(h)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visit_up</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">config_setting_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* h)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (; !config_setting_is_root(h) &amp;&amp; !hook(h)-&gt;visited; h = config_setting_parent(h)) hook(h)-&gt;visited = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre> <br><p>  Dan penolong untuk memotong simpul ekstrem: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> F&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for_each</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> config_setting&amp; st, F f)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (st.size()) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; st.size(); ++i) for_each(st.lookup(i), f); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> f(st); }</code> </pre> <br><h3 id="vyvod">  Kesimpulan </h3><br><p>  Ternyata kode itu indah dan lebih fleksibel.  Tapi kami tidak meninggalkan ide untuk membuat perubahan yang mirip dengan libconfig library asli, atau lebih tepatnya, antarmuka yang ditulis dalam C ++.  Permintaan penarikan sedang dipersiapkan sekarang, tetapi kami sudah bekerja dan kami sedang membersihkan konfigurasi kami dari pengaturan yang tidak digunakan. </p><br><h3 id="prilozhenie">  Aplikasi </h3><br><p>  Lihat kode sumber di <a href="https://github.com/sonntex/configpp" rel="nofollow">sini</a> ! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id477454/">https://habr.com/ru/post/id477454/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id477440/index.html">Flipper Zero - tomagotchi patsan multitool untuk pentester</a></li>
<li><a href="../id477442/index.html">56 proyek Python open source</a></li>
<li><a href="../id477448/index.html">Teori Pemrograman: Varian</a></li>
<li><a href="../id477450/index.html">9 pendekatan untuk mendeteksi anomali</a></li>
<li><a href="../id477452/index.html">Kejuaraan pemrograman kedua: kami menganalisis tugas-tugas ML-track</a></li>
<li><a href="../id477458/index.html">Pro dan Kontra Kehidupan IT di Skotlandia</a></li>
<li><a href="../id477460/index.html">Edisi # 26: Pelatihan TI - masalah saat ini dan tantangan dari perusahaan terkemuka</a></li>
<li><a href="../id477464/index.html">Bagaimana saya meluncurkan Docker di dalam Docker dan apa yang terjadi</a></li>
<li><a href="../id477468/index.html">Gambaran umum dari imager termal Seek Thermal SHOT: inspeksi termal dari tempat tinggal</a></li>
<li><a href="../id477470/index.html">Tentang peran tugas pengujian dalam kehidupan pengembang</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>