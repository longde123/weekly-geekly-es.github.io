<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘©ğŸ¿â€ğŸ¤â€ğŸ‘¨ğŸ» ğŸ‚ğŸ» ğŸ‘ˆ Solution open source pour dÃ©cupler la latence de lecture des donnÃ©es avec Apache Cassandra ğŸŒ  ğŸª ğŸ˜–</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Instagram possÃ¨de l'une des plus grandes bases de donnÃ©es Apache Cassandra au monde. Le projet a commencÃ© Ã  utiliser Cassandra en 2012 pour remplacer ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Solution open source pour dÃ©cupler la latence de lecture des donnÃ©es avec Apache Cassandra</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/wirex/blog/410985/"><img src="https://habrastorage.org/webt/8h/qz/qy/8hqzqyfytcsvjn_xc9y5uj9j7ns.jpeg"><br><br>  Instagram possÃ¨de l'une des plus grandes bases de donnÃ©es Apache Cassandra au monde.  Le projet a commencÃ© Ã  utiliser Cassandra en 2012 pour remplacer Redis et soutenir la mise en Å“uvre de fonctionnalitÃ©s d'application telles qu'un systÃ¨me de reconnaissance des fraudes, Tape et Direct.  Au dÃ©but, les clusters Cassandra fonctionnaient dans AWS, mais les ingÃ©nieurs les ont ensuite migrÃ©s vers l'infrastructure Facebook avec tous les autres systÃ¨mes Instagram.  Cassandra a trÃ¨s bien performÃ© en termes de fiabilitÃ© et de tolÃ©rance aux pannes.  Dans le mÃªme temps, les mesures de latence lors de la lecture des donnÃ©es pourraient clairement Ãªtre amÃ©liorÃ©es. <br><br>  L'annÃ©e derniÃ¨re, l'Ã©quipe d'assistance Instagram de Cassandra a commencÃ© Ã  travailler sur un projet visant Ã  rÃ©duire considÃ©rablement la latence dans la lecture des donnÃ©es Ã  Cassandra, que les ingÃ©nieurs ont appelÃ© Rocksandra.  Dans cet article, l'auteur explique ce qui a poussÃ© l'Ã©quipe Ã  mettre en Å“uvre ce projet, les difficultÃ©s qui ont dÃ» Ãªtre surmontÃ©es et les mesures de performances que les ingÃ©nieurs utilisent Ã  la fois dans les environnements cloud internes et externes. <br><br><h3>  Motifs de transition </h3><br>  Instagram utilise activement et largement Apache Cassandra comme service de stockage de valeurs-clÃ©s.  La plupart des demandes Instagram se produisent en ligne, par consÃ©quent, pour fournir une expÃ©rience utilisateur fiable et agrÃ©able Ã  des centaines de millions d'utilisateurs Instagram, les SLA sont trÃ¨s exigeants sur les performances du systÃ¨me. <a name="habracut"></a><br><br>  Instagram adhÃ¨re Ã  une cote de fiabilitÃ© de cinq Ã  neuf.  Cela signifie que le nombre de pannes Ã  un moment donnÃ© ne peut pas dÃ©passer 0,001%.  Afin d'amÃ©liorer les performances, les ingÃ©nieurs surveillent activement la bande passante et les latences des diffÃ©rents clusters Cassandra et s'assurent que 99% de toutes les demandes s'inscrivent dans un certain indicateur (dÃ©lai P99). <br><br>  Ci-dessous est un graphique montrant le dÃ©lai cÃ´tÃ© client d'un pour l'un des clusters de combat Cassandra.  Le bleu indique la vitesse de lecture moyenne (5 ms) et l'orange indique la vitesse de lecture Ã  99%, allant de 25 Ã  60 ms.  Ses modifications dÃ©pendent fortement du trafic client. <br><br> <a href=""><img src="https://habrastorage.org/webt/hh/w0/qq/hhw0qq_z9ce4zqkys5m8irabeja.png"></a> <br><br> <a href=""><img src="https://habrastorage.org/webt/h3/bs/oz/h3bsoz7oxelnn-sm9xse1wcn4u4.png"></a> <br><br>  L'Ã©tude a rÃ©vÃ©lÃ© que les brusques rafales de retard sont en grande partie dues au travail du ramasse-miettes JVM.  Les ingÃ©nieurs ont introduit une mÃ©trique appelÃ©e Â«pourcentage d'arrÃªts du CMÂ» pour mesurer le pourcentage de temps consacrÃ© Ã  Â«arrÃªter le mondeÂ» par le serveur Cassandra, et s'est accompagnÃ©e d'un refus des demandes des clients.  Voici le tableau ci-dessus montrant le temps (en pourcentage) qui est allÃ© aux arrÃªts SM en utilisant l'exemple de l'un des serveurs de combat Cassandra.  L'indicateur variait de 1,25% en pÃ©riode de moindre trafic Ã  2,5% en pÃ©riode de pointe. <br><br>  Le graphique montre que cette instance de serveur Cassandra pourrait passer 2,5% de son temps Ã  collecter des ordures au lieu de traiter les demandes des clients.  Les opÃ©rations prÃ©ventives du collecteur ont Ã©videmment eu un impact significatif sur le retard P99, et il est donc devenu clair que si nous pouvions rÃ©duire le taux d'arrÃªt CM, les ingÃ©nieurs pourraient rÃ©duire considÃ©rablement le taux de retard P99. <br><br><h3>  Solution </h3><br>  Apache Cassandra est une base de donnÃ©es distribuÃ©e basÃ©e sur Java avec son propre moteur de stockage de donnÃ©es basÃ© sur des arbres LSM.  Les ingÃ©nieurs ont constatÃ© que des composants de moteur tels qu'une table mÃ©moire, un outil de compression, des chemins de lecture / Ã©criture et certains autres crÃ©aient de nombreux objets dans la mÃ©moire dynamique Java, ce qui obligeait la JVM Ã  effectuer de nombreuses opÃ©rations supplÃ©mentaires.  Pour rÃ©duire l'impact des mÃ©canismes de stockage sur le travail du ramasse-miettes, l'Ã©quipe de support a envisagÃ© diffÃ©rentes approches et a finalement dÃ©cidÃ© de dÃ©velopper un moteur C ++ et de remplacer celui existant par celui-ci. <br><br>  Les ingÃ©nieurs ne voulaient pas tout faire Ã  partir de zÃ©ro et ont donc dÃ©cidÃ© de prendre RocksDB comme base. <br><br>  RocksDB est une base de donnÃ©es intÃ©grÃ©e open source hautes performances pour le stockage de valeurs-clÃ©s.  Il est Ã©crit en C ++, et son API possÃ¨de des liaisons de langage officiel pour C ++, C et Java.  RocksDB est optimisÃ© pour des performances Ã©levÃ©es, en particulier sur les disques rapides tels que les SSD.  Il est largement utilisÃ© dans l'industrie comme moteur de stockage pour MySQL, mongoDB et d'autres bases de donnÃ©es populaires. <br><br><h3>  Des difficultÃ©s </h3><br>  Lors de la mise en Å“uvre du nouveau moteur de stockage sur RocksDB, les ingÃ©nieurs ont dÃ» faire face Ã  trois tÃ¢ches difficiles et les ont rÃ©solues. <br><br>  La premiÃ¨re difficultÃ© Ã©tait que Cassandra n'avait toujours pas d'architecture permettant de connecter des processeurs de donnÃ©es tiers.  Cela signifie que le travail du moteur existant est assez Ã©troitement interconnectÃ© avec d'autres composants de la base de donnÃ©es.  Pour trouver un Ã©quilibre entre le refactoring Ã  grande Ã©chelle et les itÃ©rations rapides, les ingÃ©nieurs ont dÃ©fini l'API du nouveau moteur, y compris les interfaces de lecture, d'Ã©criture et de flux les plus courantes.  Ainsi, l'Ã©quipe d'assistance a pu mettre en Å“uvre de nouveaux mÃ©canismes de traitement des donnÃ©es pour l'API et les insÃ©rer dans les chemins d'exÃ©cution de code appropriÃ©s Ã  l'intÃ©rieur de Cassandra. <br><br>  La deuxiÃ¨me difficultÃ© Ã©tait que Cassandra supportait les types de donnÃ©es structurÃ©es et les schÃ©mas de table, tandis que RocksDB ne fournissait que des interfaces clÃ©-valeur.  Les ingÃ©nieurs ont soigneusement dÃ©fini des algorithmes de codage et de dÃ©codage pour prendre en charge le modÃ¨le de donnÃ©es Cassandra au sein des structures de donnÃ©es RocksDB et ont assurÃ© la continuitÃ© de la sÃ©mantique des requÃªtes similaires entre les deux bases de donnÃ©es. <br><br>  La troisiÃ¨me difficultÃ© Ã©tait liÃ©e Ã  un composant aussi important pour tout composant de base de donnÃ©es distribuÃ©e que le travail avec les flux de donnÃ©es.  Chaque fois qu'un nÅ“ud est ajoutÃ© ou supprimÃ© d'un cluster Cassandra, il doit rÃ©partir correctement les donnÃ©es entre les diffÃ©rents nÅ“uds pour Ã©quilibrer la charge au sein du cluster.  Les implÃ©mentations existantes de ces mÃ©canismes Ã©taient basÃ©es sur l'obtention de donnÃ©es dÃ©taillÃ©es Ã  partir du moteur de base de donnÃ©es existant.  Par consÃ©quent, les ingÃ©nieurs ont dÃ» les sÃ©parer les uns des autres, crÃ©er une couche d'abstraction et implÃ©menter une nouvelle option pour le traitement des flux Ã  l'aide de l'API RocksDB.  Pour obtenir un dÃ©bit Ã©levÃ© de flux, l'Ã©quipe de support distribue maintenant d'abord les donnÃ©es dans des fichiers sst temporaires, puis utilise l'API spÃ©ciale RocksDB pour Â«avalerÂ» les fichiers, ce qui leur permet d'Ãªtre chargÃ©s simultanÃ©ment dans l'instance RocksDB. <br><br><h3>  Indicateurs de performance </h3><br>  AprÃ¨s prÃ¨s d'un an de dÃ©veloppement et de tests, les ingÃ©nieurs ont achevÃ© la premiÃ¨re version de l'implÃ©mentation et l'ont Â«dÃ©ployÃ©eÂ» avec succÃ¨s sur plusieurs clusters Instagram Instagram Cassandra.  Sur l'un des clusters de combat, le dÃ©lai P99 est passÃ© de 60 ms Ã  20 ms.  Les observations ont Ã©galement montrÃ© que les arrÃªts SM dans ce cluster sont passÃ©s de 2,5% Ã  0,3%, soit prÃ¨s de 10 fois! <br><br>  Les ingÃ©nieurs souhaitaient Ã©galement vÃ©rifier si Rocksandra pouvait bien fonctionner dans un environnement de cloud public.  L'Ã©quipe de support a configurÃ© un cluster Cassandra dans AWS Ã  l'aide de trois instances i3.8 xlarge EC2, chacune avec un processeur 32 cÅ“urs, 244 Go de RAM et un raid zÃ©ro de quatre lecteurs flash NVMe. <br><br>  Pour les tests comparatifs, nous avons utilisÃ© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NDBench</a> et le schÃ©ma de table par dÃ©faut pour le framework. <br><br><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> emp ( emp_uname <span class="hljs-type"><span class="hljs-type">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PRIMARY KEY</span></span>, emp_dept <span class="hljs-type"><span class="hljs-type">text</span></span>, emp_first <span class="hljs-type"><span class="hljs-type">text</span></span>, emp_last <span class="hljs-type"><span class="hljs-type">text</span></span> )</code> </pre> <br>  Les ingÃ©nieurs ont prÃ©chargÃ© 250 millions de 6 lignes de 6 Ko chacune (environ 500 Go de donnÃ©es sont stockÃ©es sur chaque serveur).  Ensuite, configurez 128 lecteurs et Ã©crivains dans NDBench. <br><br>  L'Ã©quipe de support a testÃ© diverses charges et mesurÃ© les latences moyennes de lecture et d'Ã©criture / P99 / P999.  Les graphiques ci-dessous montrent que Rocksandra a montrÃ© des latences de lecture et d'Ã©criture nettement plus faibles et plus stables. <br><br><img src="https://habrastorage.org/webt/sc/7j/im/sc7jim4homfpkase00fbjixjhyq.png"><br><br><img src="https://habrastorage.org/webt/z1/ol/pw/z1olpwd4z6q-bp-kihfcf58j9bo.png"><br><br>  Les ingÃ©nieurs ont Ã©galement vÃ©rifiÃ© la charge en mode lecture sans Ã©criture et ont constatÃ© qu'avec le mÃªme dÃ©lai de lecture P99 (2 ms), Rocksandra est capable de multiplier par 10 la vitesse de lecture des informations (300 K / s pour Rocksandra contre 30 K / s pour C * 3.0). <br><br><img src="https://habrastorage.org/webt/jn/sy/fu/jnsyfumtlax15y1p0tkkalrc_f4.png"><br><br><img src="https://habrastorage.org/webt/iv/js/fs/ivjsfsiexo3bzmuklo_ughr0tju.png"><br><br><h3>  Plans futurs </h3><br>  L'Ã©quipe d'assistance Instagram a ouvert le code et le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cadre</a> <a href="">Rocksandra</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pour Ã©valuer les performances</a> .  Vous pouvez les tÃ©lÃ©charger depuis Github et essayer dans votre propre environnement.  Assurez-vous de nous dire ce qui en est arrivÃ©! <br><br>  Dans une prochaine Ã©tape, l'Ã©quipe travaille activement Ã  l'ajout d'une prise en charge plus large des fonctionnalitÃ©s C *, telles que les index secondaires, les correctifs, etc.  De plus, les ingÃ©nieurs dÃ©veloppent l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">architecture du moteur de base de donnÃ©es plug-in en C *</a> afin de transfÃ©rer ces dÃ©veloppements Ã  la communautÃ© Apache Cassandra. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/files/4bd/bf6/597/4bdbf659775744b1bdbb4d8a00a0a980.png" alt="image"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr410985/">https://habr.com/ru/post/fr410985/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr410969/index.html">5 technologies pour les cinq prochaines annÃ©es: prÃ©visions d'IBM</a></li>
<li><a href="../fr410973/index.html">Quels drones sont utilisÃ©s dans le cinÃ©ma mondial</a></li>
<li><a href="../fr410977/index.html">Une tentative de crÃ©er un pÃ©riphÃ©rique d'entrÃ©e d'informations universel</a></li>
<li><a href="../fr410979/index.html">Â«PiraterÂ» le cerveau en utilisant des Â«images-contradictionsÂ»</a></li>
<li><a href="../fr410981/index.html">Yandex a ajoutÃ© une protection contre les mineurs cryptographiques Ã  son navigateur</a></li>
<li><a href="../fr410987/index.html">GLONASS sera rendu aussi prÃ©cis que le systÃ¨me de navigation GPS</a></li>
<li><a href="../fr410989/index.html">PrÃ©dÃ©cesseurs des bracelets de fitness: podomÃ¨tre, moniteur de frÃ©quence cardiaque, ordinateur de vÃ©lo</a></li>
<li><a href="../fr410991/index.html">Portefeuille matÃ©riel de crypto-monnaie Ledger piratÃ© par un pirate de 15 ans</a></li>
<li><a href="../fr410993/index.html">Quelqu'un envoie des jouets sexuels d'Amazon Ã  des Ã©trangers. Amazon ne sait pas comment les arrÃªter</a></li>
<li><a href="../fr410995/index.html">Un tÃ©lÃ©gramme dÃ©nonce la Russie devant la Cour europÃ©enne des droits de l'homme</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>