<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚶🏻 🍧 🚲 Adaptor PPM-ke-USB pada STM32F3Discovery, atau Kami menghubungkan konsol model pesawat ke komputer sebagai joystick HID dengan STM32Cube 🌜 🍻 😃</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pada artikel ini saya akan memberi tahu Anda caranya:
 

- Buat proyek di STM32CubeMX dan atur timer untuk menangkap sinyal eksternal. 
- Dekode sinya...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Adaptor PPM-ke-USB pada STM32F3Discovery, atau Kami menghubungkan konsol model pesawat ke komputer sebagai joystick HID dengan STM32Cube</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/384813/"><img src="https://habrastorage.org/files/42a/e17/45b/42ae1745bcc442529f2839504fdf51f4.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada artikel ini saya akan memberi tahu Anda caranya:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Buat proyek di STM32CubeMX dan atur timer untuk menangkap sinyal eksternal. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dekode sinyal PPM dari konsol model pesawat. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Buat Perangkat Antarmuka Manusia di STM32 dan tulis deskriptor Laporan HID Anda. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terbang di simulator di quadrocopter balap. </font><font style="vertical-align: inherit;">:)</font></font></li>
</ul><a name="habracut"></a><br>
<h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kata pengantar</font></font></b></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Baru-baru ini, balapan FPV pada quadrocopters kelas 250 (FPV - First Person View) semakin populer. </font><font style="vertical-align: inherit;">Angka 250 berarti jarak antara sumbu motor secara diagonal, tipikal dari helikopter kecil yang dapat bermanuver. </font><font style="vertical-align: inherit;">Perangkat semacam itu dibangun di atas kerangka karbon tahan lama yang tahan jatuh dan tabrakan. </font><font style="vertical-align: inherit;">Baling-baling dengan diameter 5-6 inci dengan langkah besar (sudut kemiringan bilah) ditempatkan pada motor yang kuat untuk penerbangan paling dinamis. </font><font style="vertical-align: inherit;">Gambar dari camcorder pos analog ditransmisikan pada frekuensi 5,8 GHz ke monitor atau kacamata video pilot. </font><font style="vertical-align: inherit;">Karena transmisi digital melalui WiFi menciptakan penundaan lama (200-300 ms), video selalu disiarkan pada saluran analog. </font><font style="vertical-align: inherit;">Untuk merekam klip spektakuler, kamera aksi diletakkan di papan tulis (GoPro, Mobius, SJcam, Xiaomi Yi, dll.).</font></font><br>
<br>
<div style="text-align:center;"><img width="40%" src="https://habrastorage.org/files/727/722/0e5/7277220e5a8c4b749415d16d28091648.jpg"></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Berikut ini beberapa video menarik tentang copters FPV:</font></font></b><div class="spoiler_text"><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://www.youtube.com/embed/NsxyV-kgfio%3Ffeature%3Doembed&amp;usg=ALkJrhhtk2oMobZO---JA6E59p1YbtQZvw" frameborder="0" allowfullscreen=""></iframe><br>
<iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://www.youtube.com/embed/1MBW8zoZUR4%3Ffeature%3Doembed&amp;usg=ALkJrhjEV6J-00bP8RQdjWNI12NFn_UyvA" frameborder="0" allowfullscreen=""></iframe><br>
<iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://www.youtube.com/embed/70pusNNunMA%3Ffeature%3Doembed&amp;usg=ALkJrhjklJJ2UIr7Sp0TwKIrgAVziHcwlw" frameborder="0" allowfullscreen=""></iframe></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebelum membangun mini quadrocopter saya, saya ingin terbang dengan simulator dan melihat apakah saya tertarik dengan balapan FPV. Untuk pelatihan, simulator </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FPV FreeRider</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sangat cocok </font><font style="vertical-align: inherit;">. Itu tidak mahal, memiliki versi demo gratis dan, menurut pilot berpengalaman, sangat akurat meniru mekanisme penerbangan yang sebenarnya.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anda dapat mengontrol pesawat di simulator dari keyboard atau dari joystick. Keyboard tidak cocok untuk uji coba, karena tombol hanya dapat mengirimkan nilai diskrit (tombol ditekan / tidak ditekan) dan tidak mungkin untuk mentransmisikan nilai tengah yang bervariasi secara halus. Joystick dari konsol game dengan stik analog jauh lebih baik, tetapi mereka memiliki stik yang sangat kecil, yang tidak memungkinkan Anda untuk mengontrol perangkat dengan cukup akurat. Pilihan ideal untuk simulator adalah konsol model pesawat yang terhubung ke komputer melalui adaptor khusus, berkat sistem operasi yang melihatnya sebagai joystick.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya sudah punya satu quadrocopter, dirakit untuk penerbangan santai dan fotografi, tetapi terlalu besar dan berat untuk balapan. Oleh karena itu, ada remote control - Turnigy 9X (dalam ilustrasi pertama). Di sisi belakang, ia memiliki konektor untuk menghubungkan adaptor yang menghasilkan sinyal PPM. Sinyal ini adalah pulsa pendek dengan interval dari 1 hingga 2 milidetik, durasi yang sesuai dengan posisi kontrol (lebih lanjut tentang hal itu di bagian decoding).</font></font><br>
<br>
<div style="text-align:center;"><img width="33%" src="https://habrastorage.org/files/68b/cc1/4f0/68bcc14f02164d51a17401da82253df4.jpg"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya harus mengatakan bahwa adaptor untuk menghubungkan remote control dari PPM ke USB telah lama dirilis dan dijual dengan sekuat tenaga dan utama. </font><font style="vertical-align: inherit;">Adaptor serupa di faktor bentuk flash drive dapat dibeli seharga $ 5 di Cina atau sedikit lebih mahal di toko-toko Rusia. </font><font style="vertical-align: inherit;">Ada juga </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">proyek</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adaptor </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">sumber terbuka</font></a><font style="vertical-align: inherit;"> pada pengontrol AVR. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi keinginan yang kuat untuk terbang segera datang kepada saya pada larut malam, ketika semua toko model pesawat Moskow sudah tutup. </font><font style="vertical-align: inherit;">Saya tidak ingin menunggu di pagi hari, tidak ada waktu untuk meracuni dan menyolder papan dengan ATmega, jadi saya memutuskan untuk membuat adaptor PPM-USB pada papan STM32F3Discovery, yang sudah lama menganggur dan sudah dekat.</font></font><br>
<br>
<h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apa yang dibutuhkan</font></font></b></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk membuat adaptor, Anda perlu:</font></font><br>
<br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">STM32F3Discovery</a>.     STM32,     USB,   . </li>
<li>  c - 3,5     ( Turnigy)   BLS-,   ,   ( Discovery).</li>
<li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">STM32CubeMX</a>. </li>
<li>IDE    ARM.   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Keil uVision 5</a>.          32 ,      .</li>
<li> Turnigy 9X     PPM-.       FlySky FS-i6.</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Papan debug penemuan cukup mahal. </font><font style="vertical-align: inherit;">Biaya F3 yang dijelaskan sekitar $ 20 dan kemampuannya berlebihan untuk proyek sederhana. </font><font style="vertical-align: inherit;">Saya menggunakannya karena pada saat penulisan ini adalah satu-satunya papan dengan perangkat keras USB yang saya temukan di rumah. </font><font style="vertical-align: inherit;">Bagi yang belum membelinya, saya dapat menyarankan Anda untuk memperhatikan papan miniatur dengan controller </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STM32F103C8T6 dari AliExpress seharga $ 3</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan programmer ST-Link dari sana. </font><font style="vertical-align: inherit;">Prosesnya tidak berbeda dari yang dijelaskan dalam artikel. </font><font style="vertical-align: inherit;">Kecuali jika perlu memilih pengontrol lain di awal, tunjukkan keberadaan resonator kuarsa dan gunakan pinout yang sedikit berbeda.</font></font><br>
<br>
<div style="text-align:center;"><img width="30%" src="https://habrastorage.org/files/cf1/88d/0a1/cf188d0a1da94acfb233350ff94830ae.jpg"></div><br>
<br>
<a name="cube"></a><h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Membuat proyek di STM32CubeMX</font></font></b></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
STM32Cube adalah paket yang dikembangkan oleh STMicroelectronics untuk mempermudah hidup para pengembang perangkat STM32. Ini terdiri dari utilitas grafis CubeMX, driver HAL, dan komponen Middleware. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CubeMX</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah alat untuk membuat proyek dan menginisialisasi peripheral. Untuk memulai, cukup pilih controller, centang kotak untuk modul yang diperlukan, pilih mode yang diperlukan dalam menu dan masukkan nilai yang diinginkan di beberapa bidang. CubeMX akan menghasilkan proyek dan menghubungkan pustaka yang diperlukan untuk itu. Pengembang perangkat hanya akan menulis logika aplikasi. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Driver HAL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Hardware Abstraction Layer) adalah API untuk bekerja dengan modul dan periferal mikrokontroler. HAL memungkinkan Anda untuk memisahkan lapisan atas aplikasi yang dibuat pengembang dari bekerja dengan register dan membuat kode program semudah mungkin antara keluarga pengontrol STM32. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Middlewares</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , atau komponen perantara, termasuk sistem operasi FreeRTOS, perpustakaan untuk bekerja dengan sistem file, perpustakaan USB, TCP / IP, dll.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tampaknya sekarang mungkin untuk "memprogram dengan mouse" daripada secara manual menulis bit ke register. </font><font style="vertical-align: inherit;">Tetapi kesederhanaan dan kemudahan tidak membatalkan fakta bahwa Anda perlu mempelajari dokumentasi, terutama dalam kasus di mana Anda perlu menekan kecepatan maksimum, konsumsi daya minimum atau menggunakan periferal dalam mode non-standar. </font><font style="vertical-align: inherit;">STM32Cube belum mencakup 100% dari semua kemampuan mikrokontroler, tetapi sedang mendekati ini. </font><font style="vertical-align: inherit;">STMicroelectronics memperbarui Cube dari waktu ke waktu, memperluas fungsi, dan memperbaiki bug. </font><font style="vertical-align: inherit;">Oleh karena itu, jika Anda sudah menginstal Cube, periksa apakah itu versi terbaru.</font></font><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengaturan awal</font></font></b></h5><br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/acf/6b2/4fc/acf6b24fc6c449f58c2be3b9ce9d1c1e.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bekerja dengan proyek dimulai dengan pilihan pengontrol. Luncurkan STM32CubeMX, klik </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Proyek Baru</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Pada tab </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCU Selector</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">Anda dapat memilih pengontrol yang diinginkan dari filter. Karena kami memiliki papan debug yang sudah selesai, pada tab </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selektor Papan</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , kami menemukan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STM32F3Demangat</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Setelah memilih papan, gambar controller dengan pin yang disorot dan ditandatangani akan muncul. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada empat tab besar di bagian atas jendela: </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pinout</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - untuk mengkonfigurasi fungsi pin dan mengatur modul. Kami ada di sana saat ini. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurasi Jam</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - pengaturan jam, PLL, pembagi. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurasi</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - konfigurasi periferal dan middleware yang lebih rinci.</font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kalkulator Konsumsi Daya</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - perhitungan daya yang dikonsumsi oleh mikrokontroler. </font></font><br>
<br>
<img src="https://habrastorage.org/files/d02/a54/3a7/d02a543a7fe148d99d67ae83ad6a8fc9.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di menu sebelah kiri pada tab </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pinout</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><i><font style="vertical-align: inherit;">Anda</font></i><font style="vertical-align: inherit;"> dapat menggunakan periferal yang diinginkan, dan pada sirkuit pengontrol pilih fungsi untuk salah satu output mikrokontroler. Beberapa item di sebelah kiri adalah ikon peringatan. Ini berarti bahwa modul-modul (dalam hal ini ADC, DAC, OPAMP2, RTC) sekarang dapat digunakan secara tidak lengkap, karena beberapa outputnya sudah ditempati oleh fungsi-fungsi lain.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pin yang dikonfigurasikan ditandai dengan warna hijau pada sirkuit pengontrol. </font><font style="vertical-align: inherit;">Karena kami memilih bukan pengontrol telanjang tanpa pengikat, tetapi papan debugging F3-Discovery yang sudah jadi, beberapa output sudah dikonfigurasikan, misalnya, tombol biru terhubung ke PA0, dan LED ke PE8 ... 15. </font><font style="vertical-align: inherit;">Pin yang terhubung dengan beberapa perangkat eksternal pada Discovery disorot dalam warna oranye, tetapi modul periferal untuknya belum dikonfigurasikan. </font><font style="vertical-align: inherit;">Seperti yang Anda lihat, ini adalah pin untuk USB, resonator kuarsa, SPI dan I2C untuk giroskop dan kompas, DP dan DM untuk USB. </font><font style="vertical-align: inherit;">Kesimpulan abu-abu saat ini tidak digunakan, salah satunya dapat kami ajukan untuk tujuan kami.</font></font><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seleksi input</font></font></b></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami akan menangkap durasi pulsa, jadi input harus terhubung ke salah satu saluran timer. </font><font style="vertical-align: inherit;">Selain itu, level sinyal dengan Turnigy 9X tidak 3.3V, seperti tegangan suplai dari STM32, tetapi 5V. </font><font style="vertical-align: inherit;">Kami terlalu malas untuk menyolder pembagi tegangan, jadi Anda harus memilih input yang dapat menahan 5V (input ini disebut toleran 5V). </font><font style="vertical-align: inherit;">Pin yang cocok dapat ditemukan di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lembar data</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pada STM32F303VCT6 di bagian Pinouts </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan Pin Description</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ada banyak timer di STM32F3, mereka tersebar di hampir semua pin. </font><font style="vertical-align: inherit;">Opsi yang mudah adalah PC6. </font><font style="vertical-align: inherit;">Itu dapat menahan 5 volt dan terletak di sudut kiri bawah papan, di sebelah GND. </font><font style="vertical-align: inherit;">Tetapkan saluran 1 dari timer 3 TIM3_CH1 ke pin ini.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/eb7/4b2/67e/eb74b267e70140b9842408158de617e8.png"></div><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengaturan jam</font></font></b></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agar USB berfungsi, mikrokontroler harus clock pada frekuensi yang sangat stabil, itulah sebabnya hampir semua perangkat USB memiliki resonator kuarsa. Stabilitas frekuensi generator RC internal tidak cukup untuk USB. Tetapi pada papan Discovery STM32F3, pengembang untuk beberapa alasan serakah dan tidak menaruh kuarsa. Namun, jika Anda mempelajari </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sirkuit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dengan cermat </font><font style="vertical-align: inherit;">, Anda dapat melihat bahwa </font><font style="vertical-align: inherit;">sinyal </font><i><font style="vertical-align: inherit;">MCO</font></i><font style="vertical-align: inherit;"> terhubung </font><font style="vertical-align: inherit;">ke input </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PF0-OSC_IN</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , di mana kuarsa harus terhubung </font><font style="vertical-align: inherit;">. Itu berasal dari programmer ST-Link di papan yang sama di mana ada kuarsa. The </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">User Manual</font></a><font style="vertical-align: inherit;"> untuk F3 Discovery (UM1570) di </font><i><font style="vertical-align: inherit;">OSC Jam</font></i><font style="vertical-align: inherit;"> bagian </font><font style="vertical-align: inherit;">mengatakan bahwa 8 MHz sedang </font><font style="vertical-align: inherit;">dikirim </font><font style="vertical-align: inherit;">ke baris ini.</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br>
<img width="30%" src="https://habrastorage.org/files/b5c/234/80f/b5c23480ffca498d8e52e6fef4c0892f.png"><img width="65%" src="https://habrastorage.org/files/c00/160/fb8/c00160fb809b4c7190390d8a8ccd3ac6.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dengan demikian, mikrokontroler clock dari sumber eksternal. Mode ini disebut Bypass. Di menu pengaturan periferal di bagian </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RCC</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">untuk mencatat </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clock Kecepatan Tinggi,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pilih </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BYPASS Clock Source</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/files/934/7e5/17e/9347e517e21540a88c922d35d881c009.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebelum melanjutkan ke pengaturan jam yang lebih rinci, kami perhatikan di menu perangkat bahwa mikrokontroler akan bertindak sebagai perangkat USB. </font></font><br>
<br>
<img src="https://habrastorage.org/files/597/c20/ddb/597c20ddbe2e4c2898c90db97110e454.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang Anda dapat pergi ke tab besar berikutnya - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurasi Jam</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Di sini kita akan melihat diagram besar, yang menunjukkan sinyal jam apa yang ada dalam mikrokontroler, dari mana asalnya, bagaimana mereka bercabang, berkembang biak dan membelah. Dalam warna kuning, saya menyoroti parameter-parameter yang harus dicatat. </font></font><br>
<br>
<img src="https://habrastorage.org/files/1a5/9a8/596/1a59a8596d434c1f8d09ee5e8335adee.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Periksa apakah frekuensi input</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Frekuensi Input</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah 8 MHz. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami mengatur saklar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PLL Sumber Mux</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ke </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HSE</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (High Speed ​​External) untuk clock dari sumber eksternal daripada sumber internal. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PLL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Phase Lock Loop, atau PLL - loop-terkunci, berfungsi untuk melipatgandakan frekuensi eksternal beberapa kali. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atur</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pengganda </font><i><font style="vertical-align: inherit;">PLLMul</font></i><font style="vertical-align: inherit;"> ke 9. Kemudian kita akan mencapai frekuensi maksimum yang mungkin untuk STM32F303 - 72 MHz. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System Clock Mux</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> harus dalam posisi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PLLCLK sehingga</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> frekuensi jam dikalikan dengan PLL. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk modul USB, 48 MHz diperlukan, jadi letakkan pembagi 1,5 di depan USB. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perhatikan frekuensinya</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jam pengatur waktu APB1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> di sisi kiri sirkuit. </font><font style="vertical-align: inherit;">Itu pergi ke timer dan berguna bagi kita di masa depan. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika ada frekuensi yang salah dikonfigurasi, melebihi nilai maksimum yang mungkin atau sakelar berada di posisi yang tidak valid, maka CubeMX akan menyorot tempat ini dengan warna merah.</font></font><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengaturan pengatur waktu</font></font></b></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk mengukur durasi pulsa, kami akan memulai penghitung waktu TIM3 dalam mode Pengambilan Input. Dalam </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manual Referensi</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , di bawah bagian </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Timers tujuan umum (TIM2 / TIM3 / TIM4),</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ada diagram yang menggambarkan operasi timer. Dengan warna, saya menyoroti sinyal dan register yang digunakan dalam mode Capture Input. </font></font><br>
<br>
<img src="https://habrastorage.org/files/e76/54c/ea5/e7654cea52cb46c891e5a73e91068b71.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sinyal jam yang disorot dengan warna hijau terus-menerus memasuki register penghitung CNT dan menambah nilainya sebesar 1 setiap siklus jam. Dalam pembagi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prescaler PSC</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">frekuensi clock dapat menurun untuk jumlah yang lebih lambat. </font><font style="vertical-align: inherit;">Sinyal eksternal </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dimasukkan ke </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TIMx_CH1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Detektor tepi</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">itu mengenali tepi sinyal input - transisi dari 0 ke 1 atau dari 1 ke 0. Saat mendaftarkan tepi, ia mengirimkan dua perintah yang disorot dengan warna kuning: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- perintah untuk menulis nilai penghitung </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CNT</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ke daftar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Capture / compare 1 register (CCR1)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">panggilan</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> interupsi </font><i><font style="vertical-align: inherit;">CC1I</font></i><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- perintah untuk </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pengontrol mode Slave</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dimana nilai </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CNT</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> diatur ulang ke 0 dan hitung mundur dimulai lagi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Berikut ini adalah ilustrasi proses dalam timeline:</font></font><br>
<br>
<img width="50%" src="https://habrastorage.org/files/3b5/80b/ab0/3b580bab0b894981b8d28eadd9f444b2.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ketika interupsi terjadi, kami akan melakukan tindakan dengan nilai yang ditangkap. Jika pulsa input datang terlalu sering, dan tindakan yang terjadi pada interrupt handler terlalu lama, maka nilai CCR1 dapat ditimpa sebelum kita membaca yang sebelumnya. Dalam hal ini, Anda perlu memeriksa bendera Overcapture atau menerapkan DMA (Akses Memori Langsung) ketika data dari CCR1 secara otomatis mengisi array yang disiapkan dalam memori. Dalam kasus kami, pulsa terpendek memiliki durasi 1 milidetik, dan pengendali interupsi akan sederhana dan pendek, jadi jangan khawatir tentang menimpa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kembali ke tab </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pinout</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan atur timer </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TIM3</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> di menu </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Periferal</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/files/437/703/50b/43770350badf4efcb4d02a11ea2f9db0.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mode Slave: Mode Reset</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Berarti pada suatu peristiwa timer akan diatur ulang ke 0. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sumber Pemicu: TI1FP1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - acara yang digunakan untuk mengatur ulang dan memulai timer adalah tepi sinyal yang diambil dari input TI1. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ClockSource: Jam Internal</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - timer diberi clock dari generator internal mikrokontroler. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saluran 1: Mode</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pengambilan </font><i><font style="vertical-align: inherit;">langsung input</font></i><font style="vertical-align: inherit;"> - interval pengambilan dari saluran pertama dalam register CCR1. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada tab </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurasi</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> besar berikutnya, kami </font><font style="vertical-align: inherit;">akan membuat pengaturan timer tambahan.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/db8/b67/8d8/db8b678d8f7846c9af081a0bfdb0d7b1.png"></div><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/63b/6ac/c06/63b6acc06716451399d01566635d2f87.png"></div><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prescaler</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah pembagi timer. Jika 0, frekuensinya diambil langsung dari clock bus APB clock - 72 MHz. Jika prescaler adalah 1, frekuensinya dibagi 2 dan menjadi 36 MHz. Atur pembagi ke 71 sehingga frekuensi dibagi dengan 72. Kemudian frekuensi timer akan menjadi 1 MHz dan interval akan diukur dengan resolusi 1 mikrodetik. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Counter Period</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - atur nilai maksimum 16-bit 0xFFFF. Periode ini penting untuk menghasilkan slot waktu, misalnya, untuk PWM. Tetapi periode ini tidak penting untuk menangkap sinyal, kami akan membuatnya dikenal besar untuk setiap pulsa input. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pilihan Polaritas: Falling Edge</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - nilai timer akan ditangkap pada tepi jatuh dari sinyal input. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada tab </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengaturan NVIC</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">letakkan daw</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TIM3 global interrupt</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , sehingga peristiwa yang terkait dengan timer ke-3 menghasilkan interupsi.</font></font><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengaturan perangkat USB</font></font></b></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami telah mencatat bahwa pengontrol akan menjadi perangkat USB. </font><font style="vertical-align: inherit;">Karena joystick milik kelas perangkat HID, di menu </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Middlewares -&gt; USB_DEVICE,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pilih </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Class For FS IP: Human Interface Device Class (HID)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Kemudian CubeMX akan menghubungkan perpustakaan untuk perangkat HID ke proyek. </font></font><br>
<br>
<img src="https://habrastorage.org/files/3fe/080/472/3fe0804729bd4b2f995c5f32a9173d47.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita pergi ke pengaturan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USB_DEVICE</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pada tab </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurasi</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> di bagian </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Middlewares</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/574/ba7/dde/574ba7dde3794ce4911f955e628f7ce7.png"></div><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID Vendor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font><i><font style="vertical-align: inherit;">ID </font></i></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Produk</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah dua pengidentifikasi 16-bit yang unik untuk setiap model perangkat USB. VID sesuai dengan produsen perangkat, dan masing-masing produsen menetapkan PID, dipandu oleh pertimbangan mereka sendiri. Saya tidak dapat menemukan daftar resmi VID dan PID, saya hanya menemukan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">basis pengenal yang</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> didukung oleh penggemar. Untuk mendapatkan ID Vendor Anda sendiri, Anda harus pergi ke USB Implementers Forum di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usb.org</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan membayar beberapa ribu dolar. Perusahaan kecil atau pengembang sumber terbuka yang tidak mampu membeli VID mereka dapat meminta produsen chip USB dan secara resmi menerima pasangan VID / PID untuk proyek mereka. Layanan semacam itu ditawarkan, misalnya, oleh FTDI atau Laboratorium Silikon.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika Anda menghubungkan dua perangkat dengan VID / PID yang sama, tetapi dari jenis yang berbeda (misalnya, satu adalah perangkat HID dan yang lainnya adalah Mass Storage), sistem operasi akan mencoba menginstal driver yang sama untuk mereka, dan setidaknya salah satu dari mereka tidak akan bekerja. Itulah sebabnya pasangan VID / PID untuk model perangkat yang berbeda harus unik. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena kami tidak membuat perangkat untuk diri kami sendiri, kami tidak akan menjual dan mendistribusikannya, kami akan meninggalkan VID 0x0483, sesuai dengan STMicroelectronics, dan kami akan membuat PID kami sendiri. Secara default, CubeMX menawarkan PID 0x5710 untuk perangkat HID. Ganti, misalnya, dengan 0x57FF. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ganti </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">string Produk</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dengan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STM32 PPM-USB Adapter</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Nama ini akan muncul di daftar perangkat di Panel Kontrol Windows. Kami belum akan mengubah nomor seri (S \ N). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ketika Windows mendeteksi ia mendeteksi perangkat dengan kombinasi VID, PID, dan S \ N yang belum pernah dilihat sebelumnya, sistem akan menginstal driver yang sesuai untuk itu. Jika kombinasi VID, PID dan S \ N telah digunakan, maka Windows secara otomatis mengganti driver yang sebelumnya digunakan. Anda dapat melihat ini, misalnya, ketika Anda menghubungkan flash drive ke USB. Pertama kali menghubungkan dan menginstal membutuhkan waktu. Pada koneksi berikutnya, drive mulai bekerja hampir secara instan. Namun, jika Anda menghubungkan instance lain dari drive Flash dari model yang sama, tetapi dengan nomor seri yang berbeda, sistem akan menginstal driver baru untuk itu, meskipun memiliki VID dan PID yang sama.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya akan menjelaskan mengapa ini penting. </font><font style="vertical-align: inherit;">Jika Anda membuat mouse USB pada STM32 dengan VID, PID, dan S \ N, menyambungkannya ke komputer, lalu membuat joystick USB tanpa mengubah VID, PID, dan S \ N, maka Windows akan menganggap perangkat baru sebagai mouse yang sudah digunakan dalam sistem, dan tidak akan menginstal driver joystick. </font><font style="vertical-align: inherit;">Karenanya, joystick tidak akan berfungsi. </font><font style="vertical-align: inherit;">Karena itu, jika Anda ingin mengubah jenis perangkat Anda, membiarkan VID / PID tidak berubah, pastikan untuk mengubah nomor seri.</font></font><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pembuatan Proyek untuk IDE</font></font></b></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pengaturan terakhir yang perlu Anda buat adalah pengaturan pembuatan proyek. Ini dilakukan melalui </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Project -&gt; Settings</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ... Di sana kita akan mengatur nama, folder tujuan dan IDE yang diinginkan, di mana CubeMX akan membuat proyek. Saya memilih </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MDK-ARM V5</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , karena saya menggunakan Keil uVision 5. Pada tab </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Generator Kode</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">Anda dapat memeriksa kotak </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Salin hanya file perpustakaan yang diperlukan</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sehingga proyek tidak berantakan dengan file yang tidak perlu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tekan tombol </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Project -&gt; Hasilkan kode</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . CubeMX akan membuat proyek dengan kode yang dapat dibuka di Keil uVision dan dikompilasi dan di-flash tanpa pengaturan tambahan. Dalam file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dalam fungsi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utama (kosong)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fungsi telah dimasukkan untuk menginisialisasi jam, port, timer, dan USB. Di dalamnya, modul mikrokontroler dikonfigurasikan sesuai dengan mode yang kami atur di CubeMX. </font></font><br>
<br>
<img src="https://habrastorage.org/files/fb6/a32/393/fb6a323933734c7cb3ac4e11550d7420.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam kode, konstruksi semacam ini sering ditemukan:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* USER CODE BEGIN 0 */</span><font></font>
(...)<font></font>
<span class="hljs-comment">/* USER CODE END 0 */</span><font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diasumsikan bahwa pengguna akan menyematkan kode mereka di bagian ini. Jika </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simpan Kode Pengguna saat</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> opsi </font><i><font style="vertical-align: inherit;">pembuatan ulang</font></i><font style="vertical-align: inherit;"> diaktifkan di pengaturan proyek CubeMX </font><font style="vertical-align: inherit;">, maka kode yang terlampir di antara garis-garis ini tidak akan ditimpa selama generasi kedua dari proyek yang ada. Sayangnya, hanya bagian yang dibuat oleh CubeMX yang disimpan. Bagian </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ * KODE PENGGUNA * /</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dibuat oleh pengguna akan hilang. Oleh karena itu, jika setelah menulis kode di IDE Anda ingin kembali ke CubeMX dan menghasilkan proyek lagi dengan pengaturan baru, saya sarankan untuk membuat salinan cadangan proyek. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam pengaturan firmware di uVision ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Flash -&gt; Configure Flash Tools</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) saya menyarankan Anda untuk mengaktifkan opsi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reset after flash</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sehingga mikrokontroler mulai segera setelah flashing. </font><font style="vertical-align: inherit;">Secara default, ini dinonaktifkan, dan setelah setiap flashing, Anda harus menekan tombol Reset di papan tulis.</font></font><br>
<br>
<img src="https://habrastorage.org/files/1e1/a3d/20d/1e1a3d20dd994c1787f8a8758fcd200e.png"><br>
<br>
<a name="ppm"></a><h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decoding PPM</font></font></b></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PPM - Pulse Position Modulation - metode pengkodean sinyal yang ditransmisikan, sangat tersebar luas dalam elektronik model pesawat terbang. </font><font style="vertical-align: inherit;">Ini adalah urutan pulsa, interval waktu di antaranya sesuai dengan nilai numerik yang ditransmisikan.</font></font><br>
<br>
<div style="text-align:center;"><img width="80%" src="https://habrastorage.org/files/905/3ec/257/9053ec2573f8438b9a3053f2ef408739.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Menurut protokol ini, konsol mengirimkan informasi ke modul radio pengirim, yang dimasukkan ke konsol di bagian belakang. Banyak penerima yang ditempatkan di papan helikopter dapat mengirimkan sinyal kontrol untuk pengendali penerbangan melalui PPM. Selain itu, hampir semua konsol memiliki konektor untuk menghubungkan konsol kedua dalam mode trainer-student dan untuk menghubungkan konsol ke simulator, yang juga biasanya menggunakan PPM. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami menulis sinyal dari output simulator Turnigy 9X dengan penganalisis logika:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/53e/da5/319/53eda5319a6d45b59ee6e265de445992.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setiap urutan mengkodekan status kontrol saat ini pada remote. Biasanya empat nilai pertama (juga disebut saluran) sesuai dengan posisi batang analog, dan yang berikutnya dengan posisi sakelar sakelar atau potensiometer. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Posisi minimum kontrol sesuai dengan interval 1000 μs, maksimum - 2000 μs, posisi rata-rata - 1500 μs. Semburan pulsa, atau bingkai, dipisahkan oleh interval yang jauh lebih lama dan diikuti dengan periode 20-25 ms. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita lihat lebih dekat sinyal:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/703/86d/84e/70386d84efe24577a958767f8c5b7ae9.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seperti yang Anda lihat, tiga batang berada di posisi netral (1, 3, 4), dan satu di posisi ekstrem (2). </font><font style="vertical-align: inherit;">Tiga sakelar sakelar mati (5, 6, 7), dan yang terakhir aktif (8). </font><font style="vertical-align: inherit;">Mikrokontroler, yang bertindak sebagai adaptor, harus menangkap urutan seperti itu, menambahkan nilai ke array, dan mengirimkannya melalui USB sebagai perintah dari joystick. </font><font style="vertical-align: inherit;">Mari kita menulis decoder urutan pulsa.</font></font><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tangkap Gangguan</font></font></b></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah inisialisasi di </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.c,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sebelum </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">loop sementara</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utama </font><i><font style="vertical-align: inherit;">,</font></i><font style="vertical-align: inherit;"> mulai timer TIM3 dalam mode pengambilan Capture Input dari saluran 1, dengan generasi gangguan pengambilan. </font><font style="vertical-align: inherit;">Untuk melakukan ini, gunakan fungsi yang sesuai dari HAL:</font></font><br>
<br>
<pre><code class="cpp hljs">HAL_TIM_IC_Start_IT(&amp;htim3, TIM_CHANNEL_1);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Struktur </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">htim3</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> yang </font><font style="vertical-align: inherit;">dideklarasikan di </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah pengatur waktu TIM3, yang berisi semua struktur dan variabel yang terkait dengan timer: parameter untuk inisialisasi, pointer ke semua register timer (nilai penghitung, pembagi, semua pengaturan, bendera interupsi), penunjuk pada DMA handler yang bekerja dengan timer ini, dll. Pengembang tidak perlu mencari bit mana yang bertanggung jawab atas register apa dan secara manual mengatur dan meresetnya. Sudah cukup untuk menyerahkan pawang ke fungsi HAL. Perpustakaan HAL akan melakukan sisanya sendiri. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prinsip-prinsip struktur HAL dijelaskan secara lebih rinci dalam </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">Deskripsi</font></a><font style="vertical-align: inherit;"> dokumen </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">driver HAL STM32F3xx</font></a><font style="vertical-align: inherit;"> .</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(UM1786). Perlu dicatat bahwa perpustakaan HAL sendiri didokumentasikan dengan baik. Untuk memahami cara kerja HAL untuk timer dan cara menggunakannya, Anda dapat membaca komentar di file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stm32f3xx_hal_tim.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stm32f3xx_hal_tim.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk setiap interupsi yang dihasilkan oleh timer TIM3, penangan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TIM3_IRQHandler dipanggil</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Itu terletak di file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stm32f3xx_it.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , di mana </font><i><font style="vertical-align: inherit;">HAL_TIM_IRQHandler handler</font></i><font style="vertical-align: inherit;"> , standar untuk semua timer, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dipanggil</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> di dalamnya, dan sebuah penunjuk ke struktur htim3 diteruskan ke sana.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">TIM3_IRQHandler</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><font></font><span class="hljs-function">
</span>{<font></font>
  <span class="hljs-comment">/* USER CODE BEGIN TIM3_IRQn 0 */</span><font></font>
<font></font>
  <span class="hljs-comment">/* USER CODE END TIM3_IRQn 0 */</span><font></font>
  HAL_TIM_IRQHandler(&amp;htim3);<font></font>
  <span class="hljs-comment">/* USER CODE BEGIN TIM3_IRQn 1 */</span><font></font>
<font></font>
  <span class="hljs-comment">/* USER CODE END TIM3_IRQn 1 */</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika kita melihat ke dalam </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_TIM_IRQHandler</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stm32f3xx_hal_tim.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , kita melihat handler besar yang memeriksa flag interrupt untuk timer menyebabkan fungsi callback dan membersihkan flag setelah eksekusi. </font><font style="vertical-align: inherit;">Jika peristiwa penangkapan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">terjadi</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ia memanggil fungsi </font><i><font style="vertical-align: inherit;">HAL_TIM_IC_CaptureCallback</font></i><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ini terlihat seperti ini:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function">__weak <span class="hljs-keyword">void</span> <span class="hljs-title">HAL_TIM_IC_CaptureCallback</span><span class="hljs-params">(TIM_HandleTypeDef *htim)</span></span><font></font><span class="hljs-function">
</span>{<font></font>
<span class="hljs-comment">/* NOTE : This function Should not be modified, when the callback is needed, the __HAL_TIM_IC_CaptureCallback could be implemented in the user file</span><font></font><span class="hljs-comment">
*/</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini berarti bahwa kita dapat menimpa fungsi ini di </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Oleh karena itu, masukkan </font><font style="vertical-align: inherit;">panggilan balik ini </font><font style="vertical-align: inherit;">sebelum fungsi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int utama (void)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">HAL_TIM_IC_CaptureCallback</span><span class="hljs-params">(TIM_HandleTypeDef *htim)</span></span><font></font><span class="hljs-function">
</span>{<font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya ingin melihat bagaimana interupsi dilakukan. </font><font style="vertical-align: inherit;">Tambahkan untuk itu on-off cepat dari salah satu kesimpulan:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">HAL_TIM_IC_CaptureCallback</span><span class="hljs-params">(TIM_HandleTypeDef *htim)</span></span><font></font><span class="hljs-function">
</span>{<font></font>
  HAL_GPIO_WritePin(GPIOE, GPIO_PIN_8, GPIO_PIN_SET);<font></font>
  __nop();__nop();__nop();__nop();__nop();__nop();<font></font>
  HAL_GPIO_WritePin(GPIOE, GPIO_PIN_8, GPIO_PIN_RESET);<font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pin PE8 telah diinisialisasi sebagai output. </font><font style="vertical-align: inherit;">Antara menyalakan dan mematikan, instruksi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__nop ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dimasukkan </font><font style="vertical-align: inherit;">, yang membentuk penundaan 1 siklus clock. </font><font style="vertical-align: inherit;">Ini dilakukan agar penganalisa logika China $ 8 saya yang beroperasi pada 24 MHz tidak melewatkan pulsa terlalu pendek dari mikrokontroler 72 MHz. </font><font style="vertical-align: inherit;">Sekarang kompilasi Proyek </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">proyek -&gt; Bangun target</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan minta pengontrol </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Flash -&gt; Unduh</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Kami akan menghubungkan PPM dari remote ke PC6, dan melihat apa yang terjadi pada PC6 dan PE8 dengan penganalisis.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/abf/64c/e2c/abf64ce2c6874057933df9edb58dff8f.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Callback benar-benar dipanggil pada saat yang tepat - tepat setelah sinyal input telah beralih dari 1 ke 0. Jadi, semuanya dilakukan dengan benar.</font></font><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menangkap dan memproses data yang diambil</font></font></b></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami akan mengedit callback sehingga akan menambah setiap nilai ditangkap dengan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">captured_value</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> penyangga </font><font style="vertical-align: inherit;">tidak berubah. Jika timer menangkap nilai yang sangat besar (lebih dari 5000 μs), ini berarti bahwa jeda direkam, paket diterima secara keseluruhan dan dapat diproses. Nilai yang diproses ditambahkan ke array </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rc_data</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dari 5 elemen. Di empat pertama, posisi tongkat dikurangi ke kisaran [0; 1000], pada bit kelima, masing-masing bit diatur sesuai dengan sakelar sakelar, yang akan ditafsirkan sebagai menekan tombol pada gamepad.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">uint16_t</span> captured_value[<span class="hljs-number">8</span>] = {<span class="hljs-number">0</span>};<font></font>
<span class="hljs-keyword">uint16_t</span> rc_data[<span class="hljs-number">5</span>] = {<span class="hljs-number">0</span>};<font></font>
<span class="hljs-keyword">uint8_t</span> pointer = <span class="hljs-number">0</span>;<font></font>
<span class="hljs-keyword">uint8_t</span> data_ready = <span class="hljs-number">0</span>;<font></font>
<font></font>
...<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">HAL_TIM_IC_CaptureCallback</span><span class="hljs-params">(TIM_HandleTypeDef *htim)</span></span><font></font><span class="hljs-function">
</span>{<font></font>
    <span class="hljs-keyword">uint8_t</span> i;<font></font>
    <span class="hljs-keyword">uint16_t</span> temp;<font></font>
    <span class="hljs-comment">//     </span><font></font>
    temp = HAL_TIM_ReadCapturedValue(htim, TIM_CHANNEL_1);<font></font>
    <span class="hljs-comment">//    , ,  </span><font></font>
    <span class="hljs-keyword">if</span> ((temp &gt; <span class="hljs-number">5000</span>) &amp;&amp; (!data_ready))<font></font>
    {<font></font>
        pointer = <span class="hljs-number">0</span>;<font></font>
        <span class="hljs-comment">//        [0;1000]</span><font></font>
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++)<font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (captured_value[i] &lt; <span class="hljs-number">1000</span>)<font></font>
                captured_value[i] = <span class="hljs-number">1000</span>;<font></font>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (captured_value[i] &gt; <span class="hljs-number">2000</span>)<font></font>
                captured_value[i] = <span class="hljs-number">2000</span>;<font></font>
            rc_data[i] = captured_value[i]<span class="hljs-number">-1000</span>;<font></font>
        };<font></font>
        <span class="hljs-comment">//     </span><font></font>
        rc_data[<span class="hljs-number">4</span>] = <span class="hljs-number">0</span>;<font></font>
        <span class="hljs-keyword">if</span> (captured_value[<span class="hljs-number">4</span>] &gt; <span class="hljs-number">1500</span>)<font></font>
            rc_data[<span class="hljs-number">4</span>] |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">4</span>);<font></font>
        <span class="hljs-keyword">if</span> (captured_value[<span class="hljs-number">5</span>] &gt; <span class="hljs-number">1500</span>)<font></font>
            rc_data[<span class="hljs-number">4</span>] |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">5</span>);<font></font>
        <span class="hljs-keyword">if</span> (captured_value[<span class="hljs-number">6</span>] &gt; <span class="hljs-number">1500</span>)<font></font>
            rc_data[<span class="hljs-number">4</span>] |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">6</span>);<font></font>
        <span class="hljs-keyword">if</span> (captured_value[<span class="hljs-number">7</span>] &gt; <span class="hljs-number">1500</span>)<font></font>
            rc_data[<span class="hljs-number">4</span>] |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">7</span>);<font></font>
        data_ready = <span class="hljs-number">1</span>;<font></font>
    }<font></font>
    <span class="hljs-keyword">else</span> <span class="hljs-comment">//      </span><font></font>
    {<font></font>
        captured_value[pointer] = temp;<font></font>
        pointer++;<font></font>
    };<font></font>
    <span class="hljs-keyword">if</span> (pointer == <span class="hljs-number">8</span>) <span class="hljs-comment">//   </span><font></font>
        pointer = <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Biarkan saya menjelaskan mengapa saya menempatkan bit yang sesuai dengan tombol tidak di 4 bit yang lebih rendah, tetapi di bit kelima hingga kedelapan. Dalam simulator, seharusnya menghubungkan gamepad dari Xbox, di mana tombol LB, RB, Start dan Back digunakan, dan mereka memiliki angka dari 5 hingga 8. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada loop utama, flag data_ready akan terus diputar, dimana data akan dikirim ke komputer.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<font></font>
{<font></font>
  <span class="hljs-keyword">if</span> (data_ready)<font></font>
  {<font></font>
    <span class="hljs-comment">//      </span><font></font>
    data_ready = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk memeriksa bagaimana ini bekerja, hubungkan remote control, kompilasi dan flash lagi, dan kemudian mulai debug </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Debug -&gt; Mulai / Hentikan Sesi Debug</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Membuka jendela untuk melacak variabel </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">View -&gt; Tonton Windows -&gt; Tonton 1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan add </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">captured_value</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rc_data ada</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami mulai debugging dengan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Debug -&gt; Jalankan</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> perintah </font><font style="vertical-align: inherit;">dan secara real time, bahkan tanpa menambahkan breakpoints, kita akan melihat bagaimana angka berubah setelah tongkat.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/5cf/7da/c9c/5cf7dac9c152498e89ea3948a8549efb.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selanjutnya, Anda perlu mengirim data ke komputer dalam bentuk perintah joystick.</font></font><br>
<br>
<h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurasikan perangkat HID dan buat deskriptor laporan HID</font></font></b></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USB HID (Human Interface Device) adalah kelas perangkat untuk interaksi manusia-komputer. Ini termasuk keyboard, mouse, joystick, gamepad, panel sentuh. Keuntungan utama dari perangkat HID adalah bahwa mereka tidak memerlukan driver khusus di sistem operasi apa pun: Windows, OS X, Android, dan bahkan iOS (melalui adaptor USB-Lightning). Deskripsi terperinci dapat ditemukan dalam dokumen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Device Class Definition for HID</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Hal utama yang perlu kita ketahui untuk membuat adaptor PPM-USB adalah apa itu </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HID Report</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HID Report Descriptor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perangkat HID mengirimkan paket byte ke komputer dalam format yang telah ditentukan. Setiap paket tersebut adalah Laporan HID. Perangkat memberi tahu komputer tentang format data ketika terhubung, mengirimkan HID Report Descriptor, deskripsi paket yang menunjukkan berapa banyak byte yang berisi paket dan tujuan dari setiap byte dan bit dalam paket. Misalnya, Laporan HID dari mouse sederhana terdiri dari empat byte: byte pertama berisi informasi tentang tombol yang ditekan, byte kedua dan ketiga berisi pergerakan relatif kursor sepanjang X dan Y, dan byte keempat berisi rotasi roda gulir. Deskriptor Laporan disimpan dalam memori pengontrol perangkat sebagai array byte.</font></font><br>
<br>
<div style="text-align:center;"><img width="35%" src="https://habrastorage.org/files/22f/dd2/aa6/22fdd2aa67154365a6f89f6a2f7f2798.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebelum membuat deskriptor, saya ingin membahas secara terpisah tentang terminologi. Dua istilah umum di lingkungan bahasa Inggris - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">joystick</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gamepad</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Kata </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">joystick</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> biasanya disebut manipulator yang dipegang dengan satu tangan dan dimiringkan ke arah yang berbeda, dan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gamepad</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah perangkat dengan tombol dan tongkat yang dipegang dengan dua tangan. Pengguna berbahasa Rusia biasanya menyebut joystick baik itu, maupun yang lain. Dalam deskripsi perangkat HID, ada perbedaan antara joystick dan gamepad. Konsol model pesawat terbang lebih mirip dalam tujuan fungsionalnya untuk gamepad, jadi di masa depan saya kadang-kadang akan menggunakan istilah "gamepad".</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami membuat proyek, yang menunjukkan bahwa perangkat akan bertindak sebagai Perangkat Antarmuka Manusia. </font><font style="vertical-align: inherit;">Ini berarti bahwa perpustakaan USB HID terhubung ke proyek dan Descriptor Perangkat telah dihasilkan. </font><font style="vertical-align: inherit;">Itu terletak di file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usbd_hid.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , menjelaskan laporan mouse dan terlihat seperti ini:</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HID_Mouse_Report_Descriptor</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs">__ALIGN_BEGIN <span class="hljs-keyword">static</span> <span class="hljs-keyword">uint8_t</span> HID_MOUSE_ReportDesc[HID_MOUSE_REPORT_DESC_SIZE]  __ALIGN_END =<font></font>
{<font></font>
  <span class="hljs-number">0x05</span>,   <span class="hljs-number">0x01</span>,
  <span class="hljs-number">0x09</span>,   <span class="hljs-number">0x02</span>,
  <span class="hljs-number">0xA1</span>,   <span class="hljs-number">0x01</span>,
  <span class="hljs-number">0x09</span>,   <span class="hljs-number">0x01</span>,<font></font>
<font></font>
  <span class="hljs-number">0xA1</span>,   <span class="hljs-number">0x00</span>,
  <span class="hljs-number">0x05</span>,   <span class="hljs-number">0x09</span>,
  <span class="hljs-number">0x19</span>,   <span class="hljs-number">0x01</span>,
  <span class="hljs-number">0x29</span>,   <span class="hljs-number">0x03</span>,<font></font>
<font></font>
  <span class="hljs-number">0x15</span>,   <span class="hljs-number">0x00</span>,
  <span class="hljs-number">0x25</span>,   <span class="hljs-number">0x01</span>,
  <span class="hljs-number">0x95</span>,   <span class="hljs-number">0x03</span>,
  <span class="hljs-number">0x75</span>,   <span class="hljs-number">0x01</span>,<font></font>
<font></font>
  <span class="hljs-number">0x81</span>,   <span class="hljs-number">0x02</span>,
  <span class="hljs-number">0x95</span>,   <span class="hljs-number">0x01</span>,
  <span class="hljs-number">0x75</span>,   <span class="hljs-number">0x05</span>,
  <span class="hljs-number">0x81</span>,   <span class="hljs-number">0x01</span>,<font></font>
<font></font>
  <span class="hljs-number">0x05</span>,   <span class="hljs-number">0x01</span>,
  <span class="hljs-number">0x09</span>,   <span class="hljs-number">0x30</span>,
  <span class="hljs-number">0x09</span>,   <span class="hljs-number">0x31</span>,
  <span class="hljs-number">0x09</span>,   <span class="hljs-number">0x38</span>,<font></font>
<font></font>
  <span class="hljs-number">0x15</span>,   <span class="hljs-number">0x81</span>,
  <span class="hljs-number">0x25</span>,   <span class="hljs-number">0x7F</span>,
  <span class="hljs-number">0x75</span>,   <span class="hljs-number">0x08</span>,
  <span class="hljs-number">0x95</span>,   <span class="hljs-number">0x03</span>,<font></font>
<font></font>
  <span class="hljs-number">0x81</span>,   <span class="hljs-number">0x06</span>,
  <span class="hljs-number">0xC0</span>,   <span class="hljs-number">0x09</span>,
  <span class="hljs-number">0x3c</span>,   <span class="hljs-number">0x05</span>,
  <span class="hljs-number">0xff</span>,   <span class="hljs-number">0x09</span>,<font></font>
<font></font>
  <span class="hljs-number">0x01</span>,   <span class="hljs-number">0x15</span>,
  <span class="hljs-number">0x00</span>,   <span class="hljs-number">0x25</span>,
  <span class="hljs-number">0x01</span>,   <span class="hljs-number">0x75</span>,
  <span class="hljs-number">0x01</span>,   <span class="hljs-number">0x95</span>,<font></font>
<font></font>
  <span class="hljs-number">0x02</span>,   <span class="hljs-number">0xb1</span>,
  <span class="hljs-number">0x22</span>,   <span class="hljs-number">0x75</span>,
  <span class="hljs-number">0x06</span>,   <span class="hljs-number">0x95</span>,
  <span class="hljs-number">0x01</span>,   <span class="hljs-number">0xb1</span>,<font></font>
<font></font>
  <span class="hljs-number">0x01</span>,   <span class="hljs-number">0xc0</span><font></font>
};<font></font>
</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Membuat Descriptor Laporan HID secara manual sangat memakan waktu. </font><font style="vertical-align: inherit;">Untuk memudahkan tugas, ada alat yang disebut </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HID Descriptor Tool</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (DT). </font><font style="vertical-align: inherit;">Program ini dapat membuat deskriptor untuk perangkat Anda. </font><font style="vertical-align: inherit;">Dalam arsipnya Anda dapat menemukan beberapa contoh deskriptor untuk perangkat yang berbeda.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/a3c/6fd/07c/a3c6fd07c997415ab94ba603edda628d.png"></div><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Berikut ini adalah</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> artikel yang sangat bagus tentang membuat deskriptor HID Anda sendiri untuk mouse dan keyboard (dalam bahasa Inggris). Saya akan memberi tahu Anda dalam bahasa Rusia cara membuat pegangan untuk gamepad. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Laporan HID yang dikirim oleh konsol harus berisi empat nilai 16-bit untuk dua sumbu stik analog dan 16 nilai satu-bit untuk tombol. Total 10 byte. Pegangannya yang dibuat di DT akan terlihat seperti ini:</font></font><br>
<br>
<pre><code class="cpp hljs">    <span class="hljs-number">0x05</span>, <span class="hljs-number">0x01</span>,                    <span class="hljs-comment">// USAGE_PAGE (Generic Desktop)</span><font></font>
    <span class="hljs-number">0x09</span>, <span class="hljs-number">0x05</span>,                    <span class="hljs-comment">// USAGE (Game Pad)</span><font></font>
    <span class="hljs-number">0xa1</span>, <span class="hljs-number">0x01</span>,                    <span class="hljs-comment">// COLLECTION (Application)</span><font></font>
    <span class="hljs-number">0x09</span>, <span class="hljs-number">0x01</span>,                    <span class="hljs-comment">//   USAGE (Pointer)</span><font></font>
    <span class="hljs-number">0xa1</span>, <span class="hljs-number">0x00</span>,                    <span class="hljs-comment">//   COLLECTION (Physical)</span><font></font>
    <span class="hljs-number">0x09</span>, <span class="hljs-number">0x30</span>,                    <span class="hljs-comment">//     USAGE (X)</span><font></font>
    <span class="hljs-number">0x09</span>, <span class="hljs-number">0x31</span>,                    <span class="hljs-comment">//     USAGE (Y)</span><font></font>
    <span class="hljs-number">0x15</span>, <span class="hljs-number">0x00</span>,                    <span class="hljs-comment">//     LOGICAL_MINIMUM (0)</span><font></font>
    <span class="hljs-number">0x26</span>, <span class="hljs-number">0xe8</span>, <span class="hljs-number">0x03</span>,              <span class="hljs-comment">//     LOGICAL_MAXIMUM (1000)</span><font></font>
    <span class="hljs-number">0x75</span>, <span class="hljs-number">0x10</span>,                    <span class="hljs-comment">//     REPORT_SIZE (16)</span><font></font>
    <span class="hljs-number">0x95</span>, <span class="hljs-number">0x02</span>,                    <span class="hljs-comment">//     REPORT_COUNT (2)</span><font></font>
    <span class="hljs-number">0x81</span>, <span class="hljs-number">0x02</span>,                    <span class="hljs-comment">//     INPUT (Data,Var,Abs)</span><font></font>
    <span class="hljs-number">0xc0</span>,                          <span class="hljs-comment">//   END_COLLECTION</span><font></font>
    <span class="hljs-number">0xa1</span>, <span class="hljs-number">0x00</span>,                    <span class="hljs-comment">//   COLLECTION (Physical)</span><font></font>
    <span class="hljs-number">0x09</span>, <span class="hljs-number">0x33</span>,                    <span class="hljs-comment">//     USAGE (Rx)</span><font></font>
    <span class="hljs-number">0x09</span>, <span class="hljs-number">0x34</span>,                    <span class="hljs-comment">//     USAGE (Ry)</span><font></font>
    <span class="hljs-number">0x15</span>, <span class="hljs-number">0x00</span>,                    <span class="hljs-comment">//     LOGICAL_MINIMUM (0)</span><font></font>
    <span class="hljs-number">0x26</span>, <span class="hljs-number">0xe8</span>, <span class="hljs-number">0x03</span>,              <span class="hljs-comment">//     LOGICAL_MAXIMUM (1000)</span><font></font>
    <span class="hljs-number">0x75</span>, <span class="hljs-number">0x10</span>,                    <span class="hljs-comment">//     REPORT_SIZE (16)</span><font></font>
    <span class="hljs-number">0x95</span>, <span class="hljs-number">0x02</span>,                    <span class="hljs-comment">//     REPORT_COUNT (2)</span><font></font>
    <span class="hljs-number">0x81</span>, <span class="hljs-number">0x02</span>,                    <span class="hljs-comment">//     INPUT (Data,Var,Abs)</span><font></font>
    <span class="hljs-number">0xc0</span>,                          <span class="hljs-comment">//   END_COLLECTION</span><font></font>
    <span class="hljs-number">0x05</span>, <span class="hljs-number">0x09</span>,                    <span class="hljs-comment">//   USAGE_PAGE (Button)</span><font></font>
    <span class="hljs-number">0x19</span>, <span class="hljs-number">0x01</span>,                    <span class="hljs-comment">//   USAGE_MINIMUM (Button 1)</span><font></font>
    <span class="hljs-number">0x29</span>, <span class="hljs-number">0x10</span>,                    <span class="hljs-comment">//   USAGE_MAXIMUM (Button 16)</span><font></font>
    <span class="hljs-number">0x15</span>, <span class="hljs-number">0x00</span>,                    <span class="hljs-comment">//   LOGICAL_MINIMUM (0)</span><font></font>
    <span class="hljs-number">0x25</span>, <span class="hljs-number">0x01</span>,                    <span class="hljs-comment">//   LOGICAL_MAXIMUM (1)</span><font></font>
    <span class="hljs-number">0x75</span>, <span class="hljs-number">0x01</span>,                    <span class="hljs-comment">//   REPORT_SIZE (1)</span><font></font>
    <span class="hljs-number">0x95</span>, <span class="hljs-number">0x10</span>,                    <span class="hljs-comment">//   REPORT_COUNT (16)</span><font></font>
    <span class="hljs-number">0x81</span>, <span class="hljs-number">0x02</span>,                    <span class="hljs-comment">//   INPUT (Data,Var,Abs)</span><font></font>
    <span class="hljs-number">0xc0</span>                           <span class="hljs-comment">// END_COLLECTION</span><font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Itu tidak kalah menakutkan dari deskriptor mouse. </font><font style="vertical-align: inherit;">Tetapi jika Anda mengerti apa artinya setiap baris, semuanya ternyata cukup dimengerti dan logis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PENGGUNAAN menunjukkan bagaimana sistem harus menafsirkan data yang melangkah lebih jauh. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada banyak jenis Penggunaan, mereka diurutkan ke dalam grup - Halaman Penggunaan. </font><font style="vertical-align: inherit;">Karenanya, untuk memilih Penggunaan tertentu, Anda harus terlebih dahulu merujuk ke USAGE_PAGE yang sesuai. </font><font style="vertical-align: inherit;">Tentang apa Penggunaan dapat ditemukan dalam dokumen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hid Usage Tables</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Di bagian paling awal deskriptor, kami menunjukkan bahwa joystick akan dijelaskan:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USAGE_PAGE (Generic Desktop) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE (Game Pad)</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
KOLEKSI menggabungkan beberapa set data terkait. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pengumpulan Fisik digunakan untuk data yang terkait dengan satu titik geometris tertentu, misalnya, satu batang analog. </font><font style="vertical-align: inherit;">Pengumpulan Aplikasi digunakan untuk menggabungkan berbagai fungsi dalam satu perangkat. </font><font style="vertical-align: inherit;">Misalnya, keyboard dengan trackpad terintegrasi mungkin memiliki dua Koleksi Aplikasi. </font><font style="vertical-align: inherit;">Kami hanya menjelaskan joystick, yang berarti bahwa koleksi tersebut akan menjadi satu:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COLLECTION (Aplikasi) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
END_COLLECTION</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah itu, Anda perlu menentukan bahwa elemen yang mengirimkan koordinat akan dijelaskan. </font><font style="vertical-align: inherit;">Usage Pointer digunakan untuk menggambarkan mouse, joystick, gamepad, digitizers:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PENGGUNAAN (Pointer)</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Berikut ini adalah deskripsi batang analog yang digabungkan dalam koleksi:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KOLEKSI (Fisik)</font></font><br>
 <blockquote>USAGE (X)<br>
 USAGE (Y)<br>
 LOGICAL_MINIMUM (0)<br>
 LOGICAL_MAXIMUM (1000)<br>
 REPORT_SIZE (16)<br>
 REPORT_COUNT (2)<br>
 INPUT (Data,Var,Abs)</blockquote>END_COLLECTION</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PENGGUNAAN di sini menunjukkan bahwa nilai-nilai bias digunakan sepanjang dua sumbu - X dan Y. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LOGICAL_MINIMUM dan LOGICAL_MAXIMUM menentukan batas-batas mana nilai yang dikirimkan dapat bervariasi. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
REPORT_COUNT dan REPORT_SIZE ditetapkan, masing-masing, berapa banyak angka dan ukuran apa yang akan kita transfer, yaitu dua angka 16-bit. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
INPUT (Data, Var, Abs) berarti bahwa data berasal dari perangkat ke komputer, dan data ini dapat berubah. Nilai dalam kasus kami adalah absolut. Misalnya, nilai relatif berasal dari mouse untuk memindahkan kursor. Terkadang data digambarkan sebagai Const, bukan Var. Ini diperlukan untuk mengirimkan bit yang tidak signifikan. Misalnya, dalam laporan mouse dengan tiga tombol, 3 bit Var untuk tombol dan 5 bit Const ditransfer untuk menambah ukuran transfer ke satu byte.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seperti yang Anda lihat, deskripsi sumbu X dan Y dikelompokkan bersama. </font><font style="vertical-align: inherit;">Mereka memiliki ukuran yang sama, batas yang sama. </font><font style="vertical-align: inherit;">Stik analog yang sama dapat dijelaskan sebagai berikut, yang menjelaskan masing-masing sumbu secara terpisah. </font><font style="vertical-align: inherit;">Deskriptor seperti itu akan bekerja sama dengan yang sebelumnya:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KOLEKSI (Fisik)</font></font><br>
<blockquote><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 MENGGUNAKAN </font><font style="vertical-align: inherit;">(X) </font><font style="vertical-align: inherit;">LOGICAL_MINIMUM (0) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 LOGICAL_MAXIMUM (1000) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 REPORT_SIZE (16) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 REPORT_COUNT (1) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 INPUT (Data, Var, Abs)</font></font></blockquote><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PENGGUNAAN (Y) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 LOGICAL_MINIMUM (0) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 LOGICAL_MAXIMUM (1000) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 REPORT_SIZE (16) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 REPORT_COUNT (1) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 INPUT (Data, Var, Abs)</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">END_COLLECTION</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah stik pertama, stik analog kedua dijelaskan. </font><font style="vertical-align: inherit;">Kapaknya memiliki Penggunaan yang berbeda sehingga Anda dapat membedakannya dari tongkat pertama - Rx dan Ry:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KOLEKSI (Fisik)</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USAGE (Rx) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 USAGE (Ry) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 LOGICAL_MINIMUM (0) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 LOGICAL_MAXIMUM (1000) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 REPORT_SIZE (16) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 REPORT_COUNT (2) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 INPUT (Data, Var, Abs)</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">END_COLLECTION</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang Anda perlu menjelaskan beberapa tombol gamepad. </font><font style="vertical-align: inherit;">Hal ini dapat dilakukan sebagai berikut:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USAGE_PAGE (Tombol) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE (Tombol 1) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE (Tombol 2) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE (Tombol 3) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE (Tombol 16)</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rekaman rumit tombol dari jenis yang sama dapat dikurangi dengan menggunakan rentang Penggunaan:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USAGE_PAGE (Tombol) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE_MINIMUM (Tombol 1) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE_MAXIMUM (Tombol 16)</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Data yang dikirimkan oleh tombol adalah 16 nilai bit tunggal, bervariasi dari 0 hingga 1:</font></font><br>
<blockquote>LOGICAL_MINIMUM (0)<br>
LOGICAL_MAXIMUM (1)<br>
REPORT_SIZE (1)<br>
REPORT_COUNT (16)<br>
INPUT (Data,Var,Abs)</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Urutan baris dalam deskriptor tidak ketat. Misalnya, Logical_Minimum dan Logical_Maximum dapat ditulis sebelum Penggunaan (Tombol), atau baris Report_Size dan Report_Count dapat ditukar. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Penting bahwa perintah Input memiliki semua parameter yang diperlukan untuk transfer data (Penggunaan, Mimimum, Maksimum, Ukuran, Hitungan). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ketika deskriptor terbentuk, itu dapat diperiksa dengan perintah </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parse Descriptor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> untuk kesalahan. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika semuanya sudah beres, maka eksporlah dengan ekstensi h. Dalam file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usbd_hid.c,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ganti deskriptor dengan yang baru dan sesuaikan dengan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usbd_hid.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ukuran deskriptor </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HID_MOUSE_REPORT_DESC_SIZE</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dari 74 hingga 61. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Laporan dikirim menggunakan flag </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data_ready</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Untuk ini</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.c kita akan</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> menyertakan file header </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usbd_hid.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan dalam loop utama kita akan memanggil fungsi pengiriman laporan. </font><font style="vertical-align: inherit;">Array </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rc_data</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bertipe uint16, jadi penunjuknya harus dilemparkan ke tipe 8-bit dan meneruskan ukuran 10 alih-alih 5.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"usbd_hid.h"</span></span><font></font>
...<font></font>
<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<font></font>
{<font></font>
  <span class="hljs-keyword">if</span> (data_ready)<font></font>
  {<font></font>
    USBD_HID_SendReport(&amp;hUsbDeviceFS, (<span class="hljs-keyword">uint8_t</span>*)rc_data, <span class="hljs-number">10</span>);<font></font>
    data_ready = <span class="hljs-number">0</span>;<font></font>
  };<font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami mengkompilasi proyek dan mem-flashnya lagi.</font></font><br>
<br>
<h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Koneksi dan penggunaan</font></font></b></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sambungkan kembali kabel USB dari konektor USB ST-LINK ke konektor USB USER. </font><font style="vertical-align: inherit;">Windows akan mendeteksi perangkat baru dan secara otomatis menginstal driver. </font><font style="vertical-align: inherit;">Mari kita pergi ke </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Control Panel -&gt; Devices and Printers</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan lihat perangkat Adaptor USB-PPM STM32 kami dengan ikon gamepad.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/1ee/5ad/846/1ee5ad84654545dfbcec807073ef8207.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam pengaturan perangkat, Anda dapat melihat bagaimana salib bergerak melintasi bidang dan kolom bergerak setelah tongkat dipindahkan, dan simbol tombol menyala dari sakelar sakelar. </font><font style="vertical-align: inherit;">Kalibrasi tidak diperlukan karena nilai minimum dan maksimum telah ditetapkan dalam deskriptor.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/52c/4b0/9db/52c4b09db3074871b917aa74b3375de6.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mulai FPV FreeRider, kita akan melihat bagaimana di layar utama pada gamepad virtual yang ditarik, tongkat bergerak sesuai dengan remote control kami. </font><font style="vertical-align: inherit;">Jika sumbu tidak ditetapkan dengan benar karena alasan tertentu, Anda dapat mengkonfigurasi ulang di bagian </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kontroler</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pengalibrasi </font><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sakelar sakelar yang sesuai dengan tombol pada kendali jarak jauh digunakan untuk mengganti mode penerbangan (akrobatik / stabil), mengalihkan tampilan kamera (dari papan / dari tanah), memulai penerbangan dari awal atau menyalakan balapan untuk sementara waktu.</font></font><br>
<br>
<div style="text-align:center;"><img width="70%" src="https://habrastorage.org/files/153/bc2/3a8/153bc23a87bd4fedad1dd9b04c2aae22.png"></div><br>
<br>
<h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terbang!</font></font></b></h3><br>
<iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://www.youtube.com/embed/ilMeTba4EOE%3Ffeature%3Doembed&amp;usg=ALkJrhj8Y0EWWZlWTGce6uAGUZEFEsbFdA" frameborder="0" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di video - hasil beberapa hari pelatihan saya. Sementara saya terbang dengan leveling otomatis, dan tidak dalam mode akrobatik, seperti yang dilakukan semua master balap FPV. Dalam mode acro, jika Anda melepaskan tongkat, copter tidak secara otomatis kembali ke posisi horizontal, tetapi terus terbang dengan sudut yang sama seperti terbang. Mengelola dalam mode acro jauh lebih sulit, tetapi Anda dapat mencapai kecepatan yang lebih besar, kemampuan manuver, membuat pergolakan di udara dan bahkan terbang terbalik. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Charpu Masters</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saya masih sangat jauh, tetapi saya terus berlatih dan saya dapat mengatakan dengan pasti bahwa gagasan helikopter mini balap semakin menarik bagi saya. </font><font style="vertical-align: inherit;">Dan segera, saya pasti akan terlibat dalam konstruksi dan penerbangan tidak lagi dalam simulator, tetapi dalam kenyataan pahit, dengan tabrakan nyata, baling-baling rusak, mesin rusak dan baterai habis. </font><font style="vertical-align: inherit;">Tapi ini topik untuk artikel lain :)</font></font><br>
<br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Proyek untuk Keil uVision 5 dan STM32CubeMX ada di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id384813/">https://habr.com/ru/post/id384813/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id384801/index.html">Hari terakhir Pompeii: Ilmuwan Italia memindai sisa-sisa korban bencana</a></li>
<li><a href="../id384803/index.html">Paul Graham: Gagasan untuk Startup Organik</a></li>
<li><a href="../id384805/index.html">Spesialis IFixit menghancurkan AppleTV, dan Apple mencopot pemasangan aplikasi iFixit dari AppStore</a></li>
<li><a href="../id384809/index.html">Kertas atau "angka"? Keduanya: ulasan tentang pena NeoLAB Convergence Neo smartpen N2</a></li>
<li><a href="../id384811/index.html">Opini Ahli: Bahan Semikonduktor dalam Elektronik</a></li>
<li><a href="../id384815/index.html">Ponsel untuk keselamatan anak-anak dan ketenangan orang tua mereka: review dari bb-mobile baru</a></li>
<li><a href="../id384817/index.html">Ribuan Foto Apollo diunggah ke Flickr</a></li>
<li><a href="../id384819/index.html">Вместо того, чтобы «не быть злом» «Google» теперь «делает правильные вещи»</a></li>
<li><a href="../id384821/index.html">Siswa memperkenalkan sarung tangan yang memungkinkan orang dengan gangguan bicara untuk berkomunikasi</a></li>
<li><a href="../id384823/index.html">Cara non-standar untuk mempromosikan game seluler</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>