<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèΩ‚Äçüíª ‚ôëÔ∏è ü¶å Comment nous avons mis en ≈ìuvre la livraison de mise √† jour continue sur la plate-forme du client üò∑ üòé üôÜüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Chez True Engineering, nous avons mis en place le processus de mise √† jour continue des serveurs des clients et souhaitons partager cette exp√©rience. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment nous avons mis en ≈ìuvre la livraison de mise √† jour continue sur la plate-forme du client</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/true_engineering/blog/447812/">  Chez True Engineering, nous avons mis en place le processus de mise √† jour continue des serveurs des clients et souhaitons partager cette exp√©rience. <br><br>  Tout d'abord, nous avons d√©velopp√© un syst√®me en ligne pour le client et l'avons d√©ploy√© dans notre propre cluster Kubernetes.  Maintenant, notre solution hautement charg√©e est pass√©e √† la plate-forme du client, pour laquelle nous avons mis en place le processus de d√©ploiement continu enti√®rement automatique.  Gr√¢ce √† cela, nous avons acc√©l√©r√© le d√©lai de mise sur le march√© - la livraison des modifications de l'environnement du produit. <br><br>  Dans cet article, nous parlerons de toutes les √©tapes du processus de d√©ploiement continu (CD) ou de la mise √† jour de la plateforme du client: <br><br><ol><li>  comment commence ce processus </li><li>  synchronisation avec le r√©f√©rentiel Git du client, </li><li>  assemblage backend et frontend </li><li>  d√©ploiement automatique de l'application dans un environnement de test, </li><li>  d√©ploiement automatique sur Prod. </li></ol><br>  Dans le processus, nous partagerons les d√©tails des param√®tres. <br><br><img src="https://habrastorage.org/webt/ii/pa/gh/iipaghverrphnx-_scgemoqhgy0.jpeg"><br><a name="habracut"></a><br><h3>  1. D√©marrer le CD </h3><br>  Le d√©ploiement continu commence par le fait que le d√©veloppeur publie les modifications dans la branche de publication de notre r√©f√©rentiel Git. <br><br>  Notre application fonctionne sur la base d'une architecture de microservices et tous ses composants sont stock√©s dans un r√©f√©rentiel.  Gr√¢ce √† cela, tous les microservices sont assembl√©s et install√©s, m√™me si l'un d'eux a chang√©. <br><br>  Nous avons organis√© le travail via un r√©f√©rentiel pour plusieurs raisons: <br><br><ul><li>  Facilit√© de d√©veloppement - l'application se d√©veloppe activement, vous pouvez donc travailler imm√©diatement avec tout le code. </li><li>  Un pipeline CI / CD unique qui garantit que l'application en tant que syst√®me unique passe tous les tests et est livr√©e √† l'environnement de production du client. </li><li>  Nous excluons la confusion dans les versions - nous n'avons pas besoin de stocker une carte des versions de microservice et de d√©crire notre configuration pour chaque microservice dans les scripts Helm. </li></ul><br><h3>  2. Synchronisation avec le r√©f√©rentiel Git du code source du client </h3><br>  Les modifications apport√©es sont automatiquement synchronis√©es avec le r√©f√©rentiel Git du client.  L√†, l'assemblage de l'application est configur√©, qui d√©marre apr√®s la mise √† jour de la branche, et le d√©ploiement vers prod.  Les deux processus se produisent dans leur environnement √† partir du r√©f√©rentiel Git. <br><br>  Nous ne pouvons pas travailler directement avec le r√©f√©rentiel du client, car nous avons besoin de nos propres environnements de d√©veloppement et de test.  Nous utilisons notre r√©f√©rentiel Git √† ces fins - il est synchronis√© avec leur r√©f√©rentiel Git.  D√®s que le d√©veloppeur publie les modifications dans la branche appropri√©e de notre r√©f√©rentiel, GitLab envoie imm√©diatement ces modifications au client. <br><br><img src="https://habrastorage.org/webt/x4/de/zu/x4dezunuwwydsx3xq2uaxj1wbzo.png"><br><br>  Apr√®s cela, vous devez faire un assemblage.  Il se compose de plusieurs √©tapes: assemblage du backend et du frontend, test et livraison au prod. <br><br><h3>  3. Construisez le backend et le frontend </h3><br>  Le backend et le frontend assembly sont deux t√¢ches parall√®les qui sont effectu√©es dans le syst√®me GitLab Runner.  Sa configuration de l'assemblage d'origine r√©side dans le m√™me r√©f√©rentiel. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tutoriel pour √©crire un script YAML √† construire dans GitLab</a> . <br><br>  GitLab Runner r√©cup√®re le code du r√©f√©rentiel souhait√©, collecte la commande de g√©n√©ration d'application Java et l'envoie au registre Docker.  Ici, nous collectons le backend et le frontend, obtenons les images Docker, que nous mettons dans le r√©f√©rentiel c√¥t√© client.  Pour g√©rer les images Doker, utilisez le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plugin Gradle</a> . <br><br>  Nous synchronisons les versions de nos images avec la version de la version, qui sera publi√©e dans Docker.  Pour un fonctionnement fluide, nous avons effectu√© plusieurs r√©glages: <br><br>  1. Entre l'environnement de test et les conteneurs d'√©picerie ne sont pas remont√©s.  Nous avons fait le param√©trage pour que le m√™me conteneur puisse fonctionner sans reconstruire avec tous les param√®tres, variables d'environnement et services √† la fois dans l'environnement de test et dans le prod. <br><br>  2. Pour mettre √† jour l'application via Helm, vous devez sp√©cifier sa version.  Nous avons l'assemblage backend, le frontend et la mise √† jour de l'application - ce sont trois t√¢ches diff√©rentes, il est donc important d'utiliser la m√™me version de l'application partout.  Pour cette t√¢che, nous utilisons des donn√©es de l'historique Git, car nous avons une configuration de cluster K8S et les applications sont dans le m√™me r√©f√©rentiel Git. <br><br>  Nous obtenons la version de l'application √† partir des r√©sultats de la commande <br>  <code>git describe --tags --abbrev=7</code> . <br><br><h3>  4. D√©ploiement automatique de toutes les modifications dans un environnement de test (UAT) </h3><br>  L'√©tape suivante de ce script de g√©n√©ration consiste √† mettre √† jour automatiquement le cluster K8S.  Cela se produit √† condition que l'application enti√®re soit assembl√©e et que tous les artefacts soient publi√©s dans le Docker Registry.  Apr√®s cela, la mise √† jour de l'environnement de test d√©marre. <br><br>  La mise √† jour du cluster est lanc√©e √† l'aide de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Helm Update</a> .  Si, par cons√©quent, quelque chose s'est mal pass√©, Helm annulera automatiquement et ind√©pendamment tous ses changements.  Son travail n'a pas besoin d'√™tre contr√¥l√©. <br><br>  Avec l'assemblage, nous livrons la configuration du cluster K8S.  Par cons√©quent, l'√©tape suivante consiste √† le mettre √† jour: configMaps, d√©ploiements, services, secrets et toute autre configuration K8S que nous avons modifi√©e. <br><br>  Apr√®s cela, Helm lance RollOut mettre √† jour l'application elle-m√™me dans un environnement de test.  Avant que l'application ne soit d√©ploy√©e sur le prod.  Cette op√©ration permet aux utilisateurs de v√©rifier manuellement les fonctionnalit√©s m√©tier que nous avons publi√©es dans l'environnement de test. <br><br><h3>  5. D√©ployez automatiquement toutes les modifications dans Prod </h3><br>  Pour d√©ployer la mise √† jour dans l'environnement du produit, il ne reste plus qu'√† cliquer sur un bouton dans GitLab - et les conteneurs sont imm√©diatement livr√©s √† l'environnement du produit. <br><br>  Une seule et m√™me application peut fonctionner sans reconstruction dans diff√©rents environnements - test et production.  Nous utilisons les m√™mes artefacts sans rien changer dans l'application, et nous d√©finissons les param√®tres de l'ext√©rieur. <br><br>  Le param√©trage flexible des param√®tres d'application d√©pend de l'environnement dans lequel cette application sera ex√©cut√©e.  Nous avons supprim√© tous les param√®tres d'environnement: tout est param√©tr√© via la configuration K8S et les param√®tres Helm.  Lorsque Helm d√©ploie un assemblage dans un environnement de test, les param√®tres de test s'appliquent √† lui et les param√®tres de produit s'appliquent √† l'environnement de produit. <br><br>  Le plus difficile a √©t√© de param√©trer tous les services et variables utilis√©s, qui d√©pendent de l'environnement, et de les traduire en variables d'environnement et en description-configuration des param√®tres d'environnement pour Helm. <br><br>  Les param√®tres d'application utilisent des variables d'environnement.  Leurs valeurs sont d√©finies dans des conteneurs √† l'aide de la configmap K8S, qui est bas√©e sur des mod√®les Go.  Par exemple, d√©finir une variable d'environnement sur un nom de domaine peut se faire comme ceci: <br><br><pre> <code class="plaintext hljs">APP_EXTERNAL_DOMAIN: {{ (pluck .Values.global.env .Values.app.properties.app_external_domain | first) }}</code> </pre> <br>  <b>.Values.global.env</b> - le nom de l'environnement (prod, stage, UAT) est stock√© dans cette variable. <br>  <b>.Values.app.properties.app_external_domain</b> - dans cette variable nous dans le fichier .Values.yaml d√©finissons le domaine souhait√© <br><br>  Lors de la mise √† jour de l'application, Helm cr√©e le fichier configmap.yaml √† partir des mod√®les et remplit la valeur APP_EXTERNAL_DOMAIN avec la valeur requise en fonction de l'environnement dans lequel la mise √† jour de l'application d√©marre.  Cette variable est d√©j√† d√©finie dans le conteneur.  L'acc√®s se fait depuis l'application, respectivement, dans chaque environnement de l'application il y aura une valeur diff√©rente de cette variable. <br><br>  Relativement r√©cent, Spring Cloud a introduit le support K8S, y compris le travail avec configMaps: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Spring Cloud Kubernetes</a> .  Bien que le projet se d√©veloppe activement et change radicalement, nous ne pouvons pas l'utiliser en production.  Mais nous surveillons activement son √©tat et l'utilisons dans les configurations DEV.  D√®s qu'il se stabilise, nous passerons de l'utilisation de variables d'environnement √† celui-ci. <br><br><h3>  Total </h3><br>  Ainsi, le d√©ploiement continu est op√©rationnel.  Toutes les mises √† jour se produisent au clic d'un bouton.  La livraison des modifications de l'environnement alimentaire est automatique.  Et, surtout, les mises √† jour n'arr√™tent pas le syst√®me. <br><br><img src="https://habrastorage.org/webt/3j/aq/bs/3jaqbs3llw95qie5ienc8efaymw.jpeg"><br><br><h3>  Plans futurs: migration automatique de la base </h3><br>  Nous avons pens√© √† mettre √† niveau la base de donn√©es et √† pouvoir annuler ces modifications.  Apr√®s tout, deux versions diff√©rentes de l'application fonctionnent simultan√©ment: l'ancienne fonctionne et la nouvelle monte.  Et nous ne d√©sactiverons l'ancienne que lorsque nous serons convaincus que la nouvelle version fonctionne.  La migration de la base de donn√©es doit permettre de travailler avec les deux versions de l'application. <br><br>  Par cons√©quent, nous ne pouvons pas simplement changer le nom de la colonne ou d'autres donn√©es.  Mais nous pouvons cr√©er une nouvelle colonne, y copier les donn√©es de l'ancienne colonne et y √©crire des d√©clencheurs qui, lorsque les donn√©es seront mises √† jour, les copieront et les mettront √† jour simultan√©ment dans une autre colonne.  Et apr√®s le d√©ploiement r√©ussi de la nouvelle version de l'application, apr√®s la p√©riode de support post-lancement, nous pouvons supprimer l'ancienne colonne et le d√©clencheur devenu inutile. <br><br>  Si la nouvelle version de l'application ne fonctionne pas correctement, nous pouvons revenir √† la version pr√©c√©dente, y compris la version pr√©c√©dente de la base de donn√©es.  En un mot, nos modifications permettront de travailler simultan√©ment avec plusieurs versions de l'application. <br><br>  Nous pr√©voyons d'automatiser la migration de la base de donn√©es via le travail K8S en l'int√©grant dans le processus du CD.  Et nous partagerons s√ªrement cette exp√©rience sur Habr√©. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr447812/">https://habr.com/ru/post/fr447812/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr447802/index.html">Isabella 2</a></li>
<li><a href="../fr447804/index.html">Dwarf Fortress abandonne les graphiques de texte, mais pas son essence</a></li>
<li><a href="../fr447806/index.html">Acc√©l√©rer les performances des r√©seaux de neurones √† l'aide du hachage</a></li>
<li><a href="../fr447808/index.html">Apprendre √† √©crire des contrats intelligents Waves sur RIDE et RIDE4DAPPS. Partie 2 (DAO - Organisme autonome d√©centralis√©)</a></li>
<li><a href="../fr447810/index.html">Analytics pour Azure DevOps Services est d√©sormais accessible au public</a></li>
<li><a href="../fr447814/index.html">O√π et comment ouvrir un centre de d√©veloppement?</a></li>
<li><a href="../fr447816/index.html">Un peu de magie de mod√®le C ++ et CRTP pour contr√¥ler l'exactitude des actions du programmeur lors de la compilation</a></li>
<li><a href="../fr447818/index.html">AgileDays 2019</a></li>
<li><a href="../fr447820/index.html">Importez des mod√®les 3D dans Unity et les pi√®ges</a></li>
<li><a href="../fr447822/index.html">Presque vir√©. Comment j'ai construit le d√©partement d'analyse de Yandex</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>