<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôéüèº üîÅ ü§Ø Telefone SIP no STM32F7-Discovery üë∂üèª üëêüèæ üöè</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° pessoal. 

 Algum tempo atr√°s, escrevemos sobre como conseguimos lan√ßar um telefone SIP no STM32F4-Discovery com 1 MB de ROM e 192 KB de RAM) com ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Telefone SIP no STM32F7-Discovery</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/embox/blog/431134/">  Ol√° pessoal. <br><br>  Algum tempo atr√°s, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">escrevemos</a> sobre como conseguimos lan√ßar um telefone SIP no STM32F4-Discovery com 1 MB de ROM e 192 KB de RAM) com base na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Embox</a> .  Aqui devo dizer que essa vers√£o era m√≠nima e conectava dois telefones diretamente sem servidor e com transmiss√£o de voz apenas em uma dire√ß√£o.  Portanto, decidimos lan√ßar um telefone mais completo com uma chamada atrav√©s do servidor, transmiss√£o de voz em ambas as dire√ß√µes, mas, ao mesmo tempo, manter o menor tamanho de mem√≥ria poss√≠vel. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/W6wuEIZJf8o" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><a name="habracut"></a><br>  Para o telefone, foi decidido escolher o aplicativo <i>simple_pjsua</i> como parte da biblioteca PJSIP.  Esta √© uma aplica√ß√£o m√≠nima que pode se registrar no servidor, receber e atender chamadas.  Abaixo, darei uma descri√ß√£o imediata de como executar isso no STM32F7-Discovery. <br><br><h3>  Como executar </h3><br><ol><li>  Configurando o Embox <pre><code class="bash hljs">make confload-platform/pjsip/stm32f7cube</code> </pre> </li><li>  No arquivo conf / mods.config, defina a conta SIP desejada. <br><br><pre> <code class="bash hljs">include platform.pjsip.cmd.simple_pjsua_imported( sip_domain=<span class="hljs-string"><span class="hljs-string">"server"</span></span>, sip_user=<span class="hljs-string"><span class="hljs-string">"username"</span></span>, sip_passwd=<span class="hljs-string"><span class="hljs-string">"password"</span></span>)</code> </pre><br>  onde <i>server</i> √© o servidor SIP (por exemplo, sip.linphone.org), <i>nome de usu√°rio</i> e <i>senha</i> s√£o o nome de usu√°rio e a senha da conta. <br></li><li>  Crie o Embox com o comando <i>make</i> .  Sobre o firmware da placa que temos no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">wiki</a> e no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo</a> . <br></li><li>  Execute o comando ‚Äúsimple_pjsua_imported‚Äù no console da Embox <br><br><pre> <code class="bash hljs">00:00:12.870 pjsua_acc.c ....SIP outbound status <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> acc 0 is not active 00:00:12.884 pjsua_acc.c ....sip:alexk2222@sip.linphone.org: registration success, status=200 (Registration succes 00:00:12.911 pjsua_acc.c ....Keep-alive timer started <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> acc 0, destination:91.121.209.194:5060, interval:15s</code> </pre><br></li><li>  Por fim, resta inserir alto-falantes ou fones de ouvido na sa√≠da de √°udio e conversar em dois pequenos microfones MEMS pr√≥ximos √† tela.  Chamamos do Linux atrav√©s do aplicativo simple_pjsua, pjsua.  Bem, ou voc√™ pode qualquer outro tipo de linphone. <br></li></ol><br>  Tudo isso √© descrito em nosso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">wiki</a> . <br><br><h3>  Como chegamos a isso? </h3><br>  Ent√£o, inicialmente surgiu a quest√£o sobre a escolha de uma plataforma de hardware.  Como ficou claro que o STM32F4-Discovery n√£o caberia na mem√≥ria, o STM32F7-Discovery foi escolhido.  Ela tem uma unidade flash de 1 MB e 256 KB de RAM (+ 64 mem√≥ria r√°pida especial, que tamb√©m usaremos).  Tamb√©m n√£o √© muito para chamadas atrav√©s do servidor, mas decidiu tentar entrar. <br><br>  Convencionalmente, a tarefa foi dividida em v√°rias etapas: <br><br><ul><li>  Executando o PJSIP no QEMU.  Era conveniente para depura√ß√£o, e j√° t√≠nhamos suporte ao codec AC97 l√°. </li><li>  Grava√ß√£o e reprodu√ß√£o de voz no QEMU e STM32. </li><li>  Portando um aplicativo <i>simple_pjsua</i> de dentro do PJSIP.  Ele permite que voc√™ se registre no servidor SIP e fa√ßa chamadas. </li><li>  Implante seu pr√≥prio servidor baseado em Asterisk e teste nele, depois tente outros externos, como sip.linphone.org </li></ul><br>  O som no Embox funciona atrav√©s do Portaudio, que tamb√©m √© usado no PISIP.  Os primeiros problemas apareceram no QEMU - WAV tocaram bem em 44100 Hz, mas algo obviamente deu errado em 8000.  Aconteceu que se tratava de definir a frequ√™ncia - por padr√£o, era 44100 no equipamento, e isso n√£o mudou programaticamente conosco. <br><br>  Aqui, provavelmente vale a pena explicar um pouco como o som √© reproduzido em geral.  A placa de som pode definir algum ponteiro para um peda√ßo de mem√≥ria a partir do qual voc√™ deseja reproduzir ou gravar em uma frequ√™ncia predeterminada.  Ap√≥s o t√©rmino do buffer, uma interrup√ß√£o √© gerada e a execu√ß√£o continua a partir do pr√≥ximo buffer.  O fato √© que esses buffers precisam ser preenchidos com anteced√™ncia antes que o anterior seja reproduzido.  Este problema iremos encontrar mais adiante no STM32F7. <br><br>  Em seguida, alugamos um servidor e implantamos o Asterisk nele.  Como era necess√°rio depurar muito, mas n√£o queria falar muito no microfone, era necess√°rio executar a reprodu√ß√£o e a grava√ß√£o autom√°ticas.  Para fazer isso, corrigimos simple_pjsua para que fosse poss√≠vel inserir arquivos no lugar de dispositivos de √°udio.  No PJSIP, isso √© feito de maneira simples, uma vez que eles t√™m o conceito de porta, que pode ser um dispositivo ou um arquivo.  E essas portas podem ser conectadas de forma flex√≠vel a outras portas.  Voc√™ pode ver o c√≥digo em nosso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">reposit√≥rio</a> pjsip.  Como resultado, o esquema foi o seguinte.  Criei duas contas no servidor Asterisk - para Linux e Embox.  Em seguida, o comando <i>simple_pjsua_imported</i> √© executado na Embox, a Embox √© registrada no servidor, ap√≥s o que chamamos Embox do Linux.  No momento da conex√£o, verificamos no servidor Asterisk se toda a conex√£o est√° estabelecida e, ap√≥s algum tempo, eles devem ouvir o som do Linux na Embox, e no Linux salvamos o arquivo que √© reproduzido na Embox. <br><br>  Depois que funcionou no QEMU, passamos a migrar para o STM32F7-Discovery.  O primeiro problema - eles n√£o entraram em 1 MB de ROM sem a otimiza√ß√£o inclu√≠da do compilador "-Os" em termos de tamanho da imagem.  Portanto, inclui "-Os".  Al√©m disso, o patch desativou o suporte ao C ++, por isso √© necess√°rio apenas para o pjsua e usamos simple_pjsua. <br><br>  Depois de <i>ajustar o simple_pjsua</i> , decidimos que agora h√° chances de inici√°-lo.  Mas primeiro, voc√™ tinha que lidar com a grava√ß√£o e reprodu√ß√£o de voz.  Pergunta - onde escrever?  Escolhemos uma mem√≥ria externa - SDRAM (128 MB).  Voc√™ pode tentar voc√™ mesmo: <br><br>  Cria WAV est√©reo com uma frequ√™ncia de 16000 Hz e uma dura√ß√£o de 10 segundos: <br><br><pre> <code class="bash hljs">record -r 16000 -c 2 -d 10000 -m C0000000</code> </pre><br>  Perdemos: <br><br><pre> <code class="bash hljs">play -m C0000000</code> </pre><br>  Houve dois problemas.  O primeiro com um codec √© o WM8994, e possui um conceito de slot, e esses slots s√£o 4. Portanto, por padr√£o, se n√£o estiver configurado, ao reproduzir √°udio, a reprodu√ß√£o ocorre nos quatro slots.  Portanto, em uma frequ√™ncia de 16000 Hz, recebemos 8000 Hz, mas em 8000 Hz a reprodu√ß√£o simplesmente n√£o funcionou.  Quando apenas os slots 0 e 2 foram selecionados, funcionou como deveria.  Outro problema foi a interface de √°udio no STM32Cube, na qual a sa√≠da de √°udio funciona atrav√©s da SAI (Serial Audio Interface) de forma s√≠ncrona com a entrada de √°udio (n√£o entendeu os detalhes, mas acontece que eles compartilham um rel√≥gio comum e, de alguma forma, o √°udio √© anexado ao inicializar a sa√≠da de √°udio entrada).  Ou seja, eles n√£o podem ser iniciados separadamente; portanto, eles fizeram o seguinte - a entrada e a sa√≠da de √°udio sempre funcionam (incluindo interrup√ß√µes s√£o geradas).  Mas quando nada se perde no sistema, simplesmente inserimos um buffer vazio na sa√≠da de √°udio e, quando a reprodu√ß√£o come√ßa, honestamente come√ßamos a preench√™-lo. <br><br>  Al√©m disso, eles encontraram o fato de que o som durante a grava√ß√£o de voz era muito silencioso.  Isso se deve ao fato de que os microfones MEMS no STM32F7-Discovery de alguma forma n√£o funcionam bem em frequ√™ncias abaixo de 16000 Hz.  Portanto, definimos 16000 Hz, mesmo que 8000 Hz ocorram.  Para fazer isso, a verdade era adicionar uma convers√£o de software de uma frequ√™ncia para outra. <br><br>  Em seguida, tive que aumentar o tamanho do heap, localizado na RAM.  De acordo com nossas estimativas, o pjsip exigia cerca de 190 Kb e s√≥ t√≠nhamos cerca de 100 Kb.  Aqui eu tive que usar um pouco de mem√≥ria externa - SDRAM (cerca de 128 Kb). <br><br>  Ap√≥s todas essas edi√ß√µes, vi os primeiros pacotes entre Linux e Embox e ouvi um som!  Mas o som era terr√≠vel, nada parecido com o QEMU, nada podia ser descoberto.  Ent√£o pensamos sobre o que poderia ser o problema.  A depura√ß√£o mostrou que a Embox simplesmente n√£o tem tempo para preencher / descarregar buffers de √°udio.  Enquanto o pjsip est√° processando um quadro, duas interrup√ß√µes ocorreram antes da conclus√£o do processamento do buffer, o que √© muito.  O primeiro pensamento para acelerar foi otimizar o compilador, mas ele j√° estava inclu√≠do no PJSIP.  O segundo √© um ponto flutuante de hardware, falamos sobre isso no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo</a> .  Mas, como a pr√°tica demonstrou, a FPU n√£o deu um aumento significativo na velocidade.  O pr√≥ximo passo foi priorizar os threads.  A Embox possui diferentes estrat√©gias de agendamento, e eu inclu√≠ uma que suporta prioridades e define fluxos de √°udio com a prioridade mais alta.  Tamb√©m n√£o ajudou. <br><br>  A pr√≥xima foi a ideia de que estamos trabalhando com mem√≥ria externa e seria bom mover estruturas para l√°, que s√£o acessadas com muita frequ√™ncia.  Fiz uma an√°lise preliminar de quando e sob o que <i>simple_pjsua</i> aloca mem√≥ria.  Verificou-se que dos 190 Kb, os primeiros 90 Kb s√£o alocados para as necessidades internas do PJSIP e n√£o s√£o acessados ‚Äã‚Äãcom muita frequ√™ncia.  Em seguida, durante uma chamada recebida, a fun√ß√£o pjsua_call_answer √© chamada, na qual os buffers para trabalhar com quadros de entrada e sa√≠da s√£o alocados.  Foi cerca de 100 kb.  E aqui agimos da seguinte maneira.  Antes da chamada, os dados s√£o colocados na mem√≥ria externa.  Assim que a chamada - substitua imediatamente a pilha por outra - na RAM.  Assim, todos os dados "quentes" foram transferidos para uma mem√≥ria mais r√°pida e previs√≠vel. <br><br>  Como resultado, tudo isso junto permitiu iniciar o <i>simple_pjsua</i> e fazer uma chamada atrav√©s do servidor.  E ent√£o atrav√©s de outros servidores, como sip.linphone.org. <br><br><h3>  Conclus√µes </h3><br>  Como resultado, acabou rodando <i>simple_pjsua</i> com transmiss√£o de voz nas duas dire√ß√µes atrav√©s do servidor.  O problema com SDRAM de 128 Kb gasto adicionalmente pode ser resolvido usando um Cortex-M7 um pouco mais poderoso (por exemplo, STM32F769NI com 512 Kb de RAM), mas, ao mesmo tempo, ainda n√£o temos esperan√ßa de caber em 256 Kb :) Ficamos felizes se algu√©m estiver interessado e ainda melhor - tente.  Todas as fontes, como sempre, est√£o em nosso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">reposit√≥rio</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt431134/">https://habr.com/ru/post/pt431134/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt431124/index.html">"A ci√™ncia de dados, como matem√°tica e f√≠sica, √© outra maneira de explorar o mundo ao seu redor."</a></li>
<li><a href="../pt431126/index.html">Por que voc√™ n√£o deve economizar no PM profissional</a></li>
<li><a href="../pt431128/index.html">Hacking DDR3 SPD</a></li>
<li><a href="../pt431130/index.html">Semana 48 de seguran√ßa: Hackear sexta-feira negra</a></li>
<li><a href="../pt431132/index.html">Reuters: R√∫ssia aumentar√° multas para empresas de Internet para 1% da receita anual</a></li>
<li><a href="../pt431136/index.html">Terabytes sem peso no bolso - o futuro est√° aqui? Explorando os recursos do HyperX SAVAGE EXO</a></li>
<li><a href="../pt431138/index.html">Biometria com a chave Rostelecom: como o FSB lan√ßou a criptografia russa pela primeira vez em lojas de aplicativos</a></li>
<li><a href="../pt431140/index.html">Relat√≥rio da metapa Go in Production: v√≠deo, fotos, apresenta√ß√µes</a></li>
<li><a href="../pt431142/index.html">Como executar o SQL Profiler Trace √† noite, em um hor√°rio espec√≠fico?</a></li>
<li><a href="../pt431144/index.html">Microfone Far Fields (matriz de microfone) - her√≥i impercept√≠vel em uma coluna inteligente</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>