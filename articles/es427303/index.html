<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèæ‚Äçüåæ üëµüèΩ üå≤ Retrasando Windows Parte 2: Creando Procesos üòΩ üí´ üòû</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Windows ha sido culpado por la lentitud de las operaciones de archivos y la creaci√≥n de procesos. ¬øAlguna vez has tratado de hacerlos a√∫n m√°s lentos? ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Retrasando Windows Parte 2: Creando Procesos</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/427303/"><img src="https://habrastorage.org/getpro/habr/post_images/b55/8f1/93c/b558f193cbc015bf35b2b068ff1c8e65.jpg"><br><br>  Windows ha sido culpado por la lentitud de las operaciones de archivos y la creaci√≥n de procesos.  ¬øAlguna vez has tratado de hacerlos a√∫n m√°s lentos?  ¬°Este art√≠culo mostrar√° la t√©cnica de c√≥mo ralentizar gradualmente la creaci√≥n de procesos en Windows (hasta el infinito) de forma invisible para la mayor√≠a de los usuarios! <br><br>  Y, por supuesto, el art√≠culo tambi√©n le dir√° c√≥mo detectar y evitar este problema. <br><br>  Este es un problema real que encontr√© a principios de a√±o, y el art√≠culo explica c√≥mo lo descubr√≠ y encontr√© una soluci√≥n.  Art√≠culos anteriores sobre la desaceleraci√≥n de Windows: <br><br><ul><li>  Retraso de Windows, parte 0: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">desaceleraci√≥n arbitraria de VirtualAlloc</a> </li><li>  Retrasando Windows, parte 1: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">acceso a archivos</a> </li></ul><a name="habracut"></a><br><h1>  Algo anda mal </h1><br>  No busco problemas, pero creo que los encontr√©.  Tal vez porque recojo Chrome de la fuente cientos de veces durante el fin de semana, o tengo mala suerte en la vida.  Supongo que nunca lo sabremos.  De una forma u otra, este art√≠culo describe el <i>quinto</i> problema grave que encontr√© en Windows al construir Chrome. <br><br><ol><li>  Serializaci√≥n no planificada, lo que conduce a una interfaz de usuario de bloqueo completa: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"procesador de 24 n√∫cleos, pero no puedo mover el cursor"</a> . </li><li>  Un descriptor de proceso se filtr√≥ en uno de los complementos de Microsoft para Windows: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"Los procesos de zombis consumen tu memoria"</a> . </li><li>  Un error de correcci√≥n de larga data en el cach√© de archivos de Windows: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"¬øError del compilador?</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Error de enlazador?</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Error del kernel de Windows ".</a> </li><li>  Falla de rendimiento cuando se usan incorrectamente las notificaciones de archivos: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"Retraso de Windows, Parte 1: acceso a archivos"</a> . </li><li>  Y esto: una extra√±a soluci√≥n arquitect√≥nica que ralentiza la creaci√≥n de procesos con el tiempo. </li></ol><br><h1>  Raro seguimiento de fallas </h1><br>  Las computadoras deben ser confiables y predecibles, y algo m√°s me molesta.  Si construyo Chrome varios cientos de veces seguidas, me gustar√≠a ver cada ensamblaje exitoso.  Por lo tanto, cuando nuestro proceso de compilaci√≥n distribuida (gomacc.exe) a veces falla, quiero investigar esto.  He configurado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la grabaci√≥n autom√°tica de volcados de memoria</a> , por lo que veo que se producen bloqueos cuando se detecta la corrupci√≥n del mont√≥n.  Una forma f√°cil de verificar es habilitar el mont√≥n de p√°ginas para que el mont√≥n de Windows coloque cada asignaci√≥n de memoria en una p√°gina separada.  Esto significa que los desbordamientos de uso libre y de b√∫fer causan una falla instant√°nea en lugar de un da√±o dif√≠cil de diagnosticar.  Anteriormente escrib√≠ acerca de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">habilitar pageheap usando App Verifier</a> . <br><br>  El verificador de aplicaciones ralentiza el programa por dos razones: las asignaciones de memoria se ralentizan y las asignaciones alineadas a p√°ginas pr√°cticamente desactivan la memoria cach√© del procesador.  Por lo tanto, una ligera desaceleraci√≥n en el ensamblaje era predecible, y sucedi√≥. <br><br>  Pero cuando llegu√© m√°s tarde, la asamblea pareci√≥ detenerse por completo.  Despu√©s de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aproximadamente 7000 pasos de ensamblaje</a> , no se not√≥ ning√∫n progreso. <br><br><h1>  O (n ^ 2) generalmente no es bueno </h1><br>  Resulta que a Application Verifier le gusta crear archivos de registro.  Y no importa que nadie est√© mirando estos archivos, los crea por si acaso.  Y estos archivos deben tener nombres √∫nicos.  Estoy seguro de que me pareci√≥ una buena idea dar nombres num√©ricos a los registros en orden ascendente, como gomacc.exe.0.dat, gomacc.exe.1.dat, etc. <br><br>  Para obtener nombres num√©ricos en orden ascendente, debe determinar qu√© n√∫mero usar a continuaci√≥n.  La forma m√°s f√°cil es <i>probar</i> posibles nombres / n√∫meros hasta encontrar uno que a√∫n no se haya utilizado.  Es decir, intente crear un nuevo archivo llamado gomacc.exe.0.dat, y si ya existe, intente gomacc.exe.1.dat y as√≠ sucesivamente. <br><br>  ¬øQu√© podr√≠a salir mal? <br><br><h1>  De hecho, en el peor de los casos, todo es bastante malo. </h1><br>  Resulta que si realiza una b√∫squeda lineal de un nombre de archivo no utilizado al crear un proceso, entonces iniciar N procesos requiere operaciones <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">O (N ^ 2)</a> .  El sentido com√∫n dicta que los algoritmos O (N ^ 2) son demasiado lentos si no puede garantizar que N siempre permanezca relativamente peque√±o. <br><br>  La gravedad de la situaci√≥n depender√° del tiempo que lleve verificar la existencia del archivo.  Tom√© medidas y descubr√≠ que en Windows toma alrededor de 80 microsegundos (80 Œºs o 0.08 ms).  Iniciar el primer proceso es r√°pido, pero comenzar el proceso n√∫mero 1000 requiere escanear 1000 archivos de registro ya creados.  Tarda 80 ms, y luego a√∫n m√°s. <br><br>  Una compilaci√≥n t√≠pica de Chrome requiere que el compilador se ejecute unas 30,000 veces.  Cada ejecuci√≥n del compilador requiere el escaneo de N archivos de registro creados previamente, 0.08 ms para verificar cada archivo.  Una b√∫squeda lineal para el siguiente nombre de archivo de registro disponible significa que ejecutar N procesos requiere (N ^ 2) / 2 verificaciones de la existencia del archivo, es decir, 30,000 * 30,000 / 2, que es de 450 millones.  Dado que cada verificaci√≥n de la existencia de un archivo toma 0.08 ms, esto es 36 millones de milisegundos, o 36,000 segundos.  Es decir, el tiempo de compilaci√≥n de Chrome, que generalmente es de cinco a diez minutos, aumentar√° en otras diez horas. <br><br>  Maldici√≥n <br><br>  Al escribir este art√≠culo, reproduje el error ejecutando un archivo ejecutable vac√≠o aproximadamente 7000 veces, y vi una curva O (n ^ 2) clara como esta: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/284/66c/102/28466c1029f0ee82d675bd6547f40811.png"><br><br>  Por extra√±o que parezca, si tomamos la traza ETW y observamos el tiempo promedio de llamadas a CreateFile, entonces para casi todos los archivos el resultado es inferior a cinco microsegundos (un promedio de 4.386 Œºs en el ejemplo a continuaci√≥n): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ac8/5f7/4d4/ac85f74d465251bed5287d2534cd397e.png"><br><br>  Parece que esto muestra solo la restricci√≥n ETW en el seguimiento de E / S de archivos.  Los eventos de E / S de archivos rastrean solo el nivel m√°s bajo del sistema de archivos y, sobre Ntfs.sys, hay muchos m√°s niveles, incluidos FLTMGR.SYS y ntoskrnl.exe.  Sin embargo, la desaceleraci√≥n no puede ocultarse por completo: el uso de la CPU es visible en el gr√°fico de uso de la CPU.  La captura de pantalla siguiente muestra el intervalo de tiempo de 548 ms, que representa la creaci√≥n de un solo proceso.  B√°sicamente, todo el tiempo que lleva escanear unos 6850 posibles nombres de archivos de registro: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7a6/5e7/2d4/7a65e72d48e0527911fc9c1171212a1e.png"><br><br><h1>  ¬øTe ayudar√° un disco m√°s productivo? </h1><br>  No <br><br>  La cantidad de datos procesados ‚Äã‚Äães peque√±a, y la cantidad de escritura en el disco es a√∫n menor.  Durante mis pruebas para reproducir un error, el disco estaba casi completamente inactivo.  Este problema est√° relacionado con la CPU porque se almacenan en cach√© todos los datos relevantes del disco.  E incluso si los costos generales se redujeran en un orden de magnitud, seguir√≠an siendo demasiado grandes.  No puede mejorar el algoritmo O (N ^ 2). <br><br><h1>  Descubrimiento </h1><br>  Este problema en particular se puede detectar buscando en% userprofile% \ appverifierlogs archivos .dat.  En <i>general,</i> puede detectar una desaceleraci√≥n en la creaci√≥n de procesos al examinar el rastreo de ETW, y ahora sabe qu√© buscar. <br><br><h1>  Soluci√≥n </h1><br>  La soluci√≥n m√°s f√°cil es desactivar el registro.  Esto tambi√©n dejar√° de llenar el disco con gigabytes de registros.  Est√° deshabilitado por el siguiente comando: <br><br> <code>appverif.exe -logtofile disable</code> <br> <br>  Despu√©s de deshabilitar el registro, descubr√≠ que mis procesos comenzaron aproximadamente tres veces m√°s r√°pido (!) Que al comienzo de la prueba, y la desaceleraci√≥n desapareci√≥ por completo.  Se crean 7000 procesos verificados de Application Verifier en 1,5 minutos, no en 40 minutos.  Con mi archivo por lotes simple para pruebas y un proceso simple, veo las siguientes velocidades de creaci√≥n de procesos: <br><br><ul><li>  t√≠picamente 200 por segundo (5 ms por proceso) </li><li>  75 por segundo con Application Verifier habilitado pero registro deshabilitado (13 ms por proceso) </li><li>  40 por segundo con Application Verifier activado y el registro activado, al principio ... (25 ms por proceso, el tiempo aumenta gradualmente hasta el infinito) </li><li>  0.4 por segundo despu√©s de una compilaci√≥n de Chrome </li></ul><br>  Microsoft puede solucionar este problema abandonando el aumento mon√≥tono en el n√∫mero de archivos de registro.  Si usaran la fecha y hora actuales como un nombre de archivo (hasta un milisegundo o en una resoluci√≥n m√°s alta), obtendr√≠an nombres de registros m√°s sem√°nticamente significativos que se crean muy r√°pidamente pr√°cticamente sin l√≥gica de b√∫squeda para un archivo √∫nico. <br><br>  Pero Application Verifier ya no es compatible, y los archivos de registro son in√∫tiles de todos modos, as√≠ que deshabil√≠telos. <br><br><h1>  Informaci√≥n de apoyo </h1><br>  Los archivos por lotes y una secuencia de comandos para recrear el error despu√©s de habilitar Application Verifier para empty.exe se pueden encontrar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . <br><br>  El rastro ETW de alrededor del final del experimento est√° <a href="">aqu√≠</a> . <br><br>  Otros enlaces: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Datos de tiempo sin procesar utilizados para crear un gr√°fico.</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Discusi√≥n sobre Reddit</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Discusi√≥n en Hacker News</a> <br><br>  Para ver ejemplos de otros algoritmos O (n ^ 2) que se comercializan, consulte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Accidentally Quadratic</a> <br><br>  Para un disfrute m√°s mundano, vea una compilaci√≥n de video de mis <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">19 formas diferentes de llegar al trabajo en septiembre</a> : estaba demasiado ocupado para continuar el experimento este mes. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es427303/">https://habr.com/ru/post/es427303/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es427293/index.html">Patrones de dise√±o de JavaScript</a></li>
<li><a href="../es427295/index.html">Funciones de curr√≠culum de JavaScript</a></li>
<li><a href="../es427297/index.html">Apache Ignite + Apache Spark Data Frames: juntos m√°s divertido</a></li>
<li><a href="../es427299/index.html">¬øVamos a buscar algo m√°s para coleccionar? Constructor 3 en 1 "Flota Lunar"</a></li>
<li><a href="../es427301/index.html">Base de datos de bloqueo de GitHub</a></li>
<li><a href="../es427307/index.html">Pr√°ctica de prueba de backend de Java + Rest-Assured</a></li>
<li><a href="../es427309/index.html">C√≥mo PVS-Studio result√≥ ser m√°s atento que tres programadores y medio</a></li>
<li><a href="../es427311/index.html">C√≥mo convertirse en un centro de datos si tiene m√°s de 40 a√±os y no es un programador</a></li>
<li><a href="../es427313/index.html">C√≥mo SoftBank invierte $ 50 mil millones al a√±o en nuevas empresas y por qu√© desconcierta a los inversores</a></li>
<li><a href="../es427315/index.html">Sala de lectura de Izba o una selecci√≥n de literatura profesional.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>