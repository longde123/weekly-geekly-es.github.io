<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôåüèΩ üßùüèª üë¶üèΩ Apprentissage automatique pour Vertica üí≤ üòª ‚õàÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Annotation 
 Dans cet article, je veux partager ma propre exp√©rience avec l'apprentissage automatique dans un entrep√¥t de donn√©es sur Vertica. 

 Pour...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Apprentissage automatique pour Vertica</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/436306/"><h2>  Annotation </h2><br>  Dans cet article, je veux partager ma propre exp√©rience avec l'apprentissage automatique dans un entrep√¥t de donn√©es sur Vertica. <br><br>  Pour √™tre honn√™te, je ne suis pas un analyste expert qui peut d√©crire en d√©tail toute la vari√©t√© des m√©thodes de recherche et des algorithmes de pr√©diction de donn√©es.  Mais malgr√© tout, √©tant un expert de Vertica et ayant une exp√©rience de base avec ML, j'essaierai de parler des fa√ßons de travailler avec l'analyse pr√©dictive dans Vertica en utilisant la fonctionnalit√© de serveur int√©gr√©e et le langage R. <br><br><h2>  Biblioth√®que d'apprentissage automatique Vertica </h2><br>  √Ä partir de la version 7, Vertica a √©t√© √©tendu avec la biblioth√®que Machine Learning, avec laquelle vous pouvez: <br><br><ul><li>  Pr√©parer des exemples de donn√©es pour l'apprentissage automatique </li><li> former des mod√®les d'apprentissage automatique sur des donn√©es pr√©par√©es; </li><li>  effectuer une analyse pr√©dictive des donn√©es de stockage sur des mod√®les d'apprentissage automatique enregistr√©s. </li></ul><br>  La biblioth√®que est livr√©e imm√©diatement compl√®te avec l'installation de Vertica pour toutes les versions, y compris la communaut√© gratuite.  Travailler avec est encadr√© sous la forme d'un appel √† des fonctions sous SQL, qui sont d√©crites en d√©tail dans la documentation avec des exemples d'utilisation sur des donn√©es de d√©monstration pr√©par√©es. <br><a name="habracut"></a><br><h2>  Un exemple de travail avec ML dans Vertica </h2><br>  Comme exemple simple du fonctionnement de ML, j'ai pris les donn√©es de d√©monstration de mtcars qui font partie de l'exemple de donn√©es ML pour Vertica.  Ces donn√©es comprennent deux tableaux: <br><br><ul><li>  mtcars_train - donn√©es pr√©par√©es pour la formation de mod√®les d'apprentissage automatique </li><li>  mtcars - donn√©es pour l'analyse </li></ul><br>  Regardons les donn√©es pour la formation: <br><br><pre><code class="sql hljs">=&gt;<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> mtcars_train;</code> </pre> <br><img src="https://habrastorage.org/webt/mu/4_/o0/mu4_o0ovpeupz4c3qkf1uvnegya.jpeg"><br><br>  Dans l'ensemble de donn√©es sur les mod√®les de voitures, leurs caract√©ristiques sont d√©crites.  Essayons de former le machine learning afin que, selon les caract√©ristiques des voitures, il soit possible de pr√©dire quel type de bo√Æte de vitesses est impliqu√© dans la voiture - une bo√Æte manuelle ou une bo√Æte de vitesses automatique.  Pour ce faire, nous devrons construire un mod√®le de r√©gression logistique sur les donn√©es pr√©par√©es, en trouvant la d√©pendance du type de bo√Æte du champ "am" et des champs de poids du v√©hicule "wt", du nombre de cylindres "cyl" et du nombre de vitesses dans la bo√Æte "gear": <br><br><pre> <code class="sql hljs">=&gt;<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> LOGISTIC_REG(<span class="hljs-string"><span class="hljs-string">'logistic_reg_mtcars'</span></span>, <span class="hljs-string"><span class="hljs-string">'mtcars_train'</span></span>, <span class="hljs-string"><span class="hljs-string">'am'</span></span>, <span class="hljs-string"><span class="hljs-string">'cyl, wt, gear'</span></span>); Finished in 19 iterations</code> </pre> <br>  La fonction appel√©e a analys√© la relation entre am et les champs cyl, wt, gear, a r√©v√©l√© la formule de d√©pendance et a √©crit le r√©sultat de la simulation de d√©pendance dans la base de donn√©es Vertica dans le mod√®le ¬´logistic_reg_mtcars¬ª.  En utilisant ce mod√®le enregistr√©, vous pouvez d√©sormais analyser les donn√©es sur les voitures et pr√©dire la disponibilit√© des bo√Ætes de vitesses automatiques. <br><br>  Les informations sur le mod√®le peuvent √™tre consult√©es: <br><br><pre> <code class="sql hljs">=&gt;<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> GET_MODEL_SUMMARY(<span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PARAMETERS</span></span> model_name=<span class="hljs-string"><span class="hljs-string">'logistic_reg_mtcars'</span></span>);</code> </pre> <br><img src="https://habrastorage.org/webt/hd/aj/gp/hdajgpkb3a4jvlq2-czafzt9mv0.jpeg"><br><br>  Maintenant, nous utilisons le mod√®le sur les donn√©es pour les voitures, enregistrant le r√©sultat dans un nouveau tableau: <br><br><pre> <code class="sql hljs">=&gt;<span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> mtcars_predict_results <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> car_model, am, PREDICT_LOGISTIC_REG(cyl, wt, gear <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PARAMETERS</span></span> model_name=<span class="hljs-string"><span class="hljs-string">'logistic_reg_mtcars'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">prediction</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> mtcars );</code> </pre> <br>  Et en comparant les valeurs r√©elles de am avec celles obtenues dans la pr√©diction de pr√©diction: <br><br><pre> <code class="sql hljs">=&gt;<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> mtcars_predict_results;</code> </pre> <br><img src="https://habrastorage.org/webt/48/rt/zh/48rtzhy3c4ahjfqrupulpfy_mqy.jpeg"><br><br>  Dans ce cas, la pr√©vision de 100% co√Øncidait avec le type r√©el de bo√Æte dans les mod√®les pr√©sent√©s.  Dans le cas de la pr√©paration de nouvelles donn√©es pour la formation, vous devrez supprimer et r√©enregistrer le mod√®le. <br><br><h2>  Fonctionnalit√© ML dans Vertica </h2><br>  La biblioth√®que Vertica ML prend en charge les types d'analyse pr√©dictive suivants: <br><br><ul><li>  <b>Pr√©vision:</b> <br><ul><li>  R√©gression lin√©aire </li><li>  For√™t al√©atoire pour la r√©gression </li><li>  SVM (Support Vector Machine) pour la r√©gression </li></ul></li><li>  <b>Classification:</b> <br><ul><li>  R√©gression logistique </li><li>  Bayes na√Øfs </li><li>  For√™t al√©atoire pour la classification </li><li>  SVM (Support Vector Machine) pour la classification </li></ul></li><li>  <b>Regroupement:</b> <br><ul><li>  k-means </li></ul></li></ul><br>  Pour pr√©parer les donn√©es pour la formation, les fonctionnalit√©s suivantes sont pr√©sent√©es: <br><br><ul><li>  √âquilibrage des donn√©es </li><li>  Nettoyage des √©missions </li><li>  Encodage des valeurs de colonne cat√©gorielles (textuelles) </li><li>  Remplacement des donn√©es manquantes </li><li>  Normalisation des donn√©es </li><li>  Analyse en composantes principales </li><li>  √âchantillonnage des donn√©es </li><li>  D√©composition en valeurs singuli√®res </li></ul><br>  Compte tenu de la fonctionnalit√© ML dans Vertica, nous pouvons dire que la biblioth√®que int√©gr√©e nous permet de r√©soudre un assez large √©ventail de probl√®mes, mais n'a pas le retard n√©cessaire pour √©tudier les mod√®les et les d√©pendances dans les donn√©es.  Il existe des fonctions pour pr√©parer les donn√©es pour l'apprentissage automatique, mais sans visualiser la distribution des donn√©es sous forme de graphiques, seuls les gourous de l'analyse ayant une connaissance approfondie des donn√©es analys√©es seront en mesure de ¬´pr√©parer¬ª ces donn√©es et de former des mod√®les d'apprentissage sur celles-ci. <br><br><h2>  R Studio avec Vertica </h2><br>  Pour une analyse pr√©dictive des donn√©es plus approfondie et interactive, le langage R est id√©alement adapt√©, qui dispose d'un environnement visuel pour travailler avec les donn√©es R Studio.  Les avantages tangibles de l'utilisation de R avec Vertica seront: <br><br><ul><li>  l'interactivit√© de l'environnement avec la possibilit√© d'enregistrer l'√©tat pour une analyse plus approfondie apr√®s la prochaine analyse; </li><li>  visualisation visuelle des donn√©es sous forme de tableaux et de graphiques; </li><li>  Puissance du langage R pour travailler avec des ensembles de donn√©es; </li><li>  une vari√©t√© d'algorithmes d'analyse pr√©dictive similaires √† ceux pr√©sent√©s dans Vertica ML. </li></ul><br>  Les inconv√©nients de travailler avec R avec des donn√©es volumineuses sont les besoins en RAM, la vitesse de travail avec des tableaux de donn√©es volumineux et la n√©cessit√© d'importer et d'exporter des donn√©es Vertica.  Ces lacunes sont couvertes par la possibilit√© d'incorporer des fonctions R √©crites pour une ex√©cution directe sur un cluster dans Vertica, qui sera d√©crite ci-dessous. <br><br><h2>  Une petite introduction √† R </h2><br>  Nous reproduirons les pr√©visions de bo√Ætes automatiques sur les donn√©es Vertica en utilisant R. Afin de ne pas effrayer les programmeurs peu familiers avec ce langage, je conduirai un petit cours d'un jeune combattant R. <br><br>  Ainsi, le langage R est le m√™me langage proc√©dural qui a des objets, des classes et des fonctions. <br>  Un objet peut √™tre un ensemble de donn√©es (vecteur, liste, jeu de donn√©es ...), une valeur (texte, nombre, date, heure ...) ou une fonction.  Pour les valeurs, les types num√©rique, cha√Æne, bool√©en et date-heure sont pris en charge.  Pour les jeux de donn√©es, la num√©rotation des tableaux commence √† 1, pas √† 0. <br><br>  Classiquement, au lieu de "=" dans R, l'op√©rateur d'affectation "&lt;-" est utilis√©.  Bien qu'il ne soit pas interdit d'utiliser l'affectation de l'autre c√¥t√© "-&gt;" et m√™me l'habituel "=".  L'op√©rateur "=" lui-m√™me est utilis√© lors de l'appel de fonctions pour sp√©cifier des param√®tres nomm√©s. <br><br>  Au lieu de "."  "$" est utilis√© pour acc√©der aux champs des ensembles de donn√©es.  Un point n'est pas un mot cl√© et est utilis√© dans les noms d'objets pour augmenter leur lisibilit√©.  Ainsi, ¬´my.data $ field¬ª sera d√©crypt√© sous la forme d'un tableau d'enregistrements du champ ¬´field¬ª de l'ensemble de donn√©es ¬´my.data¬ª. <br><br>  Vous pouvez utiliser des guillemets simples ou doubles pour encadrer des textes. <br><br>  <b>Plus important encore:</b> R est con√ßu pour travailler avec des ensembles de donn√©es.  M√™me si le code dit ¬´a &lt;-1¬ª, alors assurez-vous que R √† l'int√©rieur de lui-m√™me croit que ¬´a¬ª est un tableau de 1 √©l√©ment.  La conception du langage vous permet de travailler avec des ensembles de donn√©es comme avec des variables ordinaires: ajouter et soustraire, connecter et d√©connecter, filtrer par mesures.  La fa√ßon la plus simple de cr√©er un tableau listant ses √©l√©ments est d'appeler la fonction "c (√©l√©ments du tableau s√©par√©s par des virgules)".  Le nom "c" est apparemment pris comme abr√©viation courte pour Collection, mais je ne le dirai pas avec certitude. <br><br><h2>  Chargement des donn√©es d'un SGBD dans R </h2><br>  Pour utiliser RDBMS via ODBC pour R, vous devez installer le package RODBC.  Il peut √™tre install√© dans R Studio sur l'onglet packages ou en utilisant la commande R: <br><br><pre> <code class="plaintext hljs">install.packages('RODBC') library('RODBC')</code> </pre> <br><br>  Maintenant, nous pouvons travailler avec Vertica.  Nous cr√©ons un alias ODBC sur le serveur et obtenons les donn√©es de test et l'ensemble de donn√©es complet pour la voiture: <br><br><pre> <code class="plaintext hljs">#    Vertica con &lt;- odbcConnect(dsn='VerticaDSN') #    mtcars_train mtcars.train &lt;- sqlQuery(con, "SELECT * FROM public.mtcars_train") #    mtcars&lt;/b&gt; mtcars.data &lt;- sqlQuery(con, "SELECT * FROM public.mtcars") #   odbcClose(con)</code> </pre> <br>  Lors du chargement de donn√©es √† partir de sources R pour des champs de types de texte et de date-heure, leur appartenance √† des facteurs est automatiquement √©tablie.  Le champ ¬´am¬ª est de type num√©rique et R est per√ßu comme un indicateur num√©rique, et non un facteur, qui ne permettra pas une r√©gression logistique.  Par cons√©quent, nous convertissons ce champ en un facteur num√©rique: <br><br><pre> <code class="plaintext hljs">mtcars.data$am = factor(mtcars.data$am) mtcars.train$am = factor(mtcars.train$am)</code> </pre> <br>  Dans R Studio, il est pratique de regarder les donn√©es de mani√®re interactive, de cr√©er des graphiques d'analyse pr√©dictive et d'√©crire du code dans R avec des conseils: <br><br> <a href=""><img src="https://habrastorage.org/webt/r2/ft/b8/r2ftb85rnjcmpiblxomwdiicr7k.jpeg"></a> <br><br><h2>  Construire un mod√®le en R </h2><br>  Nous allons construire un mod√®le de r√©gression logistique sur l'ensemble de donn√©es pr√©par√© pour les m√™mes dimensions que dans Vertica: <br><br><pre> <code class="plaintext hljs">mtcars.model &lt;- glm(formula = am ~ cyl + wt + gear, family = binomial(), data = mtcars.train)</code> </pre> <br>  <b>Explication:</b> en langage R, la formule d'analyse pr√©dictive est indiqu√©e comme suit: <br><br><pre> <code class="plaintext hljs">&lt;  &gt;~&lt;   &gt;</code> </pre> <br><h2>  Analyse des donn√©es du mod√®le dans R </h2><br>  Nous initialisons l'ensemble de donn√©es r√©sultant, en prenant de mtcars tous les enregistrements pour les champs obligatoires: <br><br><pre> <code class="plaintext hljs">mtcars.result &lt;- data.frame(car_model = mtcars.data$car_model, am = mtcars.data$am, predict = 0)</code> </pre> <br>  Maintenant, sur la base du mod√®le construit, vous pouvez effectuer une analyse sur les donn√©es elles-m√™mes: <br><br><pre> <code class="plaintext hljs">mtcars.result$predict &lt;- predict.glm(mtcars.model, newdata = subset(mtcars.data, select = c('cyl', 'wt', 'gear')), type = 'response' )</code> </pre> <br>  Le r√©sultat de l'analyse est renvoy√© au champ de pr√©diction sous forme de pourcentage de la probabilit√© de la pr√©vision.  Simplifiez par analogie avec Vertica aux valeurs 0 ou 1, en consid√©rant la pr√©vision positive avec une probabilit√© de plus de 50%: <br><br><pre> <code class="plaintext hljs">mtcars.result$predict &lt;- ifelse(mtcars.result$predict &gt; 0.5, 1, 0)</code> </pre> <br>  Nous calculons le nombre total d'enregistrements pour lesquels le champ de pr√©diction pr√©vu ne correspond pas √† la valeur r√©elle en am: <br><br><pre> <code class="plaintext hljs">nrow(mtcars[mtcars.result$am != mtcars.result$predict, ])</code> </pre> <br>  R a renvoy√© z√©ro.  Ainsi, les pr√©visions ont converg√© sur tous les mod√®les de voitures, comme dans le ML de Vertica. <br><br>  <b>Remarque: les</b> enregistrements de mtcars ont √©t√© renvoy√©s par le filtre (le premier param√®tre entre crochets) avec toutes les colonnes (le deuxi√®me param√®tre a √©t√© omis apr√®s la virgule entre crochets). <br><br><h2>  Enregistrement et chargement de donn√©es localement dans R </h2><br>  A la sortie de R, le studio propose de sauvegarder l'√©tat de tous les objets afin de continuer √† travailler apr√®s un red√©marrage.  Si, pour une raison quelconque, vous devez enregistrer, puis restaurer l'√©tat des objets individuels, pour cela, des fonctions sp√©ciales sont fournies dans R: <br><br><pre> <code class="plaintext hljs">#      save(mtcars.model, file = 'mtcars.model') #      load('mtcars.model')</code> </pre> <br><h2>  Enregistrement de donn√©es de R vers Vertica </h2><br>  Si R Studio a √©t√© utilis√© pour pr√©parer des donn√©es pour la formation des mod√®les ML Vertica, ou si l'analyse a √©t√© effectu√©e directement dans celui-ci, qui doit ensuite √™tre utilis√©e dans la base de donn√©es Vertica, les ensembles de donn√©es R peuvent √™tre √©crits dans la table Vertica. <br><br>  √âtant donn√© que la biblioth√®que ODBC pour R est con√ßue pour les SGBDR OLTP, elle ne peut pas g√©n√©rer correctement des requ√™tes de cr√©ation de table pour Vertica.  Par cons√©quent, pour r√©ussir l'enregistrement des donn√©es, vous devrez cr√©er manuellement la table n√©cessaire dans Vertica √† l'aide de SQL, dont l'ensemble de champs et les types co√Øncident avec l'ensemble de donn√©es enregistrables R. <br><br>  De plus, le processus d'enregistrement lui-m√™me semble simple (n'oubliez pas d'ouvrir puis de fermer la connexion con): <br><br><pre> <code class="plaintext hljs">sqlSave(con, mtcars.result, tablename = 'public.mtcars_result', append = TRUE, rownames = FALSE, colnames = FALSE)</code> </pre> <br><h2>  Utilisation de Vertica avec R </h2><br>  Le travail interactif avec des donn√©es dans R Studio est bien adapt√© au mode de recherche et de pr√©paration de donn√©es.  Mais il est totalement inadapt√© √† l'analyse de flux de donn√©es et de grands tableaux en mode automatique.  L'une des options du sch√©ma d'analyse pr√©dictive hybride R avec Vertica est la pr√©paration de donn√©es pour l'apprentissage de R et l'identification des d√©pendances pour la construction de mod√®les.  Ensuite, en utilisant les fonctions ML int√©gr√©es √† Vertica, les mod√®les de pr√©vision des donn√©es pr√©par√©es sur R sont form√©s en tenant compte des d√©pendances identifi√©es des variables. <br><br>  Il existe une option plus flexible lorsque toute la puissance du langage R est utilis√©e directement sous Vertica.  Pour cela, Vertica a d√©velopp√© la distribution R sous la forme d'une biblioth√®que de plug-ins qui vous permet d'utiliser des fonctions de transformation √©crites directement dans le langage R dans les requ√™tes SQL. La documentation d√©crit en d√©tail l'installation du support R pour Vertica et les packages R suppl√©mentaires n√©cessaires au fonctionnement, le cas √©ch√©ant. <br><br><h2>  Enregistrement du mod√®le R dans Vertica </h2><br>  Pour utiliser le mod√®le d'analyse pr√©c√©demment pr√©par√© par R Studio dans les fonctions R ex√©cut√©es sous Vertica, vous devez les enregistrer sur les serveurs Vertica.  L'enregistrement local sur chaque serveur du cluster avec un fichier n'est ni pratique ni fiable, de nouveaux serveurs peuvent √™tre ajout√©s au cluster, et lors du changement de mod√®le, vous devrez vous rappeler de r√©√©crire tous les fichiers. <br><br>  Le moyen le plus pratique consiste √† s√©rialiser le mod√®le R en texte et √† enregistrer la fonction Vertica en tant qu'UDF, qui renverra ce texte sous forme de constante (n'oubliez pas d'ouvrir puis de fermer la connexion con): <br><br><pre> <code class="plaintext hljs">#     mtcars.model.text &lt;- rawToChar( serialize(mtcars.model, connection = NULL, ascii = TRUE)) #       Vertica # (     ) mtcars.func &lt;- paste0( "CREATE OR REPLACE FUNCTION public.MtCarsAnalizeModel() RETURN varchar(65000) AS BEGIN RETURN '", gsub("'", "''", mtcars.model.text), "'; END; GRANT EXECUTE ON FUNCTION public.MtCarsAnalizeModel() TO public;" ) #    Vertica sqlQuery(con, mtcars.func)</code> </pre> <br>  La m√©thode propos√©e permet de contourner la restriction de Vertica sur les param√®tres transmis dans la fonction de transformation, o√π seul le transfert de constantes ou d'expressions de constantes est requis.  Vertica UDF SQL compile non pas comme des fonctions, mais comme des expressions calcul√©es, c'est-√†-dire que lors du passage d'un param√®tre, au lieu d'appeler la fonction, son texte (dans ce cas une constante) sera transf√©r√©, ce qui a √©t√© enregistr√© dans le code ci-dessus. <br><br>  Si vous modifiez le mod√®le, vous devrez recr√©er sa fonction dans Vertica.  Il est logique d'encapsuler ce code dans une fonction universelle qui g√©n√®re une fonction dans Vertica avec le nom sp√©cifi√© √† partir du mod√®le pass√©. <br><br><h2>  Fonctions R pour Vertica </h2><br>  Pour connecter les fonctions R √† Vertica, vous devez √©crire des fonctions d'analyse et d'enregistrement des donn√©es dans Vertica. <br><br>  La fonction de travailler avec des donn√©es sous Vertica devrait avoir deux param√®tres: l'ensemble de donn√©es r√©sultant (comme data.frame) et les param√®tres de travail (comme list): <br><br><pre> <code class="plaintext hljs">MtCarsAnalize &lt;- function(data, parameters) { if ( is.null(parameters[['model']]) ) { stop("NULL value for model! Model cannot be NULL.") } else { model &lt;- unserialize(charToRaw(parameters[['model']])) } names(data) &lt;- c('car_model', 'cyl', 'wt', 'gear') result &lt;- data.frame(car_model = data$car_model, predict = 0) result$predict &lt;- predict.glm(model, newdata = subset(data, select = c('cyl', 'wt', 'gear')), type = 'response' ) result$predict &lt;- ifelse(result$predict &gt; 0.5, TRUE, FALSE) return(result) }</code> </pre> <br>  Dans le corps de la fonction, on v√©rifie que le param√®tre du mod√®le est pass√©, dont le texte est traduit en forme binaire et d√©s√©rialis√© en l'objet du mod√®le d'analyse.  √âtant donn√© que Vertica transf√®re ses propres noms de champ √† l'ensemble de donn√©es pour la fonction, les noms de champ explicites sont d√©finis dans l'ensemble de donn√©es.  Sur la base des donn√©es obtenues, un ensemble de r√©sultats est construit avec le nom du mod√®le de machine et z√©ro pr√©dire.  Ensuite, une pr√©vision est construite en utilisant uniquement les champs n√©cessaires √† l'analyse √† partir de l'ensemble de donn√©es obtenu.  Le champ de pr√©diction de l'ensemble de r√©sultats est d√©fini sur des valeurs bool√©ennes (pour une modification au lieu de num√©riques) et le r√©sultat est renvoy√© par la fonction. <br><br>  Reste maintenant √† d√©crire l'enregistrement de cette fonction dans Vertica: <br><br><pre> <code class="plaintext hljs">MtCarsAnalizeFactory &lt;- function() { list(name = MtCarsAnalize, udxtype = c("transform"), intype = c("varchar", "int", "float", "int"), outtype = c("varchar", "boolean"), outnames = c("car_model", "predict"), parametertypecallback=MtCarsAnalizeParameters) } MtCarsAnalizeParameters &lt;- function() { parameters &lt;- list(datatype = c("varchar"), length = 65000, scale = c("NA"), name = c("model")) return(parameters) }</code> </pre> <br>  La fonction MtCarsAnalizeFactory d√©crit le nom de la fonction utilis√©e pour l'op√©ration, le champ pour l'ensemble de donn√©es entrant et sortant, et la deuxi√®me fonction d√©crit le param√®tre pass√© ¬´mod√®le¬ª.  Les types de champs sont des types de donn√©es Vertica.  Lors du transfert et du retour de donn√©es, Vertica convertit automatiquement les valeurs dans les types de donn√©es requis pour le langage R. Vous pouvez voir le tableau de compatibilit√© des types dans la documentation de Vertica. <br><br>  Vous pouvez tester le fonctionnement de la fonction √©crite pour Vertica sur les donn√©es t√©l√©charg√©es vers R studio: <br><br><pre> <code class="plaintext hljs">test.data = subset(mtcars.data, select = c('car_model', 'cyl', 'wt', 'gear')) test.params = list(model = mtcars.model.text) test.result = MtCarsAnalize(test.data, test.params)</code> </pre> <br><h2>  Connectez la biblioth√®que de fonctionnalit√©s √† Vertica </h2><br>  Nous enregistrons toutes les fonctions ci-dessus dans un seul fichier "mtcars_func.r" et t√©l√©chargeons ce fichier sur l'un des serveurs du cluster Vertica dans "/ home / dbadmin". <br><br>  <b>Un point important:</b> dans R Studio, vous devez d√©finir l'option pour enregistrer la traduction des lignes dans des fichiers en mode Posix (LF).  Cela peut √™tre fait dans les options globales, section Code, onglet Enregistrement.  Si vous travaillez sous Windows, par d√©faut, le fichier sera enregistr√© avec un retour chariot et ne pourra pas √™tre t√©l√©charg√© sur Vertica. <br><br>  Nous nous connectons au serveur √† partir du cluster Vertica, sur lequel nous avons enregistr√© le fichier et charg√© la biblioth√®que: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIBRARY</span></span> MtCarsLibs <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'/home/dbadmin/mtcars_func.r'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> <span class="hljs-string"><span class="hljs-string">'R'</span></span>;</code> </pre> <br>  √Ä partir de cette biblioth√®que, vous pouvez enregistrer la fonction R: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> TRANSFORM <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> public.MtCarsAnalize <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> <span class="hljs-string"><span class="hljs-string">'R'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-string"><span class="hljs-string">'MtCarsAnalizeFactory'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIBRARY</span></span> MtCarsLibs; <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> TRANSFORM <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> public.MtCarsAnalize(<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">float</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>;</code> </pre> <br><h2>  Fonctions d'appel R dans Vertica </h2><br>  Nous appelons la fonction R, en lui passant le texte du mod√®le, qui √©tait pr√©c√©demment enregistr√© en tant que fonction UDF: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> MtCarsAnalize(car_model, cyl, wt, gear <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PARAMETERS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">model</span></span> = public.MtCarsAnalizeModel()) <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> public.mtcars;</code> </pre> <br><img src="https://habrastorage.org/webt/8a/om/ve/8aomvezlxe_-0n4gnyonxkr25om.jpeg"><br><br>  On peut v√©rifier que, comme dans les cas pr√©c√©dents, la pr√©vision est 100% coh√©rente avec la situation r√©elle: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> c.*, p.predict, p.predict = c.am::<span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> valid <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> public.mtcars c <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> MtCarsAnalize(car_model, cyl, wt, gear <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PARAMETERS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">model</span></span> = public.MtCarsAnalizeModel()) <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> public.mtcars ) p <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> c.car_model = p.car_model</code> </pre> <br>  <b>Remarque:</b> les fonctions de transformation dans Vertica renvoient leur propre ensemble de donn√©es √† partir des champs et des enregistrements d√©finis dans les fonctions, mais elles peuvent √™tre utilis√©es dans les requ√™tes si elles sont encapsul√©es dans une sous-requ√™te. <br><br>  Lorsque les fonctions R sont connect√©es, Vertica copie le code source dans son installation, qu'il compile en code machine.  Le fichier source R t√©l√©charg√© sur le serveur apr√®s la connexion √† la biblioth√®que n'est pas requis pour les travaux ult√©rieurs.  La vitesse des fonctions prenant en compte la compilation binaire est suffisamment √©lev√©e pour fonctionner avec des tableaux de donn√©es volumineux, cependant, il convient de rappeler que toutes les op√©rations R sont effectu√©es en m√©moire et qu'il y a un risque d'aller √† l'√©change s'il y a un manque de m√©moire du syst√®me d'exploitation pour r√©pondre aux besoins de Vertica et R travaillant ensemble . <br><br>  Si la fonction est appel√©e sur la partition des donn√©es sp√©cifi√©es dans PARTITION BY pour OVER, Vertica parall√©lise l'ex√©cution de chaque partition sur les serveurs de cluster.  Ainsi, si un fabricant √©tait toujours pr√©sent dans l'ensemble de donn√©es en plus du mod√®le de machine, vous pouvez le sp√©cifier dans PARTITION BY et parall√©liser l'analyse pour chaque fabricant. <br><br><h2>  Autres opportunit√©s d'apprentissage machine Vertica </h2><br>  En plus de R, Vertica peut d√©velopper ses propres fonctions de transformation en C, Java et Python.  Chaque langue a ses propres nuances et caract√©ristiques d'√©criture et de connexion √† Vertica.  Avec son propre ML, tout cela donne √† Vertica une bonne r√©serve pour l'analyse pr√©dictive des donn√©es. <br><br><h2>  Remerciements et liens </h2><br>  Je tiens √† remercier sinc√®rement mon ami et coll√®gue Vlad Malofeev de Perm, qui m'a pr√©sent√© R et m'a aid√© √† le d√©couvrir dans l'un de nos projets communs. <br><br>  Initialement, dans un projet o√π une pr√©vision a √©t√© faite sur des conditions difficiles pour l'avenir en utilisant les donn√©es de l'ann√©e derni√®re, les d√©veloppeurs ont essay√© d'utiliser SQL et Java.  Cela a engendr√© de grandes difficult√©s de prise en compte de la qualit√© de ces sources et a fortement ralenti le d√©veloppement du projet.  Vlad est venu avec le projet avec R, nous avons connect√© R √† Vertica, il a conduit les donn√©es au studio et tout a tourn√© et tourn√© magnifiquement tout de suite.  Litt√©ralement en quelques semaines, tout ce qui a dur√© des mois a √©t√© ratiss√©, sauvant le projet d'un code complexe. <br><br>  Les exemples de donn√©es avec des voitures peuvent √™tre t√©l√©charg√©s √† partir du r√©f√©rentiel GIT: <br><br><pre> <code class="plaintext hljs">git clone https://github.com/vertica/Machine-Learning-Examples</code> </pre> <br>  et t√©l√©chargez sur Vertica: <br><br><pre> <code class="plaintext hljs">/opt/vertica/bin/vsql -d &lt;name of your database&gt; -f load_ml_data.sql</code> </pre> <br>  Si vous voulez approfondir le ML et apprendre √† travailler avec R, je vous recommande un livre en russe <b>¬´R en action¬ª.</b>  <b>Analyse et visualisation des donn√©es en langage R. ¬ª</b>  Il est √©crit dans un langage humain simple et accessible et convient aux d√©butants qui n'ont jamais rencontr√© d'apprentissage automatique. <br><br>  Vous pouvez voir ici des informations sur la connexion de la biblioth√®que R √† Vertica. <br><br>  Pour ceux qui ont d√©j√† commenc√© √† apprendre et √† utiliser ML en Python, il convient de pr√™ter attention √† l'IDE Rodeo, c'est un analogue de R Studio, car sans analyse de qualit√© interactive, c'est impossible.  Je pense que tout ce qui est d√©crit dans cet article sous R de mani√®re similaire peut √™tre d√©velopp√© en Python, y compris l'enregistrement du mod√®le dans les fonctions UDF et le d√©veloppement de fonctions d'analyse pour Vertica.  Si vous cochez, n'oubliez pas de vous d√©sabonner des r√©sultats dans les commentaires, je serai reconnaissant pour les informations. <br><br>  Merci pour votre temps et j'esp√®re avoir pu d√©montrer la simplicit√© et les capacit√©s incroyables de la symbiose de R et Vertica. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr436306/">https://habr.com/ru/post/fr436306/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr436296/index.html">explicite en d√©tail</a></li>
<li><a href="../fr436298/index.html">Id√©es de la table: vinyle virtuel</a></li>
<li><a href="../fr436300/index.html">9 meilleures pratiques de s√©curit√© chez Kubernetes</a></li>
<li><a href="../fr436302/index.html">Exp√©rience de la substitution r√©elle des importations √† l'aide du syst√®me de stockage russe AERODISK</a></li>
<li><a href="../fr436304/index.html">Zimbra Collaboration Suite et la lutte contre le phishing</a></li>
<li><a href="../fr436308/index.html">Rostelecom pourrait devenir un monopole sur le march√© des centres de donn√©es</a></li>
<li><a href="../fr436310/index.html">Comme l'a fait Ivan Metrics DevOps. Objet d'influence</a></li>
<li><a href="../fr436312/index.html">Synth√®se de la parole du r√©seau neuronal √† l'aide de l'architecture Tacotron 2, ou ¬´Obtenez l'alignement ou essayez de mourir¬ª</a></li>
<li><a href="../fr436314/index.html">Un h√¥tel-robot japonais a "licenci√©" la moiti√© de ses robots en raison des probl√®mes qu'ils cr√©ent</a></li>
<li><a href="../fr436316/index.html">Comment les cartes √† puce aident √† stimuler les projets informatiques</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>