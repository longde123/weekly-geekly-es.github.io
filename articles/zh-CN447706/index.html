<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>â‡ï¸ ğŸˆ ğŸ‘©ğŸ½â€ğŸ’» æ²¡æœ‰ä¸€ä¸ªORM ğŸ‘©â€âš•ï¸ ğŸ’¡ âœ‰ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æ²¡æœ‰ä¸€ä¸ªORM 


 å¤§å®¶å¥½ï¼ æˆ‘è´Ÿè´£Ostrovok.rué…’åº—é¢„è®¢æœåŠ¡çš„åˆä½œä¼™ä¼´å‘å±•éƒ¨ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘æƒ³è°ˆè°ˆæˆ‘ä»¬å¦‚ä½•åœ¨ä¸€ä¸ªé¡¹ç›®ä¸Šä½¿ç”¨Django ORM ã€‚ 


 å®é™…ä¸Šï¼Œæˆ‘åœ¨æ¬ºéª—ï¼Œè¿™ä¸ªåå­—åº”è¯¥æ˜¯â€œ  ä¸å¯ä»¥  ORM singleâ€œã€‚å¦‚æœæ‚¨æƒ³çŸ¥é“ä¸ºä»€ä¹ˆæˆ‘å†™è¿™ä¸ªï¼Œä»¥åŠï¼š 


- æ‚¨åœ¨å †æ ˆä¸Šæœ‰...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>æ²¡æœ‰ä¸€ä¸ªORM</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ostrovok/blog/447706/"><h1 id="ne-ormom-edinym"> æ²¡æœ‰ä¸€ä¸ªORM </h1><br><p> å¤§å®¶å¥½ï¼ æˆ‘è´Ÿè´£<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Ostrovok.ru</a>é…’åº—é¢„è®¢æœåŠ¡çš„åˆä½œä¼™ä¼´å‘å±•éƒ¨ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘æƒ³è°ˆè°ˆæˆ‘ä»¬å¦‚ä½•åœ¨ä¸€ä¸ªé¡¹ç›®ä¸Šä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Django ORM</a> ã€‚ </p><br><p> å®é™…ä¸Šï¼Œæˆ‘åœ¨æ¬ºéª—ï¼Œè¿™ä¸ªåå­—åº”è¯¥æ˜¯â€œ <del> ä¸å¯ä»¥ </del>  ORM singleâ€œã€‚å¦‚æœæ‚¨æƒ³çŸ¥é“ä¸ºä»€ä¹ˆæˆ‘å†™è¿™ä¸ªï¼Œä»¥åŠï¼š </p><br><ul><li>æ‚¨åœ¨å †æ ˆä¸Šæœ‰Djangoï¼Œå¹¶ä¸”æƒ³è¦ä»ORMä¸­æŒ¤å‡ºæœ€å¤§çš„<code>Model.objects.all()</code> ï¼Œè€Œä¸ä»…ä»…æ˜¯<code>Model.objects.all()</code> ï¼Œ </li><li> æ‚¨æƒ³å°†éƒ¨åˆ†ä¸šåŠ¡é€»è¾‘è½¬ç§»åˆ°æ•°æ®åº“çº§åˆ«ï¼Œ </li><li> è¿˜æ˜¯æ‚¨æƒ³æ‰¾å‡ºä¸ºä»€ä¹ˆB2B.Ostrovok.ruçš„å¼€å‘äººå‘˜æœ€ç»å¸¸çš„å€Ÿå£æ˜¯<em>â€œä»å†å²</em>ä¸Šè®²<em>â€</em> ï¼Œ </li></ul><br><p>  ...æ¬¢è¿çŒ«ã€‚ </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/66b/308/b1c/66b308b1cd5afefead46ef7bffdbbddf.jpg" alt="å…‰ç›˜"></p><a name="habracut"></a><br><p>  2014å¹´ï¼Œæˆ‘ä»¬æ¨å‡ºäº†B2B.Ostrovok.ru-åœ¨çº¿é¢„è®¢æœåŠ¡ï¼Œä¸ºæ—…æ¸¸å¸‚åœºçš„ä¸“ä¸šäººå‘˜ï¼ˆæ—…è¡Œä»£ç†å•†ï¼Œè¿è¥å•†å’Œå…¬å¸å®¢æˆ·ï¼‰æä¾›é…’åº—ï¼Œä¸­è½¬ï¼Œæ±½è½¦å’Œå…¶ä»–æ—…è¡ŒæœåŠ¡ã€‚ </p><br><p> åœ¨B2Bä¸­ï¼Œæˆ‘ä»¬å·²ç»è®¾è®¡å¹¶æˆåŠŸä½¿ç”¨äº†åŸºäº<code>MetaOrder</code> -meta order- <code>MetaOrder</code>çš„æŠ½è±¡è®¢å•æ¨¡å‹ã€‚ </p><br><p> å…ƒè®¢å•æ˜¯ä¸€ä¸ªæŠ½è±¡å®ä½“ï¼Œæ— è®ºå®ƒå±äºå“ªç§ç±»å‹çš„è®¢å•ï¼Œéƒ½å¯ä»¥ä½¿ç”¨å®ƒï¼šé…’åº—ï¼ˆ <code>Hotel</code> ï¼‰ï¼Œé™„åŠ æœåŠ¡ï¼ˆ <code>Upsell</code> ï¼‰æˆ–æ±½è½¦ï¼ˆ <code>Car</code> ï¼‰ã€‚ å°†æ¥å¯èƒ½ä¼šå‡ºç°å…¶ä»–ç±»å‹ã€‚ </p><br><p> å¹¶éæ€»æ˜¯å¦‚æ­¤ã€‚ å½“B2BæœåŠ¡å¯åŠ¨æ—¶ï¼Œåªèƒ½é€šè¿‡å®ƒé¢„è®¢é…’åº—ï¼Œæ‰€æœ‰ä¸šåŠ¡é€»è¾‘éƒ½å°†é‡ç‚¹æ”¾åœ¨è¿™äº›é…’åº—ä¸Šã€‚ ä¾‹å¦‚ï¼Œåˆ›å»ºäº†è®¸å¤šå­—æ®µæ¥æ˜¾ç¤ºé”€å”®é‡‘é¢å’Œé¢„è®¢é€€æ¬¾é‡‘é¢çš„æ±‡ç‡ã€‚ éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæˆ‘ä»¬æ„è¯†åˆ°åœ¨ç»™å®šå…ƒé¡ºåºçš„æƒ…å†µä¸‹å¦‚ä½•æœ€å¥½åœ°å­˜å‚¨å’Œé‡ç”¨æ­¤æ•°æ®ã€‚ ä½†æ˜¯æ•´ä¸ªä»£ç æ— æ³•é‡å†™ï¼Œå¹¶ä¸”éƒ¨åˆ†é—äº§ç»§æ‰¿åˆ°äº†æ–°æ¶æ„ä¸­ã€‚ å®é™…ä¸Šï¼Œè¿™å¯¼è‡´äº†ä½¿ç”¨å‡ ç§ç±»å‹çš„è®¢å•è¿›è¡Œè®¡ç®—çš„å›°éš¾ã€‚ æ€ä¹ˆåš-ä»<em>å†å²ä¸Šçœ‹</em> ... </p><br><p> æˆ‘çš„ç›®æ ‡æ˜¯åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­å±•ç¤ºDjango ORMçš„åŠŸèƒ½ã€‚ </p><br><h2 id="predystoriya"> èƒŒæ™¯çŸ¥è¯† </h2><br><p> ä¸ºäº†è®¡åˆ’è´¹ç”¨ï¼Œæˆ‘ä»¬çš„B2Bå®¢æˆ·ç¡®å®ç¼ºä¹æœ‰å…³ç°åœ¨/æ˜å¤©/ä»¥åéœ€è¦æ”¯ä»˜å¤šå°‘ï¼Œè®¢å•ä¸Šæ˜¯å¦æœ‰å€ºåŠ¡ä»¥åŠâ€‹â€‹å€ºåŠ¡è§„æ¨¡ä»¥åŠåœ¨é™åˆ¶èŒƒå›´å†…å¯ä»¥æ”¯å‡ºçš„æ•°é‡ç­‰æ–¹é¢çš„ä¿¡æ¯ã€‚ æˆ‘ä»¬å†³å®šä»¥ä»ªè¡¨æ¿çš„å½¢å¼æ˜¾ç¤ºæ­¤ä¿¡æ¯-è¿™æ ·çš„ç®€å•æ’åº§ï¼Œå¸¦æœ‰æ¸…æ™°çš„å›¾è¡¨ã€‚ </p><br><p><img src="https://habrastorage.org/webt/2a/rj/yo/2arjyoaa9_xfe8ddcaz5qn4w5mu.gif" alt="ç ´æŠ˜å·1"><br>  <em>ï¼ˆæ‰€æœ‰å€¼å‡ä¸ºæµ‹è¯•å€¼ï¼Œä¸é€‚ç”¨äºç‰¹å®šåˆä½œä¼™ä¼´ï¼‰</em> </p><br><p> ä¹ä¸€çœ‹ï¼Œä¸€åˆ‡éƒ½å¾ˆç®€å•-æˆ‘ä»¬è¿‡æ»¤äº†åˆä½œä¼™ä¼´çš„æ‰€æœ‰è®¢å•ï¼Œè¿›è¡Œäº†æ±‡æ€»å¹¶æ˜¾ç¤ºã€‚ </p><br><h2 id="varianty-resheniya"> è§£å†³æ–¹æ¡ˆé€‰é¡¹ </h2><br><p> å…³äºæˆ‘ä»¬å¦‚ä½•è¿›è¡Œè®¡ç®—çš„ä¸€äº›è§£é‡Šã€‚ æˆ‘ä»¬æ˜¯ä¸€å®¶å›½é™…å…¬å¸ï¼Œæ¥è‡ªä¸åŒå›½å®¶/åœ°åŒºçš„åˆä½œä¼™ä¼´ä»¥ä¸åŒçš„è´§å¸è¿›è¡Œç»è¥-è´­ä¹°å’Œè½¬å”®é¢„è®¢ã€‚ æ­¤å¤–ï¼Œä»–ä»¬å¿…é¡»ä»¥æ‰€é€‰è´§å¸ï¼ˆé€šå¸¸æ˜¯æœ¬åœ°è´§å¸ï¼‰æ¥æ”¶è´¢åŠ¡æŠ¥è¡¨ã€‚ å­˜å‚¨æ‰€æœ‰è´§å¸æ±‡ç‡çš„æ‰€æœ‰å¯èƒ½æ•°æ®æ˜¯æ„šè ¢ä¸”ä¸åˆ‡å®é™…çš„ï¼Œå› æ­¤æ‚¨éœ€è¦é€‰æ‹©ä¸€ç§å‚è€ƒè´§å¸ï¼Œä¾‹å¦‚å¢å¸ƒã€‚ å› æ­¤ï¼Œæ‚¨åªèƒ½å°†æ‰€æœ‰è´§å¸çš„æ±‡ç‡å­˜å‚¨åˆ°å¢å¸ƒã€‚ å› æ­¤ï¼Œå½“åˆä½œä¼™ä¼´æƒ³è¦æ¥æ”¶æ‘˜è¦æ—¶ï¼Œæˆ‘ä»¬å°†æŒ‰ç…§é”€å”®æ—¶è®¾å®šçš„æ±‡ç‡è½¬æ¢é‡‘é¢ã€‚ </p><br><h3 id="v-lob">  â€œåœ¨é¢å¤´ä¸Šâ€ </h3><br><p> å®é™…ä¸Šï¼Œè¿™æ˜¯<code>Model.objects.all()</code>å¹¶ä¸”æ¡ä»¶å¾ªç¯ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">å¸¦æ¡ä»¶çš„Model.objects.allï¼ˆï¼‰</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">output</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(partner_id)</span></span></span><span class="hljs-function">:</span></span> today = dt.date.today() <span class="hljs-comment"><span class="hljs-comment"># query_get_one -    partner = query_get_one(Partner.objects.filter(id=partner_id)) #    -  query = MetaOrder.objects.filter(partner=partner) result = defaultdict(Decimal) for morder in query: #  ,     #     payment_pending = morder.get_payment_pending() payment_due = morder.get_payment_due() #        # (     ) payable = morder.get_payable_in_cur() #       if payment_pending &gt; today: result['payment_pending'] += payable # ,     if payment_pending &lt; today and payment_due &gt; today: result['payment_due'] += payable return result</span></span></code> </pre> </div></div><br><p> è¯¥æŸ¥è¯¢å°†è¿”å›ä¸€ä¸ªå¯èƒ½åŒ…å«æ•°ç™¾ä¸ªé¢„è®¢çš„ç”Ÿæˆå™¨ã€‚ å°†é’ˆå¯¹è¿™äº›é¢„è®¢ä¸­çš„æ¯ä¸ªé¢„è®¢å‘æ•°æ®åº“å‘å‡ºè¯·æ±‚ï¼Œå› æ­¤è¯¥å‘¨æœŸå°†æŒç»­å¾ˆé•¿æ—¶é—´ã€‚ </p><br><p> æ‚¨å¯ä»¥é€šè¿‡æ·»åŠ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>prefetch_related</code></a>æ–¹æ³•æ¥åŠ å¿«é€Ÿåº¦ï¼š </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># object -      GenericForeignKey. query = query.prefetch_related('object')</span></span></code> </pre> <br><p> ç„¶åï¼Œå¯¹æ•°æ®åº“çš„è¯·æ±‚å°†ç•¥å¾®å‡å°‘ï¼ˆ <code>GenericForeignKey</code> ï¼‰ï¼Œä½†æ˜¯æœ€åï¼Œæˆ‘ä»¬å°†åœæ­¢å®ƒä»¬çš„æ•°ç›®ï¼Œå› ä¸ºå¯¹æ•°æ®åº“çš„è¯·æ±‚ä»å°†åœ¨å¾ªç¯çš„æ¯æ¬¡è¿­ä»£ä¸­è¿›è¡Œã€‚ </p><br><p> å¯ä»¥ï¼ˆå¹¶ä¸”åº”è¯¥ï¼‰ç¼“å­˜<code>output</code>æ–¹æ³•ï¼Œä½†æ˜¯ç¬¬ä¸€ä¸ªè°ƒç”¨ä»ç„¶æ»¡è¶³ä¸€åˆ†é’Ÿçš„é¡ºåºï¼Œè¿™æ˜¯å®Œå…¨ä¸å¯æ¥å—çš„ã€‚ </p><br><p> è¿™æ˜¯æ­¤æ–¹æ³•çš„ç»“æœï¼š </p><br><p><img src="https://habrastorage.org/webt/yz/ur/wq/yzurwquhxoeqczgncqi66je8570.png" alt="Timing_before"></p><br><p> å¹³å‡å“åº”æ—¶é—´ä¸º4ç§’ï¼Œå³°å€¼è¾¾åˆ°21ç§’ã€‚ ç›¸å½“é•¿çš„æ—¶é—´ã€‚ </p><br><p> æˆ‘ä»¬æ²¡æœ‰ä¸ºæ‰€æœ‰åˆä½œä¼™ä¼´æ¨å‡ºä»ªè¡¨æ¿ï¼Œå› æ­¤æˆ‘ä»¬å¯¹æ­¤æ²¡æœ‰å¤ªå¤šè¦æ±‚ï¼Œä½†è¶³ä»¥ç†è§£è¿™ç§æ–¹æ³•æ˜¯å¦æœ‰æ•ˆã€‚ </p><br><p><img src="https://habrastorage.org/webt/f0/rz/yn/f0rzynfsqypr3z0mh1cnwoi6ee0.png" alt="count_before"><br>  <em>å³ä¸‹è§’çš„æ•°å­—æ˜¯æŸ¥è¯¢æ•°ï¼šæœ€å°å€¼ï¼Œæœ€å¤§å€¼ï¼Œå¹³å‡å€¼ï¼Œæ€»æ•°ã€‚</em> </p><br><h3 id="s-umom"> æ˜æ™ºåœ° </h3><br><p> å‰é¢åŸå‹å¯ä»¥å¾ˆå¥½åœ°ç†è§£ä»»åŠ¡çš„å¤æ‚æ€§ï¼Œä½†ä½¿ç”¨èµ·æ¥å¹¶éæœ€ä½³ã€‚ æˆ‘ä»¬è®¤ä¸ºï¼Œå‘æ•°æ®åº“ä¸­è¿›è¡Œå‡ ä¸ªå¤æ‚çš„æŸ¥è¯¢æ¯”è®¸å¤šç®€å•çš„æŸ¥è¯¢è¦å¿«å¾—å¤šï¼Œæ‰€éœ€èµ„æºä¹Ÿæ›´å°‘ã€‚ </p><br><h4 id="plan-zaprosa"> ç”³è¯·æ–¹æ¡ˆ </h4><br><p> æŸ¥è¯¢è®¡åˆ’çš„å¹¿æ³›ç¬”è§¦å¯ä»¥è¿™æ ·æè¿°ï¼š </p><br><ul><li> æ ¹æ®åˆå§‹æ¡ä»¶æ”¶é›†è®¢å•ï¼Œ </li><li> é€šè¿‡<code>annotate</code>å‡†å¤‡è¦è®¡ç®—çš„å­—æ®µï¼Œ </li><li> è®¡ç®—å­—æ®µå€¼ </li><li> æŒ‰æ•°é‡å’Œæ•°é‡<code>aggregate</code> </li></ul><br><h4 id="nachalnye-usloviya"> åˆå§‹æ¡ä»¶ </h4><br><p> è®¿é—®è¯¥ç½‘ç«™çš„åˆä½œä¼™ä¼´åªèƒ½åœ¨å…¶åˆåŒä¸Šçœ‹åˆ°ä¿¡æ¯ã€‚ </p><br><pre> <code class="python hljs">partner = query_get_one(Partner.objects.filter(id=partner_id))</code> </pre> <br><p> å¦‚æœæˆ‘ä»¬ä¸æƒ³æ˜¾ç¤ºæ–°çš„è®¢å•/é¢„è®¢ç±»å‹ï¼Œæˆ‘ä»¬åªéœ€è¦è¿‡æ»¤æ”¯æŒçš„è®¢å•/é¢„è®¢ï¼š </p><br><pre> <code class="python hljs">query = MetaOrder.objects.filter( partner=partner, content_type__in=[ Hotel.get_content_type(), Car.get_content_type(), Upsell.get_content_type(), ] )</code> </pre> <br><p> è®¢å•çŠ¶æ€å¾ˆé‡è¦ï¼ˆæœ‰å…³<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>Q</code></a>æ›´å¤šä¿¡æ¯ï¼‰ï¼š </p><br><pre> <code class="python hljs">query = query.filter( Q(hotel__status__in=[<span class="hljs-string"><span class="hljs-string">'completed'</span></span>, <span class="hljs-string"><span class="hljs-string">'cancelled'</span></span>]) <span class="hljs-comment"><span class="hljs-comment">#     ,    # | Q(car__status__in=[...]) )</span></span></code> </pre> <br><p> ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¿˜ç»å¸¸ä½¿ç”¨é¢„å…ˆå‡†å¤‡å¥½çš„è¯·æ±‚ï¼Œä»¥æ’é™¤æ‰€æœ‰æ— æ³•ä»˜æ¬¾çš„è®¢å•ã€‚ æœ‰å¾ˆå¤šä¸šåŠ¡é€»è¾‘ï¼Œåœ¨æœ¬æ–‡çš„æ¡†æ¶ä¸­å¯¹æˆ‘ä»¬æ¥è¯´ä¸æ˜¯å¾ˆæœ‰è¶£ï¼Œä½†æ˜¯ä»æœ¬è´¨ä¸Šè®²ï¼Œè¿™äº›åªæ˜¯é™„åŠ çš„è¿‡æ»¤å™¨ã€‚ è¿”å›å‡†å¤‡å¥½çš„æŸ¥è¯¢çš„æ–¹æ³•å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="python hljs">query = MetaOrder.exclude_non_payable_metaorders(query)</code> </pre> <br><p> å¦‚æ‚¨æ‰€è§ï¼Œè¿™æ˜¯ä¸€ä¸ªç±»æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿˜å°†è¿”å›<code>QuerySet</code> ã€‚ </p><br><p> æˆ‘ä»¬è¿˜å°†å‡†å¤‡ä¸€äº›å˜é‡ï¼Œç”¨äºæ¡ä»¶æ„é€ å’Œå­˜å‚¨è®¡ç®—ç»“æœï¼š </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dt <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> typing.decimal <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Decimal today = dt.date.today() result = defaultdict(Decimal)</code> </pre> <br><h4 id="podgotovka-poley-annotatehttpsdocsdjangoprojectcomen21refmodelsquerysetsannotate"> ç°åœºå‡†å¤‡ï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>annotate</code></a> ï¼‰ </h4><br><p> ç”±äºå¿…é¡»æ ¹æ®è®¢å•ç±»å‹æ¥å¼•ç”¨å­—æ®µï¼Œå› æ­¤æˆ‘ä»¬å°†ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>Coalesce</code></a> ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä»»æ„æ•°é‡çš„æ–°å‹è®¢å•æŠ½è±¡åˆ°ä¸€ä¸ªå­—æ®µä¸­ã€‚ </p><br><p> è¿™æ˜¯<code>annotate</code>å—çš„ç¬¬ä¸€éƒ¨åˆ†ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">ç¬¬ä¸€æ¬¡æ³¨é‡Š</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#     , #      from app.helpers.numbers import ZERO, ONE query_annoted = query.annotate( _payment_pending=Coalesce( 'hotel__payment_pending', 'car__payment_pending', 'upsell__payment_pending', ), _payment_due=Coalesce( 'hotel__payment_due', 'car__payment_due', 'upsell__payment_due', ), _refund=Coalesce( 'hotel__refund', Value(ZERO) ), _refund_currency_rate=Coalesce( 'hotel__refund_currency_rate', Value(ONE) ), _sell=Coalesce( 'hotel__sell', Value(ZERO) ), _sell_currency_rate=Coalesce( 'hotel__sell_currency_rate', Value(ONE) ), )</span></span></code> </pre> </div></div><br><p>  <code>Coalesce</code>åœ¨è¿™é‡Œå¤§æ”¾å¼‚å½©ï¼Œå› ä¸ºé…’åº—è®¢å•å…·æœ‰å‡ ä¸ªç‰¹æ®Šå±æ€§ï¼Œåœ¨æ‰€æœ‰å…¶ä»–æƒ…å†µä¸‹ï¼ˆå…¶ä»–æœåŠ¡å’Œæ±½è½¦ï¼‰ï¼Œè¿™äº›å±æ€§å¯¹æˆ‘ä»¬è€Œè¨€å¹¶ä¸é‡è¦ã€‚ è¿™å°±æ˜¯<code>Value(ZERO)</code>å’Œæ±‡ç‡<code>Value(ONE)</code>çš„æ˜¾ç¤ºæ–¹å¼ã€‚  <code>ZERO</code>å’Œ<code>ONE</code>å‡ä¸ºå¸¸æ•°å½¢å¼çš„<code>Decimal('0')</code>å’Œ<code>Decimal(1)</code> ã€‚ è¿™æ˜¯ä¸€ç§ä¸šä½™æ–¹æ³•ï¼Œä½†æ˜¯åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œè¿™ç§æ–¹æ³•æ˜¯å¯ä»¥æ¥å—çš„ã€‚ </p><br><p> æ‚¨å¯èƒ½ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆä¸å°†æŸäº›å­—æ®µæŒ‰å…ƒé¡ºåºæ”¾åœ¨ä¸€ä¸ªçº§åˆ«ä¸Šï¼Ÿ ä¾‹å¦‚ï¼Œ <code>payment_pending</code> ï¼Œåˆ°å¤„éƒ½æ˜¯ã€‚ çš„ç¡®ï¼Œéšç€æ—¶é—´çš„æµé€ï¼Œæˆ‘ä»¬å°†æ­¤ç±»å­—æ®µè½¬æ¢ä¸ºå…ƒé¡ºåºï¼Œä½†æ˜¯ç°åœ¨ä»£ç è¿è¡Œè‰¯å¥½ï¼Œå› æ­¤æ­¤ç±»ä»»åŠ¡ä¸å†æ˜¯æˆ‘ä»¬çš„ä¼˜å…ˆäº‹é¡¹ã€‚ </p><br><h4 id="esche-odna-podgotovka-i-raschety"> å¦ä¸€ä¸ªå‡†å¤‡å’Œè®¡ç®— </h4><br><p> ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸Šä¸€ä¸ª<code>annotate</code>å—ä¸­æ”¶åˆ°çš„é‡‘é¢è¿›è¡Œä¸€äº›è®¡ç®—ã€‚ è¯·æ³¨æ„ï¼Œè¿™é‡Œæ‚¨ä¸å†éœ€è¦å—å®šå•ç±»å‹çš„çº¦æŸï¼ˆä¸€ä¸ªä¾‹å¤–é™¤å¤–ï¼‰ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">ç¬¬äºŒæ³¨è§£</b> <div class="spoiler_text"><pre> <code class="python hljs">.annotate( <span class="hljs-comment"><span class="hljs-comment">#  _base     _sell_base=( F('_sell') * F('_sell_currency_rate') ), _refund_base=( F('_refund') * F('_refund_currency_rate') ), _payable_base=( F('_sell_base') - F('_refund_base') ), _reporting_currency_rate=Case( When( content_type=Hotel.get_content_type(), then=RawSQL( '(hotel.currency_data-&gt;&gt;%s)::numeric', (partner.reporting_currency,), ), ), output_field=DecimalField(), default=Decimal('1'), ), )</span></span></code> </pre> </div></div><br><p> è¯¥åŒºå—æœ€æœ‰è¶£çš„éƒ¨åˆ†æ˜¯<code>_reporting_currency_rate</code>å­—æ®µï¼Œå³å‡ºå”®æ—¶ç›¸å¯¹äºå‚è€ƒè´§å¸çš„æ±‡ç‡ã€‚ æœ‰å…³é…’åº—è®¢å•çš„æ‰€æœ‰è´§å¸å¯¹å‚è€ƒè´§å¸çš„æ±‡ç‡æ•°æ®å­˜å‚¨åœ¨<code>currency_data</code> ã€‚ è¿™åªæ˜¯JSONã€‚ æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦ä¿ç•™è¿™ä¸ªï¼Ÿ  <em>å†å²ä¸Šå°±æ˜¯è¿™ç§æƒ…å†µ</em> ã€‚ </p><br><p> åœ¨è¿™é‡Œçœ‹æ¥ï¼Œä¸ºä»€ä¹ˆä¸ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>F</code></a>æ›¿ä»£åˆåŒè´§å¸çš„ä»·å€¼å‘¢ï¼Ÿ ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæ‚¨å¯ä»¥è¿™æ ·åšï¼Œé‚£å°†å¾ˆé…·ï¼š </p><br><pre> <code class="python hljs">F(<span class="hljs-string"><span class="hljs-string">f'currency_data__</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{partner.reporting_currency}</span></span></span><span class="hljs-string">'</span></span>)</code> </pre> <br><p> ä½†æ˜¯<code>f-strings</code>ä¸æ”¯æŒ<code>f-strings</code> <code>F</code> å°½ç®¡Django ORMå·²ç»å¯ä»¥è®¿é—®åµŒå¥—çš„jsonå­—æ®µï¼Œè¿™ä¸€äº‹å®éå¸¸ä»¤äººæ„‰å¿«<code>F('currency_data__USD')</code> ã€‚ </p><br><p> æœ€åä¸€ä¸ª<code>annotate</code>å—æ˜¯<code>_payable_in_cur</code>è®¡ç®—ï¼Œå®ƒå°†å¯¹æ‰€æœ‰è®¢å•è¿›è¡Œæ±‡æ€»ã€‚ æ­¤å€¼å¿…é¡»ä»¥åˆåŒè´§å¸è¡¨ç¤ºã€‚ </p><br><p><img src="https://habrastorage.org/webt/3g/hi/rd/3ghirdq4rnexrp2vnhwucju7rkw.png" alt="dash2"></p><br><pre> <code class="python hljs">.annotate( _payable_in_cur=( F(<span class="hljs-string"><span class="hljs-string">'_payable_base'</span></span>) / F(<span class="hljs-string"><span class="hljs-string">'_reporting_currency_rate'</span></span>) ) )</code> </pre> <br><p>  <code>annotate</code>æ–¹æ³•çš„ç‹¬ç‰¹ä¹‹å¤„åœ¨äºï¼Œå®ƒç”Ÿæˆäº†å¾ˆå¤šä¸ä¸è¯·æ±‚ç›´æ¥ç›¸å…³çš„<code>SELECT something AS something_else</code>æ„é€ çš„<code>SELECT something AS something_else</code> ã€‚ å¯ä»¥é€šè¿‡å¸è½½SQL <code>query.__str__()</code>æ¥çœ‹åˆ°ã€‚ </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¿™æ˜¯</a> Django ORMä¸º<code>base_query_annotated</code>ç”Ÿæˆ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">çš„</a> SQLä»£ç çš„<code>base_query_annotated</code> ã€‚ æ‚¨å¿…é¡»ç»å¸¸é˜…è¯»å®ƒï¼Œä»¥äº†è§£å¯ä»¥åœ¨å“ªé‡Œä¼˜åŒ–æŸ¥è¯¢ã€‚ </p><br><h4 id="zaklyuchitelnye-podschety"> æœ€ç»ˆè®¡ç®— </h4><br><p> å°†æœ‰ä¸€ä¸ªå°åŒ…è£…æ¥å°è£…<code>aggregate</code> ï¼Œä»¥ä¾¿å°†æ¥å¦‚æœåˆä½œä¼™ä¼´éœ€è¦å…¶ä»–æŒ‡æ ‡ï¼Œå¯ä»¥è½»æ¾æ·»åŠ ã€‚ </p><br><p><img src="https://habrastorage.org/webt/ky/qm/pi/kyqmpiht-jwpwuripuf6wlfiqv0.png" alt="dash3"></p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_get_data_from_query</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(query: QuerySet)</span></span></span><span class="hljs-function"> -&gt; Decimal:</span></span> result = query.aggregate( _sum_payable=Sum(F(<span class="hljs-string"><span class="hljs-string">'_payable_in_cur'</span></span>)), ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result[<span class="hljs-string"><span class="hljs-string">'_sum_payable'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> ZERO</code> </pre> <br><p> è¿˜æœ‰ä¸€ä»¶äº‹-è¿™æ˜¯æ ¹æ®ä¸šåŠ¡çŠ¶å†µè¿›è¡Œçš„æœ€åè¿‡æ»¤ï¼Œä¾‹å¦‚ï¼Œæˆ‘ä»¬éœ€è¦æ‰€æœ‰éœ€è¦å°½å¿«æ”¯ä»˜çš„è®¢å•ã€‚ </p><br><p><img src="https://habrastorage.org/webt/xz/rj/ss/xzrjssl1barwnpvtegjkg1tkvs0.png" alt="ç ´æŠ˜å·4"></p><br><pre> <code class="python hljs">before_payment_pending_query = _get_data_from_query( base_query_annotated.filter(_payment_pending__gt=today) )</code> </pre> <br><h4 id="otladka-i-proverka"> è°ƒè¯•ä¸éªŒè¯ </h4><br><p> éªŒè¯æ‰€åˆ›å»ºè¯·æ±‚çš„æ­£ç¡®æ€§çš„ä¸€ç§éå¸¸æ–¹ä¾¿çš„æ–¹æ³•æ˜¯å°†å…¶ä¸æ›´æ˜“è¯»çš„è®¡ç®—ç‰ˆæœ¬è¿›è¡Œæ¯”è¾ƒã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> morder <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> query: payable = morder.get_payable_in_cur() payment_pending = morder.get_payment_pending() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> payment_pending &gt; today: result[<span class="hljs-string"><span class="hljs-string">'payment_pending'</span></span>] += payable</code> </pre> <br><p> æ‚¨çŸ¥é“â€œé¢å¤´â€æ–¹æ³•å—ï¼Ÿ </p><br><h3 id="finalnyy-kod"> æœ€ç»ˆä»£ç  </h3><br><p> ç»“æœï¼Œæˆ‘ä»¬å¾—åˆ°å¦‚ä¸‹å†…å®¹ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">æœ€ç»ˆä»£ç </b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_get_data_from_query</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(query: QuerySet)</span></span></span><span class="hljs-function"> -&gt; tuple:</span></span> result = query.aggregate( _sum_payable=Sum(F(<span class="hljs-string"><span class="hljs-string">'_payable_in_cur'</span></span>)), ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result[<span class="hljs-string"><span class="hljs-string">'_sum_payable'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> ZERO <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">output</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(partner_id: int)</span></span></span><span class="hljs-function">:</span></span> today = dt.date.today() partner = query_get_one(Partner.objects.filter(id=partner_id)) query = MetaOrder.objects.filter(partner=partner, content_type__in=[ Hotel.get_content_type(), Car.get_content_type(), Upsell.get_content_type(), ]) result = defaultdict(Decimal) query_annoted = query.annotate( _payment_pending=Coalesce( <span class="hljs-string"><span class="hljs-string">'hotel__payment_pending'</span></span>, <span class="hljs-string"><span class="hljs-string">'car__payment_pending'</span></span>, <span class="hljs-string"><span class="hljs-string">'upsell__payment_pending'</span></span>, ), _payment_due=Coalesce( <span class="hljs-string"><span class="hljs-string">'hotel__payment_due'</span></span>, <span class="hljs-string"><span class="hljs-string">'car__payment_due'</span></span>, <span class="hljs-string"><span class="hljs-string">'upsell__payment_due'</span></span>, ), _refund=Coalesce( <span class="hljs-string"><span class="hljs-string">'hotel__refund'</span></span>, Value(ZERO) ), _refund_currency_rate=Coalesce( <span class="hljs-string"><span class="hljs-string">'hotel__refund_currency_rate'</span></span>, Value(Decimal(<span class="hljs-string"><span class="hljs-string">'1'</span></span>)) ), _sell=Coalesce( <span class="hljs-string"><span class="hljs-string">'hotel__sell'</span></span>, Value(ZERO) ), _sell_currency_rate=Coalesce( <span class="hljs-string"><span class="hljs-string">'hotel__sell_currency_rate'</span></span>, Value(Decimal(<span class="hljs-string"><span class="hljs-string">'1'</span></span>)) ), ).annotate( <span class="hljs-comment"><span class="hljs-comment"># Calculated fields _sell_base=( F('_sell') * F('_sell_currency_rate') ), _refund_base=( F('_refund') * F('_refund_currency_rate') ), _payable_base=( F('_sell_base') - F('_refund_base') ), _reporting_currency_rate=Case( # Only hotels have currency_data, therefore we need a # check and default value When( content_type=Hotel.get_content_type(), then=RawSQL( '(hotel.currency_data-&gt;&gt;%s)::numeric', (partner.reporting_currency,), ), ), output_field=DecimalField(), default=Decimal('1'), ), ) .annotate( _payable_in_cur=( F('_payable_base') / F('_reporting_currency_rate') ) ) before_payment_pending_query = _get_data_from_query( base_query_annotated.filter(_payment_pending__gt=today) ) after_payment_pending_before_payment_due_query = _get_data_from_query( base_query_annotated.filter( Q(_payment_pending__lte=today) &amp; Q(_payment_due__gt=today) ) )</span></span></code> </pre></div></div><br><p> ç°åœ¨æ˜¯è¿™æ ·çš„ï¼š </p><br><p><img src="https://habrastorage.org/webt/xg/1i/rf/xg1irfnazuk-rqk14wdlxn32nhi.png" alt="Timing_after"></p><br><p><img src="https://habrastorage.org/webt/mt/k7/cq/mtk7cqefuzlx96roihjpgvpeaz8.png" alt="count_after"></p><br><h2 id="vyvody"> ç»“è®º </h2><br><p> é‡å†™å¹¶ä¼˜åŒ–é€»è¾‘ä¹‹åï¼Œæˆ‘ä»¬è®¾æ³•ç›¸å½“å¿«åœ°å¤„ç†ä¼šå‘˜æŒ‡æ ‡ï¼Œå¹¶å¤§å¤§å‡å°‘äº†å¯¹æ•°æ®åº“çš„æŸ¥è¯¢æ•°é‡ã€‚ äº‹å®è¯æ˜è¯¥è§£å†³æ–¹æ¡ˆå¾ˆå¥½ï¼Œæˆ‘ä»¬å°†åœ¨é¡¹ç›®çš„å…¶ä»–éƒ¨åˆ†é‡ç”¨æ­¤é€»è¾‘ã€‚  ORMæ˜¯æˆ‘ä»¬çš„ä¸€åˆ‡ã€‚ </p><br><p> å‘è¡¨è¯„è®ºï¼Œæå‡ºé—®é¢˜-æˆ‘ä»¬å°†å°½åŠ›å›ç­”ï¼ è°¢è°¢ä½  </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN447706/">https://habr.com/ru/post/zh-CN447706/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN447696/index.html">ä¸ºä»€ä¹ˆåŸå¸‚åå¯¹ç¬¬ä¸€å®¶éç°é‡‘å•†åº—Amazon Go</a></li>
<li><a href="../zh-CN447698/index.html">çº¢éœæ ¼æ²ƒèŒ¨ï¼šæ²¡æœ‰æ–‡å‡­çš„é™¢å£«</a></li>
<li><a href="../zh-CN447700/index.html">æƒ…ç»ªä¸Šçš„çµæ´»æ€§æ˜¯ä¸ªäººæˆé•¿çš„å…³é”®ã€‚</a></li>
<li><a href="../zh-CN447702/index.html">ç†æƒ³çš„æ•°å­¦åœˆä¸å­˜åœ¨</a></li>
<li><a href="../zh-CN447704/index.html">çˆ¬Elbrus-ä¾¦å¯Ÿæˆ˜ã€‚ æŠ€æœ¯éƒ¨åˆ†1.å¯„å­˜å™¨ï¼Œå †æ ˆå’Œå…¶ä»–æŠ€æœ¯ç»†èŠ‚</a></li>
<li><a href="../zh-CN447708/index.html">Yandexå°†é¦–æ‰¹ä»¥Ilya Segalovichå‘½åçš„ç§‘å­¦å®¶æˆäºˆå¹´è½»çš„ç§‘å­¦å®¶å’Œä¸»ç®¡</a></li>
<li><a href="../zh-CN447712/index.html">å—¨ï¼ŒSaaS | Russian SaaS 2018-ç»“æœ</a></li>
<li><a href="../zh-CN447714/index.html">è®ºARMAè¿‡ç¨‹ç†è®ºåœ¨å·¥ç¨‹å®è·µä¸­çš„åº”ç”¨</a></li>
<li><a href="../zh-CN447716/index.html">å›¢ç»“ï¼šåœ¨ä¸€å£æ°”ä¸­ç”»å‡ºè®¸å¤šå¥åº·æ¡</a></li>
<li><a href="../zh-CN447718/index.html">ä¸€åˆ‡éƒ½ä¼šæŒ‰è®¡åˆ’è¿›è¡Œ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>