<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèΩ‚Äçüç≥ üôçüèø üîÆ Python es un asistente para encontrar vuelos baratos para quienes les gusta viajar üö† üñçÔ∏è üëàüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La autora del art√≠culo, cuya traducci√≥n publicamos hoy, dice que su objetivo es hablar sobre el desarrollo de un raspador web en Python usando Seleniu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Python es un asistente para encontrar vuelos baratos para quienes les gusta viajar</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/451872/">  La autora del art√≠culo, cuya traducci√≥n publicamos hoy, dice que su objetivo es hablar sobre el desarrollo de un raspador web en Python usando Selenium, que busca los precios de las tarifas a√©reas.  Al buscar boletos, se utilizan fechas flexibles (+ - 3 d√≠as en relaci√≥n con las fechas especificadas).  Scraper guarda los resultados de la b√∫squeda en un archivo de Excel y env√≠a a la persona que lo lanz√≥ un correo electr√≥nico con informaci√≥n general sobre lo que logr√≥ encontrar.  El objetivo de este proyecto es ayudar a los viajeros a encontrar las mejores ofertas. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/xl/jo/rr/xljorr2xue-q63wegfrfyt5uxu4.jpeg"></a> <br><br>  Si al tratar con el material siente que est√° perdido, eche un vistazo a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">este</a> art√≠culo. <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">Que estamos buscando</font> </h2><br>  Usted es libre de usar el sistema descrito aqu√≠ de la manera que desee.  Por ejemplo, lo us√© para buscar recorridos de fin de semana y boletos para mi ciudad natal.  Si se toma en serio la b√∫squeda de tickets rentables, puede ejecutar el script en el servidor (un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">servidor</a> simple, por 130 rublos al mes, es bastante adecuado para esto) y hacerlo funcionar una o dos veces al d√≠a.  Los resultados de la b√∫squeda le ser√°n enviados por correo electr√≥nico.  Adem√°s, le recomiendo que configure todo para que el script guarde el archivo de Excel con los resultados de b√∫squeda en la carpeta de Dropbox, que le permite ver dichos archivos desde cualquier lugar y en cualquier momento. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d39/b7b/f3b/d39b7bf3b4f8c11fa9617ae308f01247.png"></div><br>  <i><font color="#999999">Todav√≠a no he encontrado tarifas con errores, pero creo que esto es posible</font></i> <br><br>  Al buscar, como ya se ha dicho, se utiliza una "fecha flexible", el script encuentra ofertas que se encuentran dentro de los tres d√≠as posteriores a las fechas indicadas.  Aunque al iniciar el script, busca ofertas en una sola direcci√≥n, es f√°cil refinarlo para que pueda recopilar datos en varias direcciones de vuelos.  Con su ayuda, incluso puede buscar tarifas err√≥neas, tales hallazgos pueden ser muy interesantes. <br><br><h2>  <font color="#3AC1EF">¬øPor qu√© necesito otro raspador web?</font> </h2><br>  Cuando comenc√© a raspar la web, para ser honesto, no fue particularmente interesante.  Quer√≠a hacer m√°s proyectos en el campo del modelado predictivo, el an√°lisis financiero y, posiblemente, en el campo del an√°lisis del color emocional de los textos.  Pero result√≥ que era muy interesante: descubrir c√≥mo crear un programa que recopile datos de sitios web.  Al profundizar en este tema, me di cuenta de que el raspado web es el "motor" de Internet. <br><br>  Puede decidir que esta es una declaraci√≥n demasiado audaz.  Pero piense en c√≥mo Google comenz√≥ con un raspador web que Larry Page cre√≥ usando Java y Python.  Googlebots ha estado investigando y explorando Internet, tratando de proporcionar a sus usuarios las mejores respuestas posibles a sus preguntas.  El raspado web tiene un n√∫mero infinito de aplicaciones, e incluso si usted, en el campo de la ciencia de datos, est√° interesado en otra cosa, para obtener datos para el an√°lisis, necesitar√° algunas habilidades de raspado. <br><br>  Algunos de los trucos utilizados aqu√≠ los encontr√© en un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">libro</a> maravilloso sobre el raspado web, que recientemente adquir√≠.  En √©l puedes encontrar muchos ejemplos e ideas simples sobre la aplicaci√≥n pr√°ctica de lo estudiado.  Adem√°s, hay un cap√≠tulo muy interesante sobre el bypass de prueba reCaptcha.  Para m√≠, esto era una novedad, ya que no sab√≠a que hab√≠a herramientas especiales e incluso servicios completos para resolver tales problemas. <br><br><h2>  <font color="#3AC1EF">¬øTe gusta viajar?</font> </h2><br>  A la pregunta simple y bastante inofensiva formulada en el encabezado de esta secci√≥n, a menudo se puede escuchar una respuesta positiva, con un par de historias de viaje de la persona a quien se le pregunt√≥.  La mayor√≠a de nosotros estar√° de acuerdo en que viajar es una excelente manera de sumergirse en nuevos entornos culturales y expandir nuestros horizontes.  Sin embargo, si le preguntas a alguien si le gusta buscar boletos a√©reos, estoy seguro de que la respuesta estar√° lejos de ser tan positiva.  De hecho, aqu√≠ Python viene al rescate. <br><br>  La primera tarea que debemos resolver sobre la forma de crear un sistema de b√∫squeda de informaci√≥n sobre boletos a√©reos ser√° la selecci√≥n de una plataforma adecuada con la cual tomaremos informaci√≥n.  La soluci√≥n a este problema no fue f√°cil para m√≠, pero al final eleg√≠ el servicio de Kayak.  Prob√© los servicios de Momondo, Skyscanner, Expedia y algunos m√°s, pero los mecanismos de protecci√≥n contra los robots en estos recursos eran impenetrables.  Despu√©s de varios intentos, durante los cuales, al tratar de convencer a los sistemas de que era humano, tuve que lidiar con sem√°foros, pasos de peatones y bicicletas, decid√≠ que Kayak me quedaba bien, aunque aqu√≠ tambi√©n, si carga demasiadas p√°ginas en poco tiempo, tambi√©n comienzan las verificaciones.  Logr√© hacer que el bot enviara solicitudes al sitio a intervalos de 4 a 6 horas, y todo funcion√≥ bien.  Las dificultades tambi√©n surgen peri√≥dicamente cuando se trabaja con Kayak, pero si comienzas a molestarte con los cheques, entonces debes tratarlos manualmente, luego iniciar el bot o esperar unas horas, y los controles deber√≠an detenerse.  Si es necesario, puede adaptar el c√≥digo para otra plataforma, y ‚Äã‚Äãsi lo hace, puede informarlo en los comentarios. <br><br>  Si reci√©n est√° comenzando con el raspado web y no sabe por qu√© algunos sitios web est√°n luchando con √©l, antes de comenzar su primer proyecto en esta √°rea, h√°gase un favor y busque palabras en Google "Etiqueta de raspado web".  Sus experimentos pueden terminar antes de lo que piensa si est√° involucrado sin motivo en el raspado de la web. <br><br><h2>  <font color="#3AC1EF">Empezando</font> </h2><br>  Aqu√≠ hay una descripci√≥n general de lo que suceder√° en el c√≥digo de nuestro raspador web: <br><br><ul><li>  Importar bibliotecas requeridas. </li><li>  Abre la pesta√±a Google Chrome. </li><li>  Llamando a la funci√≥n que inicia el bot, pas√°ndole la ciudad y la fecha, que se utilizar√° al buscar boletos. </li><li>  Esta funci√≥n recibe los primeros resultados de b√∫squeda, ordenados seg√∫n los criterios de los m√°s atractivos (los mejores), y presiona el bot√≥n para cargar resultados adicionales. </li><li>  Otra funci√≥n recopila datos de toda la p√°gina y devuelve un marco de datos. </li><li>  Los dos pasos anteriores se realizan utilizando tipos de clasificaci√≥n por precio de billete (barato) y por velocidad de vuelo (m√°s r√°pido). </li><li>  Se env√≠a un correo electr√≥nico al usuario del script que contiene un breve resumen de los precios de los boletos (los boletos m√°s baratos y el precio promedio), y el marco de datos con la informaci√≥n ordenada por los tres indicadores antes mencionados se guarda como un archivo Excel. </li><li>  Todas las acciones anteriores se realizan en un ciclo despu√©s de un per√≠odo de tiempo especificado. </li></ul><br>  Cabe se√±alar que cada proyecto Selenium comienza con un controlador web.  Utilizo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Chromedriver</a> , trabajo con Google Chrome, pero hay otras opciones.  Tambi√©n son populares PhantomJS y Firefox.  Despu√©s de cargar el controlador, debe colocarlo en la carpeta correspondiente, esto completa la preparaci√≥n para su uso.  Las primeras l√≠neas de nuestro script abren una nueva pesta√±a de Chrome. <br><br>  Tenga en cuenta que, en mi historia, no estoy tratando de abrir nuevos horizontes para encontrar ofertas rentables en boletos a√©reos.  Existen t√©cnicas mucho m√°s avanzadas para encontrar tales ofertas.  Solo quiero ofrecer a los lectores de este material una forma simple pero pr√°ctica de resolver este problema. <br><br>  Aqu√≠ est√° el c√≥digo del que hablamos anteriormente. <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sleep, strftime <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> random <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> randint <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pandas <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> pd <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> selenium <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> webdriver <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> selenium.webdriver.common.keys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Keys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> smtplib <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> email.mime.multipart <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> MIMEMultipart <span class="hljs-comment"><span class="hljs-comment">#      chromedriver! chromedriver_path = 'C:/{YOUR PATH HERE}/chromedriver_win32/chromedriver.exe' driver = webdriver.Chrome(executable_path=chromedriver_path) #     Chrome sleep(2)</span></span></code> </pre> <br>  Al comienzo del c√≥digo, puede ver los comandos de importaci√≥n de paquetes que se utilizan en todo nuestro proyecto.  Por lo tanto, <code>randint</code> se usa para que el bot se "duerma" durante un n√∫mero aleatorio de segundos antes de comenzar una nueva operaci√≥n de b√∫squeda.  Por lo general, ni un solo bot puede prescindir de √©l.  Si ejecuta el c√≥digo anterior, se abrir√° una ventana de Chrome, que el bot utilizar√° para trabajar con sitios. <br><br>  Hagamos un peque√±o experimento y abra el sitio web kayak.com en una ventana separada.  Elija la ciudad desde la que vamos a volar y la ciudad a la que queremos llegar, as√≠ como las fechas de los vuelos.  Al elegir las fechas, verificaremos que el rango sea de + -3 d√≠as.  Escrib√≠ el c√≥digo teniendo en cuenta lo que produce el sitio en respuesta a tales solicitudes.  Si, por ejemplo, necesita buscar tickets solo para fechas determinadas, es muy probable que tenga que modificar el c√≥digo bot.  Hablando sobre el c√≥digo, hago explicaciones apropiadas, pero si sientes que est√°s confundido, h√°zmelo saber. <br><br>  Ahora haga clic en el bot√≥n de inicio de b√∫squeda y mire el enlace en la barra de direcciones.  Deber√≠a parecerse al enlace que uso en el ejemplo a continuaci√≥n, donde se declara la variable de <code>kayak</code> que almacena la URL y se usa el m√©todo de <code>get</code> del controlador web.  Despu√©s de hacer clic en el bot√≥n de b√∫squeda, los resultados deber√≠an aparecer en la p√°gina. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ae6/ac7/1f7/ae6ac71f71c92c6ff76d5dd6a8fcfa25.png"></div><br>  Cuando utilic√© el comando <code>get</code> m√°s de dos o tres veces en unos minutos, me pidieron que pasara una prueba usando reCaptcha.  Puede realizar esta verificaci√≥n manualmente y continuar los experimentos hasta que el sistema decida organizar una nueva verificaci√≥n.  Cuando prob√© el script, tuve la sensaci√≥n de que la primera sesi√≥n de b√∫squeda siempre funciona sin problemas, por lo que si desea experimentar con el c√≥digo, solo tiene que verificarlo peri√≥dicamente y dejar que el c√≥digo se ejecute utilizando largos intervalos entre las sesiones de b√∫squeda.  S√≠, y si lo piensa, es poco probable que una persona necesite informaci√≥n sobre los precios de los boletos recibidos en intervalos de 10 minutos entre operaciones de b√∫squeda. <br><br><h2>  <font color="#3AC1EF">Trabajando con una p√°gina usando XPath</font> </h2><br>  Entonces, abrimos la ventana y cargamos el sitio.  Para obtener precios y otra informaci√≥n, necesitamos usar la tecnolog√≠a XPath o los selectores CSS.  Decid√≠ detenerme en XPath y no sent√≠ la necesidad de usar selectores CSS, pero es muy posible trabajar as√≠.  Moverse por una p√°gina usando XPath puede ser una tarea desalentadora, e incluso si usa los m√©todos que describ√≠ en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">este</a> art√≠culo, que copiaron los identificadores correspondientes del c√≥digo de la p√°gina, me di cuenta de que, de hecho, esta no es la mejor manera de acceder elementos necesarios  Por cierto, en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">este</a> libro puede encontrar una excelente descripci√≥n de los conceptos b√°sicos del trabajo con p√°ginas que utilizan selectores XPath y CSS.  As√≠ es como se ve el m√©todo del controlador web correspondiente. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fa6/5c0/5c0/fa65c05c0385c658a4eee0c08a6274ff.png"></div><br>  Entonces, continuamos trabajando en el bot.  Aproveche el programa para seleccionar los boletos m√°s baratos.  En la siguiente imagen, el c√≥digo del selector XPath se resalta en rojo.  Para ver el c√≥digo, debe hacer clic derecho en el elemento de la p√°gina que le interesa y seleccionar el comando Inspeccionar en el men√∫ que aparece.  Se puede llamar a este comando para diferentes elementos de p√°gina, cuyo c√≥digo se mostrar√° y resaltar√° en la ventana de visualizaci√≥n de c√≥digo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2c4/eee/9dc/2c4eee9dc28a8ef0ff540e1c01d3eda5.png"></div><br>  <i><font color="#999999">Ver c√≥digo de p√°gina</font></i> <br><br>  Para encontrar la confirmaci√≥n de mi razonamiento sobre las desventajas de copiar selectores del c√≥digo, preste atenci√≥n a las siguientes caracter√≠sticas. <br><br>  Esto es lo que obtienes al copiar c√≥digo: <br><br><pre> <code class="python hljs">//*[@id=<span class="hljs-string"><span class="hljs-string">"wtKI-price_aTab"</span></span>]/div[<span class="hljs-number"><span class="hljs-number">1</span></span>]/div/div/div[<span class="hljs-number"><span class="hljs-number">1</span></span>]/div/span/span</code> </pre> <br>  Para copiar algo similar, debe hacer clic con el bot√≥n derecho en la parte del c√≥digo que le interesa y seleccionar Copiar&gt; Copiar XPath en el men√∫ que aparece. <br><br>  Esto es lo que sol√≠a definir el bot√≥n m√°s barato: <br><br><pre> <code class="python hljs">cheap_results = <span class="hljs-string"><span class="hljs-string">'//a[@data-code = "price"]'</span></span></code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9c9/4e3/8a4/9c94e38a436fa588ade8a2f92d97aa2d.png"></div><br>  <i><font color="#999999">Copiar&gt; Copiar comando XPath</font></i> <br><br>  Es bastante obvio que la segunda opci√≥n parece mucho m√°s simple.  Cuando lo usa, busca el elemento a, que tiene el atributo de <code>data-code</code> igual al <code>price</code> .  Usando la primera opci√≥n, se busca un elemento <code>id</code> que es <code>wtKI-price_aTab</code> , y la ruta XPath al elemento se ve como <code>/div[1]/div/div/div[1]/div/span/span</code> .  Una solicitud XPath similar a una p√°gina har√° el truco, pero solo una vez.  Puedo decir ahora que la <code>id</code> cambiar√° la pr√≥xima vez que se cargue la p√°gina.  La <code>wtKI</code> caracteres <code>wtKI</code> cambia din√°micamente cada vez que se carga la p√°gina, como resultado, el c√≥digo en el que se usa ser√° in√∫til despu√©s de la pr√≥xima recarga de la p√°gina.  As√≠ que t√≥mate un tiempo para descubrir XPath.  Este conocimiento te servir√° bien. <br><br>  Sin embargo, debe tenerse en cuenta que copiar los selectores XPath puede ser √∫til cuando se trabaja con sitios bastante simples, y si esto le conviene, no hay nada de malo en eso. <br><br>  Ahora pensemos qu√© hacer si necesita obtener todos los resultados de b√∫squeda en varias l√≠neas, dentro de la lista.  Muy simple  Cada resultado est√° dentro de un objeto con la clase <code>resultWrapper</code> .  La descarga de todos los resultados se puede realizar en un bucle similar al que se muestra a continuaci√≥n. <br><br>  Debe tenerse en cuenta que si comprende lo anterior, debe comprender f√°cilmente la mayor parte del c√≥digo que analizaremos.  En el curso del trabajo de este c√≥digo, pasamos a lo que necesitamos (de hecho, este es el elemento en el que se envuelve el resultado) usando alg√∫n mecanismo para indicar la ruta (XPath).  Esto se hace para obtener el texto del elemento y colocarlo en un objeto desde el que se puedan leer los datos (primero use <code>flight_containers</code> , luego <code>flights_list</code> ). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0b2/3fc/b7f/0b23fcb7f32738fd6012541c40f68b97.png"></div><br>  Se muestran las primeras tres l√≠neas y podemos ver claramente todo lo que necesitamos.  Sin embargo, tenemos formas m√°s interesantes de obtener informaci√≥n.  Necesitamos tomar datos de cada elemento por separado. <br><br><h2>  <font color="#3AC1EF">A trabajar!</font> </h2><br>  Es m√°s f√°cil escribir una funci√≥n para cargar resultados adicionales, as√≠ que comencemos con ella.  Me gustar√≠a maximizar la cantidad de vuelos sobre los que el programa recibe informaci√≥n y, al mismo tiempo, no causar sospechas en el servicio que conduzcan a la verificaci√≥n, por lo que hago clic en el bot√≥n Cargar m√°s resultados una vez cada vez que se muestra la p√°gina.  En este c√≥digo, debe prestar atenci√≥n al bloque <code>try</code> , que agregu√© debido al hecho de que a veces el bot√≥n no se carga normalmente.  Si tambi√©n encuentra esto, comente las llamadas a esta funci√≥n en el c√≥digo de la funci√≥n <code>start_kayak</code> , que discutiremos a continuaci√≥n. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#      ,      def load_more():   try:       more_results = '//a[@class = "moreButton"]'       driver.find_element_by_xpath(more_results).click()       #            ,          print('sleeping.....')       sleep(randint(45,60))   except:       pass</span></span></code> </pre> <br>  Ahora, despu√©s de un largo an√°lisis de esta funci√≥n (a veces puedo dejarme llevar), estamos listos para declarar una funci√≥n que se ocupar√° del raspado de p√°gina. <br><br>  Ya he recopilado la mayor parte de lo que se necesita en la pr√≥xima funci√≥n llamada <code>page_scrape</code> .  A veces, los datos devueltos sobre las etapas de la ruta se combinan, para su separaci√≥n utilizo un m√©todo simple.  Por ejemplo, la primera vez que uso las variables <code>section_a_list</code> y <code>section_b_list</code> .  Nuestra funci√≥n devuelve el marco de datos <code>flights_df</code> , esto nos permite separar los resultados obtenidos utilizando diferentes m√©todos de clasificaci√≥n de datos y luego combinarlos. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">page_scrape</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span>   <span class="hljs-string"><span class="hljs-string">"""This function takes care of the scraping part"""</span></span>     xp_sections = <span class="hljs-string"><span class="hljs-string">'//*[@class="section duration"]'</span></span>   sections = driver.find_elements_by_xpath(xp_sections)   sections_list = [value.text <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> sections]   section_a_list = sections_list[::<span class="hljs-number"><span class="hljs-number">2</span></span>] <span class="hljs-comment"><span class="hljs-comment">#          section_b_list = sections_list[1::2]     #     reCaptcha,    - .   #  ,  -   ,     ,       #   if        -   #    ,           #    SystemExit           if section_a_list == []:       raise SystemExit     #     A     B     a_duration = []   a_section_names = []   for n in section_a_list:       #         a_section_names.append(''.join(n.split()[2:5]))       a_duration.append(''.join(n.split()[0:2]))   b_duration = []   b_section_names = []   for n in section_b_list:       #         b_section_names.append(''.join(n.split()[2:5]))       b_duration.append(''.join(n.split()[0:2]))   xp_dates = '//div[@class="section date"]'   dates = driver.find_elements_by_xpath(xp_dates)   dates_list = [value.text for value in dates]   a_date_list = dates_list[::2]   b_date_list = dates_list[1::2]   #      a_day = [value.split()[0] for value in a_date_list]   a_weekday = [value.split()[1] for value in a_date_list]   b_day = [value.split()[0] for value in b_date_list]   b_weekday = [value.split()[1] for value in b_date_list]     #     xp_prices = '//a[@class="booking-link"]/span[@class="price option-text"]'   prices = driver.find_elements_by_xpath(xp_prices)   prices_list = [price.text.replace('$','') for price in prices if price.text != '']   prices_list = list(map(int, prices_list))   # stops -   ,         ,   -     xp_stops = '//div[@class="section stops"]/div[1]'   stops = driver.find_elements_by_xpath(xp_stops)   stops_list = [stop.text[0].replace('n','0') for stop in stops]   a_stop_list = stops_list[::2]   b_stop_list = stops_list[1::2]   xp_stops_cities = '//div[@class="section stops"]/div[2]'   stops_cities = driver.find_elements_by_xpath(xp_stops_cities)   stops_cities_list = [stop.text for stop in stops_cities]   a_stop_name_list = stops_cities_list[::2]   b_stop_name_list = stops_cities_list[1::2]     #   -,          xp_schedule = '//div[@class="section times"]'   schedules = driver.find_elements_by_xpath(xp_schedule)   hours_list = []   carrier_list = []   for schedule in schedules:       hours_list.append(schedule.text.split('\n')[0])       carrier_list.append(schedule.text.split('\n')[1])   #          a  b   a_hours = hours_list[::2]   a_carrier = carrier_list[1::2]   b_hours = hours_list[::2]   b_carrier = carrier_list[1::2]     cols = (['Out Day', 'Out Time', 'Out Weekday', 'Out Airline', 'Out Cities', 'Out Duration', 'Out Stops', 'Out Stop Cities',           'Return Day', 'Return Time', 'Return Weekday', 'Return Airline', 'Return Cities', 'Return Duration', 'Return Stops', 'Return Stop Cities',           'Price'])   flights_df = pd.DataFrame({'Out Day': a_day,                              'Out Weekday': a_weekday,                              'Out Duration': a_duration,                              'Out Cities': a_section_names,                              'Return Day': b_day,                              'Return Weekday': b_weekday,                              'Return Duration': b_duration,                              'Return Cities': b_section_names,                              'Out Stops': a_stop_list,                              'Out Stop Cities': a_stop_name_list,                              'Return Stops': b_stop_list,                              'Return Stop Cities': b_stop_name_list,                              'Out Time': a_hours,                              'Out Airline': a_carrier,                              'Return Time': b_hours,                              'Return Airline': b_carrier,                                                     'Price': prices_list})[cols]     flights_df['timestamp'] = strftime("%Y%m%d-%H%M") #      return flights_df</span></span></code> </pre> <br>  Trat√© de nombrar las variables para que el c√≥digo fuera claro.  Recuerde que las variables que comienzan con <code>a</code> refieren al primer paso de la ruta <code>b</code> al segundo.  Ir a la siguiente funci√≥n. <br><br><h2>  <font color="#3AC1EF">Mecanismos auxiliares</font> </h2><br>  Ahora tenemos una funci√≥n que le permite cargar resultados de b√∫squeda adicionales y una funci√≥n para procesar estos resultados.  Este art√≠culo podr√≠a completarse sobre esto, ya que estas dos funciones proporcionan todo lo necesario para raspar p√°ginas que se pueden abrir de forma independiente.  Pero todav√≠a no hemos considerado algunos de los mecanismos auxiliares discutidos anteriormente.  Por ejemplo, este es un c√≥digo para enviar correos electr√≥nicos y algunas otras cosas.  Todo esto se puede encontrar en la funci√≥n <code>start_kayak</code> , que ahora consideramos. <br><br>  Para usar esta funci√≥n, necesita informaci√≥n sobre ciudades y fechas.  Con esta informaci√≥n, forma un enlace en la variable <code>kayak</code> , que se utiliza para ir a una p√°gina que contendr√° los resultados de b√∫squeda ordenados por su mejor coincidencia.  Despu√©s de la primera sesi√≥n de scraping, trabajaremos con los precios en la tabla en la parte superior de la p√°gina.  A saber, encontramos el precio m√≠nimo del boleto y el precio promedio.  Todo esto, junto con la predicci√≥n emitida por el sitio, se enviar√° por correo electr√≥nico.  En la p√°gina, la tabla correspondiente debe estar en la esquina superior izquierda.  Trabajar con esta tabla, por cierto, puede causar un error al buscar usando fechas exactas, ya que en este caso la tabla no se muestra en la p√°gina. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start_kayak</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(city_from, city_to, date_start, date_end)</span></span></span><span class="hljs-function">:</span></span>   <span class="hljs-string"><span class="hljs-string">"""City codes - it's the IATA codes!   Date format -  YYYY-MM-DD"""</span></span>     kayak = (<span class="hljs-string"><span class="hljs-string">'https://www.kayak.com/flights/'</span></span> + city_from + <span class="hljs-string"><span class="hljs-string">'-'</span></span> + city_to +            <span class="hljs-string"><span class="hljs-string">'/'</span></span> + date_start + <span class="hljs-string"><span class="hljs-string">'-flexible/'</span></span> + date_end + <span class="hljs-string"><span class="hljs-string">'-flexible?sort=bestflight_a'</span></span>)   driver.get(kayak)   sleep(randint(<span class="hljs-number"><span class="hljs-number">8</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>))     <span class="hljs-comment"><span class="hljs-comment">#    ,           try   try:       xp_popup_close = '//button[contains(@id,"dialog-close") and contains(@class,"Button-No-Standard-Style close ")]'       driver.find_elements_by_xpath(xp_popup_close)[5].click()   except Exception as e:       pass   sleep(randint(60,95))   print('loading more.....')  #     load_more()     print('starting first scrape.....')   df_flights_best = page_scrape()   df_flights_best['sort'] = 'best'   sleep(randint(60,80))     #      ,        matrix = driver.find_elements_by_xpath('//*[contains(@id,"FlexMatrixCell")]')   matrix_prices = [price.text.replace('$','') for price in matrix]   matrix_prices = list(map(int, matrix_prices))   matrix_min = min(matrix_prices)   matrix_avg = sum(matrix_prices)/len(matrix_prices)     print('switching to cheapest results.....')   cheap_results = '//a[@data-code = "price"]'   driver.find_element_by_xpath(cheap_results).click()   sleep(randint(60,90))   print('loading more.....')  #     load_more()     print('starting second scrape.....')   df_flights_cheap = page_scrape()   df_flights_cheap['sort'] = 'cheap'   sleep(randint(60,80))     print('switching to quickest results.....')   quick_results = '//a[@data-code = "duration"]'   driver.find_element_by_xpath(quick_results).click()    sleep(randint(60,90))   print('loading more.....')  #     load_more()     print('starting third scrape.....')   df_flights_fast = page_scrape()   df_flights_fast['sort'] = 'fast'   sleep(randint(60,80))     #     Excel-,         final_df = df_flights_cheap.append(df_flights_best).append(df_flights_fast)   final_df.to_excel('search_backups//{}_flights_{}-{}_from_{}_to_{}.xlsx'.format(strftime("%Y%m%d-%H%M"),                                                                                  city_from, city_to,                                                                                  date_start, date_end), index=False)   print('saved df.....')     #    ,  ,  ,      xp_loading = '//div[contains(@id,"advice")]'   loading = driver.find_element_by_xpath(xp_loading).text   xp_prediction = '//span[@class="info-text"]'   prediction = driver.find_element_by_xpath(xp_prediction).text   print(loading+'\n'+prediction)     #    loading   , , ,        #    -    "Not Sure"   weird = '¬Ø\\_(„ÉÑ)_/¬Ø'   if loading == weird:       loading = 'Not sure'     username = 'YOUREMAIL@hotmail.com'   password = 'YOUR PASSWORD'   server = smtplib.SMTP('smtp.outlook.com', 587)   server.ehlo()   server.starttls()   server.login(username, password)   msg = ('Subject: Flight Scraper\n\n\ Cheapest Flight: {}\nAverage Price: {}\n\nRecommendation: {}\n\nEnd of message'.format(matrix_min, matrix_avg, (loading+'\n'+prediction)))   message = MIMEMultipart()   message['From'] = 'YOUREMAIL@hotmail.com'   message['to'] = 'YOUROTHEREMAIL@domain.com'   server.sendmail('YOUREMAIL@hotmail.com', 'YOUROTHEREMAIL@domain.com', msg)   print('sent email.....')</span></span></code> </pre> <br>  Prob√© este script usando una cuenta de Outlook (hotmail.com).  No verifiqu√© el funcionamiento correcto de la cuenta de Gmail, este sistema de correo es muy popular, pero hay muchas opciones posibles.  Si usa una cuenta de Hotmail, para que todo funcione, solo necesita ingresar sus datos en el c√≥digo. <br><br>  Si desea comprender qu√© se realiza exactamente en secciones separadas del c√≥digo de esta funci√≥n, puede copiarlas y experimentar con ellas.  Los experimentos de c√≥digo son la √∫nica forma de entenderlo. <br><br><h2>  <font color="#3AC1EF">Sistema listo</font> </h2><br>  Ahora que todo lo que hablamos est√° hecho, podemos crear un ciclo simple en el que se llaman nuestras funciones.  El script solicita al usuario datos sobre ciudades y fechas.  Al probar con un reinicio constante del script, es poco probable que desee ingresar estos datos manualmente cada vez, por lo que las l√≠neas correspondientes, durante la duraci√≥n de la prueba, se pueden comentar sin comentar aquellas debajo de ellas en las que los datos necesarios para el script est√°n codificados. <br><br><pre> <code class="python hljs">city_from = input(<span class="hljs-string"><span class="hljs-string">'From which city? '</span></span>) city_to = input(<span class="hljs-string"><span class="hljs-string">'Where to? '</span></span>) date_start = input(<span class="hljs-string"><span class="hljs-string">'Search around which departure date? Please use YYYY-MM-DD format only '</span></span>) date_end = input(<span class="hljs-string"><span class="hljs-string">'Return when? Please use YYYY-MM-DD format only '</span></span>) <span class="hljs-comment"><span class="hljs-comment"># city_from = 'LIS' # city_to = 'SIN' # date_start = '2019-08-21' # date_end = '2019-09-07' for n in range(0,5):   start_kayak(city_from, city_to, date_start, date_end)   print('iteration {} was complete @ {}'.format(n, strftime("%Y%m%d-%H%M")))     #  4    sleep(60*60*4)   print('sleep finished.....')</span></span></code> </pre> <br>  Aqu√≠ est√° la ejecuci√≥n de prueba del script. <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/44c/305/023/44c305023996a98a3dec745493dce7a7.png"></div><br>  <i><font color="#999999">Script de ejecuci√≥n de prueba</font></i> <br><br><h2>  <font color="#3AC1EF">Resumen</font> </h2><br>  Si llegas a este punto, ¬°felicidades!  Ahora tiene un raspador web que funciona, aunque ya veo muchas formas de mejorarlo.  Por ejemplo, se puede integrar con Twilio para que, en lugar de correos electr√≥nicos, env√≠e mensajes de texto.  Puede usar una VPN o algo m√°s para recibir simult√°neamente resultados de m√∫ltiples servidores.  Tambi√©n hay un problema recurrente al verificar si el usuario del sitio es una persona, pero este problema tambi√©n se puede resolver.  En cualquier caso, ahora tiene una base que puede expandir si lo desea.  Por ejemplo, para asegurarse de que el archivo de Excel se env√≠e al usuario como un archivo adjunto a un correo electr√≥nico. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/451872/">https://habr.com/ru/post/451872/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../451860/index.html">Los matem√°ticos han descubierto la forma perfecta de multiplicar n√∫meros.</a></li>
<li><a href="../451862/index.html">Rayo musical de Joe Diprim: un ingeniero autodidacta hace bobinas de Tesla para entretenimiento y ganancias</a></li>
<li><a href="../451864/index.html">Vulnerabilidad cr√≠tica de RCE del nivel EternalBlue detectado en el sistema operativo Windows</a></li>
<li><a href="../451866/index.html">Elija los nodos m√°s cercanos en la red</a></li>
<li><a href="../451870/index.html">Funciones modernas de C ++ que todos los programadores deben conocer</a></li>
<li><a href="../451874/index.html">Principales tendencias de SEO en Google</a></li>
<li><a href="../451876/index.html">Centro de datos de Frankfurt: centro de datos de Telehouse</a></li>
<li><a href="../451878/index.html">Transmisi√≥n en vivo de video est√©reo a gafas VR (Oculus Go)</a></li>
<li><a href="../451880/index.html">DevPRO'19: vista desde el stand de Wrike</a></li>
<li><a href="../451884/index.html">Siete a√±os de trabajo como desarrollador: ¬øqu√© lecciones he aprendido?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>