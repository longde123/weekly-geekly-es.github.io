<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ— ğŸ”½ ğŸ¤º å¼‚æ­¥ç¼–ç¨‹-å¼‚æ­¥æ€§èƒ½ï¼šäº†è§£å¼‚æ­¥å’Œç­‰å¾…çš„æˆæœ¬ ğŸ¤³ â†–ï¸ ğŸ¥ˆ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æœ¬æ–‡é¢‡ä¸ºå¤è€ï¼Œä½†å¹¶æœªå¤±å»å…¶ç›¸å…³æ€§ã€‚ å½“æ¶‰åŠåˆ°å¼‚æ­¥/ç­‰å¾…æ—¶ï¼Œé€šå¸¸ä¼šå‡ºç°ä¸€ä¸ªé“¾æ¥ã€‚ æˆ‘æ‰¾ä¸åˆ°ä¿„è¯­ç¿»è¯‘ï¼Œæ‰€ä»¥æˆ‘å†³å®šå¸®åŠ©ä¸€ä¸ªä¸æµåˆ©çš„äººã€‚ 



é•¿æœŸä»¥æ¥ï¼Œå¼‚æ­¥ç¼–ç¨‹ä¸€ç›´æ˜¯æœ€æœ‰ç»éªŒçš„å¼€å‘è€…çš„ç‹å›½ï¼Œä»–ä»¬æ¸´æœ›å—è™ç‹‚-é‚£äº›æœ‰è¶³å¤Ÿçš„ç©ºé—²æ—¶é—´ï¼Œçˆ±å¥½å’Œå¿ƒç†èƒ½åŠ›æ¥è€ƒè™‘éçº¿æ€§æ‰§è¡Œæµä¸­çš„å›è°ƒçš„äººã€‚ éšç€Microsoft .N...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å¼‚æ­¥ç¼–ç¨‹-å¼‚æ­¥æ€§èƒ½ï¼šäº†è§£å¼‚æ­¥å’Œç­‰å¾…çš„æˆæœ¬</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/458332/"><p> æœ¬æ–‡é¢‡ä¸ºå¤è€ï¼Œä½†å¹¶æœªå¤±å»å…¶ç›¸å…³æ€§ã€‚ å½“æ¶‰åŠåˆ°å¼‚æ­¥/ç­‰å¾…æ—¶ï¼Œé€šå¸¸ä¼šå‡ºç°ä¸€ä¸ªé“¾æ¥ã€‚ æˆ‘æ‰¾ä¸åˆ°ä¿„è¯­ç¿»è¯‘ï¼Œæ‰€ä»¥æˆ‘å†³å®šå¸®åŠ©ä¸€ä¸ªä¸æµåˆ©çš„äººã€‚ </p><br><hr><br><p>é•¿æœŸä»¥æ¥ï¼Œå¼‚æ­¥ç¼–ç¨‹ä¸€ç›´æ˜¯æœ€æœ‰ç»éªŒçš„å¼€å‘è€…çš„ç‹å›½ï¼Œä»–ä»¬æ¸´æœ›å—è™ç‹‚-é‚£äº›æœ‰è¶³å¤Ÿçš„ç©ºé—²æ—¶é—´ï¼Œçˆ±å¥½å’Œå¿ƒç†èƒ½åŠ›æ¥è€ƒè™‘éçº¿æ€§æ‰§è¡Œæµä¸­çš„å›è°ƒçš„äººã€‚ éšç€Microsoft .NET Framework 4.5çš„é—®ä¸–ï¼ŒCï¼ƒå’ŒVisual Basicç»™æˆ‘ä»¬å¸¦æ¥äº†å¼‚æ­¥ï¼Œå› æ­¤ï¼Œå‡¡äººç°åœ¨å¯ä»¥å‡ ä¹åƒåŒæ­¥æ–¹æ³•ä¸€æ ·å®¹æ˜“åœ°ç¼–å†™å¼‚æ­¥æ–¹æ³•ã€‚ ä¸å†éœ€è¦å›è°ƒã€‚ ä¸å†éœ€è¦ä»ä¸€ä¸ªåŒæ­¥ä¸Šä¸‹æ–‡åˆ°å¦ä¸€ä¸ªåŒæ­¥ä¸Šä¸‹æ–‡çš„æ˜¾å¼å°é€å¤„ç†ä»£ç ã€‚ æ— éœ€æ‹…å¿ƒæ‰§è¡Œç»“æœæˆ–å¼‚å¸¸å¦‚ä½•ç§»åŠ¨ã€‚ æ— éœ€ä¸ºäº†ä½¿å¼€å‘å¼‚æ­¥ä»£ç æ–¹ä¾¿è€Œä½¿ç¼–ç¨‹è¯­è¨€çš„æ‰‹æ®µå˜å½¢çš„æŠ€å·§ã€‚ ç®€è€Œè¨€ä¹‹ï¼Œä¸å†æœ‰éº»çƒ¦å’Œå¤´ç—›ã€‚ </p><a name="habracut"></a><br><p> å½“ç„¶ï¼Œå°½ç®¡ç°åœ¨å¼€å§‹ç¼–å†™å¼‚æ­¥æ–¹æ³•å¾ˆå®¹æ˜“ï¼ˆè¯·å‚è§ã€Š <em>MSDNæ‚å¿—ã€‹ [2011å¹´10æœˆ]ä¸­</em>çš„Eric Lippertå’Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Mads Torgersen</a>çš„æ–‡ç« ï¼‰ï¼Œä½†éœ€è¦æ­£ç¡®ç†è§£æ‰èƒ½åšåˆ°ã€‚å†…å¹•å‘ç”Ÿäº†ä»€ä¹ˆã€‚ æ¯å½“è¯­è¨€æˆ–åº“æé«˜å¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨çš„æŠ½è±¡çº§åˆ«æ—¶ï¼Œä¸å¯é¿å…åœ°ä¼šä¼´éšç€é™ä½ç”Ÿäº§ç‡çš„éšæ€§æˆæœ¬ã€‚ åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œè¿™äº›æˆæœ¬å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œå› æ­¤å¤§å¤šæ•°ç¨‹åºå‘˜å¯ä»¥åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹å°†å…¶å¿½ç•¥ã€‚ ä½†æ˜¯ï¼Œé«˜çº§å¼€å‘äººå‘˜åº”å……åˆ†äº†è§£å­˜åœ¨å“ªäº›æˆæœ¬ï¼Œä»¥ä¾¿é‡‡å–å¿…è¦çš„æªæ–½å¹¶è§£å†³å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼ˆå¦‚æœå®ƒä»¬è¡¨ç°å‡ºæ¥ï¼‰ã€‚ åœ¨Cï¼ƒå’ŒVisual Basicä¸­ä½¿ç”¨å¼‚æ­¥ç¼–ç¨‹å·¥å…·æ—¶ï¼Œè¿™æ˜¯å¿…éœ€çš„ã€‚ </p><br><p> åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†æè¿°å¼‚æ­¥æ–¹æ³•çš„è¾“å…¥å’Œè¾“å‡ºï¼Œè§£é‡Šå¦‚ä½•å®ç°å¼‚æ­¥æ–¹æ³•ï¼Œå¹¶è®¨è®ºä¸€äº›è¾ƒå°çš„æˆæœ¬ã€‚ è¯·æ³¨æ„ï¼Œè¿™ä¸æ˜¯å»ºè®®ä»¥å¾®ä¼˜åŒ–å’Œæ€§èƒ½çš„åä¹‰å°†å¯è¯»ä»£ç æ‰­æ›²ä¸ºéš¾ä»¥ç»´æŠ¤çš„å†…å®¹ã€‚ è¿™åªæ˜¯æœ‰åŠ©äºè¯Šæ–­æ‚¨å¯èƒ½é‡åˆ°çš„é—®é¢˜çš„çŸ¥è¯†ï¼Œä»¥åŠå…‹æœè¿™äº›é—®é¢˜çš„ä¸€ç³»åˆ—å·¥å…·ã€‚ æ­¤å¤–ï¼Œæœ¬æ–‡åŸºäº.NET Framework 4.5ç‰ˆé¢„è§ˆï¼Œå¹¶ä¸”æœ€ç»ˆå‘è¡Œç‰ˆä¸­çš„ç‰¹å®šå®ç°ç»†èŠ‚å¯èƒ½ä¼šæ›´æ”¹ã€‚ </p><br><h4 id="poluchit-udobnuyu-model-myshleniya"> è·å¾—èˆ’é€‚çš„æ€ç»´æ¨¡å¼ </h4><br><p> æ•°åå¹´æ¥ï¼Œç¨‹åºå‘˜ä¸€ç›´åœ¨ä½¿ç”¨é«˜çº§ç¼–ç¨‹è¯­è¨€Cï¼ƒï¼ŒVisual Basicï¼ŒFï¼ƒå’ŒC ++å¼€å‘é«˜æ•ˆçš„åº”ç”¨ç¨‹åºã€‚ è¿™ç§ç»éªŒä½¿ç¨‹åºå‘˜å¯ä»¥è¯„ä¼°å„ç§æ“ä½œçš„æˆæœ¬å¹¶è·å¾—æœ‰å…³æœ€ä½³å¼€å‘æŠ€æœ¯çš„çŸ¥è¯†ã€‚ ä¾‹å¦‚ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè°ƒç”¨åŒæ­¥æ–¹æ³•æ˜¯ç›¸å¯¹ç»æµçš„ï¼Œç‰¹åˆ«æ˜¯å¦‚æœç¼–è¯‘å™¨å¯ä»¥å°†è°ƒç”¨æ–¹æ³•çš„å†…å®¹ç›´æ¥åµŒå…¥åˆ°è°ƒç”¨ç‚¹ä¸­æ—¶ã€‚ å› æ­¤ï¼Œå¼€å‘äººå‘˜ä¹ æƒ¯äºå°†ä»£ç åˆ†æˆå°çš„ï¼Œæ˜“äºç»´æŠ¤çš„æ–¹æ³•ï¼Œè€Œä¸å¿…æ‹…å¿ƒå¢åŠ è°ƒç”¨æ¬¡æ•°å¸¦æ¥çš„è´Ÿé¢å½±å“ã€‚ è¿™äº›ç¨‹åºå‘˜çš„æ€ç»´æ¨¡å‹æ—¨åœ¨å¤„ç†æ–¹æ³•è°ƒç”¨ã€‚ </p><br><p> éšç€å¼‚æ­¥æ–¹æ³•çš„å‡ºç°ï¼Œéœ€è¦ä¸€ç§æ–°çš„æ€ç»´æ¨¡å‹ã€‚  Cï¼ƒå’ŒVisual BasicåŠå…¶ç¼–è¯‘å™¨èƒ½å¤Ÿåˆ›å»ºä¸€ç§å¹»è±¡ï¼Œå³å¼‚æ­¥æ–¹æ³•å¯ä»¥ç”¨ä½œå…¶åŒæ­¥å‰¯æœ¬ï¼Œå°½ç®¡å†…éƒ¨çš„ä¸€åˆ‡éƒ½æ˜¯å®Œå…¨é”™è¯¯çš„ã€‚ ç¼–è¯‘å™¨ä¸ºç¨‹åºå‘˜ç”Ÿæˆäº†å¤§é‡ä»£ç ï¼Œè¿™ä¸å¼€å‘äººå‘˜åœ¨éœ€è¦æ‰‹å·¥å®Œæˆæ—¶ç¼–å†™çš„ç”¨äºæ”¯æŒå¼‚æ­¥çš„æ ‡å‡†æ¨¡æ¿éå¸¸ç›¸ä¼¼ã€‚ æ­¤å¤–ï¼Œç”±ç¼–è¯‘å™¨ç”Ÿæˆçš„ä»£ç åŒ…å«å¯¹.NET Frameworkåº“å‡½æ•°çš„è°ƒç”¨ï¼Œä»è€Œè¿›ä¸€æ­¥å‡å°‘äº†ç¨‹åºå‘˜éœ€è¦åšçš„å·¥ä½œé‡ã€‚ ä¸ºäº†æ‹¥æœ‰æ­£ç¡®çš„æ€ç»´æ¨¡å‹å¹¶ä½¿ç”¨å®ƒåšå‡ºæ˜æ™ºçš„å†³ç­–ï¼Œé‡è¦çš„æ˜¯è¦äº†è§£ç¼–è¯‘å™¨ä¸ºæ‚¨ç”Ÿæˆçš„å†…å®¹ã€‚ </p><br><h4 id="bolshe-razmer-metodov-menshe-vyzovov"> æ›´å¤šæ–¹æ³•ï¼Œæ›´å°‘è°ƒç”¨ </h4><br><p> ä½¿ç”¨åŒæ­¥ä»£ç æ—¶ï¼Œè¿è¡Œå†…å®¹ä¸ºç©ºçš„æ–¹æ³•å‡ ä¹æ¯«æ— ç”¨å¤„ã€‚ å¯¹äºå¼‚æ­¥æ–¹æ³•ï¼Œæƒ…å†µå¹¶éå¦‚æ­¤ã€‚ è€ƒè™‘ä¸€ä¸‹è¿™ç§å¼‚æ­¥æ–¹æ³•ï¼Œå®ƒç”±ä¸€æ¡æŒ‡ä»¤ç»„æˆï¼ˆç”±äºç¼ºå°‘awaitè¯­å¥ï¼Œè¯¥æŒ‡ä»¤å°†è¢«åŒæ­¥æ‰§è¡Œï¼‰ï¼š </p><br><pre><code class="plaintext hljs">public static async Task SimpleBodyAsync() { Console.WriteLine("Hello, Async World!"); }</code> </pre> <br><p> ä¸­é—´è¯­è¨€åç¼–è¯‘å™¨ï¼ˆILï¼‰å°†åœ¨ç¼–è¯‘åæ˜¾ç¤ºæ­¤å‡½æ•°çš„çœŸå®å†…å®¹ï¼Œå¹¶è¾“å‡ºç±»ä¼¼äºå›¾1çš„å†…å®¹ã€‚ä»€ä¹ˆæ˜¯å°†ç®€å•çš„å•è¡Œä»£ç è½¬æ¢ä¸ºä¸¤ç§æ–¹æ³•ï¼Œå…¶ä¸­ä¸€ç§å±äºçŠ¶æ€æœºçš„è¾…åŠ©ç±»ã€‚ ç¬¬ä¸€ä¸ªæ˜¯å­˜æ ¹æ–¹æ³•ï¼Œå…¶ç­¾åä¸ç¨‹åºå‘˜ç¼–å†™çš„ç­¾åç›¸ä¼¼ï¼ˆæ­¤æ–¹æ³•å…·æœ‰ç›¸åŒçš„åç§°ï¼Œç›¸åŒçš„ä½œç”¨åŸŸï¼Œé‡‡ç”¨ç›¸åŒçš„å‚æ•°å¹¶è¿”å›ç›¸åŒçš„ç±»å‹ï¼‰ï¼Œä½†ä¸åŒ…å«ç¨‹åºå‘˜ç¼–å†™çš„ä»£ç ã€‚ å®ƒä»…åŒ…å«ç”¨äºåˆå§‹è®¾ç½®çš„æ ‡å‡†æ ·æ¿ã€‚ åˆå§‹è®¾ç½®ä»£ç åˆå§‹åŒ–è¡¨ç¤ºå¼‚æ­¥æ–¹æ³•æ‰€éœ€çš„çŠ¶æ€æœºï¼Œå¹¶ä½¿ç”¨å¯¹MoveNextå®ç”¨ç¨‹åºæ–¹æ³•çš„è°ƒç”¨æ¥å¯åŠ¨å®ƒã€‚ çŠ¶æ€æœºçš„å¯¹è±¡ç±»å‹åŒ…å«ä¸€ä¸ªå…·æœ‰å¼‚æ­¥æ–¹æ³•æ‰§è¡ŒçŠ¶æ€çš„å˜é‡ï¼Œå…è®¸æ‚¨åœ¨å¼‚æ­¥ç­‰å¾…ç‚¹ä¹‹é—´åˆ‡æ¢æ—¶ä¿å­˜å®ƒã€‚ å®ƒè¿˜åŒ…å«ç”±ç¨‹åºå‘˜ç¼–å†™çš„ä»£ç ï¼Œå¯¹å…¶è¿›è¡Œäº†ä¿®æ”¹ä»¥ç¡®ä¿å°†æ‰§è¡Œç»“æœå’Œå¼‚å¸¸ä¼ è¾“åˆ°è¿”å›çš„Taskå¯¹è±¡ï¼› ä¿æŒæ–¹æ³•ä¸­çš„å½“å‰ä½ç½®ï¼Œä»¥ä¾¿å¯ä»¥åœ¨æ¢å¤åä»è¯¥ä½ç½®ç»§ç»­æ‰§è¡Œæ“ä½œï¼Œç­‰ç­‰ã€‚ </p><br><p>  <strong>å›¾1</strong>å¼‚æ­¥æ–¹æ³•æ¨¡æ¿ </p><br><pre> <code class="plaintext hljs">[DebuggerStepThrough] public static Task SimpleBodyAsync() { &lt;SimpleBodyAsync&gt;d__0 d__ = new &lt;SimpleBodyAsync&gt;d__0(); d__.&lt;&gt;t__builder = AsyncTaskMethodBuilder.Create(); d__.MoveNext(); return d__.&lt;&gt;t__builder.Task; } [CompilerGenerated] [StructLayout(LayoutKind.Sequential)] private struct &lt;SimpleBodyAsync&gt;d__0 : &lt;&gt;t__IStateMachine { private int &lt;&gt;1__state; public AsyncTaskMethodBuilder &lt;&gt;t__builder; public Action &lt;&gt;t__MoveNextDelegate; public void MoveNext() { try { if (this.&lt;&gt;1__state == -1) return; Console.WriteLine("Hello, Async World!"); } catch (Exception e) { this.&lt;&gt;1__state = -1; this.&lt;&gt;t__builder.SetException(e); return; } this.&lt;&gt;1__state = -1; this.&lt;&gt;t__builder.SetResult(); } ... }</code> </pre> <br><p> å½“æ‚¨æƒ³çŸ¥é“å¯¹å¼‚æ­¥æ–¹æ³•çš„è°ƒç”¨è¦èŠ±å¤šå°‘é’±æ—¶ï¼Œè¯·è®°ä½è¿™ç§æ¨¡å¼ã€‚ éœ€è¦ä½¿ç”¨MoveNextæ–¹æ³•ä¸­çš„try / catchå—æ¥é˜²æ­¢ç¼–è¯‘å™¨å¯èƒ½ä¼šå°è¯•é€šè¿‡JITåµŒå…¥æ­¤æ–¹æ³•ï¼Œå› æ­¤è‡³å°‘æˆ‘ä»¬å¾—åˆ°äº†è°ƒç”¨è¯¥æ–¹æ³•çš„å¼€é”€ï¼Œè€Œå½“ä½¿ç”¨åŒæ­¥æ–¹æ³•æ—¶ï¼Œæ­¤è°ƒç”¨å¾ˆå¯èƒ½ä¸ä¼šï¼ˆæä¾›ï¼‰ç®€çº¦å†…å®¹ï¼‰ã€‚ æˆ‘ä»¬å°†æ”¶åˆ°ä¸€äº›å¯¹Frameworkè¿‡ç¨‹çš„è°ƒç”¨ï¼ˆä¾‹å¦‚SetResultï¼‰ã€‚ ä»¥åŠçŠ¶æ€æœºå¯¹è±¡å­—æ®µä¸­çš„å‡ ä¸ªå†™æ“ä½œã€‚ å½“ç„¶ï¼Œæˆ‘ä»¬éœ€è¦å°†æ‰€æœ‰è¿™äº›æˆæœ¬ä¸Console.WriteLineçš„æˆæœ¬è¿›è¡Œæ¯”è¾ƒï¼Œåè€…å¯èƒ½ä¼šå ä¼˜åŠ¿ï¼ˆå®ƒä»¬åŒ…æ‹¬é”å®šï¼ŒI / Oç­‰çš„æˆæœ¬ï¼‰ã€‚è¯·æ³¨æ„ç¯å¢ƒä¸ºæ‚¨åšå‡ºçš„ä¼˜åŒ–ã€‚ ä¾‹å¦‚ï¼ŒçŠ¶æ€æœºçš„å¯¹è±¡è¢«å®ç°ä¸ºç»“æ„ï¼ˆstructï¼‰ã€‚ ä»…å½“è¯¥æ–¹æ³•éœ€è¦æš‚åœæ‰§è¡Œï¼Œç­‰å¾…æ“ä½œå®Œæˆæ—¶ï¼Œæ‰ä¼šå°†è¯¥ç»“æ„æ”¾å…¥æ‰˜ç®¡å †ä¸­ï¼Œè€Œåœ¨è¿™ç§ç®€å•æ–¹æ³•ä¸­æ°¸è¿œä¸ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚ å› æ­¤ï¼Œè¿™ç§å¼‚æ­¥æ–¹æ³•çš„æ¨¡å¼å°†ä¸éœ€è¦ä»å †åˆ†é…å†…å­˜ã€‚ ç¼–è¯‘å™¨å’Œè¿è¡Œæ—¶å°†å°è¯•æœ€å°åŒ–å†…å­˜åˆ†é…æ“ä½œçš„æ•°é‡ã€‚ </p><br><h4 id="kogda-ne-nuzhno-ispolzovat-async"> ä»€ä¹ˆæ—¶å€™ä¸ä½¿ç”¨å¼‚æ­¥ </h4><br><p>  .NET Frameworkå°è¯•ä½¿ç”¨å„ç§ä¼˜åŒ–æ–¹æ³•ä¸ºå¼‚æ­¥æ–¹æ³•ç”Ÿæˆæœ‰æ•ˆçš„å®ç°ã€‚ å°½ç®¡å¦‚æ­¤ï¼Œå¼€å‘äººå‘˜æ ¹æ®ä»–ä»¬çš„ç»éªŒç»å¸¸ä¼šä½¿ç”¨ä»–ä»¬çš„ä¼˜åŒ–æ–¹æ³•ï¼Œè¿™åœ¨å°è¯•ä½¿ç”¨é€šç”¨æ–¹æ³•æ—¶å¯¹äºç¼–è¯‘å™¨å’Œè¿è¡Œæ—¶çš„è‡ªåŠ¨åŒ–å¯èƒ½æ˜¯å†’é™©ä¸”ä¸åˆ‡å®é™…çš„ã€‚ å¦‚æœæ‚¨æ²¡æœ‰å¿˜è®°è¿™ä¸€ç‚¹ï¼Œé‚£ä¹ˆåœ¨è®¸å¤šç‰¹å®šæƒ…å†µä¸‹ï¼Œæ‹’ç»ä½¿ç”¨å¼‚æ­¥æ–¹æ³•æ˜¯æœ‰ç›Šçš„ï¼Œç‰¹åˆ«æ˜¯ï¼Œè¿™é€‚ç”¨äºå¯ä»¥ç”¨äºæ›´ç²¾ç»†è®¾ç½®çš„åº“ä¸­çš„æ–¹æ³•ã€‚ é€šå¸¸ï¼Œå½“å¯ä»¥è‚¯å®šåœ°çŸ¥é“è¯¥æ–¹æ³•å¯ä»¥åŒæ­¥æ‰§è¡Œæ—¶ï¼Œå°±ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œå› ä¸ºå®ƒæ‰€ä¾èµ–çš„æ•°æ®å·²ç»å‡†å¤‡å°±ç»ªã€‚ </p><br><p> åˆ›å»ºå¼‚æ­¥æ–¹æ³•æ—¶ï¼Œ.NET Frameworkå¼€å‘äººå‘˜èŠ±è´¹å¤§é‡æ—¶é—´æ¥ä¼˜åŒ–å†…å­˜ç®¡ç†æ“ä½œçš„æ•°é‡ã€‚ è¿™æ˜¯å¿…éœ€çš„ï¼Œå› ä¸ºå†…å­˜ç®¡ç†åœ¨å¼‚æ­¥åŸºç¡€ç»“æ„çš„æ€§èƒ½ä¸Šä¼šäº§ç”Ÿæœ€å¤§çš„æˆæœ¬ã€‚ ä¸ºå¯¹è±¡åˆ†é…å†…å­˜çš„æ“ä½œé€šå¸¸ç›¸å¯¹ä¾¿å®œã€‚ ä¸ºå¯¹è±¡åˆ†é…å†…å­˜ç±»ä¼¼äºåœ¨è¶…å¸‚ä¸­å‘è´­ç‰©è½¦ä¸­å¡«å……äº§å“-å°†å®ƒä»¬æ”¾å…¥è´­ç‰©è½¦ä¸­æ—¶ï¼Œæ‚¨ä¸ä¼šèŠ±ä»»ä½•é’±ã€‚ å½“æ‚¨åœ¨ç»“å¸æ—¶ä»˜æ¬¾ï¼Œæ‹¿å‡ºé’±åŒ…å¹¶æ”¯ä»˜å¯è§‚çš„é’±æ—¶ï¼Œå°±ä¼šå‘ç”Ÿæ”¯å‡ºã€‚ è€Œä¸”ï¼Œå¦‚æœå†…å­˜åˆ†é…å¾ˆå®¹æ˜“ï¼Œåˆ™åç»­çš„åƒåœ¾å›æ”¶ä¼šä¸¥é‡å½±å“åº”ç”¨ç¨‹åºæ€§èƒ½ã€‚ å½“æ‚¨å¼€å§‹åƒåœ¾å›æ”¶æ—¶ï¼Œå°†å¯¹å½“å‰ä½äºå†…å­˜ä¸­ä½†æ²¡æœ‰é“¾æ¥çš„å¯¹è±¡è¿›è¡Œæ‰«æå’Œæ ‡è®°ã€‚ æ”¾ç½®çš„å¯¹è±¡è¶Šå¤šï¼Œæ ‡è®°å®ƒä»¬æ‰€èŠ±è´¹çš„æ—¶é—´å°±è¶Šé•¿ã€‚ å¦å¤–ï¼Œæ”¾ç½®çš„å¤§å‹å¯¹è±¡çš„æ•°é‡è¶Šå¤šï¼Œéœ€è¦è¿›è¡Œåƒåœ¾å›æ”¶çš„é¢‘ç‡å°±è¶Šé«˜ã€‚ ä½¿ç”¨å†…å­˜çš„è¿™ä¸€æ–¹é¢å¯¹ç³»ç»Ÿå…·æœ‰å…¨å±€å½±å“ï¼šå¼‚æ­¥æ–¹æ³•äº§ç”Ÿçš„åƒåœ¾è¶Šå¤šï¼Œå³ä½¿å¾®å‹æµ‹è¯•æœªè¯æ˜ä¼šäº§ç”Ÿå¤§é‡æˆæœ¬ï¼Œåº”ç”¨ç¨‹åºè¿è¡Œçš„é€Ÿåº¦ä¹Ÿä¼šè¶Šæ…¢ã€‚ </p><br><p> å¯¹äºæš‚åœæ‰§è¡Œï¼ˆç­‰å¾…å°šæœªå°±ç»ªçš„æ•°æ®ï¼‰çš„å¼‚æ­¥æ–¹æ³•ï¼Œç¯å¢ƒå¿…é¡»åˆ›å»ºTaskç±»å‹çš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å°†ä»æ–¹æ³•ä¸­è¿”å›ï¼Œå› ä¸ºè¯¥å¯¹è±¡ç”¨ä½œå¯¹è°ƒç”¨çš„å”¯ä¸€å¼•ç”¨ã€‚ ä½†æ˜¯ï¼Œé€šå¸¸å¯ä»¥è¿›è¡Œå¼‚æ­¥æ–¹æ³•è°ƒç”¨è€Œæ— éœ€æš‚åœã€‚ ç„¶åï¼Œè¿è¡Œæ—¶å¯ä»¥ä»ç¼“å­˜ä¸­è¿”å›å…ˆå‰å®Œæˆçš„Taskå¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯ä»¥ä¸€æ¬¡åˆä¸€æ¬¡åœ°ä½¿ç”¨ï¼Œè€Œæ— éœ€åˆ›å»ºæ–°çš„Taskå¯¹è±¡ã€‚ æ˜¯çš„ï¼Œä»…åœ¨æŸäº›æ¡ä»¶ä¸‹æ‰å…è®¸è¿™æ ·åšï¼Œä¾‹å¦‚ï¼Œå½“å¼‚æ­¥æ–¹æ³•è¿”å›éé€šç”¨ï¼ˆéé€šç”¨ï¼‰å¯¹è±¡Taskï¼ŒTaskæˆ–é€šè¿‡å¼•ç”¨ç±»å‹TResultæŒ‡å®šé€šç”¨Taskæ—¶ï¼Œä»è¯¥æ–¹æ³•è¿”å›nullã€‚ å°½ç®¡è¿™äº›æ¡ä»¶çš„åˆ—è¡¨éšç€æ—¶é—´çš„æ¨ç§»è€Œä¸æ–­æ‰©å¤§ï¼Œä½†æ˜¯å¦‚æœæ‚¨çŸ¥é“è¯¥æ“ä½œæ˜¯å¦‚ä½•å®ç°çš„ï¼Œé‚£å°±æ›´å¥½äº†ã€‚ <br></p><p> è€ƒè™‘å°†æ­¤ç±»å‹çš„å®ç°ä½œä¸ºMemoryStreamã€‚  MemoryStreamç»§æ‰¿è‡ªStreamï¼Œå¹¶é‡æ–°å®šä¹‰äº†.NET 4.5ä¸­å®ç°çš„æ–°æ–¹æ³•ï¼šReadAsyncï¼ŒWriteAsyncå’ŒFlushAsyncï¼Œä»¥ä¾¿æä¾›ç‰¹å®šäºå†…å­˜çš„ä»£ç ä¼˜åŒ–ã€‚ ç”±äºè¯»å–æ“ä½œæ˜¯ä»ä½äºå†…å­˜ä¸­çš„ç¼“å†²åŒºæ‰§è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒå®é™…ä¸Šæ˜¯å†…å­˜åŒºåŸŸçš„å‰¯æœ¬ï¼Œå› æ­¤ï¼Œå¦‚æœä»¥åŒæ­¥æ¨¡å¼æ‰§è¡ŒReadAsyncï¼Œåˆ™å°†è·å¾—æœ€ä½³æ€§èƒ½ã€‚ å¼‚æ­¥æ–¹æ³•ä¸­çš„æ­¤å®ç°å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="plaintext hljs">public override async Task&lt;int&gt; ReadAsync(byte [] buffer, int offset, int count, CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); return this.Read(buffer, offset, count); }</code> </pre> <br><p> å¾ˆç®€å•ã€‚ å¹¶ä¸”ç”±äºReadæ˜¯ä¸€ä¸ªåŒæ­¥è°ƒç”¨ï¼Œå¹¶ä¸”è¯¥æ–¹æ³•æ²¡æœ‰awaitè¯­å¥æ¥æ§åˆ¶æœŸæœ›ï¼Œå› æ­¤å¯¹è¯¥ReadAsyncçš„æ‰€æœ‰è°ƒç”¨å®é™…ä¸Šéƒ½å°†åŒæ­¥æ‰§è¡Œã€‚ ç°åœ¨è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ä½¿ç”¨çº¿ç¨‹çš„æ ‡å‡†æƒ…å†µï¼Œä¾‹å¦‚å¤åˆ¶æ“ä½œï¼š </p><br><pre> <code class="plaintext hljs">byte [] buffer = new byte[0x1000]; int numRead; while((numRead = await source.ReadAsync(buffer, 0, buffer.Length)) &gt; 0) { await source.WriteAsync(buffer, 0, numRead); }</code> </pre> <br><p> è¯·æ³¨æ„ï¼Œåœ¨ç»™å®šçš„ReadAsyncç¤ºä¾‹ä¸­ï¼Œå§‹ç»ˆä½¿ç”¨ç›¸åŒçš„ç¼“å†²åŒºé•¿åº¦å‚æ•°è°ƒç”¨æºæµï¼Œè¿™æ„å‘³ç€å¾ˆæœ‰å¯èƒ½è¿˜ä¼šé‡å¤è¿”å›å€¼ï¼ˆè¯»å–çš„å­—èŠ‚æ•°ï¼‰ã€‚ é™¤éåœ¨æå°‘æ•°æƒ…å†µä¸‹ï¼Œå¦åˆ™ReadAsyncçš„å®ç°ä¸å¤ªå¯èƒ½ä½¿ç”¨ç¼“å­˜çš„Taskå¯¹è±¡ä½œä¸ºè¿”å›å€¼ï¼Œä½†æ˜¯æ‚¨å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚ </p><br><p> è€ƒè™‘è¯¥æ–¹æ³•çš„å¦ä¸€ä¸ªå®ç°é€‰é¡¹ï¼Œå¦‚å›¾2æ‰€ç¤ºã€‚åˆ©ç”¨è¯¥æ–¹æ³•çš„æ ‡å‡†è„šæœ¬ä¸­å…¶å›ºæœ‰æ–¹é¢çš„ä¼˜ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ’é™¤å†…å­˜åˆ†é…æ“ä½œæ¥ä¼˜åŒ–å®ç°ï¼Œè¿™åœ¨è¿è¡Œæ—¶ä¸å¤ªå¯èƒ½å®ç°ã€‚ å¦‚æœè¯»å–äº†ç›¸åŒæ•°é‡çš„å­—èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿”å›åœ¨ä¸Šä¸€ä¸ªReadAsyncè°ƒç”¨ä¸­ä½¿ç”¨çš„åŒä¸€Taskå¯¹è±¡æ¥å®Œå…¨æ¶ˆé™¤å†…å­˜ä¸¢å¤±ã€‚ å¯¹äºè¿™æ ·çš„ä½çº§æ“ä½œï¼ˆå¯èƒ½éå¸¸å¿«å¹¶ä¸”å°†è¢«é‡å¤è°ƒç”¨ï¼‰ï¼Œæ­¤ä¼˜åŒ–å°†äº§ç”Ÿé‡å¤§å½±å“ï¼Œå°¤å…¶æ˜¯åœ¨åƒåœ¾å›æ”¶çš„æ•°é‡æ–¹é¢ã€‚ </p><br><p>  <strong>å›¾2</strong>ä¼˜åŒ–ä»»åŠ¡åˆ›å»º </p><br><pre> <code class="plaintext hljs">private Task&lt;int&gt; m_lastTask; public override Task&lt;int&gt; ReadAsync(byte [] buffer, int offset, int count, CancellationToken cancellationToken) { if (cancellationToken.IsCancellationRequested) { var tcs = new TaskCompletionSource&lt;int&gt;(); tcs.SetCanceled(); return tcs.Task; } try { int numRead = this.Read(buffer, offset, count); return m_lastTask != null &amp;&amp; numRead == m_lastTask.Result ? m_lastTask : (m_lastTask = Task.FromResult(numRead)); } catch(Exception e) { var tcs = new TaskCompletionSource&lt;int&gt;(); tcs.SetException(e); return tcs.Task; } }</code> </pre> <br><p> å¦‚æœéœ€è¦ç¼“å­˜ï¼Œå¯ä»¥ä½¿ç”¨é€šè¿‡æ¶ˆé™¤ä¸å¿…è¦çš„Taskå¯¹è±¡åˆ›å»ºçš„ç±»ä¼¼ä¼˜åŒ–æ–¹æ³•ã€‚ è€ƒè™‘ä¸€ç§æ—¨åœ¨æ£€ç´¢ç½‘é¡µå†…å®¹å¹¶å°†å…¶ç¼“å­˜ä»¥ä¾›å°†æ¥å‚è€ƒçš„æ–¹æ³•ã€‚ ä½œä¸ºå¼‚æ­¥æ–¹æ³•ï¼Œå¯ä»¥è¿™æ ·ç¼–å†™ï¼ˆä½¿ç”¨.NET 4.5çš„æ–°System.Net.Http.dllåº“ï¼‰ï¼š </p><br><pre> <code class="plaintext hljs">private static ConcurrentDictionary&lt;string,string&gt; s_urlToContents; public static async Task&lt;string&gt; GetContentsAsync(string url) { string contents; if (!s_urlToContents.TryGetValue(url, out contents)) { var response = await new HttpClient().GetAsync(url); contents = response.EnsureSuccessStatusCode().Content.ReadAsString(); s_urlToContents.TryAdd(url, contents); } return contents; }</code> </pre> <br><p> è¿™æ˜¯ä¸€ä¸ªå‰é¢å®ç°ã€‚ å¯¹äºåœ¨ç¼“å­˜ä¸­æ‰¾ä¸åˆ°æ•°æ®çš„GetContentsAsyncè°ƒç”¨ï¼Œä¸é€šè¿‡ç½‘ç»œæ¥æ”¶æ•°æ®çš„æˆæœ¬ç›¸æ¯”ï¼Œå¯ä»¥å¿½ç•¥åˆ›å»ºæ–°Taskå¯¹è±¡çš„å¼€é”€ã€‚ ä½†æ˜¯ï¼Œåœ¨ä»ç¼“å­˜ä¸­è·å–æ•°æ®çš„æƒ…å†µä¸‹ï¼Œå¦‚æœä»…åŒ…è£…å¹¶æä¾›å¯ç”¨çš„æœ¬åœ°æ•°æ®ï¼Œåˆ™è¿™äº›æˆæœ¬å°†å˜å¾—éå¸¸å¤§ã€‚ <br></p><p> ä¸ºäº†æ¶ˆé™¤è¿™äº›æˆæœ¬ï¼ˆå¦‚æœéœ€è¦è·å¾—é«˜æ€§èƒ½ï¼‰ï¼Œå¯ä»¥é‡å†™è¯¥æ–¹æ³•ï¼Œå¦‚å›¾3æ‰€ç¤ºã€‚ç°åœ¨ï¼Œæˆ‘ä»¬æœ‰ä¸¤ç§æ–¹æ³•ï¼šå…¬å…±å§”æ‰˜çš„åŒæ­¥å…¬å…±æ–¹æ³•å’Œå¼‚æ­¥ç§æœ‰æ–¹æ³•ã€‚  Dictionaryé›†åˆç°åœ¨ç¼“å­˜åˆ›å»ºçš„Taskå¯¹è±¡ï¼Œè€Œä¸æ˜¯å®ƒä»¬çš„å†…å®¹ï¼Œå› æ­¤å¯ä»¥é€šè¿‡ç®€å•åœ°è®¿é—®è¯¥é›†åˆä»¥è¿”å›ç°æœ‰Taskå¯¹è±¡çš„æ–¹å¼ï¼Œæ¥è¿›è¡Œä»¥åå°è¯•æ£€ç´¢ä»¥å‰æˆåŠŸè·å–çš„é¡µé¢å†…å®¹çš„å°è¯•ã€‚ åœ¨å†…éƒ¨ï¼Œæ‚¨å¯ä»¥åˆ©ç”¨Taskå¯¹è±¡çš„ContinueWithæ–¹æ³•ï¼Œå¦‚æœé¡µé¢åŠ è½½æˆåŠŸï¼Œæˆ‘ä»¬å¯ä»¥å°†æ‰§è¡Œçš„å¯¹è±¡ä¿å­˜åœ¨é›†åˆä¸­ã€‚ å½“ç„¶ï¼Œæ­¤ä»£ç æ›´åŠ å¤æ‚ï¼Œå¹¶ä¸”éœ€è¦åƒå¾€å¸¸ä¸€æ ·åœ¨ä¼˜åŒ–æ€§èƒ½æ—¶è¿›è¡Œå¤§é‡å¼€å‘å’Œæ”¯æŒï¼šæ‚¨ä¸å¸Œæœ›èŠ±æ—¶é—´ç¼–å†™ä»£ç ï¼Œç›´åˆ°æ€§èƒ½æµ‹è¯•è¡¨æ˜è¿™äº›å¤æ‚æ€§å¯¼è‡´å…¶æ”¹è¿›ä¸ºæ­¢ï¼Œè¿™æ˜¯ä»¤äººå°è±¡æ·±åˆ»çš„ã€‚ å“ªäº›æ”¹è¿›å®é™…ä¸Šå°†å–å†³äºåº”ç”¨æ–¹æ³•ã€‚ æ‚¨å¯ä»¥é‡‡ç”¨ä¸€ä¸ªæµ‹è¯•å¥—ä»¶ï¼Œè¯¥å¥—ä»¶å¯ä»¥æ¨¡æ‹Ÿå¸¸è§çš„ç”¨ä¾‹å¹¶è¯„ä¼°ç»“æœï¼Œä»¥ç¡®å®šè¯¥æ¸¸æˆæ˜¯å¦å€¼å¾—ä¸€è¯•ã€‚ </p><br><p>  <strong>å›¾3</strong>æ‰‹åŠ¨ç¼“å­˜ä»»åŠ¡ </p><br><pre> <code class="plaintext hljs">private static ConcurrentDictionary&lt;string,Task&lt;string&gt;&gt; s_urlToContents; public static Task&lt;string&gt; GetContentsAsync(string url) { Task&lt;string&gt; contents; if (!s_urlToContents.TryGetValue(url, out contents)) { contents = GetContentsInternalAsync(url); contents.ContinueWith(delegate { s_urlToContents.TryAdd(url, contents); }, CancellationToken.None, TaskContinuationOptions.OnlyOnRanToCompletion | TaskContinuatOptions.ExecuteSynchronously, TaskScheduler.Default); } return contents; } private static async Task&lt;string&gt; GetContentsInternalAsync(string url) { var response = await new HttpClient().GetAsync(url); return response.EnsureSuccessStatusCode().Content.ReadAsString(); }</code> </pre> <br><p> ä¸Taskå¯¹è±¡å…³è”çš„å¦ä¸€ç§ä¼˜åŒ–æ–¹æ³•æ˜¯ç¡®å®šæ˜¯å¦ä»å¼‚æ­¥æ–¹æ³•ä¸­å®Œå…¨è¿”å›è¿™æ ·çš„å¯¹è±¡ã€‚  Cï¼ƒå’ŒVisual Basicéƒ½æ”¯æŒè¿”å›ç©ºå€¼ï¼ˆvoidï¼‰çš„å¼‚æ­¥æ–¹æ³•ï¼Œå¹¶ä¸”å®ƒä»¬æ ¹æœ¬ä¸åˆ›å»ºTaskå¯¹è±¡ã€‚ åº“ä¸­çš„å¼‚æ­¥æ–¹æ³•åº”å§‹ç»ˆè¿”å›Taskå’ŒTaskï¼Œå› ä¸ºåœ¨è®¾è®¡åº“æ—¶ï¼Œæ‚¨æ— æ³•çŸ¥é“å°†ä¸ä¼šä½¿ç”¨å®ƒä»¬ç­‰å¾…å®Œæˆã€‚ ä½†æ˜¯ï¼Œåœ¨å¼€å‘åº”ç”¨ç¨‹åºæ—¶ï¼Œè¿”å›voidçš„æ–¹æ³•å¯ä»¥æ‰¾åˆ°è‡ªå·±çš„ä½ç½®ã€‚ å­˜åœ¨æ­¤ç±»æ–¹æ³•çš„ä¸»è¦åŸå› æ˜¯æä¾›ç°æœ‰çš„äº‹ä»¶é©±åŠ¨ç¯å¢ƒï¼Œä¾‹å¦‚ASP.NETå’ŒWindows Presentation Foundationï¼ˆWPFï¼‰ã€‚ ä½¿ç”¨å¼‚æ­¥å’Œç­‰å¾…ï¼Œè¿™äº›æ–¹æ³•ä½¿å®ç°æŒ‰é’®å¤„ç†ç¨‹åºï¼Œé¡µé¢åŠ è½½äº‹ä»¶ç­‰å˜å¾—å®¹æ˜“ã€‚ å¦‚æœæ‰“ç®—ä½¿ç”¨å¸¦voidçš„å¼‚æ­¥æ–¹æ³•ï¼Œè¯·è°¨æ…å¤„ç†å¼‚å¸¸ï¼šæ¥è‡ªè¯¥å¼‚å¸¸çš„å¼‚å¸¸å°†åœ¨è°ƒç”¨è¯¥æ–¹æ³•æ—¶å¤„äºæ´»åŠ¨çŠ¶æ€çš„ä»»ä½•SynchronizationContextä¸­å¼¹å‡ºã€‚ <br></p><h4 id="ne-zabyvayte-o-kontekste"> ä¸è¦å¿˜è®°ä¸Šä¸‹æ–‡ </h4><br><p>  .NET Frameworkä¸­æœ‰è®¸å¤šä¸åŒçš„ä¸Šä¸‹æ–‡ï¼šLogicalCallContextï¼ŒSynchronizationContextï¼ŒHostExecutionContextï¼ŒSecurityContextï¼ŒExecutionContextå’Œå…¶ä»–ä¸Šä¸‹æ–‡ï¼ˆå®ƒä»¬çš„æ•°é‡å·¨å¤§ï¼Œå¯èƒ½è¡¨æ˜è¯¥æ¡†æ¶çš„åˆ›å»ºè€…å‡ºäºç»æµä¸Šçš„åŠ¨æœºåˆ›å»ºäº†æ–°çš„ä¸Šä¸‹æ–‡ï¼Œä½†æˆ‘ç¡®å®šä¸æ˜¯è¿™æ ·ï¼‰ã€‚ å…¶ä¸­ä¸€äº›ä¸Šä¸‹æ–‡ä¸ä»…åœ¨åŠŸèƒ½æ–¹é¢è€Œä¸”åœ¨æ€§èƒ½æ–¹é¢éƒ½ä¸¥é‡å½±å“å¼‚æ­¥æ–¹æ³•ã€‚ </p><br><p>  <strong>SynchronizationContext</strong> SynchronizationContextåœ¨å¼‚æ­¥æ–¹æ³•ä¸­æ‰®æ¼”é‡è¦è§’è‰²ã€‚  â€œåŒæ­¥ä¸Šä¸‹æ–‡â€ä»…æ˜¯ä¸€ç§æŠ½è±¡ï¼Œä»¥ç¡®ä¿å¯¹ç‰¹å®šåº“æˆ–ç¯å¢ƒçš„è¯¦ç»†ä¿¡æ¯çš„å§”æ‰˜è°ƒç”¨è¿›è¡Œç¼–ç»„ã€‚ ä¾‹å¦‚ï¼ŒWPFå…·æœ‰ä¸€ä¸ªDispatcherSynchronizationContextï¼Œç”¨äºè¡¨ç¤ºDispatcherçš„ç”¨æˆ·ç•Œé¢ï¼ˆUIï¼‰æµï¼šå‘æ­¤åŒæ­¥ä¸Šä¸‹æ–‡å‘é€å§”æ‰˜ä¼šä½¿è¯¥å§”æ‰˜æ’é˜Ÿï¼Œä»¥ç”±Dispatcheråœ¨å…¶æµä¸­æ‰§è¡Œã€‚  ASP.NETæä¾›ä¸€ä¸ªAspNetSynchronizationContextï¼Œç”¨äºç¡®ä¿å¤„ç†ASP.NETè¯·æ±‚ä¸­æ¶‰åŠçš„å¼‚æ­¥æ“ä½œè¢«ç¡®ä¿é¡ºåºæ‰§è¡Œï¼Œå¹¶ç»‘å®šåˆ°æ­£ç¡®çš„HttpContextçŠ¶æ€ã€‚ å¥½å§ç­‰ç­‰ é€šå¸¸ï¼Œ.NET Frameworkä¸­å¤§çº¦æœ‰10ä¸ªSynchronizationContextä¸“ä¸šåŒ–ï¼Œæœ‰äº›æ˜¯å¼€æ”¾çš„ï¼Œæœ‰äº›æ˜¯å†…éƒ¨çš„ã€‚ </p><br><p> å½“ç­‰å¾….NET Frameworkå¯ä»¥å®ç°æ­¤åŠŸèƒ½çš„Taskæˆ–å…¶ä»–ç±»å‹çš„å¯¹è±¡æ—¶ï¼Œç­‰å¾…å®ƒä»¬çš„å¯¹è±¡ï¼ˆä¾‹å¦‚TaskAwaiterï¼‰å°†åœ¨ç­‰å¾…ï¼ˆawaitï¼‰å¼€å§‹æ—¶æ•è·å½“å‰çš„SynchronizationContextã€‚ ç­‰å¾…å®Œæˆåï¼Œå¦‚æœæ•è·äº†SynchronizationContextï¼Œåˆ™å°†å¼‚æ­¥æ–¹æ³•çš„ç»§ç»­å‘é€åˆ°æ­¤åŒæ­¥ä¸Šä¸‹æ–‡ã€‚ å› æ­¤ï¼Œç¼–å†™ä»UIæµä¸­è°ƒç”¨çš„å¼‚æ­¥æ–¹æ³•çš„ç¨‹åºå‘˜æ— éœ€æ‰‹åŠ¨ç¼–ç»„å¯¹UIæµçš„è°ƒç”¨å³å¯æ›´æ–°UIæ§ä»¶ï¼šæ¡†æ¶è‡ªåŠ¨æ‰§è¡Œæ­¤ç¼–ç»„ã€‚ </p><br><p> ä¸å¹¸çš„æ˜¯ï¼Œè¿™ç§å°é€å¤„ç†æ˜¯æœ‰ä»£ä»·çš„ã€‚ å¯¹äºä½¿ç”¨awaitæ¥å®ç°å…¶æ§åˆ¶æµçš„åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜ï¼Œè‡ªåŠ¨å°é€å¤„ç†æ˜¯æ­£ç¡®çš„è§£å†³æ–¹æ¡ˆã€‚ å›¾ä¹¦é¦†é€šå¸¸ä¼šæœ‰ä¸€ä¸ªå®Œå…¨ä¸åŒçš„æ•…äº‹ã€‚ å¯¹äºåº”ç”¨ç¨‹åºå¼€å‘äººå‘˜æ¥è¯´ï¼Œè¿™ç§å°é€å¤„ç†ä¸»è¦æ˜¯ä»£ç æ§åˆ¶æ‰§è¡Œä»£ç çš„ä¸Šä¸‹æ–‡æ‰€å¿…éœ€çš„ï¼Œä¾‹å¦‚ï¼Œè®¿é—®UIæ§ä»¶æˆ–è®¿é—®ä¸æ‰€éœ€ASP.NETè¯·æ±‚ç›¸å¯¹åº”çš„HttpContextã€‚ ä½†æ˜¯ï¼Œé€šå¸¸ä¸éœ€è¦åº“æ¥æ»¡è¶³è¿™ç§è¦æ±‚ã€‚ ç»“æœï¼Œè‡ªåŠ¨å°é€å¤„ç†é€šå¸¸å¸¦æ¥å®Œå…¨ä¸å¿…è¦çš„é¢å¤–è´¹ç”¨ã€‚ è®©æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹å°†æ•°æ®ä»ä¸€ä¸ªæµå¤åˆ¶åˆ°å¦ä¸€ä¸ªæµçš„ä»£ç ï¼š </p><br><pre> <code class="plaintext hljs">byte [] buffer = new byte[0x1000]; int numRead; while((numRead = await source.ReadAsync(buffer, 0, buffer.Length)) &gt; 0) { await source.WriteAsync(buffer, 0, numRead); }</code> </pre> <br><p> å¦‚æœä»UIæµä¸­è°ƒç”¨æ­¤å‰¯æœ¬ï¼Œåˆ™æ¯ä¸ªè¯»å–å’Œå†™å…¥æ“ä½œéƒ½å°†å¼ºåˆ¶æ‰§è¡Œè¿”å›åˆ°UIæµã€‚ å¯¹äºæºå’Œå¼‚æ­¥è¯»å–å’Œå†™å…¥çš„æµï¼ˆå³ï¼Œå¤§å¤šæ•°å®ç°ï¼‰ä¸­çš„å…†å­—èŠ‚æ•°æ®ï¼Œè¿™æ„å‘³ç€ä»åå°æµåˆ°UIæµçš„åˆ‡æ¢æ¬¡æ•°çº¦ä¸º500ã€‚ è¦å¤„ç†â€œä»»åŠ¡â€å’Œâ€œä»»åŠ¡â€ç±»å‹ä¸­çš„æ­¤è¡Œä¸ºï¼Œå°†åˆ›å»ºConfigureAwaitæ–¹æ³•ã€‚ æ­¤æ–¹æ³•æ¥å—ç”¨äºæ§åˆ¶å°é€å¤„ç†çš„å¸ƒå°”ç±»å‹çš„continueOnCapturedContextå‚æ•°ã€‚ å¦‚æœä¸ºtrueï¼ˆé»˜è®¤å€¼ï¼‰ï¼Œåˆ™awaitè‡ªåŠ¨å°†æ§åˆ¶æƒè¿”å›ç»™æ•è·çš„SynchronizationContextã€‚ å¦‚æœä½¿ç”¨falseï¼Œåˆ™åŒæ­¥ä¸Šä¸‹æ–‡å°†è¢«å¿½ç•¥ï¼Œç¯å¢ƒå°†ç»§ç»­åœ¨è¢«ä¸­æ–­çš„çº¿ç¨‹ä¸­æ‰§è¡Œå¼‚æ­¥æ“ä½œã€‚ å®ç°æ­¤é€»è¾‘å°†æä¾›çº¿ç¨‹ä¹‹é—´çš„å¤åˆ¶ä»£ç çš„æ›´æœ‰æ•ˆç‰ˆæœ¬ï¼š <br></p><pre> <code class="plaintext hljs">byte [] buffer = new byte[0x1000]; int numRead; while((numRead = await source.ReadAsync(buffer, 0, buffer.Length).ConfigureAwait(false)) &gt; 0) { await source.WriteAsync(buffer, 0, numRead).ConfigureAwait(false); }</code> </pre> <br><p> å¯¹äºåº“å¼€å‘äººå‘˜è€Œè¨€ï¼Œè¿™ç§åŠ é€Ÿæœ¬èº«è¶³ä»¥ä½¿äººä»¬å§‹ç»ˆè€ƒè™‘ä½¿ç”¨ConfigureAwaitï¼Œä½†æå°‘æ•°æƒ…å†µé™¤å¤–ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåº“å¯¹è¿è¡Œæ—¶æœ‰è¶³å¤Ÿçš„äº†è§£ï¼Œå¹¶ä¸”å®ƒå°†éœ€è¦é€šè¿‡è®¿é—®æ­£ç¡®çš„ä¸Šä¸‹æ–‡æ¥æ‰§è¡Œè¯¥æ–¹æ³•ã€‚ </p><br><p> é™¤äº†æ€§èƒ½ï¼Œè¿˜æœ‰å¦ä¸€ä¸ªåŸå› æ˜¯åœ¨å¼€å‘åº“æ—¶éœ€è¦ä½¿ç”¨ConfigureAwaitã€‚ æƒ³è±¡ä¸€ä¸‹ï¼Œä½¿ç”¨WPFä¸­çš„UIæµè°ƒç”¨ä½¿ç”¨ä¸å¸¦ConfigureAwaitçš„ä»£ç ç‰ˆæœ¬å®ç°çš„CopyStreamToStreamAsyncæ–¹æ³•ï¼Œä¾‹å¦‚ï¼š </p><br><pre> <code class="plaintext hljs">private void button1_Click(object sender, EventArgs args) { Stream src = â€¦, dst = â€¦; Task t = CopyStreamToStreamAsync(src, dst); t.Wait(); // deadlock! }</code> </pre> <br><p> åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç¨‹åºå‘˜å¿…é¡»å°†button1_Clickä½œä¸ºå¼‚æ­¥æ–¹æ³•ç¼–å†™ï¼Œåœ¨è¿™ç§å¼‚æ­¥æ–¹æ³•ä¸­ï¼ŒæœŸæœ›awaitæ“ä½œç¬¦æ‰§è¡ŒTaskï¼Œè€Œä¸èƒ½ä½¿ç”¨æ­¤å¯¹è±¡çš„åŒæ­¥Waitæ–¹æ³•ã€‚ åœ¨è®¸å¤šå…¶ä»–æƒ…å†µä¸‹ï¼Œéƒ½éœ€è¦ä½¿ç”¨Waitæ–¹æ³•ï¼Œä½†æ˜¯åœ¨UIæµä¸­ä½¿ç”¨å®ƒæ¥ç­‰å¾…å‡ ä¹æ€»æ˜¯ä¸€ä¸ªé”™è¯¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ åœ¨Taskå®Œæˆä¹‹å‰ï¼ŒWaitæ–¹æ³•ä¸ä¼šè¿”å›ã€‚ å¯¹äºCopyStreamToStreamAsyncï¼Œå…¶å¼‚æ­¥æµå°†å°è¯•é€šè¿‡å°†æ•°æ®å‘é€åˆ°æ•è·çš„SynchronizationContextæ¥è¿”å›æ‰§è¡Œï¼Œå¹¶ä¸”ç›´åˆ°æ­¤ç±»ä¼ è¾“å®Œæˆï¼ˆå› ä¸ºå®ƒä»¬æ˜¯ç»§ç»­å…¶æ“ä½œæ‰€å¿…éœ€çš„ï¼‰ï¼Œæ‰èƒ½å®Œæˆã€‚ ä½†æ˜¯ï¼Œè¿™äº›åˆ†æ´¾åˆæ— æ³•æ‰§è¡Œï¼Œå› ä¸ºå¿…é¡»å¤„ç†å®ƒä»¬çš„UIçº¿ç¨‹è¢«Waitè°ƒç”¨é˜»å¡äº†ã€‚ è¿™æ˜¯å¯¼è‡´æ­»é”çš„å‘¨æœŸæ€§ä¾èµ–å…³ç³»ã€‚ å¦‚æœä½¿ç”¨ConfigureAwaitï¼ˆfalseï¼‰å®ç°CopyStreamToStreamAsyncï¼Œåˆ™å°†æ²¡æœ‰ä¾èµ–å…³ç³»å’Œé˜»å¡ã€‚ </p><br><p>  <strong>ExecutionContext</strong> ExecutionContextæ˜¯.NET Frameworkçš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œä½†å¤§å¤šæ•°ç¨‹åºå‘˜ä»ç„¶å¹¸ç¦åœ°æ²¡æœ‰æ„è¯†åˆ°å®ƒçš„å­˜åœ¨ã€‚ ExecutionContext â€“  ,        SecurityContext  LogicalCallContext,   ,         .  ,    ThreadPool.QueueUserWorkItem, Task.Run, Delegate.BeginInvoke, Stream.BeginRead, WebClient.DownloadStringAsync      Framework,    ExecutionContext   ExecutionContext.Run ( ). ,  ,  ThreadPool.QueueUserWorkItem,  Windows  (identity),           WaitCallback.   ,   Task.Run    LogicalCallContext,         LogicalCallContext    Action. ExecutionContext     . </p><br><p>  Framework    ,          ExecutionContext,     ,      .     Windows      LogicalCallContext     .     (WindowsIdentity.Impersonate  CallContext.LogicalSetData)               . </p><br><h4 id="osvobodites-ot-sborki-musora">     </h4><br><p>        .    C#  Visual Basic     ,        .          await.  ,      ,    -   .   C#  Visual Basic  (Â«Â»)      ,     await  (boxed)  ,     . </p><br><p>                  .   ,     . ,       ,     ,     . </p><br><p>       C#  Visual Basic      ,      . ,     </p><br><pre> <code class="plaintext hljs">public static async Task FooAsync() { var dto = DateTimeOffset.Now; var dt = dto.DateTime; await Task.Yield(); Console.WriteLine(dt); }</code> </pre> <br><p>    dto      await,     .    ,  , -    dto: </p><br><p> <strong>Figure 4</strong>    </p><br><pre> <code class="plaintext hljs">[StructLayout(LayoutKind.Sequential), CompilerGenerated] private struct &lt;FooAsync&gt;d__0 : &lt;&gt;t__IStateMachine { private int &lt;&gt;1__state; public AsyncTaskMethodBuilder &lt;&gt;t__builder; public Action &lt;&gt;t__MoveNextDelegate; public DateTimeOffset &lt;dto&gt;5__1; public DateTime &lt;dt&gt;5__2; private object &lt;&gt;t__stack; private object &lt;&gt;t__awaiter; public void MoveNext(); [DebuggerHidden] public void &lt;&gt;t__SetMoveNextDelegate(Action param0); }</code> </pre> <br><p>         ,     .   ,     ,  , ,        .       ,        : </p><br><pre> <code class="plaintext hljs">public static async Task FooAsync() { var dt = DateTimeOffset.Now.DateTime; await Task.Yield(); Console.WriteLine(dt); }</code> </pre> <br><p>  ,   .NET (GC)    ,  ,      ,  :      0,  ,    ,     (.NET GC    0, 1  2).      ,    GC        .     ,  ,   ,    ,     ,     ,   .     0,   ,    ,   .   ,     ,         ,    . </p><br><p>                (        ,       ).    JIT   ,        ,               ,        ,      .          ,    ,        .   ,      ,  ,     ,     .   ,          ,     .  ,  C#  Visual Basic        ,       ,     . </p><br><h4 id="izbegayte-slozhnosti">   </h4><br><p>  C#  Visual Basic  ,       awaits:  .   await      ,     Task  ,       ,  . ,   ,      : <br></p><pre> <code class="plaintext hljs">public static async Task&lt;int&gt; SumAsync(Task&lt;int&gt; a, Task&lt;int&gt; b, Task&lt;int&gt; c) { return Sum(await a, await b, await c); } private static int Sum(int a, int b, int c) { return a + b + c; }</code> </pre> <br><p>  C#     â€œawait bâ€    Sum.      await,       Sum,  -       async ,   Â«Â»     await.    ,       await       .   ,  ,       CLR,    ,      ,       .         ,                 &lt;&gt;t__stack.         ,   ,   Tuple&lt;int, int&gt;             &lt;&gt;__stack.  ,     ,    ,          . ,    SumAsync : </p><br><pre> <code class="plaintext hljs">public static async Task&lt;int&gt; SumAsync(Task&lt;int&gt; a, Task&lt;int&gt; b, Task&lt;int&gt; c) { int ra = await a; int rb = await b; int rc = await c; return Sum(ra, rb, rc); }</code> </pre> <br><p>            ,   ra, rb  rc,    .  ,    :                   .          ,           ,        ,    .  ,           ,    ,       ,          . </p><br><p> ,        ,        .      Sum   ,    await   ,       .     ,    await   ,  .      await  ,      Task.WhenAll: </p><br><pre> <code class="plaintext hljs">public static async Task&lt;int&gt; SumAsync(Task&lt;int&gt; a, Task&lt;int&gt; b, Task&lt;int&gt; c) { int [] results = await Task.WhenAll(a, b, c); return Sum(results[0], results[1], results[2]); }</code> </pre> <br><p>  Task.WhenAll  Task&lt;TResult[]&gt;,    ,       ,     ,       .           .     ,         WhenAll,    Task  Task.        ,          ,    ,   ,   ,    WhenAll ,    .         WhenAll,     , ,   params,       .    ,  ,         .   Figure 5 <br></p><p> <strong>Figure 5</strong>     </p><br><pre> <code class="plaintext hljs">public static Task&lt;int&gt; SumAsync(Task&lt;int&gt; a, Task&lt;int&gt; b, Task&lt;int&gt; c) { return (a.Status == TaskStatus.RanToCompletion &amp;&amp; b.Status == TaskStatus.RanToCompletion &amp;&amp; c.Status == TaskStatus.RanToCompletion) ? Task.FromResult(Sum(a.Result, b.Result, c.Result)) : SumAsyncInternal(a, b, c); } private static async Task&lt;int&gt; SumAsyncInternal(Task&lt;int&gt; a, Task&lt;int&gt; b, Task&lt;int&gt; c) { await Task.WhenAll((Task)a, b, c).ConfigureAwait(false); return Sum(a.Result, b.Result, c.Result); }</code> </pre> <br><h4 id="asinhronnost-i-proizvoditelnost">    </h4><br><p>      ,           .  ,         .            ,            . ,      ,     :      ,      ,      /          ,       .     .NET Framework              ,       .   ,       .NET Framework,     .  ,  ,       Framework,   ,     ,  . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN458332/">https://habr.com/ru/post/zh-CN458332/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN458316/index.html">Yandex Retro Games Battle 2019-ä¸ºZX Spectrumå¼€å‘æ¸¸æˆ</a></li>
<li><a href="../zh-CN458324/index.html">Vue.jså…¥é—¨æ‰€éœ€çš„ä¸€åˆ‡</a></li>
<li><a href="../zh-CN458326/index.html">Yandexä¸ºç ”ç©¶äººå‘˜æ‰“å¼€Tolokaæ•°æ®é›†</a></li>
<li><a href="../zh-CN458328/index.html">å¦‚ä½•åœ¨Google Analyticsï¼ˆåˆ†æï¼‰ä¸­ä»Yandex.Metricaå¤åˆ¶ç›®æ ‡</a></li>
<li><a href="../zh-CN458330/index.html">å®Œç¾æ— æ­¢å¢ƒï¼šç¥ç»æ¥å£å¦‚ä½•å¸®åŠ©äººç±»</a></li>
<li><a href="../zh-CN458334/index.html">ä½¿ç”¨Slonyä»æ—§PostgreSQLè¿ç»­å¤åˆ¶åˆ°æ–°PostgreSQL</a></li>
<li><a href="../zh-CN458336/index.html">ä½¿ç”¨é¡¹ç›®ç¤ºä¾‹çš„ITäº§å“å¼€å‘çš„å…¨å‘¨æœŸï¼šå›¢é˜Ÿè§’è‰²ï¼Œå®¢æˆ·ä»»åŠ¡ï¼Œé˜¶æ®µ</a></li>
<li><a href="../zh-CN458338/index.html">åº”ç”¨ç¨‹åºå®‰å…¨ç®¡ç†å™¨ã€‚ å¼€å‘äººå‘˜è¿˜æ˜¯å®‰å…¨æ€§ï¼Ÿ</a></li>
<li><a href="../zh-CN458342/index.html">çº¹ç†ï¼Œæˆ–æˆä¸ºSurface Artistæ‰€éœ€è¦äº†è§£çš„çŸ¥è¯†ã€‚ ç¬¬1éƒ¨åˆ†ã€‚åƒç´ </a></li>
<li><a href="../zh-CN458344/index.html">ä½¿ç”¨å¼‚æ­¥æ¶ˆæ¯ä¼ é€’æ¥æé«˜å¯ç”¨æ€§</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>