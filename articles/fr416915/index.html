<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèΩ‚Äçü§ù‚Äçüë®üèª üë®üèº‚Äçüè≠ üî™ Centrifugo v2 - l'avenir du serveur de messagerie en temps r√©el et de la biblioth√®que pour Go üçî üëÉüèø üë©üèæ‚Äç‚öïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Certains lecteurs ont peut-√™tre d√©j√† entendu parler de Centrifugo . Cet article se concentrera sur le d√©veloppement de la deuxi√®me version du serveur ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Centrifugo v2 - l'avenir du serveur de messagerie en temps r√©el et de la biblioth√®que pour Go</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/avito/blog/416915/"><p>  Certains lecteurs ont peut-√™tre d√©j√† entendu parler de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Centrifugo</a> .  Cet article se concentrera sur le d√©veloppement de la deuxi√®me version du serveur et de la nouvelle biblioth√®que en temps r√©el pour le langage Go qui le sous-tend. </p><br><p>  Je m'appelle Alexander Emelin.  L'√©t√© dernier, j'ai rejoint l'√©quipe Avito, o√π j'aide maintenant √† d√©velopper le backend messenger Avito.  Le nouveau travail, directement li√© √† la livraison rapide des messages aux utilisateurs, et les nouveaux coll√®gues m'ont inspir√© pour continuer √† travailler sur le projet open source Centrifugo. </p><br><p><img src="https://habrastorage.org/webt/cl/mo/yt/clmoytonrzc4exvj6eeky8j-zw4.jpeg"></p><a name="habracut"></a><br><p>  En un mot - c'est un serveur qui se charge de maintenir des connexions constantes des utilisateurs de votre application.  Le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">polyfill</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Websocket</a> ou SockJS <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">est</a> utilis√© comme transport; il peut, s'il n'est pas possible d'√©tablir une connexion Websocket, fonctionner via Eventsource, le streaming XHR, l'interrogation longue et d'autres transports bas√©s sur HTTP.  Les clients s'abonnent aux canaux sur lesquels le backend via l'API Centrifuge publie de nouveaux messages au fur et √† mesure qu'ils apparaissent - apr√®s quoi les messages sont remis aux utilisateurs abonn√©s au canal.  En d'autres termes, c'est un serveur PUB / SUB. </p><br><p><img src="https://habrastorage.org/webt/-c/ws/k-/-cwsk-n9eulxk4cd7v9berdltzy.png"></p><br><p> Actuellement, le serveur est utilis√© dans un nombre assez important de projets.  Parmi eux, par exemple, certains projets Mail.Ru (intranet, plates-formes de formation Technopark / Technosphere, Centre de certification, etc.), avec Centrifugo, un beau tableau de bord fonctionne √† la r√©ception du bureau de Badoo √† Moscou, et 350 000 utilisateurs sont connect√©s simultan√©ment au service spot.im √† la centrifugeuse. </p><br><p>  Quelques liens vers des articles pr√©c√©dents sur le serveur et son application pour ceux qui ont entendu parler pour la premi√®re fois du projet: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Plongez dans Centrifugo</a> , </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Centrifugo - 3,5 millions de tr / min</a> , </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ainsi qu'un article en anglais racontant l'histoire du projet et la motivation de son apparition</a> . </li></ul><br><p>  J'ai commenc√© √† travailler sur la deuxi√®me version en d√©cembre de l'ann√©e derni√®re et continue √† ce jour.  Voyons ce qui se passe.  J'√©cris cet article non seulement pour vulgariser le projet, mais aussi pour obtenir un retour un peu plus constructif avant la sortie de Centrifugo v2 - maintenant il y a de la place pour la man≈ìuvre et des changements incompatibles. </p><br><h1 id="real-time-biblioteka-dlya-go">  Biblioth√®que en temps r√©el pour Go </h1><br><p>  Dans la communaut√© Go, la question se pose de temps en temps - existe-t-il des alternatives √† socket.io sur Go?  Parfois, j'ai remarqu√© que les d√©veloppeurs en r√©ponse √† cela sont invit√©s √† se tourner vers Centrifugo.  Cependant, Centrifugo est un serveur auto-h√©berg√©, pas une biblioth√®que - la comparaison n'est pas juste.  On m'a √©galement demand√© √† plusieurs reprises si le code Centrifugo pouvait √™tre r√©utilis√© pour √©crire des applications en temps r√©el dans Go.  Et la r√©ponse √©tait: th√©oriquement possible, mais je ne pouvais pas garantir la r√©trocompatibilit√© de l'API des packages internes √† mes risques et p√©rils.  Il est clair qu'il n'y a aucune raison pour que quelqu'un le prenne, et la fourche est √©galement une option.  De plus, je ne dirais pas que l'API pour les packages internes a √©t√© g√©n√©ralement pr√©par√©e pour une telle utilisation. </p><br><p>  Par cons√©quent, l'une des t√¢ches ambitieuses que je voulais r√©soudre dans le processus de travail sur la deuxi√®me version du serveur √©tait d'essayer de s√©parer le c≈ìur du serveur dans une biblioth√®que distincte sur Go.  Je crois que cela a du sens, compte tenu du nombre de fonctionnalit√©s de la centrifugeuse pour √™tre adapt√© √† la production.  De nombreuses fonctionnalit√©s pr√™tes √† l'emploi permettent de cr√©er des applications √©volutives en temps r√©el, √©liminant ainsi la n√©cessit√© pour les d√©veloppeurs d'√©crire leurs propres solutions.  J'ai √©crit sur ces fonctionnalit√©s plus t√¥t et j'en d√©crirai √©galement certaines ci-dessous. </p><br><p>  J'essaierai de justifier un plus de l'existence d'une telle biblioth√®que.  La plupart des utilisateurs de Centrifugo sont des d√©veloppeurs qui √©crivent des backends dans des langages / frameworks avec un support de concurrence faible (par exemple Django / Flask / Laravel / ...): travaillent avec beaucoup de connexions persistantes si possible, de mani√®re non √©vidente ou inefficace.  En cons√©quence, tous les utilisateurs ne peuvent pas aider au d√©veloppement d'un serveur √©crit en Go (ringard en raison d'un manque de connaissance de la langue).  Par cons√©quent, m√™me une tr√®s petite communaut√© de d√©veloppeurs Go autour de la biblioth√®que pourra aider √† d√©velopper le serveur Centrifugo en l'utilisant. </p><br><p>  Le r√©sultat est une biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Centrifuge</a> .  C'est toujours WIP, mais absolument toutes les fonctionnalit√©s indiqu√©es dans la description sur Github sont impl√©ment√©es et fonctionnent.  √âtant donn√© que la biblioth√®que fournit une API assez riche, avant de garantir la compatibilit√© descendante, je voudrais entendre plusieurs exemples r√©ussis d'utilisation dans de vrais projets sur Go.  Il n'y en a pas encore.  En plus d'√©chec :).  Il n'y en a pas. </p><br><p>  Je comprends qu'en nommant la biblioth√®que de la m√™me mani√®re que le serveur, je g√©rerai √† jamais la confusion.  Mais je pense que c'est le bon choix, car les clients (tels que centrifuge-js, centrifuge-go) fonctionnent √† la fois avec la biblioth√®que Centrifuge et le serveur Centrifugo.  De plus, le nom est d√©j√† bien ancr√© dans l'esprit des utilisateurs, et je ne veux pas perdre ces associations.  Et pourtant, pour un peu plus de clart√©, je vais encore clarifier: </p><br><ul><li>  Centrifuge - une biblioth√®que pour la langue Go, </li><li>  Centrifugo est une solution cl√© en main, un service distinct, qui dans la version 2 sera construit sur la biblioth√®que Centrifuge. </li></ul><br><p>  En raison de sa conception, Centrifugo (un service autonome qui ne sait rien de votre backend) suppose que le flux de messages via le transport en temps r√©el ira du serveur au client.  Que voulez-vous dire?  Si, par exemple, l'utilisateur √©crit un message dans le chat, ce message doit d'abord √™tre envoy√© au backend de l'application (par exemple, AJAX dans le navigateur), valid√© c√¥t√© backend, enregistr√© dans la base de donn√©es si n√©cessaire, puis envoy√© √† l'API Centrifuge.  La biblioth√®que supprime cette restriction, vous permettant d'organiser l'√©change bidirectionnel de messages asynchrones entre le serveur et le client, ainsi que les appels RPC. </p><br><p><img src="https://habrastorage.org/webt/jf/_d/er/jf_dervpzmkl2fuprcse34ayoke.png"></p><br><p>  Regardons un exemple simple: nous impl√©mentons un petit serveur sur Go en utilisant la biblioth√®que Centrifuge.  Le serveur recevra les messages des clients du navigateur via Websocket, le client disposera d'un champ de texte dans lequel vous pourrez conduire un message, appuyez sur Entr√©e - et le message sera envoy√© √† tous les utilisateurs abonn√©s √† la cha√Æne.  Autrement dit, la version la plus simplifi√©e du chat.  Il m'a sembl√© qu'il serait plus commode de placer cela sous la forme d'un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©sum√©</a> . </p><br><p>  Vous pouvez ex√©cuter comme d'habitude: </p><br><pre><code class="go hljs">git clone https:<span class="hljs-comment"><span class="hljs-comment">//gist.github.com/2f1a38ae2dcb21e2c5937328253c29bf.git cd 2f1a38ae2dcb21e2c5937328253c29bf go get -u github.com/centrifugal/centrifuge go run main.go</span></span></code> </pre> <br><p>  Et puis allez sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http: // localhost: 8000</a> , ouvrez plusieurs onglets de navigateur. </p><br><p>  Comme vous pouvez le voir, le point d'entr√©e de la logique m√©tier de l'application se produit lors du blocage des fonctions de rappel <code>On().Connect()</code> : </p><br><pre> <code class="go hljs">node.On().Connect(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx context.Context, client *centrifuge.Client, e centrifuge.ConnectEvent)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">centrifuge</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConnectReply</span></span></span></span> { client.On().Disconnect(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(e centrifuge.DisconnectEvent)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">centrifuge</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DisconnectReply</span></span></span></span> { log.Printf(<span class="hljs-string"><span class="hljs-string">"client disconnected"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> centrifuge.DisconnectReply{} }) log.Printf(<span class="hljs-string"><span class="hljs-string">"client connected via %s"</span></span>, client.Transport().Name()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> centrifuge.ConnectReply{} })</code> </pre> <br><p>  L'approche bas√©e sur le rappel m'a sembl√© la plus pratique pour interagir avec la biblioth√®que.  De plus, une approche similaire, mais faiblement typ√©e, est utilis√©e dans la mise en ≈ìuvre du <a href="">serveur socket-io sur Go</a> .  Si tout √† coup vous avez des id√©es sur la fa√ßon dont l'API pourrait √™tre r√©alis√©e de mani√®re plus idiomatique - je serai heureux de l'entendre. </p><br><p>  Il s'agit d'un exemple tr√®s simple qui ne montre pas toutes les fonctionnalit√©s de la biblioth√®que.  Quelqu'un peut noter qu'√† de telles fins, il est plus facile de prendre une biblioth√®que pour travailler avec Websocket.  Par exemple, Gorilla Websocket.  Il en est ainsi.  Cependant, m√™me dans ce cas, vous devrez copier un morceau de code de serveur d√©cent √† partir de l'exemple dans le r√©f√©rentiel Gorilla Websocket.  Et si: </p><br><ul><li>  vous devez faire √©voluer l'application sur plusieurs machines, </li><li>  ou vous n'avez pas besoin d'un canal commun, mais de plusieurs - et les utilisateurs peuvent s'abonner et se d√©sabonner dynamiquement d'eux lorsque vous naviguez dans votre application, </li><li>  ou vous devez travailler lorsque la connexion Websocket n'a pas pu √™tre √©tablie (il n'y a pas de support dans le navigateur du client, il y a une extension de navigateur, une sorte de proxy sur le chemin entre le client et le serveur coupe la connexion), </li><li>  ou vous devez restaurer les messages manqu√©s par le client pendant de courtes pauses dans la connexion Internet sans charger la base de donn√©es principale, </li><li>  ou vous avez besoin de contr√¥ler l'autorisation utilisateur dans le canal, </li><li>  ou vous devez d√©connecter la connexion permanente des utilisateurs qui sont d√©sactiv√©s dans l'application, </li><li>  ou vous avez besoin d'informations sur qui est actuellement sur la cha√Æne ou sur les √©v√©nements auxquels une personne s'est abonn√©e / d√©sabonn√©e de la cha√Æne, </li><li>  ou avez-vous besoin de mesures et de surveillance? </li></ul><br><p>  La biblioth√®que Centrifuge peut vous y aider - en fait, elle a h√©rit√© de toutes les fonctionnalit√©s de base qui √©taient auparavant disponibles dans Centrifugo.  Plus d'exemples montrant les points √©nonc√©s ci-dessus peuvent √™tre trouv√©s sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Github</a> . </p><br><p>  Le fort h√©ritage de Centrifugo peut √™tre un inconv√©nient, car la biblioth√®que a adopt√© toutes les m√©caniques de serveur, qui sont assez originales et, peut-√™tre, peuvent sembler peu √©videntes ou surcharg√©es de fonctionnalit√©s inutiles pour quelqu'un.  J'ai essay√© d'organiser le code de telle mani√®re que les fonctionnalit√©s inutilis√©es n'affectent pas les performances globales. </p><br><p>  Il existe des optimisations dans la biblioth√®que qui permettent une utilisation plus efficace des ressources.  Il s'agit de combiner plusieurs messages dans une trame Websocket pour √©conomiser sur les appels syst√®me Write ou, par exemple, utiliser Gogoprotobuf pour s√©rialiser les messages Protobuf et autres.  En parlant de Protobuf. </p><br><h1 id="binarnyy-protobuf-protokol">  Protocole Protobuf binaire </h1><br><p>  Je voulais vraiment que Centrifugo travaille avec des donn√©es binaires ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">et pas seulement moi</a> ), donc dans la nouvelle version, je voulais ajouter un protocole binaire en plus de celui existant bas√© sur JSON.  Maintenant, le protocole entier est d√©crit comme un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sch√©ma Protobuf</a> .  Cela nous a permis de le rendre plus structur√©, de repenser certaines d√©cisions non √©videntes dans le protocole de la premi√®re version. </p><br><p>  Je pense que vous n'avez pas besoin de dire longtemps quels sont les avantages de Protobuf par rapport √† JSON - compacit√©, vitesse de s√©rialisation, sch√©ma strict.  Il y a un inconv√©nient sous la forme d'illisibilit√©, mais maintenant les utilisateurs ont la possibilit√© de d√©cider ce qui est le plus important pour eux dans une situation particuli√®re. </p><br><p>  En g√©n√©ral, le trafic g√©n√©r√© par le protocole Centrifugo lors de l'utilisation de Protobuf au lieu de JSON devrait diminuer d'environ 2 fois (√† l'exclusion des donn√©es d'application).  La consommation de CPU dans mes tests de charge synth√©tique a diminu√© de la m√™me mani√®re ~ 2 fois par rapport √† JSON.  Ces chiffres parlent en fait peu de ce que, dans la pratique, tout d√©pendra du profil de charge d'une application particuli√®re. </p><br><p>  Pour des raisons d'int√©r√™t, j'ai lanc√© sur une machine avec Debian 9.4 et 32 ‚Äã‚Äãprocesseurs Intel¬Æ Xeon¬Æ Platinum 8168 @ 2.70GHz vCPU, ce qui nous a permis de comparer la bande passante de l'interaction client-serveur en cas d'utilisation du protocole JSON et du protocole Protobuf.  Il y avait 1000 abonn√©s √† 1 cha√Æne.  Sur cette cha√Æne, les messages ont √©t√© publi√©s en 4 flux et remis √† tous les abonn√©s.  La taille de chaque message √©tait de 128 octets. </p><br><p>  R√©sultats pour JSON: </p><br><pre> <code class="go hljs">$ <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> run main.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> -s ws:<span class="hljs-comment"><span class="hljs-comment">//localhost:8000/connection/websocket -n 1000 -ns 1000 -np 4 channel Starting benchmark [msgs=1000, msgsize=128, pubs=4, subs=1000] Centrifuge Pub/Sub stats: 265,900 msgs/sec ~ 32.46 MB/sec Pub stats: 278 msgs/sec ~ 34.85 KB/sec [1] 73 msgs/sec ~ 9.22 KB/sec (250 msgs) [2] 71 msgs/sec ~ 9.00 KB/sec (250 msgs) [3] 71 msgs/sec ~ 8.90 KB/sec (250 msgs) [4] 69 msgs/sec ~ 8.71 KB/sec (250 msgs) min 69 | avg 71 | max 73 | stddev 1 msgs Sub stats: 265,635 msgs/sec ~ 32.43 MB/sec [1] 273 msgs/sec ~ 34.16 KB/sec (1000 msgs) ... [1000] 277 msgs/sec ~ 34.67 KB/sec (1000 msgs) min 265 | avg 275 | max 278 | stddev 2 msgs</span></span></code> </pre> <br><p>  R√©sultats pour le cas Protobuf: </p><br><pre> <code class="go hljs">$ <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> run main.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> -s ws:<span class="hljs-comment"><span class="hljs-comment">//localhost:8000/connection/websocket?format=protobuf -n 100000 -ns 1000 -np 4 channel Starting benchmark [msgs=100000, msgsize=128, pubs=4, subs=1000] Centrifuge Pub/Sub stats: 681,212 msgs/sec ~ 83.16 MB/sec Pub stats: 685 msgs/sec ~ 85.69 KB/sec [1] 172 msgs/sec ~ 21.57 KB/sec (25000 msgs) [2] 171 msgs/sec ~ 21.47 KB/sec (25000 msgs) [3] 171 msgs/sec ~ 21.42 KB/sec (25000 msgs) [4] 171 msgs/sec ~ 21.42 KB/sec (25000 msgs) min 171 | avg 171 | max 172 | stddev 0 msgs Sub stats: 680,531 msgs/sec ~ 83.07 MB/sec [1] 681 msgs/sec ~ 85.14 KB/sec (100000 msgs) ... [1000] 681 msgs/sec ~ 85.13 KB/sec (100000 msgs) min 680 | avg 680 | max 685 | stddev 1 msgs</span></span></code> </pre><br><p>  Vous pouvez remarquer que le d√©bit d'une telle installation est plus de 2 fois sup√©rieur dans le cas de Protobuf.  Le script client peut √™tre trouv√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> - c'est le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">script de r√©f√©rence Nats adapt√© aux r√©alit√©s de Centrifuge</a> . </p><br><p>  Il convient √©galement de noter que les performances de la s√©rialisation JSON sur le serveur peuvent √™tre "am√©lior√©es" en utilisant la m√™me approche que dans gogoprotobuf - pool de tampons et g√©n√©ration de code - actuellement JSON est s√©rialis√© par un package de la biblioth√®que standard Go construite sur Reflect.  Par exemple, dans Centrifugo, la premi√®re version de JSON est s√©rialis√©e manuellement √† l'aide d'une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">biblioth√®que</a> qui fournit <a href="">un pool de m√©moire tampon</a> .  Quelque chose de similaire peut √™tre fait √† l'avenir dans le cadre de la deuxi√®me version. </p><br><p>  Il convient de souligner que protobuf peut √©galement √™tre utilis√© lors de la communication avec le serveur √† partir d'un navigateur.  Le client javascript utilise pour cela la biblioth√®que protobuf.js.  √âtant donn√© que la biblioth√®que protobufjs est assez lourde et que le nombre d'utilisateurs au format binaire sera petit, en utilisant webpack et son algorithme de tremblement d'arbre, nous g√©n√©rons deux versions du client - l'une avec prise en charge du protocole JSON uniquement, et l'autre avec prise en charge JSON et protobuf.  Pour les autres environnements o√π la taille des ressources ne joue pas un r√¥le aussi critique, les clients ne peuvent pas s'inqui√©ter de cette s√©paration. </p><br><h1 id="json-web-token-jwt">  Jeton Web JSON (JWT) </h1><br><p>  L'un des probl√®mes li√©s √† l'utilisation d'un serveur autonome tel que Centrifugo est qu'il ne sait rien de vos utilisateurs et de leur m√©thode d'authentification, ni du type de m√©canisme de session utilis√© par votre backend.  Et vous devez en quelque sorte authentifier la connexion. </p><br><p>  Pour ce faire, dans la premi√®re version Centrifuge, lors de la connexion, la signature SHA-256 HMAC a √©t√© utilis√©e, bas√©e sur une cl√© secr√®te connue uniquement du backend et de la Centrifuge.  Ainsi, l'ID utilisateur transmis par le client lui appartient r√©ellement. </p><br><p>  Peut-√™tre que le transfert correct des param√®tres de connexion et la g√©n√©ration d'un jeton ont √©t√© l'une des principales difficult√©s √† int√©grer Centrifugo dans le projet. </p><br><p>  Lorsque la centrifugeuse est apparue, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">la norme JWT</a> n'√©tait pas encore si populaire.  Maintenant, quelques ann√©es plus tard, des biblioth√®ques pour la g√©n√©ration JWT sont disponibles pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">les langues les plus populaires</a> .  L'id√©e principale de JWT est exactement ce dont la centrifugeuse a besoin: la confirmation de l'authenticit√© des donn√©es transmises.  Dans la deuxi√®me version de HMAC, une signature g√©n√©r√©e manuellement a fait place √† l'utilisation de JWT.  Cela a permis de supprimer le besoin de prise en charge des fonctions d'assistance pour la g√©n√©ration correcte de jetons dans des biblioth√®ques pour diff√©rentes langues. </p><br><p>  Par exemple, en Python, un jeton de connexion √† Centrifugo peut √™tre g√©n√©r√© comme suit: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> jwt <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time token = jwt.encode({<span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"42"</span></span>, <span class="hljs-string"><span class="hljs-string">"exp"</span></span>: int(time.time()) + <span class="hljs-number"><span class="hljs-number">10</span></span>*<span class="hljs-number"><span class="hljs-number">60</span></span>}, <span class="hljs-string"><span class="hljs-string">"secret"</span></span>).decode() print(token)</code> </pre> <br><p>  Il est important de noter que si vous utilisez la biblioth√®que Centrifuge, vous pouvez authentifier l'utilisateur en utilisant la m√©thode Go native - √† l'int√©rieur du middleware.  Des exemples sont dans le r√©f√©rentiel. </p><br><h1 id="grpc">  GRPC </h1><br><p>  Pendant le d√©veloppement, j'ai essay√© le streaming bidirectionnel GRPC comme moyen de transport pour la communication entre le client et le serveur (en plus des solutions de secours Websocket et HTTP SockJS).  Que puis-je dire?  Il a travaill√©.  Cependant, je n'ai pas trouv√© un seul sc√©nario o√π le streaming GRPC bidirectionnel serait mieux que Websocket.  J'ai regard√© principalement les m√©triques du serveur: trafic g√©n√©r√© via l'interface r√©seau, consommation CPU par le serveur avec un grand nombre de connexions entrantes, consommation m√©moire par connexion. </p><br><p>  GRPC a perdu Websocket √† tous √©gards: </p><br><ul><li>  GRPC g√©n√®re 20% de trafic suppl√©mentaire dans des sc√©narios similaires, </li><li>  GRPC consomme 2 √† 3 fois plus de CPU (selon la configuration des connexions - tous sont abonn√©s √† des canaux diff√©rents ou tous sont abonn√©s √† un canal), </li><li>  GRPC consomme 4 fois plus de RAM par connexion.  Par exemple, sur des connexions 10 000, le serveur Websocket a consomm√© 500 Mo de m√©moire et GRPC - 2 Go. </li></ul><br><p>  Les r√©sultats √©taient assez ... attendus.  En g√©n√©ral, dans GRPC, en tant que transport client, je ne voyais pas beaucoup de sens - et j'ai supprim√© le code avec une conscience claire jusqu'√† ce que, peut-√™tre, des temps meilleurs. </p><br><p>  Cependant, GRPC est bon pour ce pour quoi il a √©t√© principalement cr√©√© - pour g√©n√©rer du code qui vous permet de faire des appels RPC entre les services en utilisant un sch√©ma pr√©d√©termin√©.  Par cons√©quent, en plus de l'API HTTP, la centrifugeuse aura d√©sormais √©galement la prise en charge de l'API bas√©e sur GRPC, par exemple pour la publication de nouveaux messages sur le canal et d'autres m√©thodes d'API de serveur disponibles. </p><br><h1 id="slozhnosti-s-klientami">  Difficult√©s avec les clients </h1><br><p>  Les modifications apport√©es dans la deuxi√®me version, j'ai supprim√© le support obligatoire des biblioth√®ques pour l'API serveur - il est devenu plus facile √† int√©grer c√¥t√© serveur, cependant, le protocole client du projet a √©t√© modifi√© et dispose d'un nombre suffisant de fonctionnalit√©s.  Cela rend la mise en ≈ìuvre des clients assez difficile.  Pour la deuxi√®me version, nous avons maintenant un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">client pour Javascript</a> qui fonctionne dans les navigateurs, devrait fonctionner avec NodeJS et React-Native.  Il existe un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">client sur Go</a> et construit sur sa base et sur la base <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">des liants de projet gomobile</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pour iOS et Android</a> . </p><br><p>  Pour un bonheur complet, il n'y a pas assez de biblioth√®ques natives pour iOS et Android.  Pour la premi√®re version de Centrifugo, ils ont √©t√© achet√©s par des gars de la communaut√© open-source.  Je veux croire que quelque chose comme √ßa va arriver maintenant. </p><br><p>  J'ai r√©cemment tent√© ma chance en envoyant une demande de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">subvention MOSS de Mozilla</a> , dans l'intention d'investir dans le d√©veloppement client, mais a √©t√© refus√©e.  La raison en est la communaut√© insuffisamment active sur Github.  Malheureusement, cela est vrai, mais comme vous pouvez le voir, je prends des mesures pour am√©liorer la situation. </p><br><p><img src="https://habrastorage.org/webt/y4/3q/kc/y43qkcl_yp7fjdgalrqvuzw5hl0.jpeg"></p><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  Je n'ai pas annonc√© toutes les fonctionnalit√©s qui appara√Ætront dans Centrifugo v2 - un peu plus d'informations sont dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">probl√®me sur Github</a> .  La version du serveur n'a pas encore eu lieu, mais elle arrivera bient√¥t.  Il reste des moments inachev√©s, notamment la n√©cessit√© de compl√©ter la documentation.  Le prototype de la documentation peut √™tre consult√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> .  Si vous √™tes un utilisateur de Centrifugo, c'est le bon moment pour influencer la deuxi√®me version du serveur.  Un moment o√π ce n'est pas si effrayant de casser quelque chose, de mieux faire plus tard.  Pour les int√©ress√©s: le d√©veloppement est concentr√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dans la branche c2</a> . </p><br><p>  Il est difficile pour moi de juger de la demande de la biblioth√®que Centrifuge qui sous-tend Centrifugo v2.  Pour le moment, je suis heureux d'avoir pu le ramener √† son √©tat actuel.  L'indicateur le plus important pour moi maintenant est la r√©ponse √† la question "est-ce que j'utiliserais moi-m√™me cette biblioth√®que dans mon projet personnel?"  Ma r√©ponse est oui.  Au travail?  Oui  Par cons√©quent, je crois que d'autres d√©veloppeurs l'appr√©cieront. </p><br><p>  PS Je voudrais remercier les gars qui ont aid√© avec le travail et les conseils - Dmitry Korolkov, Artemy Ryabinkov, Oleg Kuzmin.  Ce serait serr√© sans toi. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr416915/">https://habr.com/ru/post/fr416915/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr416905/index.html">Pr√©sentation de Boston Dynamics SpotMini</a></li>
<li><a href="../fr416907/index.html">Th√©orie du bonheur. Z√®bre de loi et file d'attente extraterrestre</a></li>
<li><a href="../fr416909/index.html">Historique des sessions actives de PostgreSQL - nouvelle extension pgsentinel</a></li>
<li><a href="../fr416911/index.html">Les chatbots √©taient cens√©s √™tre la prochaine perc√©e: qu'est-ce qui a mal tourn√©?</a></li>
<li><a href="../fr416913/index.html">Qu'est-ce que l'administrateur doit oublier lors du passage au cloud - et ce qu'il faut apprendre</a></li>
<li><a href="../fr416917/index.html">Septi√®me tristesse</a></li>
<li><a href="../fr416919/index.html">Burger King et enregistrement d'√©cran secret de votre t√©l√©phone</a></li>
<li><a href="../fr416921/index.html">Comment des centaines de milliers d'antennes se r√©unissent dans un seul t√©lescope</a></li>
<li><a href="../fr416925/index.html">Ce que nous savons sur Ant Design</a></li>
<li><a href="../fr416927/index.html">Startups de chaussures - et pourquoi la Silicon Valley les aime tant</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>