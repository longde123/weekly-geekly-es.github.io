<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ•Šï¸ ğŸ‘ŒğŸ¼ ğŸ¤¾ğŸ¼ Showcase model driver sederhana (SDM) NodeMCU: antarmuka pengguna yang dinamis ğŸ’„ ğŸ‘©ğŸ¿â€ğŸ¤â€ğŸ‘©ğŸ¾ ğŸ•µğŸ¿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="NodeMCU adalah firmware interaktif , yang memungkinkan menjalankan interpreter Lua pada mikrokontroler ESP8266 (dukungan ESP32 sedang dalam pengembang...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Showcase model driver sederhana (SDM) NodeMCU: antarmuka pengguna yang dinamis</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/449992/"><p><img src="https://habrastorage.org/webt/45/dq/e8/45dqe8yvyxvpg_kcien-88xslei.jpeg" alt="gambar"></p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">NodeMCU</a> adalah <em>firmware interaktif</em> , yang memungkinkan menjalankan interpreter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Lua</a> pada mikrokontroler <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">ESP8266</a> (dukungan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">ESP32</a> sedang dalam pengembangan).  Bersamaan dengan semua antarmuka perangkat keras biasa, ia memiliki modul WiFi dan sistem file <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">SPIFFS</a> . </p><br><p>  Artikel ini menjelaskan modul baru untuk NodeMCU - sdm.  SDM merupakan kependekan dari model driver sederhana dan menyediakan abstraksi model driver-perangkat untuk sistem.  Pada bagian pertama artikel ini kita akan membahas model itu sendiri dan pada bagian kedua akan menjadi karya antarmuka pengguna web yang dibuat secara dinamis menggunakan sdm dengan beberapa komentar. </p><a name="habracut"></a><br><h1 id="driver-model-basics">  Dasar-dasar model driver </h1><br><p>  Dua komponen utama dari model ini adalah <em>perangkat</em> dan <em>driver</em> .  Perangkat adalah representasi abstrak dari beberapa perangkat keras atau perangkat virtual.  Masuk akal untuk menempatkan perangkat ke hierarki pohon, dengan mikrokontroler di atas, bus di tengah dan sensor sebagai dedaunan. </p><br><pre><code class="plaintext hljs">DEVICES + DRIVERS | +-----+ | +-----+ |1WIRE&lt;----------------------+1WIRE| ++-+-++ | +-----+ | | | | +---------+ | +--------+ | +------+ | | | +------+DS1820| +---v----+ +---v----+ +---v----+ | | +------+ |DS1820|0| |DS1820|1| |DS1822|0| | | +---^----+ +---^----+ +---^----+ | | +------+ | | +--------------+DS1822| | | | | +------+ +-----------+------------------+ +</code> </pre> <br><p>  Driver perangkat adalah sepotong logika yang terkait dengan perangkat yang diberikan.  Fungsi yang disediakan oleh driver disebut <em>metode</em> , wadah data yang terkait dengan driver disebut <em>atribut</em> .  Baik metode dan atribut tinggal di dalam driver. </p><br><p>  Atribut memiliki dua fungsi yang terkait dengannya: kait <em>pengambil</em> dan <em>penyetel</em> .  Jadi atribut fungsionalitas metode superset, tetapi mereka juga mengambil lebih banyak memori (memori mikrokontroler langka, ingat?). </p><br><pre> <code class="lua hljs">sdm.attr_add(drv, <span class="hljs-comment"><span class="hljs-comment">-- device handle "ref", -- attribute name "Reference voltage", -- attribute description 5, function(dev) -- this is a getter function return sdm.attr_data(sdm.attr_handle(dev, "ref")) end, function(dev, value) -- this is a setter function sdm.attr_set(sdm.attr_handle(dev, "ref"), value) end )</span></span></code> </pre> <br><h2 id="device-binding">  Mengikat perangkat </h2><br><p>  Bagian rumit dari model driver adalah pengikatan device-driver.  Prosesnya sendiri cukup sederhana: kami mencocokkan perangkat dengan masing-masing driver yang tersedia hingga cocok.  Hanya dua bagian yang hilang - logika yang cocok dan beberapa data untuk dicocokkan. </p><br><p>  Dalam sdm, logika yang cocok tinggal di driver dengan nama <code>_poll()</code> .  Ini adalah metode biasa yang disebut dengan gagang perangkat sebagai parameter dan mengembalikan <code>true</code> atau <code>false</code> jika perangkat dapat atau tidak dapat dilampirkan ke driver masing-masing. </p><br><pre> <code class="lua hljs">sdm.method_add(drv, <span class="hljs-string"><span class="hljs-string">"_poll"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dev, drv, par)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> attr = sdm.attr_data(sdm.local_attr_handle(dev, <span class="hljs-string"><span class="hljs-string">"id"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">-- get device attribute "id" if attr == nil then return false end -- if it does not have one, driver does not match -- parent name must be "ESP8266_1W" and first byte of "id" must be "0x28" return (sdm.device_name(par) == "ESP8266_1W") and (attr:byte(1) == 0x28) end )</span></span></code> </pre> <br><p>  Seperti terlihat pada contoh di atas, driver mencocokkan perangkat menggunakan atribut.  Tetapi seperti disebutkan di atas, atribut hanya diasosiasikan dengan driver.  Secara umum memang benar, tetapi ada beberapa atribut yang tidak dapat diambil melalui perangkat lunak.  Ini adalah chip ID, pin bekas dll.  Bagi mereka jenis atribut khusus telah ditambahkan ke <em>atribut</em> sdm - <em>local</em> .  Atribut ini dikaitkan dengan satu instance perangkat dan biasanya tidak berubah. </p><br><p>  Satu-satunya hal yang tersisa untuk dikatakan tentang pengikatan driver.  Biasanya perangkat memerlukan semacam inisialisasi pada startup dan pembersihan setelah digunakan.  Untuk tujuan ini sdm menggunakan <code>_init()</code> dan <code>_free()</code> . <br>  Jika driver memiliki metode <code>_init()</code> maka itu akan dipanggil secara otomatis setelah perangkat mengikat.  Sama dengan <code>_free()</code> . </p><br><pre> <code class="lua hljs">sdm.method_add(drv, <span class="hljs-string"><span class="hljs-string">"_init"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dev, drv, par)</span></span></span></span> sdm.device_rename(dev, sdm.request_name(<span class="hljs-string"><span class="hljs-string">"DS18B20"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">-- rename device sdm.attr_copy(dev, "temp") -- copy attribute sdm.attr_copy(dev, "precision") -- copy attribute local met = sdm.method_dev_handle(par, "setup") -- get 1Wire bus pin init function .. local func = sdm.method_func(met) -- .. and .. func(par, dev) -- .. call it end ) sdm.method_add(drv, "_free", nil, function(dev, drv, par) local met = sdm.method_dev_handle(par, "free") -- get 1Wire bus pin free function .. local func = sdm.method_func(met) -- .. and .. func(par, dev) -- .. call it end )</span></span></code> </pre> <br><p>  Pembaca yang penuh perhatian mungkin akan bertanya: apa artinya "menyalin atribut" pada contoh di atas?  Dan dia akan benar, karena ini ada hubungannya dengan atribut jenis ketiga yang belum kita diskusikan - <em>atribut pribadi</em> .  Tidak masuk akal untuk memiliki semua data atribut yang dibagikan di antara semua perangkat contoh.  Untuk keperluan ini sdm menyediakan mekanisme menyalin atribut dari driver dan menghubungkannya dengan perangkat.  Ini membuat atribut driver prototipe atau templat. </p><br><p>  Ringkasan cepat: </p><br><ul><li>  <em>atribut lokal</em> digunakan untuk data yang tidak dapat diambil oleh perangkat lunak.  Seperti ID perangkat, pin yang terhubung, dll. </li><li>  <em>atribut driver</em> digunakan untuk data yang dibagikan di antara semua instance perangkat yang terlampir pada driver ini. </li><li>  <em>atribut pribadi</em> disalin dari atribut driver dan menyimpan data yang terkait dengan hanya satu perangkat contoh.  Jenis ini adalah yang paling umum. </li></ul><br><div class="scrollable-table"><table><thead><tr><th>  Properti </th><th>  Atribut lokal </th><th>  Atribut pribadi </th><th>  Atribut driver (publik) </th></tr></thead><tbody><tr><td>  Disimpan dalam </td><td>  perangkat </td><td>  perangkat </td><td>  pengemudi </td></tr><tr><td>  Dapat diakses menggunakan pegangan pengemudi </td><td>  - </td><td>  - </td><td>  + </td></tr><tr><td>  Dapat diakses menggunakan pegangan perangkat </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  Dibagi antar perangkat </td><td>  - </td><td>  - </td><td>  + </td></tr><tr><td>  Bertahan saat pengemudi lepas </td><td>  + </td><td>  - </td><td>  + </td></tr></tbody></table></div><br><h1 id="web-user-interface-implementation">  Implementasi antarmuka pengguna web </h1><br><h2 id="server-code">  Kode server </h2><br><p>  Ada proyek <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://github.com/marcoskirsch/nodemcu-">nodemcu-httpserver yang</a> indah yang mengimplementasikan kode server untuk NudeMCU.  Sayangnya sepertinya sudah mati.  Itu digunakan sebagai dasar untuk server.  Pertama, fungsi server <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://gitlab.com/matsievskiysv/nodemcu-">dipindahkan ke LFS</a> dan kemudian <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://gitlab.com/matsievskiysv/nodemcu-pseudo">sedikit dimodifikasi</a> untuk melayani satu halaman statis untuk setiap panggilan.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Vue.js</a> adalah pilihan sempurna untuk halaman web berbasis template.  Jadi itu digunakan untuk <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">frontend</a> .  Perlu dicatat bahwa NodeMCU mungkin tidak terhubung ke Internet.  Karena itu, pustaka <code>vue.js</code> harus hadir secara lokal dan dilayani oleh server NodeMCU. </p><br><p>  Karena semua perangkat disusun dalam struktur pohon, mereka diakses seperti direktori: <code>/ESP8266/ESP8266_1W/DS18S20-0</code> .  Di sini <code>/ESP8266</code> adalah halaman NodeMCU, <code>/ESP8266/ESP8266_1W</code> adalah halaman bus <em>1Wire</em> dan akhirnya <code>/ESP8266/ESP8266_1W/DS18S20-0</code> adalah sensor suhu. </p><br><p>  Seperti disebutkan sebelumnya, semua halaman perangkat dibuat dari satu halaman template yang disajikan pada setiap panggilan.  Kode <em>JS</em> di dalam halaman ini kemudian membuat permintaan ke URL yang sama, diawali dengan <code>/api</code> .  Untuk contoh URL panggilan di atas adalah <code>/api/ESP8266/ESP8266_1W/DS18S20-0</code> .  Atas permintaan tersebut, server merespons dengan data spesifik perangkat yang disandikan <em>JSON</em> , yang mengisi halaman tersebut.  Tentu saja, permintaan halaman <em>HTML</em> dapat dilewati jika hanya data mentah yang diperlukan. </p><br><h2 id="device-tree">  Pohon perangkat </h2><br><p>  Konfigurasi perangkat awal dilakukan menggunakan struktur <em>pohon perangkat sederhana</em> .  Ini seperti <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pohon perangkat</a> , tetapi lebih sederhana.  Ini menjelaskan konfigurasi perangkat keras termasuk atribut lokal perangkat. </p><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> root={ <span class="hljs-comment"><span class="hljs-comment">-- local_attributes={}, children={ { name="ESP8266_1W", -- local_attributes={}, children = { { name="DS18S20-0", -- static declaration alternative to 1Wire poll method local_attributes={ { name="id", desc=nil, -- empty description to save space data=string.char(16) .. string.char(221) .. string.char(109) .. string.char(104) .. string.char(3) .. string.char(8) .. string.char(0) .. string.char(150) -- ugly way to create byte array }, { datapin=2 } } }, } }, { name="ESP8266_SPI", -- local_attributes={}, children = { { name="MCP3208-0" }, } }, } }</span></span></code> </pre> <br><h2 id="hardware-setup">  Pengaturan perangkat keras </h2><br><p>  Di sinilah dimulai showcase.  Untuk keperluan ini, sekelompok sensor terhubung ke NodeMCU: </p><br><ul><li>  Sensor suhu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">DS18B20</a> </li><li>  Sensor suhu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">DS18S20</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">MCP3208</a> ADC </li></ul><br><p>  <em>1</em> Sensor <em>kawat</em> terhubung ke pin yang sama. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/fb/sw/zi/fbswzi7xav_pj4waz6g19hktrso.jpeg"></a> </p><br><h2 id="web-pages-and-drivers">  Halaman web dan driver </h2><br><h3 id="root-device">  perangkat root </h3><br><p>  Tujuan utama perangkat root (alias ESP8266) adalah untuk menyediakan tempat bagi anak-anak untuk terhubung.  Namun tidak terbatas untuk memiliki metode atau atribut yang terkait dengannya. </p><br><p>  Cuplikan kode ini dari <a href="">sini</a> : </p><br><pre> <code class="lua hljs">sdm.method_add(drv, <span class="hljs-string"><span class="hljs-string">"_init"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dev, drv, par)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> attr = sdm.attr_handle(dev, <span class="hljs-string"><span class="hljs-string">"id"</span></span>) <span class="hljs-comment"><span class="hljs-comment">-- get device "id" attribute sdm.attr_set(attr, node.chipid()) -- set "id" value attr = sdm.attr_handle(dev, "float") -- get device "float" attribute sdm.attr_set(attr, 3 / 2 ~= 1) -- set to true if firmware supports floating point instructions end ) sdm.attr_add(drv, "float", "Floating point build", false, function(drv) -- attribute value is set inside "_init" function local attr = sdm.attr_drv_handle(drv, "float") return sdm.attr_data(attr) -- just return stored value end, nil )</span></span></code> </pre> <br><p>  Kode ini menambahkan atribut <code>float</code> yang digunakan untuk menampung <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tipe build</a> firmware.  Nilainya diinisialisasi dalam kait <code>_init()</code> yang merupakan fungsi khusus, yang berjalan satu kali ketika driver menempel ke perangkat. </p><br><p>  Ini adalah halaman yang dihasilkan untuk perangkat root. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/mg/5q/lo/mg5qlog3-nwjkl6itrfw6ynyvuo.png"></a> </p><br><p>  Di sini kita dapat melihat bahwa perangkat root memiliki satu metode <code>heap</code> , dua atribut driver <code>float</code> dan <code>id</code> .  Akhirnya, ia memiliki dua perangkat yang terhubung - <em>SPI</em> dan <em>1Wire</em> bus. </p><br><h3 id="spi">  SPI </h3><br><p>  <a href="">Pengemudi <em>SPI</em></a> tidak terlalu menarik.  Itu hanya memetakan fungsi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">NodeMCU SPI</a> . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/qx/mx/g8/qxmxg8mnkmnl5aglfq7q5zhpnv0.png"></a> </p><br><h3 id="mcp3208">  Mcp3208 </h3><br><p>  <em>MCP3208</em> adalah chip <em>ADC</em> .  Ini mengukur tegangan dari nol ke <em>ref</em> dan mengembalikan kode 12 bit.  Yang menarik dari implementasi <a href="">driver</a> ini adalah bahwa atribut <code>ref</code> hanya akan hadir jika firmware mendukung aritmatika floating point.  Jika tidak didukung maka alih-alih tegangan absolut, kode tegangan dikembalikan oleh metode <code>single</code> dan <code>differential</code> . </p><br><pre> <code class="lua hljs">sdm.method_add(drv, <span class="hljs-string"><span class="hljs-string">"single"</span></span>, <span class="hljs-string"><span class="hljs-string">"Single ended measure 0|1|2|3|4|5|6|7"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dev, channel)</span></span></span></span> <span class="hljs-comment"><span class="hljs-comment">-- ... if ref ~= nil then -- this part is executed only if floating point arithmetic is enabled rv = ref * rv / 4096 end return rv end ) if 3/2~=1 then -- other alternative is to access ESP8266 "float" method sdm.attr_add(drv, "ref", "Reference voltage", 5, function(dev) return sdm.attr_data(sdm.attr_handle(dev, "ref")) end, function(dev, value) sdm.attr_set(sdm.attr_handle(dev, "ref"), value) end ) end</span></span></code> </pre> <br><p> <a href=""><img src="https://habrastorage.org/webt/m_/_l/cc/m__lccntxwsrorrujvky3opbm0s.png"></a> </p><br><p>  Perhatikan juga bahwa perangkat ini memiliki atribut <code>ref</code> ditandai sebagai <em>pribadi</em> .  Ini diatur berdasarkan per perangkat. </p><br><h3 id="1wire">  1wire </h3><br><p>  <a href=""><em>1</em> Driver driver</a> mengimplementasikan metode <code>poll</code> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pencarian dinamis untuk perangkat</a> . </p><br><p>  Tepat setelah penemuan perangkat jenisnya tidak diketahui.  Jadi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">alamat unik</a> <em>1Wire</em> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">-nya</a> digunakan sebagai nama perangkat baru (byte diwakili sebagai angka yang dipisahkan oleh karakter <code>_</code> ). </p><br><pre> <code class="lua hljs">sdm.method_add(drv, <span class="hljs-string"><span class="hljs-string">"poll"</span></span>, <span class="hljs-string"><span class="hljs-string">"Poll for devices"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bus, pin)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> children = sdm.device_children(bus) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> {} <span class="hljs-comment"><span class="hljs-comment">-- already attached local ids = {} -- get IDs of attached devices for name, handle in pairs(children) do local dpin = sdm.attr_data(sdm.local_attr_handle(handle, "pin")) if dpin == pin then ids[sdm.attr_data(sdm.local_attr_handle(handle, "id"))] = true end end ow.reset_search(pin) -- reset previous search while true do -- for all found devices local id = ow.search(pin) if id == nil then break end if ids[id] == nil then -- if not already present local name = "" for i=1,#id do name = name .. tostring(id:byte(i)) .. "_" end name = name:sub(1,-2) -- add to system with their ID used as name local device = sdm.device_add(name, bus) -- add "pin" attribute local rv = sdm.local_attr_add(device, "datapin", nil, pin, nil, nil) -- add "id" attribute local rv = sdm.local_attr_add(device, "id", nil, id, nil, nil) -- poll for driver local rv = sdm.device_poll(device) end end end )</span></span></code> </pre> <br><p>  Ini adalah halaman awal untuk driver <em>1Wire</em> . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/j2/uq/ax/j2uqaxkhqilv0k1fmwaq2hn0iwq.png"></a> </p><br><p>  Setelah mengeluarkan panggilan <code>poll</code> dengan argumen <code>2</code> dan halaman yang menyegarkan, bagian anak-anak muncul.  Perhatikan bahwa nama anak-anak dapat dibaca manusia.  Ini karena fungsi <code>device_rename()</code> dipanggil selama <code>_init</code> mereka. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/_z/2x/na/_z2xnadqlt_qgyokfxomwivtwkq.png"></a> </p><br><h3 id="ds18s20">  DS18S20 </h3><br><p>  Setelah inisialisasi, <a href="">driver DS18S20</a> memeriksa bahwa <em>ID</em> perangkat dimulai dengan <code>0x10</code> , yang merupakan kode keluarga perangkat.  Ketika perangkat terpasang ke driver, namanya diganti menjadi <code>DS18S20-X</code> , di mana <code>DS18S20</code> adalah nama dasar dan <code>X</code> adalah nomor instan. </p><br><pre> <code class="lua hljs">sdm.method_add(drv, <span class="hljs-string"><span class="hljs-string">"_poll"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dev, drv, par)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> attr = sdm.attr_data(sdm.local_attr_handle(dev, <span class="hljs-string"><span class="hljs-string">"id"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> attr == <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (sdm.device_name(par) == <span class="hljs-string"><span class="hljs-string">"ESP8266_1W"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (attr:<span class="hljs-built_in"><span class="hljs-built_in">byte</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) == <span class="hljs-number"><span class="hljs-number">0x10</span></span>) <span class="hljs-comment"><span class="hljs-comment">-- check family ID end ) sdm.method_add(drv, "_init", nil, function(dev, drv, par) sdm.device_rename(dev, sdm.request_name("DS18S20")) -- rename device sdm.attr_copy(dev, "temp") -- copy attribute to device local met = sdm.method_dev_handle(par, "setup") local func = sdm.method_func(met) -- use parent "setup" method on the device func(par, dev) end )</span></span></code> </pre> <br><p> <a href=""><img src="https://habrastorage.org/webt/bm/pk/41/bmpk419dphexm-xlvnxq7hw2jxc.png"></a> </p><br><p>  Atribut lokal <code>id</code> dan <code>datapin</code> tidak memiliki kait <code>getter</code> dan <code>setter</code> , jadi hanya nama mereka yang terlihat. </p><br><h3 id="ds18b20">  DS18B20 </h3><br><p>  <a href="">Driver DS18B20</a> hampir sama dengan <a href="">driver DS18S20</a> .  Satu-satunya perbedaan adalah metode <code>precision</code> .  Kedua driver <em>DS18? 20</em> menganggap build integer dan tidak menggunakan divisi floating point. </p><br><pre> <code class="lua hljs">sdm.attr_add(drv, <span class="hljs-string"><span class="hljs-string">"precision"</span></span>, <span class="hljs-string"><span class="hljs-string">"Precision (9|10|11|12)"</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dev, precision)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> attr = sdm.attr_dev_handle(dev, <span class="hljs-string"><span class="hljs-string">"precision"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sdm.attr_data(attr) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dev, precision)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> par = sdm.device_parent(dev) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> attr = sdm.attr_dev_handle(dev, <span class="hljs-string"><span class="hljs-string">"precision"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> ex = sdm.method_func(sdm.method_dev_handle(par, <span class="hljs-string"><span class="hljs-string">"exchange"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> modes = {[<span class="hljs-number"><span class="hljs-number">9</span></span>]=<span class="hljs-number"><span class="hljs-number">0x1f</span></span>, [<span class="hljs-number"><span class="hljs-number">10</span></span>]=<span class="hljs-number"><span class="hljs-number">0x3f</span></span>, [<span class="hljs-number"><span class="hljs-number">11</span></span>]=<span class="hljs-number"><span class="hljs-number">0x5f</span></span>, [<span class="hljs-number"><span class="hljs-number">12</span></span>]=<span class="hljs-number"><span class="hljs-number">0x7f</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> modes[precision] ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ex(par, dev, {<span class="hljs-number"><span class="hljs-number">0x4e</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, modes[precision]}) sdm.attr_set(attr, precision) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> )</code> </pre> <br><p> <a href=""><img src="https://habrastorage.org/webt/er/lj/gb/erljgbs9zby8767izkmsunyhdd8.png"></a> </p><br><h2 id="memory-usage">  Penggunaan memori </h2><br><p>  <em>Memori</em> bebas <em>ESP8266</em> sekitar <em>40k</em> .  Kode server dipindahkan ke <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://gitlab.com/matsievskiysv/nodemcu-">LFS</a> , sehingga tidak memerlukan ruang RAM saat inisialisasi ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://github.com/marcoskirsch/nodemcu-">kode asli</a> memakan waktu sekitar <em>10rb</em> ). </p><br><p>  <em>SDM</em> membutuhkan sekitar <em>10rb</em> untuk 5 driver perangkat dan 5 perangkat.  Sedikit lebih rendah untuk versi firmware non-mengambang.  Jadi lebih baik untuk memilih <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">driver manifes</a> hanya driver yang diperlukan untuk tugas yang dihadapi.  Tugas paling banyak memakan memori adalah untuk melayani perpustakaan <code>vue.js</code> </p><br><p> <a href=""><img src="https://habrastorage.org/webt/yy/u-/_i/yyu-_idkp2osapmg3-jy5z2r8ly.png"></a> </p><br><p>  Dalam hal meminta data mentah <em>JSON-</em> encoded (menggunakan <code>curl</code> ), konsumsi memori puncak dapat dikurangi secara signifikan. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/w_/hu/xx/w_huxxzt4w2wszdqq04bgbonbt0.png"></a> </p><br><h2 id="instead-of-an-epilogue">  Alih-alih sebuah epilog </h2><br><p>  Salah satu metode pertama yang saya terapkan dengan sdm adalah pengikatan untuk <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>node.restart()</code></a> . <br>  Mencoba menggunakan antarmuka pengguna web menghasilkan hasil yang aneh.  Tepat setelah browser web mengeluarkan permintaan, chip dimulai kembali seperti yang diharapkan.  Tetapi karena NodeMCU tidak menanggapi dengan baik permintaan HTTP, browser web mencoba lagi permintaan yang sama.  Ketika server NodeMCU dihidupkan ulang dan dinyalakan kembali, browser terhubung, reset internal <em>coba lagi</em> dan disebut metode <code>node.restart()</code> , sehingga memulai loop tak terbatas dari restart NodeMCU. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id449992/">https://habr.com/ru/post/id449992/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id449976/index.html">Wadah asosiatif multithreaded di C ++. Laporan Yandex</a></li>
<li><a href="../id449978/index.html">Igor Antarov dari Moscow Tesla Club melawan 20 mitos tentang Tesla dan mobil listrik</a></li>
<li><a href="../id449984/index.html">Google News dan Leo Tolstoy: memvisualisasikan Word2Vec embeddings menggunakan t-SNE</a></li>
<li><a href="../id449986/index.html">Blockchain: apa yang harus kita bangun kasing?</a></li>
<li><a href="../id449990/index.html">Bagaimana cara berteman lateks, formula dan Habr?</a></li>
<li><a href="../id449994/index.html">Delapan aturan emas Schneiderman akan membantu Anda membuat antarmuka yang lebih baik</a></li>
<li><a href="../id449996/index.html">Memahami Algoritma FFT</a></li>
<li><a href="../id449998/index.html">FAQ: apa yang perlu diketahui oleh seorang pelancong tentang vaksinasi sebelum bepergian</a></li>
<li><a href="../id450000/index.html">(Kanan ke kiri (Melalui Kaca Mencari</a></li>
<li><a href="../id450002/index.html">Menemukan Bug di LLVM 8 dengan PVS-Studio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>