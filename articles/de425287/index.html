<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üê° ü¶É üî£ FIAS-H√§user in PostgreSQL üïü üö£üèΩ üßëüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Der vorherige Artikel, in dem FIAS-Adressen und -Funktionen f√ºr die Arbeit mit ihnen in der PostgreSQL-Umgebung beschrieben wurden, erregte bei einem ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>FIAS-H√§user in PostgreSQL</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/425287/">  Der vorherige Artikel, in dem FIAS-Adressen und -Funktionen f√ºr die Arbeit mit ihnen in der PostgreSQL-Umgebung beschrieben wurden, erregte bei einem kleinen Teil der Leser Interesse. <br><br>  Daher ist es sinnvoll, √§hnliche Funktionen in PL / pgSQL zu beschreiben, um mit einer Liste von FIAS-H√§usern zu arbeiten, die in eine Datenbank geladen sind, in der PostgreSQL ausgef√ºhrt wird. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/94a/cb7/fbc/94acb7fbc32a4cf18fd15e854b62360c.png"></div><br>  Die erste H√§lfte des Artikels enth√§lt Kommentare zur Implementierung von Funktionen.  Im zweiten Schritt Quellcodes von Funktionen sowie Skripte zum Erstellen einer Tabelle mit FIAS-Hausdatens√§tzen sowie zum Laden von Daten aus einer CSV-Datei in diese Tabelle.  F√ºr diejenigen Leser, die nur an den Ausgangstexten interessiert sind, empfehlen wir, sofort mit dem Anhang fortzufahren. <br><a name="habracut"></a><br>  Dieser Artikel ist eng verwandt mit den Materialien der Artikelserie ‚ÄûFIAS-Adressen in der PostgreSQL-Umgebung‚Äú ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Anfang</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Fortsetzung 1</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Fortsetzung 2</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ende</a> ). <br><a name="tfHousesAOT_def"></a><h3>  Stammbaum zu Hause </h3><br><p>  Beginnen wir mit einem Beispiel. <br></p><p>  Das Aufrufen der f-Funktion <b>stf_Houses_AddressObjectTree</b> ('42301ab8-9ead-4f8e-8281-e64f2769a254') f√ºhrt zu der folgenden Liste von Eintr√§gen. </p><br>  <b>Tabelle 1. Das Ergebnis der Funktion.</b> <br><br><img src="https://habrastorage.org/webt/3n/2w/ir/3n2wirseekn4w0oz6kcnzhazl4o.png"><br><br><p>  Bei n√§herer Betrachtung stellen Sie m√∂glicherweise fest, dass die Elementkennung ( <b>HOUSEGUID</b> ) ‚Äûd.  1, Geb√§ude  2, S. 26 ‚Äùgingen sechs Aufzeichnungen ein: </p><br><ul><li>  drei √ºbergeordnete Datens√§tze mit adressbildenden Elementen: √ºber Region, Stadt und Stra√üe; </li><li>  drei Datens√§tze mit den Merkmalen der Hausnummer: Hausnummer, Geb√§udenummer und Geb√§udenummer. </li></ul><br><p>  Die Funktion verf√ºgt √ºber einen weiteren optionalen Parameter - das Ablaufdatum des Datensatzes ( <b>EndDate</b> ), mit dem Sie den Stammbaum nicht nur des aktuellen Datensatzes √ºber das Haus, sondern auch bereits veralteter Datens√§tze <b>anzeigen</b> k√∂nnen. <br><br>  Der vollst√§ndige Text der Funktion ist im Anhang im Abschnitt <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Erstellen der Funktion fstf_Houses_AddressObjectTree angegeben</a> . </p><br><h4>  Von Anfang an </h4><br><p>  Wenn Sie wissen, wie der FIAS-Haustisch angeordnet ist, kann dieser Abschnitt √ºbersprungen werden. <br>  FIAS-H√§user ( <b>HOUSES</b> ) sind eine <b>untergeordnete</b> Liste f√ºr die Liste der <b>adressgenerierenden</b> Elemente von FIAS ( <b>ADDROBJ</b> ).  Jeder <b>Hauslisteneintrag</b> bezieht sich durch den Wert des <b>Felds AOGUID</b> auf ein FIAS-Adress generierendes Element.  Um festzustellen, in welcher Stra√üe und an welchem ‚Äã‚ÄãOrt sich das Haus befindet, m√ºssen Sie den entsprechenden Datensatz mit derselben <b>Listenkennung ADDROBJ anhand des AOGUID-</b> Werts des <b>HOUSES-</b> Datensatzes finden. </p><br><p>  Trotz der √§u√üerlich einfachen Interaktion zwischen der Liste der H√§user und der Liste der <b>adressbildenden</b> Elemente in ihrer Interaktion erschweren Merkmale die Implementierung von Funktionen in <b>HOUSES</b> . </p><br><p>  Erstens bezieht sich jeder Datensatz der Liste der H√§user durch die Kennung <b>AOGUID</b> auf eine Gruppe von <b>adressbildenden</b> Elementen, von denen eines relevant ist. </p><br><p>  Zweitens gibt es mehrere Eintr√§ge in der FIAS-Liste mit denselben Hausnummernmerkmalen: Hausnummer, Geb√§udenummer, Geb√§udenummer. </p><br><p>  Drittens wird die Aufzeichnung des Hauses nicht immer von der Aufzeichnung der Stra√üe des Dorfes geerbt. </p><br>  Aber das Wichtigste zuerst. <br><p>  F√ºr weitere √úberlegungen zur Speicherung von Informationen √ºber H√§user im FIAS reicht es aus, uns auf 4 Tabellen (DBF-Dateien) zu beschr√§nken: </p><br><img src="https://habrastorage.org/webt/ba/zn/e3/bazne3xtr_fqhud7hgzdxzjgl-8.png"><br><br><ul><li>  <b>ADDROBJ</b> - Liste der <b>adressbildenden</b> Elemente; </li><li>  <b>H√ÑUSER</b> - Liste der H√§user; </li><li>  <b>STRSTAT</b> - ein Verzeichnis struktureller Merkmale; </li><li>  <b>ESTSTAT</b> - ein Verzeichnis der Eigentumszeichen. </li></ul><br><p>  ADDROBJ wurde in einer fr√ºheren Ver√∂ffentlichung, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">‚ÄûFIAS-Adressen in PostgreSQL‚Äú</a> , ausf√ºhrlich er√∂rtert <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">,</a> sodass seine Funktionen hier genau so ausf√ºhrlich behandelt werden, wie es zur Beschreibung der Eigenschaften von H√§usern erforderlich ist. </p><br>  <b>Tabelle 2. Geschichte des Hauses ‚ÄûKrasnojarsker Territorium, Bezirk Taimyr Dolgan-Nenetsky, Dudinka, Ul.</b>  <b>Dudinskaya, 1</b> <b><br></b> <br><br><img src="https://habrastorage.org/webt/5b/vu/8k/5bvu8k8v5lriarnghwlo7n5lmk8.png"><br><br><p>  Wie aus der Tabelle hervorgeht, haben Aufzeichnungen √ºber die Geschichte des Hauses im Gegensatz zu den adressbildenden Objekten keine besonderen Relevanzzeichen.  Der Datensatz mit dem √§ltesten Enddatum des Zeitraums, der gr√∂√üer als das aktuelle ist, ist relevant.  Bisher sind aktuelle Hausaufzeichnungen mit dem Datum 06.06.2079 gekennzeichnet.  Alle anderen Aufzeichnungen √ºber das Haus gelten als historisch, und das Start- und Enddatum kennzeichnen den Zeitraum der Relevanz jeder Aufzeichnung. </p><br><p>  Die FIAS-Hausliste enth√§lt keine Zeiger auf die vorherigen und n√§chsten Datens√§tze √ºber das Haus.  Daher wird die Reihenfolge der Aufzeichnungen von der tats√§chlichen Tiefe in die Geschichte des Hauses durch das abnehmende Enddatum und dar√ºber hinaus das Startdatum des Zeitraums bzw. <b>EndDate</b> und <b>StartDate bestimmt</b> . </p><br><br><pre><code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> fias_Houses h <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> h.HOUSEGUID=<span class="hljs-string"><span class="hljs-string">'2fd64ecd-4b4b-4fc8-bd15-4a4a2f310b21'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> h.ENDDATE <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>,h.STARTDATE <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>;</code> </pre> <br><p>  Aufmerksamer Leser mit Blick auf Abb.  1, ich habe mir wahrscheinlich die Frage gestellt: Warum werden Nachschlagewerke mit Zeichen von Struktur und Eigentum erw√§hnt?  FIAS verwendet √ºber 10 dieser Verzeichnisse. Warum werden diese beiden Verzeichnisse hervorgehoben? </p><br><p>  Die Antwort wird viele √ºberraschen - aus Sicht der ‚ÄûFIAS-Logik‚Äú wird die Adresse des Hauses nicht vollst√§ndig durch die Stra√üe, das Haus, das Geb√§ude und die Geb√§udenummern identifiziert.  Der Begriff ‚ÄûFIAS-Logik‚Äú wurde in der Antwort eines Mitarbeiters des Bundessteuerdienstes auf meine Frage verwendet, warum die Liste der H√§user im Krasnojarsker Territorium √ºber 250 gepaarte Adressen von H√§usern enth√§lt.  Dieselbe Antwort besagt, dass die Eindeutigkeit des Datensatzes durch die Werte AOGUID, HOUSENUM, BUILDNUM, STRUCNUM, STRSTATUS, ESTSTATUS bereitgestellt wird. </p><br><br><img src="https://habrastorage.org/webt/xi/13/1l/xi131l6giem5x7mcbj4f-vpxfli.png"><br><br><p>  Mit anderen Worten, um ein Objekt zu finden, reicht es nicht aus, den Ort, die Stra√üe und die Hausnummer zu kennen.  Sie m√ºssen auch wissen: </p><br><ul><li>  "Besitz" ist oder "Wohneigentum"; </li><li>  Der Status dieses Objekts ist definiert oder nicht definiert. </li><li>  usw. </li></ul><br><img src="https://habrastorage.org/webt/np/9i/6n/np9i6n0cehorqtwgf6fzwyqm4mu.png"><br><br><p>  So sieht ein Beispiel aus der allgemeinen Liste der FIAS-H√§user mit doppelten Adressen aus. <br>  Die Tatsache, dass verschiedene Objekte dieselbe Adresse haben, ist nicht √ºberraschend.  Das Geb√§ude und das Land darunter;  Haus, Garage, Badehaus f√ºr einen Besitzer.  Sie haben alle die gleiche Adresse.  FIAS ist jedoch ein Adressregister, d.h.  Liste der Adressen.  Daher ist es nat√ºrlich zu erwarten, dass Adressen darin eindeutig sind und nicht Geb√§ude, Strukturen, Strukturen. </p><br><p>  Das hei√üt,  Die Liste der FIAS-H√§user aus der Liste der Hausadressen begann sich in Richtung der Liste der Erdgeb√§ude zu entwickeln.  Und FIAS-Benutzer m√ºssen dies ber√ºcksichtigen. </p><br><p>  Jeder kann das Vorhandensein von H√§usern mit doppelten Adressen √ºberpr√ºfen, indem er eine SELECT-Anweisung √§hnlich der folgenden ausf√ºhrt.  Gleichzeitig kann die Funktion fsfn_Houses_TreeActualName nicht verwendet werden, weil  Es wird nur verwendet, um die Anzahl der Spalten im Ergebnis zu reduzieren.  Es ist nicht erforderlich, die Verzeichnisse fias_StructureStatus (analog zu STRSTAT) und fias_EstateStatus (analog zu ESTSTAT) als zu verwenden  Die ausgepr√§gte Wirkung l√§sst sich auch an den Codes der Struktur- und Besitzzeichen nachvollziehen. </p><br><img src="https://habrastorage.org/webt/ch/d_/gr/chd_grqqzvzh7u_z058i-qxjkmk.png"><br><br><div class="spoiler">  <b class="spoiler_title">Operator-Quellcode</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> fsfn_Houses_TreeActualName(h.AOGUID,h.HOUSEGUID),h.HOUSEGUID,str.StructureStatusName,est.EstateStatusName <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> fias_Houses h <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> AOGUID,HOUSENUM,BUILDNUM,STRUCNUM,COUNT(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> fias_Houses h <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> EndDate =TO_TIMESTAMP(<span class="hljs-string"><span class="hljs-string">'2079-06-06 00:00:00'</span></span>,<span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> AOGUID,HOUSENUM,BUILDNUM,STRUCNUM <span class="hljs-keyword"><span class="hljs-keyword">HAVING</span></span> COUNT(*)&gt;<span class="hljs-number"><span class="hljs-number">1</span></span>) hg <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> h.AOGUID=hg.AOGUID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> h.HOUSENUM=hg.HOUSENUM <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> COALESCE(h.BUILDNUM,<span class="hljs-string"><span class="hljs-string">''</span></span>)=COALESCE(hg.BUILDNUM,<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> COALESCE(h.STRUCNUM,<span class="hljs-string"><span class="hljs-string">''</span></span>)=COALESCE(hg.STRUCNUM,<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">LEFT OUTER JOIN</span></span> fias_StructureStatus str <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> h.STRSTATUS=str.StructureStatusID <span class="hljs-keyword"><span class="hljs-keyword">LEFT OUTER JOIN</span></span> fias_EstateStatus est <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> h.ESTSTATUS=est.EstateStatusID <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> h.EndDate =TO_TIMESTAMP(<span class="hljs-string"><span class="hljs-string">'2079-06-06 00:00:00'</span></span>,<span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> h.AOGUID,h.HOUSENUM,h.BUILDNUM,h.STRUCNUM,h.STRSTATUS,h.ESTSTATUS;</code> </pre><br></div></div><br><p>  Und schlie√ülich ein weiteres Merkmal der FIAS-Home-Liste.  Jeder Hausdatensatz dieser Liste enth√§lt einen Link zu einem adressbildenden Element, dessen Liste eine Hierarchie solcher Elemente darstellt.  Auf jeder Hierarchieebene befinden sich adressbildende Elemente, die zu verschiedenen Typen geh√∂ren.  Das Wurzelelement ist also die Region (in unserem Fall das Gebiet Krasnojarsk), auf der n√§chsten Ebene ein autonomer Okrug, eine Region oder eine Stadt mit regionaler Unterordnung.  Usw.  (Einzelheiten finden Sie unter "FIAS-Adressen in PostgreSQL"). </p><br><p>  Formal k√∂nnen Sie mit einem Hausdatensatz auf jeder Ebene auf ein Element der Hierarchie verweisen.  Gl√ºcklicherweise gab es in den Daten des Krasnojarsker Territoriums keine H√§user, die sich auf einen Bezirk oder eine Region bezogen.  Trotzdem beziehen sich nicht alle H√§user auf die Stra√üe des Dorfes: </p><br><ul><li>  98% der FIAS-H√§user sind mit Stra√üen in besiedelten Gebieten verbunden; </li><li>  1,2% der H√§user - mit Stra√üen in Gartenvereinen; </li><li>  0,3% der H√§user sind Siedlungen; </li><li>  0,5% der H√§user mit anderen adressierbaren Elementen. </li></ul><br><img src="https://habrastorage.org/webt/mh/xq/3u/mhxq3ukmrzmjlboytqt2q4fsxno.png"><br>  <b>Abb.</b>  <b>2.</b> <br><br><h4>  Weitergabe von Hausadressen durch Eigent√ºmer (FIAS vs Karte) </h4><br><p>  Hier wird ein Problem beschrieben, das zu einer mehrdeutigen Interpretation des Stammbaums f√ºhrt.  (Igor Leonidovich Timoshchenkov, GIS-Spezialist, Aigeo LLC, Krasnojarsk, machte mich auf dieses Problem aufmerksam.) </p><br><p>  Das Obige zeigt, wie mehrere Datens√§tze zu Hause dieselbe Adresse enthalten.  Was kann durch den Wunsch der Steueraufsicht erkl√§rt werden, nicht nur Aufzeichnungen √ºber ein Privathaus, sondern auch √ºber die umliegenden Geb√§ude zu f√ºhren: eine Garage, eine Scheune usw.  Es gibt jedoch umgekehrte Beispiele, wenn mehrere Geb√§ude (fias_Houses) einem Geb√§ude (Haus) mit unterschiedlichen Nummern f√ºr dieses Haus entsprechen. </p><br><br><img src="https://habrastorage.org/webt/5-/u6/cs/5-u6csqwbyl14t6fwhnix-r3nue.png"><br><br><p>  Schauen Sie sich dieses Bild an.  Auf der linken Seite befindet sich ein Screenshot mit einer Karte des Dorfes, in dem sich die H√§user f√ºr zwei Eigent√ºmer befinden.  Dies sind gew√∂hnliche einst√∂ckige H√§user mit zwei Eing√§ngen.  Eine Familie lebt rechts und eine andere links.  Sie k√∂nnen sich immer noch als H√§user aus zwei Wohnungen vorstellen. </p><br><p>  Schauen Sie sich jetzt die Tabelle rechts an.  Darin entspricht fast jedes Haus mit zwei Eigent√ºmern 3 Eintr√§gen.  Das hei√üt,  Die FIAS-Haustabelle zeigt sowohl die Adresse des einzelnen Hauses (‚Äûgest. 1‚Äú) als auch die Adressen der Teile des Hauses (‚Äûgest. 1/1‚Äú, ‚Äûgest. 1/2‚Äú), die einem Eigent√ºmer geh√∂ren. </p><br><h4>  Wie funktioniert es? </h4><br><p>  Die Funktion <b>fstf_Houses_AddressObjectTree</b> hat zwei Versionen: mit vier oder mit zwei Parametern.  In der Version der Funktion mit zwei Parametern werden die <b>Hauskennung</b> ( <b>HouseGUID</b> ) und das Ablaufdatum der Aufzeichnung <b>(EndDate</b> ) √ºbergeben.  Eine Version mit vier Parametern ben√∂tigt zus√§tzlich eine Kennung f√ºr das Adressgenerierungselement ( <b>AOGUID</b> ) und den aktuellen Status ( <b>CurrStatus</b> ). </p><br><img src="https://habrastorage.org/webt/f9/9k/mv/f99kmvqqmijnjjs14z0vmakvrmq.png"><br><br><div class="spoiler">  <b class="spoiler_title">Operator-Quellcode</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> v_AOGUID,v_CurrStatus h.AOGUID,<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> &lt; <span class="hljs-keyword"><span class="hljs-keyword">ALL</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> iao.currstatus <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> fias_AddressObjects iao <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ao.aoguid = iao.aoguid) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> MAX(iao.currstatus) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> fias_AddressObjects iao <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ao.aoguid = iao.aoguid) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> fias_Houses h <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> fias_AddressObjects ao <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> h.AOGUID=ao.AOGUID <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> h.HOUSEGUID=a_HOUSEGUID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> h.ENDDATE= COALESCE(a_ENDDATE, TO_TIMESTAMP(<span class="hljs-string"><span class="hljs-string">'2079-06-06 00:00:00'</span></span>,<span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> h.ENDDATE <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>;</code> </pre><br></div></div><br><p>  Eine Funktion mit weniger Parametern berechnet die Werte der fehlenden Parameter und ruft eine Funktion mit einer gro√üen Anzahl von Parametern auf.  Dazu wird die Kennung des <b>adressbildenden</b> Elements einfach aus dem entsprechenden Feld der <b>Haustabelle</b> (f <b>ias_Houses</b> ) <b>abgerufen</b> .  Der Wert des aktuellen Status ( <b>CurrStatus</b> ) wird nach folgenden Regeln berechnet: </p><br><ul><li>  Wenn keiner der Verlaufsdatens√§tze des adressbildenden Elements 0 im Feld CurrStatus enth√§lt, wird der Variablen v_CurrStatus der maximale Feldwert f√ºr dieses adressbildende Element zugewiesen. </li><li>  Andernfalls wird dieser Variablen der Wert 0 zugewiesen. </li></ul><br><p>  Eine Funktion mit einer gro√üen Anzahl von Parametern ruft zuerst die Funktion <b>fstf_AddressObjects_AddressObjectTree auf</b> , die die √ºbergeordneten <b>adressbildenden</b> Elemente f√ºr das Haus zur√ºckgibt.  Weitere Informationen zur Funktion fstf_AddressObjects_AddressObjectTree finden Sie im Abschnitt <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Pedigree</a> des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Adressbildungselements des Dokuments FIAS Addresses in PostgreSQL</a> </p>  . <br><p>  Anschlie√üend werden die Eintr√§ge zu den adressbildenden Elementen durch Eintr√§ge zu den Nummern des Hauses, des Geb√§udes und der Struktur (siehe Tabelle 1) erg√§nzt, die f√ºr jedes nicht leere Feld zur Nummer des Hauses, des Geb√§udes und der Struktur erstellt werden. </p><br><p>  Damit alle Ausgabedatens√§tze dieselbe Struktur haben und nicht ohne einen gewissen Anteil an Foppiness, werden die Werte der Felder <b>Codeebene</b> ( <b>AOLevel</b> ), aktueller Status ( <b>CurrStatus</b> ) und Relevanzstatus ( <b>ActStatus</b> ) k√ºnstlich im Funktionsk√∂rper erstellt. </p><br><p>  Der Code f√ºr die Ebene des Hauses (Geb√§ude, Struktur) ist immer auf 8 festgelegt (siehe das Nachschlagewerk ‚ÄûEbenen adressierbarer Objekte‚Äú aus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">dem FIAS-Dokument</a> ‚Äû <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Informationen zur Zusammensetzung von Informationen‚Äú</a> ). </p><br><p>  Der Relevanzstatus wird auf <b>1</b> gesetzt, wenn das Ablaufdatum des Datensatzes ( <b>EndDate</b> ) <b>06.06.2079 ist</b> , andernfalls auf 0. </p><br><p>  <b>CurrStatus</b> - <b>Feldwerte</b> sind komplizierter.  Mit seinen Werten werden zwei Aufgaben gleichzeitig gel√∂st: Die Kennung jeder Version des Datensatzes √ºber das adressbildende Element wird gesetzt und das Vorzeichen f√ºr die Relevanz des Datensatzes zugewiesen.  Daher enth√§lt der letzte aktuelle Datensatz zu einem Element in diesem Feld den Wert <b>0</b> , und alle historischen Datens√§tze sind in der Reihenfolge ihres Auftretens nummeriert - "1" ist der fr√ºheste Datensatz, der zeitlich folgt - "2" usw.  Die Reihenfolge der Zuweisung von Werten zum Feld CurrStatus wird in der Ver√∂ffentlichung <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">FIAS-Adressen in PostgreSQL</a> ausf√ºhrlicher beschrieben. </p><br><img src="https://habrastorage.org/webt/8t/13/og/8t13ogvul4asrek6okocveb8frq.png"><br><br><div class="spoiler">  <b class="spoiler_title">Spoiler √úberschrift</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> h.AOGUID, h.HOUSEGUID, h.HOUSENUM, h.BUILDNUM, h.STRUCNUM, h.ENDDATE, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> COALESCE(h.ENDDATE, TO_TIMESTAMP(<span class="hljs-string"><span class="hljs-string">'2079-06-06 00:00:00'</span></span>,<span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span></span>)) =TO_TIMESTAMP(<span class="hljs-string"><span class="hljs-string">'2079-06-06 00:00:00'</span></span>,<span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> RANK() <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> h.AOGUID, h.HOUSEGUID <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> h.ENDDATE <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> HouseCurrStatus, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> COALESCE (h.ENDDATE, TO_TIMESTAMP(<span class="hljs-string"><span class="hljs-string">'2079-06-06 00:00:00'</span></span>,<span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span></span>)) =TO_TIMESTAMP(<span class="hljs-string"><span class="hljs-string">'2079-06-06 00:00:00'</span></span>,<span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> HouseActStatus <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> fias_Houses h <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> fias_AddressObjects ao <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> h.AOGUID=ao.AOGUID <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> h.AOGUID=a_AOGUID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> h.HOUSEGUID=a_HOUSEGUID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> h.ENDDATE= COALESCE(a_ENDDATE, TO_TIMESTAMP(<span class="hljs-string"><span class="hljs-string">'2079-06-06 00:00:00'</span></span>,<span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> h.ENDDATE <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>;</code> </pre><br></div></div><br><h3>  Volle Hausadresse </h3><br><p>  Die Hauptidee der Funktion <b>fsfn_Houses_TreeActualName</b> besteht darin, die in einer Zeile verbundene Hausnummer zusammen mit den Namen aller ihrer Vorfahren zur√ºckzugeben - <b>adressbildende</b> Elemente. </p><br><p>  Lassen Sie beispielsweise die Stammbaumfunktion (fstf_Houses_AddressObjectTree) die folgende Werteliste zur√ºckgeben. </p><br>  <b>Tabelle 4. Das Ergebnis der Funktion fstf_Houses_AddressObjectTree ('0c0d670f-097c-4e1d-bcac-9e9b22fb1b99')</b> <br><br><img src="https://habrastorage.org/webt/5s/iu/ks/5siuksa7hfbicjmqsdt-fiqu1z0.png"><br><br><p>  Dann sollte <b>fsfn_Houses_TreeActualName</b> ('0c0d670f-097c-4e1d-bcac-9e9b22fb1b99') zur√ºckkehren: ‚Äû <b>Mr. Krasnoyarsk, 34A St. Lazo, bld.</b>  <b>6, S. 17</b> ‚Äù. </p><br><p>  Die Funktion <b>fsfn_Houses_TreeActualName</b> kann als Aggregatfunktion <b>STRING_AGG</b> √ºber das Ergebnis einer Funktion vereinfacht werden, die zu Hause einen Stammbaum zur√ºckgibt. </p><br><p>  Die betreffende Funktion verf√ºgt √ºber einen weiteren optionalen Parameter - ein Array von Masken ( <b>a_MaskArray</b> ), mit denen Sie nicht alle Elementnamen, sondern nur die ben√∂tigten in das Ergebnis aufnehmen k√∂nnen. </p><br>  <b>Tabelle 5. Liste der Funktionsmasken.</b> <br><br><img src="https://habrastorage.org/webt/6e/dl/q5/6edlq5zop1sqnwemc1s2zmbmgme.png"><br><br><div class="spoiler">  <b class="spoiler_title">Textversion der Tabelle</b> <div class="spoiler_text"><table><tbody><tr><th>  Wert </th><th>  Hinweis </th></tr><tr><td>  {HS} </td><td>  Maske - Hausnummer </td></tr><tr><td>  {BY} </td><td>  Maske - Fallnummer </td></tr><tr><td>  {BG} </td><td>  Maske - Geb√§udenummer </td></tr><tr><td>  {ST} </td><td>  Maske - Stra√üe </td></tr><tr><td>  {ZC} </td><td>  Maske - Postleitzahl </td></tr><tr><td>  {DT} </td><td>  Maske - Stadtgebiet </td></tr><tr><td>  {LP} </td><td>  Maske - untergeordnete Stadt </td></tr><tr><td>  {LM} </td><td>  Maske - die Hauptsiedlung </td></tr><tr><td>  {TP} </td><td>  Maske - Region des Verbandsgegenstandes </td></tr><tr><td>  {TM} </td><td>  Maske - Thema des Bundes (Region) </td></tr><tr><td>  {CY} </td><td>  Maske - Land </td></tr></tbody></table><br></div></div><br>  Siehe auch den Abschnitt ‚Äû <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Vollst√§ndiger Name des adressbildenden Elements‚Äú der Publikation ‚ÄûFIAS-Adressen in PostgreSQL</a> ‚Äú. <br>  Der Funktionstext finden Sie im Anwendungsabschnitt ‚Äû <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Erstellen der Funktion fsfn_Houses_TreeActualName</a> ‚Äú. <br><br><h3>  FIAS Home Suche </h3><br><p>  Die Funktion <b>fstf_Houses_SearchByName</b> dient zum Durchsuchen der Adressen von FIAS-H√§usern anhand ihrer Nummern und der Namen <b>adressbildender</b> Elemente.  Dar√ºber hinaus kann die Suche nicht nur nach dem Namen und Typ des aktuellen Elements durchgef√ºhrt werden, sondern auch nach den Namen und Typen eines oder zweier seiner n√§chsten Vorfahren. </p><br><p>  Schauen wir uns einige Beispiele an.  Und zun√§chst finden wir alle H√§user mit der Nummer "220". </p><br>  <b>Tabelle 6. Ergebnis der Funktion fstf_Houses_SearchByName ('220')</b> <br><br><img src="https://habrastorage.org/webt/lk/82/od/lk82odn1sragk7w8oudjxihuqye.png"><br><br><p>  Im Gegensatz zur Funktion der Suche nach <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">adressbildenden</a> Elementen ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">fstf_AddressObjects_SearchByName</a> ) enth√§lt das Ergebnis dieser Funktion nicht den Effekt des "Schwimmens" durch die Ebenen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">adressbildender</a> Elemente.  Der erste Parameter der Funktion enth√§lt immer das Suchmuster f√ºr die Hausnummer, der zweite - die Geb√§udenummer, die dritte Geb√§udenummer. </p><br><p>  √Ñndern Sie nun die Anfrage.  Wir finden alle H√§user adressbildender Elemente, deren Nummer die Nummer ‚Äû1‚Äú enth√§lt, und das Wort ‚ÄûKrasnojarsk‚Äú erscheint in den Namen. </p><br>  <b>Tabelle 7. Das Ergebnis der Funktion fstf_Houses_SearchByName ('1', NULL, NULL, 'Krasnojarsk')</b> <br><br><img src="https://habrastorage.org/webt/bi/jm/as/bijmasrtluarib2trzq_f4m-jf8.png"><br><br><p>  Der Zweck der verbleibenden Parameter stimmt genau mit dem Zweck der Parameter der Suchfunktion der adressgenerierenden Elemente (fstf_AddressObjects_SearchByName) √ºberein. <br>  Der Text der Funktion ist im Anwendungsabschnitt ‚Äû <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Erstellen der Funktion fstf_Houses_SearchByName</a> ‚Äú angegeben. </p>  . <br><h4>  Wie funktioniert es? </h4><br><p>  Die Implementierung von <b>fstf_Houses_SearchByName √§hnelt</b> in vielerlei Hinsicht der Implementierung der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Suchfunktion f√ºr adressgenerierende Elemente (fstf_AddressObjects_SearchByName)</a> .  Der Hauptunterschied besteht darin, dass die Suche in zwei verwandten Tabellen durchgef√ºhrt wird, <b>fias_Houses</b> und <b>fias_AddressObjects</b> . </p><br><p>  Die Funktion hat 9 Argumente.  Die ersten drei sind die Hausnummern ( <b>a_HouseNum</b> ), das Geb√§ude <b>(a_BuildNum</b> ) und das Geb√§ude ( <b>a_StrucNum</b> ).  Die verbleibenden 6 ( <b>a_FormalName</b> , <b>a_ShortName</b> , <b>a_ParentFormalName</b> , <b>a_ParentShortName</b> , <b>a_GrandParentFormalName</b> , <b>a_GrandParentShortName</b> ) stimmen vollst√§ndig mit den Funktionsparametern √ºberein. <br><br>  Wenn Sie nur den Wert des Parameters ‚ÄûHausnummer‚Äú festlegen, gibt die Funktion alle Adressen in der Hausnummer zur√ºck, f√ºr die die angegebene Sequenz ein Symbol enth√§lt.  Wenn Sie NULL oder eine leere Zeichenfolge ("") als Hausnummer √ºbergeben, werden die Adressen aller H√§user zur√ºckgegeben, deren Adresselemente durch eine Reihe anderer Parameter angegeben werden. <br><br><img src="https://habrastorage.org/webt/bo/sh/ht/boshhtjrbef92owia3wp2j2_6sm.png"><br><br></p><h3>  Nachwort </h3><br><p>  Dieser Abschnitt enth√§lt Empfehlungen zum Laden der Liste der FIAS-H√§user in die Tabelle <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">fias_Houses</a></b> . </p><br><p>  Das Laden von Daten in eine Tabelle mit H√§usern erfolgt √§hnlich wie das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Laden von Daten in eine Tabelle mit adressbildenden Elementen</a> .  Nur die Quelldatei ist <b>HOUSE99.DBF</b> , nicht <b>ADDROB99.DBF</b> .  Hier ist <b>99</b> die Nummer der Region (Republik, Gebiet, Territorium).  F√ºr das Gebiet Krasnojarsk ist die Quelldatei beispielsweise die Datei <b>HOUSE24.DBF</b> . </p><br><p>  Zun√§chst wird das n√§chste Archiv mit dem Update von der Seite FIAS- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Updates</a> heruntergeladen.  Die Datei <b>HOUSE99.DBF</b> wird daraus extrahiert <b>.</b> </p><p>  . <br></p><p>  Anschlie√üend wird die Datei <b>HOUSE99.DBF</b> in das <b>CSV-</b> Format konvertiert und bereits konvertiert. Sie wird von der COPY-Anweisung in die tempor√§re Tabelle <b>fias_Houses_Temp geladen</b> . </p><br><p>  Und schlie√ülich werden die tempor√§ren Daten verwendet, um die Haupttabelle zu aktualisieren, d.h.  In fias_Houses nicht vorhandene werden hinzugef√ºgt und vorhandene ersetzt. <br>  Ein Beispiel f√ºr ein Skript zum Aktualisieren einer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Haustabelle finden Sie</a> im Abschnitt ‚Äû <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Herunterladen von FIAS-Hausaktualisierungen in die Tabelle fias_Houses</a> ‚Äú. </p><br><h3>  App </h3><br><a name="tfHousesAOT"></a><h3>  Erstellen der Funktion fstf_Houses_AddressObjectTree </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Kommentare zum Funktionsquellcode finden Sie hier</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Funktionscode</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fstf_Houses_AddressObjectTree(a_AOGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>), a_HOUSEGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>),a_CurrStatus <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>,a_ENDDATE <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span>); <span class="hljs-comment"><span class="hljs-comment">/******************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   (  )   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> <span class="hljs-comment"><span class="hljs-comment">/******************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> fstf_Houses_AddressObjectTree( a_AOGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>), <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> a_HOUSEGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>),<span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_CurrStatus <span class="hljs-type"><span class="hljs-type">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-comment"><span class="hljs-comment">/*    4: */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* 0 - , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* 1-50 - , ..  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* 51 -  */</span></span> a_ENDDATE <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'2079-06-06'</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (rtf_GUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>), rtf_CurrStatus <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>,rtf_ActStatus <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>, rtf_AOLevel <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>,rtf_ShortTypeName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>),rtf_AddressObjectName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $BODY$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c_HouseAOLevel <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>:=<span class="hljs-number"><span class="hljs-number">8</span></span>; c_HouseShortTypeName <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>):=<span class="hljs-string"><span class="hljs-string">'.'</span></span>; c_BuildShortTypeName <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>):=<span class="hljs-string"><span class="hljs-string">'.'</span></span>; c_StructShortTypeName <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>):=<span class="hljs-string"><span class="hljs-string">'.'</span></span>; c_StatusActual <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>:=<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> c_StatusNotActual <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>:=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> c_MAXENDDATE <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span>:=to_timestamp(<span class="hljs-string"><span class="hljs-string">'2079-06-06 00:00:00'</span></span>, <span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD'</span></span>); v_HouseActStatus <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_HouseCurrStatus <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_ENDDATE <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_HOUSEGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_HOUSENUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_BUILDNUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_STRUCNUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_Return_Error <span class="hljs-type"><span class="hljs-type">Integer</span></span> :=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">--************************************************************ --************************************************************ BEGIN RETURN QUERY SELECT * FROM fstf_AddressObjects_AddressObjectTree (a_AOGUID,a_CurrStatus); IF a_ENDDATE IS NULL THEN SELECT INTO v_ENDDATE MAX(ENDDATE) FROM fias_Houses WHERE AOGUID=a_AOGUID AND HOUSEGUID=a_HOUSEGUID; ELSE v_ENDDATE:=a_ENDDATE; END IF; SELECT INTO v_HOUSENUM,v_BUILDNUM,v_STRUCNUM, v_ENDDATE,v_HouseCurrStatus h.HOUSENUM,h.BUILDNUM,h.STRUCNUM, h.ENDDATE,ah.HouseCurrStatus FROM fias_Houses h INNER JOIN (SELECT AOGUID,HOUSEGUID,ENDDATE, RANK() OVER (PARTITION BY AOGUID, HOUSEGUID ORDER BY ENDDATE ASC) AS HouseCurrStatus FROM fias_Houses insh WHERE insh.AOGUID=a_AOGUID AND insh.HOUSEGUID=a_HOUSEGUID) as ah ON h.AOGUID=ah.AOGUID AND h.HOUSEGUID=ah.HOUSEGUID AND h.ENDDATE=ah.ENDDATE WHERE h.ENDDATE=v_ENDDATE; v_HouseActStatus:=CASE WHEN COALESCE(v_ENDDATE,c_MAXENDDATE)= c_MAXENDDATE THEN c_StatusActual ELSE c_StatusNotActual END; v_HouseCurrStatus:=CASE WHEN COALESCE(v_ENDDATE,c_MAXENDDATE)= c_MAXENDDATE THEN 0 ELSE v_HouseCurrStatus END; IF v_HOUSENUM IS NOT NULL THEN RETURN QUERY SELECT a_HOUSEGUID,v_HouseCurrStatus,v_HouseActStatus, c_HouseAOLevel,c_HouseShortTypeName,v_HOUSENUM; END IF; IF v_BUILDNUM IS NOT NULL THEN RETURN QUERY SELECT a_HOUSEGUID,v_HouseCurrStatus,v_HouseActStatus, c_HouseAOLevel,c_BuildShortTypeName,v_BUILDNUM; END IF; IF v_STRUCNUM IS NOT NULL THEN RETURN QUERY SELECT a_HOUSEGUID,v_HouseCurrStatus,v_HouseActStatus, c_HouseAOLevel,c_StructShortTypeName,v_STRUCNUM; END IF; END; $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION fstf_Houses_AddressObjectTree(a_AOGUID VARCHAR(36), a_HOUSEGUID VARCHAR(36),a_CurrStatus INTEGER,a_ENDDATE TIMESTAMP) IS '  (  )       '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; BEGIN TRANSACTION; DROP FUNCTION IF EXISTS fstf_Houses_AddressObjectTree(a_HOUSEGUID VARCHAR(36),a_ENDDATE TIMESTAMP); /******************************************************************/ /*   (  )   */ /*      */ /******************************************************************/ CREATE OR REPLACE FUNCTION fstf_Houses_AddressObjectTree( a_HOUSEGUID VARCHAR(36),/*     */ a_ENDDATE TIMESTAMP default '2079-06-06'/*     */ ) RETURNS TABLE (rtf_GUID VARCHAR(36), rtf_CurrStatus INTEGER,rtf_ActStatus INTEGER, rtf_AOLevel INTEGER,rtf_ShortTypeName VARCHAR(10),rtf_AddressObjectName VARCHAR(100)) AS $BODY$ DECLARE c_MaxEndDate CONSTANT TIMESTAMP:=TO_TIMESTAMP('2079-06-06','YYYY-MM-DD'); c_ActualStatusCode CONSTANT INTEGER :=1; /*      */ c_NotActualStatusCode CONSTANT INTEGER :=0; /*     */ v_AOGUID VARCHAR(36); /*   */ /*   */ v_CurrStatus INTEGER; /*    4: */ /* 0 - , */ /* 1-50 - , */ /* ..   , */ /*     */ /*     , */ /* 51 - */ v_Return_Error Integer :=0; /*   */ --******************************************************************* --******************************************************************* BEGIN SELECT INTO v_AOGUID,v_CurrStatus h.AOGUID, CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE ao.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE ao.aoguid = iao.aoguid) ELSE 0 END FROM fias_Houses h INNER JOIN fias_AddressObjects ao ON h.AOGUID=ao.AOGUID WHERE h.HOUSEGUID=a_HOUSEGUID AND h.ENDDATE=COALESCE(a_ENDDATE,c_MaxEndDate) ORDER BY h.ENDDATE DESC; RETURN QUERY SELECT * FROM fstf_Houses_AddressObjectTree( v_AOGUID,a_HOUSEGUID, v_CurrStatus,a_ENDDATE); END; $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION fstf_Houses_AddressObjectTree(a_HOUSEGUID VARCHAR(36),a_ENDDATE TIMESTAMP) IS '  (  )       '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECT * FROM fstf_Houses_AddressObjectTree('8b40b028-68eb-4315-a256-ea300c604688','42301ab8-9ead-4f8e-8281-e64f2769a254') ORDER BY rtf_AOLevel; SELECT * FROM fstf_Houses_AddressObjectTree('42301ab8-9ead-4f8e-8281-e64f2769a254') ORDER BY rtf_AOLevel;</span></span></code> </pre><br></div></div><br><a name="fnHousesTAN"></a><br><h3>  Erstellen der Funktion fsfn_Houses_TreeActualName </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Kommentare zum Funktionsquellcode finden Sie hier</a> . <br><div class="spoiler">  <b class="spoiler_title">Funktionscode</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fsfn_Houses_TreeActualName(a_AOGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>),a_HOUSEGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>),a_MaskArray <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)[<span class="hljs-number"><span class="hljs-number">10</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">CASCADE</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*****************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*           */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*****************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> fsfn_Houses_TreeActualName( a_AOGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>), <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> a_HOUSEGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>), <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_MaskArray <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)[<span class="hljs-number"><span class="hljs-number">10</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'{TP,LM,LP,ST,HS,BY,BG}'</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  ,   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $BODY$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c_HouseMaskArray <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)[<span class="hljs-number"><span class="hljs-number">3</span></span>]:=<span class="hljs-string"><span class="hljs-string">'{HS,BY,BG}'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> c_HouseNoMask <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>] :=<span class="hljs-string"><span class="hljs-string">'{HS}'</span></span>; c_BodyNoMask <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>] :=<span class="hljs-string"><span class="hljs-string">'{BY}'</span></span>;<span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> c_BuildingNoMask <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>] :=<span class="hljs-string"><span class="hljs-string">'{BG}'</span></span>;<span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> c_HouseShortTypeName <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>):=<span class="hljs-string"><span class="hljs-string">'.'</span></span>; c_BuildShortTypeName <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>):=<span class="hljs-string"><span class="hljs-string">'.'</span></span>; c_StructShortTypeName <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>):=<span class="hljs-string"><span class="hljs-string">'.'</span></span>; v_ENDDATE <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_HOUSENUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_BUILDNUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_STRUCNUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_TreeAddressObjectName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_Return_Error <span class="hljs-type"><span class="hljs-type">Integer</span></span> :=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">--******************************************************* --******************************************************* BEGIN v_TreeAddressObjectName:=fsfn_AddressObjects_TreeActualName (a_AOGUID,a_MaskArray); SELECT INTO v_ENDDATE MAX(ENDDATE) FROM fias_Houses WHERE AOGUID=a_AOGUID AND HOUSEGUID=a_HOUSEGUID; SELECT INTO v_HOUSENUM,v_BUILDNUM,v_STRUCNUM HOUSENUM, BUILDNUM,STRUCNUM FROM fias_Houses WHERE AOGUID=a_AOGUID AND HOUSEGUID=a_HOUSEGUID AND ENDDATE=v_ENDDATE; IF c_HouseNoMask &lt;@ a_MaskArray AND COALESCE(TRIM(v_HOUSENUM),'')&lt;&gt;'' THEN v_TreeAddressObjectName:=v_TreeAddressObjectName|| CASE WHEN v_TreeAddressObjectName='' THEN '' ELSE ', ' ||c_HouseShortTypeName||' '||v_HOUSENUM END; END IF; IF c_BodyNoMask &lt;@ a_MaskArray AND COALESCE(TRIM(v_BUILDNUM),'')&lt;&gt;'' THEN v_TreeAddressObjectName:=v_TreeAddressObjectName|| CASE WHEN v_TreeAddressObjectName='' THEN '' ELSE ', ' || c_BuildShortTypeName||' '||v_BUILDNUM END; END IF; IF c_BuildingNoMask &lt;@ a_MaskArray AND COALESCE(TRIM(v_STRUCNUM),'')&lt;&gt;'' THEN v_TreeAddressObjectName:=v_TreeAddressObjectName|| CASE WHEN v_TreeAddressObjectName='' THEN '' ELSE ', ' || c_StructShortTypeName||' '||v_STRUCNUM END; END IF; RETURN v_TreeAddressObjectName; END; $BODY$ LANGUAGE plpgsql ; COMMENT ON FUNCTION fsfn_Houses_TreeActualName(a_AOGUID VARCHAR(36),a_HOUSEGUID VARCHAR(36),a_MaskArray VARCHAR(2)[10]) IS '         '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; BEGIN TRANSACTION; DROP FUNCTION IF EXISTS fsfn_Houses_TreeActualName(a_HOUSEGUID VARCHAR(36),a_MaskArray VARCHAR(2)[10]) CASCADE; /*****************************************************************/ /*           */ /*****************************************************************/ CREATE OR REPLACE FUNCTION fsfn_Houses_TreeActualName( a_HOUSEGUID VARCHAR(36), /*     */ a_MaskArray VARCHAR(2)[10] default '{TP,LM,LP,ST,HS,BY,BG}' /*  ,   */ /*    */ ) RETURNS VARCHAR(1000) AS $BODY$ DECLARE c_MaxEndDate CONSTANT TIMESTAMP:=TO_TIMESTAMP('2079-06-06','YYYY-MM-DD'); v_AOGUID VARCHAR(36); /*    */ v_TreeAddressObjectName VARCHAR(1000); /*     */ v_Return_Error Integer :=0; /*   */ --********************************************************** --********************************************************** BEGIN SELECT INTO v_AOGUID h.AOGUID FROM fias_Houses h INNER JOIN fias_AddressObjects ao ON h.AOGUID=ao.AOGUID WHERE h.HOUSEGUID=a_HOUSEGUID AND h.ENDDATE=c_MaxEndDate ORDER BY h.ENDDATE DESC; v_TreeAddressObjectName:=fsfn_Houses_TreeActualName (v_AOGUID,a_HOUSEGUID,a_MaskArray); RETURN v_TreeAddressObjectName; END; $BODY$ LANGUAGE plpgsql ; COMMENT ON FUNCTION fsfn_Houses_TreeActualName(a_HOUSEGUID VARCHAR(36),a_MaskArray VARCHAR(2)[10]) IS '         '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECT fsfn_Houses_TreeActualName('8b40b028-68eb-4315-a256-ea300c604688','42301ab8-9ead-4f8e-8281-e64f2769a254'); SELECT fsfn_Houses_TreeActualName('42301ab8-9ead-4f8e-8281-e64f2769a254');</span></span></code> </pre><br></div></div><br><a name="tfHousesSBN"></a><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Erstellen der Funktion fstf_Houses_SearchByName </font></font></h3><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kommentare zum Funktionsquellcode finden Sie hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Funktionscode</font></font></b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fstf_Houses_SearchByName(a_HouseNum <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>),a_BuildNum <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>),a_StrucNum <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>),a_FormalName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>),a_ShortName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>),a_ParentFormalName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>),a_ParentShortName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>), a_GrandParentFormalName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>),a_GrandParentShortName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>)); <span class="hljs-comment"><span class="hljs-comment">/*****************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*        */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*****************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> fstf_Houses_SearchByName( a_HouseNum <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>), <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> a_BuildNum <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>,<span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> a_StrucNum <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> a_FormalName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_ShortName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_ParentFormalName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_ParentShortName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_GrandParentFormalName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_GrandParentShortName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (rtf_AOGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>),rtf_HOUSEGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>),rtf_AOLevel <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>,rtf_HousesFullName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1000</span></span>),rtf_HouseNum <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>),rtf_BuildNum <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>),rtf_StrucNum <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>),rtf_EndDate <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span>,rtf_ShortName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>),rtf_FormalName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>), rtf_CurrStatus <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>,rtf_ActStatus <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>, rtf_ParentShortName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>),rtf_ParentFormalName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>),rtf_GrandParentShortName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>),rtf_GrandParentFormalName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $BODY$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c_WildChar <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)=<span class="hljs-string"><span class="hljs-string">'%'</span></span>; c_BlankChar <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)=<span class="hljs-string"><span class="hljs-string">' '</span></span>; v_HouseNumTemplate <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_BuildNumTemplate <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_StrucNumTemplate <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_FormalNameTemplate <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_ShortNameTemplate <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_ParentFormalNameTemplate <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_ParentShortNameTemplate <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_GrandParentFormalNameTemplate <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_GrandParentShortNameTemplate <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-comment"><span class="hljs-comment">--*************************************************************** --*************************************************************** BEGIN v_ShortNameTemplate:=UPPER(COALESCE(c_WildChar ||REPLACE(TRIM(a_ShortName),c_BlankChar,c_WildChar) ||c_WildChar,c_WildChar)); v_FormalNameTemplate:=UPPER(COALESCE(c_WildChar ||REPLACE(TRIM(a_FormalName),c_BlankChar,c_WildChar) ||c_WildChar,c_WildChar)); v_HouseNumTemplate:= CASE WHEN TRIM(COALESCE(a_HouseNum,''))='' THEN '' ELSE LOWER(c_WildChar ||REPLACE(TRIM(a_HouseNum),c_BlankChar,c_WildChar)) END ||CASE WHEN TRIM(COALESCE(a_BuildNum,''))='' THEN '' ELSE LOWER(c_WildChar ||REPLACE(TRIM(a_BuildNum),c_BlankChar,c_WildChar)) END || CASE WHEN TRIM(COALESCE(a_StrucNum,''))='' THEN '' ELSE LOWER(c_WildChar ||REPLACE(TRIM(a_StrucNum),c_BlankChar,c_WildChar)) END; v_HouseNumTemplate:=v_HouseNumTemplate||c_WildChar; v_HouseNumTemplate:=CASE WHEN TRIM(COALESCE(a_HouseNum,''))='' THEN '' ELSE LOWER(c_WildChar ||REPLACE(TRIM(a_HouseNum),c_BlankChar,c_WildChar)) END ||c_WildChar; v_BuildNumTemplate:=CASE WHEN TRIM(COALESCE(a_BuildNum,''))='' THEN '' ELSE LOWER(c_WildChar ||REPLACE(TRIM(a_BuildNum),c_BlankChar,c_WildChar)) END ||c_WildChar; v_StrucNumTemplate:=CASE WHEN TRIM(COALESCE(a_StrucNum,''))='' THEN '' ELSE LOWER(c_WildChar ||REPLACE(TRIM(a_StrucNum),c_BlankChar,c_WildChar)) END||c_WildChar; IF a_FormalName IS NOT NULL AND a_ParentFormalName IS NULL AND a_ParentShortName IS NULL AND a_GrandParentFormalName IS NULL AND a_GrandParentShortName IS NULL THEN IF a_HouseNum IS NOT NULL OR a_BuildNum IS NOT NULL OR a_StrucNum IS NOT NULL THEN RETURN QUERY SELECT cfa.AOGUID,h.HouseGUID,cfa.AOLevel, fsfn_Houses_TreeActualName(h.AOGUID,h.HouseGUID), h.HouseNum,h.BuildNum,h.StrucNum, h.EndDate,cfa.ShortName,cfa.FORMALNAME, cfa.currstatus,cfa.Actstatus, NULL::VARCHAR,NULL::VARCHAR,NULL::VARCHAR,NULL::VARCHAR FROM fias_AddressObjects cfa INNER JOIN fias_Houses h ON cfa.aoguid = h.aoguid WHERE cfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) ELSE 0 END AND h.EndDate=(SELECT MAX(ih.EndDate) FROM fias_Houses ih WHERE cfa.aoguid = ih.aoguid AND h.HouseGUID = ih.HouseGUID) AND UPPER(cfa.FORMALNAME) LIKE v_FormalNameTemplate AND UPPER(cfa.ShortName) LIKE v_ShortNameTemplate AND TRIM(LOWER(COALESCE(h.HouseNum,''))) LIKE v_HouseNumTemplate AND TRIM(LOWER(COALESCE(h.BuildNum,''))) LIKE v_BuildNumTemplate AND TRIM(LOWER(COALESCE(h.StrucNum,''))) LIKE v_StrucNumTemplate ORDER BY cfa.AOLevel,cfa.ShortName,cfa.FORMALNAME, TO_NUMBER(SUBSTRING(h.HouseNum,E'\\d+'),'9999'),h.HouseNum, TO_NUMBER(SUBSTRING(h.BuildNum,E'\\d+'),'9999'),h.BuildNum, TO_NUMBER(SUBSTRING(h.StrucNum,E'\\d+'),'9999'),h.StrucNum; ELSE RETURN QUERY SELECT cfa.AOGUID,h.HouseGUID,cfa.AOLevel, fsfn_Houses_TreeActualName(h.AOGUID,h.HouseGUID), h.HouseNum,h.BuildNum,h.StrucNum,h.EndDate, cfa.ShortName,cfa.FORMALNAME,cfa.currstatus,cfa.Actstatus, NULL::VARCHAR,NULL::VARCHAR,NULL::VARCHAR,NULL::VARCHAR FROM fias_AddressObjects cfa INNER JOIN fias_Houses h ON cfa.aoguid = h.aoguid WHERE cfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) ELSE 0 END AND h.EndDate=(SELECT MAX(ih.EndDate) FROM fias_Houses ih WHERE cfa.aoguid = ih.aoguid AND h.HouseGUID = ih.HouseGUID) AND UPPER(cfa.FORMALNAME) LIKE v_FormalNameTemplate AND UPPER(cfa.ShortName) LIKE v_ShortNameTemplate ORDER BY cfa.AOLevel,cfa.ShortName,cfa.FORMALNAME, TO_NUMBER(SUBSTRING(h.HouseNum,E'\\d+'),'9999'),h.HouseNum, TO_NUMBER(SUBSTRING(h.BuildNum,E'\\d+'),'9999'),h.BuildNum, TO_NUMBER(SUBSTRING(h.StrucNum,E'\\d+'),'9999'),h.StrucNum; END IF; ELSIF a_FormalName IS NOT NULL AND a_ParentFormalName IS NOT NULL AND a_GrandParentFormalName IS NULL AND a_GrandParentShortName IS NULL THEN v_ParentShortNameTemplate:=UPPER(COALESCE(c_WildChar ||REPLACE(TRIM(a_ParentShortName),c_BlankChar,c_WildChar) ||c_WildChar,c_WildChar)); v_ParentFormalNameTemplate:=UPPER(c_WildChar ||REPLACE(TRIM(a_ParentFormalName),c_BlankChar,c_WildChar) ||c_WildChar); v_FormalNameTemplate:=COALESCE(v_FormalNameTemplate,c_WildChar); IF a_HouseNum IS NOT NULL OR a_BuildNum IS NOT NULL OR a_StrucNum IS NOT NULL THEN RETURN QUERY SELECT cfa.AOGUID,h.HouseGUID,cfa.AOLevel, fsfn_Houses_TreeActualName(h.AOGUID,h.HouseGUID), h.HouseNum,h.BuildNum,h.StrucNum,h.EndDate, cfa.ShortName,cfa.FORMALNAME,cfa.currstatus, cfa.Actstatus,pfa.ShortName,pfa.FORMALNAME, NULL::VARCHAR,NULL::VARCHAR FROM fias_AddressObjects pfa INNER JOIN fias_AddressObjects cfa ON pfa.AOGUID=cfa.ParentGUID INNER JOIN fias_Houses h ON cfa.aoguid = h.aoguid WHERE cfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) ELSE 0 END AND h.EndDate=(SELECT MAX(ih.EndDate) FROM fias_Houses ih WHERE cfa.aoguid = ih.aoguid AND h.HouseGUID = ih.HouseGUID) AND pfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE pfa.aoguid = iao.aoguid) ELSE 0 END AND UPPER(pfa.FORMALNAME) LIKE v_ParentFormalNameTemplate AND UPPER(pfa.ShortName) LIKE v_ParentShortNameTemplate AND UPPER(cfa.FORMALNAME) LIKE v_FormalNameTemplate AND UPPER(cfa.ShortName) LIKE v_ShortNameTemplate AND TRIM(LOWER(COALESCE(h.HouseNum,''))) LIKE v_HouseNumTemplate AND TRIM(LOWER(COALESCE(h.BuildNum,''))) LIKE v_BuildNumTemplate AND TRIM(LOWER(COALESCE(h.StrucNum,''))) LIKE v_StrucNumTemplate ORDER BY pfa.ShortName,pfa.FORMALNAME,cfa.AOLevel, cfa.ShortName,cfa.FORMALNAME, TO_NUMBER(SUBSTRING(h.HouseNum,E'\\d+'),'9999'), h.HouseNum,TO_NUMBER(SUBSTRING(h.BuildNum,E'\\d+'),'9999'), h.BuildNum,TO_NUMBER(SUBSTRING(h.StrucNum,E'\\d+'),'9999'), h.StrucNum; ELSE RETURN QUERY SELECT cfa.AOGUID,h.HouseGUID,cfa.AOLevel, fsfn_Houses_TreeActualName(h.AOGUID,h.HouseGUID), h.HouseNum,h.BuildNum,h.StrucNum, h.EndDate,cfa.ShortName,cfa.FORMALNAME, cfa.currstatus,cfa.Actstatus,pfa.ShortName, pfa.FORMALNAME,NULL::VARCHAR,NULL::VARCHAR FROM fias_AddressObjects pfa INNER JOIN fias_AddressObjects cfa ON pfa.AOGUID=cfa.ParentGUID INNER JOIN fias_Houses h ON cfa.aoguid = h.aoguid WHERE cfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) ELSE 0 END AND h.EndDate=(SELECT MAX(ih.EndDate) FROM fias_Houses ih WHERE cfa.aoguid = ih.aoguid AND h.HouseGUID = ih.HouseGUID) AND pfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE pfa.aoguid = iao.aoguid) ELSE 0 END AND UPPER(pfa.FORMALNAME) LIKE v_ParentFormalNameTemplate AND UPPER(pfa.ShortName) LIKE v_ParentShortNameTemplate AND UPPER(cfa.FORMALNAME) LIKE v_FormalNameTemplate AND UPPER(cfa.ShortName) LIKE v_ShortNameTemplate ORDER BY pfa.ShortName,pfa.FORMALNAME,cfa.AOLevel, cfa.ShortName,cfa.FORMALNAME, TO_NUMBER(SUBSTRING(h.HouseNum,E'\\d+'),'9999'), h.HouseNum, TO_NUMBER(SUBSTRING(h.BuildNum,E'\\d+'),'9999'), h.BuildNum, TO_NUMBER(SUBSTRING(h.StrucNum,E'\\d+'),'9999'),h.StrucNum; END IF; ELSE v_GrandParentShortNameTemplate:=COALESCE(UPPER( COALESCE(c_WildChar ||REPLACE(TRIM(a_GrandParentShortName),c_BlankChar,c_WildChar) ||c_WildChar,c_WildChar)),c_WildChar); v_GrandParentFormalNameTemplate:=COALESCE(UPPER( c_WildChar ||REPLACE(TRIM(a_GrandParentFormalName),c_BlankChar,c_WildChar) ||c_WildChar),c_WildChar); v_ParentShortNameTemplate:=COALESCE(UPPER( COALESCE(c_WildChar ||REPLACE(TRIM(a_ParentShortName),c_BlankChar,c_WildChar) ||c_WildChar,c_WildChar)),c_WildChar); v_ParentFormalNameTemplate:=COALESCE(UPPER( c_WildChar||REPLACE(TRIM(a_ParentFormalName),c_BlankChar,c_WildChar) ||c_WildChar),c_WildChar); v_FormalNameTemplate:=COALESCE(v_FormalNameTemplate,c_WildChar); IF a_HouseNum IS NOT NULL OR a_BuildNum IS NOT NULL OR a_StrucNum IS NOT NULL THEN RETURN QUERY SELECT cfa.AOGUID,h.HouseGUID,cfa.AOLevel, fsfn_Houses_TreeActualName(h.AOGUID,h.HouseGUID), h.HouseNum,h.BuildNum,h.StrucNum, h.EndDate,cfa.ShortName,cfa.FORMALNAME, cfa.currstatus,cfa.Actstatus,pfa.ShortName, pfa.FORMALNAME,gpfa.ShortName,gpfa.FORMALNAME FROM fias_AddressObjects gpfa INNER JOIN fias_AddressObjects pfa ON gpfa.AOGUID=pfa.ParentGUID INNER JOIN fias_AddressObjects cfa ON pfa.AOGUID=cfa.ParentGUID INNER JOIN fias_Houses h ON cfa.aoguid = h.aoguid WHERE cfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) ELSE 0 END AND pfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE pfa.aoguid = iao.aoguid) ELSE 0 END AND gpfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE gpfa.aoguid = iao.aoguid) ELSE 0 END AND h.EndDate=(SELECT MAX(ih.EndDate) FROM fias_Houses ih WHERE cfa.aoguid = ih.aoguid AND h.HouseGUID = ih.HouseGUID) AND UPPER(gpfa.FORMALNAME) LIKE v_GrandParentFormalNameTemplate AND UPPER(gpfa.ShortName) LIKE v_GrandParentShortNameTemplate AND UPPER(pfa.FORMALNAME) LIKE v_ParentFormalNameTemplate AND UPPER(pfa.ShortName) LIKE v_ParentShortNameTemplate AND UPPER(cfa.FORMALNAME) LIKE v_FormalNameTemplate AND UPPER(cfa.ShortName) LIKE v_ShortNameTemplate AND TRIM(LOWER(COALESCE(h.HouseNum,''))) LIKE v_HouseNumTemplate AND TRIM(LOWER(COALESCE(h.BuildNum,''))) LIKE v_BuildNumTemplate AND TRIM(LOWER(COALESCE(h.StrucNum,''))) LIKE v_StrucNumTemplate ORDER BY gpfa.ShortName,gpfa.FORMALNAME,pfa.ShortName, pfa.FORMALNAME,cfa.AOLevel,cfa.ShortName, cfa.FORMALNAME, TO_NUMBER(SUBSTRING(h.HouseNum,E'\\d+'),'9999'), h.HouseNum, TO_NUMBER(SUBSTRING(h.BuildNum,E'\\d+'),'9999'), h.BuildNum, TO_NUMBER(SUBSTRING(h.StrucNum,E'\\d+'),'9999'),h.StrucNum; ELSE RETURN QUERY SELECT cfa.AOGUID,h.HouseGUID,cfa.AOLevel, fsfn_Houses_TreeActualName(h.AOGUID,h.HouseGUID), h.HouseNum,h.BuildNum,h.StrucNum, h.EndDate,cfa.ShortName,cfa.FORMALNAME, cfa.currstatus,cfa.Actstatus,pfa.ShortName, pfa.FORMALNAME,gpfa.ShortName,gpfa.FORMALNAME FROM fias_AddressObjects gpfa INNER JOIN fias_AddressObjects pfa ON gpfa.AOGUID=pfa.ParentGUID INNER JOIN fias_AddressObjects cfa ON pfa.AOGUID=cfa.ParentGUID INNER JOIN fias_Houses h ON cfa.aoguid = h.aoguid WHERE cfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) ELSE 0 END AND pfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE pfa.aoguid = iao.aoguid) ELSE 0 END AND gpfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE gpfa.aoguid = iao.aoguid) ELSE 0 END AND h.EndDate=(SELECT MAX(ih.EndDate) FROM fias_Houses ih WHERE cfa.aoguid = ih.aoguid AND h.HouseGUID = ih.HouseGUID) AND UPPER(gpfa.FORMALNAME) LIKE v_GrandParentFormalNameTemplate AND UPPER(gpfa.ShortName) LIKE v_GrandParentShortNameTemplate AND UPPER(pfa.FORMALNAME) LIKE v_ParentFormalNameTemplate AND UPPER(pfa.ShortName) LIKE v_ParentShortNameTemplate AND UPPER(cfa.FORMALNAME) LIKE v_FormalNameTemplate AND UPPER(cfa.ShortName) LIKE v_ShortNameTemplate ORDER BY gpfa.ShortName,gpfa.FORMALNAME,pfa.ShortName, pfa.FORMALNAME,cfa.AOLevel,cfa.ShortName, cfa.FORMALNAME, TO_NUMBER(SUBSTRING(h.HouseNum,E'\\d+'),'9999'), h.HouseNum, TO_NUMBER(SUBSTRING(h.BuildNum,E'\\d+'),'9999'), h.BuildNum, TO_NUMBER(SUBSTRING(h.StrucNum,E'\\d+'),'9999'), h.StrucNum; END IF; END IF; END; $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION fstf_Houses_SearchByName(a_HouseNum VARCHAR(20),a_BuildNum VARCHAR(10),a_StrucNum VARCHAR(10),a_FormalName VARCHAR(150),a_ShortName VARCHAR(20),a_ParentFormalName VARCHAR(150),a_ParentShortName VARCHAR(20), a_GrandParentFormalName VARCHAR(150),a_GrandParentShortName VARCHAR(20)) IS '            '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; --SELECT * FROM fstf_Houses_SearchByName('220'); --SELECT * FROM fstf_Houses_SearchByName(NULL,NULL,'220'); SELECT * FROM fstf_Houses_SearchByName('1',NULL,NULL,''); SELECT * FROM fstf_Houses_SearchByName(NULL,NULL,NULL,'','','',NULL,'');</span></span></code> </pre><br></div></div><br><a name="HousesCreate"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Erstellen einer FIAS-Haustabelle fias_Houses </font></font></h3><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Skriptcode</font></font></b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fias_Houses; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fias_EstateStatus; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fias_StructureStatus; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fias_Houses( HOUSEID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, AOGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, HOUSEGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, HOUSENUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, BUILDNUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, STRUCNUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, POSTALCODE <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, OKATO <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, OKTMO <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, IFNSFL <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, TERRIFNSFL <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, IFNSUL <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, TERRIFNSUL <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, ESTSTATUS <span class="hljs-type"><span class="hljs-type">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, STATSTATUS <span class="hljs-type"><span class="hljs-type">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, STRSTATUS <span class="hljs-type"><span class="hljs-type">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, STARTDATE <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, ENDDATE <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, UPDATEDATE <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, NORMDOC <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, COUNTER <span class="hljs-type"><span class="hljs-type">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, CADNUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, DIVTYPE <span class="hljs-type"><span class="hljs-type">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> XPKfias_Houses <span class="hljs-keyword"><span class="hljs-keyword">PRIMARY KEY</span></span> ( HOUSEID )) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">OIDS</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> XIE1fias_Houses <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fias_Houses(AOGUID); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> XIE2fias_Houses <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fias_Houses(HOUSEGUID); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> XIE3fias_Houses <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fias_Houses(AOGUID,HOUSEGUID); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> XIE4fias_Houses <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fias_Houses(HOUSENUM,BUILDNUM,STRUCNUM); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> XIE5fias_Houses <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fias_Houses(HOUSENUM); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> XIE6fias_Houses <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fias_Houses(BUILDNUM); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> XIE7fias_Houses <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fias_Houses(STRUCNUM); <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> fias_Houses <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'HOUSE         ,     .'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.HOUSEID <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'   '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.AOGUID <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'      (, ,    ..)'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.HOUSEGUID <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'   '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.HOUSENUM <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.BUILDNUM <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.STRUCNUM <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.POSTALCODE <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.IFNSFL <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'  '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.TERRIFNSFL <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'    '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.IFNSUL <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'  '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.TERRIFNSUL <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'    '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.OKATO <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.OKTMO <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.ESTSTATUS <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.STRSTATUS <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.STATSTATUS <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.STARTDATE <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'  '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.ENDDATE <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'  '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.UPDATEDATE <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'  () '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.NORMDOC <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'    '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.COUNTER <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'     4'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.CADNUM <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'  '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.DIVTYPE <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' : 0 ‚Äì   1 ‚Äì  2 ‚Äì '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fias_EstateStatus( EstateStatusID <span class="hljs-type"><span class="hljs-type">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, EstateStatusName <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">60</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, EstateStatusShortName <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> XPKfias_EstateStatus <span class="hljs-keyword"><span class="hljs-keyword">PRIMARY KEY</span></span> (EstateStatusID)) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">OIDS</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> fias_EstateStatus <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' ()  '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_EstateStatus.EstateStatusID <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' .  :0 ‚Äì  ,1 ‚Äì ,2 ‚Äì ,3 ‚Äì '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_EstateStatus.EstateStatusName <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_EstateStatus.EstateStatusShortName <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fias_StructureStatus( StructureStatusID <span class="hljs-type"><span class="hljs-type">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, StructureStatusName <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">60</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, StructureStatusShortName <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> XPKfias_StructureStatus <span class="hljs-keyword"><span class="hljs-keyword">PRIMARY KEY</span></span> (StructureStatusID)) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">OIDS</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> fias_StructureStatus <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' ()  '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_StructureStatus.StructureStatusID <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' .  :0 ‚Äì  ,1 ‚Äì ,2 ‚Äì ,3 ‚Äì '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_StructureStatus.StructureStatusName <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_StructureStatus.StructureStatusShortName <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-comment"><span class="hljs-comment">--ROLLBACk TRANSACTION; COMMIT TRANSACTION;</span></span></code> </pre><br></div></div><br><a name="HousesFilling"></a><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Laden Sie FIAS Home Updates in die Tabelle fias_Houses herunter </font></font></h3><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Skript-Quellcode</font></font></b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> $$<span class="pgsql"><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">BEGIN</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/****************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*    */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/****************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DROP</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">IF</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> fias_DeletedHouses_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DROP</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">IF</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> fias_Houses_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DROP</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">IF</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> fias_EstateStatus_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DROP</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">IF</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> fias_StructureStatus_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">CREATE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> fias_Houses_temp </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">AS</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> * </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_Houses </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">LIMIT</span></span></span><span class="pgsql"> </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">1</span></span></span><span class="pgsql">; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DELETE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_Houses_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">CREATE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> fias_DeletedHouses_temp </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">AS</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> * </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_Houses </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">LIMIT</span></span></span><span class="pgsql"> </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">1</span></span></span><span class="pgsql">; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DELETE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_DeletedHouses_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">CREATE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> fias_EstateStatus_temp </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">AS</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> * </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_EstateStatus </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">LIMIT</span></span></span><span class="pgsql"> </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">1</span></span></span><span class="pgsql">; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DELETE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_EstateStatus_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">CREATE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> fias_StructureStatus_temp </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">AS</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> * </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_StructureStatus </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">LIMIT</span></span></span><span class="pgsql"> </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">1</span></span></span><span class="pgsql">; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DELETE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_StructureStatus_temp; </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*****************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*     fias_EstateStatus  */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*  " "   */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*****************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">COPY</span></span></span><span class="pgsql"> fias_EstateStatus_temp(EstateStatusID,EstateStatusNAME,EstateStatusShortName) </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'W:\Projects\Enisey GIS\DB\SourceData\ESTSTAT_20180827.csv'</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WITH</span></span></span><span class="pgsql"> (</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FORMAT</span></span></span><span class="pgsql"> csv,</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DELIMITER</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">';'</span></span></span><span class="pgsql">, </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">ENCODING</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'UTF8'</span></span></span><span class="pgsql">); </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*     */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/* " "     */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">UPDATE</span></span></span><span class="pgsql"> fias_EstateStatus s </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SET</span></span></span><span class="pgsql"> EstateStatusNAME=t.EstateStatusNAME, EstateStatusShortName=t.EstateStatusShortName </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_EstateStatus ds </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">INNER</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">JOIN</span></span></span><span class="pgsql"> fias_EstateStatus_temp t </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">ON</span></span></span><span class="pgsql"> ds.EstateStatusID=t.EstateStatusID </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> ds.EstateStatusID=s.EstateStatusID; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">INSERT</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">INTO</span></span></span><span class="pgsql"> fias_EstateStatus(EstateStatusID,EstateStatusNAME,EstateStatusShortName) </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> EstateStatusID,EstateStatusNAME,EstateStatusShortName </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_EstateStatus_temp t </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">NOT</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> (</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> * </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_EstateStatus os </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> t.EstateStatusID=os.EstateStatusID); </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/******************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*     fias_StructureStatus  */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*  " "  */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/******************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">COPY</span></span></span><span class="pgsql"> fias_StructureStatus_temp(StructureStatusID,StructureStatusNAME,StructureStatusShortName) </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'W:\Projects\Enisey GIS\DB\SourceData\STRSTAT_20180827.csv'</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WITH</span></span></span><span class="pgsql"> (</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FORMAT</span></span></span><span class="pgsql"> csv,</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DELIMITER</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">';'</span></span></span><span class="pgsql">, </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">ENCODING</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'UTF8'</span></span></span><span class="pgsql">); </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*****************************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*     " "  */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*   */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*****************************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">UPDATE</span></span></span><span class="pgsql"> fias_StructureStatus s </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SET</span></span></span><span class="pgsql"> StructureStatusNAME=t.StructureStatusNAME, StructureStatusShortName=t.StructureStatusShortName </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_StructureStatus ds </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">INNER</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">JOIN</span></span></span><span class="pgsql"> fias_StructureStatus_temp t </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">ON</span></span></span><span class="pgsql"> ds.StructureStatusID=t.StructureStatusID </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> ds.StructureStatusID=s.StructureStatusID; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">INSERT</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">INTO</span></span></span><span class="pgsql"> fias_StructureStatus(StructureStatusID,StructureStatusNAME,StructureStatusShortName) </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> StructureStatusID,StructureStatusNAME,StructureStatusShortName </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_StructureStatus_temp t </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">NOT</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> (</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> * </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_StructureStatus os </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> t.StructureStatusID=os.StructureStatusID); </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/***********************************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*     fias_Houses_temp     */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/**********************************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">COPY</span></span></span><span class="pgsql"> fias_Houses_temp(AOGUID,BUILDNUM,ENDDATE,ESTSTATUS,HOUSEGUID,HOUSEID,HOUSENUM,STATSTATUS,IFNSFL,IFNSUL,OKATO,OKTMO,POSTALCODE,STARTDATE,STRUCNUM,STRSTATUS,TERRIFNSFL,TERRIFNSUL,UPDATEDATE,NORMDOC,COUNTER,CADNUM,DIVTYPE) </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'W:\Projects\Enisey GIS\DB\SourceData\HOUSE24_20180827.csv'</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WITH</span></span></span><span class="pgsql"> (</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FORMAT</span></span></span><span class="pgsql"> csv,</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DELIMITER</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">';'</span></span></span><span class="pgsql">, </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">ENCODING</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'UTF8'</span></span></span><span class="pgsql">); </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/************************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*     fias_DeletedHouses_temp , */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*        */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/************************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*  DHOUSE24      . */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*         */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/************************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/* COPY fias_DeletedHouses_temp(AOGUID,BUILDNUM,ENDDATE,ESTSTATUS,HOUSEGUID,HOUSEID,HOUSENUM,STATSTATUS,IFNSFL,IFNSUL,OKATO,OKTMO,POSTALCODE,STARTDATE,STRUCNUM,STRSTATUS,TERRIFNSFL,TERRIFNSUL,UPDATEDATE,NORMDOC,COUNTER,CADNUM,DIVTYPE) FROM 'W:\Projects\Enisey GIS\DB\SourceData\DHOUSE24_20180827.csv' WITH (FORMAT csv,DELIMITER ';', ENCODING 'UTF8'); */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/***********************************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*        */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/***********************************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">UPDATE</span></span></span><span class="pgsql"> fias_Houses h </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SET</span></span></span><span class="pgsql"> AOGUID=t.AOGUID, BUILDNUM=t.BUILDNUM, ENDDATE=t.ENDDATE, ESTSTATUS=t.ESTSTATUS, HOUSEGUID=t.HOUSEGUID, HOUSENUM=t.HOUSENUM, STATSTATUS=t.STATSTATUS, IFNSFL=t.IFNSFL, IFNSUL=t.IFNSUL, OKATO=t.OKATO, OKTMO=t.OKTMO, POSTALCODE=t.POSTALCODE, STARTDATE=t.STARTDATE, STRUCNUM=t.STRUCNUM, STRSTATUS=t.STRSTATUS, TERRIFNSFL=t.TERRIFNSFL, TERRIFNSUL=t.TERRIFNSUL, UPDATEDATE=t.UPDATEDATE, NORMDOC=t.NORMDOC, COUNTER=t.COUNTER, CADNUM=t.CADNUM, DIVTYPE=t.DIVTYPE </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_Houses dh </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">INNER</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">JOIN</span></span></span><span class="pgsql"> fias_Houses_Temp t </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">ON</span></span></span><span class="pgsql"> t.HOUSEID=dh.HOUSEID </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> h.HOUSEID=dh.HOUSEID; </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/****************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*       */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*       */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/* fias_DeletedHouses_temp */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/****************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DELETE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_Houses h </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql">(</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">1</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_DeletedHouses_temp delh </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> delh.HOUSEID=h.HOUSEID); </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/****************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*       */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*  fias_Houses,  */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*    fias_Houses_Temp */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/****************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">INSERT</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">INTO</span></span></span><span class="pgsql"> fias_Houses(AOGUID,BUILDNUM,ENDDATE,ESTSTATUS,HOUSEGUID,HOUSEID,HOUSENUM,STATSTATUS,IFNSFL,IFNSUL,OKATO,OKTMO,POSTALCODE,STARTDATE,STRUCNUM,STRSTATUS,TERRIFNSFL,TERRIFNSUL,UPDATEDATE,NORMDOC,COUNTER,CADNUM,DIVTYPE) </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> AOGUID,BUILDNUM,ENDDATE,ESTSTATUS,HOUSEGUID,HOUSEID,HOUSENUM,STATSTATUS,IFNSFL,IFNSUL,OKATO,OKTMO,POSTALCODE,STARTDATE,STRUCNUM,STRSTATUS,TERRIFNSFL,TERRIFNSUL,UPDATEDATE,NORMDOC,COUNTER,CADNUM,DIVTYPE </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_Houses_Temp t </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">NOT</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql">(</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> * </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_Houses h </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> t.HOUSEID=h.HOUSEID); </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*    */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DROP</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">IF</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> fias_DeletedHouses_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DROP</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">IF</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> fias_Houses_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DROP</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">IF</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> fias_EstateStatus_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DROP</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">IF</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> fias_StructureStatus_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">END</span></span></span><span class="pgsql">; $$</span><span class="undefined"></span></span><span class="hljs-keyword"><span class="pgsql"><span class="undefined"></span></span><span class="hljs-keyword">LANGUAGE</span></span> plpgsql; <span class="hljs-comment"><span class="hljs-comment">--ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECT (SELECT COUNT(*) FROM fias_Houses) AS HouseCount, (SELECT COUNT(*) FROM fias_EstateStatus) AS EStatusCount, (SELECT COUNT(*) FROM fias_StructureStatus) AS SStatusCount;</span></span></code> </pre><br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de425287/">https://habr.com/ru/post/de425287/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de425275/index.html">12 Tipps zum Skalieren von Node.js.</a></li>
<li><a href="../de425279/index.html">So interviewen Sie Google: Was soll man sein, was soll man nicht bestehen?</a></li>
<li><a href="../de425281/index.html">Richtlinien f√ºr die "Konditionierung" eines Klons des beliebten chinesischen Mini-Routers Hame A15, auch bekannt als "A5-V11 ohne Markenzeichen"</a></li>
<li><a href="../de425283/index.html">Unendliche Lokalisierung oder wie wir eine Karte in Echtzeit √ºbersetzen</a></li>
<li><a href="../de425285/index.html">Wenn Sie den Jones nicht einstellen, dann verdienen Sie die Herren nicht</a></li>
<li><a href="../de425289/index.html">Unternehmensfokus</a></li>
<li><a href="../de425291/index.html">Die Ergebnisse des Sommerpraktikums 2018: Sie fegten f√ºnfhundert Pita Shawarma. Und √ºberlebt</a></li>
<li><a href="../de425293/index.html">Das ideale (wahrscheinlich) Interview eines mobilen Mittelklasse-Entwicklers</a></li>
<li><a href="../de425295/index.html">KotlinConf 2018 Live - wir sind auf Sendung</a></li>
<li><a href="../de425297/index.html">Drei Headsets f√ºr Sport oder wie ich die Knochenleitung liebte</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>