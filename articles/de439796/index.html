<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤴🏽 🤨 👨🏻‍🏭 Spring Boot 2: Was sie nicht in Versionshinweisen schreiben 👩🏽‍🍳 🔞 🔓</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wenn ein Großprojekt einem umfangreichen Update unterzogen wird, ist nie alles einfach: Es gibt unweigerlich nicht offensichtliche Nuancen (mit andere...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Spring Boot 2: Was sie nicht in Versionshinweisen schreiben</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/439796/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/a4/e3/fc/a4e3fcwl22r0y3nlx8z-6pkhtny.jpeg"></div><br><br>  Wenn ein Großprojekt einem umfangreichen Update unterzogen wird, ist nie alles einfach: Es gibt unweigerlich nicht offensichtliche Nuancen (mit anderen Worten einen Rechen).  Und dann, egal wie gut die Dokumentation ist, hilft nur die Erfahrung - Ihre eigene oder die einer anderen - bei etwas. <br><br>  Auf der Joker 2018-Konferenz habe ich darüber gesprochen, auf welche Probleme ich beim Wechsel zu Spring Boot 2 selbst gestoßen bin und wie sie gelöst werden.  Und jetzt speziell für Habr - die Textversion dieses Berichts.  Der Einfachheit halber enthält der Beitrag sowohl eine Videoaufzeichnung als auch ein Inhaltsverzeichnis: Sie können nicht das Ganze lesen, sondern gehen direkt zu dem Problem, das Sie beunruhigt. <br><a name="habracut"></a><br><h2>  Inhaltsverzeichnis </h2><br><ul><li>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Videoaufnahme</a></b> </li><li>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Eintrag</a></b> </li><li>  <b>Rechenkompilierungszeit</b> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Problembeispiele</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Wie man ist</a> </li><li>  <b>Inhaltstyp.</b>  <b>Bestimmen des Typs der HTTP-Antwort</b> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Das Problem</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Wie man ist</a> </li><li>  <b>Planung.</b>  <b>Geplanter Start</b> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Das Problem</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Wie man ist</a> </li><li>  <b>Frühlingswolke &amp; Co.</b>  <b>Bibliothekskompatibilität</b> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Das Problem</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Bonus: Ergänzungsfall</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Wie man ist</a> </li><li>  <b>Entspannungsbindung.</b>  <b>Fuzzy-Parameterbindung</b> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Das Problem</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Wie man ist</a> </li><li>  <b>Unit Testing.</b>  <b>Ausführen von Tests in Mockito 2</b> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Das Problem</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Wie man ist</a> </li><li>  <b>Gradle Plugin.</b>  <b>Erstellen Sie Spring Boot-Projekte</b> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Das Problem</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Wie man ist</a> </li><li>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Andere</a></b> </li><li>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Fazit</a></b>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Zusammenfassung und Schlussfolgerungen</a></b> </li></ul><br><br><a name="video"></a><iframe width="560" height="315" src="https://www.youtube.com/embed/8jNXZXdb3no" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><a name="intro"></a>  Guten Tag!  Ich möchte Ihnen einige Funktionen erläutern (nennen wir sie Rakes), die beim Aktualisieren des Spring Boot-Frameworks auf die zweite Version und des nachfolgenden Vorgangs auftreten können. <br><br>  Mein Name ist Vladimir Plizgá ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">GitHub</a> ), ich arbeite für CFT, einen der größten und ältesten Softwareentwickler in Russland.  In den letzten Jahren habe ich dort Backend-Entwicklungen durchgeführt, die für die technische Entwicklung der Online-Bank für Prepaid-Karten verantwortlich sind.  Bei diesem Projekt wurde ich der Initiator und Ausführender des Übergangs von einer monolithischen Architektur zu einer Mikroservice-Architektur (die noch andauert).  Nun, da das meiste Wissen, das ich mit Ihnen teilen wollte, am Beispiel dieses speziellen Projekts gesammelt wurde, werde ich Ihnen etwas mehr darüber erzählen. <br><br><h2>  Kurz zum experimentellen Produkt </h2><br>  Dies ist eine Internetbank, die im Alleingang mehr als zwei Dutzend Partnerunternehmen in ganz Russland bedient: Sie bietet Endkunden die Möglichkeit, ihr Geld über Remote-Banking-Dienste (mobile Anwendungen, Websites) zu verwalten.  Einer der Partner ist Beeline und seine Zahlungskarte.  Es stellte sich als gutes Internet-Banking heraus, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">gemessen</a> am Rating des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Markswebb Mobile Banking Rank</a> , bei dem unser Produkt eine gute Position für Anfänger einnahm. <br><br>  "Guts" befinden sich noch im Übergang, daher haben wir einen Monolithen, den sogenannten Kern, um den 23 Mikrodienste aufgebaut sind.  Im Inneren die Spring Cloud Netflix-Microservices, Spring Integration und mehr.  Und auf Spring Boot 2 fliegt das Ganze seit ungefähr dem Monat Juli.  Und genau an dieser Stelle werden wir genauer darauf eingehen.  Bei der Übersetzung dieses Projekts in die zweite Version bin ich auf einige Funktionen gestoßen, über die ich Ihnen erzählen möchte. <br><br><h2>  Berichtsübersicht </h2><br><img src="https://habrastorage.org/webt/rl/jd/zq/rljdzqye-_lbzjguklndonlyc-4.jpeg"><br><br>  Es gibt viele Bereiche, in denen Funktionen von Spring Boot 2 erschienen sind. Wir werden versuchen, alles durchzugehen.  Um dies schnell zu erledigen, brauchen wir einen erfahrenen Detektiv oder Ermittler - jemanden, der all dies wie für uns ans Licht bringt.  Da Holmes und Watson bereits <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">eine Präsentation</a> bei Joker gehalten haben, werden wir von einem anderen Spezialisten unterstützt, Lieutenant Colombo.  Mach weiter! <br><br><h2>  Federstiefel / 2 </h2><br>  Zunächst ein paar Worte zu Spring Boot im Allgemeinen und zur zweiten Version im Besonderen.  Erstens wurde diese Version, gelinde gesagt, nicht gestern veröffentlicht: Am 1. März 2018 befand sie sich bereits in der allgemeinen Verfügbarkeit.  Eines der Hauptziele der Entwickler war die vollständige Unterstützung von Java 8 auf Quellenebene.  Das heißt, es kann nicht auf einer kleineren Version kompiliert werden, obwohl die Laufzeit kompatibel ist.  Das Spring Framework der fünften Version, das etwas früher als Spring Boot 2 veröffentlicht wurde, wurde als Grundlage genommen. Dies ist nicht die einzige Abhängigkeit.  Er hat auch ein Konzept wie <a href="">BOM</a> (Bill Of Materials) - dies ist ein riesiges XML, das alle (für uns transitiven) Abhängigkeiten von allen Arten von Bibliotheken von Drittanbietern, zusätzlichen Frameworks, Tools und mehr auflistet. <br><br>  Dementsprechend stammen nicht alle Spezialeffekte, die der zweite Spring Boot einbringt, von sich selbst oder vom Spring-Ökosystem.  Für diese gesamte Farm wurden zwei hervorragende Dokumente geschrieben: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Versionshinweise</a> und das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Migrationshandbuch</a> .  Dokumente sind cool, Frühling in diesem Sinne ist im Allgemeinen gut gemacht.  Aus offensichtlichen Gründen ist es jedoch bei weitem nicht möglich, alles dort abzudecken: Es gibt einige Einzelheiten, Abweichungen usw., die dort entweder nicht enthalten sein können oder sollten.  Wir werden über solche Funktionen sprechen. <br><br><a name="compile"></a><h2>  Kompilierzeit.  Beispiele für API-Änderungen </h2><br>  Beginnen wir mit dem mehr oder weniger einfachen und offensichtlichen Rechen: Dies sind diejenigen, die in der Kompilierungszeit entstehen.  Das heißt, etwas, mit dem Sie das Projekt nicht einmal kompilieren können, wenn Sie einfach die Nummer 1 im Boot-Skript in 2 ändern. <br><br>  Die Hauptquelle für Änderungen, die die Grundlage für solche Änderungen in Spring Boot wurden, ist natürlich der Übergang von Spring zu Java 8. Außerdem wurde der Webstack von Spring 5 und Spring Boot 2 relativ gesehen in zwei Teile geteilt.  Jetzt ist es Servlet, traditionell für uns und reaktiv.  Darüber hinaus mussten einige Mängel früherer Versionen berücksichtigt werden.  Bibliotheken von Drittanbietern wurden gestartet (von außerhalb des Frühlings).  Wenn Sie sich die Versionshinweise ansehen, werden Sie keine Fallstricke im laufenden Betrieb sehen, und ehrlich gesagt, als ich die Versionshinweise zum ersten Mal las, schien mir, dass dort alles in Ordnung war.  Und für mich sah es ungefähr so ​​aus: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/uJ2P16LXA94" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Aber wie Sie wahrscheinlich vermuten, ist nicht alles so gut. <br><br>  <b>Worauf die Zusammenstellung abzielt (Beispiel 1):</b> <br><br><ul><li> <b>Warum</b> : Die <code>WebMvcConfigurerAdapter</code> Klasse ist nicht mehr vorhanden. </li><li>  <b>Warum</b> : Unterstützung von Java 8-Chips (Standardmethoden in Schnittstellen); </li><li>  <b>Was zu tun ist</b> : Verwenden Sie die <code>WebMvcConfigurer</code> Oberfläche. </li></ul><br>  Ein Projekt wird möglicherweise nicht kompiliert, zumindest weil einige Klassen einfach nicht mehr existieren.  Warum?  Ja, da sie in Java 8 nicht benötigt werden.  Wenn dies Adapter mit primitiver Implementierung von Methoden wären, dann gibt es nichts Besonderes zu erklären, Standardmethoden lösen all dies perfekt.  Hier ist ein Beispiel für diese Klasse. Es ist klar, dass es ausreicht, die Schnittstelle selbst zu verwenden, und dass keine Adapter benötigt werden. <br><br>  <b>Welche Kompilierung wird unterbrochen (Beispiel 2):</b> <br><br><ul><li>  <b>Warum</b> : Die <code>PropertySourceLoader#load</code> begonnen, eine Liste von Quellen anstelle einer zurückzugeben. </li><li>  <b>Warum</b> : Unterstützung von Ressourcen mit mehreren Dokumenten, z. B. YAML; </li><li>  <b>Was zu tun ist</b> : Umschließen Sie die Antwort in <code>singletonList()</code> (wenn überschrieben). </li></ul><br>  Ein Beispiel aus einem ganz anderen Bereich.  Einige Methoden haben sogar die Signaturen geändert.  Wenn Sie jemals die Methode loadSourceSourceLoader verwendet haben, wird jetzt eine Auflistung zurückgegeben.  Dementsprechend ermöglichte dies die Unterstützung von Ressourcen mit mehreren Dokumenten.  In YAML können Sie beispielsweise durch drei Striche eine Reihe von Dokumenten in einer Datei angeben.  Wenn Sie jetzt von Java aus damit arbeiten müssen, denken Sie daran, dass dies über die Sammlung erfolgen muss. <br><br>  <b>Welche Kompilierung wird unterbrochen (Beispiel 3):</b> <br><br><ul><li>  <b>Warum</b> : Einige Klassen aus dem Paket <code>org.springframework.boot.autoconfigure.web</code> von den Paketen <code>.servlet</code> - <code>.servlet</code> und <code>.reactive</code> ; </li><li>  <b>Warum</b> : den Jet-Stack auf dem Niveau des Traditionellen zu unterstützen; </li><li>  <b>Was zu tun ist</b> : Importe aktualisieren. </li></ul><br>  Es wurden noch mehr Änderungen eingeführt, wodurch gestapelt wurde.  Zum Beispiel wurde das, was sich früher im selben Webpaket befand, jetzt in zwei Pakete mit einer Reihe von Klassen aufgeteilt.  Dies sind <code>.servlet</code> und <code>.reactive</code> .  Warum wird es gemacht?  Weil der Jet-Stack keine riesige Krücke auf dem Servlet sein sollte.  Dies war notwendig, damit sie ihren eigenen Lebenszyklus aufrechterhalten, sich in ihre eigenen Richtungen entwickeln und sich nicht gegenseitig stören konnten.  Was tun?  Genug, um die Importe zu ändern: Die meisten dieser Klassen blieben auf API-Ebene kompatibel.  Die meisten, aber nicht alle. <br><br>  <b>Welche Kompilierung wird unterbrochen (Beispiel 4):</b> <br><br><ul><li>  <b>Warum</b> : Die Signatur der Methoden der <code>ErrorAttributes</code> Klasse hat sich <code>ErrorAttributes</code> : Anstelle von <code>RequestAttributes</code> wurden <code>WebRequest(servlet)</code> und <code>ServerRequest(reactive)</code> verwendet. </li><li>  <b>Warum</b> : den Jet-Stack auf dem Niveau des Traditionellen zu unterstützen; </li><li>  <b>Was zu tun ist</b> : Ersetzen Sie Klassennamen in Signaturen. </li></ul><br>  In der ErrorAttributes-Klasse wurden jetzt anstelle von RequestAttributes zwei weitere Klassen in Methoden verwendet: WebRequest und ServerRequest.  Der Grund ist der gleiche.  Und was tun?  Wenn Sie vom ersten zum zweiten Spring Boot wechseln, müssen Sie RequestAttributes in WebRequest ändern.  Wenn Sie bereits auf der zweiten Seite sind, verwenden Sie ServerRequest.  Offensichtlich nicht wahr? <br><br><a name="compile_solution"></a><h3>  Wie man ist </h3><br>  Es gibt einige solcher Beispiele, wir werden sie nicht alle klären.  Was tun?  Es lohnt sich zunächst, einen Blick in das Spring Boot 2.0-Migrationshandbuch zu werfen, um die Änderung, die Sie betrifft, rechtzeitig zu bemerken.  Beispielsweise wird das Umbenennen völlig nicht offensichtlicher Klassen erwähnt.  Wenn sich jedoch etwas getrennt und zerbrochen hat, sollte berücksichtigt werden, dass das Konzept von „Web“ in zwei Bereiche unterteilt ist: „Servlet“ und „Reaktiv“.  Bei der Orientierung in allen Klassen und Paketen kann dies helfen.  Darüber hinaus sollte berücksichtigt werden, dass nicht nur die Klassen und Pakete selbst umbenannt wurden, sondern auch ganze Abhängigkeiten und Artefakte.  So geschah dies beispielsweise mit Spring Cloud. <br><br><hr><br><a name="contenttype"></a><h2>  Inhaltstyp.  Bestimmen des Typs der HTTP-Antwort </h2><br>  Genug von diesen einfachen Dingen aus der Kompilierungszeit, dort ist alles klar und einfach.  Lassen Sie uns darüber sprechen, was zur Laufzeit passieren und entsprechend schießen kann, auch wenn Spring Boot 2 schon lange für Sie arbeitet.  Lassen Sie uns über die Definition des Inhaltstyps sprechen. <br><br><img src="https://habrastorage.org/webt/03/a2/db/03a2dbs5_suz7osfukciaumo0-y.jpeg"><br><br>  Es ist kein Geheimnis, dass Spring Webanwendungen schreiben kann, sowohl Seiten- als auch REST-APIs, und sie können Inhalte mit einer Vielzahl von Typen rendern, sei es XML, JSON oder etwas anderes.  Und einer der Reize, die Spring so mag, ist, dass Sie sich nicht um die Definition des Typs kümmern müssen, der in Ihrem Code angegeben ist.  Sie können auf Magie hoffen.  Diese Magie funktioniert relativ gesehen auf drei verschiedene Arten: Entweder basiert sie auf dem vom Client stammenden Accept-Header oder auf der Erweiterung der angeforderten Datei oder auf einem speziellen Parameter in der URL, der natürlich auch gesteuert werden kann. <br><br>  Betrachten Sie ein einfaches Beispiel ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">vollständiger Quellcode</a> ).  Im Folgenden werde ich die Notation von Gradle verwenden, aber selbst wenn Sie ein Maven-Fan sind, wird es für Sie nicht schwierig sein zu verstehen, was hier geschrieben steht: Wir erstellen eine winzige Anwendung auf dem ersten Spring Boot und verwenden nur ein Starter-Web. <br><br>  Beispiel (v1.x): <br><br><pre> <code class="java hljs">dependencies { ext { springBootVersion = <span class="hljs-string"><span class="hljs-string">'1.5.14.RELEASE'</span></span> } compile(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot:spring-boot-starter-web:$springBootVersion"</span></span>) }</code> </pre><br>  Als ausführbaren Code haben wir eine einzige Klasse, in der die Controller-Methode sofort deklariert wird. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@GetMapping</span></span>(value = <span class="hljs-string"><span class="hljs-string">"/download/{fileName: .+}"</span></span>, produces = {TEXT_HTML_VALUE, APPLICATION_JSON_VALUE, TEXT_PLAIN_VALUE}) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ResponseEntity&lt;Resource&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">download</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@PathVariable String fileName)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   ,  Content-Type }</span></span></code> </pre><br>  Es nimmt einen bestimmten Dateinamen als Eingabe, den es angeblich bilden und geben wird.  Es bildet seinen Inhalt wirklich in einem der drei angegebenen Typen (dies wird durch den Dateinamen bestimmt), gibt jedoch den Inhaltstyp in keiner Weise an - wir haben Spring, er wird alles selbst tun. <br><br><img src="https://habrastorage.org/webt/wa/nd/77/wand77z2iocxhhqbcr-bn6lvzxm.jpeg"><br><br>  Im Allgemeinen können Sie dies sogar versuchen.  Wenn wir dasselbe Dokument mit unterschiedlichen Erweiterungen anfordern, wird es je nach Rückgabe mit dem richtigen Inhaltstyp zurückgegeben: wenn Sie möchten - json, wenn Sie möchten - txt, wenn Sie möchten - html.  Es funktioniert wie ein Märchen. <br><br><h3>  Aktualisierung auf v2.x. </h3><br><pre> <code class="java hljs">dependencies { ext { springBootVersion = <span class="hljs-string"><span class="hljs-string">'2.0.4.RELEASE'</span></span> } compile(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot:spring-boot-starter-web:$springBootVersion"</span></span>) }</code> </pre><br>  Es ist Zeit, auf den zweiten Spring Boot zu aktualisieren.  Wir ändern einfach die Nummer 1 in 2. <br><br><img src="https://habrastorage.org/webt/rk/ki/dg/rkkidgg5r97wfxcfq_3djkria_u.jpeg"><br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Spring MVC Path Matching Standardverhaltensänderung</a> <br><br>  Aber wir sind Ingenieure, wir werfen einen Blick auf den Migrationsleitfaden und plötzlich wird etwas darüber gesagt.  Es wird jedoch eine Art „Suffix-Pfadabgleich“ erwähnt.  Es geht darum, wie Methoden in Java mit einer URL korrekt zugeordnet werden.  Dies ist jedoch nicht unser Fall, wenn auch ein wenig ähnlich. <br><br><img src="https://habrastorage.org/webt/cy/re/_f/cyre_fno26kbqiepmtpr0tewmrw.jpeg"><br><br>  Deshalb punkten, prüfen und schlagen wir!  - funktioniert plötzlich nicht mehr.  Aus irgendeinem Grund wird überall nur Text / HTML angegeben. Wenn Sie es ausgraben, ist es nicht nur Text / HTML, sondern nur der erste der Typen, die Sie im Attribut "produziert "in der Annotation" @GetMapping "angegeben haben.  Warum so?  Es sieht, gelinde gesagt, unverständlich aus. <br><br><img src="https://habrastorage.org/webt/xt/mj/50/xtmj50wpv1ossdx_6nqeakchwxc.jpeg"><br><br>  Und hier helfen keine Versionshinweise, Sie müssen die Quelle lesen. <br><br><h3>  ContentNegotiationManagerFactoryBean </h3><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ContentNegotiationManagerFactoryBean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ List&lt;ContentNegotiationStrategy&gt; strategies = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.strategies != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { strategies.addAll(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.strategies); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.favorPathExtension) { PathExtensionContentNegotiationStrategy strategy; <span class="hljs-comment"><span class="hljs-comment">// …</span></span></code> </pre><br>  Dort finden Sie einen Klassiker mit einem sehr verständlichen lakonischen Kurznamen, der eine bestimmte Flagge mit dem Namen "Erweiterung auf dem Weg berücksichtigen" (favorPathExtension) erwähnt.  Der Wert dieses Flags "true" entspricht der Anwendung einer bestimmten Strategie mit einem anderen verständlichen kurzen, kurzen Namen, aus dem hervorgeht, dass es nur für die Bestimmung des Inhaltstyps anhand der Dateierweiterung verantwortlich ist.  Wie Sie sehen können, gilt die Strategie nicht, wenn das Flag falsch ist. <br><br><img src="https://habrastorage.org/webt/qy/g3/ms/qyg3mscyw2mnlyqewltjefecwri.jpeg"><br><br>  Ja, wahrscheinlich haben viele bemerkt, dass es im Frühjahr anscheinend eine Art Richtlinie gibt, so dass der Name gut sein muss, mindestens zwanzig Zeichen lang. <br><br><img src="https://habrastorage.org/webt/ef/j8/il/efj8ilxfvvc1_dtss-7-becc_m0.jpeg"><br><br>  Wenn Sie etwas tiefer eintauchen, können Sie genau ein solches Fragment graben.  Im Spring-Framework selbst und nicht wie zu erwarten in der fünften Version, aber seit jeher wurde dieses Flag standardmäßig auf "true" gesetzt.  Während des Spring Boot und in der zweiten Version wurde es von einem anderen blockiert, der jetzt über die Einstellungen gesteuert werden kann.  Das heißt, jetzt können wir sie vom Umweltmanagement ablenken, und dies ist nur in der zweiten Version.  Fühlst du  Dort nahm er bereits die Bedeutung von „falsch“ an.  Das heißt, sie wollten irgendwie das Beste tun, dieses Flag in die Einstellungen setzen (und das ist großartig), aber der Standardwert wurde auf einen anderen umgeschaltet (das ist nicht sehr). <br><br>  Die Entwickler des Frameworks sind ebenfalls Menschen, sie neigen auch dazu, Fehler zu machen.  Was tun?  Es ist klar, dass Sie den Parameter in Ihrem Projekt ändern müssen, und alles wird gut. <br><br>  Das Einzige, was Sie für den Fall tun sollten, um Ihr Gewissen zu klären, ist, in der Spring Boot-Dokumentation nachzuschlagen, ob diese Flagge erwähnt wird.  Und dort wird er wirklich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">erwähnt</a> , aber nur in einem seltsamen Kontext: <br><blockquote>  Wenn Sie <b>die Einschränkungen verstehen</b> und dennoch möchten, dass Ihre Anwendung den Suffix-Pattern-Matching verwendet, ist die folgende Konfiguration erforderlich: <br>  spring.mvc.contentnegotiation.favor-path-extension = true <br>  ... <br></blockquote>  Es heißt, wenn Sie alle Tricks verstehen und trotzdem den Suffix-Pfadabgleich verwenden möchten, aktivieren Sie dieses Kontrollkästchen.  Fühlen Sie die Diskrepanz?  Es scheint, als würden wir im Kontext dieses Flags über die Definition des Inhaltstyps sprechen, aber hier sprechen wir über den Abgleich von Java-Methoden und URLs.  Es sieht irgendwie unverständlich aus. <br><br>  Wir müssen weiter graben.  Es gibt eine solche <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Pull-Anfrage</a> auf GitHub: <br><br><img src="https://habrastorage.org/webt/qa/ra/e8/qarae8b3dxgmf-mwhx1-bf9tev0.jpeg"><br><br>  Im Rahmen dieser Pull-Anfrage wurden diese Änderungen vorgenommen - der Standardwert wurde geändert - und dort sagt einer der Autoren des Frameworks, dass dieses Problem zwei Aspekte hat: Einer ist nur die Pfadübereinstimmung und der zweite ist die Definition des Inhaltstyps .  Das heißt, mit anderen Worten, das Flag gilt für beide und sie sind untrennbar miteinander verbunden. <br><br>  Sie könnten es natürlich sofort auf GitHub finden, wenn Sie nur wüssten, wo Sie suchen müssen. <br><br><img src="https://habrastorage.org/webt/nb/pr/sq/nbprsqxl5nlwzs5qtnv3vohv26y.jpeg"><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Suffix-Match</a> <br><br>  Darüber hinaus heißt es in der Dokumentation zum Spring Framework selbst, dass die Verwendung von Dateierweiterungen früher erforderlich war, jetzt jedoch nicht mehr als Notwendigkeit angesehen wird.  Darüber hinaus erwies es sich in mehreren Fällen als problematisch. <br><br><h3>  Fassen Sie zusammen </h3><br>  Das Ändern des Standardflag-Werts ist überhaupt kein Fehler, sondern eine Funktion.  Es ist untrennbar mit der Definition der Pfadübereinstimmung verbunden und soll <b>drei Dinge</b> tun: <br><br><ul><li>  Sicherheitsrisiken reduzieren (welche werde ich klären); </li><li>  Richten Sie das Verhalten von WebFlux und WebMvc aus. Sie unterschieden sich in diesem Aspekt. </li><li>  Richten Sie die Anweisung in der Dokumentation am Framework-Code aus. </li></ul><br><a name="contenttype_solution"></a><h3>  Wie man ist </h3><br>  Erstens sollten Sie sich nach Möglichkeit nicht auf die Definition des Inhaltstyps durch Erweiterung verlassen.  Das Beispiel, das ich gezeigt habe, ist ein Gegenbeispiel, das ist nicht nötig!  Es ist auch nicht notwendig, sich darauf zu verlassen, dass Anfragen der Form "GET Something.json" beispielsweise einfach "GET Something" sind.  Dies war in Spring Framework 4 und in Spring Boot 1 der Fall. Dies funktioniert nicht mehr.  Wenn Sie einer Datei mit der Erweiterung zuordnen müssen, müssen Sie dies explizit tun.  Stattdessen ist es besser, sich auf den Accept-Header oder den URL-Parameter zu verlassen, dessen Namen Sie steuern können.  Wenn Sie dies in keiner Weise tun können, nehmen wir an, Sie haben einige alte mobile Clients, die im letzten Jahrhundert nicht mehr aktualisiert wurden. Dann müssen Sie dieses Flag zurückgeben, es auf "true" setzen und alles funktioniert wie zuvor. <br><br>  Zum allgemeinen Verständnis können Sie außerdem das Kapitel „Suffix-Übereinstimmung“ in der Dokumentation zum Spring Framework lesen, das von den Entwicklern als eine Art Best-Practice-Sammlung in diesem Bereich betrachtet wird, und sich mit dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Angriff auf Reflected File Download</a> vertraut machen, der nur mithilfe von Manipulationen mit implementiert wird Dateierweiterung. <br><br><a name="scheduling"></a><h2>  Planung.  Geplante oder regelmäßige Aufgaben </h2><br>  Lassen Sie uns den Umfang ein wenig ändern und über das Erledigen von Aufgaben nach Zeitplan oder in regelmäßigen Abständen sprechen. <br><br><h3>  Ein Beispiel für eine Aufgabe.  Protokollnachricht alle 3 Sekunden </h3><br>  Was gesagt wird, denke ich, ist verständlich.  Wir haben einige geschäftliche Anforderungen, um etwas mit einer Art Wiederholung zu tun, also werden wir sofort mit dem Beispiel fortfahren.  Nehmen wir an, wir haben eine mega-komplexe Aufgabe: alle 3 Sekunden etwas Dreck in das Protokoll auszugeben. <br><br><img src="https://habrastorage.org/webt/rf/ay/mh/rfaymhimyivf7htbkhf7fw3nia0.jpeg"><br><br>  Dies kann natürlich auf verschiedene Arten geschehen, denn für sie gibt es im Frühling schon etwas.  Und finde es - viele Möglichkeiten. <br><br><h3>  Option 1: Suchen Sie in Ihrem Projekt nach einem Beispiel </h3><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** *A very helpful service */</span></span> <span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReallyBusinessService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// … a bunch of methods … @Scheduled(fixedDelay = 3000L) public void runRepeatedlyWithFixedDelay() { assert Runtime.getRuntime().availableProcessors() &gt;= 4; } // … another bunch of methods … }</span></span></code> </pre><br>  Wir können in unser eigenes Projekt schauen und werden wahrscheinlich so etwas finden.  Eine Anmerkung hängt an der öffentlichen Methode, und es wird deutlich, dass, sobald Sie sie auflegen, alles wie in einem Märchen funktioniert. <br><br><h3>  Option 2: Suchen Sie nach der gewünschten Anmerkung </h3><br><img src="https://habrastorage.org/webt/nr/ax/sv/nraxsvpmgs9u7z2yjavxhceqrli.jpeg"><br><br>  Sie können die Anmerkung direkt anhand des Namens suchen. Aus der Dokumentation geht auch hervor, dass Sie sie aufhängen - und alles funktioniert. <br><br><h3>  Option 3: Googeln </h3><br>  Wenn Sie nicht an sich glauben, können Sie es googeln. Nach dem, was Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">gefunden haben,</a> wird auch klar, dass alles mit einer Anmerkung beginnt. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventCreator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOG = LoggerFactory.getLogger(EventCreator.class); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> EventRepository eventRepository; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EventCreator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> EventRepository eventRepository)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.eventRepository = eventRepository; } <span class="hljs-meta"><span class="hljs-meta">@Scheduled</span></span>(fixedRate = <span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> LocalDateTime start = LocalDateTime.now(); eventRepository.save( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Event(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EventKey(<span class="hljs-string"><span class="hljs-string">"An event type"</span></span>, start, UUID.randomUUID()), Math.random() * <span class="hljs-number"><span class="hljs-number">1000</span></span>)); LOG.debug(<span class="hljs-string"><span class="hljs-string">"Event created!"</span></span>); } }</code> </pre><br>  Wer sieht den Haken darin?  Wir sind schließlich Ingenieure. Lassen Sie uns überprüfen, wie dies in der Realität funktioniert. <br><br><h3>  Zeig mir den Code! </h3><br>  Betrachten Sie eine bestimmte Aufgabe (die Aufgabe selbst und der Code befinden sich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">in meinem Repository</a> ). <br><br>  Wer nicht lesen möchte, kann dieses Fragment des Videos mit einer Demonstration (bis zur 22. Minute) ansehen: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/8jNXZXdb3no" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Als Abhängigkeit verwenden wir den ersten Spring Boot mit zwei Startern.  Eine ist für das Web, es ist, als würden wir einen Webserver entwickeln, und die zweite ist der Federstarter-Aktuator, damit wir produktionsbereite Funktionen haben, so dass wir zumindest ein bisschen wie etwas Reales sind. <br><br><pre> <code class="java hljs">dependencies { ext { springBootVersion = <span class="hljs-string"><span class="hljs-string">'1.5.14.RELEASE'</span></span> <span class="hljs-comment"><span class="hljs-comment">// springBootVersion = '2.0.4.RELEASE' } compile("org.springframework.boot:spring-boot-starter-web:$springBootVersion") compile("org.springframework.boot:spring-boot-starter-actuator:$springBootVersion") // +100500      }</span></span></code> </pre> <br>  Und unser ausführbarer Code wird noch einfacher. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> tech.toparvion.sample.joker18.schedule; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.slf4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.slf4j.LoggerFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.autoconfigure.SpringBootApplication; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.scheduling.annotation.Scheduled; <span class="hljs-meta"><span class="hljs-meta">@SpringBootApplication</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnableSchedulingDemoApplication</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger log = LoggerFactory.getLogger(EnableSchedulingDemoApplication.class); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ SpringApplication.run(EnableSchedulingDemoApplication.class, args); } <span class="hljs-meta"><span class="hljs-meta">@Scheduled</span></span>(fixedRate = <span class="hljs-number"><span class="hljs-number">3000L</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doOnSchedule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ log.info(“ <span class="hljs-number"><span class="hljs-number">3</span></span>     …”); } }</code> </pre><br>  Im Allgemeinen fast nichts Bemerkenswertes, außer der einzigen Methode, an der wir die Anmerkung aufgehängt haben.  Wir haben es irgendwo kopiert und erwarten, dass es funktioniert. <br><br>  Lassen Sie uns überprüfen, wir sind Ingenieure.  Wir fangen an.  Wir gehen davon aus, dass alle drei Sekunden eine solche Nachricht protokolliert wird.  Alles sollte sofort funktionieren, wir stellen sicher, dass alles beim ersten Spring Boot gestartet wird, und wir erwarten die Ausgabe der gewünschten Zeile.  Drei Sekunden vergehen - eine Zeile wird ausgegeben, sechs Durchgänge - eine Zeile wird angezeigt.  Optimisten haben gewonnen, alles funktioniert. <br><br><img src="https://habrastorage.org/webt/ed/em/ir/edemirx8zopb5wbf193tlbbh6fi.png"><br><br>  Es ist erst an der Zeit, auf den zweiten Spring Boot zu aktualisieren.  Wir werden uns nicht darum kümmern, einfach von einem zum anderen wechseln: <br><br><pre> <code class="java hljs">dependencies { ext { <span class="hljs-comment"><span class="hljs-comment">// springBootVersion = '1.5.14.RELEASE' springBootVersion = '2.0.4.RELEASE' }</span></span></code> </pre><br>  Theoretisch hat uns der Migrationsleitfaden vor nichts gewarnt, und wir erwarten, dass alles ohne Abweichungen funktioniert.  Aus Sicht des ausführbaren Codes haben wir keinen der anderen Rakes, die ich zuvor erwähnt habe (Inkompatibilität auf API-Ebene oder etwas anderes), da die Anwendung so einfach wie möglich ist. <br><br>  Wir fangen an.  Zunächst sind wir davon überzeugt, dass wir am zweiten Spring Boot arbeiten, ansonsten gibt es anscheinend keine Abweichungen. <br><br><img src="https://habrastorage.org/webt/e4/rq/cy/e4rqcy4gms2t-cog16ru4cr8qcu.png"><br><br>  Es vergehen jedoch 3 Sekunden, 6, 9, aber es gibt immer noch keinen Herman - keine Schlussfolgerung, nichts funktioniert. <br>  Wie so oft widerspricht die Erwartung der Realität.  Sie schreiben uns oft in der Dokumentation, dass in Spring Boot tatsächlich alles sofort funktioniert, dass wir im Allgemeinen einfach so beginnen können, wie es ist, mit minimalen Problemen, und dass keine Konfiguration erforderlich ist.  Aber sobald es zur Realität kommt, stellt sich oft heraus, dass man die Dokumentation noch lesen sollte.  Insbesondere wenn Sie tief graben, finden Sie hier folgende Zeilen: <br><blockquote>  7.3.1.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Aktivieren Sie Planungsanmerkungen</a> <br>  Um die Unterstützung für Annotationen @Scheduled und Async zu aktivieren, können Sie einer Ihrer @ Configuration-Klassen @EnableScheduling und @EnableAsync hinzufügen. </blockquote>  Damit die geplante Annotation funktioniert, müssen Sie eine weitere Annotation mit einer anderen Annotation an die Klasse hängen.  Na ja, wie immer im Frühling.  Aber warum hat es vorher funktioniert?  So etwas haben wir nicht gemacht.  Offensichtlich hing diese Anmerkung irgendwo früher im ersten Spring Boot, aber jetzt ist sie aus irgendeinem Grund nicht im zweiten. <br><br><img src="https://habrastorage.org/webt/zz/7_/ar/zz7_ardj3w6--f-wefbyenp7_p0.jpeg"><br><br>  Wir beginnen, die Quellcodes des ersten Spring Boot zu durchsuchen.  Wir finden, dass es eine Klasse gibt, an der es angeblich hängt.  Wir schauen genauer hin, es heißt "MetricExportAutoConfiguration" und ist anscheinend dafür verantwortlich, diese Leistungsmetriken außerhalb an einige zentralisierte Aggregatoren zu liefern, und es hat wirklich diese Anmerkung. <br><br><img src="https://habrastorage.org/webt/mf/ya/pb/mfyapbujxbyzbumuxy2cghrs2qk.jpeg"><br><br>  Darüber hinaus funktioniert es so, dass es sein Verhalten auf einmal in die gesamte Anwendung einbezieht und nicht an separate Klassen gehängt werden muss.  Diese Klasse war der Lieferant dieses Verhaltens und tat es dann aus irgendeinem Grund nicht.  Warum? <br><br><img src="https://habrastorage.org/webt/vd/p_/fj/vdp_fjs2gqgaicooirzzwu-tjg8.jpeg"><br><br>  Trotzdem bringt uns GitHub zu einer solchen archäologischen Ausgrabung: Im Rahmen des Übergangs zur zweiten Version von Spring Boot wurde diese Klasse zusammen mit der Anmerkung gemäht.  Warum?  Ja, da sich auch die Metrics Delivery Engine geändert hat: Sie verwenden kein eigenes Skript mehr, sondern wechseln zu Micrometer - eine wirklich sinnvolle Lösung.  Das ist nur noch etwas Überflüssiges bei ihm.  Vielleicht ist das sogar richtig. <br><br>  Wer nicht lesen möchte, sieht sich 30 Sekunden lang eine kurze Demo an: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/8jNXZXdb3no" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Daraus folgt, dass, wenn wir jetzt die fehlende Anmerkung in unserer ursprünglichen Klasse nehmen und manuell aufhängen, das Verhalten theoretisch korrekt werden sollte. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> tech.toparvion.sample.joker18.schedule; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.slf4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.slf4j.LoggerFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.autoconfigure.SpringBootApplication; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.scheduling.annotation.EnableScheduling; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.scheduling.annotation.Scheduled; <span class="hljs-meta"><span class="hljs-meta">@SpringBootApplication</span></span> <span class="hljs-meta"><span class="hljs-meta">@EnableScheduling</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnableSchedulingDemoApplication</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger log = LoggerFactory.getLogger(EnableSchedulingDemoApplication.class); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ SpringApplication.run(EnableSchedulingDemoApplication.class, args); } <span class="hljs-meta"><span class="hljs-meta">@Scheduled</span></span>(fixedRate = <span class="hljs-number"><span class="hljs-number">3000L</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doOnSchedule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ log.info(“ <span class="hljs-number"><span class="hljs-number">3</span></span>     …”); } }</code> </pre><br>  Glaubst du, es wird funktionieren?  Lassen Sie uns überprüfen.  Wir fangen an. <br><br><img src="https://habrastorage.org/webt/6f/pg/ld/6fpgldlhinmkrdq6git1-dovdrg.png"><br><br>  Es ist ersichtlich, dass nach 3 Sekunden, nach 6 und nach 9 die von uns erwartete Nachricht immer noch im Protokoll angezeigt wird. <br><br><a name="scheduling_solution"></a><h3>  Wie man ist </h3><br>  Was tun in diesem speziellen und allgemeineren Fall damit?  Egal wie moralisch dies auch klingen mag, erstens lohnt es sich, nicht nur kopierte Dokumentationsfragmente zu lesen, sondern auch ein wenig weiter zu gehen, um solche Aspekte abzudecken. <br><br>  Denken Sie zweitens daran, dass in Spring Boot viele Funktionen (Scheduling, Async, Caching, ...) nicht immer enthalten sind, sondern explizit aktiviert werden müssen. <br><br>  Drittens ist es nicht wichtig, sicher zu sein: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">Fügen Sie</a> Ihrem Code <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">Enable</a> * -Anmerkungen (und deren gesamte Familie) hinzu, ohne auf ein Framework zu hoffen.  Aber dann stellt sich die Frage: Was passiert, wenn ich und meine Kollegen zufällig ein paar Anmerkungen hinzufügen, wie werden sie sich verhalten?  Das Framework selbst behauptet, dass das Duplizieren von Anmerkungen niemals zu Fehlern führt.    :  .   ,       . <br><br> , @EnableAsync  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">Enable</a> Caching  , ,  ,  ,        ,    . ,             .     ?      javadoc    ,      .  ,        .    ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">Enable</a> *,       ,    .     ?            . <br><br><a name="proxy"></a><h2> Spring Cloud &amp; Co.   </h2><br><img src="https://habrastorage.org/webt/0a/sa/qj/0asaqj87-tg2xetyig_ytjreb34.jpeg"><br><br>       Spring Boot 2   ,    Spring Cloud —      Service Discovery (   ).      JavaMelody.     -  .  , ,    JDBC,    H2. <br><br><img src="https://habrastorage.org/webt/as/fd/lb/asfdlb0f-iqfgaquxgr7bjitwpq.jpeg"><br><br>    ,      ,  JavaMelody —   ,           ,   .   dev-,  test,          -  ,  Prometheus. <br><br>      Gradle   : <br><br><pre> <code class="java hljs">dependencies { ext { springBootVersion = <span class="hljs-string"><span class="hljs-string">'2.0.4.RELEASE'</span></span> springCloudVersion = <span class="hljs-string"><span class="hljs-string">'2.0.1.RELEASE'</span></span> } compile(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot:spring-boot-starter-web:$springBootVersion"</span></span>) runtime(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot:spring-boot-starter-jdbc:$springBootVersion"</span></span>) runtime group: <span class="hljs-string"><span class="hljs-string">"org.springframework.cloud"</span></span>, name: <span class="hljs-string"><span class="hljs-string">"spring-clooud-starter-netflix-eureka-client"</span></span>, version: <span class="hljs-function"><span class="hljs-function">springCloudVersion </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runtime</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"net.bull.javamelody:javamelody-spring-boot-starter:1.72.0"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">//… }</span></span></span></span></code> </pre><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">(  )</a> <br><br>      Spring Boot —  web  jdbc,  Spring Cloud     eureka (,    ,    Service Discovery),   JavaMelody.        . <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SpringBootApplication</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HikariJavamelodyDemoApplication</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ SpringApplication.run(HikariJavamelodyDemoApplication.class, args); } }</code> </pre><br>  Wir fangen an. <br><br><img src="https://habrastorage.org/webt/uj/os/hr/ujoshrw-kj_cn72s23h5e7fjgka.jpeg"><br><br>      .      ,        ,      -  com.sun.proxy  Hikari, HikariDataSource.    ,  Hikari —      ,    Tomcat, C3P0  . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/hv/la/u9/hvlau913-05gppcoqmjfsbuzip0.jpeg" width="50%"></div><br>   ?       . <br><br><h2>   </h2><br><h3> Spring Cloud  dataSource   </h3><br>  ,  Spring Cloud   ,    dataSource (   ),  .     ,    AutoRefresh  RefreshScope —                .          .      CGLIB. <br><br>  , ,   Spring Boot     Spring    :     JDK  (    ,   )     CGLIB (   ).     BeanPostProcessor'    BeanDefinition      ,        . <br><br><h3> JavaMelody  dataSource   </h3><br>   —  JavaMelody.    DataSource  ,      ,         . JavaMelody   JDK-,      ,   .       —   BeanPostProcessor. <br><br>        ,   ,     DataSource     JDK-,    CGLIB-.    : <br><br><img src="https://habrastorage.org/webt/j8/la/aj/j8laaj9tuxuewycjnpqzuxcaxpw.png"><br><br>     .      ,         . <br><br><h3> Spring Boot  dataSource.unwrap() </h3><br>     Spring Boot,     DataSource#unwrap(),        JMX.    JDK-       (     ),  CGLIB-,   Spring Cloud,     Spring Context. ,   ,      JDK-,    CGLIB API    . <br><br>       ,     : <br><br><img src="https://habrastorage.org/webt/a4/tb/aw/a4tbawwbqhd72cn7zw-ain4zm4c.jpeg"><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://jira.spring.io/browse/SPR-17381</a> <br><br>       ,   ,     ,         .     ,     , , , -   . <br><br><img src="https://habrastorage.org/webt/ke/bn/ns/kebnnswvcy8kwtnqezvikitcdvw.jpeg"><br><br>     .       Hikari? <br><br>  ,     Hikari  -    ,   Spring Cloud    .   : Hikari       Spring Boot 2. ? -    - .   ,  Spring Cloud?   ,    -  ,       ?   .  ,       . <br><br><h3>    … </h3><br><pre> <code class="java hljs">org.springframework.cloud.autoconfigure.RefreshAutoConfiguration .RefreshScopeBeanDefinitionEnhancer: <span class="hljs-comment"><span class="hljs-comment">/** * Class names for beans to post process into refresh scope. Useful when you * don't control the bean definition (eg it came from auto-configuration). */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Set&lt;String&gt; refreshables = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;&gt;( Arrays.asList(<span class="hljs-string"><span class="hljs-string">"com.zaxxer.hikari.HikariDataSource"</span></span>));</code> </pre><br>      Spring Cloud    autoconfiguration,       Enhancer BeanDefinition',       ,      Hikari.    Spring Cloud        .       . <br><br>      ?    Spring Cloud   ,        CGLIB-.   , ,  ,  ,    -      .        (jira.spring.io/browse/SPR-17381).       BeanPostProcessor,     .      BeanDefinition       ,    BeanPostProcessor'.   Stack Overflow    ,      -  ,    , proxyTargetClass   true  false  ,   .    ,        .      . <br><br>            ,      -   ,     . <br><br>    : <br><br><ul><li>      (, Tomcat JDBC Pool) <br> spring.datasource.type=org.apache.tomcat.jdbc.pool.DataSource <br>     <br> runtime 'org.apache.tomcat:tomcat-jdbc:8.5.29' <br> Hikari ,  , ,   ,      ,      Tomcat,     Spring Boot. </li><li>   JavaMelody,   JDBC-,    . <br> javamelody.excluded-datasources=scopedTarget.dataSource </li><li>      Spring Cloud. <br> spring.cloud.refresh.enabled=false <br> ,  ,     ,    Service Discovery,       . </li></ul><br><br>      .              ,          . <br><br><a name="bonus"></a><h3>  ( *) </h3><br> *  Spring Cloud (   JavaMelody) <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-meta"><span class="hljs-meta">@ManagedResource</span></span> <span class="hljs-meta"><span class="hljs-meta">@EnableAsync</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyJmxResource</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@ManagedOperation</span></span> <span class="hljs-meta"><span class="hljs-meta">@Async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">launchLongLastingJob</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// -   } }</span></span></code> </pre><br>   : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">github.com/toparvion/joker-2018-samples/tree/master/jmx-resource</a> . <br><br>   .    ,      Spring Cloud.   JavaMelody ,    Spring-,   .       ,  ,     ,    JMX   .      -  ,      Async,    JMX-  .      JMX,      @ManagedOperation,     ,     (    Spring —    ,     OK). <br><br>      ,     ,      , , ,  myJMXResource     JMX,     .     ,          —     , CGLIB  JDK. <br><br><img src="https://habrastorage.org/webt/de/c2/bo/dec2bo6sbaa1zipyhg55jigk960.jpeg"><br><br>  JDK  CGLIB-.    ,  -   BeanPostProcessor. <br><br>  ,    BeanPostProcessor': <br> AsyncAnnotationBeanPostProcessor <br><br><ul><li> :      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">Async</a> </li><li> : org.springframework.scheduling </li><li>  :  @EnableAsync ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">Import</a> ) </li></ul><br> 2. DefaultAdvisorAutoProxyCreator <br><ul><li> :     AOP-,        </li><li> : org.springframework.aop.framework.autoproxy </li><li>  : @Configuration- PointcutAdvisorConfig (  ) </li></ul><br> DefaultAdvisorAutoProxyCreator   @Configuration-.   ,      ,   JavaMelody,             configuration-.  ,    PointcutAdvisorConfig,        . <br><br><img src="https://habrastorage.org/webt/ta/bq/lh/tabqlh0jqjk71cnajqj5trjwp10.jpeg"><br><br>   ,    .   PointcutAdvisorConfig,   AdvisorConfig,     ,  configuration-,   ,  ,  ,    ,          . <br><br>  ,     ,   ,   ,    -. <br><br><img src="https://habrastorage.org/webt/nx/hw/vk/nxhwvkroqzaw8eziviybh7ct2sk.jpeg"><br><br>       BeanPostProcessor'.        ,       ,   ,    BeanPostProcessor         .    ,         Advised (  BeanPostProcessor'),   , ,   ,     , ,   JDK-,         .      . <br><br>        .     ,     : <br><br><img src="https://habrastorage.org/webt/kz/_r/te/kz_rtesazmfb1jdrd-2cbt7_kfo.png"><br><br>       JMX     .        BeanPostProcessor.       BeanPostProcessor',        , ,   ,   ,            JAR,    ,   . <br><br><a name="proxy_solution"></a><h3>  Wie man ist </h3><br> -,       ,   Spring AOP,  , .  « »?        ,  -       Advice  Advisor,      ,       . <br><br> -,    best practices. ,          JMX-  ,       .  - ,       , ,     .      ,   autowire' ()     .     .  ,    ,    - .           <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">Order</a> ,     .  ,   ,     , ..     proxyTargetClass,   . <br><br> :     ,   . -, «Keep calm and YAGNI».   ,                .  « »,      - , -   ,    ,       ,   .     ,  ,       :    -,   ,       —  ,    .          . , Spring    ,      ,    .        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">tolkkv</a> ,   ,      436- ,   .      ,      . <br><br><a name="relax"></a><h2> Relax Binding.    ()  </h2><br>   ,    . <br><br><img src="https://habrastorage.org/webt/ry/xw/mv/ryxwmvrfnmzbmona2o3vys4yqim.jpeg"><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://docs.spring.io/spring-boot/docs/2.0.5.RELEASE/reference/htmlsingle/#boot-features-external-config-relaxed-binding</a> <br><br>    ,  Relax Binding  Spring Boot.       -         . ,      -   firstName   ,       acme.my-project.person,  Spring Boot      .        :  camel case,  ,     ,  -  —       firstName.      Relax Binding. <br><br>      Spring Boot'    ,   ,          —        . ,  ,   ,     : <br><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">github.com/spring-projects/spring-boot/wiki/Spring-Boot-2.0-Migration-Guide#relaxed-binding</a> ( 1 ) </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">docs.spring.io/spring-boot/docs/2.0.5.RELEASE/reference/htmlsingle/#boot-features-external-config-relaxed-binding</a> ( 3 ) </li><li> <a href="">github.com/spring-projects/spring-boot/wiki/Relaxed-Binding-2.0</a> ( 4 ) </li></ul><br>   ,  ,  .  - . ,      . <br><br>  Zum Beispiel: <br><br><pre> <code class="java hljs">dependencies { ext { springBootVersion = <span class="hljs-string"><span class="hljs-string">'1.5.4.RELEASE'</span></span> } compile(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot:spring-boot-starter:$springBootVersion"</span></span>) }</code> </pre><br> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">  </a> ) <br><br>       - ,   web,   Spring Boot,         -  . <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SpringBootApplication</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RelaxBindingApplication</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationRunner</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger log = LoggerFactory.getLogger(RelaxBindingDemoApplication.class); <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SecurityProperties securityProperties; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ SpringApplication.run(RelaxBindingDemoApplication.class, args); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> main </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ApplicationArguments args)</span></span></span><span class="hljs-function"> </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"KEYSTORE TYPE IS: {}"</span></span>, securityProperties.getKeyStoreType()); } }</code> </pre><br>  ,    POJO- ( )        ,    KEYSTORE TYPE.  POJO          ,      applications.properties  application.yaml,  . <br><br>      keystoreType,     private String keystoreType,      applications.properties: security.keystoreType=jks. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-meta"><span class="hljs-meta">@ConfigurationProperties</span></span>(prefix = <span class="hljs-string"><span class="hljs-string">"security"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SecurityProperties</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String keystorePath; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String keystoreType; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getKeystorePath</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> keystorePath; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setKeystorePath</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String keystorePath)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.keystorePath = keystorePath; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getKeyStoreType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> keystoreType; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setKeystoreType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String keystoreType)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.keystoreType = keystoreType; } }</code> </pre><br>     Spring Boot     . <br><br><img src="https://habrastorage.org/webt/ya/fn/kg/yafnkgxoaoudil70xnvdw1q_hhc.jpeg"><br><br>  ,  ,  ,  .      ,      . <br><br><img src="https://habrastorage.org/webt/qz/1b/s6/qz1bs6ydorm1cfaej8lcfzvxc84.jpeg"><br><br>      ,   .   ,   ,  ,    -   ,       , - key-store-type.        ,    ,        ,     . <br><br>       .    ,      . <br><br><img src="https://habrastorage.org/webt/kf/8j/8e/kf8j8eytzsayh7xarx_dx_kaedy.jpeg"><br><br>     .      2  ,   ,   .           Java   properties —  ,    .    , , ,     ,    ,      .   —      Java bean       .   ,    ,  .       ,   «keystore»  ,    : «Key»  «Store». … <br><br><img src="https://habrastorage.org/webt/9-/ak/rw/9-akrwm5gftlarfdvte2s1hqkas.jpeg"><br><br>  ,    ,    ? . <br><br> ,    ,    Relax Binding    (   getStoreType()).   ,     . ,         .    ,  keyStoreType,   . ,       Relax Binding,    ,        ,    . <br><br>  ,   -  ,  -   ,     .      ,     .         : <br><br><img src="https://habrastorage.org/webt/ll/s_/c2/lls_c2hpqhq6ea7eooc_bf65c_u.jpeg"><br><br>        ,  -    ,    ,   , ,     -,         .        . <br><br><a name="relax_solution"></a><h3>  Wie man ist </h3><br>        :       - . -,   ,     dev-   , ,  YAML  properties,    —      ,    ,    . -,     <a href="">c   </a> ,       Relax Binding,    .  , , ,     Spring Boot   . <br><br><a name="unit"></a><h2> Unit Testing.    Mockito 2 </h2><br>    ,    -     ,        Mockito. <br><br> Mockito    ,        Spring Boot Starter,      Spring,        Mockito. <br><br><pre> <code class="plaintext hljs">$gradle -q dependencyInsight --configuration testCompile --dependency mockito org.mockito:mockito-core:2.15.0 variant "runtime" /--- org.springframework.boot:spring-boot-starter-test:2.0.2.RELEASE /---testCompile</code> </pre><br>     ?      .    Spring Boot  Mockito   ,    1.5.2 Spring Boot     Mockito 2,      .     -  .         Mockito 2. <br><br>  Mockito   ,    2016-   Mockito 2.0  Mockito.2.1—      :  Java 8    ,     Hamcrest     - .   ,     ,     . <br><br>     ,           ,     (  ) . <br><br><img src="https://habrastorage.org/webt/5a/yt/fo/5aytfoqxgbx4crbjwmngut1dh1i.jpeg"><br><br> ,       ,     JButton  Swing,    null,   ,     -  .   , string'   null,   , null   instanceof  string.  ,  Mockito 1     ,  Mockito 2          ,  anyString  null   ,        ,       .      :      null,     .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="> </a> ,  ,         ,     Mockito 1. <br><br>  ,   , . <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setTarget</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object target)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//… } } &lt;hr/&gt; @Test public void testAnyStringMatcher() { MyService myServiceMock = mock(MyService.class); myServiceMock.setTarget(new JButton()); verify(myServiceMock).setTarget(anyString()); }</span></span></code> </pre><br> ,        ,   .                 JButton.       anyString.  ,   :   ,     —    .   ,       .    -       10-    ,        .  Mockito 1   ,     : <br><br><img src="https://habrastorage.org/webt/ts/_s/cd/ts_scdhl4ikfptceteyv-plex0o.png"><br><br> Mockito 2    , ,   , anyString     : <br><br><img src="https://habrastorage.org/webt/db/tw/ec/dbtwecp6onmr9f_r4k-ufverzb8.jpeg"><br><br>     .   ,    . ,        ,      ,         ,         SocketTimeoutException,       -   .          ,  SocketTimeoutException ,  .         Mockito 1. <br><br><img src="https://habrastorage.org/webt/2b/nc/9d/2bnc9dqcfgkh7htm6-tiih1mf38.png"><br><br>   Mockito 2        ,        : <br><br><img src="https://habrastorage.org/webt/41/ya/uh/41yauhpileynqw_fqvdisk26h_k.jpeg"><br><br>   ,  Mockito 1    ,     ,        .      new SocketTimeoutException   new,  constructor,  Mockito 1   . <br><br>  Was tun?    , ,  RuntimeException,       ,    Mockito     . <br><br>    .    ,       .       compile-time. -     ,     Hamcrest.  Spring Boot,  Mockito 1     @MockBean  @SpyBean.        ,    Spring Integration,         review. <br> (: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://docs.spring.io/spring-integration/docs/5.0.0.RELEASE/reference/htmlsingle/#testing</a> ) <br><br><h3>  Wie man ist </h3><br>     ,   ,      Mockito 1,      Mockito 2 ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">dzone.com/refcardz/mockito</a> ). <br><br> -,      ,     ,    Spring Boot 1.5.2  Mockito 2. <br><br> -, ,    ,    Mockito 2,          : <a href=""></a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a> . <br><br><a name="gradle"></a><h2> Gradle Plugin.  Spring Boot  </h2><br> ,     , —  Spring Boot-  Gradle. <br><br>   Migration Guide ,  Spring Boot   Gradle   .  ,  .  :    Gradle 4  (,    settings.gradle   ).       dependency management plugin,    .    bootRepackage,  ,   :  bootWar  bootJar.     bootJar     . <br><br>  bootJar: <br><br><ul><li>  ,    org.springframework.boot  java; </li><li>   jar; </li><li>   mainClassName (    )   (  ,  -  ). </li></ul><br>  ,    ,      —   ,   ,   Gradle,     Spring Boot. <br><br>     ?   -    Spring Boot 2, , ,  Gradle 4      Spring Boot-.     ,     ,  :      ,  ,     (    ,     ). <br><br><img src="https://habrastorage.org/webt/kb/uh/y4/kbuhy4rtm7yyl_zjp2ij62wavoq.jpeg"><br><br>   ,   .    app1 ,    app2, app3  . .  app1    lib. <br><br><h3> «Show me the code!» </h3><br>   <br><br><pre> <code class="java hljs">subprojects { repositories { mavenCentral() } apply plugin: <span class="hljs-string"><span class="hljs-string">'java'</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">'org.springframework.boot'</span></span> }</code> </pre><br>         —   : java   Spring Boot   . <br><br> ,   ,       ,   .      ,        ,     ,     .       . <br><br> app1:   <br><br><pre> <code class="java hljs">dependencies { ext { springBootVersion = <span class="hljs-string"><span class="hljs-string">'2.0.4.RELEASE'</span></span> } compile(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot:spring-boot-starter:$springBootVersion"</span></span>) <span class="hljs-function"><span class="hljs-function">compile </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">project</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">':lib'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> }</span></span></code> </pre><br>          lib  ,   Spring Boot-. <br><br> app1:   <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SpringBootApplication</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GradlePluginDemoApplication</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationRunner</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//… @Override public void run(ApplicationArguments args) { String appVersion = Util.getAppVersion(getClass()); log.info("Current application version: {}", appVersion); } }</span></span></code> </pre><br>         Util,     . <br><br> lib:   <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Util</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAppVersion</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Class&lt;?&gt; appClass)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> appClass.getPackage().getImplementationVersion(); } }</code> </pre><br>   Util   getAppVersion    ,    ,  ImplementationVersion   .        . <br><br><img src="https://habrastorage.org/webt/jc/ax/ur/jcaxur0f1_-yhxot9uvkfsf3fos.jpeg"><br><br>      IDE,   ,    ,     .    gradle build  IDE ,   .         Util.  ,  ,    ,      ,       . <br><br><a name="gradle_solution"></a><h3>   </h3><br> : <br><br><ul><li> bootJar   jar; </li><li> Gradle        jar. </li></ul><br> : <ul><li>       ; </li><li>   ,    jar (  ImplementationVersion), . </li></ul><br>    ?   :        . <br><br><img src="https://habrastorage.org/webt/dz/lr/p8/dzlrp85l4z8wsgc12ttn7cwsqec.jpeg"><br><br>       Spring Boot-   , ,   lib    .     . <br><br>  2:  SB Gradle Plugin   Spring Boot- <br><br><pre> <code class="java hljs">bootJar { enabled = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }</code> </pre><br>    ,      -   ,    , ,    , ,      bootJar   . ,    jar  ,       . <br><br><a name="other"></a><h2>  Andere </h2><br>  , ,      ,      Spring Boot.       . <br><br><img src="https://habrastorage.org/webt/xm/8w/kx/xm8wkxoaoc2ujoy0kicwn5v2n9w.jpeg"><br><br>  Spring Boot        :       web-,       ,    .    - ,       ,  Spring Boot properties migrator,      ,  ,        .      ,     ,     -,        . <br><br>      Actuator.  ,       ()  ,      Spring Security.       . <br><br><img src="https://habrastorage.org/webt/hv/sl/d4/hvsld4a0hcak8jvs3rbwsbugi00.jpeg"><br><br>  Spring Cloud   .   ,        .   ,  Netflix  Feign. <br><br><img src="https://habrastorage.org/webt/lu/a5/6l/lua56loq0hsapwtgkstpf0_7ik0.jpeg"><br><br>  Spring Integration,     ,   Spring Framework,   .     —  ,    Java DSL      , ,        .   ,       ,   ,      ,        handle    handleWithAdapter. <br><br><a name="summary"></a><h2> .    </h2><br> ,    ,     : <br><br><img src="https://habrastorage.org/webt/ww/ob/aq/wwobaqaf8ncw8fsfowcbdvipbvu.jpeg"><br><br>   ,   , , Web,       . <br><br>  (Properties Binding),   ,       ,    Relax Binding. <br><br>  — ,     :   , AOP  ,        ,   Spring Boot 2     . <br><br> , , ,  —   ,     Mockito 1  Mockito 2.    -  ,     ? <br><br><ul><li>  « » (YAGNI) </li><li>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">;</a> </li><li>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Migration Guide</a> ; </li><li>   : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a> </li></ul><br> -,   ,         ,     ,    YAGNI.   ,    -  ,     .  ,  ,     . <br><br> -,   - - ,     ,   ,     .     ,      ,  , ,       .           Migration Guide.  ,         ,   ,       ,  ,          . <br><br>     ,             Spring Boot. ,                 Spring Boot,     ,       …    . <br><blockquote>    ,  : <b>5-6   </b>  <b>JPoint</b> ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="> </a>  Spring Boot:      Spring Boot-  Java 8  Java 11.    — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="> </a> . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de439796/">https://habr.com/ru/post/de439796/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de439786/index.html">Übersicht über das IP-Telefon Snom D712 (und ein wenig D710)</a></li>
<li><a href="../de439788/index.html">Eine weitere Kuriosität bei den Algorithmen GOST Grasshopper und Stribog</a></li>
<li><a href="../de439790/index.html">Testen Sie JaCarta WebClient oder bewahren Sie Token in einem Safe auf</a></li>
<li><a href="../de439792/index.html">Die NASA sucht nach Partnern in der amerikanischen Industrie, um eine teilweise wiederverwendbare bemannte Landung zu schaffen</a></li>
<li><a href="../de439794/index.html">Rückenschmerzen - Verständnis aus Sicht der modernen Medizin</a></li>
<li><a href="../de439804/index.html">Zen des Unit Testing</a></li>
<li><a href="../de439806/index.html">Gültige SSL-Domänennamen für lokale Docker-Container</a></li>
<li><a href="../de439808/index.html">Die größten Teleskope. Von Notebook und Augen bis hin zu 340-Megapixel-Kameras und Rechenzentren. Teil 1</a></li>
<li><a href="../de439810/index.html">Lernen Sie das Moleculer Microservice Framework kennen</a></li>
<li><a href="../de439812/index.html">Kaggle-Ansätze für CV in Prod: Sie können nicht implementieren, um zu schneiden</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>