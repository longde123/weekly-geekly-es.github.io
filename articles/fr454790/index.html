<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéç üßõüèæ üé• Image native Java: v√©rification de l'utilisabilit√© üèúÔ∏è üíÆ üôéüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il n'y a pas si longtemps, Oracle a publi√© la premi√®re version du projet GraalVM (https://www.graalvm.org/). Le num√©ro 19.0.0 a √©t√© imm√©diatement attr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Image native Java: v√©rification de l'utilisabilit√©</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454790/"><img src="https://habrastorage.org/webt/ge/3k/12/ge3k12jjimph6xn8zteg9n3olqo.jpeg"><br><br>  Il n'y a pas si longtemps, Oracle a publi√© la premi√®re version du projet GraalVM (https://www.graalvm.org/).  Le num√©ro 19.0.0 a √©t√© imm√©diatement attribu√© √† la version, apparemment afin de convaincre que le projet est mature et pr√™t √† √™tre utilis√© dans des applications s√©rieuses.  L'une des parties de ce projet: <a href="">Substrate VM</a> est un framework qui vous permet de transformer des applications Java en fichiers ex√©cutables natifs (ainsi que des biblioth√®ques natives pouvant √™tre connect√©es dans des applications √©crites, par exemple, en C / C ++).  Cette fonctionnalit√© a jusqu'√† pr√©sent √©t√© d√©clar√©e exp√©rimentale.  Il convient √©galement de noter que les applications Java natives ont certaines limites: vous devez r√©pertorier toutes les ressources utilis√©es pour les inclure dans le programme natif;  vous devez lister toutes les classes qui seront utilis√©es avec r√©flexion et autres restrictions.  Une liste compl√®te est donn√©e ici par <a href="">Native Image Java Limitations</a> .  Apr√®s avoir √©tudi√© cette liste, il est compr√©hensible en principe que les restrictions ne soient pas si importantes qu'il serait impossible de d√©velopper des applications plus complexes que les mots infernaux.  J'ai fix√© cet objectif: d√©velopper un petit programme qui a un serveur web int√©gr√©, utilise une base de donn√©es (via la biblioth√®que ORM) et se compile en un binaire natif qui peut fonctionner sur des syst√®mes sans machine Java install√©e. <br><a name="habracut"></a><br>  J'exp√©rimenterai sur Ubuntu 19.04 (processeur Intel Core i3-6100 √† 3,70 GHz √ó 4). <br><br><h2>  Installer GraalVM </h2><br>  L'installation de GraalVM s'effectue facilement √† l'aide de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SDKMAN</a> .  Commande d'installation de GraalVM: <br><br><pre><code class="bash hljs">sdk install java 19.0.0-grl</code> </pre> <br>  OpenJDK GraalVM CE 19.0.0 sera install√©, CE est Community Edition.  Il existe √©galement Enterprise Edition (EE), mais cette √©dition doit √™tre t√©l√©charg√©e √† partir d'Oracle Technology Network, le lien se trouve sur la page <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">T√©l√©chargements GraalVM</a> . <br><br>  Apr√®s avoir install√© GraalVM, d√©j√† en utilisant le gestionnaire de mise √† jour des composants gu de GraalVM, j'ai install√© le support de compilation dans le binaire natif - <br><br><pre> <code class="bash hljs">gu install native-image</code> </pre> <br>  Tout, les outils de travail sont pr√™ts, vous pouvez maintenant commencer √† d√©velopper des applications. <br><br><h2>  Application native simple </h2><br>  En tant que syst√®me de build, j'utilise Maven.  Pour cr√©er des binaires natifs, il existe un plugin maven: <br><br><div class="spoiler">  <b class="spoiler_title">native-image-maven-plugin</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugins</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugin</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>com.oracle.substratevm<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>native-image-maven-plugin<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>${graal.version}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">executions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">execution</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">goals</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">goal</span></span></span><span class="hljs-tag">&gt;</span></span>native-image<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">goal</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">goals</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">phase</span></span></span><span class="hljs-tag">&gt;</span></span>package<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">phase</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">execution</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">executions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">imageName</span></span></span><span class="hljs-tag">&gt;</span></span>nativej<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">imageName</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">buildArgs</span></span></span><span class="hljs-tag">&gt;</span></span> --no-server <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">buildArgs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugin</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugins</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>  Il est toujours n√©cessaire de d√©finir la classe principale de l'application.  Cela peut √™tre fait √† la fois dans native-image-maven-plugin, et de mani√®re traditionnelle, via: <br><br><div class="spoiler">  <b class="spoiler_title">plugin maven-jar</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugin</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.apache.maven.plugins<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>maven-jar-plugin<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>2.4<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">archive</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">manifest</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mainClass</span></span></span><span class="hljs-tag">&gt;</span></span>nativej.Startup<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mainClass</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">manifest</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">archive</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugin</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>  Cr√©ez la classe principale: <br><br><div class="spoiler">  <b class="spoiler_title">Startup.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Startup</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ System.out.println(<span class="hljs-string"><span class="hljs-string">"Hello world!"</span></span>); } }</code> </pre><br></div></div><br>  Vous pouvez maintenant ex√©cuter la commande maven pour cr√©er l'application: <br><br><pre> <code class="bash hljs">mvn clean package</code> </pre> <br>  La cr√©ation d'un binaire natif sur ma machine prend 35 secondes.  En cons√©quence, dans le r√©pertoire cible, un fichier binaire de taille 2,5 Mo est obtenu.  Le programme ne n√©cessite pas la machine Java install√©e et s'ex√©cute sur les machines o√π Java est manquant. <br><br>  Lien vers le r√©f√©rentiel: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Github: native-java-helloworld-demo</a> . <br><br><h2>  Pilote JDBC Postgres </h2><br>  Et donc, une application simple fonctionne, affiche ¬´Bonjour tout le monde¬ª.  Aucune solution n'√©tait n√©cessaire.  J'essaierai d'aller un niveau plus haut: je connecterai le pilote Postgres JDBC pour demander des donn√©es √† la base de donn√©es.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Les probl√®mes</a> sur le github GraalVM rencontrent des bogues li√©s au pilote Postgres, mais sur les versions candidates de GraalVM.  Tous sont marqu√©s comme fixes. <br><br>  Je connecte la d√©pendance postgresql: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.postgresql<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>postgresql<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>42.2.5<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  J'√©cris le code pour extraire les donn√©es de la base de donn√©es (la plaque utilisateur la plus simple a √©t√© cr√©√©e): <br><br><div class="spoiler">  <b class="spoiler_title">Startup.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Startup</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> SQLException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> PGSimpleDataSource ds = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PGSimpleDataSource(); ds.setUrl(<span class="hljs-string"><span class="hljs-string">"jdbc:postgresql://localhost/demo_nativem"</span></span>); ds.setUser(<span class="hljs-string"><span class="hljs-string">"test"</span></span>); ds.setPassword(<span class="hljs-string"><span class="hljs-string">"test"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> ( Connection conn = ds.getConnection(); Statement stmt = conn.createStatement(); ResultSet rs = stmt.executeQuery(<span class="hljs-string"><span class="hljs-string">"SELECT * FROM \"public\".\"user\""</span></span>); ) { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(rs.next()){ System.out.print(<span class="hljs-string"><span class="hljs-string">"ID: "</span></span> + rs.getLong(<span class="hljs-string"><span class="hljs-string">"id"</span></span>)); System.out.println(<span class="hljs-string"><span class="hljs-string">", Name: "</span></span> + rs.getString(<span class="hljs-string"><span class="hljs-string">"name"</span></span>)); } } } }</code> </pre><br></div></div><br>  Je r√©cup√®re le binaire natif et re√ßois imm√©diatement une erreur de build: <br><br> <code>Error: No instances are allowed in the image heap for a class that is initialized or reinitialized at image runtime: org.postgresql.Driver. Try marking this class for build-time initialization with --initialize-at-build-time=org.postgresql.Driver <br></code> <br><br>  Le fait est que le g√©n√©rateur d'application natif initialise tous les champs statiques pendant le processus de g√©n√©ration (sauf indication contraire), et il le fait en examinant les d√©pendances des classes.  Mon code ne fait pas r√©f√©rence √† org.postgresql.Driver, donc le collecteur ne sait pas comment l'initialiser mieux (lors de la construction ou au d√©marrage de l'application) et propose de l'enregistrer pour l'initialisation lors de la g√©n√©ration.  Cela peut √™tre fait en l'ajoutant aux arguments maven du plugin native-image-maven-plugin, comme indiqu√© dans la description de l'erreur.  Apr√®s avoir ajout√© le pilote, j'obtiens la m√™me erreur li√©e √† org.postgresql.util.SharedTimer.  Encore une fois, je collecte et rencontre une telle erreur de construction: <br><br> <code>Error: Class initialization failed: org.postgresql.sspi.SSPIClient <br></code> <br><br>  Il n'y a aucune recommandation de correction.  Mais, en regardant la source de la classe, il est clair qu'elle se rapporte √† l'ex√©cution de code sous Windows.  Sous Linux, son initialisation (qui se produit lors de l'assemblage) √©choue avec une erreur.  Il est possible de retarder son initialisation au d√©marrage de l'application: --initialize-at-run-time = org.postgresql.sspi.SSPIClient.  L'initialisation sous Linux ne se produira pas et nous n'obtiendrons plus d'erreurs li√©es √† cette classe.  Construire des arguments: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">buildArgs</span></span></span><span class="hljs-tag">&gt;</span></span> --no-server --no-fallback --initialize-at-build-time=org.postgresql.Driver --initialize-at-build-time=org.postgresql.util.SharedTimer --initialize-at-run-time=org.postgresql.sspi.SSPIClient <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">buildArgs</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  L'assemblage a commenc√© √† prendre 1 minute 20 secondes et le fichier a gonfl√© jusqu'√† 11 Mo.  J'ai ajout√© un indicateur suppl√©mentaire pour la construction du binaire: --no-fallback interdit de g√©n√©rer un binaire natif qui n√©cessite une machine Java install√©e.  Un tel binaire est cr√©√© si le collecteur d√©tecte l'utilisation de fonctionnalit√©s de langage qui ne sont pas prises en charge dans la machine virtuelle de substrat ou n√©cessitent une configuration, mais il n'y a pas encore de configuration.  Dans mon cas, le collectionneur a d√©couvert l'utilisation potentielle de la r√©flexion dans le pilote JDBC.  Mais ce n'est qu'une utilisation potentielle, ce n'est pas requis dans mon programme, et donc, une configuration suppl√©mentaire n'est pas requise (comment le faire sera montr√© plus tard).  Il y a aussi le drapeau --static, qui force le g√©n√©rateur √† lier statiquement libc.  Mais si vous l'utilisez, le programme se bloque avec une erreur de segmentation lorsque vous essayez de r√©soudre le nom du r√©seau en une adresse IP.  J'ai cherch√© des solutions √† ce probl√®me, mais je n'ai rien trouv√© de convenable, j'ai donc laiss√© la d√©pendance du programme sur libc. <br><br>  J'ex√©cute le binaire r√©sultant et j'obtiens l'erreur suivante: <br><br> <code>Exception in thread "main" org.postgresql.util.PSQLException: Could not find a java cryptographic algorithm: TLS SSLContext not available. <br></code> <br><br>  Apr√®s quelques recherches, la cause de l'erreur a √©t√© identifi√©e: Postgres, par d√©faut, √©tablit une connexion TLS √† l'aide de la courbe elliptique.  SubstrateVM n'inclut pas la mise en ≈ìuvre de tels algorithmes pour TLS, voici le probl√®me ouvert correspondant - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Prise en charge TLS ECC simple-binaire (ECDSA / ECDHE) pour SubstrateVM</a> .  Il existe plusieurs solutions: placer la biblioth√®que du package GraalVM: libsunec.so √† c√¥t√© de l'application, configurer la liste des algorithmes sur le serveur Postgres, exclure les algorithmes Elliptic Curve ou tout simplement d√©sactiver la connexion TLS dans le pilote Postgres (cette option a √©t√© choisie): <br><br><pre> <code class="java hljs">dataSource.setSslMode(SslMode.DISABLE.value);</code> </pre><br>  Ayant √©limin√© l'erreur de cr√©er une connexion avec Postgres, je lance l'application native, elle s'ex√©cute et affiche les donn√©es de la base de donn√©es. <br><br>  Lien vers le r√©f√©rentiel: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Github: native-java-postgres-demo</a> . <br><br><h2>  Infrastructure DI et serveur Web int√©gr√© </h2><br>  Lors du d√©veloppement d'une application Java complexe, ils utilisent g√©n√©ralement une sorte de framework, par exemple Spring Boot.  Mais √† en juger par cet article sur la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">prise</a> en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">charge des images natives GraalVM</a> , le travail de Spring Boot dans l'image native ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pr√™te √†</a> l'emploi¬ª ne nous est promis que dans la version de Spring Boot 5.3. <br><br>  Mais il existe un merveilleux framework <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Micronaut</a> qui <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pr√©tend fonctionner dans l'image native GraalVM</a> .  En g√©n√©ral, la connexion d'un Micronaut √† une application qui sera assembl√©e dans un binaire ne n√©cessite aucun r√©glage sp√©cial ni r√©solution de probl√®me.  En effet, de nombreux param√®tres d'utilisation des ressources de r√©flexion et de connexion pour la VM Substrate sont d√©j√† d√©finis dans Micronaut.  Soit dit en passant, les m√™mes param√®tres peuvent √™tre plac√©s dans votre application dans le fichier de param√®tres META-INF / native-image / $ {groupId} / $ {artifactId} /native-image.properties (un tel chemin pour le fichier de param√®tres est recommand√© par Substrate VM), voici un exemple typique contenu du fichier: <br><br><div class="spoiler">  <b class="spoiler_title">native-image.properties</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">Args = \ -H:+ReportUnsupportedElementsAtRuntime \ -H:ResourceConfigurationResources=${.}/resource-config.json \ -H:ReflectionConfigurationResources=${.}/reflect-config.json \ -H:DynamicProxyConfigurationResources=${.}/proxy-config.json \ --initialize-at-build-time=org.postgresql.Driver \ --initialize-at-build-time=org.postgresql.util.SharedTimer \ --initialize-at-run-time=org.postgresql.sspi.SSPIClient</code> </pre><br></div></div><br>  Les fichiers resource-config.json, reflect-config.json, proxy-config.json contiennent les param√®tres de connexion des ressources, de la r√©flexion et des proxys utilis√©s (Proxy.newProxyInstance).  Ces fichiers peuvent √™tre cr√©√©s manuellement ou r√©cup√©r√©s en utilisant agentlib: native-image-agent.  Dans le cas de l'utilisation de l'agent d'image native, vous devez ex√©cuter le fichier jar habituel (et non le binaire natif) √† l'aide de l'agent: <br><br><pre> <code class="bash hljs">java -agentlib:native-image-agent=config-output-dir=output -jar my.jar</code> </pre><br>  o√π sortie est le r√©pertoire o√π les fichiers d√©crits ci-dessus seront situ√©s.  Dans ce cas, le programme doit non seulement ex√©cuter, mais √©galement ex√©cuter des scripts dans le programme, car les param√®tres sont √©crits dans les fichiers lorsque vous utilisez la r√©flexion, ouvrez les ressources, cr√©ez un proxy.  Ces fichiers peuvent √™tre plac√©s META-INF / native-image / $ {groupId} / $ {artifactId} et r√©f√©renc√©s dans native-image.properties. <br><br>  J'ai d√©cid√© de connecter la journalisation √† l'aide de logback: j'ai ajout√© une d√©pendance √† la biblioth√®que logback-classic et au fichier logback.xml.  Apr√®s cela, j'ai compil√© un pot r√©gulier et l'ai ex√©cut√© en utilisant natif-image-agent.  √Ä la fin du programme, les fichiers de param√®tres n√©cessaires.  Si vous regardez leur contenu, vous pouvez voir que l'agent a enregistr√© l'utilisation de logback.xml pour compiler dans le binaire.  De plus, le fichier r√©flexion-config.json contient tous les cas d'utilisation de la r√©flexion: pour des classes donn√©es, les m√©ta-informations entreront dans le binaire. <br><br>  Ensuite, j'ai ajout√© une d√©pendance √† la biblioth√®que micronaut-http-server-netty pour utiliser le serveur Web int√©gr√© bas√© sur netty et cr√©√© un contr√¥leur: <br><br><div class="spoiler">  <b class="spoiler_title">Startup.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Controller</span></span>(<span class="hljs-string"><span class="hljs-string">"/hello"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HelloController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Get</span></span>(<span class="hljs-string"><span class="hljs-string">"/{name}"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Produces</span></span>(MediaType.TEXT_PLAIN) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> HttpResponse&lt;String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HttpResponse.ok(<span class="hljs-string"><span class="hljs-string">"Hello "</span></span> + name); } }</code> </pre><br></div></div><br>  Et classe principale: <br><br><div class="spoiler">  <b class="spoiler_title">HelloController.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Startup</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ Signal.handle(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Signal(<span class="hljs-string"><span class="hljs-string">"INT"</span></span>), sig -&gt; System.exit(<span class="hljs-number"><span class="hljs-number">0</span></span>)); Micronaut.run(Startup.class, args); } }</code> </pre><br></div></div><br>  Vous pouvez maintenant essayer de cr√©er un binaire natif.  Mon montage a pris 4 minutes.  Si vous l'ex√©cutez et acc√©dez √† l'adresse <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http: // localhost: 8080 / hello / user,</a> une erreur se produit: <br><br><pre> <code class="plaintext hljs">{"_links":{"self":{"href":"/hello/user","templated":false}},"message":"More than 1 route matched the incoming request. The following routes matched /hello/user: GET - /hello/user, GET - /hello/user"}</code> </pre><br>  Honn√™tement, il n'est pas enti√®rement clair pourquoi cela se produit, mais apr√®s l'avoir pouss√©, j'ai constat√© que l'erreur dispara√Æt si les lignes suivantes sont supprim√©es du fichier resource-config.json (qui a √©t√© cr√©√© par l'agent): <br><br><pre> <code class="plaintext hljs"> {"pattern":"META-INF/services/com.fasterxml.jackson.databind.Module"}, {"pattern":"META-INF/services/io.micronaut.context.env.PropertySourceLoader"}, {"pattern":"META-INF/services/io.micronaut.http.HttpResponseFactory"}, {"pattern":"META-INF/services/io.micronaut.inject.BeanConfiguration"}, {"pattern":"META-INF/services/io.micronaut.inject.BeanDefinitionReference"},</code> </pre><br>  Micronaut enregistre ces ressources et il semble que le r√©enregistrement entra√Æne un double enregistrement de mon contr√¥leur et une erreur.  Si apr√®s avoir corrig√© le fichier, vous reconstruisez le binaire et l'ex√©cutez, il n'y aura plus d'erreurs, le texte ¬´Hello user¬ª s'affichera sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http: // localhost: 8080 / hello / user</a> . <br><br>  Je veux attirer l'attention sur l'utilisation de la ligne suivante dans la classe principale: <br><br><pre> <code class="java hljs">Signal.handle(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Signal(<span class="hljs-string"><span class="hljs-string">"INT"</span></span>), sig -&gt; System.exit(<span class="hljs-number"><span class="hljs-number">0</span></span>));</code> </pre><br>  Il doit √™tre ins√©r√© pour que Micronaut se termine correctement.  Malgr√© le fait que Micronaut accroche un crochet pour l'arr√™ter, cela ne fonctionne pas dans le binaire natif.  Il y a un probl√®me correspondant: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Shutdownhook ne tire pas avec le natif</a> .  Il est marqu√© comme fixe, mais, en fait, il n'a qu'une solution de contournement utilisant la classe Signal. <br><br>  Lien vers le r√©f√©rentiel: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Github: native-java-postgres-micronaut-demo</a> . <br><br><h2>  Connexion ORM </h2><br>  JDBC est bon, mais se fatigue de code r√©p√©titif, de SELECT et UPDATE sans fin.  J'essaierai de faciliter (ou de compliquer, selon le c√¥t√© √† regarder) ma vie en connectant une sorte d'ORM. <br><br><h4>  Hibernate </h4><br>  Au d√©but, j'ai d√©cid√© d'essayer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Hibernate</a> , car il s'agit de l'un des ORM les plus courants pour Java.  Mais je n'ai pas r√©ussi √† cr√©er une image native en utilisant Hibernate en raison d'une erreur de construction: <br><br><pre> <code class="plaintext hljs">Error: Field java.lang.reflect.Method.defaultValue is not present on type java.lang.reflect.Constructor. Error encountered while analysing java.lang.reflect.Method.getDefaultValue() Parsing context: parsing org.hibernate.annotations.common.annotationfactory.AnnotationProxy.getAnnotationValues(AnnotationProxy.java:63) parsing org.hibernate.annotations.common.annotationfactory.AnnotationProxy(AnnotationProxy.java:52) ...</code> </pre><br>  Il existe un probl√®me ouvert correspondant: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">[native-image] Micronaut + Hibernate entra√Æne une erreur rencontr√©e lors de l'analyse de java.lang.reflect.Method.getDefaultValue ()</a> . <br><br><h4>  jOOQ </h4><br>  J'ai alors d√©cid√© d'essayer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">jOOQ</a> .  J'ai r√©ussi √† construire un binaire natif, mais j'ai d√ª faire beaucoup de param√®tres: sp√©cifier les classes √† initialiser (buildtime, runtime) et jouer avec la r√©flexion.  Au final, tout se r√©sume au fait que lorsque l'application d√©marre, jOOQ initialise le proxy org.jooq.impl.ParserImpl $ Ignore en tant que membre statique de la classe org.jooq.impl.Tools.  Et ce proxy utilise MethodHandle, que Substrate VM <a href="">ne prend pas encore en charge</a> .  Voici un probl√®me ouvert similaire: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">[native-image] Micronaut + Kafka ne parvient pas √† cr√©er une image native avec l'argument MethodHandle n'a pas pu √™tre r√©duit √† tout au plus un seul appel</a> . <br><br><h4>  Apache cayenne </h4><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Apache Cayenne est</a> moins commun, mais semble assez fonctionnel.  Je vais essayer de le connecter.  J'ai cr√©√© des fichiers XML pour d√©crire le sch√©ma de la base de donn√©es, ils peuvent √™tre cr√©√©s manuellement ou √† l'aide de l'outil GUI CayenneModeler, ou bas√©s sur une base de donn√©es existante.  En utilisant le plugin cayenne-maven dans le fichier pom, la g√©n√©ration de code des classes correspondant aux tables de la base de donn√©es sera effectu√©e: <br><br><div class="spoiler">  <b class="spoiler_title">plugin cayenne-maven</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugin</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.apache.cayenne.plugins<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>cayenne-maven-plugin<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>${cayenne.version}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">map</span></span></span><span class="hljs-tag">&gt;</span></span>src/main/resources/db/datamap.map.xml<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">map</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">destDir</span></span></span><span class="hljs-tag">&gt;</span></span>${project.build.directory}/generated-sources/cayenne<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">destDir</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">executions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">execution</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">goals</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">goal</span></span></span><span class="hljs-tag">&gt;</span></span>cgen<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">goal</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">goals</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">execution</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">executions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugin</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>  J'ai ensuite ajout√© la classe CayenneRuntimeFactory pour initialiser la fabrique de contexte de base de donn√©es: <br><br><div class="spoiler">  <b class="spoiler_title">CayenneRuntimeFactory.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Factory</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CayenneRuntimeFactory</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DataSource dataSource; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CayenneRuntimeFactory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DataSource dataSource)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dataSource = dataSource; } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ServerRuntime </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cayenneRuntime</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ServerRuntime.builder() .dataSource(dataSource) .addConfig(<span class="hljs-string"><span class="hljs-string">"db/cayenne-test.xml"</span></span>) .build(); } }</code> </pre><br></div></div><br>  Contr√¥leur HelloController: <br><br><div class="spoiler">  <b class="spoiler_title">HelloController.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Controller</span></span>(<span class="hljs-string"><span class="hljs-string">"/hello"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HelloController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ServerRuntime cayenneRuntime; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HelloController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ServerRuntime cayenneRuntime)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.cayenneRuntime = cayenneRuntime; } <span class="hljs-meta"><span class="hljs-meta">@Get</span></span>(<span class="hljs-string"><span class="hljs-string">"/{name}"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Produces</span></span>(MediaType.TEXT_PLAIN) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> HttpResponse&lt;String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ObjectContext context = cayenneRuntime.newContext(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> List&lt;User&gt; result = ObjectSelect.query(User.class).select(context); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.size() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { result.get(<span class="hljs-number"><span class="hljs-number">0</span></span>).setName(name); } context.commitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HttpResponse.ok(result.stream() .map(x -&gt; MessageFormat.format(<span class="hljs-string"><span class="hljs-string">"{0}.{1}"</span></span>, x.getObjectId(), x.getName())) .collect(Collectors.joining(<span class="hljs-string"><span class="hljs-string">","</span></span>))); } }</code> </pre><br></div></div><br>  Il a ensuite lanc√© le programme sous la forme d'un pot ordinaire, en utilisant agentlib: native-image-agent, pour collecter des informations sur les ressources utilis√©es et la r√©flexion. <br><br>  J'ai r√©cup√©r√© le binaire natif, l'ex√©cuter, aller √† l'adresse <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http: // localhost: 8080 / hello / user</a> et obtenir une erreur: <br><br><pre> <code class="plaintext hljs">{"message":"Internal Server Error: Provider com.sun.org.apache.xerces.internal.jaxp.SAXParserFactoryImpl not found"}</code> </pre><br>  il s'av√®re agentlib: native-image-agent n'a pas d√©tect√© l'utilisation de cette classe en r√©flexion. <br><br>  Ajout√©e manuellement au fichier reflect-config.json: <br><br><pre> <code class="plaintext hljs">{ "name":"com.sun.org.apache.xerces.internal.jaxp.SAXParserFactoryImpl", "allDeclaredConstructors":true }</code> </pre><br>  Encore une fois, je r√©cup√®re le binaire, d√©marre, met √† jour la page Web et obtient une autre erreur: <br><br><pre> <code class="plaintext hljs">Caused by: java.util.MissingResourceException: Resource bundle not found org.apache.cayenne.cayenne-strings. Register the resource bundle using the option -H:IncludeResourceBundles=org.apache.cayenne.cayenne-strings.</code> </pre><br>  Tout est clair ici, j'ajoute le r√©glage, comme indiqu√© dans la solution propos√©e.  Encore une fois, je r√©cup√®re le binaire (cela fait 5 minutes), je le red√©marre encore et encore une erreur, une autre: <br><br><pre> <code class="plaintext hljs">No DataMap found, can't route query org.apache.cayenne.query.SelectQuery@2af96966[root=class name.voyachek.demos.nativemcp.db.User,name=]"}</code> </pre><br>  J'ai d√ª bricoler avec cette erreur, apr√®s de nombreux tests, en √©tudiant les sources, il est devenu clair que la raison de l'erreur r√©side dans cette ligne de la classe org.apache.cayenne.resource.URLResource: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URLResource(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URL(url, relativePath));</code> </pre><br>  Il s'est av√©r√© que Substrate VM charge la ressource par l'URL, qui est indiqu√©e comme base, et non par l'URL, qui doit √™tre form√©e sur la base de la base et du chemin d'acc√®s relatif.  Objet du probl√®me suivant enregistr√© par moi: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Contenu de ressource non valide lors de l'utilisation d'une nouvelle URL (contexte URL, sp√©cification de cha√Æne)</a> . <br><br>  L'erreur est d√©termin√©e, vous devez maintenant rechercher des solutions de contournement.  Heureusement, Apache Cayenne s'est av√©r√© √™tre une chose assez personnalisable.  Vous deviez enregistrer votre propre chargeur de ressources: <br><br><pre> <code class="java hljs">ServerRuntime.builder() .dataSource(dataSource) .addConfig(<span class="hljs-string"><span class="hljs-string">"db/cayenne-test.xml"</span></span>) .addModule(binder -&gt; { binder.bind(ResourceLocator.class).to(ClassLoaderResourceLocatorFix.class); binder.bind(Key.get(ResourceLocator.class, Constants.SERVER_RESOURCE_LOCATOR)).to(ClassLoaderResourceLocatorFix.class); }) .build();</code> </pre><br>  Voici son code: <br><br><div class="spoiler">  <b class="spoiler_title">ClassLoaderResourceLocatorFix.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClassLoaderResourceLocatorFix</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResourceLocator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ClassLoaderManager classLoaderManager; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ClassLoaderResourceLocatorFix</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Inject ClassLoaderManager classLoaderManager)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.classLoaderManager = classLoaderManager; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Collection&lt;Resource&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findResources</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Collection&lt;Resource&gt; resources = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(<span class="hljs-number"><span class="hljs-number">3</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Enumeration&lt;URL&gt; urls; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { urls = classLoaderManager.getClassLoader(name).getResources(name); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConfigurationException(<span class="hljs-string"><span class="hljs-string">"Error getting resources for "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (urls.hasMoreElements()) { resources.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URLResourceFix(urls.nextElement())); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resources; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">URLResourceFix</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">URLResource</span></span></span><span class="hljs-class"> </span></span>{ URLResourceFix(URL url) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(url); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Resource </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRelativeResource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String relativePath)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { String url = getURL().toString(); url = url.substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, url.lastIndexOf(<span class="hljs-string"><span class="hljs-string">"/"</span></span>) + <span class="hljs-number"><span class="hljs-number">1</span></span>) + relativePath; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URLResource(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URI(url).toURL()); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (MalformedURLException | URISyntaxException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CayenneRuntimeException( <span class="hljs-string"><span class="hljs-string">"Error creating relative resource '%s' : '%s'"</span></span>, e, getURL(), relativePath); } } } }</code> </pre><br></div></div><br>  Il a une ligne <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URLResource(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URL(url, relativePath));</code> </pre><br>  remplac√© par: <br><br><pre> <code class="java hljs">String url = getURL().toString(); url = url.substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, url.lastIndexOf(<span class="hljs-string"><span class="hljs-string">"/"</span></span>) + <span class="hljs-number"><span class="hljs-number">1</span></span>) + relativePath; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URLResource(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URI(url).toURL());</code> </pre><br>  Je r√©cup√®re le binaire (70 Mo), le d√©marre, je vais sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http: // localhost: 8080 / hello / user</a> et tout fonctionne, les donn√©es de la base de donn√©es sont affich√©es sur la page. <br><br>  Lien vers le r√©f√©rentiel: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Github: native-micronaut-cayenne-demo</a> . <br><br><h2>  Conclusions </h2><br>  L'objectif est atteint: une application web simple avec acc√®s √† la base de donn√©es √† l'aide d'ORM a √©t√© d√©velopp√©e.  L'application est compil√©e en un binaire natif et peut s'ex√©cuter sur des syst√®mes sans machine Java install√©e.  Malgr√© de nombreux probl√®mes, j'ai trouv√© une combinaison de cadres, de param√®tres et de solutions de contournement qui m'a permis d'obtenir un programme de travail. <br><br>  Oui, la possibilit√© de cr√©er des binaires r√©guliers √† partir du code source Java est toujours √† l'√©tat exp√©rimental.  Cela est √©vident par l'abondance de probl√®mes, la n√©cessit√© de rechercher des solutions de contournement.  Mais en fin de compte, il s'est tout de m√™me av√©r√© atteindre le r√©sultat souhait√©.  Qu'est-ce que j'ai eu? <br><br><ul><li>  Le seul fichier autonome (presque, il existe des d√©pendances sur des biblioth√®ques telles que libc) qui peut fonctionner sur des syst√®mes sans machine Java. </li><li>  L'heure de d√©but est en moyenne de 40 millisecondes contre 2 secondes lors du d√©marrage d'un bocal ordinaire. </li></ul><br>  Parmi les lacunes, je voudrais noter le long temps de compilation du binaire natif.  Cela me prend en moyenne cinq minutes et augmentera tr√®s probablement lors de l'√©criture de code et de la connexion des biblioth√®ques.  Par cons√©quent, il est logique de cr√©er des fichiers binaires bas√©s sur du code enti√®rement d√©bogu√©.  De plus, les informations de d√©bogage pour les binaires natifs sont disponibles uniquement dans l'√©dition commerciale de Graal VM - Enterprise Edition. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr454790/">https://habr.com/ru/post/fr454790/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr454774/index.html">Nous avons √©crit le code le plus utile de notre vie, mais nous l'avons jet√© √† la poubelle. Avec nous</a></li>
<li><a href="../fr454776/index.html">Freelance ou bureau? R√©ponse du pigiste</a></li>
<li><a href="../fr454778/index.html">Le livre "Machine Learning: Algorithms for Business"</a></li>
<li><a href="../fr454780/index.html">Ce que nous savons des microservices</a></li>
<li><a href="../fr454788/index.html">Arme d'un investisseur prudent: on consid√®re la juste valeur des obligations d'investissement</a></li>
<li><a href="../fr454792/index.html">Comparaison des algorithmes de tri des √©changes</a></li>
<li><a href="../fr454804/index.html">Cr√©ez votre composant avec des micro-mod√®les</a></li>
<li><a href="../fr454806/index.html">Formation Cisco 200-125 CCNA v3.0. Jour 9. Le monde physique des interrupteurs. Partie 1</a></li>
<li><a href="../fr454808/index.html">√Ä propos des vaisseaux spatiaux et de l'espace. Comment cr√©er une fonctionnalit√© en modifiant tout le produit en cours de route</a></li>
<li><a href="../fr454810/index.html">De l'air frais sur Mars: pliez une mol√©cule de CO2 et obtenez de l'oxyg√®ne</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>