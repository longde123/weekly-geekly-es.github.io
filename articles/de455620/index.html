<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏿‍🤝‍👨🏻 🈲 🛂 CAN oder nicht CAN? Oder warum brauche ich ein Mikrocontrollernetzwerk? 🌷 🌭 🧑🏾‍🤝‍🧑🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ich musste mir diese Frage vor ungefähr zehn Jahren oder länger stellen. Die Arbeit, die erledigt werden musste, bestand darin, dem Kontrollraum ein z...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>CAN oder nicht CAN? Oder warum brauche ich ein Mikrocontrollernetzwerk?</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/455620/"><p>  Ich musste mir diese Frage vor ungefähr zehn Jahren oder länger stellen.  Die Arbeit, die erledigt werden musste, bestand darin, dem Kontrollraum ein zweites Leben zu geben.  Dies ist so etwas in der gesamten Wand, bestehend aus Glühbirnen und Schaltern mit Schaltern.  Ich denke, ich werde mich nicht irren, wenn ich annehme, dass die Schilde seit dem Erscheinen der Glühbirnen funktionieren, da die Schalter zu diesem Zeitpunkt wahrscheinlich bereits bekannt waren.  Und das Verlangen nach Schönheit kam im Allgemeinen zu Menschen aus der fernen Antike. </p><br><p>  Jetzt werden viele Anzeigetafeln Schildern vorziehen.  Ob es jedoch eine Mehrheit der Display-Fans geben wird, hängt von einer Menge ab, die uns unbekannt ist.  Aber jetzt geht es nicht darum. </p><br><p>  Jeder, der fünf Minuten lang über elektrische Verkabelung sprechen kann, wird mir sofort sagen, dass die Abschirmung aus Flachbildschirmen besteht, auf denen Schalter und Glühbirnen angebracht sind, sowie einer Box mit vielen Kabeln.  Schließlich ist eine Glühbirne ohne Kabel nur dazu geeignet, sie entweder dumm zu zerbrechen oder, wenn Sie kreativ auftauchen und Ihre Fantasie anregen, sie am neugierigsten in Ihren Mund zu stecken und schnell herauszufinden, wo sich die Notaufnahme befindet. </p><a name="habracut"></a><br><p>  Das war alles, ein Bündel Drähte, die die Box den Schaltern und Glühbirnen überließen, nur die Glühbirnen waren klein.  Anscheinend die Enkelin der berühmten Glühbirne Iljitsch. </p><br><p>  Und jetzt, erinnere ich mich, habe ich aus dem Fenster geschaut, und da ist das 21. Jahrhundert.  Daher ist es notwendig, alles neu und anders zu machen.  Anstelle von Glühbirnen - sparsame LEDs.  Anstelle von Drähten - Verkabelung.  Anstelle einer Schublade - viele, viele kleine Schubladen, also Controller. </p><br><p>  Es stellte sich heraus, dass, wenn jeder Controller vier LEDs und zwei Schalter bedienen kann, dies optimal aussieht.  Ich meine, nicht so schrecklich.  Und wenn der Leistungsbus und der Informationsbus alle Steuerungen durchlaufen, gibt es nur vier Drähte, dann erscheint eine gewisse Gnade.  Es stellte sich auch heraus, dass die Controller 104 Stück benötigen würden.  In gütlicher Weise wäre es hier notwendig, das Problem der reisenden Verkäufer zu stellen und zu lösen.  Und dann hätten die Controller vielleicht weniger ausgegeben.  Aber es war nicht gut. </p><br><p>  Zu diesem Zeitpunkt wusste ich bereits, was CAN ist, und mein Respekt vor Bosch war viel höher als der eines anständigen Restaurantkochs oder einer ordentlichen Hausfrau.  Ich bin sicher, die BMW Automobilhersteller haben sogar die Bosch-Ingenieure besucht. </p><br><p>  Controller Area Network, wie Ausländer meiner Meinung nach als technische Lösung sagen würden, entstand aus dem Wunsch heraus, endlich etwas gut zu machen.  Ich werde mich nicht verstecken, Sie werden nicht alle Reize der Ergebnisse der Arbeit der Ingenieure sofort spüren, wenn Sie zwei Bände des Standards beherrschen, aber viel später.  Wenn Sie mit Augenzeugen sprechen, befragen Sie Zeugen.  Jetzt gibt es mehr Volumes, aber vielleicht können Sie sofort mit dem dritten beginnen, denn jetzt heißt es CAN_FD.  Lassen Sie mich jedoch fortfahren. </p><br><p>  Noch vor der Kollision mit dem Schild musste ich mich mit den technischen Entscheidungen anderer Leute über die Verwendung von CAN auseinandersetzen und meine Fehler machen.  Fehler treten normalerweise zwischen dem Lesen von Anweisungen und dem Studieren von Beschreibungen auf.  Nun, dass sie erst beim zweiten Mal wie ein Rechen aussehen. </p><br><p>  Nun ein paar tausend Worte für den Leser, der Nerds toleriert und sie nicht als Feinde betrachtet. </p><br><p>  CAN kann dort installiert werden, wo RS485 zuvor an einem Twisted Pair-Kabel gearbeitet hat.  Twisted Pair ist keine unverzichtbare Bedingung, es ist einfach bequem zu vergleichen.  Mit einem Twisted-Pair-Kabel können Sie sowohl über CAN als auch über RS485 Nachrichten vom Steuercontroller an den Slave senden und eine Antwort empfangen.  Die Ähnlichkeit ist auffällig, aber konzentrieren wir uns besser auf die Unterschiede.  Einige der Unterschiede können für einige Leser ein Minuszeichen tragen.  Aber ich würde ihnen raten, nicht verärgert zu sein, sondern sich an das Gesetz von Lomonossow zu erinnern. </p><br><p>  Dank der synchronen Organisation des Protokolls wird die Kollisionsauflösung auf dem Bus sozusagen im laufenden Betrieb in Hardware implementiert.  Es wird unten angegeben, wozu dies führt und was den unruhigen Ingenieur gibt. </p><br><p>  Sie können eine Nachricht ohne Anfrage erhalten. <br>  Sie müssen nicht warten, bis die Antwort fertig ist. Sie können zu diesem Zeitpunkt eine andere Person fragen. <br>  Der Slave-Controller kann auch fragen und eine Antwort erhalten. <br>  Aufgrund des Synchronbetriebs ist die CAN-Bus-Länge umgekehrt proportional zur Übertragungsgeschwindigkeit oder ähnlichem. <br>  Die Höchstgeschwindigkeit beträgt 1 MBaud (10 - unterwegs). <br>  Der Absender weiß, dass die Nachricht während der Übertragung unmittelbar nach dem letzten Bit nicht verzerrt wurde.  Genauer gesagt, das weiß jeder im Bus. <br>  Wenn die Nachricht für eine verzerrt ist, wird der Versuch nicht von allen gezählt. <br>  Wenn die Nachricht an den Bus gesendet wurde, empfängt der Teilnehmer sie nicht nur unter der Bedingung, dass sie fehlerhaft ist. <br>  Die Anzahl der Controller am Bus sollte 127 nicht überschreiten. </p><br><p>  Nachrichten sind in der Länge begrenzt.  Sie bestehen aus einem Bezeichner, einem Längenindikator in Bytes und einem Datenblock mit genau so vielen Bytes wie angegeben.  Es gibt noch ein paar weitere Servicebits, aber lassen Sie uns darüber schweigen, da der Service unauffällig sein sollte.  Die Kennung kann 11 oder 29 Bit groß sein.  Ein Datenblock kann 0 bis 8 Bytes enthalten (64 - unterwegs). </p><br><p>  Für Einzelheiten werde ich einige Zahlen geben.  Wenn Sie mit einer Geschwindigkeit von 1 MBaud arbeiten möchten, sollte die Buslänge nicht mehr als 35 Meter betragen (einige bevorzugen 40, dh heißer).  Wenn Sie etwas über eine Entfernung von 8 km übertragen müssen, sollte die Geschwindigkeit 5 kBaud nicht überschreiten.  Der Leser hat übrigens das Recht zu fragen, warum Kilobod und nicht Kilobit?  Weil nicht alle Bauds zu Bits werden.  Irgendwie so. </p><br><p>  Wie kann ich all diese streng geheimen Zutaten entsorgen?  Diejenigen, die das Würfelspiel in allem sehen, werden sich sofort daran erinnern, dass es so etwas Wunderbares wie CANopen und viele weitere schöne Kombinationen und Abkürzungen gibt und es nichts gibt, was das Rad neu erfinden könnte.  Deshalb möchte ich oft antworten: „Sieht das Spiegelei aus zwei Eiern, das viele zum Frühstück selbst kochen, nicht wie ein Fahrrad aus?  Warum nicht zu einem Food-Service gehen und ein Omelett nehmen? “  Aber ich sollte lieber schweigen und weitermachen, ohne von Schreien des Publikums abgelenkt zu werden. </p><br><p>  In jenen Tagen, als 29-Bit-Kennungen noch nicht erfunden worden waren, gab es nur 11-Bit.  Einige begannen damit, den Namen (die Nummer) des gewünschten Datentyps dort zu stopfen.  Andere werden als Adresse des Controllers verwendet, auf den zugegriffen wird.  Beides ergab einen Sinn.  Zum Beispiel könnten Sie dies fragen: </p><br><ul><li>  Und gib uns, meine Liebe, ein Schloss des dreizehnten Jahres in einem Liter Papierverpackung. </li></ul><br><p>  Oder so: </p><br><ul><li><p>  Wickeln Sie mich bitte ein, was rechts in Ihrem unteren Regal versteckt ist. <br>  Übrigens kann dieses Design in CAN auch funktionieren: </p><br></li><li><p>  Lüg alle an!  Und du hast schnell alles aus den Regalen in meine Tasche gesteckt. <br>  Aber dieses Design wird oft nicht verwendet, weil Sie nach einer Weile warten müssen. <br>  Warten Sie, bis alle Antworten einzeln aufgereiht und dem anfordernden Controller zur Verfügung stehen.  Wir haben den Film schon verlassen, wenn das so ist. <br>  In meinem Fall würde ich mich über die Variante der Kennung als Adresse freuen.  Von den 11 Bits waren 7 erforderlich, und 4 weitere blieben übrig, um einige Nachrichten dringender als andere zu machen und einige der Controller als die wichtigsten zu markieren. <br>  Einige Unannehmlichkeiten sind von RS485 hierher gewandert, nämlich, dass die Adressen auf jedem Controller manuell eingestellt werden mussten.  Überprüfen Sie dann und installieren Sie neu.  Und vielleicht zum vorherigen Schritt zurückkehren und wiederholen. <br>  Glücklicherweise gab es zu diesem Zeitpunkt bereits zwei Umstände. </p><br></li></ul><br><p>  Zunächst wurde bereits eine 29-Bit-Kennung angezeigt.  Und das zweite ist, dass viele Hersteller von Mikrocontrollern begannen, die Bedingung, dass jeder Chip seine eigene eindeutige und ziemlich lange Nummer hat, als eine gute Form zu betrachten. </p><br><p>  In einer langen Kennung könnten nun 24 Bits sicher einer eindeutigen Adresse zugewiesen werden.  Weitere 5 blieben übrig, um sicherzustellen, dass sich die Züge in Dringlichkeit, Richtung (dort, hinten), Vorhandensein eines Restaurantwagens und Wagen mit erhöhtem Komfort unterschieden. </p><br><p>  Wenn Sie aufhören, herumzuspielen und ernst werden, untergeordnete Controller-Agenten und die übrigen Chefs anrufen, können Sie eine Tabelle erstellen.  Sie wird etwas später gezeigt. </p><br><p>  Ein bisschen mehr über das Adressieren.  Eine eindeutige Chipnummer nimmt in der Regel eine Anzahl von Bits ein, die weit über 24 liegen, beispielsweise 96 mit STM32FXXX.  Daher müssen Sie irgendwie 24 von 96 bekommen. Ich habe die XOR-Operation gewählt.  Sie können etwas anderes wählen, aber ein kleines Problem bleibt bestehen.  Dies sind Adressübereinstimmungen nach der Reduzierung. </p><br><p>  Die Wahrscheinlichkeit dieses Problems ist äußerst gering, aber es ist.  Es ist lösbar, fügt aber den Installationsprogrammen Arbeit hinzu.  Hierbei ist zu beachten, dass CAN-Nachrichten möglicherweise überhaupt keine Daten enthalten.  Dies ist nützlich für uns bei der Entscheidung.  Es besteht aus den folgenden Aktionen. </p><br><p>  Der steuernde Controller (Boss) sendet eine Broadcast-Anfrage, auf die alle Agenten antworten müssen (dies ist eine Anfrage mit einer Nulladresse).  Antwortnachrichten mit einer Datenlänge von Null und übereinstimmenden Adressen verderben sich nicht gegenseitig, sondern erreichen den Chef in Form einer. </p><br><p>  Nun bleibt zu berechnen, wie viele Antworten eingegangen sind und wie viele sie sein sollten.  Wenn diese beiden Zahlen übereinstimmen, ist alles in Ordnung.  Wenn es weniger Antworten als Controller gibt, stimmen die Adressen überein und es gibt Arbeit für die Einsteller.  Und wenn es mehr Antworten als Controller gibt, müssen Sie über eine Dissertation nachdenken, da Sie kurz vor der Entdeckung stehen. </p><br><p>  Wenn die Änderung der Länge der Nachricht als Variation ihrer Bedeutung angesehen wird, können Sie zusätzliche Funktionen erhalten, über die ich später berichten werde, wenn meine Mutter nicht zum Essen anruft. </p><br><p>  Ein weiterer interessanter Punkt ist, dass Sie, wenn Sie gleichzeitig kurze und lange Bezeichner verwenden, beispielsweise Gruppenadressierungen oder teilweise Broadcast-Anforderungen erhalten können.  Aber wir werden noch nicht tief gehen. </p><br><p>  Kehren wir zur Codierung des Bezeichners zurück. </p><br><p>  Zu Adressierungszwecken werden 24 Bit in der erweiterten Kennung und sechs in der Standardkennung zugewiesen.  Für die erweiterte Kennung wird eine Adresse mit dem Wert 0x000000 gesendet.  Für eine Standardkennung wird auch eine Nulladresse (ihre 6 Bits) als gesendet betrachtet.  Die fünf führenden (hohen) Bits in den langen und kurzen Bezeichnern werden als Header bezeichnet, wirken sich auf die Bedeutung der Nachricht aus und werden mit den Buchstaben NVADR bezeichnet: </p><br><p><img src="https://habrastorage.org/webt/5a/ir/yt/5airytjd4ojg3bn15xhoh9qo5jw.jpeg"></p><br><p>  Für das Control Panel war es natürlich erforderlich, nur einen Teil dieses Schemas zu implementieren.  Im ersten Projekt mit einem Schild (oder auf dem Schild, wie richtig?) Wurden Cortex-Chips von NXP verwendet, und in den nächsten Projekten (es gab einige) wurde bereits M0 von STMicroelectronics verwendet. </p><br><p>  Ein paar Worte zur Verwendung von Kurzbezeichnungen.  Diese sechs Bits, die für die Adressierung zugewiesen sind, adressieren nicht den Controller, sondern die Gruppe.  Zu Beginn hat diese Gruppe für alle Null.  Als Nächstes werden Agenten konfiguriert, nach denen einige oder alle Mitglieder ihrer Gruppe werden.  Als Anfrage an die Gruppe erhalten wir die Antworten der Agenten, die wir in dieser Gruppe gesammelt haben. </p><br><p>  Nun ein wenig darüber, was hinzugefügt wird, wenn Sie Nachrichten mit unterschiedlichen Datenlängen unterschiedlich interpretieren.  Zum Beispiel hilft eine Abfrage mit der Länge Null beim Debuggen sehr, wie oben erwähnt.  Eine Anforderung mit einer Länge von 3 bedient den variablen Speicherplatz von 16384 Byte. Eine Anforderung mit einer Länge von 4 tut dasselbe, ist jedoch für einen Gateway-Agenten vorgesehen, der einen CAN-Bus der zweiten Ebene bedient.  Dieser Bus kann aus einem oder zwei Agenten bestehen, aber ein paar Kilometer entfernt. </p><br><p>  Eine Abfrage mit einer Länge von 5 und 6 ist ebenfalls für einen Raum von Zwei-Byte-Variablen der Größe 4194304 vorgesehen. Zwei Bits werden nicht zur Adressierung verwendet.  Ein Bit steuert das Schreiben und Lesen.  Ein anderer signalisiert einen Fehler. </p><br><p>  Als nächstes dienen 7 und 8 vier Byte-Wörter.  Es gibt auch 4.194.304. </p><br><p>  Diese Leerzeichen sind allen Agenten gemeinsam.  Jeder von ihnen verwendet je nach Zweck nur ein Segment des Variablenraums.  Der Regler zur Temperaturmessung an zwei Punkten ist auf dem Foto dargestellt.  Dies dient zum Debuggen und Testen. </p><br><p><img src="https://habrastorage.org/webt/eq/tc/8z/eqtc8z-q-gmhha4cyzqqceqdtjc.jpeg"></p><br><p>  Die Steuerungen sind mit einem Flachkabel für 6 Adern verbunden.  Dual werden für Lebensmittel verwendet.  Der 20-Fuß-Chip ist der STM32F042. </p><br><p>  Auf der Rückseite befindet sich der MAX3051, ein CAN-Treiber im SOT23-8-Paket. <br>  Nun, Mama ruft zum Essen an. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de455620/">https://habr.com/ru/post/de455620/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de455610/index.html">Legendärer Intel Core i7-2600K: Testen von Sandy Bridge im Jahr 2019 (Teil 1)</a></li>
<li><a href="../de455612/index.html">Wir denken über die Charaktere von Spielen und Dialogen nach dem Rat von Schriftstellern und am Beispiel von Unterstützern der Theorie einer flachen Erde nach</a></li>
<li><a href="../de455614/index.html">FFI: Schreiben in Rust in einem PHP-Programm</a></li>
<li><a href="../de455616/index.html">Warum zu "Industrial Programming" in der St. Petersburg HSE gehen?</a></li>
<li><a href="../de455618/index.html">DevOps LEGO: Wie wir eine Pipeline auf Würfeln angelegt haben</a></li>
<li><a href="../de455622/index.html">Legendärer Intel Core i7-2600K: Testen von Sandy Bridge im Jahr 2019 (Teil 2)</a></li>
<li><a href="../de455624/index.html">Hyper-Verluste und was Spieleentwickler daraus lernen können</a></li>
<li><a href="../de455626/index.html">Wallarm Offzone2019 HackQuest</a></li>
<li><a href="../de455630/index.html">Digitale Veranstaltungen in Moskau vom 11. bis 16. Juni</a></li>
<li><a href="../de455632/index.html">Achtung! Gefährlicher Fehler in der C ++ - Implementierung std :: map :: merge und std :: set :: merge in Visual Studio 2017</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>