<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶í üë®üèæ‚Äçü§ù‚Äçüë®üèª üï¶ Utilisation de la base de donn√©es des journaux Mikrotik pour supprimer la force brute üëÜüèº üéüÔ∏è ü§ö</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bon apr√®s-midi 

 Dans une publication pr√©c√©dente , j'ai expliqu√© comment, facilement et naturellement, vous pouvez configurer la collecte de m√©tadonn...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Utilisation de la base de donn√©es des journaux Mikrotik pour supprimer la force brute</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/434736/">  Bon apr√®s-midi <br><br>  Dans une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">publication</a> pr√©c√©dente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">,</a> j'ai expliqu√© comment, facilement et naturellement, vous pouvez configurer la collecte de m√©tadonn√©es de trafic r√©seau sur les routeurs Mikrotik dans une base de donn√©es. <br><br>  Il est maintenant temps d'apprendre √† notre serveur √† faire une analyse √©l√©mentaire des donn√©es re√ßues et √† renvoyer des commandes. <br><br>  <b>Objectif:</b> Contr√¥le dynamique des r√®gles de pare-feu Mikrotik pour supprimer les attaques r√©seau avec devinette de mot de passe. <br><br>  <b>Moyens:</b> nouvelle distribution Linux avec rsyslogd v8, crond, SGBD mariadb et le routeur Mikrotik lui-m√™me. <br><br>  <b>M√©canique: √† l'</b> aide de la t√¢che assign√©e, une requ√™te SQL est ex√©cut√©e dans la base de donn√©es avec des donn√©es de trafic accumul√©es et mises √† jour et renvoie une liste d'adresses IP sortantes, le script bash lanc√© par la couronne g√©n√®re des commandes Mikrotik et, √† l'aide d'une connexion ssh, reconstitue la liste d'adresses pour les r√®gles de blocage existantes. <br><a name="habracut"></a><br>  Il s'agira de prot√©ger les ports TCP ouverts.  Il peut s'agir de ports entrant dans Mikrotik et transmis au r√©seau local. <br><br>  Pour commencer, nous indiquons o√π il peut y avoir des faiblesses: <br><br><ul><li>  Protocoles de contr√¥le de ssh, telnet, web, routeur winbox </li><li>  Services de messagerie smtp, pop, imap </li><li>  Tous les services Web fournis √† l'ext√©rieur </li><li>  Bureau √† distance MS RDP, VNC, etc. </li><li>  Autre chose √† votre discr√©tion </li></ul><br>  <b>√âcriture d'une requ√™te SQL pour rechercher la force brute</b> <br><br>  Notre organisation dispose de serveurs de terminaux ouverts sur l'ext√©rieur via des ports non prioritaires. <br>  Dans DNAT Mikrotik, j'ai activ√© l'enregistrement des r√®gles n√©cessaires en ajoutant le pr√©fixe RDP_DNAT.  Par ce pr√©fixe, nous rechercherons: <br><br><pre><code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src,dport,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> datetime&gt;<span class="hljs-keyword"><span class="hljs-keyword">now</span></span>() - <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">day</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> logpref=<span class="hljs-string"><span class="hljs-string">'RDP_DNAT'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> src <span class="hljs-keyword"><span class="hljs-keyword">having</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport)&gt;<span class="hljs-number"><span class="hljs-number">50</span></span>; +<span class="hljs-comment"><span class="hljs-comment">-----------------+-------+---------------------------------------+ | src | dport |   | +-----------------+-------+---------------------------------------+ | 185.156.177.58 | 12345 | 118 | | 185.156.177.59 | 12345 | 267 | | 193.238.46.12 | 12345 | 318 | | 193.238.46.13 | 12345 | 319 | | 193.238.46.99 | 12345 | 342 | | 194.113.106.150 | 12345 | 67 | | 194.113.106.152 | 12345 | 167 | | 194.113.106.153 | 12345 | 190 | | 194.113.106.154 | 12345 | 192 | | 194.113.106.155 | 12345 | 190 | | 194.113.106.156 | 12345 | 216 | | 194.113.106.158 | 12345 | 124 | +-----------------+-------+---------------------------------------+ 12 rows in set (0.06 sec)</span></span></code> </pre> <br>  Cette demande indique l'adresse IP (d'o√π provient l'attaque), le port vers lequel la connexion est √©tablie (le num√©ro de port est modifi√©) et le nombre de tentatives de connexion, avec un regroupement pr√©liminaire par src et une s√©lection de lignes, avec un nombre de tentatives sup√©rieur √† 50 par le pass√©, √† partir de l'heure actuelle, le jour. <br><br>  Dans mon cas, ces adresses peuvent √™tre interdites en toute s√©curit√©, car le nombre de connexions avec de "bons" clients est moindre, pas plus de 5 √† 10 par jour √† partir d'une seule IP. <br><br>  La demande fonctionne bien, rapidement, mais elle est un peu longue.  Pour une utilisation ult√©rieure, je propose de faire une vue, qui copierait moins √† l'avenir: <br><br><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> rdp_brute_day <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src, dport, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> datetime&gt;<span class="hljs-keyword"><span class="hljs-keyword">now</span></span>() - <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">day</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> logpref=<span class="hljs-string"><span class="hljs-string">'RDP_DNAT'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> src <span class="hljs-keyword"><span class="hljs-keyword">having</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport)&gt;<span class="hljs-number"><span class="hljs-number">50</span></span>; Query OK, 0 rows affected (0.23 sec)</code> </pre><br>  V√©rifions le fonctionnement de la vue: <br><br><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rdp_brute_day; +<span class="hljs-comment"><span class="hljs-comment">----------------+--------------+ | src | count(dport) | +----------------+--------------+ | 185.156.177.58 | 11 | +----------------+--------------+ 1 row in set (0.09 sec)</span></span></code> </pre> <br>  Super. <br><br>  <b>Nous ajoutons l'utilisateur Mikrotik avec autorisation par cl√© dsa</b> <br><br>  Dans la console linux, nous g√©n√©rons la cl√© dsa, sous l'utilisateur pour le compte duquel la t√¢che planifi√©e sera lanc√©e, j'ai fait depuis root: <br><br><pre> <code class="bash hljs">root@monix:~<span class="hljs-comment"><span class="hljs-comment"># ssh-keygen -t dsa Generating public/private dsa key pair. Enter file in which to save the key (/root/.ssh/id_dsa): Enter passphrase (empty for no passphrase): Enter same passphrase again: Your identification has been saved in /root/.ssh/id_dsa. Your public key has been saved in /root/.ssh/id_dsa.pub. ...</span></span></code> </pre> <br>  La phrase de passe n'est pas n√©cessaire.  Nous copions la cl√© publique /root/.ssh/id_dsa.pub dans Mikrotik de toutes les mani√®res possibles.  Je l'ai sorti avec la commande cat, copi√© le texte de la fen√™tre de mastic dans un fichier texte, l'ai enregistr√© et gliss√© dans la fen√™tre des fichiers winbox. <br><br>  Je ne sais pas pourquoi, mais au cours des op√©rations suivantes via l'interface Winbox, quelque chose s'est mal pass√©.  Lors de la connexion depuis le serveur via ssh, Mikrotik m'a √©galement demand√© un mot de passe.  Apr√®s avoir supprim√© l'utilisateur cr√©√© et effectu√© toutes les op√©rations via la console, la connexion dsa a fonctionn√©.  A fait approximativement comme d√©crit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  En g√©n√©ral, j'ai re√ßu l'entr√©e de bienvenue sans mot de passe √† l'aide de la cl√© dsa et j'ai ex√©cut√© la commande de v√©rification: <br><br><pre> <code class="bash hljs">root@monix:/<span class="hljs-comment"><span class="hljs-comment"># ssh rsyslogger@192.168.0.230 /system resource print uptime: 2w1d5h22m43s version: 6.43.2 (stable) ...</span></span></code> </pre> <br>  Bon. <br><br>  <b>√âcrire un script bash</b> <br><br>  Le script n'√©tait pas compliqu√©: <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mikrotik_cmd_list</span></span></span></span>(){ brute_src_list=$(mysql --skip-column-names traflog -e <span class="hljs-string"><span class="hljs-string">'select src from rdp_brute_day'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> src <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$brute_src_list</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"ip firewall address-list add address=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$src</span></span></span><span class="hljs-string"> list=rdp_banlist timeout=1d"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> } mikrotik_cmd_list | ssh -T rsyslogger@192.168.0.230</code> </pre> <br>  Afin de transf√©rer toutes les commandes dans la m√™me connexion ssh, j'avais besoin de d√©crire la fonction mikrotik_cmd_list (), dans laquelle une requ√™te est d'abord effectu√©e avec la sauvegarde des adresses ip dans la variable brute_src_list, puis dans la boucle cette variable g√©n√®re s√©quentiellement des commandes pour Mikrotik.  Apr√®s avoir appel√© la fonction, la sortie est achemin√©e via le canal vers ssh. <br><br>  N'oubliez pas de fermer les droits d'acc√®s au script √† tout le monde sauf root et de rendre le fichier ex√©cutable. <br>  La commande que le script g√©n√®re ajoutera l'adresse IP √† rdp_banlist pendant 1 jour, apr√®s cette heure, elle sera supprim√©e de la liste elle-m√™me.  Si vous souhaitez le laisser ind√©finiment, supprimez l'option de d√©lai d'expiration. <br><br>  <b>Ajouter une r√®gle au pare-feu</b> <br><br>  J'ai trouv√© deux options pour utiliser la liste rdp_banlist: <br><br>  <b>Option 1:</b> ajoutez la rdp_banlist avec un point d'exclamation aux r√®gles NAT avec le pr√©fixe RDP_DNAT. <br><br><pre> <code class="bash hljs">add action=dst-nat chain=dstnat comment=<span class="hljs-string"><span class="hljs-string">"..."</span></span> dst-address=1.2.3.4 dst-port=12345 <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>=yes <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-prefix=RDP_DNAT protocol=tcp src-address-list=\ !rdp_banlist to-addresses=192.168.200.181 to-ports=3389</code> </pre> <br>  Quelque chose comme √ßa.  Autrement dit, nous dnat tout, sauf ce qui est dans rdp_banlist. <br><br>  Dans cette option, il y a un plus et un moins. <br><br>  Le plus est que les connexions s'arr√™teront imm√©diatement. <br><br>  L'inconv√©nient est que cette adresse IP n'entrera plus dans la base de donn√©es traflog et apr√®s un jour, lorsque le d√©lai de stockage dans la liste noire est pass√©, il recommencera √† chier. <br><br>  <b>Option deux:</b> ajoutez le rdp_banlist avec un point d'exclamation √† la r√®gle de pare-feu de la cha√Æne directe, o√π nous autorisons le trafic √† passer par TCP 3389, de la m√™me mani√®re que dans la premi√®re m√©thode. <br><br><pre> <code class="bash hljs">add action=accept chain=forward comment=<span class="hljs-string"><span class="hljs-string">"..."</span></span> dst-port=3389 <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>=yes <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-prefix=ACCEPT_RDP protocol=tcp src-address-list=\ !rdp_banlist to-ports=3389</code> </pre> <br>  Quelque chose comme √ßa.  Nous autorisons tout sauf celui dans la liste d'interdiction. <br><br>  Il y a aussi un plus et un moins. <br><br>  De plus.  Les journaux avec le pr√©fixe RDP_DNAT continueront d'√™tre diffus√©s dans la base de donn√©es traflog, par laquelle nous d√©terminons le signe de l'attaque.  Par cons√©quent, lorsque le d√©lai d'expiration d'un h√¥te sp√©cifique qui poursuit ses tentatives de force brute expire, il sera √† nouveau ajout√© √† la liste d'interdiction apr√®s le prochain lancement de t√¢che planifi√©e. <br><br>  L'inconv√©nient est qu'il continue de chier dans la table DSTNAT, cr√©ant un nouvel enregistrement avec chaque connexion, bien que temporaire. <br><br>  En g√©n√©ral, la d√©cision vous appartient, j'ai choisi les deux :) (en fait, seule la premi√®re fonctionne dans ce cas), car la seconde a √©t√© activ√©e plus t√¥t et la m√©canique y √©tait diff√©rente, en fonction des entr√©es s√©quentielles dans les listes √©tape1, √©tape2, √©tape3, banlist ... eh bien, vous obtenez le point.  Une astuce ancienne et peu fiable, elle peut facilement bannir les ¬´bons¬ª clients et en m√™me temps ignorer les ¬´mauvais¬ª qui ont poliment calcul√© le timeout1. <br><br>  <b>Crontab de travaux planifi√©s</b> <br><br>  Reste √† ajouter la t√¢che assign√©e √† la crontab: <br><br><pre> <code class="bash hljs">root@monix:/root<span class="hljs-comment"><span class="hljs-comment"># echo '12 * * * * root /usr/share/traflog/scripts/rdp_brute.sh &gt;/dev/null 2&gt;&amp;1' &gt;&gt; /etc/crontab</span></span></code> </pre><br>  Un tel enregistrement ex√©cutera le script toutes les heures en 12 minutes. <br><br>  Je dois admettre que je viens de terminer le travail sur cette m√©canique aujourd'hui et avec une forte probabilit√©, quelque chose pourrait mal tourner.  Selon les circonstances, je compl√©terai et corrigerai les erreurs.  Je veux <s>boire pour</s> dormir profond√©ment pendant les vacances du Nouvel An, c'est pourquoi je suis press√© de terminer. <br>  C'est probablement tout. <br><br>  Merci √† tous pour votre attention et bonne ann√©e! <br><br>  R√©f√©rences: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Documentation mysql</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Documentation du pare-feu Mikrotik</a> <br>  Merci √† Andrey Smirnov pour l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> sur la connexion dsa. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr434736/">https://habr.com/ru/post/fr434736/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr434726/index.html">Pi√®ges li√©s √† l'identification d'un appareil Android</a></li>
<li><a href="../fr434728/index.html">Personnes et processus: pourquoi ne pas udalenka adapt√© √† chaque entreprise?</a></li>
<li><a href="../fr434730/index.html">Bases de donn√©es en m√©moire: application, mise √† l'√©chelle et ajouts importants</a></li>
<li><a href="../fr434732/index.html">La vie √† 6200 DPI. Examen du noyau HyperX Pulsefire</a></li>
<li><a href="../fr434734/index.html">Transformation de Fourier. Le rapide et le furieux</a></li>
<li><a href="../fr434738/index.html">Apprentissage par renforcement en Python</a></li>
<li><a href="../fr434740/index.html">Un r√©seau de neurones a appris √† d√©tecter les panneaux solaires dans les images satellites et √† pr√©dire le niveau de leur distribution</a></li>
<li><a href="../fr434742/index.html">Partie 2: Utilisation des contr√¥leurs UDB PSoC de Cypress pour r√©duire le nombre d'interruptions dans une imprimante 3D</a></li>
<li><a href="../fr434744/index.html">Samsung SSD 860 QVO 1 TB et 4 TB: le premier consommateur SATA QLC (2 parties)</a></li>
<li><a href="../fr434746/index.html">BLE sous microscope 4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>