<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⬜️ 🙉 🤟🏿 Criando um contêiner Docker mínimo para aplicativos Go 🍫 👩‍⚕️ 😒</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Olá Habr! Trago a sua atenção uma tradução do artigo do fundador do serviço Meetspaceapp Nick Gauthier, “Criando contêineres mínimos do Docker para ap...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Criando um contêiner Docker mínimo para aplicativos Go</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460535/"> Olá Habr!  Trago a sua atenção uma tradução do artigo do fundador do serviço Meetspaceapp Nick Gauthier, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">“Criando contêineres mínimos do Docker para aplicativos Go”</a> . <br><br>  <i>10 minutos para ler</i> <br><br>  Existem muitos contêineres oficiais e suportados pela comunidade para várias linguagens de programação (incluindo Go).  Mas esses recipientes podem ser bem grandes.  Vamos primeiro comparar os métodos padrão de criação de contêineres para aplicativos Go e depois mostrarei como criar aplicativos Go em contêiner estático extremamente pequenos <br><br><h3>  Parte 1: Nossa "aplicação" </h3><br>  Para o teste, precisamos de um pequeno aplicativo.  Vamos bifurcar google.com e gerar o tamanho HTML. <br><br><pre><code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-string"><span class="hljs-string">"io/ioutil"</span></span> <span class="hljs-string"><span class="hljs-string">"net/http"</span></span> <span class="hljs-string"><span class="hljs-string">"os"</span></span> ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { resp, err := http.Get(<span class="hljs-string"><span class="hljs-string">"https://google.com"</span></span>) check(err) body, err := ioutil.ReadAll(resp.Body) check(err) fmt.Println(<span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(body)) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(err error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { fmt.Println(err) os.Exit(<span class="hljs-number"><span class="hljs-number">1</span></span>) } }</code> </pre> <br>  Se começarmos, temos apenas um número.  Eu tenho cerca de 17K.  Decidi deliberadamente usar SSL, mas explicarei o motivo mais tarde. <br><a name="habracut"></a><br><h3>  Parte 2: dockerização </h3><br>  Usando a imagem oficial do Go, escrevemos o Dockerfile "onbuild": <br><br><pre> <code class="cmake hljs">FROM golang:onbuild</code> </pre> <br>  A imagem "Onbuild" pressupõe que seu projeto tenha uma estrutura padrão e criará um aplicativo Go padrão.  Se você precisar de mais flexibilidade, poderá usar a imagem Go padrão e compilá-la: <br><br><pre> <code class="cmake hljs">FROM golang:latest RUN mkdir /app ADD . /app/ WORKDIR /app RUN go build -o main . CMD [<span class="hljs-string"><span class="hljs-string">"/app/main"</span></span>]</code> </pre> <br>  Seria bom aqui criar um Makefile ou algo parecido que você usa para a construção do aplicativo.  Podemos carregar alguns recursos da CDN ou importá-los de outro projeto, ou talvez desejemos executar testes no contêiner ... <br>  Como você pode ver, a dockerização Go é bastante direta, especialmente quando você considera que não usamos os serviços e portas às quais precisamos nos conectar.  Mas há uma falha séria nas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">imagens oficiais</a> - elas são realmente grandes.  Vamos ver: <br><br><pre> <code class="cmake hljs">REPOSITORY SIZE TAG IMAGE ID CREATED VIRTUAL SIZE example-onbuild latest <span class="hljs-number"><span class="hljs-number">9</span></span>dfb1bbac2b8 <span class="hljs-number"><span class="hljs-number">19</span></span> minutes ago <span class="hljs-number"><span class="hljs-number">520.7</span></span>MB example-golang latest <span class="hljs-number"><span class="hljs-number">02</span></span>e19291523e <span class="hljs-number"><span class="hljs-number">19</span></span> minutes ago <span class="hljs-number"><span class="hljs-number">520.7</span></span>MB golang onbuild <span class="hljs-number"><span class="hljs-number">3</span></span>be7ee2ec1ae <span class="hljs-number"><span class="hljs-number">9</span></span> days ago <span class="hljs-number"><span class="hljs-number">514.9</span></span>MB golang <span class="hljs-number"><span class="hljs-number">1.4</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">121</span></span>a93c90463 <span class="hljs-number"><span class="hljs-number">9</span></span> days ago <span class="hljs-number"><span class="hljs-number">514.9</span></span>MB golang latest <span class="hljs-number"><span class="hljs-number">121</span></span>a93c90463 <span class="hljs-number"><span class="hljs-number">9</span></span> days ago <span class="hljs-number"><span class="hljs-number">514.9</span></span>MB</code> </pre> <br>  A imagem base ocupa 514,9 MB e nosso aplicativo adiciona outros 5,8 MB.  Como é que nosso aplicativo compilado requer 515 MB de dependências? <br>  O fato é que nosso aplicativo foi compilado dentro do contêiner.  Isso significa que o contêiner precisa instalar o Go.  Portanto, ele precisa das dependências do Go, além de um gerenciador de pacotes e um sistema operacional realmente completo.  De fato, se você olhar para o Dockerfile para golang: 1.4, ele vem com o Debian Jessie, instala o compilador GCC e cria ferramentas, baixa Go e instala.  Assim, obtemos todo o servidor Debian e o kit de ferramentas Go para iniciar nosso minúsculo aplicativo.  O que pode ser feito sobre isso? <br><br><h3>  Parte 3: Compilar! </h3><br>  Você pode melhorar a situação afastando-se um pouco da abordagem usual.  Para fazer isso, vamos compilar Go em nosso diretório de trabalho e adicionar o binário ao contêiner.  Isso significa que uma construção simples do docker não funcionará.  Precisamos de um conjunto de contêineres com várias etapas: <br><br><pre> <code class="cmake hljs">go build -o main . docker build -t example-scratch -f Dockerfile.scratch .</code> </pre> <br>  E um Dockerfile.scratch simples: <br><br><pre> <code class="cmake hljs">FROM scratch ADD main / CMD [<span class="hljs-string"><span class="hljs-string">"/main"</span></span>]</code> </pre> <br>  O que é zero?  O zero é uma imagem em branco especial na janela de encaixe.  Seu tamanho é 0B: <br><br><pre> <code class="cmake hljs">REPOSITORY TAG IMAGE ID CREATED VIRTUAL SIZE example-scratch latest ca1ad50c9256 About a minute ago <span class="hljs-number"><span class="hljs-number">5.60</span></span>MB scratch latest <span class="hljs-number"><span class="hljs-number">511136</span></span>ea3c5a <span class="hljs-number"><span class="hljs-number">22</span></span> months ago <span class="hljs-number"><span class="hljs-number">0</span></span>B</code> </pre> <br>  Como resultado, nosso contêiner ocupa apenas 5,6 MB.  Ótimo!  Mas há um problema: <br><br><pre> <code class="cmake hljs">$ docker run -it example-scratch no such <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> directory</code> </pre> <br>  O que isso significa?  Demorei um pouco para perceber que nosso binário Go estava procurando bibliotecas no sistema operacional em que estava sendo executado.  Compilamos nosso aplicativo, mas ele ainda está vinculado dinamicamente às bibliotecas que precisam ser iniciadas (ou seja, a todas as bibliotecas C).  Infelizmente, o scratch está vazio, portanto não há bibliotecas ou caminhos de carregamento.  Precisamos modificar o script de construção para compilar estaticamente nosso aplicativo com todas as bibliotecas internas: <br><br><pre> <code class="bash hljs">CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o main .</code> </pre> <br>  Desabilitamos o cgo, o que nos dá um binário estático.  Também especificamos o Linux como sistema operacional (caso alguém o construa no Mac ou no Windows).  O sinalizador -a significa reconstruir todos os pacotes que usamos, que reconstruirão todas as importações com o cgo desativado.  Agora temos um binário estático.  Vamos correr: <br><br><pre> <code class="cmake hljs">$ docker run -it example-scratch Get https://google.com: x509: failed to load system roots <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> no roots provided</code> </pre> <br>  O que é isso?  Por isso, decidi usar o SSL em nosso exemplo.  Este é um "problema" muito comum para esses cenários: para concluir solicitações SSL, precisamos de certificados SSL raiz.  Então, como os adicionamos ao nosso contêiner? <br>  Dependendo do sistema operacional, os certificados podem estar em lugares diferentes.  Para muitas distribuições Linux, isso é <b>/etc/ssl/certs/ca-certificates.crt</b> .  Portanto, em primeiro lugar, copiaremos <b>ca-certificates.crt</b> do nosso computador (ou de uma máquina virtual Linux ou de um provedor de certificados on-line) em nosso repositório.  Em seguida, adicionamos <b>ADD</b> ao nosso Dockerfile para mover esse arquivo para onde o Go espera: <br><br><pre> <code class="cmake hljs">FROM scratch ADD ca-certificates.crt /etc/ssl/certs/ ADD main / CMD [<span class="hljs-string"><span class="hljs-string">"/main"</span></span>]</code> </pre> <br>  Agora apenas recrie nossa imagem e inicie-a.  Isso funciona!  Vamos ver o tamanho da nossa aplicação agora: <br><br><pre> <code class="cmake hljs">REPOSITORY TAG IMAGE ID CREATED VIRTUAL SIZE example-scratch latest ca1ad50c9256 About a minute ago <span class="hljs-number"><span class="hljs-number">6.12</span></span>MB example-onbuild latest <span class="hljs-number"><span class="hljs-number">9</span></span>dfb1bbac2b8 <span class="hljs-number"><span class="hljs-number">19</span></span> minutes ago <span class="hljs-number"><span class="hljs-number">520.7</span></span>MB example-golang latest <span class="hljs-number"><span class="hljs-number">02</span></span>e19291523e <span class="hljs-number"><span class="hljs-number">19</span></span> minutes ago <span class="hljs-number"><span class="hljs-number">520.7</span></span>MB golang onbuild <span class="hljs-number"><span class="hljs-number">3</span></span>be7ee2ec1ae <span class="hljs-number"><span class="hljs-number">9</span></span> days ago <span class="hljs-number"><span class="hljs-number">514.9</span></span>MB golang <span class="hljs-number"><span class="hljs-number">1.4</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">121</span></span>a93c90463 <span class="hljs-number"><span class="hljs-number">9</span></span> days ago <span class="hljs-number"><span class="hljs-number">514.9</span></span>MB golang latest <span class="hljs-number"><span class="hljs-number">121</span></span>a93c90463 <span class="hljs-number"><span class="hljs-number">9</span></span> days ago <span class="hljs-number"><span class="hljs-number">514.9</span></span>MB scratch latest <span class="hljs-number"><span class="hljs-number">511136</span></span>ea3c5a <span class="hljs-number"><span class="hljs-number">22</span></span> months ago <span class="hljs-number"><span class="hljs-number">0</span></span>B</code> </pre> <br>  Adicionamos um pouco mais de meio megabyte (e a maioria vem de um arquivo estático, e não de certificados raiz).  Temos um contêiner muito pequeno - será muito conveniente movê-lo entre registros. <br><br><h3>  Conclusão </h3><br>  Nosso objetivo era reduzir o tamanho do contêiner para o aplicativo Go.  A peculiaridade do Go é que ele pode criar um arquivo binário vinculado estaticamente que contém completamente o aplicativo.  Outros idiomas também podem fazer isso, mas de modo algum todos.  A aplicação de uma técnica semelhante para reduzir o tamanho do contêiner em outros idiomas dependerá de seus requisitos mínimos.  Por exemplo, um aplicativo Java ou JVM pode ser compilado fora do contêiner e, em seguida, incorporado em um contêiner que contém apenas a JVM (e suas dependências).  Mas, mesmo assim, será menos que um contêiner com o JDK. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt460535/">https://habr.com/ru/post/pt460535/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt460523/index.html">Anúncio de um mitap que se transforma suavemente em um drinkcap BeerPHP (em Moscou e on-line)</a></li>
<li><a href="../pt460525/index.html">Bem-vindo ao DINS IT NOITE em julho: controle de qualidade e JS</a></li>
<li><a href="../pt460527/index.html">Solução de problemas com pwnable.kr 06 - aleatório e 09 - erro</a></li>
<li><a href="../pt460531/index.html">Perversões curiosas do mundo da TI - 5</a></li>
<li><a href="../pt460533/index.html">Você teve a ideia de um produto de TI, o que vem a seguir</a></li>
<li><a href="../pt460537/index.html">ZuriHac: praticando programação funcional</a></li>
<li><a href="../pt460539/index.html">Tratamento de erros no Vue</a></li>
<li><a href="../pt460541/index.html">Procure contornos faciais em um milissegundo usando um conjunto de árvores de regressão</a></li>
<li><a href="../pt460543/index.html">Novas certificações para desenvolvedores da Cisco. Visão geral da certificação do setor</a></li>
<li><a href="../pt460547/index.html">Antiguidades: Psion 5MX e Vida Aposentada</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>