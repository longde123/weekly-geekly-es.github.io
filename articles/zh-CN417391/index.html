<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>™️ 🦗 🥁 用于自定义脚本的跨浏览器Web扩展第4部分 🍮 🏫 👍</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在本文中，我将完成一系列出版物，在这些出版物中，我想谈谈我为浏览器编写Web扩展的经验。 我已经有创建Web扩展的经验，该Web扩展由大约100,000个Chrome用户安装，它们可以自动工作，但是在本系列文章中，我决定通过将Web扩展与服务器端紧密集成来研究Web扩展的开发过程。 



 第1部...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>用于自定义脚本的跨浏览器Web扩展第4部分</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/417391/">在本文中，我将完成一系列出版物，在这些出版物中，我想谈谈我为浏览器编写Web扩展的经验。 我已经有创建Web扩展的经验，该Web扩展由大约100,000个Chrome用户安装，它们可以自动工作，但是在本系列文章中，我决定通过将Web扩展与服务器端紧密集成来研究Web扩展的开发过程。 <br><br><img width="65" src="https://habrastorage.org/getpro/habr/post_images/188/09a/2d6/18809a2d60126c22c85f0dbb38c188dc.png" alt="图片"><img width="65" src="https://habrastorage.org/getpro/habr/post_images/474/b37/7c9/474b377c9fd5df452ee6b2ae849c2891.png" alt="图片"><img width="65" src="https://habrastorage.org/getpro/habr/post_images/804/cc0/c91/804cc0c91bd30f83537540bd6aca22df.png" alt="图片"><img width="65" src="https://habrastorage.org/getpro/habr/post_images/94e/097/462/94e097462cb7f3af3b482312f6fd2ee9.png" alt="图片"><img width="65" src="https://habrastorage.org/getpro/habr/post_images/4bf/d73/6f6/4bfd736f6830e4396071afedad261bfd.png" alt="图片"><br><a name="habracut"></a><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第1部分</a> ， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第2</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">部分</a> ， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第3部分</a> <br><br><h1> 计划任务 </h1><br>  Web扩展允许您配置自定义脚本，以在页面加载完成后自动执行其代码。 例如，当您有一个相同类型的页面列表用于从脚本执行中爬网和接收数据时，这很方便。 或者，如果您需要删除Internet上任何页面上的烦人的广告，则可以使用代码来跟踪您在网络资源上的操作，将页面背景更改为深色等。 <br><br> 在这种情况下，通常有必要在每日计划模式下从页面接收数据。 例如，如果站点具有货币汇率，并且URL直接请求将保护散列参数。 作为此类副本，您可以考虑<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">欧洲中央银行</a>的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">网站</a> 。 在这种情况下，要获取当前汇率，您必须知道哈希URL才能获取XML格式的正确数据。 <br><br> 使用Web扩展程序，您可以设置通过脚本接收数据以请求汇率所需的频率。  Web扩展程序接受以Crown格式的字符串作为输入，因此，要获取每日模式的汇率，必须指定* * / 1 * * *。 <br><br> 从技术角度来看，服务器部分通过向Chromium浏览器页面添加用户脚本来启动Puppeteer。 在这种情况下，我们会面临Chromium进程随时间而有意关闭的问题，因为进程数的增加将不利地影响服务器端的整体性能。 如果您打算以周期性模式运行用户脚本来解决上述问题，则必须从用户脚本向Puppeteer发送请求以完成Chromium进程。 <br><br> 在对任务计划程序实现过程进行了长时间的测试之后，决定跟踪脚本控制台的输出。 因此，要停止Chromium进程，用户脚本必须在代码的必需部分中具有命令以停止该进程： <br><br><pre><code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'script is ended'</span></span>);</code> </pre> <br> 使用此命令，用户脚本可以关闭由Puppeteer生成的Chromium服务器进程。 这是通过跟踪Puppeteer“控制台”事件来实现的： <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//initialize browser and page page.on('console', async msg =&gt; { for (let i = 0; i &lt; msg.args().length; ++i) { if(await msg.args()[i].jsonValue() == 'script is ended') { await browser.close(); } } });</span></span></code> </pre><br> 如果用户脚本没有这样的命令，则要在任务计划程序模式下完成执行过程，必须强制计时器终止。 这是使用setTimeout以简单的方式实现的： <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> timeLimitCron = <span class="hljs-number"><span class="hljs-number">30</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> timeout = setTimeout(<span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(browser) { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> browser.close(); } clearTimeout(timeout); }, timeLimitCron * <span class="hljs-number"><span class="hljs-number">1000</span></span> ); <span class="hljs-comment"><span class="hljs-comment">//time limit for cron, then forced closing, default 30 seconds</span></span></code> </pre><br> 由于任务计划程序在服务器端运行，并且用户经常需要使用特定的IP地址，因此添加了使用代理服务器的选项。 <br><br><img src="https://habrastorage.org/webt/s2/sb/ko/s2sbko8uyscf31aksmaulyn7hus.png"><br><br> 用户还可以从Puppeteer控制台下载最新的消息日志。 例如，检查代理服务器的正确操作很方便。 <br><br><h1> 键盘快捷键 </h1><br> 在测试和现场测试期间，事实证明，对于某些类型的脚本，拥有热键以在Web资源上执行它们非常有用。 此类脚本的一个示例是Redability.js。 该脚本创建一个“干净的视图”以读取站点的内容。 也就是说，js库使用内容分析页面的结构，并允许您以很高的概率获取页面的标题，作者和内容。 之后，用户脚本可以覆盖Web资源的html，并允许用户以“纯格式”阅读，而无需不必要的标记，广告等。 <br><br> 最初，只有通过单击“执行”按钮才能从弹出的Web扩展中运行用户脚本。 与接口交互的逻辑通常是出于安全考虑。 但是在上面的示例中，它不允许您轻松地将Web资源的内容转换为“纯格式”。 <br><br> 如上所述，Web扩展允许您通过content.js使用DOM，但是由于window对象不是打开选项卡的窗口对象，因此不能用于例如存储参数。 此条件限制了Web扩展程序作为跟踪按键的对象的操作。 <br><br> 在要解决的问题中，有必要将“热键”从Web扩展界面传输到服务器端进行存储。 接下来，每次加载Web资源页面时，单击正确的组合后，将获得“热键”列表并加载用户脚本。  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Hotkeys.js</a>用作使用热键的库。 <br><br> 从服务器端收到热键列表后，将执行以下代码： <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hotKeysMap = {<span class="hljs-attr"><span class="hljs-attr">keys</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">id</span></span>: []}; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> data.response.data) { hotKeysMap.keys.push(data.response.data[i][<span class="hljs-string"><span class="hljs-string">'hotkeys'</span></span>]); hotKeysMap.id.push(data.response.data[i][<span class="hljs-string"><span class="hljs-string">"_id"</span></span>]); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(hotKeysMap.keys) { getScript(<span class="hljs-string"><span class="hljs-string">"hotkeys.js"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> script = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">"script"</span></span>); script.setAttribute(<span class="hljs-string"><span class="hljs-string">"class"</span></span>, <span class="hljs-string"><span class="hljs-string">"gCore-hotKeys"</span></span>); script.setAttribute(<span class="hljs-string"><span class="hljs-string">"data-endpoint"</span></span>, event.data.endPoint); script.setAttribute(<span class="hljs-string"><span class="hljs-string">"data-token"</span></span>, event.data.token); script.setAttribute(<span class="hljs-string"><span class="hljs-string">"data-userid"</span></span>, event.data.userId); script.innerHTML = <span class="hljs-string"><span class="hljs-string">"GChotKeys = JSON.parse(\""</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(hotKeysMap).replace(<span class="hljs-regexp"><span class="hljs-regexp">/"/g</span></span>, <span class="hljs-string"><span class="hljs-string">"\\\""</span></span>) + <span class="hljs-string"><span class="hljs-string">"\");\n"</span></span> + <span class="hljs-string"><span class="hljs-string">"hotkeys(GChotKeys.keys.join(','), function(event, handler) {"</span></span> + <span class="hljs-string"><span class="hljs-string">" event.preventDefault();"</span></span> + <span class="hljs-string"><span class="hljs-string">" localStorage.setItem('runHotKeysScript', GChotKeys.id[GChotKeys.keys.indexOf(handler.key)]);"</span></span> + <span class="hljs-string"><span class="hljs-string">"});"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.body.appendChild(script); }); }</code> </pre> <br>  getScript函数为script标记生成html代码，并将其写入Web资源页面。 因此，我们在每个页面上都具有跟踪按键的功能。 我们还需要传递一个与脚本ID匹配的热键数组来执行。 这是通过为script标签添加html代码来实现的，脚本标签的内容会初始化一个全局变量以JSON格式存储匹配数组。 <br><br> 上面已经提到，Web资源的打开页面与Web扩展的内容扩展extension.js脚本之间存在通信问题，该脚本用于操作DOM。 在这种情况下，您可以采用一种简单的技术来检查localStorage中的值，这是上述两个交互点的通用对象。 <br><br> 在content.js中，您只需每秒检查一次localStorage值，并执行与单击弹出式Web扩展中的“执行”按钮时相同的DOM操作。 <br><br><pre> <code class="javascript hljs">setInterval(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(localStorage.getItem(<span class="hljs-string"><span class="hljs-string">'runHotKeysScript'</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">// run user script localStorage.removeItem('runHotKeysScript'); } }, 1000);</span></span></code> </pre><br> 因此，实现了“热键”技术，使您可以使用内部库的功能快速启动用户脚本来解决实际问题。 <br><br><h1> 结论 </h1><br> 在该项目的实施过程中，解决了基于meteor.js和跨浏览器Web扩展在服务器部分之间编写集成的实际任务。 关键的绊脚石是SCP和客户端部分三个组件之间的交互过程-在浏览器中打开的页面，content.js和background.js脚本。 <br><br> 我希望我的经验将使编写更专业的跨浏览器Web扩展变得更容易。 <br><br> 将来，计划对Web扩展进行本地化并编写对社区有用的脚本。 如果读者有想法或希望帮助编写此类用户脚本，请用私人消息编写。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN417391/">https://habr.com/ru/post/zh-CN417391/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN417377/index.html">为什么不应该使用Google Cloud</a></li>
<li><a href="../zh-CN417379/index.html">适用于Vega-C和Ariane 6的新型固体推进剂火箭发动机</a></li>
<li><a href="../zh-CN417383/index.html">JavaScript ES6：弱点</a></li>
<li><a href="../zh-CN417385/index.html">我是如何搬家的...或者我对“无情面粉”文章作者的回答</a></li>
<li><a href="../zh-CN417389/index.html">倾斜移位镜效果</a></li>
<li><a href="../zh-CN417393/index.html">我们如何建立根据个人特征为客户分配折扣的系统</a></li>
<li><a href="../zh-CN417395/index.html">端到端测试：什么，为什么，为什么</a></li>
<li><a href="../zh-CN417397/index.html">2018年要学习哪种编程语言，为什么呢？</a></li>
<li><a href="../zh-CN417399/index.html">欢迎加入：向团队介绍新开发人员</a></li>
<li><a href="../zh-CN417401/index.html">最后，我们选择功能良好的预算万用表</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>