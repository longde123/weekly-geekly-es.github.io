<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ•Œ ãŠ™ï¸ â–¶ï¸ è¯·æ±‚çš„æ‰¹å¤„ç†é—®é¢˜åŠå…¶è§£å†³æ–¹æ¡ˆï¼ˆç¬¬2éƒ¨åˆ†ï¼‰ â­•ï¸ ğŸ† ğŸ‘¨ğŸ»â€ğŸ”§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="è¿™æ˜¯æ–‡ç« â€œè¯·æ±‚åŠå…¶å¤„ç†çš„æ‰¹å¤„ç†é—®é¢˜â€çš„ç»­ç¯‡ã€‚ å»ºè®®æ‚¨é¦–å…ˆç†Ÿæ‚‰ç¬¬ä¸€éƒ¨åˆ†ï¼Œå› ä¸ºå®ƒè¯¦ç»†æè¿°äº†é—®é¢˜çš„å®è´¨ä»¥åŠè§£å†³æ–¹æ¡ˆçš„ä¸€äº›æ–¹æ³•ã€‚ åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹çœ‹å…¶ä»–æ–¹æ³•ã€‚ 

 ç›®å½•å†…å®¹  ç®€çŸ­é‡å¤ä»»åŠ¡ 
 å¢åŠ å¥—é¤ 
 é€†å‘å·¥ç¨‹ 
 æ”¶é›†æ‰€æœ‰è¯·æ±‚ 
 å¹³è¡Œæ€§ 
 é—®é¢˜æ‰€åœ¨ 
 ç»“è®º 
 ä¸šåŠ¡å¯å‘æ³• 
 è§£å†³åˆåŒé—®é¢˜ 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>è¯·æ±‚çš„æ‰¹å¤„ç†é—®é¢˜åŠå…¶è§£å†³æ–¹æ¡ˆï¼ˆç¬¬2éƒ¨åˆ†ï¼‰</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/custis/blog/467919/"><img src="https://habrastorage.org/webt/ad/_6/oe/ad_6oeq50j8z5q33t5ixjrcssqs.jpeg"><br> è¿™æ˜¯æ–‡ç« <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">â€œè¯·æ±‚åŠå…¶å¤„ç†çš„æ‰¹å¤„ç†é—®é¢˜â€</a>çš„ç»­ç¯‡ã€‚ å»ºè®®æ‚¨é¦–å…ˆç†Ÿæ‚‰ç¬¬ä¸€éƒ¨åˆ†ï¼Œå› ä¸ºå®ƒè¯¦ç»†æè¿°äº†é—®é¢˜çš„å®è´¨ä»¥åŠè§£å†³æ–¹æ¡ˆçš„ä¸€äº›æ–¹æ³•ã€‚ åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹çœ‹å…¶ä»–æ–¹æ³•ã€‚ <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">ç›®å½•å†…å®¹</b> <div class="spoiler_text">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç®€çŸ­é‡å¤ä»»åŠ¡</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¢åŠ å¥—é¤</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é€†å‘å·¥ç¨‹</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ”¶é›†æ‰€æœ‰è¯·æ±‚</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¹³è¡Œæ€§</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é—®é¢˜æ‰€åœ¨</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç»“è®º</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¸šåŠ¡å¯å‘æ³•</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è§£å†³åˆåŒé—®é¢˜</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æœç´¢æœ‰ç”¨çš„é™åˆ¶</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¯å‘å¼é”™è¯¯</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç»“è®º</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">DDDæ ·å¼çš„å•ä½</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">èšé›†å†…å‡çº§æŸ¥è¯¢çš„é€»è¾‘</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç”¨äºåœ¨æ±‡æ€»ä¹‹å¤–æ±‡æ€»æŸ¥è¯¢çš„é€»è¾‘</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç»“è®º</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä»£ç†å’ŒåŒé‡é€šè¯</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è§£å†³åˆåŒé—®é¢˜</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç»“è®º</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç»“è®º</a> </div></div><br><a name="Revision"></a><h2> ç®€çŸ­é‡å¤ä»»åŠ¡ </h2><br> é€šè¿‡èŠå¤©å¯ä»¥å°†æ–‡æ¡£ä¸ä¸€ç»„é¢„å®šä¹‰çš„å‚ä¸è€…è¿›è¡Œåè°ƒã€‚ æ¶ˆæ¯åŒ…å«æ–‡æœ¬å’Œæ–‡ä»¶ã€‚ è€Œä¸”ï¼Œå°±åƒåœ¨å¸¸è§„èŠå¤©ä¸­ä¸€æ ·ï¼Œæ¶ˆæ¯å¯ä»¥è¢«ç­”å¤å’Œè½¬å‘ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">èŠå¤©æ¶ˆæ¯æ¨¡å‹</b> <div class="spoiler_text"><code><font color="7f0055"><b>data class</b></font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">(</font> <br> <font color="3f7f5f">// nullable      persist</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">id</font> : <font color="3e7eff"><b>Long</b></font> ? <font color="333333">=</font> <font color="7f0055"><b>null</b></font> <font color="333333">,</font> <br> <font color="395da1">/**    */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">author</font> : <font color="3e7eff"><b>UserReference</b></font> <font color="333333">,</font> <br> <font color="395da1">/**  */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">message</font> : <font color="3e7eff"><b>String</b></font> <font color="333333">,</font> <br> <font color="395da1">/**    */</font> <br> <font color="3f7f5f">// -   JPA+    null,   </font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">files</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileReference</b></font> <font color="333333">&gt;</font> ? <font color="333333">=</font> <font color="7f0055"><b>null</b></font> <font color="333333">,</font> <br> <font color="395da1">/**   ,     */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">replyTo</font> : <font color="3e7eff"><b>ChatMessage</b></font> ? <font color="333333">=</font> <font color="7f0055"><b>null</b></font> <font color="333333">,</font> <br> <font color="395da1">/**   ,     */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">forwardFrom</font> : <font color="3e7eff"><b>ChatMessage</b></font> ? <font color="333333">=</font> <font color="7f0055"><b>null</b></font> <br> <font color="000066">)</font></code> </div> </div><br><div class="spoiler">  <b class="spoiler_title">é€šè¿‡ä¾èµ–æ³¨å…¥ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä»¥ä¸‹å¤–éƒ¨æœåŠ¡ï¼š</b> <div class="spoiler_text"> <code><font color="7f0055"><b>interface</b></font> <font color="3e7eff"><b>ChatMessageRepository</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>findLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="333333">&gt;</font> <br> <font color="000066">}</font> <br> <br> <font color="7f0055"><b>data class</b></font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">id</font> : <font color="3e7eff"><b>FileReference</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">name</font> : <font color="3e7eff"><b>String</b></font> <br> <font color="000066">)</font> <br> <br> <font color="7f0055"><b>interface</b></font> <font color="3e7eff"><b>FileRemoteApi</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getHeadById</b></font> <font color="000066">(</font> <font color="000066"><i>id</i></font> : <font color="3e7eff"><b>FileReference</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>FileHeadRemote</b></font> <br> <font color="3e7eff"><b>&nbsp;&nbsp;</b></font> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getHeadsByIds</b></font> <font color="000066">(</font> <font color="000066"><i>id</i></font> : <font color="3e7eff"><b>Set</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileReference</b></font> <font color="333333">&gt;</font> <font color="000066">)</font> : <font color="3e7eff"><b>Set</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="333333">&gt;</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getHeadsByIds</b></font> <font color="000066">(</font> <font color="000066"><i>id</i></font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileReference</b></font> <font color="333333">&gt;</font> <font color="000066">)</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="333333">&gt;</font> <br> <font color="000066">}</font> <br> <br> <font color="7f0055"><b>data class</b></font> <font color="3e7eff"><b>UserRemote</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">id</font> : <font color="3e7eff"><b>UserReference</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">name</font> : <font color="3e7eff"><b>String</b></font> <br> <font color="000066">)</font> <br> <br> <font color="7f0055"><b>interface</b></font> <font color="3e7eff"><b>UserRemoteApi</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getUserById</b></font> <font color="000066">(</font> <font color="000066"><i>id</i></font> : <font color="3e7eff"><b>UserReference</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>UserRemote</b></font> <br> <font color="3e7eff"><b>&nbsp;&nbsp;</b></font> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getUsersByIds</b></font> <font color="000066">(</font> <font color="000066"><i>id</i></font> : <font color="3e7eff"><b>Set</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>UserReference</b></font> <font color="333333">&gt;</font> <font color="000066">)</font> : <font color="3e7eff"><b>Set</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>UserRemote</b></font> <font color="333333">&gt;</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getUsersByIds</b></font> <font color="000066">(</font> <font color="000066"><i>id</i></font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>UserReference</b></font> <font color="333333">&gt;</font> <font color="000066">)</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>UserRemote</b></font> <font color="333333">&gt;</font> <br> <font color="000066">}</font></code> </div> </div><br> æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªRESTæ§åˆ¶å™¨ï¼š <br><br> <code><font color="7f0055"><b>interface</b></font> <font color="3e7eff"><b>ChatRestApi</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="333333">&gt;</font> <br> <font color="000066">}</font></code> <br> <br><div class="spoiler">  <b class="spoiler_title">å…¶ä¸­ï¼š</b> <div class="spoiler_text"> <code><font color="395da1">/**          */</font> <br> <font color="7f0055"><b>data class</b></font> <font color="3e7eff"><b>ReferenceUI</b></font> <font color="000066">(</font> <br> <font color="395da1">/**   url */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">ref</font> : <font color="3e7eff"><b>String</b></font> <font color="333333">,</font> <br> <font color="395da1">/**     */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">name</font> : <font color="3e7eff"><b>String</b></font> <br> <font color="000066">)</font> <br> <br> <font color="7f0055"><b>data class</b></font> <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">id</font> : <font color="3e7eff"><b>Long</b></font> <font color="333333">,</font> <br> <font color="395da1">/**    */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">author</font> : <font color="3e7eff"><b>ReferenceUI</b></font> <font color="333333">,</font> <br> <font color="395da1">/**  */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">message</font> : <font color="3e7eff"><b>String</b></font> <font color="333333">,</font> <br> <font color="395da1">/**    */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">files</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ReferenceUI</b></font> <font color="333333">&gt;,</font> <br> <font color="395da1">/**   ,     */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">replyTo</font> : <font color="3e7eff"><b>ChatMessageUI</b></font> ? <font color="333333">=</font> <font color="7f0055"><b>null</b></font> <font color="333333">,</font> <br> <font color="395da1">/**   ,     */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">forwardFrom</font> : <font color="3e7eff"><b>ChatMessageUI</b></font> ? <font color="333333">=</font> <font color="7f0055"><b>null</b></font> <br> <font color="000066">)</font> <br></code> </div></div><br> åœ¨ä¸Šä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬ç ”ç©¶äº†ä½¿ç”¨æ‰¹å¤„ç†çš„æœåŠ¡çš„æœ´ç´ å®ç°ä»¥åŠå‡ ç§åŠ é€Ÿå®ƒçš„æ–¹æ³•ã€‚ è¿™äº›æ–¹æ³•éå¸¸ç®€å•ï¼Œä½†æ˜¯å®ƒä»¬çš„åº”ç”¨ç¨‹åºä¸èƒ½æä¾›è¶³å¤Ÿå¥½çš„æ€§èƒ½ã€‚ <br><br><a name="Enlargement"></a><h2> å¢åŠ å¥—é¤ </h2><br> å¤©çœŸçš„è§£å†³æ–¹æ¡ˆçš„ä¸»è¦é—®é¢˜æ˜¯åŒ…è£…å°ºå¯¸å°ã€‚ <br><br> ä¸ºäº†å°†å‘¼å«åˆ†ç»„ä¸ºæ›´å¤§çš„æ•°æ®åŒ…ï¼Œæ‚¨éœ€è¦ä»¥æŸç§æ–¹å¼ç´¯ç§¯è¯·æ±‚ã€‚ è¯¥è¡Œå¹¶ä¸æ„å‘³ç€è¯·æ±‚çš„ç´¯ç§¯ï¼š <br><br> <code><font color="4a86e8">author =</font> <font color="566874">userRepository</font> <font color="333333">.</font> <font color="170591">getUserById</font> <font color="000066">(</font> <font color="566874">author</font> <font color="000066">)</font> <font color="333333">.</font> <i><b>toFrontReference</b></i> <font color="000066">()</font> <font color="333333">,</font></code> <br> <br> ç°åœ¨ï¼Œåœ¨æˆ‘ä»¬çš„è¿è¡Œæ—¶ä¸­ï¼Œæ²¡æœ‰ç‰¹æ®Šçš„ä½ç½®å¯ä»¥å­˜å‚¨ç”¨æˆ·åˆ—è¡¨-å®ƒæ­£åœ¨é€æ­¥å½¢æˆã€‚ è¿™å°†ä¸å¾—ä¸æ”¹å˜ã€‚ <br><br> é¦–å…ˆï¼Œæ‚¨éœ€è¦åœ¨ChatMessage.toFrontModelæ–¹æ³•ä¸­å°†æ•°æ®è·å–çš„é€»è¾‘ä¸æ˜ å°„åˆ†å¼€ï¼š <br><br> <code><font color="7f0055"><b>private fun</b></font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="333333">.</font> <font color="170591"><b>toFrontModel</b></font> <font color="000066">(</font> <br> <font color="000066"><i>getUser</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>UserReference</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>UserRemote</b></font> <font color="333333">,</font> <br> <font color="000066"><i>getFile</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>FileReference</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="333333">,</font> <br> <font color="000066"><i>serializeMessage</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>ChatMessageUI</b></font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="333333">=</font> <br> <font color="170591">ChatMessageUI</font> <font color="000066">(</font> <br> <font color="4a86e8">id =</font> <font color="566874">id</font> ?: <font color="7f0055"><b>throw</b></font> <font color="170591">IllegalStateException</font> <font color="000066">(</font> <b>"</b> <font color="333333"><b>$</b></font> <font color="7f0055"><b>this</b></font> <b>must be persisted"</b> <font color="000066">)</font> <font color="333333">,</font> <br> <font color="4a86e8">author =</font> <font color="000066"><i>getUser</i></font> <font color="000066">(</font> <font color="566874">author</font> <font color="000066">)</font> <font color="333333">.</font> <i><b>toFrontReference</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="4a86e8">message =</font> <font color="566874">message</font> <font color="333333">,</font> <br> <font color="4a86e8">files =</font> <font color="566874">files</font> <font color="333333">?.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <b>it</b> <font color="333333">.</font> <i><b>map</b></i> <font color="000066">(</font> <font color="000066"><i>getFile</i></font> <font color="000066">)</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <i><b>toFrontReference</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="4a86e8">forwardFrom =</font> <font color="566874">forwardFrom</font> <font color="333333">?.</font> <i><b>let</b></i> <font color="000066">(</font> <font color="000066"><i>serializeMessage</i></font> <font color="000066">)</font> <font color="333333">,</font> <br> <font color="4a86e8">replyTo =</font> <font color="566874">replyTo</font> <font color="333333">?.</font> <i><b>let</b></i> <font color="000066">(</font> <font color="000066"><i>serializeMessage</i></font> <font color="000066">)</font> <br> <font color="000066">)</font></code> <br> <br> äº‹å®è¯æ˜ï¼Œæ­¤å‡½æ•°ä»…ä¾èµ–äºä¸‰ä¸ªå¤–éƒ¨å‡½æ•°ï¼ˆè€Œä¸åƒæœ€åˆé‚£æ ·ä¾èµ–äºæ•´ä¸ªç±»ï¼‰ã€‚ <br><br> ç»è¿‡è¿™æ ·çš„é‡åšåï¼ŒåŠŸèƒ½çš„ä¸»ä½“å¹¶æ²¡æœ‰å˜å¾—æ›´åŠ æ¸…æ™°ï¼ŒåˆåŒä¹Ÿå˜å¾—æ›´åŠ è‰°å·¨ï¼ˆè¿™æ—¢æœ‰åˆ©åˆæœ‰å¼Šï¼‰ã€‚ <br><br> å®é™…ä¸Šï¼Œæ‚¨ä¸èƒ½ç¼©å°åå®šèŒƒå›´ï¼Œå¹¶ä¿ç•™å¯¹æ¥å£çš„ä¾èµ–æ€§ã€‚ æœ€ä¸»è¦çš„æ˜¯ï¼Œå®ƒä»¬ç»å¯¹æ²¡æœ‰å¤šä½™ï¼Œå› ä¸ºæˆ‘ä»¬å°†éœ€è¦æ‰§è¡Œå…¶ä»–å®ç°ã€‚ <br><br> ç”±äºserializeMessageå‡½æ•°ç±»ä¼¼äºé€’å½’å‡½æ•°ï¼Œå› æ­¤å¯ä»¥åœ¨é‡æ„çš„ç¬¬ä¸€æ­¥ä¸­ä½œä¸ºæ˜¾å¼é€’å½’æ¥å®Œæˆï¼š <br><br> <code><font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>ChatRestController</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">messageRepository</font> : <font color="3e7eff"><b>ChatMessageRepository</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">userRepository</font> : <font color="3e7eff"><b>UserRemoteApi</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">fileRepository</font> : <font color="3e7eff"><b>FileRemoteApi</b></font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>ChatRestApi</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>override fun</b></font> <font color="170591"><b>getLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font></code> <br> <br> æˆ‘ä¸ºtoFrontModelæ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªå­˜æ ¹ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œè¯¥å­˜æ ¹çš„å·¥ä½œæ–¹å¼ä¸æˆ‘ä»¬ç¬¬ä¸€ä¸ªç®€å•çš„å®ç°å®Œå…¨ç›¸åŒï¼ˆæ‰€æœ‰ä¸‰ä¸ªå¤–éƒ¨åŠŸèƒ½çš„å®ç°éƒ½ç›¸åŒï¼‰ã€‚ <br><br> <code><font color="7f0055"><b>private fun</b></font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="333333">.</font> <font color="170591"><b>toFrontModel</b></font> <font color="000066">()</font> : <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="333333">=</font> <br> <i><b>toFrontModel</b></i> <font color="000066">(</font> <br> <font color="4a86e8">getUser =</font> <font color="566874">userRepository</font> ::getUserById <font color="333333">,</font> <br> <font color="4a86e8">getFile =</font> <font color="566874">fileRepository</font> ::getHeadById <font color="333333">,</font> <br> <font color="4a86e8">serializeMessage =</font> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;</b></font> <font color="000066">)</font></code> <br> <br> ä½†æ˜¯æˆ‘ä»¬éœ€è¦ä½¿getUserï¼ŒgetFileå’ŒserializeMessageå‡½æ•°æœ‰æ•ˆåœ°å·¥ä½œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä»¥é€‚å½“å¤§å°ï¼ˆç†è®ºä¸Šæ¯ä¸ªæœåŠ¡çš„å¤§å°å¯ä»¥ä¸åŒï¼‰çš„æ•°æ®åŒ…å°†è¯·æ±‚å‘é€åˆ°é€‚å½“çš„æœåŠ¡ï¼Œæˆ–è€…å¦‚æœå…è®¸æ— é™åˆ¶çš„è¯·æ±‚ï¼Œé€šå¸¸æ¯ä¸ªæœåŠ¡ä¸€ä¸ªè¯·æ±‚ã€‚ <br><br> å®ç°æ­¤åˆ†ç»„çš„æœ€ç®€å•æ–¹æ³•æ˜¯ï¼Œåœ¨å¼€å§‹å¤„ç†ä¹‹å‰æ‰‹å¤´æœ‰æ‰€æœ‰å¿…è¦çš„æŸ¥è¯¢ã€‚ ä¸ºæ­¤ï¼Œåœ¨è°ƒç”¨toFrontModelä¹‹å‰ï¼Œè¯·æ”¶é›†æ‰€æœ‰å¿…è¦çš„é“¾æ¥ï¼Œè¿›è¡Œæ‰¹å¤„ç†ï¼Œç„¶åä½¿ç”¨ç»“æœã€‚ <br><br> æ‚¨è¿˜å¯ä»¥å°è¯•é€šè¿‡ç´¯ç§¯è¯·æ±‚å’Œé€æ­¥æ‰§è¡Œè¯¥æ–¹æ¡ˆã€‚ ä½†æ˜¯ï¼Œè¿™æ ·çš„æ–¹æ¡ˆå°†éœ€è¦å¼‚æ­¥æ‰§è¡Œï¼Œä½†æ˜¯ç°åœ¨æˆ‘ä»¬å°†é›†ä¸­åœ¨åŒæ­¥æ–¹æ¡ˆä¸Šã€‚ <br><br> å› æ­¤ï¼Œä¸ºäº†å¼€å§‹ä½¿ç”¨æ‰¹å¤„ç†ï¼Œæˆ‘ä»¬å¿…é¡»é¢„å…ˆæ‰¾å‡ºæˆ‘ä»¬å°†è¦æå‡ºçš„å°½å¯èƒ½å¤šçš„è¯·æ±‚ï¼ˆæœ€å¥½æ˜¯å…¨éƒ¨ï¼‰ã€‚ å¦‚æœæˆ‘ä»¬è°ˆè®ºçš„æ˜¯RESTæ§åˆ¶å™¨ï¼Œåˆ™æœ€å¥½åœ¨æ•´ä¸ªä¼šè¯æœŸé—´åˆå¹¶å¯¹æ¯ä¸ªæœåŠ¡çš„è¯·æ±‚ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">åˆ†ç»„æ‰€æœ‰é€šè¯</b> <div class="spoiler_text"> åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯ä»¥ç«‹å³è·å–ä¼šè¯ä¸­æ‰€æœ‰å¿…è¦çš„æ•°æ®ï¼Œå¹¶ä¸”ä¸ä¼šå¯¼è‡´æ¥è‡ªè¯·æ±‚å‘èµ·è€…æˆ–æ‰§è¡Œè€…çš„èµ„æºé—®é¢˜ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸èƒ½é™åˆ¶ç”¨äºè°ƒç”¨æœåŠ¡çš„æ•°æ®åŒ…å¤§å°ï¼Œå¹¶ä¸”ç«‹å³ç«‹å³æ¥æ”¶æ‰€æœ‰æ•°æ®ã€‚ <br><br> ä½¿ç”Ÿæ´»æ›´è½»æ¾çš„å¦ä¸€ä¸ªå‡è®¾æ˜¯å‡è®¾å‘èµ·è€…æœ‰è¶³å¤Ÿçš„èµ„æºæ¥å¤„ç†æ‰€æœ‰æ•°æ®ã€‚ å¦‚æœéœ€è¦ï¼Œå¯¹å¤–éƒ¨æœåŠ¡çš„è¯·æ±‚ä¹Ÿå¯ä»¥ä»¥æœ‰é™çš„åŒ…å½¢å¼å‘é€ã€‚ <br><br> åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé€»è¾‘çš„ç®€åŒ–æ¶‰åŠå¦‚ä½•å°†éœ€è¦æ•°æ®çš„ä½ç½®ä¸è°ƒç”¨ç»“æœè¿›è¡Œæ¯”è¾ƒã€‚ å¦‚æœæˆ‘ä»¬è®¤ä¸ºå‘èµ·æ–¹çš„èµ„æºéå¸¸æœ‰é™ï¼Œå¹¶ä¸”åŒæ—¶å°è¯•æœ€å°åŒ–å¤–éƒ¨è°ƒç”¨çš„æ•°é‡ï¼Œé‚£ä¹ˆå¯¹äºå›¾çš„æœ€ä½³è£å‰ªï¼Œæˆ‘ä»¬å°†é¢ä¸´ä¸€é¡¹è‰°å·¨çš„ä»»åŠ¡ã€‚ æœ€æœ‰å¯èƒ½çš„æ˜¯ï¼Œæ‚¨åªéœ€è¦ç‰ºç‰²æ€§èƒ½æ¥å‡å°‘èµ„æºæ¶ˆè€—ã€‚ <br><br> æˆ‘ä»¬å°†è€ƒè™‘åˆ°ï¼Œåœ¨æˆ‘ä»¬çš„æ¼”ç¤ºé¡¹ç›®ä¸­ï¼Œå‘èµ·è€…çš„èµ„æºæ²¡æœ‰ç‰¹åˆ«é™åˆ¶ï¼Œä»–å¯ä»¥æ¥æ”¶æ‰€æœ‰å¿…è¦çš„æ•°æ®å¹¶å°†å…¶å­˜å‚¨åˆ°ä¼šè¯ç»“æŸã€‚ å¦‚æœèµ„æºæœ‰é—®é¢˜ï¼Œæˆ‘ä»¬å°†è¿›è¡Œè¾ƒå°çš„åˆ†é¡µã€‚ <br><br> ç”±äºåœ¨æˆ‘çš„å®è·µä¸­ï¼Œæœ€éœ€è¦è¿™ç§æ–¹æ³•ï¼Œå› æ­¤æ›´å¤šç¤ºä¾‹å°†æ¶‰åŠæ­¤é€‰é¡¹ã€‚ </div></div><br> æˆ‘ä»¬å¯ä»¥åŒºåˆ†è·å¾—å¤§é‡æŸ¥è¯¢çš„æ­¤ç±»æ–¹æ³•ï¼š <br><br><ul><li> é€†å‘å·¥ç¨‹ï¼› </li><li> ä¸šåŠ¡å¯å‘æ³•ï¼› </li><li> ä»¥DDDæ ·å¼èšåˆï¼› </li><li> ä»£ç†å’ŒåŒé‡é€šè¯ã€‚ </li></ul><br> è®©æˆ‘ä»¬æµè§ˆä¸€ä¸‹é¡¹ç›®ç¤ºä¾‹ä¸­çš„æ‰€æœ‰é€‰é¡¹ã€‚ <br><br><a name="ReverseEngineering"></a><h4> é€†å‘å·¥ç¨‹ </h4><br><a name="RequirementsGathering"></a>  <b>æ”¶é›†æ‰€æœ‰è¯·æ±‚</b> <br><br> ç”±äºæˆ‘ä»¬å…·æœ‰ç”¨äºå®ç°æ”¶é›†ä¿¡æ¯å¹¶å°†å…¶è½¬æ¢ä¸ºå‰ç«¯çš„æ‰€æœ‰åŠŸèƒ½çš„ä»£ç ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è¿›è¡Œé€†å‘å·¥ç¨‹ï¼Œå¹¶ä¸”ä»æ­¤ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥äº†è§£å°†è¦å‘å‡ºçš„è¯·æ±‚ï¼š <br><br> <code><font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>ChatRestController</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">messageRepository</font> : <font color="3e7eff"><b>ChatMessageRepository</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">userRepository</font> : <font color="3e7eff"><b>UserRemoteApi</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">fileRepository</font> : <font color="3e7eff"><b>FileRemoteApi</b></font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>ChatRestApi</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>override fun</b></font> getLast <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>messages</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//    ,  forward  reply</font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">allMessages</font> <font color="333333">=</font> <font color="000066"><i>messages</i></font> <font color="333333">.</font> <i><b>asSequence</b></i> <font color="000066">()</font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>sequenceOf</b></i> <font color="000066">(</font> <font color="000066"><i>it</i></font> <font color="333333">,</font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">forwardFrom</font> <font color="333333">,</font> <b>it</b> <font color="333333">.</font> <font color="566874">replyTo</font> <font color="000066">)</font> <font color="333333">.</font> <i><b>filterNotNull</b></i> <font color="000066">()</font> <br> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">()</font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">allUserReq</font> <font color="333333">=</font> <font color="170591">allMessages</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">author</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="7f0055"><b>val</b></font> <font color="170591">allFileReq</font> <font color="333333">=</font> <font color="170591">allMessages</font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">files</font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">()</font></code> <br> <br> æ‰€æœ‰è¯·æ±‚å‡å·²æ”¶é›†ï¼Œç°åœ¨æ‚¨éœ€è¦è¿›è¡Œå®é™…çš„æ‰¹å¤„ç†ã€‚ <br><br> å¯¹äºallUserReqå’ŒallFileReqï¼Œæˆ‘ä»¬è¿›è¡Œå¤–éƒ¨æŸ¥è¯¢å¹¶æŒ‰IDè¿›è¡Œåˆ†ç»„ã€‚ å¦‚æœå¯¹åŒ…è£…çš„å¤§å°æ²¡æœ‰é™åˆ¶ï¼Œé‚£ä¹ˆå®ƒå°†çœ‹èµ·æ¥åƒè¿™æ ·ï¼š <br><br> <code><font color="566874">userRepository</font> <font color="333333">.</font> <font color="170591">getUsersByIds</font> <font color="000066">(</font> <font color="170591">allMessages</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">author</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">())</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get <br> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByIds</font> <font color="000066">(</font> <font color="170591">allMessages</font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">files</font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">())</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get</code> <br> <br> å¦‚æœæœ‰é™åˆ¶ï¼Œé‚£ä¹ˆä»£ç å°†é‡‡ç”¨ä»¥ä¸‹å½¢å¼ï¼š <br><br> <code><font color="7f0055"><b>val</b></font> <font color="170591">userApiChunkLimit</font> <font color="333333">=</font> <font color="333333"><b>100</b></font> <br> <font color="170591">allMessages</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">author</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>asSequence</b></i> <font color="000066">()</font> <font color="333333">.</font> <i><b>distinct</b></i> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>chunked</b></i> <font color="000066">(</font> <font color="170591">userApiChunkLimit</font> <font color="333333">,</font> <font color="566874">userRepository</font> ::getUsersByIds <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>flatten</b></i> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get</code> <br> <br> ä¸å¹¸çš„æ˜¯ï¼Œä¸Streamä¸åŒï¼ŒSequenceæ— æ³•è½»æ¾åˆ‡æ¢åˆ°å¹¶è¡Œæ•°æ®åŒ…è¯·æ±‚ã€‚ <br><br> å¦‚æœæ‚¨è®¤ä¸ºå¹¶è¡ŒæŸ¥è¯¢æ˜¯æœ‰æ•ˆä¸”å¿…è¦çš„ï¼Œåˆ™å¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š <br><br> <code><font color="170591">allMessages</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">author</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <font color="170591">parallelStream</font> <font color="000066">()</font> <font color="333333">.</font> <font color="170591">distinct</font> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>chunked</b></i> <font color="000066">(</font> <font color="05314d"><b>userApiChunkLimit</b></font> <font color="333333">,</font> <font color="566874">userRepository</font> ::getUsersByIds <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>flatten</b></i> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get</code> <br> <br> å¯ä»¥çœ‹å‡ºï¼Œæ²¡æœ‰ä»€ä¹ˆå¤ªå¤§å˜åŒ–ã€‚ ä½¿ç”¨ä¸€å®šæ•°é‡çš„Kotliné­”æœ¯å¯ä»¥å¸®åŠ©æˆ‘ä»¬ï¼š <br><br> <code><font color="7f0055"><b>fun</b></font> <font color="333333">&lt;</font> <font color="000066"><i>T</i></font> <font color="333333">,</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="3e7eff"><b>Stream</b></font> <font color="333333">&lt;</font> <font color="7f0055"><b>out</b></font> <font color="000066"><i>T</i></font> <font color="333333">&gt;.</font> <font color="170591"><b>chunked</b></font> <font color="000066">(</font> <font color="000066"><i>size</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="333333">,</font> <font color="000066"><i>transform</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="000066"><i>T</i></font> <font color="333333">&gt;</font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="000066">)</font> : <font color="3e7eff"><b>Stream</b></font> <font color="333333">&lt;</font> <font color="7f0055"><b>out</b></font> <font color="000066"><i>R</i></font> <font color="333333">&gt; =</font> <br> <i><b>batches</b></i> <font color="000066">(</font> <font color="7f0055"><b>this</b></font> <font color="333333">,</font> <font color="000066"><i>size</i></font> <font color="000066">)</font> <font color="333333">.</font> <font color="170591">map</font> <font color="000066">(</font> <font color="000066"><i>transform</i></font> <font color="000066">)</font> <br> <br> <font color="7f0055"><b>fun</b></font> <font color="333333">&lt;</font> <font color="000066"><i>T</i></font> <font color="333333">&gt;</font> <font color="3e7eff"><b>Stream</b></font> <font color="333333">&lt;</font> <font color="7f0055"><b>out</b></font> <font color="3e7eff"><b>Collection</b></font> <font color="333333">&lt;</font> <font color="000066"><i>T</i></font> <font color="333333">&gt;&gt;.</font> <font color="170591"><b>flatten</b></font> <font color="000066">()</font> : <font color="3e7eff"><b>Stream</b></font> <font color="333333">&lt;</font> <font color="000066"><i>T</i></font> <font color="333333">&gt; =</font> <br> <font color="170591">flatMap</font> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="170591">stream</font> <font color="000066">()</font> <font color="000066"><b>}</b></font> <br> <br> <font color="7f0055"><b>fun</b></font> <font color="333333">&lt;</font> <font color="000066"><i>T</i></font> <font color="333333">,</font> <font color="000066"><i>K</i></font> <font color="333333">&gt;</font> <font color="3e7eff"><b>Stream</b></font> <font color="333333">&lt;</font> <font color="000066"><i>T</i></font> <font color="333333">&gt;.</font> <font color="170591"><b>associateBy</b></font> <font color="000066">(</font> <font color="000066"><i>keySelector</i></font> : <font color="000066">(</font> <font color="000066"><i>T</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>K</i></font> <font color="000066">)</font> : <font color="3e7eff"><b>Map</b></font> <font color="333333">&lt;</font> <font color="000066"><i>K</i></font> <font color="333333">,</font> <font color="000066"><i>T</i></font> <font color="333333">&gt; =</font> <br> <font color="170591">collect</font> <font color="000066">(</font> <font color="3e7eff"><b>Collectors</b></font> <font color="333333">.</font> <font color="170591">toMap</font> <font color="000066">(</font> <font color="000066"><i>keySelector</i></font> <font color="333333">,</font> <font color="000066"><b>{</b></font> <b>it</b> <font color="000066"><b>}</b></font> <font color="000066">))</font></code> <br> <br><div class="spoiler">  <b class="spoiler_title">ç°åœ¨ä»ç„¶å¯ä»¥å°†æ‰€æœ‰å†…å®¹æ”¾åœ¨ä¸€èµ·ï¼š</b> <div class="spoiler_text"> <code><font color="7f0055"><b>override fun</b></font> <font color="170591"><b>getLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>messages</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//    ,  forward  reply</font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">allMessages</font> <font color="333333">=</font> <font color="000066"><i>messages</i></font> <font color="333333">.</font> <i><b>asSequence</b></i> <font color="000066">()</font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>sequenceOf</b></i> <font color="000066">(</font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <font color="566874">forwardFrom</font> <font color="333333">,</font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <font color="566874">replyTo</font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>filterNotNull</b></i> <font color="000066">()</font> <br> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">()</font> <br> <br> <font color="000066"><i>messages</i></font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066">(</font> <font color="170591">ValueHolder</font> <font color="333333">&lt;</font> <font color="000066">(</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="333333">&gt;</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>apply</b></i> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="566874">value</font> <font color="333333">=</font> <i><b>memoize</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> : <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">(</font> <br> <font color="3f7f5f">//       ,    </font> <br> <font color="4a86e8">getUser =</font> <font color="3e7eff"><b>allMessages</b></font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">author</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <font color="170591">parallelStream</font> <font color="000066">()</font> <font color="333333">.</font> <font color="170591">distinct</font> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>chunked</b></i> <font color="000066">(</font> <font color="05314d"><b>userApiChunkLimit</b></font> <font color="333333">,</font> <font color="566874">userRepository</font> ::getUsersByIds <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>flatten</b></i> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"User</b> <font color="333333"><b>$</b></font> <b>it"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="3f7f5f">//        </font> <br> <font color="4a86e8">getFile =</font> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByIds</font> <font color="000066">(</font> <font color="3e7eff"><b>allMessages</b></font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">files</font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">())</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"File</b> <font color="333333"><b>$</b></font> <b>it"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="3f7f5f">//       </font> <br> <font color="4a86e8">serializeMessage =</font> <font color="566874">value</font> <br> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> <font color="333333">.</font> <font color="566874">value</font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font></code> </div> </div><br><div class="spoiler">  <b class="spoiler_title">è§£é‡Šå’Œç®€åŒ–</b> <div class="spoiler_text"> è‚¯å®šä¼šå¼•èµ·æ‚¨æ³¨æ„çš„ç¬¬ä¸€ä»¶äº‹æ˜¯å¤‡å¿˜å½•åŠŸèƒ½ã€‚ äº‹å®æ˜¯ï¼Œå‡ ä¹è‚¯å®šä¼šä¸ºç›¸åŒçš„æ¶ˆæ¯å¤šæ¬¡è°ƒç”¨serializeMessageå‡½æ•°ï¼ˆç”±äºå›å¤å’Œè½¬å‘ï¼‰ã€‚ ä¸æ¸…æ¥šä¸ºä»€ä¹ˆæˆ‘ä»¬åº”è¯¥ä¸ºæ¯ä¸ªè¿™æ ·çš„æ¶ˆæ¯åˆ†åˆ«è¿›è¡ŒtoFrontModelï¼ˆåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè¿™æ˜¯å¿…è¦çš„ï¼Œä½†ä¸æ˜¯æˆ‘ä»¬çš„è¦æ±‚ï¼‰ã€‚ å› æ­¤ï¼Œæ‚¨å¯ä»¥å¯¹serializeMessageå‡½æ•°è¿›è¡Œè®°å¿†ã€‚ ä¾‹å¦‚ï¼Œå¯ä»¥å¦‚ä¸‹å®ç°ï¼š <br><br> <code><font color="7f0055"><b>fun</b></font> <font color="333333">&lt;</font> <font color="000066"><i>A</i></font> <font color="333333">,</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="170591"><b>memoize</b></font> <font color="000066">(</font> <font color="000066"><i>func</i></font> : <font color="000066">(</font> <font color="000066"><i>A</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="000066">)</font> <font color="333333">=</font> <font color="000066"><i>func</i></font> <font color="7f0055"><b>as?</b></font> <font color="3e7eff"><b>Memoize2</b></font> ?: <font color="170591">Memoize2</font> <font color="000066">(</font> <font color="000066"><i>func</i></font> <font color="000066">)</font> <br> <font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>Memoize2</b></font> <font color="333333">&lt;</font> <font color="000066"><i>A</i></font> <font color="333333">,</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="000066">(</font> <font color="7f0055"><b>val</b></font> <font color="566874">func</font> : <font color="000066">(</font> <font color="000066"><i>A</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="000066">)</font> : <font color="000066">(</font> <font color="000066"><i>A</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="333333">,</font> java <font color="333333">.</font> util <font color="333333">.</font> function <font color="333333">.</font> <font color="3e7eff"><b>Function</b></font> <font color="333333">&lt;</font> <font color="000066"><i>A</i></font> <font color="333333">,</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="000066">{</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">cache</font> <font color="333333">=</font> <i><b>hashMapOf</b></i> <font color="333333">&lt;</font> <font color="000066"><i>A</i></font> <font color="333333">,</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="000066">()</font> <br> <font color="7f0055"><b>override fun</b></font> <font color="170591"><b>invoke</b></font> <font color="000066">(</font> <font color="000066"><i>p1</i></font> : <font color="000066"><i>A</i></font> <font color="000066">)</font> <font color="333333">=</font> <font color="566874">cache</font> <font color="333333">.</font> <i><b>getOrPut</b></i> <font color="000066">(</font> <font color="000066"><i>p1</i></font> <font color="333333">,</font> <font color="000066"><b>{</b></font> <font color="566874">func</font> <font color="000066">(</font> <font color="000066"><i>p1</i></font> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="000066">)</font> <br> <font color="7f0055"><b>override fun</b></font> <font color="170591"><b>apply</b></font> <font color="000066">(</font> <font color="000066"><i>t</i></font> : <font color="000066"><i>A</i></font> <font color="000066">)</font> : <font color="000066"><i>R</i></font> <font color="333333">=</font> <font color="170591">invoke</font> <font color="000066">(</font> <font color="000066"><i>t</i></font> <font color="000066">)</font> <br> <font color="000066">}</font></code> <br> <br> æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦æ„é€ ä¸€ä¸ªå·²è®°å¿†çš„å‡½æ•°serializeMessageï¼Œä½†åŒæ—¶å°†åœ¨å…¶ä¸­ä½¿ç”¨å®ƒã€‚ åœ¨å†…éƒ¨ä½¿ç”¨åŠŸèƒ½çš„å®Œå…¨ç›¸åŒçš„å®ä¾‹éå¸¸é‡è¦ï¼Œå¦åˆ™æ‰€æœ‰å¤‡æ³¨éƒ½ä¼šå˜å¾—æ— ç”¨ã€‚ è¦è§£å†³æ­¤å†²çªï¼Œæˆ‘ä»¬ä½¿ç”¨ValueHolderç±»ï¼Œè¯¥ç±»ä»…å­˜å‚¨å¯¹è¯¥å€¼çš„å¼•ç”¨ï¼ˆæ‚¨å¯ä»¥æ”¹ç”¨æ ‡å‡†çš„ä¸œè¥¿ï¼Œä¾‹å¦‚AtomicReferenceï¼‰ã€‚ è¦ç¼©çŸ­é€’å½’è®°å½•ï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š <br><br> <code><font color="7f0055"><b>inline fun</b></font> <font color="333333">&lt;</font> <font color="000066"><i>A</i></font> <font color="333333">,</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="170591"><b>recursiveMemoize</b></font> <font color="000066">(</font> <font color="7f0055"><b>crossinline</b></font> <font color="000066"><i>func</i></font> : <font color="000066">(</font> <font color="000066"><i>A</i></font> <font color="333333">,</font> <font color="000066">(</font> <font color="000066"><i>A</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="000066">)</font> : <font color="000066">(</font> <font color="000066"><i>A</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="333333">=</font> <br> <font color="170591">ValueHolder</font> <font color="333333">&lt;</font> <font color="000066">(</font> <font color="000066"><i>A</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>apply</b></i> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="566874">value</font> <font color="333333">=</font> <i><b>memoize</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>a</i></font> <font color="000066"><b>-&gt;</b></font> <font color="3e7eff"><b>func</b></font> <font color="000066">(</font> <font color="000066"><i>a</i></font> <font color="333333">,</font> <font color="566874">value</font> <font color="000066">)</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> <font color="333333">.</font> <font color="566874">value</font></code> <br> <br> å¦‚æœæ‚¨ç¬¬ä¸€æ¬¡å¯ä»¥ç†è§£è¿™ç§ç®­å¤´ä¸‰æ®µè®ºï¼Œé‚£ä¹ˆæ­å–œæ‚¨ï¼Œæ‚¨æ˜¯ä¸€åå‡½æ•°å¼ç¨‹åºå‘˜:-) <br><br> ç°åœ¨ï¼Œä»£ç å°†å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br> <code><font color="7f0055"><b>override fun</b></font> <font color="170591"><b>getLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>messages</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//    ,  forward  reply</font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">allMessages</font> <font color="333333">=</font> <font color="000066"><i>messages</i></font> <font color="333333">.</font> <i><b>asSequence</b></i> <font color="000066">()</font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>sequenceOf</b></i> <font color="000066">(</font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <font color="566874">forwardFrom</font> <font color="333333">,</font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <font color="566874">replyTo</font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>filterNotNull</b></i> <font color="000066">()</font> <br> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">()</font> <br> <br> <font color="3f7f5f">//       ,    </font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">getUser</font> <font color="333333">=</font> <font color="170591">allMessages</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">author</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <font color="170591">parallelStream</font> <font color="000066">()</font> <font color="333333">.</font> <font color="170591">distinct</font> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>chunked</b></i> <font color="000066">(</font> <font color="05314d"><b>userApiChunkLimit</b></font> <font color="333333">,</font> <font color="566874">userRepository</font> ::getUsersByIds <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>flatten</b></i> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"User</b> <font color="333333"><b>$</b></font> <font color="000066"><i>it</i></font> <b>"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <br> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//        </font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">getFile</font> <font color="333333">=</font> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByIds</font> <font color="000066">(</font> <font color="170591">allMessages</font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">files</font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">())</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"File</b> <font color="333333"><b>$</b></font> <b>it"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <br> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>messages</i></font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066">(</font> <i><b>recursiveMemoize</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>memoized</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">(</font> <br> <font color="4a86e8">getUser =</font> <font color="170591">getUser</font> <font color="333333">,</font> <br> <font color="4a86e8">getFile =</font> <font color="170591">getFile</font> <font color="333333">,</font> <br> <font color="3f7f5f">//       </font> <br> <font color="4a86e8">serializeMessage =</font> <font color="000066"><i>memoized</i></font> <br> <font color="000066"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <font color="000066">)</font></code> <br> <br> æ‚¨è¿˜ä¼šæ³¨æ„åˆ°orThrowï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š <br><br> <code><font color="395da1">/**  </font> <font color="3d3d3d"><i><b>[exception]</b></i></font> <font color="395da1">,    null */</font> <br> <font color="7f0055"><b>fun</b></font> <font color="333333">&lt;</font> <font color="000066"><i>P</i></font> <font color="333333">,</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="000066">((</font> <font color="000066"><i>P</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> ? <font color="000066">)</font> <font color="333333">.</font> <font color="170591"><b>orThrow</b></font> <font color="000066">(</font> <font color="000066"><i>exception</i></font> : <font color="000066">(</font> <font color="000066"><i>P</i></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>Exception</b></font> <font color="000066">)</font> : <font color="000066">(</font> <font color="000066"><i>P</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="333333">=</font> <br> <font color="000066"><b>{</b></font> <font color="000066"><i>p</i></font> <font color="000066"><b>-&gt;</b></font> <font color="170591">invoke</font> <font color="000066">(</font> <font color="000066"><i>p</i></font> <font color="000066">)</font> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <b>it</b> ?: <font color="7f0055"><b>throw</b></font> <font color="3e7eff"><b>exception</b></font> <font color="000066">(</font> <font color="000066"><i>p</i></font> <font color="000066">)</font> <font color="000066"><b>} }</b></font></code> <br> <br> å¦‚æœåœ¨å¤–éƒ¨æœåŠ¡ä¸­æ²¡æœ‰å…³äºæˆ‘ä»¬IDçš„æ•°æ®ï¼Œå¹¶ä¸”è¿™è¢«è§†ä¸ºåˆæ³•æƒ…å†µï¼Œåˆ™æ‚¨éœ€è¦ä»¥ä¸åŒçš„æ–¹å¼å¤„ç†å®ƒã€‚ <br><br> ä¿®å¤ä¹‹åï¼ŒgetLastè¿è¡Œæ—¶é¢„è®¡çº¦ä¸º300æ¯«ç§’ã€‚ è€Œä¸”ï¼Œå³ä½¿è¯·æ±‚ä¸å†é€‚åˆæ•°æ®åŒ…å¤§å°çš„é™åˆ¶ï¼ˆç”±äºå¹¶è¡Œè¯·æ±‚æ•°æ®åŒ…ï¼‰ï¼Œè¯¥æ—¶é—´ä¹Ÿä¼šç•¥æœ‰å¢åŠ ã€‚ è®©æˆ‘æé†’æ‚¨ï¼Œæˆ‘ä»¬çš„æœ€ä½ç›®æ ‡æ˜¯500æ¯«ç§’ï¼Œå¯ä»¥å°†250æ¯«ç§’è§†ä¸ºæ­£å¸¸å·¥ä½œã€‚ </div></div><br><a name="Parallelism"></a>  <b>å¹³è¡Œæ€§</b> <br><br> ä½†æ˜¯æ‚¨éœ€è¦ç»§ç»­å‰è¿›ã€‚ å¯¹userRepositoryå’ŒfileRepositoryçš„è°ƒç”¨æ˜¯å®Œå…¨ç‹¬ç«‹çš„ï¼Œå¹¶ä¸”å¯ä»¥è½»æ¾å¹¶è¡ŒåŒ–ï¼Œç†è®ºä¸Šæ¥è¿‘200æ¯«ç§’ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">ä¾‹å¦‚ï¼Œé€šè¿‡æˆ‘ä»¬çš„åŠ å…¥åŠŸèƒ½ï¼š</b> <div class="spoiler_text"> <code><font color="7f0055"><b>override fun</b></font> <font color="170591"><b>getLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>messages</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//    ,  forward  reply</font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">allMessages</font> <font color="333333">=</font> <font color="000066"><i>messages</i></font> <font color="333333">.</font> <i><b>asSequence</b></i> <font color="000066">()</font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>sequenceOf</b></i> <font color="000066">(</font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <font color="566874">forwardFrom</font> <font color="333333">,</font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <font color="566874">replyTo</font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>filterNotNull</b></i> <font color="000066">()</font> <br> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">()</font> <br> <br> <i><b>join</b></i> <font color="000066">(</font> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//       ,    </font> <br> <font color="3e7eff"><b>allMessages</b></font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">author</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <font color="170591">parallelStream</font> <font color="000066">()</font> <font color="333333">.</font> <font color="170591">distinct</font> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>chunked</b></i> <font color="000066">(</font> <font color="05314d"><b>userApiChunkLimit</b></font> <font color="333333">,</font> <font color="566874">userRepository</font> ::getUsersByIds <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>flatten</b></i> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> <font color="333333">,</font> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//        </font> <br> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByIds</font> <font color="000066">(</font> <font color="3e7eff"><b>allMessages</b></font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">files</font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">())</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> <font color="000066">)</font> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066">(</font> <font color="170591">users</font> <font color="333333">,</font> <font color="170591">files</font> <font color="000066">)</font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>messages</i></font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066">(</font> <i><b>recursiveMemoize</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>memoized</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">(</font> <br> <font color="4a86e8">getUser =</font> <font color="170591">users</font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"User</b> <font color="333333"><b>$</b></font> <b>it"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="4a86e8">getFile =</font> <font color="170591">files</font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"File</b> <font color="333333"><b>$</b></font> <font color="000066"><i>it</i></font> <b>"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="3f7f5f">//       </font> <br> <font color="4a86e8">serializeMessage =</font> <font color="000066"><i>memoized</i></font> <br> <font color="000066"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font></code> </div> </div><br> å¦‚å®è·µæ‰€ç¤ºï¼Œæ‰§è¡Œå¤§çº¦éœ€è¦200æ¯«ç§’ï¼Œå¹¶ä¸”éšç€æ¶ˆæ¯æ•°é‡çš„å¢åŠ ï¼Œæ—¶é—´ä¸ä¼šå¢åŠ å¤ªå¤šéå¸¸é‡è¦ã€‚ <br><br><a name="Problems"></a>  <b>é—®é¢˜æ‰€åœ¨</b> <br><br> æ€»çš„æ¥è¯´ï¼Œä»£ç çš„å¯è¯»æ€§å½“ç„¶ä¸å¦‚æˆ‘ä»¬çš„æœ´ç´ çš„ç¬¬ä¸€ç‰ˆï¼Œä½†æ˜¯åºåˆ—åŒ–æœ¬èº«ï¼ˆtoFrontModelçš„å®ç°ï¼‰å¹¶æ²¡æœ‰å¤ªå¤§å˜åŒ–å¹¶ä¸”ä¿æŒå®Œå…¨å¯è¯»æ€§æ˜¯ä¸€ä»¶å¥½äº‹ã€‚ å¤–éƒ¨æœåŠ¡çš„ç‹¡çŒ¾å·¥ä½œçš„æ•´ä¸ªé€»è¾‘å­˜åœ¨äºä¸€ä¸ªåœ°æ–¹ã€‚ <br><br> è¿™ç§æ–¹æ³•çš„ç¼ºç‚¹æ˜¯æˆ‘ä»¬çš„æŠ½è±¡æ­£åœ¨è¿›è¡Œä¸­ã€‚ <br><br> å¦‚æœéœ€è¦å¯¹FrontModelè¿›è¡Œæ›´æ”¹ï¼Œåˆ™å‡ ä¹å¯ä»¥è‚¯å®šå¿…é¡»å¯¹getLastå‡½æ•°è¿›è¡Œæ›´æ”¹ï¼Œè¿™è¿åäº†æ›¿æ¢åŸåˆ™<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Barbara Liskov</a> ï¼ˆLiskovæ›¿æ¢åŸç†ï¼‰ã€‚ <br><br> ä¾‹å¦‚ï¼Œæˆ‘ä»¬åŒæ„ä»…åœ¨ä¸»è¦æ¶ˆæ¯ä¸­è§£å¯†é™„ä»¶ï¼Œè€Œä¸åœ¨ç­”å¤å’Œè½¬å‘ï¼ˆç­”å¤/è½¬å‘ï¼‰ä¸­è§£å¯†ï¼Œæˆ–è€…ä»…åœ¨ç¬¬ä¸€çº§çš„ç­”å¤å’Œè½¬å‘ä¸­è§£å¯†ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯¹toFrontModelä»£ç è¿›è¡Œæ›´æ”¹åï¼Œæ‚¨å°†å¿…é¡»åœ¨æ–‡ä»¶çš„è¯·æ±‚æ”¶é›†ä»£ç ä¸­è¿›è¡Œç›¸åº”çš„æ›´æ­£ã€‚ è€Œä¸”ï¼Œæ ¡æ­£å°†æ˜¯ä¸å¹³å‡¡çš„ï¼š <br><br> <code><font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByIds</font> <font color="000066">(</font> <br> <font color="3e7eff"><b>allMessages</b></font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">files</font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">()</font> <br> <font color="000066">)</font></code> <br> <br> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æ­£åœ¨é¡ºåˆ©è§£å†³ä¸ä¸Šä¸€ä¸ªé—®é¢˜å¯†åˆ‡ç›¸å…³çš„å¦ä¸€ä¸ªé—®é¢˜ï¼šæ•´ä¸ªä»£ç çš„æ­£ç¡®æ“ä½œå–å†³äºé€†å‘å·¥ç¨‹çš„ç´ å…»ã€‚ åœ¨æŸäº›å¤æ‚çš„æƒ…å†µä¸‹ï¼Œç”±äºé”™è¯¯çš„æŸ¥è¯¢æ”¶é›†ï¼Œä»£ç å¯èƒ½æ— æ³•æ­£ç¡®æ­£ç¡®åœ°å·¥ä½œã€‚ æ— æ³•ä¿è¯æ‚¨å°†èƒ½å¤Ÿå¿«é€Ÿæå‡ºæ¶µç›–æ‰€æœ‰æ­¤ç±»æ£˜æ‰‹æƒ…å†µçš„å•å…ƒæµ‹è¯•ã€‚ <br><br><a name="Summary1"></a>  <b>ç»“è®º</b> <br><br> ä¼˜ç‚¹ï¼š <br><br><ol><li> ä¸€ç§é¢„å…ˆæ¥æ”¶è¯·æ±‚çš„æ˜æ˜¾æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¾ˆå®¹æ˜“ä¸ä¸»ä»£ç åˆ†ç¦»ã€‚ </li><li> å‡ ä¹å®Œå…¨æ²¡æœ‰å†…å­˜å’Œæ—¶é—´å¼€é”€ï¼Œè¿™ä¸ä»…ä½¿ç”¨æœ¬æ¥åº”è¯¥æ¥æ”¶åˆ°çš„æ•°æ®ç›¸å…³ã€‚ </li><li> è‰¯å¥½çš„ä¼¸ç¼©æ€§å’Œæ„å»ºæœåŠ¡çš„èƒ½åŠ›ï¼Œä»ç†è®ºä¸Šè®²ï¼Œè¿™å°†è´Ÿè´£å¯é¢„æµ‹çš„æ—¶é—´ï¼Œè€Œä¸è€ƒè™‘å¤–éƒ¨è¯·æ±‚çš„å¤§å°ã€‚ </li></ol><br> ç¼ºç‚¹ï¼š <br><br><ol><li> æ‰¹å¤„ç†æœ¬èº«çš„ä»£ç éå¸¸å¤æ‚ã€‚ </li><li> åœ¨ç°æœ‰å®æ–½ä¸­åˆ†æè¦æ±‚çš„å¤§å‹è´Ÿè´£ä»»çš„å·¥ä½œã€‚ </li><li> æµåŠ¨çš„æŠ½è±¡ä»¥åŠå› æ­¤å¯¼è‡´çš„æ•´ä¸ªæ–¹æ¡ˆçš„è„†å¼±æ€§ï¼ˆä¸å®ç°çš„å˜åŒ–æœ‰å…³ï¼‰ã€‚ </li><li> æ”¯æŒå›°éš¾ï¼šæŸ¥è¯¢é¢„æµ‹å—ä¸­çš„é”™è¯¯å¾ˆéš¾ä¸ä¸»ä»£ç ä¸­çš„é”™è¯¯åŒºåˆ†å¼€ã€‚ ç†æƒ³æƒ…å†µä¸‹ï¼Œæ‚¨éœ€è¦ä½¿ç”¨ä¸¤å€çš„å•å…ƒæµ‹è¯•ï¼Œå› æ­¤åœ¨ç”Ÿäº§ä¸­å‡ºç°é”™è¯¯çš„è¿‡ç¨‹å°†æ˜¯å›°éš¾çš„ä¸¤å€ã€‚ </li><li> ç¼–å†™ä»£ç æ—¶ï¼Œè¯·éµå®ˆSOLIDåŸåˆ™ï¼šå¿…é¡»å‡†å¤‡ä»£ç ä»¥ç–è¿œæ‰¹å¤„ç†çš„é€»è¾‘ã€‚ ä»…è¿™äº›åŸåˆ™çš„ä»‹ç»å°†æä¾›ä¸€äº›ä¼˜ç‚¹ï¼Œå› æ­¤è¿™ä¸ªè´Ÿæ•°æ˜¯æœ€æ— å…³ç´§è¦çš„ã€‚ </li></ol><br> é‡è¦çš„æ˜¯è¦æ³¨æ„ï¼Œæ— éœ€è¿›è¡Œåå‘å·¥ç¨‹å°±å¯ä»¥ä½¿ç”¨æ­¤æ–¹æ³•ã€‚ æˆ‘ä»¬éœ€è¦è·å¾—ä¸€ä¸ªgetLaståˆåŒï¼Œç”¨äºåˆæ­¥è®¡ç®—è¯·æ±‚çš„åˆåŒå–å†³äºè¯¥åˆåŒï¼ˆä»¥ä¸‹ç§°ä¸ºé¢„å–ï¼‰ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬é€šè¿‡æŸ¥çœ‹getLastï¼ˆé€†å‘å·¥ç¨‹ï¼‰çš„å®ç°æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚ ä½†æ˜¯ï¼Œä½¿ç”¨è¿™ç§æ–¹æ³•ä¼šå‡ºç°å›°éš¾ï¼šç¼–è¾‘è¿™ä¸¤æ®µä»£ç åº”è¯¥å§‹ç»ˆæ˜¯åŒæ­¥çš„ï¼Œå¹¶ä¸”æ— æ³•ç¡®ä¿åšåˆ°è¿™ä¸€ç‚¹ï¼ˆè®°ä½hashCodeå’Œequalsï¼Œæ˜¯å®Œå…¨ä¸€æ ·çš„ä¸œè¥¿ï¼‰ã€‚ æˆ‘æƒ³å±•ç¤ºçš„ä¸‹ä¸€ç§æ–¹æ³•æ—¨åœ¨è§£å†³æ­¤é—®é¢˜ï¼ˆæˆ–è‡³å°‘ç¼“è§£ï¼‰ã€‚ <br><br><a name="BusinessHeuristics"></a><h4> ä¸šåŠ¡å¯å‘æ³• </h4><br><a name="ManagingContractProblem1"></a>  <b>è§£å†³åˆåŒé—®é¢˜</b> <br><br> å¦‚æœæˆ‘ä»¬æ²¡æœ‰ä¸¥æ ¼çš„åˆåŒï¼Œå› æ­¤æ²¡æœ‰ä¸€ç»„ç¡®åˆ‡çš„è¯·æ±‚ï¼Œå´æœ‰ä¸€ä¸ªè¿‘ä¼¼çš„è¯·æ±‚ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ æ­¤å¤–ï¼Œæˆ‘ä»¬å°†å»ºç«‹ä¸€ä¸ªè¿‘ä¼¼é›†ï¼Œä»¥ä¾¿å®ƒä¸¥æ ¼åŒ…å«ç²¾ç¡®é›†ï¼Œå¹¶åŸºäºä¸»é¢˜åŒºåŸŸçš„ç‰¹å¾ã€‚ <br><br> å› æ­¤ï¼Œæˆ‘ä»¬å»ºç«‹äº†ä¸¤è€…éƒ½ä¾èµ–äºç”¨æˆ·å°†è¦å†³å®šçš„æŸä¸ªå…¬å…±åˆåŒï¼Œè€Œä¸æ˜¯é¢„å–åˆåŒå¯¹getLastçš„ä¾èµ–ã€‚ ä¸»è¦å›°éš¾å°†æ˜¯ä»¥æŸç§æ–¹å¼ä»¥ä»£ç å½¢å¼ä½“ç°è¯¥ä¸€èˆ¬åˆåŒã€‚ <br><br><a name="UsefulRestrictions"></a>  <b>æœç´¢æœ‰ç”¨çš„é™åˆ¶</b> <br><br> è®©æˆ‘ä»¬å°è¯•ç”¨æˆ‘ä»¬çš„ä¾‹å­æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚ <br> å°±æˆ‘ä»¬è€Œè¨€ï¼Œå…·æœ‰ä»¥ä¸‹ä¸šåŠ¡åŠŸèƒ½ï¼š <br><br><ul><li> èŠå¤©å‚ä¸è€…åˆ—è¡¨æ˜¯é¢„å®šä¹‰çš„ï¼› </li><li> èŠå¤©å½¼æ­¤å®Œå…¨éš”ç¦»ï¼› </li><li> ç­”å¤/è½¬å‘é“¾çš„åµŒå¥—å¾ˆå°ï¼ˆçº¦2â€“3æ¡æ¶ˆæ¯ï¼‰ã€‚ </li></ul><br> ä»ç¬¬ä¸€ä¸ªé™åˆ¶å¼€å§‹ï¼Œæ‚¨æ— éœ€ç»•è¿‡æ¶ˆæ¯ï¼ŒæŸ¥çœ‹é‚£é‡Œæœ‰å“ªäº›ç”¨æˆ·ï¼Œé€‰æ‹©å”¯ä¸€çš„ç”¨æˆ·å¹¶å‘ä»–ä»¬æå‡ºè¯·æ±‚ã€‚ æ‚¨å¯ä»¥ç®€å•åœ°æŸ¥è¯¢é¢„å®šä¹‰åˆ—è¡¨ã€‚ å¦‚æœæ‚¨åŒæ„è¿™ä¸€è¯´æ³•ï¼Œé‚£ä¹ˆæˆ‘æŠ“ä½äº†æ‚¨ã€‚ <br><br> å®é™…ä¸Šï¼Œä¸€åˆ‡éƒ½ä¸æ˜¯é‚£ä¹ˆç®€å•ã€‚ åˆ—è¡¨å¯ä»¥é¢„å®šä¹‰ï¼Œä½†å¯ä»¥æœ‰æ•°åƒä¸ªç”¨æˆ·ã€‚ è¿™äº›äº‹æƒ…éœ€è¦æ¾„æ¸…ã€‚ åœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ï¼Œé€šå¸¸ä¼šæœ‰ä¸¤ä¸ªæˆ–ä¸‰ä¸ªèŠå¤©å‚ä¸è€…ï¼Œå¾ˆå°‘æœ‰ã€‚ å› æ­¤ï¼Œå®Œå…¨å¯ä»¥æ¥æ”¶æ‰€æœ‰æ•°æ®ã€‚ <br><br> æ­¤å¤–ï¼Œå¦‚æœèŠå¤©ç”¨æˆ·çš„åˆ—è¡¨æ˜¯é¢„å…ˆç¡®å®šçš„ï¼Œä½†æ˜¯è¯¥ä¿¡æ¯ä¸åœ¨ç”¨æˆ·æœåŠ¡ä¸­ï¼ˆè¿™å¾ˆæœ‰å¯èƒ½ï¼‰ï¼Œé‚£ä¹ˆä»è¿™äº›ä¿¡æ¯ä¸­å°†æ²¡æœ‰ä»»ä½•æ„ä¹‰ã€‚ æˆ‘ä»¬å°†é¢å¤–è¯·æ±‚èŠå¤©ç”¨æˆ·åˆ—è¡¨ï¼Œç„¶åæ‚¨ä»ç„¶å¿…é¡»å‘ç”¨æˆ·æœåŠ¡æå‡ºè¯·æ±‚ã€‚ <br><br> å‡è®¾æœ‰å…³ç”¨æˆ·è¿æ¥å’ŒèŠå¤©çš„ä¿¡æ¯å­˜å‚¨åœ¨ç”¨æˆ·æœåŠ¡ä¸­ã€‚ åœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ï¼Œæ˜¯è¿™æ ·ï¼Œå› ä¸ºè¿æ¥æ˜¯ç”±ç”¨æˆ·çš„æƒé™å†³å®šçš„ã€‚ ç„¶åï¼Œå¯¹äºç”¨æˆ·æ¥è¯´ï¼Œå®ƒå°†å˜æˆè¿™æ ·çš„é¢„å–ä»£ç ï¼š <br><br> åœ¨è¿™é‡Œä¼¼ä¹æ²¡æœ‰ä¼ é€’ä»»ä½•èŠå¤©æ ‡è¯†ç¬¦ä¼¼ä¹ä»¤äººæƒŠè®¶ã€‚ æˆ‘æ•…æ„è¿™æ ·åšï¼Œä»¥å…å¼„ä¹±ç¤ºä¾‹ä»£ç ã€‚ <br><br> ä¹ä¸€çœ‹ï¼Œç¬¬äºŒä¸ªé™åˆ¶æ²¡æœ‰ä»»ä½•æ„ä¹‰ã€‚ æ— è®ºå¦‚ä½•ï¼Œæˆ‘ä»ç„¶æ— æ³•ä»ä»–èº«ä¸Šå¾—åˆ°ä»»ä½•æœ‰ç”¨çš„ä¸œè¥¿ã€‚ <br><br> æˆ‘ä»¬ä¹‹å‰å·²ç»ä½¿ç”¨äº†ç¬¬ä¸‰ä¸ªé™åˆ¶ã€‚ å®ƒä¼šå¯¹æˆ‘ä»¬å­˜å‚¨å’Œæ¥æ”¶å¯¹è¯çš„æ–¹å¼äº§ç”Ÿé‡å¤§å½±å“ã€‚ æˆ‘ä»¬ä¸ä¼šå¼€å§‹å¼€å‘è¯¥ä¸»é¢˜ï¼Œå› ä¸ºå®ƒä¸RESTæ§åˆ¶å™¨å’Œæ‰¹å¤„ç†æ— å…³ã€‚ <br><br> å¦‚ä½•å¤„ç†æ–‡ä»¶ï¼Ÿ æˆ‘æƒ³åœ¨ä¸€ä¸ªç®€å•çš„è¯·æ±‚ä¸­è·å¾—æ‰€æœ‰èŠå¤©æ–‡ä»¶çš„åˆ—è¡¨ã€‚ æ ¹æ®APIçš„æ¡æ¬¾ï¼Œæˆ‘ä»¬åªéœ€è¦æ–‡ä»¶å¤´ï¼Œæ²¡æœ‰ä¸»ä½“ï¼Œå› æ­¤å¯¹äºè°ƒç”¨è€…æ¥è¯´ï¼Œè¿™çœ‹èµ·æ¥åƒæ˜¯ä¸€é¡¹èµ„æºå¯†é›†ä¸”å±é™©çš„ä»»åŠ¡ã€‚ <br><br> å¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬å¿…é¡»è®°ä½ï¼Œæˆ‘ä»¬ä¸ä¼šæ”¶åˆ°æ‰€æœ‰èŠå¤©æ¶ˆæ¯ï¼Œè€Œåªä¼šæ”¶åˆ°æœ€åNæ¡æ¶ˆæ¯ï¼Œå› æ­¤å¾ˆå®¹æ˜“å‘ç°å®ƒä»¬æ ¹æœ¬ä¸åŒ…å«ä»»ä½•æ–‡ä»¶ã€‚ <br><br> æ²¡æœ‰ç»Ÿä¸€çš„ç­”æ¡ˆï¼šè¿™å®Œå…¨å–å†³äºä¸šåŠ¡ç»†èŠ‚å’Œç”¨ä¾‹ã€‚ åˆ›å»ºäº§å“è§£å†³æ–¹æ¡ˆæ—¶ï¼Œå¦‚æœå¯¹ä¸€ä¸ªç”¨ä¾‹è¿›è¡Œå¯å‘å¼è®¾è®¡ï¼Œå°±ä¼šé‡åˆ°éº»çƒ¦ï¼Œç„¶åç”¨æˆ·å°†ä»¥ä¸åŒçš„æ–¹å¼ä½¿ç”¨è¯¥åŠŸèƒ½ã€‚ å¯¹äºæ¼”ç¤ºå’Œé¢„å”®ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œä½†æ˜¯ç°åœ¨æˆ‘ä»¬æ­£åœ¨å°è¯•ç¼–å†™è¯šå®çš„ç”Ÿäº§æœåŠ¡ã€‚ <br><br> å› æ­¤ï¼Œå¾ˆé—æ†¾ï¼Œä»…åŸºäºæ“ä½œå’Œç»Ÿè®¡ä¿¡æ¯æ”¶é›†çš„ç»“æœï¼ˆæˆ–ç»è¿‡ä¸“å®¶è¯„ä¼°ï¼‰ï¼Œæ‰å¯ä»¥å¯¹æ–‡ä»¶è¿›è¡Œä¸šåŠ¡å¯å‘ã€‚ <br><br> ç”±äºæˆ‘ä»¬ä»ç„¶æƒ³ä»¥æŸç§æ–¹å¼åº”ç”¨æˆ‘ä»¬çš„æ–¹æ³•ï¼Œå› æ­¤å‡è®¾ç»Ÿè®¡æ•°æ®æ˜¾ç¤ºå¦‚ä¸‹ï¼š <br><br><ol><li> å…¸å‹çš„å¯¹è¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶çš„æ¶ˆæ¯å¼€å§‹ï¼Œç„¶åæ˜¯ä¸åŒ…å«æ–‡ä»¶çš„å›å¤æ¶ˆæ¯ã€‚ </li><li> å‡ ä¹æ‰€æœ‰æ¶ˆæ¯éƒ½æ¥è‡ªå…¸å‹çš„å¯¹è¯ã€‚ </li><li> æ¯æ¬¡èŠå¤©ä¸­å”¯ä¸€æ–‡ä»¶çš„é¢„æœŸæ•°é‡çº¦ä¸º20ã€‚ </li></ol><br> å› æ­¤ï¼Œè¦æ˜¾ç¤ºå‡ ä¹æ‰€æœ‰æ¶ˆæ¯ï¼Œæ‚¨å°†éœ€è¦è·å–æŸäº›æ–‡ä»¶çš„æ ‡å¤´ï¼ˆå› ä¸ºChatMessageUIå¦‚æ­¤å®‰æ’ï¼‰ï¼Œå¹¶ä¸”æ–‡ä»¶æ€»æ•°å¾ˆå°ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåœ¨ä¸€ä¸ªè¯·æ±‚ä¸­æ¥æ”¶æ‰€æœ‰èŠå¤©æ–‡ä»¶ä¼¼ä¹æ˜¯åˆç†çš„ã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¿…é¡»å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ°æ–‡ä»¶çš„APIä¸­ï¼š <br><br> <code><font color="7f0055"><b>fun</b></font> <font color="170591"><b>getHeadsByChat</b></font> <font color="000066">()</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="333333">&gt;</font></code> <br> <br>  getHeadsByChatæ–¹æ³•çœ‹èµ·æ¥å¹¶ä¸ç‰µå¼ºï¼Œçº¯ç²¹æ˜¯å› ä¸ºæˆ‘ä»¬å¸Œæœ›ä¼˜åŒ–æ€§èƒ½ï¼ˆå°½ç®¡è¿™ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ç†ç”±ï¼‰ã€‚ é€šå¸¸ï¼Œåœ¨å¸¦æœ‰æ–‡ä»¶çš„èŠå¤©å®¤ä¸­ï¼Œç”¨æˆ·å¸Œæœ›æŸ¥çœ‹æ‰€æœ‰ä½¿ç”¨çš„æ–‡ä»¶ä»¥åŠæ·»åŠ é¡ºåºï¼ˆå› æ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨åˆ—è¡¨ï¼‰ã€‚ <br><br> è¿™ç§æ˜¾å¼è¿æ¥çš„å®ç°å°†éœ€è¦åœ¨æ–‡ä»¶æœåŠ¡æˆ–æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­å­˜å‚¨å…¶ä»–ä¿¡æ¯ã€‚ æˆ‘ä»¬è®¤ä¸ºï¼Œè¿™å®Œå…¨å–å†³äºåº”åœ¨è°çš„è´£ä»»èŒƒå›´å†…å­˜å‚¨æœ‰å…³æ–‡ä»¶ä¸èŠå¤©çš„è¿æ¥çš„å†—ä½™ä¿¡æ¯ã€‚ è¿™æ˜¯å¤šä½™çš„ï¼Œå› ä¸ºè¯¥æ¶ˆæ¯å·²ç»ä¸æ–‡ä»¶å…³è”ï¼Œè€Œæ¶ˆæ¯åˆä¸èŠå¤©å…³è”ã€‚ æ‚¨ä¸èƒ½ä½¿ç”¨éè§„èŒƒåŒ–ï¼Œè€Œæ˜¯ä»æ¶ˆæ¯ä¸­å³æ—¶æå–æ­¤ä¿¡æ¯ï¼Œå³åœ¨SQLå†…éƒ¨ï¼Œç«‹å³æ¥æ”¶æ•´ä¸ªèŠå¤©è¿‡ç¨‹ä¸­çš„æ‰€æœ‰æ–‡ä»¶ï¼ˆåœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ï¼‰ï¼Œå¹¶ç«‹å³ä»æ–‡ä»¶æœåŠ¡ä¸­è¯·æ±‚æ‰€æœ‰è¿™äº›æ–‡ä»¶ã€‚ å¦‚æœæœ‰å¾ˆå¤šèŠå¤©æ¶ˆæ¯ï¼Œåˆ™æ­¤é€‰é¡¹çš„æ•ˆæœä¼šæ›´å·®ï¼Œä½†æˆ‘ä»¬ä¸éœ€è¦éè§„èŒƒåŒ–ã€‚ æˆ‘ä¼šå°†ä¸¤ä¸ªé€‰é¡¹éƒ½éšè—åœ¨getHeadsByChatåé¢ã€‚ <br><br> ä»£ç å¦‚ä¸‹ï¼š <br><br> <code><font color="7f0055"><b>override fun</b></font> getLast <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>messages</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>join</b></i> <font color="000066">(</font> <br> <font color="000066"><b>{</b></font> <font color="566874">userRepository</font> <font color="333333">.</font> <font color="170591">getUsersByChat</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>} }</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByChat</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>} }</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="3f7f5f">//    </font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font></code> <br> <br> å¯ä»¥çœ‹å‡ºï¼Œä¸ä»¥å‰çš„ç‰ˆæœ¬ç›¸æ¯”ï¼Œå˜åŒ–å¾ˆå°ï¼Œåªæœ‰é¢„å–éƒ¨åˆ†å—åˆ°äº†å½±å“ï¼Œè¿™æ˜¯å¾ˆå¤§çš„ã€‚ <br><br> é¢„å–ä»£ç å˜å¾—æ›´çŸ­ï¼Œæ›´æ¸…æ™°ã€‚ <br><br> æ‰§è¡Œæ—¶é—´æ²¡æœ‰æ”¹å˜ï¼Œè¿™æ˜¯åˆä¹é€»è¾‘çš„ï¼Œå› ä¸ºè¯·æ±‚æ•°ä¿æŒä¸å˜ã€‚ ä»ç†è®ºä¸Šè®²ï¼Œä¼¸ç¼©å¯èƒ½ä¼šæ¯”è¯šå®çš„é€†å‘å·¥ç¨‹æ›´å¥½ï¼ˆä»…ç”±äºæ¶ˆé™¤äº†å¤æ‚è®¡ç®—çš„ç¯èŠ‚ï¼‰ã€‚ ä½†æ˜¯ï¼Œç›¸åçš„æƒ…å†µä¹Ÿæœ‰å¯èƒ½å‘ç”Ÿï¼šè¯•æ¢æ³•æ’å¾—å¤ªå¤šã€‚ å¦‚å®è·µæ‰€ç¤ºï¼Œå¦‚æœæ‚¨è®¾æ³•æå‡ºè¶³å¤Ÿçš„è¯•æ¢æ³•ï¼Œåˆ™æ‰§è¡Œæ—¶é—´ä¸åº”æœ‰ä»»ä½•ç‰¹æ®Šå˜åŒ–ã€‚ <br><br> ä½†æ˜¯ï¼Œè¿™è¿˜ä¸æ˜¯å…¨éƒ¨ã€‚ æˆ‘ä»¬æ²¡æœ‰è€ƒè™‘åˆ°ç°åœ¨æ¥æ”¶æœ‰å…³ç”¨æˆ·å’Œæ–‡ä»¶çš„è¯¦ç»†æ•°æ®ä¸æ¥æ”¶æ¶ˆæ¯æ— å…³ï¼Œå¹¶ä¸”å¯ä»¥å¹¶è¡Œå¯åŠ¨è¯·æ±‚ï¼š <br><br> æ­¤é€‰é¡¹ä¸ºæ¯ä¸ªè¯·æ±‚æä¾›ç¨³å®šçš„100æ¯«ç§’ã€‚ <br><br><a name="Mistakes"></a>  <b>å¯å‘å¼é”™è¯¯</b> <br><br> å¦‚æœåœ¨ä½¿ç”¨å¯å‘å¼æ–¹æ³•æ—¶æŸ¥è¯¢é›†ä¸å¤§ä½†ç•¥å°äºåº”æœ‰çš„æƒ…å†µè¯¥æ€ä¹ˆåŠï¼Ÿ å¯¹äºå¤§å¤šæ•°é€‰é¡¹ï¼Œæ­¤ç±»è¯•æ¢æ³•å°†èµ·ä½œç”¨ï¼Œä½†æœ‰äº›ä¾‹å¤–åˆ™éœ€è¦æ‚¨å•ç‹¬æå‡ºè¦æ±‚ã€‚ åœ¨æˆ‘çš„å®è·µä¸­ï¼Œè¿™æ ·çš„å†³å®šæ˜¯ä¸æˆåŠŸçš„ï¼Œå› ä¸ºæ¯ä¸ªå¼‚å¸¸éƒ½ä¼šå¯¹æ€§èƒ½äº§ç”Ÿå¾ˆå¤§çš„å½±å“ï¼Œæœ€åï¼Œä¸€äº›ç”¨æˆ·å‘å‡ºäº†ä¸€ä¸ªå®Œå…¨ç”±å¼‚å¸¸ç»„æˆçš„è¯·æ±‚ã€‚ æˆ‘è¦è¯´çš„æ˜¯ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå³ä½¿æŸ¥è¯¢æ”¶é›†ç®—æ³•ä»¤äººæ¯›éª¨æ‚šç„¶ä¸”ä¸å¯è¯»ï¼Œä¹Ÿæœ€å¥½ä½¿ç”¨é€†å‘å·¥ç¨‹ï¼Œä½†æ˜¯ï¼Œå½“ç„¶ï¼Œè¿™å…¨éƒ½å–å†³äºæœåŠ¡çš„å…³é”®æ€§ã€‚ <br><br><a name="Summary2"></a>  <b>ç»“è®º</b> <br><br> ä¼˜ç‚¹ï¼š <br><br><ol><li> ä¸šåŠ¡å¯å‘æ³•çš„é€»è¾‘å¾ˆå®¹æ˜“é˜…è¯»ï¼Œé€šå¸¸å¾ˆç®€å•ã€‚ ä¸ºäº†äº†è§£é€‚ç”¨æ€§çš„é™åˆ¶ï¼ŒéªŒè¯å’Œä¿®æ”¹é¢„å–åˆåŒï¼Œè¿™æ˜¯å¾ˆå¥½çš„ã€‚ </li><li> å¯ä¼¸ç¼©æ€§ä¸é€†å‘å·¥ç¨‹ä¸€æ ·å¥½ã€‚ </li><li> ä»£ç ä¸æ•°æ®çš„ä¸€è‡´æ€§é™ä½äº†ï¼Œè¿™å¯ä»¥å¯¼è‡´ä»£ç æ›´å¥½çš„å¹¶è¡ŒåŒ–ã€‚ </li><li> åƒRESTæ§åˆ¶å™¨çš„ä¸»è¦é€»è¾‘ä¸€æ ·ï¼Œé¢„å–é€»è¾‘ä¹Ÿæ˜¯åŸºäºéœ€æ±‚çš„ã€‚ å¦‚æœéœ€æ±‚ç»å¸¸å˜åŒ–ï¼Œè¿™æ˜¯ä¸€ä¸ªå¼±é¡¹ã€‚ </li></ol><br> ç¼ºç‚¹ï¼š <br><br><ol><li> ä»éœ€æ±‚ä¸­å¾—å‡ºå¯å‘å¼æŸ¥è¯¢é¢„æµ‹å¹¶ä¸æ˜¯é‚£ä¹ˆå®¹æ˜“ã€‚ åœ¨ä¸æ•æ·å…¼å®¹æ€§ä¸ä½³çš„ç¨‹åº¦ä¸Šï¼Œå¯èƒ½æœ‰å¿…è¦æ¾„æ¸…éœ€æ±‚ã€‚ </li><li> æ‚¨å¯ä»¥è·å¾—æ›´å¤šæ•°æ®ã€‚ </li><li> ä¸ºäº†ç¡®ä¿é¢„å–åˆåŒæœ‰æ•ˆåœ°å·¥ä½œï¼Œå¯èƒ½éœ€è¦å¯¹æ•°æ®å­˜å‚¨è¿›è¡Œéè§„èŒƒåŒ–ã€‚<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> è¿™æ˜¯ä¸€ä¸ªå¼±å°çš„å‡æ³•ï¼Œå› ä¸ºè¿™äº›ä¼˜åŒ–éµå¾ªä¸šåŠ¡é€»è¾‘ï¼Œå› æ­¤å¾ˆå¯èƒ½å°†ç”±ä¸åŒçš„æµç¨‹ä¸»å¼ ã€‚ </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼Œåº”ç”¨è¿™ç§æ–¹æ³•éå¸¸å›°éš¾ï¼Œå› æ­¤ä¸å€¼å¾—ä¸€è¯•ã€‚</font><font style="vertical-align: inherit;">å®é™…ä¸Šï¼Œåœ¨å®é™…çš„ä¸šåŠ¡é¡¹ç›®ä¸­ï¼Œé™åˆ¶çš„æ•°é‡æ˜¯å·¨å¤§çš„ï¼Œå¹¶ä¸”ç»å¸¸å¯ä»¥ä»æ­¤å †ä¸­è·å¾—æœ‰ç”¨çš„ä¿¡æ¯ï¼Œä»è€Œå¯ä»¥å¯¹æ•°æ®è¿›è¡Œåˆ†åŒºæˆ–é¢„æµ‹ç»Ÿè®¡ä¿¡æ¯ã€‚</font><font style="vertical-align: inherit;">è¿™ç§æ–¹æ³•çš„ä¸»è¦ä¼˜ç‚¹æ˜¯ä¸šåŠ¡å¯ä»¥è§£é‡Šæ‰€ä½¿ç”¨çš„é™åˆ¶ï¼Œå› æ­¤å¾ˆå®¹æ˜“ç†è§£å’ŒéªŒè¯å®ƒä»¬ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é€šå¸¸ï¼Œå°è¯•ä½¿ç”¨æ­¤æ–¹æ³•æ—¶æœ€å¤§çš„é—®é¢˜æ˜¯æ´»åŠ¨åˆ†ç¦»ã€‚</font><font style="vertical-align: inherit;">å¼€å‘äººå‘˜åº”è¯¥å®Œå…¨æ²‰æµ¸åœ¨ä¸šåŠ¡é€»è¾‘ä¸­ï¼Œå¹¶å‘åˆ†æå¸ˆæå‡ºé—®é¢˜ä»¥æ¾„æ¸…é—®é¢˜ï¼Œè¿™éœ€è¦ä¸€å®šç¨‹åº¦çš„ä¸»åŠ¨æ€§ã€‚</font></font><br><br><a name="DDDAgregates"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DDDæ ·å¼çš„å•ä½ </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨å¤§å‹é¡¹ç›®ä¸­ï¼Œæ‚¨ç»å¸¸å¯ä»¥çœ‹åˆ°DDDåšæ³•çš„ä½¿ç”¨ï¼Œå› ä¸ºå®ƒä»¬ä½¿æ‚¨å¯ä»¥æœ‰æ•ˆåœ°æ„å»ºä»£ç ã€‚</font><font style="vertical-align: inherit;">ä¸å¿…åœ¨é¡¹ç›®ä¸­ä½¿ç”¨æ‰€æœ‰DDDæ¨¡æ¿-æœ‰æ—¶å³ä½¿å¼•å…¥ä¸€ä¸ªDDDæ¨¡æ¿ä¹Ÿå¯ä»¥è·å¾—è‰¯å¥½çš„å›æŠ¥ã€‚</font><font style="vertical-align: inherit;">å°†DDDçš„æ¦‚å¿µè§†ä¸ºä¸€ä¸ªæ±‡æ€»ã€‚</font><font style="vertical-align: inherit;">é›†åˆæ˜¯é€»è¾‘ä¸Šè¿æ¥çš„å®ä½“çš„å¹¶é›†ï¼Œåªèƒ½é€šè¿‡é›†åˆçš„æ ¹æ¥æ‰§è¡Œå·¥ä½œï¼ˆé€šå¸¸ï¼Œè¿™æ˜¯ä¸€ä¸ªå®ä½“ï¼Œä½äºå®ä½“è¿æ¥å›¾çš„é¡¶éƒ¨ï¼‰ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»è·å–æ•°æ®çš„è§’åº¦æ¥çœ‹ï¼Œèšåˆä¸­çš„ä¸»è¦å†…å®¹æ˜¯å¤„ç†å®ä½“åˆ—è¡¨çš„æ•´ä¸ªé€»è¾‘éƒ½åœ¨ä¸€ä¸ªåœ°æ–¹-èšåˆã€‚</font><font style="vertical-align: inherit;">åœ¨æ„å»ºæœŸé—´åº”é‡‡ç”¨ä¸¤ç§æ–¹æ³•å°†å…¶ä¼ è¾“åˆ°å•å…ƒï¼š</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä»¬å°†åŠŸèƒ½è½¬ç§»åˆ°æœ¬æœºä»¥è·å–å¤–éƒ¨æ•°æ®ã€‚</font><font style="vertical-align: inherit;">ç¡®å®šå¿…è¦æ•°æ®çš„é€»è¾‘ä½äºå•å…ƒå†…éƒ¨ã€‚</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä»¬ä¼ è¾“æ‰€æœ‰å¿…è¦çš„æ•°æ®ã€‚</font><font style="vertical-align: inherit;">ç¡®å®šå¿…è¦æ•°æ®çš„é€»è¾‘ä½äºèšåˆä¹‹å¤–ã€‚</font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ–¹æ³•çš„é€‰æ‹©å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºé¢„å–å¯ä»¥è½»æ¾åœ°ç§»åˆ°èšåˆä¹‹å¤–çš„æ–¹å¼ã€‚</font><font style="vertical-align: inherit;">å¦‚æœé¢„å–é€»è¾‘æ˜¯åŸºäºä¸šåŠ¡å¯å‘å¼çš„ï¼Œåˆ™é€šå¸¸å¾ˆå®¹æ˜“å°†å…¶ä¸èšåˆåˆ†ç¦»ã€‚</font><font style="vertical-align: inherit;">åŸºäºé€»è¾‘çš„ä½¿ç”¨åˆ†æï¼ˆé€†å‘å·¥ç¨‹ï¼‰å°†é€»è¾‘è¶…å‡ºèšåˆçš„èŒƒå›´å¯èƒ½ä¼šå¾ˆå±é™©ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥å°†é€»è¾‘ç›¸å…³çš„ä»£ç åˆ†é…åˆ°ä¸åŒçš„ç±»ä¸­ã€‚</font></font><br><br><a name="EnlargementInside"></a> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨é›†åˆä¸­æ‰©å¤§æŸ¥è¯¢çš„é€»è¾‘</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è®©æˆ‘ä»¬å°è¯•å‹¾å‹’å‡ºä¸€ä¸ªä¸â€œèŠå¤©â€æ¦‚å¿µç›¸å¯¹åº”çš„é›†åˆã€‚æˆ‘ä»¬çš„ChatMessageï¼ŒUserReferenceå’ŒFileReferenceç±»ä¸å­˜å‚¨æ¨¡å‹ç›¸å¯¹åº”ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨ä¸€äº›é€‚å½“çš„å‰ç¼€æ¥é‡å‘½åå®ƒä»¬ï¼Œä½†æ˜¯æˆ‘ä»¬æœ‰ä¸€ä¸ªå°é¡¹ç›®ï¼Œå› æ­¤æˆ‘ä»¬å°†å…¶ä¿ç•™ã€‚æˆ‘ä»¬å°†ç¨‹åºé›†ç§°ä¸ºChatï¼Œå®ƒçš„ç»„ä»¶æ˜¯ChatPageå’ŒChatPageMesâ€‹â€‹sageï¼š</font><font style="vertical-align: inherit;">åˆ°ç›®å‰ä¸ºæ­¢ï¼Œå·²ç»è·å¾—äº†å¾ˆå¤šæ¯«æ— æ„ä¹‰çš„é‡å¤ã€‚è¿™æ˜¯ç”±äºä»¥ä¸‹äº‹å®ï¼šæˆ‘ä»¬çš„ä¸»é¢˜æ¨¡å‹ç±»ä¼¼äºå­˜å‚¨æ¨¡å‹ï¼Œå¹¶ä¸”ä¸¤è€…éƒ½ç±»ä¼¼äºå‰ç«¯æ¨¡å‹ã€‚</font><font style="vertical-align: inherit;">æˆ‘ç›´æ¥ä½¿ç”¨FileHeadRemoteå’ŒUserRemoteç±»ï¼Œä»¥å…ç¼–å†™è¿‡å¤šä»£ç ï¼Œå°½ç®¡é€šå¸¸åœ¨åŸŸä¸­åº”é¿å…ç›´æ¥ä½¿ç”¨æ­¤ç±»ã€‚</font></font><br><br> <code><font color="7f0055"><b>interface</b></font> <font color="3e7eff"><b>Chat</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getLastPage</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>ChatPage</b></font> <br> <font color="000066">}</font> <br> <br> <font color="7f0055"><b>interface</b></font> <font color="3e7eff"><b>ChatPage</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">messages</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatPageMessage</b></font> <font color="333333">&gt;</font> <br> <font color="000066">}</font> <br> <br> <font color="7f0055"><b>data class</b></font> <font color="3e7eff"><b>ChatPageMessage</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">id</font> : <font color="3e7eff"><b>Long</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">author</font> : <font color="3e7eff"><b>UserRemote</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">message</font> : <font color="3e7eff"><b>String</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">files</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="333333">&gt;,</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">replyTo</font> : <font color="3e7eff"><b>ChatPageMessage</b></font> ? <font color="333333">,</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">forwardFrom</font> : <font color="3e7eff"><b>ChatPageMessage</b></font> ? <br> <font color="000066">)</font></code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦‚æœä½¿ç”¨è¿™æ ·çš„èšåˆï¼Œæˆ‘ä»¬çš„RESTæ§åˆ¶å™¨å¯ä»¥é‡å†™å¦‚ä¸‹ï¼š</font><font style="vertical-align: inherit;">è¯¥é€‰é¡¹åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šä½¿æˆ‘ä»¬è”æƒ³åˆ°ç¬¬ä¸€ä¸ªå¹¼ç¨šçš„å®ç°ï¼Œä½†æ˜¯å®ƒå…·æœ‰ä¸€ä¸ªé‡è¦çš„ä¼˜åŠ¿ï¼šè¯¥æ§åˆ¶å™¨ä¸å†ä»äº‹ç›´æ¥æ¥æ”¶æ•°æ®çš„å·¥ä½œï¼Œå¹¶ä¸”ä¸ä¾èµ–äºä¸æ•°æ®å­˜å‚¨å…³è”çš„ç±»ï¼Œè€Œæ˜¯ä¾èµ–äºä»…æ¥è‡ªé€šè¿‡æ¥å£è®¾ç½®çš„å•å…ƒã€‚</font><font style="vertical-align: inherit;">å› æ­¤ï¼Œé¢„å–é€»è¾‘ä¸å†åœ¨æ§åˆ¶å™¨ä¸­ã€‚</font><font style="vertical-align: inherit;">æ§åˆ¶å™¨ä»…å¤„ç†å°†å•å…ƒè½¬æ¢ä¸ºå‰ç«¯æ¨¡å‹çš„è¿‡ç¨‹ï¼Œè¿™ä½¿æˆ‘ä»¬ç¬¦åˆå•ä¸€è´£ä»»åŸåˆ™ï¼ˆSRPï¼‰ã€‚</font><font style="vertical-align: inherit;">ä¸å¹¸çš„æ˜¯ï¼Œå¯¹äºæ±‡æ€»ä¸­æè¿°çš„æ‰€æœ‰æ–¹æ³•ï¼Œæ‚¨éƒ½å¿…é¡»ç¼–å†™ä¸€ä¸ªå®ç°ã€‚</font></font><br><br> <code><font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>ChatRestController</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">chat</font> : <font color="3e7eff"><b>Chat</b></font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>ChatRestApi</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>override fun</b></font> <font color="170591"><b>getLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <font color="566874">chat</font> <font color="333333">.</font> <font color="170591">getLastPage</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">()</font> <br> <br> <font color="7f0055"><b>private fun</b></font> <font color="3e7eff"><b>ChatPage</b></font> <font color="333333">.</font> <font color="170591"><b>toFrontModel</b></font> <font color="000066">()</font> <font color="333333">=</font> <br> <font color="566874">messages</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <br> <br> <font color="000066"><b>&nbsp;&nbsp;</b></font> <font color="7f0055"><b>private fun</b></font> <font color="3e7eff"><b>ChatPageMessage</b></font> <font color="333333">.</font> <font color="170591"><b>toFrontModel</b></font> <font color="000066">()</font> : <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="333333">=</font> <br> <font color="170591">ChatMessageUI</font> <font color="000066">(</font> <br> <font color="4a86e8">id =</font> <font color="566874">id</font> <font color="333333">,</font> <br> <font color="4a86e8">author =</font> <font color="566874">author</font> <font color="333333">.</font> <i><b>toFrontReference</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="4a86e8">message =</font> <font color="566874">message</font> <font color="333333">,</font> <br> <font color="4a86e8">files =</font> <font color="566874">files</font> <font color="333333">.</font> <i><b>toFrontReference</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="4a86e8">forwardFrom =</font> <font color="566874">forwardFrom</font> <font color="333333">?.</font> <i><b>toFrontModel</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="4a86e8">replyTo =</font> <font color="566874">replyTo</font> <font color="333333">?.</font> <i><b>toFrontModel</b></i> <font color="000066">()</font> <br> <font color="000066">)</font> <br> <font color="000066">}</font></code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è®©æˆ‘ä»¬å°è¯•ä»…ä¿å­˜ä½¿ç”¨ä¸šåŠ¡è¯•æ¢æ³•æ—¶å®ç°çš„æ§åˆ¶å™¨é€»è¾‘ã€‚</font></font></b> <div class="spoiler_text"> <code><font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>ChatImpl</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">messageRepository</font> : <font color="3e7eff"><b>ChatMessageRepository</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">userRepository</font> : <font color="3e7eff"><b>UserRemoteApi</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">fileRepository</font> : <font color="3e7eff"><b>FileRemoteApi</b></font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>Chat</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>override fun</b></font> <font color="170591"><b>getLastPage</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <font color="7f0055"><b>object</b></font> : <font color="3e7eff"><b>ChatPage</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>override val</b></font> <font color="566874">messages</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatPageMessage</b></font> <font color="333333">&gt;</font> <br> <font color="7f0055"><b>get</b></font> <font color="000066">()</font> <font color="333333">=</font> <br> <i><b>runBlocking</b></i> <font color="000066">(</font> <font color="05314d"><b>IO</b></font> <font color="000066">)</font> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="7f0055"><b>val</b></font> <font color="170591">prefetch</font> <font color="333333">=</font> <i><b>async</b></i> <font color="000066">(</font> <br> <font color="000066"><b>{</b></font> <font color="566874">userRepository</font> <font color="333333">.</font> <font color="170591">getUsersByChat</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>} }</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByChat</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>} }</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <br> <br> <i><b>withContext</b></i> <font color="000066">(</font> <font color="05314d"><b>IO</b></font> <font color="000066">)</font> <font color="000066"><b>{</b></font> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="3e7eff"><b>n</b></font> <font color="000066">)</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066">(</font> <br> <font color="170591">prefetch</font> <font color="333333">.</font> <font color="170591">await</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066">(</font> <font color="170591">users</font> <font color="333333">,</font> <font color="170591">files</font> <font color="000066">)</font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>recursiveMemoize</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>memoized</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>ChatPageMessage</b></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <i><b>toDomainModel</b></i> <font color="000066">(</font> <br> <font color="4a86e8">getUser =</font> <font color="170591">users</font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"User</b> <font color="333333"><b>$</b></font> <font color="000066"><i>it</i></font> <b>"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="4a86e8">getFile =</font> <font color="170591">files</font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"File</b> <font color="333333"><b>$</b></font> <font color="000066"><i>it</i></font> <b>"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="3f7f5f">//       </font> <br> <font color="4a86e8">serializeMessage =</font> <font color="000066"><i>memoized</i></font> <br> <font color="000066"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;</b></font> <font color="000066">}</font> <br> <font color="000066">}</font> <br> <br> <font color="7f0055"><b>private fun</b></font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="333333">.</font> <font color="170591"><b>toDomainModel</b></font> <font color="000066">(</font> <br> <font color="000066"><i>getUser</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>UserReference</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>UserRemote</b></font> <font color="333333">,</font> <br> <font color="000066"><i>getFile</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>FileReference</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="333333">,</font> <br> <font color="000066"><i>serializeMessage</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>ChatPageMessage</b></font> <br> <font color="000066">)</font> <font color="333333">=</font> <font color="170591">ChatPageMessage</font> <font color="000066">(</font> <br> <font color="4a86e8">id =</font> <font color="566874">id</font> ?: <font color="7f0055"><b>throw</b></font> <font color="170591">IllegalStateException</font> <font color="000066">(</font> <b>"</b> <font color="333333"><b>$</b></font> <font color="7f0055"><b>this</b></font> <b>must be persisted"</b> <font color="000066">)</font> <font color="333333">,</font> <br> <font color="4a86e8">author =</font> <font color="000066"><i>getUser</i></font> <font color="000066">(</font> <font color="566874">author</font> <font color="000066">)</font> <font color="333333">,</font> <br> <font color="4a86e8">message =</font> <font color="566874">message</font> <font color="333333">,</font> <br> <font color="4a86e8">files =</font> <font color="566874">files</font> <font color="333333">?.</font> <i><b>map</b></i> <font color="000066">(</font> <font color="000066"><i>getFile</i></font> <font color="000066">)</font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="4a86e8">forwardFrom =</font> <font color="566874">forwardFrom</font> <font color="333333">?.</font> <i><b>let</b></i> <font color="000066">(</font> <font color="000066"><i>serializeMessage</i></font> <font color="000066">)</font> <font color="333333">,</font> <br> <font color="4a86e8">replyTo =</font> <font color="566874">replyTo</font> <font color="333333">?.</font> <i><b>let</b></i> <font color="000066">(</font> <font color="000066"><i>serializeMessage</i></font> <font color="000066">)</font> <br> <font color="000066">)</font> <br></code> </div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">äº‹å®è¯æ˜ï¼ŒgetLastPageå‡½æ•°æœ¬èº«å…·æœ‰æ•°æ®è·å–ç­–ç•¥ï¼ŒåŒ…æ‹¬é¢„å–ï¼Œå¹¶ä¸”toDomainModelå‡½æ•°çº¯ç²¹æ˜¯æŠ€æœ¯æ€§çš„ï¼Œè´Ÿè´£å°†å­˜å‚¨çš„æ¨¡å‹è½¬æ¢ä¸ºåŸŸæ¨¡å‹ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä»¥å¯¹Kotlinæ›´ç†Ÿæ‚‰çš„å½¢å¼é‡å†™äº†å¯¹userRepositoryï¼ŒfileRepositoryå’ŒmessageRepositoryçš„å¹¶è¡Œè°ƒç”¨ã€‚æˆ‘å¸Œæœ›ä»£ç çš„å¯ç†è§£æ€§ä¸ä¼šå› æ­¤è€Œå—åˆ°å½±å“ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é€šå¸¸ï¼Œè¿™ç§æ–¹æ³•å·²ç»å®Œå…¨å¯ä»¥æ“ä½œï¼Œåº”ç”¨æ—¶çš„æ€§èƒ½å°†ä¸ç®€å•ä½¿ç”¨é€†å‘å·¥ç¨‹æˆ–ä¸šåŠ¡å¯å‘æ³•ç›¸åŒã€‚</font></font><br><br><a name="EnlargementOutside"></a> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨èšåˆä¹‹å¤–æ‰©å¤§æŸ¥è¯¢çš„é€»è¾‘</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨åˆ›å»º</font><b><font style="vertical-align: inherit;">èšåˆ</font></b><font style="vertical-align: inherit;">çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ç«‹å³é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼šæ„é€ ChatPageæ—¶ï¼Œéœ€è¦åœ¨åˆ›å»ºChatæ—¶å°†é¡µé¢å¤§å°è®¾ç½®ä¸ºå¸¸é‡ï¼Œè€Œä¸æ˜¯åƒå¾€å¸¸ä¸€æ ·å°†å…¶ä¼ é€’ç»™getLastï¼ˆï¼‰ã€‚å°†ä¸å¾—ä¸æ”¹å˜è‡ªå·±èšåˆæ¥å£ï¼š</font><font style="vertical-align: inherit;">æ—¢ç„¶æˆ‘ä»¬æœ‰dochitkaå…¶ä»–æ¶ˆæ¯ï¼Œæˆ‘ä»¬å¼ºçƒˆå¸Œæœ›è·å¾—æ‰€æœ‰å•å…ƒçš„æ•°æ®å¤–ï¼Œæˆ‘ä»¬å°†ä¸å¾—ä¸é€‰æ‹©ä¸ä»–äººèŠå¤©æ ¹ChatPageçš„æ€»ä½“æ°´å¹³çš„å‡ºæ¥ï¼š</font><font style="vertical-align: inherit;">æ¥ä¸‹æ¥ï¼Œä½ éœ€è¦åˆ›å»ºä¸€ä¸ªé¢„å–ç ï¼Œä»å•å…ƒåˆ†ç¦»ï¼š</font><font style="vertical-align: inherit;">ç°åœ¨ï¼Œä¸ºäº†è¦åˆ›å»ºèšåˆï¼Œæ‚¨éœ€è¦å°†å…¶ä¸é¢„å–å¯¹æ¥ã€‚åœ¨DDDä¸­ï¼Œè¿™ç§ç¼–æ’æ˜¯ç”±Application Serviceså®Œæˆçš„ã€‚</font></font><br><br> <code><font color="7f0055"><b>interface</b></font> <font color="3e7eff"><b>Chat</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getPage</b></font> <font color="000066">()</font> : <font color="3e7eff"><b>ChatPage</b></font> <br> <font color="000066">}</font></code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code><font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>ChatPageImpl</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">messageData</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="333333">&gt;,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">userData</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>UserRemote</b></font> <font color="333333">&gt;,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">fileData</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="333333">&gt;</font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>ChatPage</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>override val</b></font> <font color="566874">messages</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatPageMessage</b></font> <font color="333333">&gt;</font> <br> <font color="7f0055"><b>get</b></font> <font color="000066">()</font> <font color="333333">=</font> <br> <font color="566874">messageData</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066">(</font> <br> <font color="000066">(</font> <font color="566874">userData</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> <i><b>to</b></i> <font color="566874">fileData</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066">(</font> <font color="170591">users</font> <font color="333333">,</font> <font color="170591">files</font> <font color="000066">)</font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>recursiveMemoize</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>self</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>ChatPageMessage</b></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <i><b>toDomainModel</b></i> <font color="000066">(</font> <br> <font color="4a86e8">getUser =</font> <font color="170591">users</font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="4a86e8">getFile =</font> <font color="170591">files</font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="3f7f5f">//       </font> <br> <font color="4a86e8">serializeMessage =</font> <font color="000066"><i>self</i></font> <br> <font color="000066"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <br> <font color="000066">}</font></code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code><font color="7f0055"><b>fun</b></font> <font color="170591"><b>chatPagePrefetch</b></font> <font color="000066">(</font> <br> <font color="000066"><i>pageSize</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="333333">,</font> <br> <font color="000066"><i>messageRepository</i></font> : <font color="3e7eff"><b>ChatMessageRepository</b></font> <font color="333333">,</font> <br> <font color="000066"><i>userRepository</i></font> : <font color="3e7eff"><b>UserRemoteApi</b></font> <font color="333333">,</font> <br> <font color="000066"><i>fileRepository</i></font> : <font color="3e7eff"><b>FileRemoteApi</b></font> <br> <font color="000066">)</font> <font color="333333">=</font> <br> <i><b>runBlocking</b></i> <font color="000066">(</font> <font color="05314d"><b>IO</b></font> <font color="000066">)</font> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>async</b></i> <font color="000066">(</font> <br> <font color="000066"><b>{</b></font> <font color="3e7eff"><b>userRepository</b></font> <font color="333333">.</font> <font color="170591">getUsersByChat</font> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="3e7eff"><b>fileRepository</b></font> <font color="333333">.</font> <font color="170591">getHeadsByChat</font> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="3e7eff"><b>messageRepository</b></font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="3e7eff"><b>pageSize</b></font> <font color="000066">)</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font></code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code><font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>ChatService</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">messageRepository</font> : <font color="3e7eff"><b>ChatMessageRepository</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">userRepository</font> : <font color="3e7eff"><b>UserRemoteApi</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">fileRepository</font> : <font color="3e7eff"><b>FileRemoteApi</b></font> <br> <font color="000066">) {</font> <br> <font color="7f0055"><b>private fun</b></font> <font color="170591"><b>chatPagePrefetch</b></font> <font color="000066">(</font> <font color="000066"><i>pageSize</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <i><b>runBlocking</b></i> <font color="000066">(</font> <font color="05314d"><b>IO</b></font> <font color="000066">)</font> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>async</b></i> <font color="000066">(</font> <br> <font color="000066"><b>{</b></font> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="3e7eff"><b>pageSize</b></font> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="566874">userRepository</font> <font color="333333">.</font> <font color="170591">getUsersByChat</font> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByChat</font> <font color="000066">()</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <font color="333333">.</font> <font color="170591">await</font> <font color="000066">()</font> <br> <font color="000066"><b>}</b></font> <br> <br> <font color="000066"><b>&nbsp;&nbsp;</b></font> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getLastPage</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>ChatPage</b></font> <font color="333333">=</font> <br> <font color="170591">chatPagePrefetch</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066">(</font> <font color="170591">messageData</font> <font color="333333">,</font> <font color="170591">userData</font> <font color="333333">,</font> <font color="170591">fileData</font> <font color="000066">)</font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="170591">ChatPageImpl</font> <font color="000066">(</font> <font color="170591">messageData</font> <font color="333333">,</font> <font color="170591">userData</font> <font color="333333">,</font> <font color="170591">fileData</font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066">}</font></code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¥½å§ï¼Œæ§åˆ¶å™¨ä¸ä¼šæœ‰å¤ªå¤§å˜åŒ–ï¼Œæ‚¨åªéœ€è¦ä½¿ç”¨ChatService :: getLastPageè€Œä¸æ˜¯Chat :: getLastPageã€‚</font><font style="vertical-align: inherit;">ä¹Ÿå°±æ˜¯è¯´ï¼Œä»£ç å°†åƒè¿™æ ·æ›´æ”¹ï¼š</font></font><br><br> <code><font color="7f0055"><b>class</b></font> ChatRestController <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">chat</font> : <font color="3e7eff"><b>ChatService</b></font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>ChatRestApi</b></font> <br></code> <br><br><a name="Summary3"></a>  <b>ç»“è®º</b> <br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> é¢„å–é€»è¾‘å¯ä»¥æ”¾ç½®åœ¨è®¾å¤‡å†…éƒ¨æˆ–å•ç‹¬çš„ä½ç½®ã€‚ </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦‚æœé¢„å–é€»è¾‘ä¸èšåˆçš„å†…éƒ¨é€»è¾‘ç´§å¯†ç›¸å…³ï¼Œåˆ™æœ€å¥½ä¸è¦å°†å…¶å–å‡ºï¼Œå› ä¸ºè¿™ä¼šç ´åå°è£…ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä¸ªäººè®¤ä¸ºå°†é¢„å–ç§»å‡ºèšåˆæ²¡æœ‰å¤ªå¤§æ„ä¹‰ï¼Œå› ä¸ºè¿™æå¤§åœ°é™åˆ¶äº†å¯èƒ½æ€§ï¼Œå¹¶å¢åŠ äº†ä»£ç çš„éšå¼ä¸€è‡´æ€§ã€‚</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> æ±‡æ€»ç»„ç»‡æœ¬èº«å¯¹æ‰¹å¤„ç†çš„æ€§èƒ½äº§ç”Ÿç§¯æå½±å“ï¼Œå› ä¸ºå¯¹ç¹é‡è¯·æ±‚çš„æ§åˆ¶å˜å¾—æ›´å¤šï¼Œé¢„å–é€»è¾‘çš„ä½ç½®ä¹Ÿå˜å¾—ååˆ†æ˜ç¡®ã€‚ </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†è€ƒè™‘æ— æ³•ä¸ä¸»å‡½æ•°éš”ç¦»åœ°å®ç°çš„é¢„å–å®ç°ã€‚ </font></font><br><br><a name="Proxying"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ä»£ç†å’ŒåŒé‡é€šè¯ </font></font></h4><br><a name="ManagingContractProblem2"></a> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è§£å†³åˆåŒé—®é¢˜</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ­£å¦‚æˆ‘ä»¬åœ¨å‰é¢çš„éƒ¨åˆ†ä¸­å·²ç»çœ‹åˆ°çš„é‚£æ ·ï¼Œé¢„å–åˆåŒçš„ä¸»è¦é—®é¢˜åœ¨äºï¼Œå®ƒä¸å¿…é¡»ä¸ºå…¶å‡†å¤‡æ•°æ®çš„åŠŸèƒ½çš„åˆåŒç´§å¯†ç›¸å…³ã€‚</font><font style="vertical-align: inherit;">æ›´ç¡®åˆ‡åœ°è¯´ï¼Œè¿™å–å†³äºä¸»è¦åŠŸèƒ½å¯èƒ½éœ€è¦å“ªäº›æ•°æ®ã€‚</font><font style="vertical-align: inherit;">å¦‚æœæˆ‘ä»¬ä¸å°è¯•é¢„æµ‹è€Œæ˜¯å°è¯•ä½¿ç”¨ä»£ç æœ¬èº«è¿›è¡Œé€†å‘å·¥ç¨‹è¯¥æ€ä¹ˆåŠï¼Ÿ</font><font style="vertical-align: inherit;">åœ¨ç®€å•çš„æƒ…å†µä¸‹ï¼Œæµ‹è¯•ä¸­å¸¸ç”¨çš„ä»£ç†æ–¹æ³•å¯ä»¥ä¸ºæˆ‘ä»¬æä¾›å¸®åŠ©ã€‚</font><font style="vertical-align: inherit;">Mockitoä¹‹ç±»çš„åº“ä½¿ç”¨æ¥å£å®ç°ç”Ÿæˆç±»ï¼Œè¿™äº›å®ç°ä¹Ÿå¯ä»¥ç§¯ç´¯æœ‰å…³è°ƒç”¨çš„ä¿¡æ¯ã€‚</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä»¬çš„å›¾ä¹¦é¦†ä½¿ç”¨äº†ç±»ä¼¼çš„æ–¹æ³•</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦‚æœä½¿ç”¨ä»£ç†å­˜å‚¨åº“è°ƒç”¨mainå‡½æ•°å¹¶æ”¶é›†æœ‰å…³å¿…è¦æ•°æ®çš„ä¿¡æ¯ï¼Œåˆ™å¯ä»¥ä»¥åŒ…çš„å½¢å¼è·å–æ­¤æ•°æ®å¹¶é‡æ–°è°ƒç”¨mainå‡½æ•°ä»¥è·å¾—æœ€ç»ˆç»“æœã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸»è¦æ¡ä»¶å¦‚ä¸‹ï¼šæ‰€è¯·æ±‚çš„æ•°æ®ä¸åº”å½±å“åç»­è¯·æ±‚ã€‚ä»£ç†ä¸ä¼šè¿”å›çœŸå®æ•°æ®ï¼Œè€Œåªä¼šè¿”å›ä¸€äº›å­˜æ ¹ï¼Œå› æ­¤æ‰€æœ‰åˆ†æ”¯å’Œæ¥æ”¶å…³è”æ•°æ®éƒ½å°†æ¶ˆå¤±ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ï¼Œè¿™æ„å‘³ç€ä»£ç†messageRepositoryæ˜¯æ²¡æœ‰ç”¨çš„ï¼Œå› ä¸ºå°†æ ¹æ®æ¶ˆæ¯è¯·æ±‚çš„ç»“æœè¿›è¡Œè¿›ä¸€æ­¥çš„è¯·æ±‚ã€‚è¿™æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºæˆ‘ä»¬åªæœ‰ä¸€ä¸ªè¯·æ±‚messageRepositoryï¼Œæ‰€ä»¥è¿™é‡Œä¸éœ€è¦æ‰¹å¤„ç†ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> å› ä¸ºæˆ‘ä»¬å°†ä»£ç†ç®€å•çš„å‡½æ•°UserReference-&gt; UserRemoteå’ŒFileReference-&gt; FileHeadRemoteï¼Œæ‰€ä»¥æ‚¨åªéœ€è¦ç´¯åŠ ä¸¤ä¸ªå‚æ•°åˆ—è¡¨ã€‚ </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç»“æœï¼Œæˆ‘ä»¬å¾—åˆ°ä»¥ä¸‹ä¿¡æ¯ï¼š</font></font></b> <div class="spoiler_text"> <code><font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>ChatRestController</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">messageRepository</font> : <font color="3e7eff"><b>ChatMessageRepository</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">userRepository</font> : <font color="3e7eff"><b>UserRemoteApi</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">fileRepository</font> : <font color="3e7eff"><b>FileRemoteApi</b></font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>ChatRestApi</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>override fun</b></font> <font color="170591"><b>getLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="333333">&gt;</font> <font color="000066">{</font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">messages</font> <font color="333333">=</font> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <br> <font color="3f7f5f">//    </font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>transform</b></font> <font color="000066">(</font> <br> <font color="000066"><i>getUser</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>UserReference</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>UserRemote</b></font> <font color="333333">,</font> <br> <font color="000066"><i>getFile</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>FileReference</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <br> <font color="3e7eff"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="333333">&gt; =</font> <br> <font color="3e7eff"><b>messages</b></font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066">(</font> <br> <i><b>recursiveMemoize</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>self</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">(</font> <font color="000066"><i>getUser</i></font> <font color="333333">,</font> <font color="000066"><i>getFile</i></font> <font color="333333">,</font> <font color="000066"><i>self</i></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <br> <br> <font color="3f7f5f">//  </font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">userIds</font> <font color="333333">=</font> <i><b>mutableSetOf</b></i> <font color="333333">&lt;</font> <font color="3e7eff"><b>UserReference</b></font> <font color="333333">&gt;</font> <font color="000066">()</font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">fileIds</font> <font color="333333">=</font> <i><b>mutableSetOf</b></i> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileReference</b></font> <font color="333333">&gt;</font> <font color="000066">()</font> <br> <font color="170591">transform</font> <font color="000066">(</font> <br> <font color="000066"><b>{</b></font> <font color="3e7eff"><b>userIds</b></font> <font color="333333">+=</font> <b>it</b> <font color="333333">;</font> <font color="170591">UserRemote</font> <font color="000066">(</font> <font color="333333"><b>0L</b></font> <font color="333333">,</font> <b>""</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="3e7eff"><b>fileIds</b></font> <font color="333333">+=</font> <font color="000066"><i>it</i></font> <font color="333333">;</font> <font color="170591">FileHeadRemote</font> <font color="000066">(</font> <font color="333333"><b>0L</b></font> <font color="333333">,</font> <b>""</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <br> <br> <font color="7f0055"><b>return</b></font> <i><b>runBlocking</b></i> <font color="000066">(</font> <font color="05314d"><b>IO</b></font> <font color="000066">)</font> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//      </font> <br> <i><b>async</b></i> <font color="000066">(</font> <br> <font color="000066"><b>{</b></font> <font color="566874">userRepository</font> <font color="333333">.</font> <font color="170591">getUsersByIds</font> <font color="000066">(</font> <font color="3e7eff"><b>userIds</b></font> <font color="000066">)</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByIds</font> <font color="000066">(</font> <font color="3e7eff"><b>fileIds</b></font> <font color="000066">)</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <font color="333333">.</font> <font color="170591">await</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066">(</font> <font color="170591">getUser</font> <font color="333333">,</font> <font color="170591">getFile</font> <font color="000066">)</font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="170591">transform</font> <font color="000066">(</font> <font color="170591">getUser</font> <font color="333333">,</font> <font color="170591">getFile</font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;</b></font> <font color="000066">}</font> <br> <font color="000066">}</font></code> </div> </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦‚æœè¡¡é‡æ€§èƒ½ï¼Œäº‹å®è¯æ˜ï¼Œå°½ç®¡æˆ‘ä»¬ä¸¤æ¬¡è°ƒç”¨äº†è¯¥å‡½æ•°ï¼Œä½†ä½¿ç”¨è¿™ç§æ–¹æ³•å¹¶ä¸æ¯”ä½¿ç”¨é€†å‘å·¥ç¨‹æ–¹æ³•æ›´ç³Ÿã€‚è¿™æ˜¯ç”±äºè¿™æ ·çš„äº‹å®ï¼Œä¸å¤–éƒ¨æŸ¥è¯¢çš„æ‰§è¡Œæ—¶é—´ç›¸æ¯”ï¼Œè½¬æ¢å‡½æ•°çš„æ‰§è¡Œæ—¶é—´å¯ä»¥å¿½ç•¥ï¼ˆåœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼‰ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸ä½¿ç”¨ä¸šåŠ¡å¯å‘å¼æ–¹æ³•æ—¶çš„æ€§èƒ½ç›¸æ¯”ï¼Œåœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼ŒæŸ¥è¯¢çš„ç´¯ç§¯å°†ä¸å¤ªæœ‰æ•ˆã€‚ä½†æ˜¯è¯·è®°ä½ï¼Œå¹¶éæ€»æ˜¯èƒ½å¤Ÿæ‰¾åˆ°å¦‚æ­¤å‡ºè‰²çš„å¯å‘å¼æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œå¦‚æœèŠå¤©ä¸­çš„ç”¨æˆ·æ•°é‡å¾ˆå¤§ï¼Œæ–‡ä»¶æ•°é‡ä¹Ÿå¾ˆå¤§ï¼Œå¹¶ä¸”æ–‡ä»¶å¾ˆå°‘é™„åŠ åˆ°æ¶ˆæ¯ä¸­ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ä¸šåŠ¡å¯å‘å¼ç®—æ³•å°†ç«‹å³å¤±å»è¯šå®æ¥æ”¶è¯·æ±‚åˆ—è¡¨çš„èƒ½åŠ›ã€‚</font></font><br><br><a name="Summary4"></a>  <b>ç»“è®º</b> <br><br> ä¼˜ç‚¹ï¼š <br><br><ol><li>   prefetch   -   . </li><li>          prefetch. </li><li>    ,   -. </li></ol><br> ç¼ºç‚¹ï¼š <br><br><ol><li>       . </li><li>  ,     . </li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å°½ç®¡æœ‰æ˜æ˜¾çš„å¼‚å›½æƒ…è°ƒï¼Œä½†é€šè¿‡ä»£ç†å’Œé‡æ–°è°ƒç”¨è¿›è¡Œçš„è¯·æ±‚ç´¯ç§¯åœ¨ä¸»åŠŸèƒ½é€»è¾‘ä¸æ¥æ”¶çš„æ•°æ®ä¸ç›¸å…³çš„æƒ…å†µä¸‹éå¸¸é€‚ç”¨ã€‚è¿™é‡Œçš„ä¸»è¦å›°éš¾ä¸é€†å‘å·¥ç¨‹ç›¸åŒï¼šå°½ç®¡åŠŸèƒ½ç¨‹åº¦è¦å°å¾—å¤šï¼ˆä»…åŸºäºä»¥ä¸‹æŸ¥è¯¢ä¸ä¾èµ–äºå…ˆå‰æŸ¥è¯¢çš„ç»“æœè¿™ä¸€äº‹å®ï¼‰ï¼Œæˆ‘ä»¬ä»åœ¨ä¾èµ–è¯¥å‡½æ•°çš„å½“å‰å®ç°ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ€§èƒ½ä¼šç•¥æœ‰ä¸‹é™ï¼Œä½†æ˜¯åœ¨é¢„å–ä»£ç ä¸­ï¼Œæ‚¨æ— éœ€è€ƒè™‘ä¸»è¦åŠŸèƒ½å®ç°çš„æ‰€æœ‰ç»†å¾®å·®åˆ«ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å½“æ‚¨æ— æ³•å»ºç«‹è‰¯å¥½çš„ä¸šåŠ¡å¯å‘å¼æ–¹æ³•æ¥è¿›è¡ŒæŸ¥è¯¢é¢„æµ‹ï¼Œå¹¶ä¸”å¸Œæœ›å‡å°‘é¢„å–å’ŒåŠŸèƒ½è¿æ¥æ—¶ï¼Œå¯ä»¥ä½¿ç”¨æ­¤æ–¹æ³•ã€‚</font></font><br><br><a name="Conclusion"></a><h2> ç»“è®º </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¹çœ‹ä¹‹ä¸‹ï¼Œä½¿ç”¨æ‰¹å¤„ç†å¹¶éå¦‚æ­¤ç®€å•ã€‚æˆ‘è®¤ä¸ºæ‰€æœ‰è®¾è®¡æ¨¡å¼éƒ½å…·æœ‰æ­¤å±æ€§ï¼ˆè¯·è®°ä½ç¼“å­˜ï¼‰ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸ºäº†æœ‰æ•ˆåœ°å¤„ç†è¯·æ±‚ï¼Œé‡è¦çš„æ˜¯ï¼Œè°ƒç”¨è€…å¿…é¡»æ”¶é›†å°½å¯èƒ½å¤šçš„è¯·æ±‚ï¼Œè€Œè¿™é€šå¸¸å—åº”ç”¨ç¨‹åºç»“æ„çš„é˜»ç¢ã€‚æœ‰ä¸¤ç§è§£å†³æ–¹æ³•ï¼šè¦ä¹ˆè®¾è®¡åº”ç”¨ç¨‹åºä»¥æœ‰æ•ˆåœ°å¤„ç†æ•°æ®ï¼ˆå®ƒå¾ˆå¯èƒ½å¯¼è‡´åº”ç”¨ç¨‹åºçš„ååº”å¼è®¾å¤‡ï¼‰ï¼Œè¦ä¹ˆï¼ˆç»å¸¸å‘ç”Ÿï¼‰å°è¯•åœ¨ä¸è¿›è¡Œé‡å¤§é‡ç»„çš„æƒ…å†µä¸‹åœ¨ç°æœ‰åº”ç”¨ç¨‹åºä¸­å®ç°æ‰¹å¤„ç†ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å †æŸ¥è¯¢çš„æœ€æ˜¾è€Œæ˜“è§çš„æ–¹æ³•æ˜¯å¯¹å¤§é‡æŸ¥è¯¢è¿›è¡Œåå‘å·¥ç¨‹è®¾è®¡ã€‚</font><font style="vertical-align: inherit;">è¿™ç§æ–¹æ³•çš„ä¸»è¦ç¼ºç‚¹å°†æ˜¯éšå¼ä»£ç è¿æ¥æ€§çš„å¢åŠ ã€‚</font><font style="vertical-align: inherit;">ä¸€ç§æ›¿ä»£æ–¹æ³•æ˜¯ä½¿ç”¨æœ‰å…³ä¸šåŠ¡åŠŸèƒ½çš„ä¿¡æ¯ï¼Œä»¥ä¾¿å°†æ•°æ®åˆ’åˆ†ä¸ºå¤šä¸ªå—ï¼Œè¿™äº›å—é€šå¸¸è¢«å…±äº«ã€‚</font><font style="vertical-align: inherit;">æœ‰æ—¶ï¼Œä¸ºäº†å®ç°è¿™ç§æœ‰æ•ˆçš„åˆ†ç¦»ï¼Œæœ‰å¿…è¦å¯¹å­˜å‚¨è¿›è¡Œéè§„èŒƒåŒ–ï¼Œä½†æ˜¯å¦‚æœæˆåŠŸï¼Œåˆ™æ‰¹å¤„ç†çš„é€»è¾‘å°†ç”±ä¸»é¢˜åŒºåŸŸç¡®å®šï¼Œè¿™å¾ˆå¥½ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è·å¾—æ‰€æœ‰è¯·æ±‚çš„ä¸€ç§ä¸å¤ªæ˜æ˜¾çš„æ–¹æ³•æ˜¯å®ç°ä¸¤æ¬¡é€šè¿‡ã€‚</font><font style="vertical-align: inherit;">åœ¨ç¬¬ä¸€é˜¶æ®µï¼Œæˆ‘ä»¬æ”¶é›†æ‰€æœ‰å¿…è¦çš„è¯·æ±‚ï¼Œåœ¨ç¬¬äºŒé˜¶æ®µï¼Œæˆ‘ä»¬å°†å¤„ç†å·²ç»æ”¶åˆ°çš„æ•°æ®ã€‚</font><font style="vertical-align: inherit;">è¿™ç§æ–¹æ³•çš„é€‚ç”¨æ€§å—åˆ°è¦æ±‚å½¼æ­¤ç‹¬ç«‹çš„è¦æ±‚çš„é™åˆ¶ã€‚</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN467919/">https://habr.com/ru/post/zh-CN467919/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN467905/index.html">æˆ‘ä»¬å¦‚ä½•åœ¨Cloud Mail.ruä¸­è¿›è¡Œåœ°æ ‡è¯†åˆ«ï¼Œä»¥åŠä¸ºä»€ä¹ˆ</a></li>
<li><a href="../zh-CN467907/index.html">å¤–åŒ…çš„åˆ©ä¸å¼Š</a></li>
<li><a href="../zh-CN467909/index.html">åœ¨iOSä¸ŠèŠå¤©ï¼šä½¿ç”¨å¥—æ¥å­—</a></li>
<li><a href="../zh-CN467913/index.html">å¦‚ä½•æ”¹å–„â€œé‡å…½çŸ¿ç‰©è´¨â€æˆ–å¤ªé˜³èƒ½ç”µæ± æ¿çš„æ–°ç•Œé¢</a></li>
<li><a href="../zh-CN467915/index.html">ç›‘æ§Openshiftå†…éƒ¨çš„postgres</a></li>
<li><a href="../zh-CN467921/index.html">æ‹¿å‡ºå°˜åœŸé£æ‰¬çš„ç¬”ï¼šæ‰‹å†™å¯¹å¤§è„‘æœ‰ç›Š</a></li>
<li><a href="../zh-CN467923/index.html">å› æ­¤ï¼Œæ‚¨æƒ³æˆä¸ºç½‘ç»œå®‰å…¨é¢†åŸŸçš„åˆ†æå¸ˆ...</a></li>
<li><a href="../zh-CN467925/index.html">ä¸ºä»€ä¹ˆå¼€å‘äººå‘˜å¦‚æ­¤çƒ­çˆ±é»‘æš—ä¸»é¢˜</a></li>
<li><a href="../zh-CN467929/index.html">æˆ‘ä»¬ç»„ç»‡æ··ä¹±æˆ–å¦‚ä½•åœ¨ç»„ç»‡ä¸­å®æ–½æµç¨‹æ–¹æ³•</a></li>
<li><a href="../zh-CN467933/index.html">ç„¶è€Œï¼Œä¸ºä»€ä¹ˆPositæ˜¯IEEE 754çš„æœ‰ä»·å€¼æ›¿ä»£å“</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>