<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘œ ğŸ’‡ ğŸ’‡ğŸ¼ åŸºäºYandexSpeechKitçš„è¯­éŸ³å‘å¯¼çš„å®ç° ğŸ•ºğŸ¼ ğŸˆ³ ğŸ‘©ğŸ»â€ğŸ¤â€ğŸ‘¨ğŸ½</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Internetä¸Šæä¾›äº†å„ç§å®ç°ï¼Œä½†æ˜¯æˆ‘è®¤ä¸ºå®ƒä»¬éƒ½å¾ˆç®€å•ã€‚ æˆ‘æƒ³ä¸ºæ˜Ÿå·ä»‹ç»æˆ‘çš„è¯­éŸ³æŒ‡å—ç‰ˆæœ¬ã€‚ 


 æ³¨æ„ï¼šæˆ‘ä¸æ˜¯ä¸“ä¸šçš„ç¨‹åºå‘˜ï¼Œä¹Ÿè®¸æŸäº›è§£å†³æ–¹æ¡ˆå¯¹æ‚¨æ¥è¯´ä¼¼ä¹å¾ˆç–¯ç‹‚ã€‚ ä¸€äº›æŠ€å·§å¯èƒ½å·²è¿‡æ—¶ã€‚ æˆ‘å‡†å¤‡æ¥å—æ‰¹è¯„å¹¶æ”¹è¿›ç³»ç»Ÿã€‚ 


 åŠŸèƒ½ç®€ä»‹ï¼š 


 ç”¨æˆ·è¾“å…¥IVRï¼Œæå‡ºè¯·æ±‚ï¼Œå¹¶ä¸”åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåˆ°è¾¾æ‰€éœ€çš„...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>åŸºäºYandexSpeechKitçš„è¯­éŸ³å‘å¯¼çš„å®ç°</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/417273/"><p>  Internetä¸Šæä¾›äº†å„ç§å®ç°ï¼Œä½†æ˜¯æˆ‘è®¤ä¸ºå®ƒä»¬éƒ½å¾ˆç®€å•ã€‚ æˆ‘æƒ³ä¸ºæ˜Ÿå·ä»‹ç»æˆ‘çš„è¯­éŸ³æŒ‡å—ç‰ˆæœ¬ã€‚ </p><br><p>  <em>æ³¨æ„ï¼š</em>æˆ‘ä¸æ˜¯ä¸“ä¸šçš„ç¨‹åºå‘˜ï¼Œä¹Ÿè®¸æŸäº›è§£å†³æ–¹æ¡ˆå¯¹æ‚¨æ¥è¯´ä¼¼ä¹å¾ˆç–¯ç‹‚ã€‚ ä¸€äº›æŠ€å·§å¯èƒ½å·²è¿‡æ—¶ã€‚ æˆ‘å‡†å¤‡æ¥å—æ‰¹è¯„å¹¶æ”¹è¿›ç³»ç»Ÿã€‚ </p><br><p>  <strong>åŠŸèƒ½ç®€ä»‹ï¼š</strong> </p><br><p> ç”¨æˆ·è¾“å…¥IVRï¼Œæå‡ºè¯·æ±‚ï¼Œå¹¶ä¸”åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåˆ°è¾¾æ‰€éœ€çš„ä½ç½®ã€‚ ç»Ÿè®¡ä¿¡æ¯ä¹Ÿé€šè¿‡mysqlè¡¨ä¸­çš„æ¡ç›®å›ºå®šåœ¨ç³»ç»Ÿä¸Šã€‚ <br> ç®€è¦ä»‹ç»å…¬å¸å’Œéƒ¨ç½²æ­¤ç³»ç»Ÿçš„ç½‘ç»œï¼š <br> çº¦1000ä¸ªç”µè¯ï¼Œçº¦50ä¸ªéƒ¨é—¨ </p><a name="habracut"></a><br><p>  <strong>ç³»ç»Ÿä½¿ç”¨çš„è½¯ä»¶äº§å“ï¼š</strong> </p><br><ul><li> æ˜Ÿå·13.10 </li><li>  YandexSpeechKit </li><li>  python 2.6.6 </li><li>  MySQLï¼ŒMSSQL </li><li> è¢œ14.2.0 </li><li> å·æ›²7.19.7 </li><li>  meè„š3.99.5 </li></ul><br><p>  <strong>æ˜Ÿå·ä¸­æ‹¨å·è®¡åˆ’çš„æè¿°ã€‚</strong> </p><br><pre><code class="hljs php">[officevoicerec] exten =&gt; s,<span class="hljs-number"><span class="hljs-number">1</span></span>,Answer() same =&gt; n,Macro(hangercheck,${CALLERID(num)}) same =&gt; n,Set(ITERATIONS=<span class="hljs-number"><span class="hljs-number">1</span></span>) same =&gt; n,Set(HANGFLAG=<span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>) same =&gt; n,Background(/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/asterisk/sounds/ru/speechrec/zdravstvuite)</code> </pre> <br><p> åœ¨æ­¤ç‰‡æ®µä¸­ï¼Œå¯åŠ¨å®ä»¥æ£€æŸ¥å‘¼å«è€…åœ¨å¬åˆ°é—®å€™æ¶ˆæ¯åæ˜¯å¦å·²æŒ‚æ–­ã€‚ æ¥ä¸‹æ¥æ˜¯è®¾ç½®å˜é‡çš„å€¼ï¼š <br>  ITERATIONS-å¿…é¡»é‡å¤è¯†åˆ«è¿‡ç¨‹ä¸€å®šæ¬¡æ•°ã€‚  HANGFLAG-Hangercheckå®ä½¿ç”¨æ­¤å˜é‡ã€‚ </p><br><pre> <code class="hljs ruby">same =&gt; n(rec),Set(RECFILE=<span class="hljs-regexp"><span class="hljs-regexp">/tmp/</span></span>${UNIQUEID}.wav) same =&gt; n,Playback(<span class="hljs-regexp"><span class="hljs-regexp">/var/lib</span></span><span class="hljs-regexp"><span class="hljs-regexp">/asterisk/sounds</span></span><span class="hljs-regexp"><span class="hljs-regexp">/en/beep</span></span>) same =&gt; n,Record(${RECFILE},<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>) same =&gt; n,AGI(pyreq8.py,${RECFILE}) same =&gt; n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"${NUMTOCALL}"</span></span> = <span class="hljs-string"><span class="hljs-string">"repeat"</span></span>]?repeat) same =&gt; n,Set(HANGFLAG=FALSE)</code> </pre> <br><p> è®¾ç½®è®°å½•æ–‡ä»¶å˜é‡ï¼Œå†™å…¥æ–‡ä»¶ã€‚ æˆ‘ä»¬è¿è¡Œagiè„šæœ¬ï¼Œè´Ÿè´£å‘é€æ–‡ä»¶ä»¥è¿›è¡Œè¯†åˆ«å’Œæ•°å­—æœç´¢ï¼ˆè„šæœ¬çš„æè¿°å°†åœ¨åé¢ç»™å‡ºï¼‰ï¼Œæ£€æŸ¥NUMTOCALLå˜é‡ï¼ˆè¯¥å€¼ç”±è„šæœ¬è®¾ç½®ï¼‰ï¼Œè®¾ç½®ç¬¦å·HANGFLAGï¼Œè¿™æ„å‘³ç€è¯¥äººæ²¡æœ‰æå‰æŒ‚æ–­ç”µè¯ã€‚ </p><br><pre> <code class="hljs powershell">same =&gt; n,Macro(VRstat,<span class="hljs-variable"><span class="hljs-variable">$</span></span>{CALLERID(num)},<span class="hljs-variable"><span class="hljs-variable">$</span></span>{NUMTOCALL},<span class="hljs-variable"><span class="hljs-variable">$</span></span>{RSTATUS},<span class="hljs-variable"><span class="hljs-variable">$</span></span>{CHANNEL},<span class="hljs-variable"><span class="hljs-variable">$</span></span>{RECREZ}) same =&gt; n,GotoIf(<span class="hljs-variable"><span class="hljs-variable">$</span></span>[[<span class="hljs-variable"><span class="hljs-variable">$</span></span>{<span class="hljs-type"><span class="hljs-type">EXISTS</span></span>(<span class="hljs-variable"><span class="hljs-variable">$</span></span>{<span class="hljs-type"><span class="hljs-type">FNAME</span></span>})}]]?foundName:havenodescr) same =&gt; n(foundName),Set(FILE_FNAME=<span class="hljs-variable"><span class="hljs-variable">$</span></span>{STRREPLACE(FNAME, ,)}) same =&gt; n,GotoIf(<span class="hljs-variable"><span class="hljs-variable">$</span></span>[<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$</span></span></span><span class="hljs-string">{STAT(f,/var/lib/asterisk/sounds/ru/cache/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$</span></span></span><span class="hljs-string">{FILE_FNAME}.mp3)}"</span></span>=<span class="hljs-string"><span class="hljs-string">"1"</span></span>]?havecache:nocache)</code> </pre> <br><p> åœ¨æ­¤ç‰‡æ®µä¸­ï¼Œè¿è¡Œå®ä»¥æ£€æŸ¥å‘¼å«è€…åœ¨å¬åˆ°é—®å€™æ¶ˆæ¯åæ˜¯å¦æŒ‚æ–­ï¼Œç„¶åè®¾ç½®å˜é‡ã€‚ITERATIONSå¿…é¡»é‡å¤æŒ‡å®šçš„æ¬¡æ•°æ‰èƒ½è¯†åˆ«ã€‚  HANGFLAG-Hangercheckå®ä½¿ç”¨æ­¤å˜é‡ã€‚ </p><br><pre> <code class="hljs ruby">same =&gt; n(rec),Set(RECFILE=<span class="hljs-regexp"><span class="hljs-regexp">/tmp/</span></span>${UNIQUEID}.wav) same =&gt; n,Playback(<span class="hljs-regexp"><span class="hljs-regexp">/var/lib</span></span><span class="hljs-regexp"><span class="hljs-regexp">/asterisk/sounds</span></span><span class="hljs-regexp"><span class="hljs-regexp">/en/beep</span></span>) same =&gt; n,Record(${RECFILE},<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>) same =&gt; n,AGI(pyreq8.py,${RECFILE}) same =&gt; n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"${NUMTOCALL}"</span></span> = <span class="hljs-string"><span class="hljs-string">"repeat"</span></span>]?repeat) same =&gt; n,Set(HANGFLAG=FALSE)</code> </pre> <br><p> è®¾ç½®è®°å½•æ–‡ä»¶å˜é‡ï¼Œå†™å…¥æ–‡ä»¶ã€‚ æˆ‘ä»¬è¿è¡Œè´Ÿè´£å‘é€æ–‡ä»¶ä»¥è¿›è¡Œè¯†åˆ«å’Œæ•°å­—æœç´¢çš„è„šæœ¬ï¼ˆè„šæœ¬çš„è¯´æ˜å°†åœ¨ä¸‹é¢ï¼‰ï¼Œæ£€æŸ¥NUMTOCALLå˜é‡ï¼ˆè¯¥å€¼ç”±è„šæœ¬è®¾ç½®ï¼‰ï¼Œè®¾ç½®HANGFLAGæ ‡å¿—ä»¥ä½¿è¯¥äººæœªæå‰æŒ‚æ–­ã€‚ </p><br><pre> <code class="hljs powershell">same =&gt; n,Macro(VRstat,<span class="hljs-variable"><span class="hljs-variable">$</span></span>{CALLERID(num)},<span class="hljs-variable"><span class="hljs-variable">$</span></span>{NUMTOCALL},<span class="hljs-variable"><span class="hljs-variable">$</span></span>{RSTATUS},<span class="hljs-variable"><span class="hljs-variable">$</span></span>{CHANNEL},<span class="hljs-variable"><span class="hljs-variable">$</span></span>{RECREZ}) same =&gt; n,GotoIf(<span class="hljs-variable"><span class="hljs-variable">$</span></span>[[<span class="hljs-variable"><span class="hljs-variable">$</span></span>{<span class="hljs-type"><span class="hljs-type">EXISTS</span></span>(<span class="hljs-variable"><span class="hljs-variable">$</span></span>{<span class="hljs-type"><span class="hljs-type">FNAME</span></span>})}]]?foundName:havenodescr) same =&gt; n(foundName),Set(FILE_FNAME=<span class="hljs-variable"><span class="hljs-variable">$</span></span>{STRREPLACE(FNAME, ,)}) same =&gt; n,GotoIf(<span class="hljs-variable"><span class="hljs-variable">$</span></span>[<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$</span></span></span><span class="hljs-string">{STAT(f,/var/lib/asterisk/sounds/ru/cache/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$</span></span></span><span class="hljs-string">{FILE_FNAME}.mp3)}"</span></span>=<span class="hljs-string"><span class="hljs-string">"1"</span></span>]?havecache:nocache) same =&gt; n(nocache),System(curl <span class="hljs-string"><span class="hljs-string">"https://tts.voicetech.yandex.net/generate?format=mp3&amp;lang=ru-RU&amp;speaker=zahar&amp;emotion=neutral&amp;speed=0.8&amp;key="</span></span> <span class="hljs-literal"><span class="hljs-literal">-G</span></span> -<span class="hljs-literal"><span class="hljs-literal">-data</span></span><span class="hljs-literal"><span class="hljs-literal">-urlencode</span></span> <span class="hljs-string"><span class="hljs-string">"text= </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$</span></span></span><span class="hljs-string">{FNAME}."</span></span> &gt; /tmp/speech-<span class="hljs-variable"><span class="hljs-variable">$</span></span>{UNIQUEID}.mp3) same =&gt; n,System(/usr/local/bin/lame <span class="hljs-literal"><span class="hljs-literal">-S</span></span> -<span class="hljs-literal"><span class="hljs-literal">-scale</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> /tmp/speech-<span class="hljs-variable"><span class="hljs-variable">$</span></span>{UNIQUEID}.mp3 /var/lib/asterisk/sounds/ru/cache/<span class="hljs-variable"><span class="hljs-variable">$</span></span>{FILE_FNAME}.mp3) same =&gt; n(havecache),Playback(/var/lib/asterisk/sounds/ru/cache/<span class="hljs-variable"><span class="hljs-variable">$</span></span>{FILE_FNAME}) same =&gt; n,Dial(Local/<span class="hljs-variable"><span class="hljs-variable">$</span></span>{NUMTOCALL}@common<span class="hljs-literal"><span class="hljs-literal">-context</span></span>)</code> </pre> <br><p> è¿è¡Œvrstatå®ï¼ˆè´Ÿè´£ç»Ÿè®¡ï¼Œç”±äºå…¶çç¢è€Œå°†ä¸å†æè¿°ï¼‰ã€‚ æ£€æŸ¥è¯·æ±‚çš„FNAMEæè¿°ï¼ˆå˜é‡ç”±pyreq8.pyè®¾ç½®ï¼‰ã€‚ å¦‚æœæœ‰æè¿°ï¼Œè¯·åœ¨å˜é‡ä¸­è®¾ç½®é«˜é€Ÿç¼“å­˜æ–‡ä»¶åå¹¶æ£€æŸ¥å…¶æ˜¯å¦å­˜åœ¨ã€‚ å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œæˆ‘ä»¬å°†å…¶åˆæˆï¼Œå°†å…¶è½¬æ¢ä¸ºmp3ï¼Œå¢å¤§éŸ³é‡ï¼Œç„¶åï¼ˆæˆ–è€…å¦‚æœå­˜åœ¨ç¼“å­˜ï¼‰æ’­æ”¾å¹¶è°ƒç”¨è®¢æˆ·ã€‚ </p><br><pre> <code class="hljs powershell">same =&gt; n(repeat),GotoIf(<span class="hljs-variable"><span class="hljs-variable">$</span></span>[<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$</span></span></span><span class="hljs-string">{ITERATIONS}"</span></span>=<span class="hljs-string"><span class="hljs-string">"1"</span></span>]?secretary) same =&gt; n,Background(/var/lib/asterisk/sounds/ru/speechrec/<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-literal"><span class="hljs-literal">-wav</span></span>) same =&gt; n,Set(ITERATIONS=<span class="hljs-variable"><span class="hljs-variable">$</span></span>[<span class="hljs-variable"><span class="hljs-variable">$</span></span>{<span class="hljs-type"><span class="hljs-type">ITERATIONS</span></span>}+<span class="hljs-number"><span class="hljs-number">1</span></span>]) same =&gt; n,Goto(rec)</code> </pre> <br><p> é‡å¤è¯†åˆ«ã€‚ å¦‚æœè¿­ä»£æ¬¡æ•°è¶…è¿‡æŒ‡å®šçš„æ¬¡æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†è½¬æ¢ä¸ºç§˜ä¹¦ã€‚ </p><br><pre> <code class="hljs cmake"> same =&gt; n(secretary),<span class="hljs-keyword"><span class="hljs-keyword">Macro</span></span>(VRstat,<span class="hljs-variable"><span class="hljs-variable">${CALLERID(num)}</span></span>,<span class="hljs-variable"><span class="hljs-variable">${NUMTOCALL}</span></span>,<span class="hljs-variable"><span class="hljs-variable">${RSTATUS}</span></span>,<span class="hljs-variable"><span class="hljs-variable">${CHANNEL}</span></span>,<span class="hljs-variable"><span class="hljs-variable">${RECREZ}</span></span>) same =&gt; n,<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>(HANGFLAG=<span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>) same =&gt; n,Dial(Local/<span class="hljs-number"><span class="hljs-number">1000</span></span>@common-context)</code> </pre> <br><p> è½¬äº¤ç»™ç§˜ä¹¦ã€‚ æˆ‘ä»¬è¾“å…¥ç»Ÿè®¡ä¿¡æ¯ï¼Œè®¾ç½®ä»–ä»¬æ²¡æœ‰æŒ‚æ–­çš„æ ‡å¿—ã€‚ æˆ‘ä»¬æ‰“ç”µè¯ç»™ç§˜ä¹¦ã€‚ </p><br><pre> <code class="hljs ruby">same =&gt; n(havenodescr),Playback(<span class="hljs-regexp"><span class="hljs-regexp">/var/lib</span></span><span class="hljs-regexp"><span class="hljs-regexp">/asterisk/sounds</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ru/speechrec</span></span><span class="hljs-regexp"><span class="hljs-regexp">/wait2);thanks-wait) same =&gt; n,Noop('no description') same =&gt; n,Dial(Local/</span></span>${NUMTOCALL}@common-context) same =&gt; n,Hangup()</code> </pre> <br><p> å‘¼å«åœ¨ç›®å½•ä¸­æ²¡æœ‰æè¿°çš„è®¢æˆ·ã€‚ æˆ‘ä»¬ä¸¢å¤±äº†æ¶ˆæ¯ï¼Œå°†å…¶è¾“å…¥ç»Ÿè®¡æ•°æ®ä¸­ï¼Œç„¶åè°ƒç”¨å®ƒã€‚ </p><br><pre> <code class="hljs bash">exten =&gt; h,1,Gotoif($[<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${HANGFLAG}</span></span></span><span class="hljs-string">"</span></span>=<span class="hljs-string"><span class="hljs-string">"TRUE"</span></span>]?<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span>:noop) same =&gt; n(<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span>),Macro(VRstat,<span class="hljs-variable"><span class="hljs-variable">${CALLERID(num)}</span></span>,x,HANGER,<span class="hljs-variable"><span class="hljs-variable">${CHANNEL}</span></span>) same =&gt; n(noop),Noop(<span class="hljs-string"><span class="hljs-string">'exiting'</span></span>)</code> </pre> <br><p> å¤„ç†å‘¼å«ç»ˆæ­¢ä»¥ä½¿hangercheckå®æ­£å¸¸å·¥ä½œã€‚ </p><br><p>  <strong>æ‹¨å·è®¡åˆ’è¯´æ˜ã€‚</strong>  <strong>å®ã€‚</strong> </p><br><pre> <code class="hljs powershell">[<span class="hljs-type"><span class="hljs-type">macro</span></span>-<span class="hljs-type"><span class="hljs-type">hangercheck</span></span>] ;<span class="hljs-variable"><span class="hljs-variable">$</span></span>{ARG1} <span class="hljs-literal"><span class="hljs-literal">-clid</span></span> exten =&gt; s,<span class="hljs-number"><span class="hljs-number">1</span></span>,GotoIf(<span class="hljs-variable"><span class="hljs-variable">$</span></span>[<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$</span></span></span><span class="hljs-string">{ARG1}"</span></span>=<span class="hljs-string"><span class="hljs-string">"anonymous"</span></span>]?<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) exten =&gt; s,n,MYSQL(Connect connid SRV user password db utf8) exten =&gt; s,n,MYSQL(SET NAMES utf8) exten =&gt; s,n,MYSQL(Query resultid <span class="hljs-variable"><span class="hljs-variable">$</span></span>{connid} SELECT IFNULL((SELECT clid from ivr_stat where rstatus=<span class="hljs-string"><span class="hljs-string">"HANGER"</span></span> and calldate &gt;=ADDDATE(NOW(),INTERVAL <span class="hljs-literal"><span class="hljs-literal">-48</span></span> HOUR) and clid=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$</span></span></span><span class="hljs-string">{ARG1}"</span></span> order by calldate desc limit <span class="hljs-number"><span class="hljs-number">1</span></span>),<span class="hljs-string"><span class="hljs-string">"NF"</span></span>)) exten =&gt; s,n,MYSQL(Fetch fetchid <span class="hljs-variable"><span class="hljs-variable">$</span></span>{resultid} VAR) exten =&gt; s,n,MYSQL(Clear <span class="hljs-variable"><span class="hljs-variable">$</span></span>{resultid}) exten =&gt; s,n,MYSQL(Disconnect <span class="hljs-variable"><span class="hljs-variable">$</span></span>{connid}) exten =&gt; s,n,GotoIf(<span class="hljs-variable"><span class="hljs-variable">$</span></span>[<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$</span></span></span><span class="hljs-string">{VAR}"</span></span>=<span class="hljs-string"><span class="hljs-string">"NF"</span></span>]?<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) exten =&gt; s,n,Macro(VRstat,<span class="hljs-variable"><span class="hljs-variable">$</span></span>{ARG1},x,H_RECALL,<span class="hljs-variable"><span class="hljs-variable">$</span></span>{CHANNEL}) exten =&gt; s,n,Dial(Local/<span class="hljs-number"><span class="hljs-number">1000</span></span>@common<span class="hljs-literal"><span class="hljs-literal">-context</span></span>) exten =&gt; s,n,Hangup() exten =&gt; s,n(<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>),Noop(Hanger check failed)</code> </pre> <br><p> æˆ‘ä»¬åœ¨ç»Ÿè®¡æ•°æ®åº“ä¸­æ£€æŸ¥ç»™å®šçš„å·ç æ˜¯å¦å‘¼å«äº†æœ€è¿‘48å°æ—¶ï¼Œå¦‚æœä»–æŒ‚äº†ç”µè¯è€Œæ²¡æœ‰ç­‰å¾…è¯†åˆ«ç»“æŸï¼Œåˆ™å°†å…¶è¾“å…¥ç»Ÿè®¡å¹¶è¿æ¥åˆ°ç§˜ä¹¦ã€‚ </p><br><p>  <strong>ä½¿ç”¨è¿‡çš„sqlå’Œmysqlè¡¨çš„ç®€çŸ­æè¿°ã€‚</strong> </p><br><p>  SQLè¡¨dbo.phrasesã€‚ </p><br><p> <code>id(PK, int), phrase (text), number(varchar(50))</code> </p> <br><p> å¯¹è¯¥è¡¨è¿›è¡Œäº†å…¨æ–‡æœç´¢ï¼›å½“æ¥æ”¶åˆ°é•¿çŸ­è¯­æ—¶ï¼Œå®ƒç”¨äºæŒ‰å…³é”®å­—åˆ‡æ¢ã€‚ ä¾‹å¦‚ï¼ŒçŸ­è¯­â€œè¯·ä¸æˆ‘è”ç³»å¹¿å‘Šéƒ¨é—¨çš„ä»£è¡¨â€ï¼Œå¦‚æœæ•°æ®åº“ä¸­æœ‰ä¸€ä¸ªçŸ­è¯­ä¸ºâ€œå¹¿å‘Šéƒ¨é—¨â€çš„æ¡ç›®ï¼Œåˆ™å‘¼å«è€…å°†è¿æ¥åˆ°ç›¸åº”çš„å·ç ã€‚ </p><br><p>  Mysqlè¡¨recogStatsã€‚ </p><br><p> <code>id(PK, int), date (datetime), ctime(float), rtime(float),stime(float), phrase(varchar(60))</code> </p> <br><p> è¯¥è¡¨ç”¨äºå­˜å‚¨è¯†åˆ«ç»“æœå¹¶æ”¶é›†æœ‰å…³è¯†åˆ«æ—¶é—´çš„ç»Ÿè®¡ä¿¡æ¯ã€‚  ctime-è½¬æ¢éŸ³é¢‘æ–‡ä»¶æ‰€èŠ±è´¹çš„æ—¶é—´ï¼Œrtime-ä¸‹è½½å’Œè¯†åˆ«æ‰€èŠ±è´¹çš„æ—¶é—´ï¼Œstime-æœç´¢æ‰€èŠ±è´¹çš„æ—¶é—´ </p><br><p>  mysqlè¡¨ivr_statã€‚ </p><br><p> <code>id(PK, int), calldate (datetime),clid(varchar(15)),duration(int(20)),callednum(varchar(10)),rstatus(varchar(20)),channame(varchar30)),RECREZ(varchar(200))</code> </p> <br><p> è¯¥è¡¨ç”¨äºè·Ÿè¸ªè¯†åˆ«ç»“æœï¼ˆRECREZï¼Œrstatusï¼‰ï¼Œè°ƒç”¨è€…æ ¹æ®è¯†åˆ«ç»“æœçš„çŸ­è¯­ï¼ˆè¢«ç§°ä¸ºnumï¼‰çš„æœç´¢ç»“æœæ‰¾åˆ°è°ï¼Œä»¥ä¿æŒç»Ÿè®¡ä¿¡æ¯ï¼Œäº†è§£ä¸€ä¸ªäººåœ¨è¯†åˆ«èœå•ä¸ŠèŠ±è´¹çš„æ—¶é—´ï¼ˆæŒç»­æ—¶é—´ï¼‰å’Œè°ƒè¯•æ—¶é—´ï¼ˆchannameï¼‰ </p><br><p>  Mysql CustomRequestsè¡¨ã€‚ </p><br><p> <code>id(PK, int), nomer(int(10)), request(varchar(100))</code> <br> å…¶ä»–ç»„å’Œéƒ¨é—¨çš„è¾…åŠ©ç›®å½•ã€‚ </p><br><p>  Mysql numdescriptionsè¡¨ã€‚ </p><br><p> <code>Num(text), name(text)</code> </p> <br><p> å…·æœ‰è¾“å…¥çš„è¯­éŸ³ä»£ç†å·ç è¯´æ˜çš„ç›®å½•ã€‚ </p><br><p>  Mysqlè¡¨spravochnik_ruså’Œspravochnik_rus_name_num_no_tops </p><br><p> <code>nomer(varchar(11)), fio(varchar(100))</code> </p> <br><p> å¸¦æ•°å­—çš„å‚è€ƒäººã€‚ ç¬¬ä¸€ä¸ªæ˜¯å®Œæ•´çš„ï¼Œä¾›å†…éƒ¨ä½¿ç”¨ã€‚ ç¬¬äºŒç§æ˜¯ä¾›å¤–éƒ¨ä½¿ç”¨ï¼Œå…¶è‘£äº‹å’Œç»ç†çš„äººæ•°è¢«åŒ…è£…åœ¨ä¸€ä¸ªç§˜ä¹¦å¤„ä¸­ã€‚ </p><br><p>  <strong>AGIè„šæœ¬ï¼Œç”¨äºè½¬æ¢ï¼Œå‘é€å’Œæœç´¢å·²è¯†åˆ«çš„çŸ­è¯­ã€‚</strong> </p><br><p> äºŒæ‰‹å›¾ä¹¦é¦†ï¼š </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> difflib <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> exit <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uuid <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> subprocess <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> xml.etree.ElementTree <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> MySQLdb <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pymssql <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> re <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> itertools <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> permutations <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> remove <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> timeit</code> </pre> <br><p> è¿˜æœ‰<strong>asterisk.agi</strong>åº“ï¼Œæˆ‘ä»¬æ ¹æ®è°ƒè¯•å¯¼å…¥ï¼ˆè°ƒè¯•åœ¨Windowsè®¡ç®—æœºä¸Šå®Œæˆï¼‰ã€‚ </p><br><p>  <strong>å˜é‡è¯´æ˜ã€‚</strong> </p><br><pre> <code class="python hljs">WINDEBUG = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span></code> </pre> <br><p> è°ƒè¯•æ ‡å¿— </p><br><pre> <code class="python hljs">_digits = re.compile(<span class="hljs-string"><span class="hljs-string">'\d'</span></span>)</code> </pre> <br><p> å°†æ­£åˆ™è¡¨è¾¾å¼å˜é‡ç¼–è¯‘ä¸ºæ•°å­—ã€‚ </p><br><pre> <code class="python hljs">uniqid = str(uuid.uuid1()).replace(<span class="hljs-string"><span class="hljs-string">'-'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>)</code> </pre> <br><p> å”¯ä¸€æ ‡è¯†ç¬¦å˜é‡ã€‚ </p><br><pre> <code class="python hljs">dkey = <span class="hljs-string"><span class="hljs-string">'12345678-9101-1121-3141-51617181920'</span></span></code> </pre> <br><p>  Yandexè¯­éŸ³å·¥å…·åŒ…APIå¯†é’¥ã€‚ </p><br><pre> <code class="python hljs">lang = <span class="hljs-string"><span class="hljs-string">'ru-RU'</span></span></code> </pre> <br><p>  Yandexè¯­éŸ³åŒ…çš„è¯­è¨€é€‰é¡¹ã€‚ </p><br><pre> <code class="python hljs">topic = <span class="hljs-string"><span class="hljs-string">'queries'</span></span></code> </pre> <br><p>  Yandexè¯­éŸ³åŒ…çš„è¯†åˆ«ä¸»é¢˜é€‰é¡¹ã€‚ </p><br><pre> <code class="python hljs">callnumber = <span class="hljs-string"><span class="hljs-string">'222'</span></span></code> </pre> <br><p> é»˜è®¤ç”µè¯å·ç ã€‚ </p><br><pre> <code class="python hljs">setVar(<span class="hljs-string"><span class="hljs-string">'NUMTOCALL'</span></span>, callnumber)</code> </pre> <br><p> è®¾ç½®é»˜è®¤ç”µè¯å·ç ï¼Œä»¥é˜²å‡ºç°é—®é¢˜ã€‚ </p><br><pre> <code class="python hljs">persondic = dict()</code> </pre> <br><p> è¯å…¸åç§°-æ•°å­—ã€‚ </p><br><pre> <code class="python hljs">persondicFI=dict()</code> </pre> <br><p>  FIå­—å…¸-æ•°å­—ã€‚ </p><br><pre> <code class="python hljs">persondicF=dict()</code> </pre> <br><p> å­—å…¸çš„å§“æ°-æ•°å­—ã€‚ </p><br><pre> <code class="python hljs">otherdic = dict()</code> </pre> <br><p> å…·æœ‰â€œè®°å½•-ç¼–å·â€å½¢å¼çš„å…¶ä»–æ¡ç›®çš„å­—å…¸ã€‚ </p><br><pre> <code class="python hljs">descriptions = dict()</code> </pre> <br><p> å¸¦æœ‰ç”¨äºç”Ÿæˆå£°éŸ³ä»£ç†çš„æè¿°çš„å­—å…¸ï¼Œé”®å…¥Record-numberã€‚ </p><br><pre> <code class="python hljs">duplicates = list()</code> </pre> <br><p> è¿‡æ»¤éœ€è¦çš„æœåŠ¡åˆ—è¡¨ã€‚ </p><br><pre> <code class="python hljs">nums = list()</code> </pre> <br><p> åˆ—å‡ºæ‰€æœ‰æ‰©å±•åã€‚ </p><br><pre> <code class="python hljs">outfile = <span class="hljs-string"><span class="hljs-string">'/tmp/'</span></span> + uniqid + <span class="hljs-string"><span class="hljs-string">'-pcm.wav'</span></span></code> </pre> <br><p> å¯å˜çš„ä¸´æ—¶è¾“å‡ºéŸ³é¢‘æ–‡ä»¶ã€‚ </p><br><pre> <code class="python hljs">mysqlhost=<span class="hljs-string"><span class="hljs-string">'myhost'</span></span> mysqlpass=<span class="hljs-string"><span class="hljs-string">'mypass'</span></span> mysqluser=<span class="hljs-string"><span class="hljs-string">'myuser'</span></span> mysqldb=<span class="hljs-string"><span class="hljs-string">'mydb'</span></span> mssqlhost=<span class="hljs-string"><span class="hljs-string">'mshost'</span></span> mssqlpass=<span class="hljs-string"><span class="hljs-string">'mspass'</span></span> mssqluser=<span class="hljs-string"><span class="hljs-string">'msuser'</span></span> mssqldb=<span class="hljs-string"><span class="hljs-string">'msdb'</span></span></code> </pre> <br><p> è¿æ¥åˆ°mysqlå’Œmssqlçš„è¯¦ç»†ä¿¡æ¯ã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> WINDEBUG: <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> asterisk.agi <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * agi = AGI() infile = agi.env[<span class="hljs-string"><span class="hljs-string">'agi_arg_1'</span></span>] caller = agi.get_variable(<span class="hljs-string"><span class="hljs-string">'CALLERID(num)'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: caller = <span class="hljs-string"><span class="hljs-string">'1064'</span></span> infile = <span class="hljs-string"><span class="hljs-string">''</span></span></code> </pre><br><p> å¯¼å…¥åº“ï¼Œæ ¹æ®è°ƒè¯•ä¸ºè¾“å…¥éŸ³é¢‘æ–‡ä»¶çš„åç§°å’Œè°ƒç”¨è€…çš„å·ç è®¾ç½®ä¸€ä¸ªå˜é‡ã€‚ </p><br><p>  <strong>åŠŸèƒ½è¯´æ˜</strong> </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">verb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> WINDEBUG: agi.verbose(s) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> s</code> </pre> <br><p> æ ¹æ®è°ƒè¯•å˜é‡çš„å€¼ï¼Œæˆ‘ä»¬åœ¨æ˜Ÿå·æ§åˆ¶å°æˆ–stdoutä¸­æ˜¾ç¤ºæ¶ˆæ¯ã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setVar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(varname, varval)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> WINDEBUG: agi.set_variable(varname, varval) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"setting var "</span></span> + varname + <span class="hljs-string"><span class="hljs-string">" with value "</span></span> + varval</code> </pre> <br><p> æ ¹æ®è°ƒè¯•å˜é‡çš„å€¼ï¼Œæˆ‘ä»¬å°†Dialplanå˜é‡çš„å€¼åˆ†é…ç»™æ˜Ÿå·æˆ–å°†è¾“å‡ºåˆ†é…ç»™stdoutã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">contains_digits</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s)</span></span></span><span class="hljs-function">:</span></span> verb(<span class="hljs-string"><span class="hljs-string">'enter contains_digits'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bool(_digits.search(s))</code> </pre> <br><p> æ£€æŸ¥sæ˜¯å¦åŒ…å«æ•°å­—ã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return_digits</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s)</span></span></span><span class="hljs-function">:</span></span> verb(<span class="hljs-string"><span class="hljs-string">'return digits'</span></span>) pstr = s.encode(<span class="hljs-string"><span class="hljs-string">"utf-8"</span></span>) all = string.maketrans(<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) nodigs = all.translate(all, string.digits) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> unicode(pstr.translate(all, nodigs), <span class="hljs-string"><span class="hljs-string">"utf-8"</span></span>)</code> </pre> <br><p> æˆ‘ä»¬ä»…è¿”å›sä¸­çš„æ•°å­—ã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check_dob</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(num)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> int(num) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> nums: verb(<span class="hljs-string"><span class="hljs-string">'checkdob success'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: verb(<span class="hljs-string"><span class="hljs-string">'checkdob fail'</span></span> + num) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span></code> </pre> <br><p> æ£€æŸ¥numsåˆ—è¡¨ä¸­æ˜¯å¦å­˜åœ¨æ‰©å±•åã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_dob</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(strnum)</span></span></span><span class="hljs-function">:</span></span> buf = return_digits(strnum) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> contains_digits(strnum): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> check_dob(buf): verb(<span class="hljs-string"><span class="hljs-string">'setting var '</span></span> + buf) setVar(<span class="hljs-string"><span class="hljs-string">'RSTATUS'</span></span>, <span class="hljs-string"><span class="hljs-string">'SAYDIAL'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buf <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"repeat"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"repeat"</span></span></code> </pre> <br><p> æ‰©å±•è®¾ç½®åŠŸèƒ½ã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(infile)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> int(os.stat(infile).st_size) &lt;= <span class="hljs-number"><span class="hljs-number">26364</span></span>: setVar(<span class="hljs-string"><span class="hljs-string">'NUMTOCALL'</span></span>, <span class="hljs-string"><span class="hljs-string">'repeat'</span></span>) setVar(<span class="hljs-string"><span class="hljs-string">'RSTATUS'</span></span>, <span class="hljs-string"><span class="hljs-string">'SILENCE'</span></span>) verb(<span class="hljs-string"><span class="hljs-string">'empty file received'</span></span>) remove(infile) exit(<span class="hljs-number"><span class="hljs-number">9</span></span>)</code> </pre> <br><p> æ£€æŸ¥æ¥æ”¶åˆ°çš„å½•éŸ³æ–‡ä»¶æ˜¯å¦å¯è¯†åˆ«ï¼Œå¦‚æœå°ºå¯¸å¤ªå°ï¼Œæˆ‘ä»¬å‡å®šå®ƒä»¬åœ¨å¬ç­’ä¸­æ²¡æœ‰å£°éŸ³ã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addSessionStat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctime, rtime, stime, phrase)</span></span></span><span class="hljs-function">:</span></span> cdate = time.strftime(<span class="hljs-string"><span class="hljs-string">"%Y-%m-%d %H:%M:%S"</span></span>) db = MySQLdb.connect(host=mysqlhost, user=mysqluser, passwd=mysqluser, db=mysqldb, charset=<span class="hljs-string"><span class="hljs-string">'utf8'</span></span>) cur = db.cursor() cur.execute( <span class="hljs-string"><span class="hljs-string">"INSERT INTO recogStats(date,ctime,rtime,stime,phrase) VALUES ('"</span></span> + cdate + <span class="hljs-string"><span class="hljs-string">"','"</span></span> + str(ctime) + <span class="hljs-string"><span class="hljs-string">"','"</span></span> + str( rtime) + <span class="hljs-string"><span class="hljs-string">"','"</span></span> + str(stime) + <span class="hljs-string"><span class="hljs-string">"','"</span></span> + phrase + <span class="hljs-string"><span class="hljs-string">"')"</span></span>) db.commit() db.close()</code> </pre> <br><p> å½•éŸ³ç»Ÿè®¡è¯†åˆ«åŠŸèƒ½ã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fillDics</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> db = MySQLdb.connect(host=mysqlhost, user=mysqluser, passwd=mysqlpass, db=<span class="hljs-string"><span class="hljs-string">"central_cdr"</span></span>, charset=<span class="hljs-string"><span class="hljs-string">'utf8'</span></span>) cur = db.cursor() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(caller) != <span class="hljs-number"><span class="hljs-number">4</span></span>: tbname = <span class="hljs-string"><span class="hljs-string">'spravochnik_rus_name_num_no_tops'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: tbname = <span class="hljs-string"><span class="hljs-string">'svravochnik_rus_persons'</span></span> cur.execute(<span class="hljs-string"><span class="hljs-string">"""SELECT nomer,fio from """</span></span> + tbname) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> row <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> cur.fetchall(): fullfio=row[<span class="hljs-number"><span class="hljs-number">1</span></span>].lower() f=<span class="hljs-string"><span class="hljs-string">" "</span></span>.join(fullfio.split(<span class="hljs-string"><span class="hljs-string">' '</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> f <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> persondicF.keys():<span class="hljs-comment"><span class="hljs-comment"># and f not in duplicates : persondicF[f] = int(row[0]) elif fullfio in persondic.keys(): pass else: duplicates.append(f) if not fullfio in persondic.keys(): persondic[fullfio] = int(row[0]) fi=" ".join(fullfio.split(' ')[0:2]) if not fi in persondicFI.keys(): persondicFI[fi] = int(row[0]) elif fullfio in persondic.keys(): pass else: persondicFI.pop(fi) uniquedups=[x for x in list(set(duplicates)) if x != ''] for item in uniquedups: for key in persondicF.keys(): if item in key: persondicF.pop(key) cur.execute("""SELECT nomer,request from CustomRequests """) for row in cur.fetchall(): otherdic[row[1].lower()] = row[0] cur.execute("""SELECT num,name from numdescriptions """) for row in cur.fetchall(): descriptions[str(row[0])] = row[1] cur.execute("""SELECT nomer from spravochnik_rus """) for row in cur.fetchall(): nums.append(int(row[0])) db.close()</span></span></code> </pre> <br><p> æ­¤åŠŸèƒ½å¡«å†™å­—å…¸çš„å§“æ°ï¼ˆpersondicFï¼‰ï¼Œå§“æ°ï¼ˆpersondicFIï¼‰ï¼Œåç§°ï¼ˆpersondicï¼‰ï¼Œéƒ¨é—¨åç§°ï¼ˆotherdicï¼‰ï¼Œè¯­éŸ³åˆæˆè¯´æ˜ï¼ˆdescriptionï¼‰å’Œæ‰€æœ‰å…¬å¸ç¼–å·ï¼ˆnumsï¼‰ã€‚ <br> æ ¹æ®å‘¼å«è€…ç”µè¯å·ç çš„é•¿åº¦ï¼Œä¼šç”Ÿæˆä¸€ä¸ªåŒ…å«ä¸»ç®¡ï¼ˆå†…éƒ¨å‘¼å«è€…ï¼‰æˆ–ä¸åŒ…å«ï¼ˆå¤–éƒ¨å‘¼å«è€…ï¼‰å·ç çš„è¡¨ã€‚ <br> æµ‹è¯•å§“æ°ç›®å½•çš„å”¯ä¸€æ€§ï¼Œä»¥æ’é™¤å…¶ä¸­å­˜åœ¨ä¸¤ä¸ªå…·æœ‰ä¸åŒç¼–å·çš„ä¼Šå‡¡è¯ºå¤«çš„æƒ…å†µã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convert</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(infile, outfile)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#convert file verb("Converting WAV " + infile) soxconvert = subprocess.Popen(['sox', infile, '-r', '16000', '-b', '16', '-c', '1', outfile], stdout=subprocess.PIPE) (out, err) = soxconvert.communicate() # remove(infile) if soxconvert.returncode != 0: setVar('NUMTOCALL', callnumber) # return "" exit(9)</span></span></code> </pre> <br><p> ä¸‡ä¸€soxæŠ¥é”™ï¼Œè½¬æ¢æ˜Ÿå·ä¸­è®°å½•çš„æ–‡ä»¶çš„åŠŸèƒ½ï¼Œè®¾ç½®é»˜è®¤ç¼–å·å¹¶é€€å‡ºè„šæœ¬ã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendRecog</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(file)</span></span></span><span class="hljs-function">:</span></span> verb(<span class="hljs-string"><span class="hljs-string">"Sending file to yandex: "</span></span> + outfile) proc = subprocess.Popen([<span class="hljs-string"><span class="hljs-string">'curl'</span></span>, <span class="hljs-string"><span class="hljs-string">'--max-time'</span></span>, <span class="hljs-string"><span class="hljs-string">'5'</span></span>, <span class="hljs-string"><span class="hljs-string">'--silent'</span></span>, <span class="hljs-string"><span class="hljs-string">'asr.yandex.net/asr_xml?key='</span></span> + dkey + <span class="hljs-string"><span class="hljs-string">'&amp;uuid='</span></span> + uniqid + <span class="hljs-string"><span class="hljs-string">'&amp;topic='</span></span> + topic + <span class="hljs-string"><span class="hljs-string">'&amp;lang=ru-RU'</span></span>, <span class="hljs-string"><span class="hljs-string">'-F'</span></span>, <span class="hljs-string"><span class="hljs-string">'Content-Type=audio/x-pcm;bit=16;rate=16000'</span></span>, <span class="hljs-string"><span class="hljs-string">'-F'</span></span>, <span class="hljs-string"><span class="hljs-string">'audio=@'</span></span> + outfile], stdout=subprocess.PIPE) (out, err) = proc.communicate() verb(<span class="hljs-string"><span class="hljs-string">"return code is: "</span></span> + str(proc.returncode)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> proc.returncode != <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> remove(file) e = xml.etree.ElementTree.fromstring(out) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> e.attrib[<span class="hljs-string"><span class="hljs-string">'success'</span></span>] == <span class="hljs-string"><span class="hljs-string">'1'</span></span>: verb(e._children[<span class="hljs-number"><span class="hljs-number">0</span></span>].text) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> e._children[<span class="hljs-number"><span class="hljs-number">0</span></span>].text <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span></code> </pre> <br><p> å‘é€ç”¨äºè¯†åˆ«çš„æ–‡ä»¶å¹¶ä»Yandexæ¥æ”¶å“åº”çš„åŠŸèƒ½ã€‚ å¦‚æœè¯†åˆ«æˆåŠŸï¼Œæˆ‘ä»¬å°†é‡‡å–ç¬¬ä¸€ä¸ªç­”æ¡ˆã€‚ æˆ‘æ— æ³•ä½¿ç”¨curlåº“æ‰§è¡Œæ­¤æ“ä½œï¼Œå› æ­¤ä½¿ç”¨äº†æ­¤é€‰é¡¹ã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">searchfiobyf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(f)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(f.split(<span class="hljs-string"><span class="hljs-string">" "</span></span>))==<span class="hljs-number"><span class="hljs-number">2</span></span>: limit=<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> len(f.split(<span class="hljs-string"><span class="hljs-string">" "</span></span>))&gt;=<span class="hljs-number"><span class="hljs-number">3</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> f <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: limit=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> fio,num <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> persondic.iteritems(): cutfio=<span class="hljs-string"><span class="hljs-string">" "</span></span>.join(fio.split(<span class="hljs-string"><span class="hljs-string">' '</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>:limit]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> f == cutfio: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fio</code> </pre> <br><p> æœç´¢å…¨åçš„åŠŸèƒ½ï¼Œå–å†³äºè¾“å…¥çš„æ˜¯å§“æ°è¿˜æ˜¯å§“æ°å’Œåå­—ã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">combinationSearcher</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(phrase,pdic,quality)</span></span></span><span class="hljs-function">:</span></span> verb(<span class="hljs-string"><span class="hljs-string">u'searching in persons'</span></span>) result = difflib.get_close_matches(phrase, pdic.keys(), <span class="hljs-number"><span class="hljs-number">1</span></span>, quality) <span class="hljs-comment"><span class="hljs-comment">#verb(" ".join(result)) if len(result) &gt; 0: fullfio=searchfiobyf(result[0]) verb(u'found ' + str(pdic[result[0]])) setVar('RSTATUS', 'NAMESUCCESS') setVar('FNAME', fullfio) return pdic[result[0]] else: return ""</span></span></code> </pre> <br><p> ç»„åˆæœç´¢åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼šçŸ­è¯­=â€œ Alexey Petrâ€ï¼ŒpdicåŒ…å«æ¡ç›®â€œ Alexeyev Peterâ€ï¼Œget_close_matcheså‡½æ•°å°†è¿”å›â€œ Alexeyev Peterâ€ã€‚ è¯¥å‡½æ•°å¯èƒ½ä¼šäº§ç”Ÿä¸æ­£ç¡®çš„ç»“æœï¼Œä½†æ˜¯ï¼Œå¦‚å®è·µæ‰€ç¤ºï¼Œå­˜åœ¨æ›´å¤šæ­£ç¡®çš„å“åº”ã€‚  qualityå‚æ•°ä½¿æ‚¨å¯ä»¥æŒ‡å®šæœç´¢ç›¸ä¼¼çŸ­è¯­çš„å‡†ç¡®æ€§ã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getNumByName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(recognizedString)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">u''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> recognizedString: verb(<span class="hljs-string"><span class="hljs-string">'enter dobavochn'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> set_dob(recognizedString) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> len(recognizedString.replace(<span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)) == <span class="hljs-number"><span class="hljs-number">4</span></span>: verb(<span class="hljs-string"><span class="hljs-string">'enter num say'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> set_dob(recognizedString) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(recognizedString) &lt;= <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> recognizedString.lower() <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-string"><span class="hljs-string">u""</span></span>,<span class="hljs-string"><span class="hljs-string">u""</span></span>,<span class="hljs-string"><span class="hljs-string">u""</span></span>]: setVar(<span class="hljs-string"><span class="hljs-string">'RSTATUS'</span></span>, <span class="hljs-string"><span class="hljs-string">'SHORT'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"repeat"</span></span> verb(<span class="hljs-string"><span class="hljs-string">u'start searching'</span></span>) <span class="hljs-comment"><span class="hljs-comment">#  split = list(set(recognizedString.split(" "))) parts = len(split) fixedstring=" ".join(split) if parts &gt;= 5: verb('Phrase is long. Using FTDB') buf = mssqlwrapper(fixedstring) if buf != '': buf = mssqlwrapper(fixedstring)[0] if str(buf) in descriptions.keys(): setVar('FNAME', descriptions[str(buf)]) setVar('RSTATUS', 'DEPTSUCCESS') return buf else: setVar('RSTATUS', 'REQUESTNOTFOUND') return "repeat" result="" if parts == 1: mssqlcheck=mssqlwrapper(fixedstring) if mssqlcheck!='': if mssqlcheck[2]&gt;=80: buf=str(mssqlcheck[0]) if buf in descriptions.keys(): setVar('FNAME', descriptions[str(buf)]) setVar('RSTATUS', 'DEPTSUCCESS') result=buf else: result=combinationSearcher(fixedstring,persondicF,0.7) elif parts ==2: combs = list(permutations(split, parts)) # (  ,   ,   .....) for item in combs: element = " ".join(item) result=combinationSearcher(element,persondicFI,0.7) if result!="": break elif parts ==3: combs = list(permutations(split, parts)) for item in combs: element = " ".join(item) result=combinationSearcher(element,persondic,0.8) if result!="": break if result!="": return result verb('Low ftdbsearch') buf = mssqlwrapper(recognizedString) if buf != '': buf = mssqlwrapper(recognizedString)[0] if str(buf) in descriptions.keys(): verb('it is') setVar('FNAME', descriptions[str(buf)]) setVar('RSTATUS', 'DEPTSUCCESS') return buf else: verb(u'item not found ' + recognizedString) #    setVar('RSTATUS', 'REQUESTNOTFOUND') return callnumber</span></span></code> </pre> <br><p>  <strong>é€šè¿‡çŸ­è¯­æŸ¥æ‰¾æ•°å­—çš„ä¸»è¦åŠŸèƒ½ã€‚</strong> </p><br><p> è®©æˆ‘ä»¬åˆ†éƒ¨åˆ†åˆ†ææ­¤åŠŸèƒ½ã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">u''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> recognizedString: verb(<span class="hljs-string"><span class="hljs-string">'enter dobavochn'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> set_dob(recognizedString)</code> </pre> <br><p> ç¤ºä¾‹ï¼šçŸ­è¯­â€œ Pleaseï¼Œextension 1234â€å°†è¿”å›åˆ†æœºå·ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> len(recognizedString.replace(<span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)) == <span class="hljs-number"><span class="hljs-number">4</span></span>: verb(<span class="hljs-string"><span class="hljs-string">'enter num say'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> set_dob(recognizedString)</code> </pre> <br><p> å¦‚æœç”¨æˆ·è¯´å‡ºäº†å››ä½æ•°çš„å·ç ï¼Œè¯·è¿”å›ç›¸åº”çš„åˆ†æœºå·ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(recognizedString) &lt;= <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> recognizedString.lower() <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-string"><span class="hljs-string">u""</span></span>,<span class="hljs-string"><span class="hljs-string">u""</span></span>,<span class="hljs-string"><span class="hljs-string">u""</span></span>]: setVar(<span class="hljs-string"><span class="hljs-string">'RSTATUS'</span></span>, <span class="hljs-string"><span class="hljs-string">'SHORT'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"repeat"</span></span></code> </pre> <br><p> ä¸ºäº†é¿å…ç”¨ç®€çŸ­çš„è¯­æ°”ä¸å¿…è¦åœ°è¿è¡Œç¨‹åºï¼ˆå½“Yandexå¬åˆ°å¹¶è¯†åˆ«å‡ºå¯¹è¯çš„ä¸€éƒ¨åˆ†ï¼Œè€Œè°ƒç”¨è€…æœªæ”¶å¬è¯†åˆ«æ¶ˆæ¯æ—¶ï¼Œå¯èƒ½ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µï¼‰ã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> parts &gt;= <span class="hljs-number"><span class="hljs-number">5</span></span>: verb(<span class="hljs-string"><span class="hljs-string">'Phrase is long. Using FTDB'</span></span>) buf = mssqlwrapper(fixedstring) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> buf != <span class="hljs-string"><span class="hljs-string">''</span></span>: buf = mssqlwrapper(fixedstring)[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> str(buf) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> descriptions.keys(): setVar(<span class="hljs-string"><span class="hljs-string">'FNAME'</span></span>, descriptions[str(buf)]) setVar(<span class="hljs-string"><span class="hljs-string">'RSTATUS'</span></span>, <span class="hljs-string"><span class="hljs-string">'DEPTSUCCESS'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buf <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: setVar(<span class="hljs-string"><span class="hljs-string">'RSTATUS'</span></span>, <span class="hljs-string"><span class="hljs-string">'REQUESTNOTFOUND'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"repeat"</span></span> result=<span class="hljs-string"><span class="hljs-string">""</span></span></code> </pre><br><p> å¯¹äºé•¿çŸ­è¯­ï¼ˆè¶…è¿‡äº”ä¸ªè¯ï¼‰ï¼Œæˆ‘ä»¬ç«‹å³è½¬å‘mssql FTæ•°æ®åº“ã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> parts == <span class="hljs-number"><span class="hljs-number">1</span></span>: mssqlcheck=mssqlwrapper(fixedstring) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> mssqlcheck!=<span class="hljs-string"><span class="hljs-string">''</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> mssqlcheck[<span class="hljs-number"><span class="hljs-number">2</span></span>]&gt;=<span class="hljs-number"><span class="hljs-number">80</span></span>: buf=str(mssqlcheck[<span class="hljs-number"><span class="hljs-number">0</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> buf <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> descriptions.keys(): setVar(<span class="hljs-string"><span class="hljs-string">'FNAME'</span></span>, descriptions[str(buf)]) setVar(<span class="hljs-string"><span class="hljs-string">'RSTATUS'</span></span>, <span class="hljs-string"><span class="hljs-string">'DEPTSUCCESS'</span></span>) result=buf <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: result=combinationSearcher(fixedstring,persondicF,<span class="hljs-number"><span class="hljs-number">0.7</span></span>)</code> </pre> <br><p> å¦‚æœè¯†åˆ«å‡ºçš„çŸ­è¯­ç”±ä¸€ä¸ªå•è¯ç»„æˆï¼Œåˆ™é¦–å…ˆæˆ‘ä»¬æŸ¥çœ‹FTæ•°æ®åº“ï¼Œå…¶å‡†ç¡®åº¦ä¸º80ï¼…ï¼ŒæŸ¥æ‰¾å¯¹è¯†åˆ«å‡ºçš„æ•°å­—çš„æè¿°ï¼Œä¸ºæ•°å­—è®¡åˆ’è®¾ç½®ç»“æœå˜é‡å’ŒçŠ¶æ€è®¡åˆ’ï¼Œå¦åˆ™æˆ‘ä»¬åœ¨å§“æ°è¯å…¸ä¸­æœç´¢ç›¸ä¼¼çš„è¯ã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> parts ==<span class="hljs-number"><span class="hljs-number">2</span></span>: combs = list(permutations(split, parts)) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> combs: element = <span class="hljs-string"><span class="hljs-string">" "</span></span>.join(item) result=combinationSearcher(element,persondicFI,<span class="hljs-number"><span class="hljs-number">0.7</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> result!=<span class="hljs-string"><span class="hljs-string">""</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span></code> </pre> <br><p> å¦‚æœè¯¥çŸ­è¯­ç”±ä¸¤ä¸ªå•è¯ç»„æˆï¼Œåˆ™å‡å®šå®ƒæ˜¯ä¸€ä¸ªå§“æ°å’Œä¸€ä¸ªåå­—ã€‚ <br> æˆ‘ä»¬åˆ—å‡ºä¸€ä¸ªç»„åˆåˆ—è¡¨ï¼ˆIvan Ivanï¼ŒIvan Ivanï¼‰ï¼Œå¹¶å¯»æ‰¾ç›¸ä¼¼çš„æ¯”èµ›ã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> parts ==<span class="hljs-number"><span class="hljs-number">3</span></span>: combs = list(permutations(split, parts)) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> combs: element = <span class="hljs-string"><span class="hljs-string">" "</span></span>.join(item) result=combinationSearcher(element,persondic,<span class="hljs-number"><span class="hljs-number">0.8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> result!=<span class="hljs-string"><span class="hljs-string">""</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> result!=<span class="hljs-string"><span class="hljs-string">""</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result</code> </pre> <br><p> å¯¹äºä¸‰å­—è¯çŸ­è¯­ï¼Œæˆ‘ä»¬å‡å®šå®ƒæ˜¯ä¸€ä¸ªå…¨åï¼Œåˆ—å‡ºç»„åˆå¹¶åœ¨å­—å…¸ä¸­æŸ¥æ‰¾ä¸€ä¸ªå…¨åã€‚ å¦‚æœå˜é‡ä¸ä¸ºç©ºï¼Œåˆ™è¿”å›ç»“æœã€‚ </p><br><pre> <code class="python hljs">buf = mssqlwrapper(recognizedString) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> buf != <span class="hljs-string"><span class="hljs-string">''</span></span>: buf = mssqlwrapper(recognizedString)[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> str(buf) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> descriptions.keys(): verb(<span class="hljs-string"><span class="hljs-string">'it is'</span></span>) setVar(<span class="hljs-string"><span class="hljs-string">'FNAME'</span></span>, descriptions[str(buf)]) setVar(<span class="hljs-string"><span class="hljs-string">'RSTATUS'</span></span>, <span class="hljs-string"><span class="hljs-string">'DEPTSUCCESS'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buf <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: verb(<span class="hljs-string"><span class="hljs-string">u'item not found '</span></span> + recognizedString) <span class="hljs-comment"><span class="hljs-comment">#    setVar('RSTATUS', 'REQUESTNOTFOUND') return callnumber</span></span></code> </pre> <br><p> å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…é¡¹ï¼Œåˆ™åœ¨FTæ•°æ®åº“ä¸­è¿›è¡Œæœç´¢ï¼Œå¦‚æœæ‰¾åˆ°åŒ¹é…é¡¹ï¼Œåˆ™è¿”å›ç»“æœå’Œæè¿°ï¼Œå¦åˆ™è¿”å›é»˜è®¤æ•°å­—å¹¶è®¾ç½®æœªæ‰¾åˆ°è¯¥çŸ­è¯­çš„çŠ¶æ€ã€‚ </p><br><p>  <strong>è¯¥ç¨‹åºçš„ä¸»ä½“ã€‚</strong> </p><br><pre> <code class="python hljs">fillDics() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> WINDEBUG: checkSize(infile) start_time = timeit.default_timer() convert(infile, outfile) convert_elapsed = timeit.default_timer() - start_time start_time = timeit.default_timer() checkstring = sendRecog(outfile).lower() recog_elapsed = timeit.default_timer() - start_time verb(<span class="hljs-string"><span class="hljs-string">'convert_elapsed = '</span></span> + str(recog_elapsed)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> checkstring == <span class="hljs-string"><span class="hljs-string">""</span></span>: verb(<span class="hljs-string"><span class="hljs-string">'not recognized. using default.'</span></span>) setVar(<span class="hljs-string"><span class="hljs-string">'NUMTOCALL'</span></span>, <span class="hljs-string"><span class="hljs-string">'repeat'</span></span>) setVar(<span class="hljs-string"><span class="hljs-string">'RSTATUS'</span></span>, <span class="hljs-string"><span class="hljs-string">'SILENCE'</span></span>) exit(<span class="hljs-number"><span class="hljs-number">9</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: setVar(<span class="hljs-string"><span class="hljs-string">'RECREZ'</span></span>, checkstring) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: checkstring = <span class="hljs-string"><span class="hljs-string">u""</span></span> start_time = timeit.default_timer() callnumber = getNumByName(checkstring) search_elapsed = timeit.default_timer() - start_time <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> WINDEBUG: setVar(<span class="hljs-string"><span class="hljs-string">'NUMTOCALL'</span></span>, str(callnumber)) addSessionStat(convert_elapsed, recog_elapsed, search_elapsed, checkstring.lower())</code> </pre> <br><p> å¯åŠ¨å¡«å……å­—å…¸çš„åŠŸèƒ½ï¼Œå¦‚æœæˆ‘ä»¬ä¸åœ¨è°ƒè¯•ç¨‹åºä¸­-æˆ‘ä»¬å¡«å……è®¡æ—¶å™¨å˜é‡ï¼Œæ£€æŸ¥æ–‡ä»¶å¤§å°ï¼Œè¿›è¡Œè½¬æ¢ï¼Œå°†å…¶å‘é€ä»¥è¿›è¡Œè¯†åˆ«ï¼Œå¦åˆ™æˆ‘ä»¬ç”¨æ£€æŸ¥çŸ­è¯­å¡«å……checkstringå˜é‡ã€‚ <br> æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¡«å……ç”¨äºè¯†åˆ«çš„è®¡æ—¶å™¨å˜é‡ï¼Œç„¶ååœ¨ç»“æ„ä¸­æœç´¢çŸ­è¯­ã€‚ å¹¶ä¸”ï¼Œåœ¨æˆ˜æ–—åŠŸèƒ½æ–¹é¢ï¼Œæˆ‘ä»¬ä¸ºç¼–å·è®¡åˆ’è®¾ç½®å˜é‡å¹¶è¾“å…¥ç»Ÿè®¡ä¿¡æ¯ã€‚ </p><br><p>  <strong>ä¸€äº›ç»Ÿè®¡ã€‚</strong> </p><br><p>  <em>2018å¹´6æœˆï¼š</em> <br> æˆåŠŸè®¤å¯-1010 <br> æ²‰é»˜ä¸è¯­-78 <br> è¯†åˆ«å¤±è´¥ï¼ˆæ‰¾ä¸åˆ°åŒ¹é…é¡¹ï¼‰-79 <br> ç®€çŸ­ç”³è¯·-4 <br> è®¤å¯éƒ¨é—¨-7 <br> å¹³å‡è¯†åˆ«æ—¶é—´ï¼ˆYandexå¹³å‡å“åº”æ—¶é—´ï¼‰-2.6ç§’ </p><br><p>  <em>2017å¹´6æœˆï¼š</em> <br> æˆåŠŸè®¤å¯-1271 <br> è®¤å¯éƒ¨é—¨-18 <br> è¯†åˆ«å¤±è´¥ï¼ˆæ‰¾ä¸åˆ°åŒ¹é…é¡¹ï¼‰-127 <br> ç®€çŸ­ç”³è¯·-9 <br> åœ¨ç®¡å­é‡Œæ²‰é»˜äº†-71 <br> å¹³å‡è¯†åˆ«æ—¶é—´ï¼ˆYandexå¹³å‡å“åº”æ—¶é—´ï¼‰-1.5ç§’ </p><br><p> æ­¤æœåŠ¡å·²åœ¨æˆ‘å·¥ä½œçš„å…¬å¸ä¸­æˆåŠŸä½¿ç”¨ã€‚ æˆ‘å¸Œæœ›æˆ‘çš„æˆå°±èƒ½å¤Ÿå¸®åŠ©å…¶ä»–äººå®ç°ä»–ä»¬çš„æƒ³æ³•æˆ–ç±»ä¼¼åŠŸèƒ½ã€‚ å‡†å¤‡å›ç­”æ‰€æœ‰é—®é¢˜ã€‚ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN417273/">https://habr.com/ru/post/zh-CN417273/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN417261/index.html">åœ¨æ¶‰åŠä»–çš„æœºå™¨äººæ±½è½¦çš„äº‹æ•…å‘ç”Ÿåï¼ŒUberå†³å®šè£å‘˜åŒ¹å…¹å ¡çš„æ™ºèƒ½æœºå™¨æ“ä½œå‘˜</a></li>
<li><a href="../zh-CN417263/index.html">JavaScriptæ˜¯é‚ªæ¶çš„åŒ–èº«</a></li>
<li><a href="../zh-CN417265/index.html">åå¤§ï¼šDotNext 2017è«æ–¯ç§‘æœ€ä½³æŠ¥é“</a></li>
<li><a href="../zh-CN417269/index.html">è®¾è®¡å¸ˆçš„å»å‘ï¼šäº«æœ‰å›½é™…å£°èª‰çš„å¥–é¡¹</a></li>
<li><a href="../zh-CN417271/index.html">é»‘å®¢å¯ä»¥å°é”è‹±å‰åˆ©æµ·å³¡å—ï¼Ÿ</a></li>
<li><a href="../zh-CN417275/index.html">æœ‰æ•ˆè®¾è®¡å¸ˆçš„7ä¸ªæŠ€èƒ½ã€‚ å¼ºå¤§çš„èŒä¸šå‘å±•å·¥å…·</a></li>
<li><a href="../zh-CN417277/index.html">å…è´¹åº“ï¼Œç”¨äºåˆ›å»ºå’Œç¼–è¾‘PDFæ–‡ä»¶</a></li>
<li><a href="../zh-CN417283/index.html">è¿ªå£«å°¼æ¨å‡ºäº†è‡ªå·±çš„HairControlå¤´å‘åŠ¨ç”»ç³»ç»Ÿ</a></li>
<li><a href="../zh-CN417285/index.html">åœ¨IPv6ä¸­ä½•å¤„æ’å…¥å¼•å·</a></li>
<li><a href="../zh-CN417287/index.html">7æœˆçš„â€œæµ‹è¯•è€…æ—¥å†â€ã€‚ åˆ†ææµ‹è¯•</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>