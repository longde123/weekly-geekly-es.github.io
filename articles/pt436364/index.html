<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äçüë®‚Äçüëß‚Äçüë¶ üö≥ üëàüèæ O Liveprof mostrar√° quando e por que o desempenho do seu aplicativo PHP mudou üÜö üë©üèø‚Äçü§ù‚Äçüë®üèª üë©üèΩ‚Äçüíª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° Habr! Meu nome √© Timur Shagiakhmetov, sou desenvolvedor de PHP no Badoo . 

 O desempenho do aplicativo √© um dos crit√©rios mais importantes para a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>O Liveprof mostrar√° quando e por que o desempenho do seu aplicativo PHP mudou</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/436364/"><img src="https://habrastorage.org/webt/sm/5p/or/sm5porzvybv5m_8ngvmgicgmeui.jpeg"><br><br>  Ol√° Habr!  Meu nome √© Timur Shagiakhmetov, sou desenvolvedor de PHP no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Badoo</a> . <br><br>  O desempenho do aplicativo √© um dos crit√©rios mais importantes para a qualidade do trabalho de um programador.  Em quest√µes de otimiza√ß√£o de aplicativos PHP, o assistente √© o criador de perfil. <br><br>  Recentemente, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">conversamos</a> sobre quais ferramentas usamos para criar perfis.  Deixe-me lembr√°-lo: uma das ferramentas para an√°lise de desempenho, quando n√£o est√° claro quais partes do c√≥digo influenciaram o aumento no tempo de gera√ß√£o de resposta, √© o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">XHProf</a> .  Essa √© uma extens√£o do PHP que permite criar um perfil do c√≥digo em um servidor de combate e melhor√°-lo posteriormente. <br><br>  Mas eu tamb√©m gostaria de ter um hist√≥rico de altera√ß√µes no desempenho para que voc√™ possa acompanhar o que e quando afetou sua deteriora√ß√£o, certo?  Para fazer isso, h√° cerca de um ano, desenvolvemos o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Liveprof</a> , uma ferramenta para a cria√ß√£o autom√°tica de perfil de todas as solicita√ß√µes com uma interface para analisar as altera√ß√µes no desempenho do aplicativo. <br><br>  Nossa ferramenta permite que voc√™ analise a altera√ß√£o de desempenho de qualquer parte do c√≥digo, encontre os locais onde mais caiu.  Ao mesmo tempo, ele n√£o precisa ser ativado especificamente e aguardar a acumula√ß√£o de estat√≠sticas - ele est√° sempre ativo e coleta dados para uma determinada fra√ß√£o de todas as solicita√ß√µes. <br><br>  Neste artigo, falarei sobre os detalhes da implementa√ß√£o e os recursos do uso desta ferramenta. <br><a name="habracut"></a><br><h2>  Um pouco sobre o XHProf </h2><br>  Primeiro, algumas palavras sobre os recursos do pr√≥prio XHProf.  Este √© um criador de perfil para PHP escrito em C como uma extens√£o.  Foi desenvolvido no Facebook e publicado em dom√≠nio p√∫blico.  Possui v√°rios garfos ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">uprofiler</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tideways</a> ), totalmente compat√≠veis no n√≠vel do formato dos dados de sa√≠da. <br><br>  XHProf define temporizadores em todas as chamadas de fun√ß√£o / m√©todo.  Seu uso envolve alguma sobrecarga.  Mas eles n√£o s√£o t√£o grandes e permitem us√°-lo na produ√ß√£o. <br><br>  O resultado de XHProf √© uma matriz de elementos no seguinte formato: <br><br><pre><code class="php hljs">$data = [ <span class="hljs-string"><span class="hljs-string">'parentMethodName==&gt;childMethodName'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'ct'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-string"><span class="hljs-string">'wt'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-string"><span class="hljs-string">'cpu'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-string"><span class="hljs-string">'mu'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">528</span></span> <span class="hljs-string"><span class="hljs-string">'pmu'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ] ];</code> </pre> <br>  onde <br><br>  <code><b>parentMethodName</b></code> e <code><b>childMethodName</b></code> s√£o os m√©todos pai e filho, respectivamente; <br>  <code><b>ct</b></code> - o n√∫mero de chamadas no contexto da solicita√ß√£o; <br>  <code><b>wt</b></code> - tempo de execu√ß√£o da solicita√ß√£o (consiste no tempo gasto pelo processador e no tempo de espera pela E / S ou pela resposta de outro servi√ßo); <br>  <code><b>cpu</b></code> - tempo gasto pelo processador no processamento da solicita√ß√£o; <br>  <code><b>mu</b></code> - altera√ß√£o no consumo de mem√≥ria ap√≥s uma chamada de m√©todo; <br>  <code><b>pmu</b></code> - altera√ß√£o no consumo m√°ximo de mem√≥ria ap√≥s uma chamada de m√©todo. <br><br>  Algumas outras op√ß√µes tamb√©m s√£o poss√≠veis. <br><br>  O XHProf tamb√©m cont√©m ferramentas para visualizar os resultados assim obtidos.  Para cada opera√ß√£o de cria√ß√£o de perfil, obtemos uma tabela com um conjunto de par√¢metros para cada m√©todo. <br><br>  Por exemplo <br><br><div class="spoiler">  <b class="spoiler_title">resultado de classifica√ß√£o de bolhas</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayGenerator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRandomArray</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $count)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">array</span></span></span><span class="hljs-function"> </span></span>{ $array = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; $count; $i++) { $array[] = rand(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $array; } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BubbleSorter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;$array)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ $len = count($array); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; $len ; $i++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($j = <span class="hljs-number"><span class="hljs-number">0</span></span>; $j &lt; $len - $i - <span class="hljs-number"><span class="hljs-number">1</span></span>; $j++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($array[$j] &gt; $array[$j + <span class="hljs-number"><span class="hljs-number">1</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;swap($array[$j], $array[$j + <span class="hljs-number"><span class="hljs-number">1</span></span>]); } } } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">swap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;$a, &amp;$b)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ $tmp = $a; $a = $b; $b = $tmp; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isSorted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $array)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bool</span></span></span><span class="hljs-function"> </span></span>{ $len = count($array); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; $len - <span class="hljs-number"><span class="hljs-number">1</span></span>; $i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($array[$i] &gt; $array[$i + <span class="hljs-number"><span class="hljs-number">1</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayPrinter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $array, string $delimiter = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">' '</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> implode($delimiter, $array) . PHP_EOL; } } xhprof_enable(); $n = <span class="hljs-number"><span class="hljs-number">10</span></span>; $arrayGenerator = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \ArrayGenerator(); $array = $arrayGenerator-&gt;getRandomArray($n); $sorter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BubbleSorter(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$sorter-&gt;isSorted($array)) { $sorter-&gt;sort($array); } $printer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \ArrayPrinter(); $printer-&gt;print($array); $xhprof_data = xhprof_disable();</code> </pre><br></div></div><br><img src="https://habrastorage.org/webt/ip/cw/vi/ipcwviocimg7kjon1memwwziho8.png"><br><br>  Voc√™ pode entrar em cada m√©todo para descobrir quais m√©todos utilizaram quantos recursos. <br><br>  Voc√™ tamb√©m pode ver o gr√°fico de chamadas destacando os m√©todos que mais consomem recursos: <br><br><img src="https://habrastorage.org/webt/zq/yw/pl/zqywplc0eibbdxdotsr3f0bed_o.png"><br><br>  XHProf √© √∫til para analisar manualmente o desempenho de cada solicita√ß√£o.  Mas tamb√©m √© importante vermos o quadro geral.  Voc√™ precisa entender como o desempenho mudou ao longo do tempo.  Para isso, foi desenvolvida uma ferramenta que perfila as consultas no modo autom√°tico e permite analis√°-las na interface da web. <br><br><h2>  Liveprof: agregue resultados e mantenha o hist√≥rico </h2><br>  Como obter o hist√≥rico de cria√ß√£o de perfil? <br><br>  Primeiro, voc√™ precisa configurar o in√≠cio autom√°tico do criador de perfil e salvar os resultados.  O desempenho n√£o √© constante e varia de um lan√ßamento para o outro.  Para evitar a influ√™ncia de tais flutua√ß√µes, usamos os dados m√©dios de v√°rias consultas.  Como resultado, obtemos resultados agregados para cada consulta, por exemplo, m√≠nimo, m√°ximo, m√©dia e percentil 95.  Isso ajuda a encontrar coisas dif√≠ceis que podem n√£o ser necess√°rias para cada solicita√ß√£o. <br><br>  Nossa ferramenta tem vantagens e algumas limita√ß√µes. <br><br><h3>  O que o agregador pode fazer: </h3><br><ol><li>  Perfil autom√°tico de cada en√©sima solicita√ß√£o. <br></li><li>  Agrega√ß√£o di√°ria de perfis coletados. <br></li><li>  A capacidade de ver gr√°ficos de altera√ß√µes em cada par√¢metro medido pelo criador de perfil.  Por exemplo, wt, cpu, mu, pmu descritos acima. <br></li><li>  Veja a altera√ß√£o no desempenho de qualquer m√©todo por um determinado intervalo. <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Gr√°fico de chama com</a> base nos dados agregados mais recentes. <br></li><li>  Encontre consultas que chamam um m√©todo espec√≠fico <br></li></ol><br><h3>  Limita√ß√µes: </h3><br><ol><li>  Como nossa ferramenta √© agregada, n√£o √© poss√≠vel descobrir o desempenho de uma consulta (por exemplo, a mais lenta) - obtemos a m√©dia dos resultados no √∫ltimo dia.  Mas isso √© suficiente para avaliar a din√¢mica geral do desempenho.  Se alguma solicita√ß√£o caiu na velocidade de execu√ß√£o, o valor m√©dio, o percentil 95 e o tempo m√°ximo de execu√ß√£o ser√£o alterados. <br></li><li>  Voc√™ n√£o pode restaurar inequivocamente a pilha de chamadas completa, pois XHProf retorna apenas pares pai-filho exclusivos com a soma dos valores dos recursos gastos. <br></li><li>  Solicite um erro de tempo de execu√ß√£o relacionado √† sobrecarga do XHProf.  A diferen√ßa n√£o √© t√£o grande, mas deve ser levada em considera√ß√£o ao medir o tempo de execu√ß√£o da consulta. <br></li></ol><br><h3>  Como usar o profiler </h3><br><ol><li>  Primeiro, o criador de perfil precisa estar conectado ao site ou script.  A maneira mais conveniente de usar a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ferramenta √© iniciar automaticamente o criador de perfil</a> : <br><br><pre> <code class="plaintext hljs">php composer.phar require badoo/liveprof # Run a script to configure database LIVE_PROFILER_CONNECTION_URL=mysql://db_user:db_password@db_mysql:3306/Profiler?charset=utf8 php vendor/badoo/liveprof/bin/install.php</code> </pre><br>  Ele suporta vers√µes do PHP a partir da 5.4, e seu uso √© repleto de sobrecarga m√≠nima, o que permite us√°-lo em um ambiente de combate.  A ferramenta detecta automaticamente a extens√£o do criador de perfil usada: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">XHProf</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">uprofiler</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tideways</a> .  Na inicializa√ß√£o, voc√™ precisa especificar par√¢metros para conectar-se ao banco de dados e √†s configura√ß√µes de perfil. <br><br>  Exemplo de uso no c√≥digo com configura√ß√µes padr√£o: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-string"><span class="hljs-string">'vendor/autoload.php'</span></span>; \Badoo\LiveProfiler\LiveProfiler::getInstance()-&gt;start(); <span class="hljs-comment"><span class="hljs-comment">// Code is here</span></span></code> </pre> <br>  Os resultados da cria√ß√£o de perfil s√£o salvos no banco de dados.  Uma vez por dia, ocorre um processo de agrega√ß√£o.  Para fazer isso, selecione todos os registros para uma solicita√ß√£o espec√≠fica por dia e calcule as fun√ß√µes agregadas para cada um dos par√¢metros.  As fun√ß√µes de agrega√ß√£o podem ser expandidas ou redefinidas. <br><br>  Agora est√£o dispon√≠veis os seguintes: <br><br><ul><li>  pelo menos por dia; </li><li>  m√°ximo por dia; </li><li>  m√©dia di√°ria </li><li>  Percentil 95 do dia. </li></ul><br></li><li>  O <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">web client</a> agregador <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">√©</a> usado para configurar a agrega√ß√£o e visualizar os resultados.  A maneira mais f√°cil de instal√°-lo em um cont√™iner de docker: <br><br><pre> <code class="php hljs">git <span class="hljs-keyword"><span class="hljs-keyword">clone</span></span> https:<span class="hljs-comment"><span class="hljs-comment">//github.com/badoo/liveprof-ui.git cd liveprof-ui docker-compose up web</span></span></code> </pre> </li><li>  Antes do primeiro in√≠cio, voc√™ precisa configurar os par√¢metros de conex√£o com o banco de dados, uma lista de campos e fun√ß√µes agregadas usadas no arquivo de configura√ß√£o src / config / services.yaml.  Em seguida, execute o script de instala√ß√£o: <br><br><pre> <code class="php hljs">docker-compose exec web bash install.sh</code> </pre> </li><li>  √â necess√°rio registrar automaticamente scripts de agrega√ß√£o e limpeza de dados antigos em coroas: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment"># script aggregates all profiles for previous day, add it if you don't use a queue for aggregation jobs (parameter aggregator.use_jobs_in_aggregation=false) 0 2 * * * docker-compose -f %PATH_TO_PROJECT%/docker-compose.yml run --rm --entrypoint '/usr/local/bin/php /app/bin/cli.php cron:aggregate-all-profiles' web # script removes old aggregated data, by default &gt; 200 days 0 1 * * * docker-compose -f %PATH_TO_PROJECT%/docker-compose.yml run --rm --entrypoint '/usr/local/bin/php /app/bin/cli.php cron:remove-old-profiles' web 200</span></span></code> </pre> <br></li><li>  Para preencher com dados de teste, voc√™ pode executar o script: <br><br><pre> <code class="php hljs">docker-compose exec web php /app/bin/cli.php example:a-week-degradation</code> </pre> </li></ol><br><h2>  Descri√ß√£o da interface </h2><br>  A interface da web est√° dispon√≠vel em: 127.0.0.1:8000. <br><br>  Por padr√£o, uma p√°gina com uma lista de consultas agregadas √© aberta.  Torna mais f√°cil encontrar uma consulta de interesse, classificar todas as consultas por qualquer um dos par√¢metros e tamb√©m agregar novamente uma consulta espec√≠fica para ver os resultados mais recentes: <br><br><img src="https://habrastorage.org/webt/qj/-d/6b/qj-d6bj1095huwhvqmzdwim1g6k.png"><br><br>  Uma p√°gina com uma lista de m√©todos e gr√°ficos de altera√ß√µes de desempenho √© a mais usada ao trabalhar com a ferramenta.  Ele permite que voc√™ percorra a pilha de chamadas, observe o consumo de cada par√¢metro, bem como gr√°ficos de altera√ß√µes de desempenho por um determinado intervalo: <br><br><img src="https://habrastorage.org/webt/-6/ag/u4/-6agu45zuu1qs77tckpkngabjwq.png"><br><br>  <i>Uma p√°gina com uma lista completa dos m√©todos chamados permite encontrar rapidamente o m√©todo de interesse e ver os gr√°ficos, indo para a p√°gina de gr√°ficos:</i> <br><br><img src="https://habrastorage.org/webt/nj/g-/f_/njg-f_48jsuo8mcmlxuq1ukxj_4.png"><br>  <i>A p√°gina com o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">gr√°fico de chama da</a> √∫ltima consulta agregada permite identificar visualmente as partes mais pesadas.</i> <br><br>  O uso do XHProf imp√µe algumas limita√ß√µes na precis√£o do resultado.  Isso ocorre porque o criador de perfil n√£o retorna uma √°rvore de chamadas completa, mas apenas os pares pai-filho.  Al√©m disso, se algum par de m√©todos foi chamado de diferentes locais do aplicativo, como resultado, obtemos a quantidade de tempo gasto.  Para um gr√°fico de chama, voc√™ precisa ter uma √°rvore de chamadas completa.  Ao restaurar essa √°rvore, os valores dos par√¢metros s√£o normalizados, levando em considera√ß√£o o tempo gasto pelos pais. <br><br><img src="https://habrastorage.org/webt/vp/lp/xr/vplpxry-gjd-lq774gg3ji9cooo.png"><br>  <i>Uma p√°gina com uma lista de m√©todos que se tornaram mais lentos durante o intervalo selecionado.</i> <br><br>  Al√©m disso, para cada m√©todo, voc√™ pode ver quais chamadas secund√°rias afetaram mais o desempenho.  Por exemplo, na captura de tela abaixo, voc√™ pode ver que o m√©todo <code>ServiceApi::getAvailableServices()</code> come√ßou a executar 116 ms mais lentamente.  O motivo disso foi a adi√ß√£o de uma chamada ao <code>ServiceApi::getGifts()</code> (altera√ß√£o de 56 ms) e um aumento no n√∫mero de chamadas para o m√©todo <code>ServiceApi::getConfigForList()</code> de 1 para 5 (outros 50 ms): <br><br> <a href=""><img src="https://habrastorage.org/webt/rv/mc/dd/rvmcddru-ay4x9cb45xsvey_tka.png"></a> <br><br>  Se n√£o for conhecido antecipadamente qual consulta o desempenho mudou mais visivelmente, uma p√°gina com uma lista de m√©todos que se tornou mais lenta sem refer√™ncia a uma consulta espec√≠fica ajudar√°: <br><br><img src="https://habrastorage.org/webt/-6/0b/3s/-60b3svwq_rg9z7wbzmzmpriapc.png"><br>  <i>Uma p√°gina que pesquisa consultas que invocam um m√©todo espec√≠fico.</i> <br><br>  Permite comparar o tempo de execu√ß√£o em diferentes solicita√ß√µes.  Tamb√©m √© √∫til para encontrar c√≥digo n√£o utilizado: <br><br><img src="https://habrastorage.org/webt/hq/du/lv/hqdulvav1asbj9nczgowuk1mvak.png"><br><br><h3>  Recursos de personaliza√ß√£o </h3><br>  A ferramenta possui amplas oportunidades para personaliza√ß√£o: <br><br><ul><li>  voc√™ pode adicionar suas pr√≥prias fun√ß√µes agregadas que calculam um determinado valor com base na matriz passada de valores de par√¢metros; <br></li><li>  Voc√™ pode alterar o banco de dados para armazenar perfis e resultados agregados (SQLite, MySQL e PostgreSQL agora s√£o suportados, mas voc√™ pode usar outros da lista dispon√≠vel para o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Doctrine DBAL</a> ); <br></li><li>  Voc√™ pode substituir o gerenciador de conex√µes do banco de dados e implementar seus m√©todos para obter dados; <br></li><li>  Voc√™ pode usar a interface da web como um projeto independente e dentro de qualquer estrutura (por exemplo, um painel de controle do site).  Um exemplo: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">profileListAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{      &lt;i&gt;<span class="hljs-comment"><span class="hljs-comment">//Some custom logic before&lt;/i&gt;   $this-&gt;checkPermissions();   $App = new \Badoo\LiveProfilerUI\LiveProfilerUI();   $Page = $App-&gt;getPage('profile_method_list_page');   return $Page-&gt;setData($data)-&gt;render(); }</span></span></code> </pre> </li></ul><br><h2>  Conclus√£o </h2><br>  Espero que nossa ferramenta seja √∫til para outros desenvolvedores.  Isso permitir√° verificar a altera√ß√£o de desempenho de qualquer parte do c√≥digo sem o uso de temporizadores adicionais.  Isso tamb√©m facilitar√° o processo de otimiza√ß√£o, pois agora voc√™ pode ver o que afetou a degrada√ß√£o do desempenho do aplicativo ao longo do tempo. <br><br>  Est√° dispon√≠vel no GitHub: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github.com/badoo/liveprof</a> , a interface da web √© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github.com/badoo/liveprof-ui</a> . <br><br>  A ferramenta est√° em desenvolvimento ativo e pode conter alguns erros.  Espero que com a participa√ß√£o da comunidade, fique ainda melhor.  Os planos incluem adicionar suporte a outros criadores de perfil al√©m do XHProf, al√©m de expandir a lista de bancos de dados suportados. <br><br>  Envie-nos coment√°rios e perguntas sobre o uso no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Telegram</a> , bugs e solicita√ß√µes pull - diretamente para o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GitHub</a> .  Agradecemos coment√°rios e sugest√µes! <br><br>  Agradecimentos especiais a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Gregory</a> pela id√©ia e primeira implementa√ß√£o. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt436364/">https://habr.com/ru/post/pt436364/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt436352/index.html">Resumo de not√≠cias do PostgreSQL. Edi√ß√£o 14</a></li>
<li><a href="../pt436354/index.html">Militares dos EUA negligenciam quest√µes de seguran√ßa cibern√©tica</a></li>
<li><a href="../pt436356/index.html">[Interessante por tr√°s da colina] Como paramos a depend√™ncia tecnol√≥gica?</a></li>
<li><a href="../pt436358/index.html">Por que os desenvolvedores seniores ensinam os alunos</a></li>
<li><a href="../pt436360/index.html">Preciso ir r√°pido: Criando velocidade no iOS. Parte 1</a></li>
<li><a href="../pt436370/index.html">Infraestrutura de chave p√∫blica Cadeia de certificados raiz X509 v.3</a></li>
<li><a href="../pt436372/index.html">Plug-in isom√©trico para Unity3D</a></li>
<li><a href="../pt436374/index.html">Tend√™ncias de design da interface do usu√°rio e do UX 2019</a></li>
<li><a href="../pt436376/index.html">Vis√£o geral do rob√¥ todo-o-terreno EZ-Robot Roli Rover</a></li>
<li><a href="../pt436378/index.html">bobaos.pub - KNX TP / UART, Raspberry Pi e Redis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>