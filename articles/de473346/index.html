<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèª‚Äç‚úàÔ∏è üïö üç∫ Erstellen einer REST-API mit Node.js und einer Oracle-Datenbank. Teil 2 üßìüèø üì≠ üë∂</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Teil 2: Erstellen einer REST-API: Datenbankgrundlagen 
 Im ersten Artikel haben Sie einen Webserver erstellt. Hier erstellen Sie ein Modul, das f√ºr da...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Erstellen einer REST-API mit Node.js und einer Oracle-Datenbank. Teil 2</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/473346/"><h4>  Teil 2: Erstellen einer REST-API: Datenbankgrundlagen </h4><br>  Im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ersten Artikel haben</a> Sie einen Webserver erstellt. Hier erstellen Sie ein Modul, das f√ºr das Starten und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Herunterfahren des</a> Datenbankverbindungspools mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">node-oracledb verantwortlich ist</a> .  F√ºgen Sie eine Funktion hinzu, die die Ausf√ºhrung einfacher Anweisungen vereinfacht, indem automatisch Verbindungen aus dem Pool abgerufen und freigegeben werden. <br><a name="habracut"></a><br><h4>  Verbindungspool wird ausgef√ºhrt </h4><br>  Da node-oracledb auf OCI-Clientbibliotheken basiert, bietet es integrierte Unterst√ºtzung f√ºr die Erstellung von OCI-Pools, die clientseitig sind und hervorragende Leistungsmerkmale aufweisen.  Um einen Verbindungspool zu erstellen, erstellen Sie zun√§chst eine neue Konfigurationsdatei mit dem Namen <b>database.js</b> im <b>Konfigurationsverzeichnis</b> .  Kopieren Sie den folgenden Code, f√ºgen Sie ihn in die Datei ein und speichern Sie die √Ñnderungen. <br><br><pre><code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">hrPool</span></span>: { <span class="hljs-attr"><span class="hljs-attr">user</span></span>: process.env.HR_USER, <span class="hljs-attr"><span class="hljs-attr">password</span></span>: process.env.HR_PASSWORD, <span class="hljs-attr"><span class="hljs-attr">connectString</span></span>: process.env.HR_CONNECTIONSTRING, <span class="hljs-attr"><span class="hljs-attr">poolMin</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">poolMax</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">poolIncrement</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> } };</code> </pre> <br>  Wie bei der Datei <b>config / webserver.js</b> k√∂nnen Sie in dieser Datei einige Eigenschaften mithilfe von Umgebungsvariablen festlegen.  Die Verwendung von Umgebungsvariablen bietet Flexibilit√§t bei der Bereitstellung der Anwendung in verschiedenen Umgebungen und hilft beim Speichern von Kennw√∂rtern und anderen vertraulichen Informationen au√üerhalb des Quellcodes.  F√ºhren Sie die folgenden Befehle vom Terminal aus, um die erforderlichen Umgebungsvariablen festzulegen und sicherzustellen, dass sie in zuk√ºnftigen Terminalsitzungen verf√ºgbar sind. <br><br><pre> <code class="plaintext hljs">echo "export HR_USER=hr" &gt;&gt; ~/.bashrc echo "export HR_PASSWORD=oracle" &gt;&gt; ~/.bashrc echo "export HR_CONNECTIONSTRING=0.0.0.0/orcl" &gt;&gt; ~/.bashrc source ~/.bashrc</code> </pre> <br>  M√∂glicherweise stellen Sie fest, dass poolMin und poolMax identisch waren und poolIncrement auf 0 gesetzt wurde. Dadurch wird ein Pool mit fester Gr√∂√üe erstellt, der weniger Verwaltungsressourcen erfordert - eine gute Idee f√ºr Pools, die eine konsistente Verwendung erhalten. <br><br>  Obwohl Node.js h√§ufig als "Single-Threaded" beschrieben wird, steht f√ºr bestimmte Vorg√§nge ein Thread-Pool zur Verf√ºgung, der andernfalls den Haupt-Thread blockieren w√ºrde, in dem JavaScript-Code ausgef√ºhrt wird.  Dieser Thread-Pool wird von node-oracledb verwendet, um alle asynchronen Vorg√§nge auszuf√ºhren, z. B. das Empfangen von Verbindungen und das Ausf√ºhren von SQL- und PL / SQL-Code.  Die Standardgr√∂√üe f√ºr den Thread-Pool ist jedoch 4. Wenn alle 10 Verbindungen im Pool gleichzeitig funktionieren sollen, m√ºssen Sie die Anzahl der Threads entsprechend erh√∂hen. <br><br>  Mit der Umgebungsvariablen UV_THREADPOOL_SIZE kann die Gr√∂√üe des Thread-Pools angepasst werden.  UV_THREADPOOL_SIZE kann vor dem Ausf√ºhren der Anwendung Node.js oder intern festgelegt werden, muss jedoch festgelegt werden, bevor der erste Aufruf √ºber den Thread-Pool erfolgt.  Dies liegt an der Tatsache, dass der Thread-Pool bei seiner ersten Verwendung erstellt wird und nach seiner Erstellung seine Gr√∂√üe festgelegt wird.  √ñffnen Sie die Datei <b>index.js</b> im Stammverzeichnis der Anwendung und f√ºgen Sie nach der ersten Zeile (die das Webservermodul enth√§lt) die folgenden Zeilen hinzu. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** line that requires services/web-server.js is here *** const dbConfig = require('./config/database.js'); const defaultThreadPoolSize = 4; // Increase thread pool size by poolMax process.env.UV_THREADPOOL_SIZE = dbConfig.hrPool.poolMax + defaultThreadPoolSize;</span></span></code> </pre> <br>  Nachdem der Thread-Pool die entsprechende Gr√∂√üe hat, k√∂nnen Sie zum Datenbankmodul wechseln.  Erstellen Sie eine neue Datei im <b>Dienstverzeichnis mit dem</b> Namen <b>database.js</b> .  Kopieren Sie den folgenden Code, f√ºgen Sie ihn ein und speichern Sie die √Ñnderungen. <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> oracledb = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'oracledb'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> dbConfig = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../config/database.js'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pool = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> oracledb.createPool(dbConfig.hrPool); } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.initialize = initialize;</code> </pre> <br>  Dieses Modul f√ºhrt zuerst Node-Oracle und die Konfigurationsdatei ein.  Anschlie√üend wird eine asynchrone Funktion mit dem Namen initialize definiert, die dann √ºber das Objekt module.exports bereitgestellt wird.  Die Initialisierungsfunktion erstellt einen Verbindungspool, der als Standardpool im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">internen Cache der Verbindungspools</a> gespeichert wird. <br><br>  Jetzt m√ºssen Sie alles verbinden, damit der Verbindungspool gestartet wird, bevor der Webserver ge√∂ffnet wird.  Gehen Sie zur√ºck zu <b>index.js</b> und f√ºgen Sie die folgende Zeile unter Zeile 1 hinzu. <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** line that requires services/web-server.js is here *** const database = require('./services/database.js');</span></span></code> </pre> <br>  F√ºgen Sie dann der Stratup-Funktion unmittelbar vor dem vorhandenen Try-Block, der den Webserver startet, den folgenden try-Block hinzu. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Initializing database module'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> database.initialize(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (err) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(err); process.exit(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">// Non-zero failure code } // *** existing try block in startup here ***</span></span></code> </pre> <br>  Zu diesem Zeitpunkt k√∂nnen Sie node-oracledb installieren und den Code testen.  F√ºhren Sie die folgenden Befehle in einem Terminal aus dem Verzeichnis hr_app aus. <br><br><pre> <code class="javascript hljs">npm install oracledb -s node .</code> </pre> <br>  Wenn Sie Meldungen sehen, dass das Datenbankmodul und der Webserver ausgef√ºhrt werden, herzlichen Gl√ºckwunsch - Ihr Verbindungspool funktioniert jetzt! <br><br><h4>  Verbindungspool herunterfahren </h4><br>  Wenn Sie die Anwendung jetzt schlie√üen (wie zuvor mit Strg + c), wird der Node.js-Prozess zerst√∂rt, bevor der Verbindungspool geschlossen wird.  Obwohl alle zugeh√∂rigen Datenbankprozesse automatisch bereinigt werden sollten, ist es am besten, den Verbindungspool explizit zu schlie√üen, bevor Sie den Node.js.-Prozess beenden. <br><br>  Kehren Sie zur Datei <b>services / database.js zur√ºck</b> , f√ºgen Sie am Ende die folgenden Codezeilen hinzu und speichern Sie die Aktualisierungen. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** previous code above this line *** async function close() { await oracledb.getPool().close(); } module.exports.close = close;</span></span></code> </pre> <br>  Die Funktion close verwendet die Methode oracledb.getPool (), um den Standardpool synchron abzurufen, und ruft dann die Methode close f√ºr den Pool auf, um ihn zu schlie√üen. <br><br>  Um die <b>Schlie√üfunktion</b> zum richtigen Zeitpunkt aufzurufen, f√ºgen Sie der Datei <b>index.js</b> in der Funktion zum Herunterfahren unmittelbar nach dem vorhandenen try-Block, der den Webserver stoppt, die folgenden Codezeilen <b>hinzu</b> . <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** existing try-catch block in shutdown here *** try { console.log('Closing database module'); await database.close(); } catch (err) { console.log('Encountered error', e); err = err || e; }</span></span></code> </pre> <br>  Wenn Sie die Anwendung erneut starten und schlie√üen, wird das Datenbankmodul nach dem Schlie√üen des Webservers, jedoch vor Abschluss des Vorgangs geschlossen. <br><br><h4>  Vereinfachen Sie einfache CRUD-Operationen </h4><br>  Das Ausf√ºhren von SQL- oder PL / SQL-Code mit node-oracledb erfolgt normalerweise in drei Schritten: Stellen Sie die Verbindung her, f√ºhren Sie den Code aus und geben Sie die Verbindung frei.  Wenn Sie nur einen Aufruf ausf√ºhren m√∂chten (keine mehrstufige Transaktion ist erforderlich), sieht das Empfangen und Freigeben der Verbindung m√∂glicherweise wie Standardcode aus.  Ich m√∂chte eine Funktion erstellen, die alle drei Operationen in einem Aufruf ausf√ºhrt.  Kehren Sie zur Datei <b>services / database.js zur√ºck</b> , f√ºgen Sie den folgenden Code hinzu und speichern Sie die √Ñnderungen. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** previous code above this line *** function simpleExecute(statement, binds = [], opts = {}) { return new Promise(async (resolve, reject) =&gt; { let conn; opts.outFormat = oracledb.OBJECT; opts.autoCommit = true; try { conn = await oracledb.getConnection(); const result = await conn.execute(statement, binds, opts); resolve(result); } catch (err) { reject(err); } finally { if (conn) { // conn assignment worked, need to close try { await conn.close(); } catch (err) { console.log(err); } } } }); } module.exports.simpleExecute = simpleExecute;</span></span></code> </pre> <br>  In der Regel verwenden Sie das Datenbankmodul nicht im Webservermodul, sondern f√ºgen es jetzt hinzu, um zu √ºberpr√ºfen, ob es ordnungsgem√§√ü funktioniert.  √ñffnen Sie die <b>Datei services / web-server.js</b> und f√ºgen Sie die folgende Zeile unter den vorhandenen Konstantendeklarationen oben hinzu. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// line that requires ../config/web-server.js here const database = require('./database.js');</span></span></code> </pre> <br>  Verwenden Sie dann den folgenden Code, um den gesamten app.get-Handler zu ersetzen, der mit "Hello World!" Antwortet.  (Alle 3 Zeilen). <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** line that adds morgan to app here *** app.get('/', async (req, res) =&gt; { const result = await database.simpleExecute('select user, systimestamp from dual'); const user = result.rows[0].USER; const date = result.rows[0].SYSTIMESTAMP; res.end(`DB user: ${user}\nDate: ${date}`); });</span></span></code> </pre> <br>  Der neue Handler verwendet die simpleExecute-Funktion des Datenbankmoduls, um die Werte des aktuellen Benutzers und des Systemstempels aus der Datenbank abzurufen.  Die Werte werden dann im Vorlagenliteral verwendet, um dem Client mit einer dynamischen Nachricht zu antworten. <br><br>  Starten Sie die Anwendung erneut und gehen Sie zu localhost: 3000. Sie sollten ungef√§hr das folgende Bild sehen. <br><br><img src="https://habrastorage.org/webt/fu/89/1t/fu891trgyo2sweotztn8s0l-h-i.png" alt="Bild"><br><br>  Wenn Sie diese Meldung sehen, funktioniert alles wie es sollte.  Im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">n√§chsten Artikel werden</a> Sie die API weiterhin erstellen, indem Sie die Routing-, Controller- und Datenbanklogik f√ºr die GET-Anforderung hinzuf√ºgen. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de473346/">https://habr.com/ru/post/de473346/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de473334/index.html">Cat Ghonim: Wie kann man Katzen dazu bringen, sich zu Hause nicht auf dem Rasen zu entspannen?</a></li>
<li><a href="../de473338/index.html">TDD: Wie man Spezifikationen richtig schreibt (beschreibt)</a></li>
<li><a href="../de473340/index.html">Die Verdauung von frischen Materialien aus der Welt des Frontends f√ºr die letzte Woche Nr. 386 (21. - 27. Oktober 2019)</a></li>
<li><a href="../de473342/index.html">"Der lange Weg wartet auf Sie ..." oder L√∂sen des Prognoseproblems in C # mithilfe von Ml.NET (DataScience)</a></li>
<li><a href="../de473344/index.html">Konzerte und Events KudaGo in deinem Spiegel</a></li>
<li><a href="../de473348/index.html">Die Idee der Tr√§gheit (SGDm), die Idee der Skalierung (Adagrad) und der Regularisierung beim maschinellen Lernen am Beispiel des Klassifizierungsproblems</a></li>
<li><a href="../de473350/index.html">Erstellen einer REST-API mit Node.js und einer Oracle-Datenbank. Teil 3</a></li>
<li><a href="../de473352/index.html">Aktuelle Sammlungen in 10 Minuten</a></li>
<li><a href="../de473354/index.html">√úber die Kuriosit√§ten der Habrostatistik</a></li>
<li><a href="../de473358/index.html">Installieren und konfigurieren Sie Nexus Sonatype mithilfe der Infrastruktur als Code-Ansatz</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>