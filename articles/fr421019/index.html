<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👏🏼 💆 👨🏼‍🏭 Scier votre service Windows - un guide pour "pas de vrais programmeurs" 🤰🏻 💳 🔟</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Une fois que vous avez réfléchi à la façon de transformer un script ou une application en service Windows. Très probablement, la tâche ne sera pas si ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Scier votre service Windows - un guide pour "pas de vrais programmeurs"</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pc-administrator/blog/421019/"><p><img src="https://habrastorage.org/webt/j3/j5/7b/j3j57big8bze9751j7_frrcjc7q.jpeg"></p><br><p>  Une fois que vous avez réfléchi à la façon de transformer un script ou une application en service Windows.  Très probablement, la tâche ne sera pas si triviale - au moins l'application aura besoin d'une interface spéciale pour recevoir les commandes du système.  Et puisqu'il y a des exigences et des limitations, c'est-à-dire des scripts et des béquilles, agréables à cœur, à surmonter. </p><br><p>  L'article sera utile à ceux qui, comme moi, ne sont "pas un vrai programmeur". <a name="habracut"></a></p><br><h1 id="zachem-nuzhna-sluzhba-esli-est-naznachennye-zadaniya">  Pourquoi ai-je besoin d'un service s'il y a des tâches planifiées </h1><br><p>  Contrairement aux tâches assignées, le service fonctionne en permanence, démarre au démarrage du PC et peut être contrôlé par les outils Windows.  En outre, un script lancé régulièrement peut nécessiter des données d'un lancement précédent et il peut être utile d'obtenir des données de sources externes - par exemple, dans le cas de TCP ou d'un serveur Web. </p><br><p>  Personnellement, au cours des cinq dernières années, j'ai dû créer un service trois fois et demi: </p><br><ul><li> Il était nécessaire de créer un service sur <strong>fail2ban pour Windows 2003.</strong> qui fonctionnait avec les journaux FileZilla et Apache, et s'il était suspecté de force brute, il bloquait IP en utilisant les outils Windows standard - ipsec. </li><li>  Un analogue du serveur telnet pour les versions domestiques de Windows.  Il a fallu exécuter des commandes sur des postes de travail distants qui exécutaient Windows 7 Home.  En fait, la deuxième tentative de jouer des services. </li><li>  Lecteur de musique pour la salle des marchés sous Windows.  La tâche sur les savoirs traditionnels pourrait être résolue à l'aide de <strong><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mpd</a></strong> et d'un pack de scripts, mais j'ai décidé - si nous devions créer des scripts, alors pourquoi ne pas «empiler» le joueur moi-même.  Basé sur la bibliothèque <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">BASS.dll</a> . </li><li>  Lors du choix d'un serveur Web prenant en charge le téléchargement de fichiers sous Windows, une option était <strong><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">HFS</a></strong> .  Il ne peut pas travailler seul, il a donc dû le «pousser» au service.  En conséquence, je n'ai pas aimé la solution et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">j'ai</a> juste installé le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">thème Apaxy</a> sur le serveur Web Apache. </li></ul><br><p>  Pour créer un service, vous pouvez utiliser des langages de programmation pour adultes comme C. Mais si vous ne souhaitez pas communiquer avec Visual Studio, utilisez des utilitaires prêts à l'emploi.  Il existe des solutions payantes comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">FireDaemon Pro</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">AlwaysUp</a> , mais nous nous concentrons traditionnellement sur les solutions gratuites. </p><br><h1 id="sposob-pervyy-ot-microsoft">  La première façon.  De Microsoft </h1><br><p>  Ce mécanisme déjà ancien se compose de deux composants: l'utilitaire <strong>instsrv.exe</strong> pour installer le service et <strong>srvany.exe</strong> , le processus de lancement des fichiers exécutables.  Supposons que nous ayons créé un serveur Web sur PowerShell à l'aide du module <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Polaris</a> .  Le script sera extrêmement simple: </p><br><pre><code class="hljs powershell"><span class="hljs-built_in"><span class="hljs-built_in">New-PolarisGetRoute</span></span> <span class="hljs-literal"><span class="hljs-literal">-Path</span></span> <span class="hljs-string"><span class="hljs-string">'/helloworld'</span></span> <span class="hljs-literal"><span class="hljs-literal">-Scriptblock</span></span> { <span class="hljs-variable"><span class="hljs-variable">$Response</span></span>.Send(<span class="hljs-string"><span class="hljs-string">'Hello World!'</span></span>) } <span class="hljs-built_in"><span class="hljs-built_in">Start-Polaris</span></span> <span class="hljs-literal"><span class="hljs-literal">-Port</span></span> <span class="hljs-number"><span class="hljs-number">8080</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-variable"><span class="hljs-variable">$true</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">Start-Sleep</span></span> <span class="hljs-literal"><span class="hljs-literal">-Milliseconds</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> }</code> </pre> <br><p><img src="https://habrastorage.org/webt/im/br/xz/imbrxzpsqml1osyityi0k1nwe1w.jpeg"><br>  <em>Le travail du soi-disant "serveur".</em> </p><br><p>  Essayons maintenant de transformer le script en service.  Pour ce faire, téléchargez les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">outils du Kit de ressources Windows</a> , où seront nos utilitaires.  Commençons par installer un service vide avec la commande: </p><br><pre> <code class="hljs tex">instsrv WebServ C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">temp</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rktools</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">srvany</span></span></span></span>.exe</code> </pre><br><p>  Où WebServ est le nom de notre nouveau service.  Si nécessaire, via le composant logiciel enfichable <strong>services.msc</strong> , vous pouvez spécifier l'utilisateur sous lequel le service sera lancé et autoriser l'interaction avec le bureau. </p><br><p>  Écrivons maintenant le chemin de notre script en utilisant la magie du registre.  Les paramètres de service se trouvent dans la clé de registre <strong>HKLM \ SYSTEM \ CurrentControlSet \ Services \ WebServ</strong> .  Dans ce document, nous devons ajouter une nouvelle section <strong>Paramètres</strong> et y créer un paramètre de chaîne <strong>Application</strong> , en indiquant le chemin d'accès au fichier exécutable.  Dans le cas d'un script PowerShell, il ressemblera à ceci: </p><br><pre> <code class="hljs tex">C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">System</span></span></span></span>32<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">WindowsPowerShell</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">v</span></span></span></span>1.0<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">powershell</span></span></span></span>.exe -ExecutionPolicy Bypass -NoProfile -File C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">temp</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Polaris</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">server</span></span></span></span>.ps1</code> </pre><br><p><img src="https://habrastorage.org/webt/2c/9a/zw/2c9azwf_tlvz6cs2ez4jlw7pl58.jpeg"><br>  <em>Service personnalisé.</em> </p><br><p>  Vous pouvez courir et profiter. </p><br><p><img src="https://habrastorage.org/webt/4j/qh/kd/4jqhkdbgssb6gv8el-qpnfn4wea.jpeg"><br>  <em>Service de travail.</em> </p><br><p>  Cependant, cette méthode présente des inconvénients: </p><br><ul><li>  Les utilitaires sont anciens, développés avant l'invention de PowerShell, UAC et d'autres choses. </li><li>  <strong>Srvany</strong> ne contrôle pas le fonctionnement de l'application.  Même en cas d'erreur, le service continuera son travail comme si de rien n'était. </li><li>  Devra s'ajuster et fouiller dans le registre.  Vous souvenez-vous que creuser dans le registre n'est pas sûr? </li></ul><br><p>  Par conséquent, nous nous tournons vers une méthode partiellement dépourvue de ces problèmes. </p><br><h1 id="sposob-vtoroy-pochti-vzroslyy">  La deuxième façon, presque un adulte </h1><br><p>  Il existe un utilitaire appelé <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NSSM</a> - <strong>Non-Sucking Service Manager</strong> , qui peut être traduit par un <em>non-bad service manager</em> .  Contrairement au précédent, il est pris en charge par le développeur et le code source est publié sur le site.  En plus de la méthode habituelle, l'installation est également disponible via le gestionnaire de paquets <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Chocolately</a> . </p><br><p>  Vous pouvez créer un service à partir de la ligne de commande habituelle, armé de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> sur le site du développeur.  Mais nous utiliserons PowerShell.  Parce que nous pouvons, bien sûr. </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$nssm</span></span> = (<span class="hljs-built_in"><span class="hljs-built_in">Get-Command</span></span> ./nssm).Source <span class="hljs-variable"><span class="hljs-variable">$serviceName</span></span> = <span class="hljs-string"><span class="hljs-string">'WebServ'</span></span> <span class="hljs-variable"><span class="hljs-variable">$powershell</span></span> = (<span class="hljs-built_in"><span class="hljs-built_in">Get-Command</span></span> powershell).Source <span class="hljs-variable"><span class="hljs-variable">$scriptPath</span></span> = <span class="hljs-string"><span class="hljs-string">'C:\temp\Polaris\server.ps1'</span></span> <span class="hljs-variable"><span class="hljs-variable">$arguments</span></span> = <span class="hljs-string"><span class="hljs-string">'-ExecutionPolicy Bypass -NoProfile -File "{0}"'</span></span> <span class="hljs-operator"><span class="hljs-operator">-f</span></span> <span class="hljs-variable"><span class="hljs-variable">$scriptPath</span></span> &amp; <span class="hljs-variable"><span class="hljs-variable">$nssm</span></span> install <span class="hljs-variable"><span class="hljs-variable">$serviceName</span></span> <span class="hljs-variable"><span class="hljs-variable">$powershell</span></span> <span class="hljs-variable"><span class="hljs-variable">$arguments</span></span> &amp; <span class="hljs-variable"><span class="hljs-variable">$nssm</span></span> status <span class="hljs-variable"><span class="hljs-variable">$serviceName</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Start-Service</span></span> <span class="hljs-variable"><span class="hljs-variable">$serviceName</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Get-Service</span></span> <span class="hljs-variable"><span class="hljs-variable">$serviceName</span></span></code> </pre> <br><p><img src="https://habrastorage.org/webt/nn/gf/xz/nngfxzjxsimbi2srebmcwjzioie.jpeg"><br>  <em>Installation via PowerShell.</em> </p><br><p>  Pour une modification, nous vérifierons le fonctionnement du service non pas avec le navigateur, mais également via PowerShell à l'aide de la <strong>commande Invoke-RestMethod.</strong> </p><br><p><img src="https://habrastorage.org/webt/b-/wg/17/b-wg17nhhlesw6xon8sdv9c0hks.png"><br>  <em>Et ça marche vraiment.</em> </p><br><p>  Contrairement à <strong>srvany</strong> , cette méthode vous permet de redémarrer l'application au démarrage, de rediriger <strong>stdin</strong> et <strong>stdout</strong> et bien plus encore.  En particulier, si vous ne souhaitez pas écrire de commandes sur la ligne de commande, exécutez simplement l'interface graphique et entrez les paramètres nécessaires via une interface pratique. </p><br><p>  L'interface graphique est démarrée avec la commande: </p><br><pre> <code class="hljs sql">nssm.exe <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> ServiceName</code> </pre> <br><p><img src="https://habrastorage.org/webt/ji/rg/6i/jirg6iwexgpn_3zun4ich0zgepo.jpeg"><br>  <em>Vous pouvez même configurer la priorité et l'utilisation des cœurs de processeur.</em> </p><br><p>  En effet, il existe beaucoup plus d'opportunités que la <strong>srvany</strong> et un certain nombre d'autres <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">analogues</a> .  Parmi les inconvénients, un contrôle insuffisant sur l'ensemble du processus est frappant. </p><br><p>  Il y a un manque d'étain.  Par conséquent, je vais passer à la méthode la plus hardcore de tous les tests. </p><br><h1 id="sposob-tretiy-autoit">  La troisième voie.  AutoIT </h1><br><p>  Comme je suis un amoureux de longue date de ce langage de script, je n'ai pas pu dépasser la bibliothèque appelée <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">_Services_UDF v4</a> .  Il est équipé d'une riche documentation et d'exemples, donc sous le spoiler je donnerai immédiatement le texte complet du script résultant. </p><br><div class="spoiler">  <b class="spoiler_title">Liste des scripts</b> <div class="spoiler_text"><p>  Essayons donc d’envelopper notre service Web: </p><br><pre> <code class="hljs mel">#NoTrayIcon #RequireAdmin #Region #AutoIt3Wrapper_Version=Beta #AutoIt3Wrapper_UseUpx=n #AutoIt3Wrapper_Compile_Both=y #AutoIt3Wrapper_UseX64=y #EndRegion Dim $MainLog = @ScriptDir &amp; <span class="hljs-string"><span class="hljs-string">"\test_service.log"</span></span> #include &lt;services.au3&gt; #include &lt;WindowsConstants.au3&gt; $sServiceName=<span class="hljs-string"><span class="hljs-string">"WebServ"</span></span> If $cmdline[<span class="hljs-number"><span class="hljs-number">0</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> Then Switch $cmdline[<span class="hljs-number"><span class="hljs-number">1</span></span>] Case <span class="hljs-string"><span class="hljs-string">"install"</span></span>, <span class="hljs-string"><span class="hljs-string">"-i"</span></span>, <span class="hljs-string"><span class="hljs-string">"/i"</span></span> InstallService() Case <span class="hljs-string"><span class="hljs-string">"remove"</span></span>, <span class="hljs-string"><span class="hljs-string">"-u"</span></span>, <span class="hljs-string"><span class="hljs-string">"/u"</span></span>, <span class="hljs-string"><span class="hljs-string">"uninstall"</span></span> RemoveService() Case Else ConsoleWrite(<span class="hljs-string"><span class="hljs-string">" - - - Help - - - "</span></span> &amp; @CRLF) ConsoleWrite(<span class="hljs-string"><span class="hljs-string">"params : "</span></span> &amp; @CRLF) ConsoleWrite(<span class="hljs-string"><span class="hljs-string">" -i : install service"</span></span> &amp; @CRLF) ConsoleWrite(<span class="hljs-string"><span class="hljs-string">" -u : remove service"</span></span> &amp; @CRLF) ConsoleWrite(<span class="hljs-string"><span class="hljs-string">" - - - - - - - - "</span></span> &amp; @CRLF) Exit EndSwitch Else _Service_init($sServiceName) Exit EndIf Func _main($iArg, $sArgs) If Not _Service_ReportStatus($SERVICE_RUNNING, $NO_ERROR, <span class="hljs-number"><span class="hljs-number">0</span></span>) Then _Service_ReportStatus($SERVICE_STOPPED, _WinAPI_GetLastError(), <span class="hljs-number"><span class="hljs-number">0</span></span>) Exit EndIf $bServiceRunning = True $PID=Run(<span class="hljs-string"><span class="hljs-string">"C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -ExecutionPolicy Bypass -NoProfile -File C:\temp\Polaris\server.ps1"</span></span>) While $bServiceRunning _sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>) WEnd ProcessClose($PID) _Service_ReportStatus($SERVICE_STOP_PENDING, $NO_ERROR, <span class="hljs-number"><span class="hljs-number">1000</span></span>) DllCallbackFree($tServiceMain) DllCallbackFree($tServiceCtrl) _Service_ReportStatus($SERVICE_STOPPED, $NO_ERROR, <span class="hljs-number"><span class="hljs-number">0</span></span>) DllClose($hAdvapi32_DLL) DllClose($hKernel32_DLL) EndFunc Func _Sleep($delay) Local $result = DllCall($hKernel32_DLL, <span class="hljs-string"><span class="hljs-string">"none"</span></span>, <span class="hljs-string"><span class="hljs-string">"Sleep"</span></span>, <span class="hljs-string"><span class="hljs-string">"dword"</span></span>, $delay) EndFunc Func InstallService() #RequireAdmin Local $bDebug = True If $cmdline[<span class="hljs-number"><span class="hljs-number">0</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> Then $sServiceName = $cmdline[<span class="hljs-number"><span class="hljs-number">2</span></span>] EndIf If $bDebug Then ConsoleWrite(<span class="hljs-string"><span class="hljs-string">"InstallService("</span></span>&amp;$sServiceName &amp;<span class="hljs-string"><span class="hljs-string">"): Installing service, please wait"</span></span>) _Service_Create($sServiceName, $sServiceName, $SERVICE_WIN32_OWN_PROCESS, $SERVICE_AUTO_START, $SERVICE_ERROR_SEVERE, <span class="hljs-string"><span class="hljs-string">'"'</span></span> &amp; @ScriptFullPath &amp; <span class="hljs-string"><span class="hljs-string">'"'</span></span>);,<span class="hljs-string"><span class="hljs-string">""</span></span>,False,<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-string"><span class="hljs-string">"NT AUTHORITY\NetworkService"</span></span>) If @error Then Msgbox(<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-string"><span class="hljs-string">"InstallService(): Problem installing service, Error number is "</span></span> &amp; @error &amp; @CRLF &amp; <span class="hljs-string"><span class="hljs-string">" message : "</span></span> &amp; _WinAPI_GetLastErrorMessage()) Else If $bDebug Then ConsoleWrite(<span class="hljs-string"><span class="hljs-string">"InstallService(): Installation of service successful"</span></span>) EndIf Exit EndFunc Func RemoveService() _Service_Stop($sServiceName) _Service_Delete($sServiceName) If Not @error Then EndIf Exit EndFunc Func _exit() _Service_ReportStatus($SERVICE_STOPPED, $NO_ERROR, <span class="hljs-number"><span class="hljs-number">0</span></span>); EndFunc Func StopTimer() _Service_ReportStatus($SERVICE_STOP_PENDING, $NO_ERROR, $iServiceCounter) $iServiceCounter += <span class="hljs-number"><span class="hljs-number">-100</span></span> EndFunc Func _Stopping() _Service_ReportStatus($SERVICE_STOP_PENDING, $NO_ERROR, <span class="hljs-number"><span class="hljs-number">3000</span></span>) EndFunc</code> </pre> </div></div><br><p>  J'analyserai plus en détail le moment du lancement de l'application.  Il démarre après l'opération <strong>$ bServiceRunning = True</strong> et se transforme en une boucle apparemment infinie.  En fait, ce processus sera interrompu dès que le service recevra un signal d'achèvement - qu'il se déconnecte ou s'arrête manuellement. </p><br><p>  Étant donné que le programme pour le script est externe (powershell.exe), après avoir quitté la boucle, nous devons terminer son travail en utilisant <strong>ProcessClose</strong> . </p><br><p>  Pour ce faire, le script doit être compilé en <strong>.exe</strong> , puis installer le service en exécutant exe avec le commutateur <strong>-i.</strong> </p><br><p><img src="https://habrastorage.org/webt/wl/xp/ph/wlxpphvp20lakbyd2wii7ssytle.jpeg"><br>  <em>Ça marche!</em> </p><br><p>  Bien sûr, cette méthode n'est pas la plus pratique et toutes les fonctionnalités supplémentaires devront être implémentées indépendamment, qu'il s'agisse de redémarrer l'application en cas d'échec ou de rotation du journal.  Mais il donne un contrôle total sur ce qui se passe.  Et à la fin, vous pouvez faire beaucoup plus - de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">notifier</a> Telegram en cas d'échec de service à l'interaction IPC avec d'autres programmes.  Et en plus - dans un langage de script, sans installer ni apprendre Visual Studio. </p><br><p>  Dites-nous, avez-vous dû transformer des scripts et des applications en services? </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr421019/">https://habr.com/ru/post/fr421019/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr421005/index.html">Assuré REST: Conseils utiles</a></li>
<li><a href="../fr421007/index.html">Magnétophone - un outil pour enregistrer les autotests</a></li>
<li><a href="../fr421009/index.html">25 et 26 août: conférence en ligne sur la gestion opérationnelle</a></li>
<li><a href="../fr421011/index.html">Questions à l'entrevue que vous pensez stupides. Mais pas vraiment</a></li>
<li><a href="../fr421015/index.html">Enquête de durabilité 2018 des segments Internet nationaux</a></li>
<li><a href="../fr421021/index.html">Google Hadoop Review (dataproc)</a></li>
<li><a href="../fr421023/index.html">Schizophrénie d'entreprise</a></li>
<li><a href="../fr421025/index.html">7 pare-feu gérés puissants pour protéger votre infrastructure cloud</a></li>
<li><a href="../fr421027/index.html">SDMX (échange de données statistiques et de métadonnées)</a></li>
<li><a href="../fr421029/index.html">Comment augmenter le débit des magasins et se débarrasser des files d'attente</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>