<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>â‰ï¸ ğŸ¤µ ğŸ“ƒ é‚®ç®±ä¸­çš„è›‡å’ŒFï¼ƒæœ‰ä»€ä¹ˆä½œç”¨ ğŸ§‘ğŸ¾â€ğŸ¤â€ğŸ§‘ğŸ» â†—ï¸ ğŸ¤µğŸ¼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="è¿™æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ 


 éƒ½æ˜¯å…³äºè›‡çš„ã€‚ æ¯ä¸ªäººéƒ½è®°å¾—è›‡æ˜¯ä»€ä¹ˆï¼šè›‡åœ¨çŸ©å½¢åŒºåŸŸä¸Šç§»åŠ¨ã€‚ æ‰¾åˆ°é£Ÿç‰©-é•¿å¤§ï¼Œå‘ç°è‡ªå·±æˆ–ç”°é‡è¾¹ç¼˜-æ­»äº¡ã€‚ ç”¨æˆ·åªèƒ½å‘é€å‘½ä»¤ï¼šå·¦ï¼Œå³ï¼Œä¸Šï¼Œä¸‹ã€‚ 
 æˆ‘å†³å®šåœ¨è¿™é‡Œæ·»åŠ ä¸€äº›åŠ¨ä½œï¼Œä½¿è›‡ä»åƒè±†å­é€ƒèµ°ã€‚ è€Œè¿™ä¸€åˆ‡éƒ½åœ¨æ¼”å‘˜èº«ä¸Šï¼ 


å› æ­¤ï¼Œä»Šå¤©ï¼Œæˆ‘å°†ä»¥è›‡ä¸ºä¾‹ï¼Œè®¨è®ºå¦‚ä½•ä½¿ç”¨æ ‡å‡†åº“ä¸­çš„Mail...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>é‚®ç®±ä¸­çš„è›‡å’ŒFï¼ƒæœ‰ä»€ä¹ˆä½œç”¨</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/424861/"><h4 id="o-chem-eto-vse"> è¿™æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ </h4><br><p> éƒ½æ˜¯å…³äºè›‡çš„ã€‚ æ¯ä¸ªäººéƒ½è®°å¾—è›‡æ˜¯ä»€ä¹ˆï¼šè›‡åœ¨çŸ©å½¢åŒºåŸŸä¸Šç§»åŠ¨ã€‚ æ‰¾åˆ°é£Ÿç‰©-é•¿å¤§ï¼Œå‘ç°è‡ªå·±æˆ–ç”°é‡è¾¹ç¼˜-æ­»äº¡ã€‚ ç”¨æˆ·åªèƒ½å‘é€å‘½ä»¤ï¼šå·¦ï¼Œå³ï¼Œä¸Šï¼Œä¸‹ã€‚ <br> æˆ‘å†³å®šåœ¨è¿™é‡Œæ·»åŠ ä¸€äº›åŠ¨ä½œï¼Œä½¿è›‡ä»åƒè±†å­é€ƒèµ°ã€‚ è€Œè¿™ä¸€åˆ‡éƒ½åœ¨æ¼”å‘˜èº«ä¸Šï¼ </p><br><p>å› æ­¤ï¼Œä»Šå¤©ï¼Œæˆ‘å°†ä»¥è›‡ä¸ºä¾‹ï¼Œè®¨è®ºå¦‚ä½•ä½¿ç”¨æ ‡å‡†åº“ä¸­çš„<code>MailboxProcessor</code>æ„å»ºactoræ¨¡å‹ï¼Œè¦æŸ¥æ‰¾çš„è¦ç‚¹ä»¥åŠå¯èƒ½é‡åˆ°çš„é™·é˜±ã€‚ </p><br><p> æ­¤å¤„ç¼–å†™çš„ä»£ç å¹¶ä¸å®Œç¾ï¼Œå¯èƒ½è¿åæŸäº›åŸåˆ™ï¼Œå¹¶ä¸”å¯èƒ½ä¼šæ›´å¥½åœ°ç¼–å†™ã€‚ ä½†æ˜¯ï¼Œå¦‚æœæ‚¨æ˜¯åˆå­¦è€…å¹¶ä¸”æƒ³å¤„ç†é‚®ç®±-å¸Œæœ›æœ¬æ–‡å¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ã€‚ <br> å¦‚æœæ‚¨åœ¨æ²¡æœ‰æˆ‘çš„æƒ…å†µä¸‹äº†è§£æ‰€æœ‰æœ‰å…³é‚®ç®±çš„ä¿¡æ¯ï¼Œé‚£ä¹ˆæ‚¨å¯èƒ½ä¼šè§‰å¾—æ— èŠã€‚ </p><br><h4 id="pochemu-aktory"> ä¸ºä»€ä¹ˆæ˜¯æ¼”å‘˜ï¼Ÿ </h4><br><p> ä¸ºäº†ç»ƒä¹ ã€‚ æˆ‘è¯»äº†æ¼”å‘˜çš„æ¨¡ç‰¹ï¼Œçœ‹äº†è§†é¢‘ï¼Œæˆ‘å–œæ¬¢ä¸€åˆ‡ï¼Œä½†æˆ‘è‡ªå·±æ²¡æœ‰å°è¯•ã€‚ ç°åœ¨æˆ‘å°è¯•äº†ã€‚ <br> å°½ç®¡äº‹å®ä¸Šæˆ‘ä¸ºæŠ€æœ¯è€Œé€‰æ‹©æŠ€æœ¯ï¼Œä½†è¿™ä¸€æ¦‚å¿µéå¸¸æˆåŠŸåœ°è½åœ¨äº†è¿™é¡¹ä»»åŠ¡ä¸Šã€‚ </p><br><h4 id="pochemu-mailboxprocessor-a-ne-naprimer-akkanet"> ä¸ºä»€ä¹ˆé€‰æ‹©MailboxProcessorï¼Œè€Œä¸é€‰æ‹©Akka.netï¼Ÿ </h4><br><p> å¯¹äºæˆ‘çš„ä»»åŠ¡ï¼Œ <code>MailboxProcessor</code>æ˜¯éº»é›€ä»è½¨é“ç«™æ¥çš„ï¼Œ <code>MailboxProcessor</code>æ›´ä¸ºç®€å•ï¼Œå®ƒæ˜¯æ ‡å‡†åº“çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤æ‚¨æ— éœ€è¿æ¥ä»»ä½•ç¨‹åºåŒ…ã€‚ </p><a name="habracut"></a><br><h4 id="o-meylboks-processorah-i-soputsvuyuschem-boylerpleyte"> å…³äºé‚®ç®±å¤„ç†å™¨å’Œç›¸å…³æ ·æ¿ </h4><br><p> é‡ç‚¹å¾ˆç®€å•ã€‚ é‡Œé¢çš„é‚®ç®±æœ‰ä¸€ä¸ªæ¶ˆæ¯å¾ªç¯å’ŒæŸäº›çŠ¶æ€ã€‚ æ‚¨çš„æ¶ˆæ¯å¾ªç¯å°†æ ¹æ®æ”¶åˆ°çš„æ–°æ¶ˆæ¯æ¥æ›´æ–°æ­¤çŠ¶æ€ã€‚ </p><br><pre> <code class="hljs kotlin">let actor = MailboxProcessor.Start(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> inbox -&gt; // ,    //   . inbox --    MailboxProcessor let rec messageLoop oldState = async { //   let! msg = inbox.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Receive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-comment"><span class="hljs-comment">//    let newState = updateState oldState msg //      return! messageLoop newState } //       .    --     messageLoop (0,0) )</span></span></code> </pre> <br><p> è¯·æ³¨æ„<code>messageLoop</code>é€’å½’çš„ï¼Œæœ€åå¿…é¡»å†æ¬¡è°ƒç”¨å®ƒï¼Œå¦åˆ™ä»…å¤„ç†ä¸€æ¡æ¶ˆæ¯ï¼Œæ­¤å‚ä¸è€…å°†æ­»äº¡ã€‚  <code>messageLoop</code>ä¹Ÿæ˜¯å¼‚æ­¥çš„ï¼Œå¹¶ä¸”åœ¨æ”¶åˆ°æ–°æ¶ˆæ¯æ—¶æ‰§è¡Œæ¯ä¸ªåç»­è¿­ä»£ï¼š <code>let! msg = inbox.Receive()</code>  <code>let! msg = inbox.Receive()</code> ã€‚ <br> å› æ­¤ï¼Œæ•´ä¸ªé€»è¾‘è´Ÿè½½<code>updateState</code>å‡½æ•°æ‰¿æ‹…ï¼Œè¿™æ„å‘³ç€è¦åˆ›å»ºå¤„ç†å™¨çš„é‚®ç®±ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿æ„é€ å‡½æ•°æ¥å—çŠ¶æ€æ›´æ–°å‡½æ•°å’Œé›¶çŠ¶æ€ï¼š </p><br><pre> <code class="hljs haskell">//   applyMessage       //      (fun inbox -&gt; ...) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> buildActor applyMessage zeroState = <span class="hljs-type"><span class="hljs-type">MailboxProcessor</span></span>.<span class="hljs-type"><span class="hljs-type">Start</span></span>(fun inbox -&gt; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rec</span></span> loop state = async{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span>! msg = inbox.<span class="hljs-type"><span class="hljs-type">Receive</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> newState = applyMessage state msg return! loop newState } loop zeroState )</code> </pre><br><p> å¥½é…·ï¼ ç°åœ¨æˆ‘ä»¬ä¸éœ€è¦ç»å¸¸ç›‘è§†ï¼Œä»¥å…å¿˜è®°<code>return! loop newState</code>  <code>return! loop newState</code> ã€‚ å¦‚æ‚¨æ‰€çŸ¥ï¼Œactorå­˜å‚¨ä¸€ä¸ªçŠ¶æ€ï¼Œä½†æ˜¯ç°åœ¨å®Œå…¨ä¸æ¸…æ¥šå¦‚ä½•ä»å¤–éƒ¨è·å–è¯¥çŠ¶æ€ã€‚ å¤„ç†å™¨çš„é‚®ç®±å…·æœ‰<code>PostAndReply</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥å—<code>AsyncReplyChannel&lt;'Reply&gt; -&gt; 'Msg</code>å‡½æ•°ã€‚ æœ€åˆï¼Œå®ƒä½¿æˆ‘é™·å…¥åƒµå±€-å®Œå…¨ä¸æ¸…æ¥šä»ä½•å¤„è·å¾—æ­¤åŠŸèƒ½ã€‚ ä½†å®é™…ä¸Šï¼Œä¸€åˆ‡éƒ½å˜å¾—æ›´ç®€å•ï¼šæ‰€æœ‰æ¶ˆæ¯éƒ½å¿…é¡»åŒ…è£…åœ¨DUåŒ…è£…å™¨ä¸­ï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨å¯¹actorè¿›è¡Œäº†2ç§æ“ä½œï¼šå‘é€æ¶ˆæ¯æœ¬èº«å¹¶è¯¢é—®å½“å‰çŠ¶æ€ã€‚ çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š </p><br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/     . /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Mail&lt;_,_&gt;   ,  Post &amp; Get --  . /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ F#       , /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   compare &amp; equals . /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/         --   . /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   [&lt;Struct&gt;] .       type Mail&lt;'msg, 'state&gt; = | Post of 'msg | Get of AsyncReplyChannel&lt;'state&gt;</span></span></code> </pre> <br><p> ç°åœ¨ï¼Œæˆ‘ä»¬çš„æ„é€ å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="hljs erlang-repl">let buildActor applyMessage zeroState = MailboxProcessor.Start(fun inbox -&gt; let rec loop state = async{ let! msg = inbox.Receive() //    ,     // .    -- ,     //     . //     --      //    .      ! match msg with | Post msg -&gt; let newState = applyMessage state msg return! loop newState | Get channel -&gt; channel.Reply state return! loop state } loop zeroState )</code> </pre><br><p> ç°åœ¨ï¼Œè¦ä½¿ç”¨é‚®ç®±ï¼Œæˆ‘ä»¬éœ€è¦å°†æ‰€æœ‰æ¶ˆæ¯åŒ…è£…åœ¨æ­¤<code>Mail.Post</code> ã€‚ ä¸ºäº†é¿å…æ¯æ¬¡éƒ½ç¼–å†™æ­¤ä»£ç ï¼Œæœ€å¥½å°†å…¶åŒ…è£…åœ¨ä¸€ä¸ªå°åº”ç”¨ç¨‹åºä¸­ï¼š </p><br><pre> <code class="hljs coffeescript"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span> Mailbox = let buildAgent applyMessage zeroState = MailboxProcessor.Start(fun inbox -&gt; let rec <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> state = async{ let! msg = inbox.Receive() match msg with | Post msg -&gt; let newState = applyMessage state msg <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>! <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> newState | Get channel -&gt; channel.Reply state <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>! <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> state } <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> zeroState ) let post (agent: MailboxProcessor&lt;_&gt;) msg = Post msg |&gt; agent.Post let getState (agent: MailboxProcessor&lt;_&gt;) = agent.PostAndReply Get let getStateAsync (agent: MailboxProcessor&lt;_&gt;) = agent.PostAndAsyncReply Get <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   Single Case Discriminated Union. <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> MailboxProcessor   API.      , <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  -  ,  ,      <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   .       ,     <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>        . type MailAgent&lt;<span class="hljs-string"><span class="hljs-string">'msg, '</span></span>state&gt; = MailAgent <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> address:string * mailbox:MailboxProcessor&lt;Mail&lt;<span class="hljs-string"><span class="hljs-string">'msg, '</span></span>state&gt;&gt; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     API with member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Post msg = <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>            let (MailAgent (address,<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)) = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Mailbox.post <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> msg member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.GetState() = let (MailAgent (address,<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)) = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Mailbox.getState <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.GetStateAsync() = let (MailAgent (address,<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)) = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Mailbox.getStateAsync <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Address = let (MailAgent (address, _)) = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> address member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Dispose() = let (MailAgent (_, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)) = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> (this:&gt;IDisposable).Dispose() interface IDisposable with member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Dispose() = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Dispose()</code> </pre> <br><p> æˆ‘å°†å‘Šè¯‰æ‚¨ä»€ä¹ˆ<code>address:string</code>ç¨æ™šä¸€äº›ï¼Œä½†æ˜¯ç°åœ¨æˆ‘ä»¬çš„æ ·æ¿å·²ç»å‡†å¤‡å¥½ã€‚ </p><br><h4 id="sobstvenno-zmeyka"> å…¶å®è›‡ </h4><br><p> åœ¨è›‡ä¸­ï¼Œæœ‰ä¸€æ¡è›‡ï¼Œä¸€ä¸ªå¸¦æœ‰å‘½ä»¤çš„ç”¨æˆ·ï¼Œä¸€ä¸ªå­—æ®µå’Œåˆ°ä¸‹ä¸€å¸§çš„å¸¸è§„è¿‡æ¸¡ã€‚ <br> è¿™ä¸€åˆ‡éƒ½åœ¨ä¸€èµ·ï¼Œéœ€è¦æˆ‘ä»¬çš„æ¼”å‘˜ä»¬å¼„è„ã€‚ <br> æˆ‘çš„åˆå§‹å¸ƒå±€å¦‚ä¸‹ï¼š </p><br><ul><li> æ¼”å‘˜ä¸è®¡æ—¶å™¨ã€‚ æ¥å—å¼€å§‹/åœæ­¢/æš‚åœæ¶ˆæ¯ã€‚ æ¯næ¯«ç§’ï¼Œå°†<code>Flush</code>æ¶ˆæ¯å‘é€ç»™<code>Flush</code>å‚ä¸è€…ã€‚ å°†<code>System.Timers.Timer</code>å­˜å‚¨ä¸ºçŠ¶æ€ </li><li> æ¼”å‘˜å›¢é˜Ÿã€‚ æ¥æ”¶æ¥è‡ªç”¨æˆ·çš„æ¶ˆæ¯ï¼ŒåŒ…æ‹¬ä¸Š<code>Move Up/Down/Left/Right</code> ï¼Œ <code>AddPerk Speed/Attack</code> ï¼ˆæ˜¯çš„ï¼Œæˆ‘çš„è›‡å¯ä»¥å¿«é€Ÿçˆ¬ç½‘å’Œæ”»å‡»å°äººï¼‰å’Œè®¡æ—¶å™¨<code>Flush</code> ã€‚ å®ƒå­˜å‚¨å‘½ä»¤åˆ—è¡¨ä½œä¸ºçŠ¶æ€ï¼Œå¹¶é€šè¿‡åˆ·æ–°æ¸…é™¤æ­¤åˆ—è¡¨ã€‚ </li><li> æ¼”å‘˜æ˜¯è›‡ã€‚ å®ƒå­˜å‚¨è›‡çš„çŠ¶æ€-ç‰¹æƒï¼Œé•¿åº¦ï¼Œæ–¹å‘ï¼Œå¼¯æ›²å’Œåæ ‡ã€‚ <br> å½“å‘ç°é£Ÿç‰©æ—¶ï¼Œå®ƒä¼šæ¥æ”¶æ¥è‡ªå‘½ä»¤æ‰§è¡Œè€…çš„æ¶ˆæ¯åˆ—è¡¨ï¼Œ <code>Tick</code>æ¶ˆæ¯ï¼ˆå‘å‰ç§»åŠ¨è›‡1ä¸ªå•å…ƒæ ¼ï¼‰å’Œæ¥è‡ªå­—æ®µæ‰§è¡Œè€…çš„<code>GrowUp</code>æ¶ˆæ¯ã€‚ </li><li> é¢†åŸŸçš„æ¼”å‘˜ã€‚ å®ƒå­˜å‚¨ç»†èƒå›¾ï¼Œåœ¨æ¶ˆæ¯ä¸­è·å–è›‡çš„çŠ¶æ€ï¼Œå¹¶åœ¨ç°æœ‰å›¾ç‰‡ä¸Šç»˜åˆ¶åæ ‡ã€‚ å¦‚æœæ¸¸æˆç»“æŸï¼Œå®ƒè¿˜ä¼šå°†<code>GrowUp</code>å‘é€<code>GrowUp</code>è›‡æ¼”å‘˜ï¼Œå¹¶å°†<code>Stop</code>å‘½ä»¤å‘é€ç»™è®¡æ—¶å™¨ã€‚ </li></ul><br><p> å¦‚æ‚¨æ‰€è§ï¼Œå³ä½¿åªæœ‰è¿™ä¹ˆå°‘çš„å®ä½“ï¼Œæ¶ˆæ¯æ˜ å°„ä¹Ÿå·²ç»å¾ˆé‡è¦äº†ã€‚ åœ¨è¿™ä¸ªé˜¶æ®µå·²ç»å‡ºç°äº†å›°éš¾ï¼šäº‹å®æ˜¯é»˜è®¤æƒ…å†µä¸‹Fï¼ƒä¸å…è®¸å¾ªç¯ä¾èµ–ã€‚ åœ¨å½“å‰ä»£ç è¡Œä¸­ï¼Œæ‚¨åªèƒ½ä½¿ç”¨ä¸Šé¢ç¼–å†™çš„ä»£ç ï¼Œå¹¶ä¸”å¯¹é¡¹ç›®ä¸­çš„æ–‡ä»¶ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ è¿™ä¸æ˜¯é”™è¯¯ï¼Œè€Œæ˜¯åŠŸèƒ½ï¼Œæˆ‘éå¸¸å–œæ¬¢å®ƒï¼Œå› ä¸ºå®ƒæœ‰åŠ©äºä¿æŒä»£ç æ•´æ´ï¼Œä½†æ˜¯å½“è®¾è®¡éœ€è¦å¾ªç¯é“¾æ¥æ—¶è¯¥æ€ä¹ˆåŠï¼Ÿ å½“ç„¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<code>rec namespace</code> -ç„¶ååœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œæ‚¨å¯ä»¥å¼•ç”¨æ­¤æ–‡ä»¶ä¸­ä½¿ç”¨çš„æ‰€æœ‰å†…å®¹ã€‚ <br> é¢„è®¡ä»£ç ä¼šå¼„ä¹±ï¼Œä½†éšåä¼¼ä¹æ˜¯å”¯ä¸€çš„é€‰æ‹©ã€‚ è€Œä¸”æœ‰æ•ˆã€‚ </p><br><h4 id="problema-vneshnego-mira"> å¤–ç•Œçš„é—®é¢˜ </h4><br><p> åªè¦æ¼”å‘˜çš„æ•´ä¸ªç³»ç»Ÿéƒ½ä¸å¤–ç•Œéš”ç¦»ï¼Œä¸€åˆ‡éƒ½å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œè€Œæˆ‘åªåœ¨æ§åˆ¶å°ä¸­è¿›è¡Œè„±çº¿å’Œæ˜¾ç¤ºçº¿æ¡ã€‚ å½“éœ€è¦ä»¥<code>updateUI</code>å‡½æ•°çš„å½¢å¼å®ç°ä¾èµ–å…³ç³»æ—¶ï¼ˆåº”è¯¥ä¸ºæ¯ä¸ªåˆ»åº¦é‡æ–°ç»˜åˆ¶ï¼‰ï¼Œæˆ‘æ— æ³•åœ¨å½“å‰å®ç°ä¸­è§£å†³æ­¤é—®é¢˜ã€‚ æ—¢ä¸ä¸‘ä¹Ÿä¸ç¾-æ²¡åŠæ³•ã€‚ ç„¶åæˆ‘æƒ³èµ·äº†akku-æ¯•ç«Ÿï¼Œæ‚¨å¯ä»¥åœ¨æ­¤è¿‡ç¨‹ä¸­ç”Ÿæˆæ¼”å‘˜ï¼Œå¹¶ä¸”åœ¨ç¼–è¯‘é˜¶æ®µå°†æ‰€æœ‰æ¼”å‘˜ä»‹ç»ç»™æˆ‘ã€‚ <br> è§£å†³æ–¹æ¡ˆå¾ˆæ˜æ˜¾-ä½¿ç”¨akkuï¼ ä¸ï¼Œå½“ç„¶ï¼ŒAkkaä»ç„¶è¿‡é«˜ï¼Œä½†æ˜¯æˆ‘å†³å®šä»é‚£é‡Œèˆ”ä¸€äº›è§‚ç‚¹-å³åˆ›å»ºä¸€ä¸ªactorç³»ç»Ÿï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸­åŠ¨æ€æ·»åŠ æ–°actorå¹¶åœ¨è¯¥åœ°å€æŸ¥è¯¢ç°æœ‰actorã€‚ <br> ç”±äºç°åœ¨åœ¨è¿è¡Œæ—¶ä¸­æ·»åŠ å’Œåˆ é™¤è§’è‰²ï¼Œä½†é€šè¿‡åœ°å€è€Œä¸æ˜¯ç›´æ¥é“¾æ¥æ¥è·å–è§’è‰²ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æä¾›ä¸€ç§æ–¹æ¡ˆï¼Œå…¶ä¸­åœ°å€çœ‹èµ·æ¥ä¸å­˜åœ¨è€Œè§’è‰²ä¸åœ¨é‚£é‡Œã€‚ æŒ‰ç…§åŒä¸€accaçš„ç¤ºä¾‹ï¼Œæˆ‘æ·»åŠ äº†ä¸€ä¸ªç”¨äºå­˜æ”¾æ­»ä¿¡çš„æ¡†ï¼Œå¹¶é€šè¿‡æˆ‘æœ€å–œæ¬¢çš„DUè®¾è®¡äº†å®ƒï¼š </p><br><pre> <code class="hljs coffeescript"><span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Agent&lt;_,_&gt; --  ,   ,     <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     ,      . <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      ,    --    Box (mailagent), <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ,       ,   ,   , <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>       Deadbox.      MailAgent,  . <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>           . <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    --    . type Agent&lt;<span class="hljs-string"><span class="hljs-string">'message,'</span></span>state&gt; = | Box <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> MailAgent&lt;<span class="hljs-string"><span class="hljs-string">'message,'</span></span>state&gt; | DeadBox <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> string * MailAgent&lt;string * obj, Map&lt;string,obj list&gt;&gt; with member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Post msg = match <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> with | Box box -&gt; box.Post msg | DeadBox (address, deadbox) -&gt; (address, box msg) |&gt; deadbox.Post interface IDisposable with member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Dispose() = match <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> with | Box agent -&gt; agent.Dispose() | DeadBox (_,agent) -&gt; agent.Dispose()</code> </pre> <br><p> ç³»ç»Ÿæœ¬èº«çœ‹èµ·æ¥åƒè¿™æ ·ï¼š </p><br><pre> <code class="hljs coffeescript"><span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    .     --    . type MailboxNetwork() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> = <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      .   ! [&lt;DefaultValue&gt;] val mutable agentRegister: ConcurrentDictionary&lt;string, obj&gt; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.agentRegister &lt;- ConcurrentDictionary&lt;string, obj&gt;() <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      , <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    Map --     let deadLettersFn deadLetters (address:string, msg:obj) = printfn <span class="hljs-string"><span class="hljs-string">"Deadletter: %s-%A"</span></span> address msg match Map.tryFind address deadLetters with <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   | None -&gt; Map.add address [msg] deadLetters <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   --   | Some letters -&gt; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  --      Map.remove address deadLetters |&gt; Map.add address (msg::letters) let deadLettersAgent() = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"deadLetters"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Map.empty |&gt; Mailbox.buildAgent deadLettersFn)</span></span></span><span class="hljs-function"> |&gt; MailAgent member this.DeadLetters = deadLettersAgent</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> // -     ,      member this.Box&lt;'message,'state&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address)</span></span></span><span class="hljs-function"> = match this.agentRegister.TryGetValue address with | </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">true</span></span></span></span><span class="hljs-function"><span class="hljs-params">, agent)</span></span></span><span class="hljs-function"> when </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(agent :? MailAgent&lt;</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'message,'</span></span></span></span><span class="hljs-function"><span class="hljs-params">state&gt;)</span></span></span><span class="hljs-function"> -&gt;</span></span> <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ,       ,   let agent = agent :?&gt; MailAgent&lt;<span class="hljs-string"><span class="hljs-string">'message, '</span></span>state&gt; Box agent | _ -&gt; DeadBox (address, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.DeadLetters) <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  --    member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.KillBox address = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.agentRegister.TryRemove(address) |&gt; ignore member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.RespawnBox (agent: MailAgent&lt;<span class="hljs-string"><span class="hljs-string">'a,'</span></span>b&gt;) = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.KillBox agent.Address <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.agentRegister.TryAdd (agent.Address, agent) |&gt; ignore interface IDisposable with member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Dispose() = <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> agent <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.agentRegister.Values <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> match agent with | :? IDisposable <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> agent -&gt; agent.Dispose() | _ -&gt; ()</code> </pre> <br><p> è¿™æ˜¯æˆ‘ä¸Šé¢å†™è¿‡çš„ç›¸åŒ<code>address:string</code>æ´¾ä¸Šç”¨åœºçš„åœ°æ–¹ã€‚ å†æ¬¡å¥æ•ˆï¼Œç°åœ¨å¤–éƒ¨ä¾å­˜å…³ç³»å¾ˆå®¹æ˜“åˆ°è¾¾æ‚¨éœ€è¦çš„ä½ç½®ã€‚ å‚ä¸è€…çš„æ„é€ å‡½æ•°ç°åœ¨æ¥å—äº†å‚ä¸è€…ç³»ç»Ÿä½œä¸ºå‚æ•°ï¼Œå¹¶ä»é‚£é‡Œè·å¾—äº†å¿…è¦çš„åœ°å€ï¼š </p><br><pre> <code class="hljs haskell"> //    - (  )   - <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gameAgent (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) = mailboxNetwork.<span class="hljs-type"><span class="hljs-type">Box</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Command</span></span> list, <span class="hljs-type"><span class="hljs-type">GameState</span></span>&gt;(gameAddress) //    message loop           <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> commandAgentFn (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) commands msg = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gameAgent = gameAgent mailboxNetwork match msg with | <span class="hljs-type"><span class="hljs-type">Cmd</span></span> cmd -&gt; cmd::commands | <span class="hljs-type"><span class="hljs-type">Flush</span></span> -&gt; commands |&gt; gameAgent.<span class="hljs-type"><span class="hljs-type">Post</span></span> []</code> </pre><br><h4 id="medlenno"> æ…¢æ…¢åœ° </h4><br><p> å‡ºäºæ˜æ˜¾çš„åŸå› ï¼Œåœ¨è°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œæˆ‘å°†æ¸¸æˆè®¾ç½®ä¸ºä½é€Ÿè¿è¡Œï¼šæ»´ç­”ä¹‹é—´çš„å»¶è¿Ÿè¶…è¿‡500æ¯«ç§’ã€‚ å¦‚æœå°†å»¶è¿Ÿå‡å°‘åˆ°200ï¼Œåˆ™æ¶ˆæ¯å¼€å§‹å»¶è¿Ÿåˆ°è¾¾ï¼Œå¹¶ä¸”ç”¨æˆ·å›¢é˜Ÿå»¶è¿Ÿå·¥ä½œï¼Œè¿™ç ´åäº†æ•´ä¸ªæ¸¸æˆã€‚ ç¾ä¸­ä¸è¶³çš„æ˜¯è®¡æ—¶å™¨å¤šæ¬¡ä¸¢å¤±æ—¶ï¼Œè®¡æ—¶å™¨ä¼šæ”¶åˆ°åœæ­¢å‘½ä»¤ã€‚ å¯¹äºç”¨æˆ·è€Œè¨€ï¼Œè¿™ä¸æ¯«æ²¡æœ‰å‡ºç°ï¼Œä½†æ˜¯ä»ç„¶å­˜åœ¨æŸç§é”™è¯¯ã€‚ <br> ä»¤äººä¸æ„‰å¿«çš„äº‹å®æ˜¯ï¼Œå‚ä¸è€…å½“ç„¶å¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯ç›´æ¥æ–¹æ³•è°ƒç”¨è¦å¿«å¾—å¤šã€‚ å› æ­¤ï¼Œå°½ç®¡ä»ç»„ç»‡ä»£ç çš„è§’åº¦æ¥çœ‹ï¼Œå°†è›‡æœ¬èº«å­˜å‚¨åœ¨å•ç‹¬çš„è§’è‰²ä¸­å¾ˆæ–¹ä¾¿ï¼Œä½†æˆ‘è¿˜æ˜¯ä¸å¾—ä¸ä»¥é€Ÿåº¦ä¸ºåæ”¾å¼ƒè¿™ä¸ªæƒ³æ³•ï¼Œå› ä¸ºå¯¹äºæ¸¸æˆçš„1ä¸ªæ—¶é’Ÿè€Œè¨€ï¼Œæ¶ˆæ¯ä¼ é€’å¤ªæ¿€çƒˆäº†ï¼š </p><br><ol><li> ç”¨æˆ·ç›´æ¥å°†ä»»æ„æ•°é‡çš„å‘½ä»¤å‘é€åˆ°å‘½ä»¤æ‰§è¡Œè€…ã€‚ </li><li> è®¡æ—¶å™¨å°†æ»´ç­”å£°å‘é€ç»™å›¢é˜Ÿæ¼”å‘˜ï¼Œåœ¨æ—©æœŸå®ç°ä¸­è¿˜å‘é€ç»™è›‡æ¼”å‘˜ï¼Œä»¥ä¾¿ä»–å°†è›‡ç§»åˆ°ä¸‹ä¸€ä¸ªå•å…ƒ </li><li> å½“ç›¸åº”çš„æ¶ˆæ¯æ¥è‡ªè®¡æ—¶å™¨æ—¶ï¼Œå‘½ä»¤æ‰§è¡Œè€…å‘é€è›‡çš„å‘½ä»¤åˆ—è¡¨ã€‚ </li><li> æ ¹æ®2ä¸ªä¸Šå±‚æ¶ˆæ¯æ›´æ–°äº†çŠ¶æ€çš„è›‡æ¼”å‘˜å°†çŠ¶æ€å‘é€ç»™ç°åœºæ¼”å‘˜ã€‚ </li><li> ç°åœºæ¼”å‘˜é‡ç”»äº†ä¸€åˆ‡ã€‚ å¦‚æœè›‡å‘ç°äº†é£Ÿç‰©ï¼Œé‚£ä¹ˆå®ƒå°†å‘è›‡æ¼”å‘˜å‘é€ä¸€æ¡<code>GrowUp</code>æ¶ˆæ¯ï¼Œæ­¤åä»–å°†æ–°çŠ¶æ€å‘é€å›ç”°é‡æ¼”å‘˜ã€‚ </li></ol><br><p> è€ƒè™‘åˆ°<code>MailboxProcessor</code>è‚ é“ä¸­çš„åŒæ­¥ï¼Œå¯¹äºæ‰€æœ‰è¿™ä¸€åˆ‡æ¥è¯´ï¼Œåªæœ‰1ä¸ªæ—¶é’Ÿå‘¨æœŸæ˜¯ä¸å¤Ÿçš„ã€‚ è€Œä¸”ï¼Œåœ¨å½“å‰çš„å®ç°ä¸­ï¼Œè®¡æ—¶å™¨æ¯éš”næ¯«ç§’å‘é€ä¸€æ¬¡ä¸‹ä¸€æ¡æ¶ˆæ¯ï¼Œæ— è®ºæ˜¯å¦å‘ç”Ÿä»»ä½•äº‹æƒ…ï¼Œå› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬æ²¡æœ‰è¿›è¡Œ1æ¬¡æµ‹é‡ï¼Œåˆ™æ¶ˆæ¯å¼€å§‹ç´¯ç§¯ï¼Œæƒ…å†µå˜å¾—æ›´ç³Ÿã€‚ æœ€å¥½â€œä¼¸å±•â€è¿™ä¸€ç‰¹å®šçš„æªæ–½ï¼Œå¤„ç†æ‰€æœ‰ç§¯ç´¯çš„ä¸œè¥¿ï¼Œç„¶åç»§ç»­å‰è¿›ã€‚ </p><br><h4 id="finalnaya-versiya"> æœ€ç»ˆç‰ˆæœ¬ </h4><br><p> æ˜¾ç„¶ï¼Œåº”è¯¥ç®€åŒ–æ¶ˆæ¯æ–¹æ¡ˆï¼ŒåŒæ—¶éå¸¸å¸Œæœ›ä½¿ä»£ç å°½å¯èƒ½ç®€å•ä¸”æ˜“äºè®¿é—®-ç›¸å¯¹è€Œè¨€ï¼Œæˆ‘ä¸æƒ³å°†æ‰€æœ‰å†…å®¹éƒ½æ¨ç»™ä¸€ä½ä¸Šå¸æ¼”å‘˜ï¼Œå› æ­¤æ¼”å‘˜ä¸­çš„æ„ä¹‰ä¸å¤§ã€‚ <br> å› æ­¤ï¼Œé€šè¿‡æŸ¥çœ‹æ¼”å‘˜åå•ï¼Œæˆ‘æ„è¯†åˆ°æœ€å¥½å…ˆç‰ºç‰²ä¸€ä¸ªè›‡æ¼”å‘˜ã€‚ éœ€è¦ä¸€ä¸ªè®¡æ—¶å™¨ï¼Œè¿˜éœ€è¦ä¸€ä¸ªç¼“å†²åŒºæ¥å®æ—¶ç§¯ç´¯ç”¨æˆ·å‘½ä»¤ï¼Œä½†æ˜¯æ¯æ‹ä¸€æ¬¡åªèƒ½å°†å…¶å€’å…¥ä¸€æ¬¡ï¼Œå¹¶ä¸”ä¸éœ€è¦å®¢è§‚åœ°å°†è›‡ä¿ç•™åœ¨å•ç‹¬çš„è§’è‰²ä¸­ï¼Œè¿™æ ·åšåªæ˜¯ä¸ºäº†æ–¹ä¾¿ã€‚ æ­¤å¤–ï¼Œé€šè¿‡å°†å…¶ä¸ç°åœºæ¼”å‘˜ä¿æŒåœ¨ä¸€èµ·ï¼Œå¯ä»¥ç«‹å³å¤„ç†<code>GrowUp</code>è„šæœ¬ã€‚ è›‡çš„<code>Tick</code>æ¶ˆæ¯ä¹Ÿæ²¡æœ‰å¤šå¤§æ„ä¹‰ï¼Œå› ä¸ºå½“æˆ‘ä»¬ä»å›¢é˜Ÿæ¼”å‘˜é‚£é‡Œæ”¶åˆ°æ¶ˆæ¯æ—¶ï¼Œè¿™å·²ç»æ„å‘³ç€å‘ç”Ÿäº†æ–°çš„èŠ‚æ‹ã€‚ æ­¤å¤–ï¼Œå¦‚æœæœ‰å»¶è¿Ÿï¼Œåˆ™å¯ä»¥å»¶é•¿èŠ‚æ‹ï¼Œæˆ‘ä»¬è¿›è¡Œäº†ä»¥ä¸‹æ›´æ”¹ï¼š </p><br><ol><li> æˆ‘ä»¬åˆ é™¤äº†â€œ <code>Tick</code>å’Œ<code>GrowUp</code>æ¶ˆæ¯ã€‚ </li><li> æˆ‘ä»¬å°†è›‡æ¼”å‘˜æ”¾åˆ°ç°åœºæ¼”å‘˜ä¸­-ä»–ç°åœ¨å°†å­˜å‚¨è¿™äº›å·çš„â€œ taplaâ€ã€‚ </li><li> æˆ‘ä»¬ä»è®¡æ—¶å™¨<code>System.Timers.Timer</code>åˆ é™¤<code>System.Timers.Timer</code> ã€‚ è€Œæ˜¯ï¼Œå·¥ä½œæ–¹æ¡ˆå¦‚ä¸‹ï¼šå½“ä»–æ”¶åˆ°â€œ <code>Start</code>å‘½ä»¤æ—¶ï¼Œä»–å°†â€œ <code>Flush</code>å‘é€<code>Flush</code>å›¢é˜Ÿæ¼”å‘˜ã€‚ ä»–å‘ç°åœº+è›‡æ¼”å‘˜å‘é€å‘½ä»¤åˆ—è¡¨ï¼Œæœ€åä¸€ä¸ªæ¼”å‘˜å¤„ç†æ‰€æœ‰è¿™ä¸€åˆ‡ï¼Œå¹¶å°†<code>Next</code>ä¸€æ¡æ¶ˆæ¯å‘é€ç»™è®¡æ—¶å™¨ï¼Œä»è€Œå‘ä»–è¯·æ±‚æ–°çš„æ»´ç­”å£°ã€‚ æ¥æ”¶åˆ°<code>Next</code>çš„è®¡æ—¶å™¨å°†ç­‰å¾…<code>Thread.Sleep(delay)</code>å¹¶é‡æ–°å¼€å§‹æ•´ä¸ªå¾ªç¯ã€‚ ä¸€åˆ‡éƒ½å¾ˆç®€å•ã€‚ </li></ol><br><p> æ€»ç»“ä¸€ä¸‹ã€‚ </p><br><ul><li> åœ¨å…ˆå‰çš„å®ç°ä¸­ï¼Œæœ€å°å…è®¸å»¶è¿Ÿä¸º500 msã€‚ åœ¨å½“å‰å»¶è¿Ÿä¸­ï¼Œæ‚¨å¯ä»¥å°†å…¶å®Œå…¨åˆ é™¤-ç°åœºæ¼”å‘˜å‡†å¤‡å°±ç»ªæ—¶å°†éœ€è¦æ–°çš„èŠ‚æ‹ã€‚ ä¸å†å¯èƒ½ä»ä»¥å‰çš„æªæ–½ä¸­æ”¶é›†åŸå§‹æ¶ˆæ¯ã€‚ </li><li> æ¶ˆæ¯æ˜ å°„å¤§å¤§ç®€åŒ–äº†-æˆ‘ä»¬æ‹¥æœ‰æœ€ç®€å•çš„å¾ªç¯ï¼Œè€Œä¸æ˜¯å¤æ‚çš„å›¾ã€‚ </li><li> è¿™ç§ç®€åŒ–è§£å†³äº†è®¡æ—¶å™¨ä¸¢å¤±æ—¶å¤šæ¬¡<code>Stop</code>çš„é”™è¯¯ã€‚ </li><li> æ¶ˆæ¯åˆ—è¡¨å·²å‡å°‘ã€‚ æ›´å°‘çš„ä»£ç -æ›´å°‘çš„é‚ªæ¶ï¼ </li></ul><br><p> çœ‹èµ·æ¥åƒè¿™æ ·ï¼š </p><br><pre> <code class="hljs haskell"> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> [&lt;<span class="hljs-type"><span class="hljs-type">Literal</span></span>&gt;] commandAddress = <span class="hljs-string"><span class="hljs-string">"command"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> [&lt;<span class="hljs-type"><span class="hljs-type">Literal</span></span>&gt;] timerAddress = <span class="hljs-string"><span class="hljs-string">"timer"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> [&lt;<span class="hljs-type"><span class="hljs-type">Literal</span></span>&gt;] gameAddress = <span class="hljs-string"><span class="hljs-string">"game"</span></span> // -     <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> commandAgent (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) = mailboxNetwork.<span class="hljs-type"><span class="hljs-type">Box</span></span>&lt;<span class="hljs-type"><span class="hljs-type">CommandMessage</span></span>, <span class="hljs-type"><span class="hljs-type">Command</span></span> list&gt;(commandAddress) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> timerAgent (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) = mailboxNetwork.<span class="hljs-type"><span class="hljs-type">Box</span></span>&lt;<span class="hljs-type"><span class="hljs-type">TimerCommand</span></span>, <span class="hljs-type"><span class="hljs-type">TimerState</span></span>&gt;(timerAddress) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gameAgent (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) = mailboxNetwork.<span class="hljs-type"><span class="hljs-type">Box</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Command</span></span> list, <span class="hljs-type"><span class="hljs-type">GameState</span></span>&gt;(gameAddress) // message loop   <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gameAgentFn (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) updateUi gameState cmd = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> timerAgent = timerAgent mailboxNetwork //    match gameState.gameFrame with //     | <span class="hljs-type"><span class="hljs-type">Frame</span></span> field -&gt; //       <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gameState = <span class="hljs-type"><span class="hljs-type">Game</span></span>.updateGameState gameState cmd timerAgent.<span class="hljs-type"><span class="hljs-type">Post</span></span> <span class="hljs-type"><span class="hljs-type">Next</span></span> //    updateUi gameState //     gameState // ! | <span class="hljs-type"><span class="hljs-type">End</span></span> (<span class="hljs-type"><span class="hljs-type">Win</span></span> _) -&gt; timerAgent.<span class="hljs-type"><span class="hljs-type">Post</span></span> <span class="hljs-type"><span class="hljs-type">PauseOrResume</span></span> <span class="hljs-type"><span class="hljs-type">Game</span></span>.updateGameState gameState cmd //        | _ -&gt; timerAgent.<span class="hljs-type"><span class="hljs-type">Post</span></span> <span class="hljs-type"><span class="hljs-type">Stop</span></span> //     gameState // message loop   <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> commandAgentFn (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) commands msg = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gameAgent = gameAgent mailboxNetwork match msg with | <span class="hljs-type"><span class="hljs-type">Cmd</span></span> cmd -&gt; cmd::commands //       | <span class="hljs-type"><span class="hljs-type">Flush</span></span> -&gt; commands |&gt; gameAgent.<span class="hljs-type"><span class="hljs-type">Post</span></span> //     [] // message loop   <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> timerAgentFn (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) (state: <span class="hljs-type"><span class="hljs-type">TimerState</span></span>) cmd = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> commandAgent = commandAgent mailboxNetwork match cmd with | <span class="hljs-type"><span class="hljs-type">Start</span></span> -&gt; commandAgent.<span class="hljs-type"><span class="hljs-type">Post</span></span> <span class="hljs-type"><span class="hljs-type">Flush</span></span>; {state with active = true} | <span class="hljs-type"><span class="hljs-type">Next</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> state.active <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> //    ,     <span class="hljs-type"><span class="hljs-type">Threading</span></span>.<span class="hljs-type"><span class="hljs-type">Thread</span></span>.<span class="hljs-type"><span class="hljs-type">Sleep</span></span>(state.delay) commandAgent.<span class="hljs-type"><span class="hljs-type">Post</span></span> <span class="hljs-type"><span class="hljs-type">Flush</span></span>; state | <span class="hljs-type"><span class="hljs-type">Stop</span></span> -&gt; printfn <span class="hljs-string"><span class="hljs-string">"Stop received"</span></span>; { state with active = false } | <span class="hljs-type"><span class="hljs-type">PauseOrResume</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> not state.active <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> //     <span class="hljs-comment"><span class="hljs-comment">--   commandAgent.Post Flush { state with active = not state.active } | SetDelay delay -&gt; Threading.Thread.Sleep(delay) if state.active then commandAgent.Post Flush {state with delay = delay}</span></span></code> </pre> <br><h4 id="ssylki"> å‚è€ƒæ–‡çŒ® </h4><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é‚®ç®±ç®€ä»‹</a> </li><li>  <a href="">æœ€å¥½å¥‡çš„é‚®ç®±èµ„æº</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ¼”å‘˜æ¨¡å‹çš„æºä»£ç </a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN424861/">https://habr.com/ru/post/zh-CN424861/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN424851/index.html">é›‡ç”¨ITæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ</a></li>
<li><a href="../zh-CN424853/index.html">ä¸€ä¸ªæƒ³è¦å¾ˆå¥½åœ°å±•ç¤ºçš„è§†å›¾æ§åˆ¶å™¨çš„æ•…äº‹</a></li>
<li><a href="../zh-CN424855/index.html">æœºå™¨å­¦ä¹ ï¼šä¸å¤§è±¡äº‰å¤º</a></li>
<li><a href="../zh-CN424857/index.html">CloudFlareå®æ–½çš„åŠ å¯†SNIæ”¯æŒ</a></li>
<li><a href="../zh-CN424859/index.html">å…·æœ‰1602æ˜¾ç¤ºå±çš„æœ€ç®€å•çš„Arduinoæ¸¸æˆ-ç¬¬1éƒ¨åˆ†</a></li>
<li><a href="../zh-CN424865/index.html">å‘ç°åŸºæœ¬è®¾è®¡ç²’å­</a></li>
<li><a href="../zh-CN424867/index.html">ä»å¤´å¼€å§‹å…­è¶³åŠ¨ç‰©çš„å¼€å‘ï¼ˆç¬¬1éƒ¨åˆ†ï¼‰-è®¾è®¡</a></li>
<li><a href="../zh-CN424869/index.html">æ–°çš„iOS 12åŠŸèƒ½å¦‚ä½•æé†’æˆ‘ç°åœ¨è¯¥'æ„ˆäº†</a></li>
<li><a href="../zh-CN424871/index.html">åŸƒéš†Â·é©¬æ–¯å…‹ï¼ˆElon Muskï¼‰å’Œç‰¹æ–¯æ‹‰ï¼ˆTeslaï¼‰ä¸ç¾å›½è¯åˆ¸äº¤æ˜“å§”å‘˜ä¼šå’Œè§£</a></li>
<li><a href="../zh-CN424873/index.html">NETä¸­HttpClientçš„é™·é˜±</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>