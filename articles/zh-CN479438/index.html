<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👄 🍆 🎰 Postgres-Tuesday＃5：“ PostgreSQL和Kubernetes。 CI / CD。 测试自动化» 🎅🏻 🎻 👯</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="去年年底，俄罗斯PostgreSQL社区#RuPostgres进行了另一场直播，其联合创始人Nikolai Samokhvalov与Flanta技术总监Dmitry Stolyarov在Kubernetes的背景下讨论了该DBMS。 

 我们正在发布本次讨论的主体成绩单，并在该社区的YouTube...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Postgres-Tuesday＃5：“ PostgreSQL和Kubernetes。 CI / CD。 测试自动化»</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/479438/"><img src="https://habrastorage.org/webt/qm/rm/ln/qmrmlnm8gjj_8gih4dzhy2ybrvy.jpeg"><br><br> 去年年底，俄罗斯PostgreSQL社区<a href="https://www.meetup.com/postgresqlrussia/">#RuPostgres进行了</a>另一场直播，其联合创始人Nikolai Samokhvalov与Flanta技术总监Dmitry Stolyarov在Kubernetes的背景下讨论了该DBMS。 <br><br> 我们正在发布本次讨论的主体成绩单，并<a href="https://www.youtube.com/channel/UC0SBGSNmBLrTZIkbN-lJHnw">在该社区的YouTube频道上</a>发布了完整的视频： <a name="habracut"></a><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/qXc9VTr4TFc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h2> 数据库和Kubernetes </h2><br>  <i><b>NS</b> ：我们今天不会谈论VACUUM和CHECKPOINT。</i>  <i>我们想谈谈Kubernetes。</i>  <i>我知道您有多年的经验。</i>  <i>我看了您的视频，甚至还看了其中的一些片段……让我们马上开始：为什么在K8s中使用Postgres或MySQL？</i> <br><br>  <b>DS</b> ：这个问题没有一个单一的答案，而且不可能。 但总的来说，它具有简单性和便利性……潜力。 毕竟，每个人都想要托管服务。 <br><br>  <i><b>NS</b> ：喜欢<a href="https://aws.amazon.com/rds/">RDS</a> ，只能在家吗？</i> <br><br>  <b>DS</b> ：是的，只喜欢RDS。 <br><br>  <i><b>NS</b> ：“任何地方”都是一个好主意。</i>  <i>在大型公司中，所有内容都位于不同的位置。</i>  <i>那么，如果这是一家大公司，为什么不采用现成的解决方案呢？</i>  <i>例如，Nutanix有自己的发展，而其他公司（VMware ...）具有相同的“仅在家中使用RDS”。</i> <br><br>  <b>DS</b> ：但是，我们谈论的是仅在某些条件下才能运行的单个实现。 而且，如果我们谈论的是Kubernetes，则基础设施种类繁多（可以在K8中使用）。 这本质上是云API的标准... <br><br>  <i><b>NS</b> ：它也是免费的！</i> <br><br>  <b>DS</b> ：这不是那么重要。 对于很大一部分市场来说，免费并不重要。 另一件事很重要……您可能还记得报告“ <a href="https://habr.com/ru/company/flant/blog/431500/">数据库和Kubernetes</a> ”？ <br><br>  <i><b>NS</b> ：是的。</i> <br><br>  <b>DS</b> ：我意识到他的模棱两可。 有人以为我是在说：“伙计们，所有数据库都归Kubernetes了！”，而其他人则认为它们都是可怕的自行车。 我想完全说一句：“看看正在发生什么，有什么问题以及如何解决。 现在去Kubernetes基地吗？ 生产？ 好吧，只有在您喜欢...做某些事情的情况下。 但是对于开发人员，我可以说我推荐它。 对于开发人员而言，动态创建/删除环境非常重要。” <br><br>  <i>NS：“开发人员”是指所有非生产环境吗？</i>  <i>分期，质量检查...</i> <br><br>  <b>DS</b> ：如果我们谈论的是Perf摊位，那么可能还没有，因为那里的要求是特定的。 如果我们谈论的是在临时情况下需要非常大的数据库的特殊情况，那么可能就不太可能了……如果这是一个长期存在的静态环境，那么将基地设在K8中有什么好处？ <br><br>  <i><b>NS</b> ：没有。</i>  <i>但是我们在哪里看到静态环境？</i>  <i>明天的静态环境已经过时了。</i> <br><br>  <b>DS</b> ：分期可以是静态的。 我们有客户... <br><br>  <i><b>NS</b> ：是的，我也有。</i>  <i>最大的问题是，如果您的基础容量为10 TB，并且分段-200 GB ...</i> <br><br>  <b>DS</b> ：我的箱子很酷！ 分期进行时，有一个可以进行更改的产品基础。 并提供一个按钮：“开始生产”。 这些变化-增量-已在生产中添加（看来，它们只是通过API进行了同步）。 这是一个非常奇特的选择。 <br><br>  <i><b>NS</b> ：我看到硅谷的初创公司坐在RDS或什至在Heroku中-这是2-3年前的故事-他们将转储下载到他们的笔记本电脑中。</i>  <i>到目前为止，由于底座仅80 GB，因此在笔记本电脑上有一个位置。</i>  <i>然后他们为每个人购买磁盘，因此他们有3个基础，以便他们可以进行不同的开发。</i>  <i>这也发生。</i>  <i>我还看到他们不害怕将产品复制到阶段中-这在很大程度上取决于公司。</i>  <i>但是他看到他们很害怕，而且他们经常没有足够的时间和双手。</i>  <i>但是，在继续讨论该主题之前，我想听听有关Kubernetes的信息。</i>  <i>我正确理解，到目前为止，没有人吗？</i> <br><br>  <b>DS</b> ：我们的产品基础很小。 我们正在谈论的是数十GB的容量和非关键服务，对于这些服务来说，创建副本太懒了（并且没有这种需求）。 并且只要在Kubernetes下有一个普通存储即可。 该数据库在虚拟机上工作-在存储之上有条件地在VMware中工作。 我们将其放置在<a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">PV中</a> ，现在我们可以将其从汽车转移到汽车。 <br><br>  <i><b>NS</b> ：可以在几分钟之内推出具有良好磁盘和良好网络的高达100 GB的这种大小的数据库，对吗？</i>  <i>每秒1 GB的速度不再是奇特的。</i> <br><br>  <b>DS</b> ：是的，对于线性操作，这不是问题。 <br><br>  <i><b>NS</b> ：好的，我们应该只考虑产品。</i>  <i>如果我们考虑将Kubernetes用于非产品环境-怎么做？</i>  <i>我看到在Zalando <a href="https://github.com/zalando/postgres-operator">他们正在做一个操作员</a> ，在Crunchy中他们正在<a href="https://github.com/CrunchyData/postgres-operator">锯</a> ，还有其他一些选择。</i>  <i>还有<a href="https://ongres.com/">OnGres-</a>这是我们来自西班牙的好朋友Alvaro：他们基本上不仅是<a href="https://habr.com/ru/company/flant/blog/326414/">运营商</a> ，而是整个发行商（ <a href="https://gitlab.com/ongresinc/stackgres">StackGres</a> ），除了Postgres本身之外，他们还决定填充备份，Envoy代理...</i> <br><br>  <b>DS</b> ：特使是为了什么？  Postgres流量平衡到底是什么？ <br><br>  <i><b>NS</b> ：是的。</i>  <i>也就是说，他们将其视为：如果您使用Linux发行版和内核，那么通常的PostgreSQL是内核，并且他们希望制作一个对云友好且可在Kubernetes上运行的发行版。</i>  <i>它们停靠组件（备份等）并进行调试，以使其正常运行。</i> <br><br>  <b>DS</b> ：太酷了！ 本质上，它是制作托管Postgres的软件。 <br><br>  <i><b>NS</b> ：Linux发行版有一个永恒的问题：如何制作驱动程序，以便支持所有硬件。</i>  <i>他们的想法是，他们将在Kubernetes工作。</i>  <i>我知道在Zalando运营商中，我们最近看到了AWS上的眼球，但这不是很好。</i>  <i>不应与特定的基础结构有联系-那么意义何在？</i> <br><br>  <b>DS</b> ：我不知道Zalando在什么具体情况下参与进来，但是在Kubernetes中进行存储的方式是不可能以通用方式删除磁盘备份的。 最近，在<a href="https://habr.com/ru/company/flant/blog/465417/">CSI规范</a>的最新版本中，该标准提供了快照的可能性，但是在哪里实现呢？ 老实说，它还很原始...我们正在AWS，GCE，Azure，vSphere之上尝试CSI，但是由于您可以看到它尚未准备就绪，所以我们开始使用它了。 <br><br>  <i><b>NS</b> ：因此，有时您必须配合基础架构。</i>  <i>我认为这仍是早期阶段-增长问题。</i>  <i>问题：您对想在K8s中尝试PgSQL的初学者有什么建议？</i>  <i>可能是哪个运算符？</i> <br><br>  <b>DS</b> ：问题是对我们来说Postgres是3％。 在Kubernetes中，我们仍然有很多不同软件的清单，我什至不会列出所有清单。 例如，Elasticsearch。 运营商很多：有些正在积极发展，有些则没有。 对于我们自己，我们提出了操作员应具备的要求，因此我们非常重视他。 运算符专门用于Kubernetes，而不是“在亚马逊条件下做某事的运算符...”实际上，我们<a href="https://github.com/spotahome/redis-operator">为Redis</a>使用了一个运算符（=几乎所有客户）（广泛使用） <i>（我们将很快发表一篇有关它的文章）</i> 。 <br><br>  <i><b>NS</b> ：但是对于MySQL也是如此？</i>  <i>我知道Percona ...因为他们现在涉及MySQL，MongoDB和Postgres，所以他们将必须修复某种通用的方法：对于所有数据库，对于所有云提供商。</i> <br><br>  <b>DS</b> ：我们没有时间查看MySQL的声明。 对我们来说，这不是现在的主要重点。  MySQL独立运行良好。 为什么要成为操作员，如果您只能启动数据库...您可以使用Postrges启动Docker容器，也可以通过简单的方式启动它。 <br><br>  <i><b>NS</b> ：这也是一个问题。</i>  <i>完全没有操作员？</i> <br><br>  <b>DS</b> ：是的，我们100％的人都在没有操作员的情况下运行PostgreSQL。 到目前为止。 对于Prometheus和Redis，我们积极使用运算符。 我们计划找到Elasticsearch的运算符-它消耗最多，因为我们想100％地在Kubernetes中安装它。 正如我们想确保MongoDB也始终安装在Kubernetes中一样。 某些心愿单出现在这里-感觉在这些情况下可以做一些。 而关于Postgres，我们甚至都没有看。 当然，我们知道存在不同的选择，但实际上我们是独立的。 <br><br><h2>  Kubernetes中的测试数据库 </h2><br>  <i><b>NS</b> ：让我们继续测试的话题。</i>  <i>从DevOps的角度来看，如何推出数据库中的更改。</i>  <i>有微服务，许多数据库，总是在某些地方发生变化。</i>  <i>如何确保CI / CD正常，以便一切都从DBMS位置井井有条。</i>  <i>你的方法是什么？</i> <br><br>  <b>DS</b> ：没有答案。 有几种选择。 首先是我们要推广的基础规模。 您自己曾提到过，公司对于在开发和阶段复制产品有不同的态度。 <br><br>  <i><b>NS</b> ：就GDPR而言，我认为它们越来越整齐...我可以说在欧洲，它们已经开始罚款。</i> <br><br>  <b>DS</b> ：但是您经常可以编写用于转储产品并对其进行混淆的软件。 原来是prod'ovye数据（快照，转储，二进制副本...），但它们是匿名的。 相反，可能有生成脚本：它可以是装置，也可以只是生成大型数据库的脚本。 问题是什么：创建基础映像需要多长时间？ 在正确的环境上部署多少时间？ <br><br> 我们采用了该方案：如果客户端有一个夹具数据集（数据库的最低版本），那么默认情况下我们将使用它们。 如果我们谈论的是审阅环境，那么在创建分支时，我们已经部署了一个应用程序实例-我们在那里部署了一个小型数据库。 但是，当我们每天（晚上）从生产环境中删除一次转储并在其基础上收集包含这些已加载数据的PostgreSQL和MySQL的Docker容器时，该<a href="https://habr.com/ru/company/flant/blog/417509/">选项</a>就很好了。 如果您需要从该映像部署基础数据库50次，则可以非常简单，快速地完成此操作。 <br><br>  <i><b>NS</b> ：简单的复制？</i> <br><br>  <b>DS</b> ：数据直接存储在Docker映像中。 即 我们有一个现成的映像，尽管100 GB。 由于Docker中的层，我们可以根据需要快速多次部署此映像。 该方法很傻，但是效果很好。 <br><br>  <i><b>NS</b> ：此外，在测试时，它会在Docker内部更改，对吗？</i>  <i>在Docker内部进行写时复制-将其丢弃并再次运行，一切都很好。</i>  <i>上课！</i>  <i>您已经将它与may和main一起使用了吗？</i> <br><br>  <b>DS</b> ：很久了。 <br><br>  <i><b>NS</b> ：我们做的事情非常相似。</i>  <i>只有我们不使用Docker的写时复制，而是更多。</i> <br><br>  <b>JS</b> ：他不是普通人。  Docker'ny随处可见。 <br><br>  <i><b>NS</b> ：从理论上讲，是的。</i>  <i>但是我们那里也有模块，您可以制作不同的模块并使用不同的文件系统。</i>  <i>等等</i>  <i>从Postgres，我们以不同的方式看待所有这一切。</i>  <i>现在，我从Docker的角度看，发现一切都对您有效。</i>  <i>但是，如果数据库很大（例如1 TB），那么就太长了：晚上都进行操作，将所有东西都塞在Docker中……如果5 TB塞进了Docker……还是一切正常吗？</i> <br><br>  <b>DS</b> ：有什么区别：它是blob，只是位和字节。 <br><br>  <i><b>NS</b> ：区别是：您是否通过转储和还原来做到这一点？</i> <br><br>  <b>DS</b> ：完全没有必要。 生成此图像的方法可以不同。 <br><br>  <i><b>NS</b> ：对于某些客户，我们做到了，因此我们不定期生成基本图像，而是不断更新其图像。</i>  <i>它本质上是一个副本，但不是直接从主数据库接收数据，而是通过存档接收数据。</i>  <i>每天都会在其中滚动WAL的二进制归档文件，并且在那里也删除备份...这些WAL随后会以轻微的延迟（从字面上说是1-2秒）飞到基本映像。</i>  <i>我们可以通过任何方式克隆它-现在默认情况下具有ZFS。</i> <br><br>  <b>DS</b> ：但是使用ZFS，您只能使用一个节点。 <br><br>  <i><b>NS</b> ：是的。</i>  <i>但是ZFS也具有神奇的<a href="https://docs.oracle.com/cd/E18752_01/html/819-5461/gbchx.html">发送功能</a> ：您可以发送快照，甚至（我尚未真正测试过快照，但是...）您也可以在两个<code>PGDATA</code>之间发送增量。</i>  <i>实际上，我们还有另一个我们并未特别考虑用于此类任务的工具。</i>  <i>PostgreSQL具有<a href="https://www.postgresql.org/docs/12/app-pgrewind.html">pg_rewind</a> ，它可以作为“智能” rsync，跳过了许多您不必注意的事情，因为可以肯定的是，那里没有任何变化。</i>  <i>我们可以在两个服务器之间进行快速同步，并以完全相同的方式倒带。</i> <br><br>  <i>因此，我们正在尝试在DBA'noy方面做更多的工作，以制作一种工具，使您可以执行与您说的相同的事情：我们有一个基础，但我们希望同时进行50次测试。</i> <br><br>  <b>DS</b> ：50次表示您需要订购50个Spot实例。 <br><br>  <i><b>NS</b> ：不，我们在一台机器上做所有事情。</i> <br><br>  <b>DS</b> ：但是，如果这个基础是1 TB，那么您将如何部署50次。 很可能她有条件地需要256 GB的RAM？ <br><br>  <i><b>NS</b> ：是的，有时需要很多内存-这是正常的。</i>  <i>但是这样的例子来自生活。</i>  <i>该生产机具有96个内核和600 GB。</i>  <i>同时，数据库使用32个核心（有时甚至使用16个核心）和100-120 GB的内存。</i> <br><br>  <b>DS</b> ：那有50份？ <br><br>  <i><b>NS</b> ：所以只有一个副本，然后写时复制（ZFS'ny）起作用了……我会告诉你更多。</i> <br><br>  <i>例如，我们有一个10 TB的基数。</i>  <i>他们为此制作了一个磁盘，ZFS仍将其百分比大小压缩了30-40。</i>  <i>由于我们不进行负载测试，因此确切的响应时间对我们来说并不重要：让它慢2倍-没关系。</i> <br><br>  <i>我们启用程序员，QA，DBA等。</i>  <i>在1-2个线程中执行测试。</i>  <i>例如，他们可以开始某种迁移。</i>  <i>它一次不需要10个核心-它需要1个Postgres后端，1个核心。</i>  <i>迁移将开始-也许自动<a href="https://www.postgresql.org/docs/12/routine-vacuuming.html">真空</a>仍将开始，然后激活第二个核心。</i>  <i>我们分配了16-32个内核，因此10个人可以同时工作，没有问题。</i> <br><br>  <i>由于<code>PGDATA</code>物理上是相同的，因此事实证明我们实际上是在愚弄Postgres。</i>  <i>诀窍是这样的：例如，它同时启动10个Postgres。</i>  <i>通常是什么问题？</i>  <i>他们<a href="https://www.postgresql.org/docs/current/runtime-config-resource.html">将shared_buffers设置</a>为25％。</i>  <i>因此，这是200 GB。</i>  <i>您开始的时间不会超过三个，因为内存将结束。</i> <br><br>  <i>但是在某个时候，我们意识到这不是必需的：我们将shared_buffers设置为2 GB。</i>  <i>PostgreSQL具有<a href="https://www.postgresql.org/docs/current/runtime-config-query.html">有效的</a>缓存大小，实际上只有它会影响<a href="https://en.wikipedia.org/wiki/Query_plan">计划</a> 。</i>  <i>我们将其设置为0.5 Tb。</i>  <i>而且，即使他们真的不在那也没关系：他像制定计划一样。</i> <br><br>  <i>因此，当我们测试某种迁移时，我们可以收集所有计划-我们将看到它在生产中将如何发生。</i>  <i>秒数将有所不同（较慢），但是实际读取的数据以及计划本身（什么样的JOIN等）的获取与生产时完全相同。</i>  <i>同时，您可以在一台计算机上运行许多此类检查。</i> <br><br>  <b>DS</b> ：您认为有几个问题吗？ 第一个是仅适用于PostgreSQL的解决方案。 这种方法非常私密，不是通用的。 第二个-Kubernetes（这就是云现在要去的地方）涉及许多节点，这些节点是短暂的。 在您的情况下，它是一个有状态的持久节点。 这些事情与我矛盾。 <br><br>  <i><b>NS</b> ：首先-我同意，这纯粹是Postgres的故事。</i>  <i>我认为，如果我们有几乎所有内存的直接IO和缓冲池，则此方法将不起作用-会有不同的计划。</i>  <i>但我们目前仅与Postgres合作，我们不考虑其他人。</i> <br><br>  <i>关于Kubernetes。</i>  <i>您自己总是说我们有一个持久的基础。</i>  <i>如果实例崩溃，最主要的是保存磁盘。</i>  <i>在这里，我们还在Kubernetes中拥有了整个平台，并且Postgres的组件是独立的（尽管有一天会存在）。</i>  <i>因此，一切都是这样：实例掉了，但我们将其保存为PV并仅连接到另一个（新）实例，好像什么也没发生。</i> <br><br>  <b>DS</b> ：从我的角度来看，我们在Kubernetes中创建了pod。  K8s-弹性的：组件可根据需要单独订购。 任务是简单地创建一个Pod，并说它需要X个资源，然后K8会解决这个问题。 但是Kubernetes的存储支持仍然不稳定：在<a href="https://habr.com/ru/company/flant/blog/467477/">1.16版</a> ， <a href="https://habr.com/ru/company/flant/blog/476998/">1.17版</a> （此版本于<i>几周前</i>发布）中，这些功能仅是beta版。 <br><br> 六个月或一年将过去-它或多或少会变得稳定，或者至少会这样宣布。 然后快照和调整大小的可能性已经完全解决了您的问题。 因为你有基地。 是的，它可能不会很快，但是速度取决于“幕后”，因为某些实现可以在磁盘子系统级别进行复制和写时复制。 <br><br>  <i><b>NS</b> ：所有引擎（亚马逊，谷歌...）也必须开始支持该版本-这还需要一些时间。</i> <br><br>  <b>DS</b> ：虽然我们不使用它们。 我们用我们的。 <br><br><h2>  Kubernetes下的本地开发 </h2><br>  <i><b>NS</b> ：当您需要在一台机器上举起所有吊舱并进行少量测试时，是否遇到了这样的愿望清单？</i>  <i>为了快速获得概念证明，请参见该应用程序可以在Kubernetes中运行，而无需为其分配一堆机器。</i>  <i>有迷你吧，对吗？</i> <br><br>  <b>DS</b> ：在我看来，这种情况-部署在一个节点上-完全是关于本地开发的。 或这种模式的一些表现。 有<a href="https://habr.com/ru/company/flant/blog/333470/">Minikube</a> ，有<a href="https://k3s.io/">k3</a> ， <a href="https://github.com/kubernetes-sigs/kind">KIND</a> 。 我们将在Docker中使用Kubernetes。 现在他们开始与他合作进行测试。 <br><br>  <i><b>NS</b> ：我曾经认为这是将所有Pod包装在一个Docker映像中的尝试。</i>  <i>但事实证明，这与其他事情有关。</i>  <i>无论如何，仅在Docker中就有单独的容器，单独的Pod。</i> <br><br>  <b>DS</b> ：是的。 并完成了一个相当有趣的模仿，但是重点是……我们有一个部署工具<a href="https://werf.io/">-werf</a> 。 我们想在其中<code>werf up</code>一个模式-有条件<code>werf up</code> ：“给我一个本地的Kubernetes。” 然后在此运行有条件的<code>werf follow</code> 。 然后，开发人员将能够在IDE中进行编辑，然后在系统中启动一个进程，以查看更改并重新组合图像，然后将其重新建模为本地K8。 因此，我们想尝试解决当地发展的问题。 <br><br><h2>  K8现实中的快照和数据库克隆 </h2><br>  <i><b>NS</b> ：如果您返回写时复制。</i>  <i>我注意到云也有快照。</i>  <i>他们的工作方式不同。</i>  <i>例如，在GCP中：您在美国东海岸拥有一个数TB的实例。</i>  <i>您会定期进行快照。</i>  <i>您可以从快照中获取西海岸磁盘的副本-几分钟后一切就绪，它可以非常快速地工作，只需要在内存中填充缓存。</i>  <i>但是这些克隆（快照）-为了“提供”新卷。</i>  <i>当您需要创建许多实例时，这非常有用。</i> <br><br>  <i>但是对于我来说，对于测试而言，似乎是您在Docker中讨论的快照，或者在ZFS，btrfs甚至是LVM中讨论的快照...-它们使您无法在同一台计算机上制作真正的新数据。</i>  <i>在云中，您仍然必须每次都为它们付费，而不必等待几分钟，而要等待几分钟（如果是<a href="https://aws.amazon.com/about-aws/whats-new/2019/11/amazon-ebs-fast-snapshot-restore-eliminates-need-for-prewarming-data-into-volumes-created-snapshots/">延迟负载</a> ，则可能要花几个小时）。</i> <br><br>  <i>相反，您可以在一两秒钟之内获得此数据，进行测试并将其丢弃。</i>  <i>这些快照解决了不同的问题。</i>  <i>在第一种情况下-扩展并获取新副本，在第二种情况下-进行测试。</i> <br><br>  <b>DS</b> ：我不同意。 克隆卷通常是云的任务。 我没有看过它们的实现，但是我知道我们如何在硬件上实现它。 我们有Ceph，在其中您可以告诉任何物理卷（ <a href="https://docs.ceph.com/docs/master/rbd/">RBD</a> ）进行<i>克隆，</i>并在几十毫秒内获得具有相同特性， <a href="https://en.wikipedia.org/wiki/IOPS">IOPS</a>等的第二个卷。 您必须了解内部存在棘手的写时复制。 云为何不这样做？ 我确信他们正在某种程度上尝试这样做。 <br><br>  <i><b>NS</b> ：但是它们仍然需要几秒钟，数十秒钟来提升实例，将Docker带到那里等等。</i> <br><br>  <b>DS</b> ：为什么必须提出整个实例？ 但是我们有一个32核的实例，一个16……的实例，以某种方式适合它-例如，四个。 当我们订购第五个实例时，该实例将上升，然后将其删除。 <br><br>  <i><b>NS</b> ：是的，有趣的是，Kubernetes有一个不同的故事。</i>  <i>我们的数据库不在K8s和一个实例中。</i>  <i>但是，克隆一个数TB的数据库只需不到两秒钟。</i> <br><br>  <b>DS</b> ：太酷了。 但是我最初的信息是这不是通用解决方案。 是的，这很酷，但是只有Postgres才适合，并且只能在一个节点上使用。 <br><br>  <i><b>NS</b> ：它不仅适用于Postgres：正如我所描述的，这些计划仅以这种方式起作用。</i>  <i>但是，如果您不理会这些计划，而我们只需要所有数据进行功能测试，那么它适用于任何DBMS。</i> <br><br>  <b>DS</b> ：很多年前，我们在LVM快照上做到了这一点。 这是经典。 这种方法已经被非常积极地使用。 仅仅有状态节点是一种痛苦。 因为不需要丢弃它们，所以请始终记住它们... <br><br>  <i><b>NS</b> ：您在这里看到任何混合的可能性吗？</i>  <i>假设有状态是某种豆荚，它可用于多个人（许多测试人员）。</i>  <i>我们只有一卷，但是由于有了文件系统，所以克隆是本地的。</i>  <i>如果Pod跌落，磁盘将保留-Pod上升，它将考虑所有克隆的信息，收回所有内容并说：“这是您在这些端口上的克隆，请进一步使用它们。”</i> <br><br>  <b>DS</b> ：从技术上讲，这意味着在Kubernetes中，这是一个pod，我们在其中运行许多Postgres。 <br><br>  <i><b>NS</b> ：是的。</i>  <i>他有一个限制：假设与此同时，最多有10个人与他一起工作。</i>  <i>如果需要20，请运行第二个类似的容器。</i>  <i>完全现实地克隆它，在收到第二个完整卷之后，它将具有相同的10个“瘦”克隆。</i>  <i>没有看到这样的机会？</i> <br><br>  <b>DS</b> ：我们必须在这里添加安全性问题。 这种组织选项意味着该Pod具有很高的功能，因为它可以在文件系统上执行非标准操作...但是我重复一遍：我相信从中期来看，存储将固定在Kubernetes中，整个卷的故事将固定在云中-一切都会“正常进行”。 它会调整大小，克隆...有一个卷-我们说：“在此基础上创建一个新卷”-经过一分半钟，我们得到了所需的卷。 <br><br>  <i><b>NS</b> ：我不相信在一秒钟半的时间内可以达到数TB。</i>  <i>在Ceph，您自己做，然后谈论云。</i>  <i>在EC2上转到云，复制许多TB的EBS卷，看看性能如何。</i>  <i>不需要几秒钟。</i>  <i>当他们达到这样的指标时，我非常感兴趣。</i>  <i>我了解您在说什么，但让我不同意。</i> <br><br>  <b>DS</b> ：好的，但是我说的是中期的，不是短期的。 好几年了 <br><br><h2>  Zalando的PostgreSQL专业版运算符 </h2><br> 在这次会议的中间，来自Zalando的前开发人员Alexey Klyukin谈到了PostgreSQL运算符的历史，他也加入了她的行列： <br><br><blockquote> 总的来说，这个话题也涉及到了：Postgres和Kubernetes。 当我们于2017年在Zalando开始进行这项工作时，每个人都想做这个话题，但没人做。 每个人都已经有了Kubernetes，但是当被问到如何处理数据库时，甚至像<a href="https://github.com/kelseyhightower">Kelsey Hightower</a>这样宣讲K8的人也说过这样的话： <br><br>  <i>“转到托管服务并使用它们；不要在Kubernetes中启动数据库。</i>  <i>否则，您的K8将决定例如升级，部署所有节点，并且您的数据将飞得很远很远。”</i> <br><br> 我们决定让运营商与该建议相反，将在Kubernetes中启动Postgres数据库。 而且我们有一个良好的基础<a href="https://github.com/zalando/patroni">-Patroni</a> 。 这是PostgreSQL的自动故障转移，已正确完成，即 使用etcd，consul或ZooKeeper作为集群信息的存储库。 这样的存储库将提供给每个询问例如现在是什么领导者的人的相同信息，尽管事实上我们已经分发了所有信息，所以没有头脑分裂。 另外，我们为他准备了一个<a href="https://github.com/zalando/patroni/tree/master/docker">Docker映像</a> 。 <br><br> 通常，在从内部铁数据中心迁移到云之后，公司中出现了自动故障转移的需求。 云基于PaaS（平台即服务）专有解决方案。 它是开源的，但是要提高它，您必须努力工作。 它被称为<a href="https://stups.io/">STUPS</a> 。 <br><br> 最初，没有Kubernetes。 更准确地说，当部署自己的解决方案时，K8已经存在，但过于粗糙以至于不适合生产。 我认为是2015年或2016年。 到2017年，Kubernetes变得越来越成熟-需要迁移到那里。 <br><br> 而且我们已经有了一个docker容器。 有使用Docker的PaaS。 为什么不尝试K8s？ 为什么不写自己的声明？ 来自Avito的穆拉特·卡比洛夫（Murat Kabilov）最初是根据自己的倡议发起这个项目-“玩”，然后发起项目“开始”。 <br><br> 但总的来说，我想谈谈AWS。 历史上为什么会有AWS相关代码... <br><br> 在Kubernetes中运行某些程序时，您需要了解K8s正在进行中。 它在不断发展，改进，并定期甚至中断。 您需要仔细监控Kubernetes的所有变化，需要准备好沉浸其中，并了解其详细工作原理-也许比您想要的更多。 原则上，这是运行数据库的任何平台... <br><br> 因此，当我们执行该语句时，便有了Postgres，它可以与外部卷配合使用（在本例中为EBS，因为我们在AWS中工作）。 数据库正在增长，有时需要调整大小：例如，EBS的原始大小为100 TB，数据库已经增长到现在的大小，现在我们要使EBS达到200 TB。 怎么了 假设您可以转储/还原到新实例，但这很长，而且会停机。 <br><br> 因此，我想要调整大小以扩展EBS分区，然后告诉文件系统使用新空间。 我们做到了，但是那时Kubernetes没有用于调整大小操作的API。 自从我们致力于AWS以来，我们就为其API编写了代码。 <br><br> 没有人会为其他平台做同样的事情。 声明只能在AWS上运行，而在其他所有功能上都无法运行，这没有什么复杂之处。 总的来说，这是一个开源项目：如果有人想加快使用新API的速度，欢迎我们。 有<a href="https://github.com/zalando/postgres-operator">GitHub</a> ，pull-requests-Zalando团队正在尝试快速响应它们并提升操作员。 据我所知，该项目<a href="https://summerofcode.withgoogle.com/archive/2019/organizations/6187982082539520/">参与</a>了Google Summer of Code和其他一些类似的计划。  Zalando对此非常活跃。 <br></blockquote><br><h2>  PS奖金！ </h2><br> 如果您对PostgreSQL和Kubernetes主题感兴趣，那么我们还提请您注意上个星期发生的下一个Postgres， <b>来自Zalando的Alexander Kukushkin</b>与Nikolai进行了交谈。 可从<a href="https://www.youtube.com/watch%3Fv%3DFE0xi7SBqsg">此处</a>获得视频。 <br><br><h2>  PPS </h2><br> 另请参阅我们的博客： <br><br><ul><li>  “ <a href="https://habr.com/ru/company/flant/blog/431500/">数据库和Kubernetes（审查和视频报告）</a> ”； </li><li>  “ <a href="https://habr.com/ru/company/flant/blog/475036/">Cassandra迁移到Kubernetes：功能和解决方案</a> ”； </li><li>  “ <a href="https://habr.com/ru/company/flant/blog/461149/">MongoDB到Kubernetes的无障碍迁移</a> ”； </li><li>  “将<a href="https://habr.com/ru/company/flant/blog/450662/">RabbitMQ顺利迁移到Kubernetes</a> 。” </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN479438/">https://habr.com/ru/post/zh-CN479438/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN479422/index.html">[视频动画]有线世界：35年内海底电缆网络如何覆盖全球</a></li>
<li><a href="../zh-CN479426/index.html">安全周50：Confluence和Linux中的中间人攻击</a></li>
<li><a href="../zh-CN479428/index.html">12月9日至15日在莫斯科举行的数字活动</a></li>
<li><a href="../zh-CN479430/index.html">12月9日至15日在圣彼得堡举行的数字活动</a></li>
<li><a href="../zh-CN479432/index.html">Yandex.Maps：我去了卡控制器-我立即获得了用户的位置（好吧，现在认真了）</a></li>
<li><a href="../zh-CN479442/index.html">Alexey Savvateev：社会分裂的博弈论模型（+ Nginx调查）</a></li>
<li><a href="../zh-CN479446/index.html">汽车在阅读测试方面已经领先于人们。 但是他们了解他们阅读的内容吗？</a></li>
<li><a href="../zh-CN479450/index.html">AppCode 2019.3：速度更快，对Swift的了解更好，对Mac Catalyst的了解，方便地显示组装消息</a></li>
<li><a href="../zh-CN479452/index.html">域名系统如何发展：ARPANET时代</a></li>
<li><a href="../zh-CN479458/index.html">服务器机房的美感或实用性</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>