<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍓 👱 📺 Laurent模块和智能家居（第2部分）。Arduino和AMS 👵🏼 🔔 👌🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="这是将KernelChip的 Laurent 模块集成到家庭自动化系统中的系列文章中的第二篇。在这一部分中，我们将重点介绍将这些模块与Arduino生态系统集成。在系列的第一部分中，我们讨论了与流行的MajorDoMo家庭自动化系统的集成，在第三部分中，您将学习如何从Processing编程语言中的...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Laurent模块和智能家居（第2部分）。Arduino和AMS</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/387205/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这是将</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KernelChip的</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Laurent </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">模块</font></a><font style="vertical-align: inherit;">集成</font><font style="vertical-align: inherit;">到家庭自动化系统</font><font style="vertical-align: inherit;">中的系列文章中的</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">第二篇。</font></a><font style="vertical-align: inherit;">在这一部分中，我们将重点介绍将这些模块与Arduino生态系统集成。</font><font style="vertical-align: inherit;">在</font><font style="vertical-align: inherit;">系列</font><font style="vertical-align: inherit;">的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第一部分中</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，我们讨论了与流行的MajorDoMo家庭自动化系统的集成，在第三部分中，您将学习如何从Processing编程语言中的草图直接在计算机的桌面上管理这些模块。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/geektimes/post_images/279/7d1/bf2/2797d1bf243f51c2e44c4bbf9b4282d3.jpg" alt="图片"><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino是我们的一切</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
没有Arduino的地方？</font><font style="vertical-align: inherit;">我不会在很长一段时间内描述这个平台的优势，它的受欢迎程度是不言而喻的，所以让我们立即了解一下Arduino和Laurent模块之间交互的技术细节。</font><font style="vertical-align: inherit;">在此过程中，我们不会忘记</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino Mega Server系统</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，它是Arduino生态系统非常有趣的派生产品。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">铁</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例如，对于通过网络控制模块，适合使用常见的Arduino Uno板或同样流行的Arduino Mega板，该板上配备了基于W5100芯片组装的Ethernet Shield网络接口卡。</font><font style="vertical-align: inherit;">本文中的所有示例均针对此类组合给出，并已在实践中进行了测试。</font><font style="vertical-align: inherit;">一切工作可靠，没有任何问题。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/geektimes/post_images/086/9f1/1a8/0869f11a82455209389c7e6c37437f0b.jpg" alt="图片"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基于W5100芯片的Ethernet Shield，</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
就是说，您只需</font><em><font style="vertical-align: inherit;">要略做一些更改</font></em><font style="vertical-align: inherit;">，就可以将其草图并上传到Uno或Mega板上。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">管理草图模块</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在本系列的第一部分中，我已经讨论了通过网络管理Laurent模块的原理，对于那些没有阅读第一部分的人，我将在这里简单地重复一下理论。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
信息是通过网络与模块交换的，要开始使用它们，您需要在端口2424上建立TCP / IP连接。</font><font style="vertical-align: inherit;">建立连接后，您可以发送控制模块的文本命令（所谓的KE命令）。</font><font style="vertical-align: inherit;">该</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KernelChip网站</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有详细的文档，包括KE命令的访问描述。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，让我们尝试将这种理论上的“参考术语”翻译成Arduino草图的简单语言。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">草图</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我不会在这里解释如何安装和配置Arduino编程环境，前提是您已经完成了这一工作并且能够编写简单的草图。</font><font style="vertical-align: inherit;">因此，对于初学者来说，我们需要连接必要的库SPI.h和Ethernet.h，以控制总线和以太网模块本身。</font></font><br>
<br>
<pre><code class="java hljs">#include &lt;SPI.h&gt;<font></font>
#include &lt;Ethernet.h&gt;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后，您需要设置我们将管理的以太网模块和Laurent模块的网络设置。</font><font style="vertical-align: inherit;">请注意，MAC地址和IP地址必须唯一，并且LAURENT_PORT必须设置为2424，并且不能设置其他任何值。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> SELF_MAC[] = {<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x2A</span></span>, <span class="hljs-number"><span class="hljs-number">0xF5</span></span>, <span class="hljs-number"><span class="hljs-number">0x12</span></span>, <span class="hljs-number"><span class="hljs-number">0x67</span></span>, <span class="hljs-number"><span class="hljs-number">0xEE</span></span>};
<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> SELF_IP[] = {<span class="hljs-number"><span class="hljs-number">192</span></span>, <span class="hljs-number"><span class="hljs-number">168</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>};<font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> LAURENT_IP[] = {<span class="hljs-number"><span class="hljs-number">192</span></span>, <span class="hljs-number"><span class="hljs-number">168</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">19</span></span>};
<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> LAURENT_PORT = <span class="hljs-number"><span class="hljs-number">2424</span></span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们仍然需要一个用于存储网络命令的缓冲区，该缓冲区的大小选择为200字节，并留有一定余量，如果您遇到缺少RAM的问题，则可以将其减少到例如100字节甚至更少。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf[<span class="hljs-number"><span class="hljs-number">200</span></span>];
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最后一点是Laurent模块的以太网客户端。</font><font style="vertical-align: inherit;">现在，我们将使用lclient对象对模块执行所有操作。</font></font><br>
<br>
<pre><code class="java hljs">EthernetClient lclient;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
就是这样，现在让我们看一下将命令发送到Laurent模块的函数。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendLaurentRequest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lclient.connect(LAURENT_IP, LAURENT_PORT)) { <font></font>
    Serial.print(<span class="hljs-string"><span class="hljs-string">"Command: "</span></span>);<font></font>
    Serial.println(buf);<font></font>
    lclient.println(buf);<font></font>
    delay(<span class="hljs-number"><span class="hljs-number">100</span></span>);<font></font>
  <font></font>
    Serial.print(<span class="hljs-string"><span class="hljs-string">"Answer:  "</span></span>);
    <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(lclient.available() != <span class="hljs-number"><span class="hljs-number">0</span></span>) {
      <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> c = lclient.read();<font></font>
      Serial.print(c);<font></font>
    }<font></font>
    delay(<span class="hljs-number"><span class="hljs-number">500</span></span>);<font></font>
    lclient.stop();<font></font>
  } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {<font></font>
      Serial.println(<span class="hljs-string"><span class="hljs-string">"Error sending command"</span></span>);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果在端口2424上与Laurent模块建立了连接，则缓冲区的内容将发送到模块并在Serial中复制以进行目测。</font><font style="vertical-align: inherit;">然后，期望100毫秒并收到模块响应。</font><font style="vertical-align: inherit;">之后，再次暂停并中断与模块的通信。</font><font style="vertical-align: inherit;">如果由于某种原因无法建立与模块的连接，则会显示一条错误消息。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在让我们分析一下初始化。</font><font style="vertical-align: inherit;">以太网初始化是一个简单的功能</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ethernetInit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{<font></font>
  Ethernet.begin(SELF_MAC, SELF_IP);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Laurent模块由laurentInit（）函数初始化，我们将详细分析其操作。它很大，您需要充分理解它，因为可以基于此函数的代码来建立对Laurent模块的自己的请求。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">laurentInit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{<font></font>
  Serial.println(<span class="hljs-string"><span class="hljs-string">"Start modul Laurent Init..."</span></span>);<font></font>
  Serial.print(<span class="hljs-string"><span class="hljs-string">"Connect to Laurent... "</span></span>);
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lclient.connect(LAURENT_IP, LAURENT_PORT)) {<font></font>
    Serial.println(<span class="hljs-string"><span class="hljs-string">"OK"</span></span>);<font></font>
    lclient.stop();<font></font>
    <font></font>
    <span class="hljs-comment"><span class="hljs-comment">// Send test command</span></span>
    Serial.println(<span class="hljs-string"><span class="hljs-string">"Selftest..."</span></span>);<font></font>
    sprintf(buf, <span class="hljs-string"><span class="hljs-string">"$KE"</span></span>);<font></font>
    sendLaurentRequest();<font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// Send password (default: "Laurent")</span></span>
    Serial.println(<span class="hljs-string"><span class="hljs-string">"Set password..."</span></span>);<font></font>
    sprintf(buf, <span class="hljs-string"><span class="hljs-string">"$KE,PSW,SET,Laurent"</span></span>);   <font></font>
    sendLaurentRequest();<font></font>
  } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {<font></font>
      Serial.println(<span class="hljs-string"><span class="hljs-string">"failed"</span></span>);<font></font>
    }<font></font>
  delay(<span class="hljs-number"><span class="hljs-number">500</span></span>);<font></font>
    <font></font>
  <span class="hljs-comment"><span class="hljs-comment">//   DATA</span></span>
  sprintf(buf, <span class="hljs-string"><span class="hljs-string">"$KE,DAT,OFF"</span></span>);<font></font>
  sendLaurentRequest();<font></font>
  delay(<span class="hljs-number"><span class="hljs-number">100</span></span>);<font></font>
  <font></font>
  <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
  sprintf(buf, <span class="hljs-string"><span class="hljs-string">"$KE,REL,2,0"</span></span>);<font></font>
  sendLaurentRequest();<font></font>
  <font></font>
  Serial.println(<span class="hljs-string"><span class="hljs-string">"Modul Laurent Init done"</span></span>);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初，显示初始化消息，并尝试连接到Laurent模块。如果失败，则会显示一条错误消息，并且如果成功连接到模块，则会发送自诊断命令，运行状况良好的模块应使用“ #OK”响应。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接下来，发送命令以输入密码（在这种情况下，这是默认密码）。预期为500毫秒。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接下来，引入了两个附加命令-其中一个命令停止模块输出的数据（如果有的话），第二个命令关闭我们在实验中使用的2号继电器。换句话说，这些命令将模块带入一些初始状态。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是初始化过程的打印输出，在该过程中所有命令和所有模块响应均可见：</font></font><br>
<br>
<pre><code class="dos hljs"><span class="hljs-built_in"><span class="hljs-built_in">Start</span></span> modul Laurent Init...<font></font>
Connect to Laurent... OK<font></font>
Selftest...<font></font>
<span class="hljs-function"><span class="hljs-function">Command: $</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KE</span></span></span><span class="hljs-function">
</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Answer</span></span></span><span class="hljs-function">:  #</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OK</span></span></span><span class="hljs-function">
</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Set</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">password</span></span></span><span class="hljs-function">...
</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Command</span></span></span><span class="hljs-function">: $</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KE</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PSW</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SET</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Laurent</span></span></span><span class="hljs-function">
</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Answer</span></span></span><span class="hljs-function">:  #</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PSW</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SET</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OK</span></span></span><span class="hljs-function">
</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Command</span></span></span><span class="hljs-function">: $</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KE</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DAT</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OFF</span></span></span><span class="hljs-function">
</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Answer</span></span></span><span class="hljs-function">:  #</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DAT</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OK</span></span></span><span class="hljs-function">
</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Command</span></span></span><span class="hljs-function">: $</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KE</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">REL</span></span></span><span class="hljs-function">,2,0
</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Answer</span></span></span><span class="hljs-function">:  #</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">REL</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OK</span></span></span><span class="hljs-function">
</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Modul</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Laurent</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Init</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">done</span></span></span><span class="hljs-function">
</span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，标准setup（）函数的代码。</font><font style="vertical-align: inherit;">所有子系统均已初始化，包括以标准9600波特率的串行端口。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{  <font></font>
  Serial.begin(<span class="hljs-number"><span class="hljs-number">9600</span></span>);  <font></font>
  ethernetInit();<font></font>
  laurentInit();<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，我们初始化了模块，并可以按需要的方式对其进行管理：发送命令，读取答案，考虑Laurent模块发出的数据来构建控制逻辑。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例如，考虑最简单的任务-定期打开和关闭连接到Laurent模块第二个继电器的灯的光。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
  <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
  sprintf(buf, <span class="hljs-string"><span class="hljs-string">"$KE,REL,2,1"</span></span>);<font></font>
  sendLaurentRequest();<font></font>
  delay(<span class="hljs-number"><span class="hljs-number">3000</span></span>);
  <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
  sprintf(buf, <span class="hljs-string"><span class="hljs-string">"$KE,REL,2,0"</span></span>);<font></font>
  sendLaurentRequest();<font></font>
  delay(<span class="hljs-number"><span class="hljs-number">3000</span></span>);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
loop（）函数是一个无限循环，按照我们的命令，指示灯将连续点亮并每3秒钟熄灭一次。</font><font style="vertical-align: inherit;">当然，这只是一个例子，实际上，工作的逻辑可以是任何逻辑，而一切都取决于您的需求。</font><font style="vertical-align: inherit;">当然，您不仅可以发送命令以启用或禁用负载，还可以发送模块支持的其他命令。</font><font style="vertical-align: inherit;">您可以在Laurent模块的文档中找到命令及其说明的完整列表。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您可以采用此草图并将其集成到您自己的项目中，从而增加对管理Laurent模块的支持。</font><font style="vertical-align: inherit;">反之亦然，以此草图为基础并逐渐增加其功能。</font><font style="vertical-align: inherit;">完美无止境。</font><font style="vertical-align: inherit;">这是完整的草图。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完整的草图代码</font></font></b><div class="spoiler_text">#include &lt;SPI.h&gt;<br>
#include &lt;Ethernet.h&gt;<br>
<br>
byte SELF_MAC[] = {0x00, 0x2A, 0xF5, 0x12, 0x67, 0xEE};<br>
byte SELF_IP[] = {192, 168, 2, 20};<br>
<br>
byte LAURENT_IP[] = {192, 168, 2, 19};<br>
int LAURENT_PORT = 2424;<br>
<br>
char buf[200];<br>
<br>
EthernetClient lclient;<br>
<br>
void ethernetInit() {<br>
 Ethernet.begin(SELF_MAC, SELF_IP);<br>
}<br>
<br>
void laurentInit() {<br>
 Serial.println(«Start modul Laurent Init...»);<br>
 Serial.print(«Connect to Laurent… „);<br>
 if (lclient.connect(LAURENT_IP, LAURENT_PORT)) {<br>
 Serial.println(“OK»);<br>
 lclient.stop();<br>
 <br>
 // Send test command<br>
 Serial.println(«Selftest...»);<br>
 sprintf(buf, "$KE");<br>
 sendLaurentRequest();<br>
<br>
// Send password (default: «Laurent»)<br>
 Serial.println(«Set password...»);<br>
 sprintf(buf, "$KE,PSW,SET,Laurent"); <br>
 sendLaurentRequest();<br>
 } else {<br>
 Serial.println(«failed»);<br>
 }<br>
 delay(500);<br>
 <br>
 //   DATA<br>
 sprintf(buf, "$KE,DAT,OFF");<br>
 sendLaurentRequest();<br>
 delay(100);<br>
 <br>
 //  <br>
 sprintf(buf, "$KE,REL,2,0");<br>
 sendLaurentRequest();<br>
 <br>
 Serial.println(«Modul Laurent Init done»);<br>
} // laurentInit<br>
<br>
void sendLaurentRequest() {<br>
 if (lclient.connect(LAURENT_IP, LAURENT_PORT)) { <br>
 Serial.print(«Command: „);<br>
 Serial.println(buf);<br>
 lclient.println(buf);<br>
 delay(100);<br>
 <br>
 Serial.print(“Answer: „);<br>
 while(lclient.available() != 0) {<br>
 char c = lclient.read();<br>
 Serial.print©;<br>
 }<br>
 delay(500);<br>
 lclient.stop();<br>
 } else {<br>
 Serial.println(“Error sending command»);<br>
 }<br>
} // sendLaurentRequest<br>
<br>
void setup() { <br>
 Serial.begin(9600); <br>
 ethernetInit();<br>
 laurentInit();<br>
}<br>
<br>
void loop() {<br>
 //  <br>
 sprintf(buf, "$KE,REL,2,1");<br>
 sendLaurentRequest();<br>
 delay(3000);<br>
<br>
//  <br>
 sprintf(buf, "$KE,REL,2,0");<br>
 sendLaurentRequest();<br>
 delay(3000);<br>
}<br>
</div></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino Mega服务器</font></font></h2><br>
<img src="https://habrastorage.org/getpro/geektimes/post_images/6cb/44c/34f/6cb44c34fc97289e192f28cc8e59fb8c.png" alt="图片"><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino Mega Server</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（AMS）是一个功能强大的系统，适用于Arduino Mega（现在也适用于Arduino DUE，不久之后适用于其他32位平台M0（零）和Genuino 101），其中包含代码“适用于所有场合”以及更多其他功能内置服务器和用户友好的Web界面。</font><font style="vertical-align: inherit;">AMS开箱即用地支持Laurent模块，您无需添加用户逻辑即可。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AMS具有模块化结构，打开和关闭模块的操作只需在草图中注释掉一条线即可，例如，</font></font><br>
<br>
<pre><code class="java hljs">#define LAURENT_FEATURE
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要么 </font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//#define LAURENT_FEATURE</span></span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果该行被注释掉，则该模块将无法编译，也不会参与工作，如在站点标题中的模块指示符上所示。</font><font style="vertical-align: inherit;">反之亦然，已编译且工作正常的模块以蓝色表示。</font><font style="vertical-align: inherit;">在这种情况下，LRT控制模块LRT不起作用。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/geektimes/post_images/7bb/e3b/f7e/7bbe3bf7ea1146478f40eff0c230d38f.png" alt="图片"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模块操作指示灯</font></font></em><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用Laurent模块响应</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，让我们添加功能，不仅可以显示模块响应，还可以与它们一起使用，例如分析它们或在Arduino Mega Server网页上显示。</font><font style="vertical-align: inherit;">为此，我们需要一个新的字符串变量和一个常量，该常量确定分配给Laurent模块答案的字符串的长度。</font><font style="vertical-align: inherit;">在测试示例中，它等于25个字符，但是如果答案不适合该值，则可以增加它。</font><font style="vertical-align: inherit;">您只需要记住微控制器的RAM是宝贵的资源，就需要保存它。</font><font style="vertical-align: inherit;">将以下行从AMS软件包添加到标准laurent.ino模块中：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> MAX_LEN_LREQUEST = <span class="hljs-number"><span class="hljs-number">25</span></span>;<font></font>
String lrequest = String(MAX_LEN_LREQUEST);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们还需要更改发出请求的函数的代码（添加的更改用箭头突出显示）。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendLaurentRequest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lclient.connect(LAURENT_IP, LAURENT_PORT)) { <font></font>
    Serialprint(<span class="hljs-string"><span class="hljs-string">"Command: "</span></span>);<font></font>
    Serial.println(buf);<font></font>
    lclient.println(buf);<font></font>
    delay(<span class="hljs-number"><span class="hljs-number">100</span></span>);<font></font>
  <font></font>
    Serialprint(<span class="hljs-string"><span class="hljs-string">"Answer:  "</span></span>);
    <span class="hljs-comment"><span class="hljs-comment">// --------------------&gt;</span></span>
    lrequest = <span class="hljs-string"><span class="hljs-string">""</span></span>;
    <span class="hljs-comment"><span class="hljs-comment">// --------------------&gt;</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(lclient.available() != <span class="hljs-number"><span class="hljs-number">0</span></span>) {
      <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> c = lclient.read();<font></font>
      Serial.print(c);<font></font>
      <span class="hljs-comment"><span class="hljs-comment">// --------------------&gt;</span></span>
      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lrequest.length() &lt; MAX_LEN_LREQUEST) {<font></font>
        lrequest += (c);<font></font>
      }<font></font>
      <span class="hljs-comment"><span class="hljs-comment">// --------------------&gt;</span></span><font></font>
    }<font></font>
    delay(<span class="hljs-number"><span class="hljs-number">500</span></span>);<font></font>
    lclient.stop();<font></font>
  } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {<font></font>
      Serialprint(<span class="hljs-string"><span class="hljs-string">"Error sending command\n"</span></span>);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，我们学习了如何在lrequest变量中获得Laurent答案，现在我们可以做我们认为适合的任何事情。</font><font style="vertical-align: inherit;">接下来，我将展示如何直接在AMS网站标题的仪表板上显示查询结果。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一个小笔记。</font><font style="vertical-align: inherit;">本示例使用Serialprint函数而不是标准Serial.print，因为它节省了更多RAM。</font><font style="vertical-align: inherit;">只需将两个单词的结尾简单地转换为标准的即可。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将模块响应输出到站点头</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
还有最后一个例子。</font><font style="vertical-align: inherit;">让我们在Arduino Mega Server站点的标题中显示Laurent模块的答案。</font><font style="vertical-align: inherit;">为此，我们需要将请求添加到AMS草图的main loop（）循环中。</font><font style="vertical-align: inherit;">打开arduino_mega_server.ino文件，并在cyclosInSecWork（）函数之前输入以下代码：</font></font><br>
<br>
<pre><code class="java hljs">    #<span class="hljs-function"><span class="hljs-function">ifdef LAURENT_FEATURE
      </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cycle30s)</span></span></span><span class="hljs-function"> </span></span>{<font></font>
        sprintf(buf, <span class="hljs-string"><span class="hljs-string">"$KE"</span></span>);   <font></font>
        sendLaurentRequest();<font></font>
      }<font></font>
    #endif<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此代码将每隔三十秒查询Laurent模块的运行状况。自然，这只是一个例子，在这个地方可以有任何请求和任何代码。因此，在变量lrequest中，我们可以获得有关模块状态的答案，并且现在可以将其显示在站点的标题中。为此，请打开server_ajax.ino模块，最后在cl.println（“”）行之前，在responseDash函数代码（EthernetClient cl）中；添加以下代码：</font></font><br>
<br>
<pre><code class="java hljs">    #<span class="hljs-function"><span class="hljs-function">ifdef LAURENT_FEATURE
      </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendTagString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"laurent"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">""</span></span></span></span><span class="hljs-function"><span class="hljs-params">, lrequest, cl)</span></span></span></span>;<font></font>
    #endif<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
实际上，此代码将模块响应发送到网页。</font><font style="vertical-align: inherit;">剩下要做的两件事：第一是添加将“捕获”我们的数据的JavaScript代码，第二是AMS页面本身上的HTML代码，其中将显示模块答案。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，请打开scripts.js文件，并在右括号前的getDashData（）函数中// //如果（this.responseXML！= Null）输入将接受我们前提的代码。</font></font><br>
<br>
<pre><code class="javascript hljs">          <span class="hljs-comment"><span class="hljs-comment">// Laurent</span></span>
          <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {
            <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> laurent = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.responseXML.getElementsByTagName(<span class="hljs-string"><span class="hljs-string">'laurent'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].childNodes[<span class="hljs-number"><span class="hljs-number">0</span></span>].nodeValue;<font></font>
          } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (err) {<font></font>
              laurent = <span class="hljs-string"><span class="hljs-string">"-"</span></span>;<font></font>
            }<font></font>
          <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"laurent"</span></span>).innerHTML = laurent; 
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
只需稍微校正标准AMS交付中的dash.htm文件并向其添加代码即可在屏幕上显示信息。</font><font style="vertical-align: inherit;">在包含class =“ online-device”的行之后，立即输入带有代码的新行：</font></font><br>
<br>
<pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>Laurent: <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"value"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"laurent"</span></span></span><span class="hljs-tag">&gt;</span></span>...<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
就这样。</font><font style="vertical-align: inherit;">我们已经在Arduino Mega Server站点的标题中显示了Laurent模块的响应。</font><font style="vertical-align: inherit;">这是我们努力的结果。</font><font style="vertical-align: inherit;">模块的状态在AMS面板中清晰可见，并且每30秒更新一次，因此，如果模块发生故障，您最多需要30秒才能知道。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/geektimes/post_images/126/5f2/c08/1265f2c08e49db3483fb7df355ac27e1.png" alt="图片"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结论</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如您所见，使用Arduino和Arduino Mega Server管理Laurent模块并不复杂，并且如果您已经有这样的模块或计划将它们添加到Smart Home系统中，那么本文将帮助您轻松而轻松地完成此操作。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在下一个周期的下一篇文章中，您将学习如何直接在计算机屏幕上管理劳兰斯，以及如何使教孩子编程的过程更具交互性和趣味性。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">加法</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">一个Youtube频道已打开，这是</font><font style="vertical-align: inherit;">Arduino Mega Server </font><font style="vertical-align: inherit;">的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">促销视频</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，演示了如何在实际系​​统上工作。</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN387205/">https://habr.com/ru/post/zh-CN387205/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN387195/index.html">LEGO Technics的动感雕塑“西西弗斯”</a></li>
<li><a href="../zh-CN387197/index.html">行星可以长出暗物质的头发</a></li>
<li><a href="../zh-CN387199/index.html">DIY PowerBank可提供17,000毫安时的毫安小时</a></li>
<li><a href="../zh-CN387201/index.html">来自中间王国的黑客多少钱？</a></li>
<li><a href="../zh-CN387203/index.html">个性分裂的37岁盲人女性成年后开始见识</a></li>
<li><a href="../zh-CN387207/index.html">前Google工程师如何开发新的餐厅搜索技术</a></li>
<li><a href="../zh-CN387209/index.html">矩阵的诞生：人工神经网络学会了创造人和卧室内部的逼真的面孔</a></li>
<li><a href="../zh-CN387215/index.html">一种将Wi-Fi模块添加到Raspberry Pi Zero的简单方法</a></li>
<li><a href="../zh-CN387217/index.html">聪明的衣服和可穿戴技术</a></li>
<li><a href="../zh-CN387219/index.html">怎样使新年热潮在10-20美元之间？第2部分</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>