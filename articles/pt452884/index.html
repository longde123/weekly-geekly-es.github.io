<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§æüèº üë®üèΩ‚Äçüé§ üö∑ An√°lise do desempenho da m√°quina virtual no VMware vSphere. Parte 1: CPU ‚ú≥Ô∏è üîπ üë©üèª‚Äçüåæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Se voc√™ administra uma infraestrutura virtual baseada no VMware vSphere (ou em qualquer outra pilha de tecnologia), provavelmente ouve reclama√ß√µes dos...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>An√°lise do desempenho da m√°quina virtual no VMware vSphere. Parte 1: CPU</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dataline/blog/452884/"><img src="https://habrastorage.org/webt/m9/sx/3b/m9sx3brt_zkyowlzywiwyoobc60.png"><br><br>  Se voc√™ administra uma infraestrutura virtual baseada no VMware vSphere (ou em qualquer outra pilha de tecnologia), provavelmente ouve reclama√ß√µes dos usu√°rios: "A m√°quina virtual est√° lenta!".  Nesta s√©rie de artigos, analisarei as m√©tricas de desempenho e explicarei o que e por que "desacelera" e como garantir que n√£o "desacelere". <br><br>  Vou considerar os seguintes aspectos de desempenho das m√°quinas virtuais: <br><br><ul><li>  CPU </li><li>  RAM </li><li>  DISK, </li><li>  Rede </li></ul><br>  Vou come√ßar com a CPU. <br><br>  Para an√°lise de desempenho, precisamos de: <br><br><ul><li> <b>Os contadores de desempenho do vCenter</b> s√£o contadores de desempenho cujos gr√°ficos podem ser visualizados no vSphere Client.  As informa√ß√µes sobre esses contadores est√£o dispon√≠veis em qualquer vers√£o do cliente (cliente "grosso" em C #, cliente da web no Flex e cliente da web em HTML5).  Nesses artigos, usaremos capturas de tela do cliente C #, apenas porque elas ficam melhores em miniatura :) </li><li>  <b>ESXTOP</b> √© um utilit√°rio que √© executado na linha de comando do ESXi.  Com sua ajuda, voc√™ pode obter os valores dos contadores de desempenho em tempo real ou fazer upload desses valores por um determinado per√≠odo em um arquivo .csv para an√°lise posterior.  Em seguida, vou falar mais sobre essa ferramenta e fornecer alguns links √∫teis para documenta√ß√£o e artigos relacionados. </li></ul><br><a name="habracut"></a><br><h3>  Pouco de teoria </h3><br><img src="https://habrastorage.org/webt/zf/rh/dx/zfrhdxqi6ys3wgdgzs0m5ibk96i.png"><br><br>  No ESXi, um processo separado √© respons√°vel pela opera√ß√£o de cada vCPU (n√∫cleo da m√°quina virtual) - o mundo na terminologia VMware.  Tamb√©m existem processos de servi√ßo, mas do ponto de vista da an√°lise de desempenho da VM, eles s√£o menos interessantes. <br><br>  Um processo no ESXi pode estar em um dos quatro estados: <br><br><ul><li>  <b>Executar</b> - o processo faz algum trabalho √∫til. </li><li>  <b>Aguardar</b> - o processo n√£o realiza nenhum trabalho (inativo) ou est√° aguardando entrada / sa√≠da. </li><li>  <b>Costop</b> √© uma condi√ß√£o que ocorre em m√°quinas virtuais com v√°rios n√∫cleos.  Ocorre quando o agendador de CPU do hipervisor (ESXi CPU Scheduler) n√£o pode agendar todos os n√∫cleos ativos da m√°quina virtual para execu√ß√£o simult√¢nea nos n√∫cleos f√≠sicos do servidor.  No mundo f√≠sico, todos os n√∫cleos de processador funcionam em paralelo; o SO convidado na VM espera um comportamento semelhante; portanto, o hipervisor precisa desacelerar os n√∫cleos da VM, que t√™m a capacidade de concluir a batida mais rapidamente.  Nas vers√µes modernas do ESXi, o agendador de CPU usa um mecanismo chamado co-agendamento relaxado: o hipervisor considera a lacuna entre o n√∫cleo da m√°quina virtual mais r√°pido e mais lento (inclina√ß√£o) Se a diferen√ßa exceder um determinado limite, o n√∫cleo r√°pido entra no estado de custo. Se os n√∫cleos da VM passarem muito tempo nesse estado, isso poder√° causar problemas de desempenho. </li><li>  <b>Pronto</b> - o processo entra nesse estado quando o hypervisor n√£o tem a capacidade de alocar recursos para sua execu√ß√£o.  Valores altos prontos podem causar problemas de desempenho da VM. </li></ul><br><h3>  Contadores b√°sicos de desempenho da CPU de uma m√°quina virtual </h3><br>  <b>Uso da CPU,%.</b>  Mostra a porcentagem de uso da CPU por um determinado per√≠odo. <br><br><img src="https://habrastorage.org/webt/ly/ad/rg/lyadrgztwkrkipbfnzllfcjtrq4.png"><br><br>  <b>Como analisar?</b>  Se a VM usar esta CPU de forma est√°vel para 90% ou houver picos de at√© 100%, teremos problemas.  Os problemas podem ser expressos n√£o apenas na opera√ß√£o "lenta" do aplicativo dentro da VM, mas tamb√©m na inacessibilidade da VM pela rede.  Se o sistema de monitoramento mostrar que a VM cai periodicamente, preste aten√ß√£o aos picos no gr√°fico Uso da CPU. <br><br>  H√° um alarme padr√£o, que mostra a carga da CPU da m√°quina virtual: <br><br><img src="https://habrastorage.org/webt/6a/pr/b9/6aprb9vc1gwbtioocqpjdm7jzhk.png"><br><br>  <b>O que fazer</b>  Se o uso da CPU sobrecarregar constantemente a VM, voc√™ poder√° aumentar o n√∫mero de vCPUs (infelizmente, isso nem sempre ajuda) ou transferir as VMs para um servidor com processadores mais eficientes. <br><br><h3>  Uso da CPU em Mhz </h3><br>  Nos gr√°ficos de uso do vCenter em%, voc√™ pode ver apenas a m√°quina virtual inteira, n√£o h√° gr√°ficos para n√∫cleos individuais (o Esxtop possui valores em% para n√∫cleos).  Para cada n√∫cleo, voc√™ pode ver Uso em MHz. <br><br>  <b>Como analisar?</b>  Acontece que o aplicativo n√£o √© otimizado para a arquitetura multin√∫cleo: ele usa 100% apenas um n√∫cleo e o restante fica ocioso sem carga.  Por exemplo, com as configura√ß√µes de backup padr√£o, o MS SQL inicia o processo em apenas um n√∫cleo.  Como resultado, o backup √© mais lento, n√£o devido √† velocidade lenta do disco (√© sobre isso que o usu√°rio reclamou inicialmente), mas porque o processador n√£o pode lidar com isso.  O problema foi resolvido alterando os par√¢metros: o backup come√ßou a ser executado em paralelo em v√°rios arquivos (respectivamente, em v√°rios processos). <br><br><img src="https://habrastorage.org/webt/6p/pm/w8/6ppmw8d5vqe2gepkiahzqx9tfms.png"><br>  <i>Um exemplo de uma carga desigual de n√∫cleos.</i> <br><br>  Tamb√©m existe uma situa√ß√£o (como no gr√°fico acima) quando os n√∫cleos s√£o carregados de maneira desigual e alguns deles t√™m picos de 100%.  Assim como o carregamento de apenas um n√∫cleo, o alarme no uso da CPU n√£o funcionar√° (est√° presente em toda a VM), mas haver√° problemas de desempenho. <br><br>  <b>O que fazer</b>  Se o software na m√°quina virtual carrega os kernels de maneira desigual (usa apenas um n√∫cleo ou parte dos kernels), n√£o h√° sentido em aumentar seu n√∫mero.  Nesse caso, √© melhor mover a VM para um servidor com processadores mais eficientes. <br><br>  Voc√™ tamb√©m pode tentar verificar as configura√ß√µes de energia no BIOS do servidor.  Muitos administradores ativam o modo de alto desempenho no BIOS e, assim, desativam as tecnologias de economia de energia dos estados C e P.  Os modernos processadores Intel usam a tecnologia Turbo Boost, que aumenta a frequ√™ncia de n√∫cleos de processadores individuais devido a outros n√∫cleos.  Mas ele funciona apenas com as tecnologias de economia de energia inclu√≠das.  Se os desligarmos, o processador n√£o poder√° reduzir o consumo de energia dos kernels que n√£o est√£o carregados. <br><br>  A VMware recomenda n√£o desativar as tecnologias de economia de energia nos servidores, mas escolher modos que maximizem o gerenciamento de energia para o hipervisor.  Ao mesmo tempo, nas configura√ß√µes de energia do hipervisor, voc√™ precisa selecionar Alto desempenho. <br><br>  Se voc√™ tiver VMs (ou n√∫cleos de VM) separados em sua infraestrutura que exijam uma frequ√™ncia de CPU aumentada, a configura√ß√£o correta do consumo de energia poder√° melhorar significativamente seu desempenho. <br><br><img src="https://habrastorage.org/webt/uq/ov/-o/uqov-ooazq0fetmazbwzhvxlgeg.png"><br><br><h3>  Pronto para CPU (prontid√£o) </h3><br>  Se o n√∫cleo da VM (vCPU) estiver no estado Pronto, ele n√£o far√° um trabalho √∫til.  Essa condi√ß√£o ocorre quando o hypervisor n√£o encontra um n√∫cleo f√≠sico livre ao qual o processo de vCPU da m√°quina virtual pode ser designado. <br><br>  <b>Como analisar?</b>  Normalmente, se os n√∫cleos da m√°quina virtual estiverem no estado Pronto por mais de 10% do tempo, voc√™ notar√° problemas de desempenho.  Simplificando, mais de 10% do tempo que uma VM espera pela disponibilidade de recursos f√≠sicos. <br><br>  No vCenter, voc√™ pode ver 2 contadores associados ao CPU Ready: <br><br><ul><li>  Prontid√£o </li><li>  Pronto. </li></ul><br>  Os valores de ambos os contadores podem ser visualizados em toda a VM e em kernels individuais. <br>  A prontid√£o mostra o valor imediatamente em porcentagem, mas apenas em tempo real (dados da √∫ltima hora, intervalo de medi√ß√£o 20 segundos).  Esse contador √© melhor usado apenas para procurar problemas "em busca". <br><br>  Os valores dos contadores prontos tamb√©m podem ser visualizados em perspectiva hist√≥rica.  Isso √© √∫til para estabelecer padr√µes e para uma an√°lise mais profunda do problema.  Por exemplo, se uma m√°quina virtual come√ßar a ter problemas de desempenho em algum momento espec√≠fico, voc√™ poder√° comparar os intervalos do valor de CPU Ready travado com a carga total no servidor em que a VM est√° sendo executada e tomar medidas para reduzir a carga (se o DRS n√£o conseguir lidar). <br><br>  Pronto, diferente da prontid√£o, √© mostrado n√£o em porcentagens, mas em milissegundos.  Este √© um contador do tipo Somat√≥rio, ou seja, mostra quanto tempo o n√∫cleo da VM ficou no estado Pronto durante o per√≠odo de medi√ß√£o.  Voc√™ pode converter esse valor em porcentagem por uma f√≥rmula simples: <br><br>  (Valor da soma da CPU pronta / (intervalo de atualiza√ß√£o padr√£o do gr√°fico em segundos * 1000)) * 100 =% da CPU pronta <br><br>  Por exemplo, para VMs no gr√°fico abaixo, o valor de pico de Pronto para toda a m√°quina virtual √© o seguinte: <br><br><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mn>4286</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>/</mo></mrow><mo stretchy=&quot;false&quot;>(</mo><mn>20</mn><mo>&amp;#x2217;</mo><mn>1000</mn><mo stretchy=&quot;false&quot;>)</mo><mo stretchy=&quot;false&quot;>)</mo><mo>&amp;#x2217;</mo><mn>100</mn><mo>=</mo><mn>21</mn></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="28.801ex" height="2.66ex" viewBox="0 -832 12400.4 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhOQArx2IB7bOheEri1neDywvE0AA#MJMAIN-34"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhOQArx2IB7bOheEri1neDywvE0AA#MJMAIN-32" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhOQArx2IB7bOheEri1neDywvE0AA#MJMAIN-38" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhOQArx2IB7bOheEri1neDywvE0AA#MJMAIN-36" x="1501" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhOQArx2IB7bOheEri1neDywvE0AA#MJMAIN-2F" x="2002" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhOQArx2IB7bOheEri1neDywvE0AA#MJMAIN-28" x="2502" y="0"></use><g transform="translate(2892,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhOQArx2IB7bOheEri1neDywvE0AA#MJMAIN-32"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhOQArx2IB7bOheEri1neDywvE0AA#MJMAIN-30" x="500" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhOQArx2IB7bOheEri1neDywvE0AA#MJMAIN-2217" x="4115" y="0"></use><g transform="translate(4837,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhOQArx2IB7bOheEri1neDywvE0AA#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhOQArx2IB7bOheEri1neDywvE0AA#MJMAIN-30" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhOQArx2IB7bOheEri1neDywvE0AA#MJMAIN-30" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhOQArx2IB7bOheEri1neDywvE0AA#MJMAIN-30" x="1501" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhOQArx2IB7bOheEri1neDywvE0AA#MJMAIN-29" x="6839" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhOQArx2IB7bOheEri1neDywvE0AA#MJMAIN-29" x="7229" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhOQArx2IB7bOheEri1neDywvE0AA#MJMAIN-2217" x="7841" y="0"></use><g transform="translate(8563,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhOQArx2IB7bOheEri1neDywvE0AA#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhOQArx2IB7bOheEri1neDywvE0AA#MJMAIN-30" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhOQArx2IB7bOheEri1neDywvE0AA#MJMAIN-30" x="1001" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhOQArx2IB7bOheEri1neDywvE0AA#MJMAIN-3D" x="10343" y="0"></use><g transform="translate(11399,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhOQArx2IB7bOheEri1neDywvE0AA#MJMAIN-32"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhOQArx2IB7bOheEri1neDywvE0AA#MJMAIN-31" x="500" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>4286</mn><mrow class="MJX-TeXAtom-ORD"><mo>/</mo></mrow><mo stretchy="false">(</mo><mn>20</mn><mo>‚àó</mo><mn>1000</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>‚àó</mo><mn>100</mn><mo>=</mo><mn>21</mn></math></span></span><script type="math/tex" id="MathJax-Element-1"> 4286 / (20 * 1000)) * 100 = 21% (4286 / (20 * 1000)) * 100 = 21% </script><br><br><img src="https://habrastorage.org/webt/oq/ma/1u/oqma1u-x4wdruct6jqgvlak9ia0.png"><br><br>  Ao calcular o valor Pronto como uma porcentagem, voc√™ deve prestar aten√ß√£o a dois pontos: <br><br><ul><li>  O valor de Ready em toda a VM √© a soma de Ready entre os n√∫cleos. </li><li>  Intervalo de medi√ß√£o.  Em tempo real, s√£o 20 segundos e, por exemplo, nos gr√°ficos di√°rios, s√£o 300 segundos. </li></ul><br>  Com a solu√ß√£o de problemas ativa, esses pontos simples podem ser facilmente perdidos e um tempo valioso pode ser gasto na solu√ß√£o de problemas inexistentes. <br><br>  Calculamos Ready com base nos dados do gr√°fico abaixo.  (324474 / (20 * 1000)) * 100 = 1622% para toda a VM.  Se voc√™ olhar para os n√∫cleos, ser√° menos assustador: 1622/64 = 25% por n√∫cleo.  Nesse caso, detectar um truque √© bastante simples: o valor Pronto √© irrealista.  Mas se falamos de 10 a 20% para toda a VM com v√°rios n√∫cleos, ent√£o para cada n√∫cleo, o valor pode estar dentro do intervalo normal. <br><br><img src="https://habrastorage.org/webt/_m/qe/cc/_mqeccs8ivn_r-zrogedc_ofw9a.png"><br><br>  <b>O que fazer</b>  Um valor alto de Pronto indica que o servidor n√£o possui recursos de processador suficientes para a opera√ß√£o normal de m√°quinas virtuais.  Nessa situa√ß√£o, resta apenas reduzir a sobrescri√ß√£o no processador (vCPU: pCPU).  Obviamente, isso pode ser alcan√ßado reduzindo os par√¢metros das VMs existentes ou migrando parte da VM para outros servidores. <br><br><h3>  Co-stop </h3><br>  <b>Como analisar?</b>  Esse contador tamb√©m tem o tipo de soma e se traduz em porcentagens como Pronto: <br><br>  (Valor de soma de parada da CPU / (intervalo de atualiza√ß√£o padr√£o do gr√°fico em segundos * 1000)) * 100 =% de parada da CPU <br><br>  Aqui voc√™ tamb√©m precisa prestar aten√ß√£o ao n√∫mero de n√∫cleos por VM e ao intervalo de medi√ß√£o. <br>  No estado costop, o kernel n√£o faz um trabalho √∫til.  Com a sele√ß√£o correta do tamanho da VM e carga normal no servidor, o contador de co-parada deve estar pr√≥ximo de zero. <br><br><img src="https://habrastorage.org/webt/pz/y8/sr/pzy8sr12hk1z2yosm9devw7knvs.png"><br>  <i>Nesse caso, a carga √© claramente anormal :)</i> <br><br>  <b>O que fazer</b>  Se v√°rias VMs com um grande n√∫mero de n√∫cleos estiverem em execu√ß√£o no mesmo hipervisor e houver excesso de assinatura na CPU, o contador de co-stop poder√° aumentar, o que levar√° a problemas com o desempenho dessas VMs. <br><br>  Al√©m disso, a co-parada aumentar√° se os threads forem usados ‚Äã‚Äãpara kernels ativos de uma VM no mesmo n√∫cleo do servidor f√≠sico com a hipertrilha ativada.  Essa situa√ß√£o pode surgir, por exemplo, se a VM tiver mais n√∫cleos do que fisicamente no servidor em que trabalha ou se a configura√ß√£o "preferHT" estiver ativada para a VM.  Voc√™ pode ler sobre essa configura√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br>  Para evitar problemas com o desempenho da VM devido √† alta co-parada, selecione o tamanho da VM de acordo com as recomenda√ß√µes do fabricante do software que √© executado nesta VM e com os recursos do servidor f√≠sico em que a VM est√° sendo executada. <br><br>  N√£o adicione kernels na reserva, isso pode causar problemas de desempenho, n√£o apenas na pr√≥pria VM, mas tamb√©m nos vizinhos do servidor. <br><br><h3>  Outras m√©tricas √∫teis da CPU </h3><br>  <b>Executar</b> - quanto tempo (ms) para o per√≠odo de medi√ß√£o da vCPU estava no estado RUN, ou seja, realmente executou um trabalho √∫til. <br><br>  <b>Inativo</b> - quanto tempo (ms) para o per√≠odo de medi√ß√£o da vCPU ficou inativo.  Valores altos de inatividade n√£o s√£o um problema, apenas a vCPU n√£o tinha "nada a ver". <br><br>  <b>Aguarde</b> - quanto tempo (ms) para o per√≠odo de medi√ß√£o da vCPU estava no estado Aguardar.  Como IDLE est√° inclu√≠do neste contador, os altos valores de espera tamb√©m n√£o indicam um problema.  Por√©m, se a espera for alta, o IDLE estiver baixo, a VM aguardar√° a conclus√£o das opera√ß√µes de E / S, e isso, por sua vez, poder√° indicar um problema com o desempenho do disco r√≠gido ou de alguns dispositivos virtuais da VM. <br><br>  <b>M√°ximo limitado</b> - quanto tempo (ms) para o per√≠odo de medi√ß√£o da vCPU estava no estado Pronto devido ao limite de recursos definido.  Se o desempenho for inexplicavelmente baixo, √© √∫til verificar o valor desse contador e o limite da CPU nas configura√ß√µes da VM.  As VMs podem realmente ter limites dos quais voc√™ n√£o est√° ciente.  Por exemplo, isso acontece quando a VM foi inclinada do modelo no qual o limite da CPU foi definido. <br><br>  <b>Espera de troca</b> - quanto tempo a vCPU aguardou pela opera√ß√£o com o VMkernel Swap durante o per√≠odo de medi√ß√£o.  Se os valores desse contador estiverem acima de zero, a VM definitivamente ter√° problemas de desempenho.  Falaremos mais sobre SWAP no artigo sobre contadores de RAM. <br><br><h3>  ESXTOP </h3><br>  Se os contadores de desempenho no vCenter s√£o bons para analisar dados hist√≥ricos, a an√°lise on-line do problema √© melhor realizada no ESXTOP.  Aqui, todos os valores s√£o apresentados na forma finalizada (sem necessidade de traduzir nada) e o per√≠odo m√≠nimo de medi√ß√£o √© de 2 segundos. <br>  A tela ESXTOP na CPU √© chamada pela tecla "c" e fica assim: <br><br><img src="https://habrastorage.org/webt/5x/8g/-o/5x8g-ovkxsc4xsuuvvk6guv3t0u.png"><br><br>  Por conveni√™ncia, voc√™ pode deixar apenas os processos da m√°quina virtual pressionando Shift-V. <br>  Para ver as m√©tricas dos n√∫cleos individuais da VM, pressione ‚Äúe‚Äù e digite o GID da VM em que voc√™ est√° interessado (30919 na captura de tela abaixo): <br><br><img src="https://habrastorage.org/webt/tu/fn/jz/tufnjzwauierg5thzwsij3elpca.png"><br><br>  Consulte brevemente as colunas que s√£o apresentadas por padr√£o.  Colunas adicionais podem ser adicionadas pressionando ‚Äúf‚Äù. <br><br>  <b>NWLD (n√∫mero de mundos)</b> - o n√∫mero de processos no grupo.  Para expandir o grupo e ver as m√©tricas de cada processo (por exemplo, para cada n√∫cleo de uma VM com v√°rios n√∫cleos), pressione "e".  Se um grupo tiver mais de um processo, os valores das m√©tricas para o grupo ser√£o iguais √† soma das m√©tricas para os processos individuais. <br><br>  <b>% USADO</b> - quantos ciclos a CPU do servidor usa um processo ou grupo de processos. <br><br>  <b>% RUN</b> - quanto tempo durante o per√≠odo de medi√ß√£o o processo estava no estado RUN, ou seja,  realizou um trabalho √∫til.  Difere de% USADO, pois n√£o leva em considera√ß√£o o hyperthreading, a escala de frequ√™ncia e o tempo gasto nas tarefas do sistema (% SYS). <br><br>  <b>% SYS</b> - tempo gasto em tarefas do sistema, por exemplo: manipula√ß√£o de interrup√ß√µes, entrada / sa√≠da, opera√ß√£o de rede etc. O valor pode ser alto se houver muita entrada / sa√≠da na VM. <br><br>  <b>% OVRLP</b> - quanto tempo o n√∫cleo f√≠sico no qual o processo da VM est√° executando gastou nas tarefas de outros processos. <br><br>  Essas m√©tricas est√£o relacionadas da seguinte maneira: <br><br>  % USADO =% RUN +% SYS -% OVRLP. <br><br>  Normalmente, a m√©trica% USED √© mais informativa. <br><br>  <b>% WAIT</b> - quanto tempo durante o per√≠odo de medi√ß√£o o processo ficou no estado Wait.  Inclui IDLE. <br><br>  <b>% IDLE</b> - quanto tempo o processo ficou no estado IDLE durante o per√≠odo de medi√ß√£o. <br><br>  <b>% SWPWT</b> - quanto tempo a vCPU aguardou a opera√ß√£o com o VMkernel Swap durante o per√≠odo de medi√ß√£o. <br><br>  <b>% VMWAIT</b> - quanto tempo a vCPU ficou no estado de espera de um evento (geralmente E / S) durante o per√≠odo de medi√ß√£o.  N√£o h√° contador semelhante no vCenter.  Valores altos indicam problemas com entrada / sa√≠da para a VM. <br><br>  % WAIT =% VMWAIT +% IDLE +% SWPWT. <br><br>  Se a VM n√£o usar o VMkernel Swap, ao analisar problemas de desempenho, √© recomend√°vel examinar% VMWAIT, pois essa m√©trica n√£o leva em considera√ß√£o o tempo em que a VM n√£o fez nada (% IDLE). <br><br>  <b>% RDY</b> - quanto tempo o processo ficou no estado Pronto durante o per√≠odo de medi√ß√£o. <br><br>  <b>% CSTP</b> - quanto tempo o processo ficou no estado p√≥s durante o per√≠odo de medi√ß√£o. <br><br>  <b>% MLMTD</b> - quanto tempo durante o per√≠odo de medi√ß√£o da vCPU estava no estado Pronto devido ao limite de recursos definido. <br><br>  % WAIT +% RDY +% CSTP +% RUN = 100% - o n√∫cleo da VM est√° sempre em um desses quatro estados. <br><br><h3>  CPU no hypervisor </h3><br>  Tamb√©m existem contadores de desempenho da CPU para o hypervisor no vCenter, mas eles n√£o representam nada de interessante - √© apenas a soma dos contadores de todas as VMs no servidor. <br>  A maneira mais conveniente de ver o status da CPU no servidor √© na guia Resumo: <br><br><img src="https://habrastorage.org/webt/cr/zn/bb/crznbbcz3ifhippyvvrpqaotvps.png"><br><br>  Para o servidor, bem como para a m√°quina virtual, h√° um alarme padr√£o: <br><br><img src="https://habrastorage.org/webt/-v/x0/gz/-vx0gzuta3wskstyrmu8ylixqla.png"><br><br>  Com uma carga alta na CPU do servidor, as VMs em execu√ß√£o nele come√ßam a ter problemas de desempenho. <br><br>  No ESXTOP, os dados de utiliza√ß√£o da CPU do servidor s√£o apresentados na parte superior da tela.  Al√©m da carga padr√£o da CPU, que n√£o √© informativa para os hipervisores, h√° mais tr√™s m√©tricas: <br><br>  <b>N√öCLEO UTIL (%)</b> - carregando o n√∫cleo do servidor f√≠sico.  Este contador mostra quanto tempo o kernel executou o trabalho durante o per√≠odo de medi√ß√£o. <br><br>  <b>PCPU UTIL (%)</b> - se o <b>hyperthreading</b> estiver ativado, haver√° dois threads (PCPU) para cada n√∫cleo f√≠sico.  Essa m√©trica mostra quanto tempo cada thread fez o trabalho. <br><br>  <b>PCPU USADO (%)</b> √© o mesmo que PCPU UTIL (%), mas leva em considera√ß√£o o escalonamento de frequ√™ncia (diminuindo a frequ√™ncia central para economia de energia ou aumentando a frequ√™ncia central devido √† tecnologia Turbo Boost) e o hyperthreading. <br><br>  PCPU_USED% = PCPU_UTIL% * frequ√™ncia central efetiva / frequ√™ncia nominal central. <br><br><img src="https://habrastorage.org/webt/gk/il/nh/gkilnhtdazgv5nxiwbydkhda-oe.png"><br>  <i>Nesta captura de tela, para alguns n√∫cleos, devido √† opera√ß√£o do Turbo Boost, o valor USED √© superior a 100%, pois a frequ√™ncia do n√∫cleo √© superior ao nominal.</i> <br><br>  Algumas palavras sobre como o hiperencadeamento √© levado em considera√ß√£o.  Se os processos executam 100% do tempo nos dois segmentos do n√∫cleo f√≠sico do servidor, enquanto o n√∫cleo √© executado na frequ√™ncia nominal, ent√£o: <br><br><ul><li>  O CORE UTIL para o kernel ser√° 100%, </li><li>  O PCPU UTIL para os dois segmentos ser√° 100%, </li><li>  PCED USADO para os dois segmentos ser√° de 50%. </li></ul><br>  Se os dois threads n√£o funcionaram 100% do tempo durante o per√≠odo de medi√ß√£o, nos per√≠odos em que os threads funcionaram em paralelo, a PCPU USADA para n√∫cleos √© dividida pela metade. <br><br>  O ESXTOP tamb√©m possui uma tela com os par√¢metros de consumo de energia do servidor da CPU.  Aqui voc√™ pode ver se o servidor usa tecnologias de economia de energia: estados C e estados P.  Chamado pela tecla p: <br><br><img src="https://habrastorage.org/webt/cd/qv/he/cdqvhelnmce9qeseanbqzl3qsqs.png"><br><br><h3>  Problemas comuns de desempenho da CPU </h3><br>  Por fim, analisarei os motivos t√≠picos de problemas com o desempenho da VM da CPU e darei breves dicas para resolv√™-los: <br><br>  <b>Velocidade do clock do n√∫cleo insuficiente.</b>  Se n√£o houver maneira de transferir VMs para kernels mais eficientes, tente alterar as configura√ß√µes de energia para fazer o Turbo Boost funcionar com mais efici√™ncia. <br><br>  <b>Dimensionamento incorreto da VM (muitos / poucos n√∫cleos).</b>  Se voc√™ colocar poucos n√∫cleos, haver√° uma carga alta na CPU da VM.  Se muito, pegue um co-stop alto. <br><br>  <b>Excesso de assinatura grande na CPU no servidor.</b>  Se a VM estiver alta Pronta, reduza a assinatura em excesso na CPU. <br><br>  <b>Topologia NUMA incorreta em VMs grandes.</b>  A topologia NUMA que a VM v√™ (vNUMA) deve corresponder √† topologia do servidor NUMA (pNUMA).  Os diagn√≥sticos e as poss√≠veis solu√ß√µes para esse problema est√£o escritos, por exemplo, no livro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">"Deep Dive do VMware vSphere 6.5 Host Resources"</a> .  Se voc√™ n√£o quiser ir mais fundo e n√£o tiver restri√ß√µes de licenciamento no sistema operacional instalado na VM, execute v√°rios soquetes virtuais na VM em um √∫nico n√∫cleo.  Voc√™ n√£o vai perder muito :) <br><br>  Isso √© tudo para a CPU.  Fa√ßa perguntas.  Na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pr√≥xima parte</a> , falarei sobre RAM. <br><br><div class="spoiler">  <b class="spoiler_title">Links √∫teis</b> <div class="spoiler_text">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://virtual-red-dot.info/vm-cpu-counters-vsphere/</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://kb.vmware.com/kb/1017926</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://www.yellow-bricks.com/2012/07/17/why-is-wait-so-high/</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://communities.vmware.com/docs/DOC-9279</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://www.vmware.com/content/dam/digitalmarketing/vmware/en/pdf/techpaper/performance/whats-new-vsphere65-perf.pdf</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://pages.rubrik.com/host-resources-deep-dive_request.html</a> </div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt452884/">https://habr.com/ru/post/pt452884/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt452856/index.html">Por que projetos indie n√£o vivem para lan√ßar</a></li>
<li><a href="../pt452872/index.html">Como n√£o me preparei e realizei um semin√°rio de Rosnanov sobre FPGAs em Moscou. Planeja fazer o mesmo em Las Vegas e Zelenograd</a></li>
<li><a href="../pt452876/index.html">UICollectionViewLayout para pizza de diferentes partes</a></li>
<li><a href="../pt452880/index.html">Dados sensacionais dos usu√°rios vazam de janeiro a abril de 2019</a></li>
<li><a href="../pt452882/index.html">Erro do cliente no primeiro contato com o freelancer</a></li>
<li><a href="../pt452886/index.html">Projetos Wiki e nome Noosfera em HACKNOWLEGE</a></li>
<li><a href="../pt452888/index.html">Perto de Munique, come√ßou a testar o tiltrotor Lilium Jet de cinco lugares</a></li>
<li><a href="../pt452890/index.html">23 de maio, 18:30 - transmiss√£o ao vivo da cozinha QIWI</a></li>
<li><a href="../pt452892/index.html">Como um n√£o programador pode se mudar para os EUA: instru√ß√µes passo a passo</a></li>
<li><a href="../pt452894/index.html">Enfrente o Anti-Spoofing ou reconhe√ßa tecnologicamente um trapaceiro entre mil</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>