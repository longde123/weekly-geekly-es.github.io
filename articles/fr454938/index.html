<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§ûüèª üçß üññüèæ D√©veloppement de son propre noyau pour l'int√©gration dans un syst√®me de processeur bas√© sur FPGA üòî ‚öîÔ∏è üèß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ainsi, dans le premier article du cycle, il a √©t√© dit qu'il √©tait pr√©f√©rable d'utiliser un syst√®me de processeur pour contr√¥ler nos √©quipements mis en...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>D√©veloppement de son propre noyau pour l'int√©gration dans un syst√®me de processeur bas√© sur FPGA</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454938/"><img src="https://habrastorage.org/webt/ze/eo/9f/zeeo9fw5rmqp8pk7lsmr0cytbve.jpeg"><br><br>  Ainsi, dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">premier article du cycle,</a> il a √©t√© dit qu'il √©tait pr√©f√©rable d'utiliser un syst√®me de processeur pour contr√¥ler nos √©quipements mis en ≈ìuvre √† l'aide de FPGA pour le complexe Redd, puis au cours des premier et deuxi√®me articles, il a √©t√© montr√© comment fabriquer ce syst√®me.  Eh bien, c'est fait, nous pouvons m√™me choisir des noyaux pr√™ts √† l'emploi dans la liste pour les inclure, mais le but ultime est de g√©rer nos propres noyaux personnalis√©s.  Le moment est venu de r√©fl√©chir √† la mani√®re d'inclure un noyau arbitraire dans le syst√®me de processeur. <br><a name="habracut"></a><br>  Tous les articles du cycle: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">D√©veloppement du ¬´firmware¬ª le plus simple pour les FPGA install√©s dans Redd, et d√©bogage en utilisant le test de m√©moire comme exemple</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">D√©veloppement du ¬´firmware¬ª le plus simple pour les FPGA install√©s dans Redd.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 2. Code de programme</a> <br><br>  Pour comprendre la th√©orie d'aujourd'hui, vous devez trouver et t√©l√©charger le document <b>Sp√©cifications de l'interface Avalon</b> , car le bus <b>Avalon</b> est le bus de base du syst√®me NIOS II.  Je me r√©f√©rerai aux sections, tableaux et figures pour la r√©vision du document du 26 septembre 2018. <br><br>  Nous ouvrons la section 3 consacr√©e aux interfaces mapp√©es en m√©moire, ou plut√¥t - 3.2.  Le tableau 9 r√©pertorie les signaux de bus.  Veuillez noter que tous ces signaux sont facultatifs.  Je n'ai trouv√© aucun signal contenant ¬´Oui¬ª dans la colonne Obligatoire.  Nous pouvons tr√®s bien ne pas transmettre tel ou tel signal √† notre appareil.  Par cons√©quent, dans le cas le plus simple, le bus est extr√™mement simple √† mettre en ≈ìuvre.  Le d√©but du tableau ressemble √† ceci: <br><br><img src="https://habrastorage.org/webt/qj/et/kn/qjetkngv8gubiwwtqtx8atvab7c.png"><br><br>  Comme vous pouvez le voir, tous les signaux sont tr√®s bien d√©crits (sauf que cela se fait en anglais).  Voici les chronogrammes pour divers cas.  Le cas le plus simple ne pose aucune question.  Je vais maintenant prendre le chronogramme du document et couvrir certaines des lignes avec un remplissage translucide (elles sont toutes facultatives, nous avons le droit d'exclure toutes les consid√©rations). <br><br><img src="https://habrastorage.org/webt/q4/oz/w_/q4ozw_efgf6v6adbdhnkdeacply.png"><br><br>  Effrayant  Mais tout est simple: on nous donne l'adresse et le stroboscope de <b>lecture</b> , il faut r√©gler les donn√©es sur le bus readdata.  Et vice versa: on nous donne l'adresse, les donn√©es sur le bus de donn√©es √©crites et le stroboscope d'√©criture, et nous devons capturer les donn√©es.  Ce n'est pas du tout effrayant, un bus synchrone typique. <br><br>  Des lignes de seize tables cach√©es <b>sont</b> n√©cessaires dans le cas o√π l'acc√®s √† la m√©moire n'est pas des mots de 32 bits.  Ceci est extr√™mement important lorsque nous concevons des noyaux universels.  Mais lorsque nous concevons un noyau d'un jour, nous √©crivons simplement dans le document √† propos de ce noyau (je suis un opposant √† la marque dans ma t√™te, mais quelqu'un peut le limiter √† cela) que nous devons utiliser des mots de 32 bits et c'est tout.  Et bien, et le signal de <b>r√©ponse</b> , c'est tr√®s sp√©cial, et √ßa ne nous int√©resse pas en principe. <br><br>  Parfois, il est important que lorsque l'√©quipement n'est pas pr√™t, il soit possible de retarder le fonctionnement du bus pendant plusieurs cycles d'horloge.  Dans ce cas, le signal <b>WaitRequest</b> doit √™tre ajout√©.  Le chronogramme changera comme suit: <br><br><img src="https://habrastorage.org/webt/sy/hr/lf/syhrlf64dvm-zrr262xvveicea4.png"><br><br>  Pendant que <b>WaitRequest est</b> arm√©, l'assistant sait que notre appareil est occup√©.  Soyez prudent si ce signal n'est pas r√©initialis√©, le syst√®me entier "g√®lera" lors de la manipulation, donc seul un red√©marrage du FPGA peut le r√©initialiser.  JTAG se bloque avec le syst√®me.  La derni√®re fois que j'ai observ√© ce ph√©nom√®ne, c'√©tait lors de la pr√©paration de cet article, donc les souvenirs sont toujours vifs. <br><br>  Plus loin dans le document de l'entreprise, des cas plus productifs de pipelining de donn√©es et de transactions par lots sont envisag√©s, mais la t√¢che de l'article n'est pas de consid√©rer toutes les options possibles, mais de montrer au lecteur la fa√ßon de travailler, en soulignant que tout cela n'est pas du tout effrayant, nous nous limiterons donc √† ces deux options simples. <br><br>  Concevons un appareil simple qui deviendra p√©riodiquement indisponible sur le bus.  La premi√®re chose qui me vient √† l'esprit est l'interface s√©rie.  Pendant la transmission, nous ferons attendre le syst√®me.  Et dans la vie, je d√©conseille fortement de faire cela: le processeur s'arr√™tera jusqu'√† la fin d'une transaction occup√©e, mais c'est un cas id√©al pour un article, car le code d'impl√©mentation sera compr√©hensible et peu encombrant.  En g√©n√©ral, nous fabriquons un √©metteur s√©rie qui peut envoyer des donn√©es et des signaux de s√©lection de puce √† deux appareils. <br><br><img src="https://habrastorage.org/webt/fr/uj/_u/fruj_ufw0phhzgbovupezinxo6c.png"><br><br>  Commen√ßons par l'option de pneu la plus simple.  Faisons un port de sortie parall√®le, qui forme les signaux du choix des cristaux. <br><br><img src="https://habrastorage.org/webt/rc/z6/yg/rcz6ygig6s3yz-bxsjwsbonygp4.png"><br><br>  Pour cela, je prendrai le projet obtenu dans l'article pr√©c√©dent, mais afin d'√©viter toute confusion, je le mettrai dans le r√©pertoire AVALON_DEMO.  Je ne changerai pas les noms des autres fichiers.  Dans ce r√©pertoire, cr√©ez le r√©pertoire <b>my_cores</b> .  Le nom du r√©pertoire peut √™tre n'importe quoi.  Nous y stockerons nos noyaux.  Certes, aujourd'hui, il en sera un.  Cr√©ez un fichier <b>CrazySerial.sv</b> avec le contenu suivant: <br><pre><code class="plaintext hljs">module CrazySerial ( input clk, input reset, input [1:0] address, input write, input [31:0] writedata, output reg [1:0] cs ); always @(posedge clk, posedge reset) begin if (reset == 1) begin cs &lt;= 0; end else begin if (write) case (address) 2'h00: cs &lt;= writedata [1:0]; default:; endcase end end endmodule</code> </pre> <br>  Faisons les choses correctement.  Tout d'abord, les lignes d'interface.  <b>clk</b> et <b>reset</b> sont les lignes d'horloge et de r√©initialisation.  Les noms des <b>adresses</b> , <b>des</b> <b>lignes d'</b> <b>√©criture</b> et d' <b>√©criture</b> sont extraits du tableau avec la liste des signaux du document <b>Interfaces Mapp√©es en M√©moire</b> . <br><br><img src="https://habrastorage.org/webt/lz/q9/rv/lzq9rvmj8mekwwiqqene5mvbu7i.png"><br><br><img src="https://habrastorage.org/webt/pe/xz/a-/pexza-dsswt01-shzs4sy0pkjay.png"><br><br>  En fait, je pourrais donner n'importe quel nom.  La liaison de lignes logiques avec des lignes physiques sera effectu√©e ult√©rieurement.  Mais si vous donnez les noms, comme dans le tableau, l'environnement de d√©veloppement les connectera par lui-m√™me.  Par cons√©quent, il est pr√©f√©rable de prendre les noms de la table. <br><br>  Eh bien, <b>cs</b> sont les lignes de s√©lection des cristaux qui sortiront de la puce. <br><br>  L'impl√©mentation elle-m√™me est triviale.  Lors de la r√©initialisation, les sorties sont mises √† z√©ro.  Et donc - √† chaque mesure, nous v√©rifions s'il y a un signal d' <b>√©criture</b> .  S'il existe une adresse √©gale √† z√©ro, cliquez sur les donn√©es.  Bien s√ªr, il serait possible d'ajouter un d√©codeur ici, ce qui emp√™chera le choix de deux appareils √† la fois, mais ce qui est bien dans la vie surchargera l'article.  L'article ne fournit que les √©tapes les plus n√©cessaires, cependant, il est √† noter que dans la vie, tout peut √™tre fait plus compliqu√©. <br><br>  Super.  Nous sommes pr√™ts √† introduire ce code dans le syst√®me de processeur.  Nous allons √† <b>Platform Designer</b> , s√©lectionnez comme fichier d'entr√©e le syst√®me que nous avons construit dans les exp√©riences pr√©c√©dentes: <br><br><img src="https://habrastorage.org/webt/vd/a3/mp/vda3mpnhkbmfl9gj037h7kyefs8.png"><br><br>  Nous attirons l'attention sur l' <b>√©l√©ment Nouveau composant</b> dans le coin sup√©rieur gauche: <br><br><img src="https://habrastorage.org/webt/iz/xq/hw/izxqhw8wg6jshahucg0ardu7ukg.png"><br><br>  Pour ajouter votre composant, cliquez sur cet √©l√©ment.  Dans la bo√Æte de dialogue qui s'ouvre, remplissez les champs.  Et pour l'article, remplissez uniquement le nom du composant: <br><br><img src="https://habrastorage.org/webt/nn/l8/mt/nnl8mtcsdxmqyp6cjnkrcr-qlc0.png"><br><br>  Maintenant, allez dans l'onglet <b>Fichiers</b> et cliquez sur <b>Ajouter un fichier</b> : <br><br><img src="https://habrastorage.org/webt/fo/rw/jx/forwjxin05orcsaaw7uuuiw1mra.png"><br><br>  Ajoutez le fichier cr√©√© pr√©c√©demment, s√©lectionnez-le dans la liste et cliquez sur <b>Analyser le fichier de synth√®se</b> : <br><br><img src="https://habrastorage.org/webt/a_/-i/g0/a_-ig0-b-v--safmwwco-gcblvi.png"><br><br>  Il n'y a aucune erreur lors de l'analyse de <b>SystemVerilog</b> , mais il existe plusieurs erreurs conceptuelles.  Ils sont dus au fait que certaines lignes √©taient mal connect√©es par l'environnement de d√©veloppement.  Nous allons dans l'onglet <b>Signaux &amp; Interfaces</b> et faisons attention ici: <br><br><img src="https://habrastorage.org/webt/be/7s/nb/be7snb0yjnqj8qn-ku_dboeirjs.png"><br><br>  Les lignes <b>cs</b> ont √©t√© incorrectement affect√©es √† l'interface <b>avalon_slave0</b> , le signal <b>readdata</b> .  Mais ensuite, toutes les autres lignes ont √©t√© reconnues correctement, gr√¢ce au fait que nous leur avons donn√© des noms √† partir du tableau de documents.  Mais que faire des lignes probl√©matiques?  Ils doivent √™tre affect√©s √† une interface comme un <b>conduit</b> .  Pour ce faire, cliquez sur l'√©l√©ment ¬´ajouter une interface¬ª <br><br><img src="https://habrastorage.org/webt/ur/ce/je/urcejebzbrayxcoyvs16vorleik.png"><br><br>  Dans le menu d√©roulant, s√©lectionnez <b>conduit</b> : <br><br><img src="https://habrastorage.org/webt/2-/l-/45/2-l-45h1b_8jnat3uazcscgcpt0.png"><br><br>  Nous obtenons une nouvelle interface: <br><br><img src="https://habrastorage.org/webt/g_/r4/j0/g_r4j0acbfvawp7plewjmsolw1e.png"><br><br>  Si vous le souhaitez, il peut √™tre renomm√©.  Certes, cela sera certainement n√©cessaire si nous voulons faire plusieurs interfaces externes.  Dans le cadre de l'article, nous lui laisserons le nom <b>conduit_end</b> .  Maintenant, nous accrochons la ligne <b>cs</b> avec la souris et la faisons glisser dans cette interface.  Nous devons r√©ussir √† lancer un signal sous la ligne <b>conduit_end</b> , nous serons alors autoris√©s √† le faire.  Dans d'autres endroits, le curseur appara√Ætra comme un cercle barr√©.  En fin de compte, nous devrions avoir ceci: <br><br><img src="https://habrastorage.org/webt/gb/2e/lw/gb2elw6dvx2iw11y28uq0qlye5q.png"><br><br>  Remplacez le type de signal par <b>readdata</b> avec, disons, <b>chipselect</b> .  Image finale: <br><br><img src="https://habrastorage.org/webt/6o/ur/gq/6ourgq054tn85rth2nixk33_pvs.png"><br><br>  Mais les erreurs sont rest√©es.  Le <b>bus Avalon</b> ne re√ßoit pas de signal de r√©initialisation.  Nous s√©lectionnons <b>avalon_slave_0</b> dans la liste et examinons ses propri√©t√©s. <br><br><img src="https://habrastorage.org/webt/s6/0i/--/s60i--4ijigk6exutkovd5zlwi0.png"><br><br>  Remplacer <b>aucun</b> avec <b>r√©initialisation</b> .  Dans le m√™me temps, nous examinerons les autres propri√©t√©s de l'interface. <br><br><img src="https://habrastorage.org/webt/xn/4d/kf/xn4dkf5jpxsi-6ujubxeuptddo4.png"><br><br>  On peut voir que l'adressage est en mots.  Eh bien, un certain nombre d'autres √©l√©ments de la documentation sont configur√©s ici.  Les diagrammes de temps obtenus dans ce cas seront dessin√©s tout en bas des propri√©t√©s: <br><br><img src="https://habrastorage.org/webt/xc/nw/xq/xcnwxqjxkz7y4qgxtcmn6ulb5eu.png"><br><br>  En fait, il n'y a plus d'erreurs.  Vous pouvez cliquer sur <b>Terminer</b> .  Notre module cr√©√© est apparu dans l'arborescence des appareils: <br><br><img src="https://habrastorage.org/webt/rt/qe/bz/rtqebza22wictmnw0cpgvw_uu3g.png"><br><br>  Ajoutez-le au syst√®me de processeur, connectez les signaux d'horloge et r√©initialisez.  Nous connectons le bus de <b>donn√©es au</b> processeur <b>Data Master</b> .  Double-cliquez sur <b>Conduit_end</b> et donnez au signal externe un nom, par exemple, des <b>lignes</b> .  Cela se r√©v√®le en quelque sorte comme ceci: <br><br><img src="https://habrastorage.org/webt/ob/mm/al/obmmalo6x1jytho2mzkvy4emdbu.png"><br><br>  Il est important de ne pas oublier que puisque nous avons ajout√© un bloc au syst√®me, nous devons nous assurer qu'il n'entre en conflit avec personne dans l'espace d'adressage.  Dans ce cas particulier, il n'y a pas de conflits dans la figure, mais de toute fa√ßon, je s√©lectionnerai l'√©l√©ment de menu <b>Syst√®me-&gt; Attribuer des adresses de base</b> . <br><br>  C‚Äôest tout.  Le bloc est cr√©√©, configur√©, ajout√© au syst√®me.  Cliquez sur le bouton <b>G√©n√©rer HDL</b> , puis sur <b>Terminer</b> . <br><br>  Nous faisons un brouillon du projet, apr√®s quoi nous allons au <b>Pin Planner</b> et assignons les jambes.  Il s'est av√©r√© comme ceci: <br><br><img src="https://habrastorage.org/webt/mn/fs/39/mnfs39ezihwpwese2tsdto4ialc.png"><br><br>  Ce qui correspond aux contacts B22 et C22 du connecteur d'interface. <br><br>  Nous faisons l'assemblage final, chargeons le syst√®me de processeur dans le FPGA.  Maintenant, nous devons affiner le code du programme.  Lancez Eclipse. <br><br>  Permettez-moi de vous rappeler que je travaille actuellement avec un projet qui se trouve dans un r√©pertoire diff√©rent par rapport √† mon dernier travail avec Redd.  Afin de ne pas √™tre confus, je supprimerai les anciens projets de l'arborescence (mais uniquement de l'arborescence, sans effacer les fichiers eux-m√™mes). <br><br><img src="https://habrastorage.org/webt/xm/jv/ch/xmjvchikm8_ukin_evoqdw28op8.png"><br><br>  Ensuite, je clique sur le bouton droit de la souris sur une arborescence vide et s√©lectionne <b>Importer</b> dans le menu: <br><br><img src="https://habrastorage.org/webt/yp/kt/sf/ypktsfboxaxgfhqcubjnlwogoxq.png"><br><br>  Suivant - <b>G√©n√©ral</b> - <b>&gt; Projet existant dans l'espace de travail</b> : <br><br><img src="https://habrastorage.org/webt/rb/dw/me/rbdwmebel6yu6hjmvyxn7hik0q8.png"><br><br>  Et s√©lectionnez simplement le r√©pertoire dans lequel les fichiers du projet sont stock√©s: <br><br><img src="https://habrastorage.org/webt/nd/3t/6h/nd3t6hwmddm9pfrwr4cjd4iw4hy.png"><br><br><img src="https://habrastorage.org/webt/ei/qg/de/eiqgdehf_klzhkyyleod_opnlgq.png"><br><br>  Les deux projets h√©rit√©s des exp√©riences pass√©es se connecteront √† l'environnement de d√©veloppement. <br><br><img src="https://habrastorage.org/webt/qq/vw/jk/qqvwjkfgoli7vu3wedt3qhbnsf0.png"><br><br>  Je mettrai en √©vidence l'√©l√©ment suivant dans un cadre: <br><blockquote>  Apr√®s chaque modification de la configuration mat√©rielle, s√©lectionnez √† nouveau l'√©l√©ment de menu <b>Nios II -&gt; G√©n√©rer BSP</b> pour le projet BSP. </blockquote><br><br><img src="https://habrastorage.org/webt/ks/jn/mt/ksjnmtcdfbf2p0vej4qeeltlkxk.png"><br><br>  En fait, apr√®s cette op√©ration, un nouveau bloc est apparu dans le <b>fichier \ AVALON_DEMO \ software \ SDRAMtest_bsp \ system.h</b> : <br><pre> <code class="plaintext hljs">/* * CrazySerial_0 configuration * */ #define ALT_MODULE_CLASS_CrazySerial_0 CrazySerial #define CRAZYSERIAL_0_BASE 0x4011020 #define CRAZYSERIAL_0_IRQ -1 #define CRAZYSERIAL_0_IRQ_INTERRUPT_CONTROLLER_ID -1 #define CRAZYSERIAL_0_NAME "/dev/CrazySerial_0" #define CRAZYSERIAL_0_SPAN 16 #define CRAZYSERIAL_0_TYPE "CrazySerial"</code> </pre><br>  Tout d'abord, nous nous int√©ressons √† la constante <b>CRAZYSERIAL_0_BASE</b> . <br><br>  Ajoutez le code suivant √† la fonction <b>main ()</b> : <br><pre> <code class="plaintext hljs"> while (true) { IOWR_ALTERA_AVALON_PIO_DATA (CRAZYSERIAL_0_BASE,0x00); IOWR_ALTERA_AVALON_PIO_DATA (CRAZYSERIAL_0_BASE,0x01); IOWR_ALTERA_AVALON_PIO_DATA (CRAZYSERIAL_0_BASE,0x02); IOWR_ALTERA_AVALON_PIO_DATA (CRAZYSERIAL_0_BASE,0x03); }</code> </pre><br>  Nous commen√ßons le d√©bogage et regardons le contenu des lignes avec un oscilloscope.  Il doit y avoir du code binaire incr√©mentiel.  Il est l√†. <br><br><img src="https://habrastorage.org/webt/fm/xp/0z/fmxp0z5mactvzv-vdv2cahbvj1i.png"><br><br>  De plus, la fr√©quence d'acc√®s aux ports est tout simplement magnifique: <br><br><img src="https://habrastorage.org/webt/cm/rd/of/cmrdofrh6yzmo2xwdkjynz6gwwm.png"><br><br>  Environ 25 MHz est la moiti√© de la fr√©quence du bus (2 cycles d'horloge).  Parfois, le temps d'acc√®s n'est pas de 2 cycles, mais plus long.  Cela est d√ª √† l'ex√©cution d'op√©rations de branchement dans le programme.  En g√©n√©ral, l'acc√®s le plus simple au bus fonctionne. <br><br>  Il est temps d'ajouter par exemple la fonctionnalit√© du port s√©rie.  Pour ce faire, ajoutez le signal d'interface de <b>demande d'attente</b> li√© au bus et une paire de signaux de port s√©rie - <b>sck</b> et <b>sdo</b> .  Au total, nous obtenons le fragment de code suivant sur <b>systemverilog</b> : <br><br><img src="https://habrastorage.org/webt/dy/wc/vt/dywcvtwz6_h4ccubotauamcnnju.png"><br><br><div class="spoiler">  <b class="spoiler_title">M√™me texte:</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">module CrazySerial ( input clk, input reset, input [1:0] address, input write, input [31:0] writedata, output waitrequest, output reg [1:0] cs, output reg sck, output sdo );</code> </pre><br></div></div><br>  Selon les r√®gles de bonne forme, vous devez faire une machine simple qui transmettra des donn√©es.  Malheureusement, la machine la plus simple de l'article sera tr√®s difficile.  Mais en fait, si je n'augmente pas la fonctionnalit√© de la machine (et je ne vais pas le faire dans le cadre de l'article), alors elle n'aura que deux √©tats: la transmission est en cours et la transmission n'est pas en cours.  Par cons√©quent, je peux encoder l'√©tat avec un seul signal: <br>  envoi reg = 0; <br><br>  Pendant la transmission, j'ai besoin d'un compteur de bits, d'un diviseur d'horloge (je fais un appareil d√©lib√©r√©ment lent) et d'un registre √† d√©calage pour les donn√©es transmises.  Ajoutez les registres appropri√©s: <br><pre> <code class="plaintext hljs"> reg [2:0] bit_cnt = 0; reg [3:0] clk_div = 0; reg [7:0] shifter = 0;</code> </pre><br>  Je diviserai la fr√©quence par 10 (guid√©e par le principe "pourquoi pas?").  En cons√©quence, √† la cinqui√®me √©tape, j'armerai SCK, et √† la dixi√®me - supprimez cette ligne, apr√®s quoi - passez au bit de donn√©es suivant.  Pour toutes les autres mesures, augmentez simplement le compteur du diviseur.  Il est important de ne pas oublier que sur la quatri√®me mesure, vous devez √©galement augmenter le compteur, et sur la neuvi√®me - z√©ro.  Si nous omettons la transition vers le bit suivant, la logique sp√©cifi√©e ressemble √† ceci: <br><pre> <code class="plaintext hljs"> if (sending) begin case (clk_div) 4: begin sck &lt;= 1; clk_div &lt;= clk_div + 1; end 9: begin sck &lt;= 0; clk_div &lt;= 0; // &lt;   &gt; end default: clk_div &lt;= clk_div + 1; endcase end else</code> </pre><br>  Passer au bit suivant est facile.  Ils ont d√©cal√© le registre √† d√©calage, puis, si le bit actuel est le septi√®me, ils ont cess√© de fonctionner en commutant l'√©tat de la machine, sinon ils ont augment√© le compteur de bits. <br><pre> <code class="plaintext hljs"> shifter &lt;= {shifter[6:0],1'b0}; if (bit_cnt == 7) begin sending &lt;= 0; end else begin bit_cnt &lt;= bit_cnt + 1; end</code> </pre><br>  En fait, c'est tout.  Le bit de sortie est toujours extrait du bit haut du registre √† d√©calage: <br><pre> <code class="plaintext hljs"> assign sdo = shifter [7];</code> </pre><br>  Et la ligne la plus importante pour la r√©vision actuelle.  Le signal de <b>demande d'attente est</b> arm√© √† l'unit√© toujours lorsque des donn√©es s√©rie sont transmises.  C'est-√†-dire que c'est une copie du signal d' <b>envoi</b> qui d√©finit l'√©tat de la machine: <br><pre> <code class="plaintext hljs"> assign waitrequest = sending;</code> </pre><br>  Eh bien, et lors de l'√©criture √† l'adresse 1 (rappel, nous avons ici l'adressage en mots de 32 bits), nous encliquetons les donn√©es dans le registre √† d√©calage, remettons √† z√©ro les compteurs et commen√ßons le processus de transfert: <br><pre> <code class="plaintext hljs"> if (write) //... 2'h01: begin bit_cnt &lt;= 0; clk_div &lt;= 0; sending &lt;= 1; shifter &lt;= writedata [7:0]; end default:; endcase end</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Je vais maintenant donner tous les fragments d√©crits comme un seul texte:</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">module CrazySerial ( input clk, input reset, input [1:0] address, input write, input [31:0] writedata, output waitrequest, output reg [1:0] cs, output reg sck, output sdo ); reg sending = 0; reg [2:0] bit_cnt = 0; reg [3:0] clk_div = 0; reg [7:0] shifter = 0; always @(posedge clk, posedge reset) begin if (reset == 1) begin cs &lt;= 0; sck &lt;= 0; sending &lt;= 0; end else begin if (sending) begin case (clk_div) 4: begin sck &lt;= 1; clk_div &lt;= clk_div + 1; end 9: begin clk_div &lt;= 0; shifter &lt;= {shifter[6:0],1'b0}; sck &lt;= 0; if (bit_cnt == 7) begin sending &lt;= 0; end else begin bit_cnt &lt;= bit_cnt + 1; end end default: clk_div &lt;= clk_div + 1; endcase end else if (write) case (address) 2'h00: cs &lt;= writedata [1:0]; 2'h01: begin bit_cnt &lt;= 0; clk_div &lt;= 0; sending &lt;= 1; shifter &lt;= writedata [7:0]; end default:; endcase end end assign sdo = shifter [7]; assign waitrequest = sending; endmodule</code> </pre><br></div></div><br>  Nous commen√ßons √† introduire un nouveau code dans le syst√®me.  En fait, le chemin d'acc√®s est le m√™me que lors de la cr√©ation du composant, mais certaines √©tapes peuvent d√©j√† √™tre omises.  Nous allons maintenant nous familiariser avec le processus de raffinement.  Acc√©dez √† <b>Platform Designer</b> .  Si nous ne changions que le code verilog, il serait assez simple d'effectuer l'op√©ration <b>Generate HDL</b> pour le syst√®me fini.  Mais comme le module a de nouvelles lignes (c'est-√†-dire que l'interface a chang√©), il doit √™tre refait.  Pour ce faire, s√©lectionnez-le dans l'arborescence, appuyez sur le bouton droit de la souris et s√©lectionnez <b>Modifier</b> . <br><br><img src="https://habrastorage.org/webt/sg/el/hx/sgelhxlzgzwjz81z6q7xhkhbxzs.png"><br><br>  Nous √©ditons un syst√®me existant.  Il suffit donc d'aller dans l'onglet <b>Fichiers</b> et de cliquer sur <b>Analyser les fichiers de sinth√®se</b> : <br><br><img src="https://habrastorage.org/webt/qy/nw/0q/qynw0q5tul7k26yaygdyzsigouu.png"><br><br>  De mani√®re pr√©visible, des erreurs se sont produites.  Mais nous savons d√©j√† que les mauvaises lignes sont √† bl√¢mer.  Par cons√©quent, nous allons dans l'onglet <b>Signaux et interfaces</b> , faites glisser <b>sck</b> et <b>sdo le</b> long de la m√™me ligne de l'interface <b>avalon_slave_0</b> vers l'interface <b>conduit_end</b> : <br><br><img src="https://habrastorage.org/webt/z_/rz/jj/z_rzjjaaiaqzey6gczf6ptt0vfa.png"><br><br>  Renommez √©galement les champs <b>Type de signal</b> pour eux.  Le r√©sultat devrait √™tre le suivant: <br><br><img src="https://habrastorage.org/webt/ng/3_/t_/ng3_t_kiebqf_jw3wwljh0aqsig.png"><br><br>  En fait, c'est tout.  Cliquez sur <b>Terminer</b> , appelez <b>G√©n√©rer un fichier HDL</b> pour le syst√®me de processeur, r√©digez le projet dans Quartus, attribuez de nouvelles √©tapes: <br><br><img src="https://habrastorage.org/webt/ul/hg/rh/ulhgrhytzp1y9149j8x11apyvcy.png"><br><br>  Ce sont les contacts A21 et A22 du connecteur d'interface, nous faisons l'assemblage final, remplissez le ¬´firmware¬ª dans le FPGA. <br><br>  Fer mis √† jour.  Maintenant, le programme.  Allons √† Eclipse.  Que retenons-nous de faire l√†-bas?  C'est vrai, n'oubliez pas de choisir <b>G√©n√©rer BSP</b> . <br><br>  En fait, c'est tout.  Il reste √† ajouter des fonctionnalit√©s au programme.  Transf√©rons une paire d'octets vers le port s√©rie, mais nous enverrons le premier octet au p√©riph√©rique s√©lectionn√© par la ligne <b>cs [0]</b> et le second - <b>cs [1]</b> . <br><pre> <code class="plaintext hljs"> IOWR_ALTERA_AVALON_PIO_DATA (CRAZYSERIAL_0_BASE,0x01); IOWR_ALTERA_AVALON_PIO_DATA (CRAZYSERIAL_0_BASE+4,0x12); IOWR_ALTERA_AVALON_PIO_DATA (CRAZYSERIAL_0_BASE,0x02); IOWR_ALTERA_AVALON_PIO_DATA (CRAZYSERIAL_0_BASE+4,0x34); IOWR_ALTERA_AVALON_PIO_DATA (CRAZYSERIAL_0_BASE,0x00);</code> </pre><br>  Veuillez noter qu'il n'y a aucun contr√¥le de disponibilit√©.  Les colis se succ√®dent.  N√©anmoins, sur l'oscilloscope, tout s'est av√©r√© assez coh√©rent <br><br><img src="https://habrastorage.org/webt/vh/qm/ig/vhqmigcblrnmmcizbs11jwdgsig.png"><br><br>  Le rayon jaune est <b>cs [0]</b> , le <b>rayon</b> vert est <b>sdo</b> , le <b>rayon</b> violet est <b>sck</b> et le <b>rayon</b> bleu est <b>cs [1]</b> .  On peut voir que le code 0x12 est all√© au premier appareil, 0x34 au second. <br><br>  La lecture se fait de la m√™me mani√®re, mais je ne peux tout simplement pas trouver un bel exemple, √† l'exception de la lecture banale du contenu du pied du connecteur.  Mais cet exemple est tellement d√©g√©n√©r√© qu'il n'est m√™me pas int√©ressant de le faire.  Mais ici, il convient de noter que lors de la lecture de ce param√®tre de bus peut √™tre extr√™mement important: <br><br><img src="https://habrastorage.org/webt/m4/7g/i6/m47gi6xbkat-jct5iuuffqmyya8.png"><br><br>  S'il y a une ligne de <b>lecture</b> , un chronogramme de lecture appara√Ætra dans la bo√Æte de dialogue des param√®tres.  Et cela montrera l'influence de ce param√®tre.  Lors de la lecture des jambes du connecteur, il ne sera toujours pas perceptible, mais lors de la lecture √† partir du m√™me FIFO ou RAM - compl√®tement.  La RAM peut √™tre configur√©e pour √©mettre des donn√©es imm√©diatement apr√®s la soumission de l'adresse, ou elle peut √™tre √©mise de mani√®re synchrone.  Dans le second cas, une latence est ajout√©e.  Apr√®s tout, le bus a r√©gl√© l'adresse, r√©gl√© le stroboscope ... Mais il n'y a pas de donn√©es sur le front le plus proche du signal d'horloge.  Ils appara√Ætront apr√®s ce front ... Autrement dit, le syst√®me a une latence √† une latence.  Et il suffit de le prendre en compte en d√©finissant ce param√®tre.  En bref, si vous ne lisez pas ce qui √©tait attendu, v√©rifiez d'abord si vous avez besoin de configurer la latence.  Le reste - la lecture n'est pas diff√©rente de l'√©criture. <br><br>  Eh bien, permettez-moi de vous rappeler une fois de plus qu'il vaut mieux ne pas supprimer la disponibilit√© du bus pour les op√©rations √† long terme, sinon il est tout √† fait possible de r√©duire consid√©rablement les performances du syst√®me.  Le signal pr√™t est bon pour maintenir la transaction pendant quelques cycles d'horloge, et pas jusqu'√† 80 cycles d'horloge, comme dans mon exemple.  Mais premi√®rement, tout autre exemple serait g√™nant pour l'article, et deuxi√®mement, pour les noyaux d'un jour, c'est tout √† fait acceptable.  Vous serez pleinement conscient de vos actions et √©viterez les situations o√π le bus est bloqu√©.  Certes, si le noyau survit au temps qui lui est allou√©, une telle hypoth√®se peut g√¢cher la vie √† l'avenir, lorsque tout le monde l'oublie, et cela ralentit tout.  Mais ce sera plus tard. <br><br>  N√©anmoins, nous avons appris √† faire en sorte que le c≈ìur du processeur contr√¥le nos c≈ìurs.  Tout est clair avec le monde adressable, il est maintenant temps de traiter avec le monde du streaming.  Mais nous le ferons dans le prochain article, et peut-√™tre m√™me plusieurs articles. <br><br><h3>  Conclusion </h3><br>  L'article montre comment un noyau Verilog arbitraire peut √™tre connect√© pour contr√¥ler le syst√®me de processeur Nios II.  Les options pour la connexion la plus simple au bus Avalon, ainsi que la connexion dans laquelle le bus peut √™tre dans un √©tat occup√©, sont affich√©es.  Des liens vers la litt√©rature sont fournis, √† partir desquels vous pouvez d√©couvrir d'autres modes de fonctionnement du bus Avalon en mode mapp√© en m√©moire. <br><br>  Le projet r√©sultant peut √™tre t√©l√©charg√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr454938/">https://habr.com/ru/post/fr454938/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr454924/index.html">Param√®tres d'authentification dans Veeam Backup pour Microsoft Office 365 v3</a></li>
<li><a href="../fr454926/index.html">Tout ce que vous saviez sur word2vec n'est pas vrai</a></li>
<li><a href="../fr454928/index.html">Fa√ßon de contourner l'√©cran de verrouillage de Windows sur les sessions RDP</a></li>
<li><a href="../fr454932/index.html">Investissements et logiciels: 5 terminaux de trading pour n√©gocier en bourse</a></li>
<li><a href="../fr454936/index.html">Vivaldi: le blocage des publicit√©s devrait √™tre le choix de l'utilisateur</a></li>
<li><a href="../fr454940/index.html">Assurance sant√© voyage: instructions d√©taill√©es</a></li>
<li><a href="../fr454944/index.html">Fonctionnement du format JPEG</a></li>
<li><a href="../fr454946/index.html">√âtats mondiaux: pourquoi et comment les √©viter</a></li>
<li><a href="../fr454958/index.html">Un regard int√©rieur: √©cole doctorale √† l'EPFL. Partie 4.1: vie quotidienne</a></li>
<li><a href="../fr454960/index.html">Microbiota. Comment les m√©dicaments affectent les bact√©ries intestinales</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>