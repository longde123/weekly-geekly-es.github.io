<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëì ‚ÜîÔ∏è üö£üèø PHP sans serveur üå™Ô∏è üèñÔ∏è üë®üèø‚Äçüíª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="√Ä la veille du lancement du cours Backend PHP Developer, nous avons eu une le√ßon traditionnelle ouverte . Cette fois, nous nous sommes familiaris√©s av...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PHP sans serveur</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/477370/"><p>  √Ä la veille du lancement du <a href="https://otus.pw/PjYz/">cours Backend PHP Developer,</a> nous avons eu une <a href="https://www.youtube.com/watch%3Fv%3DcGBggTdDmKI">le√ßon traditionnelle ouverte</a> .  Cette fois, nous nous sommes familiaris√©s avec le concept Serverless, avons parl√© de son impl√©mentation dans AWS, discut√© des principes de fonctionnement, d'assemblage et de lancement, et avons √©galement construit un simple TG-bot PHP bas√© sur AWS Lambda. </p><br><p>  Conf√©rencier - <a href="https://otus.ru/teacher/491/">Alexander Pryakhin</a> , CTO de Westwing Russie. </p><br><hr><br><p><img src="https://habrastorage.org/webt/fm/-y/de/fm-yde0vvpixphwgwoqfsumq-n4.jpeg"></p><a name="habracut"></a><br><h2 id="kratkiy-ekskurs-v-istoriyu">  Une br√®ve excursion dans l'histoire </h2><br><p><img src="https://habrastorage.org/webt/w7/jh/mk/w7jhmkufvziqczxd8ppmbgjylpy.png"></p><br><p>  Comment en est-on arriv√© √† une telle vie que l'informatique sans serveur est apparue?  Bien s√ªr, ils sont apparus non seulement comme √ßa, mais sont devenus une continuation logique des technologies de virtualisation existantes. </p><br><p><img src="https://habrastorage.org/webt/am/jv/dt/amjvdt02rv2bv7_-yhbexlhejm0.png"></p><br><p>  Que virtualisons-nous habituellement?  Par exemple, un processeur.  Vous pouvez √©galement virtualiser la m√©moire en mettant en √©vidence certaines zones de m√©moire et en les rendant accessibles √† certains utilisateurs et inaccessibles √† d'autres.  Vous pouvez virtualiser un r√©seau VPN.  Et ainsi de suite. </p><br><p><img src="https://habrastorage.org/webt/il/2o/p_/il2op_dxfloq7om6r_czugnhebq.png"></p><br><p>  La virtualisation est bonne car nous utilisons mieux les ressources et augmentons la productivit√©.  Mais il y a aussi des inconv√©nients, par exemple, √† un moment donn√©, il y avait des probl√®mes de compatibilit√©.  Cependant, il n'y a pratiquement aucune architecture qui serait incompatible avec les machines virtuelles modernes. </p><br><p>  Le prochain inconv√©nient est que nous ajoutons une couche suppl√©mentaire d'abstraction, ajoutons un hyperviseur, ajoutons une machine virtuelle par elle-m√™me et, bien s√ªr, nous pouvons perdre un peu de vitesse.  Un peu compliqu√© et l'utilisation du serveur. </p><br><p><img src="https://habrastorage.org/webt/yh/on/4j/yhon4j0ial2rlrdfq_grqgx6yjw.png"></p><br><p>  Si nous emportons une machine virtuelle standard avec vous, elle ressemblera √† ceci: </p><br><p><img src="https://habrastorage.org/webt/rq/ii/at/rqiiat114asa0rziaowjsjp1amg.png"></p><br><p>  Premi√®rement, nous avons un serveur de fer, et deuxi√®mement, le syst√®me d'exploitation sur lequel tournera notre hyperviseur.  Et en plus de tout cela, nos machines virtuelles tournent, dans lesquelles il y a un OS invit√©, des biblioth√®ques et des applications.  Si vous pensez logiquement, alors nous voyons des frais g√©n√©raux en pr√©sence de l'OS invit√©, car en fait nous d√©pensons des ressources suppl√©mentaires. </p><br><p>  Comment puis-je r√©soudre le probl√®me des frais g√©n√©raux?  Refuser les machines virtuelles et mettre un syst√®me de gestion de conteneurs au-dessus du syst√®me d'exploitation principal.  Bien s√ªr, le syst√®me le plus populaire est d√©sormais le Docker Engine.  Ensuite, les biblioth√®ques √† l'int√©rieur du conteneur utiliseront le noyau h√¥te du syst√®me d'exploitation. </p><br><p><img src="https://habrastorage.org/webt/rb/wv/ce/rbwvceyh5h8mrsgsst9bu8acadk.png"></p><br><p>  De cette fa√ßon, nous supprimons les frais g√©n√©raux, mais Docker n'est pas id√©al non plus, et il a ses propres probl√®mes et fonctionnalit√©s de travail que tout le monde n'aime pas. </p><br><p>  La principale chose √† comprendre est que Docker et la machine virtuelle sont des approches diff√©rentes, et il n'est pas n√©cessaire de les assimiler.  Docker n'est pas un microvirtuel avec lequel vous pouvez travailler comme avec une machine virtuelle, car le conteneur est pour cela et le conteneur.  Mais le conteneur nous permet d'offrir une flexibilit√© et une approche compl√®tement diff√©rente de la livraison continue, lorsque nous livrons des choses √† la production et comprenons qu'elles sont d√©j√† test√©es et fonctionnent. </p><br><h2 id="oblachnye-tehnologii">  Technologie cloud </h2><br><p>  Avec le d√©veloppement de la virtualisation, les technologies cloud ont √©galement commenc√© √† se d√©velopper.  C'est une bonne solution, mais il convient de mentionner tout de suite que les nuages ‚Äã‚Äãne sont pas une solution miracle et pas une panac√©e pour tous les maux.  Ici, on ne peut s'emp√™cher de rappeler une citation c√©l√®bre: </p><br><blockquote>  "Quand j'entends quelqu'un vanter le cloud comme une solution miracle pour tous les probl√®mes informatiques, je remplace silencieusement" cloud "par" clown "et continue avec un sourire zen." <br>  Amy riche </blockquote><p>  Cependant, pour les moyennes entreprises qui souhaitent b√©n√©ficier d'un certain niveau de service et d'une tol√©rance aux pannes sans injections financi√®res massives, le cloud est tout √† fait une option.  Et pour de nombreuses entreprises, conserver leur centre de donn√©es avec le m√™me SLA sera beaucoup plus cher que d'√™tre servi dans le cloud.  De plus, nous pouvons utiliser les nuages ‚Äã‚Äãpour nos besoins, car ils fournissent certaines choses en quelques clics de souris, ce qui est tr√®s pratique.  Par exemple, la possibilit√© de lever une machine virtuelle ou un r√©seau en quelques clics. <br>  Oui, il existe des restrictions, par exemple, la 152e loi f√©d√©rale interdisant le stockage de donn√©es personnelles √† l'√©tranger, donc le m√™me Amazon ne nous conviendra pas lors d'un audit.  N'oubliez pas Vendor-lock.  De nombreuses solutions cloud ne se portent pas entre elles, bien que le m√™me stockage compatible S3 soit pris en charge par la plupart des fournisseurs. </p><br><p>  Les nuages ‚Äã‚Äãnous offrent la possibilit√© de recevoir diff√©rents niveaux de service sans connaissances √©troitement cibl√©es.  Moins vous aurez besoin de connaissances, plus nous paierons.  Dans la figure ci-dessous, vous pouvez regarder la pyramide, o√π, de bas en haut, la diminution des connaissances techniques requises lors de l'utilisation du cloud est affich√©e: </p><br><p><img src="https://habrastorage.org/webt/ro/hi/aj/rohiajoeei87pirilzujxcaelqs.png"></p><br><h2 id="serverless-i-faas-function-as-a-service">  Sans serveur et FaaS (Fonction en tant que service) </h2><br><p>  Sans serveur est une mani√®re assez r√©cente d'ex√©cuter des scripts dans les nuages, par exemple, comme AWS (en termes d'AWS, le serveur est impl√©ment√© dans Lambda).  * Les approches AaS r√©pertori√©es dans la pyramide ci-dessus sont d√©j√† famili√®res: IaaS (EC2, VDS), PaaS (h√©bergement partag√©), SaaS (Office 365, Tilda).  Ainsi, Serverless est une impl√©mentation de l'approche FaaS.  Et cette approche consiste √† fournir √† l'utilisateur une plate-forme pr√™te √† l'emploi pour le d√©veloppement, le lancement et la gestion de certaines fonctionnalit√©s sans n√©cessiter d'auto-pr√©paration et de configuration. </p><br><p>  Imaginez que vous ayez une machine qui est engag√©e dans le traitement de nuit des documents, effectuant des t√¢ches de 00h00 √† 6h00 et pendant le reste des heures, elle est inactive.  La question est: pourquoi payer pour cela pendant la journ√©e?  Et pourquoi ne pas utiliser des ressources gratuites pour autre chose?  Ce d√©sir d'optimisation et le d√©sir de d√©penser de l'argent uniquement sur ce que vous utilisez r√©ellement, ont conduit √† l'√©mergence de FaaS. </p><br><p>  Serverless est une ressource pour ex√©cuter du code et rien de plus.  Cela ne signifie pas qu'il n'y a pas de serveur derri√®re notre script - il l'est, mais nous n'avons en fait aucune ressource sp√©cifiquement allou√©e sur laquelle notre Lambda sera lanc√©e.  Lorsque nous ex√©cutons notre script, la micro-infrastructure se d√©roule imm√©diatement en dessous, et ce n'est pas votre probl√®me en principe - vous pensez seulement que vous avez le code ex√©cut√©, et vous n'avez pas besoin de penser √† autre chose. <br>  Cela n√©cessite, bien s√ªr, une certaine approche du d√©veloppement de votre code.  Par exemple, vous ne pouvez rien stocker dans cet environnement, vous devez tout retirer.  S'il s'agit de donn√©es, une base de donn√©es externe est n√©cessaire, s'il s'agit d'un journal, puis d'un service de journal externe, s'il s'agit d'un fichier, puis d'un stockage de fichiers externe.  Heureusement, tout fournisseur sans serveur offre la possibilit√© de se connecter √† des syst√®mes externes. </p><br><p>  Vous n'avez que du code, vous travaillez dans le paradigme des apatrides, vous n'avez pas d'√©tat.  Pour le m√™me monde de PHP, cela signifie, par exemple, que vous pouvez oublier le m√©canisme de session standard.  En principe, vous pouvez m√™me construire votre Serverless, et r√©cemment sur Habr√© il y avait <a href="https://habr.com/ru/company/southbridge/blog/475044/">un article √† ce sujet</a> . </p><br><p>  L'id√©e principale de Serverless est que l'infrastructure ne n√©cessite pas le support de l'√©quipe.  Tout tombe sur les √©paules de la plateforme, pour laquelle vous payez en fait de l'argent.  Parmi les inconv√©nients - vous ne contr√¥lez pas l'environnement d'ex√©cution et ne savez pas o√π ce qui est effectu√©. </p><br><p>  Sans serveur: </p><br><ul><li>  ne signifie pas l'absence physique du serveur; </li><li>  pas un tueur de virtualoks et Docker; </li><li>  pas de battage m√©diatique ici et maintenant. <br>  Sans serveur doit √™tre pouss√© consciemment et d√©lib√©r√©ment.  Par exemple, si vous devez tester rapidement une hypoth√®se sans impliquer la moiti√© de l'√©quipe.  Vous obtenez donc la fonction en tant que service.  La fonction r√©pondra √† certains √©v√©nements, et comme il y a une r√©action aux √©v√©nements, ces √©v√©nements doivent √™tre appel√©s par quelque chose - pour cela, il existe de nombreux d√©clencheurs dans le m√™me AWS. </li></ul><br><p>  Caract√©ristiques de FaaS: </p><br><ul><li>  l'infrastructure ne n√©cessite pas de configuration; </li><li>  Mod√®le d'√©v√©nement ¬´pr√™t √† l'emploi¬ª; </li><li>  Apatride; </li><li>  la mise √† l'√©chelle est tr√®s facile et s'effectue automatiquement en fonction des besoins de l'utilisateur. </li></ul><br><h2 id="aws-lambda">  AWS Lambda </h2><br><p>  La premi√®re impl√©mentation FaaS accessible au public est AWS Lambda.  S'il s'agit d'une th√®se, elle pr√©sente les caract√©ristiques suivantes: <br>  - disponible depuis 2014; <br>  - prend en charge Java, Node.js, Python, Go et des runtimes personnalis√©s; <br>  - nous payons pour: <br>  nombre d'appels; <br>  d√©lai de livraison. <br>  AWS Lambda: pourquoi est-il n√©cessaire: <br>  √âlimination  Vous ne payez que pour la dur√©e d'ex√©cution du service. <br>  La vitesse.  Lambda elle-m√™me se l√®ve et fonctionne tr√®s rapidement. <br>  Fonctionnel.  Lambda poss√®de de nombreuses fonctionnalit√©s pour l'int√©gration avec les services AWS. <br>  Performance.  Mettre un lambda est assez difficile.  En parall√®le, elle peut √™tre r√©alis√©e selon la r√©gion d'un maximum de 1000 √† 3000 copies.  Et si vous le souhaitez, cette limite peut √™tre augment√©e en √©crivant √† l'appui. </p><br><p>  Nous avons un corps lambda, un √©diteur en ligne, VPC comme une grille virtuelle de calculs, la journalisation, le code lui-m√™me, les variables d'environnement et les d√©clencheurs qui provoquent lambda (en passant, le versioning fonctionne tr√®s bien).  Une excellente anatomie Lambda est d√©crite dans <a href="https://habr.com/ru/post/457100/">cet article</a> . </p><br><p>  Le code est stock√© soit dans le corps (s'il s'agit de langues prises en charge par d√©faut) soit dans des couches.  Nous avons un d√©clencheur qui appelle le lambda, le lambda lit les environnements temporaires, les tire vers lui et ex√©cute notre code: </p><br><p><img src="https://habrastorage.org/webt/sr/py/zu/srpyzu9gzq6gfkekd-tbo5zkmyq.png"></p><br><p>  Si nous avons un runtime personnalis√©, nous devrons placer le code dans une couche.  Si vous avez travaill√© avec Docker, la couche Docker est tr√®s similaire √† la couche de lambda - une sorte de quasi-r√©f√©rentiel dans lequel se trouve notre liaison n√©cessaire.  Nous avons l√† le fichier ex√©cutable de l'environnement (si nous parlons de PHP, vous devez placer le binaire PHP compil√© √† l'avance), le fichier d'amor√ßage lambda (situ√© par d√©faut) et les scripts directement appel√©s qui seront ex√©cut√©s. </p><br><p><img src="https://habrastorage.org/webt/pj/es/fp/pjesfpgl0xix6psx4tqwegms_4m.png"></p><br><p>  Avec la livraison, tout n'est pas si rose: </p><br><p><img src="https://habrastorage.org/webt/xg/qt/km/xgqtkmwgjqrisunlmvwtgym2nkk.png"></p><br><p>  Autrement dit, il nous est propos√© de prendre des fichiers avec le code, de les t√©l√©charger dans l'archive zip, de les t√©l√©charger sur la couche et d'ex√©cuter notre code.  C'est compl√®tement cool que cela soit propos√© dans la documentation officielle d'Amazon. </p><br><p><img src="https://habrastorage.org/webt/w2/ls/vr/w2lsvrvdjcbta6km5boxp3ntsgw.png"></p><br><p>  Bien s√ªr, cela ne correspond pas aux r√©alit√©s modernes et √† l'odeur de deux milli√®mes dans l'air.  Heureusement, des gens gentils ont essay√© et cr√©√© plusieurs frameworks, nous allons donc utiliser le framework Serverless d√©velopp√© sur Node.js et nous permettant de g√©rer les applications bas√©es sur AWS Lambda.  De plus, lorsque nous parlons de d√©ploiement et de d√©veloppement, bien s√ªr, je ne veux pas vraiment d√©ployer manuellement, mais nous souhaitons faire quelque chose de flexible et d‚Äôautomatis√©. </p><br><p>  Il nous faut donc: <br>  - AWS CLI - interface de ligne de commande pour travailler avec les services AWS; <br>  - le framework Serverless d√©j√† mentionn√© ci-dessus (la version de d√©veloppement est gratuite, et ses fonctionnalit√©s suffisent aux yeux); <br>  - La biblioth√®que Bref, n√©cessaire √† l'√©criture de code.  Cette biblioth√®que est install√©e √† l'aide de composer, donc le code sera compatible avec n'importe quel framework.  Une excellente solution, d'autant plus qu'AWS Lambda ne prend pas en charge l'appel de scripts PHP hors de la bo√Æte. </p><br><p><img src="https://habrastorage.org/webt/ke/de/4w/kede4wq7a7kupqj4zheld7ifkp0.png"></p><br><h2 id="nastraivaem-okruzhenie-i-aws">  Personnalisez votre environnement et AWS </h2><br><h3 id="aws-cli">  CLI AWS </h3><br><p>  Commen√ßons par cr√©er un compte et installer AWS CLI.  Le shell de la console AWS est bas√© sur Python 2.7+ ou 3.4+.  √âtant donn√© qu'AWS recommande la version 3 de Python, nous ne discuterons pas. <br>  Les exemples ci-dessous concernent Ubuntu. </p><br><pre><code class="plaintext hljs">sudo apt-get -y install python3-pip</code> </pre> <br><p>  Installez ensuite directement l'AWS CLI: </p><br><pre> <code class="plaintext hljs">pip3 install awscli --upgrade --user</code> </pre> <br><p>  V√©rifiez l'installation: </p><br><pre> <code class="plaintext hljs">aws --version</code> </pre> <br><p>  Vous devez maintenant connecter AWS CLI √† votre compte.  Vous pouvez utiliser votre nom d'utilisateur et votre mot de passe existants, mais il serait pr√©f√©rable de cr√©er un utilisateur distinct via AWS IAM, en lui d√©finissant uniquement les droits d'acc√®s n√©cessaires.  L'appel de la configuration ne causera pas de probl√®mes: </p><br><pre> <code class="plaintext hljs">aws configure</code> </pre> <br><p>  Ensuite, vous aurez besoin d'AWS Secret et d'AWS Access Key.  Ils peuvent √™tre obtenus dans ASW IAM dans l'onglet "Informations d'identification de s√©curit√©" (situ√© sur la page de l'utilisateur souhait√©).  Le bouton ¬´Cr√©er une cl√© d'acc√®s¬ª vous aidera √† g√©n√©rer des cl√©s d'acc√®s.  Gardez-les avec vous. </p><br><p><img src="https://habrastorage.org/webt/yn/t3/0q/ynt30qaych_hosd73v0bl3yb51q.png"></p><br><p>  Pour enregistrer un nouveau bot dans Telegram, utilisez @BotFather et la commande / newbot.  En cons√©quence, le jeton n√©cessaire pour vous connecter √† votre bot vous sera retourn√©.  Verrouillez-le √©galement. </p><br><p><img src="https://habrastorage.org/webt/mn/db/6_/mndb6_yarkg6ssd1cmfaykayuam.png"></p><br><h3 id="serverless-framework">  Framework sans serveur </h3><br><p>  Pour installer Serverless Framework, vous aurez besoin d'un compte sur <a href="https://serverless.com/">https://serverless.com/</a> . <br>  Apr√®s avoir termin√© l'enregistrement, nous proc√©derons √† l'installation sur notre poste de travail.  Node.js 6e et sup√©rieur sera requis. </p><br><pre> <code class="plaintext hljs">sudo apt-get -y install nodejs</code> </pre> <br><p>  Pour assurer le lancement correct dans notre environnement, nous suivons les √©tapes recommand√©es: </p><br><pre> <code class="plaintext hljs">mkdir ~/.npm-global export PATH=~/.npm-global/bin:$PATH source ~/.profile npm config set prefix '~/.npm-global'</code> </pre> <br><p>  Ajoutez √©galement: </p><br><pre> <code class="plaintext hljs">~/.npm-global/bin:$PATH</code> </pre> <br><p>  dans le fichier / etc / environment. <br>  Maintenant, mettez Serverless: </p><br><pre> <code class="plaintext hljs">npm install -g serverless</code> </pre> <br><h3 id="aws">  Aws </h3><br><p>  Eh bien, il est temps de passer √† l'interface AWS et d'ajouter un nom de domaine.  Nous cr√©ons une zone AWS Route 53, un enregistrement DNS et un certificat SSL pour cela. <br>  De plus, vous avez besoin de l'ELB, que nous cr√©ons dans le service EC2 -&gt; Load Balancers.  Soit dit en passant, lors de la cr√©ation d'un ELB, vous devez suivre toutes les √©tapes de l'assistant, en indiquant le certificat cr√©√©. </p><br><p>  Quant √† l'√©quilibreur, vous pouvez le cr√©er via l'AWS CLI √† l'aide de la commande suivante: </p><br><pre> <code class="plaintext hljs">aws elb create-load-balancer --load-balancer-name my-load-balancer --listeners "Protocol=HTTP,LoadBalancerPort=80,InstanceProtocol=HTTP,InstancePort=80" "Protocol=HTTPS,LoadBalancerPort=443,InstanceProtocol=HTTP,InstancePort=80,SSLCertificateId=arn:aws:iam::123456789012:server-certificate/my-server-cert" --subnets subnet-15aaab61 --security-groups sg-a61988c3</code> </pre> <br><p>  Un √©quilibreur sera n√©cessaire apr√®s le premier d√©ploiement.  Dans ce cas, vous devez lui envoyer des demandes √† notre domaine.  Pour l'impl√©menter, dans les param√®tres de l'enregistrement DNS (champ "Alias ‚Äã‚Äãtarget"), commencez √† saisir le nom de l'ELB cr√©√©.  En cons√©quence, vous verrez une liste d√©roulante, il reste donc √† s√©lectionner l'entr√©e souhait√©e et √† l'enregistrer. </p><br><p><img src="https://habrastorage.org/webt/-i/yr/8g/-iyr8gsoknvxwk0nsjvwtiolca0.png"></p><br><p>  Maintenant, allez au code. </p><br><h3 id="pishem-kod">  √âcrire un code </h3><br><p>  Nous utiliserons Bref pour √©crire le code.  Comme mentionn√© pr√©c√©demment, cette biblioth√®que est install√©e √† l'aide de composer, donc le code sera compatible avec n'importe quel framework.  Soit dit en passant, les d√©veloppeurs ont d√©j√† d√©crit le processus d'utilisation de Bref avec <a href="https://bref.sh/docs/frameworks/laravel.html">Laravel</a> et <a href="https://bref.sh/docs/frameworks/symfony.html">Symfony</a> .  Mais il est conseill√© pour nous de travailler sur le PHP "nu" - cela aidera √† mieux comprendre l'essence. <br>  Nous commen√ßons par les d√©pendances: </p><br><pre> <code class="plaintext hljs">{ "require": { "php": "&gt;=7.2", "bref/bref": "^0.5.9", "telegram-bot/api": "*" }, "autoload": { "psr-4": { "App\": "src/" } } }</code> </pre> <br><p>  Nous allons √©crire en PHP 7.2 et sup√©rieur, et pour travailler avec Telegram, ce shell pour l'API nous convient - <a href="https://github.com/TelegramBot/Api">https://github.com/TelegramBot/Api</a> .  Quant au code lui-m√™me, il sera plac√© dans le r√©pertoire src. </p><br><p>  Ainsi, l'environnement sans serveur passe par une bo√Æte de dialogue de console.  Une application HTTP est requise, et du point de vue de Lambda, cela signifie que les appels de script seront ex√©cut√©s de la m√™me mani√®re que Nginx.  L'interpr√©tation sera effectu√©e par PHP-FPM.  En g√©n√©ral, cela ressemble plus √† un appel de script de console standard.  C'est un point important, car sans prendre en compte cette fonctionnalit√©, nous ne pourrons pas appeler de scripts via HTTP. <br>  Nous r√©alisons: </p><br><pre> <code class="plaintext hljs">vendor/bin/bref init</code> </pre> <br><p>  Dans la bo√Æte de dialogue, s√©lectionnez l'√©l√©ment ¬´Application HTTP¬ª et n'oubliez pas de sp√©cifier la r√©gion, car l'application doit fonctionner dans la m√™me r√©gion dans laquelle fonctionne l'√©quilibreur. <br>  Apr√®s l'initialisation, 2 nouveaux fichiers appara√Ætront: <br>  index.php - le fichier appel√©; <br>  serverless.yml - fichier de configuration de d√©ploiement. <br>  Le dossier .serverless devra √™tre imm√©diatement ajout√© au .gitignore (il appara√Ætra apr√®s la 1√®re tentative de d√©ploiement). </p><br><p>  Une fois que nous avons une application Web, nous d√©posons index.php dans le dossier public, basculant imm√©diatement vers serverless.yml.  Voici √† quoi cela pourrait ressembler dans notre impl√©mentation: </p><br><pre> <code class="plaintext hljs">#  lambda- service: app #    provider: name: aws #   ! region: eu-central-1 #    runtime: provided # ,  bref  1024.         memoryLimit: 256 #   stage: dev #    environment: BOT_TOKEN: ${ssm:/app/bot-token} #  bref plugins: - ./vendor/bref/bref #  Lambda- functions: #       php-api-dev # service-function-stage api: handler: public/index.php description: '' # in seconds (API Gateway has a timeout of 29 seconds) timeout: 28 layers: - ${bref:layer.php-73-fpm} #     API Gateway events: - http: 'ANY /' - http: 'ANY /{proxy+}' #    environment: MY_VARIABLE: ${ssm:/app/my_variable}</code> </pre> <br><p>  Analysons maintenant les lignes non √©videntes.  Nous avons surtout besoin de variables d'environnement.  Nous ne voulons pas coder en dur les connexions aux bases de donn√©es, les API externes, etc. Si nous nous connectons √† Telegram, nous aurons notre propre jeton, qui est re√ßu de BotFather.  Et il n'est pas recommand√© de stocker ce jeton dans serverless.yml, il est donc pr√©f√©rable de l'envoyer vers le stockage AWS ssm: </p><br><pre> <code class="plaintext hljs">aws ssm put-parameter --region eu-central-1 --name '/app/my_variable' --type String --value '___BOTFATHER'</code> </pre> <br><p>  Soit dit en passant, nous en parlons dans la configuration. <br>  Ces variables sont disponibles en tant que variables d'environnement, et vous pouvez y acc√©der en PHP en utilisant la fonction getenv.  Si nous parlons de notre exemple, gardons le jeton de bot dans la port√©e globale pour plus de simplicit√©.  Nous pouvons √©galement transf√©rer le jeton dans la port√©e d'une seule fonction, et l'appel lui-m√™me ne changera pas de cela. </p><br><p>  Continuons.  Cr√©ons maintenant une classe BotApp simple - elle sera charg√©e de g√©n√©rer une r√©ponse pour le bot et r√©pondra aux commandes.  Les d√©veloppeurs de t√©l√©grammes recommandent d'ajouter la prise en charge des commandes / help et / start pour tous les bots.  Ajoutons une autre commande pour le plaisir.  La classe elle-m√™me est assez simple et permet d'impl√©menter le contr√¥leur Front dans index.php sans charger le fichier d'appel lui-m√™me.  Pour obtenir une logique plus complexe, l'architecture doit √™tre d√©velopp√©e et compliqu√©e. </p><br><pre> <code class="plaintext hljs">&lt;?php namespace App; use TelegramBot\Api\Client; use Telegram\Bot\Objects\Update; class BotApp { function run(): void{ $token = getenv('BOT_TOKEN'); $bot = new Client($token); //   start $bot-&gt;command('start', function ($message) use ($bot) { $answer = ' !'; $bot-&gt;sendMessage($message-&gt;getChat()-&gt;getId(), $answer); }); //    $bot-&gt;command('help', function ($message) use ($bot) { $answer = ': /help -  '; $bot-&gt;sendMessage($message-&gt;getChat()-&gt;getId(), $answer); }); //   $bot-&gt;command('hello', function ($message) use ($bot) { $answer = '-,  - ,   Serverless '; $bot-&gt;sendMessage($message-&gt;getChat()-&gt;getId(), $answer); }); $bot-&gt;run(); } }</code> </pre> <br><p>  Et voici la liste de index.php: </p><br><pre> <code class="plaintext hljs">&lt;?php require_once('../vendor/autoload.php'); use App\BotApp; try{ $botApp = new BotApp(); $botApp-&gt;run(); } catch (Exception $e){ echo $e-&gt;getMessage(); print_r($e-&gt;getTrace(), 1); }</code> </pre> <br><p>  Cela peut sembler √©trange, mais tout est pr√™t pour que nous partions en production.  Faisons-le en ex√©cutant la commande dans le dossier serverless.yml: </p><br><pre> <code class="plaintext hljs">sls deploy</code> </pre> <br><p>  En mode normal, sans serveur emballera les fichiers dans des archives zip, cr√©era un compartiment S3 o√π les placer, puis cr√©era ou mettra √† jour l'application AWS attach√©e √† Lambda, et placera le code et le runtime dans une couche distincte. </p><br><p>  Lors du 1er lancement, l'API Gateway sera cr√©√©e (nous l'avons laiss√©e pour faciliter le test des appels, mais il est alors conseill√© de la supprimer).  Vous devrez √©galement configurer l'appel Lambda via ELB, pour lequel nous s√©lectionnons ¬´Ajouter un d√©clencheur¬ª dans la fen√™tre de contr√¥le des fonctions et s√©lectionnez ¬´Application Load Balancer¬ª dans la liste d√©roulante.  Vous devrez sp√©cifier l'ELB cr√©√© pr√©c√©demment, d√©finir la connexion via HTTPS, laisser l'h√¥te vide et, dans Path, sp√©cifier le chemin que Lambda appellera (par exemple, / lambda / mytgbot).  Par cons√©quent, votre Lambda sera disponible √† l'URL avec le chemin sp√©cifi√©. </p><br><p>  Vous pouvez maintenant enregistrer la partie r√©ponse du bot dans Telegram afin que le messager comprenne o√π obtenir les messages.  Pour ce faire, appelez l'URL suivante dans le navigateur, mais n'oubliez pas d'y substituer vos propres param√®tres: </p><br><pre> <code class="plaintext hljs">https://api.telegram.org/bot_/setWebhook?url=https://my-elb-host.com/lambda/mytgbot</code> </pre> <br><p>  En cons√©quence, l'API retournera ¬´OK¬ª, apr√®s quoi le bot sera disponible. </p><br><p><img src="https://habrastorage.org/webt/g-/rd/kl/g-rdkldh57hxw-sbbcl_ci9nmyk.png"></p><br><h2 id="testiruem-bota-na-lokali">  Test du bot sur les locales </h2><br><p>  Le bot peut √™tre test√© avant le d√©ploiement.  Le fait est que le Serverless Framework prend en charge le lancement sur les locales en utilisant des conteneurs Docker pour cela.  Commande d'appel: </p><br><pre> <code class="plaintext hljs">sls invoke local --docker -f myFunction</code> </pre> <br><p>  N'oubliez pas que nous avons utilis√© des variables d'environnement, donc lors de l'appel, elles doivent √©galement √™tre d√©finies au format: </p><br><pre> <code class="plaintext hljs">sls invoke local --docker -f myFunction --env VAR1=val1</code> </pre> <br><h2 id="logi">  Journaux </h2><br><p>  Par d√©faut, la sortie de l'appel sera enregistr√©e dans CloudWatch - elle est disponible dans le panneau de surveillance de la fonction Lambda correspondante.  Ici vous pouvez lire les traces d'appels en cas de vidage c√¥t√© PHP.  De plus, vous pouvez connecter des services de surveillance avanc√©s, mais ils co√ªteront quelques centimes de plus chaque mois. </p><br><h2 id="itogo">  Total </h2><br><p>  En cons√©quence, nous avons obtenu une solution assez rapide, flexible, √©volutive et relativement peu co√ªteuse.  Oui, Lambda ne gagne pas toujours par rapport aux VM et conteneurs standard, mais il y a des situations o√π l'application Serverless aide √† ¬´tirer¬ª rapidement et efficacement.  Et l'exemple du bot cr√©√© le d√©montre. <br>  Documents utiles sur le sujet: </p><br><ul><li>  <a href="http.html">Documentation Bref</a> </li><li>  <a href="https://habr.com/ru/post/457100/">Th√©orie lambda</a> ; </li><li>  <a href="https://dev.to/sosnowski/anatomy-of-aws-lambda-1i1e">Anatomie lambda</a> ; </li><li>  <a href="https://serverless.com/">Framework sans serveur</a> </li><li>  <a href="https://devenergy.ru/archives/941">Bot Telegram sans serveur bas√© sur PHP et AWS Lambda</a> . </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr477370/">https://habr.com/ru/post/fr477370/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr477358/index.html">Nous vous invitons √† DINS DevOps EVENING le 5 d√©cembre: nous parlons d'un syst√®me de traitement d'√©v√©nements, nous partageons notre exp√©rience de travail avec Influx</a></li>
<li><a href="../fr477360/index.html">Nouveaut√©s de SOLIDWORKS Simulation 2020</a></li>
<li><a href="../fr477362/index.html">Plus qu'un anti-spam: comment tirer le meilleur parti de votre passerelle de messagerie √©lectronique de s√©curit√©</a></li>
<li><a href="../fr477364/index.html">Comment devenir d√©veloppeur Java? Ou peut-√™tre choisir Python?</a></li>
<li><a href="../fr477366/index.html">Cinq questions sur la conception de langages de programmation</a></li>
<li><a href="../fr477372/index.html">Amazon perd la guerre contre les contrefa√ßons</a></li>
<li><a href="../fr477374/index.html">Machines Z √† fuzzing</a></li>
<li><a href="../fr477378/index.html">Agile mixte - approche Waterfall lors de la mise en ≈ìuvre d'applications m√©tier (aka Agile-like)</a></li>
<li><a href="../fr477382/index.html">Esports - faire du profit: Mercedes, m√©gaphone, paris et image de marque pour les esports</a></li>
<li><a href="../fr477384/index.html">Conf√©rence ¬´S√©curit√© de l'information. Menaces du pr√©sent et du futur ¬ª</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>