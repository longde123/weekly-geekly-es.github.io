<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¤› ğŸ§¢ ğŸ‘©ğŸ¼â€ğŸ¤ Akses properti di dalam bidang Jsonb untuk Npgsql ğŸ›°ï¸ ğŸ˜• ğŸ™‹</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="PostgreSQL memiliki tipe data Jsonb yang memungkinkan Anda untuk menambahkan properti tambahan ke model relasional standar dengan kemampuan untuk menc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Akses properti di dalam bidang Jsonb untuk Npgsql</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/463747/"><p> PostgreSQL memiliki tipe data Jsonb yang memungkinkan Anda untuk menambahkan properti tambahan ke model relasional standar dengan kemampuan untuk mencari melalui mereka. </p><br><p> EntityFramework Core dengan ekstensi Npgsql dapat menarik data bidang ke tipe <code>System.String</code> </p><br><p>  Namun, untuk memfilter oleh properti Json melalui EF di tingkat kueri, Anda harus menggunakan SQL murni, yang sangat tidak nyaman, karena Anda perlu masuk ke pemetaan (jika tidak otomatis), cari nama bidang yang sesuai dengan properti model, dukung penamaan ini.  Fleksibilitas yang diberikan ORM kepada kami hilang. </p><br><p>  Jika itu membuat Anda tertekan, juga saya, selamat datang ke kucing. </p><br><p>  Di akhir artikel ada tautan ke sumber! </p><a name="habracut"></a><br><h3 id="oboznachim-zadachi">  Nyatakan tugas </h3><br><p>  Sebagai pengembang, saya ingin memiliki alat untuk mengakses bidang Jsonb dengan tujuan memfilter dan menyortirnya, yang: </p><br><ul><li>  Ini akan kompatibel dengan <strong>EntityFramework Core 2</strong> (kami menggunakannya) </li><li>  Anda tidak perlu menulis SQL sendiri saat bekerja dengannya </li><li>  Akan bekerja dengan struktur Json datar (di dalam json hanya ada properti json) </li></ul><br><p>  Saya <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" title="Npgsql.Json.NET">akan</a> menambahkan bahwa ada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" title="Npgsql.Json.NET">Npgsql.Json.NET</a> , yang dapat memproyeksikan nilai Json dan Jsonb ke dalam tipe CLR.  Sejujurnya, saya tidak mengerti untuk apa itu, karena karena kami membutuhkan bidang Json dalam basis data relasional, kemungkinan besar kami memiliki entitas dengan rangkaian bidang yang dinamis. </p><br><h3 id="algoritm-resheniya-zadachi">  Algoritma untuk memecahkan masalah </h3><br><ol><li>  Tetapkan metode (atau metode) yang akan memenuhi kebutuhan kita. </li><li>  Buat penerjemah yang akan berpartisipasi dalam pembuatan kode SQL. </li><li>  Persetan dengan Npgsql. </li></ol><br><h3 id="reshenie">  Solusi </h3><br><p>  Pertama, kita mendefinisikan suatu metode.  Saya ingin digunakan sesuatu seperti ini: </p><br><pre> <code class="plaintext hljs">context.Entity.Where(x =&gt; JsonbMethods.Value&lt;string&gt;(x.JsonbField, "jsonPropertyName") == "value")</code> </pre> <br><p>  Karena itu, inilah metode kami: </p><br><pre> <code class="plaintext hljs">public static TSource Value&lt;TSource&gt;(object jsonbProperty, string jsonbPropertyName) { throw new NotSupportedException(); }</code> </pre> <br><p>  Selama beberapa jam saya memilih sumber-sumber EF Core, Npgsql dan tidak hanya mencari cara untuk memperluas fungsi dasar generasi SQL.  Saya sampai di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" title="di sini sebelum artikel ini">artikel ini</a> , tetapi saya tidak suka pendekatan penulis dengan metode menghubungkan penerjemah, karena itu mendefinisikan ulang alat standar, yang berarti dapat bertentangan dengan alat serupa lainnya. <br>  Akibatnya, saya sampai ke sumber Net Topology Suite.  Yang saya butuhkan dari sana adalah cara untuk menghubungkan penerjemah metode. </p><br><p>  Tetapi sebagian besar waktu yang saya habiskan untuk menghasilkan fragmen sql yang saya butuhkan. </p><br><p>  Berikut ini sintaks yang diperlukan </p><br><p> <code>tableAlias."JsonField"-&gt;&gt;"insideProperty"</code> </p> <br><p>  Awalnya saya mencoba di penerjemah untuk mengembalikan ColumnExpression.  Saat membuatnya, parameter pertama adalah nama kolom (string).  Saya hanya memasaknya dari parameter yang datang kepada saya dalam metode ini.  Diluncurkan, dicentang, kesalahan.  Ternyata apa yang saya sampaikan sebagai nama dibungkus tanda kutip.  Akibatnya, SQL berubah menjadi <code>tableAlias.""JsonField"-&gt;&gt;"insideProperty""</code> . </p><br><p>  Dalam kode sumber generator, saya menemukan metode <code>VisitColumn</code> di mana perilaku ini adalah hardcode dan tidak bergantung pada parameter apa pun.  Artinya, saya tidak bisa memengaruhinya.  Itu perlu untuk mencari solusi lain. </p><br><p>  Kemudian saya membuat <code>Expression</code> saya sendiri - <code>JsonbPropertyAccessorExpression: Expression</code> </p><br><p>  Masih menimpa metode <code>Accept</code> untuk <code>ISqlExpressionVisitor</code> . </p><br><p>  Tetapi masalahnya adalah, dalam antarmuka ini tidak ada metode yang dapat disegmentasikan oleh operator kustom.  Kemudian terpikir olehku untuk mengunjungi bukan satu metode, tetapi beberapa metode.  Pertama mengunjungi <code>VisitColumn</code> , yang menciptakan akses ke tableAlias. "JsonField" kolom, kemudian <code>VisitSqlFragment</code> , di mana saya melemparkan <code>"-&gt;&gt;'insideFieldName'"</code> . </p><br><p>  Saya tidak berharap, tetapi itu berhasil.  Hampir. </p><br><p>  Ketika saya mencoba memfilter menurut teks untuk kebetulan yang tepat, untuk beberapa alasan, filter <code>tableAlias."JsonField"-&gt;&gt;"insideProperty" = JSONB "value"</code> , yang menyebabkan kesalahan, karena tidak mungkin untuk membuang teks ke tipe JSONB jika tidak mengandung Json yang valid .  Dan mengapa saya perlu mengarahkan sesuatu ke sesuatu ketika saya ingin teks? </p><br><p>  Saya bahkan membuat keputusan untuk menghapus tanda dari kolom Jsonb dari model pemetaan, bahwa itu adalah Jsonb, hanya menambahkan tanda ini ke <code>MigrationContext</code> sehingga menghasilkan migrasi yang benar.  Dan itu bahkan lepas landas, tetapi pendekatan itu bagi saya terasa seperti penopang.  Meskipun demikian, saya berhenti di sana. </p><br><p>  Setelah itu, saya menetapkan ke CAST, karena metode <code>Value</code> bersifat universal dan mungkin ada berbagai jenis data di properti Json, yang juga perlu disortir dan difilter. </p><br><p>  Sebagai hasilnya, saya mulai mengembalikan <code>ExplicitCastExpression</code> dari penerjemah saya, di mana saya melewati <code>Expression</code> kustom saya dan jenis yang terkandung dalam argumen universal metode <code>Value</code> . </p><br><p>  ketika saya melihat hasil SQL ketika mencari berdasarkan tanggal, saya menemukan bahwa nilai yang dibandingkan dilemparkan ke tipe timestamp.  <code>timestamp 'some date value'</code> .  Dan kemudian saya sadar.  Masalah sebelumnya, yang saya selesaikan dengan tongkat penyangga, hilang dengan sendirinya.  Ketika accessor dilemparkan ke dalam teks ke bidang Json, generator tidak lagi menambahkan konversi eksplisit ke JSONB, karena sudah ada teks di sebelah kiri operasi perbandingan, dan secara default accessor dari bidang Jsonb mengembalikan tipe Jsonb. </p><br><h3 id="v-zavershenii">  Pada akhirnya </h3><br><p>  Sebagai kesimpulan, saya ingin menambahkan bahwa saya tidak menemukan dokumentasi tentang cara menambahkan penerjemah khusus untuk properti dan metode.  mungkin terlihat buruk.  Jika seseorang memiliki komentar tentang pendekatan, pada kode, dll, tulis di komentar. </p><br><p>  Jika seseorang ingin memperluas perpustakaan dalam garpu, menulis dalam surat pribadi, saya akan mencoba membantu.  Nah, atau membuang pullrequests. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" title="Berikut ini tautan ke sumbernya">Berikut ini tautan ke sumbernya</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id463747/">https://habr.com/ru/post/id463747/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id463735/index.html">Qrator memfilter sistem pengiriman konfigurasi jaringan</a></li>
<li><a href="../id463737/index.html">Pemecahan masalah dengan pwnable.kr 21 - horcuxes. Pemrograman Berorientasi Kembali dan Rantai ROP</a></li>
<li><a href="../id463739/index.html">Sistem Manajemen Konfigurasi Jaringan Filter Qrator</a></li>
<li><a href="../id463741/index.html">Firefox (sudah diperbaiki) dan Chrome memungkinkan Anda menggunakan header Alt-Svc untuk memindai port intranet</a></li>
<li><a href="../id463745/index.html">Komplikasi C ++ tidak bisa dihindari. Dan tidak hanya C ++</a></li>
<li><a href="../id463749/index.html">Scrum vs Kanban: Tetap Tenang dan Pilih Yang Cocok Untukmu</a></li>
<li><a href="../id463751/index.html">iOS 13: Apa yang Anda butuhkan dan apa yang benar-benar tidak perlu Anda lakukan saat mengembangkan untuk OS baru</a></li>
<li><a href="../id463753/index.html">PVS-Studio Mengunjungi Apache Hive</a></li>
<li><a href="../id463755/index.html">Perbedaan antara "Juni", "Tengah" dan "Senior". Dan apa yang harus dilakukan untuk naik satu level</a></li>
<li><a href="../id463759/index.html">PVS-Studio mengunjungi Apache Hive</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>