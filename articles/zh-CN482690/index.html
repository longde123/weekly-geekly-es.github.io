<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ•º ğŸˆ ã€°ï¸ åœ¨åˆå¹¶ä¸­åˆ›å»ºå‘å¸ƒè€… ğŸ¤œğŸ¾ ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ ğŸ³</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ä»Šå¤©ï¼Œæˆ‘æƒ³å‘æ‚¨å±•ç¤ºå¦‚ä½•åœ¨Appleçš„æ–°Combineæ¡†æ¶ä¸­åˆ›å»ºè‡ªå·±çš„Publisherã€‚ 


 å› æ­¤ï¼Œå¯¹äºåˆå­¦è€…æ¥è¯´ï¼Œæˆ‘ä»¬éœ€è¦ç®€è¦å›é¡¾ä¸€ä¸‹Combineçš„åŸºæœ¬éƒ¨åˆ†å¦‚ä½•ç›¸äº’äº¤äº’ï¼Œå³å‘å¸ƒè€…ï¼Œè®¢é˜…ï¼Œè®¢é˜…è€…ã€‚ 


- è®¢é˜…è€…åŠ å…¥å‘å¸ƒè€… 
- å‘å¸ƒè€…å‘é€è®¢é˜…è®¢é˜…è€… 
- è®¢é˜…æœåŠ¡å™¨è¦æ±‚è®¢é˜…æä¾›Nä¸ªå€¼ 
-...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>åœ¨åˆå¹¶ä¸­åˆ›å»ºå‘å¸ƒè€…</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482690/"><p><img src="https://habrastorage.org/webt/yu/vm/d7/yuvmd7t0eg1ws5pi_ahqklv9bba.png"></p><br><p> ä»Šå¤©ï¼Œæˆ‘æƒ³å‘æ‚¨å±•ç¤ºå¦‚ä½•åœ¨Appleçš„æ–°Combineæ¡†æ¶ä¸­åˆ›å»ºè‡ªå·±çš„Publisherã€‚ </p><a name="habracut"></a><br><p> å› æ­¤ï¼Œå¯¹äºåˆå­¦è€…æ¥è¯´ï¼Œæˆ‘ä»¬éœ€è¦ç®€è¦å›é¡¾ä¸€ä¸‹Combineçš„åŸºæœ¬éƒ¨åˆ†å¦‚ä½•ç›¸äº’äº¤äº’ï¼Œå³å‘å¸ƒè€…ï¼Œè®¢é˜…ï¼Œè®¢é˜…è€…ã€‚ </p><br><ul><li> è®¢é˜…è€…åŠ å…¥å‘å¸ƒè€… </li><li> å‘å¸ƒè€…å‘é€è®¢é˜…è®¢é˜…è€… </li><li> è®¢é˜…æœåŠ¡å™¨è¦æ±‚è®¢é˜…æä¾›Nä¸ªå€¼ </li><li> å‘å¸ƒè€…å‘é€çš„Nä¸ªå€¼æˆ–æ›´å°‘ </li><li> å‘å¸ƒè€…å‘é€å®Œæˆä¿¡å· </li></ul><br><h1 id="publisher"> å‘è¡Œäºº </h1><br><p> å› æ­¤ï¼Œè®©æˆ‘ä»¬å¼€å§‹åˆ›å»ºå‘å¸ƒæœåŠ¡å™¨ã€‚ è½¬åˆ°Appleæ–‡æ¡£ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°<a href="https://developer.apple.com/documentation/combine/publisher">Publisher</a>æ˜¯ä¸€ä¸ªåè®®ã€‚ </p><br><pre><code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Publisher</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">associatedtype</span></span> <span class="hljs-type"><span class="hljs-type">Output</span></span> <span class="hljs-keyword"><span class="hljs-keyword">associatedtype</span></span> <span class="hljs-type"><span class="hljs-type">Failure</span></span> : <span class="hljs-type"><span class="hljs-type">Error</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-function">&lt;S&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subscriber: S)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-type"><span class="hljs-type">S</span></span> : <span class="hljs-type"><span class="hljs-type">Subscriber</span></span>, <span class="hljs-type"><span class="hljs-type">Self</span></span>.<span class="hljs-type"><span class="hljs-type">Failure</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Failure</span></span>, <span class="hljs-type"><span class="hljs-type">Self</span></span>.<span class="hljs-type"><span class="hljs-type">Output</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Input</span></span> }</code> </pre> <br><p> å…¶ä¸­â€œè¾“å‡ºâ€æ˜¯æ­¤å‘å¸ƒæœåŠ¡å™¨ä¼ é€’çš„å€¼çš„ç±»å‹ï¼Œâ€œå¤±è´¥â€æ˜¯å¿…é¡»éµå¾ªâ€œé”™è¯¯â€åè®®çš„é”™è¯¯çš„ç±»å‹ã€‚ </p><br><p> ä»¥åŠæ¥æ”¶å‡½æ•°ï¼ˆ_ï¼šSubscriberï¼‰ï¼Œå°†ä½¿ç”¨subscribeï¼ˆ_ :)å°†è°ƒç”¨æ­¤å‡½æ•°æ·»åŠ åˆ°æ­¤å‘å¸ƒè€…ã€‚ </p><br><p> ä¾‹å¦‚ï¼Œæˆ‘ä»¬å®ç°äº†Publisherï¼Œå®ƒå°†ä¸ºæˆ‘ä»¬ç”Ÿæˆ<a href="https://en.wikipedia.org/wiki/Fibonacci_number">æ–æ³¢é‚£å¥‘æ•°</a> ã€‚ </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciPublisher</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Publisher</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Output</span></span> = <span class="hljs-type"><span class="hljs-type">Int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Failure</span></span> = <span class="hljs-type"><span class="hljs-type">Never</span></span> }</code> </pre> <br><p> ç”±äºè¯¥åºåˆ—ç”±æ•°å­—ç»„æˆï¼Œå› æ­¤è¾“å‡ºçš„ç±»å‹å°†ä¸ºIntç±»å‹çš„Outputï¼Œè€ŒFailureå°†æ˜¯ä»ä¸çš„ç‰¹æ®Šç±»å‹ï¼Œè¡¨ç¤ºæ­¤Publisherå°†æ°¸è¿œä¸ä¼šå¤±è´¥ã€‚ </p><br><p> ä¸ºäº†çµæ´»æ€§ï¼Œæˆ‘ä»¬æŒ‡å®šäº†è¦æ¥æ”¶çš„å…ƒç´ æ•°é‡çš„é™åˆ¶ï¼Œå¹¶å°†æ­¤å€¼åŒ…è£…åœ¨Publisherçš„æŸäº›é…ç½®å¯¹è±¡ä¸­ã€‚ </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-type"><span class="hljs-type">UInt</span></span> }</code> </pre> <br><p> è®©æˆ‘ä»¬ä»”ç»†çœ‹ä¸€ä¸‹è¿™æ®µä»£ç ï¼Œvar countï¼šUIntçœ‹èµ·æ¥æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œä½†æ˜¯å®ƒçš„ä½¿ç”¨å°†æˆ‘ä»¬é™åˆ¶åœ¨UIntç±»å‹çš„æœ‰æ•ˆå€¼èŒƒå›´å†…ï¼Œå¹¶ä¸”ä¹Ÿä¸æ¸…æ¥šè¦è¡¨æ˜æ˜¯å¦ä»ç„¶éœ€è¦æ— é™åºåˆ—ã€‚ </p><br><p> ä»£æ›¿UIntï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åœ¨Combineä¸­å®šä¹‰çš„Subscribers.Demandç±»å‹ï¼Œè¯¥ç±»å‹ä¹Ÿè¢«æè¿°ä¸ºé€šè¿‡è®¢é˜…ä»è®¢é˜…æœåŠ¡å™¨å‘é€åˆ°å‘å¸ƒæœåŠ¡å™¨çš„ç±»å‹ã€‚ ç®€å•æ¥è¯´ï¼Œå®ƒæ˜¾ç¤ºäº†å¯¹å…ƒç´ çš„<em>éœ€æ±‚</em> ï¼Œè®¢é˜…æœåŠ¡å™¨è¯·æ±‚äº†å¤šå°‘ä¸ªå…ƒç´ ã€‚ æ— é™åˆ¶-ä¸é™åˆ¶ï¼Œæ²¡æœ‰é™åˆ¶-å®Œå…¨æ²¡æœ‰ï¼Œæœ€å¤§ï¼ˆNï¼‰-ä¸è¶…è¿‡Næ¬¡ã€‚ </p><br><pre> <code class="swift hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Demand</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Equatable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Comparable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Hashable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Codable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomStringConvertible</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> unlimited: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">none</span></span>: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> <span class="hljs-comment"><span class="hljs-comment">///  Demand.max(0) @inlinable public static func max(_ value: Int) -&gt; Subscribers.Demand .... }</span></span></code> </pre> <br><p> æˆ‘ä»¬é‡å†™FibonacciConfigurationï¼Œå°†ç±»å‹æ›´æ”¹ä¸ºæ–°çš„ç±»å‹ä»¥è¿›è¡Œè®¡æ•°ã€‚ </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> }</code> </pre> <br><p> è®©æˆ‘ä»¬å›åˆ°Publisherå¹¶å®ç°receiveï¼ˆ_ï¼šSubscriberï¼‰æ–¹æ³•ï¼Œæ­£å¦‚æˆ‘ä»¬å›æƒ³çš„é‚£æ ·ï¼Œéœ€è¦ä½¿ç”¨æ­¤æ–¹æ³•å°†Subscriberæ·»åŠ åˆ°Publisherã€‚ å¹¶ä¸”ä»–é€šè¿‡â€œè®¢é˜…â€å®Œæˆæ­¤æ“ä½œï¼Œå‘å¸ƒè€…å¿…é¡»åˆ›å»ºä¸€ä¸ªè®¢é˜…å¹¶å°†è¯¥è®¢é˜…è½¬ç§»ç»™è®¢é˜…è€…ã€‚ </p><br><pre> <code class="swift hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-function">&lt;S&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subscriber: S)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-type"><span class="hljs-type">S</span></span> : <span class="hljs-type"><span class="hljs-type">Subscriber</span></span>, <span class="hljs-type"><span class="hljs-type">Failure</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Failure</span></span>, <span class="hljs-type"><span class="hljs-type">Output</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Input</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> subscription = <span class="hljs-type"><span class="hljs-type">FibonacciSubscription</span></span>(subscriber: subscriber, configuration: configuration) subscriber.receive(subscription: subscription) }</code> </pre> <br><p> è¿™æ˜¯ä¸€ä¸ªé€šç”¨å‡½æ•°ï¼Œå°†è®¢é˜…æœåŠ¡å™¨ä½œä¸ºå‚æ•°ï¼Œå‘å¸ƒæœåŠ¡å™¨çš„è¾“å‡ºå€¼å¿…é¡»ä¸è®¢é˜…æœåŠ¡å™¨çš„è¾“å…¥å€¼ï¼ˆè¾“å‡º== S.Inputï¼‰åŒ¹é…ï¼Œå¯¹äºé”™è¯¯ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ è¿™å¯¹äºâ€œè¿æ¥â€ Publisher'aå’ŒSubscriber'aæ˜¯å¿…éœ€çš„ã€‚ </p><br><p> åœ¨å‡½æ•°æœ¬èº«ä¸­ï¼Œåˆ›å»ºFibonacciSubscriptionè®¢é˜…ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬è½¬ç§»è®¢é˜…è€…å’Œé…ç½®ã€‚ ä¹‹åï¼Œè®¢é˜…å°†è½¬ç§»åˆ°è®¢é˜…è€…ã€‚ </p><br><p> æˆ‘ä»¬çš„å‘å¸ƒè€…å·²ç»å‡†å¤‡å°±ç»ªï¼Œæœ€ç»ˆæˆ‘ä»¬å¯ä»¥ï¼š </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciPublisher</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Publisher</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Output</span></span> = <span class="hljs-type"><span class="hljs-type">Int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Failure</span></span> = <span class="hljs-type"><span class="hljs-type">Never</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-function">&lt;S&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subscriber: S)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-type"><span class="hljs-type">S</span></span> : <span class="hljs-type"><span class="hljs-type">Subscriber</span></span>, <span class="hljs-type"><span class="hljs-type">Failure</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Failure</span></span>, <span class="hljs-type"><span class="hljs-type">Output</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Input</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> subscription = <span class="hljs-type"><span class="hljs-type">FibonacciSubscription</span></span>(subscriber: subscriber, configuration: configuration) subscriber.receive(subscription: subscription) } }</code> </pre> <br><p> å¦‚æ‚¨æ‰€è§ï¼ŒPublisheræœ¬èº«ä¸åŒ…å«ä»»ä½•ç”¨äºç”ŸæˆFibonacciåºåˆ—çš„é€»è¾‘ï¼›æ‰€æœ‰é€»è¾‘å°†åœ¨è®¢é˜…ç±»-FibonacciSubscriptionä¸­ã€‚ </p><br><p> æ‚¨å¯èƒ½å·²ç»çŒœåˆ°äº†ï¼ŒFibonacciSubscriptionç±»å°†éµå¾ªSubscriptionåè®®ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹è¯¥åè®®çš„å®šä¹‰ã€‚ </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscription</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cancellable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomCombineIdentifierConvertible</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> demand: Subscribers.Demand)</span></span></span></span> }</code> </pre> <br><p> è¯·æ±‚ï¼ˆ_ï¼šSubscribers.Demandï¼‰å‡½æ•°å‘Šè¯‰å‘å¸ƒè€…ä»–å¯ä»¥å‘è®¢é˜…è€…å‘é€æ›´å¤šå€¼ã€‚ åœ¨è¿™ç§æ–¹æ³•ä¸­ï¼Œå‘é€æ–æ³¢é‚£å¥‘æ•°çš„é€»è¾‘å°†æ˜¯è¿™æ ·ã€‚ <br> æˆ‘ä»¬è¿˜éœ€è¦å®ç°ä»¥ä¸‹Cancelableableåè®®å¹¶å®ç°cancelï¼ˆï¼‰å‡½æ•°ã€‚ </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cancellable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> }</code> </pre> <br><p> åªéœ€éµå¾ªCustomCombineIdentifierConvertibleåè®®å¹¶å®šä¹‰åªè¯»å˜é‡CombineIdentifierã€‚ </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomCombineIdentifierConvertible</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> combineIdentifier: <span class="hljs-type"><span class="hljs-type">CombineIdentifier</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> } }</code> </pre> <br><p> éœ€è¦æ¾„æ¸…çš„æ˜¯ï¼Œå¦‚æœæ‚¨æ»šåŠ¨åˆ°Combineä¸­CustomCombineIdentifierConvertibleåè®®çš„å®šä¹‰ä¸‹æ–¹ï¼Œåˆ™å¯ä»¥çœ‹åˆ°Combineä¸ºè¯¥åè®®æä¾›äº†æ‰©å±•åï¼Œæ ¼å¼ä¸º- </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomCombineIdentifierConvertible</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Self</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnyObject</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> combineIdentifier: <span class="hljs-type"><span class="hljs-type">CombineIdentifier</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> } }</code> </pre> <br><p> è¿™å‘Šè¯‰æˆ‘ä»¬ï¼Œå¦‚æœéµå¾ªè¯¥åè®®çš„ç±»å‹ä¹Ÿéµå¾ªAnyObjectåè®®ï¼ˆå³ï¼Œå¦‚æœè¯¥ç±»å‹æ˜¯ç±»ï¼‰ï¼Œåˆ™é»˜è®¤æƒ…å†µä¸‹ä¼šæä¾›å˜é‡CombineIdentifierçš„å®šä¹‰ï¼šCombineIdentifierã€‚  FibonacciSubscriptionæ˜¯ä¸€ä¸ªç±»ï¼Œå› æ­¤æˆ‘ä»¬è·å¾—äº†é»˜è®¤çš„å˜é‡å®šä¹‰ã€‚ </p><br><h1 id="subscription"> è®¢é˜…æ–¹å¼ </h1><br><p> å› æ­¤ï¼Œæˆ‘ä»¬å°†å¼€å§‹å®æ–½FibonacciSubscriptionã€‚ </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciSubscription</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">S</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscriber</span></span></span><span class="hljs-class">&gt;: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscription</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">S</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Input</span></span></span><span class="hljs-class"> == </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Int</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subscriber: <span class="hljs-type"><span class="hljs-type">S?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(subscriber: <span class="hljs-type"><span class="hljs-type">S?</span></span>, configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.subscriber = subscriber <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.configuration = configuration <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span> = configuration.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span> } ... }</code> </pre> <br><p> å¦‚æ‚¨æ‰€è§ï¼ŒFibonacciConfigurationåŒ…å«æŒ‡å‘è®¢æˆ·çš„å¼ºå¤§é“¾æ¥ï¼Œæ¢å¥è¯è¯´ï¼Œå®ƒæ˜¯è®¢æˆ·çš„æ‰€æœ‰è€…ã€‚  <strong>è¿™æ˜¯é‡è¦çš„ä¸€ç‚¹ï¼Œè®¢é˜…è´Ÿè´£ä¿ç•™è®¢é˜…è€…ï¼Œå¹¶ä¸”å¿…é¡»ä¿ç•™è®¢é˜…è€…ï¼Œç›´åˆ°å®Œæˆå·¥ä½œï¼Œå‡ºç°é”™è¯¯æˆ–å–æ¶ˆä¸ºæ­¢ã€‚</strong> </p><br><p> æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä»Cancellableåè®®ä¸­å®ç°cancelï¼ˆï¼‰æ–¹æ³•ã€‚ </p><br><pre> <code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { subscriber = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre> <br><p> å°†è®¢æˆ·è®¾ç½®ä¸ºnilä½¿å…¶æ— æ³•è¿›è¡Œé¢„è®¢ã€‚ </p><br><p> ç°åœ¨ï¼Œæˆ‘ä»¬å‡†å¤‡å¼€å§‹å‘é€æ–æ³¢é‚£å¥‘æ•°å­—çš„å®ç°ã€‚ <br> æˆ‘ä»¬å®ç°äº†è¯·æ±‚æ–¹æ³•ï¼ˆ_ï¼šSubscribers.Demandï¼‰ã€‚ </p><br><pre> <code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> demand: Subscribers.Demand)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// 1 guard count &gt; .none else { subscriber?.receive(completion: .finished) return } // 2 count -= .max(1) subscriber?.receive(0) if count == .none { subscriber?.receive(completion: .finished) return } // 3 count -= .max(1) subscriber?.receive(1) if count == .none { subscriber?.receive(completion: .finished) return } // 4 var prev = 0 var current = 1 var temp: Int while true { temp = prev prev = current current += temp subscriber?.receive(current) count -= .max(1) if count == .none { subscriber?.receive(completion: .finished) return } } }</span></span></code> </pre> <br><p>  1ï¼‰ä»ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬æ£€æŸ¥å‘å¸ƒè€…å¯ä»¥æä¾›å¤šå°‘å…ƒç´ ï¼Œå¦‚æœæ ¹æœ¬ä¸æä¾›ï¼Œåˆ™å®Œæˆå‘é€ï¼Œå¹¶å‘è®¢é˜…è€…å‘é€ä¿¡å·ï¼Œè¡¨æ˜å·ç å‘é€å·²å®Œæˆã€‚ <br>  2ï¼‰å¦‚æœæœ‰éœ€è¦ï¼Œåˆ™å°†è¯·æ±‚çš„æ€»æ•°å‡å°‘ä¸€ä¸ªï¼Œå°†æ–æ³¢é‚£å¥‘æ•°åˆ—çš„ç¬¬ä¸€ä¸ªå…ƒç´ å‘é€ç»™è®¢é˜…æœåŠ¡å™¨ï¼Œå³0ï¼Œç„¶åå†æ¬¡æ£€æŸ¥å‘å¸ƒæœåŠ¡å™¨å¯ä»¥æä¾›ç»™æˆ‘ä»¬çš„å…ƒç´ æ•°é‡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™å‘è®¢é˜…æœåŠ¡å™¨å‘é€ä¿¡å·ä»¥å®Œæˆã€‚ <br>  3ï¼‰ä¸2ï¼‰æ®µä¸­çš„æ–¹æ³•ç›¸åŒï¼Œä½†ä»…é€‚ç”¨äºæ–æ³¢é‚£å¥‘æ•°åˆ—ä¸­çš„ç¬¬äºŒä¸ªå…ƒç´ ã€‚ <br>  4ï¼‰å¦‚æœéœ€è¦ä¸¤ä¸ªä»¥ä¸Šçš„å…ƒç´ ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†å®ç°ä¸€ä¸ªè¿­ä»£ç®—æ³•æ¥æŸ¥æ‰¾æ–æ³¢é‚£å¥‘æ•°ï¼Œåœ¨æ¯ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬å°†æŠŠä¸‹ä¸€ä¸ªæ•°å­—ä»æ–æ³¢é‚£å¥‘æ•°åˆ—è½¬ç§»åˆ°Subscriber'yï¼Œå¹¶æ£€æŸ¥Publisherä»ç„¶å¯ä»¥æä¾›å¤šå°‘ä¸ªå…ƒç´ ã€‚ å¦‚æœå‘å¸ƒè€…ä¸å†æä¾›æ–°å·ç ï¼Œåˆ™å‘è®¢é˜…è€…å‘é€å®Œæˆä¿¡å·ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">ç›®å‰ï¼Œæˆ‘ä»¬å·²ç»ç¼–å†™äº†è¿™æ ·çš„ä»£ç </b> <div class="spoiler_text"><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciPublisher</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Publisher</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Output</span></span> = <span class="hljs-type"><span class="hljs-type">Int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Failure</span></span> = <span class="hljs-type"><span class="hljs-type">Never</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-function">&lt;S&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subscriber: S)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-type"><span class="hljs-type">S</span></span> : <span class="hljs-type"><span class="hljs-type">Subscriber</span></span>, <span class="hljs-type"><span class="hljs-type">Failure</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Failure</span></span>, <span class="hljs-type"><span class="hljs-type">Output</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Input</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> subscription = <span class="hljs-type"><span class="hljs-type">FibonacciSubscription</span></span>(subscriber: subscriber, configuration: configuration) subscriber.receive(subscription: subscription) } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciSubscription</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">S</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscriber</span></span></span><span class="hljs-class">&gt;: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscription</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">S</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Input</span></span></span><span class="hljs-class"> == </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Int</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subscriber: <span class="hljs-type"><span class="hljs-type">S?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(subscriber: <span class="hljs-type"><span class="hljs-type">S?</span></span>, configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.subscriber = subscriber <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.configuration = configuration <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span> = configuration.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { subscriber = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> demand: Subscribers.Demand)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// 1 guard count &gt; .none else { subscriber?.receive(completion: .finished) return } // 2 count -= .max(1) subscriber?.receive(0) if count == .none { subscriber?.receive(completion: .finished) return } // 3 count -= .max(1) subscriber?.receive(1) if count == .none { subscriber?.receive(completion: .finished) return } // 4 var prev = 0 var current = 1 var temp: Int while true { temp = prev prev = current current += temp subscriber?.receive(current) count -= .max(1) if count == .none { subscriber?.receive(completion: .finished) return } } } }</span></span></code> </pre> </div></div><br><h3 id="pervoe-testirovanie"> ç¬¬ä¸€æ¬¡æµ‹è¯• </h3><br><p> ç°åœ¨ï¼Œæˆ‘ä»¬å°†æµ‹è¯•æ‰€æ‹¥æœ‰çš„å†…å®¹ï¼Œæ‹¥æœ‰å‘å¸ƒè€…å’Œè®¢é˜…è€…ï¼Œæ²¡æœ‰è¶³å¤Ÿçš„Sibscriberï¼ŒCombineä»æ¡†ä¸­æä¾›2ä¸ªSibscriberï¼šæ¥æ”¶å™¨å’Œåˆ†é…ã€‚ </p><br><ul><li> ä¸‹æ²‰-æ­¤æ–¹æ³•åˆ›å»ºä¸€ä¸ªè®¢æˆ·å¹¶ç«‹å³è¯·æ±‚<strong>æ— é™</strong>æ•°é‡çš„å€¼ã€‚ </li><li>  Assign-å°†Publisherä¸­çš„æ¯ä¸ªå…ƒç´ è®¾ç½®ä¸ºå¯¹è±¡å±æ€§ã€‚ </li></ul><br><p>  â€œæ¥æ”¶å™¨â€éå¸¸é€‚åˆæˆ‘ä»¬çš„ç›®çš„ï¼Œåº”ç‰¹åˆ«æ³¨æ„å®ƒè¦æ±‚æ— é™æ•°é‡çš„å€¼çš„äº‹å®ã€‚ </p><br><p> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦åšå‡ºé‡è¦åŒºåˆ†ï¼Œæˆ‘ä»¬çš„å‘å¸ƒè€…åœ¨countå˜é‡ä¸­ç¡®å®šæˆ‘ä»¬çš„å‘å¸ƒè€…å¯ä»¥æä¾›çš„å…ƒç´ æ•°é‡ï¼Œè€Œè¿™äº›æ¡ä»¶ç”±æˆ‘ä»¬è‡ªå·±å†³å®šã€‚ åŸåˆ™ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ä¸ä½¿ç”¨æ­¤å˜é‡ï¼Œå¹¶ä¸”ä¸å—ä¼ é€’æ–æ³¢é‚£å¥‘æ•°çš„é™åˆ¶ï¼Œä½†æ˜¯å¾ˆå¿«æˆ‘ä»¬å°†è¶…å‡ºIntç±»å‹çš„å…è®¸å€¼èŒƒå›´ã€‚ <br> æ¥æ”¶å™¨çš„æƒ…å†µæœ‰æ‰€ä¸åŒï¼Œæ¯ä¸ªè®¢é˜…æœåŠ¡å™¨ç¡®å®šè¦æ¥æ”¶å¤šå°‘ä¸ªå€¼ï¼Œæ¥æ”¶å™¨è¯·æ±‚æ— é™æ•°é‡çš„å€¼ï¼Œè¿™æ„å‘³ç€å®ƒå°†æ¥æ”¶å€¼ï¼Œç›´åˆ°æ¥æ”¶åˆ°å®Œæˆï¼Œé”™è¯¯æˆ–å–æ¶ˆçš„ä¿¡å·ã€‚ </p><br><p> ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨å‘å¸ƒæœåŠ¡å™¨ï¼Œæˆ‘ä»¬å°†å…¶åˆ›å»ºæ·»åŠ åˆ°å‘å¸ƒæœåŠ¡å™¨åè®®æ‰©å±•ä¸­ã€‚ </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Publishers</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fibonacci</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(configuration: FibonacciConfiguration)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">FibonacciPublisher</span></span> { <span class="hljs-type"><span class="hljs-type">FibonacciPublisher</span></span>(configuration: configuration) } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fibonacci</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">count</span></span></span></span><span class="hljs-function"><span class="hljs-params">: Subscribers.Demand = .</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">max</span></span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-number">6</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">)</span></span></span></span></span></span>) -&gt; <span class="hljs-type"><span class="hljs-type">FibonacciPublisher</span></span> { <span class="hljs-type"><span class="hljs-type">FibonacciPublisher</span></span>(configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>)) } }</code> </pre> <br><p> å› æ­¤å°è¯•æˆ‘ä»¬çš„å‘å¸ƒè€… </p><br><pre> <code class="swift hljs"><span class="hljs-type"><span class="hljs-type">Publishers</span></span>.fibonacci(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: .<span class="hljs-built_in"><span class="hljs-built_in">max</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>)) .sink { value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(value, terminator: <span class="hljs-string"><span class="hljs-string">" "</span></span>) } <span class="hljs-comment"><span class="hljs-comment">// print 0 1 1 2 3 5 8 13 21 34 - OK</span></span></code> </pre> <br><p> ç°åœ¨è¾¹ç•Œæƒ…å†µ </p><br><pre> <code class="swift hljs"><span class="hljs-type"><span class="hljs-type">Publishers</span></span>.fibonacci(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: .<span class="hljs-built_in"><span class="hljs-built_in">max</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>)) .sink { value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(value, terminator: <span class="hljs-string"><span class="hljs-string">" "</span></span>) } <span class="hljs-comment"><span class="hljs-comment">// prinst 0 - OK Publishers.fibonacci(count: .max(2)) .sink { value in print(value, terminator: " ") } // prints 0 1 - OK Publishers.fibonacci(count: .none) .print() //    publisher'a .sink { value in print(value, terminator: " ") } // prints receive finished - OK</span></span></code> </pre> <br><p> ä½†æ˜¯ï¼Œå¦‚æœæŒ‡å®š.unlimitedä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ </p><br><pre> <code class="swift hljs"><span class="hljs-type"><span class="hljs-type">Publishers</span></span>.fibonacci(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: .unlimited) .<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>() .sink { value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(value, terminator: <span class="hljs-string"><span class="hljs-string">" "</span></span>) } <span class="hljs-comment"><span class="hljs-comment">// prints 0 1 1 2 3 5 8 13 21 ...   ,     Int.</span></span></code> </pre> <br><p> å¦‚ä½•ä½¿ç”¨.unlimitedï¼Œä½†èƒ½å¤Ÿè¾“å‡ºå¤šä¸ªæ•°å­—ï¼Ÿ ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦.prefixï¼ˆ_ï¼‰è¿ç®—ç¬¦ï¼Œè¯¥è¿ç®—ç¬¦çš„å·¥ä½œæ–¹å¼ä¸é›†åˆä¸­çš„.prefixï¼ˆ_ï¼‰ç›¸åŒï¼Œå³ï¼Œå®ƒä»…ä¿ç•™å‰Nä¸ªå…ƒç´ ã€‚ </p><br><pre> <code class="swift hljs"><span class="hljs-type"><span class="hljs-type">Publishers</span></span>.fibonacci(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: .unlimited) .<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>() .<span class="hljs-keyword"><span class="hljs-keyword">prefix</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>) .sink { <span class="hljs-number"><span class="hljs-number">_</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> } <span class="hljs-comment"><span class="hljs-comment">// prints 0 1 1 2 3 cancel   ,       Int.</span></span></code> </pre> <br><p> æ€ä¹ˆäº† ä¹Ÿè®¸åœ¨.prefixï¼ˆ_ï¼‰ä¸­ï¼Ÿ è®©æˆ‘ä»¬å¯¹Foundationçš„æ ‡å‡†åºåˆ—è¿›è¡Œä¸€äº›å®éªŒã€‚ </p><br><pre> <code class="swift hljs"><span class="hljs-comment"><span class="hljs-comment">//   1 2 3 4 5 6 7 8 ... 1... .publisher .print() .prefix(5) .sink { _ in } // prints 1 2 3 4 5 cancel - </span></span></code> </pre> <br><p> å¦‚æˆ‘ä»¬æ‰€è§ï¼Œä¸Šé¢çš„ä»£ç æ­£å¸¸å·¥ä½œï¼Œé‚£ä¹ˆé—®é¢˜å‡ºåœ¨æˆ‘ä»¬çš„Publisherçš„å®ç°ä¸­ã€‚ <br> æˆ‘ä»¬æŸ¥çœ‹æ¥è‡ª.printï¼ˆï¼‰çš„æ—¥å¿—ï¼Œç„¶åçœ‹åˆ°åœ¨æ¥è‡ª.prefixï¼ˆ_ï¼‰çš„Nä¸ªè¯·æ±‚ä¹‹åï¼Œæˆ‘ä»¬åœ¨FibonacciSubscriptionä¸Šè°ƒç”¨äº†cancelï¼ˆï¼‰ï¼Œå°†è®¢æˆ·è®¾ç½®ä¸ºnilã€‚ </p><br><pre> <code class="swift hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { subscriber = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre> <br><p> å¦‚æœæ‰“å¼€è°ƒç”¨å †æ ˆï¼Œåˆ™å¯ä»¥çœ‹åˆ°ä»è¯·æ±‚ï¼ˆ_ :)è°ƒç”¨äº†cancelï¼ˆï¼‰ï¼Œå³åœ¨å¯¹è®¢æˆ·çš„è°ƒç”¨ä¸­ã€‚.Receiveï¼ˆ_ï¼‰ã€‚ ä»ä¸­æˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼Œè¯·æ±‚ï¼ˆ_ :)è®¢é˜…æœåŠ¡å™¨å†…éƒ¨çš„æŸä¸ªæ—¶é—´ç‚¹å¯èƒ½å˜ä¸ºnilï¼Œç„¶åæˆ‘ä»¬éœ€è¦åœæ­¢ç”Ÿæˆæ–°æ•°å­—çš„å·¥ä½œã€‚ å°†æ­¤æ¡ä»¶æ·»åŠ åˆ°æˆ‘ä»¬çš„ä»£ç ä¸­ã€‚ </p><br><pre> <code class="swift hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> demand: Subscribers.Demand)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// 1 guard count &gt; .none else { subscriber?.receive(completion: .finished) return } // 2 count -= .max(1) subscriber?.receive(0) guard let _ = subscriber else { return } // new if count == .none { subscriber?.receive(completion: .finished) return } // 3 count -= .max(1) subscriber?.receive(1) guard let _ = subscriber else { return } // new if count == .none { subscriber?.receive(completion: .finished) return } // 4 var prev = 0 var current = 1 var temp: Int while let subscriber = subscriber { // new temp = prev prev = current current += temp subscriber.receive(current) count -= .max(1) if count == .none { subscriber.receive(completion: .finished) return } } }</span></span></code> </pre> <br><p> ç°åœ¨è¿è¡Œæˆ‘ä»¬çš„æµ‹è¯•ä»£ç ã€‚ </p><br><pre> <code class="swift hljs"><span class="hljs-type"><span class="hljs-type">Publishers</span></span>.fibonacci(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: .unlimited) .<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>() .<span class="hljs-keyword"><span class="hljs-keyword">prefix</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>) .sink { <span class="hljs-number"><span class="hljs-number">_</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> } <span class="hljs-comment"><span class="hljs-comment">// prints 0 1 1 2 3 cancel - </span></span></code> </pre> <br><p> å¾—åˆ°äº†é¢„æœŸçš„è¡Œä¸ºã€‚ </p><br><h1 id="subscriber"> è®¢æˆ· </h1><br><p> é‚£ä¹ˆæˆ‘ä»¬çš„æ–æ³¢é‚£å¥‘è®¢é˜…å·²ç»å‡†å¤‡å¥½äº†å—ï¼Ÿ å¹¶éå¦‚æ­¤ï¼Œåœ¨æˆ‘ä»¬çš„æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬åªä½¿ç”¨äº†ä¸€ä¸ªæ¥æ”¶å™¨ï¼Œè¦æ±‚è¾“å…¥æ— é™æ•°é‡çš„æ•°å­—ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå¸Œæœ›è·å¾—ä¸€å®šæ•°é‡çš„æœ‰é™æ•°å­—çš„ç”¨æˆ·å‘¢ï¼Ÿ åˆå¹¶æ²¡æœ‰æä¾›è¿™æ ·çš„è®¢é˜…è€…ï¼Œä½†æ˜¯ä»€ä¹ˆé˜»æ­¢æˆ‘ä»¬ç¼–å†™è‡ªå·±çš„è®¢é˜…è€…å‘¢ï¼Ÿ ä»¥ä¸‹æ˜¯æˆ‘ä»¬çš„FibonacciSubscriberçš„å®ç°ã€‚ </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciSubscriber</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscriber</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Input</span></span> = <span class="hljs-type"><span class="hljs-type">Int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Failure</span></span> = <span class="hljs-type"><span class="hljs-type">Never</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> limit: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(limit: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.limit = limit } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subscription: Subscription)</span></span></span></span> { subscription.request(limit) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> input: Input)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> { .<span class="hljs-keyword"><span class="hljs-keyword">none</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(completion: Subscribers.Completion&lt;Failure&gt;)</span></span></span></span> { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Subscriber's completion: \(completion)"</span></span>) } }</code> </pre> <br><p> å› æ­¤ï¼Œæˆ‘ä»¬çš„FibonacciSubscriberå…·æœ‰limitå±æ€§ï¼Œè¯¥å±æ€§ç¡®å®šè¯¥è®¢é˜…æœåŠ¡å™¨å¸Œæœ›æ¥æ”¶å¤šå°‘ä¸ªå…ƒç´ ã€‚ è¿™æ˜¯é€šè¿‡receiveï¼ˆ_ï¼šSubscriptionï¼‰æ–¹æ³•å®Œæˆçš„ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å‘Šè¯‰è®¢é˜…æˆ‘ä»¬éœ€è¦å¤šå°‘ä¸ªå…ƒç´ ã€‚ è¿˜éœ€è¦æ³¨æ„receiveï¼ˆ_ï¼šInputï¼‰-&gt; Subscribers.Demandå‡½æ•°ï¼Œå½“æ¥æ”¶åˆ°ä¸€ä¸ªæ–°å€¼æ—¶ä¼šè°ƒç”¨æ­¤å‡½æ•°ï¼Œä½œä¸ºè¿”å›å€¼ï¼Œæˆ‘ä»¬æŒ‡ç¤ºè¦æ¥æ”¶å¤šå°‘ä¸ªå…¶ä»–å…ƒç´ ï¼š.none-ä¸€ç‚¹ä¹Ÿä¸ï¼Œ.maxï¼ˆNï¼‰Nä¸ªï¼Œæ€»å…±ï¼Œæ¥æ”¶åˆ°çš„å…ƒç´ æ€»æ•°å°†ç­‰äºå·²æ¥æ”¶çš„å·²å‘é€è®¢é˜…çš„å€¼ï¼ˆ_ï¼šè®¢é˜…ï¼‰ä¸æ¥è‡ªæ¥æ”¶çš„æ‰€æœ‰è¿”å›å€¼ï¼ˆ_ï¼šè¾“å…¥ï¼‰-&gt; Subscribers.Demandä¹‹å’Œã€‚ </p><br><h3 id="vtoroe-testirovanie"> ç¬¬äºŒæ¬¡æµ‹è¯• </h3><br><p> è®©æˆ‘ä»¬å°è¯•ä½¿ç”¨FibonacciSubscriberã€‚ </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> subscriber = <span class="hljs-type"><span class="hljs-type">FibonacciSubscriber</span></span>(limit: .<span class="hljs-built_in"><span class="hljs-built_in">max</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>)) <span class="hljs-type"><span class="hljs-type">Publishers</span></span>.fibonacci(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: .<span class="hljs-built_in"><span class="hljs-built_in">max</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>)) .<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>() .subscribe(subscriber) <span class="hljs-comment"><span class="hljs-comment">// prints 0 1 1 2 3 -     0 1 1</span></span></code> </pre> <br><p> å¦‚æˆ‘ä»¬æ‰€è§ï¼Œå‘å¸ƒæœåŠ¡å™¨å‘é€äº†5ä¸ªå€¼ï¼Œè€Œä¸æ˜¯3ä¸ªã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ å› ä¸ºFibonacciSubscription'açš„requestï¼ˆ_ï¼šSubscribers.Demandï¼‰æ–¹æ³•æ²¡æœ‰è€ƒè™‘è®¢é˜…è€…çš„éœ€æ±‚ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬å¯¹å…¶è¿›è¡Œä¿®å¤ï¼Œä¸ºæ­¤æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªè¯·æ±‚çš„é™„åŠ å±æ€§ï¼Œé€šè¿‡è¯¥å±æ€§æˆ‘ä»¬å¯ä»¥è·Ÿè¸ªè®¢é˜…è€…çš„éœ€æ±‚ã€‚ </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciSubscription</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">S</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscriber</span></span></span><span class="hljs-class">&gt;: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscription</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">S</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Input</span></span></span><span class="hljs-class"> == </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Int</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subscriber: <span class="hljs-type"><span class="hljs-type">S?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> requested: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> = .<span class="hljs-keyword"><span class="hljs-keyword">none</span></span> <span class="hljs-comment"><span class="hljs-comment">// new init(subscriber: S?, configuration: FibonacciConfiguration) { self.subscriber = subscriber self.configuration = configuration self.count = configuration.count } func cancel() { subscriber = nil } func request(_ demand: Subscribers.Demand) { guard count &gt; .none else { subscriber?.receive(completion: .finished) return } requested += demand // new count -= .max(1) requested -= .max(1) // new requested += subscriber?.receive(0) ?? .none // new guard let _ = subscriber, requested &gt; .none else { return } // new if count == .none { subscriber?.receive(completion: .finished) return } count -= .max(1) requested -= .max(1) // new requested += subscriber?.receive(1) ?? .none // new guard let _ = subscriber, requested &gt; .none else { return } // new if count == .none { subscriber?.receive(completion: .finished) return } var prev = 0 var current = 1 var temp: Int while let subscriber = subscriber, requested &gt; .none { // new temp = prev prev = current current += temp requested += subscriber.receive(current) // new count -= .max(1) requested -= .max(1) // new if count == .none { subscriber.receive(completion: .finished) return } } } }</span></span></code> </pre> <br><h3 id="trete-testirovanie"> ç¬¬ä¸‰æ¬¡æµ‹è¯• </h3><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> subscriber = <span class="hljs-type"><span class="hljs-type">FibonacciSubscriber</span></span>(limit: .<span class="hljs-built_in"><span class="hljs-built_in">max</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>)) <span class="hljs-type"><span class="hljs-type">Publishers</span></span>.fibonacci(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: .<span class="hljs-built_in"><span class="hljs-built_in">max</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>)) .<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>() .subscribe(subscriber) <span class="hljs-comment"><span class="hljs-comment">// prints 0 1 1 - OK</span></span></code> </pre> <br><p>  Publisherç°åœ¨å¯ä»¥æ­£å¸¸å·¥ä½œã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">æœ€ç»ˆä»£ç </b> <div class="spoiler_text"><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Foundation <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Combine struct FibonacciConfiguration { var count: Subscribers.Demand } struct FibonacciPublisher: Publisher { typealias Output = Int typealias Failure = Never var configuration: FibonacciConfiguration func receive&lt;S&gt;(subscriber: S) where S : Subscriber, Failure == S.Failure, Output == S.Input { let subscription = FibonacciSubscription(subscriber: subscriber, configuration: configuration) subscriber.receive(subscription: subscription) } } private final class FibonacciSubscription&lt;S: Subscriber&gt;: Subscription where S.Input == Int { var subscriber: S? var configuration: FibonacciConfiguration var count: Subscribers.Demand var requested: Subscribers.Demand = .none init(subscriber: S?, configuration: FibonacciConfiguration) { self.subscriber = subscriber self.configuration = configuration self.count = configuration.count } func cancel() { subscriber = nil } func request(_ demand: Subscribers.Demand) { guard count &gt; .none else { subscriber?.receive(completion: .finished) return } requested += demand count -= .max(1) requested -= .max(1) requested += subscriber?.receive(0) ?? .none guard let _ = subscriber, requested &gt; .none else { return } if count == .none { subscriber?.receive(completion: .finished) return } count -= .max(1) requested -= .max(1) requested += subscriber?.receive(1) ?? .none guard let _ = subscriber, requested &gt; .none else { return } if count == .none { subscriber?.receive(completion: .finished) return } var prev = 0 var current = 1 var temp: Int while let subscriber = subscriber, requested &gt; .none { temp = prev prev = current current += temp requested += subscriber.receive(current) count -= .max(1) requested -= .max(1) if count == .none { subscriber.receive(completion: .finished) return } } } } extension Publishers { private static func fibonacci(configuration: FibonacciConfiguration) -&gt; FibonacciPublisher { FibonacciPublisher(configuration: configuration) } static func fibonacci(count: Subscribers.Demand = .max(6)) -&gt; FibonacciPublisher { FibonacciPublisher(configuration: FibonacciConfiguration(count: count)) } } class FibonacciSubscriber: Subscriber { typealias Input = Int typealias Failure = Never var limit: Subscribers.Demand init(limit: Subscribers.Demand) { self.limit = limit } func receive(subscription: Subscription) { subscription.request(limit) } func receive(_ input: Input) -&gt; Subscribers.Demand { .none } func receive(completion: Subscribers.Completion&lt;Failure&gt;) { print("Subscriber's completion: \(completion)") } } Publishers.fibonacci(count: .max(4)) .print() .sink { _ in } let subscriber = FibonacciSubscriber(limit: .max(3)) Publishers.fibonacci(count: .max(5)) .print() .subscribe(subscriber)</code> </pre></div></div><br><h1 id="rezultat"> ç»“æœ </h1><br><p> æˆ‘å¸Œæœ›æœ¬æ–‡èƒ½ä½¿æ‚¨æ›´â€‹â€‹å¤šåœ°äº†è§£ä»€ä¹ˆæ˜¯å‘å¸ƒè€…ï¼Œè®¢é˜…å’Œè®¢é˜…è€…ï¼Œå®ƒä»¬ä¹‹é—´å¦‚ä½•äº¤äº’ä»¥åŠåœ¨å†³å®šå®æ–½å‘å¸ƒè€…æ—¶éœ€è¦æ³¨æ„çš„å‡ ç‚¹ã€‚ æ¬¢è¿å¯¹æœ¬æ–‡è¿›è¡Œä»»ä½•è¯„è®ºå’Œæ¾„æ¸…ã€‚ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN482690/">https://habr.com/ru/post/zh-CN482690/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN482676/index.html">æœ‰æ•ˆæ’åºStructç±»å‹æ•°æ®</a></li>
<li><a href="../zh-CN482678/index.html">æˆ‘å¦‚ä½•å†³å®šé’ˆå¯¹iOSè¿›è¡Œæ–‡æœ¬æœç´¢ä»¥åŠå®ƒçš„ç»“æœ</a></li>
<li><a href="../zh-CN482680/index.html">åœ°ç©´ï¼ŒXORï¼Œå…¥ä¾µæœªåŠ å¯†çš„ZIPå’ŒPRSPã€‚ ä½¿ç”¨r0ot-mi Cryptoè§£å†³é—®é¢˜ã€‚ ç¬¬äºŒéƒ¨åˆ†</a></li>
<li><a href="../zh-CN482684/index.html">æˆ‘ç”¨ä¸¤å‘¨æ—¶é—´å’Œ552ç¾å…ƒåˆ›å»ºäº†è‡ªå·±çš„è˜¸é…±</a></li>
<li><a href="../zh-CN482686/index.html">ç§‘å­¦å®¶ä½¿åŠ¨ç‰©è¡Œä¸ºç ”ç©¶è‡ªåŠ¨åŒ–ï¼Œä»¥è§£ç å¤§è„‘åŠŸèƒ½</a></li>
<li><a href="../zh-CN482692/index.html">è‹±ç‰¹å°”NUCå·¥ä½œä¸è™šæ‹ŸåŒ–ä¹‹å®¶</a></li>
<li><a href="../zh-CN482694/index.html">Windowsä¹‹åæœ‰ç”Ÿå‘½å—ï¼Ÿæˆ–è€…åˆ°2020å¹´åœ¨å“ªé‡ŒåŸ¹å…»Windowsç³»ç»Ÿç®¡ç†å‘˜/å·¥ç¨‹å¸ˆï¼Ÿ</a></li>
<li><a href="../zh-CN482696/index.html">Windows Linuxå®‰è£…ç³»ç»Ÿçš„å…¨ç£ç›˜åŠ å¯†ã€‚ åŠ å¯†å¤šé‡å¯åŠ¨</a></li>
<li><a href="../zh-CN482698/index.html">[è®ºæ–‡]ä¸“ç”¨äºæµ®æ¸¸ç”Ÿç‰©ã€‚ æˆ‘æ²¡æœ‰å—åˆ°å·¥ä½œçš„å¯å‘</a></li>
<li><a href="../zh-CN482700/index.html">å¦‚ä½•â€œæ“â€è°·æ­Œå’ŒYandexï¼šç½‘ç«™çš„é»‘ç™½SEOä¿ƒé”€ã€‚ è°¢æ–¯å¡”ç§‘å¤«| äººPROï¼ƒ74</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>