<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö∞ ‚ôêÔ∏è üéÖüèø T√©l√©phone SIP sur STM32F7-Discovery üêá ü§º ‚ôàÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour √† tous. 

 Il y a quelque temps, nous avons √©crit comment nous avons r√©ussi √† lancer un t√©l√©phone SIP sur STM32F4-Discovery avec 1 Mo de ROM e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>T√©l√©phone SIP sur STM32F7-Discovery</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/embox/blog/431134/">  Bonjour √† tous. <br><br>  Il y a quelque temps, nous avons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©crit</a> comment nous avons r√©ussi √† lancer un t√©l√©phone SIP sur STM32F4-Discovery avec 1 Mo de ROM et 192 Ko de RAM) bas√© sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Embox</a> .  Ici, je dois dire que cette version √©tait minimale et connectait deux t√©l√©phones directement sans serveur et avec une transmission vocale dans un seul sens.  Par cons√©quent, nous avons d√©cid√© de lancer un t√©l√©phone plus complet avec un appel via le serveur, une transmission vocale dans les deux sens, mais en m√™me temps, garder la taille de m√©moire la plus petite possible. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/W6wuEIZJf8o" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><a name="habracut"></a><br>  Pour le t√©l√©phone, il a √©t√© d√©cid√© de choisir l'application <i>simple_pjsua</i> dans le cadre de la biblioth√®que PJSIP.  Il s'agit d'une application minimale qui peut s'inscrire sur le serveur, recevoir et r√©pondre aux appels.  Ci-dessous, je vais imm√©diatement d√©crire comment ex√©cuter cela sur le STM32F7-Discovery. <br><br><h3>  Comment courir </h3><br><ol><li>  Configuration d'Embox <pre><code class="bash hljs">make confload-platform/pjsip/stm32f7cube</code> </pre> </li><li>  Dans le fichier conf / mods.config, d√©finissez le compte SIP souhait√©. <br><br><pre> <code class="bash hljs">include platform.pjsip.cmd.simple_pjsua_imported( sip_domain=<span class="hljs-string"><span class="hljs-string">"server"</span></span>, sip_user=<span class="hljs-string"><span class="hljs-string">"username"</span></span>, sip_passwd=<span class="hljs-string"><span class="hljs-string">"password"</span></span>)</code> </pre><br>  o√π <i>serveur</i> est le serveur SIP (par exemple, sip.linphone.org), le <i>nom d'utilisateur</i> et le <i>mot de passe</i> sont le nom d'utilisateur et le mot de passe du compte. <br></li><li>  Construisez Embox avec la commande <i>make</i> .  √Ä propos du firmware de la carte que nous avons sur le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">wiki</a> et dans l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> . <br></li><li>  Ex√©cutez la commande "simple_pjsua_imported" dans la console Embox <br><br><pre> <code class="bash hljs">00:00:12.870 pjsua_acc.c ....SIP outbound status <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> acc 0 is not active 00:00:12.884 pjsua_acc.c ....sip:alexk2222@sip.linphone.org: registration success, status=200 (Registration succes 00:00:12.911 pjsua_acc.c ....Keep-alive timer started <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> acc 0, destination:91.121.209.194:5060, interval:15s</code> </pre><br></li><li>  Enfin, il reste √† ins√©rer des haut-parleurs ou des √©couteurs dans la sortie audio, et √† parler dans deux petits microphones MEMS pr√®s de l'√©cran.  Nous appelons depuis Linux via l'application simple_pjsua, pjsua.  Eh bien, ou vous pouvez tout autre type de t√©l√©phone portable. <br></li></ol><br>  Tout cela est d√©crit sur notre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">wiki</a> . <br><br><h3>  Comment en sommes-nous arriv√©s l√†? </h3><br>  Ainsi, au d√©part, la question s'est pos√©e de choisir une plate-forme mat√©rielle.  Comme il √©tait clair que le STM32F4-Discovery ne tiendrait pas en m√©moire, le STM32F7-Discovery a √©t√© choisi.  Elle poss√®de un lecteur flash de 1 Mo et 256 Ko de RAM (+ 64 m√©moires rapides sp√©ciales, que nous utiliserons √©galement).  Pas beaucoup non plus pour les appels via le serveur, mais j'ai d√©cid√© d'essayer d'entrer. <br><br>  Classiquement, la t√¢che √©tait divis√©e en plusieurs √©tapes: <br><br><ul><li>  Ex√©cution de PJSIP sur QEMU.  C'√©tait pratique pour le d√©bogage, en plus nous avions d√©j√† le support du codec AC97 l√†-bas. </li><li>  Enregistrement et lecture de la voix sur QEMU et STM32. </li><li>  <i>Portage d'</i> une application <i>simple_pjsua √†</i> partir de PJSIP.  Il vous permet de vous inscrire sur le serveur SIP et de passer des appels. </li><li>  D√©ployez votre propre serveur bas√© sur Asterisk et testez-le, puis essayez des serveurs externes tels que sip.linphone.org </li></ul><br>  Le son dans Embox fonctionne via Portaudio, qui est √©galement utilis√© dans PISIP.  Les premiers probl√®mes sont apparus sur QEMU - WAV a bien jou√© √† 44100 Hz, mais quelque chose s'est mal pass√© √† 8000.  Il s'est av√©r√© qu'il s'agissait de r√©gler la fr√©quence - par d√©faut, c'√©tait 44100 dans l'√©quipement, et cela n'a pas chang√© de programme avec nous. <br><br>  Ici, il vaut probablement la peine d'expliquer un peu comment le son est jou√© en g√©n√©ral.  La carte son peut d√©finir un pointeur sur un morceau de m√©moire √† partir duquel vous souhaitez lire ou enregistrer √† une fr√©quence pr√©d√©termin√©e.  Une fois le tampon termin√©, une interruption est g√©n√©r√©e et l'ex√©cution se poursuit √† partir du tampon suivant.  Le fait est que ces tampons doivent √™tre remplis √† l'avance avant que le pr√©c√©dent ne soit jou√©.  Ce probl√®me, nous le rencontrerons plus loin sur le STM32F7. <br><br>  Ensuite, nous avons lou√© un serveur et d√©ploy√© Asterisk dessus.  Puisqu'il fallait beaucoup d√©boguer, mais ne voulait pas parler beaucoup dans le microphone, il fallait faire la lecture et l'enregistrement automatiques.  Pour ce faire, nous avons patch√© simple_pjsua afin qu'il soit possible de glisser des fichiers √† la place des p√©riph√©riques audio.  Dans PJSIP, cela se fait tout simplement, car ils ont le concept d'un port, qui peut √™tre un p√©riph√©rique ou un fichier.  Et ces ports peuvent √™tre connect√©s de mani√®re flexible √† d'autres ports.  Vous pouvez voir le code dans notre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©f√©rentiel</a> pjsip.  En cons√©quence, le sch√©ma √©tait le suivant.  J'ai cr√©√© deux comptes sur le serveur Asterisk - pour Linux et pour Embox.  Ensuite, la commande <i>simple_pjsua_imported</i> est ex√©cut√©e sur Embox, Embox est enregistr√©e sur le serveur, apr√®s quoi nous appelons Embox depuis Linux.  Au moment de la connexion, nous v√©rifions sur le serveur Asterisk que la connexion enti√®re est √©tablie, et apr√®s un certain temps, ils devraient entendre le son de Linux dans Embox, et sous Linux, nous enregistrons le fichier lu depuis Embox. <br><br>  Apr√®s avoir travaill√© sur QEMU, nous sommes pass√©s au portage sur STM32F7-Discovery.  Le premier probl√®me - ils ne sont pas entr√©s dans 1 Mo de ROM sans l'optimisation incluse du compilateur ¬´-Os¬ª en termes de taille d'image.  Par cons√©quent, inclus "-O".  De plus, le patch a d√©sactiv√© la prise en charge C ++, il n'est donc n√©cessaire que pour pjsua, et nous utilisons simple_pjsua. <br><br>  Apr√®s avoir <i>install√© simple_pjsua</i> , nous avons d√©cid√© qu'il y avait maintenant des chances de le lancer.  Mais d'abord, il fallait g√©rer l'enregistrement et la lecture de la voix.  Question - o√π √©crire?  Nous avons choisi une m√©moire externe - SDRAM (128 Mo).  Vous pouvez l'essayer vous-m√™me: <br><br>  Cr√©e un WAV st√©r√©o avec une fr√©quence de 16000 Hz et une dur√©e de 10 secondes: <br><br><pre> <code class="bash hljs">record -r 16000 -c 2 -d 10000 -m C0000000</code> </pre><br>  Nous perdons: <br><br><pre> <code class="bash hljs">play -m C0000000</code> </pre><br>  Il y avait deux probl√®mes.  Le premier avec un codec est WM8994, et il a un concept comme un slot, et ces slots sont 4. Donc, par d√©faut, si ce n'est pas configur√©, alors lors de la lecture audio, la lecture se produit dans les quatre slots.  Par cons√©quent, √† une fr√©quence de 16000 Hz, nous avons re√ßu 8000 Hz, mais pour 8000 Hz, la lecture n'a tout simplement pas fonctionn√©.  Lorsque seuls les emplacements 0 et 2 ont √©t√© s√©lectionn√©s, cela a fonctionn√© comme il se doit.  Un autre probl√®me √©tait l'interface audio dans le STM32Cube, dans laquelle la sortie audio fonctionne via SAI (Serial Audio Interface) de mani√®re synchrone avec l'entr√©e audio (n'a pas compris les d√©tails, mais il s'av√®re qu'ils partagent une horloge commune et que l'audio y est attach√© lors de l'initialisation de la sortie audio entr√©e).  Autrement dit, ils ne peuvent pas √™tre lanc√©s s√©par√©ment, ils ont donc fait ce qui suit - l'entr√©e audio et la sortie audio fonctionnent toujours (y compris les interruptions sont g√©n√©r√©es).  Mais lorsque rien n'est perdu dans le syst√®me, nous glissons simplement un tampon vide dans la sortie audio, et lorsque la lecture commence, nous commen√ßons honn√™tement √† le remplir. <br><br>  De plus, ils ont rencontr√© le fait que le son lors de l'enregistrement de la voix √©tait tr√®s silencieux.  Cela est d√ª au fait que les microphones MEMS du STM32F7-Discovery ne fonctionnent pas bien √† des fr√©quences inf√©rieures √† 16000 Hz.  Par cons√©quent, nous d√©finissons 16000 Hz, m√™me si 8000 Hz arrive.  Pour ce faire, la v√©rit√© √©tait d'ajouter une conversion logicielle d'une fr√©quence √† l'autre. <br><br>  Ensuite, j'ai d√ª augmenter la taille du tas, qui est situ√© dans la RAM.  Selon nos estimations, pjsip n√©cessitait environ 190 Ko, et nous n'en avions qu'environ 100 Ko.  Ici, je devais utiliser un peu de m√©moire externe - SDRAM (environ 128 Ko). <br><br>  Apr√®s toutes ces modifications, j'ai vu les premiers packages entre Linux et Embox, et j'ai entendu un son!  Mais le son √©tait terrible, pas du tout comme sur QEMU, rien ne pouvait √™tre discern√©.  Ensuite, nous avons r√©fl√©chi √† ce qui pourrait √™tre le probl√®me.  Le d√©bogage a montr√© qu'Embox n'a tout simplement pas le temps de remplir / d√©charger les tampons audio.  Pendant que pjsip traite une trame, 2 interruptions se sont produites avant la fin du traitement de la m√©moire tampon, ce qui est trop.  La premi√®re pens√©e pour acc√©l√©rer √©tait d'optimiser le compilateur, mais il √©tait d√©j√† inclus dans PJSIP.  Le second est un virgule flottante mat√©rielle, nous en avons parl√© dans l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> .  Mais comme la pratique l'a montr√©, le FPU n'a pas donn√© une augmentation significative de la vitesse.  L'√©tape suivante consistait √† hi√©rarchiser les threads.  Embox a diff√©rentes strat√©gies de planification, et j'en ai inclus une qui prend en charge les priorit√©s et d√©finit les flux audio sur la priorit√© la plus √©lev√©e.  Cela n'a pas aid√© non plus. <br><br>  L'id√©e suivante √©tait que nous travaillions avec de la m√©moire externe et qu'il serait bien d'y d√©placer des structures, auxquelles on acc√®de tr√®s souvent.  J'ai fait une analyse pr√©liminaire de quand et sous quel <i>simple_pjsua</i> alloue de la m√©moire.  Il s'est av√©r√© que sur 190 Ko, les 90 premiers Ko sont allou√©s aux besoins internes du PJSIP et qu'ils ne sont pas consult√©s tr√®s souvent.  Ensuite, pendant un appel entrant, la fonction pjsua_call_answer est appel√©e, dans laquelle les tampons pour travailler avec les trames entrantes et sortantes sont ensuite allou√©s.  C'√©tait environ 100 ko.  Et ici, nous avons agi comme suit.  Avant l'appel, les donn√©es sont plac√©es dans la m√©moire externe.  D√®s que l'appel - remplacez imm√©diatement le tas par un autre - en RAM.  Ainsi, toutes les donn√©es ¬´chaudes¬ª ont √©t√© transf√©r√©es vers une m√©moire plus rapide et plus pr√©visible. <br><br>  En cons√©quence, tout cela ensemble a permis de d√©marrer <i>simple_pjsua</i> et de passer un appel via son serveur.  Et puis via d'autres serveurs tels que sip.linphone.org. <br><br><h3>  Conclusions </h3><br>  En cons√©quence, il s'est av√©r√© ex√©cuter <i>simple_pjsua</i> avec une transmission vocale dans les deux sens via le serveur.  Le probl√®me avec la SDRAM de 128 Ko suppl√©mentaire peut √™tre r√©solu en utilisant un Cortex-M7 l√©g√®rement plus puissant (par exemple, STM32F769NI avec 512 Ko de RAM), mais en m√™me temps, nous n'avons toujours aucun espoir de tenir dans 256 Ko :) Nous serons heureux si quelqu'un est int√©ress√© , et encore mieux - essayez.  Toutes les sources, comme d'habitude, sont dans notre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©f√©rentiel</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr431134/">https://habr.com/ru/post/fr431134/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr431124/index.html">"La science des donn√©es, comme les math√©matiques et la physique, est une autre fa√ßon d'explorer le monde qui vous entoure."</a></li>
<li><a href="../fr431126/index.html">Pourquoi vous ne devriez pas √©conomiser sur les MP professionnels</a></li>
<li><a href="../fr431128/index.html">Piratage DDR3 SPD</a></li>
<li><a href="../fr431130/index.html">Semaine de la s√©curit√© 48: Hack Black Friday</a></li>
<li><a href="../fr431132/index.html">Reuters: la Russie augmentera les amendes des soci√©t√©s Internet √† 1% du chiffre d'affaires annuel</a></li>
<li><a href="../fr431136/index.html">Des t√©raoctets en apesanteur dans votre poche - est l'avenir ici? Exploration des fonctionnalit√©s d'HyperX SAVAGE EXO</a></li>
<li><a href="../fr431138/index.html">Biom√©trie avec la cl√© Rostelecom: comment le FSB a lanc√© pour la premi√®re fois la cryptographie russe dans les magasins d'applications</a></li>
<li><a href="../fr431140/index.html">Reportage de la m√©tapa Go in Production: vid√©o, photos, pr√©sentations</a></li>
<li><a href="../fr431142/index.html">Comment ex√©cuter SQL Profiler Trace la nuit, √† une heure pr√©cise?</a></li>
<li><a href="../fr431144/index.html">Far Fields mic (Mic array) - h√©ros discret dans une colonne intelligente</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>