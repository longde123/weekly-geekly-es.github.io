<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçù üïµüèº üÜï Verificamos la vulnerabilidad cerrada y obtenemos cuatro nuevos CVE üíè üò£ üë®üèº‚Äçüè≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Me pidieron que continuara la serie de art√≠culos sobre el cierre de vulnerabilidades y sobre c√≥mo se cierran (nuestro primer art√≠culo se puede leer aq...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Verificamos la vulnerabilidad cerrada y obtenemos cuatro nuevos CVE</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/acribia/blog/430408/">  Me pidieron que continuara la serie de art√≠culos sobre el cierre de vulnerabilidades y sobre c√≥mo se cierran (nuestro primer art√≠culo se puede leer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> ).  La √∫ltima vez descubrimos que incluso si el fabricante informa sobre el cierre de la vulnerabilidad, entonces en realidad todo puede no ser as√≠. <br><br><img src="https://habrastorage.org/webt/me/ds/nj/medsnjr0lbtdxy9vots_csy_bbg.jpeg"><br><a name="habracut"></a><br><h3>  Criterios de selecci√≥n: </h3><br>  Los criterios de selecci√≥n para las vulnerabilidades consideradas esta vez fueron los mismos (excepto que esta vez quer√≠a ver otros tipos de vulnerabilidades): <br><br><ul><li>  deber√≠a haber un exploit: queremos ver que antes de la actualizaci√≥n todo estaba mal <s>explotado</s> , y despu√©s de eso se volvi√≥ bueno; </li><li>  la vulnerabilidad deber√≠a ser cr√≠tica (idealmente RCE) y con una puntuaci√≥n alta; </li><li>  el producto debe ser de c√≥digo abierto; </li><li>  el producto no debe ser abandonado y usado activamente; </li><li>  la vulnerabilidad deber√≠a ser relativamente nueva; </li><li>  como siempre, lo principal es que nosotros mismos estar√≠amos interesados. </li></ul><br><h3>  Qu√© y c√≥mo eleg√≠: </h3><br>  Fui a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">vulners.com</a> y ped√≠ que mostrara todos los exploits con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">exploit-db.com</a> en las √∫ltimas semanas.  Esta vez en la categor√≠a web, Ihsan Sencan cre√≥ casi todos los exploits, pero debido al hecho de que con mayor frecuencia se relacionan con inyecciones sql en aplicaciones y complementos antiguos no compatibles, los elimin√©.  De los productos restantes, solo la herramienta de gesti√≥n de proyectos ProjeQtOr 7.2.5 con vulnerabilidad CVE-2018-18924 cay√≥ en la categor√≠a de "no abandonada y en desarrollo activo". <br>  Esta vulnerabilidad cumpli√≥ con todos los criterios de selecci√≥n: <br><br><ul><li>  hay una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">haza√±a</a> ; </li><li>  Vulnerabilidad RCE (aunque requiere que el usuario est√© autorizado); </li><li>  el producto es de c√≥digo abierto; </li><li> el producto no se abandon√≥, en 2018 hubo 28 lanzamientos y solo sourceforge.net hubo 702 descargas (y la mayor√≠a de las descargas de actualizaciones resuelven el problema de CVE, lo que probablemente indica que las personas vieron CVE y comenzaron a actualizar); </li><li>  CVE del 4 de noviembre, una haza√±a del 25 de octubre, esto satisface los requisitos de novedad; </li><li>  Mir√© el problema y su soluci√≥n, me interes√© (m√°s sobre eso m√°s adelante). </li></ul><br><h4>  Comprensi√≥n de la herramienta de gesti√≥n de proyectos ProjeQtOr </h4><br>  Leemos la descripci√≥n del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">exploit</a> y la descripci√≥n de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">CVE en nist.gov</a> , entendemos que la versi√≥n 7.2.5 solo es vulnerable para un usuario autorizado.  Y tambi√©n que puede cargar un archivo .shtml como imagen, aunque se mostrar√° el mensaje de error <i>"Este archivo no es una imagen v√°lida"</i> , pero el archivo se guardar√° en las im√°genes del servidor y se podr√° acceder a √©l mediante un enlace directo en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">host / files / images / image_name</a> . <br><br><img src="https://habrastorage.org/webt/8d/wu/0x/8dwu0x1uezs-x_ws7egw9szchue.png"><br><br>  El acceso a trav√©s de un enlace directo es bueno, pero aqu√≠ todav√≠a tiene que adivinar el nombre con el que se descargar√° el archivo.  Tenemos suerte, y no es aleatorio, sino que se genera a partir de la hora actual en el formato: a√±o, mes, d√≠a, horas, minutos, segundos.  El resultado es ese n√∫mero 20181114140320. A continuaci√≥n, la ID de usuario y luego el nombre del archivo original pasan por el gui√≥n bajo.  Hay bastantes inc√≥gnitas: <br><br><ul><li>  Zona horaria en el servidor </li><li>  si el reloj del servidor est√° inactivo; </li><li>  ID de usuario </li></ul><br>  Y nuevamente tenemos suerte: si carga una imagen v√°lida, todos estos par√°metros nos ser√°n informados.  No es dif√≠cil repasar varias opciones de enlaces (varios, ya que hay segundos, y es dif√≠cil acceder a ellos de inmediato). <br><br><img src="https://habrastorage.org/webt/zq/ce/lh/zqcelhvlhrk7496dafoiqart2nk.png"><br><br>  En general, obtener el nombre del archivo no es un problema.  Seguimos adelante.  Y pensamos, ¬øpor qu√© no simplemente subir un script php?  Estamos intentando descargarlo, aparece la misma ventana, pero el archivo no aparece en el directorio.  ¬°Es hora de mirar el c√≥digo! <br><br>  El script uploadImage.php es responsable de cargar la imagen al servidor en la versi√≥n 7.2.5. Estamos interesados ‚Äã‚Äãen las l√≠neas 100 a 117. <br><br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>)==<span class="hljs-string"><span class="hljs-string">'php'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>)==<span class="hljs-string"><span class="hljs-string">'phtm'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(@!getimagesize($uploadedFile[<span class="hljs-string"><span class="hljs-string">'tmp_name'</span></span>])) { $error=i18n(<span class="hljs-string"><span class="hljs-string">'errorNotAnImage'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { traceHack(<span class="hljs-string"><span class="hljs-string">"Try to upload php file as image in CKEditor"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( ! move_uploaded_file($uploadedFile[<span class="hljs-string"><span class="hljs-string">'tmp_name'</span></span>], $uploadfile)) { $error = htmlGetErrorMessage(i18n(<span class="hljs-string"><span class="hljs-string">'errorUploadFile'</span></span>,<span class="hljs-string"><span class="hljs-string">'hacking ?'</span></span>)); errorLog(i18n(<span class="hljs-string"><span class="hljs-string">'errorUploadFile'</span></span>,<span class="hljs-string"><span class="hljs-string">'hacking ?'</span></span>)); } } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$error) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(@!getimagesize($uploadfile)) { $error=i18n(<span class="hljs-string"><span class="hljs-string">'errorNotAnImage'</span></span>); } }</code> </pre> <br>  La l√≠nea 100 es responsable de verificar la extensi√≥n del archivo: si es php o phtm, el archivo se descarta y no se guarda.  Por lo tanto, los archivos php no aparecen en el directorio "files / images /".  La l√≠nea 115 crea el error que vemos, pero no hace nada con el archivo. <br><br>  Bueno, no dejemos el exploit y carguemos el archivo con la extensi√≥n .shtml.  Aqu√≠ vale la pena hacer una peque√±a digresi√≥n y decir qu√© es .shtml y con qu√© se come. <br><br><h4>  SHTML y SSI </h4><br>  Definici√≥n de Wikipedia: <br><br>  SSI (Server Side incluye - inclusi√≥n en el lado del servidor) - un lenguaje simple para el "ensamblaje" din√°mico de p√°ginas web en el servidor desde los componentes individuales y la entrega del documento HTML recibido al cliente.  Implementado en el servidor web Apache usando el m√≥dulo mod_include.  La funci√≥n incluida en la configuraci√≥n predeterminada del servidor web le permite incluir archivos HTML, por lo tanto, para usar las instrucciones, el archivo debe terminar con la extensi√≥n .shtml, .stm o .shtm. <br><br>  En tus propias palabras: <br><br>  SHTML es HTML que puede ejecutar conjuntos de instrucciones del lado del servidor.  De lo √∫til, hay una funci√≥n ejecutiva que ejecuta comandos arbitrarios en el servidor (s√≠, podemos descargar el archivo usando c√≥digo HTML y ejecutarlo). <br><br>  Aqu√≠ hay un c√≥digo de muestra para ejecutar c√≥digo arbitrario: <br><br><pre> <code class="php hljs">&lt;!--<span class="hljs-comment"><span class="hljs-comment">#exec cmd=‚Äùls‚Äù --&gt;</span></span></code> </pre> <br>  La buena noticia es que esta funcionalidad no est√° habilitada de forma predeterminada en el servidor Apache2, y para habilitarla debes bailar con una pandereta.  En un par de horas de elegir la configuraci√≥n, pude hacer que el retorno de las variables de entorno funcionara, pero no el comando.  Aqu√≠ est√° mi c√≥digo SSI: <br><br><pre> <code class="php hljs">&lt;html&gt; &lt;head&gt; &lt;title&gt;thegeekstuff.com&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;p&gt; Today is &lt;!--<span class="hljs-comment"><span class="hljs-comment">#echo var="DATE_LOCAL" --&gt; &lt;!--#exec cmd="ls" --&gt; &lt;/p&gt; &lt;/body&gt; &lt;/html&gt;  : Today is Wednesday, 14-Nov-2018 17:29:14 MSK [an error occurred while processing this directive]</span></span></code> </pre><br>  Si alguien te dice qu√© escribir en la configuraci√≥n para que funcione correctamente, me encantar√≠a leerlo. <br><br><h4>  Explotar vulnerabilidad </h4><br>  Si las estrellas convergen, puede descargar el archivo shtml y ejecutar comandos arbitrarios (o, como yo, ver la hora en el servidor). <br><br><h4>  Viendo el parche </h4><br>  La pr√≥xima versi√≥n es 7.2.6, pero no hay cambios con respecto a la vulnerabilidad que nos interesa (nist.gov nuevamente enga√±ado). <br><br>  Observamos la versi√≥n 7.2.7 y parece que todo est√° arreglado (los propios desarrolladores dicen que todo est√° arreglado solo en esta versi√≥n).  Hay dos cambios clave: <br><br>  1. Entre las extensiones prohibidas, se agreg√≥ "shtm" (si los primeros 4 caracteres son tales, shtml tambi√©n se incluye aqu√≠): <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>)==<span class="hljs-string"><span class="hljs-string">'php'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>)==<span class="hljs-string"><span class="hljs-string">'phtm'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>)==<span class="hljs-string"><span class="hljs-string">'shtm'</span></span>) {</code> </pre> <br><br>  2. Los archivos que no son im√°genes ahora se eliminan: <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(@!getimagesize($uploadfile)) { $error=i18n(<span class="hljs-string"><span class="hljs-string">'errorNotAnImage'</span></span>); kill($uploadfile); }</code> </pre> <br>  Parece que puede divergir, porque las im√°genes que no se borran, y shtml ni siquiera est√° tratando de persistir.  Pero no siempre me gust√≥ que trataran de resolver un problema con las listas negras.  Por ejemplo, en algunos pa√≠ses, las compa√±√≠as proh√≠ben las redes sociales.  Esto lleva al hecho de que los usuarios comienzan a usar los "espejos" de las redes sociales, donde se roban sus nombres de usuario y contrase√±as.  Sus contrase√±as coinciden con las contrase√±as corporativas, pero puede haber problemas mucho mayores que un empleado hojeando un instagram con una taza de caf√©. <br><br>  En la programaci√≥n web y su seguridad, las listas negras tambi√©n son malas. <br><br><h4>  Omitir la lista negra de ProjeQtOr </h4><br>  Bueno, todo es simple.  Primero, veamos qu√© archivos puede interpretar Apache2 + PHP en la configuraci√≥n predeterminada (todo se instal√≥ en ubuntu 16.04 con un repositorio actualizado).  La directiva "FilesMatch" es responsable de la capacidad de interpretar archivos.  Hacemos una b√∫squeda en √©l con el comando "grep -r" &lt;FilesMatch "/ etc / apache2" y aqu√≠ est√° el resultado: <br><br><pre> <code class="php hljs">/etc/apache2/mods-available/php7<span class="hljs-number"><span class="hljs-number">.0</span></span>.conf:&lt;FilesMatch <span class="hljs-string"><span class="hljs-string">".+\.ph(p[3457]?|t|tml)$"</span></span>&gt; /etc/apache2/mods-available/php7<span class="hljs-number"><span class="hljs-number">.0</span></span>.conf:&lt;FilesMatch <span class="hljs-string"><span class="hljs-string">".+\.phps$"</span></span>&gt; /etc/apache2/mods-available/php7<span class="hljs-number"><span class="hljs-number">.0</span></span>.conf:&lt;FilesMatch <span class="hljs-string"><span class="hljs-string">"^\.ph(p[3457]?|t|tml|ps)$"</span></span>&gt; /etc/apache2/sites-available/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-ssl.conf: &lt;FilesMatch <span class="hljs-string"><span class="hljs-string">"\.(cgi|shtml|phtml|php)$"</span></span>&gt; /etc/apache2/apache2.conf:&lt;FilesMatch <span class="hljs-string"><span class="hljs-string">"^\.ht"</span></span>&gt;</code> </pre> <br>  En la configuraci√≥n default-ssl.conf, todas las extensiones simplemente se enumeran en su totalidad; estas son: cgi, shtml, phtml, php.  Por desgracia, todo excepto cgi se filtra en ProjeQtOr. <br><br>  La configuraci√≥n php7.0.conf es mucho m√°s interesante, en ella las extensiones son establecidas por la expresi√≥n regular.  Obtenemos: <br><table><tbody><tr><th>  Extensi√≥n </th><th>  Lo que se filtra </th></tr><tr><td>  php </td><td>  substr ($ ext, 0.3) == 'php' </td></tr><tr><td>  php3 </td><td>  substr ($ ext, 0.3) == 'php' </td></tr><tr><td>  php4 </td><td>  substr ($ ext, 0.3) == 'php' </td></tr><tr><td>  php5 </td><td>  substr ($ ext, 0.3) == 'php' </td></tr><tr><td>  php7 </td><td>  substr ($ ext, 0.3) == 'php' </td></tr><tr><td>  pht </td><td>  Nada </td></tr><tr><td>  phtml3 </td><td>  substr ($ ext, 0.4) == 'phtm' </td></tr></tbody></table><br>  Genial, se encuentra una extensi√≥n de archivo que no se filtra.  Verificamos que realmente se interprete. <br><br>  Cree un archivo test.pht con los siguientes contenidos: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> phpinfo();</code> </pre> <br>  Vamos a este archivo en el navegador y vemos informaci√≥n sobre el php instalado.  Sorprendentemente, se omiti√≥ la lista negra, mientras que para configuraciones no predeterminadas, por alguna raz√≥n, se podr√≠an permitir otras extensiones para la interpretaci√≥n. <br><br>  Cargamos nuestro archivo de prueba en la herramienta de gesti√≥n de proyectos ProjeQtOr.  Por supuesto, recibimos un error, porque esto no es una imagen (en la versi√≥n anterior a 7.2.7, ya tenemos ejecuci√≥n de c√≥digo en el servidor, porque cambiar phpinfo para ejecutar comandos no es dif√≠cil).  En la versi√≥n 7.2.7, el archivo se elimina y el c√≥digo no se ejecuta. <br><br>  Pero no estamos molestos y pasamos por alto el cheque de la imagen. <br><br><h4>  Imagen PHP </h4><br>  La funci√≥n getimagesize, que simplemente mira el encabezado del archivo transferido, verifica si el archivo descargado es una imagen en la herramienta de gesti√≥n de proyectos ProjeQtOr. <br><br>  Aprovechando el hecho de que puede haber basura en el archivo php, y la interpretaci√≥n del c√≥digo php comienza solo con los caracteres "&lt;? Php", escribimos un peque√±o c√≥digo que primero escribe la imagen y luego el c√≥digo php que necesitamos.  Como imagen, enviaremos una captura de pantalla de la ventana de error.  3 l√≠neas de c√≥digo python y listo: <br><br><pre> <code class="python hljs">data = open (<span class="hljs-string"><span class="hljs-string">'test.png'</span></span>,<span class="hljs-string"><span class="hljs-string">'rb'</span></span>).read() data += open (<span class="hljs-string"><span class="hljs-string">'test.pht'</span></span>,<span class="hljs-string"><span class="hljs-string">'rb'</span></span>).read() open (<span class="hljs-string"><span class="hljs-string">'new_pht_png.pht'</span></span>,<span class="hljs-string"><span class="hljs-string">'wb'</span></span>).write(data)</code> </pre> <br>  Probablemente, podr√≠a escribir un encabezado de imagen v√°lido al comienzo del archivo, pero es m√°s f√°cil, y a√∫n m√°s, la imagen se muestra en cualquier visor. <br><br>  Subimos esta creaci√≥n al servidor y, he aqu√≠, se carga (y se muestra en el visor como una imagen), y tambi√©n es bueno que se nos muestre el nombre completo con el que se descarg√≥ este archivo. <br><br><img src="https://habrastorage.org/webt/xi/px/mh/xipxmhyuzvcaqbxl28pcrrezd1q.png"><br><br>  Vamos al archivo descargado <a href="">localhost / files / images / 20181114171730_1_new_pht_png.pht</a> y vemos la imagen descargada como texto, y la salida de phpinfo debajo de ella.  Est√° claro que reemplazar phpinfo con un simple shell web no es dif√≠cil.  Por ejemplo, esto: &lt;? Sistema Php ($ _ GET ['cmd']); <br><br><img src="https://habrastorage.org/webt/m-/kv/ad/m-kvadznv4ev99yge_zwwsgzf6m.png"><br><br>  Una vez que comenz√≥ a elegir descargas de archivos, debe finalizar el trabajo y ver d√≥nde m√°s hay una descarga de archivos con o sin listas negras. <br><br><h4>  Otro archivo cargado </h4><br>  Lo veremos en la √∫ltima versi√≥n disponible.  Suponiendo que use la misma funci√≥n para cargar archivos que antes, es decir  move_uploaded_file, lo buscamos en el directorio del proyecto "grep -r" move_uploaded_file "./".  Obtenemos los siguientes 5 archivos: <br><br>  ./tool/uploadImage.php <br>  ./tool/saveDocumentVersion.php <br>  ./tool/uploadPlugin.php <br>  ./tool/import.php <br>  ./tool/saveAttachment.php <br><br>  Archivo uploadImage.php - ya buscado. <br>  Archivo saveDocumentVersion.php: descarga versiones de documentos (como su nombre lo indica).  Estamos tratando de descargar un documento y mirarlo (para empezar, siempre cargaremos una imagen).  Despu√©s de la descarga, vemos que la extensi√≥n .1 se agrega al archivo.  Observamos en el c√≥digo c√≥mo se obtiene el nombre (esto se hace en la l√≠nea 229): <br><br><pre> <code class="php hljs">$uploadfile = $dv-&gt;getUploadFileName();</code> </pre> <br>  La funci√≥n getUploadFileName se declara en el archivo DocumentVersionMain.php.  All√≠, en la l√≠nea 227, vemos que "." Se agrega al nombre devuelto.  e identificaci√≥n del documento.  No podemos evitar incluso el punto agregado: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $uploaddir . $paramPathSeparator . $fileName . <span class="hljs-string"><span class="hljs-string">'.'</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;id;</code> </pre> <br>  El archivo uploadPlugin.php es accesible solo para los administradores y el hecho de que el complemento pueda tener un c√≥digo incorrecto es muy l√≥gico y dif√≠cil de eliminar sin tener que ingresar la validaci√≥n del complemento (como hace el CMS popular).  Por supuesto, cuando intentas descargar algo all√≠, se carga con √©xito y luego se ejecuta. <br><br>  El archivo import.php tambi√©n est√° disponible solo para administradores.  Al descargar un archivo, se nos dice que debe ser un archivo csv o un archivo xlsx.  Por supuesto, tratamos de cargar el archivo php y vemos un error: <br><br><h4>  ERROR: el tipo de archivo proporcionado y el formato de archivo seleccionado no coinciden </h4><br>  Importaci√≥n cancelada <br><br>  El problema es que, como en el error original de CVE, el archivo no se elimina, pero permanece disponible en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">localhost / files / attach / import / test.php</a> . <br><br>  El archivo saveAttachment se usa al cargar cualquier archivo adjunto (por ejemplo, al cargar su propia imagen).  El script PHP no se arrastra all√≠, ya que hay una protecci√≥n de la forma: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>)==<span class="hljs-string"><span class="hljs-string">'php'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>)==<span class="hljs-string"><span class="hljs-string">'phtm'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>)==<span class="hljs-string"><span class="hljs-string">'shtm'</span></span>) { $attachment‚ÜífileName.=<span class="hljs-string"><span class="hljs-string">".projeqtor"</span></span>;</code> </pre> <br>  resulta que a los archivos de extensi√≥n php *, phtm *, shtm * se agrega la extensi√≥n ".projeqtor", es decir, obviamente nuestro archivo pht se arrastrar√° all√≠ (incluso sin rastrear las im√°genes).  Lo intentamos y obtenemos todo en la direcci√≥n <a href="">localhost / files / attach / attach_1 / test.pht</a> . <br><br>  Resultado total de cinco ubicaciones de descarga de archivos encontradas r√°pidamente: <br><br><ul><li>  logr√≥ cargar php o pht script 4 veces; </li><li>  la validaci√≥n de la lista negra es en dos; </li><li>  la validaci√≥n de la lista blanca no est√° en ning√∫n lado; </li><li>  una vez no se pudo descargar el archivo (no se pudo descargar, pero no se pudo ejecutar), porque  la expansi√≥n estaba cambiando </li></ul><br><h3>  Conclusiones sobre la herramienta de gesti√≥n de proyectos ProjeQtOr y CVE-2018-18924 </h3><br><br><ul><li>  la vulnerabilidad reportada ha sido virtualmente eliminada; </li><li>  hay otras vulnerabilidades en el c√≥digo (informadas a los desarrolladores, e incluso prometieron listas blancas de extensiones); </li><li>  la configuraci√≥n adecuada del servidor Apache2 podr√≠a salvarnos de todo (limite los formatos ejecutables solo a lo necesario, proh√≠ba la ejecuci√≥n de scripts en las carpetas de usuario); </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">nist.gov</a> no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">contiene</a> la √∫ltima versi√≥n vulnerable. </li></ul><br><h3>  Nota de la se√±ora </h3><br><ul><li>  rechazar listas negras siempre que sea posible (no s√© d√≥nde es imposible); </li><li>  tenga cuidado y est√© atento al procesar archivos descargados (es mejor que est√© en un solo lugar y no se extienda por 5); </li><li>  un servidor web configurado correctamente evita muchos problemas en el c√≥digo del proyecto (es importante escribir c√≥digo y configurar bien el servidor). </li></ul><br><h3>  Respuesta detallada de desarrolladores </h3><br>  La primera respuesta de los desarrolladores fue algo as√≠ como "arreglamos todo, as√≠ que vea el c√≥digo corregido".  Tuve que pintar con gran detalle d√≥nde est√°n algunos problemas y c√≥mo se pueden explotar. <br><br>  Luego recibi√≥ una respuesta detallada: ‚Äús√≠, hay problemas y se solucionar√°n en la versi√≥n 7.3.0.  Tambi√©n se agregar√°n listas blancas para im√°genes para xlslx y csv ".  Tambi√©n escribieron que tienen una recomendaci√≥n para agregar los directorios de "archivos adjuntos" y "documentos" fuera del acceso web en las instrucciones de instalaci√≥n. <br><br>  Los desarrolladores me permitieron registrar CVE y escribir un art√≠culo despu√©s de la actualizaci√≥n (que sali√≥ y est√° disponible para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">descargar</a> ). <br><br><h3>  Conclusi√≥n </h3><br>  Como escrib√≠ al principio, muchas personas han descargado la actualizaci√≥n decidiendo CVE (m√°s de 500 descargas), y es genial que las personas actualicen su software vulnerable, pero es triste que el software siga siendo vulnerable. <br><br>  Como resultado, se nos asignaron cuatro CVE a m√≠ y a nuestra empresa: CVE-2018-19307, CVE-2018-19308, CVE-2018-19309, CVE-2018-19310. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es430408/">https://habr.com/ru/post/es430408/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es430398/index.html">C√≥mo entender que no eres bienvenido o discutir m√©todos para expulsar a los trabajadores de la empresa</a></li>
<li><a href="../es430400/index.html">Experiencia usando un h√≠brido de teclado y mouse en programaci√≥n</a></li>
<li><a href="../es430402/index.html">¬øQu√© es silencioso developer.android.com sobre RecyclerView?</a></li>
<li><a href="../es430404/index.html">Recopilamos datos sobre el comportamiento del cliente en el sitio.</a></li>
<li><a href="../es430406/index.html">C ++ 20 y M√≥dulos, Redes, Corutinas, Rangos, Gr√°ficos. Resultados de la reuni√≥n en San Diego</a></li>
<li><a href="../es430410/index.html">"Siempre tendr√° que desarrollarse": una entrevista con Evgeny Kuvshinov (ManyChat) sobre el desarrollo en una startup</a></li>
<li><a href="../es430412/index.html">L√≥gica difusa contra PID. Cruzamos el erizo y la serpiente. Motor de aeronave y algoritmos de control de NPP</a></li>
<li><a href="../es430414/index.html">Azure DevOps para Commodore 64?</a></li>
<li><a href="../es430418/index.html">Experiencia personal usando sensores de proximidad en desarrollo</a></li>
<li><a href="../es430420/index.html">Conferencia "Contenido" - ahora con soporte para hyper-threading</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>