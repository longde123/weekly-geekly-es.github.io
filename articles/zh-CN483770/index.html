<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎂 💃🏼 🎦 迈向SSL自动化 🌋 🔅 🤗</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="我们经常必须使用SSL证书。 让我们回想一下创建和安装证书的过程（大多数情况下通常是这样）。 


- 查找提供商（可以在其上购买SSL的网站）。 
- 产生企业社会责任。 
- 发送给您的提供商。 
- 验证域所有权。 
- 获取证书。 
- 将证书转换为所需形式（可选）。 例如，从pem到PKC...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>迈向SSL自动化</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483770/"><p> 我们经常必须使用SSL证书。 让我们回想一下创建和安装证书的过程（大多数情况下通常是这样）。 </p><br><ul><li> 查找提供商（可以在其上购买SSL的网站）。 </li><li> 产生企业社会责任。 </li><li> 发送给您的提供商。 </li><li> 验证域所有权。 </li><li> 获取证书。 </li><li> 将证书转换为所需形式（可选）。 例如，从pem到PKCS＃12。 </li><li> 在Web服务器上安装证书。 </li></ul><br><p>相对较快，不复杂也不容易理解。 如果我们最多有十二个项目，则此选项非常合适。 如果还有更多，并且它们至少具有三个环境？ 经典开发-演出-生产。 在这种情况下，您应该考虑使此过程自动化。 我建议您深入研究该问题，并找到一种解决方案，以最大程度地减少将来创建和维护证书所需的时间。 本文将提供对该问题的分析以及重复的小指南。 </p><br><p> 我会提前预约：我们公司的主要专长是.net，因此还有IIS和其他Windows。 因此，ACME客户端及其所有操作也将根据使用窗口进行描述。 </p><br><h2> 与谁相关的一些源数据 </h2><a name="habracut"></a><br><p> 作者K代表的公司K。 网址（例如）：company.tld </p><br><p>  X项目是我们的项目之一，我得出的结论是，同样，在使用证书时，我们需要争取最大的时间节省。 该项目具有四个环境：开发，测试，暂存和生产。 开发和测试在我们这边，暂存和生产在客户端。 </p><br><p> 该项目的一个特点是它具有大量可用作子域的模块。 </p><br><p> 也就是说，我们有以下图片： </p><br><div class="scrollable-table"><table><thead><tr><th> 开发人员 </th><th> 测验 </th><th> 分期 </th><th> 生产量 </th></tr></thead><tbody><tr><td>  projectX.dev.company.tld </td><td>  projectX.test.company.tld </td><td>  staging.projectX.tld </td><td>  projectX.tld </td></tr><tr><td>  module1.projectX.dev.company.tld </td><td>  module1.projectX.test.company.tld </td><td>  module1.staging.projectX.tld </td><td>  module1.projectX.tld </td></tr><tr><td>  module2.projectX.dev.company.tld </td><td>  module2.projectX.test.company.tld </td><td>  module2.staging.projectX.tld </td><td>  module2.projectX.tld </td></tr><tr><td>  ... </td><td>  ... </td><td>  ... </td><td>  ... </td></tr><tr><td>  moduleN.projectX.dev.company.tld </td><td>  moduleN.projectX.test.company.tld </td><td>  moduleN.staging.projectX.tld </td><td>  moduleN.projectX.tld </td></tr></tbody></table></div><br><p> 对于生产，将使用购买的通配符证书，没有问题。 但它仅涵盖子域的第一级。 因此，如果存在用于* .projectX.tld的证书-那么它将对staging.projectX.tld起作用，但对于module1.staging.projectX.tld则没有。 但我不想单独购买一个。 </p><br><p> 这仅仅是一个公司的一个项目的一个例子。 当然，该项目不是一个。 </p><cut></cut><br><p> 每个人解决此问题的常见原因如下： </p><br><ul><li> 最近， <a href="https://habr.com/ru/company/globalsign/news/t/464159/">谷歌提出减少SSL证书的最大有效期</a> 。 与所有的后果。 </li><li> 为项目和整个公司的内部需求促进发布和维护SSL的过程。 </li><li> 证书记录的集中存储，部分解决了使用DNS进行域验证和后续自动更新的问题，还解决了客户端信任问题。 不过，与第三方资源相比，CNAME在合作伙伴/承包商公司的服务器上引起了更多信任。 </li><li> 好吧，最后，在这种情况下，短语“要胜于没有”非常合适。 </li></ul><br><h2 id="vybor-provaydera-ssl-i-podgotovitelnye-shagi"> 选择SSL提供程序和准备步骤 </h2><br><p> 在免费SSL证书的可用选项中，考虑了cloudflare和letencrypt。  DNS（和其他一些项目）的DNS托管在cloudflare上，但我不喜欢使用其证书。 因此，决定使用letencrypt。 <br> 要创建通配符SSL证书，您必须确认域的所有权。 此过程涉及创建一些DNS记录（TXT或CNAME），并在颁发证书时进行后续验证。  Linux有一个<a href="https://certbot.eff.org/" rel="nofollow">称为certbot</a>的实用程序，它使您可以部分（或完全对于某些DNS提供商）自动化此过程。 对于Windows，在<a href="https://letsencrypt.org/docs/client-options/" rel="nofollow">找到并测试过的</a> ACME客户端选项中，我选择了<a href="https://pkisharp.github.io/win-acme/" rel="nofollow">WinACME</a> 。 </p><br><p> 并创建了该域的记录，我们继续创建证书： </p><br><p><img src="https://habrastorage.org/webt/xb/8a/ay/xb8aayklmjtj7l5mda_oq7o_wvy.png" alt="图片"></p><br><p> 我们对最后一个结论感兴趣，即，用于颁发通配符证书的验证域所有权的可用选项： </p><br><ol><li> 手动创建DNS记录（不支持自动更新） </li><li> 使用acme-dns服务器创建DNS记录（可在<a href="https://habr.com/ru/post/350202/">此处</a>找到更多详细信息。 </li><li> 使用您自己的脚本（certbot的cloudflare插件模拟）创建DNS记录。 </li></ol><br><p> 乍一看，第三点很合适，但是DNS提供程序是否不支持此功能？ 我们需要一个一般情况。 通常情况是CNAME记录，所有记录都支持它们。 因此，我们在第2点停止，然后配置ACME-DNS服务器。 </p><br><h2 id="nastroyka-acme-dns-servera-i-process-vypuska-sertifikata"> 配置ACME-DNS服务器和证书颁发过程 </h2><br><p> 例如，我创建了2nd.pp.ua域，将来我将使用它。 </p><br><p> 服务器正确运行的<a href="https://github.com/joohoi/acme-dns" rel="nofollow">前提条件</a>是为其域创建NS和A记录。 我遇到的第一个令人不快的时刻-cloudflare（至少在免费使用模式下）不允许您同时为同一主机创建NS和A记录。 并不是说这是一个问题，但是在绑定中是可能的。 支持人员答复说，他们的面板不允许这样做。 没关系，创建两个条目： </p><br><pre><code class="plaintext hljs">acmens.2nd.pp.ua. IN A 35.237.128.147 acme.2nd.pp.ua. IN NS acmens.2nd.pp.ua.</code> </pre> <br><p> 在这个阶段， <code>acmens.2nd.pp.ua</code>主机应该可以解析。 </p><br><pre> <code class="plaintext hljs">$ ping acmens.2nd.pp.ua PING acmens.2nd.pp.ua (35.237.128.147) 56(84) bytes of data</code> </pre> <br><p> 但是<code>acme.2nd.pp.ua</code>将无法解析，因为为其提供服务的DNS服务器尚未运行。 </p><br><p> 创建记录后，去配置并运行ACME-DNS服务器。 我将它放置在docker容器中的ubuntu服务器上，但是您可以在golang所在的任何地方运行它。  Windows也可以，但是我仍然更喜欢Linux服务器。 </p><br><p> 创建必要的目录和文件： </p><br><pre> <code class="bash hljs">$ mkdir config $ mkdir data $ touch config/config.cfg</code> </pre> <br><p> 善加利用 <del>  vim </del> 您最喜欢的文本编辑器，然后将示例<a href="https://github.com/joohoi/acme-dns" rel="nofollow">配置</a>插入config.cfg。 </p><br><p> 要成功，只需调整常规和api部分： </p><br><pre> <code class="plaintext hljs">[general] listen = "0.0.0.0:53" protocol = "both" domain = "acme.2nd.pp.ua" nsname = "acmens.2nd.pp.ua" nsadmin = "admin.2nd.pp.ua" records = "acme.2nd.pp.ua. A 35.237.128.147", "acme.2nd.pp.ua. NS acmens.2nd.pp.ua.", ] ... [api] ... tls = "letsencrypt" …</code> </pre> <br><p> 另外，如果需要，请在服务的主目录中创建一个docker-compose文件： </p><br><pre> <code class="plaintext hljs">version: '3.7' services: acmedns: image: joohoi/acme-dns:latest ports: - "443:443" - "53:53" - "53:53/udp" - "80:80" volumes: - ./config:/etc/acme-dns:ro - ./data:/var/lib/acme-dns</code> </pre> <br><p> 做完了 你可以跑步。 </p><br><pre> <code class="bash hljs">$ docker-compose up -d</code> </pre> <br><p> 在此阶段， <code>acme.2nd.pp.ua</code>主机应开始<code>acme.2nd.pp.ua</code> ，并且404应该出现在<code>https://acme.2nd.pp.ua</code> </p><br><pre> <code class="bash hljs">$ ping acme.2nd.pp.ua PING acme.2nd.pp.ua (35.237.128.147) 56(84) bytes of data. $ curl https://acme.2nd.pp.ua 404 page not found</code> </pre> <br><p> 如果这没有出现-幸运的是， <code>docker logs -f &lt;container_name&gt;</code>帮助了，日志非常可读。 </p><br><p> 我们可以开始创建证书了。 以管理员身份打开powershell并运行winacme。 我们对选举感兴趣： </p><br><ul><li>  M：创建新证书（完整选项） </li><li>  2：手动输入 </li><li>  2：[dns-01]使用acme-dns（ <a href="https://github.com/joohoi/acme-dns" rel="nofollow">https://github.com/joohoi/acme-dns</a> ）创建验证记录 </li><li> 当被问及到ACME-DNS服务器的链接时，我们将输入创建的服务器（https）的URL作为响应。  acme-dns服务器的URL： <a href="https://acme.2nd.pp.ua/" rel="nofollow">https</a> : <a href="https://acme.2nd.pp.ua/" rel="nofollow">//acme.2nd.pp.ua</a> </li></ul><br><p> 在服务器中，客户端发出必须添加到现有DNS服务器的条目（一次性过程）： </p><br><pre> <code class="plaintext hljs">[INFO] Creating new acme-dns registration for domain 1nd.pp.ua Domain: 1nd.pp.ua Record: _acme-challenge.1nd.pp.ua Type: CNAME Content: c82a88a5-499f-464f-96e4-be7f606a3b47.acme.2nd.pp.ua. Note: Some DNS control panels add the final dot automatically. Only one is required.</code> </pre> <br><p><img src="https://habrastorage.org/webt/v9/fa/2g/v9fa2gnoq7c5cfjqapys5ta0agg.png" alt="图片"></p><br><p> 我们创建必要的记录，并确保已正确创建它： </p><br><p><img src="https://habrastorage.org/webt/lj/pa/qn/ljpaqnz56dj9kynsb-7cb44eqvc.png" alt="图片"></p><br><pre> <code class="plaintext hljs">$ dig CNAME _acme-challenge.1nd.pp.ua +short c82a88a5-499f-464f-96e4-be7f606a3b47.acme.2nd.pp.ua.</code> </pre> <br><p> 我们确认已在winacme中创建了必要的条目，然后继续创建证书的过程： </p><br><p><img src="https://habrastorage.org/webt/6y/zk/2y/6yzk2y9n4-mcboxlhhwlqngem28.png" alt="图片"></p><br><p>  <a href="https://github.com/joohoi/acme-dns-certbot-joohoi" rel="nofollow">这里</a>介绍<a href="https://github.com/joohoi/acme-dns-certbot-joohoi" rel="nofollow">了</a>如何将certbot用作客户端。 </p><br><p> 这样就完成了创建证书的过程，您可以将其安装在Web服务器上并使用它。 如果在创建证书时还创建了调度程序中的任务，则将来证书更新过程将自动进行。 </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN483770/">https://habr.com/ru/post/zh-CN483770/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN483756/index.html">我们发出HTTP请求，正常降级（而不是一个空白）</a></li>
<li><a href="../zh-CN483758/index.html">2020年可与十大移动应用开发公司合作</a></li>
<li><a href="../zh-CN483762/index.html">GitLab 12.6发布了项目安全等级和发布材料</a></li>
<li><a href="../zh-CN483766/index.html">法院是社交黑客的工具，还是关于WHOIS数据库中信息可靠性的一点建议</a></li>
<li><a href="../zh-CN483768/index.html">PostgreSQL-5中的MVCC。 页内真空和HOT更新</a></li>
<li><a href="../zh-CN483774/index.html">2020年1月IT人力资源专业人员的事件摘要</a></li>
<li><a href="../zh-CN483776/index.html">5分钟内介绍语义差分法</a></li>
<li><a href="../zh-CN483778/index.html">安全周03：负责任的错误报告原则</a></li>
<li><a href="../zh-CN483784/index.html">如何用非租户应用程序制作多租户应用程序</a></li>
<li><a href="../zh-CN483786/index.html">混合排序</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>