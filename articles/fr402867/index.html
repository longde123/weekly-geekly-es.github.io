<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèæ‚Äç‚öïÔ∏è ‚ö†Ô∏è üï∫üèø Bo√Æte noire du fumeur üíç üêÉ üë©‚Äçüëß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Beaucoup de gens fument trop, surtout quand ils sont d√©pendants de quelque chose et ne remarquent pas comment ils fument une cigarette apr√®s l'autre. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bo√Æte noire du fumeur</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/402867/">  Beaucoup de gens fument trop, surtout quand ils sont d√©pendants de quelque chose et ne remarquent pas comment ils fument une cigarette apr√®s l'autre.  La bo√Æte noire du fumeur (CJK) ne vous permet pas de prendre la prochaine cigarette avant un certain laps de temps.  Dans cet article, je ferai attention √† certains d√©tails qui peuvent √™tre utiles pour d'autres d√©veloppements, en particulier le contr√¥leur LC Teensy pas si c√©l√®bre (famille Arduino). <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/mRDSiEAsiAI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><a name="habracut"></a><br>  <b>La m√©canique</b> <br><br>  Les d√©tails ChYAK sont imprim√©s sur une imprimante 3D et apr√®s assemblage des parties inf√©rieure, centrale et sup√©rieure sont coll√©es ensemble. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/353/eb5/369/353eb5369a304723be064ac6e07722e9.jpg"></div><br><br>  Le m√©canisme de verrouillage est rendu √©lectrom√©canique, tandis que les fonctions de verrouillage de base sont r√©alis√©es de mani√®re purement m√©canique, ce qui rend difficile le crack du NJC en manipulant les espaces et en retirant les batteries. <br><br>  Le syst√®me de verrouillage se compose d'une cr√©maill√®re √† dents et d'un cliquet bistable, qui permet au plateau de se d√©placer uniquement dans le sens de la fermeture.  Lorsqu'il atteint une p√©riode de temps pr√©d√©termin√©e, le servo effectue un seul mouvement de va-et-vient et pousse le cliquet, qui est r√©gl√© dans le deuxi√®me √©tat stable ¬´ouvert¬ª.  Le CFC reste ouvert jusqu'√† ce que l'utilisateur tire m√©caniquement le plateau.  Lorsqu'il est d√©ploy√©, le plateau pousse le cliquet et le remet √† l'√©tat arm√©. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a0b/9a1/c0e/a0b9a1c0eaf74795b582073f40f55b93.jpg"></div><br><br>  Le chargeur est r√©alis√© sous la forme d'un tambour avec 4 √©videments pour cigarettes.  Pour √©viter d'essayer de faire passer une cigarette dans le chargeur, le m√©canisme √† cliquet ne permet pas de se d√©placer dans la direction oppos√©e, du c√¥t√© duquel les pare-chocs sont fabriqu√©s. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/69b/1af/cb9/69b1afcb91214e94a40b24be99f6895e.jpg"></div><br><br>  Des fentes ont √©t√© faites sur le couvercle sup√©rieur, elles vous permettent d'√©liminer les √©ventuelles distorsions de cigarettes √† l'int√©rieur de la bo√Æte et de secouer les copeaux de tabac. <br><br>  <b>Interface</b> <br><br>  Pour contr√¥ler l'heure, le nombre de cigarettes dans CHYAK et le nombre de cigarettes sorties, l'affichage OLED est surveill√©.  Il est √©teint presque tout le temps pour ne pas d√©charger la batterie et n'est allum√© que par un signal du capteur capacitif central, qui se d√©clenche lorsqu'une main est lev√©e vers le CHYAK ou un signal du bouton lors du chargement des cigarettes.  Un autre bouton capture le moment o√π le plateau est ferm√© et d√©marre le cycle de retard suivant.  Deux capteurs capacitifs suppl√©mentaires sont situ√©s sur la paroi arri√®re et sont utilis√©s pour r√©gler les compteurs de cigarettes (n√©cessaires, par exemple, lors du changement de piles). <br><br>  <b>√âlectronique</b> <br><br>  Le microcontr√¥leur est un Teensy LC.  Cet appareil de type arduin, compatible avec la plupart des biblioth√®ques Arduino, a √©t√© choisi car il prend en charge les capteurs capacitifs (interface tactile (TSI)).  Les capteurs sont si sensibles qu'ils sentent facilement la main lev√©e √† une distance d'un centim√®tre.  Teensy LC a le mode dit LLWU, dans ce mode tous les modules sont en mode veille, √† l'exception de l'oscillateur 1 kHz.  Vous pouvez quitter ce mode veille de 4 mani√®res: a) obtenir une interruption du capteur capacitif, b) obtenir une interruption de la broche, c) obtenir un d√©bordement du compteur 1 kHz (minuterie √† faible puissance, LPTMR), d) obtenir une interruption de l'alarme. <br><br>  Ici, l'auteur √©tait en difficult√©: dans les plans initiaux, il s'agissait d'utiliser TSI pour se r√©veiller lorsqu'une main √©tait pr√©sent√©e, et LPTMR pour des interruptions p√©riodiques pour ajuster les niveaux de TSI (en fonction des conditions environnementales) et le contr√¥le du temps.  Mais il s'est av√©r√© que LPTMR est utilis√© pour le fonctionnement de TSI et, par cons√©quent, ne peut pas √™tre utilis√© comme compteur de temps.  (L'interruption de d√©bordement LPTMR est un d√©clenchement mat√©riel pour TSI, et, bien s√ªr, doit √™tre rapide pour surveiller le capteur. Habituellement, ce compteur est pr√©r√©gl√© sur moins un pour que TSI soit interrog√© avec la fr√©quence la plus √©lev√©e possible de 1 kHz). <br><br>  Une autre possibilit√© serait d'utiliser l'interruption d'alarme RTC, mais le fait est que Tenncy LC n'a pas d'horloge temps r√©el (RTC).  Au contraire, RTC est dans le processeur lui-m√™me, mais il n'y a pas de c√¢blage pour le quartz RTC sur la carte.  Cependant, le d√©veloppeur du processeur a laiss√© une faille pour les esprits curieux.  L'oscillateur 1 kHz (qui fonctionne en mode veille) peut √™tre utilis√© comme source pour les registres RTC du contr√¥leur.  Ensuite, il s'av√®re que le RTC peut compter non pas des secondes d'intervalle (comme lors de l'utilisation de quartz √† 32 kHz), mais 32 secondes si vous utilisez un oscillateur √† 1 kHz.  Cette pr√©cision n'est bien s√ªr pas suffisante.  Mais il y a une issue. <br><br>  Voici comment cela fonctionne: <br><br>  Il existe un registre RTC Time Prescaler (RTC_TPR).  Ce registre de 16 bits compte les impulsions de l'oscillateur.  Lorsqu'il d√©borde, le registre des secondes de temps RTC (RTC_TSR) augmente d'une unit√©.  En mode classique, ce sont les secondes, qui sont compar√©es au registre des alarmes temporelles RTC (RTC_TAR), et lorsqu'elles co√Øncident, une interruption d'alarme est g√©n√©r√©e.  Lors de l'utilisation de quartz 32 kHz standard, RTC_TSR n'est pas pr√©install√©, mais est compt√© √† partir de z√©ro √† chaque fois (32 768 jusqu'au d√©bordement (secondes)).  Mais si nous pr√©r√©glons RTC_TSR √† chaque fois, en tenant compte du fait que nous avons un oscillateur lent √† 1 kHz, nous pouvons obtenir une interruption d'alarme jusqu'√† une milliseconde de pr√©cision (sans tenir compte de l'inexactitude de l'oscillateur lui-m√™me).  Bien entendu, RTC_TAR doit √©galement √™tre recalcul√© en cons√©quence. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/719/cc7/057/719cc7057df74632be110832ac93d99b.png"></div><br><br>  Par exemple, si nous voulons d√©finir la p√©riode √† 87 secondes, nous devons √©crire 2 dans RTC_TSR (2 * 32768 = 65536ms = 65,536s), 2 dans RTC_TAR et 32768- (87 * 1000-65536) = 11304 dans RTC_TSR.  Ensuite, 32.768-11.304 = 21.464 secondes se passeront avant le premier d√©bordement RTC_TPR, et deux cycles complets 2 * 32.768 = 65.536 leur seront ajout√©s, qui ne seront que 21.464 + 65.536 = 87 secondes <br>  En g√©n√©ral, comme ceci: <br><br><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setAlarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> seconds )</span></span></span><span class="hljs-function"> </span></span>{ RTC_SR = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//disable RTC RTC_TPR=32768-(seconds*1000%32768); RTC_TSR=0; //RTC counter RTC_SR = RTC_SR_TCE; //enable RTC RTC_TAR = seconds*1000/32768; }</span></span></code> </pre> <br>  Et m√™me nous pouvons surveiller le temps total (jusqu'√† une erreur de 1 kHz de l'oscillateur), par exemple, si au d√©but du programme tous les registres RTC √©taient nuls: <br><br><pre> <code class="hljs lisp">timeEllapsed=(<span class="hljs-name"><span class="hljs-name">RTC_TSR*32768+RTC_TPR</span></span>)/1000</code> </pre> <br>  La pr√©cision de l'oscillateur 1 kHz est faible, mais pour nos besoins, elle sera suffisante.  Il convient de noter que lors du d√©marrage d'une nouvelle alarme, nous modifions les registres RTC, donc si vous avez besoin de surveiller l'heure, ils doivent √™tre m√©moris√©s avant le d√©clenchement de l'alarme, et apr√®s avoir quitt√© l'interruption d'alarme, ils sont recalcul√©s √† nouveau en tenant compte du temps pass√© en veille prolong√©e.  Je l'ai d√©crit en d√©tail ici: √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">propos de RTC pour Teency LC</a> <br><br>  Dans CJC, une interruption toutes les 10 minutes mesure et stocke le niveau du signal des capteurs capacitifs en l'absence d'une main.  Ceci est fait afin de pouvoir suivre de mani√®re fiable les changements dans les signaux √† l'approche.  Avec un fond √† ~ 500 unit√©s, nous utilisons un niveau exc√©dentaire de ~ 20 unit√©s, ce qui permet de sentir la main √† une distance de 5-10 mm.  Le niveau de fond d√©pend de la temp√©rature et de l'humidit√©, donc pour la fiabilit√© il doit √™tre ajust√© p√©riodiquement.  C'est, je crois, une faille dans les d√©veloppeurs de processeurs.  Pourquoi n'ont-ils pas permis d'avoir un r√©veil de TSI et d'un autre compteur de faible puissance en m√™me temps (il suffit d'ajouter un autre registre), car un ajustement p√©riodique des niveaux de TSI est presque obligatoire, m√™me si vous n'avez pas besoin d'une minuterie √† d'autres fins! <br><br>  Maintenant sur l'√©nergie consomm√©e.  En mode veille LLWU, le Teensy LC consomme environ 15 uA lorsqu'il n'y a pas de kit carrosserie.  Nous avons d√ª connecter un autre √©cran OLED et un servo.  Ces deux appareils ont des courants de fuite importants m√™me dans un √©tat passif. <br><br>  Tout est simple avec OLED, c'est un √©cran OLED monochrome Adafruit 0,96 "128x64, il est aliment√© par 3,3 V, consomme environ 20 mA lorsqu'il est allum√© (en fonction du nombre de pixels impliqu√©s) et est contr√¥l√© par SPI.  Autrement dit, connectez simplement son entr√©e d'alimentation √† la sortie de 20 milliamp√®res du Teensy LC (Teency a diff√©rents types de sorties) et vous avez termin√©.  Lorsque tout le monde dort, cette sortie est simplement transf√©r√©e au 3√®me √©tat et le courant ne passe pas par l'affichage, au r√©veil la sortie est transf√©r√©e √† l'√©tat haut de sortie et devient Vcc pour l'affichage. <br><br>  Le servo est un peu plus compliqu√©.  Le servo en mode veille consomme un courant d'environ 2 mA, ce qui, bien s√ªr, n'est pas acceptable.  Par cons√©quent, vous devez l'√©teindre compl√®tement pendant que vous dormez.  Contrairement √† l'Arduin classique, le Teensy LC propose une assez petite s√©lection d'alimentations: soit 1,7-3,3 V directement connect√©es, soit 2,6-5,5 V (avec le r√©gulateur de tension interne activ√©).  Les servos g√©n√©ralement accessibles fonctionnent √† partir d'au moins 1S Lipo, et cela fait 3,3-4,2 V. Par cons√©quent, nous devons allumer trois batteries standard en s√©rie pour avoir de 3,3 (d√©charge) √† 4,6 V (nouveau).  Pour la plupart des servos, 3,3 V est √† la limite de fonctionnement, donc les sorties Teensy ne peuvent pas √™tre utilis√©es directement (comme pour OLED).  Oui, et le courant pendant la rotation est d'environ 50 mA, ce qui est un peu trop pour le Teensy LC.  Par cons√©quent, le servo est activ√© via MOSFET: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d87/121/7a3/d871217a39f04ecfb537dff032ac7fb1.png"></div><br><br>  Avec cette mise sous tension, il peut sembler que ce n'est pas s√ªr, car lorsque le MOSFET est √©teint, la tension √† l'entr√©e PWM ctrl d√©passe 3,3 V, et les entr√©es Tennsy LC ne sont pas tol√©rantes √† 5 V (contrairement √† l'Arduin classique).  Mais cela ne vaut pas la peine d'√™tre craint, en se souvenant que le courant PWM ctrl est tr√®s petit, et il n'y a pas lieu de craindre pour la diode de limitation √† l'entr√©e du processeur (la raison de l'inadmissibilit√© de d√©passer Vcc + 0,5 est dans cette diode), d'ailleurs, √† des courants comparables aux courants de la diode ferm√©e il ne sera m√™me pas √† l'√©tat ouvert. <br><br>  en CHYAK j'utilise HK282 avec un seuil de 3,3V (juste parce que je l'avais).  Une sorte de servo basse tension et basse puissance peut √™tre aliment√© directement √† partir des sorties Teensy, selon le sch√©ma utilis√© pour OLED. <br><br>  En cons√©quence, le courant en mode veille s'est av√©r√© √™tre d'environ 50 uA, il √©tait probablement possible de le r√©duire encore plus, mais j'ai d√©cid√© que cela suffisait (ne serait-ce qu'au sommeil, les batteries devraient durer plus de 4 ans: 2000mAh / 0,05mA). <br><br>  <b>Technique</b> <br><br>  Imprim√© sur une imprimante 3D Monoprice Ultimate, plastique PLA, buse 0,4 mm, couche 0,2 mm.  Pour plus de d√©tails sur le m√©canisme de verrouillage, une couche de 0,1 mm pour plus de pr√©cision.  Les ressorts sont √©galement imprim√©s sur une imprimante 3D.  Tapez longtemps.  Par exemple, la partie la plus au milieu (elle a de nombreuses pi√®ces internes et de doubles parois pour l'√©lectronique et les fils) a √©t√© imprim√©e pendant 20 heures.  Il a √©t√© coll√© avec de la colle cyan-acrylate.  Si quelque chose se casse √† l'int√©rieur, impossible √† distinguer (protection contre les maniaques-fumeurs), vous devrez le casser comme une tirelire et l'imprimer √† nouveau (un argument en faveur des imprimantes 3D).  Les dessins et les animations sont r√©alis√©s dans SolidWorks, l'environnement de d√©veloppement AtmelStudio (oui, AVR (teency) est pris en charge d√®s la sortie de la bo√Æte, comme Arduino, via VisualMicro). </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr402867/">https://habr.com/ru/post/fr402867/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr402853/index.html">La troisi√®me vague de solutions blockchain apporte la technologie CAT</a></li>
<li><a href="../fr402859/index.html">Des ordinateurs portables au service de la police</a></li>
<li><a href="../fr402861/index.html">Premi√®re fois: pour la premi√®re du film</a></li>
<li><a href="../fr402863/index.html">Un contrat mod√®le honn√™te comme m√©canisme d'autor√©gulation des relations publiques</a></li>
<li><a href="../fr402865/index.html">Deux vols d'une √©tape du Falcon 9 en une vid√©o</a></li>
<li><a href="../fr402869/index.html">Trackers tendances √† la mode: Samsung, Polar, Withings, qui n'√©taient pas attendus</a></li>
<li><a href="../fr402871/index.html">Comment ouvrir une banque en Europe: licences et blockchain</a></li>
<li><a href="../fr402873/index.html">Le livre "Ne meurs pas! La nourriture dans la lutte pour la vie "</a></li>
<li><a href="../fr402875/index.html">Matrices pour cam√©ras CCTV. √Ä quoi faire attention?</a></li>
<li><a href="../fr402877/index.html">Pr√©sentation de l'imprimante de chocolat</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>