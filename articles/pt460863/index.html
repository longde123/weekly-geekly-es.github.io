<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë≠ üíã üë®üèº‚Äç‚úàÔ∏è Cloudflare crash details 2 de julho de 2019 ‚ú¥Ô∏è üëº ü§∏üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="H√° quase 9 anos, a Cloudflare era uma pequena empresa, mas eu n√£o trabalhava nela, era apenas um cliente. Um m√™s ap√≥s o lan√ßamento do Cloudflare, rece...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cloudflare crash details 2 de julho de 2019</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/460863/"><p><img src="https://habrastorage.org/webt/dx/yb/5r/dxyb5rids6_8tahyhactypl4rwm.png"></p><br><p>  H√° quase 9 anos, a Cloudflare era uma pequena empresa, mas eu n√£o trabalhava nela, era apenas um cliente.  Um m√™s ap√≥s o lan√ßamento do Cloudflare, recebi uma notifica√ß√£o de que o DNS n√£o parece estar funcionando no meu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">site</a> jgc.org.  O Cloudflare fez uma altera√ß√£o nos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Buffers de Protocolo</a> e houve um DNS quebrado. </p><a name="habracut"></a><br><p>  Escrevi imediatamente para Matthew Prince, encabe√ßando a carta ‚ÄúOnde est√° o meu DNS?‚Äù, E ele enviou uma resposta longa, cheia de detalhes t√©cnicos ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">leia toda a correspond√™ncia aqui</a> ), √† qual respondi: </p><br><blockquote>  De: John Graham Cumming <br>  Data: 7 de outubro de 2010 9:14 <br>  Assunto: Re: Onde est√° o meu DNS? <br>  Para: Matthew Prince <br><br>  Relat√≥rio legal, obrigado.  Definitivamente vou ligar se houver problemas.  Provavelmente vale a pena escrever um post sobre isso quando voc√™ coletar todas as informa√ß√µes t√©cnicas.  Eu acho que as pessoas v√£o gostar de uma hist√≥ria aberta e honesta.  Especialmente se voc√™ anexar gr√°ficos a ele para mostrar como o tr√°fego cresceu ap√≥s o lan√ßamento. <br><br>  Eu tenho um bom monitoramento no site e recebo um SMS sobre cada falha.  O monitoramento mostra que a falha ocorreu entre 13:03:07 e 14:04:12.  Os testes s√£o realizados a cada cinco minutos. <br><br>  Tenho certeza que voc√™ descobrir√°.  Voc√™ definitivamente n√£o precisa de sua pr√≥pria pessoa na Europa?  :-) </blockquote><p>  E ele respondeu: </p><br><blockquote>  De: Matthew Prince <br>  Data: 7 de outubro de 2010, 9:57 <br>  Assunto: Re: Onde est√° o meu DNS? <br>  Para: John Graham Cumming <br><br>  Obrigada  Respondemos a todos que escreveram.  Estou indo para o escrit√≥rio agora e escreveremos algo no blog ou postaremos um post oficial em nosso quadro de avisos.  Concordo plenamente, a honestidade √© o nosso tudo. </blockquote><p>  Agora, a Cloudflare √© uma empresa realmente grande, trabalho nela e agora tenho que escrever abertamente sobre nosso erro, suas conseq√º√™ncias e nossas a√ß√µes. </p><br><h3 id="sobytiya-2-iyulya">  2 de julho de eventos </h3><br><p>  Em 2 de julho, implantamos uma nova regra nas regras gerenciadas do WAF, devido √† falta de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">recursos do processador</a> em cada n√∫cleo do processador que processa o tr√°fego HTTP / HTTPS na rede Cloudflare em todo o mundo.  Estamos constantemente aprimorando as regras gerenciadas do WAF em resposta a novas amea√ßas e vulnerabilidades.  Em maio, por exemplo, corremos para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">adicionar uma regra</a> para nos proteger de uma s√©ria vulnerabilidade no SharePoint.  O ponto principal do nosso WAF √© a capacidade de implantar regras r√°pida e globalmente. </p><br><p>  Infelizmente, a atualiza√ß√£o da quinta-feira passada continha uma express√£o regular que gastava muitos recursos do processador dedicados ao HTTP / HTTPS no retorno.  Isso afetou nossos recursos principais de proxy, CDN e WAF.  O gr√°fico mostra que os recursos do processador para atender ao tr√°fego HTTP / HTTPS atingem quase 100% nos servidores da nossa rede. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/au/xp/dz/auxpdz0pbethhc_hka-nvzmmsmo.png"></a> <br>  <em>Usando recursos do processador em um dos pontos de presen√ßa durante um incidente</em> </p><br><p>  Como resultado, nossos clientes (e os clientes de nossos clientes) encontraram uma p√°gina com um erro 502 nos dom√≠nios do Cloudflare.  Os erros 502 foram gerados pelos servidores Web front-end do Cloudflare, que ainda possu√≠am kernels gratuitos, mas n√£o podiam entrar em contato com processos que processam o tr√°fego HTTP / HTTPS. </p><br><p><img src="https://habrastorage.org/webt/mn/36/v_/mn36v_x1bbtqofu8l9lzpjty-pm.png"></p><br><p>  Sabemos quantos inconvenientes isso causou aos nossos clientes.  Estamos terrivelmente envergonhados.  E esse fracasso nos impediu de lidar efetivamente com o incidente. </p><br><p> Se voc√™ era um desses clientes, provavelmente o assustava, irritava e aborrecia.  Al√©m disso, n√£o temos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">falhas globais</a> h√° 6 anos.  O alto consumo de CPU foi devido a uma regra WAF com uma express√£o regular mal formulada, o que levou a um retorno excessivo.  Aqui est√° a express√£o culpada: <code>(?:(?:\"|'|\]|\}|\\|\d|(?:nan|infinity|true|false|null|undefined|symbol|math)|\`|\-|\+)+[)]*;?((?:\s|-|~|!|{}|\|\||\+)*.*(?:.*=.*)))</code> </p><br><p>  Embora seja interessante por si s√≥ (e vou falar mais sobre isso abaixo), o servi√ßo Cloudflare foi interrompido por 27 minutos, n√£o apenas devido √† express√£o regular impr√≥pria.  Demorou um pouco para descrever a sequ√™ncia de eventos que levaram √† falha, por isso n√£o respondemos rapidamente.  No final do post, descreverei o backtracking em express√µes regulares e direi o que fazer sobre isso. </p><br><h3 id="chto-sluchilos">  O que aconteceu </h3><br><p>  Vamos come√ßar em ordem.  Todo o tempo √© indicado aqui no UTC. </p><br><p>  √Äs 13:42, um engenheiro da equipe de firewall fez uma pequena altera√ß√£o nas regras para detectar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">XSS</a> usando um processo autom√°tico.  Assim, um ticket de solicita√ß√£o de mudan√ßa foi criado.  Gerenciamos esses tickets pelo Jira (captura de tela abaixo). </p><br><p>  Ap√≥s 3 minutos, a primeira p√°gina do PagerDuty apareceu, relatando um problema com o WAF.  Foi um teste sint√©tico que verifica a funcionalidade do WAF (temos centenas deles) fora do Cloudflare para monitorar a opera√ß√£o normal.  Em seguida, imediatamente houve p√°ginas com notifica√ß√µes de falhas de outros testes ponta a ponta dos servi√ßos Cloudflare, problemas globais de tr√°fego, erros 502 generalizados e v√°rios relat√≥rios de nossos pontos de presen√ßa (PoP) em cidades ao redor do mundo que indicavam falta de recursos do processador. </p><br><p><img src="https://habrastorage.org/webt/fh/iw/ja/fhiwjas8c3-qfcwo-11nks3lld4.png"></p><br><p><img src="https://habrastorage.org/webt/fs/g7/xo/fsg7xokybw-svzn8tn-uyhuj7dm.jpeg"></p><br><p>  Recebi v√°rias notifica√ß√µes, sa√≠ da reuni√£o e j√° estava indo para a mesa quando o chefe do departamento de desenvolvimento de solu√ß√µes disse que perdemos 80% do tr√°fego.  Corri para nossos engenheiros da SRE que j√° estavam trabalhando no problema.  A princ√≠pio, pensamos que era algum tipo de ataque desconhecido. </p><br><p><img src="https://habrastorage.org/webt/-r/ox/mw/-roxmwj33bvn_n-xyww8xhfwpmw.jpeg"></p><br><p>  Os engenheiros do Cloudflare SRE est√£o espalhados pelo mundo e monitoram a situa√ß√£o o tempo todo.  Normalmente, esses alertas notificam voc√™ sobre problemas locais espec√≠ficos de escopo limitado, s√£o monitorados em pain√©is internos e s√£o resolvidos v√°rias vezes ao dia.  Mas essas p√°ginas e notifica√ß√µes indicavam algo realmente s√©rio, e os engenheiros do SRE anunciaram imediatamente o n√≠vel de gravidade do P0 e se voltaram para os engenheiros de gerenciamento e sistema. </p><br><p>  Nossos engenheiros de Londres naquele momento estavam ouvindo uma palestra no sal√£o principal.  A palestra teve que ser interrompida, todos se reuniram em uma grande sala de confer√™ncias e mais especialistas foram convidados.  Este n√£o era um problema comum que o SRE pudesse descobrir por si mesmos.  Era urgente conectar os especialistas certos. </p><br><p>  √Äs 14:00, determinamos que havia um problema com o WAF e n√£o havia ataque.  O departamento de desempenho recuperou os dados do processador e ficou √≥bvio que a WAF era a culpada.  Outro colaborador confirmou essa teoria com strace.  Outra pessoa viu nos logs que o problema com o WAF.  √Äs 14:02, toda a equipe me procurou quando foi proposto o uso de kill global - um mecanismo incorporado ao Cloudflare que desativa um componente em todo o mundo. </p><br><p>  Como matamos a WAF globalmente √© outra hist√≥ria.  N√£o √© assim t√£o simples.  Utilizamos nossos pr√≥prios produtos e, como nosso servi√ßo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Access</a> n√£o funcionou, n√£o conseguimos autenticar e entrar no painel de controle interno (quando tudo foi reparado, descobrimos que alguns membros da equipe perderam o acesso devido a um recurso de seguran√ßa que desabilita credenciais se N√£o use o painel de controle interno por muito tempo). </p><br><p>  E n√£o conseguimos acessar nossos servi√ßos internos, como Jira ou o sistema de compila√ß√£o.  Precis√°vamos de uma solu√ß√£o alternativa, usada com pouca frequ√™ncia (isso tamb√©m precisaria ser resolvido).  Finalmente, um engenheiro conseguiu interromper o WAF √†s 14:07 e, √†s 14:09, o n√≠vel de tr√°fego e processador em todos os lugares voltou ao normal.  O restante dos mecanismos de defesa do Cloudflare funcionou como esperado. </p><br><p>  Ent√£o come√ßamos a restaurar o WAF.  Como a situa√ß√£o estava fora do comum, realizamos testes negativos (perguntando-nos se o problema realmente era essa altera√ß√£o) e positivos (garantindo que a revers√£o funcionasse) em uma cidade usando tr√°fego separado, transferindo clientes pagos a partir da√≠. </p><br><p>  √Äs 14h52, est√°vamos convencidos de que entend√≠amos o motivo, fizemos uma corre√ß√£o e ativamos o WAF novamente. </p><br><h3 id="kak-rabotaet-cloudflare">  Como funciona o Cloudflare </h3><br><p>  O Cloudflare possui uma equipe de engenheiros que gerenciam regras gerenciadas para o WAF.  Eles tentam aumentar a taxa de detec√ß√£o, reduzir o n√∫mero de falsos positivos e responder rapidamente a novas amea√ßas √† medida que surgem.  Nos √∫ltimos 60 dias, 476 solicita√ß√µes de altera√ß√£o para regras gerenciadas pelo WAF foram processadas (em m√©dia, uma a cada 3 horas). </p><br><p>  Essa altera√ß√£o espec√≠fica precisava ser implantada no modo de simula√ß√£o, onde o tr√°fego real do cliente passa pela regra, mas nada √© bloqueado.  Usamos esse modo para verificar a efic√°cia das regras e medir a propor√ß√£o de resultados falso-positivos e falso-negativos.  Mas mesmo no modo de simula√ß√£o, as regras devem ser realmente executadas e, nesse caso, a regra continha uma express√£o regular que consumia muitos recursos do processador. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/1p/sc/90/1psc90ccs9enwxvdyvu4thq30eo.png"></a> </p><br><p>  Como voc√™ pode ver na solicita√ß√£o de mudan√ßa acima, temos um plano de implanta√ß√£o, um plano de revers√£o e um link para o procedimento operacional padr√£o interno (SOP) para esse tipo de implanta√ß√£o.  O SOP para alterar a regra permite public√°-la globalmente.  De fato, no Cloudflare, tudo √© organizado de maneira totalmente diferente, e o SOP exige primeiro enviar o software para teste e uso interno para um ponto de presen√ßa interno (PoP) (usado por nossos funcion√°rios), depois para um pequeno n√∫mero de clientes em um local isolado, depois para um grande n√∫mero de clientes e somente ent√£o para o mundo inteiro. </p><br><p>  Aqui est√° como fica.  Usamos git no sistema interno atrav√©s do BitBucket.  Os engenheiros de mudan√ßa enviam o c√≥digo que eles constroem para o TeamCity e, quando a constru√ß√£o √© aprovada, os revisores s√£o designados.  Quando a solicita√ß√£o de pool √© aprovada, o c√≥digo √© coletado e uma s√©rie de testes √© realizada (novamente). </p><br><p>  Se a montagem e os testes forem bem-sucedidos, uma solicita√ß√£o de mudan√ßa ser√° criada em Jira e a mudan√ßa dever√° ser aprovada pelo supervisor ou especialista principal apropriado.  Ap√≥s a aprova√ß√£o, ele √© implantado na chamada "variedade de animais silvestres": DOG, PIG e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Canary</a> (c√£o, caxumba e can√°rio). </p><br><p>  O DOG PoP √© o Cloudflare PoP (como qualquer outra de nossas cidades), usado apenas pelos funcion√°rios do Cloudflare.  O PoP para uso interno permite detectar problemas antes mesmo que a solu√ß√£o comece a receber o tr√°fego do cliente.  Coisa √∫til. </p><br><p>  Se o teste DOG for bem-sucedido, o c√≥digo prosseguir√° para o est√°gio PIG (porquinho da √≠ndia).  Este √© o Cloudflare PoP, onde uma pequena quantidade de tr√°fego livre do cliente flui atrav√©s do novo c√≥digo. <br>  Se tudo estiver bem, o c√≥digo vai para Canary.  Temos tr√™s PoPs Can√°rias em diferentes partes do mundo.  O tr√°fego de clientes pagos e gratuitos passa pelo novo c√≥digo neles, e esta √© a √∫ltima verifica√ß√£o de erro. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ew/d_/0h/ewd_0hfzquucy07y15qbgbckaao.png"></a> <br>  <em>Processo de lan√ßamento do software Cloudflare</em> </p><br><p>  Se o c√≥digo estiver correto no Canary, n√≥s o liberaremos.  Passar por todas as etapas - DOG, PIG, Canary, o mundo inteiro - leva v√°rias horas ou dias, dependendo da altera√ß√£o do c√≥digo.  Devido √† diversidade da rede e dos clientes da Cloudflare, testamos exaustivamente o c√≥digo antes de um lan√ßamento global para todos os clientes.  Mas o WAF n√£o segue especificamente esse processo porque as amea√ßas precisam ser respondidas rapidamente. </p><br><p>  Amea√ßas WAF <br>  Nos √∫ltimos anos, houve significativamente mais amea√ßas em aplicativos convencionais.  Isso se deve √† maior disponibilidade de ferramentas de teste de software.  Por exemplo, escrevemos recentemente sobre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">difus√£o</a> ). </p><br><p><img src="https://habrastorage.org/webt/br/lu/mp/brlumpkugkwhpdfq3zb0fb5vixm.png"><br>  <em>Fonte: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://cvedetails.com/</a></em> </p><br><p>  Muitas vezes, uma confirma√ß√£o do conceito √© criada e publicada imediatamente no Github para que as equipes que atendem ao aplicativo possam test√°-lo rapidamente e garantir que ele esteja adequadamente protegido.  Portanto, o Cloudflare precisa da capacidade de responder a novos ataques o mais r√°pido poss√≠vel, para que os clientes tenham a oportunidade de corrigir seu software. </p><br><p>  Um √≥timo exemplo da resposta r√°pida do Cloudflare √© a implanta√ß√£o da prote√ß√£o contra vulnerabilidades do SharePoint em maio ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">leia aqui</a> ).  Quase imediatamente ap√≥s a publica√ß√£o dos an√∫ncios, notamos um grande n√∫mero de tentativas de explorar a vulnerabilidade nas instala√ß√µes do SharePoint de nossos clientes.  Nossos funcion√°rios monitoram constantemente novas amea√ßas e escrevem regras para proteger nossos clientes. </p><br><p>  A regra que causou o problema na quinta-feira foi a prote√ß√£o contra scripts entre sites (XSS).  Tamb√©m houve muitos outros ataques desse tipo nos √∫ltimos anos. </p><br><p><img src="https://habrastorage.org/webt/tr/jy/oz/trjyozwk_k4raviofhzgeskwf2s.png"><br>  <em>Fonte: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://cvedetails.com/</a></em> </p><br><p>  O procedimento padr√£o para modificar uma regra gerenciada para WAF requer teste de integra√ß√£o cont√≠nua (CI) antes da implanta√ß√£o global.  Quinta-feira passada, fizemos e expandimos as regras.  √Äs 13:31, um engenheiro enviou uma solicita√ß√£o de pool aprovada com uma altera√ß√£o. </p><br><p><img src="https://habrastorage.org/webt/uz/xj/jo/uzxjjo5648f52t8x-tnu66tuvku.png"></p><br><p>  √Äs 13:37, o TeamCity reuniu as regras, executou os testes e aprovou.  O conjunto de testes WAF testa a funcionalidade principal do WAF e consiste em um grande n√∫mero de testes de unidade para fun√ß√µes individuais.  Ap√≥s os testes de unidade, verificamos as regras do WAF com um grande n√∫mero de solicita√ß√µes HTTP.  As solicita√ß√µes HTTP verificam quais solicita√ß√µes devem ser bloqueadas pelo WAF (para interceptar o ataque) e quais podem ser ignoradas (para n√£o bloquear tudo e evitar falsos positivos).  Mas n√£o realizamos testes para o uso excessivo de recursos do processador, e o estudo dos logs de assemblies WAF anteriores mostra que o tempo de execu√ß√£o do teste com a regra n√£o aumentou e era dif√≠cil suspeitar que n√£o havia recursos suficientes. </p><br><p>  Os testes foram aprovados e o TeamCity come√ßou a implantar automaticamente a altera√ß√£o √†s 13:42. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/8-/s2/gd/8-s2gd8pw8j5zhxukadhwh77xr4.png"></a> </p><br><h3 id="quicksilver">  Merc√∫rio </h3><br><p>  As regras WAF foram projetadas para lidar com amea√ßas rapidamente, por isso as implantamos usando o reposit√≥rio de pares de valores-chave distribu√≠dos do Quicksilver, que distribui as altera√ß√µes globalmente em segundos.  Todos os nossos clientes usam essa tecnologia quando alteram a configura√ß√£o no painel ou na API, e √© gra√ßas a isso que respondemos √†s altera√ß√µes com a velocidade da luz. </p><br><p>  Conversamos um pouco sobre o Merc√∫rio.  Costum√°vamos usar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Kyoto Tycoon</a> como um reposit√≥rio globalmente distribu√≠do de pares de valores-chave, mas havia problemas operacionais com ele e escrevemos nosso reposit√≥rio replicado em mais de 180 cidades.  Agora, com o Quicksilver, enviamos altera√ß√µes na configura√ß√£o do cliente, atualizamos as regras WAF e distribu√≠mos o c√≥digo JavaScript gravado pelos clientes no Cloudflare Workers. </p><br><p>  Leva apenas alguns segundos para uma configura√ß√£o percorrer o mundo pressionando um bot√£o em um painel ou chamando uma API para fazer uma altera√ß√£o na configura√ß√£o.  Os clientes adoram essa configura√ß√£o de velocidade.  E Workers fornece a eles uma implanta√ß√£o de software global quase instant√¢nea.  Em m√©dia, o Quicksilver distribui cerca de 350 altera√ß√µes por segundo. </p><br><p>  E o Quicksilver √© muito r√°pido.  Em m√©dia, atingimos o 99¬∫ percentil de 2,29s para propagar altera√ß√µes em todos os computadores do mundo.  Geralmente a velocidade √© boa.  Afinal, quando voc√™ ativa uma fun√ß√£o ou limpa o cache, isso acontece quase instantaneamente e em qualquer lugar.  O envio de c√≥digo atrav√©s do Cloudflare Workers √© na mesma velocidade.  O Cloudflare promete a seus clientes atualiza√ß√µes r√°pidas no momento certo. </p><br><p>  Mas, nesse caso, a velocidade nos enganou e as regras mudaram em todos os lugares em quest√£o de segundos.  Voc√™ provavelmente notou que o c√≥digo WAF usa Lua.  O Cloudflare faz uso extensivo de Lua no ambiente de produ√ß√£o e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">j√° discutimos os</a> detalhes de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Lua no WAF</a> .  O Lua WAF usa o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PCRE</a> internamente e aplica o rastreamento para correspond√™ncia.  N√£o possui mecanismos de defesa contra express√µes que est√£o fora de controle.  Abaixo vou falar mais sobre isso e o que estamos fazendo com isso. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/zd/qq/yo/zdqqyof00zszstm3indwngi26_8.png"></a> </p><br><p>  Antes da implanta√ß√£o das regras, tudo corria bem: a solicita√ß√£o de pool foi criada e aprovada, o pipeline de CI / CD coletou e testou o c√≥digo, a solicita√ß√£o de altera√ß√£o foi enviada de acordo com o SOP, que regula a implanta√ß√£o e a revers√£o, e a implanta√ß√£o foi conclu√≠da. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/5t/47/ar/5t47art0hduaaxywv3io5_71z8a.png"></a> <br>  <em>Processo de implanta√ß√£o do CloudFare WAF</em> </p><br><p>  O que deu errado <br>  Como eu disse antes, implantamos dezenas de novas regras WAF toda semana e temos muitos sistemas de prote√ß√£o contra as consequ√™ncias negativas dessa implanta√ß√£o.  E quando algo d√° errado, geralmente √© uma combina√ß√£o de v√°rias circunst√¢ncias.  Se voc√™ encontrar apenas uma raz√£o, √© claro que isso √© calmante, mas nem sempre √© verdade.  Aqui est√£o os motivos que levaram √† falha do nosso servi√ßo HTTP / HTTPS. </p><br><ol><li>  O engenheiro escreveu uma express√£o regular que poderia levar a um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">retorno</a> excessivo. </li><li>  Uma ferramenta que poderia impedir o uso excessivo dos recursos do processador usados ‚Äã‚Äãpela express√£o regular foi removida por engano durante a refatora√ß√£o do WAF, algumas semanas antes - a refatora√ß√£o era necess√°ria para que o WAF consumisse menos recursos. </li><li>  O mecanismo regex n√£o tinha garantias de complexidade. </li><li>  O conjunto de testes n√£o p√¥de revelar consumo excessivo de CPU. </li><li>  O procedimento SOP permite a implanta√ß√£o global de altera√ß√µes de regra n√£o urgentes sem um processo de v√°rias etapas. </li><li>  O plano de revers√£o exigia uma montagem WAF completa duas vezes, o que demorou muito tempo. </li><li>  O primeiro alerta de alerta de tr√°fego global funcionou tarde demais. </li><li>  Adiamos a atualiza√ß√£o da p√°gina de status. </li><li>  Tivemos problemas ao acessar os sistemas devido a uma falha e a solu√ß√£o alternativa n√£o foi bem-sucedida. </li><li>  Os engenheiros do SRE perderam o acesso a alguns sistemas porque suas credenciais expiraram por motivos de seguran√ßa. </li><li>  Nossos clientes n√£o tiveram acesso ao painel ou √† API do Cloudflare porque eles passam pela regi√£o do Cloudflare. </li></ol><br><h3 id="chto-izmenilos-s-proshlogo-chetverga">  O que mudou desde a √∫ltima quinta-feira </h3><br><p>  Primeiro, paramos completamente todo o trabalho em vers√µes do WAF e fazemos o seguinte: </p><br><ol><li>  Reintroduzindo a prote√ß√£o contra recursos excessivos do processador que removemos.  (Feito) </li><li>  Verifique manualmente todas as regras 3868 nas regras gerenciadas do WAF para localizar e corrigir outros casos em potencial de retorno excessivo.  (Verifica√ß√£o conclu√≠da) </li><li>  Inclu√≠mos perfil de desempenho para todas as regras no conjunto de testes.  (Esperado: 19 de julho) </li><li>  Mudamos para o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">mecanismo re2</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Rust</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">regex</a> - ambos fornecem garantias no tempo de execu√ß√£o.  (Esperado: 31 de julho) </li><li>  Reescrevemos o SOP para implantar as regras em etapas, como outros softwares no Cloudflare, mas, ao mesmo tempo, temos a capacidade de implantar uma emerg√™ncia global se os ataques j√° come√ßaram. </li><li>  Estamos desenvolvendo a possibilidade de retirada urgente do painel e da API do Cloudflare da regi√£o do Cloudflare. </li><li>  Estamos automatizando a atualiza√ß√£o da p√°gina <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Status</a> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Cloudflare</a> . </li></ol><br><p>  A longo prazo, estamos abandonando o Lua WAF, que escrevi h√° v√°rios anos.  Migramos o WAF para o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">novo sistema de firewall</a> .  Portanto, o WAF ser√° mais r√°pido e receber√° um n√≠vel adicional de prote√ß√£o. </p><br><h3 id="zaklyuchenie">  Conclus√£o </h3><br><p>  Essa falha causou problemas para n√≥s e nossos clientes.  Reagimos rapidamente para corrigir a situa√ß√£o e agora estamos trabalhando em falhas nos processos que causaram a falha, e estamos nos aprofundando ainda mais para nos proteger de poss√≠veis problemas com express√µes regulares no futuro, mudando para uma nova tecnologia. </p><br><p>  Temos muita vergonha desse fracasso e pedimos desculpas aos nossos clientes.  Esperamos que essas mudan√ßas garantam que isso n√£o ocorra novamente. </p><br><h3 id="prilozhenie-bektreking-regulyarnyh-vyrazheniy">  Aplica√ß√£o.  Retrocesso de express√£o regular </h3><br><p>  Para entender como a express√£o: </p><br><pre> <code class="plaintext hljs">(?:(?:\"|'|\]|\}|\\|\d (?:nan|infinity|true|false|null|undefined|symbol|math)|\`|\- |\+)+[)]*;?((?:\s|-|~|!|{}|\|\||\+)*.*(?:.*=.*)))</code> </pre> <br><p>  Com todos os recursos do processador, voc√™ precisa saber um pouco sobre como o mecanismo regex padr√£o funciona.  O problema aqui √© o padr√£o <code>.*(?:.*=.*)</code> .  <code>(?:</code> e o correspondente <code>)</code> n√£o √© um grupo excitante (ou seja, a express√£o entre par√™nteses √© agrupada como uma express√£o). </p><br><p>  No contexto de consumo excessivo de recursos do processador, esse padr√£o pode ser designado como <code>.*.*=.*</code> .  Como tal, o padr√£o parece desnecessariamente complexo.  Mais importante, por√©m, no mundo real, essas express√µes (semelhantes √†s express√µes complexas nas regras da WAF) que solicitam que o mecanismo corresponda a um fragmento, seguido por outro fragmento, podem levar a um retorno catastr√≥fico.  E aqui est√° o porqu√™. </p><br><p><img src="https://habrastorage.org/webt/wr/7g/ec/wr7gec__o2lld5uwyz5ir6vfolm.png"></p><br><p>  Em express√£o regular <code>.</code>  significa que voc√™ precisa corresponder a um caractere. <code>.*</code> - corresponder a zero ou mais caracteres "avidamente", ou seja, capturar um m√°ximo de caracteres, portanto <code>.*.*=.*</code> significa corresponder a zero ou mais caracteres e corresponder a zero ou mais caracteres, localize caractere literal =, corresponde a zero ou mais caracteres. </p><br><p>  Fa√ßa a linha de teste <code>x=x</code> .  Corresponde √† express√£o <code>.*.*=.*. .*.*</code>  <code>.*.*=.*. .*.*</code> at√© o sinal de igual corresponde ao primeiro <code>x</code> (um dos grupos <code>.*</code> corresponde a <code>x</code> e o segundo a zero caracteres).  <code>.*</code> after = corresponde ao √∫ltimo <code>x</code> . </p><br><p>  Para essa compara√ß√£o, s√£o necess√°rias 23 etapas.  O primeiro grupo <code>.*</code> <code>.*.*=.*</code> Atua "avidamente" e corresponde √† linha inteira <code>x=x</code> .  O mecanismo passa para o pr√≥ximo grupo <code>.*</code> .  N√£o temos mais caracteres para corresponder, portanto, o segundo grupo <code>.*</code> Corresponde a zero caracteres (isso √© permitido).  Ent√£o o mecanismo vai para o sinal <code>=</code> .  N√£o h√° mais caracteres (o primeiro grupo <code>.*</code> Usou toda a express√£o <code>x=x</code> ), nenhuma correspond√™ncia ocorre. </p><br><p>  E aqui o mecanismo de express√£o regular retorna ao in√≠cio.  Ele vai para o primeiro grupo <code>.*</code> E o compara <code> x=</code> (em vez de <code>x=x</code> ) e assume o segundo grupo <code>.*</code> .  O segundo grupo <code>.*</code> Mapeia para o segundo <code>x</code> e, novamente, n√£o temos mais caracteres.  E quando o mecanismo atinge <code>=</code> v <code>.*.*=.*</code> Novamente, nada acontece.  E ele volta atr√°s novamente. </p><br><p>  Desta vez, o grupo <code>.*</code> Ainda corresponde a <code>x=</code> , mas o segundo grupo <code>.*</code> mais <code>x</code> , mas zero caracteres.  O mecanismo tenta encontrar o s√≠mbolo literal <code>=</code> no padr√£o <code>.*.*=.*</code> , Mas n√£o sai (afinal, o primeiro grupo j√° o ocupou <code>.*</code> ).  E ele volta atr√°s novamente. </p><br><p>  Desta vez, o primeiro grupo <code>.*</code> Leva apenas o primeiro x.  Mas o segundo grupo <code>.*</code> "Avidamente" captura <code>=x</code> .  J√° adivinhou o que vai acontecer?  O mecanismo tenta corresponder ao literal <code>=</code> , falha e faz o pr√≥ximo retorno. </p><br><p>   <code>.*</code>     <code>x</code> .  <code>.*</code>   <code>=</code> . ,      <code>=</code> ,       <code>.*</code> .   .         ! </p><br><p>     <code>.*</code>     <code>x</code> ,  <code>.*</code> ‚Äî   ,      <code>=</code>   <code> =</code>  .    <code>.*</code>    <code>x</code> . </p><br><p> 23    <code>x=x</code> .      Perl <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Regexp::Debugger</a> ,  ,     . </p><br><p><img src="https://habrastorage.org/webt/a7/do/2n/a7do2nizluizhm1h2q2shajnvgs.gif"></p><br><p>    ,     <code>x=x</code>    <code>x=xx</code> ?  33 .   <code>x=xxx</code> ? 45.   .      <code>x=x</code>  <code>x=xxxxxxxxxxxxxxxxxxxx</code> (20 <code>x</code>  <code>=</code> ).    20 x  <code>=</code> ,     555 ! ( ,     <code>x=</code>      20 <code>x</code> ,   4067 ,  ,   ). </p><br><p><img src="https://habrastorage.org/webt/t-/1m/l4/t-1ml4up0y5w262eye_cyjmlik4.png"></p><br><p>         <code>x=xxxxxxxxxxxxxxxxxxxx</code> : </p><br><p><img src="https://habrastorage.org/webt/t8/oz/wq/t8ozwqwv1otujwl5_bebeglitpe.gif"></p><br><p>   ,         .      ,     . ,     <code>.*.*=.*</code> ; (         ). ,     ,  <code>foo=bar;</code>  . </p><br><p>       .   <code>x=x</code>  90 ,   23.     .   <code>x=</code>  20 <code>x</code> ,  5353 .  .      <code>Y</code>     . </p><br><p><img src="https://habrastorage.org/webt/kn/n9/ex/knn9exewj9a48-fkxyayefzexeu.png"></p><br><p>  ,   5353    <code>x=xxxxxxxxxxxxxxxxxxxx</code>  <code>.*.*=.*;</code> </p><br><p><img src="https://habrastorage.org/webt/d3/gg/ra/d3ggrayopot2-l7vivzm0fqfnmq.gif"></p><br><p>   ¬´¬ª,   ¬´¬ª ,    .      <code>.*?.*?=.*?</code> ,   <code>x=x</code>  11  (  23).    <code>x=xxxxxxxxxxxxxxxxxxxx</code> .  ,  <code>?</code>  <code>.*</code>      ,    . </p><br><p>  ¬´¬ª      .     <code>.*.*=.*;</code>  <code>.*?.*?=.*?;</code> ,    . <code>x=x</code>    555 ,  <code>x=</code>  20 <code>x</code> ‚Äî 5353. </p><br><p> ,    (      ) ‚Äî         .        . </p><br><p>       1968 ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Programming Techniques: Regular expression search algorithm</a> (¬´ :    ¬ª).    ,         ,          ,        . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/fd/nn/ri/fdnnril2lmr0udityqylanfzahk.png"></a> </p><br><blockquote> <strong>  <br>     <br>   (Ken Thompson)</strong> <br> Bell Telephone Laboratories, Inc., -,  - <br><br>                 .             IBM 7094    .               ,         .    ,   . <br><br> <strong></strong> <br>      ,       . <br><br>        .      .     ‚Äî                  . <br>              . ,        . ,           . <br> ,           IBM 7094. <br><br> <strong></strong> <br>       .   ‚Äî   ,       .       ¬´¬∑¬ª    .         .      .  2  ,       . </blockquote><p>         ,           ALGOL-60,       IBM 7094.  ,     . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/fx/se/9x/fxse9xv8le3pgp2quvsrufznvb8.png"></a> </p><br><blockquote>   .    ‚äï      . <br>   1          .      ‚Äî a, b, c,      S[i]   NNODE. <br><br> NNODE   ,          (. . 5) </blockquote><p>       <code>.*.*=.*</code> ,   ,      . </p><br><p><img src="https://habrastorage.org/webt/mt/_5/lc/mt_5lcklo-jw2x6zmt8nwjg8hpy.png"></p><br><p>  . 0   ,   0,  3 ,     1, 2  3.      <code>.*</code>   . 3      .    <code>=</code>    <code>=</code> .  4  .    ,    . </p><br><p>  ,           <code>.*.*=.*</code> ,     <code>x=x</code> .     0,    .  1 </p><br><p><img src="https://habrastorage.org/webt/tx/a6/cl/txa6cltpurcbwxzrxk1v9ypkec4.png"></p><br><p>    ,        .        . </p><br><p>      ,       (1  2),    .  2) </p><br><p><img src="https://habrastorage.org/webt/ve/pb/nj/vepbnjljx-0cinc-eapaz17mths.png"></p><br><p>  . 2 ,  ,     <code>x</code>  <code>x=x</code> . <code>x</code>     ,    1     1.  <code>x</code>     ,    2     2. </p><br><p>    <code>x</code>  <code>x=x</code>  -   1  2.      3  4,       <code>=</code> . </p><br><p>    <code>=</code>  <code>x=x</code> .   x  ,              1    1    2   2,        <code>=</code>     2   3 (  4).    .  3) </p><br><p><img src="https://habrastorage.org/webt/0b/x8/7f/0bx87fp1aquszmn-wjp7ta3b4i0.png"></p><br><p>      <code>x</code>  <code>x=x</code> .   1  2        1  2.   3 <code>x</code>           3. </p><br><p>      <code>x=x</code> ,      4,     .     ,          .   . </p><br><p> ,     4 (   <code>x=</code> )    ,    ,    <code>x</code> . </p><br><p>        . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt460863/">https://habr.com/ru/post/pt460863/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt460851/index.html">SamsPcbGuide, Parte 10: Tecnologia - Componentes sem solda de chumbo</a></li>
<li><a href="../pt460855/index.html">Como usar o PHP para implementar microsservi√ßos?</a></li>
<li><a href="../pt460857/index.html">Como a pesquisa da Namecoin Blockchain previu ataques cibern√©ticos RTM</a></li>
<li><a href="../pt460859/index.html">Confer√™ncia IThink # 3 em Kharkov - com base na WWDC 2019</a></li>
<li><a href="../pt460861/index.html">Escopo e fechamento lexical do JavaScript</a></li>
<li><a href="../pt460865/index.html">Pessoas na lua. Fontes</a></li>
<li><a href="../pt460867/index.html">Sourcery para converter automaticamente em estruturas de objetos do Dom√≠nio</a></li>
<li><a href="../pt460869/index.html">Reconhecimento de objetos em tempo real no iOS usando YOLOv3</a></li>
<li><a href="../pt460873/index.html">Por que Turok: Dinosaur Hunter para N64 est√° anos √† frente de seu tempo</a></li>
<li><a href="../pt460875/index.html">Como n√≥s da QIWI chegamos a um estilo comum de intera√ß√£o entre o View e o ViewModel no MVVM</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>