<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèΩ‚Äç‚öïÔ∏è ü§¥üèæ üòí La technique de d√©veloppement de serveurs hautement fiables sur Go üñïüèª ‚õ±Ô∏è üë©‚Äçüëß‚Äçüëß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="De temps en temps, les programmeurs Web font face √† des t√¢ches qui peuvent m√™me effrayer les professionnels. Nous parlons de d√©velopper des applicatio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>La technique de d√©veloppement de serveurs hautement fiables sur Go</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/413681/">  De temps en temps, les programmeurs Web font face √† des t√¢ches qui peuvent m√™me effrayer les professionnels.  Nous parlons de d√©velopper des applications serveur qui n'ont pas le droit de faire des erreurs, de projets dans lesquels le co√ªt de l'√©chec est extr√™mement √©lev√©.  L'auteur du document, dont nous publions la traduction aujourd'hui, expliquera comment aborder ces t√¢ches. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/2r/ma/ty/2rmaty9ihtz7cjzhhvzqgm5e7ia.jpeg"></a> <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">De quel niveau de fiabilit√© votre projet a-t-il besoin?</font> </h2><br>  Avant de vous plonger dans les d√©tails du d√©veloppement d'applications serveur hautement fiables, vous devez vous demander si votre projet a vraiment besoin du niveau de fiabilit√© le plus √©lev√© possible.  Le processus de d√©veloppement de syst√®mes con√ßus pour des sc√©narios de travail dans lesquels l'erreur s'apparente √† une catastrophe universelle peut √™tre excessivement compliqu√© pour la plupart des projets dans lesquels les cons√©quences d'erreurs possibles ne sont pas particuli√®rement effrayantes. <br><br>  Si le co√ªt de l'erreur ne s'av√®re pas extr√™mement √©lev√©, une approche est acceptable, dans la mise en ≈ìuvre de laquelle le d√©veloppeur fait les efforts les plus raisonnables pour assurer l'op√©rabilit√© du projet, et si des probl√®mes surviennent, il les comprend simplement.  Des outils de surveillance modernes et des processus de d√©ploiement logiciel continu vous permettent d'identifier rapidement les probl√®mes de production et de les r√©soudre presque instantan√©ment.  Dans de nombreux cas, cela suffit. <br><br>  Dans le projet sur lequel je travaille aujourd'hui, ce n'est pas le cas.  Nous parlons de la mise en ≈ìuvre de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">blockchain</a> - une infrastructure de serveur distribu√©e pour l'ex√©cution s√ªre du code dans un environnement avec un faible niveau de confiance, tout en atteignant un consensus.  L'une des applications de cette technologie est la monnaie num√©rique.  Il s'agit d'un exemple classique d'un syst√®me avec un co√ªt d'erreur extr√™mement √©lev√©.  Dans ce cas, les d√©veloppeurs de projets doivent vraiment le rendre tr√®s, tr√®s fiable. <br><br>  Cependant, dans certains autres projets, m√™me s'ils ne sont pas li√©s √† la finance, la recherche de la plus haute fiabilit√© du code est logique.  Le co√ªt de maintenance d'une base de code fr√©quemment cass√©e peut atteindre tr√®s rapidement des valeurs astronomiques.  La capacit√© d'identifier les probl√®mes aux premiers stades du processus de d√©veloppement, alors que le co√ªt de leur r√©solution est encore faible, ressemble √† une r√©compense tr√®s r√©elle pour l'investissement en temps et en efforts dans la m√©thodologie de d√©veloppement de syst√®mes hautement fiables. <br><br><h2>  <font color="#3AC1EF">Peut-√™tre que la solution est TDD?</font> </h2><br>  Le d√©veloppement par le biais de tests ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Test Driven Development</a> , TDD) est souvent consid√©r√© comme le meilleur rem√®de contre le mauvais code.  TDD est une m√©thodologie de d√©veloppement puriste, dans l'application de laquelle les tests sont √©crits en premier, et seulement ensuite - du code qui n'est ajout√© au projet que lorsque les tests qui le v√©rifient cessent de g√©n√©rer des erreurs.  Ce processus garantit une couverture √† 100% du code avec des tests et donne souvent l'illusion que le code est test√© dans toutes les variantes possibles de son utilisation. <br><br>  Mais ce n'est pas le cas.  TDD est une excellente m√©thodologie qui fonctionne bien dans certains domaines, mais pour d√©velopper un code vraiment fiable, mais pas assez.  Pire encore, TDD inspire au d√©veloppeur une fausse confiance et l'application de cette m√©thodologie peut conduire au fait qu'il ne fera tout simplement pas, par paresse, des tests pour v√©rifier les d√©faillances du syst√®me dans des situations dont l'occurrence, du point de vue du bon sens, est presque impossible.  Nous en reparlerons plus tard. <br><br><h2>  <font color="#3AC1EF">Les tests sont la cl√© de la fiabilit√©</font> </h2><br>  En fait, peu importe que vous cr√©iez des tests avant d‚Äô√©crire du code ou apr√®s, que vous utilisiez ou non une m√©thodologie de d√©veloppement comme TDD.  L'essentiel est le fait d'avoir des tests.  Les tests sont la meilleure fortification d√©fensive qui prot√®ge votre code des probl√®mes de production. <br><br>  Puisque nous allons ex√©cuter nos tests tr√®s souvent, id√©alement apr√®s avoir ajout√© chaque nouvelle ligne au code, il est n√©cessaire que les tests soient automatis√©s.  Notre confiance dans la qualit√© du code ne doit en aucun cas reposer sur ses v√©rifications manuelles.  Le fait est que les gens ont tendance √† faire des erreurs.  L'attention port√©e aux d√©tails par une personne est affaiblie apr√®s avoir effectu√© la m√™me t√¢che intimidante plusieurs fois de suite. <br><br>  Les tests doivent √™tre rapides.  Tr√®s vite. <br><br>  S'il faut plus de quelques secondes pour terminer la suite de tests, les d√©veloppeurs seront tr√®s probablement paresseux et ajouteront du code au projet sans le tester.  La vitesse est l'une des plus grandes forces de Go.  La bo√Æte √† outils de d√©veloppement dans ce langage est l'une des plus rapides parmi celles existantes.  La compilation, la reconstruction et le test des projets se font en quelques secondes. <br><br>  De plus, les tests sont l'un des principaux moteurs des projets open source.  Par exemple, cela s'applique √† tout ce qui concerne la technologie blockchain.  L'open source ici est presque une religion.  La base de code afin de gagner la confiance de ceux qui l'utiliseront doit √™tre ouverte.  Cela permet, par exemple, de conduire son audit, cela cr√©e une atmosph√®re de d√©centralisation, dans laquelle il n'y a pas certaines entit√©s qui contr√¥lent le projet. <br><br>  Cela n'a aucun sens d'attendre une contribution significative au projet open source de d√©veloppeurs externes si ce projet ne comprend pas de tests de qualit√©.  Les participants externes au projet ont besoin de m√©canismes pour v√©rifier rapidement la compatibilit√© de ce qu'ils ont √©crit avec ce qui est d√©j√† ajout√© au projet.  En fait, l'ensemble des tests devrait √™tre effectu√© automatiquement √† la r√©ception de chaque demande pour ajouter un nouveau code au projet.  Si quelque chose qui est cens√© √™tre ajout√© au projet au moyen d'une telle demande casse quelque chose, le test doit le signaler imm√©diatement. <br><br>  La couverture compl√®te de la base de code avec des tests est une mesure trompeuse mais importante.  L'objectif d'atteindre une couverture de code √† 100% avec des tests peut sembler excessif, mais si vous y r√©fl√©chissez, il s'av√®re que si le code n'est pas enti√®rement couvert par les tests, une partie du code est envoy√© en production sans v√©rification, ce qui n'a jamais √©t√© ex√©cut√© auparavant. <br><br>  Une couverture compl√®te du code avec des tests ne signifie pas n√©cessairement qu'il y a suffisamment de tests dans le projet et ne signifie pas que ce sont des tests qui fournissent absolument toutes les options pour utiliser le code.  En toute confiance, nous pouvons seulement dire que si le projet n'est pas couvert √† 100% par des tests, le d√©veloppeur ne peut pas √™tre s√ªr de la fiabilit√© absolue du code, car certaines parties du code ne sont jamais test√©es. <br><br>  Malgr√© ce qui pr√©c√®de, il existe des situations o√π il y a trop de tests.  Id√©alement, chaque erreur possible devrait entra√Æner l'√©chec d'un test.  Si le nombre de tests est excessif, c'est-√†-dire que diff√©rents tests v√©rifient les m√™mes fragments de code, puis modifier le code existant et changer le comportement du syst√®me existant conduira au fait que pour que les tests existants correspondent au nouveau code, cela prendra trop de temps pour les traiter . <br><br><h2>  <font color="#3AC1EF">Pourquoi Go est-il un excellent choix pour des projets hautement fiables?</font> </h2><br>  Go est un langage tap√© statique.  Les types sont un contrat entre divers morceaux de code qui sont ex√©cut√©s ensemble.  Sans v√©rification de type automatique pendant le processus d'assemblage du projet, si vous devez respecter des r√®gles strictes pour couvrir le code avec des tests, nous devons impl√©menter des tests qui v√©rifient nous-m√™mes ces ¬´contrats¬ª.  Cela se produit, par exemple, dans les projets serveur et client bas√©s sur JavaScript.  L'√©criture de tests complexes visant uniquement √† v√©rifier les types signifie beaucoup de travail suppl√©mentaire, qui, dans le cas de Go, peut √™tre √©vit√©. <br><br>  Go est un langage simple et dogmatique.  Comme vous le savez, Go inclut de nombreuses id√©es traditionnelles pour les langages de programmation, comme l'h√©ritage OOP classique.  La complexit√© est le pire ennemi d'un code fiable.  Les probl√®mes ont tendance √† se cacher au niveau des articulations des structures complexes.  Cela s'exprime dans le fait que bien que les options typiques pour l'utilisation d'une certaine conception soient faciles √† tester, il existe des cas limites bizarres auxquels le d√©veloppeur de test pourrait m√™me ne pas penser.  En fin de compte, le projet n'aboutira qu'√† un seul de ces cas.  En ce sens, le dogmatisme est √©galement utile.  Dans Go, il n'y a souvent qu'une seule fa√ßon d'effectuer une action.  Cela peut sembler √™tre un facteur qui freine l'esprit libre du programmeur, mais quand quelque chose ne peut √™tre fait que d'une seule mani√®re, il est difficile de faire quelque chose de mal. <br><br>  Go est concis mais expressif.  Le code lisible est plus facile √† analyser et √† auditer.  Si le code est trop verbeux, son objectif principal peut se noyer dans le ¬´bruit¬ª des constructions auxiliaires.  Si le code est trop concis, les programmes qu'il contient peuvent √™tre difficiles √† lire et √† comprendre.  Go maintient un √©quilibre entre concision et expressivit√©.  Par exemple, il n'y a pas beaucoup de constructions auxiliaires, comme dans des langages tels que Java ou C ++.  Dans le m√™me temps, les constructions Go, relatives par exemple √† des domaines tels que la gestion des erreurs, sont tr√®s claires et assez d√©taill√©es, ce qui simplifie le travail du programmeur, l'aidant √† s'assurer, par exemple, qu'il a v√©rifi√© tout ce qui est possible. <br><br>  Go a des m√©canismes de gestion des erreurs et de r√©cup√©ration clairs apr√®s les plantages.  Des m√©canismes de gestion des erreurs d'ex√©cution bien r√©gl√©s sont la pierre angulaire d'un code tr√®s fiable.  Go a des r√®gles strictes pour retourner et distribuer les erreurs.  Dans des environnements comme Node.js, m√©langer les approches de contr√¥le du flux d'un programme, telles que les rappels, les promesses et les fonctions asynchrones, conduit souvent √† des erreurs non g√©r√©es, comme un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rejet non g√©r√© d'une promesse</a> .  La restauration du programme apr√®s des √©v√©nements similaires est presque <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">impossible</a> . <br><br>  Go a une biblioth√®que standard √©tendue.  Les d√©pendances sont un risque, en particulier lorsque leur source est des projets dans lesquels une attention insuffisante est accord√©e √† la fiabilit√© du code.  Une application serveur qui entre en production contient toutes les d√©pendances.  De plus, en cas de probl√®me, le d√©veloppeur de l'application finie en sera responsable, et non celui qui a cr√©√© l'une des biblioth√®ques utilis√©es par lui.  Par cons√©quent, dans des environnements o√π les projets √©crits sont surcharg√©s de petites d√©pendances, il est plus difficile de cr√©er des applications fiables. <br><br>  Les d√©pendances sont √©galement un risque pour la s√©curit√©, car le niveau de vuln√©rabilit√© d'un projet correspond au niveau de vuln√©rabilit√© de sa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©pendance la</a> plus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dangereuse</a> .  La vaste biblioth√®que standard Go est maintenue par ses d√©veloppeurs en tr√®s bon √©tat, son existence r√©duit le besoin de d√©pendances externes. <br><br>  Vitesse de d√©veloppement √©lev√©e.  Une caract√©ristique cl√© d'environnements comme Node.js est son cycle de d√©veloppement extr√™mement court.  L'√©criture de code prend moins de temps, par cons√©quent, le programmeur devient plus productif. <br><br>  Go a √©galement une vitesse de d√©veloppement √©lev√©e.  Un ensemble d'outils pour la construction de projets est assez rapide pour pouvoir regarder instantan√©ment le code en action.  Le temps de compilation est extr√™mement court; par cons√©quent, l'ex√©cution de code sur Go est per√ßue comme si elle n'avait pas √©t√© compil√©e, mais interpr√©t√©e.  De plus, le langage poss√®de suffisamment d'abstractions, comme un syst√®me de collecte des ordures, qui permet aux d√©veloppeurs de diriger les efforts pour impl√©menter les fonctionnalit√©s de leur projet, et non de r√©soudre des t√¢ches auxiliaires. <br><br><h2>  <font color="#3AC1EF">Exp√©rience pratique</font> </h2><br>  Maintenant que nous avons exprim√© suffisamment de points g√©n√©raux, il est temps de jeter un ≈ìil au code.  Nous avons besoin d'un exemple assez simple pour que, tout en l'√©tudiant, nous puissions nous concentrer sur la m√©thodologie de d√©veloppement, mais en m√™me temps, il devrait √™tre suffisamment avanc√© pour que nous, en l'explorant, ayons quelque chose √† dire.  J'ai d√©cid√© qu'il serait plus facile de prendre quelque chose de ce que je fais quotidiennement.  Par cons√©quent, je propose d'analyser la cr√©ation d'un serveur qui traite quelque chose qui ressemble √† des transactions financi√®res.  Les utilisateurs de ce serveur pourront v√©rifier les soldes des comptes associ√©s √† leurs comptes.  De plus, ils pourront transf√©rer des fonds d'un compte √† un autre. <br><br>  Nous allons essayer de ne pas compliquer cet exemple.  Notre syst√®me aura un serveur.  Nous ne contacterons pas les syst√®mes d'authentification et de cryptographie.  Ce sont des parties int√©grantes des projets de travail.  Mais nous devons nous concentrer sur le c≈ìur d'un tel projet, pour montrer comment le rendre aussi fiable que possible. <br><br><h3>  <font color="#3AC1EF">‚ñçDivision d'un projet complexe en parties faciles √† g√©rer</font> </h3><br>  La complexit√© est le pire ennemi de la fiabilit√©.  L'une des meilleures approches lorsque l'on travaille avec des syst√®mes complexes consiste √† appliquer le principe bien connu de ¬´diviser pour mieux r√©gner¬ª.  La t√¢che doit √™tre divis√©e en petites sous-t√¢ches et r√©soudre chacune d'elles s√©par√©ment.  De quel c√¥t√© aborder la partition de notre t√¢che?  Nous suivrons le principe de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">la responsabilit√© partag√©e</a> .  Chaque partie de notre projet devrait avoir son propre domaine de responsabilit√©. <br><br>  Cette id√©e correspond parfaitement √† l'architecture de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">microservices</a> populaire.  Notre serveur sera compos√© de services distincts.  Chaque service aura un domaine de responsabilit√© clairement d√©fini et une interface clairement d√©crite pour interagir avec d'autres services. <br><br>  Apr√®s avoir structur√© le serveur de cette mani√®re, nous serons en mesure de prendre des d√©cisions sur le fonctionnement de chacun des services.  Tous les services peuvent √™tre ex√©cut√©s ensemble, dans le m√™me processus, √† partir de chacun d'eux, vous pouvez cr√©er un serveur distinct et √©tablir leur interaction √† l'aide de RPC, vous pouvez s√©parer les services et ex√©cuter chacun d'eux sur un ordinateur distinct. <br><br>  Nous ne compliquerons pas la t√¢che, nous choisirons l'option la plus simple.  √Ä savoir, tous les services seront ex√©cut√©s dans le m√™me processus, ils √©changeront directement des informations, comme les biblioth√®ques.  Si n√©cessaire, cette solution architecturale pourra √† l'avenir √™tre facilement r√©vis√©e et modifi√©e. <br><br>  Alors de quels services avons-nous besoin?  Notre serveur est peut-√™tre trop simple pour le diviser en parties, mais, √† des fins p√©dagogiques, nous le diviserons n√©anmoins.  Nous devons r√©pondre aux demandes HTTP des clients visant √† v√©rifier les soldes et √† ex√©cuter les transactions.  L'un des services peut fonctionner avec une interface HTTP pour les clients.  <code>PublicApi</code> cela <code>PublicApi</code> .  Un autre service d√©tiendra des informations sur l'√©tat du syst√®me - le bilan.  <code>StateStorage</code> cela <code>StateStorage</code> .  Le troisi√®me service combinera les deux d√©crits ci-dessus et mettra en ≈ìuvre la logique des ¬´contrats¬ª visant √† modifier les soldes.  La t√¢che du troisi√®me service sera l'ex√©cution des contrats.  <code>VirtualMachine</code> cela <code>VirtualMachine</code> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8a2/a04/79b/8a2a0479b551df5fd2a3c46e67bb46a7.png"></div><br>  <i><font color="#999999">Architecture du serveur d'applications</font></i> <br><br>  Placez le code de ces services dans les dossiers de projet <code>/services/publicapi</code> , <code>/services/virtualmachine</code> et <code>/services/statestorage</code> . <br><br><h3>  <font color="#3AC1EF">‚ñç D√©finition claire des responsabilit√©s de service</font> </h3><br>  Lors de la mise en place des services, nous souhaitons pouvoir travailler avec chacun d'eux individuellement.  Il est m√™me possible de r√©partir le d√©veloppement de ces services entre diff√©rents programmeurs.  √âtant donn√© que les services sont interd√©pendants et que nous voulons parall√©liser leur d√©veloppement, nous devons commencer √† travailler avec une d√©finition claire des interfaces qu'ils utilisent pour interagir les uns avec les autres.  √Ä l'aide de ces interfaces, nous pouvons tester les services de mani√®re autonome en pr√©parant des talons pour tout ce qui se trouve en dehors de chacun d'eux. <br><br>  Comment d√©crire l'interface?  L'une des options est de tout documenter, mais la documentation a la propri√©t√© de devenir obsol√®te, au cours du travail sur un projet, des diff√©rences commencent √† s'accumuler entre la documentation et le code.  De plus, nous pouvons utiliser des d√©clarations d'interface Go.  C'est une option int√©ressante, mais il vaut mieux d√©crire l'interface pour que cette description ne d√©pende pas d'un langage de programmation sp√©cifique.  Cela nous sera utile dans une situation tr√®s r√©elle, si au cours du travail sur un projet, il sera d√©cid√© de mettre en ≈ìuvre certains de ses services dans d'autres langues dont les capacit√©s sont mieux adapt√©es pour r√©soudre leurs probl√®mes. <br><br>  Une option pour d√©crire les interfaces est d'utiliser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">protobuf</a> .  Il s'agit d'un langage simple et d'un protocole ind√©pendant du langage pour d√©crire les messages et les points de terminaison de service. <br><br>  Commen√ßons par l'interface du service <code>StateStorage</code> .  Nous pr√©senterons l'√©tat de l'application sous la forme d'une structure de vue cl√©-valeur.  Voici le code du fichier <code>statestorage.proto</code> : <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">syntax</span></span> = <span class="hljs-string"><span class="hljs-string">"proto3"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">package</span></span> statestorage; <span class="hljs-attribute"><span class="hljs-attribute">service</span></span> StateStorage { <span class="hljs-attribute"><span class="hljs-attribute">rpc</span></span> WriteKey (WriteKeyInput) returns (WriteKeyOutput); <span class="hljs-attribute"><span class="hljs-attribute">rpc</span></span> ReadKey (ReadKeyInput) returns (ReadKeyOutput); } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> WriteKeyInput { <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> key = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> value = <span class="hljs-number"><span class="hljs-number">2</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> WriteKeyOutput { } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> ReadKeyInput { <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> key = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> ReadKeyOutput { <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> value = <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> <br>  Bien que les clients utilisent HTTP via le service <code>PublicApi</code> , cela n'interf√®re pas non plus avec l'interface claire d√©crite par les m√™mes moyens que ci-dessus (le fichier <code>publicapi.proto</code> ): <br><br><pre> <code class="hljs pgsql">syntax = "proto3"; package publicapi; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "protocol/transactions.proto"; service PublicApi { rpc Transfer (TransferInput) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> (TransferOutput); rpc GetBalance (GetBalanceInput) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> (GetBalanceOutput); } message TransferInput { protocol.<span class="hljs-keyword"><span class="hljs-keyword">Transaction</span></span> <span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>; } message TransferOutput { string success = <span class="hljs-number"><span class="hljs-number">1</span></span>; int32 result = <span class="hljs-number"><span class="hljs-number">2</span></span>; } message GetBalanceInput { protocol.Address <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>; } message GetBalanceOutput { string success = <span class="hljs-number"><span class="hljs-number">1</span></span>; int32 result = <span class="hljs-number"><span class="hljs-number">2</span></span>; }</code> </pre> <br>  Maintenant, nous devons d√©crire les structures de donn√©es de <code>Transaction</code> et d' <code>Address</code> (fichier <code>transactions.proto</code> ): <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">syntax</span></span> = <span class="hljs-string"><span class="hljs-string">"proto3"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">package</span></span> protocol; <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> Address { <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> username = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> Transaction { <span class="hljs-attribute"><span class="hljs-attribute">Address</span></span> from = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">Address</span></span> to = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> amount = <span class="hljs-number"><span class="hljs-number">3</span></span>; }</code> </pre> <br>  Dans le projet, les proto-descriptions des services sont plac√©es dans le dossier <code>/types/services</code> et les descriptions des structures de donn√©es √† usage g√©n√©ral se trouvent dans le dossier <code>/types/protocol</code> . <br><br>  Une fois que les descriptions d'interface sont pr√™tes, elles peuvent √™tre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">compil√©es</a> en code Go. <br><br>  Les avantages de cette approche sont que le code qui ne correspond pas √† la description de l'interface n'appara√Æt tout simplement pas dans les r√©sultats de la compilation.  L'utilisation de m√©thodes alternatives nous obligerait √† √©crire des tests sp√©ciaux pour v√©rifier que le code correspond aux descriptions de l'interface. <br><br>  Les d√©finitions compl√®tes, les fichiers Go g√©n√©r√©s et les instructions de compilation peuvent √™tre trouv√©s <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> .  Ceci est possible gr√¢ce √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Square Engineering</a> et √† leur d√©veloppement de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">goprotowrap</a> . <br><br>  Veuillez noter que dans notre projet, la couche de transport RPC n'est pas impl√©ment√©e et l'√©change de donn√©es entre les services ressemble √† des appels de biblioth√®que ordinaires.  Lorsque nous sommes pr√™ts √† distribuer des services sur diff√©rents serveurs, nous pouvons ajouter une couche de transport telle que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">gRPC</a> au syst√®me. <br><br><h3>  <font color="#3AC1EF">‚ñç Types de tests utilis√©s dans le projet</font> </h3><br>  √âtant donn√© que les tests sont la cl√© d'un code hautement fiable, je sugg√®re que nous parlions d'abord des tests que nous allons √©crire pour notre projet. <br><br><h4>  Tests unitaires </h4><br>  Les tests unitaires sont au c≈ìur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">de la pyramide des tests</a> .  Nous testerons chaque module isol√©ment.  Qu'est-ce qu'un module?  Dans Go, nous pouvons percevoir les modules comme des fichiers s√©par√©s dans un package.  Par exemple, si nous avons le fichier <code>/services/publicapi/handlers.go</code> , nous <code>/services/publicapi/handlers.go</code> le test unitaire pour celui-ci dans le m√™me package √† <code>/services/publicapi/handlers_test.go</code> . <br><br>  Il est pr√©f√©rable de placer les tests unitaires dans le m√™me package que le code de test, ce qui permet aux tests d'avoir acc√®s aux variables et fonctions non export√©es. <br><br><h4>  Tests de service </h4><br>  Le type de test suivant est connu sous diff√©rents noms.  Il s'agit des tests dits de service, d'int√©gration ou de composants.  Leur essence est de prendre plusieurs modules et de tester leur travail commun.  Ces tests sont sup√©rieurs d'un niveau aux tests unitaires de la pyramide des tests.  Dans notre cas, nous utiliserons des tests d'int√©gration pour tester l'ensemble du service.  Ces tests d√©terminent les sp√©cifications du service.  Par exemple, les tests du service <code>StateStorage</code> seront plac√©s dans le dossier <code>/services/statestorage/spec</code> . <br><br>  Il est pr√©f√©rable de placer ces tests dans un package qui diff√®re de celui dans lequel se trouve le code test√© afin que l'acc√®s aux capacit√©s de ce code se fasse uniquement via des interfaces export√©es. <br><br><h4>  Tests de bout en bout </h4><br>  Ces tests sont au sommet de la pyramide des tests, avec leur aide pour v√©rifier l'ensemble du syst√®me et tous ses services sont effectu√©s.  Ces tests d√©crivent les sp√©cifications e2e de bout en bout du syst√®me, nous les <code>/e2e/spec</code> dans le <code>/e2e/spec</code> . <br><br>  Les tests de bout en bout, ainsi que les tests de service, doivent √™tre plac√©s dans un package diff√©rent de celui dans lequel se trouve le code test√© afin que le syst√®me ne puisse fonctionner que via des interfaces export√©es. <br><br>  Quels tests doivent √™tre √©crits en premier?  Commencer par la fondation de la "pyramide" et remonter?  Ou commencer par le haut et descendre?  Chacune de ces approches a droit √† la vie.  Les avantages d'une approche descendante r√©sident dans la cr√©ation de la sp√©cification d'abord pour l'ensemble du syst√®me.  Il est g√©n√©ralement plus facile de discuter au tout d√©but des travaux sur les caract√©ristiques du syst√®me dans son ensemble.  M√™me si nous divisons le syst√®me en services s√©par√©s de mani√®re incorrecte, les sp√©cifications du syst√®me resteront inchang√©es.  De plus, cela nous aidera √† comprendre que quelque chose, √† un niveau inf√©rieur, est mal fait. <br><br>  L'inconv√©nient de l'approche descendante est que les tests de bout en bout sont les tests qui sont utilis√©s apr√®s tous les autres, lorsque tout le syst√®me en cours de d√©veloppement est cr√©√©.  Cela signifie qu'ils g√©n√©reront des erreurs pendant longtemps.  Lors de la r√©daction des tests pour notre projet, nous utiliserons cette approche m√™me. <br><br><h3>  <font color="#3AC1EF">‚ñçD√©veloppement des tests</font> </h3><br><h4>  D√©veloppement de test de bout en bout </h4><br>  Avant de cr√©er des tests, nous devons d√©cider si nous allons les √©crire sans utiliser d'outils auxiliaires ou utiliser une sorte de framework.  S'appuyer sur le framework, l'utiliser comme d√©pendance de d√©veloppement, est moins dangereux que de s'appuyer sur le framework dans le code qui entre en production.  Dans notre cas, √©tant donn√© que la biblioth√®que Go standard n'a pas de prise en charge <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">BDD</a> d√©cente et que ce format est id√©al pour d√©crire les sp√©cifications, nous choisirons une option de travail qui inclut l'utilisation d'un cadre. <br><br>  Il existe de nombreux cadres formidables qui donnent ce dont nous avons besoin.  Parmi eux, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GoConvey</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ginkgo</a> . <br><br>  Personnellement, j'aime utiliser une combinaison de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ginkgo</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Gomega</a> (noms terribles, mais que faire) qui utilisent des constructions syntaxiques comme <code>Describe()</code> et <code>It()</code> . <br><br>  √Ä quoi ressembleront nos tests?  Par exemple, voici un test du m√©canisme de v√©rification du solde utilisateur (fichier <code>sanity.go</code> ): <br><br><pre> <code class="hljs go"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> spec <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _ = Describe(<span class="hljs-string"><span class="hljs-string">"Sanity"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ( node services.Node ) BeforeEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { node = services.NewNode() node.Start() }) AfterEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { node.Stop() }) It(<span class="hljs-string"><span class="hljs-string">"should show balances with GET /api/balance"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { resp, err := http.Get(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/api/balance?from=user1"</span></span>) Expect(err).ToNot(HaveOccurred()) Expect(resp.StatusCode).To(Equal(http.StatusOK)) Expect(ResponseBodyAsString(resp)).To(Equal(<span class="hljs-string"><span class="hljs-string">"0"</span></span>)) }) })</code> </pre> <br>  √âtant donn√© que le serveur est accessible depuis le monde ext√©rieur via HTTP, nous travaillerons avec son API Web en utilisant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://golang.org/pkg/net/">http.Get</a> .  Qu'en est-il des tests transactionnels?  Voici le code du test correspondant: <br><br><pre> <code class="hljs lisp">It(<span class="hljs-string"><span class="hljs-string">"should transfer funds with POST /api/transfer"</span></span>, func() { resp, err <span class="hljs-symbol"><span class="hljs-symbol">:=</span></span> http.Get(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/api/transfer?from=user1&amp;to=user2&amp;amount=17"</span></span>) Expect(<span class="hljs-name"><span class="hljs-name">err</span></span>).ToNot(<span class="hljs-name"><span class="hljs-name">HaveOccurred</span></span>()) Expect(<span class="hljs-name"><span class="hljs-name">resp</span></span>.StatusCode).To(<span class="hljs-name"><span class="hljs-name">Equal</span></span>(<span class="hljs-name"><span class="hljs-name">http</span></span>.StatusOK)) Expect(<span class="hljs-name"><span class="hljs-name">ResponseBodyAsString</span></span>(<span class="hljs-name"><span class="hljs-name">resp</span></span>)).To(<span class="hljs-name"><span class="hljs-name">Equal</span></span>(<span class="hljs-string"><span class="hljs-string">"-17"</span></span>)) resp, err = http.Post(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/api/balance?from=user2"</span></span>, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) Expect(<span class="hljs-name"><span class="hljs-name">err</span></span>).ToNot(<span class="hljs-name"><span class="hljs-name">HaveOccurred</span></span>()) Expect(<span class="hljs-name"><span class="hljs-name">resp</span></span>.StatusCode).To(<span class="hljs-name"><span class="hljs-name">Equal</span></span>(<span class="hljs-name"><span class="hljs-name">http</span></span>.StatusOK)) Expect(<span class="hljs-name"><span class="hljs-name">ResponseBodyAsString</span></span>(<span class="hljs-name"><span class="hljs-name">resp</span></span>)).To(<span class="hljs-name"><span class="hljs-name">Equal</span></span>(<span class="hljs-string"><span class="hljs-string">"17"</span></span>)) })</code> </pre><br>  Le code de test d√©crit parfaitement leur essence, il peut m√™me remplacer la documentation.  Comme vous pouvez le constater, nous admettons la pr√©sence de soldes de comptes d'utilisateurs n√©gatifs.  C'est une caract√©ristique de notre projet.  Si elle √©tait interdite, cette d√©cision serait refl√©t√©e dans le test. <br><br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Voici le</a> code de test complet <br><br><h4>  D√©veloppement de tests de service </h4><br>  Maintenant, apr√®s avoir d√©velopp√© des tests de bout en bout, nous descendons la pyramide des tests et proc√©dons √† la cr√©ation de tests de service.  Ces tests sont d√©velopp√©s pour chaque service individuel.  Nous choisissons un service qui d√©pend d'un autre service, car ce cas est plus int√©ressant que de d√©velopper des tests pour un service ind√©pendant. <br><br>  Commen√ßons par le service <code>VirtualMachine</code> .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ici</a> vous pouvez trouver l'interface avec des proto-descriptions pour ce service.  √âtant donn√© que le service <code>VirtualMachine</code> s'appuie sur le service <code>StateStorage</code> et lui fait des appels, nous devrons cr√©er un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">objet</a> <code>StateStorage</code> pour le service <code>StateStorage</code> afin de tester le service <code>VirtualMachine</code> de mani√®re isol√©e.  L'objet stub nous permet de contr√¥ler les r√©ponses <code>StateStorage</code> pendant les tests. <br><br>  Comment impl√©menter un objet stub dans Go?  Cela peut √™tre fait exclusivement au moyen du langage, sans outils auxiliaires, ou vous pouvez recourir √† la biblioth√®que appropri√©e, qui, en plus, permettra de travailler avec les instructions dans le processus de test.  √Ä cette fin, je pr√©f√®re utiliser la biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">go-mock</a> . <br><br>  Nous <code>/services/statestorage/mock.go</code> le code de <code>/services/statestorage/mock.go</code> dans le fichier <code>/services/statestorage/mock.go</code> .  Il est pr√©f√©rable de placer les objets stub au m√™me endroit que les entit√©s qu'ils imitent afin de leur donner acc√®s aux variables et fonctions non export√©es.  Le stub √† ce stade est une impl√©mentation sch√©matique du service, mais, √† mesure que le service se d√©veloppe, nous devrons peut-√™tre d√©velopper l'impl√©mentation du stub.  Voici le code de l'objet stub (fichier <code>mock.go</code> ): <br><br><pre> <code class="hljs go"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> statestorage <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> MockService <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { mock.Mock } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *MockService)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { s.Called() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *MockService)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { s.Called() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *MockService)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsStarted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bool</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> s.Called().Bool(<span class="hljs-number"><span class="hljs-number">0</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *MockService)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(input *statestorage.WriteKeyInput)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*statestorage.WriteKeyOutput, error)</span></span></span></span> { ret := s.Called(input) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret.Get(<span class="hljs-number"><span class="hljs-number">0</span></span>).(*statestorage.WriteKeyOutput), ret.Error(<span class="hljs-number"><span class="hljs-number">1</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *MockService)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(input *statestorage.ReadKeyInput)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*statestorage.ReadKeyOutput, error)</span></span></span></span> { ret := s.Called(input) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret.Get(<span class="hljs-number"><span class="hljs-number">0</span></span>).(*statestorage.ReadKeyOutput), ret.Error(<span class="hljs-number"><span class="hljs-number">1</span></span>) }</code> </pre> <br>  Si vous donnez le d√©veloppement de services individuels √† diff√©rents programmeurs, il est logique de cr√©er d'abord des talons et de les transmettre √† l'√©quipe. <br><br>  Revenons au d√©veloppement d'un test de service pour <code>VirtualMachine</code> .  Quel sc√©nario dois-je v√©rifier ici?  Il est pr√©f√©rable de se concentrer sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">l'interface de</a> service et les tests de conception pour chaque point de terminaison.  Nous impl√©mentons un test pour le point de terminaison <code>CallContract()</code> avec un argument repr√©sentant la m√©thode <code>"GetBalance"</code> .  Voici le code correspondant (fichier <code>contracts.go</code> ): <br><br><pre> <code class="hljs go"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> spec <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _ = Describe(<span class="hljs-string"><span class="hljs-string">"Contracts"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ( service uut.Service stateStorage *_statestorage.MockService ) BeforeEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { service = uut.NewService() stateStorage = &amp;_statestorage.MockService{} service.Start(stateStorage) }) AfterEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { service.Stop() }) It(<span class="hljs-string"><span class="hljs-string">"should support 'GetBalance' contract method"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { stateStorage.When(<span class="hljs-string"><span class="hljs-string">"ReadKey"</span></span>, &amp;statestorage.ReadKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user1"</span></span>}).Return(&amp;statestorage.ReadKeyOutput{Value: <span class="hljs-number"><span class="hljs-number">100</span></span>}, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>).Times(<span class="hljs-number"><span class="hljs-number">1</span></span>) addr := protocol.Address{Username: <span class="hljs-string"><span class="hljs-string">"user1"</span></span>} out, err := service.CallContract(&amp;virtualmachine.CallContractInput{Method: <span class="hljs-string"><span class="hljs-string">"GetBalance"</span></span>, Arg: &amp;addr}) Expect(err).ToNot(HaveOccurred()) Expect(out.Result).To(BeEquivalentTo(<span class="hljs-number"><span class="hljs-number">100</span></span>)) Expect(stateStorage).To(ExecuteAsPlanned()) }) })</code> </pre><br>  Veuillez noter que le service que nous testons, <code>VirtualMachine</code> , obtient un pointeur sur sa d√©pendance, <code>StateStorage</code> , dans la m√©thode <code>Start()</code> via un m√©canisme d'injection de d√©pendance simple.  C'est l√† que nous passons l'instance de l'objet stub.  <code>stateStorage.When("ReadKey", &amp;statestorage.ReadKeyInput{Key‚Ä¶</code> √©galement attention √† la ligne <code>stateStorage.When("ReadKey", &amp;statestorage.ReadKeyInput{Key‚Ä¶</code> , o√π nous indiquons √† l'objet stub comment il doit se comporter lorsqu'il y acc√®de. Lorsque la m√©thode <code>ReadKey</code> est <code>ReadKey</code> , elle doit renvoyer une valeur 100. Ensuite, dans la ligne <code>Expect(stateStorage).To(ExecuteAsPlanned())</code> , nous v√©rifions que cette commande est appel√©e exactement une fois. <br><br>  Des tests similaires deviennent des sp√©cifications pour le service.  L'ensemble complet de tests pour le service <code>VirtualMachine</code> peut √™tre trouv√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> .  Des suites de tests pour d'autres services de notre projet peuvent √™tre trouv√©es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br><h4>  D√©veloppement de tests unitaires </h4><br>  Peut-√™tre que l'impl√©mentation du contrat pour la m√©thode <code>"GetBalance"</code> est trop simple, alors parlons de l'impl√©mentation d'une m√©thode de <code>"Transfer"</code> l√©g√®rement plus complexe.  Le contrat de transfert de fonds d'un compte √† un autre repr√©sent√© par cette m√©thode doit lire les donn√©es sur les soldes de l'exp√©diteur et du destinataire des fonds, calculer les nouveaux soldes et enregistrer ce qui s'est pass√© dans l'√©tat d'application.  Le test de service pour tout cela est tr√®s similaire √† celui que nous venons de mettre en place (fichier <code>transactions.go</code> ): <br><br><pre> <code class="hljs lisp">It(<span class="hljs-string"><span class="hljs-string">"should support 'Transfer' transaction method"</span></span>, func() { stateStorage.When(<span class="hljs-string"><span class="hljs-string">"ReadKey"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">&amp;statestorage</span></span>.ReadKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user1"</span></span>}).Return(<span class="hljs-name"><span class="hljs-name">&amp;statestorage</span></span>.ReadKeyOutput{Value: <span class="hljs-number"><span class="hljs-number">100</span></span>}, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>).Times(<span class="hljs-number"><span class="hljs-number">1</span></span>) stateStorage.When(<span class="hljs-string"><span class="hljs-string">"ReadKey"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">&amp;statestorage</span></span>.ReadKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user2"</span></span>}).Return(<span class="hljs-name"><span class="hljs-name">&amp;statestorage</span></span>.ReadKeyOutput{Value: <span class="hljs-number"><span class="hljs-number">50</span></span>}, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>).Times(<span class="hljs-number"><span class="hljs-number">1</span></span>) stateStorage.When(<span class="hljs-string"><span class="hljs-string">"WriteKey"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">&amp;statestorage</span></span>.WriteKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user1"</span></span>, Value: <span class="hljs-number"><span class="hljs-number">90</span></span>}).Return(<span class="hljs-name"><span class="hljs-name">&amp;statestorage</span></span>.WriteKeyOutput{}, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>).Times(<span class="hljs-number"><span class="hljs-number">1</span></span>) stateStorage.When(<span class="hljs-string"><span class="hljs-string">"WriteKey"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">&amp;statestorage</span></span>.WriteKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user2"</span></span>, Value: <span class="hljs-number"><span class="hljs-number">60</span></span>}).Return(<span class="hljs-name"><span class="hljs-name">&amp;statestorage</span></span>.WriteKeyOutput{}, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>).Times(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-literal"><span class="hljs-literal">t</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:=</span></span> protocol.Transaction{From: <span class="hljs-symbol"><span class="hljs-symbol">&amp;protocol</span></span>.Address{Username: <span class="hljs-string"><span class="hljs-string">"user1"</span></span>}, To: <span class="hljs-symbol"><span class="hljs-symbol">&amp;protocol</span></span>.Address{Username: <span class="hljs-string"><span class="hljs-string">"user2"</span></span>}, Amount: <span class="hljs-number"><span class="hljs-number">10</span></span>} out, err <span class="hljs-symbol"><span class="hljs-symbol">:=</span></span> service.ProcessTransaction(<span class="hljs-name"><span class="hljs-name">&amp;virtualmachine</span></span>.ProcessTransactionInput{Method: <span class="hljs-string"><span class="hljs-string">"Transfer"</span></span>, Arg: <span class="hljs-symbol"><span class="hljs-symbol">&amp;t</span></span>}) Expect(<span class="hljs-name"><span class="hljs-name">err</span></span>).ToNot(<span class="hljs-name"><span class="hljs-name">HaveOccurred</span></span>()) Expect(<span class="hljs-name"><span class="hljs-name">out</span></span>.Result).To(<span class="hljs-name"><span class="hljs-name">BeEquivalentTo</span></span>(<span class="hljs-number"><span class="hljs-number">90</span></span>)) Expect(<span class="hljs-name"><span class="hljs-name">stateStorage</span></span>).To(<span class="hljs-name"><span class="hljs-name">ExecuteAsPlanned</span></span>()) })</code> </pre> <br>  Dans le processus de travail sur le projet, nous arrivons enfin √† cr√©er ses m√©canismes internes et √† cr√©er un module situ√© dans le fichier <code>processor.go</code> , qui contient la mise en ≈ìuvre du contrat.  Voici la version originale (fichier <code>processor.go</code> ): <br><br><pre> <code class="hljs go"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> virtualmachine <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *service)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processTransfer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(fromUsername </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, toUsername </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, amount </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int32</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int32</span></span></span></span><span class="hljs-function"><span class="hljs-params">, error)</span></span></span></span> { fromBalance, err := s.stateStorage.ReadKey(&amp;statestorage.ReadKeyInput{Key: fromUsername}) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, err } toBalance, err := s.stateStorage.ReadKey(&amp;statestorage.ReadKeyInput{Key: toUsername}) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, err } _, err = s.stateStorage.WriteKey(&amp;statestorage.WriteKeyInput{Key: fromUsername, Value: fromBalance.Value - amount}) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, err } _, err = s.stateStorage.WriteKey(&amp;statestorage.WriteKeyInput{Key: toUsername, Value: toBalance.Value + amount}) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, err } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fromBalance.Value - amount, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre><br>  Cette conception satisfait le test de service, mais dans notre cas, le test d'int√©gration ne contient qu'un test du sc√©nario de base.  Qu'en est-il des cas limites et des √©checs potentiels?  Comme vous pouvez le voir, l'un des appels que nous faisons √† <code>StateStorage</code> peut √©chouer.  Si une couverture √† 100% du code avec des tests est requise, nous devons v√©rifier toutes ces situations.  Le test unitaire est id√©al pour impl√©menter de tels tests. <br><br>  Comme nous allons appeler la fonction plusieurs fois avec diff√©rentes donn√©es d'entr√©e et simuler les param√®tres pour atteindre toutes les branches du code, afin de rendre ce processus plus efficace, nous pouvons recourir √† des tests bas√©s sur des tables.  Go a tendance √† √©viter les cadres de tests unitaires exotiques.  Nous pouvons refuser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ginkgo</a> , mais nous devrions probablement quitter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Gomega</a> .  Par cons√©quent, les contr√¥les effectu√©s ici seront similaires √† ceux que nous avons effectu√©s lors des tests pr√©c√©dents.  Voici le code de test (fichier <code>processor_test.go</code> ): <br><br><pre> <code class="hljs lua"><span class="hljs-built_in"><span class="hljs-built_in">package</span></span> virtualmachine import ... var transferTable = []struct{ to <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> //  ,    read1Err <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> //       read2Err <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> //       write1Err <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> //       write2Err <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> //       <span class="hljs-built_in"><span class="hljs-built_in">output</span></span> int32 //   errs bool //        }{ {<span class="hljs-string"><span class="hljs-string">"user2"</span></span>, errors.New(<span class="hljs-string"><span class="hljs-string">"a"</span></span>), <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, {<span class="hljs-string"><span class="hljs-string">"user2"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, errors.New(<span class="hljs-string"><span class="hljs-string">"a"</span></span>), <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, {<span class="hljs-string"><span class="hljs-string">"user2"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, errors.New(<span class="hljs-string"><span class="hljs-string">"a"</span></span>), <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, {<span class="hljs-string"><span class="hljs-string">"user2"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, errors.New(<span class="hljs-string"><span class="hljs-string">"a"</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, {<span class="hljs-string"><span class="hljs-string">"user2"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-number"><span class="hljs-number">90</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>}, } func TestTransfer(t *testing.T) { Œ© := NewGomegaWithT(t) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, tt := range transferTable { s := NewService() ss := &amp;_statestorage.MockService{} s.Start(ss) ss.When(<span class="hljs-string"><span class="hljs-string">"ReadKey"</span></span>, &amp;statestorage.ReadKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user1"</span></span>}).Return(&amp;statestorage.ReadKeyOutput{Value: <span class="hljs-number"><span class="hljs-number">100</span></span>}, tt.read1Err) ss.When(<span class="hljs-string"><span class="hljs-string">"ReadKey"</span></span>, &amp;statestorage.ReadKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user2"</span></span>}).Return(&amp;statestorage.ReadKeyOutput{Value: <span class="hljs-number"><span class="hljs-number">50</span></span>}, tt.read2Err) ss.When(<span class="hljs-string"><span class="hljs-string">"WriteKey"</span></span>, &amp;statestorage.WriteKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user1"</span></span>, Value: <span class="hljs-number"><span class="hljs-number">90</span></span>}).Return(&amp;statestorage.WriteKeyOutput{}, tt.write1Err) ss.When(<span class="hljs-string"><span class="hljs-string">"WriteKey"</span></span>, &amp;statestorage.WriteKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user2"</span></span>, Value: <span class="hljs-number"><span class="hljs-number">60</span></span>}).Return(&amp;statestorage.WriteKeyOutput{}, tt.write2Err) <span class="hljs-built_in"><span class="hljs-built_in">output</span></span>, err := s.(*service).processTransfer(<span class="hljs-string"><span class="hljs-string">"user1"</span></span>, tt.to, <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> tt.errs { Œ©.Expect(err).To(HaveOccurred()) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Œ©.Expect(err).ToNot(HaveOccurred()) Œ©.Expect(<span class="hljs-built_in"><span class="hljs-built_in">output</span></span>).To(BeEquivalentTo(tt.<span class="hljs-built_in"><span class="hljs-built_in">output</span></span>)) } } }</code> </pre> <br>     ¬´Œ©¬ª ‚Äî  ,    ‚Äî    (     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Gomega</a> ).          . <br><br>        ,        TDD,          ,     ,     .       <code>processTransfer()</code>         . <br><br>       <code>VirtualMachine</code>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> .       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> . <br><br>    100%   .    ,    .             . <br><br>   ,        ?   .        , ,    ,     . <br><br><h3> <font color="#3AC1EF">‚ñç  -</font> </h3><br>              .         ?  HTTP-  Go     (goroutine).     ,  ‚Äî        ,     . ,      ,  ,   . <br><br>           -               . ,   ,   ,          ,        .  -     <code>/e2e/stress</code> .   - ( <code>stress.go</code> ): <br><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> stress import ... const NUM_TRANSACTIONS = <span class="hljs-number"><span class="hljs-number">20000</span></span> const NUM_USERS = <span class="hljs-number"><span class="hljs-number">100</span></span> const TRANSACTIONS_PER_BATCH = <span class="hljs-number"><span class="hljs-number">200</span></span> const BATCHES_PER_SEC = <span class="hljs-number"><span class="hljs-number">40</span></span> var <span class="hljs-number"><span class="hljs-number">_</span></span> = Describe(<span class="hljs-string"><span class="hljs-string">"Transaction Stress Test"</span></span>, func() { var ( node services.Node ) BeforeEach(func() { node = services.NewNode() node.Start() }) AfterEach(func() { node.Stop() }) It(<span class="hljs-string"><span class="hljs-string">"should handle lots and lots of transactions"</span></span>, func() { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  HTTP-     transport := http.Transport{ IdleConnTimeout: time.Second*<span class="hljs-number"><span class="hljs-number">20</span></span>, MaxIdleConns: TRANSACTIONS_PER_BATCH*<span class="hljs-number"><span class="hljs-number">10</span></span>, MaxIdleConnsPerHost: TRANSACTIONS_PER_BATCH*<span class="hljs-number"><span class="hljs-number">10</span></span>, } client := &amp;http.Client{Transport: &amp;transport} //      ledger := <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[string]int32{} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; NUM_USERS; i++ { ledger[fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"user%d"</span></span>, i+<span class="hljs-number"><span class="hljs-number">1</span></span>)] = <span class="hljs-number"><span class="hljs-number">0</span></span> } //     HTTP   rand.Seed(<span class="hljs-number"><span class="hljs-number">42</span></span>) done := make(chan error, TRANSACTIONS_PER_BATCH) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; NUM_TRANSACTIONS / TRANSACTIONS_PER_BATCH; i++ { log.Printf(<span class="hljs-string"><span class="hljs-string">"Sending %d transactions... (batch %d out of %d)"</span></span>, TRANSACTIONS_PER_BATCH, i+<span class="hljs-number"><span class="hljs-number">1</span></span>, NUM_TRANSACTIONS / TRANSACTIONS_PER_BATCH) time.Sleep(time.Second / BATCHES_PER_SEC) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> j := <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; TRANSACTIONS_PER_BATCH; j++ { from := randomizeUser() to := randomizeUser() amount := randomizeAmount() ledger[from] -= amount ledger[to] += amount go sendTransaction(client, from, to, amount, &amp;done) } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> j := <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; TRANSACTIONS_PER_BATCH; j++ { err := &lt;- done Expect(err).ToNot(HaveOccurred()) } } //   <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; NUM_USERS; i++ { user := fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"user%d"</span></span>, i+<span class="hljs-number"><span class="hljs-number">1</span></span>) resp, err := client.Get(fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/api/balance?from=%s"</span></span>, user)) Expect(err).ToNot(HaveOccurred()) Expect(resp.StatusCode).To(Equal(http.StatusOK)) Expect(ResponseBodyAsString(resp)).To(Equal(fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"%d"</span></span>, ledger[user]))) } }) }) func randomizeUser() string { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"user%d"</span></span>, rand.Intn(NUM_USERS)+<span class="hljs-number"><span class="hljs-number">1</span></span>) } func randomizeAmount() int32 { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rand.Int31n(<span class="hljs-number"><span class="hljs-number">1000</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span> } func sendTransaction(client *http.Client, from string, to string, amount int32, done *chan error) { url := fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/api/transfer?from=%s&amp;to=%s&amp;amount=%d"</span></span>, from, to, amount) resp, err := client.Post(url, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, nil) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err == nil { ioutil.ReadAll(resp.Body) resp.Body.Close() } *done &lt;- err }</code> </pre> <br>    ,  -   .           (       <code>rand.Seed(42)</code> )  ,    .         .     ,            ,  ‚Äî ,     . <br><br>    -  HTTP   ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>          TCP- (     ,     ,           ).  ,  ,              200     <code>IdleConnection</code>    TCP-   .       ,      100. <br><br>  ‚Ä¶   : <br><br><pre> <code class="hljs go">fatal error: concurrent <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> writes goroutine <span class="hljs-number"><span class="hljs-number">539</span></span> [running]: runtime.throw(<span class="hljs-number"><span class="hljs-number">0x147bf</span></span>60, <span class="hljs-number"><span class="hljs-number">0x15</span></span>) /usr/local/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>/src/runtime/<span class="hljs-built_in"><span class="hljs-built_in">panic</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">616</span></span> +<span class="hljs-number"><span class="hljs-number">0x81</span></span> fp=<span class="hljs-number"><span class="hljs-number">0xc4207159d</span></span>8 sp=<span class="hljs-number"><span class="hljs-number">0xc4207159b8</span></span> pc=<span class="hljs-number"><span class="hljs-number">0x102ca01</span></span> runtime.mapassign_faststr(<span class="hljs-number"><span class="hljs-number">0x13f</span></span>5140, <span class="hljs-number"><span class="hljs-number">0xc4201ca0c0</span></span>, <span class="hljs-number"><span class="hljs-number">0xc4203a8097</span></span>, <span class="hljs-number"><span class="hljs-number">0x6</span></span>, <span class="hljs-number"><span class="hljs-number">0x1012001</span></span>) /usr/local/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>/src/runtime/hashmap_fast.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">703</span></span> +<span class="hljs-number"><span class="hljs-number">0x3e9</span></span> fp=<span class="hljs-number"><span class="hljs-number">0xc420715a48</span></span> sp=<span class="hljs-number"><span class="hljs-number">0xc4207159d</span></span>8 pc=<span class="hljs-number"><span class="hljs-number">0x100d</span></span>879 services/statestorage.(*service).WriteKey(<span class="hljs-number"><span class="hljs-number">0xc42000c060</span></span>, <span class="hljs-number"><span class="hljs-number">0xc4209e6800</span></span>, <span class="hljs-number"><span class="hljs-number">0xc4206491a0</span></span>, <span class="hljs-number"><span class="hljs-number">0x0</span></span>, <span class="hljs-number"><span class="hljs-number">0x0</span></span>) services/statestorage/methods.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span> +<span class="hljs-number"><span class="hljs-number">0x10c</span></span> fp=<span class="hljs-number"><span class="hljs-number">0xc420715a88</span></span> sp=<span class="hljs-number"><span class="hljs-number">0xc420715a48</span></span> pc=<span class="hljs-number"><span class="hljs-number">0x138339c</span></span> services/virtualmachine.(*service).processTransfer(<span class="hljs-number"><span class="hljs-number">0xc4201ca090</span></span>, <span class="hljs-number"><span class="hljs-number">0xc4203a8097</span></span>, <span class="hljs-number"><span class="hljs-number">0x6</span></span>, <span class="hljs-number"><span class="hljs-number">0xc4203a80a1</span></span>, <span class="hljs-number"><span class="hljs-number">0x6</span></span>, <span class="hljs-number"><span class="hljs-number">0x2a4</span></span>, <span class="hljs-number"><span class="hljs-number">0xc420715b30</span></span>, <span class="hljs-number"><span class="hljs-number">0x1012928</span></span>, <span class="hljs-number"><span class="hljs-number">0x40</span></span>) services/virtualmachine/processor.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span> +<span class="hljs-number"><span class="hljs-number">0x16e</span></span> fp=<span class="hljs-number"><span class="hljs-number">0xc420715ad</span></span>0 sp=<span class="hljs-number"><span class="hljs-number">0xc420715a88</span></span> pc=<span class="hljs-number"><span class="hljs-number">0x13840ee</span></span> services/virtualmachine.(*service).ProcessTransaction(<span class="hljs-number"><span class="hljs-number">0xc4201ca090</span></span>, <span class="hljs-number"><span class="hljs-number">0xc4209e67c0</span></span>, <span class="hljs-number"><span class="hljs-number">0x30</span></span>, <span class="hljs-number"><span class="hljs-number">0x1433660</span></span>, <span class="hljs-number"><span class="hljs-number">0x12a1d</span></span>01) Ginkgo ran <span class="hljs-number"><span class="hljs-number">1</span></span> suite in <span class="hljs-number"><span class="hljs-number">1.288879763s</span></span> Test Suite Failed</code> </pre> <br>  ?   <code>StateStorage</code>       ( <code>map</code> ),   . ,     ,            .     ,           <code>map</code>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sync.map</a> .     . <br><br>     <a href="">processTransfer()</a> .         ,   ‚Äî      .         , ,         ,        ,     .     ,          <code>processTransfer()</code> . <a href=""></a>  . <br><br>    ,   . ,    ,     . <br><br><pre> <code class="hljs go">e2e/stress/transactions.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">44</span></span> Expected &lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;: <span class="hljs-number"><span class="hljs-number">-7498</span></span> to equal &lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;: <span class="hljs-number"><span class="hljs-number">-7551</span></span> e2e/stress/transactions.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">82</span></span> ------------------------------ Ginkgo ran <span class="hljs-number"><span class="hljs-number">1</span></span> suite in <span class="hljs-number"><span class="hljs-number">5.251593179s</span></span> Test Suite Failed</code> </pre> <br>       ,    . ,   ,          ( ,           ).    ,   <a href=""></a> ,    . <br><br>  ‚Äî  .    TDD         .   ?           ,       100%?!   ,    ‚Äî      .    <code>processTransfer()</code>      ,       ,    . <br><br>             .  ,       <a href=""></a>   ,   . <a href=""></a>    . <br><br><h2>  <font color="#3AC1EF">R√©sum√©</font> </h2><br> , ,  ,     -,      ,      ,  ?     ?   ‚Äî . <br><br>       ,     -.  ,  ¬´¬ª  <code>processTransfer()</code>      .  ,  ,    <a href=""></a> .         ,   ‚Äî .    ,      -       .     ,        ,        . <br><br>     . ,         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> .  ,     <code>StateStorage</code>   <code>WriteKey</code> ,     , , ,     <code>WriteKeys</code>    ,         ,       . <br><br>   ,        :          .            ¬´ ¬ª.       -,        ,  ,     ,    ,      .   ‚Äî     .     ,   ,    ‚Äî      . <br><br>       ,       ‚Äî   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>  GitHub.          .  ,   ,    , , ,     ,      . <br><br>  <b>Chers lecteurs!</b>        ? <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr413681/">https://habr.com/ru/post/fr413681/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr413669/index.html">Samsung IT School: enseigner aux √©tudiants comment d√©velopper des applications mobiles</a></li>
<li><a href="../fr413673/index.html">Sur la question des performances des anciennes et nouvelles versions d'un n≈ìud</a></li>
<li><a href="../fr413675/index.html">Joker 2018: Club des d√©veloppeurs Java anonymes</a></li>
<li><a href="../fr413677/index.html">Lancement de ROS sur le robot auto-√©quilibrant EduMIP</a></li>
<li><a href="../fr413679/index.html">Angulaire 6. PWA. Modules de chargement paresseux. D√©ploiement automatique dans Firebase</a></li>
<li><a href="../fr413683/index.html">ILV a d√©bloqu√© 7 millions d'adresses IP. Rester verrouill√© 4 millions</a></li>
<li><a href="../fr413689/index.html">Debian + Postfix + Dovecot + Multidomain + SSL + IPv6 + OpenVPN + Multi-interfaces + SpamAssassin-learn + Bind</a></li>
<li><a href="../fr413691/index.html">Commencer</a></li>
<li><a href="../fr413693/index.html">Fait √† la main: clavier programmable pour le commerce en ligne √† faire soi-m√™me</a></li>
<li><a href="../fr413695/index.html">S√©curit√© de Messenger: pourquoi le stockage de messages sur la blockchain pourrait √™tre une bonne id√©e</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>