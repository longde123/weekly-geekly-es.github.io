<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèùÔ∏è üëãüèΩ üèª Como o framework tiOPF para delphi / lazarus funciona. Modelo de visitante üî∑ üåà ‚õ±Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Do tradutor 
 H√° duas raz√µes pelas quais eu me comprometi a traduzir v√°rios materiais sobre a estrutura desenvolvida h√° vinte anos para o ambiente de ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como o framework tiOPF para delphi / lazarus funciona. Modelo de visitante</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/441266/"><h3>  Do tradutor </h3><br>  H√° duas raz√µes pelas quais eu me comprometi a traduzir v√°rios materiais sobre a estrutura desenvolvida h√° vinte anos para o ambiente de programa√ß√£o n√£o muito popular: <br><br>  1. Alguns anos atr√°s, tendo aprendido muitas das del√≠cias de trabalhar com o Entity Framework como ORM para a plataforma .Net, procurei em v√£o an√°logos para o ambiente Lazarus e, em geral, para freepascal. <br>  Surpreendentemente, faltam boas ORMs para ela.  Tudo o que foi encontrado foi um projeto de c√≥digo aberto chamado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tiOPF</a> , desenvolvido no final dos anos 90 para o delphi, mais tarde portado para o freepascal.  No entanto, essa estrutura √© fundamentalmente diferente da apar√™ncia usual de ORMs grandes e grossas. <br><br>  N√£o h√° m√©todos visuais para projetar objetos (no Entity - modelo primeiro) e mapear objetos para campos de tabelas em um banco de dados relacional (no Entity - banco de dados primeiro) no tiOPF.  O pr√≥prio desenvolvedor posiciona esse fato como uma das defici√™ncias do projeto, no entanto, como m√©rito, ele oferece uma orienta√ß√£o completa especificamente sobre o modelo de neg√≥cios do objeto, vale apenas um c√≥digo r√≠gido ... <br><a name="habracut"></a><br>  Foi no n√≠vel do c√≥digo proposto que eu tive problemas.  Naquela √©poca, eu n√£o era muito versado nesses paradigmas e m√©todos que o desenvolvedor de framework usou na √≠ntegra e mencionou na documenta√ß√£o v√°rias vezes por par√°grafo (padr√µes de design do visitante, vinculador, observador, v√°rios n√≠veis de abstra√ß√£o para independ√™ncia do DBMS, etc. .).  Meu grande projeto de trabalho com o banco de dados da √©poca estava completamente focado nos componentes visuais do Lazarus e na maneira de trabalhar com os bancos de dados oferecidos pelo ambiente visual, como resultado, toneladas do mesmo c√≥digo: tr√™s tabelas no pr√≥prio banco de dados com quase a mesma estrutura e dados homog√™neos, tr√™s formul√°rios id√™nticos para visualiza√ß√£o, tr√™s formul√°rios id√™nticos para edi√ß√£o, tr√™s formul√°rios id√™nticos para relat√≥rios e tudo mais, desde o in√≠cio do cabe√ßalho "Como n√£o projetar software". <br><br>  Depois de ler bastante literatura sobre os princ√≠pios do design correto de bancos de dados e sistemas de informa√ß√£o, incluindo o estudo de modelos, al√©m de me familiarizar com o Entity Framework, decidi fazer uma refatora√ß√£o completa do banco de dados e do meu aplicativo.  E se eu lidei completamente com a primeira tarefa, para a implementa√ß√£o da segunda havia duas estradas indo em dire√ß√µes diferentes: ou estudasse .net, C # e o Entity Framework completamente, ou encontrasse um ORM adequado para o familiar sistema Lazarus.  Havia tamb√©m uma terceira, primeira e discreta trilha de bicicleta - escrever ORM para atender √†s suas necessidades, mas esse n√£o √© o ponto agora. <br><br>  O c√≥digo fonte da estrutura n√£o √© muito comentado, mas os desenvolvedores, no entanto, prepararam (aparentemente no per√≠odo inicial de desenvolvimento) uma certa quantidade de documenta√ß√£o.  Tudo isso, √© claro, √© de l√≠ngua inglesa e a experi√™ncia mostra que, apesar da abund√¢ncia de c√≥digos, diagramas e frases de programa√ß√£o de modelos, muitos programadores de l√≠ngua russa ainda s√£o pouco orientados na documenta√ß√£o em ingl√™s.  Nem sempre e nem todo mundo deseja treinar a capacidade de entender o texto t√©cnico em ingl√™s sem a necessidade de a mente traduzi-lo para o russo. <br><br>  Al√©m disso, a revis√£o repetida do texto para tradu√ß√£o permite que voc√™ veja o que eu perdi quando conheci a documenta√ß√£o, n√£o a compreendi completamente ou incorretamente.  Ou seja, esta √© para si uma oportunidade de aprender melhor a estrutura em estudo. <br><br>  2. Na documenta√ß√£o, o autor intencionalmente ou n√£o pula algumas partes do c√≥digo, provavelmente √≥bvias em sua opini√£o.  Devido √† limita√ß√£o de sua escrita, a documenta√ß√£o usa mecanismos e objetos desatualizados como exemplos, exclu√≠dos ou n√£o mais usados ‚Äã‚Äãem novas vers√µes da estrutura (mas eu n√£o disse que ela mesma continua se desenvolvendo?).  Al√©m disso, quando repeti os exemplos desenvolvidos, encontrei alguns erros que deveriam ser corrigidos.  Portanto, em alguns lugares me permiti n√£o apenas traduzir o texto, mas tamb√©m complement√°-lo ou revis√°-lo para que ele permane√ßa relevante, e os exemplos estavam funcionando. <br><br>  Quero come√ßar a tradu√ß√£o de materiais de um artigo de Peter Henrikson sobre a primeira ‚Äúbaleia‚Äù na qual toda a estrutura se apoia - o modelo Visitor.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Texto original publicado aqui</a> . <br><br><h2>  Modelo de visitante e tiOPF </h2><br>  O objetivo deste artigo √© apresentar o modelo Visitor, cujo uso √© um dos principais conceitos da estrutura tiOPF (TechInsite Object Persistence Framework).  Vamos considerar o problema em detalhes, depois de analisar solu√ß√µes alternativas antes de usar o Visitante.  No processo de desenvolvimento de nosso pr√≥prio conceito de visitante, enfrentaremos outro desafio: a necessidade de percorrer todos os objetos da cole√ß√£o.  Esta quest√£o tamb√©m ser√° estudada. <br><br>  A tarefa principal √© apresentar uma maneira generalizada de executar um conjunto de m√©todos relacionados em alguns objetos da cole√ß√£o.  Os m√©todos executados podem variar dependendo do estado interno dos objetos.  N√£o podemos executar m√©todos, mas podemos executar v√°rios m√©todos nos mesmos objetos. <br><br><h3>  O n√≠vel necess√°rio de treinamento </h3><br>  O leitor deve estar familiarizado com o objeto pascal e dominar os princ√≠pios b√°sicos da programa√ß√£o orientada a objetos. <br><br><h3>  Exemplo de tarefa de neg√≥cios neste artigo </h3><br>  Como exemplo, desenvolveremos um cat√°logo de endere√ßos que permite criar registros de pessoas e suas informa√ß√µes de contato.  Com o aumento das poss√≠veis formas de comunica√ß√£o entre as pessoas, o aplicativo deve permitir a flexibilidade de adicionar esses m√©todos sem processamento significativo de c√≥digo (lembro que depois de terminar de processar o c√≥digo para adicionar um n√∫mero de telefone, eu imediatamente precisava process√°-lo novamente para adicionar email).  Precisamos fornecer duas categorias de endere√ßos: real, como endere√ßo residencial, postal, comercial e eletr√¥nico: telefone fixo, fax, celular, email, site. <br><br>  No n√≠vel da apresenta√ß√£o, nosso aplicativo deve se parecer com o Explorer / Outlook, ou seja, deve-se usar componentes padr√£o, como o TreeView e o ListView.  O aplicativo deve funcionar rapidamente e n√£o dar a impress√£o de software cliente-servidor volumoso. <br><br>  Um aplicativo pode ser algo como isto: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/18a/fa8/773/18afa8773d4df14f7c08b3e4ae5ec204.png"><br><br>  No menu de contexto da √°rvore, voc√™ pode optar por adicionar / remover o contato de uma pessoa ou empresa e clicar com o bot√£o direito do mouse na lista de dados de contato para acessar sua caixa de di√°logo de edi√ß√£o, excluir ou adicionar dados. <br><br>  Os dados podem ser salvos de v√°rias formas e, no futuro, consideraremos como usar esse modelo para implementar esse recurso. <br><br><h3>  Antes de come√ßar </h3><br>  Come√ßaremos com uma cole√ß√£o simples de objetos - uma lista de pessoas que, por sua vez, t√™m duas propriedades - nome (Nome) e endere√ßo (EmailAdrs).  Para come√ßar, a lista ser√° preenchida com dados no construtor e, posteriormente, ser√° carregada de um arquivo ou banco de dados.  Obviamente, este √© um exemplo muito simplificado, mas √© suficiente para implementar completamente o modelo do Visitante. <br><br>  Crie um novo aplicativo e adicione duas classes da se√ß√£o de interface do m√≥dulo principal: TPersonList (herdado de TObjectList e requer um plug-in no m√≥dulo contnrs) e TPerson (herdado de TObject): <br><br><pre><code class="delphi hljs"><span class="hljs-title"><span class="hljs-title">TPersonList</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TObjectList)  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">;</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;  <span class="hljs-title"><span class="hljs-title">TPerson</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TObject)  <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>    FEMailAdrs: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>;    FName: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>;  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>    <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> FName <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> FName;    <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> EMailAdrs: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> FEMailAdrs <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> FEMailAdrs;  <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  No construtor TPersonList, criamos tr√™s objetos TPerson e adicionamos √† lista: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TPersonList</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lData: TPerson; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">inherited</span></span>; lData := TPerson.Create; lData.<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span> := <span class="hljs-string"><span class="hljs-string">'Malcolm Groves'</span></span>; lData.EMailAdrs := <span class="hljs-string"><span class="hljs-string">'malcolm@dontspamme.com'</span></span>;  <span class="hljs-comment"><span class="hljs-comment">// (ADUG Vice President) Add(lData); lData := TPerson.Create; lData.Name := 'Don MacRae';  // (ADUG President) lData.EMailAdrs := 'don@dontspamme.com'; Add(lData); lData := TPerson.Create; lData.Name := 'Peter Hinrichsen';  // (Yours truly) lData.EMailAdrs := 'peter_hinrichsen@dontspamme.com'; Add(lData); end;</span></span></code> </pre> <br>  Primeiro, examinaremos a lista e realizaremos duas opera√ß√µes em cada elemento da lista.  As opera√ß√µes s√£o semelhantes, mas n√£o s√£o as mesmas: uma simples chamada ShowMessage para exibir o conte√∫do das propriedades Name e EmailAdrs dos objetos TPerson.  Adicione dois bot√µes ao formul√°rio e nomeie-os da seguinte forma: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/201/819/5ce/2018195cee6acbb2348e3ceb78abeaea.png"><br><br>  No escopo preferido do seu formul√°rio, voc√™ tamb√©m deve adicionar uma propriedade (ou apenas um campo) FPersonList do tipo TPersonList (se o tipo for declarado abaixo do formul√°rio, altere a ordem ou fa√ßa uma declara√ß√£o de tipo preliminar) e chame o construtor no manipulador de eventos onCreate: <br><br><pre> <code class="delphi hljs">FPersonList := TPersonList.Create;</code> </pre> <br>  Para liberar mem√≥ria corretamente no manipulador de eventos onClose do formul√°rio, esse objeto deve ser destru√≠do: <br><br><pre> <code class="delphi hljs">FPersonList.Free.</code> </pre> <br><h3>  Etapa 1. Itera√ß√£o de c√≥digo r√≠gido </h3><br>  Para mostrar nomes de objetos TPerson, adicione o seguinte c√≥digo ao manipulador de eventos onClick do primeiro bot√£o: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Button1Click</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> FPersonList.Count - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>   ShowMessage(TPerson(FPersonList.Items[i]).<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Para o segundo bot√£o, o c√≥digo do manipulador ser√° o seguinte: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Button2Click</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> FPersonList.Count - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>   ShowMessage(TPerson(FPersonList.Items[i]).EMailAdrs); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Aqui est√£o os cardumes √≥bvios desse c√≥digo: <br><br><ul><li>  dois m√©todos que fazem quase a mesma coisa.  Toda a diferen√ßa est√° apenas no nome da propriedade do objeto que eles mostram; <br></li><li>  a itera√ß√£o ser√° tediosa, especialmente quando voc√™ for for√ßado a escrever um loop semelhante em centenas de lugares no c√≥digo; <br></li><li>  um elenco dif√≠cil para TPerson √© repleto de situa√ß√µes excepcionais.  E se houver uma inst√¢ncia de TAnimal na lista sem uma propriedade de endere√ßo?  N√£o h√° mecanismo para interromper o erro e se defender contra ele neste c√≥digo. <br></li></ul><br>  Vamos descobrir como melhorar o c√≥digo introduzindo uma abstra√ß√£o: passamos o c√≥digo do iterador para a classe pai. <br><br><h3>  Etapa 2. Abstraindo o iterador </h3><br>  Portanto, queremos mover a l√≥gica do iterador para a classe base.  O iterador da lista em si √© muito simples: <br><br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> FList.Count - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-comment"><span class="hljs-comment">// -    ‚Ä¶</span></span></code> </pre> <br>  Parece que estamos planejando usar um modelo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Iterator</a> .  No livro sobre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">padr√µes de design do Gang-of-Four</a> , √© sabido que o Iterator pode ser externo e interno.  Ao usar um iterador externo, o cliente controla explicitamente a travessia chamando o m√©todo Next (por exemplo, a enumera√ß√£o de elementos TCollection √© controlada pelos m√©todos First, Next, Last).  Usaremos o iterador interno aqui, pois √© mais f√°cil implementar a travessia de √°rvore com sua ajuda, que √© nosso objetivo.  Adicionaremos o m√©todo Iterate √† nossa classe list e passaremos um m√©todo de retorno de chamada para ele, que deve ser executado em cada elemento da lista.  O retorno de chamada no objeto pascal √© declarado como um tipo de procedimento; teremos, por exemplo, TDoSomethingToAPerson. <br><br>  Portanto, declaramos um tipo de procedimento TDoSomethingToAPerson, que aceita um par√¢metro do tipo TPerson.  O tipo de procedimento permite usar o m√©todo como par√¢metro de outro m√©todo, ou seja, implementar retorno de chamada.  Dessa maneira, criaremos dois m√©todos, um dos quais mostrar√° a propriedade Name do objeto e o outro - a propriedade EmailAdrs, e eles mesmos ser√£o passados ‚Äã‚Äãcomo par√¢metro ao iterador geral.  Por fim, a se√ß√£o de declara√ß√£o de tipo deve ficar assim: <br><br><pre> <code class="delphi hljs"><span class="hljs-comment"><span class="hljs-comment">{ TPerson }</span></span> <span class="hljs-title"><span class="hljs-title">TPerson</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TObject) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>   FEMailAdrs: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>;   FName: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> FName <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> FName;   <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> EMailAdrs: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> FEMailAdrs <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> FEMailAdrs; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; TDoSomethingToAPerson = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pData: TPerson)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">of</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">object</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-comment"><span class="hljs-comment">{ TPersonList }</span></span> <span class="hljs-title"><span class="hljs-title">TPersonList</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TObjectList) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">;</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoSomething</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pMethod: TDoSomethingToAPerson)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;   DoSomething: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TPersonList</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoSomething</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pMethod: TDoSomethingToAPerson)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Count - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>   pMethod(TPerson(Items[i])); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Agora, para executar as a√ß√µes necess√°rias nos itens da lista, precisamos fazer duas coisas.  Primeiro, defina as opera√ß√µes necess√°rias usando m√©todos que possuem a assinatura especificada por TDoSomethingToAPerson e, em segundo lugar, escreva chamadas DoSomething com os ponteiros para esses m√©todos passados ‚Äã‚Äãcomo par√¢metro.  Na se√ß√£o de descri√ß√£o do formul√°rio, adicione duas declara√ß√µes: <br><br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span>   FPersonList: TPersonList;   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoShowName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pData: TPerson)</span></span></span><span class="hljs-function">;</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoShowEmail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pData: TPerson)</span></span></span><span class="hljs-function">;</span></span></code> </pre> <br>  Na implementa√ß√£o desses m√©todos, indicamos: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoShowName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pData: TPerson)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ShowMessage(pData.<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoShowEmail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pData: TPerson)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ShowMessage(pData.EMailAdrs); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  O c√≥digo para manipuladores de bot√£o √© alterado da seguinte maneira: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Button1Click</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> FPersonList.DoSomething(@DoShowName); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Button2Click</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> FPersonList.DoSomething(@DoShowEmail); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  J√° est√° melhor.  Agora temos tr√™s n√≠veis de abstra√ß√£o em nosso c√≥digo.  Um iterador geral √© um m√©todo de uma classe que implementa uma cole√ß√£o de objetos.  A l√≥gica de neg√≥cios (at√© agora apenas a sa√≠da de mensagens sem fim atrav√©s do ShowMessage) √© colocada separadamente.  No n√≠vel da apresenta√ß√£o (interface gr√°fica), a l√≥gica de neg√≥cios √© chamada em uma linha. <br><br>  √â f√°cil imaginar como uma chamada para ShowMessage pode ser substitu√≠da por c√≥digo que salva nossos dados do TPerson em um banco de dados relacional usando a consulta SQL do objeto TQuery.  Por exemplo, assim: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SavePerson</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pData: TPerson)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lQuery: TQuery; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> lQuery := TQuery.Create(<span class="hljs-keyword"><span class="hljs-keyword">nil</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>   lQuery.SQL.Text := <span class="hljs-string"><span class="hljs-string">'insert into people values (:Name, :EMailAdrs)'</span></span>;   lQuery.ParamByName(<span class="hljs-string"><span class="hljs-string">'Name'</span></span>).AsString := pData.<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>;   lQuery.ParamByName(<span class="hljs-string"><span class="hljs-string">'EMailAdrs'</span></span>).AsString := pData.EMailAdrs;   lQuery.Datababase := gAppDatabase;   lQuery.ExecSQL; <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>   lQuery.Free; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  A prop√≥sito, isso introduz um novo problema de manuten√ß√£o de uma conex√£o com o banco de dados.  Em nossa solicita√ß√£o, a conex√£o com o banco de dados √© realizada atrav√©s de algum objeto global gAppDatabase.  Mas onde ser√° localizado e como trabalhar?  Al√©m disso, somos atormentados em cada etapa do iterador para criar objetos TQuery, configurar a conex√£o, executar a consulta e n√£o se esque√ßa de liberar a mem√≥ria.  Seria melhor agrupar esse c√≥digo em uma classe que encapsule a l√≥gica da cria√ß√£o e execu√ß√£o de consultas SQL, al√©m de configurar e manter uma conex√£o com o banco de dados. <br><br><h3>  Etapa 3. Passando um objeto em vez de passar um ponteiro para um retorno de chamada </h3><br>  Passar o objeto para o m√©todo iterador da classe base resolver√° o problema da manuten√ß√£o do estado.  Criaremos uma classe Visitor abstrata TPersonVisitor com um √∫nico m√©todo Execute e passaremos o objeto para esse m√©todo como par√¢metro.  A interface abstrata do visitante √© apresentada abaixo: <br><br><pre> <code class="delphi hljs">  <span class="hljs-title"><span class="hljs-title">TPersonVisitor</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TObject) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pPerson: TPerson)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Em seguida, adicione o m√©todo Iterate √† nossa classe TPersonList: <br><br><pre> <code class="delphi hljs"><span class="hljs-title"><span class="hljs-title">TPersonList</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TObjectList) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">;</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Iterate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisitor: TPersonVisitor)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  A implementa√ß√£o deste m√©todo ser√° a seguinte: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TPersonList</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Iterate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisitor: TPersonVisitor)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Count - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>   pVisitor.Execute(TPerson(Items[i])); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Um objeto do Visitor implementado da classe TPersonVisitor √© passado para o m√©todo Iterate e, ao enumerar itens da lista para cada um deles, o Visitor especificado (seu m√©todo de execu√ß√£o) √© chamado com a inst√¢ncia TPerson como par√¢metro. <br><br>  Vamos criar duas implementa√ß√µes do Visitor - TShowNameVisitor e TShowEmailVistor, que realizar√£o o trabalho necess√°rio.  Veja como reabastecer a se√ß√£o de interfaces do m√≥dulo: <br><br><pre> <code class="delphi hljs"><span class="hljs-comment"><span class="hljs-comment">{ TShowNameVisitor }</span></span> <span class="hljs-title"><span class="hljs-title">TShowNameVisitor</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TPersonVisitor) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pPerson: TPerson)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-comment"><span class="hljs-comment">{ TShowEmailVisitor }</span></span> <span class="hljs-title"><span class="hljs-title">TShowEmailVisitor</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TPersonVisitor) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pPerson: TPerson)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Por uma quest√£o de simplicidade, a implementa√ß√£o dos m√©todos de execu√ß√£o neles ainda ser√° uma √∫nica linha - ShowMessage (pPerson.Name) e ShowMessage (pPerson.EMailAdrs). <br><br>  E altere o c√≥digo para os manipuladores de cliques do bot√£o: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Button1Click</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lVis: TPersonVisitor; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> lVis := TShowNameVisitor.Create; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>   FPersonList.Iterate(lVis); <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>   lVis.Free; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Button2Click</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lVis: TPersonVisitor; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> lVis := TShowEmailVisitor.Create; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>   FPersonList.Iterate(lVis); <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>   lVis.Free; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Agora, tendo resolvido um problema, criamos outro para n√≥s mesmos.  A l√≥gica do iterador √© encapsulada em uma classe separada;  as opera√ß√µes executadas durante a itera√ß√£o s√£o agrupadas em objetos, o que nos permite salvar algumas informa√ß√µes sobre o estado, mas o tamanho do c√≥digo aumentou de uma linha (FPersonList.DoSomething (@DoShowName)) para nove linhas para cada manipulador de bot√£o. Agora, isso nos ajudar√° - este √© o Visitor Manager, que cuidar√° da cria√ß√£o e libera√ß√£o de suas c√≥pias.Potencialmente, podemos fornecer v√°rias opera√ß√µes com objetos a serem executados durante a itera√ß√£o; para isso, o Visitor Manager armazenar√° sua lista e passar√° a cada etapa, voc√™  . Olnyaya √∫nica opera√ß√µes seleccionadas seguinte ir√° demonstrar claramente os benef√≠cios desta abordagem, vamos usar os visitantes para salvar os dados em um banco de dados relacional como um dado simples poupan√ßa opera√ß√£o pode ser realizada por tr√™s operadores diferentes SQL: criar, apagar e o UPDATE. <br><br><h3>  Etapa 4. Encapsulamento adicional do visitante </h3><br>  Antes de prosseguir, precisamos encapsular a l√≥gica do trabalho do Visitante, separando-a da l√≥gica comercial do aplicativo para que ele n√£o retorne a ele.  Ser√£o necess√°rios tr√™s etapas para fazer isso: criar as classes base TVisited e TVisitor, depois as classes base para o objeto de neg√≥cios e a cole√ß√£o de objetos de neg√≥cios e ajustar ligeiramente nossas classes espec√≠ficas TPerson e TPersonList (ou TPeople) para que se tornem herdeiros da base criada. aulas.  Em termos gerais, a estrutura das classes corresponder√° a esse diagrama: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8bb/f5e/b62/8bbf5eb6201de628050d085c061fe800.png"><br><br>  O objeto TVisitor implementa dois m√©todos: a fun√ß√£o AcceptVisitor e o procedimento Execute, nos quais o objeto do tipo TVisited √© passado.  O objeto TVisited, por sua vez, implementa o m√©todo Iterate com um par√¢metro do tipo TVisitor.  Ou seja, TVisited.Iterate deve chamar o m√©todo Execute no objeto TVisitor transferido, enviando um link para sua pr√≥pria inst√¢ncia como par√¢metro e, se a inst√¢ncia for uma cole√ß√£o, o m√©todo Execute ser√° chamado para cada elemento da cole√ß√£o.  A fun√ß√£o AcceptVisitor √© necess√°ria, pois estamos desenvolvendo um sistema generalizado.  Ser√° poss√≠vel passar para o Visitor, que opera apenas com os tipos TPerson, uma inst√¢ncia da classe TDog, por exemplo, e deve haver um mecanismo para evitar exce√ß√µes e erros de acesso devido √† incompatibilidade de tipos.  A classe TVisited √© descendente da classe TPersistent, j√° que um pouco mais tarde precisaremos implementar fun√ß√µes relacionadas ao uso do RTTI. <br><br>  A parte da interface do m√≥dulo agora ser√° assim: <br><br><pre> <code class="delphi hljs">TVisited = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; <span class="hljs-comment"><span class="hljs-comment">{ TVisitor }</span></span> <span class="hljs-title"><span class="hljs-title">TVisitor</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TObject) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AcceptVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisited: TVisited)</span></span></span><span class="hljs-function">:</span></span> boolean; <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisited: TVisited)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-comment"><span class="hljs-comment">{ TVisited }</span></span> <span class="hljs-title"><span class="hljs-title">TVisited</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TPersistent) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Iterate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisitor: TVisitor)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Os m√©todos da classe abstrata TVisitor ser√£o implementados pelos herdeiros, e a implementa√ß√£o geral do m√©todo Iterate para TVisited √© fornecida abaixo: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TVisited</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Iterate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisitor: TVisitor)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> pVisitor.Execute(self); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Ao mesmo tempo, o m√©todo √© declarado virtual para a possibilidade de sua substitui√ß√£o nos herdeiros. <br><br><h3>  Etapa 5. Crie um objeto de neg√≥cios e uma cole√ß√£o compartilhados </h3><br>  Nossa estrutura precisa de mais duas classes base: para definir um objeto de neg√≥cios e uma cole√ß√£o desses objetos.  Chame-os de TtiObject e TtiObjectList.  A interface do primeiro deles: <br><br><pre> <code class="delphi hljs"><span class="hljs-title"><span class="hljs-title">TtiObject</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TVisited) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Posteriormente no processo de desenvolvimento, complicaremos essa classe, mas para a tarefa atual, apenas um construtor virtual com a possibilidade de substitu√≠-la nos herdeiros √© suficiente. <br><br>  Planejamos gerar a classe TtiObjectList da TVisited para usar o comportamento em m√©todos que j√° foram implementados pelo ancestral (tamb√©m existem outros motivos para essa heran√ßa que ser√£o discutidos em seu lugar).  Al√©m disso, nada pro√≠be o uso de <abbr title="O autor n√£o implementou a pe√ßa com interfaces no manual, porque O artigo foi escrito nos anos 90 e o mod para seu uso no freepascal ainda n√£o chegou.">interfaces</abbr> (interfaces) em vez de classes abstratas. <br><br>  A parte da interface da classe TtiObjectList ser√° a seguinte: <br><br><pre> <code class="delphi hljs"><span class="hljs-title"><span class="hljs-title">TtiObjectList</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TtiObject) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>   FList: TObjectList; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>;   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">destructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Destroy</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>;   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Clear</span></span></span><span class="hljs-function">;</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Iterate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisitor: TVisitor)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>;   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pData: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Como voc√™ pode ver, o pr√≥prio cont√™iner com os elementos do objeto est√° localizado na se√ß√£o protegida e n√£o estar√° dispon√≠vel para os clientes desta classe.  A parte mais importante da classe √© a implementa√ß√£o do m√©todo Iterate substitu√≠do.  Se na classe base o m√©todo simplesmente chamado pVisitor.Execute (self), aqui a implementa√ß√£o est√° conectada √† enumera√ß√£o da lista: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TtiObjectList</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Iterate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisitor: TVisitor)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">inherited</span></span> Iterate(pVisitor); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> FList.Count - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>   (FList.Items[i] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TVisited).Iterate(pVisitor); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  A implementa√ß√£o de outros m√©todos de classe leva uma linha de c√≥digo sem levar em considera√ß√£o as express√µes herdadas colocadas automaticamente: <br><br><pre> <code class="delphi hljs">Create: FList := TObjectList.Create; Destroy: FList.Free; Clear: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Assigned(FList) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> FList.Clear; Add: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Assigned(FList) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> FList.Add(pData);</code> </pre> <br>  Esta √© uma parte importante de todo o sistema.  Temos duas classes b√°sicas de l√≥gica de neg√≥cios: TtiObject e TtiObjectList.  Ambos t√™m um m√©todo Iterate para o qual uma inst√¢ncia da classe TVisited √© passada.  O pr√≥prio iterador chama o m√©todo Execute da classe TVisitor e passa uma refer√™ncia ao pr√≥prio objeto.  Essa chamada √© predefinida no comportamento da classe no n√≠vel superior de heran√ßa.  Para uma classe de cont√™iner, cada objeto armazenado na lista tamb√©m possui seu m√©todo Iterate, chamado com um par√¢metro do tipo TVisitor, ou seja, √© garantido que cada Visitante espec√≠fico ignore todos os objetos armazenados na lista, bem como a pr√≥pria lista como um objeto de cont√™iner. <br><br><h3>  Etapa 6. Criando um Gerenciador de Visitantes </h3><br>  Ent√£o, voltando ao problema que n√≥s mesmos desenhamos no terceiro passo.  Como n√£o queremos criar e destruir c√≥pias de visitantes sempre, o desenvolvimento do gerente ser√° a solu√ß√£o.  Ele deve executar duas tarefas principais: gerenciar a lista de Visitantes (que s√£o registrados como tal na se√ß√£o de inicializa√ß√£o de m√≥dulos individuais) e execut√°-los quando receberem o comando apropriado do cliente. <br>  Para implementar o gerenciador, suplementaremos nosso m√≥dulo com tr√™s classes adicionais: TVisClassRef, TVisMapping e TtiVisitorManager. <br><br><pre> <code class="delphi hljs">TVisClassRef = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> TVisitor;</code> </pre> <br>  TVisClassRef √© um tipo de refer√™ncia e indica o nome de uma classe espec√≠fica - um descendente do TVisitor.  O significado de usar um tipo de refer√™ncia √© o seguinte: quando o m√©todo Execute base com uma assinatura √© chamado <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pData: TVisited; </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pVisClass: TVisClassRef)</span></span></span><span class="hljs-function">,</span></span></code> </pre> <br>  internamente, esse m√©todo pode usar uma express√£o como lVisitor: = pVisClass.Create para criar uma inst√¢ncia de um Visitante espec√≠fico, sem conhecer seu tipo inicialmente.  Ou seja, qualquer classe - um descendente do TVisitor pode ser criado dinamicamente dentro do mesmo m√©todo Execute ao passar o nome de sua classe como par√¢metro. <br><br>  A segunda classe, TVisMapping, √© uma estrutura de dados simples com duas propriedades: uma refer√™ncia ao tipo TVisClassRef e uma propriedade de cadeia Command.  √â necess√°ria uma classe para comparar as opera√ß√µes executadas pelo nome (um comando, por exemplo, "save") e a classe Visitor, que esses comandos executam.  Adicione seu c√≥digo ao projeto: <br><br><pre> <code class="delphi hljs"><span class="hljs-title"><span class="hljs-title">TVisMapping</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TObject) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>   FCommand: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>;   FVisitorClass: TVisClassRef; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> VisitorClass: TVisClassRef <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> FVisitorClass <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> FVisitorClass;   <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> Command: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> FCommand <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> FCommand; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  E a √∫ltima classe √© TtiVisitorManager.  Quando registramos o Visitor usando o Manager, uma inst√¢ncia da classe TVisMapping √© criada, que √© inserida na lista Manager. <br>  Assim, no Gerenciador, √© criada uma lista de Visitantes com um comando de sequ√™ncia correspondente, ap√≥s o recebimento do qual eles ser√£o executados.  A interface da classe √© adicionada ao m√≥dulo: <br><br><pre> <code class="delphi hljs"><span class="hljs-title"><span class="hljs-title">TtiVisitorManager</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TObject) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>   FList: TObjectList; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">;</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">destructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Destroy</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>;   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RegisterVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pCommand: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">; pVisitorClass: TVisClassRef)</span></span></span><span class="hljs-function">;</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pCommand: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">; pData: TVisited)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Seus principais m√©todos s√£o RegisterVisitor e Execute.  O primeiro √© normalmente chamado na se√ß√£o de inicializa√ß√£o do m√≥dulo, que descreve a classe Visitor, e se parece com isso: <br><br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">initialization</span></span>  gTIOPFManager.VisitorManager.RegisterVisitor(<span class="hljs-string"><span class="hljs-string">'show'</span></span>, TShowNameVisitor);  gTIOPFManager.VisitorManager.RegisterVisitor(<span class="hljs-string"><span class="hljs-string">'show'</span></span>, TShowEMailAdrsVisitor);</code> </pre> <br>  O c√≥digo do m√©todo em si ser√° o seguinte: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TtiVisitorManager</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RegisterVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pCommand: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">; pVisitorClass: TVisClassRef)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lData: TVisMapping; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> lData := TVisMapping.Create; lData.Command := pCommand; lData.VisitorClass := pVisitorClass; FList.Add(lData); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  N√£o √© dif√≠cil perceber que esse c√≥digo √© muito semelhante √† implementa√ß√£o do modelo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Factory</a> do Pascal. <br><br>  Outro m√©todo Execute importante aceita dois par√¢metros: o comando pelo qual o Visitante ou seu grupo a ser identificado ser√° identificado, bem como o objeto de dados cujo m√©todo Iterate ser√° chamado com um link para a inst√¢ncia do Visitante desejado.  O c√≥digo completo para o m√©todo Execute √© fornecido abaixo: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TtiVisitorManager</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pCommand: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">; pData: TVisited)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: integer; lVisitor: TVisitor; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> FList.Count - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> SameText(pCommand, TVisMapping(FList.Items[i]).Command) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>     lVisitor := TVisMapping(FList.Items[i]).VisitorClass.Create;     <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>       pData.Iterate(lVisitor);     <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>       lVisitor.Free;     <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;   <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Portanto, para executar dois visitantes registrados anteriormente com uma equipe, precisamos de apenas uma linha de c√≥digo: <br><br><pre> <code class="delphi hljs">gTIOPFManager.VisitorManager.Execute(<span class="hljs-string"><span class="hljs-string">'show'</span></span>, FPeople);</code> </pre> <br>  Em seguida, suplementaremos nosso projeto para que voc√™ possa chamar comandos semelhantes: <br><br><pre> <code class="delphi hljs"><span class="hljs-comment"><span class="hljs-comment">//      gTIOPFManager.VisitorManager.Execute('read', FPeople); //      gTIOPFManager.VisitorManager.Execute('save', FPeople).</span></span></code> </pre> <br><h3>  Etapa 7. Ajustando classes de l√≥gica de neg√≥cios </h3><br>  Adicionar o ancestral das classes TtiObject e TtiObjectList para nossos objetos de neg√≥cios TPerson e TPeople nos permitir√° encapsular a l√≥gica do iterador na classe base e n√£o toc√°-la mais, al√©m disso, torna-se poss√≠vel transferir objetos com dados para o Visitor Manager. <br><br>  A nova declara√ß√£o de classe de cont√™iner ter√° a seguinte apar√™ncia: <br><br><pre> <code class="delphi hljs"><span class="hljs-title"><span class="hljs-title">TPeople</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TtiObjectList);</code> </pre> <br>  De fato, a classe TPeople nem precisa implementar nada.  Teoricamente, poder√≠amos ficar sem uma declara√ß√£o TPeople e armazenar objetos em uma inst√¢ncia da classe TtiObjectList, mas como planejamos escrever Visitors processando apenas inst√¢ncias TPeople, precisamos dessa classe.  Na fun√ß√£o AcceptVisitor, as seguintes verifica√ß√µes ser√£o realizadas: <br><br><pre> <code class="delphi hljs">Result := pVisited <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> TPeople.</code> </pre> <br>  Para a classe TPerson, adicionamos o ancestral TtiObject e movemos as duas propriedades existentes para o escopo publicado, pois no futuro precisaremos trabalhar com o RTTI com essas propriedades.  √â isso muito mais tarde que reduzir√° significativamente o c√≥digo envolvido no mapeamento de objetos e registros em um banco de dados relacional: <br><br><pre> <code class="delphi hljs"><span class="hljs-title"><span class="hljs-title">TPerson</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TtiObject) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>   FEMailAdrs: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>;   FName: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">published</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> FName <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> FName;   <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> EMailAdrs: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> FEMailAdrs <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> FEMailAdrs; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br><h3>  Etapa 8. Crie uma visualiza√ß√£o de prot√≥tipo </h3><br>  <b><i>Observa√ß√£o</i></b> .  No artigo original, a GUI foi baseada nos componentes que o autor do tiOPF criou para a conveni√™ncia de trabalhar com sua estrutura no delphi.  Estes eram an√°logos dos componentes do DB Aware, que eram controles padr√£o, como r√≥tulos, campos de entrada, caixas de sele√ß√£o, listas etc., mas estavam associados a determinadas propriedades dos objetos tiObject da mesma maneira que os componentes de exibi√ß√£o de dados estavam associados a campos nas tabelas do banco de dados.  Com o tempo, o autor da estrutura marcou os pacotes com esses componentes visuais como obsoletos e indesej√°veis ‚Äã‚Äãde usar.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em troca, ele sugere criar um link entre componentes visuais e propriedades de classe usando o padr√£o de design do Mediador. </font><font style="vertical-align: inherit;">Este modelo √© o segundo mais importante em toda a arquitetura da estrutura. </font><font style="vertical-align: inherit;">A descri√ß√£o do intermedi√°rio pelo autor √© coberta por um artigo separado, compar√°vel em volume a este manual, portanto, ofere√ßo minha vers√£o simplificada aqui como uma GUI. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Renomeie o bot√£o 1 no formul√°rio do projeto para "show command" e o bot√£o 2 deixa-o sem manipulador por enquanto ou nomeie-o imediatamente "save command". </font><font style="vertical-align: inherit;">Jogue um componente de memorando no formul√°rio e coloque todos os elementos ao seu gosto. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adicione uma classe Visitor que implementar√° o comando show: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interface -</font></font><br><br><pre> <code class="delphi hljs"><span class="hljs-title"><span class="hljs-title">TShowVisitor</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TVisitor) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AcceptVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisited: TVisited)</span></span></span><span class="hljs-function">:</span></span> boolean; <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisited: TVisited)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> E a implementa√ß√£o √© - </font></font><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TShowVisitor</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AcceptVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisited: TVisited)</span></span></span><span class="hljs-function">:</span></span> boolean; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := (pVisited <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> TPerson); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TShowVisitor</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisited: TVisited)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> AcceptVisitor(pVisited) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; Form1.Memo1.Lines.Add(TPerson(pVisited).<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span> + <span class="hljs-string"><span class="hljs-string">': '</span></span> + TPerson(pVisited).EMailAdrs); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AcceptVisitor verifica se o objeto que est√° sendo transferido √© uma inst√¢ncia de TPerson, porque o Visitante deve executar apenas o comando com esses objetos. Se o tipo corresponder, o comando ser√° executado e uma linha com propriedades do objeto ser√° adicionada ao campo de texto. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As a√ß√µes de suporte para a integridade do c√≥digo ser√£o as seguintes. Adicione duas propriedades √† descri√ß√£o do pr√≥prio formul√°rio na se√ß√£o particular: FPeople do tipo TPeople e VM do tipo TtiVisitorManager. No manipulador de eventos de cria√ß√£o de formul√°rios, precisamos iniciar essas propriedades, al√©m de registrar o Visitor com o comando "show":</font></font><br><br><pre> <code class="delphi hljs">FPeople := TPeople.Create; FillPeople; VM := TtiVisitorManager.Create; VM.RegisterVisitor(<span class="hljs-string"><span class="hljs-string">'show'</span></span>,TShowVisitor);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O FilPeople tamb√©m √© um procedimento auxiliar que preenche uma lista com tr√™s objetos; seu c√≥digo √© obtido do construtor de lista anterior. </font><font style="vertical-align: inherit;">N√£o se esque√ßa de destruir todos os objetos criados. </font><font style="vertical-align: inherit;">Nesse caso, escrevemos FPeople.Free e VM.Free no manipulador de fechamento de formul√°rio. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E agora - bams! </font><font style="vertical-align: inherit;">- manipulador do primeiro bot√£o:</font></font><br><br><pre> <code class="delphi hljs">Memo1.Clear; VM.Execute(<span class="hljs-string"><span class="hljs-string">'show'</span></span>,FPeople);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Concordo, muito mais divertido. </font><font style="vertical-align: inherit;">E n√£o jure pelo hash de todas as classes em um m√≥dulo. </font><font style="vertical-align: inherit;">No final do manual, coletaremos esses escombros.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Etapa 9. A classe base do Visitor que trabalha com arquivos de texto </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nesta fase, criaremos a classe base do Visitante que sabe trabalhar com arquivos de texto. Existem tr√™s maneiras de trabalhar com arquivos no objeto pascal: procedimentos antigos a partir do primeiro pascal (como AssignFile e ReadLn), trabalhar com fluxos (TStringStream ou TFileStream) e usar o objeto TStringList.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se o primeiro m√©todo estiver muito desatualizado, o segundo e o terceiro ser√£o uma boa alternativa baseada no POO. </font><font style="vertical-align: inherit;">Ao mesmo tempo, trabalhar com fluxos fornece benef√≠cios adicionais, como a capacidade de compactar e criptografar dados, mas a leitura e grava√ß√£o linha a linha em um fluxo √© um tipo de redund√¢ncia em nosso exemplo. </font><font style="vertical-align: inherit;">Para simplificar, escolheremos um TStringList, que possui dois m√©todos simples - LoadFromFile e SaveToFile. </font><font style="vertical-align: inherit;">Mas lembre-se de que, com arquivos grandes, esses m√©todos ficam significativamente mais lentos, portanto o fluxo ser√° a escolha ideal para eles. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interface da classe base TVisFile:</font></font><br><br><pre> <code class="delphi hljs"><span class="hljs-title"><span class="hljs-title">TVisFile</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TVisitor) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>   FList: TStringList;   FFileName: TFileName; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>;   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">destructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Destroy</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> E a implementa√ß√£o do construtor e destruidor: </font></font><br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TVisFile</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">inherited</span></span> Create; FList := TStringList.Create; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> FileExists(FFileName) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span>   FList.LoadFromFile(FFileName); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">destructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TVisFile</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Destroy</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> FList.SaveToFile(FFileName); FList.Free; <span class="hljs-keyword"><span class="hljs-keyword">inherited</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O valor da propriedade FFileName ser√° atribu√≠do nos construtores dos descendentes dessa classe base (apenas n√£o use o c√≥digo r√≠gido, que iremos organizar aqui, como o principal estilo de programa√ß√£o depois!). </font><font style="vertical-align: inherit;">O diagrama das classes Visitor que trabalham com arquivos √© o seguinte: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/717/969/104/717969104d4b13d73ba1844fe0c2ddf9.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De acordo com o diagrama abaixo, criamos dois descendentes da classe base TVisFile: TVisTXTFile e TVisCSVFile. </font><font style="vertical-align: inherit;">Um trabalhar√° com arquivos * .csv nos quais os campos de dados s√£o separados por um s√≠mbolo (v√≠rgula), o segundo - com arquivos de texto nos quais os campos de dados individuais ter√£o um comprimento fixo em uma linha. </font><font style="vertical-align: inherit;">Para essas classes, redefinimos apenas os construtores da seguinte maneira:</font></font><br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TVisCSVFile</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> FFileName := <span class="hljs-string"><span class="hljs-string">'contacts.csv'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">inherited</span></span> Create; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TVisTXTFile</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> FFileName := <span class="hljs-string"><span class="hljs-string">'contacts.txt'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">inherited</span></span> Create; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>.</code> </pre> <br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Etapa 10. Adicione o manipulador de visitantes de arquivos de texto </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqui vamos adicionar dois visitantes espec√≠ficos, um ler√° um arquivo de texto e o segundo escrever√° nele. </font><font style="vertical-align: inherit;">O visitante de leitura deve substituir os m√©todos da classe base AcceptVisitor e Execute. </font><font style="vertical-align: inherit;">AcceptVisitor verifica se o objeto da classe TPeople √© passado para o Visitor:</font></font><br><br><pre> <code class="delphi hljs">Result := pVisited <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> TPeople;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A implementa√ß√£o de execu√ß√£o √© a seguinte: </font></font><br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TVisTXtRead</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisited: TVisited)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: integer; lData: TPerson; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> AcceptVisitor(pVisited) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">Exit</span></span>; <span class="hljs-comment"><span class="hljs-comment">//==&gt; TPeople(pVisited).Clear; for i := 0 to FList.Count - 1 do begin   lData := TPerson.Create;   lData.Name := Trim(Copy(FList.Strings[i], 1, 20));   lData.EMailAdrs := Trim(Copy(FList.Strings[i], 21, 80));   TPeople(pVisited).Add(lData); end; end;</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O visitante limpa primeiro a lista do objeto TPeople passado a ele pelo par√¢metro, depois l√™ as linhas de seu objeto TStringList, nas quais o conte√∫do do arquivo √© carregado, cria um objeto TPerson em cada linha e o adiciona √† lista de cont√™ineres TPeople. </font><font style="vertical-align: inherit;">Para simplificar, as propriedades name e emailadrs no arquivo de texto s√£o separadas por espa√ßos.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O visitante do registro implementa a opera√ß√£o inversa. Seu construtor (substitu√≠do) limpa a TStringList interna (ou seja, executa a opera√ß√£o FList.Clear; √© obrigat√≥ria ap√≥s a heran√ßa), AcceptVisitor verifica se o objeto da classe TPerson foi passado, o que n√£o √© um erro, mas uma diferen√ßa importante do mesmo m√©todo de leitura do Visitor. Parece mais f√°cil implementar a grava√ß√£o da mesma maneira - verifique todos os objetos do cont√™iner, adicione-os a um StringList e salve-o em um arquivo. Tudo isso foi assim, se realmente est√°vamos falando sobre a grava√ß√£o final dos dados em um arquivo, no entanto, planejamos mapear dados para um banco de dados relacional, isso deve ser lembrado. E, neste caso, devemos executar o c√≥digo SQL apenas para os objetos que foram alterados (criados, exclu√≠dos ou editados). √â por isso que antes que o Visitante execute uma opera√ß√£o no objeto,ele deve verificar a correspond√™ncia de seu tipo:</font></font><br><br><pre> <code class="delphi hljs">Result := pVisited <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Tperson;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O m√©todo execute simplesmente adiciona ao StringList interno uma string formatada com a regra especificada: primeiro, o conte√∫do da propriedade name do objeto passado, preenchido com espa√ßos de at√© 20 caracteres, depois o conte√∫do da propriedade emaiadrs: </font></font><br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TVisTXTSave</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisited: TVisited)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> AcceptVisitor(pVisited) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; FList.Add(PadRight(TPerson(pVisited).<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>,<span class="hljs-number"><span class="hljs-number">20</span></span>)+PadRight(TPerson(pVisited).EMailAdrs,<span class="hljs-number"><span class="hljs-number">60</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Etapa 11. Adicione o manipulador de visitantes de arquivos CSV </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os visitantes que l√™em e escrevem s√£o semelhantes em quase todos os colegas das classes TXT, exceto na maneira de formatar a linha final de um arquivo: no padr√£o CSV, os valores das propriedades s√£o separados por v√≠rgulas. </font><font style="vertical-align: inherit;">Para ler linhas e analis√°-las em propriedades, usamos a fun√ß√£o ExtractDelimited do m√≥dulo strutils, e a grava√ß√£o √© realizada simplesmente concatenando as linhas:</font></font><br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TVisCSVRead</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisited: TVisited)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: integer; lData: TPerson; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> AcceptVisitor(pVisited) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; TPeople(pVisited).Clear; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> FList.Count - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>   lData := TPerson.Create;   lData.<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span> := ExtractDelimited(<span class="hljs-number"><span class="hljs-number">1</span></span>, FList.Strings[i], [<span class="hljs-string"><span class="hljs-string">','</span></span>]);   lData.EMailAdrs := ExtractDelimited(<span class="hljs-number"><span class="hljs-number">2</span></span>, FList.Strings[i], [<span class="hljs-string"><span class="hljs-string">','</span></span>]);   TPeople(pVisited).Add(lData); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TVisCSVSave</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisited: TVisited)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> AcceptVisitor(pVisited) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; FList.Add(TPerson(pVisited).<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span> + <span class="hljs-string"><span class="hljs-string">','</span></span> + TPerson(pVisited).EMailAdrs); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tudo o que resta para n√≥s √© registrar novos visitantes no gerente e verificar o funcionamento do aplicativo. </font><font style="vertical-align: inherit;">No manipulador de cria√ß√£o de formul√°rio, adicione o seguinte c√≥digo:</font></font><br><br><pre> <code class="delphi hljs">VM.RegisterVisitor(<span class="hljs-string"><span class="hljs-string">'readTXT'</span></span>, TVisTXTRead); VM.RegisterVisitor(<span class="hljs-string"><span class="hljs-string">'saveTXT'</span></span>,TVisTXTSave); VM.RegisterVisitor(<span class="hljs-string"><span class="hljs-string">'readCSV'</span></span>,TVisCSVRead); VM.RegisterVisitor(<span class="hljs-string"><span class="hljs-string">'saveCSV'</span></span>,TVisCSVSave);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Encaixe os bot√µes necess√°rios no formul√°rio e atribua a eles os manipuladores apropriados: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/112/0c2/7c3/1120c27c31300af40162387ac222d33c.png"><br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadCSVbtnClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> VM.Execute(<span class="hljs-string"><span class="hljs-string">'readCSV'</span></span>, FPeople); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadTXTbtnClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> VM.Execute(<span class="hljs-string"><span class="hljs-string">'readTXT'</span></span>, FPeople); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SaveCSVbtnClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> VM.Execute(<span class="hljs-string"><span class="hljs-string">'saveCSV'</span></span>, FPeople); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SaveTXTbtnClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> VM.Execute(<span class="hljs-string"><span class="hljs-string">'saveTXT'</span></span>, FPeople); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formatos de arquivo adicionais para salvar dados s√£o implementados simplesmente adicionando os Visitantes apropriados e registrando-os no Gerenciador. </font><font style="vertical-align: inherit;">E preste aten√ß√£o ao seguinte: intencionalmente nomeamos os comandos de forma diferente, ou seja, saveTXT e saveCSV. </font><font style="vertical-align: inherit;">Se os dois visitantes corresponderem a um comando de salvamento, os dois iniciar√£o no mesmo comando, verifique voc√™ mesmo.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Etapa 12. Limpeza final do c√≥digo </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para maior beleza e pureza do c√≥digo, al√©m de preparar um projeto para o desenvolvimento adicional da intera√ß√£o com o DBMS, distribuiremos nossas classes em diferentes m√≥dulos de acordo com a l√≥gica e sua finalidade. </font><font style="vertical-align: inherit;">No final, devemos ter a seguinte estrutura de m√≥dulos na pasta do projeto, o que nos permite prescindir de uma rela√ß√£o circular entre eles (ao se montar, organize os m√≥dulos necess√°rios nas se√ß√µes de uso):</font></font><br><br><table><tbody><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> M√≥dulo </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fun√ß√£o </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Aulas </font></font><br></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tivisitor.pas </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Classes base do modelo Visitor e Manager </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TVisitor </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TVisited </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TVisMapping </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TtiVisitorManager</font></font><br></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tiobject.pas </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Classes base de l√≥gica de neg√≥cios </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TtiObject </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TtiObjectList</font></font><br></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> people_BOM.pas </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Classes espec√≠ficas de l√≥gica de neg√≥cios </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TPerson </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TPeople</font></font><br></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> people_SRV.pas </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Classes concretas respons√°veis ‚Äã‚Äãpela intera√ß√£o </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TVisFile </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TVisTXTFile </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TVisCSVFile </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TVisCSVSave </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TVisCSVRead </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TVisTXTSalve </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TVisTXTRead</font></font><br></td></tr></tbody></table><br><h3>  Conclus√£o </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Neste artigo, examinamos o problema de iterar sobre uma cole√ß√£o ou lista de objetos que podem ter tipos diferentes. </font><font style="vertical-align: inherit;">Usamos o modelo de visitante proposto pelo GoF para implementar de maneira ideal duas maneiras diferentes de mapear dados de objetos para arquivos de diferentes formatos. </font><font style="vertical-align: inherit;">Ao mesmo tempo, diferentes m√©todos podem ser executados por uma equipe devido √† cria√ß√£o do Visitor Manager. </font><font style="vertical-align: inherit;">Por fim, os exemplos simples e ilustrativos discutidos no artigo nos ajudar√£o a desenvolver um sistema semelhante para mapear objetos para um banco de dados relacional. </font></font><br><br> <i><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquivo com c√≥digo fonte de exemplos - aqui</font></font></a></b></i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt441266/">https://habr.com/ru/post/pt441266/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt441254/index.html">Semin√°rio ‚ÄúPor que entramos em contato com o Kubernetes e o que obtemos dele‚Äù, 28 de fevereiro de Moscou</a></li>
<li><a href="../pt441258/index.html">Rastreamento din√¢mico completo no Linux usando eBPF e bpftrace</a></li>
<li><a href="../pt441260/index.html">Como os gr√°ficos de rede neural ajudaram</a></li>
<li><a href="../pt441262/index.html">Tarefas simples e longas eliminam os candidatos melhor do que os curtos e complexos</a></li>
<li><a href="../pt441264/index.html">Guia do Usu√°rio Kibana. Visualiza√ß√£o. Parte 2</a></li>
<li><a href="../pt441268/index.html">Testes de Ceedling + Eclipse ou de unidade para microcontroladores</a></li>
<li><a href="../pt441270/index.html">Primeiro, observe o FoundationDB da Apple</a></li>
<li><a href="../pt441274/index.html">Como se tornar um testador - o conhecimento e as habilidades necess√°rias</a></li>
<li><a href="../pt441278/index.html">Como criar uma linda paleta de cores</a></li>
<li><a href="../pt441280/index.html">Configura√ß√£o da GAL no Zimbra Collaboration Suite</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>