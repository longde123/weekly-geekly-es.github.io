<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëõ üö£üèª üßõüèº Nous int√©grons l'interpr√©teur Lua dans le projet de microcontr√¥leur (stm32) üë®üèæ üí≤ üëèüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans des applications assez importantes, une partie importante du projet est la logique m√©tier. Il est pratique de d√©boguer cette partie du programme ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nous int√©grons l'interpr√©teur Lua dans le projet de microcontr√¥leur (stm32)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459602/"><img src="https://habrastorage.org/webt/p6/9j/kz/p69jkzome873c4rbil8fftedrxs.png"><br><br>  Dans des applications assez importantes, une partie importante du projet est la logique m√©tier.  Il est pratique de d√©boguer cette partie du programme sur l'ordinateur, puis de l'int√©grer dans le projet du microcontr√¥leur, en attendant que cette partie soit ex√©cut√©e exactement comme pr√©vu sans aucun d√©bogage (cas id√©al). <br><br>  √âtant donn√© que la plupart des programmes pour microcontr√¥leurs sont √©crits en C / C ++, √† ces fins, ils utilisent g√©n√©ralement des classes abstraites qui fournissent des interfaces aux entit√©s de bas niveau (si un projet est √©crit uniquement en C, les structures de pointeurs de fonction sont souvent utilis√©es).  Cette approche fournit le niveau d'abstraction requis sur le fer, mais elle est lourde de n√©cessit√© de recompilation constante du projet avec la programmation ult√©rieure de la m√©moire non volatile du microcontr√¥leur avec un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">gros</a> fichier de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">micrologiciel</a> binaire. <br><br>  Cependant, il existe un autre moyen: utiliser un langage de script qui vous permet de d√©boguer la logique m√©tier en temps r√©el sur l'appareil lui-m√™me ou de charger des scripts de travail directement √† partir de la m√©moire externe, sans inclure ce code dans le micrologiciel du microcontr√¥leur. <br><br>  J'ai choisi Lua comme langage de script. <a name="habracut"></a><br><br><h2>  Pourquoi Lua? </h2><br>  Il existe plusieurs langages de script que vous pouvez int√©grer dans un projet de microcontr√¥leur.  Quelques simples BASIC-like, PyMite, Pawn ... Chacun a ses avantages et ses inconv√©nients, dont une discussion n'est pas incluse dans la liste des probl√®mes abord√©s dans cet article. <br><br>  Bri√®vement sur ce qui est bon sp√©cifiquement lua - peut √™tre trouv√© dans l'article <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"Lua en 60 minutes</a> . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"</a>  Cet article m'a beaucoup inspir√© et, pour une √©tude plus approfondie de la question, j'ai lu le guide officiel de l'auteur de la langue Robert Jeruzalimsky " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Programming in Lua</a> " (disponible dans la traduction officielle russe). <br><br>  Je voudrais √©galement mentionner le projet eLua.  Dans mon cas, j'ai d√©j√† une couche logicielle de bas niveau pr√™te √† l'emploi pour l'interaction avec les p√©riph√©riques du microcontr√¥leur et les autres p√©riph√©riques requis situ√©s sur la carte de l'appareil.  Par cons√©quent, je n'ai pas consid√©r√© ce projet (car il est reconnu de fournir les couches m√™mes pour connecter le noyau Lua avec les p√©riph√©riques du microcontr√¥leur). <br><br><h2>  √Ä propos du projet dans lequel Lua sera int√©gr√© </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Par tradition</a> , mon <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">projet sandbox</a> sera utilis√© comme la qualit√© du terrain d'exp√©rimentation (lien vers le commit avec la lua d√©j√† int√©gr√©e avec toutes les am√©liorations n√©cessaires d√©crites ci-dessous). <br><br>  Le projet est bas√© sur le microcontr√¥leur stm32f405rgt6 avec 1 Mo non volatile et 192 Ko de RAM (les 2 anciens blocs d'une capacit√© totale de 128 Ko sont actuellement utilis√©s). <br><br>  Le projet dispose d'un syst√®me d'exploitation en temps r√©el FreeRTOS pour prendre en charge l'infrastructure mat√©rielle p√©riph√©rique.  Toute la m√©moire pour les t√¢ches, les s√©maphores et autres objets FreeRTOS est allou√©e statiquement √† l'√©tape de liaison (situ√©e dans la zone .bss de la RAM).  Toutes les entit√©s FreeRTOS (s√©maphores, files d'attente, piles de t√¢ches, etc.) font partie d'objets globaux dans les zones priv√©es de leurs classes.  Cependant, le tas FreeRTOS est toujours allou√© pour prendre en charge les fonctions <i>malloc</i> , <i>free</i> , <i>calloc</i> (requises pour des fonctions telles que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">printf</a> ) qui sont red√©finies pour fonctionner avec.  Il existe une API am√©lior√©e pour travailler avec les cartes MicroSD (FatFS), ainsi que pour le d√©bogage de l'UART (115200, 8N1). <br><br><h2>  √Ä propos de la logique d'utilisation de Lua dans le cadre d'un projet </h2><br>  Dans le but de d√©boguer la logique m√©tier, il est suppos√© que les commandes seront envoy√©es par UART, empaquet√©es (comme un objet s√©par√©) dans des lignes finies (se terminant par le caract√®re "\ n" + 0-terminateur) et envoy√©es √† la machine lua.  En cas d'√©chec de l'ex√©cution, sortie par printf (puisqu'il √©tait <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">auparavant impliqu√©</a> dans le projet).  Lorsque la logique est d√©bogu√©e, il sera possible de t√©l√©charger le fichier logique m√©tier final √† partir du fichier de la carte microSD (non inclus dans le mat√©riel de cet article).  De plus, dans le but de d√©boguer Lua, la machine sera ex√©cut√©e √† l'int√©rieur d'un thread FreeRTOS distinct (√† l'avenir, un thread s√©par√© sera allou√© pour chaque script de logique m√©tier d√©bogu√© dans lequel il sera ex√©cut√© avec son environnement). <br><br><h2>  Inclusion du sous-module lua dans le projet </h2><br>  Le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">miroir officiel du projet sur github</a> sera utilis√© comme source de la biblioth√®que lua (puisque mon projet y est √©galement affich√©. Vous pouvez utiliser les sources directement depuis le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">site officiel</a> ).  √âtant donn√© que le projet dispose d'un syst√®me √©tabli d'assemblage de sous-modules dans le cadre du projet, avec des CMakeLists individuelles pour chaque sous-module, j'ai cr√©√© un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sous-module distinct</a> dans lequel j'ai inclus cette fourche et CMakeLists pour conserver un style d'assemblage unique. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CMakeLists</a> construit les sources du r√©f√©rentiel lua comme une biblioth√®que statique avec les drapeaux de compilation de sous-module suivants (extraits du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fichier de configuration du sous-module</a> dans le projet principal): <br><br><pre><code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span>(C_COMPILER_FLAGS <span class="hljs-string"><span class="hljs-string">"-std=gnu99;-fshort-enums;-fno-exceptions;-Wno-type-limits;-ffunction-sections;-fdata-sections;"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span>(MODULE_LUA_COMP_FLAGS <span class="hljs-string"><span class="hljs-string">"-O0;-g3;${C_COMPILER_FLAGS}"</span></span></code> </pre> <br>  Et drapeaux de sp√©cification du processeur utilis√© (d√©fini dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">racine CMakeLists</a> ): <br><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span>(HARDWARE_FLAGS -mthumb; -mcpu=cortex-m4; -mfloat-abi=hard; -mfpu=fpv4-sp-d16;)</code> </pre> <br>  Il est important de noter la n√©cessit√© pour la racine CMakeLists de sp√©cifier une d√©finition qui permet de ne pas utiliser de valeurs doubles (puisque le microcontr√¥leur n'a pas de support mat√©riel pour double. Flottant uniquement): <br><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">add_definitions</span></span>(-DLUA_32BITS)</code> </pre> <br>  Eh bien, il ne reste plus qu'√† informer l'√©diteur de liens de la n√©cessit√© d'assembler cette biblioth√®que et d'inclure le r√©sultat dans la mise en page du projet final: <br><br><div class="spoiler">  <b class="spoiler_title">Trac√© de CMakeLists pour lier un projet √† la biblioth√®que lua</b> <div class="spoiler_text"><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">add_subdirectory</span></span>(<span class="hljs-variable"><span class="hljs-variable">${CMAKE_SOURCE_DIR}</span></span>/bsp/submodules/module_lua) ... <span class="hljs-keyword"><span class="hljs-keyword">target_link_libraries</span></span>(<span class="hljs-variable"><span class="hljs-variable">${PROJECT_NAME}</span></span>.elf PUBLIC <span class="hljs-comment"><span class="hljs-comment"># -Wl,--start-group       #      . #  Lua    ,      #  . "-Wl,--start-group" ..._... MODULE_LUA ..._... "-Wl,--end-group")</span></span></code> </pre> </div></div><br><h2>  D√©finir des fonctions pour travailler avec la m√©moire </h2><br>  Puisque Lua lui-m√™me ne s'occupe pas de la m√©moire, cette responsabilit√© est transf√©r√©e √† l'utilisateur.  Cependant, lors de l'utilisation de la biblioth√®que <i>lauxlib</i> int√©gr√©e et de la fonction <i>luaL_newstate √†</i> partir d'elle, la fonction <i>l_alloc</i> est <i>li√©e en</i> tant que syst√®me de m√©moire.  Il est d√©fini comme suit: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l_alloc</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ud, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ptr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> osize, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nsize)</span></span></span><span class="hljs-function"> </span></span>{ (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)ud; (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)osize; <span class="hljs-comment"><span class="hljs-comment">/* not used */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nsize == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(ptr); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">realloc</span></span>(ptr, nsize); }</code> </pre> <br>  Comme mentionn√© au d√©but de l'article, le projet a d√©j√† remplac√© <i>les</i> fonctions <i>malloc</i> et <i>free</i> , mais il n'y a pas de fonction <i>realloc</i> .  Nous devons y rem√©dier. <br><br>  Dans le m√©canisme standard pour travailler avec le tas FreeRTOS, le fichier heap_4.c utilis√© dans le projet n'a pas de fonction pour redimensionner un bloc de m√©moire pr√©c√©demment allou√©.  √Ä cet √©gard, il est n√©cessaire de faire sa mise en ≈ìuvre sur la base de <i>malloc</i> et <i>gratuit</i> . <br><br>  Puisqu'√† l'avenir, il est possible de modifier le sch√©ma d'allocation de m√©moire (en utilisant un autre fichier heap_x.c), il a √©t√© d√©cid√© de ne pas utiliser les int√©rieurs du sch√©ma actuel (heap_4.c), mais de cr√©er un compl√©ment de niveau sup√©rieur.  Bien que moins efficace. <br><br>  Il est important de noter que la m√©thode <i>realloc</i> supprime non seulement l'ancien bloc (s'il en existait un) et en cr√©e un nouveau, mais d√©place √©galement les donn√©es de l'ancien bloc vers le nouveau.  De plus, si l'ancien bloc contenait plus de donn√©es que le nouveau, le nouveau est rempli √† la limite des anciens et les donn√©es restantes sont supprim√©es. <br><br>  Si ce fait n'est pas pris en compte, votre machine pourra ex√©cuter un tel script trois fois √† partir de la ligne " <i>a = 3 \ n</i> ", apr√®s quoi il tombera dans une faute mat√©rielle.  Le probl√®me peut √™tre r√©solu apr√®s avoir √©tudi√© l'image r√©siduelle des registres dans le gestionnaire de pannes mat√©rielles, √† partir de laquelle il sera possible de d√©couvrir que le crash s'est produit apr√®s avoir tent√© d'√©tendre la table dans les entrailles du code interpr√®te et de ses biblioth√®ques.  Si vous appelez un script comme " <i>print 'test'</i> ", le comportement changera en fonction de la fa√ßon dont le fichier du firmware est assembl√© (en d'autres termes, le comportement n'est pas d√©fini). <br><br>  Afin de copier les donn√©es de l'ancien bloc vers le nouveau, nous devons conna√Ætre la taille de l'ancien bloc.  FreeRTOS heap_4.c (comme les autres fichiers qui fournissent des m√©thodes de gestion de tas) ne fournit pas d'API pour cela.  Par cons√©quent, vous devez terminer le v√¥tre.  Comme base, j'ai pris la fonction <i>vPortFree</i> et r√©duit sa fonctionnalit√© √† la forme suivante: <br><br><div class="spoiler">  <b class="spoiler_title">Code de fonction VPortGetSizeBlock</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vPortGetSizeBlock</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pv)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *puc = (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *)pv; BlockLink_t *pxLink; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pv != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { puc -= xHeapStructSize; pxLink = (BlockLink_t *)puc; configASSERT((pxLink-&gt;xBlockSize &amp; xBlockAllocatedBit) != <span class="hljs-number"><span class="hljs-number">0</span></span>); configASSERT(pxLink-&gt;pxNextFreeBlock == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pxLink-&gt;xBlockSize &amp; ~xBlockAllocatedBit; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> </div></div><br>  Maintenant, c'est petit, √©crivez <i>realloc</i> bas√© sur <i>malloc</i> , <i>free</i> et <i>vPortGetSizeBlock</i> : <br><br><div class="spoiler">  <b class="spoiler_title">Code d'impl√©mentation Realloc bas√© sur malloc, free et vPortGetSizeBlock</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">realloc</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ptr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> new_size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ptr == <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(new_size); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* p = <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(new_size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p == <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p; } <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> old_size = vPortGetSizeBlock(ptr); <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> cpy_len = (new_size &lt; old_size)?new_size:old_size; <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(p, ptr, cpy_len); <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(ptr); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p; }</code> </pre> </div></div><br><h2>  Ajouter un support pour travailler avec stdout </h2><br>  Comme il ressort de la description officielle, l'interpr√©teur lua lui-m√™me n'est pas en mesure de travailler avec les E / S.  √Ä ces fins, l'une des biblioth√®ques standard est connect√©e.  Pour la sortie, il utilise le flux <i>stdout</i> .  La fonction <i>luaopen_io</i> de la biblioth√®que standard est responsable de la connexion au flux.  Pour prendre en charge l'utilisation de <i>stdout</i> (contrairement √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">printf</a> ), vous devrez remplacer la fonction <i>fwrite</i> .  Je l'ai red√©fini en fonction des fonctions d√©crites dans l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article pr√©c√©dent</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Fonction d'√©criture</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> fwrite(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *buf, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> count, FILE *stream) { stream = stream; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> len = size * count; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *s = <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*&gt;(buf); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; len; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_write_char((s[i])) != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> len; }</code> </pre> </div></div><br>  Sans sa d√©finition, la fonction d' <i>impression</i> dans lua s'ex√©cutera avec succ√®s, mais il n'y aura pas de sortie.  De plus, il n'y aura aucune erreur sur la pile Lua de la machine (puisque la fonction a √©t√© ex√©cut√©e avec succ√®s). <br><br>  En plus de cette fonction, nous aurons besoin de la fonction <i>fflush</i> (pour que le mode interactif fonctionne, qui sera <i>discut√©</i> plus tard).  Comme cette fonction ne peut pas √™tre remplac√©e, vous devrez la nommer un peu diff√©remment.  La fonction est une version all√©g√©e de la fonction <i>fwrite</i> et est destin√©e √† envoyer ce qui est maintenant dans le tampon avec son nettoyage ult√©rieur (sans transfert de chariot suppl√©mentaire). <br><br><div class="spoiler">  <b class="spoiler_title">Fonction Mc_fflush</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mc_fflush</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> len = buf_p; buf_p = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (uart_1.tx(tx_buf, len, <span class="hljs-number"><span class="hljs-number">100</span></span>) != mc_interfaces::res::ok) { errno = EIO; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br></div></div><br><h2>  R√©cup√©ration de cha√Ænes √† partir d'un port s√©rie </h2><br>  Pour obtenir des cha√Ænes pour une machine lua, j'ai d√©cid√© d'√©crire une classe uart-terminal simple, qui: <br><br><ul><li>  re√ßoit des donn√©es sur un port s√©rie octet par octet (en interruption); </li><li>  ajoute l'octet re√ßu √† la file d'attente, d'o√π le flux le re√ßoit; </li><li>  dans un flux d'octets, s'il ne s'agit pas d'un saut de ligne, renvoy√© sous la forme dans laquelle il est arriv√©; </li><li>  si un saut de ligne est arriv√© (' <i>\ r</i> '), alors 2 octets de retour de chariot terminal sont envoy√©s (" <i>\ n \ r</i> "); </li><li>  apr√®s l'envoi de la r√©ponse, le gestionnaire de l'octet arriv√© (objet de disposition de ligne) est appel√©; </li><li>  contr√¥le la pression de la touche de suppression de caract√®re (pour √©viter de supprimer des caract√®res de service de la fen√™tre du terminal); </li></ul><br>  Liens vers les sources: <br><br><ul><li>  L'interface de classe UART est <a href="">ici</a> ; </li><li>  La classe de base UART est <a href="">ici</a> et <a href="">ici</a> ; </li><li>  classe uart_terminal <a href="">ici</a> et <a href="">ici</a> ; </li><li>  cr√©er un objet de classe dans le cadre du projet <a href="">ici</a> . </li></ul><br>  De plus, je note que pour que cet objet fonctionne correctement, vous devez attribuer une priorit√© √† l'interruption UART dans la plage autoris√©e pour travailler avec les fonctions FreeRTOS √† partir de l'interruption.  Sinon, vous pouvez obtenir des erreurs difficiles √† d√©boguer.  Dans l'exemple actuel, les options suivantes pour les interruptions sont d√©finies dans le fichier <a href="">FreeRTOSConfig.h</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Param√®tres dans FreeRTOSConfig.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> configPRIO_BITS 4 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> configKERNEL_INTERRUPT_PRIORITY 0XF0 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//   FreeRTOS API   //   0x8 - 0xF. #define configMAX_SYSCALL_INTERRUPT_PRIORITY 0x80</span></span></span></span></code> </pre> </div></div><br>  Dans le projet lui-m√™me, un objet de classe <i>nvic</i> d√©finit la priorit√© de l'interruption 0x9, qui est incluse dans la plage valide (la classe nvic est d√©crite <a href="">ici</a> et <a href="">ici</a> ). <br><br><h2>  Formation de cordes pour une machine Lua </h2><br>  Les octets re√ßus de l'objet uart_terminal sont transf√©r√©s vers une instance d'une classe simple serial_cli, qui fournit une interface minimale pour √©diter la cha√Æne et la transf√©rer directement vers le thread dans lequel la lua-machine est ex√©cut√©e (en appelant la fonction de rappel).  Lors de l'acceptation du caract√®re '\ r', une fonction de rappel est appel√©e.  Cette fonction doit copier une ligne sur elle-m√™me et ¬´lib√©rer¬ª le contr√¥le (puisque la r√©ception de nouveaux octets est bloqu√©e pendant un appel. Ce n'est pas un probl√®me avec des flux correctement prioris√©s et une vitesse UART suffisamment basse). <br><br>  Liens vers les sources: <br><br><ul><li>  fichiers de description serial_cli <a href="">ici</a> et <a href="">ici</a> ; </li><li>  cr√©er un objet de classe dans le cadre du projet <a href="">ici</a> . </li></ul><br>  Il est important de noter que cette classe consid√®re qu'une cha√Æne de plus de 255 caract√®res n'est pas valide et la rejette.  C'est intentionnel, car l'interpr√©teur lua vous permet d'entrer des constructions ligne par ligne, en attendant la fin du bloc. <br><br><h2>  Passer une cha√Æne √† l'interpr√©teur Lua et son ex√©cution </h2><br>  L'interpr√©teur Lua lui-m√™me ne sait pas accepter le code de bloc ligne par ligne, puis ex√©cuter lui-m√™me le bloc entier.  Cependant, si vous installez Lua sur un ordinateur et ex√©cutez l'interpr√©teur en mode interactif, nous pouvons voir que l'ex√©cution se fait ligne par ligne avec la notation correspondante lors de la frappe, que le bloc n'est pas encore termin√©.  Puisque le mode interactif est ce qui est fourni dans le package standard, nous pouvons voir son code.  Il se trouve dans le fichier <a href="">lua.c.</a>  Nous nous int√©ressons √† la fonction <i>doREPL</i> et √† tout ce qu'elle utilise.  Afin de ne pas proposer de v√©lo, pour obtenir les fonctions du mode interactif dans le projet, j'ai cr√©√© un portage de ce code dans une classe distincte, que j'ai nomm√©e <i>lua_repl</i> par le nom de la fonction d'origine, qui utilise printf pour sortir des informations sur la console et a une m√©thode publique <i>add_lua_string</i> pour ajouter une ligne re√ßue de l'objet classe serial_cli d√©crit ci-dessus. <br><br>  R√©f√©rences: <br><br><ul><li>  description de la classe lua_repl <a href="">ici</a> ; </li><li>  code <a href="">ici</a> , <a href="">ici</a> et <a href="">ici</a> ; </li></ul><br>  La classe est faite selon le mod√®le Myleton singleton, car il n'est pas n√©cessaire de donner plusieurs modes interactifs au sein du m√™me appareil.  Un objet de classe lua_repl re√ßoit ici les donn√©es d'un objet de classe serial_cli. <br><br>  √âtant donn√© que le projet dispose d√©j√† d'un syst√®me unifi√© pour l'initialisation et la maintenance des objets globaux, le pointeur vers l'objet de la classe lua_repl est pass√© √† l'objet de la classe globale <a href="">player :: base</a> <a href="">ici</a> .  Dans la m√©thode de <i>d√©marrage</i> d'un objet de la classe <a href="">player :: base</a> (d√©clar√©e <a href="">ici</a> . Elle est √©galement appel√©e depuis main), la m√©thode <i>init</i> de l'objet de la classe lua_repl est appel√©e avec la priorit√© de la t√¢che FreeRTOS 3 (dans le projet, vous pouvez affecter la priorit√© de la t√¢che de 1 √† 4. O√π 1 Est la priorit√© la plus faible et 4 est la plus √©lev√©e).  Apr√®s une initialisation r√©ussie, la classe globale d√©marre le planificateur FreeRTOS et le mode interactif commence son travail. <br><br><h2>  Probl√®mes de portage </h2><br>  Vous trouverez ci-dessous une liste des probl√®mes que j'ai rencontr√©s lors du port Lua de la machine. <br><br><h4>  2-3 scripts d'une seule ligne d'affectation de variables sont ex√©cut√©s, puis tout tombe en faute </h4><br>  Le probl√®me venait de la m√©thode de r√©allocation.  Il est n√©cessaire non seulement de res√©lectionner le bloc, mais √©galement de copier le contenu de l'ancien (comme d√©crit ci-dessus). <br><br><h4>  Lorsque vous essayez d'imprimer une valeur, l'interpr√®te tombe en faute </h4><br>  Il √©tait d√©j√† plus difficile de d√©tecter le probl√®me, mais √† la fin j'ai r√©ussi √† d√©couvrir que snprintf √©tait utilis√© pour l'impression.  Puisque lua stocke les valeurs en double (ou float dans notre cas), printf (et ses d√©riv√©s) avec support en virgule flottante est requis (j'ai √©crit sur les subtilit√©s de printf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> ). <br><br><h2>  Configuration requise pour la m√©moire non volatile (flash) </h2><br>  Voici quelques mesures que j'ai prises pour juger de la quantit√© de m√©moire non volatile (flash) qui doit √™tre allou√©e pour int√©grer la machine Lua dans le projet.  La compilation a √©t√© effectu√©e en utilisant gcc-arm-none-eabi-8-2018-q4-major.  La version de Lua 5.4 a √©t√© utilis√©e.  Ci-dessous dans les mesures, l'expression ¬´sans Lua¬ª signifie la non-inclusion de l'interpr√©teur et des m√©thodes d'interaction avec lui et ses biblioth√®ques, ainsi qu'un objet de la classe lua_repl dans le projet.  Toutes les entit√©s de bas niveau (y compris les remplacements pour les fonctions <i>printf</i> et <i>fwrite</i> ) restent dans le projet.  La taille du segment FreeRTOS est de 1024 * 25 octets.  Le reste est occup√© par des entit√©s de projet mondiales. <br><br>  Le tableau r√©capitulatif des r√©sultats est le suivant (toutes les tailles en octets): <br><table border="1"><tbody><tr><th>  Options de construction </th><th>  Sans lua </th><th>  Noyau uniquement </th><th>  Lua avec biblioth√®que de base </th><th>  Lua avec base de biblioth√®ques, coroutine, table, cha√Æne </th><th>  luaL_openlibs </th></tr><tr><td>  -O0 -g3 </td><td>  103028 </td><td>  220924 </td><td>  236124 </td><td>  262652 </td><td>  308372 </td></tr><tr><td>  -O1 -g3 </td><td>  74940 </td><td>  144732 </td><td>  156916 </td><td>  174452 </td><td>  213068 </td></tr><tr><td>  -Os -g0 </td><td>  71172 </td><td>  134228 </td><td>  145756 </td><td>  161428 </td><td>  198400 </td></tr></tbody></table><br><h2>  Exigences de RAM </h2><br>  √âtant donn√© que la consommation de RAM d√©pend enti√®rement de la t√¢che, je donnerai un tableau r√©capitulatif de la m√©moire consomm√©e imm√©diatement apr√®s avoir <i>allum√©</i> la machine avec un ensemble de biblioth√®ques diff√©rent (il est affich√© par l' <i>impression (commande collectgarbage ("count") * 1024</i> )). <br><table border="1"><tbody><tr><td>  La composition </td><td>  RAM utilis√©e </td></tr><tr><td>  Lua avec biblioth√®que de base </td><td>  4809 </td></tr><tr><td>  Lua avec base de biblioth√®ques, coroutine, table, cha√Æne </td><td>  6407 </td></tr><tr><td>  luaL_openlibs </td><td>  12769 </td></tr></tbody></table><br>  Dans le cas de l'utilisation de toutes les biblioth√®ques, la taille de la RAM requise est consid√©rablement augment√©e par rapport aux ensembles pr√©c√©dents.  Cependant, son utilisation dans une partie consid√©rable des applications n'est pas n√©cessaire. <br><br>  De plus, 4 ko sont √©galement allou√©s √† la pile de t√¢ches, dans laquelle la machine Lua est ex√©cut√©e. <br><br><h2>  Utilisation ult√©rieure </h2><br>  Pour une utilisation compl√®te de la machine dans le projet, vous devrez d√©crire plus en d√©tail toutes les interfaces requises par le code logique m√©tier pour les objets mat√©riels ou de service du projet.  Cependant, c'est le sujet d'un article s√©par√©. <br><br><h2>  R√©sum√© </h2><br>  Cet article d√©crit comment connecter une machine Lua √† un projet de microcontr√¥leur, ainsi que lancer un interpr√©teur interactif √† part enti√®re qui vous permet d'exp√©rimenter la logique m√©tier directement √† partir de la ligne de commande du terminal.  De plus, les exigences pour le mat√©riel du microcontr√¥leur ont √©t√© prises en compte pour diff√©rentes configurations de la machine Lua. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr459602/">https://habr.com/ru/post/fr459602/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr459590/index.html">Programme d'affiliation open source d√©centralis√© sur la blockchain Waves</a></li>
<li><a href="../fr459592/index.html">Trois conseils de gestion du temps pour ceux qui ont tout essay√©.</a></li>
<li><a href="../fr459594/index.html">Lire entre les notes: syst√®me de transfert de donn√©es dans la musique</a></li>
<li><a href="../fr459596/index.html">iOS Digest n ¬∞ 9 (28 juin - 11 juillet)</a></li>
<li><a href="../fr459598/index.html">Foire aux questions de SELinux (FAQ)</a></li>
<li><a href="../fr459604/index.html">T√©l√©gramme - bot | Menu complet</a></li>
<li><a href="../fr459606/index.html">R√©seaux sociaux distribu√©s</a></li>
<li><a href="../fr459610/index.html">Ces routeurs dangereux: le piratage √† grande √©chelle des √©quipements r√©seau r√©cents et des m√©thodes de protection</a></li>
<li><a href="../fr459612/index.html">Comment Qualcomm a arrach√© l'industrie du mobile pendant pr√®s de 20 ans de suite</a></li>
<li><a href="../fr459614/index.html">Un canard robot remue les rizi√®res</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>