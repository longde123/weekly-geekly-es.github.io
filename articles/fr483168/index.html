<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔳 🤷🏼 👋🏻 Comment faire un bot qui transforme une photo en bande dessinée. Deuxième partie Formation modèle 😢 🏼 🌫️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="⇨ La première partie 
 ⇨ Troisième partie 

 Bonjour encore! 

 Comme vous pouvez le voir, les vacances ont quelque peu paralysé la chronologie des ar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment faire un bot qui transforme une photo en bande dessinée. Deuxième partie Formation modèle</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483168/">  <a href="https://habr.com/ru/post/479218/">⇨ La première partie</a> <br>  <a href="https://habr.com/ru/post/485824/">⇨ Troisième partie</a> <br><br>  Bonjour encore! <br><br>  Comme vous pouvez le voir, les vacances ont quelque peu paralysé la chronologie des articles. <br>  Je pense que beaucoup pendant cette période ont réussi, sinon à former pleinement leur modèle, au moins à expérimenter avec différents ensembles de données. <br><blockquote>  1. Mettez la distribution <br>  2. Téléchargement d'images <br>  3. ??? <br>  4. Profit! <br></blockquote>  Si vous n'étiez pas à la hauteur de ces réseaux de neurones, ou si vous commencez à lire cet article, alors, comme on dit, il n'y a pas de temps pour expliquer, nous prenons le kit de distribution, téléchargeons les photos nécessaires, et c'est parti! <br><a name="habracut"></a><br>  Des instructions détaillées figurent <a href="https://habr.com/ru/post/479218/">dans l'article précédent de la série</a> . <br><br><h2>  La première crêpe est grumeleuse </h2><br>  Lorsque j'ai formé le modèle pour <a href="https://t.me/photo2comicsbot" rel="nofollow">@ photo2comicsbot</a> pour la première fois, sans plus tarder, je viens de mettre environ 1000 pages de bandes dessinées dans un ensemble de données. <br>  Oui, ainsi que des couvertures, des annonces et d'autres charges. <br><br>  À l'entrée, cela ressemblait à ceci: <br><br><img src="https://habrastorage.org/webt/vs/7t/p8/vs7tp8lqmuevcrv_3cpuzbyaef4.png"><br><br>  Le résultat est correspondant: <br><br><img src="https://habrastorage.org/webt/2s/sf/5s/2ssf5st8mk1oge_9rrfbyepmlhk.png"><br><br><img src="https://habrastorage.org/webt/7x/dl/kp/7xdlkpn70yzd8qfljqusgn6jy5y.png"><br><br><img src="https://habrastorage.org/webt/ll/ll/v8/llllv8gmtfys_udt5euohplcjzw.png"><br><br><div class="spoiler">  <b class="spoiler_title">Plus d'images</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/tl/ey/8e/tley8enuh1qlcjt3nc7e9-wnzse.png"><br><br><img src="https://habrastorage.org/webt/2u/cz/5n/2ucz5nwpenvhonfh84m080tj_t0.png"><br><br><img src="https://habrastorage.org/webt/o7/qb/xt/o7qbxtxqcrgdcih_4m-ysiksd_e.png"><br><br><img src="https://habrastorage.org/webt/xc/-8/yl/xc-8ylyfuk71me4v59xxvn3qhj4.png"><br><br><img src="https://habrastorage.org/webt/ys/zx/vm/yszxvm-2hc8xt6rjsvvxcpuyy3w.png"><br><br><img src="https://habrastorage.org/webt/jl/p9/3t/jlp93trm26hwitdzgmdt_kylhfw.png"><br><br><img src="https://habrastorage.org/webt/3l/fb/y6/3lfby6xuenl47xlggsv9n2p9hss.png"><br><br><img src="https://habrastorage.org/webt/bq/mt/sd/bqmtsdr7xedmcxsogpa4j8olk8c.png"><br><br></div></div><br>  Le modèle transmet parfaitement les différences générales entre les bandes dessinées et les photos: <br><br><ul><li>  Étalonnage de couleur typique </li><li>  Sélection des contours </li><li>  Blocage </li><li>  Nuage de texte </li></ul><br>  En principe, cette option peut être tout à fait suffisante pour la production. <br><br>  Mais je me demandais quels résultats peuvent être obtenus sur un ensemble de données plus «propre». <br><br><h2>  Prenez deux </h2><br>  Pour l'expérience suivante, j'ai laissé les pages avec un bloc, et du reste j'ai découpé les plus grandes pièces, constituées d'un bloc, afin de se débarrasser des lignes de séparation verticales et horizontales dans le modèle final. <br><blockquote>  Si vous apportez des modifications à votre jeu de données, par exemple, supprimez ou ajoutez des photos, n'oubliez pas d'enregistrer la version précédente.  Vous aurez un endroit où retourner en cas de problème. </blockquote>  Le deuxième ensemble de données ressemblait à ceci: <br><br><img src="https://habrastorage.org/webt/ww/j9/8f/wwj98fxmy0d15c0xgxfz8w9bfs4.png"><br><br>  Le résultat, comme on dit, est évident: <br><br><img src="https://habrastorage.org/webt/zn/b3/sc/znb3sczf0ypubx8jya-uryrqbxm.png"><br><br><img src="https://habrastorage.org/webt/xp/n9/zv/xpn9zvimruobxodr4wa2vhrutxk.png"><br><br><img src="https://habrastorage.org/webt/xh/nf/sp/xhnfspsgqrkxvuvhdkj7vaqz5yy.png"><br><br><div class="spoiler">  <b class="spoiler_title">Plus d'images</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ag/6b/pw/ag6bpwlw1xefb9o8igrdixarhqc.png"><br><br><img src="https://habrastorage.org/webt/h7/xb/di/h7xbdiuyzdmukmjalf3o6rdou8e.png"><br><br><img src="https://habrastorage.org/webt/by/j8/zk/byj8zkaujwhx52po8xqw37un2oo.png"><br><br><img src="https://habrastorage.org/webt/pl/po/0y/plpo0yucjtvt0sbfc-pefnxz940.png"><br><br><img src="https://habrastorage.org/webt/65/4f/el/654fellkdx6_ebimev8ardha_e0.png"><br><br><img src="https://habrastorage.org/webt/zj/9u/vq/zj9uvqeres9m1kr2nmzcpgt-8uc.png"><br></div></div><br>  Les lignes de division ont disparu, mais avec elles l'expressivité laissée dans les nuages ​​avec le texte: elles ont commencé à se rencontrer beaucoup moins souvent dans l'ensemble de données et ont cessé d'être la caractéristique principale. <br><br>  L'espace vide qui était auparavant rempli de texte est maintenant rempli de bruit psychédélique. <br><br><h2>  La troisième fois est un charme </h2><br>  J'ai décidé de me débarrasser complètement du texte, ne laissant que les parties de la bande dessinée où il ne se trouve pas.  Personne n'a survécu: pas de nuage, pas de titres ou de noms de séries. <br><br>  Jeu de données après le «génocide linguistique»: <br><br><img src="https://habrastorage.org/webt/zu/pw/az/zupwaz8q1toeo9qvqncmfamino8.png"><br><br>  Le résultat final: <br><br><img src="https://habrastorage.org/webt/9s/o2/qg/9so2qgo6e6jpkdazfsqf2wlu1-w.png"><br><br><img src="https://habrastorage.org/webt/gs/nr/7p/gsnr7pfyfu4bcowe0bpyqlqn1vc.png"><br><br><img src="https://habrastorage.org/webt/me/vs/m6/mevsm6y3hlgvrvsa8qce0xhenqa.png"><br><br><div class="spoiler">  <b class="spoiler_title">Plus d'images</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/uv/hn/ua/uvhnuapobrpzdu8fxhyjqnz-ozg.png"><br><br><img src="https://habrastorage.org/webt/w1/gu/2e/w1gu2enojimz-lrpkzrzlkvihv8.png"><br><br><img src="https://habrastorage.org/webt/_e/j0/91/_ej091msilwm4hhlmbl3j7nw6sq.png"><br><br><img src="https://habrastorage.org/webt/ql/o6/th/qlo6thuiesfbqx_f2yx6yanf4ne.png"><br><br><img src="https://habrastorage.org/webt/cm/xg/4t/cmxg4tu9jp4-6dcjvjp2nwei3gq.png"><br></div></div><br>  D'une part, il y a moins d'artefacts, d'autre part, l'expressivité a disparu.  Étant donné que dans la formation GAN, la qualité du résultat est largement déterminée par vous et moi, il n'y a pas de recette unique pour un bon modèle. <br><br>  La beauté est dans l'œil du spectateur, alors n'ayez pas peur d'expérimenter et de choisir ce que vous aimez le plus. <br><br><h2>  À l'arme! </h2><br>  Eh bien, nous avons déjà parlé des principaux pièges et des méthodes pour y faire face, il est temps de passer aux choses sérieuses. <br><br>  Accédez au dossier dans lequel nous avons téléchargé la distribution.  Permettez-moi de vous rappeler qu'il s'appelait <b>pytorch-CycleGAN-and-pix2pix</b> <br><br>  Puisque nous avons des instructions pour les nuls, nous ne toucherons pas au code de distribution, car tous les paramètres nécessaires peuvent être définis à partir de la ligne de commande. <br><br>  Dans cette distribution, l'entraînement par défaut se déroule sur deux cents époques, avec une atténuation linéaire du rythme d'apprentissage après la centième époque. <br><blockquote>  La résolution maximale que ma carte de huit gigaoctets était capable de maîtriser était de 400x400.  La formation complète m'a pris environ 33 heures, nous allons donc utiliser un petit hack de vie.  Tout d'abord, nous formerons le modèle en images 128x128, puis 256x256, et ce n'est qu'au stade final que nous lui montrerons notre magnifique 400x400. <br>  La première étape durera 100 époques, la deuxième et la troisième - 50 chacune, ce qui nous permettra de réduire le temps d'entraînement de près de moitié. <br><br>  Comme le montre la pratique, le résultat de cette approche n'est pas pire, et parfois meilleur, que lors d'un entraînement immédiat à une résolution maximale. </blockquote>  Peut-être assez de théorie, il est temps de passer à la pratique. <br><br>  À l'invite de commande, entrez. <br><br><h3>  Première étape </h3><br><pre><code class="bash hljs">python train.py --dataroot {dataset root folder} --name {model name} --model cycle_gan --crop_size 128 --load_size 180 --init_type kaiming --netG resnet_9blocks --no_dropout --batch_size 4</code> </pre> <br>  <i>N'oubliez pas de remplacer les accolades par vos propres valeurs.</i> <i><br></i> <br>  Nous analyserons plus en détail certains paramètres: <br><br><pre> <code class="bash hljs">--batch_size {number}</code> </pre> <br>  Ce paramètre est responsable du nombre d'images traitées par cycle, affectant positivement la vitesse et négativement sur la gourmandise du modèle. <br><br>  À chaque étape, sélectionnez le maximum --batch_size, qui ne provoque pas d'erreurs en raison du manque de mémoire GPU. <br><br><pre> <code class="bash hljs">-- dataroot {dataset root folder}</code> </pre> <br>  - dossier avec notre jeu de données.  À l'intérieur, il devrait y avoir les dossiers trainA, trainB, testA, testB, comme décrit dans l'article précédent. <br><br><pre> <code class="bash hljs">--name {model name}</code> </pre> <br>  - Le nom de votre projet.  Cela peut être arbitraire, mais je recommande d'inclure l'architecture du modèle, la résolution maximale et le nom de l'ensemble de données dans le nom. <br>  Par exemple: "resnet9_128to400_comics8" <br>  Ainsi, vous pouvez distinguer les expériences avec divers paramètres et données. <br><br>  La première étape de la formation peut être arrêtée à la centième ère. <br><br>  Vous pouvez observer la progression depuis le navigateur: <a href="http://localhost/" rel="nofollow">localhost</a> : 8097 / <br>  (ou un autre lien qui sera visible dans la console) <br><br><h3>  Étape deux </h3><br><pre> <code class="bash hljs">python train.py --dataroot {dataset root folder} --name {model name} --model cycle_gan --crop_size 256 --load_size 290 --init_type kaiming --netG resnet_9blocks --no_dropout --batch_size 2 --epoch 100 --epoch_count 0 --continue_train</code> </pre> <br>  Il est important d'indiquer l'époque à laquelle nous avons terminé nos études dans la première étape. <br>  "--Epoch 100" signifie que nous chargerons le modèle à partir du point de contrôle de la centième ère <br>  «--Epoch_count 0» signifie que nous allons commencer l'entraînement à partir de zéro, avec la vitesse d'apprentissage maximale. <br><br>  La deuxième étape de la formation peut être arrêtée à la 50e ère. <br><br><h3>  Troisième étape </h3><br><pre> <code class="bash hljs">python train.py --dataroot {dataset root folder} --name {model name} --model cycle_gan --crop_size 400 --load_size 430 --init_type kaiming --netG resnet_9blocks --no_dropout --batch_size 1 --epoch 50 --epoch_count 0 --continue_train</code> </pre> <br><br>  La troisième étape de l'entraînement peut être arrêtée à la 50e ère, mais c'est une question de goût.  Vous pouvez terminer jusqu'à la fin et choisir le résultat intermédiaire que vous aimez.  Il est important de se rappeler que le résultat sur la 200e ère peut être pire que sur la 150e. <br><br><h2>  Maintenant, sortez et voyez ce que vous avez fait </h2><br>  Pendant l'entraînement, le modèle et les résultats intermédiaires seront enregistrés dans un dossier <br>  / pytorch-CycleGAN-and-pix2pix / checkpoints / {nom du modèle} <br><br>  Pour tester le modèle, entrez simplement la ligne de commande: <br><br><pre> <code class="bash hljs">python test.py --dataroot {dataset root folder} --name {model name} --model cycle_gan --netG resnet_9blocks --crop_size 512 --load_size 580 --epoch {epoch name}</code> </pre> <br>  Vous pouvez voir le résultat sur un jeu de données de test pour n'importe quel point de contrôle, il suffit de le spécifier comme {nom de l'époque}.  Si {nom d'époque} n'est pas spécifié, le dernier point de contrôle sera pris. <br><br>  Le résultat sera enregistré dans le dossier: <br> <code>/pytorch-CycleGAN-and-pix2pix/results/{model name}/test_{epoch name}</code> <br> <blockquote>  Afin de ne pas confondre quel modèle sur quel ensemble de données donne quel résultat, <br>  commencez à tenir un petit journal.  Enregistrer les données de référence et les résultats d'apprentissage. <br><br>  Par exemple, la ligne de commande et l'époque à laquelle vous avez atteint.  Ces données sont suffisantes pour enregistrer les paramètres d'entraînement et l'ensemble de données sur lequel nous nous sommes entraînés. <br><br>  Après tout, quelle est la différence entre une expérience scientifique et une farce?  Le fait que tout soit documenté avec nous! </blockquote>  C'est tout pour aujourd'hui!  Dans le prochain article, nous apprendrons comment exporter un modèle fini et l'héberger dans le cloud. <br><br>  N'ayez pas peur d'expérimenter.  Assurez-vous d'essayer plusieurs ensembles de données différents, de comparer les résultats et de les partager dans les commentaires! <br><br>  A très bientôt! <br><br>  <a href="https://habr.com/ru/post/485824/">⇨ Partie suivante</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr483168/">https://habr.com/ru/post/fr483168/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr483148/index.html">Nous discutons de jumeaux numériques et de simulation avec le fondateur d'une société de conseil</a></li>
<li><a href="../fr483154/index.html">J'ai dépensé 40 000 $ et j'ai ruiné une excellente idée pour une startup</a></li>
<li><a href="../fr483156/index.html">Mettez le chat sur ses pieds</a></li>
<li><a href="../fr483160/index.html">Espace 2020: Mars, constellations de satellites et nouvelles fusées</a></li>
<li><a href="../fr483166/index.html">Détection automatique de l'encodage de texte</a></li>
<li><a href="../fr483170/index.html">Base de données Messenger (partie 2): nous partitionnons le «profit»</a></li>
<li><a href="../fr483172/index.html">Comment localiser une application ou un jeu? Dix principales sources d'apprentissage en ligne gratuites</a></li>
<li><a href="../fr483174/index.html">Enregistrez et transférez le son d'un appareil à l'autre à l'aide de la connectivité Multipeer</a></li>
<li><a href="../fr483176/index.html">Base de données Messenger (partie 1): nous concevons le cadre de base</a></li>
<li><a href="../fr483178/index.html">Voici une mise à jour sur la version Flutter 1.9 couplée à la programmation Dart 2.5</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>