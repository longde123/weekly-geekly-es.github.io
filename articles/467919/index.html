<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏾‍🚀 👯 👊 Problemas de procesamiento por lotes de solicitudes y sus soluciones (parte 2) 🥨 🎴 🈴</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Esta es una continuación del artículo "Problemas de procesamiento por lotes de solicitudes y sus soluciones" . Se recomienda que primero se familiaric...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Problemas de procesamiento por lotes de solicitudes y sus soluciones (parte 2)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/custis/blog/467919/"><img src="https://habrastorage.org/webt/ad/_6/oe/ad_6oeq50j8z5q33t5ixjrcssqs.jpeg"><br>  Esta es una continuación del artículo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"Problemas de procesamiento por lotes de solicitudes y sus soluciones"</a> .  Se recomienda que primero se familiarice con la primera parte, ya que describe en detalle la esencia del problema y algunos enfoques para su solución.  Aquí nos fijamos en otros métodos. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Contenido</b> <div class="spoiler_text">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Breve repetición de la tarea.</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Aumentar paquetes</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Ingeniería inversa</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Recoge todas las solicitudes</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Paralelismo</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Los problemas</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Conclusiones</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Heurística empresarial</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Resolviendo un problema de contrato</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Buscar limitaciones útiles</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Errores heurísticos</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Conclusiones</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Unidades de estilo DDD</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Lógica de consultas crecientes dentro de un agregado</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Lógica para agregar consultas fuera del agregado</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Conclusiones</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Proxy y doble llamada</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Resolviendo un problema de contrato</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Conclusiones</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Conclusión</a> </div></div><br><a name="Revision"></a><h2>  Breve repetición de la tarea. </h2><br>  Hay un chat para coordinar el documento con un conjunto predefinido de participantes.  Los mensajes contienen texto y archivos.  Y, como en los chats regulares, los mensajes pueden ser respuestas y reenvíos. <br><br><div class="spoiler">  <b class="spoiler_title">Modelo de mensaje de chat</b> <div class="spoiler_text"><code><font color="7f0055"><b>data class</b></font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">(</font> <br> <font color="3f7f5f">// nullable      persist</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">id</font> : <font color="3e7eff"><b>Long</b></font> ? <font color="333333">=</font> <font color="7f0055"><b>null</b></font> <font color="333333">,</font> <br> <font color="395da1">/**    */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">author</font> : <font color="3e7eff"><b>UserReference</b></font> <font color="333333">,</font> <br> <font color="395da1">/**  */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">message</font> : <font color="3e7eff"><b>String</b></font> <font color="333333">,</font> <br> <font color="395da1">/**    */</font> <br> <font color="3f7f5f">// -   JPA+    null,   </font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">files</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileReference</b></font> <font color="333333">&gt;</font> ? <font color="333333">=</font> <font color="7f0055"><b>null</b></font> <font color="333333">,</font> <br> <font color="395da1">/**   ,     */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">replyTo</font> : <font color="3e7eff"><b>ChatMessage</b></font> ? <font color="333333">=</font> <font color="7f0055"><b>null</b></font> <font color="333333">,</font> <br> <font color="395da1">/**   ,     */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">forwardFrom</font> : <font color="3e7eff"><b>ChatMessage</b></font> ? <font color="333333">=</font> <font color="7f0055"><b>null</b></font> <br> <font color="000066">)</font></code> </div> </div><br><div class="spoiler">  <b class="spoiler_title">A través de la inyección de dependencias, podemos implementar los siguientes servicios externos:</b> <div class="spoiler_text"> <code><font color="7f0055"><b>interface</b></font> <font color="3e7eff"><b>ChatMessageRepository</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>findLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="333333">&gt;</font> <br> <font color="000066">}</font> <br> <br> <font color="7f0055"><b>data class</b></font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">id</font> : <font color="3e7eff"><b>FileReference</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">name</font> : <font color="3e7eff"><b>String</b></font> <br> <font color="000066">)</font> <br> <br> <font color="7f0055"><b>interface</b></font> <font color="3e7eff"><b>FileRemoteApi</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getHeadById</b></font> <font color="000066">(</font> <font color="000066"><i>id</i></font> : <font color="3e7eff"><b>FileReference</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>FileHeadRemote</b></font> <br> <font color="3e7eff"><b>&nbsp;&nbsp;</b></font> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getHeadsByIds</b></font> <font color="000066">(</font> <font color="000066"><i>id</i></font> : <font color="3e7eff"><b>Set</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileReference</b></font> <font color="333333">&gt;</font> <font color="000066">)</font> : <font color="3e7eff"><b>Set</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="333333">&gt;</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getHeadsByIds</b></font> <font color="000066">(</font> <font color="000066"><i>id</i></font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileReference</b></font> <font color="333333">&gt;</font> <font color="000066">)</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="333333">&gt;</font> <br> <font color="000066">}</font> <br> <br> <font color="7f0055"><b>data class</b></font> <font color="3e7eff"><b>UserRemote</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">id</font> : <font color="3e7eff"><b>UserReference</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">name</font> : <font color="3e7eff"><b>String</b></font> <br> <font color="000066">)</font> <br> <br> <font color="7f0055"><b>interface</b></font> <font color="3e7eff"><b>UserRemoteApi</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getUserById</b></font> <font color="000066">(</font> <font color="000066"><i>id</i></font> : <font color="3e7eff"><b>UserReference</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>UserRemote</b></font> <br> <font color="3e7eff"><b>&nbsp;&nbsp;</b></font> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getUsersByIds</b></font> <font color="000066">(</font> <font color="000066"><i>id</i></font> : <font color="3e7eff"><b>Set</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>UserReference</b></font> <font color="333333">&gt;</font> <font color="000066">)</font> : <font color="3e7eff"><b>Set</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>UserRemote</b></font> <font color="333333">&gt;</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getUsersByIds</b></font> <font color="000066">(</font> <font color="000066"><i>id</i></font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>UserReference</b></font> <font color="333333">&gt;</font> <font color="000066">)</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>UserRemote</b></font> <font color="333333">&gt;</font> <br> <font color="000066">}</font></code> </div> </div><br>  Necesitamos implementar un controlador REST: <br><br> <code><font color="7f0055"><b>interface</b></font> <font color="3e7eff"><b>ChatRestApi</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="333333">&gt;</font> <br> <font color="000066">}</font></code> <br> <br><div class="spoiler">  <b class="spoiler_title">Donde:</b> <div class="spoiler_text"> <code><font color="395da1">/**          */</font> <br> <font color="7f0055"><b>data class</b></font> <font color="3e7eff"><b>ReferenceUI</b></font> <font color="000066">(</font> <br> <font color="395da1">/**   url */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">ref</font> : <font color="3e7eff"><b>String</b></font> <font color="333333">,</font> <br> <font color="395da1">/**     */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">name</font> : <font color="3e7eff"><b>String</b></font> <br> <font color="000066">)</font> <br> <br> <font color="7f0055"><b>data class</b></font> <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">id</font> : <font color="3e7eff"><b>Long</b></font> <font color="333333">,</font> <br> <font color="395da1">/**    */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">author</font> : <font color="3e7eff"><b>ReferenceUI</b></font> <font color="333333">,</font> <br> <font color="395da1">/**  */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">message</font> : <font color="3e7eff"><b>String</b></font> <font color="333333">,</font> <br> <font color="395da1">/**    */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">files</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ReferenceUI</b></font> <font color="333333">&gt;,</font> <br> <font color="395da1">/**   ,     */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">replyTo</font> : <font color="3e7eff"><b>ChatMessageUI</b></font> ? <font color="333333">=</font> <font color="7f0055"><b>null</b></font> <font color="333333">,</font> <br> <font color="395da1">/**   ,     */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">forwardFrom</font> : <font color="3e7eff"><b>ChatMessageUI</b></font> ? <font color="333333">=</font> <font color="7f0055"><b>null</b></font> <br> <font color="000066">)</font> <br></code> </div></div><br>  En la parte anterior, analizamos la implementación ingenua de un servicio utilizando el procesamiento por lotes y varias formas de acelerarlo.  Estos métodos son muy simples, pero su aplicación no proporciona un rendimiento suficientemente bueno. <br><br><a name="Enlargement"></a><h2>  Aumentar paquetes </h2><br>  El principal problema de las soluciones ingenuas era el pequeño tamaño de los paquetes. <br><br>  Para agrupar llamadas en paquetes más grandes, debe acumular solicitudes de alguna manera.  Esta línea no implica la acumulación de solicitudes: <br><br> <code><font color="4a86e8">author =</font> <font color="566874">userRepository</font> <font color="333333">.</font> <font color="170591">getUserById</font> <font color="000066">(</font> <font color="566874">author</font> <font color="000066">)</font> <font color="333333">.</font> <i><b>toFrontReference</b></i> <font color="000066">()</font> <font color="333333">,</font></code> <br> <br>  Ahora, en nuestro tiempo de ejecución, no hay un lugar especial para almacenar la lista de usuarios: se está formando gradualmente.  Esto tendrá que cambiar. <br><br>  Primero debe separar la lógica de adquisición de datos de la asignación en el método ChatMessage.toFrontModel: <br><br> <code><font color="7f0055"><b>private fun</b></font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="333333">.</font> <font color="170591"><b>toFrontModel</b></font> <font color="000066">(</font> <br> <font color="000066"><i>getUser</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>UserReference</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>UserRemote</b></font> <font color="333333">,</font> <br> <font color="000066"><i>getFile</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>FileReference</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="333333">,</font> <br> <font color="000066"><i>serializeMessage</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>ChatMessageUI</b></font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="333333">=</font> <br> <font color="170591">ChatMessageUI</font> <font color="000066">(</font> <br> <font color="4a86e8">id =</font> <font color="566874">id</font> ?: <font color="7f0055"><b>throw</b></font> <font color="170591">IllegalStateException</font> <font color="000066">(</font> <b>"</b> <font color="333333"><b>$</b></font> <font color="7f0055"><b>this</b></font> <b>must be persisted"</b> <font color="000066">)</font> <font color="333333">,</font> <br> <font color="4a86e8">author =</font> <font color="000066"><i>getUser</i></font> <font color="000066">(</font> <font color="566874">author</font> <font color="000066">)</font> <font color="333333">.</font> <i><b>toFrontReference</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="4a86e8">message =</font> <font color="566874">message</font> <font color="333333">,</font> <br> <font color="4a86e8">files =</font> <font color="566874">files</font> <font color="333333">?.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <b>it</b> <font color="333333">.</font> <i><b>map</b></i> <font color="000066">(</font> <font color="000066"><i>getFile</i></font> <font color="000066">)</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <i><b>toFrontReference</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="4a86e8">forwardFrom =</font> <font color="566874">forwardFrom</font> <font color="333333">?.</font> <i><b>let</b></i> <font color="000066">(</font> <font color="000066"><i>serializeMessage</i></font> <font color="000066">)</font> <font color="333333">,</font> <br> <font color="4a86e8">replyTo =</font> <font color="566874">replyTo</font> <font color="333333">?.</font> <i><b>let</b></i> <font color="000066">(</font> <font color="000066"><i>serializeMessage</i></font> <font color="000066">)</font> <br> <font color="000066">)</font></code> <br> <br>  Resulta que esta función depende solo de tres funciones externas (y no de clases completas, como era al principio). <br><br>  Después de tal revisión, el cuerpo de la función no quedó menos claro, y el contrato se hizo más difícil (esto tiene ventajas y desventajas). <br><br>  De hecho, no puede hacer un estrechamiento del contrato y dejar dependencias en las interfaces.  Lo principal es que definitivamente no hay nada superfluo en ellos, ya que tendremos que hacer implementaciones alternativas. <br><br>  Dado que la función serializeMessage es similar a una función recursiva, esto se puede hacer como una recursión explícita en el primer paso de la refactorización: <br><br> <code><font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>ChatRestController</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">messageRepository</font> : <font color="3e7eff"><b>ChatMessageRepository</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">userRepository</font> : <font color="3e7eff"><b>UserRemoteApi</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">fileRepository</font> : <font color="3e7eff"><b>FileRemoteApi</b></font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>ChatRestApi</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>override fun</b></font> <font color="170591"><b>getLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font></code> <br> <br>  Hice un trozo para el método toFrontModel, que hasta ahora funciona exactamente igual que en nuestra primera implementación ingenua (la implementación de las tres funciones externas sigue siendo la misma). <br><br> <code><font color="7f0055"><b>private fun</b></font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="333333">.</font> <font color="170591"><b>toFrontModel</b></font> <font color="000066">()</font> : <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="333333">=</font> <br> <i><b>toFrontModel</b></i> <font color="000066">(</font> <br> <font color="4a86e8">getUser =</font> <font color="566874">userRepository</font> ::getUserById <font color="333333">,</font> <br> <font color="4a86e8">getFile =</font> <font color="566874">fileRepository</font> ::getHeadById <font color="333333">,</font> <br> <font color="4a86e8">serializeMessage =</font> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;</b></font> <font color="000066">)</font></code> <br> <br>  Pero debemos hacer que las funciones getUser, getFile y serializeMessage funcionen de manera eficiente, es decir, enviar solicitudes a los servicios apropiados en paquetes del tamaño correcto (en teoría, este tamaño puede ser diferente para cada servicio) o generalmente una solicitud por servicio si se permiten solicitudes ilimitadas. <br><br>  La forma más fácil de lograr esta agrupación es si tenemos todas las consultas necesarias a la mano antes de comenzar el procesamiento.  Para hacer esto, antes de llamar a FrontModel, recopile todos los enlaces necesarios, realice el procesamiento por lotes y luego use el resultado. <br><br>  También puede probar el esquema con la acumulación de solicitudes y su ejecución gradual.  Sin embargo, tales esquemas requerirán ejecución asincrónica, pero por ahora nos centraremos en los síncronos. <br><br>  Entonces, para comenzar a utilizar el procesamiento por lotes, de una forma u otra tendremos que encontrar de antemano tantas solicitudes como sea posible (preferiblemente todas) que tendremos que hacer.  Si estamos hablando de un controlador REST, sería bueno combinar las solicitudes de cada servicio a lo largo de la sesión. <br><br><div class="spoiler">  <b class="spoiler_title">Agrupar todas las llamadas</b> <div class="spoiler_text">  En algunas situaciones, todos los datos necesarios dentro de la sesión pueden obtenerse de inmediato y no causarán problemas con los recursos ni del iniciador de la solicitud ni del ejecutor.  En este caso, no podemos limitar el tamaño del paquete para llamar al servicio e inmediatamente recibir todos los datos a la vez. <br><br>  Otra suposición que hace la vida mucho más fácil es asumir que el iniciador tiene suficientes recursos para procesar todos los datos.  Las solicitudes a servicios externos también se pueden enviar en paquetes limitados, si así lo requieren. <br><br>  La simplificación de la lógica en este caso se refiere a cómo se compararán los lugares donde se necesitan los datos con los resultados de las llamadas.  Si consideramos que los recursos del iniciador son muy limitados y, al mismo tiempo, intentamos minimizar el número de llamadas externas, tenemos una tarea bastante difícil para el corte óptimo del gráfico.  Lo más probable es que solo tenga que sacrificar el rendimiento para reducir el consumo de recursos. <br><br>  Consideraremos que, específicamente en nuestro proyecto de demostración, el iniciador no está particularmente limitado en recursos, puede recibir todos los datos necesarios y almacenarlos hasta el final de la sesión.  Si hay problemas con los recursos, solo haremos una paginación más pequeña. <br><br>  Dado que, en mi práctica, tal enfoque es el más demandado, otros ejemplos se referirán a esta opción. </div></div><br>  Podemos distinguir tales métodos para obtener grandes conjuntos de consultas: <br><br><ul><li>  ingeniería inversa; </li><li>  heurística empresarial; </li><li>  agregados en el estilo de DDD; </li><li>  proxy y doble llamada. </li></ul><br>  Veamos todas las opciones en el ejemplo de nuestro proyecto. <br><br><a name="ReverseEngineering"></a><h4>  Ingeniería inversa </h4><br><a name="RequirementsGathering"></a>  <b>Recoge todas las solicitudes</b> <br><br>  Dado que tenemos un código para implementar todas las funciones involucradas en la recopilación de información y convertirla para la interfaz, podemos hacer ingeniería inversa y desde este código podemos entender qué solicitudes serán: <br><br> <code><font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>ChatRestController</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">messageRepository</font> : <font color="3e7eff"><b>ChatMessageRepository</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">userRepository</font> : <font color="3e7eff"><b>UserRemoteApi</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">fileRepository</font> : <font color="3e7eff"><b>FileRemoteApi</b></font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>ChatRestApi</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>override fun</b></font> getLast <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>messages</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//    ,  forward  reply</font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">allMessages</font> <font color="333333">=</font> <font color="000066"><i>messages</i></font> <font color="333333">.</font> <i><b>asSequence</b></i> <font color="000066">()</font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>sequenceOf</b></i> <font color="000066">(</font> <font color="000066"><i>it</i></font> <font color="333333">,</font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">forwardFrom</font> <font color="333333">,</font> <b>it</b> <font color="333333">.</font> <font color="566874">replyTo</font> <font color="000066">)</font> <font color="333333">.</font> <i><b>filterNotNull</b></i> <font color="000066">()</font> <br> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">()</font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">allUserReq</font> <font color="333333">=</font> <font color="170591">allMessages</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">author</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="7f0055"><b>val</b></font> <font color="170591">allFileReq</font> <font color="333333">=</font> <font color="170591">allMessages</font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">files</font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">()</font></code> <br> <br>  Se recopilan todas las solicitudes, ahora debe realizar el procesamiento por lotes real. <br><br>  Para allUserReq y allFileReq, realizamos consultas externas y las agrupamos por id.  Si no hay restricciones en el tamaño del paquete, se verá así: <br><br> <code><font color="566874">userRepository</font> <font color="333333">.</font> <font color="170591">getUsersByIds</font> <font color="000066">(</font> <font color="170591">allMessages</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">author</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">())</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get <br> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByIds</font> <font color="000066">(</font> <font color="170591">allMessages</font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">files</font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">())</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get</code> <br> <br>  Si hay una restricción, entonces el código tomará la siguiente forma: <br><br> <code><font color="7f0055"><b>val</b></font> <font color="170591">userApiChunkLimit</font> <font color="333333">=</font> <font color="333333"><b>100</b></font> <br> <font color="170591">allMessages</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">author</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>asSequence</b></i> <font color="000066">()</font> <font color="333333">.</font> <i><b>distinct</b></i> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>chunked</b></i> <font color="000066">(</font> <font color="170591">userApiChunkLimit</font> <font color="333333">,</font> <font color="566874">userRepository</font> ::getUsersByIds <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>flatten</b></i> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get</code> <br> <br>  Desafortunadamente, a diferencia de Stream, Sequence no puede cambiar fácilmente a una solicitud de paquete paralelo. <br><br>  Si considera que una consulta paralela es válida y necesaria, puede hacer, por ejemplo, esto: <br><br> <code><font color="170591">allMessages</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">author</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <font color="170591">parallelStream</font> <font color="000066">()</font> <font color="333333">.</font> <font color="170591">distinct</font> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>chunked</b></i> <font color="000066">(</font> <font color="05314d"><b>userApiChunkLimit</b></font> <font color="333333">,</font> <font color="566874">userRepository</font> ::getUsersByIds <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>flatten</b></i> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get</code> <br> <br>  Se puede ver que nada ha cambiado mucho.  Usar una cierta cantidad de magia de Kotlin nos ayudó con esto: <br><br> <code><font color="7f0055"><b>fun</b></font> <font color="333333">&lt;</font> <font color="000066"><i>T</i></font> <font color="333333">,</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="3e7eff"><b>Stream</b></font> <font color="333333">&lt;</font> <font color="7f0055"><b>out</b></font> <font color="000066"><i>T</i></font> <font color="333333">&gt;.</font> <font color="170591"><b>chunked</b></font> <font color="000066">(</font> <font color="000066"><i>size</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="333333">,</font> <font color="000066"><i>transform</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="000066"><i>T</i></font> <font color="333333">&gt;</font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="000066">)</font> : <font color="3e7eff"><b>Stream</b></font> <font color="333333">&lt;</font> <font color="7f0055"><b>out</b></font> <font color="000066"><i>R</i></font> <font color="333333">&gt; =</font> <br> <i><b>batches</b></i> <font color="000066">(</font> <font color="7f0055"><b>this</b></font> <font color="333333">,</font> <font color="000066"><i>size</i></font> <font color="000066">)</font> <font color="333333">.</font> <font color="170591">map</font> <font color="000066">(</font> <font color="000066"><i>transform</i></font> <font color="000066">)</font> <br> <br> <font color="7f0055"><b>fun</b></font> <font color="333333">&lt;</font> <font color="000066"><i>T</i></font> <font color="333333">&gt;</font> <font color="3e7eff"><b>Stream</b></font> <font color="333333">&lt;</font> <font color="7f0055"><b>out</b></font> <font color="3e7eff"><b>Collection</b></font> <font color="333333">&lt;</font> <font color="000066"><i>T</i></font> <font color="333333">&gt;&gt;.</font> <font color="170591"><b>flatten</b></font> <font color="000066">()</font> : <font color="3e7eff"><b>Stream</b></font> <font color="333333">&lt;</font> <font color="000066"><i>T</i></font> <font color="333333">&gt; =</font> <br> <font color="170591">flatMap</font> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="170591">stream</font> <font color="000066">()</font> <font color="000066"><b>}</b></font> <br> <br> <font color="7f0055"><b>fun</b></font> <font color="333333">&lt;</font> <font color="000066"><i>T</i></font> <font color="333333">,</font> <font color="000066"><i>K</i></font> <font color="333333">&gt;</font> <font color="3e7eff"><b>Stream</b></font> <font color="333333">&lt;</font> <font color="000066"><i>T</i></font> <font color="333333">&gt;.</font> <font color="170591"><b>associateBy</b></font> <font color="000066">(</font> <font color="000066"><i>keySelector</i></font> : <font color="000066">(</font> <font color="000066"><i>T</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>K</i></font> <font color="000066">)</font> : <font color="3e7eff"><b>Map</b></font> <font color="333333">&lt;</font> <font color="000066"><i>K</i></font> <font color="333333">,</font> <font color="000066"><i>T</i></font> <font color="333333">&gt; =</font> <br> <font color="170591">collect</font> <font color="000066">(</font> <font color="3e7eff"><b>Collectors</b></font> <font color="333333">.</font> <font color="170591">toMap</font> <font color="000066">(</font> <font color="000066"><i>keySelector</i></font> <font color="333333">,</font> <font color="000066"><b>{</b></font> <b>it</b> <font color="000066"><b>}</b></font> <font color="000066">))</font></code> <br> <br><div class="spoiler">  <b class="spoiler_title">Ahora queda por poner todo junto:</b> <div class="spoiler_text"> <code><font color="7f0055"><b>override fun</b></font> <font color="170591"><b>getLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>messages</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//    ,  forward  reply</font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">allMessages</font> <font color="333333">=</font> <font color="000066"><i>messages</i></font> <font color="333333">.</font> <i><b>asSequence</b></i> <font color="000066">()</font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>sequenceOf</b></i> <font color="000066">(</font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <font color="566874">forwardFrom</font> <font color="333333">,</font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <font color="566874">replyTo</font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>filterNotNull</b></i> <font color="000066">()</font> <br> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">()</font> <br> <br> <font color="000066"><i>messages</i></font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066">(</font> <font color="170591">ValueHolder</font> <font color="333333">&lt;</font> <font color="000066">(</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="333333">&gt;</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>apply</b></i> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="566874">value</font> <font color="333333">=</font> <i><b>memoize</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> : <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">(</font> <br> <font color="3f7f5f">//       ,    </font> <br> <font color="4a86e8">getUser =</font> <font color="3e7eff"><b>allMessages</b></font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">author</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <font color="170591">parallelStream</font> <font color="000066">()</font> <font color="333333">.</font> <font color="170591">distinct</font> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>chunked</b></i> <font color="000066">(</font> <font color="05314d"><b>userApiChunkLimit</b></font> <font color="333333">,</font> <font color="566874">userRepository</font> ::getUsersByIds <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>flatten</b></i> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"User</b> <font color="333333"><b>$</b></font> <b>it"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="3f7f5f">//        </font> <br> <font color="4a86e8">getFile =</font> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByIds</font> <font color="000066">(</font> <font color="3e7eff"><b>allMessages</b></font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">files</font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">())</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"File</b> <font color="333333"><b>$</b></font> <b>it"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="3f7f5f">//       </font> <br> <font color="4a86e8">serializeMessage =</font> <font color="566874">value</font> <br> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> <font color="333333">.</font> <font color="566874">value</font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font></code> </div> </div><br><div class="spoiler">  <b class="spoiler_title">Explicaciones y simplificaciones</b> <div class="spoiler_text">  Lo primero que seguramente llamará tu atención es la función de memorizar.  El hecho es que la función serializeMessage seguramente se llamará varias veces para los mismos mensajes (debido a la respuesta y reenvío).  No está claro por qué deberíamos hacer toFrontModel por separado para cada mensaje (en algunos casos esto puede ser necesario, pero no el nuestro).  Por lo tanto, puede hacer una memorización para la función serializeMessage.  Esto se implementa, por ejemplo, de la siguiente manera: <br><br> <code><font color="7f0055"><b>fun</b></font> <font color="333333">&lt;</font> <font color="000066"><i>A</i></font> <font color="333333">,</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="170591"><b>memoize</b></font> <font color="000066">(</font> <font color="000066"><i>func</i></font> : <font color="000066">(</font> <font color="000066"><i>A</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="000066">)</font> <font color="333333">=</font> <font color="000066"><i>func</i></font> <font color="7f0055"><b>as?</b></font> <font color="3e7eff"><b>Memoize2</b></font> ?: <font color="170591">Memoize2</font> <font color="000066">(</font> <font color="000066"><i>func</i></font> <font color="000066">)</font> <br> <font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>Memoize2</b></font> <font color="333333">&lt;</font> <font color="000066"><i>A</i></font> <font color="333333">,</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="000066">(</font> <font color="7f0055"><b>val</b></font> <font color="566874">func</font> : <font color="000066">(</font> <font color="000066"><i>A</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="000066">)</font> : <font color="000066">(</font> <font color="000066"><i>A</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="333333">,</font> java <font color="333333">.</font> util <font color="333333">.</font> function <font color="333333">.</font> <font color="3e7eff"><b>Function</b></font> <font color="333333">&lt;</font> <font color="000066"><i>A</i></font> <font color="333333">,</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="000066">{</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">cache</font> <font color="333333">=</font> <i><b>hashMapOf</b></i> <font color="333333">&lt;</font> <font color="000066"><i>A</i></font> <font color="333333">,</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="000066">()</font> <br> <font color="7f0055"><b>override fun</b></font> <font color="170591"><b>invoke</b></font> <font color="000066">(</font> <font color="000066"><i>p1</i></font> : <font color="000066"><i>A</i></font> <font color="000066">)</font> <font color="333333">=</font> <font color="566874">cache</font> <font color="333333">.</font> <i><b>getOrPut</b></i> <font color="000066">(</font> <font color="000066"><i>p1</i></font> <font color="333333">,</font> <font color="000066"><b>{</b></font> <font color="566874">func</font> <font color="000066">(</font> <font color="000066"><i>p1</i></font> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="000066">)</font> <br> <font color="7f0055"><b>override fun</b></font> <font color="170591"><b>apply</b></font> <font color="000066">(</font> <font color="000066"><i>t</i></font> : <font color="000066"><i>A</i></font> <font color="000066">)</font> : <font color="000066"><i>R</i></font> <font color="333333">=</font> <font color="170591">invoke</font> <font color="000066">(</font> <font color="000066"><i>t</i></font> <font color="000066">)</font> <br> <font color="000066">}</font></code> <br> <br>  Luego, necesitamos construir una función memorizada serializeMessage, pero al mismo tiempo será utilizada dentro de ella.  Es importante usar exactamente la misma instancia de la función en el interior, de lo contrario toda la memorización se irá por el desagüe.  Para resolver esta colisión, utilizamos la clase ValueHolder, que simplemente almacena una referencia al valor (puede tomar algo estándar en su lugar, por ejemplo, AtomicReference).  Para acortar el registro de recursividad, puede hacer esto: <br><br> <code><font color="7f0055"><b>inline fun</b></font> <font color="333333">&lt;</font> <font color="000066"><i>A</i></font> <font color="333333">,</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="170591"><b>recursiveMemoize</b></font> <font color="000066">(</font> <font color="7f0055"><b>crossinline</b></font> <font color="000066"><i>func</i></font> : <font color="000066">(</font> <font color="000066"><i>A</i></font> <font color="333333">,</font> <font color="000066">(</font> <font color="000066"><i>A</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="000066">)</font> : <font color="000066">(</font> <font color="000066"><i>A</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="333333">=</font> <br> <font color="170591">ValueHolder</font> <font color="333333">&lt;</font> <font color="000066">(</font> <font color="000066"><i>A</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>apply</b></i> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="566874">value</font> <font color="333333">=</font> <i><b>memoize</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>a</i></font> <font color="000066"><b>-&gt;</b></font> <font color="3e7eff"><b>func</b></font> <font color="000066">(</font> <font color="000066"><i>a</i></font> <font color="333333">,</font> <font color="566874">value</font> <font color="000066">)</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> <font color="333333">.</font> <font color="566874">value</font></code> <br> <br>  Si pudiste entender este silogismo de flecha la primera vez, felicidades, eres un programador funcional :-) <br><br>  Ahora el código se verá así: <br><br> <code><font color="7f0055"><b>override fun</b></font> <font color="170591"><b>getLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>messages</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//    ,  forward  reply</font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">allMessages</font> <font color="333333">=</font> <font color="000066"><i>messages</i></font> <font color="333333">.</font> <i><b>asSequence</b></i> <font color="000066">()</font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>sequenceOf</b></i> <font color="000066">(</font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <font color="566874">forwardFrom</font> <font color="333333">,</font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <font color="566874">replyTo</font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>filterNotNull</b></i> <font color="000066">()</font> <br> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">()</font> <br> <br> <font color="3f7f5f">//       ,    </font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">getUser</font> <font color="333333">=</font> <font color="170591">allMessages</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">author</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <font color="170591">parallelStream</font> <font color="000066">()</font> <font color="333333">.</font> <font color="170591">distinct</font> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>chunked</b></i> <font color="000066">(</font> <font color="05314d"><b>userApiChunkLimit</b></font> <font color="333333">,</font> <font color="566874">userRepository</font> ::getUsersByIds <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>flatten</b></i> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"User</b> <font color="333333"><b>$</b></font> <font color="000066"><i>it</i></font> <b>"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <br> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//        </font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">getFile</font> <font color="333333">=</font> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByIds</font> <font color="000066">(</font> <font color="170591">allMessages</font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">files</font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">())</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"File</b> <font color="333333"><b>$</b></font> <b>it"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <br> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>messages</i></font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066">(</font> <i><b>recursiveMemoize</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>memoized</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">(</font> <br> <font color="4a86e8">getUser =</font> <font color="170591">getUser</font> <font color="333333">,</font> <br> <font color="4a86e8">getFile =</font> <font color="170591">getFile</font> <font color="333333">,</font> <br> <font color="3f7f5f">//       </font> <br> <font color="4a86e8">serializeMessage =</font> <font color="000066"><i>memoized</i></font> <br> <font color="000066"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <font color="000066">)</font></code> <br> <br>  También puede notar o Throw, que se define así: <br><br> <code><font color="395da1">/**  </font> <font color="3d3d3d"><i><b>[exception]</b></i></font> <font color="395da1">,    null */</font> <br> <font color="7f0055"><b>fun</b></font> <font color="333333">&lt;</font> <font color="000066"><i>P</i></font> <font color="333333">,</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="000066">((</font> <font color="000066"><i>P</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> ? <font color="000066">)</font> <font color="333333">.</font> <font color="170591"><b>orThrow</b></font> <font color="000066">(</font> <font color="000066"><i>exception</i></font> : <font color="000066">(</font> <font color="000066"><i>P</i></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>Exception</b></font> <font color="000066">)</font> : <font color="000066">(</font> <font color="000066"><i>P</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="333333">=</font> <br> <font color="000066"><b>{</b></font> <font color="000066"><i>p</i></font> <font color="000066"><b>-&gt;</b></font> <font color="170591">invoke</font> <font color="000066">(</font> <font color="000066"><i>p</i></font> <font color="000066">)</font> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <b>it</b> ?: <font color="7f0055"><b>throw</b></font> <font color="3e7eff"><b>exception</b></font> <font color="000066">(</font> <font color="000066"><i>p</i></font> <font color="000066">)</font> <font color="000066"><b>} }</b></font></code> <br> <br>  Si no hay datos sobre nuestra identificación en servicios externos y esto se considera una situación legal, debe manejarlo de alguna manera diferente. <br><br>  Después de esta solución, se espera que el tiempo de ejecución getLast sea de alrededor de 300 ms.  Además, este tiempo crecerá ligeramente, incluso si las solicitudes ya no se ajustan a las restricciones sobre el tamaño del paquete (ya que los paquetes se solicitan en paralelo).  Permítame recordarle que nuestro objetivo mínimo es de 500 ms, y 250 ms pueden considerarse trabajo normal. </div></div><br><a name="Parallelism"></a>  <b>Paralelismo</b> <br><br>  Pero necesitas seguir adelante.  Las llamadas a userRepository y fileRepository son completamente independientes y se pueden paralelizar fácilmente, en teoría, se acercan a los 200 ms. <br><br><div class="spoiler">  <b class="spoiler_title">Por ejemplo, a través de nuestra función de unión:</b> <div class="spoiler_text"> <code><font color="7f0055"><b>override fun</b></font> <font color="170591"><b>getLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>messages</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//    ,  forward  reply</font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">allMessages</font> <font color="333333">=</font> <font color="000066"><i>messages</i></font> <font color="333333">.</font> <i><b>asSequence</b></i> <font color="000066">()</font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>sequenceOf</b></i> <font color="000066">(</font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <font color="566874">forwardFrom</font> <font color="333333">,</font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <font color="566874">replyTo</font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>filterNotNull</b></i> <font color="000066">()</font> <br> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">()</font> <br> <br> <i><b>join</b></i> <font color="000066">(</font> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//       ,    </font> <br> <font color="3e7eff"><b>allMessages</b></font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">author</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <font color="170591">parallelStream</font> <font color="000066">()</font> <font color="333333">.</font> <font color="170591">distinct</font> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>chunked</b></i> <font color="000066">(</font> <font color="05314d"><b>userApiChunkLimit</b></font> <font color="333333">,</font> <font color="566874">userRepository</font> ::getUsersByIds <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>flatten</b></i> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> <font color="333333">,</font> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//        </font> <br> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByIds</font> <font color="000066">(</font> <font color="3e7eff"><b>allMessages</b></font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">files</font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">())</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> <font color="000066">)</font> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066">(</font> <font color="170591">users</font> <font color="333333">,</font> <font color="170591">files</font> <font color="000066">)</font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>messages</i></font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066">(</font> <i><b>recursiveMemoize</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>memoized</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">(</font> <br> <font color="4a86e8">getUser =</font> <font color="170591">users</font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"User</b> <font color="333333"><b>$</b></font> <b>it"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="4a86e8">getFile =</font> <font color="170591">files</font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"File</b> <font color="333333"><b>$</b></font> <font color="000066"><i>it</i></font> <b>"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="3f7f5f">//       </font> <br> <font color="4a86e8">serializeMessage =</font> <font color="000066"><i>memoized</i></font> <br> <font color="000066"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font></code> </div> </div><br>  Como muestra la práctica, la ejecución tarda unos 200 ms, y es muy importante que el tiempo no crezca mucho con un aumento en el número de mensajes. <br><br><a name="Problems"></a>  <b>Los problemas</b> <br><br>  En general, el código, por supuesto, se ha vuelto menos legible que nuestra ingenua primera versión, pero es bueno que la serialización en sí (la implementación de toFrontModel) no haya cambiado mucho y siga siendo completamente legible.  Toda la lógica del trabajo astuto con servicios externos vive en un solo lugar. <br><br>  La desventaja de este enfoque es que nuestra abstracción continúa. <br><br>  Si necesitamos hacer cambios en toFrontModel, casi seguramente tendremos que hacer cambios en la función getLast, lo que viola <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el</a> Principio de sustitución de Liskov. <br><br>  Por ejemplo, acordamos descifrar los archivos adjuntos solo en los mensajes principales, pero no en las respuestas y transferencias (responder / reenviar), o solo en las respuestas y transferencias del primer nivel.  En este caso, después de realizar cambios en el código toFrontModel, deberá realizar las correcciones correspondientes en el código de recopilación de solicitudes para los archivos.  Además, la corrección no será trivial: <br><br> <code><font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByIds</font> <font color="000066">(</font> <br> <font color="3e7eff"><b>allMessages</b></font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">files</font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">()</font> <br> <font color="000066">)</font></code> <br> <br>  Y aquí nos estamos acercando sin problemas a otro problema que está estrechamente relacionado con el anterior: el funcionamiento correcto del código en su conjunto depende de la alfabetización de la ingeniería inversa.  En algunos casos complejos, el código puede no funcionar correctamente precisamente debido a una recopilación de consultas incorrecta.  No hay garantía de que pueda llegar rápidamente a pruebas unitarias que cubran todas esas situaciones difíciles. <br><br><a name="Summary1"></a>  <b>Conclusiones</b> <br><br>  Pros: <br><br><ol><li>  Una forma obvia de pre-recibir solicitudes, que se separa fácilmente del código principal. </li><li>  La ausencia casi completa de sobrecarga de memoria y tiempo asociada con el uso de solo los datos que se habrían recibido de todos modos. </li><li>  Buena escala y la capacidad de construir un servicio, que en teoría será responsable de un tiempo predecible, independientemente del tamaño de la solicitud desde el exterior. </li></ol><br>  Contras: <br><br><ol><li>  Código bastante complejo para el procesamiento por lotes en sí. </li><li>  Trabajo grande y responsable en el análisis de solicitudes en la implementación existente. </li><li>  La abstracción fluida y, como consecuencia, la fragilidad de todo el esquema en relación con los cambios en la implementación. </li><li>  Dificultades en el soporte: los errores en el bloque de predicción de consulta son difíciles de distinguir de los errores en el código principal.  Idealmente, debe usar el doble de pruebas unitarias, por lo que los procedimientos con errores en la producción serán el doble de difíciles. </li><li>  Cumplir con los principios SÓLIDOS al escribir código: el código debe estar preparado para alienar la lógica del procesamiento por lotes.  La introducción de estos principios por sí sola proporcionará algunas ventajas, por lo que este menos es el más insignificante. </li></ol><br>  Es importante tener en cuenta que puede utilizar este método sin realizar ingeniería inversa como tal.  Necesitamos obtener un contrato getLast, del cual depende el contrato para el cálculo preliminar de las solicitudes (en adelante, captación previa).  En este caso, lo hicimos al observar la implementación de getLast (ingeniería inversa).  Sin embargo, con este enfoque, surgen dificultades: la edición de estas dos piezas de código siempre debe ser sincrónica, y es imposible garantizar esto (recuerde hashCode y equals, es exactamente lo mismo).  El siguiente enfoque, que me gustaría mostrar, está diseñado para resolver este problema (o al menos mitigarlo). <br><br><a name="BusinessHeuristics"></a><h4>  Heurística empresarial </h4><br><a name="ManagingContractProblem1"></a>  <b>Resolviendo un problema de contrato</b> <br><br>  ¿Qué sucede si no operamos con un contrato exacto y, por lo tanto, con un conjunto exacto de solicitudes, sino con un aproximado?  Además, crearemos un conjunto aproximado para que incluya estrictamente el conjunto exacto y se base en las características del área temática. <br><br>  Por lo tanto, en lugar de la dependencia del contrato de captación previa en getLast, establecemos la dependencia de ambos en algún contrato común que será dictado por el usuario.  La principal dificultad será encarnar de alguna manera este contrato general en forma de código. <br><br><a name="UsefulRestrictions"></a>  <b>Buscar limitaciones útiles</b> <br><br>  Intentemos hacer esto con nuestro ejemplo. <br>  En nuestro caso, existen las siguientes características comerciales: <br><br><ul><li>  la lista de participantes en el chat está predefinida; </li><li>  los chats están completamente aislados unos de otros; </li><li>  El anidamiento de las cadenas de respuesta / reenvío es pequeño (~ 2–3 mensajes). </li></ul><br>  De la primera restricción se deduce que no es necesario correr alrededor de los mensajes, ver qué usuarios están allí, elegir los únicos y hacer una solicitud para ellos.  Simplemente puede consultar una lista predefinida.  Si estuviste de acuerdo con esta declaración, entonces te atrapé. <br><br>  De hecho, no todo es tan simple.  Una lista puede estar predefinida, pero puede haber miles de usuarios.  Tales cosas necesitan ser aclaradas.  En nuestro caso, generalmente habrá dos o tres participantes en el chat, rara vez más.  Por lo tanto, es perfectamente aceptable recibir datos sobre todos ellos. <br><br>  Además, si la lista de usuarios de chat está predeterminada, pero esta información no está en el servicio del usuario (lo cual es muy probable), entonces no tendrá sentido a partir de dicha información.  Haremos una solicitud adicional para la lista de usuarios de chat, y luego aún tendrá que hacer la (s) solicitud (es) al servicio de usuario. <br><br>  Suponga que la información sobre la conexión de los usuarios y el chat se almacena en el servicio del usuario.  En nuestro caso, esto es así, ya que la conexión está determinada por los derechos del usuario.  Luego, para los usuarios, se obtendrá un código de captación previa de este tipo: <br><br>  Puede parecer sorprendente aquí que no estamos pasando ningún identificador de chat.  Hice esto intencionalmente para no saturar el código de muestra. <br><br>  A primera vista, nada se sigue de la segunda restricción.  En cualquier caso, todavía no podía obtener nada útil de él. <br><br>  Ya hemos usado la tercera restricción anteriormente.  Puede tener un impacto significativo en cómo almacenamos y recibimos conversaciones.  No comenzaremos a desarrollar este tema, ya que no tiene nada que ver con el controlador REST y el procesamiento por lotes. <br><br>  ¿Qué hacer con los archivos?  Me gustaría obtener una lista de todos los archivos de chat en una simple solicitud.  Según los términos de la API, solo necesitamos encabezados de archivo, sin cuerpos, por lo que no parece una tarea peligrosa y que requiera muchos recursos para la persona que llama. <br><br>  Por otro lado, debemos recordar que no recibimos todos los mensajes de chat, sino solo la última N, y puede resultar fácilmente que no contengan ningún archivo. <br><br>  No puede haber una respuesta universal: todo depende de los detalles del negocio y los casos de uso.  Al crear una solución de producto, puede meterse en problemas si establece una heurística para un caso de uso, y luego los usuarios trabajarán con la funcionalidad de una manera diferente.  Para demostraciones y preventas, esta es una buena opción, pero en este momento estamos tratando de escribir un servicio de producción honesto. <br><br>  Entonces, por desgracia, será posible realizar heurísticas de negocios para los archivos aquí solo en función de los resultados de la operación y la recopilación de estadísticas (o después de una evaluación experta). <br><br>  Como todavía queremos aplicar de alguna manera nuestro método, supongamos que las estadísticas muestran lo siguiente: <br><br><ol><li>  Una conversación típica comienza con un mensaje que incluye uno o más archivos, seguido de mensajes de respuesta sin archivos. </li><li>  Casi todos los mensajes vienen en conversaciones típicas. </li><li>  El número esperado de archivos únicos dentro de un solo chat es de ~ 20. </li></ol><br>  De esto se deduce que para mostrar casi todos los mensajes necesitará obtener los encabezados de algunos archivos (porque ChatMessageUI está tan organizado) y que el número total de archivos es pequeño.  En este caso, parece razonable recibir todos los archivos de chat en una sola solicitud.  Para hacer esto, tendremos que agregar lo siguiente a nuestra API para archivos: <br><br> <code><font color="7f0055"><b>fun</b></font> <font color="170591"><b>getHeadsByChat</b></font> <font color="000066">()</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="333333">&gt;</font></code> <br> <br>  El método getHeadsByChat no parece exagerado y está hecho exclusivamente por nuestro deseo de optimizar el rendimiento (aunque esta también es una buena razón).  Muy a menudo, en las salas de chat con archivos, los usuarios desean ver todos los archivos utilizados y en el orden en que se agregaron (por lo tanto, usamos List). <br><br>  La implementación de una conexión tan explícita requerirá el almacenamiento de información adicional en un servicio de archivos o en nuestra aplicación.  Todo depende de en qué área de responsabilidad, en nuestra opinión, esta información redundante sobre la conexión del archivo con el chat debe almacenarse.  Es redundante porque el mensaje ya está asociado con el archivo y, a su vez, está asociado con el chat.  No puede utilizar la desnormalización, pero extraiga esta información sobre la marcha de los mensajes, es decir, dentro de SQL, reciba de inmediato todos los archivos durante el chat (esto está en nuestra aplicación) y solicítelos todos de una vez desde el servicio de archivos.  Esta opción funcionará peor si hay muchos mensajes de chat, pero no necesitamos desnormalización.  Ocultaría ambas opciones detrás de getHeadsByChat. <br><br>  El código es el siguiente: <br><br> <code><font color="7f0055"><b>override fun</b></font> getLast <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>messages</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>join</b></i> <font color="000066">(</font> <br> <font color="000066"><b>{</b></font> <font color="566874">userRepository</font> <font color="333333">.</font> <font color="170591">getUsersByChat</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>} }</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByChat</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>} }</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="3f7f5f">//    </font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font></code> <br> <br>  Se puede ver que, en comparación con la versión anterior, muy poco ha cambiado y solo la parte de captación previa se ha visto afectada, lo cual es genial. <br><br>  El código de captación previa se ha vuelto mucho más corto y claro. <br><br>  El tiempo de ejecución no ha cambiado, lo cual es lógico, ya que el número de solicitudes sigue siendo el mismo.  Existen casos teóricamente posibles en los que el escalado será mejor que la ingeniería inversa honesta (solo debido a la eliminación del enlace del cálculo complejo).  Sin embargo, las situaciones opuestas son igualmente probables: las heurísticas reman demasiado.  Como muestra la práctica, si logra llegar a una heurística adecuada, entonces no debería haber ningún cambio especial en el tiempo de ejecución. <br><br>  Sin embargo, esto no es todo.  No tomamos en cuenta que ahora recibir datos detallados sobre usuarios y archivos no está relacionado con la recepción de mensajes y las solicitudes se pueden lanzar en paralelo: <br><br>  Esta opción proporciona unos 100 ms estables por solicitud. <br><br><a name="Mistakes"></a>  <b>Errores heurísticos</b> <br><br>  ¿Qué sucede si, al usar la heurística, el conjunto de consultas no es más grande, sino un poco más pequeño de lo que debería ser?  Para la mayoría de las opciones, tales heurísticas funcionarán, pero habrá excepciones para las cuales deberá realizar una solicitud por separado.  En mi práctica, tales decisiones no tuvieron éxito, ya que cada excepción tuvo un gran impacto en el rendimiento y, al final, algunos usuarios hicieron una solicitud que consistió completamente en excepciones.  Diría que en tales situaciones es mejor usar ingeniería inversa, incluso si el algoritmo de recopilación de consultas es espeluznante e ilegible, pero, por supuesto, todo depende de la importancia del servicio. <br><br><a name="Summary2"></a>  <b>Conclusiones</b> <br><br>  Pros: <br><br><ol><li>  La lógica de la heurística empresarial es fácil de leer y generalmente trivial.  Esto es bueno para comprender los límites de aplicabilidad, verificar y modificar el contrato de captación previa. </li><li>  La escalabilidad es tan buena como la ingeniería inversa. </li><li>  La coherencia del código según los datos se reduce, lo que puede conducir a una mejor paralelización del código. </li><li>  La lógica de captación previa, como la lógica principal del controlador REST, se basa en los requisitos.  Esta es una ventaja débil si los requisitos cambian con frecuencia. </li></ol><br>  Contras: <br><br><ol><li>  A partir de los requisitos, no es tan fácil derivar la heurística para las predicciones de consultas.  Puede ser necesario aclarar los requisitos, en la medida en que sea poco compatible con ágil. </li><li>  Puedes obtener datos adicionales. </li><li>  Para garantizar que el contrato de captación previa funcione de manera efectiva, probablemente se requerirá la desnormalización del almacenamiento de datos.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Este es un punto débil, ya que estas optimizaciones se derivan de la lógica empresarial y, por lo tanto, lo más probable es que sean reclamadas por diferentes procesos. </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A partir de nuestro ejemplo, podemos concluir que aplicar este enfoque es muy difícil y que el juego no vale la pena. </font><font style="vertical-align: inherit;">De hecho, en proyectos comerciales reales, el número de restricciones es enorme y, a partir de este montón, a menudo es posible obtener algo útil, que le permite particionar datos o predecir estadísticas. </font><font style="vertical-align: inherit;">La principal ventaja de este enfoque es que las restricciones utilizadas son interpretadas por la empresa, por lo tanto, se entienden y validan fácilmente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por lo general, el mayor problema cuando se intenta utilizar este enfoque es la separación de actividades. </font><font style="vertical-align: inherit;">El desarrollador debe estar bien inmerso en la lógica empresarial y hacer preguntas a los analistas que aclaren las preguntas, lo que requiere un cierto nivel de iniciativa.</font></font><br><br><a name="DDDAgregates"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Unidades de estilo DDD </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En proyectos grandes, a menudo puede ver el uso de prácticas DDD, ya que le permiten estructurar eficientemente su código. </font><font style="vertical-align: inherit;">No es necesario utilizar todas las plantillas DDD en el proyecto; a veces puede obtener buenos resultados incluso con la introducción de una. </font><font style="vertical-align: inherit;">Considere el concepto de DDD como un agregado. </font><font style="vertical-align: inherit;">Un agregado es una unión de entidades conectadas lógicamente, cuyo trabajo se lleva a cabo solo a través de la raíz del agregado (por lo general, esta es una entidad que es la parte superior del gráfico de conectividad de la entidad). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desde el punto de vista de la obtención de datos, lo principal en el agregado es que toda la lógica de trabajar con listas de entidades está en un solo lugar: el agregado. </font><font style="vertical-align: inherit;">Hay dos enfoques sobre lo que debe transferirse a la unidad durante su construcción:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transferimos funciones a la unidad para obtener datos externos. </font><font style="vertical-align: inherit;">La lógica para determinar los datos necesarios vive dentro de la unidad.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transferimos todos los datos necesarios. </font><font style="vertical-align: inherit;">La lógica para determinar los datos necesarios vive fuera del agregado.</font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La elección del enfoque depende en gran medida de la facilidad con que la captación previa se puede mover fuera del agregado. </font><font style="vertical-align: inherit;">Si la lógica de captación previa se basa en la heurística empresarial, generalmente es fácil separarla del agregado. </font><font style="vertical-align: inherit;">Llevar la lógica más allá del alcance de un agregado basado en un análisis de su uso (ingeniería inversa) puede ser peligroso, ya que podemos distribuir código lógicamente relacionado en diferentes clases.</font></font><br><br><a name="EnlargementInside"></a> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La lógica de ampliar las consultas dentro de un agregado</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Intentemos esbozar un agregado que correspondería al concepto de "chat". Nuestras clases ChatMessage, UserReference, FileReference corresponden al modelo de almacenamiento, por lo que podrían cambiarse de nombre con algún prefijo apropiado, pero tenemos un pequeño proyecto, así que vamos a dejarlo como está. Llamamos al ensamblado Chat, y sus componentes son ChatPage y ChatPageMessage: </font><font style="vertical-align: inherit;">Hasta ahora, se obtiene una gran cantidad de duplicaciones sin sentido. Esto se debe al hecho de que nuestro modelo de tema es similar al modelo de almacenamiento y ambos son similares al modelo frontend. </font><font style="vertical-align: inherit;">Utilizo las clases FileHeadRemote y UserRemote directamente, para no escribir código innecesario, aunque generalmente en el dominio debes evitar usar tales clases directamente.</font></font><br><br> <code><font color="7f0055"><b>interface</b></font> <font color="3e7eff"><b>Chat</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getLastPage</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>ChatPage</b></font> <br> <font color="000066">}</font> <br> <br> <font color="7f0055"><b>interface</b></font> <font color="3e7eff"><b>ChatPage</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">messages</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatPageMessage</b></font> <font color="333333">&gt;</font> <br> <font color="000066">}</font> <br> <br> <font color="7f0055"><b>data class</b></font> <font color="3e7eff"><b>ChatPageMessage</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">id</font> : <font color="3e7eff"><b>Long</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">author</font> : <font color="3e7eff"><b>UserRemote</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">message</font> : <font color="3e7eff"><b>String</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">files</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="333333">&gt;,</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">replyTo</font> : <font color="3e7eff"><b>ChatPageMessage</b></font> ? <font color="333333">,</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">forwardFrom</font> : <font color="3e7eff"><b>ChatPageMessage</b></font> ? <br> <font color="000066">)</font></code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si usa dicho agregado, nuestro controlador REST se puede reescribir de la siguiente manera: </font><font style="vertical-align: inherit;">esta opción recuerda en gran medida nuestra primera implementación ingenua, pero tiene una ventaja importante: el controlador ya no se dedica a recibir datos directamente y no depende de las clases asociadas con el almacenamiento de datos, sino que depende solo desde la unidad, que se configura a través de las interfaces. </font><font style="vertical-align: inherit;">Por lo tanto, la lógica de captación previa ya no está en el controlador. </font><font style="vertical-align: inherit;">El controlador solo se ocupa de la conversión de la unidad en un modelo front-end, lo que nos da cumplimiento con el Principio de responsabilidad única (SRP). </font><font style="vertical-align: inherit;">Desafortunadamente, para todos los métodos descritos en el agregado, tendrá que escribir una implementación.</font></font><br><br> <code><font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>ChatRestController</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">chat</font> : <font color="3e7eff"><b>Chat</b></font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>ChatRestApi</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>override fun</b></font> <font color="170591"><b>getLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <font color="566874">chat</font> <font color="333333">.</font> <font color="170591">getLastPage</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">()</font> <br> <br> <font color="7f0055"><b>private fun</b></font> <font color="3e7eff"><b>ChatPage</b></font> <font color="333333">.</font> <font color="170591"><b>toFrontModel</b></font> <font color="000066">()</font> <font color="333333">=</font> <br> <font color="566874">messages</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <br> <br> <font color="000066"><b>&nbsp;&nbsp;</b></font> <font color="7f0055"><b>private fun</b></font> <font color="3e7eff"><b>ChatPageMessage</b></font> <font color="333333">.</font> <font color="170591"><b>toFrontModel</b></font> <font color="000066">()</font> : <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="333333">=</font> <br> <font color="170591">ChatMessageUI</font> <font color="000066">(</font> <br> <font color="4a86e8">id =</font> <font color="566874">id</font> <font color="333333">,</font> <br> <font color="4a86e8">author =</font> <font color="566874">author</font> <font color="333333">.</font> <i><b>toFrontReference</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="4a86e8">message =</font> <font color="566874">message</font> <font color="333333">,</font> <br> <font color="4a86e8">files =</font> <font color="566874">files</font> <font color="333333">.</font> <i><b>toFrontReference</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="4a86e8">forwardFrom =</font> <font color="566874">forwardFrom</font> <font color="333333">?.</font> <i><b>toFrontModel</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="4a86e8">replyTo =</font> <font color="566874">replyTo</font> <font color="333333">?.</font> <i><b>toFrontModel</b></i> <font color="000066">()</font> <br> <font color="000066">)</font> <br> <font color="000066">}</font></code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Intentemos simplemente guardar la lógica del controlador implementada cuando se utiliza la heurística empresarial.</font></font></b> <div class="spoiler_text"> <code><font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>ChatImpl</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">messageRepository</font> : <font color="3e7eff"><b>ChatMessageRepository</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">userRepository</font> : <font color="3e7eff"><b>UserRemoteApi</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">fileRepository</font> : <font color="3e7eff"><b>FileRemoteApi</b></font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>Chat</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>override fun</b></font> <font color="170591"><b>getLastPage</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <font color="7f0055"><b>object</b></font> : <font color="3e7eff"><b>ChatPage</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>override val</b></font> <font color="566874">messages</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatPageMessage</b></font> <font color="333333">&gt;</font> <br> <font color="7f0055"><b>get</b></font> <font color="000066">()</font> <font color="333333">=</font> <br> <i><b>runBlocking</b></i> <font color="000066">(</font> <font color="05314d"><b>IO</b></font> <font color="000066">)</font> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="7f0055"><b>val</b></font> <font color="170591">prefetch</font> <font color="333333">=</font> <i><b>async</b></i> <font color="000066">(</font> <br> <font color="000066"><b>{</b></font> <font color="566874">userRepository</font> <font color="333333">.</font> <font color="170591">getUsersByChat</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>} }</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByChat</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>} }</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <br> <br> <i><b>withContext</b></i> <font color="000066">(</font> <font color="05314d"><b>IO</b></font> <font color="000066">)</font> <font color="000066"><b>{</b></font> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="3e7eff"><b>n</b></font> <font color="000066">)</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066">(</font> <br> <font color="170591">prefetch</font> <font color="333333">.</font> <font color="170591">await</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066">(</font> <font color="170591">users</font> <font color="333333">,</font> <font color="170591">files</font> <font color="000066">)</font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>recursiveMemoize</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>memoized</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>ChatPageMessage</b></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <i><b>toDomainModel</b></i> <font color="000066">(</font> <br> <font color="4a86e8">getUser =</font> <font color="170591">users</font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"User</b> <font color="333333"><b>$</b></font> <font color="000066"><i>it</i></font> <b>"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="4a86e8">getFile =</font> <font color="170591">files</font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"File</b> <font color="333333"><b>$</b></font> <font color="000066"><i>it</i></font> <b>"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="3f7f5f">//       </font> <br> <font color="4a86e8">serializeMessage =</font> <font color="000066"><i>memoized</i></font> <br> <font color="000066"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;</b></font> <font color="000066">}</font> <br> <font color="000066">}</font> <br> <br> <font color="7f0055"><b>private fun</b></font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="333333">.</font> <font color="170591"><b>toDomainModel</b></font> <font color="000066">(</font> <br> <font color="000066"><i>getUser</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>UserReference</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>UserRemote</b></font> <font color="333333">,</font> <br> <font color="000066"><i>getFile</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>FileReference</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="333333">,</font> <br> <font color="000066"><i>serializeMessage</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>ChatPageMessage</b></font> <br> <font color="000066">)</font> <font color="333333">=</font> <font color="170591">ChatPageMessage</font> <font color="000066">(</font> <br> <font color="4a86e8">id =</font> <font color="566874">id</font> ?: <font color="7f0055"><b>throw</b></font> <font color="170591">IllegalStateException</font> <font color="000066">(</font> <b>"</b> <font color="333333"><b>$</b></font> <font color="7f0055"><b>this</b></font> <b>must be persisted"</b> <font color="000066">)</font> <font color="333333">,</font> <br> <font color="4a86e8">author =</font> <font color="000066"><i>getUser</i></font> <font color="000066">(</font> <font color="566874">author</font> <font color="000066">)</font> <font color="333333">,</font> <br> <font color="4a86e8">message =</font> <font color="566874">message</font> <font color="333333">,</font> <br> <font color="4a86e8">files =</font> <font color="566874">files</font> <font color="333333">?.</font> <i><b>map</b></i> <font color="000066">(</font> <font color="000066"><i>getFile</i></font> <font color="000066">)</font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="4a86e8">forwardFrom =</font> <font color="566874">forwardFrom</font> <font color="333333">?.</font> <i><b>let</b></i> <font color="000066">(</font> <font color="000066"><i>serializeMessage</i></font> <font color="000066">)</font> <font color="333333">,</font> <br> <font color="4a86e8">replyTo =</font> <font color="566874">replyTo</font> <font color="333333">?.</font> <i><b>let</b></i> <font color="000066">(</font> <font color="000066"><i>serializeMessage</i></font> <font color="000066">)</font> <br> <font color="000066">)</font> <br></code> </div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultó que la función getLastPage en sí misma tiene una estrategia de adquisición de datos, incluida la captación previa, y la función toDomainModel es puramente técnica y es responsable de convertir los modelos almacenados en un modelo de dominio. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reescribí las llamadas paralelas a userRepository, fileRepository y messageRepository en una forma más familiar para Kotlin. Espero que la comprensión del código no haya sufrido por esto. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En general, dicho método ya está completamente operativo, el rendimiento al aplicarlo será el mismo que con el uso simple de ingeniería inversa o heurística empresarial.</font></font><br><br><a name="EnlargementOutside"></a> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La lógica de ampliar las consultas fuera del agregado</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> En el proceso de creación del agregado, inmediatamente encontraremos un problema: para construir ChatPage, el tamaño de página deberá establecerse como una constante al crear Chat, y no pasarlo a getLast (), como de costumbre. </font><font style="vertical-align: inherit;">Tendremos </font><font style="vertical-align: inherit;">que cambiar la interfaz agregada en sí: </font><font style="vertical-align: inherit;">dado que tenemos una hija de los mensajes restantes y queremos firmemente que todos los datos queden fuera del agregado, tendremos que abandonar por completo el agregado de nivel de Chat y hacer de ChatPage la raíz: a </font><font style="vertical-align: inherit;">continuación, debemos crear un código de </font><font style="vertical-align: inherit;">captación previa </font><font style="vertical-align: inherit;">separado del agregado: </font><font style="vertical-align: inherit;">ahora para eso Para crear un agregado, debe acoplarlo con captación previa. En DDD, este tipo de orquestación es realizada por Application Services.</font></font><br><br> <code><font color="7f0055"><b>interface</b></font> <font color="3e7eff"><b>Chat</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getPage</b></font> <font color="000066">()</font> : <font color="3e7eff"><b>ChatPage</b></font> <br> <font color="000066">}</font></code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code><font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>ChatPageImpl</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">messageData</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="333333">&gt;,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">userData</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>UserRemote</b></font> <font color="333333">&gt;,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">fileData</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="333333">&gt;</font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>ChatPage</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>override val</b></font> <font color="566874">messages</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatPageMessage</b></font> <font color="333333">&gt;</font> <br> <font color="7f0055"><b>get</b></font> <font color="000066">()</font> <font color="333333">=</font> <br> <font color="566874">messageData</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066">(</font> <br> <font color="000066">(</font> <font color="566874">userData</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> <i><b>to</b></i> <font color="566874">fileData</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066">(</font> <font color="170591">users</font> <font color="333333">,</font> <font color="170591">files</font> <font color="000066">)</font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>recursiveMemoize</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>self</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>ChatPageMessage</b></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <i><b>toDomainModel</b></i> <font color="000066">(</font> <br> <font color="4a86e8">getUser =</font> <font color="170591">users</font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="4a86e8">getFile =</font> <font color="170591">files</font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="3f7f5f">//       </font> <br> <font color="4a86e8">serializeMessage =</font> <font color="000066"><i>self</i></font> <br> <font color="000066"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <br> <font color="000066">}</font></code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code><font color="7f0055"><b>fun</b></font> <font color="170591"><b>chatPagePrefetch</b></font> <font color="000066">(</font> <br> <font color="000066"><i>pageSize</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="333333">,</font> <br> <font color="000066"><i>messageRepository</i></font> : <font color="3e7eff"><b>ChatMessageRepository</b></font> <font color="333333">,</font> <br> <font color="000066"><i>userRepository</i></font> : <font color="3e7eff"><b>UserRemoteApi</b></font> <font color="333333">,</font> <br> <font color="000066"><i>fileRepository</i></font> : <font color="3e7eff"><b>FileRemoteApi</b></font> <br> <font color="000066">)</font> <font color="333333">=</font> <br> <i><b>runBlocking</b></i> <font color="000066">(</font> <font color="05314d"><b>IO</b></font> <font color="000066">)</font> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>async</b></i> <font color="000066">(</font> <br> <font color="000066"><b>{</b></font> <font color="3e7eff"><b>userRepository</b></font> <font color="333333">.</font> <font color="170591">getUsersByChat</font> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="3e7eff"><b>fileRepository</b></font> <font color="333333">.</font> <font color="170591">getHeadsByChat</font> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="3e7eff"><b>messageRepository</b></font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="3e7eff"><b>pageSize</b></font> <font color="000066">)</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font></code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code><font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>ChatService</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">messageRepository</font> : <font color="3e7eff"><b>ChatMessageRepository</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">userRepository</font> : <font color="3e7eff"><b>UserRemoteApi</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">fileRepository</font> : <font color="3e7eff"><b>FileRemoteApi</b></font> <br> <font color="000066">) {</font> <br> <font color="7f0055"><b>private fun</b></font> <font color="170591"><b>chatPagePrefetch</b></font> <font color="000066">(</font> <font color="000066"><i>pageSize</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <i><b>runBlocking</b></i> <font color="000066">(</font> <font color="05314d"><b>IO</b></font> <font color="000066">)</font> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>async</b></i> <font color="000066">(</font> <br> <font color="000066"><b>{</b></font> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="3e7eff"><b>pageSize</b></font> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="566874">userRepository</font> <font color="333333">.</font> <font color="170591">getUsersByChat</font> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByChat</font> <font color="000066">()</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <font color="333333">.</font> <font color="170591">await</font> <font color="000066">()</font> <br> <font color="000066"><b>}</b></font> <br> <br> <font color="000066"><b>&nbsp;&nbsp;</b></font> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getLastPage</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>ChatPage</b></font> <font color="333333">=</font> <br> <font color="170591">chatPagePrefetch</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066">(</font> <font color="170591">messageData</font> <font color="333333">,</font> <font color="170591">userData</font> <font color="333333">,</font> <font color="170591">fileData</font> <font color="000066">)</font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="170591">ChatPageImpl</font> <font color="000066">(</font> <font color="170591">messageData</font> <font color="333333">,</font> <font color="170591">userData</font> <font color="333333">,</font> <font color="170591">fileData</font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066">}</font></code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bueno, el controlador no cambiará mucho, solo necesita usar ChatService :: getLastPage en lugar de Chat :: getLastPage. </font><font style="vertical-align: inherit;">Es decir, el código cambiará así:</font></font><br><br> <code><font color="7f0055"><b>class</b></font> ChatRestController <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">chat</font> : <font color="3e7eff"><b>ChatService</b></font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>ChatRestApi</b></font> <br></code> <br><br><a name="Summary3"></a>  <b>Conclusiones</b> <br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La lógica de captación previa se puede colocar dentro de la unidad o en un lugar separado. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si la lógica de captación previa está fuertemente relacionada con la lógica interna del agregado, es mejor no eliminarla, ya que esto puede interrumpir la encapsulación. </font><font style="vertical-align: inherit;">Personalmente, no veo mucho sentido sacar la captación previa del agregado, ya que esto limita en gran medida las posibilidades y aumenta la coherencia implícita del código.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La organización agregada en sí misma tiene un efecto positivo en el rendimiento del procesamiento por lotes, ya que el control sobre las solicitudes pesadas se vuelve más y el lugar para la lógica de captación previa se vuelve bastante definido. </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> En el próximo capítulo, consideraremos una implementación de captación previa que no puede implementarse aisladamente de la función principal. </font></font><br><br><a name="Proxying"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Proxy y doble llamada </font></font></h4><br><a name="ManagingContractProblem2"></a> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resolviendo el problema del contrato</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Como ya discutimos en las partes anteriores, el principal problema del contrato de captación previa es que está fuertemente conectado con el contrato de la función para la cual debe preparar los datos. </font><font style="vertical-align: inherit;">Para ser más precisos, depende de qué datos pueda necesitar la función principal. </font><font style="vertical-align: inherit;">¿Qué pasa si no tratamos de predecir, pero intentamos hacer ingeniería inversa usando el código mismo? </font><font style="vertical-align: inherit;">En situaciones simples, el enfoque proxy comúnmente utilizado en las pruebas puede ayudarnos. </font><font style="vertical-align: inherit;">Las bibliotecas como Mockito generan clases con implementaciones de interfaz, que también pueden acumular información sobre las llamadas. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un enfoque similar se utiliza en nuestra biblioteca</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si llama a la función principal con repositorios proxy y recopila información sobre los datos necesarios, puede obtener estos datos en forma de paquete y volver a llamar a la función principal para obtener el resultado final. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La condición principal es la siguiente: los datos solicitados no deberían afectar las solicitudes posteriores. El proxy no devolverá datos reales, sino solo algunos apéndices, por lo que desaparecerán todas las ramificaciones y la recepción de los datos asociados. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En nuestro caso, esto significa que es inútil usar proxy messageRepository, ya que se realizan más solicitudes en función de los resultados de la solicitud del mensaje. Esto no es un problema, ya que solo tenemos una solicitud para messageRepository, por lo que no se requiere procesamiento por lotes aquí.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dado que representaremos las funciones simples UserReference-&gt; UserRemote y FileReference-&gt; FileHeadRemote, solo necesita acumular dos listas de argumentos. </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como resultado, obtenemos lo siguiente:</font></font></b> <div class="spoiler_text"> <code><font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>ChatRestController</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">messageRepository</font> : <font color="3e7eff"><b>ChatMessageRepository</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">userRepository</font> : <font color="3e7eff"><b>UserRemoteApi</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">fileRepository</font> : <font color="3e7eff"><b>FileRemoteApi</b></font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>ChatRestApi</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>override fun</b></font> <font color="170591"><b>getLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="333333">&gt;</font> <font color="000066">{</font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">messages</font> <font color="333333">=</font> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <br> <font color="3f7f5f">//    </font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>transform</b></font> <font color="000066">(</font> <br> <font color="000066"><i>getUser</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>UserReference</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>UserRemote</b></font> <font color="333333">,</font> <br> <font color="000066"><i>getFile</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>FileReference</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <br> <font color="3e7eff"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="333333">&gt; =</font> <br> <font color="3e7eff"><b>messages</b></font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066">(</font> <br> <i><b>recursiveMemoize</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>self</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">(</font> <font color="000066"><i>getUser</i></font> <font color="333333">,</font> <font color="000066"><i>getFile</i></font> <font color="333333">,</font> <font color="000066"><i>self</i></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <br> <br> <font color="3f7f5f">//  </font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">userIds</font> <font color="333333">=</font> <i><b>mutableSetOf</b></i> <font color="333333">&lt;</font> <font color="3e7eff"><b>UserReference</b></font> <font color="333333">&gt;</font> <font color="000066">()</font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">fileIds</font> <font color="333333">=</font> <i><b>mutableSetOf</b></i> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileReference</b></font> <font color="333333">&gt;</font> <font color="000066">()</font> <br> <font color="170591">transform</font> <font color="000066">(</font> <br> <font color="000066"><b>{</b></font> <font color="3e7eff"><b>userIds</b></font> <font color="333333">+=</font> <b>it</b> <font color="333333">;</font> <font color="170591">UserRemote</font> <font color="000066">(</font> <font color="333333"><b>0L</b></font> <font color="333333">,</font> <b>""</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="3e7eff"><b>fileIds</b></font> <font color="333333">+=</font> <font color="000066"><i>it</i></font> <font color="333333">;</font> <font color="170591">FileHeadRemote</font> <font color="000066">(</font> <font color="333333"><b>0L</b></font> <font color="333333">,</font> <b>""</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <br> <br> <font color="7f0055"><b>return</b></font> <i><b>runBlocking</b></i> <font color="000066">(</font> <font color="05314d"><b>IO</b></font> <font color="000066">)</font> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//      </font> <br> <i><b>async</b></i> <font color="000066">(</font> <br> <font color="000066"><b>{</b></font> <font color="566874">userRepository</font> <font color="333333">.</font> <font color="170591">getUsersByIds</font> <font color="000066">(</font> <font color="3e7eff"><b>userIds</b></font> <font color="000066">)</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByIds</font> <font color="000066">(</font> <font color="3e7eff"><b>fileIds</b></font> <font color="000066">)</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <font color="333333">.</font> <font color="170591">await</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066">(</font> <font color="170591">getUser</font> <font color="333333">,</font> <font color="170591">getFile</font> <font color="000066">)</font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="170591">transform</font> <font color="000066">(</font> <font color="170591">getUser</font> <font color="333333">,</font> <font color="170591">getFile</font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;</b></font> <font color="000066">}</font> <br> <font color="000066">}</font></code> </div> </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si mide el rendimiento, resulta que con este enfoque no es peor que usar métodos de ingeniería inversa, aunque llamamos a la función dos veces. Esto se debe al hecho de que, en comparación con el tiempo de ejecución de consultas externas, el tiempo de ejecución de la función de conversión puede descuidarse (en nuestro caso). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En comparación con el rendimiento cuando se utiliza la heurística empresarial, en nuestro caso, la acumulación de consultas será menos efectiva. Pero tenga en cuenta que no siempre es posible encontrar tan buenas heurísticas. Por ejemplo, si el número de usuarios en el chat es grande, al igual que el número de archivos, y los archivos rara vez se adjuntan a los mensajes, nuestro algoritmo sobre heurística empresarial comenzará a perder de inmediato al recibir honestamente una lista de solicitudes.</font></font><br><br><a name="Summary4"></a>  <b>Conclusiones</b> <br><br>  Pros: <br><br><ol><li>   prefetch   -   . </li><li>          prefetch. </li><li>    ,   -. </li></ol><br>  Contras: <br><br><ol><li>       . </li><li>  ,     . </li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A pesar del aparente exotismo, la acumulación de solicitudes a través de proxy y recuperación es bastante aplicable en situaciones en las que la lógica de la función principal no está vinculada a los datos recibidos. La principal dificultad aquí es la misma que con la ingeniería inversa: estamos aplicando la implementación actual de la función, aunque en un grado mucho menor (solo en el hecho de que las siguientes consultas no dependen de los resultados de consultas anteriores). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El rendimiento disminuirá ligeramente, pero en el código de captación previa no tendrá que tener en cuenta todos los matices de la implementación de la función principal. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puede usar este enfoque cuando no pueda construir una buena heurística comercial para la predicción de consultas y desee reducir la conectividad de captación previa y función.</font></font><br><br><a name="Conclusion"></a><h2>  Conclusión </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usar el procesamiento por lotes no es tan simple como parece a primera vista. Creo que todos los patrones de diseño tienen esta propiedad (recuerde el almacenamiento en caché). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para un procesamiento por lotes eficiente de las solicitudes, es importante que la persona que llama recopile tantas solicitudes como sea posible, lo que a menudo se ve obstaculizado por la estructura de la aplicación. Hay dos formas de salir: diseñar la aplicación con el fin de trabajar eficientemente con datos (puede muy bien conducir a un dispositivo reactivo de la aplicación) o, como sucede a menudo, tratar de implementar el procesamiento por lotes en una aplicación existente sin una reestructuración significativa.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La forma más obvia de acumular consultas es realizar ingeniería inversa del código existente en busca de consultas pesadas. </font><font style="vertical-align: inherit;">El principal inconveniente de este enfoque será un aumento en la conectividad de código implícito. </font><font style="vertical-align: inherit;">Una alternativa es utilizar la información sobre las características comerciales para dividir los datos en fragmentos, que a menudo se comparten y en su conjunto. </font><font style="vertical-align: inherit;">A veces, para una separación tan efectiva, será necesario desnormalizar el almacenamiento, pero si esto tiene éxito, la lógica del procesamiento por lotes estará determinada por el área temática, lo cual es bueno. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Una forma menos obvia de obtener todas las solicitudes es implementar dos pases. </font><font style="vertical-align: inherit;">En la primera etapa, recopilamos todas las solicitudes necesarias, en la segunda trabajamos con los datos ya recibidos. </font><font style="vertical-align: inherit;">La aplicabilidad de este enfoque está limitada por el requisito de independencia de las solicitudes entre sí.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/467919/">https://habr.com/ru/post/467919/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../467905/index.html">Cómo hicimos un reconocimiento histórico en Cloud Mail.ru y por qué</a></li>
<li><a href="../467907/index.html">Pros y contras de la subcontratación</a></li>
<li><a href="../467913/index.html">Cómo mejorar el "mineral bastardo", o la nueva interfaz para el panel solar</a></li>
<li><a href="../467915/index.html">Monitoreo de postgres dentro de Openshift</a></li>
<li><a href="../467917/index.html">Plantillas de gestión</a></li>
<li><a href="../467921/index.html">Saque plumas polvorientas: la escritura a mano es buena para el cerebro</a></li>
<li><a href="../467923/index.html">Por lo tanto, desea convertirse en un analista en el campo de la seguridad de la red ...</a></li>
<li><a href="../467925/index.html">¿Por qué los desarrolladores aman tanto el tema oscuro?</a></li>
<li><a href="../467929/index.html">Organizamos el caos o cómo implementar un enfoque basado en procesos en una organización</a></li>
<li><a href="../467933/index.html">Y, sin embargo, por qué Posit es una alternativa digna a IEEE 754</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>