<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>  Б C贸mo comenzar un proyecto de mascotas y no obtener beneficios   锔</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="TL; DR 

 El art铆culo describe el uso del proyecto mascota como una forma de mantener y mejorar las habilidades. El autor cre贸 una biblioteca PHP para...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C贸mo comenzar un proyecto de mascotas y no obtener beneficios</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479122/"><p><img src="https://habrastorage.org/webt/cz/x-/ln/czx-lnrbjewed61t5fm8k_pjvei.png" alt="C贸mo comenzar un proyecto de mascotas y no obtener beneficios"></p><br><div class="spoiler">  <b class="spoiler_title">TL; DR</b> <div class="spoiler_text"><p>  El art铆culo describe el uso del proyecto mascota como una forma de mantener y mejorar las habilidades.  El autor cre贸 una <a href="https://github.com/liquetsoft/fias-symfony" rel="nofollow">biblioteca PHP</a> para instalar <a href="https://fias.nalog.ru/" rel="nofollow">FIAS a</a> partir de archivos XML. </p></div></div><br><h2 id="cel">  Prop贸sito </h2><br><p>  Raramente cambio de trabajo, por lo tanto, dado el deseo natural de cada organizaci贸n por procesos fijos, cualquier tarea se convierte en una rutina.  Por un lado, es beneficioso para una empresa mantener ese estado, por otro lado, para m铆 esto significa una p茅rdida completa u obsolescencia de habilidades.  PHP se est谩 desarrollando r谩pidamente y, en consecuencia, el retraso potencial tambi茅n est谩 creciendo r谩pidamente.  Finalmente, todos sabemos que hoy en d铆a es dif铆cil para un programador encontrar un buen trabajo sin el conocimiento de Elasticsearch, RabbitMQ, Kafka y otras tecnolog铆as que no aparecen a menudo en mi trabajo diario. </p><a name="habracut"></a><br><p>  Despu茅s de comenzar el siguiente sitio t铆pico, decid铆 que era hora de cambiar algo.  No quer铆a cambiar mi trabajo, pero record茅 c贸mo en una de las conferencias el orador recomend贸 usar su propio proyecto opcional, el llamado proyecto mascota, para la capacitaci贸n.  El m茅todo parec铆a apropiado y decid铆 probarlo. </p><br><h2 id="vybor-zadachi">  Selecci贸n de tareas </h2><br><p>  La elecci贸n de la tarea result贸 ser la parte m谩s dif铆cil de la empresa.  No se me ocurri贸 nada especial: algunos servicios, como un analizador de trabajos que se pueden implementar f谩cilmente en una pila familiar.  Abandon茅 la idea del proyecto durante varios meses, hasta que accidentalmente vi las noticias sobre el hackathon del Ministerio de Finanzas.  Sugiri贸 usar una de la lista de fuentes de datos abiertas para crear un servicio.  Entre otros, tambi茅n se indic贸 el Sistema Federal de Direcciones de Informaci贸n (FIAS).  Desafortunadamente, el hackathon ya hab铆a terminado para entonces. </p><br><p>  Aprend铆 sobre FIAS por primera vez, pero la tarea me pareci贸 interesante.  Juzgue usted mismo: aproximadamente 30 GB de archivos XML, aproximadamente 60 millones de l铆neas en la base de datos y, adem谩s, la biblioteca podr铆a resultar 煤til en el trabajo.  Hab铆a algunas soluciones listas para usar en Github, pero eso no me detuvo.  Por el contrario, en base a su an谩lisis, hice requisitos adicionales que destacar铆an mi implementaci贸n. </p><br><p>  Mirando hacia el futuro, noto que me encontr茅 con muchas menos dificultades de las que esperaba. </p><br><h2 id="formulirovka-zadachi">  Declaraci贸n de tarea </h2><br><p>  El 90% del 茅xito es la declaraci贸n correcta del problema.  Despu茅s de varios a帽os de trabajo de plantilla, fue bastante dif铆cil lograr formular claramente el problema.  Solo quer铆a comenzar a trabajar, pero ya en el proceso todo se habr铆a aclarado por s铆 solo.  Despu茅s de una hora de lucha con la dilaci贸n, finalmente escrib铆: crear una biblioteca en PHP para importar datos FIAS. </p><br><p>  M谩s tarde, despu茅s de probarlo, agregu茅 algunos requisitos adicionales: </p><br><ul><li>  implementaci贸n en PHP sin utilizar utilidades de terceros, c贸digo exclusivo en PHP y extensiones de PECL, </li><li>  importaci贸n de todos los datos del conjunto FIAS, </li><li>  instalaci贸n completa y ciclo de actualizaci贸n: b煤squeda de la versi贸n necesaria, recepci贸n del archivo, desempaquetado, escritura en la base de datos, </li><li>  M谩xima flexibilidad: la capacidad de cambiar la ubicaci贸n de almacenamiento, modificar los datos antes de grabar, filtrar lo necesario, etc. </li><li>  La biblioteca debe integrarse f谩cilmente en los proyectos existentes. </li></ul><br><h2 id="fias">  FIAS </h2><br><p>  FIAS tiene un <a href="https://fias.nalog.ru/" rel="nofollow">sitio web oficial</a> que nos brinda la definici贸n y el prop贸sito de crear un sistema </p><br><blockquote>  El Sistema de Direcciones de Informaci贸n Federal (FIAS) es el sistema de informaci贸n del estado federal que proporciona la formaci贸n, mantenimiento y uso del registro de direcciones del estado. <br><br>  El prop贸sito de crear el FIAS es la formaci贸n de un 煤nico recurso federal que contenga informaci贸n de direcciones estructurada, confiable, uniforme y p煤blicamente disponible.  Gracias a la implementaci贸n de FIAS, esta informaci贸n se puede obtener de forma gratuita a trav茅s de Internet en el portal oficialmente registrado de FIAS. </blockquote><p>  Los materiales con una descripci贸n son suficientes tanto en <a href="https://fias.nalog.ru/Updates.aspx" rel="nofollow">el sitio web de FIAS</a> como en el <a href="https://habr.com/ru/search/%3Fq%3D%25D0%25A4%25D0%2598%25D0%2590%25D0%25A1">Habr茅</a> , por lo tanto, no me centrar茅 en esto. </p><br><p>  En resumen  FIAS viene en dos formatos: FIAS y KLADR.  El segundo est谩 en desuso y ya no est谩 en uso.  La informaci贸n se almacena en DBF o en XML.  Cada cambio en la composici贸n de FIAS est谩 marcado con una nueva versi贸n.  Puede solicitar un paquete con datos completos que est茅 actualizado en este momento o que solo contenga cambios entre las dos versiones.  Links proporciona un servicio SOAP.  El paquete es un archivo RAR que contiene archivos con nombres especialmente formados.  Consisten en un prefijo, un nombre de conjunto de datos y una fecha de generaci贸n.  Hay dos tipos de prefijos: AS_ para archivos desde los que se deben agregar datos a la base de datos, y AS <em>DEL</em> para archivos cuyos datos se deben eliminar de la base de datos. </p><br><p>  FIAS contiene los siguientes datos: </p><br><ul><li>  registro de elementos formadores de direcciones (este es el gr谩fico de direcciones: regiones, ciudades y calles), </li><li>  elementos de direcci贸n que identifican objetos direccionables (n煤mero de casa y datos de la casa), </li><li>  informaci贸n sobre terrenos </li><li>  informaci贸n sobre el local (apartamentos, oficinas, habitaciones, etc.), </li><li>  informaci贸n sobre el documento normativo, que es la base para la asignaci贸n del nombre al elemento de direcci贸n. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Adem谩s de varios diccionarios</b> <div class="spoiler_text"><ul><li>  una lista de posibles valores de los intervalos de las casas (regular, par, impar), </li><li>  Una lista de estados de relevancia de una entrada de un elemento de direcci贸n por el clasificador KLADR4.0 </li><li>  una lista de estados de relevancia de una entrada de un elemento de direcci贸n de acuerdo con FIAS, </li><li>  una lista de nombres completos y abreviados de tipos de elementos de direcci贸n y sus niveles de clasificaci贸n, </li><li>  lista de tipos de edificios, </li><li>  lista de posibles tipos de propiedad </li><li>  lista de c贸digos de operaciones con objetos direccionables, </li><li>  una lista de posibles condiciones de bienes inmuebles, </li><li>  lista de tipos de locales u oficinas, </li><li>  lista de tipos de habitaciones, </li><li>  lista de posibles estados (centros) de objetos de direcci贸n de unidades administrativas, </li><li>  tipos de documentos reglamentarios. </li></ul></div></div><br><p>  La estructura de datos se describe en el documento, que se puede encontrar <a href="https://fias.nalog.ru/Updates.aspx" rel="nofollow">en la secci贸n de actualizaciones</a> . </p><br><p>  En definitiva, tenemos un algoritmo de instalaci贸n FIAS bastante simple y lineal: </p><br><ul><li>  obtener del servicio SOAP un enlace al archivo y el n煤mero de versi贸n actual, </li><li>  descargar archivo, </li><li>  desempacar </li><li>  escribe en la base de datos todos los datos de los archivos con el prefijo AS_, </li><li>  eliminar de la base de datos todos los datos de los archivos con el prefijo AS <em>DEL</em> (s铆, es cierto, durante la instalaci贸n tambi茅n debe eliminar algunos de los datos) </li><li>  anote el n煤mero de la versi贸n instalada. </li></ul><br><p>  Y no menos simple algoritmo de actualizaci贸n: </p><br><ul><li>  obtener del servicio SOAP una lista con n煤meros de versi贸n y enlaces a archivos con cambios, </li><li>  si la versi贸n actual en la base de datos local es la 煤ltima, entonces detenga la ejecuci贸n, </li><li>  obtener un enlace al archivo con los cambios a la pr贸xima versi贸n, </li><li>  descargar archivo, </li><li>  desempacar </li><li>  escribe en la base de datos todos los datos de los archivos con el prefijo AS_, </li><li>  eliminar de la base de datos todos los datos de los archivos con el prefijo AS <em>DEL</em> , </li><li>  anote el n煤mero de la versi贸n actualizada, </li><li>  volver al primer paso </li></ul><br><p>  FIAS deja impresiones contradictorias.  Por un lado: automatizaci贸n completa de todo el proceso, formatos abiertos, buena documentaci贸n.  Por otro lado: una extra帽a decisi贸n de usar RAR patentado para datos abiertos;  diferencias entre documentaci贸n y realidad (principalmente relacionadas con atributos obligatorios), que causan muchos problemas peque帽os pero desagradables;  ocasionalmente vienen archivos que no se pueden desempaquetar en Linux;  algunos deltas entre versiones ocupan 4-5 GB. </p><br><h2 id="arhitektura">  Arquitectura </h2><br><p>  Cada biblioteca debe basarse en una idea b谩sica, un n煤cleo alrededor del cual crecer谩 el resto de la funcionalidad.  El patr贸n de "cadena de deberes" me pareci贸 la mejor opci贸n para el papel de tal idea.  En primer lugar, es ideal: varias operaciones secuenciales que una persona hubiera realizado si hubiera querido instalar FIAS manualmente son obvias para el desarrollador y encajan bien en clases peque帽as escritas en el estilo SOLID.  En segundo lugar, dicha cadena se expande muy f谩cilmente con nuevas operaciones en casi cualquier etapa, lo que proporciona una buena flexibilidad.  En tercer lugar, hace tiempo que quer铆a escribir mi propia implementaci贸n. </p><br><p>  Adem谩s de las operaciones, he creado varios servicios que pueden transferirse usando DI.  Le permiten reutilizar el c贸digo, reemplazar f谩cilmente la implementaci贸n para tareas del sistema de bajo nivel (descargar un archivo, desempaquetar un archivo, escribir en una base de datos y otros) y proporcionar una buena cobertura con las pruebas gracias a los simulacros. </p><br><p>  Como resultado, la biblioteca contiene cuatro tipos principales de objetos, para cada uno de los cuales el 谩rea de responsabilidad est谩 claramente definida: </p><br><ul><li>  servicios: proporcionan herramientas para realizar tareas de sistema de bajo nivel, </li><li>  objeto de estado: almacena informaci贸n para la transmisi贸n entre operaciones, </li><li>  operaciones: utilizando los servicios y el estado en que implementan la parte at贸mica de la l贸gica empresarial, </li><li>  cadena de operaciones: realiza operaciones y transfiere el estado entre ellas. </li></ul><br><p>  Usando el enlace de operaciones y servicios proporcionados por la biblioteca, puede obtener f谩cilmente cualquier nueva cadena o complementar la existente utilizando solo archivos de configuraci贸n. </p><br><h2 id="freymvorki">  Marcos </h2><br><p>  Con pausas largas y refactorizaci贸n constante, trabaj茅 en la biblioteca durante un a帽o y medio. </p><br><p>  La primera versi贸n relativamente estable estaba lista en dos meses de trabajo por las tardes.  De hecho, podr铆a existir por separado del marco y contener todo lo necesario: un script de entrada para ejecutar en la consola, un contenedor DI, un complemento para PDO, su propio registrador y migraciones de estructura de base de datos, de lo que estaba muy orgulloso. </p><br><p>  Por supuesto, sus colegas la rechazaron sin piedad. </p><br><p>  El principal argumento en contra de esto fue la falta de apoyo a los marcos populares.  Nadie quer铆a escribir un contenedor separado para la biblioteca.  Debido a esto, comet铆 el error m谩s costoso a tiempo: comenc茅 a admitir tanto la versi贸n independiente como los contenedores individuales para cada marco.  Los archivos FIAS reales son diferentes de lo que est谩 escrito en la documentaci贸n.  Cada vez que era necesario eliminar o agregar, por ejemplo, no nulo en la descripci贸n de la columna, ten铆a que hacer cambios en tres repositorios.  Debido a lo tedioso del proceso, el trabajo se detuvo por otros seis meses. </p><br><p>  La sensaci贸n de incompletitud me atorment贸 todo este tiempo y despu茅s de una sangrienta batalla contra la pereza me oblig贸 a volver a dise帽ar una nueva versi贸n.  Para empezar, decid铆 que nadie necesita una biblioteca independiente, lo que significa que debe eliminar todos los servicios que proporcionan marcos del paquete, reemplaz谩ndolos por interfaces.  As铆 que nos metimos debajo del cuchillo: un script de entrada para ejecutar en la consola, un contenedor DI, un complemento sobre PDO, nuestro propio registrador y migraciones de la estructura de la base de datos.  A continuaci贸n, decid铆 hacer paquetes separados para cada marco, que conectar谩n todas las partes desde el principal a un script de trabajo y proporcionar谩n implementaciones espec铆ficas de servicios. </p><br><p>  El punto clave fue el modelo.  Actualizar constantemente conjuntos heterog茅neos de objetos en varios repositorios no quer铆a.  Al mismo tiempo, en el trabajo principal, obtuve un proyecto en Symfony.  Despu茅s de conocerlo r谩pidamente, decid铆 que la caracter铆stica m谩s 煤til de SF es la generaci贸n de c贸digo y resolver谩 todos mis problemas.  <a href="" rel="nofollow">Cre茅</a> un <a href="" rel="nofollow">archivo yaml</a> en el paquete principal, que contiene una descripci贸n declarativa de los datos FIAS.  Luego agregu茅 generadores de c贸digo que crean clases espec铆ficas para modelos basados en esta descripci贸n: entidades de Doctrine para Symfony y objetos Eloquent para Laravel.  Durante el desarrollo de los generadores, me di cuenta de que las plantillas de ramitas no eran adecuadas para esto, y me decid铆 por una soluci贸n especializada: <a href="https://github.com/nette/php-generator" rel="nofollow">Nette PHP Generator</a> . </p><br><p>  Como prueba de concepto, cre茅 paquetes para <a href="https://github.com/liquetsoft/fias-laravel" rel="nofollow">Laravel</a> y <a href="https://github.com/liquetsoft/fias-symfony" rel="nofollow">Symfony</a> .  Como trabaj茅 m谩s tiempo con el segundo, describir茅 todo lo posterior en su contexto. </p><br><h2 id="infrastruktura">  La infraestructura </h2><br><p>  La mayor铆a de mis proyectos de combate se escribieron sobre tecnolog铆as obsoletas, por lo que no pude usar analizadores de c贸digo modernos en ninguno de ellos.  Deshaci茅ndome de la opresi贸n heredada, instal茅 y configur茅 todas las herramientas de control de calidad de c贸digo que pude: </p><br><ul><li>  <a href="https://github.com/vimeo/psalm" rel="nofollow">Salmo</a> para la verificaci贸n de tipo, </li><li>  <a href="https://scrutinizer-ci.com/" rel="nofollow">Escrutinio</a> para la evaluaci贸n general de la calidad (ayuda <a href="https://scrutinizer-ci.com/" rel="nofollow">mucho</a> con la complejidad ciclom谩tica) </li><li>  <a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer" rel="nofollow">PHP Fixing Standards Fixer</a> para verificar el estilo del c贸digo, </li><li>  <a href="https://github.com/sebastianbergmann/phpcpd" rel="nofollow">PHP Copiar / Pegar Detector</a> para encontrar duplicados, </li><li>  <a href="https://github.com/sebastianbergmann/phpunit" rel="nofollow">PHPUnit</a> para ejecutar pruebas unitarias. </li></ul><br><p>  Validaci贸n integrada en Github usando <a href="https://travis-ci.org/" rel="nofollow">Travis</a> .  Como toque final, agreg贸 un archivo Docker para crear un entorno de desarrollador local completo con un archivo make que contiene los comandos b谩sicos para el contenedor (lanzamiento de comprobaciones, pruebas, creaci贸n de modelos y otros). </p><br><h2 id="itogi-obucheniya">  Resultados de aprendizaje </h2><br><h3 id="php-7">  PHP 7 </h3><br><p>  Antes de comenzar a trabajar en la biblioteca, nunca us茅 las <a href="https://www.php.net/manual/ru/migration70.new-features.php" rel="nofollow">nuevas caracter铆sticas de PHP 7</a> .  Son hermosos: desde tipos estrictos hasta un aumento significativo en la productividad.  Un agradecimiento especial a los desarrolladores por el operador de fusi贸n nula.  No he visto una disminuci贸n tan grave en la base del c贸digo despu茅s de la introducci贸n de un operador. </p><br><h3 id="rar">  Rar </h3><br><p>  Sorprendentemente, en PECL hab铆a un <a href="https://www.php.net/manual/ru/book.rar.php" rel="nofollow">paquete para trabajar con RAR</a> .  Por lo general, tales extensiones no son confiables y trato de evitarlas.  Esto result贸 ser sospechosamente estable: se instal贸 en 7.2 sin problemas, fue capaz de descomprimir archivos enormes relativamente r谩pido y con un bajo consumo de RAM (6 GB se desempacan en 10-20 minutos dependiendo de los recursos del sistema disponibles).  Todav铆a temo que esto sea una manifestaci贸n de la ley de Murphy. </p><br><h3 id="xmlreader">  Xmlreader </h3><br><p>  Leer archivos xml gigantes no es una tarea trivial.  Y de nuevo la extensi贸n PECL vino al rescate: <a href="https://www.php.net/manual/ru/book.xmlreader.php" rel="nofollow">XmlReader</a> .  No me di cuenta de inmediato de todo su poder, pero en varios enfoques lo adapt茅 junto con el <a href="https://symfony.com/doc/current/components/serializer.html" rel="nofollow">serializador de Symfony</a> para obtener datos de archivos FIAS de manera r谩pida y econ贸mica.  En el lado de la biblioteca, el objeto lector implementa la interfaz iteradora, que devuelve secuencialmente las cadenas xml correspondientes a un registro en el archivo.  Usando el serializador de Symfony, estas cadenas se convierten en objetos.  Un archivo de 20 GB se puede leer en 3-4 minutos sin usar m谩s de 50 MB de RAM. </p><br><h3 id="zapis-v-bazu-dannyh">  Escribir en la base de datos </h3><br><p>  Por supuesto, comenc茅 con matrices asociativas con datos y descripciones de tablas voluminosas.  El c贸digo se convirti贸 r谩pidamente en un hash de configuraciones y clases de convertidor. </p><br><p>  La magia de las entidades de Doctrina mostr贸 c贸mo los objetos pueden autodescribirse.  Decid铆 usar el mismo enfoque, pero al mismo tiempo deshacerme de mi propia implementaci贸n de escribir datos en la base de datos usando PDO.  En cambio, cre茅 una interfaz de almacenamiento que describe m茅todos para procesar objetos.  Seg煤n la clase de entidad, una implementaci贸n de almacenamiento particular decide exactamente c贸mo y d贸nde escribir los datos.  Este enfoque facilit贸 la conexi贸n de una amplia variedad de almacenamientos: desde MySql a archivos csv. </p><br><h3 id="optimizaciya-vstavki-dannyh">  Optimizaci贸n de inserci贸n de datos </h3><br><p>  Interrump铆 la primera importaci贸n despu茅s de que excediera en 48 horas.  Se hizo evidente que necesita optimizar el proceso de inserci贸n de datos. </p><br><p>  Primero, <a href="https://www.postgresql.org/docs/12/datatype-uuid.html" rel="nofollow">cambi茅 a las columnas de tipo ugid</a> para claves primarias <a href="https://www.postgresql.org/docs/12/datatype-uuid.html" rel="nofollow">integradas en PostgreSql</a> .  Escribir en una columna uuid con un 铆ndice es mucho m谩s r谩pido que escribir en una cadena. </p><br><p>  Despu茅s de esto, abandon茅 todos los 铆ndices no cr铆ticos y las claves externas, ya que la preocupaci贸n por la integridad de los datos est谩 completamente del lado del equipo de FIAS. </p><br><p> Luego rehice la interfaz de almacenamiento para que el script externo pueda informarle expl铆citamente sobre la finalizaci贸n de la importaci贸n.  Esto permiti贸 el uso de inserci贸n masiva, que a veces aceler贸 la grabaci贸n.  <a href="https://www.postgresql.org/docs/current/populate.html" rel="nofollow">Buscando informaci贸n,</a> tambi茅n encontr茅 el comando <a href="https://www.postgresql.org/docs/current/sql-copy.html" rel="nofollow"><code>copy</code></a> junto con <a href="https://www.postgresql.org/docs/current/functions-xml.html" rel="nofollow"><code>query_to_xml</code></a> .  Ten铆a dos grandes inconvenientes: en primer lugar, el usuario de PostgreSql deb铆a tener permisos de lectura para el archivo, lo que no pod铆a garantizar, y en segundo lugar, la capacidad de modificar datos dentro del script antes de que se perdiera la escritura. </p><br><p>  A pesar de estos cambios, el tiempo de importaci贸n super贸 las 30 horas.  Se necesitaba un cambio radical de enfoque. </p><br><h3 id="parallelnye-processy">  Procesos paralelos </h3><br><p>  Internet est谩 repleto de art铆culos sobre asincron铆a en PHP.  Mi elecci贸n recay贸 en el <a href="https://amphp.org/" rel="nofollow">amplificador</a> .  Simplemente no funcion贸 de forma asincr贸nica.  En primer lugar, el c贸digo se convirti贸 r谩pidamente en una aterradora hoja de devoluciones de llamadas y llamadas no obvias (probablemente sea mi culpa, no el enfoque asincr贸nico).  En segundo lugar, tuve que abandonar el uso de ORM est谩ndar porque se necesitan llamadas sin bloqueo a la base de datos a trav茅s de un <a href="https://github.com/amphp/mysql" rel="nofollow">marco especial</a> .  En tercer lugar, aunque existen condiciones bajo las cuales PostgreSql puede insertar filas en paralelo, son <a href="" rel="nofollow">extremadamente</a> <a href="https://wiki.postgresql.org/wiki/Parallel_Query" rel="nofollow">dif铆ciles de</a> cumplir.  Como resultado, despu茅s de 5 horas de trabajo, vi todas mis solicitudes asincr贸nicas "sincronizadas" a la fuerza en el lado de la base de datos. </p><br><p>  Pero la importaci贸n est谩 bien dividida en procesos paralelos: varias tareas completamente independientes que no tienen recursos comunes por los cuales podr铆an competir, y datos que podr铆an intercambiar.  Adem谩s, en el marco de un hilo, recib铆 un c贸digo hermoso y lineal. </p><br><p>  El primero decid铆 probar la extensi贸n <a href="https://www.php.net/manual/ru/book.parallel.php" rel="nofollow">paralela</a> .  Tiene un defecto fatal: el int茅rprete debe estar construido con soporte para ZTS (Zend Thread Safety).  Dado que ZTS no funciona en los scripts web normales, habr铆a que tener dos versiones diferentes del int茅rprete.  Uno, sin ZTS, para web, el segundo, con ZTS, para instalar FIAS.  El potencial aumento del rendimiento super贸 este inconveniente, especialmente teniendo en cuenta lo f谩cil que es ensamblar un nuevo contenedor Docker y usarlo junto con el anterior.  Desafortunadamente, iniciar Symfony dentro de un nuevo hilo caus贸 que la pila de PHP se desbordara, y no estaba listo para rechazar el contenedor DI y la configuraci贸n conveniente. </p><br><p>  Finalmente, encontr茅 el <a href="https://symfony.com/doc/current/components/process.html" rel="nofollow">proceso de Symfony</a> .  De hecho, inicia un nuevo proceso para el comando de consola especificado y supervisa su finalizaci贸n.  Tuve que agregar dos cadenas adicionales.  El primero descarga el archivo, lo descomprime e inicia procesos paralelos para el procesamiento de datos.  El segundo toma una lista de archivos del argumento de la l铆nea de comando y escribe su contenido en la base de datos. </p><br><p>  Debido a la falta de experiencia con procesos paralelos, parece que he cometido todos los errores de novato. </p><br><p>  Por ejemplo, mi proceso de inicio verific贸 la finalizaci贸n de los ni帽os usando un bucle infinito y, por supuesto, estaba gastando indecentemente muchos recursos de procesador en esto.  La llamada de sue帽o entre iteraciones ayud贸. </p><br><p>  En la primera implementaci贸n, los archivos se distribuyeron de manera desigual entre los procesos.  Los dos m谩s grandes cayeron en una secuencia, que se proces贸 durante m谩s de 20 horas.  En la segunda implementaci贸n, agregu茅 un administrador especial que distribuye archivos en funci贸n del tiempo que lleva importarlos.  Ahora los procesos se cargan de manera uniforme. </p><br><p>  Despu茅s de estas ediciones, pude importar la versi贸n completa de FIAS en 16-20 horas, dependiendo de los recursos del servidor.  No es tan bueno como nos gustar铆a, pero sigo trabajando en la optimizaci贸n.  El siguiente paso es un rechazo completo de PostgreSql a favor de Elasticsearch. </p><br><h2 id="vyvody">  Conclusiones </h2><br><p>  驴Vali贸 la pena?  驴Dos a帽os de trabajo en una biblioteca que nunca entr贸 en ning煤n proyecto de combate? </p><br><p>  Si completamente. </p><br><p>  Cambi茅 mi trabajo de todos modos.  Durante un recorrido de una docena de entrevistas, respond铆 muchas preguntas dif铆ciles solo gracias a mi proyecto favorito. </p><br><p>  El p谩nico de que PHP est谩 muriendo es cada vez m谩s fuerte.  No ocultar茅 el hecho de que yo mismo estaba pensando en migrar a otro idioma. </p><br><p>  Despu茅s de ver el gran trabajo que el equipo de PHP realiz贸 en la versi贸n 7;  茅l estaba convencido por su ejemplo personal de cu谩n maduro se volvi贸 el lenguaje y cu谩n rico fue el ecosistema que creci贸;  Puedo decir con seguridad que los rumores sobre la muerte de PHP son muy exagerados.  Y esto es solo el comienzo: en el futuro estamos esperando JIT, asincron铆a fuera de la caja y mucho m谩s. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/479122/">https://habr.com/ru/post/479122/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../479102/index.html">Conocimiento de Yandex.Maps o cu谩nto amo la documentaci贸n</a></li>
<li><a href="../479106/index.html">驴Cu谩nto cuestan los trucos de magia?</a></li>
<li><a href="../479108/index.html">Knight's life - Arena en l铆nea con elementos RPG</a></li>
<li><a href="../479116/index.html">Impresiones en la b煤squeda Y. Directa: por qu茅 paga 1,5 veces m谩s por clic</a></li>
<li><a href="../479120/index.html">La participaci贸n fall贸: llevamos a AgentTesla a agua limpia. Parte 2</a></li>
<li><a href="../479124/index.html">[Infograf铆a] Inteligencia artificial en ciencia ficci贸n</a></li>
<li><a href="../479126/index.html">Python en desarrollo m贸vil</a></li>
<li><a href="../479128/index.html">驴C贸mo funciona el servicio m茅dico del aeropuerto?</a></li>
<li><a href="../479132/index.html">Componente externo para la plataforma m贸vil 1C (BroadcastReceiver)</a></li>
<li><a href="../479136/index.html">Computaci贸n cu谩ntica: 驴el final de la cadena de bloques?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>