<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🥅 🍧 🧢 Cómo comenzar un proyecto de mascotas y no obtener beneficios 🤔 😺 ☠️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="TL; DR 

 El artículo describe el uso del proyecto mascota como una forma de mantener y mejorar las habilidades. El autor creó una biblioteca PHP para...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cómo comenzar un proyecto de mascotas y no obtener beneficios</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479122/"><p><img src="https://habrastorage.org/webt/cz/x-/ln/czx-lnrbjewed61t5fm8k_pjvei.png" alt="Cómo comenzar un proyecto de mascotas y no obtener beneficios"></p><br><div class="spoiler">  <b class="spoiler_title">TL; DR</b> <div class="spoiler_text"><p>  El artículo describe el uso del proyecto mascota como una forma de mantener y mejorar las habilidades.  El autor creó una <a href="https://github.com/liquetsoft/fias-symfony" rel="nofollow">biblioteca PHP</a> para instalar <a href="https://fias.nalog.ru/" rel="nofollow">FIAS a</a> partir de archivos XML. </p></div></div><br><h2 id="cel">  Propósito </h2><br><p>  Raramente cambio de trabajo, por lo tanto, dado el deseo natural de cada organización por procesos fijos, cualquier tarea se convierte en una rutina.  Por un lado, es beneficioso para una empresa mantener ese estado, por otro lado, para mí esto significa una pérdida completa u obsolescencia de habilidades.  PHP se está desarrollando rápidamente y, en consecuencia, el retraso potencial también está creciendo rápidamente.  Finalmente, todos sabemos que hoy en día es difícil para un programador encontrar un buen trabajo sin el conocimiento de Elasticsearch, RabbitMQ, Kafka y otras tecnologías que no aparecen a menudo en mi trabajo diario. </p><a name="habracut"></a><br><p>  Después de comenzar el siguiente sitio típico, decidí que era hora de cambiar algo.  No quería cambiar mi trabajo, pero recordé cómo en una de las conferencias el orador recomendó usar su propio proyecto opcional, el llamado proyecto mascota, para la capacitación.  El método parecía apropiado y decidí probarlo. </p><br><h2 id="vybor-zadachi">  Selección de tareas </h2><br><p>  La elección de la tarea resultó ser la parte más difícil de la empresa.  No se me ocurrió nada especial: algunos servicios, como un analizador de trabajos que se pueden implementar fácilmente en una pila familiar.  Abandoné la idea del proyecto durante varios meses, hasta que accidentalmente vi las noticias sobre el hackathon del Ministerio de Finanzas.  Sugirió usar una de la lista de fuentes de datos abiertas para crear un servicio.  Entre otros, también se indicó el Sistema Federal de Direcciones de Información (FIAS).  Desafortunadamente, el hackathon ya había terminado para entonces. </p><br><p>  Aprendí sobre FIAS por primera vez, pero la tarea me pareció interesante.  Juzgue usted mismo: aproximadamente 30 GB de archivos XML, aproximadamente 60 millones de líneas en la base de datos y, además, la biblioteca podría resultar útil en el trabajo.  Había algunas soluciones listas para usar en Github, pero eso no me detuvo.  Por el contrario, en base a su análisis, hice requisitos adicionales que destacarían mi implementación. </p><br><p>  Mirando hacia el futuro, noto que me encontré con muchas menos dificultades de las que esperaba. </p><br><h2 id="formulirovka-zadachi">  Declaración de tarea </h2><br><p>  El 90% del éxito es la declaración correcta del problema.  Después de varios años de trabajo de plantilla, fue bastante difícil lograr formular claramente el problema.  Solo quería comenzar a trabajar, pero ya en el proceso todo se habría aclarado por sí solo.  Después de una hora de lucha con la dilación, finalmente escribí: crear una biblioteca en PHP para importar datos FIAS. </p><br><p>  Más tarde, después de probarlo, agregué algunos requisitos adicionales: </p><br><ul><li>  implementación en PHP sin utilizar utilidades de terceros, código exclusivo en PHP y extensiones de PECL, </li><li>  importación de todos los datos del conjunto FIAS, </li><li>  instalación completa y ciclo de actualización: búsqueda de la versión necesaria, recepción del archivo, desempaquetado, escritura en la base de datos, </li><li>  Máxima flexibilidad: la capacidad de cambiar la ubicación de almacenamiento, modificar los datos antes de grabar, filtrar lo necesario, etc. </li><li>  La biblioteca debe integrarse fácilmente en los proyectos existentes. </li></ul><br><h2 id="fias">  FIAS </h2><br><p>  FIAS tiene un <a href="https://fias.nalog.ru/" rel="nofollow">sitio web oficial</a> que nos brinda la definición y el propósito de crear un sistema </p><br><blockquote>  El Sistema de Direcciones de Información Federal (FIAS) es el sistema de información del estado federal que proporciona la formación, mantenimiento y uso del registro de direcciones del estado. <br><br>  El propósito de crear el FIAS es la formación de un único recurso federal que contenga información de direcciones estructurada, confiable, uniforme y públicamente disponible.  Gracias a la implementación de FIAS, esta información se puede obtener de forma gratuita a través de Internet en el portal oficialmente registrado de FIAS. </blockquote><p>  Los materiales con una descripción son suficientes tanto en <a href="https://fias.nalog.ru/Updates.aspx" rel="nofollow">el sitio web de FIAS</a> como en el <a href="https://habr.com/ru/search/%3Fq%3D%25D0%25A4%25D0%2598%25D0%2590%25D0%25A1">Habré</a> , por lo tanto, no me centraré en esto. </p><br><p>  En resumen  FIAS viene en dos formatos: FIAS y KLADR.  El segundo está en desuso y ya no está en uso.  La información se almacena en DBF o en XML.  Cada cambio en la composición de FIAS está marcado con una nueva versión.  Puede solicitar un paquete con datos completos que esté actualizado en este momento o que solo contenga cambios entre las dos versiones.  Links proporciona un servicio SOAP.  El paquete es un archivo RAR que contiene archivos con nombres especialmente formados.  Consisten en un prefijo, un nombre de conjunto de datos y una fecha de generación.  Hay dos tipos de prefijos: AS_ para archivos desde los que se deben agregar datos a la base de datos, y AS <em>DEL</em> para archivos cuyos datos se deben eliminar de la base de datos. </p><br><p>  FIAS contiene los siguientes datos: </p><br><ul><li>  registro de elementos formadores de direcciones (este es el gráfico de direcciones: regiones, ciudades y calles), </li><li>  elementos de dirección que identifican objetos direccionables (número de casa y datos de la casa), </li><li>  información sobre terrenos </li><li>  información sobre el local (apartamentos, oficinas, habitaciones, etc.), </li><li>  información sobre el documento normativo, que es la base para la asignación del nombre al elemento de dirección. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Además de varios diccionarios</b> <div class="spoiler_text"><ul><li>  una lista de posibles valores de los intervalos de las casas (regular, par, impar), </li><li>  Una lista de estados de relevancia de una entrada de un elemento de dirección por el clasificador KLADR4.0 </li><li>  una lista de estados de relevancia de una entrada de un elemento de dirección de acuerdo con FIAS, </li><li>  una lista de nombres completos y abreviados de tipos de elementos de dirección y sus niveles de clasificación, </li><li>  lista de tipos de edificios, </li><li>  lista de posibles tipos de propiedad </li><li>  lista de códigos de operaciones con objetos direccionables, </li><li>  una lista de posibles condiciones de bienes inmuebles, </li><li>  lista de tipos de locales u oficinas, </li><li>  lista de tipos de habitaciones, </li><li>  lista de posibles estados (centros) de objetos de dirección de unidades administrativas, </li><li>  tipos de documentos reglamentarios. </li></ul></div></div><br><p>  La estructura de datos se describe en el documento, que se puede encontrar <a href="https://fias.nalog.ru/Updates.aspx" rel="nofollow">en la sección de actualizaciones</a> . </p><br><p>  En definitiva, tenemos un algoritmo de instalación FIAS bastante simple y lineal: </p><br><ul><li>  obtener del servicio SOAP un enlace al archivo y el número de versión actual, </li><li>  descargar archivo, </li><li>  desempacar </li><li>  escribe en la base de datos todos los datos de los archivos con el prefijo AS_, </li><li>  eliminar de la base de datos todos los datos de los archivos con el prefijo AS <em>DEL</em> (sí, es cierto, durante la instalación también debe eliminar algunos de los datos) </li><li>  anote el número de la versión instalada. </li></ul><br><p>  Y no menos simple algoritmo de actualización: </p><br><ul><li>  obtener del servicio SOAP una lista con números de versión y enlaces a archivos con cambios, </li><li>  si la versión actual en la base de datos local es la última, entonces detenga la ejecución, </li><li>  obtener un enlace al archivo con los cambios a la próxima versión, </li><li>  descargar archivo, </li><li>  desempacar </li><li>  escribe en la base de datos todos los datos de los archivos con el prefijo AS_, </li><li>  eliminar de la base de datos todos los datos de los archivos con el prefijo AS <em>DEL</em> , </li><li>  anote el número de la versión actualizada, </li><li>  volver al primer paso </li></ul><br><p>  FIAS deja impresiones contradictorias.  Por un lado: automatización completa de todo el proceso, formatos abiertos, buena documentación.  Por otro lado: una extraña decisión de usar RAR patentado para datos abiertos;  diferencias entre documentación y realidad (principalmente relacionadas con atributos obligatorios), que causan muchos problemas pequeños pero desagradables;  ocasionalmente vienen archivos que no se pueden desempaquetar en Linux;  algunos deltas entre versiones ocupan 4-5 GB. </p><br><h2 id="arhitektura">  Arquitectura </h2><br><p>  Cada biblioteca debe basarse en una idea básica, un núcleo alrededor del cual crecerá el resto de la funcionalidad.  El patrón de "cadena de deberes" me pareció la mejor opción para el papel de tal idea.  En primer lugar, es ideal: varias operaciones secuenciales que una persona hubiera realizado si hubiera querido instalar FIAS manualmente son obvias para el desarrollador y encajan bien en clases pequeñas escritas en el estilo SOLID.  En segundo lugar, dicha cadena se expande muy fácilmente con nuevas operaciones en casi cualquier etapa, lo que proporciona una buena flexibilidad.  En tercer lugar, hace tiempo que quería escribir mi propia implementación. </p><br><p>  Además de las operaciones, he creado varios servicios que pueden transferirse usando DI.  Le permiten reutilizar el código, reemplazar fácilmente la implementación para tareas del sistema de bajo nivel (descargar un archivo, desempaquetar un archivo, escribir en una base de datos y otros) y proporcionar una buena cobertura con las pruebas gracias a los simulacros. </p><br><p>  Como resultado, la biblioteca contiene cuatro tipos principales de objetos, para cada uno de los cuales el área de responsabilidad está claramente definida: </p><br><ul><li>  servicios: proporcionan herramientas para realizar tareas de sistema de bajo nivel, </li><li>  objeto de estado: almacena información para la transmisión entre operaciones, </li><li>  operaciones: utilizando los servicios y el estado en que implementan la parte atómica de la lógica empresarial, </li><li>  cadena de operaciones: realiza operaciones y transfiere el estado entre ellas. </li></ul><br><p>  Usando el enlace de operaciones y servicios proporcionados por la biblioteca, puede obtener fácilmente cualquier nueva cadena o complementar la existente utilizando solo archivos de configuración. </p><br><h2 id="freymvorki">  Marcos </h2><br><p>  Con pausas largas y refactorización constante, trabajé en la biblioteca durante un año y medio. </p><br><p>  La primera versión relativamente estable estaba lista en dos meses de trabajo por las tardes.  De hecho, podría existir por separado del marco y contener todo lo necesario: un script de entrada para ejecutar en la consola, un contenedor DI, un complemento para PDO, su propio registrador y migraciones de estructura de base de datos, de lo que estaba muy orgulloso. </p><br><p>  Por supuesto, sus colegas la rechazaron sin piedad. </p><br><p>  El principal argumento en contra de esto fue la falta de apoyo a los marcos populares.  Nadie quería escribir un contenedor separado para la biblioteca.  Debido a esto, cometí el error más costoso a tiempo: comencé a admitir tanto la versión independiente como los contenedores individuales para cada marco.  Los archivos FIAS reales son diferentes de lo que está escrito en la documentación.  Cada vez que era necesario eliminar o agregar, por ejemplo, no nulo en la descripción de la columna, tenía que hacer cambios en tres repositorios.  Debido a lo tedioso del proceso, el trabajo se detuvo por otros seis meses. </p><br><p>  La sensación de incompletitud me atormentó todo este tiempo y después de una sangrienta batalla contra la pereza me obligó a volver a diseñar una nueva versión.  Para empezar, decidí que nadie necesita una biblioteca independiente, lo que significa que debe eliminar todos los servicios que proporcionan marcos del paquete, reemplazándolos por interfaces.  Así que nos metimos debajo del cuchillo: un script de entrada para ejecutar en la consola, un contenedor DI, un complemento sobre PDO, nuestro propio registrador y migraciones de la estructura de la base de datos.  A continuación, decidí hacer paquetes separados para cada marco, que conectarán todas las partes desde el principal a un script de trabajo y proporcionarán implementaciones específicas de servicios. </p><br><p>  El punto clave fue el modelo.  Actualizar constantemente conjuntos heterogéneos de objetos en varios repositorios no quería.  Al mismo tiempo, en el trabajo principal, obtuve un proyecto en Symfony.  Después de conocerlo rápidamente, decidí que la característica más útil de SF es la generación de código y resolverá todos mis problemas.  <a href="" rel="nofollow">Creé</a> un <a href="" rel="nofollow">archivo yaml</a> en el paquete principal, que contiene una descripción declarativa de los datos FIAS.  Luego agregué generadores de código que crean clases específicas para modelos basados ​​en esta descripción: entidades de Doctrine para Symfony y objetos Eloquent para Laravel.  Durante el desarrollo de los generadores, me di cuenta de que las plantillas de ramitas no eran adecuadas para esto, y me decidí por una solución especializada: <a href="https://github.com/nette/php-generator" rel="nofollow">Nette PHP Generator</a> . </p><br><p>  Como prueba de concepto, creé paquetes para <a href="https://github.com/liquetsoft/fias-laravel" rel="nofollow">Laravel</a> y <a href="https://github.com/liquetsoft/fias-symfony" rel="nofollow">Symfony</a> .  Como trabajé más tiempo con el segundo, describiré todo lo posterior en su contexto. </p><br><h2 id="infrastruktura">  La infraestructura </h2><br><p>  La mayoría de mis proyectos de combate se escribieron sobre tecnologías obsoletas, por lo que no pude usar analizadores de código modernos en ninguno de ellos.  Deshaciéndome de la opresión heredada, instalé y configuré todas las herramientas de control de calidad de código que pude: </p><br><ul><li>  <a href="https://github.com/vimeo/psalm" rel="nofollow">Salmo</a> para la verificación de tipo, </li><li>  <a href="https://scrutinizer-ci.com/" rel="nofollow">Escrutinio</a> para la evaluación general de la calidad (ayuda <a href="https://scrutinizer-ci.com/" rel="nofollow">mucho</a> con la complejidad ciclomática) </li><li>  <a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer" rel="nofollow">PHP Fixing Standards Fixer</a> para verificar el estilo del código, </li><li>  <a href="https://github.com/sebastianbergmann/phpcpd" rel="nofollow">PHP Copiar / Pegar Detector</a> para encontrar duplicados, </li><li>  <a href="https://github.com/sebastianbergmann/phpunit" rel="nofollow">PHPUnit</a> para ejecutar pruebas unitarias. </li></ul><br><p>  Validación integrada en Github usando <a href="https://travis-ci.org/" rel="nofollow">Travis</a> .  Como toque final, agregó un archivo Docker para crear un entorno de desarrollador local completo con un archivo make que contiene los comandos básicos para el contenedor (lanzamiento de comprobaciones, pruebas, creación de modelos y otros). </p><br><h2 id="itogi-obucheniya">  Resultados de aprendizaje </h2><br><h3 id="php-7">  PHP 7 </h3><br><p>  Antes de comenzar a trabajar en la biblioteca, nunca usé las <a href="https://www.php.net/manual/ru/migration70.new-features.php" rel="nofollow">nuevas características de PHP 7</a> .  Son hermosos: desde tipos estrictos hasta un aumento significativo en la productividad.  Un agradecimiento especial a los desarrolladores por el operador de fusión nula.  No he visto una disminución tan grave en la base del código después de la introducción de un operador. </p><br><h3 id="rar">  Rar </h3><br><p>  Sorprendentemente, en PECL había un <a href="https://www.php.net/manual/ru/book.rar.php" rel="nofollow">paquete para trabajar con RAR</a> .  Por lo general, tales extensiones no son confiables y trato de evitarlas.  Esto resultó ser sospechosamente estable: se instaló en 7.2 sin problemas, fue capaz de descomprimir archivos enormes relativamente rápido y con un bajo consumo de RAM (6 GB se desempacan en 10-20 minutos dependiendo de los recursos del sistema disponibles).  Todavía temo que esto sea una manifestación de la ley de Murphy. </p><br><h3 id="xmlreader">  Xmlreader </h3><br><p>  Leer archivos xml gigantes no es una tarea trivial.  Y de nuevo la extensión PECL vino al rescate: <a href="https://www.php.net/manual/ru/book.xmlreader.php" rel="nofollow">XmlReader</a> .  No me di cuenta de inmediato de todo su poder, pero en varios enfoques lo adapté junto con el <a href="https://symfony.com/doc/current/components/serializer.html" rel="nofollow">serializador de Symfony</a> para obtener datos de archivos FIAS de manera rápida y económica.  En el lado de la biblioteca, el objeto lector implementa la interfaz iteradora, que devuelve secuencialmente las cadenas xml correspondientes a un registro en el archivo.  Usando el serializador de Symfony, estas cadenas se convierten en objetos.  Un archivo de 20 GB se puede leer en 3-4 minutos sin usar más de 50 MB de RAM. </p><br><h3 id="zapis-v-bazu-dannyh">  Escribir en la base de datos </h3><br><p>  Por supuesto, comencé con matrices asociativas con datos y descripciones de tablas voluminosas.  El código se convirtió rápidamente en un hash de configuraciones y clases de convertidor. </p><br><p>  La magia de las entidades de Doctrina mostró cómo los objetos pueden autodescribirse.  Decidí usar el mismo enfoque, pero al mismo tiempo deshacerme de mi propia implementación de escribir datos en la base de datos usando PDO.  En cambio, creé una interfaz de almacenamiento que describe métodos para procesar objetos.  Según la clase de entidad, una implementación de almacenamiento particular decide exactamente cómo y dónde escribir los datos.  Este enfoque facilitó la conexión de una amplia variedad de almacenamientos: desde MySql a archivos csv. </p><br><h3 id="optimizaciya-vstavki-dannyh">  Optimización de inserción de datos </h3><br><p>  Interrumpí la primera importación después de que excediera en 48 horas.  Se hizo evidente que necesita optimizar el proceso de inserción de datos. </p><br><p>  Primero, <a href="https://www.postgresql.org/docs/12/datatype-uuid.html" rel="nofollow">cambié a las columnas de tipo ugid</a> para claves primarias <a href="https://www.postgresql.org/docs/12/datatype-uuid.html" rel="nofollow">integradas en PostgreSql</a> .  Escribir en una columna uuid con un índice es mucho más rápido que escribir en una cadena. </p><br><p>  Después de esto, abandoné todos los índices no críticos y las claves externas, ya que la preocupación por la integridad de los datos está completamente del lado del equipo de FIAS. </p><br><p> Luego rehice la interfaz de almacenamiento para que el script externo pueda informarle explícitamente sobre la finalización de la importación.  Esto permitió el uso de inserción masiva, que a veces aceleró la grabación.  <a href="https://www.postgresql.org/docs/current/populate.html" rel="nofollow">Buscando información,</a> también encontré el comando <a href="https://www.postgresql.org/docs/current/sql-copy.html" rel="nofollow"><code>copy</code></a> junto con <a href="https://www.postgresql.org/docs/current/functions-xml.html" rel="nofollow"><code>query_to_xml</code></a> .  Tenía dos grandes inconvenientes: en primer lugar, el usuario de PostgreSql debía tener permisos de lectura para el archivo, lo que no podía garantizar, y en segundo lugar, la capacidad de modificar datos dentro del script antes de que se perdiera la escritura. </p><br><p>  A pesar de estos cambios, el tiempo de importación superó las 30 horas.  Se necesitaba un cambio radical de enfoque. </p><br><h3 id="parallelnye-processy">  Procesos paralelos </h3><br><p>  Internet está repleto de artículos sobre asincronía en PHP.  Mi elección recayó en el <a href="https://amphp.org/" rel="nofollow">amplificador</a> .  Simplemente no funcionó de forma asincrónica.  En primer lugar, el código se convirtió rápidamente en una aterradora hoja de devoluciones de llamadas y llamadas no obvias (probablemente sea mi culpa, no el enfoque asincrónico).  En segundo lugar, tuve que abandonar el uso de ORM estándar porque se necesitan llamadas sin bloqueo a la base de datos a través de un <a href="https://github.com/amphp/mysql" rel="nofollow">marco especial</a> .  En tercer lugar, aunque existen condiciones bajo las cuales PostgreSql puede insertar filas en paralelo, son <a href="" rel="nofollow">extremadamente</a> <a href="https://wiki.postgresql.org/wiki/Parallel_Query" rel="nofollow">difíciles de</a> cumplir.  Como resultado, después de 5 horas de trabajo, vi todas mis solicitudes asincrónicas "sincronizadas" a la fuerza en el lado de la base de datos. </p><br><p>  Pero la importación está bien dividida en procesos paralelos: varias tareas completamente independientes que no tienen recursos comunes por los cuales podrían competir, y datos que podrían intercambiar.  Además, en el marco de un hilo, recibí un código hermoso y lineal. </p><br><p>  El primero decidí probar la extensión <a href="https://www.php.net/manual/ru/book.parallel.php" rel="nofollow">paralela</a> .  Tiene un defecto fatal: el intérprete debe estar construido con soporte para ZTS (Zend Thread Safety).  Dado que ZTS no funciona en los scripts web normales, habría que tener dos versiones diferentes del intérprete.  Uno, sin ZTS, para web, el segundo, con ZTS, para instalar FIAS.  El potencial aumento del rendimiento superó este inconveniente, especialmente teniendo en cuenta lo fácil que es ensamblar un nuevo contenedor Docker y usarlo junto con el anterior.  Desafortunadamente, iniciar Symfony dentro de un nuevo hilo causó que la pila de PHP se desbordara, y no estaba listo para rechazar el contenedor DI y la configuración conveniente. </p><br><p>  Finalmente, encontré el <a href="https://symfony.com/doc/current/components/process.html" rel="nofollow">proceso de Symfony</a> .  De hecho, inicia un nuevo proceso para el comando de consola especificado y supervisa su finalización.  Tuve que agregar dos cadenas adicionales.  El primero descarga el archivo, lo descomprime e inicia procesos paralelos para el procesamiento de datos.  El segundo toma una lista de archivos del argumento de la línea de comando y escribe su contenido en la base de datos. </p><br><p>  Debido a la falta de experiencia con procesos paralelos, parece que he cometido todos los errores de novato. </p><br><p>  Por ejemplo, mi proceso de inicio verificó la finalización de los niños usando un bucle infinito y, por supuesto, estaba gastando indecentemente muchos recursos de procesador en esto.  La llamada de sueño entre iteraciones ayudó. </p><br><p>  En la primera implementación, los archivos se distribuyeron de manera desigual entre los procesos.  Los dos más grandes cayeron en una secuencia, que se procesó durante más de 20 horas.  En la segunda implementación, agregué un administrador especial que distribuye archivos en función del tiempo que lleva importarlos.  Ahora los procesos se cargan de manera uniforme. </p><br><p>  Después de estas ediciones, pude importar la versión completa de FIAS en 16-20 horas, dependiendo de los recursos del servidor.  No es tan bueno como nos gustaría, pero sigo trabajando en la optimización.  El siguiente paso es un rechazo completo de PostgreSql a favor de Elasticsearch. </p><br><h2 id="vyvody">  Conclusiones </h2><br><p>  ¿Valió la pena?  ¿Dos años de trabajo en una biblioteca que nunca entró en ningún proyecto de combate? </p><br><p>  Si completamente. </p><br><p>  Cambié mi trabajo de todos modos.  Durante un recorrido de una docena de entrevistas, respondí muchas preguntas difíciles solo gracias a mi proyecto favorito. </p><br><p>  El pánico de que PHP está muriendo es cada vez más fuerte.  No ocultaré el hecho de que yo mismo estaba pensando en migrar a otro idioma. </p><br><p>  Después de ver el gran trabajo que el equipo de PHP realizó en la versión 7;  él estaba convencido por su ejemplo personal de cuán maduro se volvió el lenguaje y cuán rico fue el ecosistema que creció;  Puedo decir con seguridad que los rumores sobre la muerte de PHP son muy exagerados.  Y esto es solo el comienzo: en el futuro estamos esperando JIT, asincronía fuera de la caja y mucho más. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/479122/">https://habr.com/ru/post/479122/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../479102/index.html">Conocimiento de Yandex.Maps o cuánto amo la documentación</a></li>
<li><a href="../479106/index.html">¿Cuánto cuestan los trucos de magia?</a></li>
<li><a href="../479108/index.html">Knight's life - Arena en línea con elementos RPG</a></li>
<li><a href="../479116/index.html">Impresiones en la búsqueda Y. Directa: por qué paga 1,5 veces más por clic</a></li>
<li><a href="../479120/index.html">La participación falló: llevamos a AgentTesla a agua limpia. Parte 2</a></li>
<li><a href="../479124/index.html">[Infografía] Inteligencia artificial en ciencia ficción</a></li>
<li><a href="../479126/index.html">Python en desarrollo móvil</a></li>
<li><a href="../479128/index.html">¿Cómo funciona el servicio médico del aeropuerto?</a></li>
<li><a href="../479132/index.html">Componente externo para la plataforma móvil 1C (BroadcastReceiver)</a></li>
<li><a href="../479136/index.html">Computación cuántica: ¿el final de la cadena de bloques?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>