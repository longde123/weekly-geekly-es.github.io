<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üò® ü§òüèº ‚ùå Premiers pas avec les microservices dans Spring Boot üë©üèª‚ÄçüöÄ üë©üèª‚Äç‚öïÔ∏è ‚¨áÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour √† tous! 

 Dans cet article, nous allons d√©montrer les composants de base pour cr√©er des microservices RESTful √† l'aide du registre des servic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Premiers pas avec les microservices dans Spring Boot</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/413567/">  Bonjour √† tous! <br><br>  Dans cet article, nous allons d√©montrer les composants de base pour cr√©er des microservices RESTful √† l'aide du registre des services Consul, Spring Boot pour tous les √©chafaudages, injection de d√©pendance, Maven pour l'assemblage, ainsi que Spring REST et l'API Java RESTful Jersey / JaxRS. <br><br>  Les principaux avantages des microservices: <br><br><ul><li>  Les microservices vous aident √† assouplir votre code </li></ul><br><ul><li>  Les microservices permettent √† diff√©rentes √©quipes de travailler sur de petits composants √† l'aide de technologies ind√©pendantes, offrant un d√©ploiement plus s√©curis√© et plus fr√©quent. Spring Boot prend en charge diverses impl√©mentations pour cr√©er une API REST </li></ul><br><ul><li>  La d√©couverte et l'appel de services ne d√©pendent pas de la plateforme de service </li></ul><br><ul><li>  Swagger cr√©e une documentation API solide et une interface d'appel </li></ul><br>  Si vous n'utilisez pas d√©j√† les microservices, vous n'avez pas r√©ussi √† entrer dans la phase des premiers adeptes sur la courbe de perception technologique, et c'est probablement le bon moment pour commencer. <br><br><img src="https://habrastorage.org/webt/o_/ze/uu/o_zeuux9s9xpxbxjvitgdmiqox4.png"><a name="habracut"></a><br><br>  Au cours des deux derni√®res d√©cennies, l'entreprise est devenue tr√®s flexible dans notre processus SDLC, mais nos applications, en r√®gle g√©n√©rale, restent encore monolithiques, avec d'√©normes pots prenant en charge toutes les diff√©rentes API et versions sur le march√©.  Mais √† l'heure actuelle, on souhaite davantage de processus Lean et DevOps, et la fonctionnalit√© devient ¬´sans serveur¬ª.  La refactorisation vers les microservices peut r√©duire l'intrication du code et des ressources, rendre les assemblages plus petits, les versions plus s√ªres et les API plus stables. <br><br>  Dans cet article, nous allons cr√©er une application simple de gestion de portefeuille boursier que les clients peuvent appeler pour √©valuer leur portefeuille d'actions (tickers et valeurs boursi√®res).  Le microservice de portefeuille r√©cup√©rera le portefeuille du client, l'enverra au microservice de tarification pour appliquer les derniers prix, puis rendra le portefeuille pleinement √©valu√© et sous-totalis√©, d√©montrant tout cela par le biais d'un appel de repos. <br><br><img src="https://habrastorage.org/webt/qe/ea/aw/qeeaawb8mapjtsibfyw3nro_ue8.png"><br><br>  Avant de commencer √† travailler sur la cr√©ation de nos microservices, pr√©parons notre environnement en cr√©ant Consul. <br><br><h3>  T√©l√©charger Consul </h3><br>  Nous utiliserons le consul Hashicorp pour d√©couvrir les services, alors allez sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">www.consul.io/downloads.html</a> et t√©l√©chargez Consul pour Windows, Linux, Mac, etc.  Cela vous fournira un fichier ex√©cutable que vous devez ajouter √† votre chemin. <br><br><h3>  Lancer Consul </h3><br>  √Ä l'invite de commandes, lancez Consul en mode dev: <br><br><pre><code class="bash hljs">consul agent -dev</code> </pre> <br>  Pour v√©rifier qu'il fonctionne, acc√©dez √† votre navigateur et acc√©dez √† l'interface consul <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http: // localhost: 8500</a> .  Si tout se passe bien, le consul doit signaler qu'il est bel et bien vivant.  En cliquant sur le service consul (√† gauche), vous recevrez des informations suppl√©mentaires (√† droite). <br><br><img src="https://habrastorage.org/webt/9p/4m/2t/9p4m2taqogtv6ahb3dnpmvvt2oc.png"><br><br>  En cas de probl√®me pour le moment, assurez-vous d'ajouter Consul au chemin d'ex√©cution et les ports 8500 et 8600 sont disponibles. <br><br><h3>  Cr√©er une application SpringBoot </h3><br>  Nous utiliserons le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Spring Initializr</a> , qui est int√©gr√© dans la plupart des IDE, pour √©chafauder nos applications SpringBoot.  Les captures d'√©cran ci-dessous utilisent IntelliJ IDEA. <br><br>  S√©lectionnez ¬´Fichier / Nouveau projet¬ª pour ouvrir un nouveau mod√®le de projet, puis ¬´Spring Initializr¬ª. <br><br><img src="https://habrastorage.org/webt/xb/j5/3t/xbj53tf_bfr5dauohwqmv9gkdmm.png"><br><br>  En g√©n√©ral, vous pouvez configurer un √©chafaudage sans IDE en remplissant un formulaire en ligne via la page Web SpringBoot Initializr <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">start.spring.io</a> , qui cr√©era un fichier zip pour votre projet vide, pr√™t √† √™tre t√©l√©charg√©. <br><br>  Cliquez sur ¬´Suivant¬ª et remplissez les m√©tadonn√©es du projet.  Utilisez la configuration suivante: <br><br><img src="https://habrastorage.org/webt/l0/_p/zk/l0_pzkpsppbplfrusj7suogqmyk.png"><br><br>  Cliquez sur ¬´Suivant¬ª pour s√©lectionner les d√©pendances, puis entrez ¬´Jersey¬ª et ¬´Consul Discovery¬ª dans la recherche de d√©pendances.  Ajoutez ces d√©pendances: <br><br><img src="https://habrastorage.org/webt/jt/t8/l8/jtt8l89pauvzyu_oo_riav_na4e.png"><br><br>  Cliquez sur ¬´Suivant¬ª pour indiquer le nom du projet et son emplacement.  Conservez le nom par d√©faut ¬´portfolio¬ª et sp√©cifiez l'emplacement pr√©f√©r√© du projet, puis cliquez sur ¬´terminer¬ª pour cr√©er et ouvrir le projet: <br><br><img src="https://habrastorage.org/webt/un/xl/gh/unxlgh-ufplppxqhuyfyfdoug5g.png"><br><br>  Nous pouvons utiliser le fichier application.properties g√©n√©r√©, mais SpringBoot reconna√Æt √©galement le format YAML, qui est un peu plus facile √† visualiser, nous allons donc le renommer en application.yml. <br><br>  Nous appelons le microservice ¬´portfolio-service¬ª.  Nous pouvons sp√©cifier un port ou utiliser le port 0 pour que l'application utilise un port disponible.  Dans notre cas, nous utiliserons le 57116. Si vous h√©bergez ce service en tant que conteneur Docker, vous pouvez le mapper sur n'importe quel port que vous s√©lectionnez.  Nommez l'application et sp√©cifiez notre port en ajoutant ce qui suit √† notre application.yml: <br><br><pre> <code class="bash hljs">spring: application: name: portfolio-service server: port: 57116</code> </pre><br>  Pour rendre notre service disponible, ajoutez une annotation √† notre classe d'application SpringBoot.  Ouvrez l'application PortfolioApplication et ajoutez @EnableDiscoveryClient au-dessus de la d√©claration de classe. <br><br>  Confirmez les importations.  La classe devrait ressembler √† ceci: <br><br><pre> <code class="bash hljs">package com.restms.demo.portfolio; import org.springframework.cloud.client.discovery.EnableDiscoveryClient; . . . @SpringBootApplication @EnableDiscoveryClient public class PortfolioApplication { public static void main(String[] args) { SpringApplication.run(PortfolioApplication.class, args); } }</code> </pre><br>  (Pour montrer comment les microservices peuvent √™tre constitu√©s de plates-formes ind√©pendantes, nous utiliserons Jersey pour ce service et Spring REST pour le suivant). <br>  Pour configurer le service Web RESTful sur Jersey, nous devons sp√©cifier la classe de configuration ResourceConfig.  Ajoutez la classe JerseyConfig (pour d√©monstration, nous l'enregistrerons dans le m√™me package que notre classe d'application).  Il devrait ressembler √† ceci, plus le package et l'importation corrects: <br><br><pre> <code class="bash hljs">@Configuration @ApplicationPath(<span class="hljs-string"><span class="hljs-string">"portfolios"</span></span>) public class JerseyConfig extends ResourceConfig { public <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">JerseyConfig</span></span></span></span>() { register(PortfolioImpl.class); } }</code> </pre><br>  Notez qu'il h√©rite de ResourceConfig pour le d√©signer comme classe de configuration Jersey.  L'attribut @ApplicationPath ("portfolios") d√©finit le contexte de l'appel, ce qui signifie que les appels doivent commencer par l'√©l√©ment de chemin "portfolioios".  (Si vous l'omettez, le contexte par d√©faut est ¬´/¬ª). <br><br>  La classe PortfolioImpl servira deux demandes: portfolios / client / {id-client} renvoie tous les portefeuilles et portefeuilles / client / {id-client} / portfolio / {id-portfolio} renvoie un portefeuille.  Un portefeuille se compose d'un ensemble de tickers et du nombre d'actions d√©tenues par ce ticker.  (Pour d√©monstration, il existe trois clients avec les identificateurs 0, 1 et 2, chacun ayant trois portefeuilles avec les identificateurs 0, 1 et 2). <br><br>  Votre IDE vous demandera de cr√©er PortfolioImpl;  faites-le maintenant.  Pour le d√©montrer, ajoutez-le au m√™me package.  Entrez le code ci-dessous et confirmez toutes les importations: <br><br><pre> <code class="bash hljs">@Component @Path(<span class="hljs-string"><span class="hljs-string">"/"</span></span>) public class PortfolioImpl implements InitializingBean { private Object[][][][] clientPortfolios; @GET @Path(<span class="hljs-string"><span class="hljs-string">"customer/{customer-id}"</span></span>) @Produces(MediaType.APPLICATION_JSON) // a portfolio consists of an array of arrays, each containing an array of // stock ticker and associated shares public Object[][][] getPortfolios(@PathParam(<span class="hljs-string"><span class="hljs-string">"customer-id"</span></span>) int customerId) { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> clientPortfolios[customerId]; } @GET @Path(<span class="hljs-string"><span class="hljs-string">"customer/{customer-id}/portfolio/{portfolio-id}"</span></span>) @Produces(MediaType.APPLICATION_JSON) public Object[][] getPortfolio(@PathParam(<span class="hljs-string"><span class="hljs-string">"customer-id"</span></span>) int customerId, @PathParam(<span class="hljs-string"><span class="hljs-string">"portfolio-id"</span></span>) int portfolioId) { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> getPortfolios(customerId)[portfolioId]; } @Override public void afterPropertiesSet() throws Exception { Object[][][][] clientPortfolios = { { // 3 customers, 3 portfolios each {new Object[]{<span class="hljs-string"><span class="hljs-string">"JPM"</span></span>, 10201}, new Object[]{<span class="hljs-string"><span class="hljs-string">"GE"</span></span>, 20400}, new Object[]{<span class="hljs-string"><span class="hljs-string">"UTX"</span></span>, 38892}}, {new Object[]{<span class="hljs-string"><span class="hljs-string">"KO"</span></span>, 12449}, new Object[]{<span class="hljs-string"><span class="hljs-string">"JPM"</span></span>, 23454}, new Object[]{<span class="hljs-string"><span class="hljs-string">"MRK"</span></span>, 45344}}, {new Object[]{<span class="hljs-string"><span class="hljs-string">"WMT"</span></span>, 39583}, new Object[]{<span class="hljs-string"><span class="hljs-string">"DIS"</span></span>, 95867}, new Object[]{<span class="hljs-string"><span class="hljs-string">"TRV"</span></span>, 384756}}, }, { {new Object[]{<span class="hljs-string"><span class="hljs-string">"GE"</span></span>, 38475}, new Object[]{<span class="hljs-string"><span class="hljs-string">"MCD"</span></span>, 12395}, new Object[]{<span class="hljs-string"><span class="hljs-string">"IBM"</span></span>, 91234}}, {new Object[]{<span class="hljs-string"><span class="hljs-string">"VZ"</span></span>, 22342}, new Object[]{<span class="hljs-string"><span class="hljs-string">"AXP"</span></span>, 385432}, new Object[]{<span class="hljs-string"><span class="hljs-string">"UTX"</span></span>, 23432}}, {new Object[]{<span class="hljs-string"><span class="hljs-string">"IBM"</span></span>, 18343}, new Object[]{<span class="hljs-string"><span class="hljs-string">"DIS"</span></span>, 45673}, new Object[]{<span class="hljs-string"><span class="hljs-string">"AAPL"</span></span>, 23456}}, }, { {new Object[]{<span class="hljs-string"><span class="hljs-string">"AXP"</span></span>, 34543}, new Object[]{<span class="hljs-string"><span class="hljs-string">"TRV"</span></span>, 55322}, new Object[]{<span class="hljs-string"><span class="hljs-string">"NKE"</span></span>, 45642}}, {new Object[]{<span class="hljs-string"><span class="hljs-string">"CVX"</span></span>, 44332}, new Object[]{<span class="hljs-string"><span class="hljs-string">"JPM"</span></span>, 12453}, new Object[]{<span class="hljs-string"><span class="hljs-string">"JNJ"</span></span>, 45433}}, {new Object[]{<span class="hljs-string"><span class="hljs-string">"MRK"</span></span>, 32346}, new Object[]{<span class="hljs-string"><span class="hljs-string">"UTX"</span></span>, 46532}, new Object[]{<span class="hljs-string"><span class="hljs-string">"TRV"</span></span>, 45663}}, } }; this.clientPortfolios = clientPortfolios; } }</code> </pre><br>  L'annotation de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">composant la</a> d√©signe comme classe du composant Spring et l'expose comme point de terminaison.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">Les</a> annotations de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">chemin</a> sur la d√©claration de classe d√©clarent que la classe est accessible via l'√©l√©ment de chemin ¬´/¬ª, et deux appels api pris en charge sont disponibles via portfolios / customer / {customer-id} et portfolios / customer / {customer-id} / portfolio / {portfolio- id}, comme nous le voyons dans les annotations de la m√©thode.  Notez que le chemin ("/") est le chemin par d√©faut, mais nous le laissons pour r√©f√©rence.  Les m√©thodes sont d√©sign√©es comme HTTP GET via @GETannotation.  Notre m√©thode est con√ßue pour renvoyer un tableau et annot√©e pour renvoyer Json, elle renvoie donc un tableau Json.  Remarquez comment les annotations <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">Path</a> Param sont utilis√©es dans la signature de m√©thode pour extraire les param√®tres affich√©s des requ√™tes affich√©es. <br><br>  (Pour notre d√©mo, nous retournons des valeurs cod√©es en dur. Bien s√ªr, dans la pratique, l'impl√©mentation interrogera la base de donn√©es ou un autre service ou source de donn√©es au lieu du code dur.) <br>  Cr√©ez maintenant un projet et ex√©cutez-le.  Si vous utilisez IntelliJ, il cr√©era un ex√©cutable par d√©faut, il vous suffit donc de cliquer sur la fl√®che verte ¬´ex√©cuter¬ª.  Vous pouvez √©galement utiliser <br><br><pre> <code class="bash hljs">mvn spring-boot:run</code> </pre> <br>  Ou vous pouvez effectuer l'installation de maven et ex√©cuter l'application √† l'aide de java -jar, en pointant vers le fichier jar g√©n√©r√© dans le r√©pertoire cible: <br><br><pre> <code class="bash hljs">java -jar target\portfolio-0.0.1-SNAPSHOT.jar</code> </pre> <br>  Maintenant, nous devrions voir ce service dans Consul, alors revenons √† notre navigateur, t√©l√©chargez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http: // localhost: 8500 / ui / # / dc1 / services</a> (ou mettez √† jour si vous y √™tes d√©j√†). <br><br><img src="https://habrastorage.org/webt/bs/ab/2v/bsab2vs-dswpzy7nmpevmtphdma.png"><br><br>  Hmm, nous voyons notre service l√†-bas, mais il est affich√© comme ayant √©chou√©.  C'est parce que Consul attend un signal de rythme cardiaque ¬´sain¬ª de notre service. <br>  Pour g√©n√©rer des signaux de pulsation, nous pouvons ajouter une d√©pendance sur le service <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Spring Actuator</a> au pom de notre application. <br><br><pre> <code class="bash hljs">&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt; &lt;/dependency&gt;</code> </pre><br>  Pendant que nous sommes √† pom, notons qu'il existe un conflit de version avec Jersey entre le starter Consul et le starter Jersey.  Pour lisser cela, d√©signer le d√©marreur Jersey comme la premi√®re d√©pendance. <br><br>  Votre pom devrait maintenant contenir les d√©pendances suivantes: <br><br><pre> <code class="bash hljs">&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-jersey&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-consul-discovery&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt; &lt;scope&gt;<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt;</code> </pre><br>  En red√©marrant Consul, le service Portfolio affiche un heureux: <br><br><img src="https://habrastorage.org/webt/uf/oq/qr/ufoqqrtcnxnlwazqy-ozrp1lceo.png"><br><br>  Maintenant, dans le service de portefeuille, il y a deux n≈ìuds de transmission: l'un d'eux est notre impl√©mentation du service de portefeuille, et l'autre est le rythme cardiaque. <br><br>  V√©rifions le port qui a √©t√© attribu√©.  Vous pouvez le voir dans la sortie de l'application: <br><br><pre> <code class="bash hljs">INFO 19792 --- [ main] sbcetTomcatEmbeddedServletContainer : Tomcat started on port(s): 57116 (http)</code> </pre> <br>  Vous pouvez √©galement voir le port directement dans l'interface utilisateur du Consul.  Cliquez sur ¬´service client¬ª, puis s√©lectionnez le lien ¬´Lien de v√©rification du service client¬ª, qui affiche le port de service, dans ce cas 57116. <br><br><img src="https://habrastorage.org/webt/s_/up/ce/s_upceczzu0xupqioariurhawz8.png"><br><br>  Demandez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http: // localhost: 57116 / portfolios / customer / 1 / portfolio / 2</a> et vous verrez le tableau json [["IBM", 18343], ["DIS", 45673], ["AAPL", 23456]] <br><br>  Notre premier microservice est ouvert aux affaires! <br><br><h3>  Service de tarification </h3><br>  Ensuite, nous cr√©erons notre service de tarification, cette fois en utilisant Spring RestController au lieu de Jersey. <br><br>  Le service de tarification acceptera l'identifiant client et l'identifiant de portefeuille comme param√®tres et utilisera RestTemplate pour demander des services de portefeuille, recevoir des tickers et des stocks, et retourner les prix actuels.  (Je n'ai pas besoin de vous dire que ces valeurs sont de fausses nouvelles, alors ne les utilisez pas pour prendre des d√©cisions commerciales!) <br><br>  Cr√©ez un nouveau projet en utilisant les informations suivantes: <br><br><img src="https://habrastorage.org/webt/gz/sy/sm/gzsysm7_cgynyxucuhgrcfoxhbs.png"><br><br>  Cette fois, s√©lectionnez les d√©pendances Web, Consul Discovery et Actuator: <br><br><img src="https://habrastorage.org/webt/1l/ke/ov/1lkeovxzix2pxqwmodb2efdw-zu.png"><br><br>  Laissez le nom par d√©faut du projet ¬´pricing¬ª et cr√©ez un projet dans le r√©pertoire de votre choix. <br><br>  Cette fois, nous utiliserons application.properties au lieu de application.yml. <br>  D√©finissez le nom et le port dans application.properties comme suit: <br><br><pre> <code class="bash hljs">spring.application.name=pricing server.port=57216</code> </pre> <br>  Annoter PricingApplication avec @EnableDiscoveryClient.  La classe devrait ressembler √† ceci, plus le package et l'importation. <br><br><pre> <code class="bash hljs">@SpringBootApplication @EnableDiscoveryClient public class PricingApplication { public static void main(String[] args) { SpringApplication.run(PricingApplication.class, args); } }</code> </pre><br>  Ensuite, nous cr√©erons la classe PricingEndpoint.  Ici, je vais donner un exemple plus d√©taill√©, car il pr√©sente plusieurs fonctions importantes, y compris la d√©couverte de services (recherche de services de portefeuille) et l'utilisation de RestTemplate pour la requ√™te: <br><br><pre> <code class="bash hljs">@RestController @RequestMapping(<span class="hljs-string"><span class="hljs-string">"/pricing"</span></span>) public class PricingEndpoint implements InitializingBean { @Autowired DiscoveryClient client; Map&lt;String, Double&gt; pricingMap = new HashMap&lt;&gt;(); RestTemplate restTemplate = new RestTemplate(); @GetMapping(<span class="hljs-string"><span class="hljs-string">"/customer/{customer-id}/portfolio/{portfolio-id}"</span></span>) public List&lt;String&gt; getPricedPortfolio( @PathVariable(<span class="hljs-string"><span class="hljs-string">"customer-id"</span></span>) Integer customerId, @PathVariable(<span class="hljs-string"><span class="hljs-string">"portfolio-id"</span></span>) Integer portfolioId) { List&lt;ServiceInstance&gt; instances = client.getInstances(<span class="hljs-string"><span class="hljs-string">"portfolio-service"</span></span>); ServiceInstance instance = instances.stream() .findFirst() .orElseThrow(() -&gt; new RuntimeException(<span class="hljs-string"><span class="hljs-string">"not found"</span></span>)); String url = String.format(<span class="hljs-string"><span class="hljs-string">"%s/portfolios/customer/%d/portfolio/%d"</span></span>, instance.getUri(), customerId, portfolioId); // query <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the portfolios, returned as an array of List // of size 2, containing a ticker and a position (<span class="hljs-comment"><span class="hljs-comment"># of shares) Object[] portfolio = restTemplate.getForObject(url, Object[].class); // Look up the share prices, and return a list of Strings, formatted as // ticker, shares, price, total List&lt;String&gt; collect = Arrays.stream(portfolio).map(position -&gt; { String ticker = ((List&lt;String&gt;) position).get(0); int shares = ((List&lt;Integer&gt;) position).get(1); double price = getPrice(ticker); double total = shares * price; return String.format("%s %d %f %f", ticker, shares, price, total); }).collect(Collectors.toList()); return collect; } private double getPrice(String ticker) { return pricingMap.get(ticker); } @Override public void afterPropertiesSet() throws Exception { pricingMap.put("MMM",201.81); pricingMap.put("AXP",85.11); pricingMap.put("AAPL",161.04); pricingMap.put("BA",236.32); pricingMap.put("CAT",118.02); pricingMap.put("CVX",111.31); pricingMap.put("CSCO",31.7); pricingMap.put("KO",46.00); pricingMap.put("DIS",101.92); pricingMap.put("XOM",78.7); pricingMap.put("GE",24.9); pricingMap.put("GS",217.62); pricingMap.put("HD",155.82); pricingMap.put("IBM",144.29); pricingMap.put("INTC",35.66); pricingMap.put("JNJ",130.8); pricingMap.put("JPM",89.75); pricingMap.put("MCD",159.81); pricingMap.put("MRK",63.89); pricingMap.put("MSFT",73.65); pricingMap.put("NKE",52.78); pricingMap.put("PFE",33.92); pricingMap.put("PG",92.79); pricingMap.put("TRV",117.00); pricingMap.put("UTX",110.12); pricingMap.put("UNH",198.00); pricingMap.put("VZ",47.05); pricingMap.put("V",103.34); pricingMap.put("WMT", 80.05); } }</span></span></code> </pre><br>  Pour trouver un service de portefeuille, nous devons avoir acc√®s √† DiscoveryClient.  Il est facile d'obtenir l'annotation @Autowired de Spring. <br><br><pre> <code class="bash hljs">@Autowired DiscoveryClient client;</code> </pre><br>  Cette instance DiscoveryClient est ensuite utilis√©e pour rechercher le service dans l'appel: <br><br><pre> <code class="bash hljs">List&lt;ServiceInstance&gt; instances = client.getInstances(<span class="hljs-string"><span class="hljs-string">"portfolio-service"</span></span>); ServiceInstance instance = instances.stream().findFirst().orElseThrow(() -&gt; new RuntimeException(<span class="hljs-string"><span class="hljs-string">"not found"</span></span>));</code> </pre><br>  Une fois le service trouv√©, nous pouvons l'utiliser pour r√©pondre √† notre demande, que nous composons conform√©ment √† l'appel API cr√©√© dans notre service de portefeuille. <br><br><pre> <code class="bash hljs">String url = String.format(<span class="hljs-string"><span class="hljs-string">"%s/portfolios/customer/%d/portfolio/%d"</span></span>, instance.getUri(), customerId, portfolioId);</code> </pre><br>  Enfin, nous utilisons RestTemplate pour ex√©cuter notre demande GET. <br><br><pre> <code class="bash hljs">Object[] portfolio = restTemplate.getForObject(url, Object[].class);</code> </pre> <br>  Notez que pour les contr√¥leurs Rest (ainsi que pour Spring MVC Request Controller), les variables de chemin sont r√©cup√©r√©es √† l'aide de l'annotation <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">Path</a> Variable, contrairement √† Jersey, qui, comme nous l'avons vu, utilise <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">Path</a> Param. <br><br>  Ceci conclut notre tarification avec Spring RestController. <br><br><h3>  La documentation </h3><br>  Nous avons r√©solu tous ces probl√®mes afin de cr√©er nos microservices, mais ils n'apporteront pas suffisamment d'avantages si nous ne donnons pas au monde des connaissances sur la fa√ßon de les utiliser. <br><br>  Pour ce faire, nous utilisons l'outil <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Swagger</a> pratique et facile √† utiliser, qui documente non seulement nos appels API, mais fournit √©galement un client Web pratique pour les appeler. <br><br>  Pr√©cisons d'abord Swagger dans notre pom: <br><br><pre> <code class="bash hljs">&lt;dependency&gt; &lt;groupId&gt;io.springfox&lt;/groupId&gt; &lt;artifactId&gt;springfox-swagger2&lt;/artifactId&gt; &lt;version&gt;2.7.0&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;io.springfox&lt;/groupId&gt; &lt;artifactId&gt;springfox-swagger-ui&lt;/artifactId&gt; &lt;version&gt;2.7.0&lt;/version&gt; &lt;/dependency&gt;</code> </pre><br>  Ensuite, nous devons dire √† Swagger laquelle de nos classes nous voulons documenter.  Pr√©sentons la nouvelle classe SwaggerConfig contenant la sp√©cification Swagger. <br><br><pre> <code class="bash hljs">@Configuration @EnableSwagger2 public class SwaggerConfig { @Bean public Docket <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">api</span></span></span></span>() { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> new Docket(DocumentationType.SWAGGER_2) .select() .apis(RequestHandlerSelectors.any()) .paths(PathSelectors.regex(<span class="hljs-string"><span class="hljs-string">"/pricing.*"</span></span>)) .build(); } }</code> </pre><br>  Voyons voir ce que fait cette classe.  Tout d'abord, nous l'avons d√©sign√© comme une configuration Swagger avec l'annotation @ EnableSwagger2. <br><br>  Ensuite, nous avons cr√©√© un composant Docket qui indique √† Swagger quelles API doivent √™tre affich√©es.  Dans l'exemple ci-dessus, nous avons demand√© √† Swagger de montrer tout chemin commen√ßant par ¬´/ pricing¬ª.  Une alternative serait de sp√©cifier des classes pour la documentation, et non pour les chemins: <br><br><pre> <code class="bash hljs">.apis(RequestHandlerSelectors.basePackage(<span class="hljs-string"><span class="hljs-string">"com.restms.demo"</span></span>)) .paths(PathSelectors.any())</code> </pre><br>  Red√©marrez le microservice de prix et appelez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http: // localhost: 57216 / swagger-ui.html √†</a> partir du navigateur <br><br><img src="https://habrastorage.org/webt/8x/0k/gk/8x0kgk8hxs_dpijzolsmxk8rdva.png"><br><br>  Cliquez sur Lister les op√©rations pour afficher les op√©rations de service en d√©tail. <br>  Cliquez sur D√©velopper les op√©rations pour cr√©er une demande bas√©e sur le formulaire.  D√©finissez certains param√®tres, cliquez sur "Essayez-le!"  et attendez la r√©ponse: <br><br><img src="https://habrastorage.org/webt/rf/0_/iu/rf0_ius_kz3fljd74-aaqhzwsia.png"><br><br>  Vous pouvez ajouter beaucoup plus de couleurs en ajoutant des annotations Swagger √† vos m√©thodes. <br>  Par exemple, d√©corez la m√©thode PricingImpl.getPricedPortfolio existante √† l'aide de l'annotation @ApiOperation, comme illustr√© ci-dessous: <br><br><pre> <code class="bash hljs">@ApiOperation(value = <span class="hljs-string"><span class="hljs-string">"Retrieves a fully priced portfolio"</span></span>, notes = <span class="hljs-string"><span class="hljs-string">"Retrieves fully priced portfolio given customer id and portfolio id"</span></span>) @GetMapping(<span class="hljs-string"><span class="hljs-string">"/customer/{customer-id}/portfolio/{portfolio-id}"</span></span>) public List&lt;String&gt; getPricedPortfolio(@PathVariable(<span class="hljs-string"><span class="hljs-string">"customer-id"</span></span>) Integer customerId, @PathVariable(<span class="hljs-string"><span class="hljs-string">"portfolio-id"</span></span>) Integer portfolioId)</code> </pre> <br>  Rechargez et mettez √† jour swagger-ui pour voir la nouvelle documentation mise √† jour: <br><br><img src="https://habrastorage.org/webt/1z/vy/bj/1zvybjvfyh6zmjxd7gahn5_tlyi.png"><br><br>  Et ce n'est pas tout ce que vous pouvez faire avec Swagger, alors consultez la documentation. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Yuri Dvorzhetsky</a> , un conf√©rencier dans notre cours <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"Developer on the Spring Framework",</a> vous en dira plus sur Spring Boot: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/zgd9SfSxO0Y" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><i>Article original</i></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr413567/">https://habr.com/ru/post/fr413567/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr413557/index.html">NewSQL: SQL ne va nulle part</a></li>
<li><a href="../fr413559/index.html">D√©gradation du Web ou comment rendre le Web lisible par l'homme</a></li>
<li><a href="../fr413561/index.html">Vitesse d'arbre d'expression Linq compil√©e</a></li>
<li><a href="../fr413563/index.html">4 fa√ßons d'importer un package dans Go</a></li>
<li><a href="../fr413565/index.html">Analyse de piratage Kubernetes - Porte d√©rob√©e via Kubelet</a></li>
<li><a href="../fr413569/index.html">D√©mant√®lement des batteries au lithium-ion de l'usine 18650</a></li>
<li><a href="../fr413571/index.html">Num√©ro 25: Formation informatique - probl√®mes et d√©fis actuels des grandes entreprises</a></li>
<li><a href="../fr413575/index.html">BricsCAD Shape - CAO 3D gratuit de Bricsys</a></li>
<li><a href="../fr413577/index.html">[Annonce] Hubs pour la comp√©tition sur CodinGame.com dans sept villes de Russie</a></li>
<li><a href="../fr413579/index.html">Nous allons mettre un mot sur la d√©composition du code: programmation contextuelle</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>