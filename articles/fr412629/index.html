<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêÜ üõ†Ô∏è üó°Ô∏è Forme d'onde adaptative pour votre service audio üêí üë©üèΩ‚Äçü§ù‚Äçüë®üèø ‚ùÑÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Lorsque j'avais besoin de configurer une archive audio pour un seul site de diffusion, en plus du panneau d'administration, j'avais √©galement besoin d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Forme d'onde adaptative pour votre service audio</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/412629/"><img src="https://habrastorage.org/webt/nw/k4/n3/nwk4n3zrjoklldqz2vfmpq25nzs.gif"><br><br>  Lorsque j'avais besoin de configurer une archive audio pour un seul site de diffusion, en plus du panneau d'administration, j'avais √©galement besoin d'un lecteur audio.  L'√©mission a dur√© 40 minutes plus deux pauses musicales.  L'utilisation de Waveform dans des formats aussi longs est particuli√®rement pratique.Par cons√©quent, comme de nombreux services de musique, j'ai d√©cid√© d'utiliser cette solution dans la conception du lecteur. <br><br>  Avec la future refonte pr√©vue du site et, √©ventuellement, les futures applications mobiles, la forme d'onde raster reposait simplement contre le coin.  Il n'est pas adaptatif, il est extr√™mement gourmand en ressources √† reconcevoir s'il est dans le raster. <br><a name="habracut"></a><br>  Le c√©l√®bre SOUNDCLOUD a r√©solu ce probl√®me sur de petits √©crans en d√©pla√ßant toute la forme d'onde par rapport au centre statique.  Mais je ne veux pas √ßa. <br><br>  La diffusion radio a √©t√© effectu√©e via le panneau d'administration, et j'ai imm√©diatement fait plus de copies compress√©es des fichiers audio via ffmpeg.  Il serait stupide d'abandonner ses capacit√©s et de g√©n√©rer une forme d'onde. <br><br><h4>  Algorithme d'actions: </h4><br>  1. G√©n√©ration d'une forme d'onde dans une taille minimale pour le stockage <br>  2. Traduction en vecteur (JSON) <br>  3. Dessiner un joueur pour ce tableau <br>  4. Mise en ≈ìuvre de l'adaptabilit√©: r√©duction uniforme de la matrice et retour √† l'√©tape 3 <br><br><h3>  G√©n√©ration de forme d'onde </h3><br><br>  Au moment de la mise en ≈ìuvre de cette approche, les camarades de la BBC n'avaient pas encore publi√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">la</a> sortie en JSON <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dans leur utilitaire</a> , pour autant que je m'en souvienne.  Et pour le moment, je vous recommande de reconstruire leur utilitaire pour supprimer la sortie inutile de nombres n√©gatifs et suppl√©mentaires.  Vieux sur les canaux de bitness et autres b√™tises. <br>  En attendant, continuez: <br><br>  Si nous prenons ma conception du lecteur (sa largeur est r√©duite ici), nous verrons qu'il y a 2 pixels par bande (plus 1 s√©parateur de pixels).  Cela signifie que 600px nous donnera 1200px de largeur. <br><br><img src="https://habrastorage.org/webt/p9/dk/wf/p9dkwfisywv4-irpqxeyteuqpvw.jpeg"><br><br>  Je suppose qu'√† l'avenir, il sera extr√™mement improbable qu'une plus grande pr√©sentation du fichier audio soit n√©cessaire.  Eh bien, si vous ne tirez pas le design sur toute la largeur du moniteur 4K, vous devriez y penser, mais je m'arr√™te √† 600x60px. <br><br>  Et maintenant plus proche du code: <br><br><pre><code class="php hljs">shell_exec(<span class="hljs-string"><span class="hljs-string">"ffmpeg -y -i '$name.mp3' -filter_complex 'aformat=channel_layouts=mono,compand,showwavespic=s=600x120,crop=in_w:in_h/2:0:0' -c:v png -pix_fmt monob -frames:v 1 '$png_path.png' &gt; /dev/null 2&gt;/dev/null &amp;"</span></span>);</code> </pre> <br>  <i>-filter_complex</i> - connecte des filtres <br><br>  <i>aformat</i> - travailler avec le son <br><br>  <i>channel_layouts</i> <br><br>  <i>-mono</i> - mode mono <br><br>  <i>-compand</i> est un compresseur et un expandeur.  Dans ce mode, les sons faibles et forts seront √©galis√©s en volume, ce qui vous permet d'obtenir une forme d'onde sans pics ni surcharges sur les enregistrements silencieux et forts.  La forme d'onde, pour ainsi dire, est toujours √©tir√©e au maximum. <br><br>  <i>-showwavespic = s = 600x120</i> - s prend la taille de l'image. <br><br>  <i>-crop = in_w: in_h / 2: 0: 0</i> - recadrez l'image re√ßue.  En r√®gle g√©n√©rale, la r√©ponse en fr√©quence de sortie est refl√©t√©e autour de l'axe x.  Par cons√©quent, nous saupoudrons, ne laissant que la pointe de l'iceberg. <br><br>  <i>-c: v png -pix_fmt monob -frames: v 1</i> - format d'image de sortie, palette de couleurs bw et uniquement la premi√®re image (nous n'avons pas besoin d'animation).  png8 est id√©al pour la qualit√© (sans perte dans notre cas) / lieu. <br><br>  <i>&gt; / dev / null 2&gt; / dev / null &amp;</i> envoyer la sortie et les donn√©es de travail √† l'ab√Æme.  Et '&amp;' permet √† php de ne pas attendre que la console ait fini de fonctionner, mais de continuer. <br><br>  En sortie, on obtient cette image: <br><br><img src="https://habrastorage.org/webt/4f/ee/s6/4fees6nkctphgo1oaxk6j9es7s0.png"><br>  Taille du fichier final 2.4kb <br><br>  <i>Ce qui est dr√¥le, c'est qu'il y a quelques ann√©es, au lieu du blanc, il y avait une couleur rouge.</i>  <i>Les d√©veloppeurs ont apparemment chang√© les valeurs par d√©faut.</i> <br><br><h3>  Convertir la forme d'onde en vecteur </h3><br>  L'image r√©sultante est l'amplitude en Y et le temps en X. Il est √©l√©mentaire de la traduire en un tableau JSON unidimensionnel.  O√π les valeurs agiront comme des valeurs d'amplitude, et le temps est simplement leur indice ordinal. <br><br>  J'ai d√©cid√© de faire la traduction √† la vol√©e, sans mettre en cache le r√©sultat, c'est tr√®s vite fait. <br>  Nous mesurons le nombre de pixels le long de Y du haut vers le premier, et passons au pixel suivant le long de X. <br><br><pre> <code class="php hljs">$a = imagecreatefrompng(<span class="hljs-string"><span class="hljs-string">"test.png"</span></span>); $i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $h = <span class="hljs-string"><span class="hljs-string">'60'</span></span>; <span class="hljs-comment"><span class="hljs-comment">// horizontal movener while ( $i &lt; 600 ) { // vertical movener $y = $h-1; $c = 0; while ( $c &lt; $h ) { //echo imagecolorat($aa, $i, $c ); // test color if(imagecolorat($a, $i, $c ) == "255") { $arr[$i] = $c; break; } else { $arr[$i] = $y; } $c++; } $i++; }; echo json_encode($arr);</span></span></code> </pre><br>  Le tableau r√©sultant se compose de 600 valeurs. <br><br> <code>[46,28,34,35,34,35,26,33,39,29,29,30,30,30,33,33,28...]</code> <br> <br><h3>  Rendu des joueurs par JSON </h3><br>  Pour une barre de progression de travail pratique, j'ai pris progressor.js d'Elliot Bentley.  Il l'a fait pour un service de transcription audio. <br><br>  <a href="">github.com/ejb/progressor.js</a> 2,76 Ko <br><br>  Jetons √† nouveau un ≈ìil √† notre joueur. <br><br><img src="https://habrastorage.org/webt/p9/dk/wf/p9dkwfisywv4-irpqxeyteuqpvw.jpeg"><br><br>  La barre de progression se compose de deux couches: un arri√®re-plan avec des barres grises et vertes. <br><br>  Ci-dessous, les images sont dessin√©es avec la fonction getGraph. <br><br>  Son sens est de dessiner des colonnes de l'√©paisseur et de la couleur souhait√©es avec des s√©parateurs de colonnes. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> c = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">"canvas"</span></span>); c.width = width; c.height = height; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ctx = c.getContext(<span class="hljs-string"><span class="hljs-string">"2d"</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getGraph</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fillStyle1,fillStyle2,fillStyle3</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fillStyle3) { <span class="hljs-comment"><span class="hljs-comment">//console.log(fillStyle1); var grd = ctx.createLinearGradient(0,120,0,0); grd.addColorStop(0.5,fillStyle1); grd.addColorStop(1,fillStyle2); fillStyle1 = grd; fillStyle2 = fillStyle3; } json.forEach(function(item, i, arr) { ctx.fillStyle = fillStyle1; ctx.fillRect(i * 3, height, 2, item - height); ctx.fillStyle = fillStyle2; var next = json[i + 1]; if( item &lt;= next ) { h2 = next; } else { h2 = item; } ctx.fillRect(i * 3 + 2, height, 1, h2 - height); }); return c.toDataURL(); }</span></span></code> </pre><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Voici un exemple de travail sans adaptabilit√©</a> <br><br><h3>  4. Mise en ≈ìuvre de l'adaptabilit√© </h3><br>  Maintenant, nous devons r√©duire le tableau JSON sur le client √† la taille souhait√©e et vous avez ici l'adaptabilit√©. <br><br><h3>  Planifiez un </h3><br>  La toute premi√®re m√©thode qui vient √† l'esprit est de supprimer tous les deuxi√®me, troisi√®me, quatri√®me ... dans un cycle, de sorte que vous ne pouvez pas r√©duire le tableau de moins de moiti√©, et la pr√©cision des pixels ne peut pas √™tre obtenue ici. <br><br>  La modification de la forme d'onde en supprimant les valeurs du tableau est une impasse.  Lorsque vous faites cela, vous verrez combien la forme d'onde se d√©chire impersonnellement, car vous lancez des extr√™mes et ne faites pas la moyenne des voisins en hauteur. <br><br>  Nous avons besoin d'algorithmes de r√©√©chantillonnage.  Il existe une impl√©mentation de l'algorithme sur js: <br><br>  <a href=""><b>plus grandTriangleTroisSeaux</b></a> <br><br>  Il fonctionne bien, ne demande qu'une entr√©e comme un tableau, aux indices desquels il recevra les coordonn√©es XY. Nous avons un tableau unidimensionnel, j'ai donc d√ª me moquer un peu et refaire la fonction.  Cette chose fonctionne comme ceci: <br><br><img src="https://habrastorage.org/webt/mf/xx/wt/mfxxwtrk4jf5nddwlkqpmzu3__e.gif"><br><br>  Et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici,</a> vous pouvez toucher avec adaptative comme KDPV. <br><br>  D√©finissez le mode d'affichage o√π le cadre html sera sur la droite.  Ensuite, vous pouvez modifier la largeur de cette fen√™tre. <br><br><h3>  Plan B - Puff </h3><br>  Cependant, je ne voudrais toujours pas charger le c√¥t√© client.  Par exemple, je veux 1000 points-5000, mais toute la largeur de l'√©cran.  Si j'ai plus de points, comment cette chose se comportera-t-elle sur un mobile?  D'une part, ce n'est absolument pas un probl√®me, ce n'est pas si cher en apparence, √† en juger par les d√©mos de l'algorithme, il m√¢che facilement 5000 points.  Mais d'un autre c√¥t√©, il faut donner autant qu'on demande.  Question de design. <br><br>  √âl√©mentaire, si vous avez Node.Js, vous pouvez transf√©rer ce code sur le serveur.  Et si vous avez php, vous pouvez trouver une impl√©mentation de cet algorithme en php mais ... pourquoi, pensais-je. <br><br>  O√π sont les algorithmes de r√©√©chantillonnage?  Dans la m√™me biblioth√®que native GD que celle utilis√©e pour g√©n√©rer JSON.  Nous passons simplement le param√®tre du client en pixels de la largeur requise et redimensionnons notre forme d'onde avant de la convertir en JSON. <br><br>  Par cons√©quent, je d√©velopperai le code √©crit au d√©but. <br><br><pre> <code class="php hljs">$h = <span class="hljs-number"><span class="hljs-number">60</span></span>; $width_new = <span class="hljs-number"><span class="hljs-number">600</span></span>; $a = imagecreatefrompng(<span class="hljs-string"><span class="hljs-string">"$id.png"</span></span>); $width_old = imagesx($a); $aa = imagecreatetruecolor($width_new, $h); imagecopyresized($aa, $a, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, $width_new, $h, $width_old, $h); imagetruecolortopalette($aa, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>); $i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// horizontal movener while ( $i &lt; $width_new ) { // vertical movener $y = $h-1; $c = 0; while ( $c &lt; $h ){ //echo imagecolorat($aa, $i, $c ); // search what color is needed if(imagecolorat($aa, $i, $c ) == "1"){ $arr[$i] = $c; break; } else { $arr[$i] = $y; } $c++; } $i++; }; echo json_encode($arr);</span></span></code> </pre><br>  Apr√®s cela, vous ne pouvez pas vous inqui√©ter si vous devez modifier la conception, la largeur du lecteur, d√©velopper une application mobile.  Tout semble assez flexible et tr√®s intelligent. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le code est ici</a> <br><br><div class="spoiler">  <b class="spoiler_title">.</b> <div class="spoiler_text">  Oeuf de P√¢ques. <br><br>  C'√©tait probablement une journ√©e ensoleill√©e.  La fen√™tre de notre chambre donnait sur deux anciens planchers de briques de 9 √©tages, dont je me souviens √©tant adolescent, je sais qu'un anneau de tramway s'ouvre derri√®re eux, un peu plus loin - l'ancien h√¥pital, il est juste derri√®re l'√©cole, et le b√¢timent actuel avec le bureau o√π j'essaie de creuser. dans ses m√©moires, il s'agit d'un ancien h√¥pital inachev√©, maintenant un immeuble de bureaux purement.  Je me souviens comment, dans mon enfance, les forces sp√©ciales se sont entra√Æn√©es ici, elles ont √©t√© montr√©es √† la t√©l√©vision, prenant d'assaut vigoureusement une structure en b√©ton, envahie par tout ce qui l'entourait.  Et maintenant, il s'av√®re que je choque √©nergiquement la balustrade brillante, que je descends les escaliers et que j'admire la forme de distorsion de ce b√¢timent dans le reflet du complexe r√©sidentiel le plus proche.  (√Ä proximit√©, le long de la ligne de tramway, le mur de l'ancien grand cimeti√®re s'ouvre. Et sur elle est une inscription en peinture verte "Pendant que Boris est au pouvoir" et "Labour Russia". Dieu sait qui et quand ils ont √©t√© faits, mais apr√®s quelques d√©cennies, ils lisent encore mais restent compl√®tement invisibles. Je n'ai plus vu depuis l'h√©ritage des ann√©es 90 un monument plus ancien de la ville.) <br><br>  Au dernier √©tage, il est vide, car il se trouve vide dans un paquet avec du sarrasin qui a √©t√© commenc√©: il y a beaucoup de tout en dessous et serr√©: certains escrocs de g√©o-intelligence sp√©ciale, bureau 2gis, puis seoshniki r√©gulier, et au-dessus il n'y a presque pas de grains.  Pensez-vous que quelque chose devrait pousser √† travers les planchers de quelque chose ici, mais au cours des 5 derni√®res ann√©es, seul le lave-vitres a regard√© du transcendantal et du comptable immanent aux yeux fous, qui frappent √† toutes les portes du sol √† la recherche de quelqu'un , qui vous expliquera comment signer un paiement via un plug-in fou pour les services bancaires par Internet en raison d'une autre mise √† jour du navigateur. <br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr412629/">https://habr.com/ru/post/fr412629/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr412619/index.html">myDribbble Meetup 2017 √† Moscou</a></li>
<li><a href="../fr412621/index.html">Comment devenir magicien (partie 3). Lettre de Poudlard</a></li>
<li><a href="../fr412623/index.html">Le nouveau kit pour Star Citizen co√ªtera 27 000 $</a></li>
<li><a href="../fr412625/index.html">Comment trouver rapidement et ne pas perdre des sp√©cialistes de l'IA et de la science des donn√©es</a></li>
<li><a href="../fr412627/index.html">Exposition internationale CMEF & ICMD 2018 Spring in Shanghai (Part 2)</a></li>
<li><a href="../fr412633/index.html">Exp√©rience de la configuration et de l'utilisation de WSL (sous-syst√®me Linux dans Windows 10)</a></li>
<li><a href="../fr412637/index.html">Faire ou ne pas repenser les logos? Telle est la question</a></li>
<li><a href="../fr412639/index.html">Ce que vous devez attendre pour cr√©er des strat√©gies de trading sur la bourse: l'efficacit√© de l'apprentissage automatique</a></li>
<li><a href="../fr412641/index.html">Qu'ont en commun l'exploitation mini√®re, la G√©orgie et Irkoutsk?</a></li>
<li><a href="../fr412643/index.html">Comment nous avons int√©gr√© le syst√®me de paiement dans le projet russe</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>