<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üò™ ü§™ üö∞ Errores t√≠picos al trabajar con PostgreSQL. Parte 1 üòÇ üë©üèæ‚Äçüç≥ üë©üèø‚Äç‚öñÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hace poco m√°s de un mes, en Mosc√∫, se celebr√≥ la conferencia m√°s grande de la comunidad post-PG PGConf.Rusia 2019, que reuni√≥ a m√°s de 700 personas en...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Errores t√≠picos al trabajar con PostgreSQL. Parte 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/postgrespro/blog/442462/"> Hace poco m√°s de un mes, en Mosc√∫, se celebr√≥ la conferencia m√°s grande de la comunidad post-PG PGConf.Rusia 2019, que reuni√≥ a m√°s de 700 personas en la Universidad Estatal de Mosc√∫.  Decidimos publicar un video y una transcripci√≥n de los mejores informes.  La presentaci√≥n de <b>Ivan Frolkov sobre los errores t√≠picos cuando se trabaja con PostgreSQL</b> fue considerada como la mejor en la conferencia, por lo que comenzaremos con ella. <br><br>  Por conveniencia, dividimos el descifrado en dos partes.  En este art√≠culo, hablaremos sobre nombres inconsistentes, sobre restricciones, sobre d√≥nde es mejor concentrar la l√≥gica: en la base de datos o en la aplicaci√≥n.  La segunda parte tratar√° con el manejo de errores, acceso concurrente, operaciones no cancelables, CTE y JSON. <br><br><img src="https://habrastorage.org/webt/f7/ro/mc/f7romcfk7jnjqrlwyalubebwxbo.jpeg"><br><br>  En nuestra empresa, me dedico a la atenci√≥n al cliente en temas relacionados con las aplicaciones, es decir, ayudo en casos de problemas con las conexiones, con la optimizaci√≥n de consultas y otras cosas similares.  He visto suficientes de las aplicaciones m√°s diversas.  Lo que simplemente no vi!  Quiz√°s incluso m√°s de lo que nos gustar√≠a.  Parte de lo que contar√© se aplica no solo a PostgreSQL, sino a cualquier base de datos, pero algo principalmente a PostgreSQL. <br><br>  La conclusi√≥n principal que pude extraer de lo que vi fue bastante inesperada: de hecho, cualquier aplicaci√≥n con la debida persistencia puede funcionar.  Hubo un proyecto maravilloso (no puedo mencionar todas las empresas con las que trabajamos) en el que una aplicaci√≥n a√∫n m√°s maravillosa cre√≥ tablas por millones.  Se ve√≠a as√≠: el lunes, el sistema funciona bien, y el viernes pr√°cticamente no funciona.  Los fines de semana, lanzan VACUUM FULL y el lunes vuelve a funcionar bien.  Resulta que puedes burlarte de PostgreSQL de esta manera, y todo esto vivir√° y funcionar√° durante bastante tiempo.  Otro compa√±ero hizo algo extra√±o: todo se bas√≥ en factores desencadenantes en √©l, no hubo procedimientos en absoluto.  Es decir, la mayor√≠a de las mesas no se pueden tocar, algo no se puede hacer, pero esta base tambi√©n vivi√≥. <br><a name="habracut"></a><br>  Lo explic√≥ de esta manera: ‚Äúla base se mueve de un estado consistente a otro consistente.  Si vuelvo a cargar los datos, se romper√°.  Pero como tengo disparadores y una clave √∫nica, no puedo volver a enrollar los datos ".  El enfoque es salvaje, pero al mismo tiempo tiene sentido.  Tal vez fue necesario hacerlo de manera diferente, pero tambi√©n es necesario tener en cuenta las caracter√≠sticas de los clientes.  El primer error del que hablar√© es: <br><br><img src="https://habrastorage.org/webt/4p/lf/qc/4plfqce37dhhwayo5nbkpl1uxxa.jpeg"><br><br>  Aqu√≠ hay un ejemplo real que encontr√©.  En la diapositiva, ver√° c√≥mo se nombr√≥ la misma entidad en diferentes columnas.  Tambi√©n se podr√≠a con espacios.  Otros objetos tambi√©n fueron nombrados inconsistentemente.  Si necesita tomar algo en otra tabla, entonces necesita ver c√≥mo se llama all√≠, ¬øes lo mismo?  Si tiene id_user y user_id en la misma tabla, el trabajo comienza con la investigaci√≥n: ¬øqu√© significar√≠a todo? <br><br>  Para otros clientes, todos los objetos se nombraron as√≠: dos letras, luego cinco d√≠gitos.  Debo decir que no fue "1C".  Por qu√© hicieron esto, no lo s√©: no hab√≠a l√≥gica en esto, pero es mi negocio optimizar las consultas. <br><br>  Otro ejemplo: parte de los nombres en ruso, parte en no ruso, pero con alg√∫n tipo de acento ruso.  Esto dificulta la comprensi√≥n y crea nuevos errores.  Yo mismo trato de nombrar las columnas como si estuviera contando con un servicio, cu√°l de estos nombres de columna har√° autom√°ticamente nombres de columna normales en alg√∫n informe.  En la vida real, desafortunadamente, no es muy exitoso nombrar consistentemente, incluido el m√≠o.  Esto es especialmente dif√≠cil con el desarrollo colectivo.  Pero debemos esforzarnos. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/sdVfBkoz_Fc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Otra raz√≥n importante para nombrar secuencialmente: los nombres de objetos est√°n disponibles a trav√©s de solicitudes de metadatos, es decir, los nombres tambi√©n son datos.  Podr√° escribir una solicitud y seleccionar, por ejemplo, todas las im√°genes, en general, todas las im√°genes, de la base de datos. <br><br><img src="https://habrastorage.org/webt/0j/lj/2f/0jlj2fncre7udyrknycske7s8iw.jpeg"><br><br>  Los metadatos claros son muy convenientes.  Especialmente cuando considera los problemas t√≠picos con la documentaci√≥n, y en mi experiencia la documentaci√≥n generalmente est√° ausente, incompleta o incorrecta, o ambas: porque la tarea de escribir buena documentaci√≥n es comparable en complejidad a la tarea de escribir el c√≥digo en s√≠.  Por lo tanto, es mejor cuando el c√≥digo se auto documenta.  Y un nombre l√≥gico y coherente de los objetos contribuye a esto, y cuando algo no est√° claro, debe escribir un c√≥digo de fragmento y observar c√≥mo funciona.  Una vez que no es nada, dos nada, pero cuando lo haces todo el d√≠a, es agotador. <br><br><img src="https://habrastorage.org/webt/10/zm/0k/10zm0kofn31dedkjwo8chc_ckp4.jpeg"><br><br>  El caso real: una organizaci√≥n muy seria con la que trabajamos ten√≠a una base: el flujo de trabajo en Oracle.  Lo trasladamos a Postgres.  Uno de los t√©rminos del contrato era que impon√≠amos CLAVES EXTRANJERAS.  No estaban all√≠ y, desafortunadamente, no pudimos imponerlos: result√≥ que las mesas ten√≠an muchas filas "izquierdas", y nadie sabe qu√© hacer con ellas, incluido el cliente. <br><br>  Cuando no necesita mirar las barras de progreso, pero trabaja con documentos para pagar dinero, entonces la situaci√≥n es triste.  Ayuda mucho cuando, seg√∫n el contrato, el programador paga los errores por s√≠ mismo, y es deseable que las cantidades sean grandes; luego, la iluminaci√≥n ocurre en minutos, probablemente quince.  Las restricciones aparecen inmediatamente, inmediatamente todo comienza a ser verificado. <br><br>  Ni siquiera se imagina (bueno, tal vez alguien ya se imagina) lo mucho m√°s conveniente que es lidiar con el caso cuando el pago fall√≥, que cuando pas√≥, pero no all√≠.  Especialmente si la cantidad es grande.  Esto es por experiencia personal. <br><br><img src="https://habrastorage.org/webt/iz/iz/ng/izizngxvaxznqqn2xbc0alnxddq.jpeg"><br><br>  Por otro lado, a menudo se puede escuchar que la restricci√≥n reduce el rendimiento.  S√≠, lo hacen, pero si desea tener los datos correctos, simplemente no hay otras opciones para usted.  Si tiene una aplicaci√≥n que tiene en cuenta el n√∫mero de visitas a la tienda por parte de los clientes, puede haber imprecisiones que no afectar√°n especialmente las estad√≠sticas, y si contamos el dinero, las restricciones son necesarias. <br><br>  Los nombres de restricciones generalmente son generados por un ORM o sistema, y ‚Äã‚Äãgeneralmente nadie se molesta espec√≠ficamente en nombrar restricciones, ¬°pero en vano!  Cuando contin√∫a procesando el error, con el nombre de restricci√≥n, puede enviar un mensaje claro al usuario, clasificar el error y hacerle saber si debe intentar realizar la operaci√≥n nuevamente, o si esta operaci√≥n ya no es necesaria o simplemente no puede repetirse. <br><br>  Otra cosa que no he visto, pero que recomiendo encarecidamente: para todas las operaciones importantes de auditor√≠a financiera (y no solo financiera), debe haber al menos dos.  El hecho es que tarde o temprano se encontrar√° con algo para cambiar en el c√≥digo, y es muy posible que rompa una de las verificaciones.  Entonces el segundo te salvar√°.  Si haces tres, tampoco est√° mal. <br><br><img src="https://habrastorage.org/webt/e1/qz/8a/e1qz8aawn39pl2koidzfe2ducvo.jpeg"><br><br>  A menudo surge la pregunta: d√≥nde verificar la exactitud de los datos.  ¬øEn el cliente o en el servidor?  En mi opini√≥n, es obvio que debe verificar tanto all√≠ como all√≠.  Tiene un error en el cliente, entonces el servidor no est√° <br>  fallar√°, o si tiene un error en el servidor, entonces al menos el cliente ayudar√° a rastrearlo.  La pregunta es algo discutible, y pasamos sin problemas al tema: ¬ød√≥nde mantener la l√≥gica base: en la aplicaci√≥n o en la base de datos? <br><br>  Es conveniente en la base de datos porque, en mi experiencia, una empresa regularmente emite cambios urgentes: elimine o inserte esto y eso es lo segundo.  Si tiene l√≥gica en el c√≥digo compilado, debe recopilar, implementar y ver qu√© sucedi√≥.  A menudo esto es simplemente imposible.  En la base de datos, esto es m√°s conveniente.  Pero hay un aforismo bien conocido: los programadores experimentados de Fortran escriben en Fortran en cualquier idioma.  El 80 por ciento del c√≥digo del servidor est√° escrito en un estilo completamente de procedimiento: tenemos la funci√≥n "get_user ()" y devuelve el tipo "usuario", y si "get_list_users ()", devuelve una matriz de "usuarios".  Es realmente m√°s conveniente escribir tales cosas en Java que en SQL o pgsql. <br><br><img src="https://habrastorage.org/webt/6w/hw/nz/6whwnz-4moi5mhyce4v3b0ez5fy.jpeg"><br><br>  Por otro lado: ¬øpor qu√© necesita la funci√≥n "get_user ()"?  Simplemente lo toma en una mesa o en una vista.  Como tiene una base de datos relacional, debe escribir, como me parece, relacional.  Es importante, en primer lugar, determinar claramente con qu√© datos estamos trabajando: si nuestros datos son basura o semi-basura, entonces el resultado ser√° apropiado y probablemente no deber√≠a eliminarse.  Si los datos son importantes para nosotros, si se trata de dinero, propiedad u operaciones legales, entonces se necesita restricci√≥n y cuanto m√°s mejor.  Repito: es mejor no realizar la operaci√≥n que realizarla incorrectamente.  Y no escriba c√≥digo de procedimiento en una base de datos relacional: lo lamentar√° mucho. <br><br><img src="https://habrastorage.org/webt/6-/gb/me/6-gbmeqxsupjei79il3wrnp_jts.jpeg"><br><br>  Vi una tabla con 30 mil filas (productos), en la que la solicitud "mostrar una lista de productos relevantes" se ejecut√≥ durante aproximadamente un segundo.  Aparentemente, lograron crear un esquema de base de datos "hermoso y complejo".  Personalmente, creo que si est√° haciendo algo muy complicado, lo m√°s probable es que est√© haciendo algo mal o que realmente tenga una tarea muy, muy dif√≠cil.  Si tiene alg√∫n tipo de tienda o una aplicaci√≥n regular para contadores, entonces es poco probable que existan relaciones muy complejas entre entidades. <br><br>  Cuando comenc√© mi carrera profesional, la tabla en un archivo DBF de 60 megabytes en el sistema bancario parec√≠a muy grande, y ahora 60 megabytes no es nada en absoluto: el hardware es mejor, el software es mejor, todo funciona m√°s r√°pido, pero la pregunta sigue siendo: ¬ød√≥nde obtienes tanto? datos?  Las bases muy grandes e hinchadas generalmente se vuelven as√≠ debido a los archivos.  En cualquier DBMS y en PostgreSQL, se ha invertido mucho esfuerzo para garantizar el funcionamiento competitivo de la aplicaci√≥n consistente.  Lo m√°s probable es que el archivo no cambie, y la mayor√≠a de las capacidades de DBMS para trabajar con √©l no son necesarias en absoluto.  Vale la pena pensar en sacarlo del DBMS. <br><br><img src="https://habrastorage.org/webt/oa/sb/yr/oasbyrwvfcu8t8marxk3nx5xj98.jpeg"><br><br>  De vez en cuando, con una especie de estrabismo del comisario, hacen la pregunta: ¬øPostgreSQL extraer√° una base de tal o cual volumen?  Pero aqu√≠ la pregunta en s√≠ es extra√±a: puede poner datos en la base de datos tanto como desee, siempre que haya suficiente espacio en disco, habr√° mucho.  La pregunta es, por ejemplo, c√≥mo hacer una copia de seguridad de los archivos en petabytes, d√≥nde colocar√° la copia de seguridad completa y cu√°nto la quitar√°.  Sospecho firmemente que al menos parcialmente estos requisitos de volumen est√°n relacionados con el deseo de los vendedores de equipos de venderle m√°s. <br><br>  Si almacena documentos en la base de datos, es poco probable que los procese all√≠: la hoja de c√°lculo de Excel, por supuesto, puede modificarse en el servidor, pero esta es una ocupaci√≥n extra√±a.  Lo m√°s probable es que tales archivos sean generalmente de solo lectura.  Es mejor almacenar enlaces a documentos y ellos mismos en alg√∫n almacenamiento externo.  Al final, puede mantener la firma digital de la tabla, para que no cambie (si decide los asuntos legislativos relevantes). <br><br>  Otra observaci√≥n: si no tiene un mega-mega negocio, no una especie de, por ejemplo, una empresa federal, entonces es poco probable que tenga una base muy grande.  Si no almacena video en √©l, por supuesto. <br><br><img src="https://habrastorage.org/webt/3c/ek/sv/3ceksvarvtdlaeb86hoycymgguu.jpeg"><br><br>  Otra raz√≥n por la que la base de datos es grande son los √≠ndices innecesarios.  No encontr√© bases sin √≠ndices, pero a menudo encontr√© bases donde varios √≠ndices en las mismas columnas en el mismo orden.  La base te permite hacer esto.  Cuando cree un √≠ndice, vea si duplica uno existente.  Puede ver qu√© √≠ndices no son necesarios mirando pg_stat_user_indexes para ver qu√© tan activamente se usa el √≠ndice.  Tal vez no se requiere en absoluto. <br><br>  Me encontr√© con una situaci√≥n (por cierto, t√≠pica), cuando una tabla muy grande no est√° particionada.  En todos los DBMS, las tablas grandes se dividen mejor, pero en PostgreSQL esto es especialmente cierto debido a nuestro querido VACUUM.  Aconsejar√≠a particionar tablas comenzando probablemente con 100 gigabytes.  Tal vez a partir de los 50. Vi tablas de terabytes no particionadas y, sin embargo, viv√≠an de SSD.  Pero esto es un poco demasiado, ser√≠a mejor cortarlos. <br><br><img src="https://habrastorage.org/webt/yf/lo/ug/yflougupmnnaudv4i823izyewmu.jpeg"><br><br>  Y una observaci√≥n m√°s: casi todas las bases de datos de un gran volumen son solo archivos adjuntos.  En vivo, los datos cambiantes rara vez se encuentran en tales bases de datos.  Un determinante con lo que tiene: si es el archivo, entonces puede pensar en c√≥mo llevarlo a alg√∫n lado.  Y, por cierto, puede proporcionarle acceso desde la base de datos.  Entonces la aplicaci√≥n no necesita ser cambiada: nada cambiar√° por ello. <br><br>  Algunas de estas observaciones pertenecen a la categor√≠a "es mejor ser rico y saludable que pobre y enfermo".  A menudo, en primer lugar, hay c√≥digo heredado.  En segundo lugar, sucedi√≥ algo inesperado, no pensaron en algo y resulta que no todo es tan hermoso como nos gustar√≠a.  Pero sin embargo: no seas muy inteligente.  Recuerda que si eres muy inteligente, lo m√°s probable es que est√©s haciendo algo mal. <br><br>  <i>[Continuar√°]</i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/442462/">https://habr.com/ru/post/442462/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../442452/index.html">C√≥mo iniciar sesi√≥n en NodeJS para que los ni√±os del patio respeten</a></li>
<li><a href="../442454/index.html">Magic Leap planea complementar el mundo real con capas digitales</a></li>
<li><a href="../442456/index.html">C√≥mo ahorrar recursos en el navegador y no romper la web. Informe Yandex</a></li>
<li><a href="../442458/index.html">Abismo o camino artificial desde un piloto RPA hasta la implementaci√≥n en toda la empresa</a></li>
<li><a href="../442460/index.html">Ayudando al proveedor queryable a ordenar cadenas interpoladas</a></li>
<li><a href="../442464/index.html">¬øC√≥mo creci√≥ el "Drag√≥n" tripulado</a></li>
<li><a href="../442466/index.html">¬øC√≥mo promover un juego incremental? Gratis, r√°pido y eficiente *</a></li>
<li><a href="../442468/index.html">En un experimento √∫nico, los ratones recibieron visi√≥n infrarroja</a></li>
<li><a href="../442470/index.html">Resumen semanal de Frontend (25 de febrero - 3 de marzo de 2019)</a></li>
<li><a href="../442472/index.html">El resumen de materiales frescos del mundo del front-end para la √∫ltima semana No. 354 (25 de febrero - 3 de marzo de 2019)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>