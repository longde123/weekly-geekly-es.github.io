<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§úüèª üíÜ üîÅ Nous √©crivons un pilote pour un ordinateur portable pour le plaisir et le profit, ou comment s'engager dans le noyau m√™me si vous √™tes un imb√©cile üçà üíØ üå°Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Comment tout a commenc√© 
 Commen√ßons par poser le probl√®me. √âl√©ments fournis: un ordinateur portable. Nouvel ordinateur portable, jeux. Avec r√©tro-√©cl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nous √©crivons un pilote pour un ordinateur portable pour le plaisir et le profit, ou comment s'engager dans le noyau m√™me si vous √™tes un imb√©cile</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484564/"><h2>  Comment tout a commenc√© </h2><br>  Commen√ßons par poser le probl√®me.  √âl√©ments fournis: un ordinateur portable.  Nouvel ordinateur portable, jeux.  Avec r√©tro-√©clairage RVB.  Voici un ordinateur portable comme celui-ci: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f6d/ef2/d0f/f6def2d0ff5bcc3fe56d7805f257fd7c.jpg" alt="image"><br>  <i>Image prise √† partir de lenovo.com</i> <br><br>  Il existe √©galement un programme pour cet ordinateur portable.  Le programme contr√¥le simplement ce r√©tro-√©clairage. <br><br>  Le seul probl√®me est le programme pour Windows, mais je veux que tout fonctionne dans votre Linux pr√©f√©r√©.  Et les ampoules pour briller, et pour que de belles couleurs scintillent.  Oui, c'est juste comment faire, de sorte que sans ing√©nierie inverse et sans √©crire vos pilotes?  La r√©ponse simple est venue rapidement - aucun moyen.  Eh bien, allons √©crire un pilote. <br><a name="habracut"></a><br><h3>  √âtape 1 - Plonger dans le code </h3><br>  Nous avons trois endroits √† partir desquels vous pouvez voir comment le r√©tro-√©clairage clignote.  Par ordre de difficult√© croissante: <br><br>  1. Un grand programme de jeu gonfl√© Lenovo Nerve Center - dans lequel il y a une fonction pour configurer tout ce r√©tro-√©clairage. <br><br>  2. La combinaison des raccourcis clavier Fn + Space est possible.  il est trait√© par le m√™me programme. <br><br>  3. BIOS.  Pendant le chargement de l'ordinateur portable, le r√©tro√©clairage scintille √©galement - mais uniquement en rouge et seulement pendant une seconde. <br><br>  Pour l'avenir, je dirai que je devais essayer les trois, mais je n'ai progress√© avec un certain succ√®s que le premier.  Nous allons parler d'elle. <br><br>  Eh bien, ouvrez le dossier du programme: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/105/aaa/774/105aaa77430d926b8df36807cb177f77.png" alt="dossier"><br><br>  Nous remarquons imm√©diatement qu'il existe une DLL avec un nom int√©ressant - LedSettingsPlugin.dll.  La n√¥tre est-elle ...?  Ouvrons dans IDA Pro et jetons un ≈ìil. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/39c/994/5ae/39c9945aec86778f668c0f14ec97fe00.png" alt="moiti√© droite"><br><br>  Faites attention √† la moiti√© droite de l'√©cran.  Il y a beaucoup d'informations laiss√©es par les programmeurs - nous les utiliserons.  Nous voyons que pour une raison quelconque, il existe de nombreuses lignes similaires aux noms de m√©thode.  Pourquoi? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8e8/cd8/77d/8e8cd877d3551b32d680a2ce399f34d6.png" alt="nom-de-fonction"><br><br>  Et ce sont les noms des m√©thodes.  Comme c'est pratique!  Disons ce que nous pouvons avec nos propres noms, et regardons √† nouveau la liste des fonctions.  Pour nommer dans l'IDA, vous pouvez utiliser le raccourci clavier N, ou simplement cliquer avec le bouton droit sur ce que nous voulons appeler. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dc1/0a0/fd7/dc10a0fd790c45cfe0ace4303a971c64.png" alt="setledstatusex"><br><br>  Nous regardons les fonctions ... Y720LedSetHelper :: SetLEDStatusEx.  On dirait que nous devons!  Nous remarquons que quelque chose comme une cha√Æne est form√©e ici, puis pass√©e √† un certain CHidDevHelper :: HidRequestsByPath.  Plus pr√©cis√©ment int√©ress√© par var_38, toutes les m√©tamorphoses dont l'IDA nous a gentiment d√©sign√©. <br><br>  Var_34 nous int√©resse √©galement.  Il va juste apr√®s var_38 - dans la tradition d'assemblage, les variables sont stock√©es dans l'ordre inverse sous RSP.  Var_34 n'est ici que le nom de la constante - -34h. <br><br>  Nous obtenons qu'√† partir de var_38 le programme met z√©ro, puis le style, la couleur, le num√©ro trois et le bloc sont la partie du clavier √† laquelle cette couleur s'appliquera.  (Pour l'avenir, je dirai que trois est la valeur de luminosit√© ici. Apr√®s l'avoir rendu g√©rable, nous obtenons le pilote encore plus cool que l'original!) <br><br>  Entrons dans HidRequestsByPath et d√©couvrons enfin comment cela se passe. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bd3/368/4ea/bd33684ea9ec9a7253bb2902c91c1e04.png" alt="devhelper"><br><br>  Nous voyons deux fonctions, HidD_GetFeature et HidD_SetFeature.  Les deux dans le fichier ne sont pas trac√©s ... Mais ils sont tr√®s bien trac√©s dans la documentation officielle de Microsoft - <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/hidsdi/nf-hidsdi-hidd_setfeature" rel="nofollow">ici</a> et <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/hidsdi/nf-hidsdi-hidd_getfeature" rel="nofollow">ici</a> . <br><br>  Vous pouvez vous en f√©liciter - nous y sommes arriv√©s.  C'est le fond, pas besoin de creuser plus profond√©ment.  Sous Linux, il existe de telles fonctions - il suffit de les appeler avec les m√™mes arguments, et tout devrait fonctionner ... est-ce vrai? <br><br><h3>  √âtape 2 - lancer le prototype ...? </h3><br>  Pas vraiment.  Commen√ßons simplement et ex√©cutons lsusb.  Nous trouvons donc le clavier et lui envoyons quelque chose. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/461/304/5cd/4613045cd623936511a7edbb734b365a.png" alt="lsusb"><br><br>  Integrated Technology Express, Inc.  semble le plus int√©ressant ici.  Nous utiliserons le fameux outil / dev / hidraw.  Nous trouvons le bon ... Cela se fait par une simple recherche dans les fichiers / sys / class / hidraw / hidraw * / device / uevent. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0fd/aa4/39a/0fdaa439a9fb9b995fbf543e08858a57.png" alt="cacher"><br><br>  En voici un.  Les chiffres sont les m√™mes - cela signifie que cet appareil est hidraw0.  Mais nous essayons d'envoyer des donn√©es, et rien ne se passe!  Une sorte de non-sens.  √Ä ce stade, les mains commencent √† tomber ... Peut-√™tre, pas pour les simples mortels, est-ce cette ing√©nierie inverse? <br><br>  Mais continuons.  Nous allons essayer.  Si l'auteur comprenait tout cela, il inverserait la recherche de notre chauffeur du m√™me centre nerveux ... Mais nous n'avons pas de cerveau.  Revenons √† Windows, il y a une id√©e. <br><br>  Il y a une telle chose dans Windows - Gestionnaire de p√©riph√©riques.  Cela vous permet de faire beaucoup de choses - nous sommes int√©ress√©s par le fait qu'il vous permet de couper des appareils.  Simple et sans compromis. <br><br>  Coupons les appareils un par un jusqu'√† ce que l'√©tat des ampoules cesse de changer. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/96f/778/0f1/96f7780f1987136f81aa5cbf842ac7b9.jpg" alt="d√©sactiver l'appareil"><br><br>  Celui-ci a √©t√© coup√©.  Donc, si vous regardez l'ID du mat√©riel, nous verrons quel est son nom et avec quoi il mange. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7c5/a44/265/7c5a4426568f1c71e0c7426b3f9e20e4.jpg" alt="notre-appareil"><br><br>  Nous regardons - c'est lui. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7f8/99d/a6a/7f899da6af09b1d0eb9159f6ffd6a151.png" alt="dmesg"><br><br>  Un appareil que j'inonde depuis plusieurs ann√©es √† Dmesg. <br><br>  [Pourquoi n'est-il pas apparu dans lsusb?  Et pas du tout USB.  Il utilise le protocole I2C HID, qui vous permet de <s>cacher les appareils des mains curieuses des artisans pour</s> installer des gadgets HID sur le bus de l'ordinateur lui-m√™me.] <br><br><h3>  Digression lyrique - engageons-nous </h3><br>  √Ä la recherche du bon appareil, j'ai repris mon installation presque jusqu'au noyau.  De plus, je n'aimais pas vraiment ce que j'ai montr√© cette feuille de dmesg avant chaque verrou.  Puisque je suis ici, pourquoi ne pas √©crire un court commit?  Les mains me d√©mangent quand m√™me. <br><br>  Ce que nous devons voir, c'est o√π se trouvent les appareils sur I2C HID, et o√π √©crire les bizarreries qui leur sont inh√©rentes.  <a href="" rel="nofollow">Ici.</a>  Sans plus tarder, √©coutons l'erreur - longueur d'entr√©e incorrecte.  Rendons-le correct. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/eda/5da/50d/eda5da50dce50157f772a8a227702323.png" alt="mauvaise taille d'entr√©e"><br><br>  Ajoutez une nouvelle bizarrerie, appelons-la I2C_HID_QUIRK_BAD_INPUT_SIZE.  Par analogie avec celles existantes. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/932/33e/296/93233e296f0d07184be67ca04cfb7539.png" alt="bizarrerie"><br><br>  Ajoutez notre appareil √† la liste des quirkut.  Ce que nous avons fait jusqu'√† pr√©sent: <br><br>  1. Recherchez sur Internet ¬´i2c hid linux kernel¬ª.  Cliquez sur la quatri√®me r√©ponse √† DuckDuckGo. <br><br>  2. A √©crit trois (!) Mots en anglais - BAD_INPUT_SIZE <br><br>  3. Ajout d'un au BIT (4).  Il s'est av√©r√© BIT (5). <br><br>  4. Nous avons ajout√© un num√©ro dans hid-ids.h - l'ID de notre appareil (non indiqu√© dans l'illustration, mais il est √©galement approximatif). <br><br>  Programmons maintenant. <br><br>  Nous voyons la ligne - `ret_size = ihid-&gt; inbuf [0] |  ihid-&gt; inbuf [1] &lt;&lt; 8; ` <br><br>  Et puis il se plaint que ret_size n'est pas √©gal √† ce qu'il veut. <br><br>  Que si le queer est impliqu√©, faites la m√™me chose, bien au contraire. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dfe/693/f6c/dfe693f6c3d4bd88162f3902c6dd79af.png" alt="si-condition"><br><br>  Nous envoyons le patch √† la newsletter, sans oublier de tester ... (pour √™tre honn√™te, il a juste fallu plus pour l'ajouter √† la newsletter du cerveau. Ce n'est pas facile.) <br><br><img src="https://habrastorage.org/getpro/habr/post_images/33b/dc0/148/33bdc0148925600e067f37a385d5f09f.png" alt="appliqu√©"><br><br>  Et c'est tout. <br><br><h3>  √âtape 3 - le conducteur! </h3><br>  Ensuite, je me suis souvenu - oh oui, vous devez encore √©crire un pilote.  J'ai d√©cid√© de ne pas encore le confier au noyau (des questions ont commenc√© √† y √™tre pos√©es, j'ai vraiment d√ª r√©fl√©chir. Si l'un des citoyens de Habrovsk peut m'aider √† me conseiller, √©crivez-moi - je serai heureux!) <br><br>  Ouvrez le python.  (Au d√©but, bash l'√©tait, mais j'ai chang√© d'avis tr√®s rapidement.) Nous allons utiliser le fameux outil / dev / hidraw. <br><br>  / dev / hidraw0, / dev / hidraw1 - comment fonctionnent ces fichiers?  Pour les E / S simples, ils peuvent √™tre utilis√©s comme n'importe quel fichier normal et cela fonctionnera.  Mais GetFeature et SetFeature doivent bricoler avec ... <br><br>  StackOverflow (ou quelqu'un d'autre, je ne me souviens pas d√©j√†) a sugg√©r√© qu'il avait besoin d'un peu d'ioctl.  Il s'agit d'une m√©thode sp√©ciale pour travailler avec des fichiers inhabituels tels que des p√©riph√©riques HID, des terminaux, etc. <br><br>  Ioctl fonctionne comme √ßa.  Vous lui donnez un descripteur de fichier ouvert (qui s'int√©resse √† ce que c'est, <a href="https://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B0%25D0%25B9%25D0%25BB%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B4%25D0%25B5%25D1%2581%25D0%25BA%25D1%2580%25D0%25B8%25D0%25BF%25D1%2582%25D0%25BE%25D1%2580" rel="nofollow">il y a un lien vers Wikipedia</a> ), un certain nombre et un tampon - apr√®s quoi il fait quelque chose avec ce tampon et le renvoie.  Je n'exag√®re pas, il y a beaucoup de choses qui d√©pendent de l'impl√©mentation.  Permettez-moi de vous donner un exemple: 0xC0114806, ou d√©j√† familier pour nous SetFeature.  C'est <br><br> <code>(6 &lt;&lt; 29) | (ord('H') &lt;&lt; 8) | (0x06 &lt;&lt; 0) | (0x11 &lt;&lt; 16).</code> <br> <br>  Les 6 premiers ici signifient que le fichier sera ouvert pour l'√©criture et la lecture.  Pourquoi la lecture n'est pas tr√®s claire - mais il est √©crit pour le faire, probablement.  Ord ('H') ici - HID abr√©g√©.  Peut-√™tre que d'autres choses signifient, selon le fichier.  Dans ce cas, le HID. <br>  0x06 - l'√©quipe elle-m√™me.  La sixi√®me √©quipe avec HID est SetFeature.  La derni√®re partie est la longueur du tampon. <br><br>  Il ne reste plus qu'√† appeler ioctl avec ces valeurs - et la sortie est le pilote.  <a href="https://gitlab.com/kryma/lenovo-y720-backlight-driver" rel="nofollow">Il travaille</a> . <br><br><h3>  Postface </h3><br>  J'esp√®re que c'√©tait int√©ressant √† lire.  Peut-√™tre m√™me utile.  Certains ont √©t√© omis ou abr√©g√©s - le lecteur clairvoyant, peut-√™tre, d√©couvrira la lecture de l'√©tat dans le pilote, et un deuxi√®me SetFeature, qui n'√©tait pas du tout mentionn√© dans le texte.  Le d√©veloppement des pilotes et du noyau Linux sont de grandes choses, et ils ne peuvent pas √™tre compl√®tement ma√Ætris√©s en un seul v√©lo.  L'article n'est probablement pas √† ce sujet, mais sur le fait que faire quelque chose de petit et agr√©able, open-source ou pour vous-m√™me, n'est pas du tout difficile.  Il suffit de trouver une semaine de soir√©es avec du th√© et une envie de se plonger dans le code. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr484564/">https://habr.com/ru/post/fr484564/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr484548/index.html">Comment Citrix NetScaler CVE-2019-19781 a expos√© des probl√®mes critiques de l'industrie informatique cach√©e</a></li>
<li><a href="../fr484550/index.html">L'holacratie est-elle n√©cessaire dans une entreprise informatique: avantages et inconv√©nients</a></li>
<li><a href="../fr484552/index.html">Lecture pour un geek: 10 documents sur la technologie audio - comment les pistes musicales, les enregistrements HD et le son 8D sont organis√©s</a></li>
<li><a href="../fr484554/index.html">Cr√©er un bouton avec Ripple Effect pour XMars UI</a></li>
<li><a href="../fr484556/index.html">Alors, quand est-il encore possible d'utiliser! Important?</a></li>
<li><a href="../fr484568/index.html">Hack The Box - Walkthrough Player. FFmpeg exploit, JWT et diverses listes Web</a></li>
<li><a href="../fr484572/index.html">Mon approche de gestion du temps / des t√¢ches avec VSCode</a></li>
<li><a href="../fr484574/index.html">Pas de tiques! Plantes vs vecteur de la maladie de Lyme</a></li>
<li><a href="../fr484578/index.html">Objectifs de niveau de service - Exp√©rience Google (traduction de la section Google SRE Book)</a></li>
<li><a href="../fr484580/index.html">Ce que vous devez savoir sur les simulateurs de m√©moire</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>