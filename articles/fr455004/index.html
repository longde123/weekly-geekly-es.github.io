<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí£ üë©üèø‚Äçüç≥ üêπ Unity: une ville sans fin g√©n√©r√©e par proc√©dure obtenue √† l'aide de l'algorithme WFC (effondrement de la fonction d'onde) üà∑Ô∏è üéø üé¢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! 

 En tant que l√©gislateurs sur Unity sur le march√© russe, nous vous proposons de lire une √©tude int√©ressante sur l'utilisation pratiqu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Unity: une ville sans fin g√©n√©r√©e par proc√©dure obtenue √† l'aide de l'algorithme WFC (effondrement de la fonction d'onde)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/455004/">  Bonjour, Habr! <br><br>  En tant que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">l√©gislateurs</a> sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Unity</a> sur le march√© russe, nous vous proposons de lire une √©tude int√©ressante sur l'utilisation pratique de l'algorithme WFC (Wave Function Collapse), construit √† l'image et √† la ressemblance du principe bien connu de la m√©canique quantique et tr√®s pratique pour la g√©n√©ration proc√©durale de niveaux dans les jeux.  Plus t√¥t dans Habr√©, l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">histoire d√©taill√©e</a> de cet algorithme a d√©j√† √©t√© publi√©e.  L'auteur de l'article d'aujourd'hui, Marian Kleineberg, consid√®re l'algorithme dans le contexte des graphiques en trois dimensions et de la g√©n√©ration d'une ville sans fin.  Bonne lecture! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/4b/e7/af/4be7afzttmmd9g8y2snj_pnxpns.jpeg"></div><a name="habracut"></a><br>  Nous allons parler d'un jeu o√π vous vous promenez dans une ville sans fin qui est g√©n√©r√©e de mani√®re proc√©durale lorsque vous vous d√©placez.  Une ville est construite √† partir d'un ensemble de blocs en utilisant l'algorithme WFC (effondrement de la fonction d'onde). <br><br>  L'assemblage jouable est disponible en t√©l√©chargement sur le site Web <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">itch.io.</a>  Vous pouvez √©galement prendre le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">code source sur github</a> .  Enfin, je propose une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vid√©o</a> dans laquelle je parcours la ville ainsi g√©n√©r√©e. <br><br><h3>  Algorithme </h3><br>  J'appellerai le mot ¬´cellule¬ª un √©l√©ment maill√© de voxel 3D qui peut contenir un bloc ou √™tre vide.  Le mot "module" j'appellerai un bloc qui peut occuper une telle cellule. <br><br>  L'algorithme d√©cide des modules √† s√©lectionner dans chaque cellule du monde du jeu.  Un tableau de cellules est consid√©r√© comme une fonction d'onde sous une forme non observable.  Ainsi, chaque cellule correspond √† de nombreux modules qui peuvent y appara√Ætre.  En termes de m√©canique quantique, on pourrait dire, "la cellule est en superposition de tous les modules".  L'existence du monde commence sous une forme compl√®tement inobservable, o√π n'importe quel module peut √™tre dans chaque cellule.  De plus, toutes les cellules s'effondrent l'une apr√®s l'autre.  Cela signifie que pour chaque cellule, un module est s√©lectionn√© au hasard parmi tous les possibles. <br><br>  L'√©tape suivante est la propagation des contraintes.  Pour chaque module, un sous-ensemble de modules est s√©lectionn√© et peut √™tre adjacent √† celui-ci.  Chaque fois qu'un module s'effondre, des sous-ensembles d'autres modules sont mis √† jour, qui sont toujours autoris√©s comme adjacents √† celui-ci.  L'√©tape de propagation des restrictions est la partie de l'algorithme la plus consommatrice de ressources en termes de puissance de calcul. <br><br>  Un aspect important de l'algorithme consiste √† d√©terminer la cellule √† effondrer.  L'algorithme r√©duit toujours la cellule avec la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plus petite entropie</a> .  Il s'agit d'une cellule qui permet un nombre minimal de choix (c'est-√†-dire une cellule avec le moins d'al√©atoire).  Si la probabilit√© d'effondrement est la m√™me pour tous les modules, alors la cellule avec le nombre minimum de modules possibles aura l'entropie la plus faible.  En r√®gle g√©n√©rale, les probabilit√©s d'√™tre s√©lectionn√©es sont diff√©rentes pour les diff√©rents modules disponibles.  Une cellule avec deux modules possibles ayant la m√™me probabilit√© offre un choix plus large (entropie sup√©rieure) que celui dans lequel il y a deux modules, et pour l'un d'eux la probabilit√© de tomber sous le choix est tr√®s √©lev√©e, et pour l'autre elle est tr√®s petite. <br><br><img src="https://habrastorage.org/webt/dp/kw/z-/dpkwz-w1fr5-xxrw_flqyt_mtou.gif"><br><br>  (Gif publi√© par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ExUtumno</a> sur Github) <br><br>  Des informations plus d√©taill√©es sur l'algorithme d'effondrement de la fonction d'onde, ainsi qu'un certain nombre de beaux exemples, peuvent √™tre trouv√©s ici.  Initialement, cet algorithme a √©t√© propos√© pour g√©n√©rer des textures 2D bas√©es sur un seul √©chantillon.  Dans ce cas, les indicateurs probabilistes des modules et les r√®gles d'adjacence sont d√©termin√©s en fonction de leur occurrence dans l'exemple.  Cet article fournit ces informations manuellement. <br><br>  Voici une <a href="">vid√©o</a> d√©montrant cet algorithme en action. <br><br><h3>  √Ä propos des blocs, prototypes et modules </h3><br>  Le monde est g√©n√©r√© √† partir d'un ensemble dans lequel environ 100 blocs.  Je les ai cr√©√©s en utilisant Blender.  Au d√©but, j'avais tr√®s peu de blocs, et je les ai ajout√©s petit √† petit quand je l'ai jug√© n√©cessaire. <br><br><img src="https://habrastorage.org/webt/yj/26/sn/yj26snwykmonhpvoy9mvv_bnsq8.png"><br><br>  L'algorithme doit savoir quels modules peuvent √™tre plac√©s c√¥te √† c√¥te.  Pour chaque module, il y a 6 listes de voisins possibles, une dans chacune des directions.  Cependant, je voulais √©viter d'avoir √† cr√©er une telle liste manuellement.  De plus, je voulais g√©n√©rer automatiquement des options tourn√©es pour chacun de mes blocs. <br><br>  Ces deux t√¢ches sont r√©solues √† l'aide des modules dits prototypes.  Il s'agit essentiellement de <code>MonoBehaviour</code> , qui est pratique pour travailler avec l'√©diteur Unity.  Des modules ainsi que des listes d'√©l√©ments voisins valides et des options pivot√©es sont automatiquement cr√©√©s sur la base de ces prototypes. <br><br>  Un probl√®me complexe s'est pos√© avec la mod√©lisation des informations d'adjacence, de sorte que ce processus automatique a fonctionn√©.  Voici ce que j'ai obtenu: <br><br><img src="https://habrastorage.org/webt/ym/cj/ke/ymcjkeehpahvovwxbpl7kma28bs.png"><br><br>  Chaque bloc a 6 contacts, un pour chaque face.  Le contact a un num√©ro.  De plus, les contacts horizontaux peuvent √™tre invers√©s, non invers√©s ou sym√©triques.  Les contacts verticaux ont soit un indice de rotation compris entre 0 et 3, soit sont marqu√©s comme <i>invariants en rotation</i> . <br><br>  Sur cette base, je peux v√©rifier automatiquement quels modules sont autoris√©s √† s'embo√Æter.  Les modules adjacents doivent avoir les m√™mes num√©ros de broche.  Leur sym√©trie doit √©galement co√Øncider (le m√™me indice de rotation vertical, une paire de contacts horizontaux invers√©s et non invers√©s), ou les modules doivent √™tre sym√©triques / invariants. <br><br><img src="https://habrastorage.org/webt/zk/-3/lo/zk-3looqprzz5upxpuavvmkccbu.png"><br><br>  Il existe des r√®gles d'exclusion par lesquelles je peux interdire les options de quartier qui seraient autoris√©es par d√©faut.  Certains blocs avec des contacts correspondants semblent tout simplement laids √† proximit√©.  Voici un exemple de carte g√©n√©r√©e sans appliquer de r√®gles d'exception: <br><br><img src="https://habrastorage.org/webt/md/od/0f/mdod0f_xkotiz9sc7tigjres6ia.jpeg"><br><br><h3>  Chemin vers l'infini </h3><br>  L'algorithme d'effondrement de la fonction d'onde d'origine g√©n√®re des cartes de taille finie.  Je voulais construire un monde qui se d√©veloppera et se d√©veloppera au fur et √† mesure que vous avancerez. <br><br>  Au d√©but, j'ai essay√© de g√©n√©rer des fragments de taille finie et d'utiliser les contacts des fragments adjacents comme restrictions.  Si un fragment est g√©n√©r√© et qu'un fragment adjacent √† celui-ci est √©galement g√©n√©r√©, seuls les modules de ce type sont autoris√©s √† c√¥t√© des modules existants.  Avec cette approche, le probl√®me suivant se pose: chaque fois qu'une cellule s'effondre, la propagation des restrictions r√©duira les opportunit√©s m√™me √† une distance de plusieurs cellules.  L'image suivante montre les effets de l'effondrement d'une seule cellule: <br><br><img src="https://habrastorage.org/webt/ex/yj/rv/exyjrvgb7tciaf1skkzgndnvpd0.png"><br><br>  Si √† chaque √©tape de l'algorithme un seul fragment est g√©n√©r√©, les restrictions ne s'appliquent pas aux fragments adjacents.  Dans ce cas, de tels modules ont √©t√© s√©lectionn√©s √† l'int√©rieur du fragment, ce qui serait inacceptable si d'autres fragments √©taient pris en compte.  Par cons√©quent, lorsque l'algorithme a tent√© de g√©n√©rer le fragment suivant, il n'a pas pu trouver une seule solution. <br><br>  Maintenant, je n'utilise plus de fragments, mais stocke la carte dans un dictionnaire qui affiche la position d'une cellule sur une cellule.  La cellule n'est remplie que si n√©cessaire.  Certains √©l√©ments de l'algorithme doivent √™tre ajust√©s dans cet esprit.  Lors du choix d'une cellule qui doit s'effondrer, il est impossible de prendre en compte toutes les cellules si leur nombre est infini.  Au lieu de cela, nous ne g√©n√©rons qu'une petite partie de la carte √† la fois, une fois que le joueur l'a atteinte.  En dehors de cette zone, les restrictions continuent de se propager. <br><br>  Dans certains cas, cette approche ne fonctionne pas.  Consid√©rez un ensemble de modules pour une section droite d'un tunnel de la figure ci-dessus - il n'y a pas d'entr√©e dans le tunnel.  Si l'algorithme choisit un tel module de tunnel, alors le tunnel sera infini par d√©finition.  Au stade de la distribution des restrictions, le programme tentera d'allouer un nombre infini de cellules.  J'ai d√©velopp√© un ensemble sp√©cial de modules pour contourner ce probl√®me. <br><br><h3>  Conditions aux limites </h3><br>  Il existe deux conditions aux limites importantes.  Tous les visages au niveau sup√©rieur de la carte doivent avoir des contacts ¬´a√©riens¬ª.  Tous les visages sur la base de la carte doivent avoir des contacts ¬´solides¬ª.  Si ces conditions ne sont pas remplies, sur la carte, il y aura des trous dans le sol et certains b√¢timents seront sans toit. <br><br>  Sur une carte de taille finie, ce probl√®me serait facilement r√©solu.  Pour toutes les cellules au niveau le plus √©lev√© et le plus bas, il serait n√©cessaire de retirer tous les modules avec des contacts inappropri√©s.  Commencez ensuite la distribution des restrictions et supprimez les modules restants qui ne nous conviennent plus. <br><br>  Sur une carte de taille infinie, cela ne fonctionnera pas, car au plus haut et au plus bas niveau, nous avons un nombre infini de cellules.  La solution la plus na√Øve consiste √† supprimer toutes les cellules inappropri√©es d√®s qu'elles apparaissent.  Cependant, lorsqu'un module est supprim√© au niveau sup√©rieur, des restrictions s'appliquent aux cellules qui lui sont adjacentes.  Il y a un effet d'avalanche, conduisant √† nouveau √† une s√©lection infinie de cellules. <br><br>  J'ai r√©solu ce probl√®me en cr√©ant une carte 1 √ó n √ó 1, o√π n est la hauteur.  Cette carte utilise l'habillage du monde pour r√©partir les restrictions.  Le m√©canisme fonctionne comme dans le jeu Pacman: en d√©passant le bord droit de la carte, le personnage y revient √† cause du bord gauche.  Maintenant, je peux appliquer toutes les restrictions √† ma carte.  Chaque fois que vous cr√©ez une nouvelle cellule sur une carte infinie, cette cellule est initialis√©e avec un ensemble de modules correspondant √† une position sp√©cifique sur la carte. <br><br><h3>  Conditions d'erreur et recherche de retour </h3><br>  Parfois, l'algorithme WFC atteint un √©tat dans lequel la cellule ne correspond √† aucun module possible.  Dans les applications o√π nous avons affaire √† un monde de taille finie, vous pouvez simplement r√©initialiser le r√©sultat et recommencer √† z√©ro.  Dans un monde infini, cela ne fonctionnera pas, car une partie du monde est d√©j√† montr√©e au joueur.  Tout d'abord, j'ai opt√© pour une solution dans laquelle les endroits o√π les erreurs se sont produites √©taient remplis de blocs blancs. <br><br>  J'utilise actuellement la recherche de retour.  L'ordre de l'effondrement des cellules et certaines informations sur la r√©partition des restrictions sont stock√©es sous forme d'historique.  Si l'algorithme WFC √©choue, une partie de l'historique est annul√©e.  En r√®gle g√©n√©rale, cela fonctionne, mais parfois des erreurs peuvent √™tre d√©tect√©es trop tard, et une recherche de retour couvre de nombreuses √©tapes.  Dans de rares cas, la cellule dans laquelle se trouve le joueur est r√©g√©n√©r√©e. <br><br>  √Ä mon avis, en raison de cette limitation, l'application de l'algorithme WFC avec des mondes infinis ne convient pas aux jeux commerciaux. <br><br><h3>  Contexte </h3><br>  J'ai commenc√© √† travailler sur cette t√¢che apr√®s avoir regard√© une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">conf√©rence d'Oscar Stelberg</a> racontant comment il utilise l'algorithme pour g√©n√©rer des niveaux dans le jeu Bad North.  En g√©n√©ral, mon algorithme a √©t√© impl√©ment√© pendant la semaine de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">procjam</a> . <br><br>  J'ai quelques id√©es pour affiner encore cet algorithme, mais je ne suis pas s√ªr qu'un jour je vais y ajouter du gameplay.  Et si je me r√©unis - ce ne sera certainement pas une strat√©gie aussi √©pique que vous l'avez d√©j√† imagin√©e.  Cependant, si vous voulez v√©rifier comment vos m√©canismes de jeu pr√©f√©r√©s fonctionnent avec cet algorithme - essayez-le vous-m√™me!  En fin de compte, le code source est accessible au public et autoris√© par le MIT. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr455004/">https://habr.com/ru/post/fr455004/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr454994/index.html">Quels sont les avantages de la recharge sans fil et pourquoi l‚Äôavenir se cache-t-il? Exp√©rience personnelle pour 2019</a></li>
<li><a href="../fr454996/index.html">Centre de formation des cosmonautes du nom de Yu.A. Gagarine et Roscosmos ont commenc√© un recrutement ouvert dans l'√©quipe de cosmonautes</a></li>
<li><a href="../fr454998/index.html">Julia et l'informatique parall√®le</a></li>
<li><a href="../fr455000/index.html">D√©m√©nagement prudent aux Pays-Bas avec sa femme. Partie 3: travail, coll√®gues et autre vie</a></li>
<li><a href="../fr455002/index.html">Bienvenue √† la Top 3D Expo en septembre</a></li>
<li><a href="../fr455006/index.html">T√©l√©commande √† trois commandes avec un programme de 290 mots de 16 bits</a></li>
<li><a href="../fr455008/index.html">Web s√©mantique et donn√©es li√©es. Corrections et ajouts</a></li>
<li><a href="../fr455010/index.html">Scripts utilisateur asynchrones dans Pure Rust sans frameworks et SMS</a></li>
<li><a href="../fr455012/index.html">FAQ sur l'interception cellulaire: Que sont les intercepteurs / SCAT IMSI et puis-je les prot√©ger contre eux?</a></li>
<li><a href="../fr455016/index.html">Nous cr√©ons le site le plus inaccessible avec une cote id√©ale Phare</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>