<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè™ üëÇüèª ‚öôÔ∏è Millions d'appels vid√©o par jour ou ¬´Appelle maman!¬ª üåÄ ‚èèÔ∏è üòÜ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Du point de vue de l'utilisateur, les services d'appel semblent assez simples: vous allez √† la page d'un autre utilisateur, vous appelez, il d√©croche,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Millions d'appels vid√©o par jour ou ¬´Appelle maman!¬ª</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/odnoklassniki/blog/428217/">  Du point de vue de l'utilisateur, les services d'appel semblent assez simples: vous allez √† la page d'un autre utilisateur, vous appelez, il d√©croche, vous lui parlez.  Dehors, il semble que tout soit simple, mais peu savent faire un tel service.  Mais Alexander Tobol ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">alatobol</a> ) sait non seulement, mais partage aussi volontiers son exp√©rience. <br><br><img src="https://habrastorage.org/webt/rq/un/cx/rquncxhtqvyydpdbneoatkwfvke.jpeg"><br><br>  Poursuivez la version texte du rapport sur la Sib√©rie HighLoad ++, √† partir de laquelle vous apprendrez: <br><br><ul><li>  comment les services d'appels vid√©o fonctionnent sous le capot; </li><li>  combien il est beau de percer le NAT - cela sera int√©ressant pour les sp√©cialistes du jeu qui ont besoin d'une connexion peer-to-peer; </li><li>  comment WebRTC fonctionne, quels protocoles il inclut; </li><li>  comment puis-je r√©gler WebRTC via BigData. </li></ul><br><iframe width="560" height="315" src="https://www.youtube.com/embed/MnEXuKHjIOU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <strong>√Ä propos de l'orateur:</strong> Alexander Tobol dirige le d√©veloppement des plates-formes vid√©o et bande sur ok.ru. <br><a name="habracut"></a><br><h2>  Historique des appels vid√©o <br></h2><br>  Le premier appareil d'appel vid√©o est apparu en 1960, il s'appelait un picherphone, utilisait des r√©seaux d√©di√©s et √©tait extr√™mement cher.  En 2006, Skype a ajout√© des appels vid√©o √† son application.  En 2010, Flash a pris en charge le protocole RTMFP et nous, √† Odnoklassniki, avons lanc√© des appels vid√©o Flash.  En 2016, Chrome a cess√© de prendre en charge Flash, et en ao√ªt 2017, nous avons red√©marr√© les appels avec la nouvelle technologie, dont je parlerai aujourd'hui.  Apr√®s avoir finalis√© le service, nous avons re√ßu pendant six mois une augmentation significative du nombre d'appels termin√©s avec succ√®s.  R√©cemment, nous avons √©galement des masques dans les appels. <br><img src="https://habrastorage.org/webt/kn/9u/uy/kn9uuyg18yggcfabvmzgs-cfygg.jpeg"><br><br><h2>  Architecture et savoirs traditionnels <br></h2><br>  Puisque nous travaillons dans un r√©seau social, nous n'avons pas de t√¢ches techniques et nous ne savons pas ce que sont les savoirs traditionnels.  Habituellement, l'id√©e enti√®re tient sur une seule page et ressemble √† ceci. <br><img src="https://habrastorage.org/webt/qf/9x/ju/qf9xjum4vvjczd3-momvzhht9cw.jpeg"><br><br>  L'utilisateur souhaite appeler d'autres utilisateurs √† l'aide d'une application Web ou iOS / Android.  Un autre utilisateur peut avoir plusieurs appareils.  L'appel arrive sur tous les appareils, l'utilisateur d√©croche le t√©l√©phone sur l'un d'eux, il parle.  Tout est simple. <br><br><h2>  Sp√©cifications techniques <br></h2><br>  Afin de faire un service d'appel de qualit√©, nous devons comprendre quelles caract√©ristiques nous voulons suivre.  Nous avons d√©cid√© de commencer par chercher ce qui aga√ßait le plus l'utilisateur. <br><br>  L'utilisateur est vraiment ennuy√© s'il d√©croche le t√©l√©phone et est oblig√© d'attendre que la connexion soit √©tablie. <br><img src="https://habrastorage.org/webt/8g/kk/qb/8gkkqbq6ioqxnn0ro6dcq9kwhno.jpeg"><br><br>  L'utilisateur est ennuy√© si la qualit√© de l'appel est mauvaise - quelque chose est interrompu, la vid√©o est dispers√©e, le son bouillonne. <br><img src="https://habrastorage.org/webt/2l/rt/ud/2lrtudpp-tw5cjsknhzamgj--pi.jpeg"><br><br>  Mais surtout l'utilisateur est agac√© par le retard des appels.  La latence est l'une des caract√©ristiques importantes des appels.  Avec une latence dans une conversation de l'ordre de 5 secondes, il est absolument impossible de mener un dialogue. <br><img src="https://habrastorage.org/webt/z-/tn/lf/z-tnlfghw6laz3j25e3kbwob9mi.jpeg"><br><br>  Nous avons d√©termin√© pour nous-m√™mes des caract√©ristiques acceptables: <br><br><ul><li>  <strong>D√©marrer</strong> - nous avons d√©cid√© qu'il √©tait bon de commencer l'appel dans une seconde.  C'est-√†-dire  la connexion apr√®s que l'utilisateur a r√©pondu, ne devrait pas prendre plus d'une seconde. </li><li>  <strong>La qualit√©</strong> est un indicateur tr√®s subjectif.  Vous pouvez mesurer, par exemple, le rapport signal / bruit (SNR), mais il manque encore des trames et autres artefacts.  Nous avons mesur√© la qualit√© de mani√®re plut√¥t subjective et √©valu√© le bonheur des utilisateurs. </li><li>  <strong>La latence</strong> doit √™tre inf√©rieure √† 0,5 seconde.  Si la latence est sup√©rieure √† 0,5 seconde, vous entendez d√©j√† des retards et commencez √† vous interrompre. </li></ul><br><img src="https://habrastorage.org/webt/cl/yx/j0/clyxj0ajsqq5coamt5orttz-kxc.jpeg"><br><br>  Polycom est un syst√®me de conf√©rence install√© dans nos bureaux.  Nous avons des latences moyennes de polycom de l'ordre de 1,3 seconde.  Avec un tel retard, vous ne vous comprenez pas toujours.  Si le d√©lai augmente √† 2 secondes, le dialogue ne sera pas possible. <br><img src="https://habrastorage.org/webt/3_/yy/qq/3_yyqqbvvq5zoavfa5q9tzvqhiq.jpeg"><br><br>  Comme nous avions d√©j√† lanc√© la plateforme, nous nous attendions √† peu pr√®s √† un million d'appels par jour.  C'est mille appels en parall√®le.  Si tous les appels sont lanc√©s via le serveur, il y aura mille appels m√©gabits par appel.  C'est seulement 1 gigabit / sec un seul serveur de fer sera suffisant. <br><br><h2>  Internet vs TTX <br></h2><br>  Qu'est-ce qui peut vous emp√™cher d'obtenir de telles fonctionnalit√©s int√©ressantes?  Internet! <br><img src="https://habrastorage.org/webt/qb/aq/sy/qbaqsyfaf6vln4e882armfugx1g.jpeg"><br><br>  Sur Internet, il y a des choses comme le temps d'aller-retour (RTT), qui ne peuvent pas √™tre surmont√©es, il y a une bande passante variable, il y a le NAT. <br><br>  Auparavant, nous mesurions la vitesse de transmission dans les r√©seaux de nos utilisateurs. <br><img src="https://habrastorage.org/webt/bm/ge/z6/bmgez6efih7z_lqwidcknso8edw.jpeg"><br><br>  Nous l'avons ventil√© par type de connexion, avons examin√© le RTT moyen, la perte de paquets, la vitesse et avons d√©cid√© de tester les appels sur les valeurs moyennes de chacun de ces r√©seaux. <br><img src="https://habrastorage.org/webt/ui/o4/k8/uio4k8pmxmyxyclfwwawehqijes.jpeg"><br><br>  Il existe d'autres probl√®mes sur Internet: <br><br><ul><li>  <strong>Perte de paquets</strong> - nous avons mesur√© 0,6% de perte de paquets al√©atoire (nous ne prenons pas en compte la perte de paquets de congestion avec un nombre excessif de paquets). </li><li>  <strong>R√©organisation</strong> - vous envoyez des paquets dans le m√™me ordre et le r√©seau les trie √† nouveau. </li><li>  <strong>Jitter</strong> - envoie un flux vid√©o ou audio √† un certain intervalle, et les paquets se regroupent du c√¥t√© client en paquets, par exemple, en raison de la mise en m√©moire tampon sur les p√©riph√©riques r√©seau. </li><li>  <strong>NAT</strong> - il s'est av√©r√© que plus de 97% des utilisateurs sont derri√®re NAT.  Nous parlerons pourquoi, quoi et comment. </li></ul><br><img src="https://habrastorage.org/webt/z_/uo/mc/z_uomck64smc12_beaupdnutgp4.jpeg"><br><br>  Consid√©rez les param√®tres r√©seau r√©pertori√©s ci-dessus avec un exemple simple. <br><br>  J'ai pagin√© le site Web de l'Universit√© d'√âtat de Novossibirsk depuis mon bureau et j'ai re√ßu un ping si √©trange. <br><img src="https://habrastorage.org/webt/wi/am/at/wiamatloo1eviw58g3zgzbrsc2e.jpeg"><br><br>  La gigue moyenne dans cet exemple est de 30 ms, c'est-√†-dire que l'intervalle moyen entre les temps de ping adjacents est d'environ 30 ms et le ping moyen est de 105 ms. <br><br>  Qu'est-ce qui est important dans les appels, pourquoi allons-nous nous battre pour le P2P? <br><img src="https://habrastorage.org/webt/gb/ny/yx/gbnyyxij20hrfo96scwubxdzovu.jpeg"><br><br>  √âvidemment, si nous parvenons √† √©tablir une connexion p2p entre nos utilisateurs qui essaient de se parler √† Saint-P√©tersbourg, plut√¥t que via un serveur situ√© √† Novossibirsk, nous √©conomiserons environ 100 ms aller-retour et du trafic vers ce service. <br><br>  Par cons√©quent, la majeure partie de l'article est consacr√©e √† la fabrication de bons p2p. <br><br><h2>  Histoire ou h√©ritage <br></h2><br>  Comme je l'ai dit, nous avons un service d'appel depuis 2010 et nous l'avons red√©marr√©. <br><img src="https://habrastorage.org/webt/si/ru/lu/sirulur_jaalnldpkmvbjx7ct-q.jpeg"><br><br>  En 2006, lorsque Skype a commenc√©, Flash a achet√© Amicima, qui a fabriqu√© RTMFP.  Flash avait d√©j√† RTMP, qui peut en principe √™tre utilis√© pour les appels, et il est souvent utilis√© pour le streaming.  Flash a ensuite ouvert la sp√©cification RTMP.  Je me demande pourquoi ils avaient besoin de RTMFP?  En 2010, nous avons utilis√© RTMFP. <br><br>  Comparez les exigences des protocoles d'appel et des protocoles de streaming r√©els et voyez o√π se trouve cette fronti√®re. <br><img src="https://habrastorage.org/webt/ih/j9/xi/ihj9xiris6praclbyxpxelwc1i4.jpeg"><br><br>  <strong>RTMP</strong> est plus un protocole de streaming vid√©o.  Il utilise TCP, il a un retard cumul√©.  Si vous disposez d'une bonne connexion Internet, les appels vers RTMP fonctionneront. <br><br>  <strong>Le protocole RTMFP</strong> , malgr√© la diff√©rence en une seule lettre, est le protocole UDP.  Il est exempt de probl√®mes de mise en m√©moire tampon - ceux qui sont sur TCP;  Il est priv√© de blocage en t√™te de ligne - c'est lorsque vous avez perdu un paquet, et TCP ne renvoie pas les paquets suivants jusqu'√† ce qu'il soit temps d'envoyer √† nouveau le perdu.  RTMFP √©tait capable de g√©rer NAT et connaissait un changement dans l'adresse IP des clients.  Par cons√©quent, nous avons lanc√© le Web sur RTMFP en 2010. <br><img src="https://habrastorage.org/webt/pv/rx/16/pvrx163tvieetirsg8nkfrov7qm.jpeg"><br><br>  Ce n'est qu'en 2011 que le projet initial de WebRTC est apparu, qui n'√©tait pas encore pleinement op√©rationnel.  En 2012, nous avons commenc√© √† prendre en charge les appels sur iOS / Android, puis quelque chose d'autre s'est produit, et en 2016, Chrome a cess√© de prendre en charge Flash.  Nous devions faire quelque chose. <br><img src="https://habrastorage.org/webt/uu/ub/cs/uuubcssxa_w9-ost03_y6dqq6ic.jpeg"><br><br>  Nous avons regard√© tous les protocoles VoIP: comme toujours, pour faire quelque chose, nous commen√ßons par regarder les concurrents. <br><br><h2>  Concurrents ou par o√π commencer <br></h2><br>  Nous avons choisi les concurrents les plus populaires: Skype, WhatsApp, Google Duo (similaire √† Hangouts) et ICQ. <br><br>  Pour commencer, nous avons mesur√© le retard. <br><img src="https://habrastorage.org/webt/yv/br/d2/yvbrd2tluf9yzf-xqqibngdooh8.jpeg"><br><br>  C'est facile √† faire.  Ci-dessus, une photographie dans laquelle: <br><br><ul><li>  Chronom√®tre (voir t√©l√©phone en haut √† gauche), qui indique l'heure (03:08). </li><li>  Le t√©l√©phone √† proximit√© passe un appel et prend le premier t√©l√©phone sous forme de vid√©o.  √Ä partir du moment o√π l'image est entr√©e dans l'appareil photo du t√©l√©phone et que vous l'avez vue, cela a pris environ 100 ms. </li><li>  Un appel vers un autre t√©l√©phone (blanc) et une fois de plus.  Ici, le retard est d'environ 310 ms avec Google Duo. </li></ul><br>  Je ne r√©v√©lerai pas encore toutes les cartes, mais nous nous sommes assur√©s que ces appareils ne pouvaient pas √©tablir de connexions p2p.  Bien s√ªr, les mesures ont √©t√© effectu√©es dans diff√©rents r√©seaux, et ce n'est qu'un exemple. <br><img src="https://habrastorage.org/webt/rn/xz/ee/rnxzee4grukafmg0gu3cunpemsi.jpeg"><br><br>  Skype interrompt encore un peu.  Il s'est av√©r√© qu'avec Skype, au cas o√π il ne parviendrait pas √† connecter p2p, le d√©lai est de 1,1 s. <br><br>  Notre environnement de test √©tait compliqu√©.  Nous avons test√© dans diff√©rentes conditions (EDGE, 3G, LTE, WiFi), pris en compte que les canaux sont asym√©triques, et je donne les valeurs moyennes de toutes les mesures. <br><img src="https://habrastorage.org/webt/gb/pp/6s/gbpp6sc5jugssoov8nmzvajlifo.jpeg"><br><br>  Afin d'estimer la consommation de la batterie, la charge du processeur et tout le reste, nous avons d√©cid√© que vous pouvez simplement mesurer la temp√©rature du t√©l√©phone avec un pyrom√®tre et supposer qu'il s'agit d'une charge moyenne sur le GPU du t√©l√©phone par processeur, batterie.  En principe, il est tr√®s d√©sagr√©able de porter un t√©l√©phone chaud √† votre oreille, et m√™me de le tenir entre vos mains.  Il semble √† l'utilisateur que l'application va maintenant utiliser toute sa batterie. <br><img src="https://habrastorage.org/webt/dl/ck/vd/dlckvdbr8we75haadv9qkgk1jxk.jpeg"><br><br>  Le r√©sultat est: <br><br><ul><li>  Les plus lents <strong>dans le retard</strong> √©taient ICQ et Skype, et les plus rapides - Telegram.  Ce n'est pas une comparaison compl√®tement correcte, car Telegram n'a pas d'appels vid√©o, mais leur latence audio est minimale.  WhatsApp (environ 200 ms) et Hangouts - 390 ms fonctionnent tr√®s bien. </li><li>  <strong>Par temp√©rature,</strong> Telegram mange le moins sans vid√©o et Skype le plus. </li><li>  En termes de temps de <strong>r√©ponse</strong> , Telegram √©tablit la connexion <strong>pour la</strong> dur√©e <strong>la</strong> plus longue et la plus rapide WhatsApp et Google Duo. </li></ul><br>  G√©nial, nous avons obtenu quelques m√©triques! <br><img src="https://habrastorage.org/webt/t8/mb/n0/t8mbn0vv_g1utslspeeevk8g5ie.jpeg"><br><br>  Nous avons test√© la qualit√© de la vid√©o et de la voix sur diff√©rents r√©seaux, avec diff√©rentes gouttes et tout le reste.  En cons√©quence, nous sommes arriv√©s √† la conclusion que la <strong>vid√©o de</strong> la <strong>plus haute qualit√© se trouve sur Google Duo et que la voix est sur Skype</strong> , mais cela se trouve dans les ¬´mauvais¬ª r√©seaux lorsqu'il y a d√©j√† une distorsion.  En g√©n√©ral, tout le monde travaille approximativement m√©diocre.  WhatsApp a l'image la plus floue. <br><br>  Voyons voir sur quoi tout cela est impl√©ment√©. <br><img src="https://habrastorage.org/webt/ih/ap/1i/ihap1infndlvdjllso8eszhjnla.jpeg"><br><br>  Skype a son propre protocole propri√©taire, et tout le monde utilise soit une modification de WebRTC, soit g√©n√©ralement directement WebRTC.  Hangouts, Google Duo, WhatsApp, Facebook Messenger peuvent fonctionner avec le Web, et ils ont tous WebRTC sous le capot.  Ils sont tous tellement diff√©rents, avec des caract√©ristiques diff√©rentes, et ils ont tous un WebRTC!  Il faut donc pouvoir le cuisiner correctement.  De plus, il y a Telegram, dont certaines parties de WebRTC sont responsables de la partie audio, il y a ICQ, qui a longtemps forg√© WebRTC et a continu√© √† d√©velopper sa propre voie. <br><br><h2>  WebRTC  L'architecture <br></h2><br><img src="https://habrastorage.org/webt/3q/0x/-c/3q0x-cy-45bblq5lgoayq2awd5u.jpeg"><br><br>  WebRTC implique la pr√©sence d'un serveur de signalisation, un interm√©diaire entre les clients, qui est utilis√© pour √©changer des messages lors de l'√©tablissement d'une connexion p2p entre eux.  Apr√®s avoir √©tabli une connexion directe, les clients commencent √† √©changer des donn√©es multim√©dias entre eux. <br><br><h2>  WebRTC  D√©mo <br></h2><br>  Commen√ßons par une d√©mo simple.  Il existe 5 √©tapes simples pour √©tablir une connexion WebRTC. <br><br><div class="spoiler">  <b class="spoiler_title">Exemple de code d√©taill√©</b> <div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-number"><span class="hljs-number">1.</span></span> <span class="hljs-comment"><span class="hljs-comment">// Step #1: Getting local video stream and initializing a peer connection with it (both caller and callee) 2. 3. var localStream = null; 4. var localVideo = document.getElementById('localVideo'); 5. 6. navigator 7. .mediaDevices 8. .getUserMedia({ audio: true, video: true }) 9. .then(stream =&gt; { 10. localVideo.srcObject = stream; 11. localStream = stream; 12. }); 13. 14. var pc = new RTCPeerConnection({ iceServers: [...] }); 15. 16. localStream 17. .getTracks() 18. .forEach(track =&gt; pc.addTrack(track, localStream)); 19. 20. // Step #2: Creating SDP offer (caller) 21. 22. pc.createOffer({ offerToReceiveAudio: true, offerToReceiveVideo: true }) 23. .then(offer =&gt; signaling.send('offer', offer)); 24. 25. // Step #3: Handling SDP offer and sending SDP answer (callee) 26. 27. signaling.on('offer', offer =&gt; { 28. pc.setRemoteDescription(offer) 29. .then(() =&gt; pc.createAnswer()) 30. .then(answer =&gt; signaling.send('answer', answer)) 31. }); 32. 33. // Step #4: Handling SDP answer (calleer) 34. 35. signaling.on('answer', answer =&gt; pc.setRemoteDescription(answer)); 36. 37. // Step #5: Exchanging ICE candidates 38. 39. pc.onicecandidate = event =&gt; signaling.send('candidate', event.candidate); 40. 41. signaling.on('candidate', candidate =&gt; pc.addIceCandidate(candidate)); 42. 43. // Step #6: Getting remote video stream (both caller and callee) 44. 45. var remoteVideo = document.getElementById('remoteVideo'); 46. 47. pc.onaddstream = event =&gt; remoteVideo.srcObject = event.streams[0];</span></span></code> </pre> <br></div></div><br>  Il dit ceci: <br><br><ol><li>  Prenez une vid√©o et √©tablissez une connexion entre pairs, transf√©rez une sorte de iceServers (ce n'est pas imm√©diatement clair de quoi il s'agit). <br></li><li>  Cr√©ez une offre SDP et envoyez-la √† la signalisation, et la signalisation WebRTC ne l'impl√©mentera en aucune fa√ßon. <br></li><li>  Ensuite, vous devez cr√©er un wrapper pour celui provenant de la signalisation, et cela ne fait pas non plus partie de WebRTC. <br></li><li>  √âchangez encore quelques candidats. <br></li><li>  Obtenez enfin le flux vid√©o √† distance. <br></li></ol><br>  Voyons ce qui se passe l√†-bas et ce dont nous avons besoin pour nous mettre en ≈ìuvre. <br><img src="https://habrastorage.org/webt/wx/fz/fn/wxfzfnkuw7smjite-bdpmadb_ro.jpeg"><br><br>  Nous regardons l'image de bas en haut.  Il existe une biblioth√®que WebRTC d√©j√† int√©gr√©e au navigateur, prise en charge par Chrome, Firefox, etc. Vous pouvez la cr√©er sous Android / iOS et communiquer avec elle via l'API et SDP (Session Description Protocol), qui d√©crit la session elle-m√™me.  Ci-dessous, je vais vous dire ce qui y est inclus.  Pour utiliser cette biblioth√®que dans votre application, vous devez √©tablir une connexion entre les abonn√©s via la signalisation.  La signalisation est aussi votre service que vous devez √©crire vous-m√™me, WebRTC ne le fournit pas. <br><br>  Plus loin dans l'article, nous discuterons du r√©seau dans l'ordre, puis de la vid√©o / audio, et √† la fin, nous √©crirons notre signalisation. <br><br><h2>  R√©seau WebRTC ou p2p (en fait c2s2c) <br></h2><br>  La configuration d'une connexion p2p semble √™tre assez simple. <br><img src="https://habrastorage.org/webt/he/7h/so/he7hsoyzqklbzj715slypgychgc.jpeg"><br><br>  Nous avons Alice et Bob qui veulent √©tablir une connexion p2p.  Ils prennent leurs adresses IP, ils ont un serveur de signalisation auquel ils sont tous les deux connect√©s, et par lequel ils peuvent √©changer ces adresses.  Ils √©changent des adresses, et oh!  Ils ont les m√™mes adresses, quelque chose s'est mal pass√©! <br><img src="https://habrastorage.org/webt/rn/hc/uj/rnhcujxoa5k0tni2oquj-tx3hfi.jpeg"><br><br>  En fait, les deux utilisateurs sont tr√®s probablement assis derri√®re des routeurs Wi-Fi et ce sont leurs adresses IP grises locales.  Le routeur leur fournit une fonctionnalit√© telle que la traduction d'adresses r√©seau (NAT).  Comment fonctionne-t-elle? <br><img src="https://habrastorage.org/webt/yr/xu/r0/yrxur0s_xhoye3i36zod4ropbec.jpeg"><br><br>  Vous avez un sous-r√©seau gris et une adresse IP externe.  Vous envoyez un paquet √† Internet √† partir de votre adresse grise, NAT remplace votre adresse grise par du blanc et se souvient du mappage: quel port il a envoy√©, √† quel utilisateur et √† quel port il correspond.  Lorsque le paquet de retour arrive, il se r√©sout par ce mappage et l'envoie √† l'exp√©diteur.  Tout est simple. <br><br>  Vous trouverez ci-dessous une illustration de l'apparence de ma place. <br><img src="https://habrastorage.org/webt/ud/ar/da/udardacyxvmzt5mq0modbosd-mc.jpeg"><br><br>  Il s'agit de mon adresse IP interne et de l'adresse du routeur (d'ailleurs, √©galement grise).  Si vous tracez et voyez l'itin√©raire, nous verrons mon routeur Wi-Fi: un paquet d'adresses de fournisseur gris et une IP blanche externe.  Ainsi, en fait, j'aurai deux NATs: l'un sur lequel je suis en Wi-Fi, et l'autre autre chez le fournisseur, √† moins, bien s√ªr, de m'acheter une adresse IP externe d√©di√©e. <br><br>  <strong>NAT est si populaire parce que:</strong> <br><br><ul><li>  de nombreux IPv4 sont toujours manquants et il n'y a pas suffisamment d'adresses; </li><li>  NAT semble prot√©ger le r√©seau; </li><li>  c'est une fonction standard du routeur: connectez-vous au Wi-Fi, il y a du NAT l√†, √ßa fonctionne. </li></ul><br>  Par cons√©quent, seulement 3% des utilisateurs sont assis avec une adresse IP externe, tandis que tous les autres passent par NAT. <br><br>  NAT vous permet d'acc√©der en toute s√©curit√© √† toutes les adresses blanches.  Mais si vous n'√™tes all√© nulle part, personne ne peut venir √† vous. <br><img src="https://habrastorage.org/webt/j7/cl/j2/j7clj2pypnpwv_p-odndgflgzpk.jpeg"><br><br>  √âtablir une connexion p2p est un probl√®me.  En fait, Alice et Bob ne peuvent pas s‚Äôenvoyer de paquets s‚Äôils sont tous deux derri√®re NAT. <br><br>  WebRTC dispose d' <strong>un protocole STUN</strong> pour r√©soudre ce probl√®me.  Il est propos√© de d√©ployer un serveur STUN.  Puis Alice se connecte au serveur STUN, obtient son adresse IP, l'envoie √† Bob via la signalisation.  Bob obtient √©galement son adresse IP et l'envoie √† Alice.  Ils s'envoient des paquets et traversent ainsi le NAT. <br><img src="https://habrastorage.org/webt/1m/mq/iz/1mmqiz57zbyzzahdgng_y_3hywo.jpeg"><br><br>  <strong>Question</strong> : Alice a un port sp√©cifique ouvert, NAT / Firewall a d√©j√† √©t√© rompu √† ce port et Bob est ouvert.  Ils connaissent leurs adresses respectives.  Alice essaie d'envoyer le paquet √† Bob; il envoie le paquet √† Alice.  Pensez-vous qu'ils peuvent parler ou non? <br><br>  En fait, vous avez raison dans tous les cas, le r√©sultat d√©pend du type de paire NAT que les utilisateurs ont. <br><img src="https://habrastorage.org/webt/te/hd/hj/tehdhjdvyvfv9dcrxng950n98h8.jpeg"><br><br><h3>  Traduction d'adresses r√©seau <br></h3><br>  Il existe 4 types de NAT: <br><br><ol><li>  NAT √† c√¥ne plein; <br></li><li>  NAT √† c√¥ne restreint; <br></li><li>  Port √† c√¥ne restreint NAT; <br></li><li>  NAT sym√©trique <br></li></ol><br>  Dans la version de base, Alice envoie un paquet au serveur STUN, elle ouvre un port.  Bob d√©couvre en quelque sorte son port et envoie un paquet de retour.  S'il s'agit d'un <strong>NAT √† c√¥ne complet</strong> - le plus simple qui mappe simplement le port externe au port interne, alors Bob sera en mesure d'envoyer imm√©diatement un paquet √† Alice, d'√©tablir une connexion et ils parleront. <br><img src="https://habrastorage.org/webt/ph/kp/zr/phkpzrkuy3k2uzqsl4sub-sla7o.jpeg"><br><br>  Voici le sch√©ma d'interaction: Alice d'un port envoie un paquet au port STUN, STUN lui r√©pond avec son adresse externe.  STUN peut r√©pondre √† partir de n'importe quelle adresse, s'il s'agit d'un NAT √† c√¥ne complet, il passera toujours par NAT, et Bob peut r√©pondre √† la m√™me adresse. <br><img src="https://habrastorage.org/webt/dl/pp/3a/dlpp3anl2az479kengmx5easix4.jpeg"><br><br>  Dans le cas du <strong>NAT √† c√¥ne restreint, les</strong> choses sont un peu plus compliqu√©es.  Il se souvient non seulement du port √† partir duquel vous devez mapper vers l'adresse interne, mais √©galement de l'adresse externe vers laquelle vous √™tes all√©.  Autrement dit, si vous avez √©tabli une connexion uniquement avec le serveur IP STUN, personne d'autre sur le r√©seau ne pourra vous r√©pondre et le paquet de Bob n'atteindra pas. <br><img src="https://habrastorage.org/webt/yt/-g/sg/yt-gsg5yyrf99ywt77j2ydntyzy.jpeg"><br><br>  Comment ce probl√®me est-il r√©solu?  Dans un sch√©ma simple (voir l'illustration ci-dessous) comme celui-ci: Alice envoie un paquet √† STUN, il lui r√©pond avec son IP.  STUN peut y r√©pondre depuis n'importe quel port tant qu'il est NAT √† c√¥ne restreint.  Bob ne peut pas r√©pondre √† Alice car il a une adresse diff√©rente.  Alice r√©pond avec un paquet, connaissant l'adresse IP de Bob.  Elle ouvre NAT √† Bob, Bob lui r√©pond.  Hourra, ils ont parl√©. <br><img src="https://habrastorage.org/webt/iz/ji/ar/izjiare3mege16iftxwal3haqye.jpeg"><br><br>  Une option l√©g√®rement plus compliqu√©e est le <strong>NAT √† c√¥ne restreint au port</strong> .  N√©anmoins, seul STUN doit r√©pondre exactement √† partir du port auquel il a √©t√© acc√©d√©.  Tout fonctionnera aussi. <br><br>  La chose la plus nuisible est le <strong>NAT sym√©trique</strong> . <br><img src="https://habrastorage.org/webt/p-/se/fu/p-sefuxnvpapxpuf8-wqavqkd0u.jpeg"><br><br>  Au d√©but, tout fonctionne exactement de la m√™me mani√®re - Alice envoie le paquet au serveur STUN, il r√©pond depuis le m√™me port.  Bob ne peut pas r√©pondre √† Alice, mais elle envoie le paquet √† Bob.  Et ici, malgr√© le fait qu'Alice envoie un paquet au port 4444, le mappage lui alloue un nouveau port.  Le NAT sym√©trique diff√®re en ce que chaque fois qu'une nouvelle connexion est √©tablie, chaque fois qu'elle √©met un nouveau port sur le routeur.  En cons√©quence, Bob bat dans le port √† partir duquel Alice est all√©e √† STUN, et ils ne peuvent pas se connecter. <br><br>  Dans le sens oppos√©, si Bob a une adresse IP ouverte, Alice peut simplement venir le voir et √©tablir une connexion. <br><br>  Toutes les options sont rassembl√©es dans un tableau ci-dessous. <br><img src="https://habrastorage.org/webt/-c/jf/o9/-cjfo9dclflwku9qz-2p4wl_hre.jpeg"><br><br>  Cela montre que presque tout est possible, sauf lorsque nous essayons d'√©tablir des connexions via NAT sym√©trique avec NAT √† c√¥ne restreint de port ou NAT sym√©trique √† l'autre extr√©mit√©. <br><img src="https://habrastorage.org/webt/gp/lk/_d/gplk_darehdjbaxktic84liuwto.jpeg"><br><br>  Comme nous l'avons d√©couvert, p2p n'a pas de prix pour nous en termes de latence, mais s'il n'a pas √©t√© possible de l'installer, WebRTC nous propose un serveur TURN.  Lorsque nous avons r√©alis√© que p2p ne s'installera pas, nous pouvons simplement nous connecter √† TURN, qui va proxy tout le trafic.  Cependant, en m√™me temps, vous paierez pour le trafic et les utilisateurs peuvent avoir des retards suppl√©mentaires. <br><br><h2>  Pratique <br></h2><br>  Google dispose de serveurs STUN gratuits.  Vous pouvez les mettre dans la biblioth√®que, cela fonctionnera. <br><br>  Les serveurs TURN ont des informations d'identification (identifiant et mot de passe).  Tr√®s probablement, vous devrez √©lever le v√¥tre, il est plut√¥t difficile de le trouver gratuitement. <br><br>  Exemples de serveurs STUN gratuits de Google: <br><br><ul><li>  √©tourdissement: stun.l.google.com: 19302 </li><li>  √©tourdissement: stun1.l.google.com: 19302 </li><li>  √©tourdissement: stun2.l.google.com: 19302 </li><li>  √©tourdissement: stun3.l.google.com: 19302 </li></ul><br>  Et un serveur TURN gratuit avec des mots de passe: url: 'turn: 192.158.29.39: 3478? Transport = udp', identifiant: 'JZEOEt2V3Qb0y27GRntt2u2PAYA =', nom d'utilisateur: '28224511: 1379330808 ‚Ä≤. <br><br>  Nous utilisons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">coturn</a> . <br><img src="https://habrastorage.org/webt/yj/_d/zv/yj_dzvkvpkhmol2a8ryscucgoli.jpeg"><br><br>  En cons√©quence, 34% du trafic passe par la connexion p2p, tout le reste est mandat√© via le serveur TURN. <br><br><h4>  Quoi d'autre est int√©ressant dans le protocole STUN? <br></h4><br>  STUN vous permet de d√©terminer le type de NAT. <br><img src="https://habrastorage.org/webt/nj/lo/7h/njlo7h_sounawjxlwk-pxsiejy0.jpeg"><br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><em>Lien de</em></a> <em>diapositive</em> <br><br>  Lors de l'envoi d'un paquet, vous pouvez indiquer que vous souhaitez recevoir une r√©ponse du m√™me port ou demander √† STUN de r√©pondre √† partir d'un port diff√©rent, d'une IP diff√©rente, ou m√™me d'une IP et d'un port diff√©rents.  Ainsi, <strong>pour 4 requ√™tes au serveur STUN, vous pouvez d√©terminer le type de NAT</strong> . <br><img src="https://habrastorage.org/webt/og/0m/2h/og0m2hawerjjdabsr43zwygz_cy.jpeg"><br><br>  Nous avons compt√© les types de NAT et nous avons constat√© que presque tous les utilisateurs ont soit NAT sym√©trique soit NAT √† c√¥ne restreint de port.  Par cons√©quent, il s'av√®re que seul un tiers des utilisateurs peuvent √©tablir une connexion p2p. <br><br>  Vous pouvez vous demander pourquoi je vous dis tout cela si vous pouviez simplement prendre le STUN de Google, le mettre dans WebRTC, et il semble que tout fonctionnera. <br><br>  Parce que vous pouvez d√©terminer vous-m√™me le type de NAT. <br><img src="https://habrastorage.org/webt/ih/qn/8j/ihqn8j2nm2dumsstvyopem7ljxk.jpeg"><br><br>  Il s'agit d'un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lien</a> vers une application Java qui ne fait rien de compliqu√©: il envoie simplement un ping √† diff√©rents ports et diff√©rents serveurs STUN, et regarde quel port il voit √† la fin.  Si vous avez Open Full cone NAT, le serveur STUN aura le m√™me port.  Avec le NAT √† c√¥ne restreint, vous aurez diff√©rents ports pour chaque demande STUN. <br><img src="https://habrastorage.org/webt/ve/qf/t1/veqft1dee6wstziwrkrbemxj5da.jpeg"><br><br>  Avec Symmetric NAT, √ßa se passe comme √ßa dans mon bureau.  Il existe des ports compl√®tement diff√©rents. <br><br>  Mais parfois, il existe un mod√®le int√©ressant: pour chaque connexion, le num√©ro de port augmente d'une unit√©. <br><img src="https://habrastorage.org/webt/2n/7e/ro/2n7ero_besx7rzunsjuzfjplfpy.jpeg"><br><br>  Autrement dit, de nombreux NAT sont configur√©s de mani√®re √† augmenter ou diminuer le port d'une constante.  Cette constante peut √™tre trouv√©e et ainsi traverser le NAT sym√©trique. <br><img src="https://habrastorage.org/webt/te/6n/bf/te6nbfknmebcz7zmrtk35jqwfpk.jpeg"><br><br>  Ainsi, nous traversons le NAT - nous allons √† un serveur STUN, √† un autre, regardons la diff√©rence, comparons et essayons √† nouveau de donner notre port d√©j√† avec cet incr√©ment ou d√©cr√©ment.  Autrement dit, Alice essaie de donner √† Bob son port, d√©j√† ajust√© pour une constante, sachant que la prochaine fois, ce sera juste cela. <br><img src="https://habrastorage.org/webt/l1/re/-m/l1re-mp1om6zkjqm0j1n5rfh004.jpeg"><br><br>  Nous avons donc r√©ussi √† souder <strong>12% d'√©gal √† √©gal</strong> . <br><br>  En fait, parfois, les routeurs externes avec la m√™me IP se comportent de la m√™me mani√®re.  Par cons√©quent, si des statistiques sont collect√©es et si le NAT sym√©trique est une caract√©ristique du fournisseur, et non une caract√©ristique du routeur Wi-Fi de l'utilisateur, alors le delta peut √™tre pr√©dit, l'envoyer imm√©diatement √† l'utilisateur afin qu'il l'utilise et ne passe pas trop de temps √† le d√©terminer. <br><br><h2>  Relais CDN ou que faire si vous ne parvenez pas √† √©tablir une connexion P2P <br></h2><br>  Si nous utilisons toujours le serveur TURN et ne travaillons pas en p2p, mais en mode r√©el, en passant tout le trafic via le serveur, nous pouvons toujours ajouter un CDN.  √Ä moins, bien s√ªr, que vous ayez une aire de jeux.  Nous avons nos propres sites CDN, donc pour nous, c'√©tait assez simple.  Mais il fallait d√©terminer o√π il valait mieux envoyer une personne: sur un site CDN ou, disons, sur une cha√Æne vers Moscou.  Ce n'est pas une t√¢che tr√®s triviale, nous l'avons donc fait: <br><br><ol><li>  Accidentellement d√©livr√© √† certains utilisateurs du site de Moscou, certains - √† distance. <br></li><li>  Nous avons collect√© des statistiques sur l'IP de l'utilisateur, sur les serveurs et sur les caract√©ristiques du r√©seau. <br></li><li>  Par maxMind, nous avons regroup√© les sous-r√©seaux, regard√© les statistiques et avons pu comprendre par IP quel utilisateur avait le serveur TURN le plus proche pour la connexion. <br></li></ol><br><img src="https://habrastorage.org/webt/ql/dg/sy/qldgsyqtvaeqqdvyctilcipatau.jpeg"><br><br>  Il y a un CDN √† Novossibirsk.  Si tout fonctionne pour vous via Moscou, le 99e centile de RTT est de 1,3 seconde.  Gr√¢ce √† CDN, tout fonctionne beaucoup plus rapidement (0,4 seconde). <br><br>  Est-il toujours pr√©f√©rable d'utiliser une connexion p2p et de ne pas utiliser de serveur?  Un exemple int√©ressant est les deux fournisseurs de Krasnoyarsk Optibyte et Mobra (les noms peuvent avoir chang√©).  Pour une raison quelconque, la connexion entre eux sur p2p est bien pire que via MSK.  Ils ne sont probablement pas amis entre eux. <br><img src="https://habrastorage.org/webt/yq/en/dm/yqendmksjs7vila8zpra1xu_2uc.jpeg"><br><br>  Nous avons analys√© tous ces cas, envoyant des utilisateurs au hasard vers p2p ou via MSK, collect√© des statistiques et construit des pr√©dictions.  Nous savons que les statistiques doivent √™tre mises √† jour, donc pour certains utilisateurs, nous √©tablissons sp√©cialement diff√©rentes connexions pour v√©rifier si quelque chose a chang√© dans les r√©seaux. <br><br>  Nous avons mesur√© des caract√©ristiques aussi simples que le temps d'arrondi, la perte de paquets, la bande passante - il reste √† apprendre √† les comparer correctement. <br><img src="https://habrastorage.org/webt/yu/l-/nb/yul-nbvpnw5za6ixc80wlgumrse.jpeg"><br><br>  Comment comprendre ce qui est le mieux: Internet √† 2 Mbit / s, RTT 400 ms et perte de paquets de 5% ou 100 Kbit / s, d√©lai de 100 ms et perte de paquets insuffisante? <br><br>  Il n'y a pas de r√©ponse exacte, l'√©valuation de la qualit√© des appels vid√©o est tr√®s subjective.  Par cons√©quent, apr√®s la fin de l'appel, nous avons demand√© aux utilisateurs d'√©valuer la qualit√© des ast√©risques et de d√©finir les constantes en fonction des r√©sultats.  Il s'est av√©r√© que, par exemple, RTT est inf√©rieur √† 300 ms - cela n'a plus d'importance, le d√©bit binaire est plus important. <br><br>  Notes d'utilisateurs plus √©lev√©es sur Android et iOS.  On voit que les utilisateurs iOS sont plus susceptibles de mettre une unit√© et plus souvent cinq.  Je ne sais pas pourquoi, probablement, les sp√©cificit√©s de la plateforme.  Mais nous avons tir√© les constantes le long de celles-ci, de sorte que nous avions, comme il nous semble, du bien. <br><br>  Revenons √† notre aper√ßu de l'article, nous discutons toujours du r√©seau. <br><br>  <strong>√Ä quoi ressemble la configuration de la connexion?</strong> <br><img src="https://habrastorage.org/webt/-o/0b/zz/-o0bzzfolvd5rhfysec57ebndda.jpeg"><br><br>  Nous envoyons des serveurs STUN et TURN √† PeerConnection (), une connexion est √©tablie.  Alice d√©couvre son IP, l'envoie √† la signalisation;  Bob apprend l'IP d'Alice.  Alice obtient l'IP de Bob.  Ils √©changent des paquets, peuvent traverser le NAT, d√©finir TURN et communiquer. <br><img src="https://habrastorage.org/webt/yz/oa/rv/yzoarv064wp3s6zwwjpy0ec68hk.jpeg"><br><br>  Dans les 5 √©tapes de l'√©tablissement de la connexion dont nous avons discut√© pr√©c√©demment, nous avons d√©termin√© les serveurs, d√©termin√© o√π les obtenir et les candidats ICE sont des adresses IP externes que nous √©changeons via la signalisation.  Les adresses IP internes des clients, si elles se trouvent dans la plage d'un r√©seau Wi-Fi, peuvent √©galement √™tre tent√©es de percer. <br><br>  Passons √† la partie de la vid√©o. <br><br><h2>  Vid√©o et audio <br></h2><br>  WebRTC prend en charge un certain ensemble de codecs vid√©o et audio, mais vous pouvez y ajouter votre propre codec.  Fondamentalement pris en charge par <strong>H.264 et VP8 pour la vid√©o</strong> .  VP8 est un codec logiciel, il consomme donc beaucoup de batterie.  H.264 n'est pas disponible sur tous les appareils (il est g√©n√©ralement natif), la priorit√© par d√©faut est donc sur VP8. <br><br>  √Ä l'int√©rieur du SDP (Session Description Protocol), il y a n√©gociation de codec: lorsqu'un client envoie une liste de ses codecs, l'autre envoie la sienne en priorit√©, et ils conviennent des codecs √† utiliser pour la communication.  Si vous le souhaitez, vous pouvez modifier la priorit√© des codecs VP8 et H.264, et pour cette raison, vous pouvez √©conomiser la batterie sur certains appareils, o√π 264 est natif.  Voici <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un exemple</a> de la fa√ßon dont cela peut √™tre fait.  Nous l'avons fait, il nous a sembl√© que les utilisateurs ne se plaignaient pas de la qualit√©, mais en m√™me temps la charge de la batterie √©tait beaucoup moins consomm√©e. <br><br>  Pour l'audio, WebRTC a <strong>OPUS ou G711</strong> , g√©n√©ralement tous les OPUS fonctionnent toujours, rien n'a besoin d'√™tre fait avec. <br><br>  Voici les mesures de temp√©rature apr√®s 10 minutes d'utilisation. <br><img src="https://habrastorage.org/webt/pf/-q/pj/pf-qpjvwi8myzm7_q1zlmpe2zbs.jpeg"><br><br>  Il est clair que nous avons test√© diff√©rents appareils.  Ceci est un exemple d'iPhone, et sur celui-ci, l'application OK utilise le moins la batterie, car la temp√©rature de l'appareil est la moins √©lev√©e. <br><br>  La deuxi√®me chose que vous pouvez activer si vous utilisez WebRTC est de <strong>d√©sactiver automatiquement la vid√©o lorsque la connexion est tr√®s mauvaise</strong> . <br><img src="https://habrastorage.org/webt/xg/kx/ab/xgkxab9ccijdbomfmja0rtrhfpg.jpeg"><br><br>  Si vous avez moins de 40 Kbps, la vid√©o se d√©sactivera.  Il vous suffit de cocher la case lors de la cr√©ation de la connexion, la valeur seuil peut √™tre configur√©e via l'interface.  Vous pouvez √©galement d√©finir le d√©bit binaire de d√©marrage minimal et maximal. <br><img src="https://habrastorage.org/webt/xw/7d/ts/xw7dtsmnuz7pe0ujabtjapnnkxg.jpeg"><br><br>  C'est une chose tr√®s utile.  Si lorsque vous √©tablissez une connexion, vous savez √† l'avance le d√©bit que vous attendez, vous pouvez le transf√©rer, l'appel commencera √† partir de celui-ci et vous n'aurez pas besoin d'adapter le d√©bit.  De plus, si vous savez que vous avez souvent des pertes de paquets ou des baisses de bande passante sur votre canal, la valeur maximale peut √©galement √™tre limit√©e. <br><br>  WhatsApp fonctionne avec des vid√©os tr√®s savonneuses, mais avec de petits retards, car il comprime agressivement le d√©bit binaire d'en haut. <br><br>  Nous avons collect√© des statistiques √† l'aide de MaxMind et l'avons cartographi√©. <br><img src="https://habrastorage.org/webt/la/1b/kq/la1bkqswv6zqpbqdd7zrjarq0xu.jpeg"><br><br>  Il s'agit d'une qualit√© de d√©part approximative que nous utilisons pour les appels dans diff√©rentes r√©gions de la Russie. <br><br><h2>  Signalisation <br></h2><br>  Vous devrez tr√®s probablement √©crire cette partie si vous souhaitez passer des appels.  Il y a toutes sortes d'emb√ªches.  Rappelez-vous √† quoi √ßa ressemble. <br><img src="https://habrastorage.org/webt/ip/iv/er/ipiverlo5evjhsixis-obij86vs.jpeg"><br><br>  Il existe une application avec signalisation qui se connecte et √©change avec SDP, et le SDP ci-dessous est l'interface avec WebRTC. <br><br>  Voici √† quoi ressemble une signalisation simple: <br><img src="https://habrastorage.org/webt/y3/zl/ih/y3zlihhnt8w32ukv-ms7sbelbgm.jpeg"><br><br>  Alice appelle Bob.  Il se connecte, par exemple, via une connexion Web-socket.  Bob re√ßoit une pouss√©e sur son t√©l√©phone portable ou son navigateur, ou dans une sorte de connexion ouverte, se connecte via une prise Web et apr√®s cela, le t√©l√©phone commence √† sonner dans sa poche.  Bob d√©croche le t√©l√©phone, Alice lui envoie ses codecs et autres fonctionnalit√©s WebRTC qu'elle prend en charge.  Bob lui r√©pond de la m√™me fa√ßon, et apr√®s cela, ils √©changent les candidats qu'ils ont vus.  Hourra, appelle! <br><br>  Tout semble assez long.  Tout d‚Äôabord, tant que vous n‚Äô√©tablissez pas de connexion Web, jusqu‚Äô√† ce que la pouss√©e arrive et tout le reste, le t√©l√©phone de Bob ne sonne pas dans sa poche.  Alice attendra tout le temps, pensera o√π est Bob, pourquoi il ne d√©croche pas le t√©l√©phone.  Apr√®s confirmation, tout cela prend quelques secondes, et m√™me sur de bonnes connexions, il peut √™tre de 3 √† 5 secondes, et sur de mauvaises connexions, les 10. <br><br>  Nous devons y faire quelque chose!  Vous me direz que tout peut √™tre fait tr√®s simplement. <br><br><img src="https://habrastorage.org/webt/kz/q0/ym/kzq0ymgejzqqpmlyso5ri8mvz-k.jpeg"><br><br>  Si vous avez d√©j√† une connexion ouverte pour votre application, vous pouvez imm√©diatement envoyer un push pour √©tablir une connexion, vous connecter au serveur de signalisation souhait√© et commencer imm√©diatement √† passer des appels. <br><br>  Puis une autre optimisation.  M√™me si le t√©l√©phone sonne toujours dans votre poche et que vous ne l'avez pas d√©croch√©, vous pouvez en fait √©changer des informations sur les codecs pris en charge, les adresses IP externes, commencer √† envoyer des paquets vid√©o vides et, en g√©n√©ral, tout sera r√©chauff√©.  Une fois que vous aurez d√©croch√© le t√©l√©phone, tout ira bien. <br><br>  Nous l'avons fait, et il semblait que tout √©tait cool.  Mais non. <br><img src="https://habrastorage.org/webt/hh/m5/t6/hhm5t6dtihar96isxhtsm92pums.jpeg"><br><br>  Le premier probl√®me est que les utilisateurs annulent souvent l'appel.  Ils cliquent sur ¬´Appeler¬ª et annulent imm√©diatement.  En cons√©quence, la pouss√©e va √† l'appel et l'utilisateur dispara√Æt (il a perdu Internet ou autre chose).  Pendant ce temps, le t√©l√©phone de quelqu'un sonne, il d√©croche et on ne l'attend pas l√†-bas.  Par cons√©quent, notre optimisation primitive afin de commencer √† appeler le plus rapidement possible ne fonctionne pas vraiment. <br><img src="https://habrastorage.org/webt/xy/we/gy/xywegygpnsrlns4osq7nn4i71f0.jpeg"><br><br>  Avec une annulation d'appel rapide, il y a une deuxi√®me chose nuisible.  Si vous g√©n√©rez l'ID de votre conversation sur le serveur, vous devez attendre une r√©ponse.  C'est-√†-dire que vous cr√©ez un appel, obtenez un ID et seulement apr√®s cela, vous pouvez faire ce que vous voulez: envoyer des paquets, √©changer, y compris annuler l'appel.  C'est une tr√®s mauvaise histoire, car il s'av√®re que tant que la r√©ponse n'est pas arriv√©e, vous ne pouvez en fait rien annuler du client.  Par cons√©quent, il est pr√©f√©rable de g√©n√©rer une sorte d'ID sur le client tel qu'un GUID et de dire que vous avez d√©marr√© l'appel.  Les gens font souvent cela: ils ont appel√©, annul√© et rappel√© imm√©diatement.  Pour √©viter que cela ne soit g√¢ch√©, faites un GUID et soumettez-le. <br><img src="https://habrastorage.org/webt/1e/he/ob/1eheobd8oyf6z-je6j0puuj7psy.jpeg"><br><br>  Cela ne semble rien, mais il y a un autre probl√®me.  Si Bob a deux t√©l√©phones, ou ailleurs, le navigateur reste ouvert, alors tout notre sch√©ma magique pour √©changer des paquets, √©tablir une connexion ne fonctionne pas s'il a soudainement r√©pondu √† partir d'un autre appareil. <br><br>  Que faire?  Revenons √† notre sch√©ma de base de signalisation lente simple et optimisons-le, envoyons le push un peu plus t√¥t.  L'utilisateur commencera √† se connecter plus rapidement, mais cela √©conomisera quelques sous. <br><img src="https://habrastorage.org/webt/ap/k3/kx/apk3kx9qq3nsrzmrervqa548e-g.jpeg"><br><br>  Que faire de la partie la plus longue apr√®s avoir d√©croch√© le t√©l√©phone et commenc√© l'√©change? <br><img src="https://habrastorage.org/webt/ff/bj/qv/ffbjqvge9liirsi6spjc7ttlyby.jpeg"><br><br>  Vous pouvez effectuer les op√©rations suivantes.  Il est clair qu‚ÄôAlice conna√Æt d√©j√† tous ses codecs et peut les envoyer aux deux t√©l√©phones de Bob.  Elle peut r√©soudre toutes ses adresses IP et √©galement les envoyer √† la signalisation, ce qui les gardera dans sa file d'attente, mais n'enverra √† aucun des clients afin qu'ils commencent √† √©tablir une connexion avec elle √† l'avance. <br><br>  Que peut faire Bob?  offer,   ,    ,   , ,    ,   .     ,    codec negotiation,  signaling             ,   ,     . Candidates         signaling. <br><br>   ,   signaling               .    ,          ,       . <br><br>    .           Google Duo  WhatsApp. <br><img src="https://habrastorage.org/webt/qr/gs/ry/qrgsry_mx3ahy48v6gvw1l49uau.jpeg"><br><br> ,   -  . ,      signaling,     ,   ,  , ,  ,    .     . <br><br> <strong>    ?</strong> <br><img src="https://habrastorage.org/webt/tp/fn/p3/tpfnp3a3cqrv_pdv31x7m4tirxi.jpeg"><br><br>      :   ,    .   ,      , ‚Äî   signaling  ,  ,   -  ,     ,     ,     . <br><img src="https://habrastorage.org/webt/so/mv/go/somvgopdt0c3zi5kksffvtpogz4.jpeg"><br><br>  ,   ,  ,      .          . ,     ,       ,   ,    .       ,    . <br><br>          ,     24/7,      -,      . <br><img src="https://habrastorage.org/webt/3a/uh/au/3auhaued9dsrfuwyhffcubvuqpy.jpeg"><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><em></em></a> <em>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a></em> <br><br>    web-socket  - load balancer,    signaling-   -,       .  Zookeeper   Leader Election,     signaling,     conversation.       conversation,      . <br><br>      ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NewSQL  Cassandra</a> .     ,  .       ,    signaling,   ,    signaling,     - ,  Leader Election  Zookeeper,   ,   ,         . <br><br>   : <br><br><ul><li>   - , ,   IP  signaling </li><li> Signaling ,   . </li><li>  ,  ,   , ,     . </li><li>       . </li></ul><br>     ,   . <br><br>           Cassandra,       ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>    ). <br><br> <strong>,  :</strong> <br><br><ul><li>   iceServers    ; </li><li>   Session Description Protocol; </li><li>         ; </li><li>      signaling    WebRTC   ,   IP ; </li><li>    ! </li></ul><br><img src="https://habrastorage.org/webt/6j/hp/6k/6jhp6kn6luheqat6jepleauq1me.jpeg"><br><br> <strong> :</strong> <br><br><ul><li>   delay    ; </li><li>     ; </li><li>        . </li></ul><br>  Ouah! <br><img src="https://habrastorage.org/webt/97/ru/zy/97ruzyu7gams8pyk2ktcoqb9yim.jpeg"><br><br><h2> Security. Man in the middle attack for WebRTC <br></h2><br>   man in the middle attack for WebRTC.   , WebRTC      ,     RTP,   1996 ,  SDP   1998  SIP. <br><img src="https://habrastorage.org/webt/yi/zm/7k/yizm7kvtjfnpnphvmuwiduk6yua.jpeg"><br><br>    ‚Äî   RFC     RTP,    RTP WebRTC. <br><br>      RFC ‚Äî       audio level,   ,     audio level  ,   . ,    SDP,   ,     .      congestion,       -. <br><br>  WebRTC  .  2011     ,  2013    Firefox,      iOS/Android,  2014 Opera.  , -   ,         . <br><img src="https://habrastorage.org/webt/53/s2/31/53s231p3esxh8vt9ls8dn8szgqi.jpeg"><br><br>       signaling,      ,  DTLS Handshake   .  ,       signaling,         ¬´¬ª   ,   ,      ,   . <br><img src="https://habrastorage.org/webt/i-/lq/uh/i-lquhbrd0eltgcqorvk1bu2gjs.jpeg"><br><br>       , , ,    HTTPS, WSS  ..     ‚Äî ZRTP,  , , Telegram. <br><br>    Telegram ,   ,     .       ,    ,  ,     ,       p2p . <br><br>  Comment √ßa marche? <br><img src="https://habrastorage.org/webt/rx/0-/ws/rx0-wsjwmt6y8fboqtzsgyzpqos.jpeg"><br><br>          ‚Äî .    ,    ,  .          .              K,    ,     ,        . <br><br>       ,       ,     K <sub>1</sub>  K <sub>2</sub> .       .    .   K <sub>1</sub>  K <sub>2</sub>     ,         .       K <sub>1</sub>  K <sub>2</sub>     :  ,   ‚Äî  ,   ‚Äî       ,  .        ,     ,  -    , ,   . <br><br><h2> <strong></strong> <br></h2><br><ul><li>  ¬´¬ª NAT type   symmetric NAT. </li><li>  ,  : 2  relay, , CDN;         . </li><li>   ,   . </li><li>    signaling. </li></ul><br><img src="https://habrastorage.org/webt/xr/h6/2i/xrh62iyyd4cb5ynwfa66atogljm.jpeg"><br><br>   ,       RTMFP, ,     WebRTC,   ,    .    !           4 . <br><br><h2> <strong> </strong> <br></h2><br>      ,    : <br><br><ul><li>   WebRTC  ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://webrtc.org/native-code/development/</a> ),    iOS/Android,      ; </li><li>    coturn ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/coturn/coturn</a> ); </li><li>  signaling. </li></ul><br>   ,    . <br><br><div class="spoiler"> <b class="spoiler_title">     </b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/MnEXuKHjIOU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br></div></div><br><blockquote>        HighLoad++  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>      4-. <br><br>     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> .    ,  19  (10    9    -)  ,   -    .  ,       ,   . <br></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr428217/">https://habr.com/ru/post/fr428217/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr428203/index.html">Nous regardons les graphiques: estimations et pr√©visions pour le march√© du cloud computing, donn√©es en 2018</a></li>
<li><a href="../fr428205/index.html">Lifehacks NaviHaka</a></li>
<li><a href="../fr428209/index.html">Livre de recettes du d√©veloppeur: recettes de conception pilot√©e par domaine (partie 2, structure et interaction)</a></li>
<li><a href="../fr428211/index.html">Le livre ¬´Architecture √©volutive. Soutien au changement continu "</a></li>
<li><a href="../fr428213/index.html">Comment interpr√©ter les pr√©dictions de mod√®le dans SHAP</a></li>
<li><a href="../fr428219/index.html">D'o√π est venue la pratique de la r√©installation massive de personnel qualifi√©?</a></li>
<li><a href="../fr428221/index.html">G√©n√©ration AI de visages r√©alistes</a></li>
<li><a href="../fr428223/index.html">Les villes et leurs Big Data</a></li>
<li><a href="../fr428225/index.html">Comment faire des analyses Web pour SaaS via Google Analytics: introduction et suivi d'un entonnoir</a></li>
<li><a href="../fr428227/index.html">Apprentissage automatique: pr√©dire les cours boursiers en bourse</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>