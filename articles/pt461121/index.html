<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêê üë©üèª‚Äçüç≥ üë©üèº‚Äçü§ù‚Äçüë®üèø Pequenas experi√™ncias multitarefa em um microcontrolador üìø üë®üèæ‚Äçüé§ üíß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Em uma das notas anteriores, o autor tentou argumentar que, ao programar o microcontrolador, uma simples troca de tarefas ser√° √∫til em situa√ß√µes em qu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pequenas experi√™ncias multitarefa em um microcontrolador</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461121/"><p>  Em uma das notas anteriores, o autor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tentou</a> argumentar que, ao programar o microcontrolador, uma simples troca de tarefas ser√° √∫til em situa√ß√µes em que o uso do sistema operacional em tempo real √© muito alto e o loop abrangente para todas as a√ß√µes necess√°rias √© muito pequeno ( Ele disse, assim como o conde de La Fer).  Mais precisamente, n√£o muito pouco, mas muito confuso. </p><br><p>  Em uma nota subseq√ºente, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">foi planejado</a> otimizar o acesso aos recursos compartilhados por v√°rias tarefas usando filas baseadas em buffers de anel (FIFOs) e uma tarefa separada especialmente designada para isso.  Tendo dispersado para tarefas diferentes aquelas a√ß√µes que n√£o est√£o relacionadas entre si, temos o direito de esperar um c√≥digo mais vis√≠vel.  E se ao mesmo tempo obtivermos alguma conveni√™ncia e simplicidade, por que n√£o tentar? </p><br><p>  Obviamente, o microcontrolador n√£o foi projetado para resolver qualquer tarefa conceb√≠vel do usu√°rio.  Ent√£o, talvez, esse alternador de tarefas seja bastante suficiente em muitas situa√ß√µes.  Em suma, √© improv√°vel que um pequeno experimento doa.  Portanto, para n√£o ser infundado, seu humilde servo decidiu escrever algo e testar seus rabiscos. </p><a name="habracut"></a><br><p>  Nos microcontroladores, devo dizer, o requisito de considerar o tempo como algo importante e dif√≠cil √© mais comum do que nos computadores de uso geral.  Ir al√©m da estrutura no primeiro caso √© equivalente a inoperabilidade, e no segundo caso, apenas leva a um aumento no tempo de espera, o que √© bastante aceit√°vel se os nervos estiverem em ordem.  Existem at√© dois termos "tempo real suave" e "tempo real dif√≠cil". </p><br><p>  Deixe-me lembr√°-lo, est√°vamos conversando sobre controladores com o n√∫cleo Cortex-M3,4,7.  Hoje √© uma fam√≠lia muito comum.  Nos exemplos abaixo, usamos o microcontrolador STM32F303, que faz parte da placa STM32F3DISCOVERY. </p><br><p>  O switch √© um √∫nico arquivo assembler. <br>  O montador n√£o tem medo do autor, mas, pelo contr√°rio, inspira a esperan√ßa de que a velocidade m√°xima seja alcan√ßada. </p><br><p>  Inicialmente, a l√≥gica mais simples da opera√ß√£o do comutador foi planejada, a qual √© apresentada na Figura 1 para oito tarefas. </p><br><p><img src="https://habrastorage.org/webt/ul/ot/pm/ulotpmeuad4zcxqcgroa_t92al0.jpeg"></p><br><p>  Nesse esquema, as tarefas levam uma parte do tempo, uma por uma, e podem apenas dar o restante do tick e, se necess√°rio, ignorar alguns dos ticks.  Essa l√≥gica provou ser boa, porque o tamanho qu√¢ntico pode ser pequeno.  E √© exatamente isso que √© necess√°rio para n√£o levantar urgentemente uma tarefa para a qual uma interrup√ß√£o acabou de acontecer, e tamb√©m aumentar e depois diminuir sua prioridade.  O pacote que acabou de ser recebido aguardar√° silenciosamente de 200 a 300 microssegundos at√© que sua tarefa receba seu tique.  E se tivermos um Cortex-M7 operando com uma frequ√™ncia de 216 MHz, 20 microssegundos por um tick √© bastante razo√°vel, pois levar√° menos de meio microssegundo para alternar.  E qualquer tarefa do exemplo acima nunca ter√° mais de 140 microssegundos de atraso. </p><br><p>  No entanto, com um aumento no n√∫mero de tarefas, mesmo com um tamanho extremamente pequeno do quantum de tempo, o atraso no in√≠cio da atividade da tarefa necess√°ria pode deixar de ser agrad√°vel.  Com base nisso, e tamb√©m levando em considera√ß√£o que apenas uma pequena parte das tarefas realmente requer tempo real, foi decidido modificar levemente a l√≥gica do comutador.  √â mostrado na Figura 2. </p><br><p><img src="https://habrastorage.org/webt/iq/gs/qi/iqgsqiqf4zigukr5vvrfi2sbgki.jpeg"></p><br><p>  Agora, selecionamos apenas uma parte das tarefas que recebem um quantum inteiro e selecionamos apenas uma marca para o resto, na qual elas se revezam no jogo.  Nesse caso, a sub-rotina de inicializa√ß√£o recebe um par√¢metro de entrada, ou seja, o n√∫mero da posi√ß√£o, a partir do qual todas as tarefas ser√£o afetadas em direitos e compartilhar√£o um tique.  Ao mesmo tempo, o esquema antigo permaneceu dispon√≠vel, para isso basta definir o valor do par√¢metro como zero ou o n√∫mero total de tarefas.  Os custos de troca aumentaram apenas com algumas instru√ß√µes do montador. </p><br><p>  Dois esquemas semelhantes s√£o usados ‚Äã‚Äãpara permitir o acesso a recursos compartilhados.  O primeiro, mencionado em uma nota anterior, usa v√°rios FIFOs (ou buffers circulares pelo n√∫mero de produtores de mensagens) e uma tarefa de correspond√™ncia separada.  Ele foi projetado para se comunicar com o mundo exterior e n√£o exige expectativas de tarefas que geram mensagens.  √â necess√°rio apenas garantir que as filas n√£o estejam lotadas. </p><br><p>  O segundo esquema tamb√©m usa uma tarefa separada para permitir o acesso, mas apresenta expectativas porque gerencia o recurso interno nas duas dire√ß√µes.  Essas a√ß√µes n√£o podem ser vinculadas ao tempo.  A Figura 3 mostra os componentes do segundo circuito. </p><br><p><img src="https://habrastorage.org/webt/-m/fb/4r/-mfb4rum70winng8agin4yqbf3e.jpeg"></p><br><p>  Os principais elementos s√£o um buffer de solicita√ß√µes, de acordo com o n√∫mero de tarefas desejadas, e um indicador de acesso.  A opera√ß√£o deste design √© bastante simples.  A tarefa √† esquerda envia uma solicita√ß√£o de acesso a um local especialmente alocado para ela (por exemplo, a tarefa 2 grava 1 na Solicita√ß√£o 2).  Tarefa - o expedidor seleciona quem permitir e grava o n√∫mero da tarefa selecionada no sinalizador de resolu√ß√£o.  A tarefa que recebeu permiss√£o executa suas a√ß√µes e grava o sinal do final do acesso √† solicita√ß√£o, o valor 0xFF.  O agendador, vendo que a solicita√ß√£o √© limpa, redefine o sinalizador de permiss√£o, redefine a solicita√ß√£o anterior e redefine a solicita√ß√£o de outra tarefa. </p><br><p>  Dois projetos de teste no IAR e uma descri√ß√£o da placa STM32F3DISCOVERY usada podem ser vistos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> .  No primeiro projeto, o ATS303 simplesmente verificou seu desempenho e o depurou.  Todos os LEDs instalados nesta placa foram √∫teis.  Ningu√©m ficou ferido. </p><br><p>  O segundo rascunho do BTS303 testou as duas op√ß√µes de aloca√ß√£o de recursos mencionadas.  Nele, as tarefas 1 e 2 geram mensagens de teste recebidas pelo operador.  Para me comunicar com o operador, tive que adicionar um cachecol com uma porta TTL COM, como mostra a foto abaixo. </p><br><p><img src="https://habrastorage.org/webt/za/hh/_c/zahh_cdcuabvgg-o92ukph_feji.jpeg"></p><br><p>  O operador usa um emulador de terminal.  Penso que o leitor desculpar√° o autor pela cor do tubo macio.  Parece assim. </p><br><p><img src="https://habrastorage.org/webt/1r/wa/aj/1rwaajjm2zx_ue2tglhquc7suw4.jpeg"></p><br><p>  Para iniciar o sistema inteiro, antes de resolver as interrup√ß√µes, s√£o necess√°rias etapas preliminares no corpo da tarefa zero principal (), que s√£o apresentadas abaixo. </p><br><pre><code class="plaintext hljs">void main_start_task_switcher(U8 border); U8 task_run_and_return_task_number((U32)t1_task); U8 task_run_and_return_task_number((U32)t2_task); U8 task_run_and_return_task_number((U32)t3_human_link); U8 task_run_and_return_task_number((U32)t4_human_answer); U8 task_run_and_return_task_number((U32)task_5); U8 task_run_and_return_task_number((U32)task_6); U8 task_run_and_return_task_number((U32)task_7);</code> </pre> <br><p>  Nessas linhas, o switch inicia primeiro e, em seguida, as sete tarefas restantes. </p><br><p>  Aqui est√° o conjunto m√≠nimo de chamadas necess√°rias para o trabalho. </p><br><pre> <code class="plaintext hljs"> void task_wake_up_action(U8 taskNumber);</code> </pre> <br><p>  Essa chamada √© usada em uma interrup√ß√£o de um timer de hardware do usu√°rio.  Os desafios das pr√≥prias tarefas falam por si. </p><br><pre> <code class="plaintext hljs"> void release_me_and_set_sleep_steps(U32 ticks); U8 get_my_number(void);</code> </pre><br><p>  Todas essas fun√ß√µes est√£o no arquivo de op√ß√£o do assembler.  Existem v√°rias outras fun√ß√µes que s√£o √∫teis para teste, mas n√£o s√£o necess√°rias. </p><br><p>  No projeto BTS303, a tarefa 3 recebe comandos do operador de fora e envia a ele as respostas da tarefa 4. A tarefa 4 recebe comandos do operador da tarefa 3 e os executa com poss√≠veis respostas.  A tarefa 3 tamb√©m recebe mensagens das tarefas 1 e 2 e a envia via UART para o emulador de terminal (por exemplo, massa de vidraceiro). </p><br><p>  A tarefa 0 (principal) realiza algum trabalho auxiliar, por exemplo, verifica o n√∫mero de palavras deixadas n√£o afetadas na √°rea empilhada de cada tarefa.  Esta informa√ß√£o pode ser solicitada pelo operador e ter uma id√©ia do uso da pilha.  Inicialmente, para cada tarefa, uma √°rea de pilha de 512 bytes (128 palavras) √© alocada e √© necess√°rio monitorar (pelo menos no est√°gio de depura√ß√£o) que essas √°reas n√£o chegam perto do estouro. </p><br><p>  As tarefas 5 e 6 fazem c√°lculos em alguma vari√°vel comum de ponto flutuante.  Para fazer isso, eles solicitam acesso a ele na tarefa 7. </p><br><p>  H√° outro recurso adicional que pode ser visto em projetos de teste.  Ele foi projetado para que voc√™ possa despertar a tarefa n√£o ap√≥s o n√∫mero de tiques expirar, mas ap√≥s um tempo especificado, e a apar√™ncia √© a seguinte. </p><br><pre> <code class="plaintext hljs"> void wake_me_up_after_milliSeconds(U32 timeMS);</code> </pre> <br><p>  Para sua implementa√ß√£o, tamb√©m √© necess√°rio um cron√¥metro de hardware adicional, que tamb√©m √© implementado nos casos de teste. </p><br><p>  Como voc√™ pode ver, a lista de todas as chamadas necess√°rias cabe em uma p√°gina. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt461121/">https://habr.com/ru/post/pt461121/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt461099/index.html">Jogo AirAttack! - nossa primeira experi√™ncia de desenvolvimento de VR</a></li>
<li><a href="../pt461101/index.html">O Android Jetpack comp√µe a primeira impress√£o</a></li>
<li><a href="../pt461105/index.html">5 plugins √∫teis para webpack</a></li>
<li><a href="../pt461107/index.html">Dos√≠metro para Seryozha. Parte II Tubos centen√°rios vs √°tomo pac√≠fico</a></li>
<li><a href="../pt461113/index.html">Cinco anos de uso do C ++ em projetos de microcontroladores em produ√ß√£o</a></li>
<li><a href="../pt461125/index.html">A tarefa de criar c√≥digos num√©ricos seq√ºenciais para numerar mensagens no c√≥digo-fonte no Visual Studio (ex. C #)</a></li>
<li><a href="../pt461127/index.html">An√°lise de desempenho da VM no VMware vSphere. Parte 3: Armazenamento</a></li>
<li><a href="../pt461129/index.html">Sobre kote, esposa, dois filhos, a id√©ia ... e n√£o apenas. Hist√≥ria com continua√ß√£o</a></li>
<li><a href="../pt461131/index.html">Caminh√£o de carrinho ROS - Parte 2. Software</a></li>
<li><a href="../pt461133/index.html">Testando o c√≥digo do SQL Server com tSQLt</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>