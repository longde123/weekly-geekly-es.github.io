<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕵🏽 👧🏾 ⛩️ Programmation visuelle pour Sonoff Basic 🌓 👩🏿‍⚕️ 🧑🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Un article sur la façon de créer un contrôleur logique programmable à partir d'un appareil chinois bon marché. Un tel appareil trouvera son applicatio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Programmation visuelle pour Sonoff Basic</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/436272/"><img src="https://habrastorage.org/getpro/habr/post_images/df6/125/27b/df612527bc8ae8a2c188d370940dbf78.jpg" alt="image"><br><br>  Un article sur la façon de créer un contrôleur logique programmable à partir d'un appareil chinois bon marché.  Un tel appareil trouvera son application à la fois dans la domotique et comme une leçon pratique en informatique scolaire. <br><a name="habracut"></a><br>  <em><font color="#424949">Pour référence, par défaut, le programme Sonoff Basic fonctionne avec une application mobile via le service cloud chinois, après la modification proposée, toutes les autres interactions avec cet appareil deviendront possibles dans le navigateur.</font></em> <br><br><h2>  <font color="#2874A6">Section I. Connexion de Sonoff au MGT24</font> </h2><br><h3>  <font color="#424949">Étape 1. Créez un panneau de contrôle</font> </h3><br>  Inscrivez-vous sur le site <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mgt24</a> (si vous n'êtes pas encore inscrit) et connectez-vous sous votre compte. <br><br><div class="spoiler">  <b class="spoiler_title">Se connecter</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/9c4/caa/9d0/9c4caa9d0e70ad4b30a23555a816c780.png" alt="image"><br></div></div><br>  Pour créer un panneau de contrôle pour un nouvel appareil, cliquez sur le bouton "+". <br><br><div class="spoiler">  <b class="spoiler_title">Exemple de création de panneau</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/afa/ccd/ed8/afaccded8dda9b70d5145da032a878fc.png" alt="image"><br></div></div><br>  Une fois le panneau créé, il apparaîtra dans la liste de vos panneaux. <br><br>  Dans l'onglet «Installation» du panneau créé, recherchez les champs «Device ID» et «Authorization Key», à l'avenir, ces informations seront nécessaires lors de la configuration de l'appareil Sonoff. <br><br><div class="spoiler">  <b class="spoiler_title">Exemple d'onglet</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/523/a96/d0a/523a96d0ae4d3682ad106a7adbc3e289.png" alt="image"><br></div></div><br><h3>  <font color="#424949">Étape 2. Flashage de l'appareil</font> </h3><br>  À l'aide de l'utilitaire <a href="">XTCOM_UTIL,</a> téléchargez le <a href="">micrologiciel Sonoff Basic PLC</a> sur l'appareil, pour cela, vous avez besoin d'un convertisseur USB-TTL.  Voici l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">instruction</a> et l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">instruction</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vidéo</a> . <br><br><h3>  <font color="#424949">Étape 3. Configurer l'appareil</font> </h3><br>  Mettez l'appareil sous tension, une fois la LED allumée, appuyez sur le bouton et maintenez-le enfoncé jusqu'à ce que la LED commence à clignoter régulièrement de manière uniforme. <br><br>  À ce stade, un nouveau réseau Wi-Fi appelé «PLC Sonoff Basic» apparaîtra, connectez votre ordinateur à ce réseau. <br><br><div class="spoiler">  <b class="spoiler_title">Indication LED de décodage</b> <div class="spoiler_text"><div class="scrollable-table"><table><tbody><tr><th>  Indication LED </th><th>  Statut de l'appareil </th></tr><tr><td>  double clignotement périodique </td><td>  pas de connexion avec le routeur </td></tr><tr><td>  brille continuellement </td><td>  connexion établie avec le routeur </td></tr><tr><td>  clignotement uniforme périodique </td><td>  mode point d'accès wifi </td></tr><tr><td>  éteindre </td><td>  pas de pouvoir </td></tr></tbody></table></div><br></div></div><br>  Ouvrez un navigateur Internet et entrez le texte «192.168.4.1» dans la barre d'adresse, accédez à la page des paramètres réseau de l'appareil. <br><br>  Remplissez les champs comme suit: <br><br><ul><li>  «Nom du réseau» et «Mot de passe» (pour lier l'appareil à votre routeur Wi-Fi domestique). </li><li>  «Device ID» et «Authorization Key» (pour autoriser l'appareil sur le service MGT24). </li></ul><br><div class="spoiler">  <b class="spoiler_title">Exemple de configuration des paramètres réseau de l'appareil</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/c22/0b0/8d4/c220b08d4abca1789b20e3f08ea5577e.png" alt="image"><br></div></div><br>  Enregistrez les paramètres et redémarrez l'appareil. <br><br>  Voici un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tutoriel vidéo</a> . <br><br><h3>  <font color="#424949">Étape 4. Connexion des capteurs (facultatif)</font> </h3><br>  Le micrologiciel actuel prend en charge jusqu'à quatre capteurs de température DS18B20.  Voici un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">didacticiel vidéo</a> sur le montage des capteurs.  Apparemment, cette étape sera la plus difficile, car elle nécessitera des mains directes et un fer à souder. <br><br><h2>  <font color="#2874A6">Section II.</font>  <font color="#2874A6">Programmation visuelle</font> </h2><br><h3>  <font color="#424949">Étape 1. Script</font> </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Blockly est</a> utilisé comme environnement de programmation, l'environnement est facile à apprendre, vous n'avez donc pas besoin d'être programmeur pour créer des scripts simples. <br><br>  J'ai ajouté des blocs spécialisés pour écrire et lire les paramètres du périphérique.  L'accès à n'importe quel paramètre se fait par nom.  Les noms composés sont utilisés pour les paramètres du périphérique distant: «paramètre @ périphérique». <br><br><div class="spoiler">  <b class="spoiler_title">Liste déroulante d'options</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/3a8/b7c/db2/3a8b7cdb22abbe0c400c60830da7b996.png" alt="image"><br></div></div><br>  Un exemple de scénario d'allumage et d'extinction cyclique de la charge (1 Hz): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/701/6d4/965/7016d496538dd3cf3abae9b2587b6401.png" alt="image"><br><br>  Un exemple de scénario qui synchronise le fonctionnement de deux périphériques distincts.  A savoir, le relais du dispositif cible répète le fonctionnement du relais du dispositif distant. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9d7/45c/40c/9d745c40c3ddac6d21cd473f025b68d8.png" alt="image"><br><br>  Scénario pour thermostat (sans hystérésis): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2a3/b2d/027/2a3b2d027fe0c8971b4b17aab2433ab7.png" alt="image"><br><br>  Pour créer des scripts plus complexes, vous pouvez utiliser des variables, des boucles, des fonctions (avec des arguments) et d'autres constructions.  Je ne décrirai pas tout cela en détail ici, le réseau a déjà beaucoup de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">matériel</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">formation sur Blockly</a> . <br><br><h3>  <font color="#424949">Étape 2. Ordre de script</font> </h3><br>  Le script s'exécute en continu et dès qu'il atteint sa fin, il recommence.  Il y a deux blocs qui peuvent suspendre temporairement le script, «delay» et «pause». <br><br>  Le bloc de retard est utilisé pour des retards en millisecondes ou microsecondes.  Cette unité maintient strictement l'intervalle de temps, bloquant le fonctionnement de l'ensemble de l'appareil. <br><br>  Le bloc pause est utilisé pour les seconds (peut-être moins) retards, et il ne bloque pas l'exécution d'autres processus dans l'appareil. <br><br>  Si le script contient en lui-même une boucle infinie, dans le corps de laquelle il n'y a pas de «pause», l'interpréteur lance indépendamment une petite pause. <br><br>  Si la pile de mémoire allouée est épuisée, l'interpréteur arrêtera l'exécution d'un tel script vorace (attention aux fonctions récursives). <br><br><h3>  <font color="#424949">Étape 3. Débogage des scripts</font> </h3><br>  Pour déboguer un script déjà chargé dans le périphérique, vous pouvez exécuter la trace du programme par étapes.  Cela peut être extrêmement utile lorsque le comportement du script n'est pas celui voulu par l'auteur.  Dans ce cas, le traçage permet à l'auteur de trouver rapidement la source du problème et de corriger l'erreur dans le script. <br><br>  Le script de calcul factoriel en mode débogage: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/98e/845/718/98e8457184a5c48ee027e2ac8af3ed77.png" alt="image"><br><br>  L'outil de débogage est très simple et se compose de trois boutons principaux: "démarrer", "un pas en avant" et "arrêter" (nous n'oublierons pas non plus "entrer" et "sortir" du mode débogage).  En plus du suivi étape par étape, vous pouvez définir un point d'arrêt sur n'importe quel bloc (en cliquant sur le bloc). <br>  Pour afficher les valeurs actuelles des paramètres (capteurs, relais) sur le moniteur, utilisez le bloc d'impression. <br>  Voici une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vidéo de présentation</a> sur l'utilisation du débogueur. <br><br><h2>  <font color="#2874A6">Section pour les curieux.</font>  <font color="#2874A6">Mais qu'est-ce qui se cache sous le capot?</font> </h2><br>  Pour que les scripts fonctionnent sur le périphérique cible, un interpréteur de bytecode et un assembleur pour 38 instructions ont été développés.  Un générateur de code spécialisé a été intégré au code source par blocs qui convertit les blocs visuels en instructions d'assembleur.  À l'avenir, ce programme d'assemblage est converti en bytecode et transféré sur le périphérique pour exécution. <br><br>  L'architecture de cette machine virtuelle est assez simple et il n'y a aucun sens à la décrire; sur le net, vous trouverez de nombreux articles sur la conception de machines virtuelles simples. <br><br>  Pour la pile de ma machine virtuelle, j'alloue généralement 1000 octets, cela suffit avec une marge.  Bien sûr, les récursions profondes peuvent épuiser n'importe quelle pile, mais il est peu probable qu'elles trouvent une application pratique. <br><br>  Le bytecode résultant est assez compact.  Par exemple, le bytecode pour calculer le même factoriel n'est que de 49 octets.  Voici sa présentation visuelle: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a94/d9f/511/a94d9f51102478e3b5d0db578f95132e.png" alt="image"><br><br>  Et voici son programme d'assembleur: <br><br><pre><code class="javascript hljs">shift <span class="hljs-number"><span class="hljs-number">-1</span></span> ldi <span class="hljs-number"><span class="hljs-number">10</span></span> call factorial, <span class="hljs-number"><span class="hljs-number">1</span></span> print exit :factorial ld_arg <span class="hljs-number"><span class="hljs-number">0</span></span> ldi <span class="hljs-number"><span class="hljs-number">1</span></span> gt je <span class="hljs-number"><span class="hljs-number">8</span></span> ld_arg <span class="hljs-number"><span class="hljs-number">0</span></span> ld_arg <span class="hljs-number"><span class="hljs-number">0</span></span> ldi <span class="hljs-number"><span class="hljs-number">1</span></span> sub call factorial, <span class="hljs-number"><span class="hljs-number">1</span></span> mul ret ldi <span class="hljs-number"><span class="hljs-number">1</span></span> ret</code> </pre> <br>  Si la forme de représentation de l'assembleur n'a aucune valeur pratique, l'onglet javascrit, au contraire, donne un aspect plus familier que les blocs visuels: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">factorial</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">num</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (num &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> num * factorial(num - <span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.alert(factorial(<span class="hljs-number"><span class="hljs-number">10</span></span>));</code> </pre><br>  Quant aux performances.  Lorsque j'ai commencé le scénario clignotant le plus simple, sur l'écran de l'oscilloscope, j'ai obtenu un méandre de 47 kHz (à une vitesse d'horloge du processeur de 80 MHz). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5be/199/e2c/5be199e2c8efd52bc0fb5d0b179c3f24.png" alt="image"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/f66/2e9/7cf/f662e97cfda73f74647d23a03a5d4696.jpg" alt="image"><br><br>  Je pense que c'est un bon résultat, au moins cette vitesse est presque dix fois plus rapide que celle de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lua</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Espruino</a> . <br><br><h2>  <font color="#2874A6">La dernière partie</font> </h2><br>  Pour résumer, je dirai que l'utilisation de scripts nous permet non seulement de programmer la logique d'un appareil individuel, mais permet également de relier plusieurs appareils en un seul mécanisme, où certains appareils influencent le comportement des autres. <br><br>  Je note également que la méthode choisie de stockage des scripts (directement dans les appareils eux-mêmes, et non sur le serveur), simplifie le basculement des appareils existants vers un autre serveur, par exemple, le Raspberry domestique, voici les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">instructions</a> . <br><br>  <i>C'est tout, je serai heureux d'entendre des conseils et des critiques constructives.</i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr436272/">https://habr.com/ru/post/fr436272/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr436262/index.html">* La mise à jour d'Ethereum "Constantinople" est reportée en raison d'une vulnérabilité potentielle trouvée au dernier moment</a></li>
<li><a href="../fr436264/index.html">Mono-référentiels: veuillez ne pas le faire (partie 2)</a></li>
<li><a href="../fr436266/index.html">Mise à l'échelle extrême dans Alibaba JDK</a></li>
<li><a href="../fr436268/index.html">Nous collectons un jeu complet</a></li>
<li><a href="../fr436270/index.html">35% de l'audience Runet n'utilise pas du tout d'ordinateur pour Internet</a></li>
<li><a href="../fr436276/index.html">Visualisation tridimensionnelle dans des simulateurs de matériel roulant basés sur le moteur OpenSceneGraph</a></li>
<li><a href="../fr436282/index.html">Défi d'une entreprise étrangère ou échec d'une entrevue</a></li>
<li><a href="../fr436288/index.html">Comment le monopole a-t-il commencé, ou un peu d'histoires avec l'IBM PC 5150</a></li>
<li><a href="../fr436292/index.html">Contrôlez, modifiez, supprimez: les 10 meilleurs rapports de DotNext 2018 Moscou</a></li>
<li><a href="../fr436294/index.html">Modélisation de séries chronologiques</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>