<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨‍👩‍👧‍👧 🥗 ✊🏻 我们从错误初始化的数据存储中还原虚拟机。 一个胡说八道的结局 🚅 🤰 ➿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="免责声明：笔记很有趣。 其中有用信息的特定密度很小。 它写为“为你自己”。 
 抒情介绍 
 我们组织中的文件转储正在Windows Server 2016下的VMware ESXi 6虚拟机上旋转。这不仅是转储。 这是结构部门之间的文件共享服务器：这里有协作，项目文档以及网络扫描仪中的文件夹。 通...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>我们从错误初始化的数据存储中还原虚拟机。 一个胡说八道的结局</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/452928/"><blockquote>  <b>免责声明：</b>笔记很有趣。 其中有用信息的特定密度很小。 它写为“为你自己”。 </blockquote><br><h3> 抒情介绍 </h3><br> 我们组织中的文件转储正在Windows Server 2016下的VMware ESXi 6虚拟机上旋转。这不仅是转储。 这是结构部门之间的文件共享服务器：这里有协作，项目文档以及网络扫描仪中的文件夹。 通常，这是整个生产寿命。 <br><br> 所有生产寿命的容器都开始挂起。 此外，客人可以安静地吊死自己，而不影响其他人。 可能挂起了整个主机，并因此挂起了所有其他来宾计算机。 我可以上吊，也可以挂起vSphere Client服务：也就是说，其他guest虚拟机的进程仍在运行，计算机正常运行并且正在响应，但是没有文件损坏，vSphere Client也没有附着在主机上。 通常，无法识别任何系统。 在负载较弱的白天可能会发生挂起。 可能在晚上零负载期间。 可能在晚上进行差异备份和中等负载期间。 可以在周末进行完整备份和高负载时使用。 情况明显恶化。 最初是一年一次，然后每六个月一次。 在我耐心等待的时候，每周两次。 <br><a name="habracut"></a><br> 我为RAM犯了罪。 但是即使在周末，他们也没有让我停下垃圾，将Memtest赶走。 等待五月假期。 五月的假期，我开车离开了Memtest，发现没有错误。 <br><br> 我很惊讶，决定去度假。 我度假时-垃圾场没有挂死。 当星期一第一天上班时，垃圾桶挂了。 保持完整备份，并在最后将其挂起。 假期里如此热烈的会面促使我决定将访客驱动器物理地拖到另一个主机上。 <br><br> 而且，尽管早就知道在放假后的第一天，什么事情都做不成，尽管我一整天都准备工作，但对下一次冻结的愤慨打消了我的思想和心情，誓言... <br><br> 物理磁盘已重新排列到另一台主机。 热连接。 磁盘出现在“ <i>驱动器”</i>选项卡上的存储设置中。 在“ <i>数据存储”</i>选项卡上，这些驱动器上<i>的</i>存储不是。  <i>刷新</i> -不显示。 好吧，当然，第一个冲动是<i>Add Storage</i> 。 添加向导告诉您它支持什么。 当然，它也支持VMFS。 我毫不怀疑。 快速浏览每个步骤中的向导消息：“下一步”，“下一步”，“下一步”，“完成”。 她的目光甚至都没有赶上主人梯级之一的窗户底部带有感叹号的黄色小圆圈。 <br><br> 向导结束时，一个新的数据存储出现在列表上...并带有其他物理磁盘上的数据存储。 <br><br> 我将继续浏览新添加的数据存储区，它...是空的。 当然，我再次感到惊讶。 假期后的头15分钟是早上8点，即使咖啡中的糖还没有搅拌。 在这里。 我首先想到的是，我从“本地”主机上拉错了驱动器。 我查看了“本地”主机中是否存在所需的数据存储：否，不存在。 第二个想法是：“狗屎b！”。 不确定，但是在我看来，第三，第四和至少第五个想法是相同的。 <br><br> 为了消除疑惑，我迅速在示例上安装了新的ESXi，安装了左侧驱动器，并在通读它之后，完成了向导的步骤。 是的 使用向导添加数据存储时，磁盘上的所有数据都会丢失，而无法回滚操作和还原数据。 后来，我在一个论坛上阅读了大师对这种设计的评估：糟糕透顶。 现在我真的同意了。 <br><br> 从第六个开始，思想以更具建设性的方式流动。 知道了 即使对于3Tb驱动器，初始化也要花费几秒钟的时间。 因此，这是高级格式化。 因此，分区表被简单地重写了。 因此数据仍然存在。 因此，现在让我们寻找一些未格式化的内容。 <br><br> 我从Strelec的启动映像加载汽车……我发现分区恢复程序是众所周知的，除了VMFS。 例如，他们知道Synology的分区布局，但是VMFS不知道。 <br><br> 枚举程序并不容易：GetDataBack和R.Saver充其量只能找到具有实时目录结构和实时文件名的NTFS分区。 但这不适合我。 我需要两个vmdk文件：一个系统磁盘和一个垃圾箱。 <br><br> 然后我明白了，现在看来，我将安装Windows并推出文件备份。 同时我还记得我在那里有一个DFS根目录。 而且，在对单位文件夹的访问权限的数量和分支系统上也完全荒唐。 别无选择。 唯一可以接受的时间选项是使用数据和所有权限还原系统和磁盘的状态。 <br><br> 再次谷歌搜索，论坛，KB'shki并再次哭泣：Yaroslavna：VMware ESXi不提供数据恢复机制。 所有讨论线程都有两个总决赛：有人在不便宜的DiskInternals VMFS Recovery的帮助下恢复了，或者有人在<i>vmfs-tools</i>和<i>dd</i> <i>help的帮助</i>下积极地推广其服务。 不能选择以700美元的价格购买DiskInternals VMFS Recovery许可证。 也不允许将局外人从“潜在对手的领土”引入公司数据。 但有人质疑，VMFS分区也可以读取UFS Explorer。 <br><br><h3>  DiskInternals VMFS恢复 </h3><br> 试用版已下载并安装。 程序成功看到一个空的VMFS部分： <br><br><img src="https://habrastorage.org/webt/yy/pe/po/yypepobhgib-ilpc2lratezxrhc.png" alt="图片"><br><br> 在<i>取消删除（快速扫描）</i>模式下，我还发现了一个破旧的数据存储区，其中包含虚拟机文件夹，其中的磁盘位于其中： <br><br><img src="https://habrastorage.org/webt/jr/y8/sk/jry8skays28vnmrhzl8ot6jpfyu.png"><br><br> 预览显示文件处于活动状态： <br><br><img src="https://habrastorage.org/webt/tt/f1/eo/ttf1eoyfh-l0lsyfxcwcazss7dw.png"><br><br> 将分区成功安装到系统中，但是由于某些原因，所有三个文件夹都具有相同的虚拟机。 当然，卑鄙定律不是必需的。 <br><br><div class="spoiler">  <b class="spoiler_title">三行耻辱</b> <div class="spoiler_text"> 无耻地锁定软件的尝试以失败告终。 但是UFS Explorer被锁定。 <br><br><blockquote> 我对软件盗窃极为反对。 在任何情况下，我都不应敦促使用针对未经许可的使用的保护措施。 <br></blockquote><br> 我当时处于灾难性的境地，对我所采取的措施并不感到骄傲。 <br></div></div><br><h3>  UFS资源管​​理器 </h3><br> 扫描磁盘显示存在7个节点。  “惊人的方式”的节点数量与VMFS Recovery检测到的* -flat.vmdk文件数量一致： <br><br><img src="https://habrastorage.org/webt/nc/kh/m0/nckhm0xgc35ajd7hcmt9xbqgz6o.png"><br><br> 文件大小和节点大小的比较也显示了最大匹配字节。 同时，还原了-flat.vmdk文件的名称以及它们属于虚拟机的名称。 <br><br><img src="https://habrastorage.org/webt/ru/o2/jm/ruo2jmc33trnezku3qnqzt3n1yy.png"><br><br> 通常，从ESXi的角度来看，vmdk磁盘由两个文件组成：数据文件（&lt;计算机名称&gt; -flat.vmdk）和物理磁盘分区文件（&lt;计算机名称&gt; .vmdk）。 如果将* -flat.vmdk文件从本地计算机上载到数据存储，则ESXi将不会将其识别为有效的磁盘文件。  VMware知识库中有一篇文章介绍如何手动创建磁盘描述符文件： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">kb.vmware.com/s/article/1002511</a> ，但我不必这样做，我只是从DiskInternals VMFS Recovery中的文件内容预览区域复制了相应文件的内容。 ： <br><br><img src="https://habrastorage.org/webt/wa/ra/m3/waram3hzq42ow0zefbooy1vacqk.png"><br><br> 从UFS Explorer卸载2.5TB节点4个小时并将其加载到Datastore虚拟机管理程序20个小时后，发生故障的磁盘文件已连接到新创建的虚拟机。 捡起车轮。 没有发现数据丢失。 <br><br><img src="https://habrastorage.org/webt/-p/nc/73/-pnc73v0yy5rcpghk4qan_fownw.jpeg"></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN452928/">https://habr.com/ru/post/zh-CN452928/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN452914/index.html">面向微笑不怕实验的人，Scala上的ML面带微笑</a></li>
<li><a href="../zh-CN452916/index.html">起来吧 脊柱外科：什么时候做，有什么危险</a></li>
<li><a href="../zh-CN452922/index.html">灵活的CSS网格表</a></li>
<li><a href="../zh-CN452924/index.html">您需要采取什么措施来防止您的Google帐户被盗</a></li>
<li><a href="../zh-CN452926/index.html">静态测试或保存Private Ryan</a></li>
<li><a href="../zh-CN452938/index.html">3D打印机的喷枪又回来了，现在它们不再能停下来了</a></li>
<li><a href="../zh-CN452942/index.html">GeekBrains与编程专家举行12次免费在线会议</a></li>
<li><a href="../zh-CN452944/index.html">语言学家和数据分析专家的“对话”将是什么</a></li>
<li><a href="../zh-CN452946/index.html">重读Lou Greenaw的“ Windows 95 / NT编程哲学”</a></li>
<li><a href="../zh-CN452952/index.html">圣彼得堡的JetBrains开放日</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>