<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💂 📡 🌮 Fünf Jahre C ++ für Projekte für Mikrocontroller in der Produktion 🤛🏿 🧖🏽 🧗🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In diesem Artikel werde ich Ihnen erzählen, wie ich die Unternehmen, für die ich über fünf Jahre gearbeitet habe, von der Verwaltung von Projekten für...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Fünf Jahre C ++ für Projekte für Mikrocontroller in der Produktion</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461113/">  In diesem Artikel werde ich Ihnen erzählen, wie ich die Unternehmen, für die ich über fünf Jahre gearbeitet habe, von der Verwaltung von Projekten für Mikrocontroller in C auf C ++ übertragen habe und was daraus entstanden ist (Spoiler: Alles ist schlecht). <br><a name="habracut"></a><br><h2>  Ein bisschen über dich </h2><br>  Ich begann unter C-Mikrocontrollern zu schreiben, hatte nur Schulerfahrung mit Pascal, dann studierte ich Assembler und verbrachte ungefähr 3 Jahre damit, verschiedene Mikrocontroller-Architekturen und deren Peripheriegeräte zu studieren.  Dann gab es die Erfahrung der realen Arbeit in C # und C ++ mit ihrem parallelen Studium, das mehrere Jahre dauerte.  Nach dieser Zeit kehrte ich wieder und lange Zeit zur Programmierung von Mikrocontrollern zurück und hatte bereits die notwendige theoretische Grundlage für die Arbeit an realen Projekten. <br><br><h2>  Erstes Jahr </h2><br>  Ich hatte nichts gegen den prozeduralen Stil von C, aber das Unternehmen, das meine eigentliche Praxis mit realen Projekten begann, verwendete "C-Programmierung in einem objektorientierten Stil".  Es sah ungefähr so ​​aus. <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uart_init</span></span></span><span class="hljs-class"> {</span></span> USART_TypeDef *USARTx; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> baudrate; ... } <span class="hljs-keyword"><span class="hljs-keyword">uart_cfg_t</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uart_init</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uart_cfg_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *cfg)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uart_start_tx</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *d, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> l)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uart_tx</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *d, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> l, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> timeout)</span></span></span></span>;</code> </pre> <br>  Dieser Ansatz hatte folgende Vorteile: <br><br><ol><li>  Der Code war weiterhin C-Code. Daraus ergeben sich folgende Vorteile: <ul><li>  Es ist einfacher, "Objekte" zu steuern, da leicht nachverfolgt werden kann, wer und wo was und in welcher Reihenfolge verursacht (mit Ausnahme von Unterbrechungen, jedoch nicht in diesem Artikel). </li><li>  um den "Zeiger auf das Objekt" zu speichern, reicht es aus, sich an den zurückgegebenen fd zu erinnern; </li><li>  Wenn das "Objekt" gelöscht wurde, erhalten Sie beim Versuch, es zu verwenden, einen entsprechenden Fehler im Rückgabewert der Funktion. </li></ul></li><li>  Die Abstraktion solcher Objekte über die dort verwendete HAL ermöglichte es, für die Aufgabe anpassbare Objekte aus ihrer eigenen Initialisierungsstruktur zu schreiben (und bei fehlender HAL-Funktionalität könnte man den Zugriff auf die Register innerhalb der "Objekte" verbergen). </li></ol><br>  Nachteile: <br><br><ol><li>  Wenn jemand das „Objekt“ gelöscht und dann ein neues Objekt eines anderen Typs erstellt hat, kann es vorkommen, dass das neue Objekt das fd des alten erhält und das weitere Verhalten nicht bestimmt wird.  Dieses Verhalten kann leicht auf Kosten eines geringen Speicherverbrauchs für eine verknüpfte Liste geändert werden, anstatt ein Array mit einem Schlüsselwert zu verwenden (das Array für jeden Index fd hat einen Zeiger auf die Struktur des Objekts gespeichert). </li><li>  Es war unmöglich, Speicher unter "globalen Objekten" statisch zu markieren.  Da in den meisten Anwendungen „Objekte“ einmal erstellt und nicht weiter gelöscht wurden, sah es aus wie eine „Krücke“.  Hier wäre es beim Erstellen eines Objekts möglich, einen Zeiger auf seine interne Struktur zu übergeben, die während des Layouts statisch zugewiesen wurde. Dies würde jedoch den Initialisierungscode weiter verwirren und die Kapselung unterbrechen. </li></ol><br>  Auf die Frage, warum C ++ beim Aufbau der gesamten Infrastruktur nicht ausgewählt wurde, antworteten sie wie folgt: „Nun, C ++ führt zu starken zusätzlichen Kosten, unkontrollierten Speicherkosten sowie einer umfangreichen ausführbaren Firmware-Datei.“  Vielleicht hatten sie recht.  Tatsächlich gab es zu Beginn des Entwurfs nur GCC 3.0.5, das nicht besonders freundlich zu C ++ war (wir müssen noch damit arbeiten, um Programme unter QNX6 zu schreiben).  Es gab kein constexpr und C ++ 11/14, mit dem Sie globale Objekte erstellen konnten, bei denen es sich im Wesentlichen um Daten im Bereich .data handelte, die in der Kompilierungsphase berechnet wurden, und Methoden für diese. <br><br>  Auf die Frage, warum nicht in die Register schreiben - ich habe eine klare Antwort erhalten, dass die Verwendung von "Objekten" es Ihnen ermöglicht, den gleichen Anwendungstyp "an einem Tag" zu konfigurieren. <br><br>  Als ich all dies erkannte und erkannte, dass C ++ jetzt nicht mehr dasselbe ist wie mit GCC 3.0.5, begann ich, den Hauptteil der Funktionalität in C ++ neu zu schreiben.  Arbeiten Sie zunächst mit den Hardware-Peripheriegeräten des Mikrocontrollers und anschließend mit den Peripheriegeräten externer Geräte.  Tatsächlich war dies nur eine bequemere Hülle gegenüber dem, was zu dieser Zeit verfügbar war. <br><br><h2>  Jahr zwei und drei </h2><br>  Ich habe alles, was ich für meine Projekte brauchte, in C ++ umgeschrieben und sofort neue Module in C ++ geschrieben.  Dies waren jedoch nur Shells über C. Nachdem ich festgestellt hatte, dass ich C ++ nicht genug verwendete, begann ich, seine Stärken zu nutzen: Vorlagen, Nur-Header-Klassen, constexpr und mehr.  Alles lief gut. <br><br><h2>  Viertes und fünftes Jahr </h2><br><ul><li>  Alle Objekte sind global und enthalten Verknüpfungen in der Kompilierungsphase (entsprechend der Architektur des Projekts). </li><li>  Allen Objekten wird in der Phase des Layouts Speicher zugewiesen. </li><li>  nach Klassenobjekt für jeden Pin; </li><li>  ein Objekt, das alle Pins kapselt, um sie mit einer Methode zu initialisieren; </li><li>  ein RCC-Steuerobjekt, das alle Objekte kapselt, die sich auf den Hardwarebussen befinden; </li><li>  Das CAN &lt;-&gt; RS485-Konverterprojekt gemäß Kundenprotokoll enthält 60 Objekte; </li><li>  Wenn sich auf der HAL- oder Klassenebene eines Objekts etwas auf dieser Ebene befindet, müssen Sie nicht nur das Problem beheben, sondern auch überlegen, wie es behoben werden kann, damit dieses Update bei allen möglichen Konfigurationen dieses Moduls funktioniert ;; </li><li>  Die verwendeten Vorlagen und constexpr können nicht berechnet werden, bevor die Map-, ASM- und Bin-Dateien der endgültigen Firmware angezeigt werden (oder das Debugging im Mikrocontroller gestartet wird). </li><li>  Im Falle eines Fehlers in der Vorlage wird eine Nachricht mit einer Länge von einem Drittel der Projektkonfiguration von GCC ausgegeben.  Etwas davon zu lesen und zu verstehen ist eine separate Leistung. </li></ul><br><h2>  Zusammenfassung </h2><br>  Jetzt verstehe ich folgendes: <ol><li>  Die Verwendung von "Universalmodulkonstruktoren" erschwert das Programm nur unnötig.  Es ist viel einfacher, die Konfigurationsregister für ein neues Projekt anzupassen, als sich mit den Beziehungen zwischen Objekten und dann auch mit der HAL-Bibliothek zu befassen. </li><li>  Haben Sie keine Angst, C ++ zu verwenden, aus Angst, dass es "viel Speicher verschlingt" oder "weniger optimiert ist als C".  Nein das ist nicht so.  Sie müssen befürchten, dass die Verwendung von Objekten und vielen Abstraktionsebenen den Code unlesbar macht und das Debuggen eine Heldentat ist. </li><li>  Wenn Sie nichts „Komplizierendes“ wie Vorlagen, Vererbung und andere attraktive Reize von C ++ verwenden, warum dann überhaupt C ++ verwenden?  Nur um der Objekte willen?  Lohnt es sich?  Und für statische globale Objekte ohne Verwendung von Neu / Löschen bei einigen Projekten verboten? </li></ol><br>  Zusammenfassend lässt sich sagen, dass sich die scheinbare Einfachheit der Verwendung von C ++ nur als Ausrede herausstellte, um die Komplexität des Projekts wiederholt zu erhöhen, ohne an Geschwindigkeit oder Speicher zu gewinnen. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de461113/">https://habr.com/ru/post/de461113/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de461095/index.html">Apollo Guidance Computer - Architektur und Systemsoftware. Teil 1</a></li>
<li><a href="../de461099/index.html">Spiel AirAttack! - unsere erste VR-Entwicklungserfahrung</a></li>
<li><a href="../de461101/index.html">Android Jetpack Compose First Impression</a></li>
<li><a href="../de461105/index.html">5 nützliche Webpack-Plugins</a></li>
<li><a href="../de461107/index.html">Dosimeter für Seryozha. Teil II Hundertjährige Röhren gegen friedliches Atom</a></li>
<li><a href="../de461121/index.html">Kleine Multitasking-Experimente in einem Mikrocontroller</a></li>
<li><a href="../de461125/index.html">Die Aufgabe, sequentielle numerische Codes zum Nummerieren von Nachrichten im Quellcode in Visual Studio zu erstellen (z. B. C #)</a></li>
<li><a href="../de461127/index.html">VM-Leistungsanalyse in VMware vSphere. Teil 3: Lagerung</a></li>
<li><a href="../de461129/index.html">Über Kote, Frau, zwei Söhne, die Idee ... und nicht nur. Geschichte mit Fortsetzung</a></li>
<li><a href="../de461131/index.html">ROS Wagen LKW Teil 2. Software</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>