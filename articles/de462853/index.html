<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè™ üë®üèΩ‚Äçüíª ü¶è Aktualisieren von Statistiken zu sekund√§ren Replikaten der Verf√ºgbarkeitsgruppe üõåüèø üïµüèª üöà</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wir alle lieben und nutzen die erstaunlichen Funktionen der Verf√ºgbarkeitsgruppe f√ºr sekund√§re Replikate wie Integrit√§tspr√ºfungen, Sicherungen usw. 

...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Aktualisieren von Statistiken zu sekund√§ren Replikaten der Verf√ºgbarkeitsgruppe</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462853/">  Wir alle lieben und nutzen die erstaunlichen Funktionen der Verf√ºgbarkeitsgruppe f√ºr sekund√§re Replikate wie Integrit√§tspr√ºfungen, Sicherungen usw. <br><br>  Tats√§chlich bereitet die Unf√§higkeit, diese Informationen in einer Datenbank auf einem Replikat zu speichern, immer noch Kopfschmerzen (und denken Sie an Dinge wie CDC, um noch mehr Unbehagen zu verursachen). <br><br>  Aber h√∂r auf dich zu beschweren, hier ist die Hauptidee: Lieber Microsoft, lass uns unsere Replikate verwenden, um Statistiken zu aktualisieren ... nun, und viel mehr daran tun. <br><br><h3>  Es gibt immer einen Weg oder so etwas </h3><a name="habracut"></a><br>  <i>*fast immer</i> <br><br>  Lassen Sie uns die bekannten grundlegenden Details einer m√∂glichen L√∂sung in Enterprise Edition MS SQL Server auflisten: <br><br><ul><li>  Wir k√∂nnen Replikate lesbar machen und Daten daraus lesen (nicht, dass Sie dies immer tun mussten, aber wenn Sie wirklich wissen, was Sie tun ...); </li><li>  Wir k√∂nnen unsere Objekte nach Tempdb (ja, Ihre Multi-Terabyte-Tabellen sind f√ºr eine solche Operation wahrscheinlich nicht sehr geeignet) oder in eine andere beschreibbare Datenbank kopieren. </li><li>  Wir k√∂nnen die Ergebnisse in einen freigegebenen Ordner schreiben, auf den beide Replikate zugreifen k√∂nnen (sei es eine Textdatei in einer Dateifreigabe). </li><li>  Wir k√∂nnen Statistiken als Blob von SQL Server exportieren. </li><li>  Wir k√∂nnen den heruntergeladenen Blob in die Statistik importieren. </li></ul><br><h4>  Lass es uns tun </h4><br>  Ich habe eine Test-AG auf zwei virtuellen Maschinen mit SQL Server 2017 (Sie k√∂nnen jede Version verwenden) und ich werde eine einfache Tabelle erstellen, in der ich die Statistiken aktualisieren m√∂chte. <br><br>  Hier ist ein Skript zum Erstellen einer Tabelle und zum Einf√ºgen einer Million Zeilen: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> dbo.SampleDataTable; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> dbo.SampleDataTable ( C1 <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, C2 <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_SampleDataTable PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (C1) ); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.SampleDataTable <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (TABLOCK) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t.RN, t.RN <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (<span class="hljs-number"><span class="hljs-number">1000000</span></span>) ROW_NUMBER() <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)) RN <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.objects t1 <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sys.objects t2 <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sys.objects t3 <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sys.objects t4 <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sys.objects t5 ) t <span class="hljs-keyword"><span class="hljs-keyword">OPTION</span></span> (MAXDOP <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br>  Erstellen wir nun die ST_SampleDataTable_C2-Statistik f√ºr Spalte c2 <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> ST_SampleDataTable_C2 <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> dbo.SampleDataTable(C2);</code> </pre> <br>  Und dann werde ich 1000 Zeilen einf√ºgen, was sehr wichtig sein wird und weshalb ich die Statistiken wirklich aktualisieren muss. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> nocount <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.SampleDataTable <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (TABLOCK) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">10000000</span></span> + t.RN, <span class="hljs-number"><span class="hljs-number">999999999</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (<span class="hljs-number"><span class="hljs-number">1000</span></span>) ROW_NUMBER() <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)) RN <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.objects t1 <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sys.objects t2 <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sys.objects t3 <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sys.objects t4 <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sys.objects t5 ) t <span class="hljs-keyword"><span class="hljs-keyword">OPTION</span></span> (MAXDOP <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br>  Jetzt habe ich 1000 Eintr√§ge, in denen in Spalte C2 der Wert 999999999 lautet. Und dies bedeutet definitiv das Problem mit dem aufsteigenden Schl√ºssel, und ich muss die Statistiken wirklich aktualisieren ... auf dem Replikat, damit ich den Hauptserver nicht mit Berechnungen und belastete hinderte ihn daran, Kunden zu bedienen. <br><br>  Lassen Sie uns mit dem guten alten Befehl DBCC SHOW_STATISTICS unsere Statistiken untersuchen. <br><br><pre> <code class="sql hljs">DBCC SHOW_STATISTICS('dbo.SampleDataTable', 'ST_SampleDataTable_C2')</code> </pre> <br><img src="https://habrastorage.org/webt/gm/hx/xv/gmhxxvlklhhluczq_s43u1ejo_o.png"><br>  In unserem K√∂nigreich ist alles perfekt und unsere Statistiken sind in perfekter Reihenfolge, obwohl nur 1 Million Zeilen ber√ºcksichtigt werden und es keine sch√§dlichen tausend Zeilen gibt, die letztendlich Teil dieser Statistiken werden sollten. <br><br>  Wir k√∂nnen den Statistikstrom auch mit dem Parameter STATS_STREAM des Befehls DBCC SHOW_STATISTICS anzeigen: <br><br><pre> <code class="sql hljs">DBCC SHOW_STATISTICS('dbo.SampleDataTable', 'ST_SampleDataTable_C2') <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> STATS_STREAM;</code> </pre> <br><img src="https://habrastorage.org/webt/p8/rt/nc/p8rtncofa5dn602kl7bvexkst0m.png"><br><br>  Es ist nur ein Zeichensatz, √ºber den Blogs seit Jahren schreiben, aber ich bin mir immer noch nicht sicher, ob dies eine vollst√§ndig dokumentierte Funktion ist (obwohl sie die Leute nie davon abgehalten hat, sie zu verwenden). <br><br><h3>  Auf das Stichwort </h3><br>  Kopieren wir unsere Tabelle auf einem Replikat nach tempdb (obwohl sich meine AG im synchronen Modus befindet, kann dasselbe asynchron gemacht werden, nur die Daten k√∂nnen mit einer leichten Verz√∂gerung kommen). <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> TempDB; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> dbo.SampleDataTable; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> dbo.SampleDataTable ( C1 <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, C2 <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_SampleDataTable PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (C1) ); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.SampleDataTable <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> C1, C2 <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> AvGroupDb.dbo.SampleDataTable;</code> </pre> <br>  Jetzt k√∂nnen wir die Statistiken mit einem vollst√§ndigen Scan in tempdb auf dem Replikat aktualisieren. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> TempDB; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> ST_SampleDataTable_C2 <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> dbo.SampleDataTable(C2) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> FULLSCAN;</code> </pre> <br>  ( <i>Anmerkung des √úbersetzers - Nico hat vergessen, Statistiken zu erstellen, und verwendet die falsche Syntax der Operation UPDATE STATISTICS. Anstelle von UPDATE sollte sie CREATE sein, d. H. Die Statistiken werden nicht aktualisiert, sondern erstellt.</i> ) <br><br>  Gehen Sie zur√ºck zu DBCC SHOW_STATISTICS und sehen Sie es sich an: <br><br><pre> <code class="sql hljs">DBCC SHOW_STATISTICS('dbo.SampleDataTable', 'ST_SampleDataTable_C2')</code> </pre> <br><img src="https://habrastorage.org/webt/pg/ai/n7/pgain7_73tket3lziu3h3fopk90.png"><br><br>  Es sieht v√∂llig anders aus als auf dem Hauptserver - nur 3 Zeilen gegen√ºber 178, aber es beschreibt die Daten perfekt - wir haben eine Million eindeutige Zeilen und 1000 Zeilen mit demselben C2-Spaltenwert - das Histogramm ist so gut wie m√∂glich . <br><br>  Schauen wir uns den Statistikfluss an: <br><br><pre> <code class="sql hljs">DBCC SHOW_STATISTICS('dbo.SampleDataTable', 'ST_SampleDataTable_C2') <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> STATS_STREAM;</code> </pre> <br><img src="https://habrastorage.org/webt/04/0u/pz/040upzmtjoezg-ykcnvdvjzzicw.png"><br><br>  Sie m√ºssen kein Genie sein, um zu bemerken, dass der Stream v√∂llig anders aussieht - wir sehen die 5689A0C6-Zeichen im aktualisierten Stream, w√§hrend wir im Original zwischen all diesen Nullen EDF10EB4 sahen. <br><br>  Konzentrieren wir uns darauf, diese Daten in eine Textdatei au√üerhalb von SQL Server zu exportieren, und tun dies mithilfe des wunderbaren BCP-Befehls, f√ºr den CMDSHELL aktiviert sein muss (Hinweis: Sie m√∂chten dies wahrscheinlich nicht auf Ihrem Produktionsserver). <br><br><pre> <code class="sql hljs">EXEC xp_cmdshell 'BCP "DBCC SHOW_STATISTICS(''AvGroupDb.dbo.SampleDataTable'', ''ST_SampleDataTable_C2'') <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> STATS_STREAM<span class="hljs-string"><span class="hljs-string">" queryout \\SharedServer\Tempdb\stats.txt -c -T';</span></span></code> </pre> <br>  Und hier ist, wie gro√ü die Datei stats.txt in unserem Ball sein wird: <br><br><img src="https://habrastorage.org/webt/io/3f/uz/io3fuz8igpsqphnccpgmf_ghxwq.png"><br><br>  Nur ein paar Kilobyte!  Einfach zu √ºbertragen, einfach zu verwalten. <br><br><h3>  Zur√ºck zum Hauptserver </h3><br>  Auf dem Hauptserver m√ºssen wir eine tempor√§re Tabelle erstellen, in der der Statistikstrom gespeichert wird, bevor wir Statistiken daraus in unserer Haupttabelle SampleDataTable aktualisieren k√∂nnen (in der Praxis k√∂nnen wir diese Tabelle f√ºr viele Datenbanken, Tabellen und Statistiken erweitern). <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> dbo.TempStats( Stats_Stream VARBINARY(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">Rows</span></span> <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>, DataPages <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span> );</code> </pre> <br>  Importieren wir die Daten aus unserer Textdatei in unsere neue tempor√§re Tabelle und sehen, was wir importiert haben: <br><br><pre> <code class="sql hljs">BULK <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> dbo.TempStats <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">'\\SharedServer\Tempdb\stats.txt'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.TempStats;</code> </pre> <br><img src="https://habrastorage.org/webt/nd/0h/rk/nd0hrkomoixkorwndcrijcxlzwu.png"><br><br>  Wir k√∂nnen dieselben Daten sehen, die wir auf dem Replikat berechnet haben, aber diese Daten befinden sich bereits auf unserem Hauptserver. Wir m√ºssen nur noch unsere Statistiken in der Tabelle aktualisieren.  Diese Operation kann mit der Operation UPDATE STATISTICS mit dem Parameter WITH STATS_STREAM = ... ausgef√ºhrt werden <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @script <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @script = <span class="hljs-string"><span class="hljs-string">'UPDATE STATISTICS dbo.SampleDataTable(ST_SampleDataTable_C2) WITH STATS_STREAM = '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>), [Stats_Stream],<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.TempStats PRINT @script; <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_executesql @script;</code> </pre> <br>  Dieses Skript liest den oben importierten Wert (ja, ich wei√ü - ich habe dieses Beispiel f√ºr eine Tabelle erstellt und mich nicht mit mehreren Statistiken, Tabellen, Datenbanken usw. befasst), generiert eine UPDATE STATISTICS-Anweisung, zeigt sie auf dem Bildschirm an und am Ende erf√ºllt es. <br>  Folgendes bekomme ich in der Ausgabe: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> dbo.SampleDataTable(ST_SampleDataTable_C2) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> STATS_STREAM =</code> </pre> <br>  Wenn ich DBCC SHOW_STATISTICS auf dem Hauptserver ausf√ºhre, erhalte ich genau das Ergebnis, auf das ich gehofft habe - genau wie auf dem Replikat.  Der Kreis ist geschlossen. <br><pre> <code class="sql hljs">DBCC SHOW_STATISTICS('dbo.SampleDataTable', 'ST_SampleDataTable_C2');</code> </pre> <br>  Der wirklich gro√üartige Teil dieser Geschichte ist, dass die Gr√∂√üe des Objekts mit Statistiken sehr klein ist und wir es sehr einfach / sofort auf den Hauptserver √ºbertragen k√∂nnen. <br><br><h3>  Nicht so einfaches Szenario. </h3><br>  Wenn Sie mehrere AGs zwischen denselben Replikaten haben, wobei ein Replikat das Hauptreplikat in einem AG und das andere das Hauptreplikat in dem zweiten ist, k√∂nnen Sie BLOB-Daten in den Datenstrom zwischen den Replikaten einf√ºgen und eine winzige Datenbank mit den √ºbertragenen Daten hinzuf√ºgen. <br><br><img src="https://habrastorage.org/webt/ua/af/5r/uaaf5rbrsxkxfq1onfcydtzlgbm.png"><br><br>  Schau dir das Bild an.  Wenn wir zwei AGs (AG1 &amp; AG2) haben, die sich auf verschiedenen Servern befinden, und wir eine bestimmte Tabelle auf Server1 in AG1 haben, f√ºr die wir Statistiken aktualisieren m√∂chten, k√∂nnen wir diese Tabelle auf Server2 kopieren (nennen wir sie dbo.MyTable ) In tempdb, aktualisieren und mit AG2 senden Sie das Objekt mit dem Statistik-Stream zur√ºck an Server1, wo Sie einfach Statistiken aus diesem Stream in die ben√∂tigten Statistiken importieren. <br><br>  Ja, ich wei√ü, es klingt verwirrend, aber stellen Sie es sich einfach als einen Feedback-Kanal vor, √ºber den die Ergebnisse geliefert werden, anstatt sie auf Dateib√§lle zu legen. <br><br><h3>  Platz f√ºr Zweifel </h3><br>  Sie k√∂nnen einige Einw√§nde haben, zum Beispiel: <br><br><ul><li>  Warum sollte ich dies auf einem Replikat tun, wenn ich es sicher auf dem Hauptserver tun kann?  (Nun, die Idee ist, den Hauptserver auszulagern) </li><li>  Laden wir das Replikat jedoch m√∂glicherweise nicht (ja, aber wenn es inaktiv ist, m√∂chten wir seine Leistung nutzen). </li><li>  und wir k√∂nnen irgendwie nicht auf dem Hauptserver agieren?  (Nein, wir lesen nur die Daten aus dem Replikat und senden ein paar Kilobyte zur√ºck, was in unserem Jahrhundert Gigabyte und Terabyte wie "shtoa?" klingt.) ( <i>Hinweis √úbersetzer - im Allgemeinen, nur im Fall einer lesbaren Replik AG, k√∂nnen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">wir</a></i> ) </li><li>  Was ist, wenn der Hauptserver mitten im Prozess beginnt, die Statistiken selbst zu aktualisieren?  (In diesem Fall kann entweder der zweite Prozess unterbrochen oder mit den aktualisierten Daten neu gestartet werden.) </li></ul><br><h3>  AG Feedback Kanal </h3><br>  Dies ist ein Kanal mit R√ºckmeldung vom Replikat an den Hauptserver. Nachdem wir die Transaktion in der synchronen AG zugesagt haben, wartet der Hauptserver auf die Best√§tigung durch das Replikat. Ich denke, dass dieser Kanal zur Implementierung dieser Verbesserung verwendet werden kann.  Schauen Sie sich das Bild an, das in einem Beitrag von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Simon Su aufgenommen wurde</a> . <br><br><img src="https://habrastorage.org/webt/hc/my/rk/hcmyrkc1okyfr1byzfvhxexwixy.png"><br><br>  Welches den gesamten Mechanismus des vorhandenen R√ºckkopplungskanals darstellt.  Das Replikat best√§tigt in Schritt 12 und anschlie√üend dem Prim√§rserver, dass die Informationen gespeichert wurden.  Der gleiche Kanal kann verwendet werden, um ein Statistikflussobjekt nach dem Nachz√§hlen auf einem Replikat zu senden.  Nat√ºrlich m√ºssen wir f√ºr diesen Zweck kein Tempdb verwenden, sondern ein In-Memory-Objekt in der Datenbank erstellen, das nicht dauerhaft gespeichert werden soll (sehen Sie sich Ihre In-Memory-OLTP-Schema-Only-Tabellen an oder denken Sie an NOLOGGING-Tabellen in Oracle) sollte am Ende der Operation entfernt werden - das w√§re wirklich cool. <br><br><h3>  Allgemeine Gedanken </h3><br>  Dies sollte nicht davon abh√§ngen, ob das synchrone Replikat - die meisten Zeitstatistiken werden nicht alle paar Sekunden aktualisiert, und dies f√ºhrt uns zum zweiten Teil der Idee - einen Aufruf zum Aktualisieren der Statistiken auf dem Hauptserver mit einem Parameter wie z <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> dbo.MyAwesomeTable(HugeImportantStatOnC17) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> FULLSCAN, SECONDARY</code> </pre> <br>  Dabei gibt der Parameter SECONDARY an, wo die Operation ausgef√ºhrt werden soll. <br>  Und genau wie bei Sicherungen sollten wir in der Lage sein, das bevorzugte Replikat anzugeben, um UPDATE STATISTICS (oder einen anderen Vorgang in der Zukunft) in den Einstellungen auszuf√ºhren. <br><br>  Ich bin sicher, dass diese Funktion viele Enterprise Edition-Benutzer dazu ermutigen wird, auf die neue Version von SQL Server zu migrieren, mit der schwere Vorg√§nge zwischen Replikaten verteilt werden k√∂nnen. <br><br>  Was die aktuelle Situation betrifft, sehe ich genau, wie Sie diese L√∂sung mit Powershell automatisieren k√∂nnen. <br><br>  Microsoft, Sie sind dran!  ;) <br><br>  Stimmen Sie hier f√ºr die vorgeschlagene Funktion <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ab</a> . <br><br>  <i>Anmerkung des √úbersetzers: Vorschl√§ge und Kommentare zu √úbersetzung und Styling sind wie gewohnt willkommen.</i> <i><br><br></i>  <i>Normalerweise habe ich das prim√§re Replikat in der √úbersetzung "prim√§rer Server" und das sekund√§re Replikat - einfach ein Replikat - genannt.</i>  <i>Vielleicht ist das nicht ganz richtig, aber mein Ohr tut weniger weh als die "prim√§ren" und "sekund√§ren" Repliken auf msdn.</i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de462853/">https://habr.com/ru/post/de462853/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de462843/index.html">Einschr√§nkungen von 8-Bit-Spielen und deren genaue Wiederherstellung in Unity</a></li>
<li><a href="../de462845/index.html">Massage f√ºr Ihr Gehirn: Sprechen Sie √ºber ASMR</a></li>
<li><a href="../de462847/index.html">Hewlett Packard Enterprise-Webinare von August bis Oktober 2019</a></li>
<li><a href="../de462849/index.html">Irgendwas mit Inode</a></li>
<li><a href="../de462851/index.html">Wir bieten einen Cloud-Service f√ºr die Verwaltung von Verbrauchsmaterialien (Angular + Firebase).</a></li>
<li><a href="../de462855/index.html">Einfache Programmierung: Kanban-Board f√ºr GitLab an einem Arbeitstag</a></li>
<li><a href="../de462859/index.html">Wie ein europ√§isches Busunternehmen in Russland operiert: Wie unterscheiden sich Busse und Fahrg√§ste?</a></li>
<li><a href="../de462863/index.html">21. August Sendung Zabbix Moscow Meetup # 5</a></li>
<li><a href="../de462867/index.html">Ausw√§hlen eines Farbschemas f√ºr Ihre App: Wie machen Sie es einfach?</a></li>
<li><a href="../de462869/index.html">Agileanisches Projektmanagementsystem</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>