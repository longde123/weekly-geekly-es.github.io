<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title> 葛  Unity3D: Modificar delegado de aplicaci贸n de iOS   </title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Creo que muchos en el proceso de desarrollo de un juego para iOS tuvieron que enfrentar el hecho de que se hace necesario usar una u otra funcionalida...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Unity3D: Modificar delegado de aplicaci贸n de iOS</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/430118/">  Creo que muchos en el proceso de desarrollo de un juego para iOS tuvieron que enfrentar el hecho de que se hace necesario usar una u otra funcionalidad nativa.  Con respecto a Unity3D, pueden surgir muchos problemas en este tema: para implementar alg煤n tipo de caracter铆stica, debe buscar complementos nativos escritos en Objective-C.  Alguien en este momento inmediatamente se desespera y abandona la idea.  Alguien est谩 buscando soluciones preparadas en AssetStore o en foros, esperando que ya exista una soluci贸n preparada.  Si no hay soluciones preparadas, entonces los m谩s persistentes de nosotros no vemos otra manera que sumergirnos en el abismo de la programaci贸n de iOS y la interacci贸n de Unity3D con el c贸digo Objective-C. <br><br>  Quienes elijan el 煤ltimo camino (aunque, creo, ellos mismos lo saben), enfrentar谩n muchos problemas en este camino dif铆cil y espinoso: <br><br><ul><li>  iOS es un ecosistema absolutamente desconocido y aislado, que se desarrolla a su manera.  Como m铆nimo, tendr谩 que pasar mucho tiempo para comprender c贸mo puede llegar a la aplicaci贸n y en qu茅 partes del proyecto Xcode generado autom谩ticamente se encuentra el c贸digo para que el motor Unity3D interact煤e con el componente nativo de la aplicaci贸n. </li><li>  Objective-C es un lenguaje de programaci贸n bastante separado y poco parecido.  Y cuando se trata de interactuar con el c贸digo C ++ de la aplicaci贸n Unity3D, el "dialecto" de este lenguaje, llamado Objective-C ++, entra en escena.  Hay muy poca informaci贸n sobre 茅l, la mayor parte es antigua y de archivo. </li><li>  El protocolo de interacci贸n entre la aplicaci贸n Unity3D y iOS est谩 mal descrito.  Debe confiar 煤nicamente en los tutoriales de los entusiastas de la red que escriben c贸mo desarrollar el complemento nativo m谩s simple.  Al mismo tiempo, pocas personas tocan cuestiones m谩s profundas y problemas derivados de la necesidad de hacer algo complicado. </li></ul><br>  Aquellos que quieran aprender sobre los mecanismos de interacci贸n de Unity3D con una aplicaci贸n iOS, por favor, bajo cat. <br><a name="habracut"></a><br>  Con el fin de aportar m谩s claridad al estrecho cuello de botella de la interacci贸n de Unity3D con el c贸digo nativo, este art铆culo describe los aspectos de interacci贸n de un delegado de aplicaci贸n iOS con c贸digo Unity3D, con el que se implementan las herramientas C ++ y Objective-C, y c贸mo modificar la aplicaci贸n delega usted mismo.  Esta informaci贸n puede ser 煤til tanto para una mejor comprensi贸n de los mecanismos de vinculaci贸n de Unity3D + iOS como para un uso pr谩ctico. <br><br><h3>  Interacci贸n entre iOS y la aplicaci贸n. </h3><br>  Como introducci贸n, veamos c贸mo se implementa la interacci贸n de la aplicaci贸n con el sistema en iOS y viceversa.  Esquem谩ticamente, el lanzamiento de una aplicaci贸n iOS se ve as铆: <br><br><img src="https://habrastorage.org/webt/jd/vm/oi/jdvmoimtygqdsc095abusfopdao.png" alt="imagen"><br><br>  Para estudiar este mecanismo desde el punto de vista del c贸digo, es adecuada una nueva aplicaci贸n creada en Xcode utilizando la plantilla "Aplicaci贸n de vista 煤nica". <br><br><img src="https://habrastorage.org/webt/du/_z/75/du_z75efp4bdgv_fvb02x-mjfis.png"><br><br>  Al elegir esta plantilla, la salida le dar谩 la aplicaci贸n de iOS m谩s simple que puede ejecutarse en un dispositivo o emulador y mostrar una pantalla en blanco.  Xcode crear谩 un proyecto 煤til en el que solo habr谩 5 archivos con c贸digo fuente (2 de ellos ser谩n archivos de encabezado .h) y varios archivos auxiliares que no nos interesan (composici贸n tipogr谩fica, configuraciones, iconos). <br><br><img src="https://habrastorage.org/webt/jt/mz/ov/jtmzov95oshddmprhby9wkqigve.png"><br><br>  Veamos de qu茅 son responsables los archivos de c贸digo fuente: <br><br><ul><li>  <i>ViewController.m</i> / <i>ViewController.h</i> : c贸digos fuente no muy interesantes para nosotros.  Dado que su aplicaci贸n tiene una Vista (que no est谩 representada por c贸digo, sino que usa el Storyboard), necesitar谩 la clase Controlador, que controlar谩 esta Vista.  En general, de esta manera Xcode nos anima a usar el patr贸n MVC.  El proyecto que genera Unity3D no tendr谩 estos archivos fuente. </li><li>  <i>AppDelegate.m</i> / <i>AppDelegate.h</i> es el delegado de su aplicaci贸n.  El punto de inter茅s en la aplicaci贸n donde comienza el trabajo del c贸digo de aplicaci贸n personalizado. </li><li>  <i>main.m</i> : el punto de partida de la aplicaci贸n.  A la manera de cualquier aplicaci贸n C / C ++, contiene la funci贸n principal con la que se inicia el programa. </li></ul><br>  Ahora, veamos el c贸digo que comienza con el archivo <i>main.m</i> : <br><br><pre><code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> main(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> argc, <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * argv[]) { <span class="hljs-comment"><span class="hljs-comment">//1 @autoreleasepool { //2 return UIApplicationMain(argc, argv, nil, NSStringFromClass([AppDelegate class])); // 3 } }</span></span></code> </pre> <br>  Con la l铆nea 1, todo est谩 claro y sin explicaci贸n, pasemos a la l铆nea 2. Indica que el ciclo de vida de la aplicaci贸n ocurrir谩 dentro del grupo de Liberaci贸n autom谩tica.  El uso del grupo de liberaci贸n autom谩tica nos dice que confiaremos la administraci贸n de memoria de la aplicaci贸n a este grupo en particular, es decir, tratar谩 los problemas cuando sea necesario liberar memoria para una variable en particular.  La historia sobre la administraci贸n de memoria en iOS est谩 m谩s all谩 del alcance de esta historia, por lo que no tiene sentido profundizar en este tema.  Para aquellos que est茅n interesados en este tema, pueden encontrar, por ejemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">este art铆culo</a> . <br><br>  Pasemos a la l铆nea 3. Llama a la funci贸n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">UIApplicationMain</a> .  Se le pasan los par谩metros de inicio del programa (argc, argv).  Luego, en esta funci贸n, se indica qu茅 clase usar como la clase principal de la aplicaci贸n, se crea su instancia.  Y, finalmente, se indica qu茅 clase usar como delegado de la aplicaci贸n, se crea su instancia, se configuran las conexiones entre la instancia de la clase de aplicaci贸n y su delegado. <br><br>  En nuestro ejemplo, nil se pasa como la clase que representar谩 la instancia de la aplicaci贸n; en t茅rminos generales, el an谩logo local es nulo.  Adem谩s de nil, puede pasar una clase espec铆fica heredada de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">UIApplication all铆</a> .  Si se especifica nil, se usar谩 la aplicaci贸n UIA.  Esta clase es un punto centralizado para administrar y coordinar el trabajo de una aplicaci贸n en iOS y es un singleton.  Con 茅l, puede aprender casi todo sobre el estado actual de la aplicaci贸n, notificaciones, ventanas, eventos que ocurrieron en el propio sistema que afectan a esta aplicaci贸n y mucho m谩s.  Esta clase casi nunca hereda.  Nos detendremos en la creaci贸n de la clase Delegado de aplicaciones con m谩s detalle. <br><br><h3>  Crear delegado de aplicaci贸n </h3><br>  Una indicaci贸n de qu茅 clase usar como delegado de la aplicaci贸n ocurre en una llamada de funci贸n <br><br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">NSStringFromClass</span></span>([AppDelegate <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>])</code> </pre> <br>  Analicemos esta llamada en partes. <br><br><pre> <code class="objectivec hljs">[AppDelegate <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>]</code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Esta construcci贸n</a> devuelve un objeto de la clase AppDelegate (que se declara en AppDelegate.h / .m), y la funci贸n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">NSStringFromClass</a> devuelve el nombre de la clase como una cadena.  Simplemente pasamos el nombre de cadena de la clase que se crear谩 y utilizar谩 como delegado a la funci贸n UIApplicationMain.  Para una mejor comprensi贸n, la l铆nea 3 en el archivo <i>main.m</i> podr铆a reemplazarse por lo siguiente: <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">UIApplicationMain</span></span>(argc, argv, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-string"><span class="hljs-string">@"AppDelegate"</span></span>);</code> </pre> <br>  Y el resultado de su implementaci贸n ser铆a id茅ntico a la versi贸n original.  Aparentemente, los desarrolladores decidieron adoptar este enfoque para no usar una constante de cadena.  Con un enfoque est谩ndar, si cambia el nombre de una clase delegada, el analizador arrojar谩 inmediatamente un error.  En el caso de utilizar la l铆nea habitual, el c贸digo se compilar谩 correctamente y recibir谩 un error solo al iniciar la aplicaci贸n. <br><br>  Un mecanismo similar para crear una clase, usando solo el nombre de la cadena de la clase, puede recordarle Reflection from C #.  Objective-C y su tiempo de ejecuci贸n son mucho m谩s poderosos que Reflection en C #.  Este es un punto bastante importante en el contexto de este art铆culo, pero tomar铆a mucho tiempo describir todas las caracter铆sticas.  Sin embargo, todav铆a nos encontraremos con "Reflexi贸n" en el Objetivo-C a continuaci贸n.  Queda por comprender el concepto del delegado de la aplicaci贸n y sus funciones. <br><br><h3>  Delegado de aplicaciones </h3><br>  Toda interacci贸n de la aplicaci贸n con iOS ocurre en la clase UIApplication.  Esta clase asume muchas responsabilidades: notifica sobre el origen de los eventos, el estado de la aplicaci贸n y mucho m谩s.  En su mayor parte, su papel es notificar.  Pero cuando algo sucede en el sistema, deber铆amos poder responder de alguna manera a este cambio, para realizar alg煤n tipo de funcionalidad personalizada.  Si una instancia de la clase UIApplication hace esto, esta pr谩ctica comenzar谩 a parecerse a un enfoque llamado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Objeto Divino</a> .  Por lo tanto, vale la pena pensar en liberar a esta clase de parte de sus responsabilidades. <br><br>  Es para estos fines que el ecosistema de iOS usa algo como un delegado de aplicaci贸n.  A partir del nombre en s铆, podemos concluir que estamos tratando con un patr贸n de dise帽o como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Delegaci贸n</a> .  En resumen, simplemente transferimos la responsabilidad del procesamiento de la respuesta a ciertos eventos de la aplicaci贸n al delegado de la aplicaci贸n.  Para este prop贸sito, en nuestro ejemplo, se cre贸 la clase AppDelegate en la que podemos escribir funcionalidades personalizadas, mientras que la clase UIApplication funciona en modo de recuadro negro.  Este enfoque puede parecer controvertido para alguien en t茅rminos de la belleza del dise帽o de la arquitectura, pero los propios autores de iOS nos est谩n empujando a este enfoque y la gran mayor铆a de los desarrolladores (si no todos) lo usan. <br><br>  Para verificar visualmente con qu茅 frecuencia durante el trabajo de la aplicaci贸n, el delegado de la aplicaci贸n recibe un mensaje en particular, eche un vistazo al diagrama: <br><br><img src="https://habrastorage.org/webt/md/61/bc/md61bc9my4focy1suoy5qn9om2s.png" alt="imagen"><br><br>  Los rect谩ngulos amarillos indican las llamadas de uno u otro m茅todo delegado en respuesta a ciertos eventos de la vida de la aplicaci贸n (ciclo de vida de la aplicaci贸n).  Este diagrama ilustra solo eventos relacionados con cambios en el estado de la aplicaci贸n y no refleja muchos otros aspectos de la responsabilidad del delegado, como aceptar notificaciones o interactuar con marcos. <br><br>  Estos son algunos ejemplos en los que podr铆amos necesitar acceso a un delegado de aplicaciones de Unity3D: <br><br><ol><li>  manejo de notificaciones push y locales </li><li>  Registro de eventos de lanzamiento de aplicaciones para an谩lisis </li><li>  determinaci贸n de c贸mo iniciar la aplicaci贸n: "limpiar" o salir del fondo </li><li>  c贸mo se lanz贸 la aplicaci贸n: mediante tach para notificaci贸n, usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">acciones r谩pidas de la pantalla de inicio</a> o simplemente tach en incon </li><li>  interacci贸n con WatchKit o HealthKit </li><li>  abrir y procesar URL desde otra aplicaci贸n.  Si esta URL se aplica a su aplicaci贸n, puede procesarla en su aplicaci贸n en lugar de permitir que el sistema abra esa URL en un navegador </li></ol><br>  Esta no es la lista completa de escenarios.  Adem谩s, vale la pena se帽alar que el delegado modifica muchos sistemas de an谩lisis y publicidad en sus complementos nativos. <br><br><h3>  C贸mo Unity3D implementa un delegado de aplicaci贸n </h3><br>  Veamos ahora el proyecto Xcode generado por Unity3D y descubramos c贸mo se implementa el delegado de aplicaciones en Unity3D.  Al compilar para la plataforma iOS, Unity3D genera autom谩ticamente un proyecto Xcode para usted, que utiliza una gran cantidad de c贸digo repetitivo.  Este c贸digo de plantilla tambi茅n incluye el c贸digo de delegado de aplicaci贸n.  Dentro de cualquier proyecto generado, puede encontrar los archivos <i>UnityAppController.h</i> y <i>UnityAppController.mm</i> .  Estos archivos contienen el c贸digo de la clase UnityAppController que nos interesa. <br><br>  De hecho, Unity3D utiliza una versi贸n modificada de la plantilla "Aplicaci贸n de vista 煤nica".  Solo en esta plantilla, Unity3D usa el delegado de la aplicaci贸n no solo para manejar eventos de iOS, sino tambi茅n para inicializar el motor, preparar componentes gr谩ficos y mucho m谩s.  Esto es muy f谩cil de entender si nos fijamos en el m茅todo. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)application:(<span class="hljs-built_in"><span class="hljs-built_in">UIApplication</span></span>*)application didFinishLaunchingWithOptions:(<span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span>*)launchOptions</code> </pre><br>  en el c贸digo de la clase UnityAppController.  Este m茅todo se llama en el momento de la inicializaci贸n de la aplicaci贸n, cuando puede transferir el control a su c贸digo personalizado.  Dentro de este m茅todo, por ejemplo, puede encontrar las siguientes l铆neas: <br><br><pre> <code class="objectivec hljs">UnityInitApplicationNoGraphics([[[<span class="hljs-built_in"><span class="hljs-built_in">NSBundle</span></span> mainBundle] bundlePath] UTF8String]); [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> selectRenderingAPI]; [UnityRenderingView InitializeForAPI: <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.renderingAPI]; _window = [[<span class="hljs-built_in"><span class="hljs-built_in">UIWindow</span></span> alloc] initWithFrame: [<span class="hljs-built_in"><span class="hljs-built_in">UIScreen</span></span> mainScreen].bounds]; _unityView = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> createUnityView]; [DisplayManager Initialize]; _mainDisplay = [DisplayManager Instance].mainDisplay; [_mainDisplay createWithWindow: _window andView: _unityView]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> createUI]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> preStartUnity];</code> </pre><br>  Sin siquiera entrar en detalles sobre lo que hacen estos desaf铆os, puede adivinar que est谩n relacionados con la preparaci贸n de Unity3D para el trabajo.  Resulta el siguiente escenario: <br><br><ol><li>  La funci贸n principal se llama desde <i>main.mm</i> </li><li>  Se crean las clases de instancia de la aplicaci贸n y su delegado. </li><li>  El delegado de la aplicaci贸n prepara y lanza el motor Unity3D </li><li>  Tu c贸digo personalizado comienza a funcionar.  Si usa il2cpp, su c贸digo se traduce de C # a IL y luego al c贸digo C ++, que ingresa directamente al proyecto Xcode. </li></ol><br>  Este script suena bastante simple y l贸gico, pero trae consigo un problema potencial: 驴c贸mo podemos modificar el delegado de la aplicaci贸n si no tenemos acceso al c贸digo fuente cuando trabajamos en Unity3D? <br><br><h3>  Unity3D afectado para modificar el delegado de la aplicaci贸n </h3><br>  Podemos echar un vistazo a los archivos <i>AppDelegateListener.mm/.h</i> .  Contienen macros que le permiten registrar cualquier clase como escucha de eventos para el delegado de la aplicaci贸n.  Este es un buen enfoque, no necesitamos modificar el c贸digo existente, sino simplemente agregar uno nuevo.  Pero tiene un inconveniente importante: no todos los eventos de aplicaciones son compatibles y no hay forma de obtener informaci贸n sobre el inicio de la aplicaci贸n. <br><br>  La salida m谩s obvia, sin embargo, inaceptable es cambiar el c贸digo fuente del delegado a mano despu茅s de que Unity3D construya el proyecto Xcode.  El problema con este enfoque es obvio: la opci贸n es adecuada si realiza ensamblajes con las manos y no le confunde la necesidad de modificar el c贸digo manualmente despu茅s de cada ensamblaje.  En el caso de usar constructores (Unity Cloud Build o cualquier otra m谩quina de compilaci贸n), esta opci贸n es absolutamente inaceptable.  Para estos prop贸sitos, los desarrolladores de Unity3D nos dejaron un vac铆o legal. <br><br>  El archivo <i>UnityAppController.h</i> , adem谩s de declarar variables y m茅todos, tambi茅n contiene una definici贸n de macro: <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#define IMPL_APP_CONTROLLER_SUBCLASS(ClassName) ...</span></span></code> </pre> <br>  Esta macro solo permite anular el delegado de la aplicaci贸n.  Para hacer esto, debe seguir algunos pasos simples: <br><br><ol><li>  Escriba su propio delegado de aplicaci贸n en Objective-C </li><li>  En alg煤n lugar dentro del c贸digo fuente, agregue la siguiente l铆nea <pre> <code class="objectivec hljs">IMPL_APP_CONTROLLER_SUBCLASS(___)</code> </pre> </li><li>  Coloque esta fuente dentro de la carpeta Plugins / iOS de su proyecto Unity3D </li></ol><br>  Ahora recibir谩 un proyecto en el que el delegado de la aplicaci贸n Unity3D est谩ndar ser谩 reemplazado por uno personalizado. <br><br><h3>  驴C贸mo funciona la macro de reemplazo de delegado? </h3><br>  Veamos el c贸digo fuente completo de la macro: <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#define IMPL_APP_CONTROLLER_SUBCLASS(ClassName) ... @interface ClassName(OverrideAppDelegate) \ { \ } \ +(void)load; \ @end \ @implementation ClassName(OverrideAppDelegate) \ +(void)load \ { \ extern const char* AppControllerClassName; \ AppControllerClassName = #ClassName; \ } \ @end</span></span></code> </pre> <br>  El uso de esta macro en su fuente agregar谩 el c贸digo descrito en la macro al cuerpo de su fuente en la etapa de compilaci贸n.  Esta macro hace lo siguiente.  Primero, agregar谩 el m茅todo de carga a la interfaz de su clase.  Una interfaz en el contexto de Objective-C puede considerarse como una colecci贸n de campos y m茅todos p煤blicos.  En C #, aparecer谩 un m茅todo de carga est谩tica en su clase que no devuelve nada.  A continuaci贸n, la implementaci贸n de este m茅todo de carga se agregar谩 al c贸digo de su clase.  En este m茅todo, se declarar谩 la variable AppControllerClassName, que es una matriz de tipo char y luego se le asignar谩 un valor a esta variable.  Este valor es el nombre de la cadena de su clase.  Obviamente, esta informaci贸n no es suficiente para comprender el mecanismo de operaci贸n de esta macro, por lo tanto, debemos entender qu茅 es este m茅todo de "carga" y por qu茅 se declara una variable. <br><br>  La <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci贸n oficial</a> dice que cargar es un m茅todo especial que se llama una vez para cada clase (espec铆ficamente la clase, no sus instancias) en la etapa inicial del lanzamiento de la aplicaci贸n, incluso antes de que se llame a la funci贸n principal.  El entorno de tiempo de ejecuci贸n Objective-c (tiempo de ejecuci贸n) al inicio de la aplicaci贸n registrar谩 todas las clases que se utilizar谩n durante la operaci贸n de la aplicaci贸n y llamar谩 al m茅todo de carga, si se implementa.  Resulta que incluso antes del inicio de cualquier c贸digo en nuestra aplicaci贸n, la variable AppControllerClassName se agregar谩 a su clase. <br><br>  Entonces podr铆a pensar: "驴Y cu谩l es el punto de tener esta variable si se declara dentro del m茅todo y se eliminar谩 de la memoria cuando salga de este m茅todo?".  La respuesta a esta pregunta se encuentra un poco m谩s all谩 de los l铆mites de Objective-C. <br><br><h3>  驴Y d贸nde est谩 C ++? </h3><br>  Echemos otro vistazo a la declaraci贸n de esta variable. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* AppControllerClassName;</code> </pre> <br>  Lo 煤nico que puede ser incomprensible en esta declaraci贸n es el modificador externo.  Si intenta utilizar este modificador en Objective-C puro, Xcode arrojar谩 un error.  El hecho es que este modificador no es parte de Objective-C; se implementa en C ++.  Objective-C puede describirse de manera muy sucinta diciendo que es "lenguaje C con clases".  Es una extensi贸n del lenguaje C y permite el uso ilimitado del c贸digo C intercalado con el c贸digo Objective-C. <br><br>  Sin embargo, para usar funciones externas y otras de C ++, debe hacer alg煤n truco: use Objective-C ++.  Pr谩cticamente no hay informaci贸n sobre este lenguaje, debido al hecho de que es solo el c贸digo Objective-C que permite la inserci贸n del c贸digo C ++.  Para que el compilador considere que alg煤n archivo fuente debe compilarse como Objective-C ++, y no Objective-C, solo necesita cambiar la extensi贸n de este archivo de <i>.m</i> a <i>.mm</i> . <br><br>  El modificador externo en s铆 mismo se usa para declarar una variable global.  M谩s precisamente, para decirle al compilador "Cr茅eme, tal variable existe, pero la memoria para ella no fue asignada aqu铆, sino en otra fuente.  Y ella tambi茅n tiene un valor, te lo garantizo.  Por lo tanto, nuestra l铆nea de c贸digo simplemente crea una variable global y almacena el nombre de nuestra clase personalizada en ella.  Solo queda entender d贸nde se puede usar esta variable. <br><br><h3>  Volver a la p谩gina principal </h3><br>  Recordamos lo que se dijo anteriormente: el delegado de la aplicaci贸n se crea especificando el nombre de la clase.  Si en una plantilla Xcode de proyecto normal se cre贸 un delegado utilizando el valor constante [clase myClass], entonces, aparentemente, los chicos de Unity decidieron que este valor deber铆a estar envuelto en una variable.  Usando el m茅todo de empuje cient铆fico, tomamos el proyecto Xcode generado por Unity3D y vamos al archivo <i>main.mm.</i> <br><br>  En 茅l vemos un c贸digo m谩s complejo que antes, falta parte de este c贸digo como innecesario: <br><br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">// WARNING: this MUST be c decl (NSString ctor will be called after +load, so we cant really change its value) const char* AppControllerClassName = "UnityAppController"; int main(int argc, char* argv[]) { ... UIApplicationMain(argc, argv, nil, [NSString stringWithUTF8String: AppControllerClassName]); } return 0; }</span></span></code> </pre> <br>  Aqu铆 vemos la declaraci贸n de esta muy variable, y la creaci贸n del delegado de la aplicaci贸n con su ayuda. <br>  Si creamos un delegado personalizado, entonces la variable necesaria existe y ya importa: el nombre de nuestra clase.  Declarar e inicializar la variable antes de la funci贸n principal garantiza que tenga un valor predeterminado: UnityAppController. <br><br>  Ahora con esta decisi贸n todo deber铆a quedar muy claro. <br><br><h3>  Problema macro </h3><br>  Por supuesto, para la gran mayor铆a de las situaciones, usar esta macro es una gran soluci贸n.  Pero vale la pena se帽alar que hay un gran obst谩culo: no puede tener m谩s de un delegado personalizado.  Esto sucede porque si 2 o m谩s clases usan la macro IMPL_APP_CONTROLLER_SUBCLASS (ClassName), entonces para la primera de ellas se asignar谩 el valor de la variable que necesitamos y se ignorar谩n otras asignaciones.  Y esta variable es una cadena, es decir, no se le puede asignar m谩s de un valor. <br><br>  Puede pensar que este problema es degenerado y poco probable en la pr谩ctica.  Pero este art铆culo no habr铆a sucedido si tal problema no hubiera ocurrido realmente, e incluso en circunstancias muy extra帽as.  La situaci贸n puede ser la siguiente.  Tiene un proyecto en el que utiliza muchos servicios de an谩lisis y publicidad.  Muchos de estos servicios tienen componentes Objective-C.  Han estado en su proyecto durante mucho tiempo y no conoce los problemas con ellos.  Aqu铆 debe escribir un delegado personalizado.  Utiliza una macro m谩gica dise帽ada para salvarte de problemas, crear un proyecto y obtener un informe sobre el 茅xito del ensamblaje.  Ejecute el proyecto en el dispositivo y su funcionalidad no funcionar谩 y no recibir谩 un solo error. <br><br>  Y puede ser que uno de los complementos de publicidad o an谩lisis use la misma macro.  Por ejemplo, en el complemento de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">AppsFlyer</a> se usa esta macro. <br><br><h3>  驴Cu谩l es el valor de la variable externa en el caso de declaraciones m煤ltiples? </h3><br>  Es interesante entender si la misma variable externa se declara en varios archivos y se inicializan a la manera de nuestra macro (en el m茅todo de carga), entonces 驴c贸mo podemos entender qu茅 valor tomar谩 la variable?  Para comprender el patr贸n, se cre贸 una aplicaci贸n de prueba simple, cuyo c贸digo se puede encontrar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu铆</a> . <br><br>  La esencia de la aplicaci贸n es simple.  Hay 2 clases A y B, en ambas clases se declara la variable externa AexternVar, se le asigna un valor espec铆fico.  Los valores de la variable en las clases se establecen de manera diferente.  En la funci贸n principal, se registra el valor de esta variable.  Se encontr贸 experimentalmente que el valor de la variable depende del orden en que se agregan las fuentes al proyecto.  El orden en que el tiempo de ejecuci贸n de Objective-C registra las clases durante la ejecuci贸n de la aplicaci贸n depende de esto.  Si desea repetir el experimento, abra el proyecto y seleccione la pesta帽a Construir fases en la configuraci贸n del proyecto.  Como el proyecto es de prueba y peque帽o, solo tiene 8 c贸digos fuente.  Todos ellos est谩n presentes en la pesta帽a Fases de compilaci贸n en la lista de fuentes de compilaci贸n. <br><br><img src="https://habrastorage.org/webt/oi/ly/ln/oilylnhxdyjg3cvgcrj5nzhjvwy.png"><br><br>  Si en esta lista la fuente de la clase A es m谩s alta que la fuente de la clase B, entonces la variable tomar谩 un valor de la clase B. De lo contrario, la variable tomar谩 un valor de la clase A. <br><br>  Solo imagine cu谩ntos problemas puede causar esto te贸ricamente es un peque帽o matiz.  Especialmente si el proyecto es enorme, se genera autom谩ticamente y no sabe en qu茅 clases se declara dicha variable. <br><br><h3>  Resoluci贸n de problemas </h3><br>  Anteriormente en el art铆culo, se dijo que Objective-C dar谩 un buen comienzo a C # Reflection.  Espec铆ficamente, para resolver nuestro problema, puede usar el mecanismo llamado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">M茅todo Swizzling</a> .  La esencia de este mecanismo es que tenemos la oportunidad de reemplazar la implementaci贸n de un m茅todo de cualquier clase con otro durante la aplicaci贸n.  Por lo tanto, podemos reemplazar el m茅todo de inter茅s en UnityAppController con uno personalizado.  Tomamos la implementaci贸n existente y complementamos el c贸digo que necesitamos.  Estamos escribiendo c贸digo que reemplaza la implementaci贸n existente del m茅todo con la que necesitamos.  Durante el trabajo de la aplicaci贸n, el delegado que usa la macro funcionar谩 como antes, invocando la implementaci贸n b谩sica de UnityAppController, y all铆 nuestro m茅todo personalizado entrar谩 en juego y lograremos el resultado deseado.  Este enfoque est谩 bien escrito e ilustrado en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">este art铆culo</a> .  Con esta t茅cnica, podemos hacer una clase auxiliar, un an谩logo de un delegado personalizado.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En esta clase, escribiremos todo el c贸digo personalizado, haciendo de la clase personalizada una especie de Wrapper para llamar a la funcionalidad de otras clases. </font><font style="vertical-align: inherit;">Este enfoque funcionar谩, pero es extremadamente impl铆cito debido al hecho de que es dif铆cil rastrear d贸nde se reemplaza el m茅todo y qu茅 consecuencias tendr谩.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Otra soluci贸n al problema. </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El aspecto principal del problema que sucedi贸 es que hay muchos delegados personalizados, o solo puede tener uno, o reemplazarlo parcialmente por un segundo. </font><font style="vertical-align: inherit;">Al mismo tiempo, no hay forma de asegurarse de que el c贸digo de los delegados personalizados no se arrastre a diferentes archivos de origen. </font><font style="vertical-align: inherit;">Resulta que la situaci贸n se puede considerar como una referencia cuando solo hay un delegado en la aplicaci贸n, debe poder crear clases personalizadas tantas como desee, mientras que ninguna de estas clases usa la macro para evitar problemas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La cosa es peque帽a, queda por determinar c贸mo se puede hacer esto usando Unity3D, mientras se deja la capacidad de construir un proyecto usando una m谩quina de construcci贸n. </font><font style="vertical-align: inherit;">El algoritmo de soluci贸n es el siguiente:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Escribimos delegados personalizados en la cantidad requerida, dividiendo la l贸gica de los complementos en diferentes clases, observando los principios de SOLID y no recurriendo a la sofisticaci贸n. </font></font></li><li>       UnityAppController   XCode      .         UnityAppController   . </li><li>    UnityAppController     Unity . </li><li>     XCode     UnityAppController  ,       </li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El elemento m谩s dif铆cil de esta lista es, sin duda, el 煤ltimo. Sin embargo, esta caracter铆stica se puede implementar en Unity3D utilizando el script de compilaci贸n posterior al proceso. Tal gui贸n fue escrito una noche hermosa, puedes verlo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este postproceso es bastante f谩cil de usar, el铆jalo en un proyecto de Unity. Mire en la ventana del Inspector y vea un campo llamado NewDelegateFile. Arrastre y suelte su UnityAppController modificado en este campo y gu谩rdelo.</font></font><br><br><img src="https://habrastorage.org/webt/zs/sb/l2/zssbl2ttito42xsbqwcpqzqfezs.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al construir un proyecto de iOS, el delegado est谩ndar ser谩 reemplazado por uno modificado, y no se requiere intervenci贸n manual. </font><font style="vertical-align: inherit;">Ahora, al agregar nuevos delegados personalizados al proyecto, solo necesita modificar la opci贸n UnityAppController en su proyecto Unity.</font></font><br><br><h4>  PS </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gracias a todos los que llegaron al final, el art铆culo realmente result贸 ser extremadamente largo. </font><font style="vertical-align: inherit;">Espero que la informaci贸n pintada sea 煤til.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es430118/">https://habr.com/ru/post/es430118/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es430106/index.html">Nuevo en XYZprinting en IMTS 2018: impresoras 3D y robots</a></li>
<li><a href="../es430108/index.html">驴Por qu茅 el "joven t茅cnico" no podr谩 construir un l谩ser?</a></li>
<li><a href="../es430112/index.html">C贸mo ense帽amos a un autom贸vil a hablar con millones de personas</a></li>
<li><a href="../es430114/index.html">C贸mo crear mec谩nicas de juego confiables en Excel. Parte 2</a></li>
<li><a href="../es430116/index.html">Las computadoras escriben en prosa, pero siguen siendo inferiores a las personas. Por qu茅</a></li>
<li><a href="../es430120/index.html">Domar a la bestia. Lo que enfrentamos al desarrollar una aplicaci贸n de diario personal en React Native</a></li>
<li><a href="../es430122/index.html">La adicci贸n al trabajo es una condici贸n dolorosa de la que no es costumbre hablar.</a></li>
<li><a href="../es430126/index.html">Otra lista de proyectos para practicar</a></li>
<li><a href="../es430128/index.html">Desarrollo a trav茅s de pruebas: mejora de habilidades</a></li>
<li><a href="../es430132/index.html">Lo que aprendimos sobre la seguridad de Intel ME en los 煤ltimos a帽os: 7 datos sobre el misterioso subsistema</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>