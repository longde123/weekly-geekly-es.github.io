<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§º üë¶üèæ ü•ö Validierung in Java-Anwendungen üà∂ üë©‚Äç‚ù§Ô∏è‚Äçüë® üò¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dieser Text widmet sich verschiedenen Ans√§tzen zur Datenvalidierung: Auf welche Fallstricke kann ein Projekt sto√üen und welche Methoden und Technologi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Validierung in Java-Anwendungen</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/haulmont/blog/427543/"><p>  <em>Dieser Text widmet sich verschiedenen Ans√§tzen zur Datenvalidierung: Auf welche Fallstricke kann ein Projekt sto√üen und welche Methoden und Technologien sollten bei der Validierung von Daten in Java-Anwendungen angewendet werden.</em> </p><br><p><img src="https://habrastorage.org/webt/cj/yc/yj/cjycyj3zf_l1ai9ch_vsgzisstk.png" alt="Validierung"></p><br><p>  Ich habe oft Projekte gesehen, deren Entwickler sich nicht die M√ºhe gemacht haben, einen Ansatz zur Datenvalidierung zu w√§hlen.  Die Teams arbeiteten unter unglaublichem Druck in Form von Fristen und vagen Anforderungen an dem Projekt und hatten daher einfach keine Zeit f√ºr eine genaue und konsistente Validierung.  Daher ist ihr Validierungscode √ºberall verstreut: in Javascript-Snippets, Bildschirmcontrollern, in Gesch√§ftslogik-Bins, Dom√§nenentit√§ten, Triggern und Datenbankeinschr√§nkungen.  Dieser Code war voll von if-else-Anweisungen, es gab eine Reihe von Ausnahmen und es wurde versucht herauszufinden, wo diese bestimmten Daten dort validiert sind. Infolgedessen wird es im Verlauf des Projekts schwierig und teuer, die Anforderungen zu erf√ºllen (oft recht verwirrend) Einheitlichkeit der Ans√§tze zur Datenvalidierung. </p><br><p>  Gibt es also eine einfache und elegante M√∂glichkeit, Daten zu validieren?  Gibt es einen Weg, der uns vor der S√ºnde der Unlesbarkeit sch√ºtzt, der die gesamte Logik der Validierung zusammenfasst und der bereits von Entwicklern beliebter Java-Frameworks f√ºr uns entwickelt wurde? </p><br><p>  Ja, so gibt es. </p><a name="habracut"></a><br><p>  F√ºr uns, die Entwickler <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">der CUBA-Plattform</a> , ist es sehr wichtig, dass Sie die Best Practices verwenden k√∂nnen.  Wir glauben, dass der Validierungscode: </p><br><ol><li>  Wiederverwendbar sein und dem DRY-Prinzip folgen; </li><li>  Sei nat√ºrlich und verst√§ndlich; </li><li>  Platziert dort, wo der Entwickler es erwartet; </li><li>  Sie k√∂nnen Daten aus verschiedenen Quellen √ºberpr√ºfen: Benutzeroberfl√§che, SOAP-Aufrufe, REST usw. </li><li>  Arbeiten Sie problemlos in einer Umgebung mit mehreren Threads. </li><li>  Wird innerhalb der Anwendung automatisch aufgerufen, ohne dass √úberpr√ºfungen manuell ausgef√ºhrt werden m√ºssen. </li><li>  Um dem Benutzer klare, lokalisierte Nachrichten in √ºbersichtlichen Dialogfeldern zu geben; </li><li>  Befolgen Sie die Standards. </li></ol><br><p>  Lassen Sie uns sehen, wie dies mithilfe einer Beispielanwendung implementiert werden kann, die mit dem CUBA Platform Framework geschrieben wurde.  Da CUBA jedoch auf Spring und EclipseLink basiert, funktionieren die meisten der hier verwendeten Techniken auf jeder anderen Java-Plattform, die die JPA- und Bean-Validierungsspezifikationen unterst√ºtzt. </p><br><h2 id="validaciya-s-ispolzovaniem-database-constraints">  Validierung unter Verwendung von Datenbankeinschr√§nkungen </h2><br><p> Die wahrscheinlich h√§ufigste und naheliegendste Methode zur Validierung von Daten besteht darin, Einschr√§nkungen auf Datenbankebene zu verwenden, z. B. das erforderliche Flag (f√ºr Felder, deren Wert nicht leer sein darf), die Zeilenl√§nge, eindeutige Indizes usw.  Diese Methode eignet sich am besten f√ºr Unternehmensanwendungen, da diese Art von Software normalerweise ausschlie√ülich auf die Datenverarbeitung ausgerichtet ist.  Selbst hier machen Entwickler jedoch h√§ufig Fehler, indem sie die Grenzwerte f√ºr jede Ebene der Anwendung separat festlegen.  Meistens liegt der Grund in der Verteilung der Verantwortlichkeiten zwischen den Entwicklern. </p><br><p>  Stellen Sie sich ein Beispiel vor, das die meisten von uns kennen, einige sogar aus eigener Erfahrung ... Wenn die Spezifikation besagt, dass das Feld f√ºr die Passnummer 10 Zeichen enthalten sollte, wird dies h√∂chstwahrscheinlich von allen √ºberpr√ºft: einem DB-Architekten in DDL, einem Backend-Entwickler in der entsprechenden Entit√§t und REST-Services und schlie√ülich der UI-Entwickler direkt auf der Client-Seite.  Dann √§ndert sich diese Anforderung und das Feld wird auf 15 Zeichen erh√∂ht.  Devops √§ndern die Einschr√§nkungswerte in der Datenbank, aber nichts √§ndert sich f√ºr den Benutzer, da auf der Clientseite die Einschr√§nkung dieselbe ist ... </p><br><p>  Jeder Entwickler wei√ü, wie er dieses Problem vermeiden kann - die Validierung muss zentralisiert werden!  In CUBA befindet sich eine solche Validierung in JPA-Entit√§tsanmerkungen.  Basierend auf diesen Metainformationen generiert CUBA Studio das richtige DDL-Skript und wendet die entsprechenden clientseitigen Validatoren an. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/118/a16/f17/118a16f1705740a1676eb2c0ea164ef4.png" alt="Beispiel f√ºr Interessationen"></p><br><p>  Wenn sich die Anmerkungen √§ndern, aktualisiert CUBA die DDL-Skripts und generiert die Migrationsskripts. Wenn Sie das Projekt das n√§chste Mal bereitstellen, werden neue JPA-basierte Einschr√§nkungen sowohl in der Benutzeroberfl√§che als auch in der Anwendungsdatenbank wirksam. </p><br><p> Trotz der Einfachheit und Implementierung auf Datenbankebene, die dieser Methode absolute Zuverl√§ssigkeit verleiht, ist der Umfang der JPA-Annotationen auf die einfachsten F√§lle beschr√§nkt, die im DDL-Standard ausgedr√ºckt werden k√∂nnen und keine Datenbankausl√∂ser oder gespeicherten Prozeduren enthalten.  JPA-basierte Einschr√§nkungen k√∂nnen daher ein Entit√§tsfeld eindeutig oder obligatorisch machen oder eine maximale Spaltenl√§nge festlegen.  Mit der Annotation <code>@UniqueConstraint</code> k√∂nnen Sie sogar eine eindeutige Einschr√§nkung f√ºr die Kombination von Spalten <code>@UniqueConstraint</code> .  Aber das ist wahrscheinlich alles. </p><br><p>  Wie auch immer, in F√§llen, in denen eine komplexere Validierungslogik erforderlich ist, z. B. das √úberpr√ºfen eines Felds auf einen minimalen / maximalen Wert, das Validieren mit einem regul√§ren Ausdruck oder das Durchf√ºhren einer benutzerdefinierten Pr√ºfung, die nur f√ºr Ihre Anwendung spezifisch ist, wird der als <strong>"Bean Validation"</strong> bekannte Ansatz angewendet . </p><br><h2 id="bean-validation">  Bean-Validierung </h2><br><p>  Jeder wei√ü, dass es empfehlenswert ist, Standards mit einem langen Lebenszyklus zu befolgen, deren Wirksamkeit in Tausenden von Projekten nachgewiesen wurde.  Java Bean Validation ist ein in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">JSR 380, 349 und 303</a> und ihren Anwendungen dokumentierter Ansatz: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Hibernate Validator</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Apache BVal</a> . </p><br><p>  Obwohl dieser Ansatz vielen Entwicklern bekannt ist, wird er h√§ufig untersch√§tzt.  Dies ist eine einfache M√∂glichkeit, die Datenvalidierung auch in √§ltere Projekte einzubetten, sodass Sie Validierungen klar, einfach, zuverl√§ssig und so nah wie m√∂glich an der Gesch√§ftslogik erstellen k√∂nnen. </p><br><p>  Die Verwendung der Bean-Validierung bietet dem Projekt viele Vorteile: </p><br><ul><li>  Die Validierungslogik befindet sich neben dem Themenbereich: Die Definition der Einschr√§nkungen f√ºr die Felder und Methoden des Bin erfolgt auf nat√ºrliche und wirklich objektorientierte Weise. </li><li>  Der Bean-Validierungsstandard bietet uns <code>@NotNull</code> Dutzende von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Validierungsanmerkungen</a> , zum Beispiel: <code>@NotNull</code> , <code>@Size</code> , <code>@Min</code> , <code>@Max</code> , <code>@Pattern</code> , <code>@Email</code> , <code>@Past</code> , nicht ganz Standard <code>@URL</code> , <code>@Length</code> , das leistungsst√§rkste <code>@ScriptAssert</code> und viele andere . </li><li>  Der Standard beschr√§nkt uns nicht auf vorgefertigte Anmerkungen und erm√∂glicht es uns, eigene zu erstellen.  Wir k√∂nnen auch eine neue Annotation erstellen, indem wir mehrere andere kombinieren, oder sie mithilfe einer separaten Java-Klasse als Validator definieren. <br>  Im obigen Beispiel k√∂nnen wir beispielsweise die <code>@ValidPassportNumber</code> Klasse <code>@ValidPassportNumber</code> , um zu √ºberpr√ºfen, ob die Passnummer dem Format entspricht, abh√§ngig vom Wert des <code>@ValidPassportNumber</code> . </li><li>  Einschr√§nkungen k√∂nnen nicht nur f√ºr Felder oder Klassen festgelegt werden, sondern auch f√ºr Methoden und deren Parameter.  Dieser Ansatz wird als <strong>"vertragliche Validierung" bezeichnet</strong> und etwas sp√§ter er√∂rtert. </li></ul><br><p>  Wenn der Benutzer die eingegebenen Informationen √ºbermittelt, startet die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">CUBA-Plattform</a> <em>(wie einige andere Frameworks)</em> die Bean-Validierung automatisch, sodass sofort eine Fehlermeldung angezeigt wird, wenn die Validierung fehlschl√§gt und die Bin-Validatoren nicht manuell ausgef√ºhrt werden m√ºssen. </p><br><p>  Kehren wir zum Beispiel mit der Passnummer zur√ºck, aber dieses Mal werden wir es durch einige Einschr√§nkungen der Entit√§t Person erg√§nzen: </p><br><ul><li>  Das Namensfeld muss aus 2 oder mehr Zeichen bestehen und g√ºltig sein.  (Wie Sie sehen k√∂nnen, ist Regexp nicht einfach, aber "Charles Ogier de Batz de Castelmore Comte d'Artagnan" wird den Test bestehen, "R2D2" jedoch nicht); </li><li>  <code>height</code> (H√∂he) sollte im folgenden Intervall liegen: <code>0 &lt; height &lt;= 300</code> cm; </li><li>  Das <code>email</code> Feld muss eine Zeichenfolge enthalten, die dem Format der richtigen E-Mail entspricht. </li></ul><br><p>  Bei all diesen √úberpr√ºfungen sieht die Person-Klasse folgenderma√üen aus: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Listeners</span></span>(<span class="hljs-string"><span class="hljs-string">"passportnumber_PersonEntityListener"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@NamePattern</span></span>(<span class="hljs-string"><span class="hljs-string">"%s|name"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(name = <span class="hljs-string"><span class="hljs-string">"PASSPORTNUMBER_PERSON"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Entity</span></span>(name = <span class="hljs-string"><span class="hljs-string">"passportnumber$Person"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ValidPassportNumber</span></span>(groups = {Default.class, UiCrossFieldChecks.class}) <span class="hljs-meta"><span class="hljs-meta">@FraudDetectionFlag</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StandardEntity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> serialVersionUID = -<span class="hljs-number"><span class="hljs-number">9150857881422152651L</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Pattern</span></span>(message = <span class="hljs-string"><span class="hljs-string">"Bad formed person name: ${validatedValue}"</span></span>, regexp = <span class="hljs-string"><span class="hljs-string">"^[AZ][az]*(\\s(([az]{1,3})|(([az]+\\')?[AZ][az]*)))*$"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Length</span></span>(min = <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-meta"><span class="hljs-meta">@NotNull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"NAME"</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String name; <span class="hljs-meta"><span class="hljs-meta">@Email</span></span>(message = <span class="hljs-string"><span class="hljs-string">"Email address has invalid format: ${validatedValue}"</span></span>, regexp = <span class="hljs-string"><span class="hljs-string">"^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\\.[a-zA-Z0-9-.]+$"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"EMAIL"</span></span>, length = <span class="hljs-number"><span class="hljs-number">120</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String email; <span class="hljs-meta"><span class="hljs-meta">@DecimalMax</span></span>(message = <span class="hljs-string"><span class="hljs-string">"Person height can not exceed 300 centimeters"</span></span>, value = <span class="hljs-string"><span class="hljs-string">"300"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@DecimalMin</span></span>(message = <span class="hljs-string"><span class="hljs-string">"Person height should be positive"</span></span>, value = <span class="hljs-string"><span class="hljs-string">"0"</span></span>, inclusive = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"HEIGHT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> BigDecimal height; <span class="hljs-meta"><span class="hljs-meta">@NotNull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"COUNTRY"</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> Integer country; <span class="hljs-meta"><span class="hljs-meta">@NotNull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"PASSPORT_NUMBER"</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, length = <span class="hljs-number"><span class="hljs-number">15</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String passportNumber; ... }</code> </pre> <br><p>  <a href="">Person.java</a> </p><br><p>  Ich glaube, dass die Verwendung von Anmerkungen wie <code>@NotNull</code> , <code>@DecimalMin</code> , <code>@Length</code> , <code>@Pattern</code> und dergleichen ziemlich offensichtlich ist und keine Kommentare erfordert.  Schauen wir uns die Implementierung der Annotation <code>@ValidPassportNumber</code> genauer an. </p><br><p>  Unsere brandneue <code>@ValidPassportNumber</code> √ºberpr√ºft, ob <code>Person#passportNumber</code> mit dem regul√§ren Ausdrucksmuster f√ºr jedes Land √ºbereinstimmt, das im Feld <code>Person#country</code> ist. </p><br><p>  Schauen wir uns zun√§chst die Dokumentation an (die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">CUBA-</a> oder <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Hibernate-</a> Handb√ºcher sind in Ordnung). <code>UiCrossFieldChecks.class</code> m√ºssen wir unsere Klasse mit dieser neuen Annotation markieren und den <code>UiCrossFieldChecks.class</code> an sie √ºbergeben. <code>UiCrossFieldChecks.class</code> bedeutet, dass diese Validierung am <code>UiCrossFieldChecks.class</code> sollte Validierungen - Nachdem alle einzelnen Felder √ºberpr√ºft wurden und <code>Default.class</code> die Einschr√§nkung in der Standardvalidierungsgruppe speichert. </p><br><p>  Die Beschreibung der Anmerkungen sieht folgenderma√üen aus: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Target</span></span>(ElementType.TYPE) <span class="hljs-meta"><span class="hljs-meta">@Retention</span></span>(RetentionPolicy.RUNTIME) <span class="hljs-meta"><span class="hljs-meta">@Constraint</span></span>(validatedBy = ValidPassportNumberValidator.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> ValidPassportNumber { <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> "Passport number is not valid"</span></span>; Class&lt;?&gt;[] groups() <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> {}; Class&lt;? extends Payload&gt;[] payload() <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> {}; }</code> </pre> <br><p>  <a href="">ValidPassportNumber.java</a> </p><br><p>  Hier gibt <code>@Target(ElementType.TYPE)</code> , dass der Zweck dieser Laufzeitanmerkung die Klasse ist, und <code>@Constraint(validatedBy = ‚Ä¶ )</code> bestimmt, dass die Validierung von der <code>ValidPassportNumberValidator</code> Klasse durchgef√ºhrt wird, die die <code>ConstraintValidator&lt;...&gt;</code> -Schnittstelle implementiert.  Der Validierungscode selbst befindet sich in der Methode <code>isValid(...)</code> , mit der die eigentliche √úberpr√ºfung auf recht einfache Weise durchgef√ºhrt wird: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValidPassportNumberValidator</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConstraintValidator</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValidPassportNumber</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ValidPassportNumber constraint)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isValid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Person person, ConstraintValidatorContext context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (person == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (person.country == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || person.passportNumber == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> doPassportNumberFormatCheck(person.getCountry(), person.getPassportNumber()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doPassportNumberFormatCheck</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CountryCode country, String passportNumber)</span></span></span><span class="hljs-function"> </span></span>{ ... } }</code> </pre> <br><p>  <a href="">ValidPassportNumberValidator.java</a> </p><br><p>  Das ist alles.  Mit der CUBA-Plattform m√ºssen wir nur eine Codezeile schreiben, damit unsere benutzerdefinierte Validierung funktioniert und dem Benutzer Fehlermeldungen angezeigt werden. <br>  Nichts kompliziertes, oder? </p><br><p>  Nun wollen wir sehen, wie alles funktioniert.  Hier hat CUBA andere Nishtyaki: Es zeigt dem Benutzer nicht nur eine Fehlermeldung an, sondern hebt auch in roten Feldern hervor, die die Bean-Validierung nicht bestanden haben: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/310/83d/b2b/31083db2b14d67d88de169542b59748a.png" alt="UI-Darstellung"></p><br><p>  Ist das nicht eine elegante L√∂sung?  Sie erhalten eine angemessene Anzeige von Validierungsfehlern in der Benutzeroberfl√§che, indem Sie den Entit√§ten des Themenbereichs nur einige Java-Anmerkungen hinzuf√ºgen. </p><br><p>  Um den Abschnitt zusammenzufassen, lassen Sie uns noch einmal kurz die Vorteile der Bean-Validierung f√ºr Entit√§ten auflisten: </p><br><ol><li>  Es ist verst√§ndlich und lesbar; </li><li>  Erm√∂glicht das Definieren von Werteinschr√§nkungen direkt in Entit√§tsklassen. </li><li>  Es kann angepasst und erg√§nzt werden; </li><li>  Integriert in g√§ngige ORMs und √úberpr√ºfungen werden automatisch ausgef√ºhrt, bevor √Ñnderungen in der Datenbank gespeichert werden. </li><li>  Einige Frameworks f√ºhren die Bean-Validierung auch automatisch aus, wenn der Benutzer Daten an die Benutzeroberfl√§che sendet (und wenn nicht, ist es einfach, die <code>Validator</code> Schnittstelle manuell aufzurufen). </li><li>  Die Bean-Validierung ist ein anerkannter Standard und enth√§lt zahlreiche Dokumentationen im Internet. </li></ol><br><p>  Was aber, wenn Sie eine Einschr√§nkung f√ºr eine Methode, einen Konstruktor oder eine REST-Adresse festlegen m√ºssen, um Daten zu validieren, die von einem externen System stammen?  Oder wenn Sie die Werte der Methodenparameter deklarativ √ºberpr√ºfen m√ºssen, ohne langweiligen Code mit vielen if-else-Bedingungen in jeder getesteten Methode zu schreiben? </p><br><p>  Die Antwort ist einfach: Die Bean-Validierung gilt auch f√ºr Methoden! </p><br><h2 id="validation-by-contract">  Validierung durch Vertrag </h2><br><p>  Manchmal m√ºssen Sie √ºber die Validierung des Status des Datenmodells hinausgehen.  Viele Methoden k√∂nnen von der automatischen Validierung von Parametern und R√ºckgabewerten profitieren.  Dies kann nicht nur erforderlich sein, um die Daten zu √ºberpr√ºfen, die an REST- oder SOAP-Adressen gesendet werden, sondern auch in den F√§llen, in denen die Vor- und Nachbedingungen von Methodenaufrufen notiert werden sollen, um sicherzustellen, dass die eingegebenen Daten vor der Ausf√ºhrung des Methodenk√∂rpers √ºberpr√ºft wurden oder der R√ºckgabewert liegt im erwarteten Bereich, oder wir m√ºssen beispielsweise nur deklarativ die Wertebereiche der Eingabeparameter beschreiben, um die Lesbarkeit des Codes zu verbessern. </p><br><p>  Mithilfe der Bean-Validierung k√∂nnen Einschr√§nkungen auf die Eingabeparameter und R√ºckgabewerte von Methoden und Konstruktoren angewendet werden, um die Vor- und Nachbedingungen ihrer Aufrufe in einer beliebigen Java-Klasse zu √ºberpr√ºfen.  Dieser Pfad bietet gegen√ºber herk√∂mmlichen Methoden zur √úberpr√ºfung der G√ºltigkeit von Parametern und R√ºckgabewerten mehrere Vorteile: </p><br><ol><li>  Es ist nicht erforderlich, √úberpr√ºfungen manuell in einem imperativen Stil durchzuf√ºhren (z. B. durch <code>IllegalArgumentException</code> von <code>IllegalArgumentException</code> und dergleichen).  Sie k√∂nnen Einschr√§nkungen deklarativ definieren und den Code verst√§ndlicher und aussagekr√§ftiger machen. </li><li>  Einschr√§nkungen k√∂nnen konfiguriert, wiederverwendet und konfiguriert werden: Sie m√ºssen nicht f√ºr jede Pr√ºfung eine Validierungslogik schreiben.  Weniger Code bedeutet weniger Fehler. </li><li>  Wenn die Klasse, der R√ºckgabewert der Methode oder ihr Parameter mit der Annotation <code>@Validated</code> gekennzeichnet ist, werden die √úberpr√ºfungen bei jedem Aufruf der Methode automatisch von der Plattform durchgef√ºhrt. </li><li>  Wenn die ausf√ºhrbare Datei mit der Annotation <code>@Documented</code> gekennzeichnet ist, werden ihre Vor- und Nachbedingungen in das generierte JavaDoc aufgenommen. </li></ol><br><p>  Mit der <strong>'Vertragsvalidierung' erhalten</strong> wir klaren, kompakten und einfach zu wartenden Code. </p><br><p>  Schauen wir uns als Beispiel die Schnittstelle des REST-Controllers einer CUBA-Anwendung an.  √úber die <code>PersonApiService</code> Schnittstelle k√∂nnen Sie mit der Methode <code>getPersons()</code> eine Liste von Personen aus der Datenbank <code>getPersons()</code> und mit dem <code>addNewPerson(...)</code> eine neue Person hinzuf√ºgen. </p><br><p>  Und vergessen Sie nicht, dass die Bean-Validierung vererbt wird!  Mit anderen Worten, wenn wir eine bestimmte Klasse, ein bestimmtes Feld oder eine bestimmte Methode mit Anmerkungen versehen, unterliegen alle Klassen, die diese Klasse erben oder diese Schnittstelle implementieren, derselben Validierungsanmerkung. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Validated</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PersonApiService</span></span></span><span class="hljs-class"> </span></span>{ String NAME = <span class="hljs-string"><span class="hljs-string">"passportnumber_PersonApiService"</span></span>; <span class="hljs-meta"><span class="hljs-meta">@NotNull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Valid</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequiredView</span></span>(<span class="hljs-string"><span class="hljs-string">"_local"</span></span>) <span class="hljs-function"><span class="hljs-function">List&lt;Person&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPersons</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addNewPerson</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( @NotNull @Length(min = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2</span></span></span></span><span class="hljs-function"><span class="hljs-params">, max = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">255</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pattern</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Bad formed person name: ${validatedValue}"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, regexp = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"^[AZ][az]*(\\s(([az]{1,3})|(([az]+\\')?[AZ][az]*)))*$"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String name, @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DecimalMax</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Person height can not exceed 300 cm"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, value = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"300"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DecimalMin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Person height should be positive"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, value = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"0"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, inclusive = </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">false</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> BigDecimal height, @NotNull CountryCode country, @NotNull String passportNumber )</span></span>; }</code> </pre> <br><p>  <a href="">PersonApiService.java</a> </p><br><p>  Ist dieser Code klar genug? <br>  _ (Mit Ausnahme der Annotation <code>@RequiredView(‚Äú_local‚Äù)</code> , die f√ºr die CUBA-Plattform spezifisch ist und √ºberpr√ºft, ob das zur√ºckgegebene <code>Person</code> Objekt alle Felder aus der Tabelle PASSPORTNUMBER_PERSON enth√§lt) ._ </p><br><p>  Die <code>@Valid</code> definiert, dass jedes von der Methode <code>getPersons()</code> zur√ºckgegebene <code>getPersons()</code> auch gegen die Einschr√§nkungen der <code>Person</code> Klasse validiert werden muss. </p><br><p>  In einer CUBA-Anwendung stehen diese Methoden unter folgenden Adressen zur Verf√ºgung: </p><br><ul><li>  / app / rest / v2 / services / passportnumber_PersonApiService / getPersons </li><li>  / app / rest / v2 / services / passportnumber_PersonApiService / addNewPerson </li></ul><br><p>  √ñffnen Sie die Postman-Anwendung und stellen Sie sicher, dass die Validierung ordnungsgem√§√ü funktioniert: </p><br><p><img src="https://habrastorage.org/webt/qg/ra/qj/qgraqjsxfyeqqa6qcjf2pkf7tcq.png" alt="Postbote App"></p><br><p>  Wie Sie vielleicht bemerkt haben, wird die Passnummer im obigen Beispiel nicht validiert.  Dies liegt daran, dass f√ºr dieses Feld eine √úberpr√ºfung der Parameter der <code>addNewPerson</code> Methode <code>addNewPerson</code> ist, da die Auswahl einer Vorlage f√ºr regul√§re Ausdr√ºcke zur √úberpr√ºfung von <code>passportNumber</code> vom Wert des <code>addNewPerson</code> abh√§ngt.  Diese Kreuzvalidierung ist ein vollst√§ndiges Analogon zu Entit√§tsbeschr√§nkungen auf Klassenebene! </p><br><p>  Die Kreuzvalidierung von Parametern wird von JSR 349 ‚Äã‚Äãund 380 unterst√ºtzt. In der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dokumentation</a> zum <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ruhezustand</a> erfahren Sie, wie Sie Ihre eigene Kreuzvalidierung von Klassen- / Schnittstellenmethoden implementieren. </p><br><h2 id="za-predelami-bean-validation">  Validierung au√üerhalb der Bohnen </h2><br><p>  Es gibt keine Perfektion auf der Welt, daher hat die Bohnenvalidierung ihre Nachteile und Grenzen: </p><br><ol><li>  Manchmal m√ºssen wir nur den Status eines komplexen Diagramms von Objekten √ºberpr√ºfen, bevor wir √Ñnderungen an der Datenbank speichern.  Beispielsweise m√ºssen Sie sicherstellen, dass alle Elemente einer Kundenbestellung in einem Paket enthalten sind.  Dies ist ein ziemlich schwieriger Vorgang, und es ist keine gute Idee, ihn jedes Mal auszuf√ºhren, wenn der Benutzer der Bestellung neue Artikel hinzuf√ºgt.  Daher ist eine solche Pr√ºfung m√∂glicherweise nur einmal erforderlich: bevor das <code>Order</code> Objekt und seine <code>OrderItem</code> Unterobjekte in der Datenbank gespeichert werden. </li><li>  Einige √úberpr√ºfungen m√ºssen innerhalb einer Transaktion durchgef√ºhrt werden.  Beispielsweise sollte das elektronische Speichersystem pr√ºfen, ob gen√ºgend Kopien der Waren vorhanden sind, um die Bestellung zu erf√ºllen, bevor sie in die Datenbank √ºbernommen werden.  Eine solche Pr√ºfung kann nur innerhalb einer Transaktion durchgef√ºhrt werden, weil  Das System ist multithreaded und die Menge der auf Lager befindlichen Waren kann sich jederzeit √§ndern. </li></ol><br><p>  Die CUBA-Plattform bietet zwei Daten√ºberpr√ºfungsmechanismen vor dem Festschreiben, die als <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Entity-Listener</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Transaktions-Listener bezeichnet werden</a> .  Betrachten wir sie genauer. </p><br><h3 id="entity-listemers">  Entity Listemers </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Entity-Listener in CUBA sind</a> den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>PreInsertEvent</code> , <code>PreUpdateEvent</code> und <code>PredDeleteEvent</code> Listenern</a> , die JPA dem Entwickler anbietet, sehr √§hnlich.  Mit beiden Mechanismen k√∂nnen Sie Entit√§tsobjekte √ºberpr√ºfen, bevor und nachdem sie in der Datenbank gespeichert wurden. </p><br><p>  In CUBA ist es einfach, einen Entity-Listener zu erstellen und zu verbinden. Dazu ben√∂tigen Sie zwei Dinge: </p><br><ol><li>  Erstellen Sie eine verwaltete Bean, die eine der Entity-Listener-Schnittstellen implementiert.  3 Schnittstellen sind wichtig f√ºr die Validierung: <br>  <code>BeforeDeleteEntityListener&lt;T&gt;</code> , <br>  <code>BeforeInsertEntityListener&lt;T&gt;</code> , <br> <code>BeforeUpdateEntityListener&lt;T&gt;</code> </li> <li>  F√ºgen Sie die Annotation <code>@Listeners</code> zu dem Entit√§tsobjekt hinzu, das Sie verfolgen <code>@Listeners</code> . </li></ol><br><p>  Und alle. </p><br><p>  Im Vergleich zum JPA-Standard (JSR 338, Abschnitt 3.5) sind die CUBA Platform-Listener-Schnittstellen typisiert, sodass Sie kein Argument vom Typ <code>Object</code> in einen Entit√§tstyp umwandeln m√ºssen, um damit arbeiten zu k√∂nnen.  Die CUBA-Plattform f√ºgt verwandten Entit√§ten oder EntityManager-Aufrufern die M√∂glichkeit hinzu, andere Entit√§ten zu laden und zu √§ndern.  Alle diese √Ñnderungen rufen auch den entsprechenden Entity-Listener auf. </p><br><p>  Die CUBA-Plattform unterst√ºtzt auch das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">"weiche L√∂schen"</a> , ein Ansatz, bei dem Datens√§tze nicht tats√§chlich aus der Datenbank gel√∂scht, sondern nur als gel√∂scht markiert werden und f√ºr den normalen Gebrauch nicht mehr zug√§nglich sind.  Zum sanften L√∂schen ruft die Plattform die <code>BeforeDeleteEntityListener</code> / <code>AfterDeleteEntityListener</code> , w√§hrend Standardimplementierungen <code>PreUpdate</code> / <code>PostUpdate</code> aufrufen <code>PreUpdate</code> . </p><br><p>  Schauen wir uns ein Beispiel an.  Hier stellt die Ereignis-Listener-Bean mit nur einer Codezeile eine Verbindung zur Entit√§tsklasse her: der Annotation <code>@Listeners</code> , die den Namen der Listener-Klasse tr√§gt: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Listeners</span></span>(<span class="hljs-string"><span class="hljs-string">"passportnumber_PersonEntityListener"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@NamePattern</span></span>(<span class="hljs-string"><span class="hljs-string">"%s|name"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(name = <span class="hljs-string"><span class="hljs-string">"PASSPORTNUMBER_PERSON"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Entity</span></span>(name = <span class="hljs-string"><span class="hljs-string">"passportnumber$Person"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ValidPassportNumber</span></span>(groups = {Default.class, UiCrossFieldChecks.class}) <span class="hljs-meta"><span class="hljs-meta">@FraudDetectionFlag</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StandardEntity</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> </pre> <br><p>  <a href="">Person.java</a> </p><br><p>  Die Listener-Implementierung selbst sieht folgenderma√üen aus: </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Checks that there are no other persons with the same * passport number and country code * Ignores spaces in the passport number for the check. * So numbers "12 45 768007" and "1245 768007" and "1245768007" * are the same for the validation purposes. */</span></span> <span class="hljs-meta"><span class="hljs-meta">@Component</span></span>(<span class="hljs-string"><span class="hljs-string">"passportnumber_PersonEntityListener"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PersonEntityListener</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BeforeDeleteEntityListener</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BeforeInsertEntityListener</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BeforeUpdateEntityListener</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onBeforeDelete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Person person, EntityManager entityManager)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!checkPassportIsUnique(person.getPassportNumber(), person.getCountry(), entityManager)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ValidationException( <span class="hljs-string"><span class="hljs-string">"Passport and country code combination isn't unique"</span></span>); } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onBeforeInsert</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Person person, EntityManager entityManager)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// use entity argument to validate the Person object // entityManager could be used to access database // if you need to check the data // throw ValidationException object if validation check failed if (!checkPassportIsUnique(person.getPassportNumber(), person.getCountry(), entityManager)) throw new ValidationException( "Passport and country code combination isn't unique"); } @Override public void onBeforeUpdate(Person person, EntityManager entityManager) { if (!checkPassportIsUnique(person.getPassportNumber(), person.getCountry(), entityManager)) throw new ValidationException( "Passport and country code combination isn't unique"); } ... }</span></span></code> </pre> <br><p>  <a href="">PersonEntityListener.java</a> </p><br><p>  Entity Listener sind eine gute Wahl, wenn: </p><br><ul><li>  Es ist erforderlich, die Daten innerhalb der Transaktion zu √ºberpr√ºfen, bevor das Entit√§tsobjekt in der Datenbank gespeichert wird. </li><li>  Es ist erforderlich, die Daten in der Datenbank w√§hrend des Validierungsprozesses zu √ºberpr√ºfen, um beispielsweise zu √ºberpr√ºfen, ob gen√ºgend Produkte auf Lager sind, um die Bestellung anzunehmen. </li><li>  Sie m√ºssen nicht nur das Entit√§tsobjekt wie <code>Order</code> , sondern auch verwandte Entit√§ten, z. B. <code>OrderItems</code> f√ºr die <code>Order</code> Entit√§t. </li><li>  Wir m√∂chten die Einf√ºge-, Aktualisierungs- oder L√∂schvorg√§nge nur f√ºr bestimmte Entit√§tsklassen <code>OrderItem</code> , z. B. nur f√ºr <code>OrderItem</code> und <code>OrderItem</code> , und m√ºssen w√§hrend der Transaktion nicht nach √Ñnderungen in anderen Entit√§tsklassen <code>OrderItem</code> . </li></ul><br><h3 id="transaction-listeners">  Transaktions-Listener </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">CUBA-Transaktions-Listener</a> agieren auch im Kontext von Transaktionen, werden jedoch im Vergleich zu Entity-Listenern f√ºr jede Datenbanktransaktion aufgerufen. </p><br><p>  Diese geben ihnen Superkraft: </p><br><ul><li>  nichts kann ihrer Aufmerksamkeit entgehen. </li></ul><br><p>  Dies wird jedoch durch ihre M√§ngel bestimmt: </p><br><ul><li>  sie sind schwieriger zu schreiben; </li><li>  Sie k√∂nnen die Leistung erheblich reduzieren. </li><li>  Sie sollten sehr sorgf√§ltig geschrieben werden: Ein Fehler im Transaktions-Listener kann sogar das anf√§ngliche Laden der Anwendung beeintr√§chtigen. </li></ul><br><p>  Transaktions-Listener sind daher eine gute L√∂sung, wenn Sie verschiedene Entit√§tstypen mit demselben Algorithmus untersuchen m√ºssen, z. B. indem Sie alle Daten mit einem einzigen Dienst auf Cyber-Betrug √ºberpr√ºfen, der alle Ihre Gesch√§ftsobjekte bedient. </p><br><p><img src="https://habrastorage.org/webt/km/v9/co/kmv9cougmokpc3opta_dfk4egqk.jpeg" alt="Du sollst nicht entschieden!"></p><br><p>  Schauen Sie sich ein Beispiel an, das pr√ºft, ob die Entit√§t √ºber eine <code>@FraudDetectionFlag</code> Annotation verf√ºgt, und startet gegebenenfalls einen Betrugsdetektor.  Ich wiederhole: Denken Sie daran, dass diese Methode <strong>vor dem Festschreiben jeder Datenbanktransaktion</strong> auf dem System aufgerufen wird. <strong>Daher</strong> sollte der Code versuchen, so wenige Objekte wie m√∂glich zu √ºberpr√ºfen. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span>(<span class="hljs-string"><span class="hljs-string">"passportnumber_ApplicationTransactionListener"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationTransactionListener</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BeforeCommitTransactionListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Logger log = LoggerFactory.getLogger(ApplicationTransactionListener.class); <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">beforeCommit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(EntityManager entityManager, Collection&lt;Entity&gt; managedEntities)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Entity entity : managedEntities) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (entity <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> StandardEntity &amp;&amp; !((StandardEntity) entity).isDeleted() &amp;&amp; entity.getClass().isAnnotationPresent(FraudDetectionFlag.class) &amp;&amp; !fraudDetectorFeedAndFastCheck(entity)) { logFraudDetectionFailure(log, entity); String msg = String.format( <span class="hljs-string"><span class="hljs-string">"Fraud detection failure in '%s' with id = '%s'"</span></span>, entity.getClass().getSimpleName(), entity.getId()); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ValidationException(msg); } } } ... }</code> </pre> <br><p>  <a href="">ApplicationTransactionListener.java</a> </p><br><p>  Um ein Transaktionslistener zu werden, muss eine verwaltete Bean die <code>BeforeCommitTransactionListener</code> Schnittstelle und die <code>beforeCommit</code> Methode implementieren.  Transaktionslistener binden automatisch, wenn die Anwendung gestartet wird.  CUBA registriert alle Klassen, die <code>BeforeCommitTransactionListener</code> oder <code>AfterCompleteTransactionListener</code> als Transaktionslistener. </p><br><h2 id="zaklyuchenie">  Fazit </h2><br><p>  Die Bean-Validierung <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">(JPA 303, 349 und 980)</a> ist ein Ansatz, der als zuverl√§ssige Grundlage f√ºr 95% der Datenvalidierungsf√§lle in einem Unternehmensprojekt dienen kann.  Der Hauptvorteil dieses Ansatzes besteht darin, dass der gr√∂√üte Teil der Validierungslogik direkt in den Dom√§nenmodellklassen konzentriert ist.  Daher ist es leicht zu finden, leicht zu lesen und leicht zu warten.  Spring, CUBA und viele andere Bibliotheken unterst√ºtzen diese Standards und f√ºhren automatisch Validierungspr√ºfungen durch, wenn Daten auf der UI-Ebene empfangen, validierte Methoden aufgerufen oder Daten √ºber ORM gespeichert werden. Daher sieht die Bean-Validierung aus Entwicklersicht oft magisch aus. </p><br><p>  Einige Softwareentwickler betrachten die Validierung auf Klassenebene des Subjektmodells als unnat√ºrlich und zu kompliziert. Sie sagen, dass die Datenvalidierung auf UI-Ebene eine ziemlich effektive Strategie ist.  Ich glaube jedoch, dass zahlreiche Validierungspunkte in Komponenten und UI-Controllern nicht der rationalste Ansatz sind.   ,  ,  ,    ,     ,       listener'        . </p><br><p>  ,  ,     : </p><br><ol><li> <strong>JPA </strong>   ,          ,        DDL. </li><li> <strong>Bean Validation</strong> ‚Äî , , ,             .      ,       . </li><li> <strong>  </strong>  bean validation,    .        , ,   REST. </li><li> <strong>Entity listeners:</strong>      ,   Bean Validation,             . ,         .  Hibernate    . </li><li> <strong>Transaction listeners</strong> ‚Äî ,   ,    .  ,      ,                    . </li></ol><br><p> <em>PS: ,              Java,      ,    ,    .</em> </p><br><hr><br><h2 id="poleznye-ssylki">  N√ºtzliche Links </h2><br><div class="spoiler">  <b class="spoiler_title">Versteckter Text</b> <div class="spoiler_text"><h3 id="standarty-i-ih-realizacii"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Standards und deren Umsetzung </font></font></h3><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSR 303 - Bean Validation 1.0</font></font></a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSR 349 ‚Äã‚Äã- Bean Validation 1.1</font></font></a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSR 349, Bean Validation Specification</font></font></a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSR 380, Bean-Validierungsspezifikation</font></font></a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hibernate Validator 5.4.2 (JSR 349) Referenz</font></font></a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Hibernate Validator 6.10 (JSR 380) reference</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Hibernate Validator main page</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Hibernate validator 6.10 API docs</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">HV 6.10: Declaring and validating method constraints</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">HV 6.10: Cross parameter constraints</a> </li></ul><br><h3 id="biblioteki">  Bibliotheken </h3><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">CUBA bean validation</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Validation cookbook for CUBA applications</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">JavaFX with Bean Validation and CDI 2.0</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">OVal ‚Äî non a JSR 303, 349, 380 compliant validation framework</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Spring, Java Bean Validation Basics</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Validation, Data Binding, and Type Conversion in Spring 4.1</a> </li></ul><br><h3 id="filosofiya-validacii-dannyh">    </h3><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Form validation best practices</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">JavaFX Form Validation</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Blah vs Bean Validation: you missed the point like Mars Climate Orbiter</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Avoiding Many If Blocks For Validation Checking</a> </li></ul><br><h3 id="materialy-dlya-dalneyshego-chteniya">     </h3><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Validation cookbook for CUBA applications</a> </li></ul></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de427543/">https://habr.com/ru/post/de427543/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de427533/index.html">Smartwatches, die nicht aufgeladen werden m√ºssen. Gibt es viele von ihnen?</a></li>
<li><a href="../de427535/index.html">Wir starten eine kollektive Auswahl an L√∂sungen</a></li>
<li><a href="../de427537/index.html">So werden Sie ein erfolgreicher Produktmanager: Kurse, in denen Sie gerade geschult werden</a></li>
<li><a href="../de427539/index.html">Das letzte Mal in Europa stellt die Uhr f√ºr die Winterzeit ein</a></li>
<li><a href="../de427541/index.html">Amazon fordert Bloomberg nachdr√ºcklich auf, in einem Artikel √ºber chinesische Spyware-Module auf Servern hochkar√§tige Anspr√ºche zu streichen</a></li>
<li><a href="../de427545/index.html">Informationssysteme ‚ÄûLandung erwartet‚Äú zur Registrierung des Luftverkehrs in Russland</a></li>
<li><a href="../de427549/index.html">Bericht des Club of Rome 2018, Kapitel 1.6: Technologie-Wildcards</a></li>
<li><a href="../de427551/index.html">Warum k√∂nnen wir die QWERTZ-Tastatur nicht aufgeben?</a></li>
<li><a href="../de427555/index.html">Tiere, die Menschen mithilfe der Gesichtserkennungstechnologie zu verfolgen gelernt haben</a></li>
<li><a href="../de427557/index.html">Zusammenfassung der IT-Ereignisse im November (Teil 1)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>