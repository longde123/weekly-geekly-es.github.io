<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏼‍⚖️ 🚞 🎀 Erstellen eines Microservices für Quarkus, Kotlin und Gradle 👋🏼 👩🏼‍🔬 🧕🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Einleitung 


 Im vorherigen Artikel haben wir kurz den Prozess der Erstellung eines Mikroservices auf modernen JVM-Frameworks sowie deren Vergleich b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Erstellen eines Microservices für Quarkus, Kotlin und Gradle</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484320/"><p><img src="https://habrastorage.org/webt/b0/c8/k8/b0c8k8k4cxgj8-czvjdrgn6uxgk.jpeg"></p><br><h2 id="vvedenie">  Einleitung </h2><br><p>  Im <a href="https://romankudryashov.com/blog/2020/01/heterogeneous-microservices/" rel="nofollow">vorherigen Artikel haben</a> wir kurz den Prozess der Erstellung eines Mikroservices auf modernen JVM-Frameworks sowie deren Vergleich beschrieben.  Dieser Artikel wird im kürzlich veröffentlichten <a href="https://quarkus.io/" rel="nofollow">Quarkus</a> anhand des Beispiels der Erstellung eines Mikrodienstes mit den genannten Technologien und gemäß den im Hauptartikel angegebenen Anforderungen näher erläutert.  Die resultierende Anwendung wird Teil der folgenden Microservice-Architektur: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f09/7fd/476/f097fd47661517c348a85a4d3251ecb4.png" alt="Zielarchitektur"></p><a name="habracut"></a><br><p>  Der Quellcode des Projekts ist wie gewohnt auf <a href="https://github.com/rkudryashov/heterogeneous-microservices/tree/master/quarkus-service" rel="nofollow">GitHub</a> verfügbar. </p><br><p>  Bevor Sie mit der Arbeit an einem Projekt beginnen können, muss Folgendes installiert sein: </p><br><ul><li>  Jdk 13 </li><li>  <a href="https://www.consul.io/" rel="nofollow">Consul</a> </li></ul><br><h2 id="sozdanie-novogo-proekta">  Erstellen Sie ein neues Projekt </h2><br><p>  Verwenden Sie zum Generieren eines neuen Projekts <a href="https://code.quarkus.io/" rel="nofollow">Web Starter</a> oder Maven (zum Erstellen eines <a href="https://quarkus.io/guides/getting-started" rel="nofollow">Maven-</a> Projekts oder <a href="https://quarkus.io/guides/gradle-tooling" rel="nofollow">Gradle-</a> Projekts).  Es ist erwähnenswert, dass das Framework die Sprachen Java, Kotlin und Scala unterstützt. </p><br><h2 id="zavismosti">  Sucht </h2><br><p>  In diesem Projekt wird Gradle Kotlin DSL als Build-System verwendet.  Das Build-Skript sollte enthalten: </p><br><ul><li><p>  Plugins <br>  <em>Listing 1. <a href="" rel="nofollow">build.gradle.kts</a></em> </p><br><pre><code class="kotlin hljs">plugins { kotlin(<span class="hljs-string"><span class="hljs-string">"jvm"</span></span>) kotlin(<span class="hljs-string"><span class="hljs-string">"plugin.allopen"</span></span>) id(<span class="hljs-string"><span class="hljs-string">"io.quarkus"</span></span>) }</code> </pre> <br><p>  Die Auflösung der Plugin-Version erfolgt in <a href="" rel="nofollow"><code>settings.gradle.kts</code></a> . </p><br></li><li><p>  Sucht <br>  <em>Listing 2. <a href="" rel="nofollow">build.gradle.kts</a></em> </p><br><pre> <code class="kotlin hljs">dependencies { ... implementation(enforcedPlatform(<span class="hljs-string"><span class="hljs-string">"io.quarkus:quarkus-bom:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$quarkusVersion</span></span></span><span class="hljs-string">"</span></span>)) implementation(<span class="hljs-string"><span class="hljs-string">"io.quarkus:quarkus-resteasy-jackson"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"io.quarkus:quarkus-rest-client"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"io.quarkus:quarkus-kotlin"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"io.quarkus:quarkus-config-yaml"</span></span>) testImplementation(<span class="hljs-string"><span class="hljs-string">"io.quarkus:quarkus-junit5"</span></span>) ... }</code> </pre> <br><p>  Informationen zum Importieren von Maven-Stücklisten finden Sie in der <a href="https://docs.gradle.org/current/userguide/platforms.html" rel="nofollow">Gradle-Dokumentation</a> . </p><br></li></ul><br><p>  Sie müssen auch einige Kotlin-Klassen <code>open</code> (diese sind standardmäßig <code>final</code> . Weitere Informationen zur Konfiguration von Gradle finden Sie im <a href="https://quarkus.io/guides/kotlin" rel="nofollow">Quarkus Kotlin-Handbuch</a> : </p><br><p>  <em>Listing 3. <a href="" rel="nofollow">build.gradle.kts</a></em> </p><br><pre> <code class="kotlin hljs">allOpen { <span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>(<span class="hljs-string"><span class="hljs-string">"javax.enterprise.context.ApplicationScoped"</span></span>) }</code> </pre> <br><h2 id="konfigurirovanie">  Konfiguration </h2><br><p>  Das Framework unterstützt die Konfiguration mithilfe von Eigenschaften und YAML-Dateien <br>  (mehr im <a href="https://quarkus.io/guides/config" rel="nofollow">Quarkus Konfigurationshandbuch</a> ).  Die Konfigurationsdatei befindet sich im <code>resources</code> und sieht folgendermaßen aus: </p><br><p>  <em>Listing 4. <a href="" rel="nofollow">application.yaml</a></em> </p><br><pre> <code class="plaintext hljs">quarkus: http: host: localhost port: 8084 application-info: name: quarkus-service framework: name: Quarkus release-year: 2019</code> </pre> <br><p>  In diesem Codefragment werden die Standard- und benutzerdefinierten Parameter des Mikrodienstes konfiguriert.  Letzteres kann so gelesen werden: </p><br><p>  <em>Listing 5. Benutzerdefinierte Anwendungsparameter lesen ( <a href="" rel="nofollow">Quellcode</a> )</em> </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.quarkus.arc.config.ConfigProperties <span class="hljs-meta"><span class="hljs-meta">@ConfigProperties(prefix = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"application-info"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationInfoProperties</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> name: String <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> framework: FrameworkConfiguration <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FrameworkConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> name: String <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> releaseYear: String } }</code> </pre> <br><h2 id="biny">  Bins </h2><br><p>  Bevor Sie mit der Arbeit mit dem Code beginnen, sollten Sie beachten, dass es im Quellcode der Quarkus-Anwendung keine Hauptmethode gibt (obwohl diese möglicherweise angezeigt wird). </p><br><p>  <code>@ConfigProperties</code> Bean aus der vorherigen Auflistung in eine andere Bean erfolgt mit der Annotation <code>@Inject</code> : </p><br><p>  <em>Listing 6. Implementierung der <code>@ConfigProperties</code> Bean ( <a href="" rel="nofollow">Quelle</a> )</em> </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@ApplicationScoped</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationInfoService</span></span></span></span>( <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> applicationInfoProperties: ApplicationInfoProperties, <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> serviceClient: ServiceClient ) { ... }</code> </pre> <br><p>  <code>ApplicationInfoService</code> von <code>@ApplicationScoped</code> annotierte <code>ApplicationInfoService</code> Bean wird wiederum wie folgt implementiert: </p><br><p>  <em>Listing 7. Bereitstellen der <code>@ApplicationScoped</code> Bean ( <a href="" rel="nofollow">Quelle</a> )</em> </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationInfoResource</span></span></span></span>( <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> applicationInfoService: ApplicationInfoService )</code> </pre> <br><p>  Weitere Informationen zu Contexts und Dependency Injection finden Sie im <a href="https://quarkus.io/guides/cdi-reference" rel="nofollow">Quarkus CDI-Handbuch</a> . </p><br><h2 id="rest-kontroller">  REST-Controller </h2><br><p>  Ein REST-Controller ist nichts Ungewöhnliches für Benutzer, die mit Spring Framework oder Java EE arbeiten: </p><br><p>  <em>Listing 8. REST-Controller ( <a href="" rel="nofollow">Quelle</a> )</em> </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Path(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/application-info"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@Produces(MediaType.APPLICATION_JSON)</span></span> <span class="hljs-meta"><span class="hljs-meta">@Consumes(MediaType.APPLICATION_JSON)</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationInfoResource</span></span></span></span>( <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> applicationInfoService: ApplicationInfoService ) { <span class="hljs-meta"><span class="hljs-meta">@GET</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@QueryParam(</span></span></span><span class="hljs-meta-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta"><span class="hljs-meta-string">"request-to"</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> requestTo: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">?)</span></span></span></span>: Response = Response.ok(applicationInfoService.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(requestTo)).build() <span class="hljs-meta"><span class="hljs-meta">@GET</span></span> <span class="hljs-meta"><span class="hljs-meta">@Path(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/logo"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@Produces(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"image/png"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">logo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: Response = Response.ok(applicationInfoService.getLogo()).build() }</code> </pre> <br><h2 id="rest-klient">  REST-Client </h2><br><p>  Um in der Quarkus Microservice-Architektur zu arbeiten, muss ein Service in der Lage sein, Anforderungen für andere Services zu erfüllen.  Da alle Services dieselbe API haben, ist es sinnvoll, eine einzige Schnittstelle für gemeinsamen Code und eine Reihe von REST-Clients zu erstellen, die diesen erben: </p><br><p>  <em>Listing 9. REST-Clients ( <a href="" rel="nofollow">Quellcode</a> )</em> </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@ApplicationScoped</span></span> <span class="hljs-meta"><span class="hljs-meta">@Path(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExternalServiceClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@GET</span></span> <span class="hljs-meta"><span class="hljs-meta">@Path(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/application-info"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@Produces(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"application/json"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getApplicationInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: ApplicationInfo } <span class="hljs-meta"><span class="hljs-meta">@RegisterRestClient(baseUri = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"http://helidon-service"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HelidonServiceClient</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ExternalServiceClient @RegisterRestClient</span></span></span></span>(baseUri = <span class="hljs-string"><span class="hljs-string">"http://ktor-service"</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">KtorServiceClient</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ExternalServiceClient @RegisterRestClient</span></span></span></span>(baseUri = <span class="hljs-string"><span class="hljs-string">"http://micronaut-service"</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MicronautServiceClient</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ExternalServiceClient @RegisterRestClient</span></span></span></span>(baseUri = <span class="hljs-string"><span class="hljs-string">"http://quarkus-service"</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QuarkusServiceClient</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ExternalServiceClient @RegisterRestClient</span></span></span></span>(baseUri = <span class="hljs-string"><span class="hljs-string">"http://spring-boot-service"</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SpringBootServiceClient</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ExternalServiceClient</span></span></span></span></code> </pre> <br><p>  Wie Sie sehen, wird beim Erstellen eines REST-Clients für andere Services lediglich eine Schnittstelle mit den entsprechenden JAX-RS- und MicroProfile-Annotationen erstellt. </p><br><h2 id="service-discovery">  Service-Erkennung </h2><br><p>  Wie Sie im vorherigen Abschnitt gesehen haben, sind die <code>baseUri</code> Parameterwerte die Namen der Services.  Bisher hat Quarkus jedoch keine integrierte Unterstützung für Service Discovery ( <a href="https://github.com/quarkusio/quarkus/issues/2052" rel="nofollow">Eureka</a> ) oder funktioniert nicht ( <a href="https://github.com/quarkusio/quarkus/issues/5812" rel="nofollow">Consul</a> ), da das Framework in erster Linie auf die Arbeit in Cloud-Umgebungen ausgerichtet ist.  Daher wird das Service Discovery-Muster mithilfe der <a href="https://github.com/rickfast/consul-client" rel="nofollow">Consul Client for Java-</a> Bibliothek implementiert. </p><br><p>  Der Client für Consul enthält zwei Methoden, <code>register</code> und <code>getServiceInstance</code> (unter Verwendung des Round-Robin-Algorithmus): </p><br><p>  <em>Listing 10. Kunde an Konsul ( <a href="" rel="nofollow">Quelle</a> )</em> </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@ApplicationScoped</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConsulClient</span></span></span></span>( <span class="hljs-meta"><span class="hljs-meta">@ConfigProperty(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"application-info.name"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> serviceName: String, <span class="hljs-meta"><span class="hljs-meta">@ConfigProperty(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"quarkus.http.port"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> port: <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> consulUrl = <span class="hljs-string"><span class="hljs-string">"http://localhost:8500"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> consulClient <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> lazy { Consul.builder().withUrl(consulUrl).build() } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> serviceInstanceIndex: <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">register</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { consulClient.agentClient().register(createConsulRegistration()) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getServiceInstance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(serviceName: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Service { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> serviceInstances = consulClient.healthClient().getHealthyServiceInstances(serviceName).response <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> selectedInstance = serviceInstances[serviceInstanceIndex] serviceInstanceIndex = (serviceInstanceIndex + <span class="hljs-number"><span class="hljs-number">1</span></span>) % serviceInstances.size <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> selectedInstance.service } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createConsulRegistration</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> = ImmutableRegistration.builder() .id(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$serviceName</span></span></span><span class="hljs-string">-</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$port</span></span></span><span class="hljs-string">"</span></span>) .name(serviceName) .address(<span class="hljs-string"><span class="hljs-string">"localhost"</span></span>) .port(port) .build() }</code> </pre> <br><p>  Zuerst müssen Sie die Anwendung registrieren: </p><br><p>  <em>Listing 11. Registrierung bei Consul ( <a href="" rel="nofollow">Quelle</a> )</em> </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@ApplicationScoped</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConsulRegistrationBean</span></span></span></span>( <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> consulClient: ConsulClient ) { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onStart</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@Observes</span></span></span></span><span class="hljs-function"><span class="hljs-params"> event: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">StartupEvent</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { consulClient.register() } }</code> </pre> <br><p>  Als Nächstes müssen Sie die Namen von Diensten in einen realen Ort konvertieren.  Verwenden Sie dazu eine Klasse, die <code>ClientRequestFilter</code> und <code>@Provider</code> annotiert: </p><br><p>  <em>Listing 12. Filter für die Arbeit mit Service Discovery ( <a href="" rel="nofollow">Quelle</a> )</em> </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Provider</span></span> <span class="hljs-meta"><span class="hljs-meta">@ApplicationScoped</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConsulFilter</span></span></span></span>( <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> consulClient: ConsulClient ) : ClientRequestFilter { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">filter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(requestContext: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">ClientRequestContext</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> serviceName = requestContext.uri.host <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> serviceInstance = consulClient.getServiceInstance(serviceName) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> newUri: URI = URIBuilder(URI.create(requestContext.uri.toString())) .setHost(serviceInstance.address) .setPort(serviceInstance.port) .build() requestContext.uri = newUri } }</code> </pre> <br><p>  Der Filter ersetzt lediglich den URI des <code>requestContext</code> Objekts durch den vom Client an Consul empfangenen Dienstort. </p><br><h2 id="testirovanie">  Testen </h2><br><p>  Tests für zwei API-Methoden werden mithilfe der Bibliothek REST Assured implementiert: </p><br><p>  <em>Listing 13. Tests ( <a href="" rel="nofollow">Quelle</a> )</em> </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@QuarkusTest</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QuarkusServiceApplicationTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testGet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { given() .`<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>`().<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"/application-info"</span></span>) .then() .statusCode(<span class="hljs-number"><span class="hljs-number">200</span></span>) .contentType(ContentType.JSON) .body(<span class="hljs-string"><span class="hljs-string">"name"</span></span>) { `<span class="hljs-keyword"><span class="hljs-keyword">is</span></span>`(<span class="hljs-string"><span class="hljs-string">"quarkus-service"</span></span>) } .body(<span class="hljs-string"><span class="hljs-string">"framework.name"</span></span>) { `<span class="hljs-keyword"><span class="hljs-keyword">is</span></span>`(<span class="hljs-string"><span class="hljs-string">"Quarkus"</span></span>) } .body(<span class="hljs-string"><span class="hljs-string">"framework.releaseYear"</span></span>) { `<span class="hljs-keyword"><span class="hljs-keyword">is</span></span>`(<span class="hljs-number"><span class="hljs-number">2019</span></span>) } } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testGetLogo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { given() .`<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>`().<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"/application-info/logo"</span></span>) .then() .statusCode(<span class="hljs-number"><span class="hljs-number">200</span></span>) .contentType(<span class="hljs-string"><span class="hljs-string">"image/png"</span></span>) .body(`<span class="hljs-keyword"><span class="hljs-keyword">is</span></span>`(notNullValue())) } }</code> </pre> <br><p>  Während des Tests muss die Anwendung nicht bei Consul registriert werden. Im Quellcode des Projekts neben dem Test befindet sich daher <code>ConsulClientMock</code> , das <code>ConsulClient</code> : </p><br><p>  <em>Listing 14. Mock for <code>ConsulClient</code> ( <a href="" rel="nofollow">Quelle</a> )</em> </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Mock</span></span> <span class="hljs-meta"><span class="hljs-meta">@ApplicationScoped</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConsulClientMock</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ConsulClient</span></span></span></span>(<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// do nothing override fun register() { } }</span></span></code> </pre> <br><h2 id="sborka">  Versammlung </h2><br><p>  Während der Gradle- <code>build</code> Task wird die <code>quarkusBuild</code> Task <code>quarkusBuild</code> .  Standardmäßig werden eine <em>Runner-</em> JAR und ein <code>lib</code> Ordner generiert, in dem sich die Abhängigkeiten befinden.  Um eine Uber-JAR zu erstellen, muss die <code>quarkusBuild</code> Task wie folgt konfiguriert werden: </p><br><p>  <em>Listing 15. Konfiguration der Uber-JAR-Generierung ( <a href="" rel="nofollow">Quelle</a> )</em> </p><br><pre> <code class="kotlin hljs">tasks { withType&lt;QuarkusBuild&gt; { isUberJar = <span class="hljs-literal"><span class="hljs-literal">true</span></span> } }</code> </pre> <br><p>  Führen Sie zum <code>./gradlew clean build</code> im Stammverzeichnis des Projekts aus. </p><br><h2 id="zapusk">  Starten Sie </h2><br><p>  Bevor Sie den Microservice starten, müssen Sie Consul starten (beschrieben im <a href="https://romankudryashov.com/blog/2020/01/heterogeneous-microservices/" rel="nofollow">Hauptartikel</a> ). </p><br><p>  Microservice kann gestartet werden mit: </p><br><ul><li>  Gradle <code>quarkusDev</code> Aufgabe <br>  Führen Sie im Stammverzeichnis des Projekts Folgendes aus: <br> <code>./gradlew :quarkus-service:quarkusDev</code> <br>  oder führen Sie die Task in der IDE aus </li><li>  Überglas <br>  Führen Sie im Stammverzeichnis des Projekts Folgendes aus: <br> <code>java -jar quarkus-service/build/quarkus-service-1.0.0-runner.jar</code> </li> </ul><br><p>  Jetzt können Sie die REST-API verwenden und beispielsweise die folgende Abfrage ausführen: </p><br><p> <code>GET http://localhost:8084/application-info</code> </p> <br><p>  Das Ergebnis wird sein: </p><br><p>  <em>Listing 16. Das Ergebnis des API-Aufrufs</em> </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"quarkus-service"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"framework"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Quarkus"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"releaseYear"</span></span>: <span class="hljs-number"><span class="hljs-number">2019</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"requestedService"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> }</code> </pre> <br><h2 id="sovmestimost-s-spring">  Federkompatibilität </h2><br><p>  Das Framework bietet Kompatibilität mit verschiedenen Spring-Technologien: <a href="https://quarkus.io/guides/spring-di" rel="nofollow">DI</a> , <a href="https://quarkus.io/guides/spring-web" rel="nofollow">Web</a> , <a href="https://quarkus.io/guides/spring-security" rel="nofollow">Sicherheit</a> , <a href="https://quarkus.io/guides/spring-data-jpa" rel="nofollow">Daten-JPA</a> . </p><br><h2 id="zaklyuchenie">  Fazit </h2><br><p>  Der Artikel untersuchte ein Beispiel für die Erstellung eines einfachen REST-Service unter Quarkus mit Kotlin und Gradle.  Im <a href="https://romankudryashov.com/blog/2020/01/heterogeneous-microservices/" rel="nofollow">Hauptartikel sehen</a> Sie, dass die resultierende Anwendung vergleichbare Parameter wie Anwendungen auf anderen modernen JVM-Frameworks aufweist.  Somit hat Quarkus ernsthafte Konkurrenten wie Helidon MicroProfile, Micronaut und Spring Boot (wenn es sich um Fullstack-Frameworks handelt).  Ich denke daher, dass wir auf eine interessante Entwicklung von Ereignissen warten, die für das gesamte Java-Ökosystem von Nutzen sein werden. </p><br><h2 id="poleznye-ssylki">  Nützliche Links </h2><br><ul><li>  <a href="https://quarkus.io/get-started/" rel="nofollow">Quarkus - Erste Schritte</a> </li><li>  <a href="https://quarkus.io/guides/getting-started" rel="nofollow">Quarkus - Erstellen Sie Ihre erste Anwendung</a> </li><li>  <a href="https://quarkus.io/blog/quarkus-for-spring-developers/" rel="nofollow">Quarkus für Frühjahrsentwickler</a> </li></ul><br><p>  PS Danke <a href="https://habr.com/en/users/vladimirsitnikov/" class="user_link">vladimirsitnikov</a> für die Hilfe bei der Vorbereitung des Artikels. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de484320/">https://habr.com/ru/post/de484320/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de484302/index.html">Slurm DevOps - eine bessere Arbeitsmeise in 3 Tagen als ein schöner Kran in ferner Zukunft</a></li>
<li><a href="../de484304/index.html">China verabschiedete sein "Frühlingspaket"</a></li>
<li><a href="../de484306/index.html">Lernfähigkeit kann unentscheidbar sein</a></li>
<li><a href="../de484310/index.html">Webix JavaScript-Bibliothek mit den Augen eines Anfängers. Teil 2. Mit Formularen arbeiten</a></li>
<li><a href="../de484312/index.html">Effiziente Speicherung von Hunderten Millionen kleiner Dateien. Selbst gehostete Lösung</a></li>
<li><a href="../de484326/index.html">Springe nach London oder mein Praktikum bei Jump Trading</a></li>
<li><a href="../de484328/index.html">Paul Graham kündigt neue Bel-Programmiersprache an</a></li>
<li><a href="../de484330/index.html">[Nginx] So schlagen Sie response_status = 0</a></li>
<li><a href="../de484332/index.html">Fokus auf Aufgabenverwaltung. Wie wir unser Managementsystem machen</a></li>
<li><a href="../de484336/index.html">Regeln für die Arbeit mit dynamischen Arrays und benutzerdefinierten Auflistungsklassen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>