<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéÉ üò± üèø Monad "Reader" a trav√©s de as√≠ncrono / espera en C # üèØ ‚å®Ô∏è üë∞üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En mi art√≠culo anterior, describ√≠ c√≥mo implementar el patr√≥n Quiz√°s Monad usando declaraciones as√≠ncronas / en espera . Esta vez le dir√© c√≥mo implemen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Monad "Reader" a trav√©s de as√≠ncrono / espera en C #</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/470501/"><p><img src="https://habrastorage.org/webt/jb/8f/kq/jb8fkqbv4lkkzgyy4j-66ykf9nu.jpeg"></p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">En mi art√≠culo anterior,</a> describ√≠ c√≥mo implementar el patr√≥n Quiz√°s Monad usando declaraciones <strong>as√≠ncronas / en espera</strong> .  Esta vez le dir√© c√≥mo implementar otra plantilla de dise√±o popular, "Monad Reader", utilizando las mismas t√©cnicas. </p><br><p>  Esta plantilla le permite transferir impl√≠citamente un cierto contexto a la jerarqu√≠a de llamadas a funciones sin usar par√°metros o campos de clase, y puede considerarse como otra forma de implementar la Inyecci√≥n de dependencias.  Por ejemplo: </p><a name="habracut"></a><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Config</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Template; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Console.WriteLine(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> GreetGuys().Apply(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Config {Template = <span class="hljs-string"><span class="hljs-string">"Hi, {0}!"</span></span>})); <span class="hljs-comment"><span class="hljs-comment">//(Hi, John!, Hi, Jos√©!) Console.WriteLine(await GreetGuys().Apply(new Config {Template = "¬°Hola, {0}!" })); //(¬°Hola, John!, ¬°Hola, Jos√©!) } //       -   ‚ÄúConfig". public static async Reader&lt;(string gJohn, string gJose)&gt; GreetGuys() =&gt; (await Greet("John"), await Greet("Jos√©")); static async Reader&lt;string&gt; Greet(string name) =&gt; string.Format(await ExtractTemplate(), name); static async Reader&lt;string&gt; ExtractTemplate() =&gt; await Reader&lt;string&gt;.Read&lt;Config&gt;(c =&gt; c.Template);</span></span></code> </pre> <br><h2 id="klassicheskiy-reader">  "Lector" cl√°sico </h2><br><p>  Primero, veamos c√≥mo puede implementar este patr√≥n sin sentencias <strong>async / wait</strong> : </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Config</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Template; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ClassicReader</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> greeter = GreetGuys(); Console.WriteLine(greeter.Apply(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Config{Template = <span class="hljs-string"><span class="hljs-string">"Hello, {0}"</span></span>})); <span class="hljs-comment"><span class="hljs-comment">//(Hello, John, Hello, Jose) Console.WriteLine(greeter.Apply(new Config{Template = "¬°Hola, {0}!" })); //(¬°Hola, John!, ¬°Hola, Jose!) } public static Reader&lt;(string gJohn, string gJose), Config&gt; GreetGuys() =&gt; from toJohn in Greet("John") from toJose in Greet("Jose") select (toJohn, toJose); //  "query syntax"      : //Greet("John") // .SelectMany( // toJohn =&gt; Greet("Jose"), // (toJohn, toJose) =&gt; (toJohn, toJose)) public static Reader&lt;string, Config&gt; Greet(string name) =&gt; new Reader&lt;string, Config&gt;(cfg =&gt; string.Format(cfg.Template, name)); }</span></span></code> </pre> <br><p>  <em>(Lector)</em> </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Reader</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>, <span class="hljs-title"><span class="hljs-title">TCtx</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Func&lt;TCtx, T&gt; _exec; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Reader</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Func&lt;TCtx, T&gt; exec</span></span></span><span class="hljs-function">)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._exec = exec; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Apply</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TCtx ctx</span></span></span><span class="hljs-function">)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._exec(ctx); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Reader</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Reader&lt;TJoin, TCtx&gt; SelectMany&lt;TIn, TOut, TCtx, TJoin&gt;( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Reader&lt;TIn, TCtx&gt; source, Func&lt;TIn, Reader&lt;TOut, TCtx&gt;&gt; bind, Func&lt;TIn, TOut, TJoin&gt; <span class="hljs-keyword"><span class="hljs-keyword">join</span></span>) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Reader&lt;TJoin, TCtx&gt;(ctx =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> inValue = source.Apply(ctx); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> outValue = bind(inValue).Apply(ctx); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(inValue, outValue); }); }</code> </pre> <br><p>  Este c√≥digo funciona, pero sin el uso de la sintaxis de consulta (que no siempre es conveniente en s√≠ misma), su legibilidad disminuye dr√°sticamente y esto no es sorprendente, ya que las m√≥nadas provienen de lenguajes funcionales donde dicho c√≥digo parece natural y se lee bien (aunque incluso en Haskelel surgi√≥ un "do" notaci√≥n para mejorar la legibilidad).  Sin embargo, la implementaci√≥n cl√°sica ayuda a comprender la esencia del patr√≥n: en lugar de ejecutar inmediatamente alg√∫n c√≥digo, se coloca en una funci√≥n que solo se llamar√° cuando obtenga su contexto. </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Reader&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">, Config&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Greet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name</span></span></span><span class="hljs-function">)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Reader&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, Config&gt;(cfg =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(cfg.Template, name)); <span class="hljs-comment"><span class="hljs-comment">//      ,     : //public static string Greet(string name, Config cfg) // =&gt; string.Format(cfg.Template, name);</span></span></code> </pre> <br><p>  <strong>SelectMany</strong> puede agrupar varias de estas funciones en una sola, por lo que puede crear una rutina completa que se retrasar√° hasta que se aplique su contexto.  Por otro lado, este enfoque se asemeja a escribir c√≥digo asincr√≥nico, donde la ejecuci√≥n del programa se detiene si se requiere el resultado de alguna operaci√≥n asincr√≥nica.  Cuando el resultado de la operaci√≥n est√© listo, el programa continuar√°.  Se supone que la infraestructura de C #, dise√±ada para trabajar con operaciones as√≠ncronas ( <em><strong>as√≠ncrono / espera</strong></em> ), se puede utilizar de alguna manera al implementar la m√≥nada "Reader" y ... ¬°esta suposici√≥n es cierta!  Si las funciones requieren acceso al contexto, entonces su ejecuci√≥n puede "pausarse" hasta que este contexto se especifique externamente. </p><br><h2 id="asinhronnyy-reader">  Lector asincr√≥nico </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">En mi art√≠culo anterior,</a> mostr√© c√≥mo obtener control sobre las declaraciones <strong>as√≠ncronas / en espera</strong> usando <strong>tipos de retorno asincr√≥nicos gen√©ricos</strong> .  El mismo enfoque se utilizar√° esta vez.  Comencemos con la clase <strong>Reader</strong> , que se usar√° como el tipo de resultado de operaciones asincr√≥nicas: </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">AsyncMethodBuilder(typeof(ReaderTaskMethodBuilder&lt;&gt;))</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Reader</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">INotifyCompletion</span></span>, <span class="hljs-title"><span class="hljs-title">IReader</span></span> { ...</code> </pre> <br><p>  Esta clase tiene dos tareas (en teor√≠a, podr√≠amos crear dos clases diferentes): </p><br><ol><li>  Recuperando valores del contexto. </li><li>  Cree una lista vinculada de instancias de la clase <strong>Reader</strong> que se utilizar√° para distribuir el contexto en toda la jerarqu√≠a de llamadas. </li></ol><br><p>  Para cada una de estas tareas, crearemos un constructor separado: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Func&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>, T&gt; _extractor; <span class="hljs-comment"><span class="hljs-comment">//1.       public static Reader&lt;T&gt; Read&lt;TCtx&gt;(Func&lt;TCtx, T&gt; extractor) =&gt; new Reader&lt;T&gt;(ctx =&gt; extractor((TCtx)ctx)); private Reader(Func&lt;object, T&gt; exec) =&gt; this._extractor = exec; //2.   ReaderTaskMethodBuilder     C# internal Reader() { }</span></span></code> </pre> <br><p>  Cuando se usa una instancia de la clase <strong>Reader</strong> como argumento para el operador de <strong>espera</strong> , esta instancia obtiene una referencia al delegado que continuar√° el programa.  Se debe llamar a este delegado despu√©s de recibir el contexto de la extracci√≥n de los datos necesarios para que el programa contin√∫e. </p><br><p><img src="https://habrastorage.org/webt/8q/k2/u3/8qk2u3lwleoo6hfd55fzclhz1sa.png"></p><br><p>  Para vincular instancias de la clase <strong>Reader</strong> , <strong>creemos el</strong> m√©todo <strong>SetChild</strong> : </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IReader _child; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetChild</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IReader reader</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._child = reader; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._ctx != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._child.SetCtx(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._ctx); } }</code> </pre> <br><p>  que se llamar√° dentro de <strong>ReaderTaskMethodBuilder</strong> : </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ReaderTaskMethodBuilder</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; { ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> GenericAwaitOnCompleted&lt;TAwaiter, TStateMachine&gt;( <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> TAwaiter awaiter, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> TStateMachine stateMachine) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TAwaiter : INotifyCompletion <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TStateMachine : IAsyncStateMachine { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (awaiter <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> IReader reader) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Task.SetChild(reader); } awaiter.OnCompleted(stateMachine.MoveNext); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Reader&lt;T&gt; Task { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } }</code> </pre> <br><p>  Dentro del m√©todo <strong>SetChild,</strong> llamamos a la funci√≥n <strong>SetCtx</strong> para difundir el contexto a trav√©s de la jerarqu√≠a de llamadas.  Si, al llamar a <strong>SetCtx</strong> en este nivel de la jerarqu√≠a, se especifica la funci√≥n _ <strong>extractor</strong> (el primer constructor de la clase <strong>Reader</strong> ) que extrae directamente los datos del contexto, ahora puede llamarlos, obtener los datos necesarios y completar la operaci√≥n asincr√≥nica actual a trav√©s de una llamada a <strong>SetResult</strong> : </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetCtx</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ctx</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._ctx = ctx; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._ctx != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._child?.SetCtx(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._ctx); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._extractor != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SetResult(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._extractor(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._ctx)); } } }</code> </pre> <br><p>  <strong>SetResult</strong> almacena el valor recuperado del contexto y llama al delegado para continuar el programa: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T result</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._result = result; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.IsCompleted = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._continuation?.Invoke(); }</code> </pre> <br><p>  En el caso de que la instancia de la clase <strong>Reader</strong> no tenga iniciada la funci√≥n _ <strong>extractor</strong> (el segundo constructor de la clase <strong>Reader</strong> ), <strong>ReaderTaskMethodBuilder</strong> debe llamar a <strong>SetResult</strong> cuando la m√°quina de estado generada <strong>pasa</strong> al estado final. </p><br><p>  <strong>SetCtx</strong> tambi√©n se llama en el m√©todo <strong>Apply</strong> para establecer el contexto en el nodo ra√≠z de la jerarqu√≠a: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Reader&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Apply</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ctx</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SetCtx(ctx); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; }</code> </pre> <br><p>  <a href="">C√≥digo completo de GitHub</a> </p><br><p>  Ahora, puede echar un vistazo a un ejemplo m√°s realista del uso de <strong>Reader</strong> as√≠ncrono -a: </p><br><div class="spoiler">  <b class="spoiler_title">Haga clic para expandir el ejemplo.</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ReaderTest</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Configuration</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> DataBaseId; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GreetingTemplate; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> NameFormat; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configuration</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dataBaseId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> greetingTemplate, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nameFormat</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.DataBaseId = dataBaseId; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.GreetingTemplate = greetingTemplate; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.NameFormat = nameFormat; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] ids = { <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span> }; Configuration[] configurations = { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Configuration(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-string"><span class="hljs-string">"Congratulations, {0}! You won {1}$!"</span></span>, <span class="hljs-string"><span class="hljs-string">"{0} {1}"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Configuration(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-string"><span class="hljs-string">"¬°Felicidades, {0}! Ganaste {1} $"</span></span>, <span class="hljs-string"><span class="hljs-string">"{0}"</span></span>), }; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configuration <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> configurations) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> userId <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ids) { <span class="hljs-comment"><span class="hljs-comment">//""      - userId var logic = GetGreeting(userId); //  (database Id, templates)     var greeting = await logic.Apply(configuration); Console.WriteLine(greeting) } } //Congratulations, John Smith! You won 110$! //Congratulations, Mary Louie! You won 30$! //Congratulations, Louis Slaughter! You won 47$! //¬°Felicidades, John! Ganaste 110 $ //¬°Felicidades, Mary! Ganaste 30 $ //¬°Felicidades, Louis! Ganaste 47 $ } private static async Reader&lt;string&gt; GetGreeting(int userId) { var template = await Reader&lt;string&gt;.Read&lt;Configuration&gt;(cfg =&gt; cfg.GreetingTemplate); var fullName = await GetFullName(userId); var win = await GetWin(userId); return string.Format(template, fullName, win); } private static async Reader&lt;string&gt; GetFullName(int userId) { var template = await Reader&lt;string&gt;.Read&lt;Configuration&gt;(cfg =&gt; cfg.NameFormat); var firstName = await GetFirstName(userId); var lastName = await GetLastName(userId); return string.Format(template, firstName, lastName); } private static async Reader&lt;string&gt; GetFirstName(int userId) { var dataBase = await GetDataBase(); return await dataBase.GetFirstName(userId); } private static async Reader&lt;string&gt; GetLastName(int userId) { var dataBase = await GetDataBase(); return await dataBase.GetLastName(userId); } private static async Reader&lt;int&gt; GetWin(int userId) { var dataBase = await GetDataBase(); return await dataBase.GetWin(userId); } private static async Reader&lt;Database&gt; GetDataBase() { var dataBaseId = await Reader&lt;int&gt;.Read&lt;Configuration&gt;(cfg =&gt; cfg.DataBaseId); return Database.ConnectTo(dataBaseId); } } public class Database { public static Database ConnectTo(int id) { if (id == 100) { return new Database(); } throw new Exception("Wrong database"); } private Database() { } private static readonly (int Id, string FirstName, string LastName, int Win)[] Data = { (1, "John","Smith", 110), (2, "Mary","Louie", 30), (3, "Louis","Slaughter", 47), }; public async Task&lt;string&gt; GetFirstName(int id) { await Task.Delay(50); return Data.Single(i =&gt; i.Id == id).FirstName; } public async Task&lt;string&gt; GetLastName(int id) { await Task.Delay(50); return Data.Single(i =&gt; i.Id == id).LastName; } public async Task&lt;int&gt; GetWin(int id) { await Task.Delay(50); return Data.Single(i =&gt; i.Id == id).Win; } }</span></span></code> </pre> </div></div><br><p>  El programa muestra saludos para algunos usuarios, pero no sabemos sus nombres de antemano porque solo tenemos sus identificadores, por lo que debemos leer sus nombres de la "base de datos".  Para conectarse a esta "base de datos" necesita conocer los par√°metros de conexi√≥n, y para generar saludos, tambi√©n necesitamos plantillas para estos saludos.  Toda esta informaci√≥n se pasa impl√≠citamente a trav√©s del <strong>lector</strong> as√≠ncrono. </p><br><h2 id="vnedrenie-zavisimostey-chrez-asinhronnyy-reader">  Inyecci√≥n de dependencia a trav√©s de "Reader" as√≠ncrono </h2><br><p>  En comparaci√≥n con la implementaci√≥n cl√°sica, el <strong>lector</strong> as√≠ncrono tiene un inconveniente: no podemos especificar el tipo de contexto que se transmitir√°.  Esta limitaci√≥n proviene del hecho de que el compilador de C # solo permite un tipo de datos parametrizado (tipo gen√©rico) en la clase <strong>ReaderTaskMethodBuilder</strong> (esto puede <strong>corregirse</strong> en futuras versiones). </p><br><p>  Por otro lado, no creo que esto sea cr√≠tico, porque en la vida real un contenedor de inyecci√≥n de dependencia probablemente se pasar√° como contexto: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Reader</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Reader&lt;TService&gt; GetService&lt;TService&gt;() =&gt; Reader&lt;TService&gt;.Read&lt;IServiceProvider&gt;(serviceProvider =&gt; (TService)serviceProvider .GetService(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(TService))); }</code> </pre> <br><pre> <code class="cs hljs">... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Reader&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Greet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userName</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> service = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Reader.GetService&lt;IGreater&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> service.GreetUser(userName); } ...</code> </pre> <br><p>  <a href="">( <em>Aqu√≠ puedes encontrar la versi√≥n completa ...</em> )</a> </p><br><p>  A diferencia del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">asincr√≥nico "Quiz√°s"</a> , que no recomend√© usar en ning√∫n c√≥digo industrial, considerar√≠a usar el As√≠ncrono <strong>Reader</strong> -a en algunos proyectos de la vida real como reemplazo (o adici√≥n) a los mecanismos tradicionales de inyecci√≥n de dependencias (cuando todas las dependencias se pasan como par√°metros del constructor) Dado que <strong>Reader</strong> -a tiene una serie de ventajas: </p><br><ol><li>  No hay necesidad de campos cuyas clases almacenen enlaces a recursos integrados.  De hecho, no habr√° necesidad de clases reales, ya que toda la l√≥gica se puede implementar en m√©todos est√°ticos. </li><li>  El uso de <strong>Reader</strong> -a tender√° a escribir c√≥digo sin bloqueo, ya que todos los m√©todos ser√°n asincr√≥nicos y nada interferir√° con el uso de versiones asincr√≥nicas de las funciones de la biblioteca. </li><li>  El c√≥digo ser√° un poco m√°s legible, porque cada vez que veamos a <strong>Reader</strong> como el tipo de retorno de alg√∫n m√©todo, sabremos que requiere acceso a alg√∫n contexto impl√≠cito </li><li>  El <strong>lector</strong> as√≠ncrono no usa la reflexi√≥n. </li></ol><br><p>  Por supuesto, puede haber objeciones al uso de este <strong>Reader</strong> -a, pero en cualquier caso, la tarea principal de estos art√≠culos es mostrar c√≥mo las plantillas que se crearon originalmente para lenguajes funcionales pueden adaptarse para un estilo de programaci√≥n imperativo, que la mayor√≠a de las personas considera m√°s f√°cil de entender. . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/470501/">https://habr.com/ru/post/470501/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../470487/index.html">Concursos tecnol√≥gicos Radiofest-2019</a></li>
<li><a href="../470489/index.html">Semana de la seguridad 41: m√°s vulnerabilidades en las tarjetas SIM, descifrado de PDF</a></li>
<li><a href="../470491/index.html">A trav√©s de espinas al juego de los sue√±os: el progreso y la evoluci√≥n de las criaturas</a></li>
<li><a href="../470497/index.html">C√≥mo usar systemd-nspawn para restaurar un sistema Linux</a></li>
<li><a href="../470499/index.html">C√≥mo usar las interrupciones en Unity Animator al m√°ximo</a></li>
<li><a href="../470503/index.html">Usuarios y autorizaci√≥n de Kubernetes RBAC</a></li>
<li><a href="../470511/index.html">TI en Armenia: sectores estrat√©gicos y esferas tecnol√≥gicas del pa√≠s</a></li>
<li><a href="../470513/index.html">C√≥mo encontr√© una casa inteligente dominada por una botnet</a></li>
<li><a href="../470515/index.html">Un peque√±o paso para el probador: los 10 mejores informes de Heisenbug 2019 Piter</a></li>
<li><a href="../470517/index.html">EP ruso para los m√°s peque√±os</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>