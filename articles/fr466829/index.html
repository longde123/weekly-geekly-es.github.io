<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòº üï† üïµÔ∏è Quelques touches pour travailler avec des identifiants bigint dans R üë©üèº‚Äçüé§ üß£ ‚¨úÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Chaque fois qu'une conversation commence sur l'utilisation de diverses bases de donn√©es comme source de donn√©es, le sujet des identificateurs d'enregi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Quelques touches pour travailler avec des identifiants bigint dans R</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/466829/"><p> Chaque fois qu'une conversation commence sur l'utilisation de diverses bases de donn√©es comme source de donn√©es, le sujet des identificateurs d'enregistrement, des objets ou de quelque chose d'autre appara√Æt.  Parfois, la coordination du protocole d'√©change peut √™tre envisag√©e par les participants pendant plusieurs mois.  <code>int</code> - <code>bigint</code> - <code>guid</code> , puis en cercle.  Pour les t√¢ches de volume, <code>bigint</code> que nativement dans R il n'y a pas de support <code>bigint</code> (capacit√© ~ 2 ^ 64), le choix de la pr√©sentation correcte de ces identifiants peut √™tre critique en termes de performances.  Existe-t-il une solution de contournement √©vidente et universelle?  Voici quelques consid√©rations pratiques qui peuvent √™tre utilis√©es dans les projets comme test d√©cisif. </p><br><p>  En r√®gle g√©n√©rale, les identifiants seront utilis√©s pour trois classes de t√¢ches: </p><br><ul><li>  regroupement; </li><li>  filtrage </li><li>  association. </li></ul><br><p>  Sur cette base, nous √©valuerons diff√©rentes approches. </p><br><p>  Il s'agit d'une continuation des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">publications pr√©c√©dentes</a> . <a name="habracut"></a></p><br><h1 id="hranim-kak-string">  Stocker sous forme de <code>string</code> </h1><br><p>  L'option pour les petites donn√©es est plut√¥t bonne.  Ici et la possibilit√© de r√©cup√©rer n'importe quelle longueur de l'identifiant, et la possibilit√© de prendre en charge non seulement les identificateurs num√©riques, mais aussi alphanum√©riques.  Un avantage suppl√©mentaire est la capacit√© garantie de recevoir correctement les donn√©es via n'importe quel protocole de base de donn√©es non natif, par exemple, via l'API REST de la passerelle. </p><br><p>  Les inconv√©nients sont √©galement √©vidents.  Grande consommation de m√©moire, augmentation du volume d'informations de la base de donn√©es, d√©gradation des performances √† la fois au niveau du r√©seau et au niveau du calcul. </p><br><h1 id="ispolzuem-paket-bit64">  Nous utilisons le package <code>bit64</code> </h1><br><p>  Beaucoup de ceux qui n'ont entendu que le nom de ce package peuvent penser que le voici, la solution parfaite.  H√©las, ce n'est pas tout √† fait vrai.  Non seulement est-ce un add-on en plus du <code>numeric</code> (citation: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">' <em>Encore une fois, le choix est √©vident: R n'a qu'un seul type de donn√©es 64 bits: doubles. En utilisant des doubles,</em></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><em><br></em></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><em>integer64 h√©rite de certaines fonctionnalit√©s telles que is.atomic, length, length &lt;-, names, names &lt;-, dim, dim &lt;-, dimnames, dimnames.</em></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">'</a> ), il y a donc toujours une expansion massive de l'arithm√©tique de base et il n'y a aucune garantie qu'elle n'explosera nulle part et il n'y aura pas de conflit avec d'autres packages. </p><br><h1 id="ispolzuem-tip-numeric">  Nous utilisons le type <code>numeric</code> </h1><br><p>  C'est une astuce compl√®tement correcte, qui est un bon compromis pour ceux qui savent exactement ce qui sera cach√© dans la r√©ponse <code>int64</code> de la base de donn√©es.  Apr√®s tout, tous les 64 bits n'y seront pas vraiment impliqu√©s.  Souvent, il peut y en avoir beaucoup moins que 2 ^ 64. </p><br><p>  Une telle solution est possible en raison des sp√©cificit√©s du format √† virgule flottante double pr√©cision.  Les d√©tails peuvent √™tre trouv√©s dans l'article populaire en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">format √† virgule flottante double pr√©cision</a> . </p><br><pre> <code class="plaintext hljs">The 53-bit significand precision gives from 15 to 17 significant decimal digits precision (2‚àí53 ‚âà 1.11 √ó 10‚àí16). If a decimal string with at most 15 significant digits is converted to IEEE 754 double-precision representation, and then converted back to a decimal string with the same number of digits, the final result should match the original string. If an IEEE 754 double-precision number is converted to a decimal string with at least 17 significant digits, and then converted back to double-precision representation, the final result must match the original number.</code> </pre> <br><p>  Si vous avez 15 chiffres d√©cimaux ou moins dans l'identifiant, vous pouvez utiliser des <code>numeric</code> et ne vous inqui√©tez pas. </p><br><p>  La m√™me astuce est bonne lorsque vous devez travailler avec des donn√©es temporaires, en particulier celles contenant des millisecondes.  Le transfert de donn√©es temporaires sur le r√©seau sous forme de texte prend du <code>POSIXct</code> outre, du c√¥t√© de la r√©ception, vous devez ex√©cuter l'analyseur de texte -&gt; <code>POSIXct</code> , qui est √©galement extr√™mement gourmand en ressources (baisse des performances parfois).  Le transfert sous forme binaire n'est pas un fait que tous les pilotes prendront en charge le transfert du fuseau horaire et des millisecondes.  Mais la transmission du temps pr√©cis en millisecondes dans la zone UTC dans la repr√©sentation d'horodatage unix (13 d√©cimales) est tr√®s bien et sans perte fournie par le format <code>numeric</code> . </p><br><h2 id="ne-vse-tak-prosto-i-ochevidno">  Pas si simple et √©vident </h2><br><p>  Si nous regardons de plus pr√®s la version avec des lignes, l'√©vidence et la cat√©gorisation de l'√©nonc√© initial s'√©loignent un peu.  Travailler avec des cha√Ænes dans R n'est pas tr√®s simple, m√™me en omettant les nuances d'alignement des blocs de m√©moire et de pr√©lecture.  √Ä en juger par les livres et la documentation approfondie, les variables de cha√Æne ne sont pas stock√©es par elles-m√™mes dans une variable, mais sont plac√©es dans un pool de cha√Ænes global.  Toutes les lignes.  Et ce pool est utilis√© par les tableaux de cha√Ænes pour r√©duire la consommation de m√©moire.  C'est-√†-dire  un vecteur texte sera un ensemble de lignes dans le pool global + un vecteur de liens vers les enregistrements de ce pool. </p><br><pre> <code class="python hljs">library(tidyverse) library(magrittr) library(stringi) library(gmp) library(profvis) library(pryr) library(rTRNG) set.seed(<span class="hljs-number"><span class="hljs-number">46572</span></span>) RcppParallel::setThreadOptions(numThreads = parallel::detectCores() - <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">#              options(scipen = 10000) options(digits = 14) options(pillar.sigfig = 14) pryr::mem_used() fname &lt;- here::here("output", "dump.csv") #  10^4,       (    +  ) m1 &lt;- sample(stri_rand_strings(100, 64, "[a0-9]"), 10^7, replace = TRUE) #     readr::write_csv(enframe(m1, name = NULL), fname) #       m2 &lt;- readr::read_csv(fname, col_types = "c") %&gt;% pull(value) pryr::object_size(m2) pryr::mem_used() #      print(glue::glue("File size: {fs::file_size(fname)}. ", "Constructed from file object's (m2) size: {fs::fs_bytes(pryr::object_size(m2))}. ", "Pure pointer's size: {fs::fs_bytes(8*length(m2))}")) .Internal(inspect(m1)) .Internal(inspect(m2))</span></span></code> </pre> <br><p>  On voit que m√™me sans aller au niveau C ++, l'hypoth√®se n'est pas si loin de la v√©rit√©.  Le volume du vecteur cha√Æne co√Øncide presque avec le volume des pointeurs 64 bits, et la variable elle-m√™me prend beaucoup moins d'espace que le fichier sur le disque. </p><br><pre> <code class="plaintext hljs">File size: 62M. Constructed from file object's (m2) size: 7.65M. Pure pointer's size: 7.63M</code> </pre> <br><p>  Et le contenu des vecteurs avant l'√©criture et apr√®s la lecture est identique - resp.  les √©l√©ments vectoriels font r√©f√©rence aux m√™mes blocs de m√©moire. </p><br><p>  Donc, regarder de plus pr√®s l'utilisation des cha√Ænes de texte comme identificateurs ne semble plus une id√©e si folle.  Les rep√®res de regroupement, de filtrage et de fusion, √† l'aide de <code>dplyr</code> et de <code>data.table</code> donnent des lectures approximativement similaires pour <code>numeric</code> identificateurs <code>numeric</code> et de <code>character</code> , ce qui donne une confirmation suppl√©mentaire de l'optimisation en raison du pool global.  Apr√®s tout, le travail est en cours avec des pointeurs dont la taille est de 32 ou 64 bits, selon l'assemblage R (32/64), et c'est pr√©cis√©ment le type <code>numeric</code> . </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#    gc() pryr::mem_used() bench::mark( string = id_df %&gt;% group_by(id_string) %&gt;% summarise(j = prod(j, na.rm = TRUE)), # bit64 = id_df %&gt;% group_by(id_bit64) %&gt;% summarise(j = prod(j, na.rm = TRUE)), numeric = id_df %&gt;% group_by(id_numeric) %&gt;% summarise(j = prod(j, na.rm = TRUE)), # gmp = id_df %&gt;% group_by(id_gmp) %&gt;% summarise(j = prod(j, na.rm = TRUE)), check = FALSE ) #    gc() pryr::mem_used() string_subset &lt;- sample(unique(id_df$id_string), 20) numeric_subset &lt;- sample(unique(id_df$id_numeric), 20) bench::mark( string = dplyr::filter(id_df, id_string %in% string_subset), numeric = dplyr::filter(id_df, id_numeric %in% numeric_subset), check = FALSE ) #    gc() pryr::mem_used() #        string_copy_df &lt;- rlang::duplicate(dplyr::count(id_df, id_string)) numeric_copy_df &lt;- rlang::duplicate(dplyr::count(id_df, id_numeric)) bench::mark( string = id_df %&gt;% dplyr::left_join(string_copy_df, by = "id_string"), numeric = id_df %&gt;% dplyr::left_join(numeric_copy_df, by = "id_numeric"), iterations = 10, check = FALSE )</span></span></code> </pre> <br><p>  Soit dit en passant, la taille maximale de la m√©moire R disponible peut √™tre consult√©e avec la commande <a href="" rel="nofollow"><code>fs::fs_bytes(memory.limit())</code></a> . </p><br><p>  Pour √™tre honn√™te, il convient de noter que <code>dplyr</code> n'a pas toujours eu une <code>dplyr</code> rapide des <code>dplyr</code> , voir le cas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">"La jonction par une colonne de caract√®res est lente, par rapport √† la jonction par une colonne de facteurs. # 1386 {Closed}"</a> .  Ce thread propose d'utiliser les capacit√©s du pool global de cha√Ænes et de comparer non pas des cha√Ænes en tant que telles, mais des pointeurs vers des cha√Ænes. </p><br><h2 id="detali-po-upravlenie-pamyatyu">  D√©tails de la gestion de la m√©moire </h2><br><p>  Sources de base </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">R Internals par R Core Team</a> , en particulier <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Chapitre 1 - R Internal Structures</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">R internes.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">1.1 SEXP</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">R internes.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">12.1 Vecteurs longs</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">M√©moire R. avanc√©e</a> .  C'est dans la deuxi√®me √©dition du livre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">2. Noms et valeurs</a> </li></ul><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  Naturellement, cette question est constamment pos√©e sous une forme ou une autre, un certain nombre de liens ci-dessous. </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Dans R, est-il pr√©f√©rable d'utiliser entier64, num√©rique ou caract√®re pour les grands num√©ros d'identification entiers?</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">R dans un monde 64 bits</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">bit64: Une classe S3 pour les vecteurs de nombres entiers 64 bits</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">VRAIMENT GRANDS NOMBRES EN R</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">gmp: Arithm√©tique de pr√©cision multiple</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Rmpfr: R MPFR - Fiabilit√© en virgule flottante de pr√©cision multiple</a> </li></ul><br><p>  Mais afin de comprendre consciemment ce qu'il faut faire correctement, quelles sont les opportunit√©s et les limites, il est pr√©f√©rable de descendre au niveau le plus bas possible.  Il s'av√®re qu'il y a une masse de sp√©cificit√©s pas √©videntes.  La publication est de nature recherche, car elle affecte des aspects assez basiques de la R, que peu de gens utilisent dans leur travail quotidien.  S'il y a des ajouts, commentaires ou corrections significatifs, il sera tr√®s int√©ressant de les conna√Ætre. </p><br><p>  La publication pr√©c√©dente est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´Utilisation de R pour les t√¢ches utilitaires¬ª</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr466829/">https://habr.com/ru/post/fr466829/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr466815/index.html">Pr√©sentation technique de NEC HYDRAstor HS8 et plus</a></li>
<li><a href="../fr466817/index.html">Varonis a d√©couvert un virus d'extraction de crypto: notre enqu√™te</a></li>
<li><a href="../fr466819/index.html">Mise en place d'offres promotionnelles sur iOS. Comment gagner plus sur les abonnements?</a></li>
<li><a href="../fr466821/index.html">Installez 3CX √† partir d'Amazon AWS Marketplace</a></li>
<li><a href="../fr466823/index.html">Comment nous configurons les migrations pour les processus m√©tier dans Bitrix24</a></li>
<li><a href="../fr466831/index.html">D√©veloppement d'un syst√®me d'exploitation monolithique de type Unix - Heap (4)</a></li>
<li><a href="../fr466833/index.html">Choses importantes √† savoir sur Tensorflow 2.0</a></li>
<li><a href="../fr466837/index.html">Week-end √† v√©lo √©lectrique avec g√©n√©rateur de gaz</a></li>
<li><a href="../fr466839/index.html">L'histoire de la cr√©ation de Norton Commander. Partie 1/3</a></li>
<li><a href="../fr466841/index.html">Pourquoi un coussin chauffant, s'il y a un ordinateur portable: l'√©tude de la r√©sistance thermique au niveau atomique</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>