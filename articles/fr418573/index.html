<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏇🏾 🗡️ 🕺🏻 Waterius: Transférez les relevés d'eau sur un téléphone via Wi-Fi (4 ans sur batterie) 👨🏻‍🔬 ✈️ 🕺</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Une fois, j'étais fatigué de prendre des relevés de compteurs d'eau. Il était possible de poser un aimant près du comptoir et de se calmer, mais j'ai ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Waterius: Transférez les relevés d'eau sur un téléphone via Wi-Fi (4 ans sur batterie)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/418573/"><img src="https://habrastorage.org/webt/cu/cm/id/cucmidscnzwyjeto65obezfzjgw.jpeg"><br><br>  Une fois, j'étais fatigué de prendre des relevés de compteurs d'eau.  Il était possible de poser un aimant près du comptoir et de se calmer, mais j'ai trouvé ce chemin antisportif. <br><br>  Mon chemin était difficile et fleuri.  Mais le résultat est un appareil qui transmet les relevés d'eau via Wi-Fi au téléphone.  Simple et intuitif à utiliser et à configurer pour au moins un élève de l'école, au moins <s>pour une</s> personne âgée.  Et familier avec le mot "Arduino" - également simple à fabriquer.  L'appareil peut fonctionner sur piles pendant quatre ans (plus longtemps que la relation avec votre ex a duré).  Il s'agit également du premier projet ouvert présentant de telles caractéristiques.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">J'ai écrit des</a> analogues d'usine, ils sont peu nombreux et d'accord avec eux. <br><br>  Donc, nous avons de l'argent et un grand mais honnête désir de simplifier nos vies sans violer le Code criminel.  Et pour qu'aucun de vos 220V, serveurs et un tas de boutons!  Nous regardons les lectures sur le smartphone dans l'application Blynk ou un service similaire. <br><br>  Maintenant, asseyez-vous sur une chaise, mangez plus de ces petits pains français moelleux et buvez du thé.  Regardez de belles photos et écoutez mon histoire sur les éléments à prendre en compte lors de la création d'appareils autonomes.  Mais d'abord, une brève description de Waterius. <br><a name="habracut"></a><br><h3>  Prérequis </h3><br><ul><li>  compteur avec fil (UPD2: toute <s>sortie «contact sec»</s> ) </li><li>  Routeur Wi-Fi avec Internet </li></ul><br><h3>  CARACTÉRISTIQUES </h3><br><ul><li>  Puissance: 3 piles AA </li><li>  durée de travail 4 ans ou plus </li><li>  2 compteurs d'eau </li><li>  un seul bouton pour configurer </li><li>  mémoire non volatile pour les indications et les paramètres réseau </li></ul><br><h3>  Transfert quotidien Wi-Fi </h3><br><ul><li>  lectures actuelles </li><li>  consommation d'eau par jour </li><li>  tension d'alimentation </li><li>  e-mail  lettres (le corps et le titre peuvent être modifiés) </li></ul><br><br>  Prise en charge du serveur TCP et de l'application Blynk.  Ajoutez <s>HTTP</s> , <s>MQTT</s> , Modbus TCP, Cayenne, IFTTT, etc.  (ici est donné une place pour la manifestation de votre génie créateur). <br><br>  UPD2: des génies créatifs dévoilés pourtant HTTPS, MQTT <br><br><h2>  Personnalisation </h2><br>  Lorsque le bouton Waterius est cliqué, il active le point d'accès Wi-Fi.  Connectez-vous, remplissez le formulaire, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">inclinez-vous</a> trois fois vers l'est et dites «merci» aux développeurs de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">WiFiManager</a> .  Vous pouvez mentalement. <br><br><img width="750" src="https://habrastorage.org/webt/du/9k/jn/du9kjni_1m0qlxthmhvagpl1fvg.jpeg" alt="Configurer Waterius à l'aide de Wifimanager"><br><br><h2>  Électronique divertissante </h2><br>  Une diffusion d'éléments radio pour l'assemblage de Waterius <br><br><img src="https://habrastorage.org/webt/g3/or/q4/g3orq43vvb6jmy2ow3m04n1dldg.jpeg"><br><br>  La seule façon d'atteindre des unités de consommation de micro-ampères tout en comptant les impulsions est d'utiliser un microcontrôleur économique, pas ce que vous pensiez.  Waterius heart - microcontrôleur Attiny85 (analogues - MSP430, STM8L).  Il est cousu sans problème avec n'importe quelle planche Arduino avec des mains dépassant la taille.  Attiny85 fonctionne à une fréquence de 1 MHz du générateur interne et compte les impulsions, vérifiant périodiquement 2 entrées pour un court-circuit et un bouton.  Courant de sommeil <a href="">4 μA à 3V</a> .  Un conte de fées. <br><br>  En tant que Wi-Fi, j'utilise ESP8266-01.  Consommation en fonctionnement 75mA, impulsions jusqu'à 250mA.  Deux microcontrôleurs communiquent sur le bus i2c.  La justesse du choix a été confirmée par le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">projet de la station météo</a> .  L'ESP8266 fait constamment rêver: la broche EN est tirée sur GND via une résistance.  Le courant de consommation est inférieur à 10 μA (je suis tombé sur des instances avec 0 μA).  Une fois par jour, Attiny85 délivre HAUT, ESP8266 se réveille, reçoit des lectures d'Attiny85, se connecte au Wi-Fi domestique et envoie des données en ~ 4 secondes - ce qui, selon les recherches de scientifiques britanniques, est beaucoup plus rapide que vous ne le faites habituellement manuellement sur ces mêmes compteurs. <br><br><img align="right" src="https://habrastorage.org/webt/y6/ov/aa/y6ovaaeka77kd0inlhivxv3cd_k.jpeg">  <i>La photo montre un bon ESP, la consommation bondit de 7-11μA.</i>  <i>Habituellement, les nombres sont de 19 à 23 μA.</i> <br><br>  D'autres types de sommeil ne fonctionneront pas pour Waterius, au moins saupoudrez-le de mélatonine aux sons d'une berceuse: un sommeil profond infini avec un réveil instantané sur une réinitialisation externe consomme 20 μA et convient à l'envoi fréquent de données.  L'option la plus économique: éteignez complètement l'ESP8266, mais vous aurez besoin de transistors à effet de champ qui ont peur de l'électricité statique, c'est tout. <br><br>  Le bouton de configuration est situé sur la ligne SCL.  Toutes les broches Attiny85 sont occupées!  Pour cette raison, Waterius ne prend pas en charge les sorties des compteurs Namur et n'a pas de capteur de fuite. <br>  La LED est connectée à la broche TX de l'ESP et s'allume lorsque l'ESP fonctionne.  Branchez l'adaptateur TTL-USB pour voir le journal (intéressant cependant!).  Au début du développement, je pensais que pour indiquer une erreur, vous devez faire clignoter la LED, mais vous y arriverez - cela ne fera que compliquer le code. <br>  Si vous vous connectez avec succès à un routeur Wi-Fi après 3 à 10 secondes, le voyant s'éteint et s'il continue de s'allumer, reconnectez votre téléphone à Waterius.  Technologie sophistiquée, nanotechnologie, réalisations de la NASA, enseignements de la Chine ancienne. <br><br>  Chacun de nous le sait: une caractéristique des appareils de faible puissance est leur sensibilité aux interférences électromagnétiques.  Je me suis donc tourné vers un ingénieur électronique familier et j'ai étudié la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">littérature</a> (+ le plus beau cours de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Murata</a> ).  Toutes les broches sur ESP et Attiny sont tirées sur alimentation ou GND.  Condensateurs de puissance installés.  La masse «sale» des compteurs est connectée à la masse «propre» via une résistance de 300 ohms, et les sorties elles-mêmes via une résistance 3k3.  Tout le monde le serait! <br><br><h3>  Logement </h3><br>  Nous prenons une bouteille en plastique ... une blague.  J'ai utilisé un compartiment pour 4 piles AA.  Un trou est découpé dans le couvercle du connecteur, sur le côté pour la LED et le bouton. <br><br><img src="https://habrastorage.org/webt/yl/dt/e2/yldte2s4juxluytorqdld8eumrs.jpeg"><br><br>  Vous pouvez utiliser la boîte de jonction (avec une imprimante 3D et d'autres chamanismes, expérimentez-vous si ce n'est pas le cas). <br><br>  Dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github se</a> trouve une carte monocouche pour LUT et une carte à deux couches pour la production en usine.  Waterius peut être fabriqué même par un écolier!  Certes, s'il n'a pas de hoverboard et ne fait jamais tourner le spinner. <br><br>  La planche idéale ne fonctionne pas tout de suite.  Le premier prototype ressemblait à ceci: <br><br><img src="https://habrastorage.org/webt/wd/3c/tw/wd3ctw183ioynjkuqnxhszttjee.jpeg"><br><br>  Mais la quatrième version, qui a été construite, est presque «parfaite»: <br><br><img src="https://habrastorage.org/webt/t3/uw/m4/t3uwm48xqxlcuef8u1nrgq3clkm.jpeg"><br><br>  Je n'ai pas pu résister et j'ai commandé un pack de planches en Resonite.  C'est élevé! <br><br><img src="https://habrastorage.org/webt/ok/hm/-n/okhm-nnvs0vnjlpdqiiezw_tts0.jpeg"><br><br><h3>  La nutrition </h3><br>  Dans Waterius, il y a un stabilisateur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">3V MCP1700</a> avec une consommation minimale très faible (quelques μA).  Trois piles alcalines AA 1,5 V <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pourront se décharger</a> presque complètement à 3,2 V. De plus, l'Attiny85 aura une tension stable (et la <a href="">fréquence</a> sera moins <a href="">flottante</a> , ce qui bourdonne, bien que ce ne soit pas important dans ce projet). <br><br>  Le circuit fonctionnera sans stabilisateur à partir de deux piles AA.  Attiny85 devrait acheter la version V (puissance jusqu'à 1,8 V).  ESP fonctionnait "sur Internet" jusqu'à 2,5V.  Nous pourrons utiliser 40% de la capacité de la batterie (ne le croyez pas - voir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">les</a> tests de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">A. Nadezhin</a> ).  Si vous achetez deux batteries au lithium AA 1.5V 3 Ah, Waterius fonctionnera jusqu'à 10 ans à basse température, et là - vous regardez - et nous construirons le communisme. <br><br>  Le manque d'outils ne me permet pas de mesurer avec précision la consommation de Waterius.  Il travaille chez lui depuis 45 jours, envoyant des relevés toutes les 30 minutes (pour accélérer la sortie).  La tension d'alimentation a chuté de 0,17 V de 4,68 V à 4,51 V (UPD: 100 jours 4,38 V, UPD2: 313 jours 3,9 V).  Si cela continue, les piles dureront 1,5 an.  L'envoi de relevés une fois par jour est 3 fois plus économique, donc 4 ans de travail.  Oui, je connais les batteries à décharge automatique.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">La fiche technique d'Energizer</a> et la durée de conservation sur les emballages indiquent qu'elle n'est pas solide. <br><br>  Voici un calcul de la consommation de la batterie et du coût des composants pour les plus curieux ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tableau Google</a> ). <br><br><h2>  Détails du programmeur (pour ceux qui ne sont pas fatigués) </h2><br>  La mise en œuvre du comptage d'impulsions sur les interruptions ne convient pas, car  l'eau peut être coupée au moment où l'interrupteur à lames est fermé (zone ~ 3L), et le courant traversera les résistances de tirage.  Une protection contre les rebonds de contact sera nécessaire: microcircuit ou retard du code.  J'ai implémenté un sondage périodique toutes les 250 ms et incrémenté (un beau mot, non?) Valeur uniquement avec une fermeture répétée.  Rien n'a besoin d'être soudé, bien que si vous le voulez vraiment, vous le pouvez. <br><br>  Pour me protéger contre le rechargement d'Attiny, je stocke toutes les valeurs dans sa mémoire EEPROM.  Pour dépasser la limite de 100 000 entrées, j'ai écrit un <a href="">tampon en anneau</a> avec une marque d'anneau pour la cellule actuelle.  Maintenant je dors paisiblement, c'est ce que je vous souhaite.  Le code prévoit l'inclusion de la journalisation pour le débogage.  Connectez le TTL-USB au deuxième connecteur de compteur. <br><br><h2>  Exportation de données </h2><br>  Au début, j'ai écrit le bot Telegram, mais Roskomnadzor a bloqué Telegram.  J'ai dû abandonner cette décision pour ne pas démarrer le serveur proxy et ne pas faire basculer le bateau.  L'utilisation de Blynk s'est avérée optimale (les développeurs intrépides ont du mal avec les verrous).  Voici le <a href="">code QR du projet</a> .  Outre lui, le projet Cayenne dispose d'une application téléphonique. <br><br>  L'envoi automatique vers Mosvodokanal n'est pas implémenté, car  projet à but non lucratif, mais quelles sont nos années.  Ou le vôtre.  Je n'ai pas les moyens d'entretenir mon serveur et de «légitimer» la procédure d'envoi, mais vous demandez des amis, tout d'un coup ... Je serai heureux de votre aide et de vos pensées libres. <br><br>  Les Moscovites envoient des témoignages par SMS, ce qui signifie qu'un serveur web suffit pour recevoir les données de Waterius et une page avec SMS ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github</a> ).  Les experts moscovites du programme Fiddler, qui utilisent l'application du service d'État de Moscou, devraient être intéressés par mon <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">script Python pour l'</a> envoi de lectures d'eau. <br><br><h2>  Développement </h2><br>  L'un des principaux freins lors de la création d'un nouveau produit est le perfectionnisme, comme vous le savez.  Il n'est pas nécessaire de créer une nouvelle fonction sans vérifier si les consommateurs en ont besoin.  Le code simple est plus facile à développer. <br><br>  Le chemin vers le perfectionnisme passe par <br><br><ul><li>  Mise à niveau du micrologiciel ESP et Attiny sur Internet </li><li>  UPD2: <s>prise en charge du HTTPS ou du chiffrement</s> </li><li>  un serveur où l'utilisateur pouvait télécharger son script pour envoyer des relevés d'eau. </li><li>  en utilisant STM8L / MSP430 (ils sont plus économiques et plus de broches) </li><li>  UPD2: <s>contrôle visuel de la présence de contact avec les compteurs connectés</s> </li><li>  indication de la période d'envoi de l'email  lettres </li><li>  UPD2: <s>prise en charge des</s> compteurs <s>pour les sorties</s> Namur </li><li>  capteur de fuite (UPD2: terminé lors de la réinitialisation) </li><li>  contrôle de grue </li><li>  support de compteur d'électricité </li></ul><br><h2>  Remerciements </h2><br>  Merci à <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ivan Kovalenko</a> et Ivan Ganzha pour leurs conseils en génie électrique, Aigul, E. Lapin  pour la bonne approche de la vie et papa pour le fait que je peux non seulement programmer, mais aussi souder, et pour vous - pour votre attention! <br><br><img src="https://habrastorage.org/webt/bi/rs/dg/birsdgh0skpa69dhb-q2mltxffs.jpeg"><br><br>  Je serai heureux de toutes suggestions, pool de demandes et critiques! <br><br>  Réchauffez le fer à souder!  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Projet Github</a> <br><br>  UPD2 05/07/2019: Merci à tous ceux qui contribuent au projet! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr418573/">https://habr.com/ru/post/fr418573/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr418561/index.html">Machines d'état au service de MVP. Conférence Yandex</a></li>
<li><a href="../fr418563/index.html">Le condensé de matériaux intéressants pour le développeur mobile # 263 (23 juillet - 29 juillet)</a></li>
<li><a href="../fr418565/index.html">En route vers une couverture de code à 100% avec des tests dans Go en utilisant sql-dumper comme exemple</a></li>
<li><a href="../fr418567/index.html">Dell cessera d'être une société privée et, pour la première fois en 5 ans, mettra des actions en bourse</a></li>
<li><a href="../fr418569/index.html">Nouveaux satellites - nouveaux bugs: le capteur infrarouge satellite GOES-17 ne refroidit pas bien</a></li>
<li><a href="../fr418575/index.html">«Ne décolle pas»: 6 gadgets audio insolites</a></li>
<li><a href="../fr418577/index.html">Gérez vos signets avec des balises - pour le plus grand plaisir de vous et de vos collègues</a></li>
<li><a href="../fr418579/index.html">Fonctionnement des bibliothèques d'environnement virtuel</a></li>
<li><a href="../fr418581/index.html">React Basics (manuel, 2e édition)</a></li>
<li><a href="../fr418585/index.html">Création d'une carte locale du pays du robot</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>