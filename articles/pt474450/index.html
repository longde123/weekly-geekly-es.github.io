<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∞ ‚õëÔ∏è ‚úåüèø Pare de usar TTL ridiculamente pequeno para DNS üë®üèª ü§öüèø üíÖüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A baixa lat√™ncia do DNS √© um fator essencial para uma navega√ß√£o r√°pida na Internet. Para minimiz√°-lo, √© importante selecionar cuidadosamente servidore...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pare de usar TTL ridiculamente pequeno para DNS</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/474450/"> A baixa lat√™ncia do DNS √© um fator essencial para uma navega√ß√£o r√°pida na Internet.  Para minimiz√°-lo, √© importante selecionar cuidadosamente servidores DNS e <a href="">retransmiss√£o an√¥nima</a> .  Mas a primeira coisa a fazer √© se livrar de consultas in√∫teis. <br><br>  √â por isso que o DNS foi criado originalmente como um protocolo altamente armazenado em cache.  Os administradores de zona definem uma vida √∫til (TTL) para registros individuais e os resolvedores usam essas informa√ß√µes ao armazenar registros na mem√≥ria para evitar tr√°fego desnecess√°rio. <br><br>  O cache √© eficiente?  H√° alguns anos, minha pequena pesquisa mostrou que n√£o era perfeita.  D√™ uma olhada no estado atual das coisas. <br><a name="habracut"></a><br>  Para coletar informa√ß√µes, corrigi o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">servidor DNS criptografado</a> para armazenar o valor TTL da resposta.  √â definido como o TTL m√≠nimo de suas entradas para cada solicita√ß√£o recebida.  Isso fornece uma boa vis√£o geral da distribui√ß√£o do tr√°fego real TTL e tamb√©m leva em considera√ß√£o a popularidade de solicita√ß√µes individuais.  A vers√£o corrigida do servidor funcionou por v√°rias horas. <br><br>  O conjunto de dados resultante consiste em 1.583.579 registros (nome, qtype, TTL, registro de data e hora).  Aqui est√° a distribui√ß√£o geral do TTL (o eixo X √© TTL em segundos): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ad8/32d/ae9/ad832dae907082ec2fc4dbc983e27f8d.png"><br><br>  Al√©m do pequeno monte em 86.400 (principalmente para registros SOA), √© bastante √≥bvio que os TTLs est√£o na faixa baixa.  Vamos dar uma olhada: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/112/70a/fdf/11270afdf48074f7a74747e3e29417d7.png"><br><br>  Bem, TTLs ao longo de 1 hora n√£o s√£o estatisticamente significativos.  Em seguida, foque no intervalo de 0 a 3600: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/851/a67/e4b/851a67e4baceeb03779679b70d291712.png"><br><br>  A maioria TTL de 0 a 15 minutos: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/310/28c/7bc/31028c7bcc13140d83a25998c2259b25.png"><br><br>  A grande maioria de 0 a 5 minutos: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b8d/52b/5d5/b8d52b5d5e051e624c22a2593eb7da7e.png"><br><br>  Isso n√£o √© muito bom. <br><br>  A distribui√ß√£o cumulativa torna o problema ainda mais √≥bvio: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/37d/c97/6ca/37dc976cac9d3aefc3ddef037e035cd9.png"><br><br>  Na metade das respostas do DNS, o TTL √© de 1 minuto ou menos e, em tr√™s quartos, de 5 minutos ou menos. <br><br>  Mas espere, √© realmente pior.  Afinal, isso √© TTL de servidores autorizados.  No entanto, os resolvedores de clientes (por exemplo, roteadores, caches locais) recebem TTLs de resolvedores mais altos e diminuem a cada segundo. <br><br>  Assim, o cliente pode realmente usar cada registro, em m√©dia, pela metade do TTL original, ap√≥s o qual enviar√° uma nova solicita√ß√£o. <br><br>  Talvez esses TTLs muito baixos digam respeito apenas a solicita√ß√µes incomuns, n√£o a sites e APIs populares?  Vamos ver: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/476/783/894/4767838946d6302bf216f28cd8c83d27.png"><br><br>  O eixo X √© TTL, o eixo Y √© a popularidade da consulta. <br><br>  Infelizmente, as consultas mais populares tamb√©m s√£o armazenadas em cache, o pior de tudo. <br><br>  Mais zoom: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c32/18f/c83/c3218fc832e85c1b3528778a384c99dd.png"><br><br>  Veredicto: tudo est√° muito ruim.  Era ruim antes, mas piorou.  O cache do DNS tornou-se praticamente in√∫til.  √Ä medida que menos pessoas usam o resolvedor DNS do seu ISP (por boas raz√µes), o aumento na lat√™ncia est√° se tornando mais percept√≠vel. <br><br>  O cache do DNS tornou-se √∫til apenas para o conte√∫do que ningu√©m visita. <br><br>  Observe tamb√©m que o software pode interpretar TTLs baixos de maneira <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">diferente</a> . <br><br><h1>  Por que isso? </h1><br>  Por que um TTL t√£o pequeno √© definido para registros DNS? <br><br><ul><li>  Os balanceadores de carga desatualizados s√£o deixados com as configura√ß√µes padr√£o. <br></li><li>  H√° mitos de que o balanceamento de carga do DNS depende do TTL (n√£o √© assim - desde o Netscape Navigator, os clientes escolhem um endere√ßo IP aleat√≥rio do conjunto RR e tentam outro de forma transparente se n√£o conseguirem se conectar) <br></li><li>  Os administradores desejam aplicar as altera√ß√µes imediatamente, porque √© mais f√°cil planejar. <br></li><li>  O administrador do servidor DNS ou do balanceador de carga v√™ sua tarefa como efetivamente implantar a configura√ß√£o solicitada pelos usu√°rios, em vez de acelerar sites e servi√ßos. <br></li><li>  TTL baixo proporciona tranq√ºilidade. <br></li><li>  As pessoas inicialmente definem TTLs baixos para teste e esquecem de alter√°-los. </li></ul><br>  N√£o inclu√≠ "failover" na lista, pois tudo isso √© menos relevante.  Se voc√™ precisar redirecionar os usu√°rios para outra rede apenas para exibir a p√°gina de erro, quando absolutamente tudo estiver quebrado, provavelmente ser√° aceit√°vel um atraso de mais de 1 minuto. <br><br>  Al√©m disso, o minuto TTL significa que, se os servidores DNS autorizados estiverem bloqueados por mais de um minuto, ningu√©m mais poder√° acessar os servi√ßos dependentes.  E a redund√¢ncia n√£o ajudar√° se a causa for um erro de configura√ß√£o ou invas√£o.  Por outro lado, com TTLs razo√°veis, muitos clientes continuar√£o usando a configura√ß√£o anterior e nunca perceber√£o nada. <br><br>  Os servi√ßos CDN e os balanceadores de carga s√£o os principais respons√°veis ‚Äã‚Äãpelos baixos TTLs, especialmente quando combinam CNAME com pequenos TTLs e registros com TTLs igualmente pequenos (mas independentes): <br><br><pre>  $ drill raw.githubusercontent.com
 raw.githubusercontent.com.  9 NO CNAME github.map.fastly.net.
 github.map.fastly.net.  20 EM A 151.101.128.133
 github.map.fastly.net.  20 EM A 151.101.192.133
 github.map.fastly.net.  20 EM A 151.101.0.133
 github.map.fastly.net.  20 EM A 151.101.64.133 </pre><br>  Sempre que um CNAME ou qualquer um dos registros A expirar, voc√™ dever√° enviar uma nova solicita√ß√£o.  Ambos t√™m um TTL de 30 segundos, mas n√£o corresponde.  O TTL m√©dio real ser√° de 15 segundos. <br><br>  Mas espera!  Ainda pior.  Alguns resolvedores se comportam muito mal nessa situa√ß√£o com dois TTLs baixos associados: <br><br><pre>  $ drill raw.githubusercontent.com @ 4.2.2.2
 raw.githubusercontent.com.  1 NO CNAME github.map.fastly.net.
 github.map.fastly.net.  1 EM A 151.101.16.133 </pre><br>  O resolvedor Level3 provavelmente funciona no BIND.  Se voc√™ continuar enviando essa solicita√ß√£o, sempre ser√° retornado um TTL 1. Essencialmente, <code>raw.githubusercontent.com</code> nunca <code>raw.githubusercontent.com</code> armazenado em cache. <br><br>  Aqui est√° outro exemplo de tal situa√ß√£o com um dom√≠nio muito popular: <br><br><pre>  $ drill detectportal.firefox.com @ 1.1.1.1
 detectportal.firefox.com.  25 NO CNAME detectportal.prod.mozaws.net.
 detectportal.prod.mozaws.net.  26 NO CNAME detectportal.firefox.com-v2.edgesuite.net.
 detectportal.firefox.com-v2.edgesuite.net.  10668 NO CNAME a1089.dscd.akamai.net.
 a1089.dscd.akamai.net.  10 EM A 104.123.50.106
 a1089.dscd.akamai.net.  10 EM A 104.123.50.88 </pre><br>  Pelo menos tr√™s registros CNAME.  Aw.  Um deles tem um TTL decente, mas √© completamente in√∫til.  Em outros CNAMEs, o TTL inicial √© de 60 segundos, mas para os dom√≠nios <code>akamai.net</code> TTL m√°ximo √© de 20 segundos e nenhum deles est√° em fase. <br><br>  E os dom√≠nios que pesquisam constantemente os dispositivos Apple? <br><br><pre>  $ drill 1-courier.push.apple.com @ 4.2.2.2
 1-courier.push.apple.com.  1253 NO CNAME 1.courier-push-apple.com.akadns.net.
 1.courier-push-apple.com.akadns.net.  1 EM CNAME gb-courier-4.push-apple.com.akadns.net.
 gb-courier-4.push-apple.com.akadns.net.  1 EM A 17.57.146.84
 gb-courier-4.push-apple.com.akadns.net.  1 EM A 17.57.146.85 </pre><br>  O mesmo problema que o Firefox tem e o TTL fica travado por 1 segundo na maioria das vezes ao usar o resolvedor Level3. <br><br>  Dropbox? <br><br><pre>  $ drill client.dropbox.com @ 8.8.8.8
 client.dropbox.com.  7 EM CNAME client.dropbox-dns.com.
 client.dropbox-dns.com.  59 EM A 162.125.67.3<font></font>
<font></font>
 $ drill client.dropbox.com @ 4.2.2.2
 client.dropbox.com.  1 EM CNAME client.dropbox-dns.com.
 client.dropbox-dns.com.  1 EM A 162.125.64.3 </pre><br>  <code>safebrowsing.googleapis.com</code> um TTL de 60 segundos, assim como nos dom√≠nios do Facebook.  E, novamente, do ponto de vista do cliente, esses valores s√£o reduzidos pela metade. <br><br><h1>  Que tal definir um TTL m√≠nimo? </h1><br>  Usando o nome, tipo de solicita√ß√£o, TTL e o carimbo de data / hora salvo originalmente, escrevi um script para simular 1,5 milh√£o de solicita√ß√µes passando por um resolvedor de cache, a fim de estimar a quantidade de solicita√ß√µes extras enviadas devido a uma entrada de cache expirada. <br><br>  47,4% dos pedidos foram feitos ap√≥s a expira√ß√£o do registro existente.  Isso √© irracionalmente alto. <br><br>  Qual ser√° o efeito no armazenamento em cache se o TTL m√≠nimo estiver definido? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/567/031/322/56703132270c3b852be408660d27d78d.png"><br><br>  O eixo X √© o valor TTL m√≠nimo.  Registros com TTLs de origem acima desse valor n√£o s√£o afetados. <br><br>  Eixo Y - porcentagem de solicita√ß√µes de um cliente que j√° possui um registro em cache, mas expirou e faz uma nova solicita√ß√£o. <br><br>  A porcentagem de solicita√ß√µes "extras" √© reduzida de 47% para 36%, basta definir o TTL m√≠nimo em 5 minutos.  Ao definir o TTL m√≠nimo em 15 minutos, o n√∫mero dessas solicita√ß√µes √© reduzido para 29%.  Um TTL m√≠nimo de 1 hora os reduz para 17%.  A grande diferen√ßa! <br><br>  Que tal n√£o mudar nada no lado do servidor, mas definir o TTL m√≠nimo nos caches DNS do cliente (roteadores, resolvedores locais)? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/047/214/099/047214099e2253d3dc3816c76c366a6b.png"><br><br>  O n√∫mero de solicita√ß√µes necess√°rias √© reduzido de 47% para 34% ao definir o TTL m√≠nimo em 5 minutos, para 25% com um m√≠nimo de 15 minutos e at√© 13% com um m√≠nimo de 1 hora.  Talvez o valor ideal seja 40 minutos. <br><br>  O impacto dessa mudan√ßa m√≠nima √© enorme. <br><br><h1>  Quais s√£o as implica√ß√µes? </h1><br>  Obviamente, o servi√ßo pode ser transferido para um novo provedor de nuvem, um novo servidor, uma nova rede, exigindo que os clientes usem os registros DNS mais recentes.  E um TTL suficientemente pequeno ajuda a fazer essa transi√ß√£o sem problemas.  Por√©m, com a transi√ß√£o para uma nova infraestrutura, ningu√©m espera que os clientes mudem para novos registros DNS dentro de 1 minuto, 5 minutos ou 15 minutos.  Definir uma vida √∫til m√≠nima de 40 minutos em vez de 5 minutos n√£o impedir√° que os usu√°rios acessem o servi√ßo. <br><br>  No entanto, isso reduzir√° significativamente a lat√™ncia e aumentar√° a confidencialidade e a confiabilidade, evitando solicita√ß√µes desnecess√°rias. <br><br>  Obviamente, os RFCs dizem que voc√™ precisa aplicar estritamente o TTL.  Mas a realidade √© que o sistema DNS se tornou muito ineficiente. <br><br>  Se voc√™ trabalha com servidores DNS autoritativos, verifique seu TTL.  Voc√™ realmente precisa de valores ridiculamente baixos? <br><br>  Obviamente, existem boas raz√µes para definir pequenos TTLs para registros DNS.  Mas n√£o para 75% do tr√°fego DNS, que permanece praticamente inalterado. <br><br>  E se, por algum motivo, voc√™ realmente precisar usar TTL baixo para DNS, ao mesmo tempo, verifique se o cache n√£o est√° ativado no seu site.  Pelas mesmas raz√µes. <br><br>  Se voc√™ possui um cache DNS local, como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">dnscrypt-proxy</a> , que permite definir o TTL m√≠nimo, use esta fun√ß√£o.  Isso √© normal.  Nada de ruim vai acontecer.  Defina o TTL m√≠nimo entre aproximadamente 40 minutos (2400 segundos) e 1 hora.  Um intervalo bastante razo√°vel. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt474450/">https://habr.com/ru/post/pt474450/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt474438/index.html">Simples e em C ++. Userver Basics - Uma estrutura para escrever microsservi√ßos ass√≠ncronos</a></li>
<li><a href="../pt474440/index.html">Dificuldades no c√°lculo da receita de assinaturas renov√°veis ‚Äã‚Äãautomaticamente em aplicativos iOS</a></li>
<li><a href="../pt474442/index.html">Hist√≥ria da extens√£o da vida irlandesa</a></li>
<li><a href="../pt474444/index.html">Mais 5 projetos de treinamento ousados ‚Äã‚Äãpara o desenvolvedor (Camada, Squoosh, Calculadora, Rastreador de sites, Leitor de m√∫sica)</a></li>
<li><a href="../pt474448/index.html">O que o c√©rebro de um estudante no mundo da computa√ß√£o √© capaz</a></li>
<li><a href="../pt474452/index.html">Relat√≥rio de status de outono Haxe</a></li>
<li><a href="../pt474458/index.html">Total acumulado em SQL</a></li>
<li><a href="../pt474460/index.html">Descri√ß√£o das arquiteturas de processador no LLVM usando o TableGen</a></li>
<li><a href="../pt474462/index.html">Enorme conjunto de dados aberto da vers√£o 1.0 do discurso russo</a></li>
<li><a href="../pt474466/index.html">Hist√≥ria do primeiro Diablo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>