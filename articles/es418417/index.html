<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßöüèø üë©üèΩ‚Äçüè´ üõ∞Ô∏è Apolo: 9 meses - vuelo normal üõÄüèæ üê¨ ‚ò∏Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola a todos, mi nombre es Semyon Levenson, trabajo como l√≠der de equipo en el proyecto Stream de Rambler Group y quiero hablar sobre nuestra experien...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Apolo: 9 meses - vuelo normal</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/rambler-co/blog/418417/"><p><img src="https://habrastorage.org/webt/ww/0p/je/ww0pjeoegdfxhlx-zfh54jbxvyw.png" alt="imagen"></p><br><p>  Hola a todos, mi nombre es Semyon Levenson, trabajo como l√≠der de equipo en el proyecto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Stream</a> de Rambler Group y quiero hablar sobre nuestra experiencia con Apollo. </p><br><p>  Explicar√© qu√© es el "Stream".  Este es un servicio automatizado para emprendedores, que le permite atraer clientes desde Internet a su negocio sin involucrarse en publicidad, y crear r√°pidamente sitios simples sin ser un experto en dise√±o. </p><a name="habracut"></a><br><p>  La captura de pantalla muestra uno de los pasos para crear una p√°gina de destino. </p><br><p><img src="https://habrastorage.org/webt/rf/vg/dj/rfvgdjmcvzpwydgz9qcdu8_3eay.png"></p><br><h3 id="chto-bylo-vnachale">  ¬øCu√°l fue el comienzo? </h3><br><p> Y al principio hab√≠a MVP, muchos Twig, jQuery y plazos muy ajustados.  Pero seguimos un camino no est√°ndar y decidimos hacer un redise√±o.  El redise√±o no tiene el sentido de "estilos parcheados", pero decidi√≥ revisar completamente el sistema.  Y esta fue una buena etapa para nosotros para armar la interfaz perfecta.  Despu√©s de todo, nosotros, el equipo de desarrollo, deber√≠amos continuar apoyando esto e implementar otras tareas sobre la base de esto, para lograr nuevas metas establecidas por el equipo del producto. </p><br><p>  Nuestro departamento ya ha acumulado suficiente experiencia en el uso de React.  No quer√≠a pasar 2 semanas configurando el paquete web, as√≠ que decid√≠ usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">CRA</a> (Crear aplicaci√≥n de reacci√≥n).  Para los estilos, se tomaron <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Componentes con estilo</a> , y donde sin escribir, tomaron <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Flow</a> .  Tomaron <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Redux</a> para la Gesti√≥n del Estado, pero como resultado result√≥ que no lo necesitamos en absoluto, pero m√°s sobre eso m√°s adelante. </p><br><p>  Armamos nuestra interfaz perfecta y nos dimos cuenta de que nos hab√≠amos olvidado de algo.  Al final result√≥ que, nos olvidamos del backend, o m√°s bien de la interacci√≥n con √©l.  Cuando pens√≥ en lo que podemos usar para organizar esta interacci√≥n, lo primero que se le ocurri√≥, por supuesto, es Descansar.  No, no fuimos a descansar (sonr√≠e), sino que comenzamos a hablar sobre la API RESTful.  En principio, la historia es familiar, se extiende por mucho tiempo, pero tambi√©n sabemos sobre los problemas con ella.  Hablaremos de ellos. </p><br><p>  El primer problema es la documentaci√≥n.  RESTful, por supuesto, no dice c√≥mo organizar la documentaci√≥n.  Aqu√≠ hay una opci√≥n para usar el mismo swagger, pero de hecho es la introducci√≥n de una entidad adicional y la complicaci√≥n de los procesos. </p><br><p>  El segundo problema es c√≥mo organizar el soporte para versionar la API. </p><br><p>  El tercer problema importante es una gran cantidad de consultas o puntos finales personalizados que podemos recompensar.  Supongamos que necesitamos solicitar publicaciones, para estas publicaciones: comentarios y m√°s autores de estos comentarios.  En el cl√°sico Rest, tenemos que hacer al menos 3 consultas.  S√≠, podemos recompensar puntos finales personalizados, y todo esto se puede reducir a 1 solicitud, pero esto ya es una complicaci√≥n. </p><br><p><img src="https://habrastorage.org/webt/mo/os/uv/moosuvdayfwhr7r2dqswlg9nuuk.png"><br>  <em>Gracias <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Sashko Stubailo</a> por la ilustraci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">.</a></em> </p><br><h3 id="reshenie">  Soluci√≥n </h3><br><p>  Y en este momento, Facebook viene en nuestra ayuda con GraphQL.  ¬øQu√© es GraphQL?  Esta es una plataforma, pero hoy veremos una de sus partes: este es el lenguaje de consulta para su API, solo un idioma y bastante primitivo.  Y funciona de la manera m√°s simple posible: a medida que solicitamos alg√∫n tipo de entidad, tambi√©n lo obtenemos. </p><br><p>  Solicitud: </p><br><pre><code class="hljs objectivec">{ me { <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> isAcceptedFreeOffer balance } }</code> </pre> <br><p>  La respuesta es: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"me"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"isAcceptedFreeOffer"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"balance"</span></span>: <span class="hljs-number"><span class="hljs-number">100000</span></span> } }</code> </pre> <br><p>  Pero GraphQL no solo se trata de leer, tambi√©n se trata de cambiar los datos.  Para hacer esto, hay mutaciones en GraphQL.  Las mutaciones son notables porque podemos declarar la respuesta deseada desde el backend, con un cambio exitoso.  Sin embargo, hay algunos matices.  Por ejemplo, si nuestra mutaci√≥n afecta datos fuera de los l√≠mites del gr√°fico. </p><br><p>  Un ejemplo de una mutaci√≥n en la que utilizamos una oferta gratuita: </p><br><pre> <code class="hljs nginx"><span class="hljs-section"><span class="hljs-section">mutation</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">acceptOffer</span></span> (_type: FREE) { <span class="hljs-attribute"><span class="hljs-attribute">id</span></span> isAcceptedFreeOffer } }</code> </pre> <br><p>  En respuesta, obtenemos la misma estructura solicitada </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"acceptOffer"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"isAcceptedFreeOffer"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } }</code> </pre> <br><p>  La interacci√≥n con el backend GraphQL se puede hacer usando fetch regular. </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">fetch</span></span>(<span class="hljs-string"><span class="hljs-string">'/graphql'</span></span>, { <span class="hljs-keyword"><span class="hljs-keyword">method</span></span>: <span class="hljs-string"><span class="hljs-string">'POST'</span></span>, headers: { <span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/json'</span></span> }, body: <span class="hljs-type"><span class="hljs-type">JSON</span></span>.stringify({ query: <span class="hljs-string"><span class="hljs-string">'{me { id balance } }'</span></span> }) });</code> </pre> <br><h3 id="kakie-zhe-plyusy-u-graphql">  ¬øCu√°les son las ventajas de GraphQL? </h3><br><p>  La primera y muy buena ventaja que se puede apreciar cuando comienzas a trabajar con √©l es que este lenguaje est√° fuertemente tipado y autodocumentado.  Al dise√±ar el esquema GraphQL en el servidor, podemos describir inmediatamente los tipos y atributos directamente en el c√≥digo. </p><br><p><img src="https://habrastorage.org/webt/7l/oh/ze/7lohze1ioujv7qchctics80_qd8.png"></p><br><p>  Como se mencion√≥ anteriormente, RESTful tiene un problema de versiones.  GraphQL implement√≥ una soluci√≥n muy elegante para esto: en desuso. </p><br><p><img src="https://habrastorage.org/webt/zr/la/rr/zrlarrevkaenkyjdx7yzm6wbm5a.png"></p><br><p>  Supongamos que tenemos una pel√≠cula, la ampliamos y tenemos un director.  Y en alg√∫n momento simplemente hacemos del director un tipo separado.  La pregunta es, ¬øqu√© hacer con el √∫ltimo campo de director?  Hay dos respuestas: eliminamos este campo o lo marcamos como obsoleto y desaparece autom√°ticamente de la documentaci√≥n. </p><br><p>  Decidimos independientemente lo que necesitamos. </p><br><p>  Recordamos la imagen anterior, donde todo fue con REST, pero aqu√≠ todo se combina en una solicitud y no requiere ninguna personalizaci√≥n del desarrollo del backend.  Una vez que todos lo describieron, y giramos, giramos, hacemos malabares. </p><br><p><img src="https://habrastorage.org/webt/k2/rs/rp/k2rsrp234e3xoe6gs8jmwpy1rse.png"></p><br><p>  Pero no sin una mosca en la pomada.  En principio, no hay tantos inconvenientes para GraphQL en la interfaz, porque se desarroll√≥ originalmente para resolver problemas de interfaz.  Pero el backend no funciona tan bien ... Tienen un problema como N + 1.  Tome la consulta como ejemplo: </p><br><pre> <code class="hljs objectivec">{ landings(_page: <span class="hljs-number"><span class="hljs-number">0</span></span>, limit: <span class="hljs-number"><span class="hljs-number">20</span></span>) { nodes { <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> title } totalCount } }</code> </pre> <br><p>  Una solicitud simple, solicitamos 20 sitios y la cantidad de sitios que tenemos.  Y en el backend, esto puede convertirse en 21 consultas de bases de datos.  Este problema es conocido, resuelto.  Para Node JS hay un paquete de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">carga</a> de datos de Facebook.  Para otros idiomas, puede encontrar sus propias soluciones. </p><br><p>  Tambi√©n existe el problema de la anidaci√≥n profunda.  Por ejemplo, tenemos √°lbumes, estos √°lbumes tienen canciones y, a trav√©s de la canci√≥n, tambi√©n podemos obtener √°lbumes.  Para hacer esto, realice las siguientes consultas: </p><br><pre> <code class="hljs objectivec">{ album(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: <span class="hljs-number"><span class="hljs-number">42</span></span>) { songs { title artists } } }</code> </pre> <br><pre> <code class="hljs dos">{ song(id: <span class="hljs-number"><span class="hljs-number">1337</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">title</span></span> album { <span class="hljs-built_in"><span class="hljs-built_in">title</span></span> } } }</code> </pre> <br><p>  Por lo tanto, obtenemos una consulta recursiva, que tambi√©n nos sirve de base. </p><br><pre> <code class="hljs objectivec">query evil { album(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: <span class="hljs-number"><span class="hljs-number">42</span></span>) { songs { album { songs { album {</code> </pre> <br><p>  Este problema tambi√©n es conocido, la soluci√≥n para Node JS es el l√≠mite de profundidad de GraphQL, para otros idiomas tambi√©n hay soluciones. </p><br><p>  Por lo tanto, nos decidimos por GraphQL.  Es hora de elegir una biblioteca que funcione con la API GraphQL.  El ejemplo en un par de l√≠neas con fetch, que se muestra arriba, es solo un transporte.  Pero gracias al esquema y la capacidad de declaraci√≥n, tambi√©n podemos almacenar en cach√© las consultas en el frente y trabajar con un mayor rendimiento con el backend GraphQL. </p><br><p>  Entonces tenemos dos jugadores principales: Relay y Apollo. </p><br><h3 id="relay">  Rel√© </h3><br><p>  Relay es un desarrollo de Facebook, lo usan ellos mismos.  Como Oculus, Circle CI, Arsti y Friday. </p><br><h4 id="kakie-plyusy-est-u-relay">  ¬øCu√°les son las ventajas de Relay? </h4><br><p>  La ventaja inmediata es que el desarrollador es Facebook.  React, Flow y GraphQL son desarrollos de Facebook, todos los cuales son rompecabezas dise√±ados entre s√≠.  D√≥nde estamos sin estrellas en Github, Relay tiene casi 11,000, Apollo tiene 7600 en comparaci√≥n. Lo bueno que tiene Relay es Relay-compiler, una herramienta que optimiza y analiza sus consultas GraphQL en el nivel de construcci√≥n de su proyecto .  Podemos suponer que esto es uglify solo para GraphQL: </p><br><pre> <code class="hljs scala">#  <span class="hljs-type"><span class="hljs-type">Relay</span></span>-compiler foo { # <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FooType</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> ... </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">on</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FooType</span></span></span><span class="hljs-class"> </span></span>{ # matches the parent <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">so</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">is</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">extraneous</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> } } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">#</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foo</span></span></span><span class="hljs-class"> </span></span>{ id }</code> </pre> <br><h4 id="kakie-minusy-u-relay">  ¬øCu√°les son los contras de Relay? </h4><br><p>  El primer menos * es la falta de SSR fuera de la caja.  Github todav√≠a tiene un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">problema</a> abierto.  Por qu√© bajo el asterisco, porque ya hay soluciones, pero son de terceros y, adem√°s, bastante ambiguas. </p><br><p><img src="https://habrastorage.org/webt/ee/1b/rc/ee1brchbmmgdpqka4kpf3ogo2my.png"></p><br><p>  Nuevamente, Relay es una especificaci√≥n.  El hecho es que GraphQL ya es una especificaci√≥n, y Relay es una especificaci√≥n sobre una especificaci√≥n. </p><br><p><img src="https://habrastorage.org/webt/f6/ds/nl/f6dsnlwzog77hrwpboaru95u7_y.png"></p><br><p>  Por ejemplo, la paginaci√≥n de retransmisi√≥n se implementa de manera diferente, aqu√≠ aparecen los cursores. </p><br><pre> <code class="hljs pgsql">{ friends(first: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">after</span></span>: "opaqueCursor") { edges { <span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span> node { id <span class="hljs-type"><span class="hljs-type">name</span></span> } } pageInfo { hasNextPage } } }</code> </pre> <br><p>  Ya no usamos las compensaciones y l√≠mites habituales.  Para los feeds en el feed, este es un gran tema, pero cuando comenzamos a hacer todo tipo de cuadr√≠culas, entonces hay dolor. </p><br><p>  Facebook resolvi√≥ su problema escribiendo una biblioteca para React.  Hay soluciones para otras bibliotecas, para vue.js, por ejemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">vue-relay</a> .  Pero si prestamos atenci√≥n a la cantidad de estrellas y commits, entonces aqu√≠ tambi√©n, no todo es tan suave y puede ser inestable.  Por ejemplo, la aplicaci√≥n Crear Reacci√≥n fuera del cuadro CRA le impide usar el compilador de retransmisi√≥n.  Pero puede sortear esta limitaci√≥n con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">react-app-rewired</a> . </p><br><p><img src="https://habrastorage.org/webt/dj/wb/i2/djwbi2it6brz4qxdipg0wcdyhpa.png"></p><br><h2 id="apollo">  Apolo </h2><br><p>  Nuestro segundo candidato es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Apolo</a> .  Desarrollado por su equipo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Meteor</a> .  Apollo utiliza comandos tan conocidos como: AirBnB, ticketmaster, Opentable, etc. </p><br><h3 id="kakie-est-plyusy-u-apollo">  ¬øCu√°les son las ventajas de Apollo? </h3><br><p>  La primera ventaja importante es que Apollo se desarroll√≥ como una biblioteca agn√≥stica de framework.  Por ejemplo, si ahora queremos reescribir todo en Angular, entonces esto no ser√° un problema, Apollo trabaja con esto.  E incluso puedes escribir todo en Vanilla. </p><br><p>  Apollo tiene buena documentaci√≥n, hay soluciones listas para problemas comunes. </p><br><p><img src="https://habrastorage.org/webt/tq/wu/ko/tqwukoydh-b7fem6dwusyuwklgw.png"></p><br><p>  Otra ventaja de Apollo: una potente API.  En principio, aquellos que trabajaron con Redux encontrar√°n enfoques comunes aqu√≠: hay ApolloProvider (como Provux para Redux), y en lugar de almacenar para Apollo, esto se llama cliente: </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { ApolloProvider } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-apollo'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { ApolloClient } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./ApolloClient'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> App = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">ApolloProvider</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">client</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{ApolloClient}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ... </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">ApolloProvider</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> );</code> </pre> <br><p>  A nivel del componente en s√≠, tenemos Graphql HOC proporcionado como conexi√≥n.  Y escribimos la consulta GraphQL ya dentro, como MapStateToProps en Redux. </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { graphql } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-apollo'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> gql <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'graphql-tag'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Landing } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./Landing'</span></span>; graphql(gql<span class="hljs-string"><span class="hljs-string">` { landing(id: 1) { id title } } `</span></span>)(Landing);</code> </pre> <br><p>  Pero cuando hacemos MapStateToProps en Redux, recogemos los datos locales.  Si no hay datos locales, el propio Apollo va al servidor a buscarlos.  Los accesorios muy convenientes caen en el componente mismo. </p><br><pre> <code class="hljs actionscript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Landing</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">({ data, loading, error, refetch, </span></span><span class="hljs-rest_arg"><span class="hljs-function"><span class="hljs-params"><span class="hljs-rest_arg">...other</span></span></span></span><span class="hljs-function"><span class="hljs-params"> })</span></span></span><span class="hljs-function"> </span></span>{ ... }</code> </pre> <br><p>  Esto es: <br>  ‚Ä¢ datos; <br>  ‚Ä¢ estado de descarga; <br>  ‚Ä¢ un error si ocurri√≥; <br>  funciones auxiliares como refetch para recargar datos o fetchMore para paginar.  Tambi√©n hay una gran ventaja tanto para Apollo como para Relay, que es la interfaz de usuario optimista.  Le permite confirmar deshacer / rehacer en el nivel de solicitud: </p><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props.setNotificationStatusMutation({ variables: { ‚Ä¶ }, optimisticResponse: { ‚Ä¶ } });</code> </pre> <br><p>  Por ejemplo, el usuario hizo clic en el bot√≥n "me gusta", y el "me gusta" cont√≥ inmediatamente.  En este caso, se enviar√° una solicitud al servidor en segundo plano.  Si se produce alg√∫n error durante el proceso de env√≠o, los datos mutables volver√°n a su estado original por s√≠ solos. </p><br><p>  La representaci√≥n del lado del servidor est√° bien implementada, configuramos un indicador en el cliente y todo est√° listo. </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">new</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ApolloClient</span></span>({ <span class="hljs-attribute"><span class="hljs-attribute">ssrMode</span></span>: true, ... });</code> </pre> <br><p>  Pero aqu√≠ me gustar√≠a hablar sobre el estado inicial.  Cuando Apolo lo cocina para s√≠ mismo, todo funciona bien. </p><br><pre> <code class="hljs javascript">&lt;script&gt; <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.__APOLLO_STATE__ = client.extract(); <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApolloClient({ <span class="hljs-attr"><span class="hljs-attr">cache</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InMemoryCache().restore(<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.__APOLLO_STATE__), link });</code> </pre> <br><p>  Pero no tenemos renderizado del lado del servidor, y el backend empuja una consulta GraphQL espec√≠fica a la variable global.  Aqu√≠ necesita una peque√±a muleta, debe escribir una funci√≥n Transformar para que la respuesta GraphQL del backend ya se convierta en el formato necesario para Apollo. </p><br><pre> <code class="hljs javascript">&lt;script&gt; <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.__APOLLO_STATE__ = transform({‚Ä¶}); <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApolloClient({ <span class="hljs-attr"><span class="hljs-attr">cache</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InMemoryCache().restore(<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.__APOLLO_STATE__), link });</code> </pre> <br><p>  Otra ventaja de Apollo es que es muy personalizable.  Todos recordamos el middleware de Redux, aqu√≠ todo es igual, solo que esto se llama enlace. </p><br><p><img src="https://habrastorage.org/webt/va/gw/-z/vagw-zeeg2j0t7pjuawtw4tllq8.png"></p><br><p>  Me gustar√≠a se√±alar por separado dos enlaces: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">apollo-link-state</a> , que es necesario para almacenar el estado local en ausencia de Redux, y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">apollo-link-rest</a> , si queremos escribir consultas GraphQL en la API Rest.  Sin embargo, con este √∫ltimo debe ser extremadamente cuidadoso, porque  Pueden surgir ciertos problemas. </p><br><h4 id="minusy-u-apollo-tozhe-est">  Apolo tambi√©n tiene contras </h4><br><p>  Veamos un ejemplo.  Hubo un problema de rendimiento inesperado: se solicitaron 2.000 elementos en la interfaz (era un directorio) y comenzaron los problemas de rendimiento.  Despu√©s de verlo en el depurador, result√≥ que Apollo consume muchos recursos mientras lee, el problema est√° b√°sicamente cerrado, ahora todo est√° bien, pero hubo un pecado. </p><br><p>  Adem√°s, la refetch result√≥ ser muy obvia ... </p><br><pre> <code class="hljs actionscript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Landing</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">({ loading, refetch, </span></span><span class="hljs-rest_arg"><span class="hljs-function"><span class="hljs-params"><span class="hljs-rest_arg">...other</span></span></span></span><span class="hljs-function"><span class="hljs-params"> })</span></span></span><span class="hljs-function"> </span></span>{ ... }</code> </pre> <br><p>  Parece que cuando hacemos una nueva solicitud de datos, adem√°s, si la solicitud anterior termin√≥ con un error, la carga deber√≠a ser verdadera.  Pero no! </p><br><p>  Para que esto suceda, debe especificar notifyOnNetworkStatusChange: true en el HOC graphql, o almacenar localmente el estado de recuperaci√≥n. </p><br><h3 id="apollo-vs-relay">  Apolo vs.  Rel√© </h3><br><p>  Por lo tanto, obtuvimos dicha tabla, todos pesamos, contamos y ten√≠amos un 76% detr√°s de Apolo. </p><br><p><img src="https://habrastorage.org/webt/ry/if/wx/ryifwxtkdmb4yvc2xczme5xoqkc.png"></p><br><p>  As√≠ que elegimos la biblioteca y nos pusimos a trabajar. </p><br><p>  Pero me gustar√≠a decir m√°s sobre la cadena de herramientas. </p><br><p>  Aqu√≠ todo es muy bueno, hay varios complementos para editores, en alg√∫n lugar mejor, en alg√∫n lugar peor.  Tambi√©n hay apollo-codegen, que genera archivos √∫tiles, por ejemplo, tipos de flujo, y b√°sicamente extrae el esquema de la API GraphQL. </p><br><h3 id="rubrika-ochumelye-ruchki-ili-chto-my-sdelali-u-sebya">  El t√≠tulo "Manos locas" o lo que hicimos en casa </h3><br><p>  Lo primero que encontramos fue que b√°sicamente necesitamos solicitar datos de alguna manera. </p><br><pre> <code class="hljs lisp">graphql(<span class="hljs-name"><span class="hljs-name">BalanceQuery</span></span>)(<span class="hljs-name"><span class="hljs-name">BalanceItem</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  Tenemos condiciones comunes: carga, manejo de errores.  Escribimos nuestro propio halc√≥n (asyncCard), que est√° conectado a trav√©s de la composici√≥n de graqhql y asyncCard. </p><br><pre> <code class="hljs lisp">compose( <span class="hljs-name"><span class="hljs-name">graphql</span></span>(<span class="hljs-name"><span class="hljs-name">BalanceQuery</span></span>), AsyncCard )(<span class="hljs-name"><span class="hljs-name">BalanceItem</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  Tambi√©n me gustar√≠a hablar sobre fragmentos.  Hay un componente LandingItem y sabe qu√© datos necesita de la API GraphQL.  Establecemos la propiedad del fragmento, donde especificamos los campos de la entidad de aterrizaje. </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> LandingItem = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ content }: Props</span></span></span><span class="hljs-function">) =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">LandingItemStyle</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ‚Ä¶ </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">LandingItemStyle</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> ); LandingItem.fragment = gql<span class="hljs-string"><span class="hljs-string">` fragment LandingItem on Landing { ... } `</span></span>;</code> </pre> <br><p>  Ahora, en el nivel de uso de componentes, usamos su fragmento en la solicitud final. </p><br><pre> <code class="hljs bash">query LandingsDashboard { landings(...) { nodes { ...LandingItem } totalCount } <span class="hljs-variable"><span class="hljs-variable">${LandingItem.Fragment}</span></span> }</code> </pre> <br><p>  Y supongamos que una tarea vuela para agregar estado a esta p√°gina de destino, no es un problema.  Agregamos una propiedad al render y al fragmento.  Y todo est√° listo.  Principio de responsabilidad √∫nica en todo su esplendor. </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> LandingItem = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ content }: Props</span></span></span><span class="hljs-function">) =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">LandingItemStyle</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ‚Ä¶ </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">LandingItemStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> ‚Ä¶ /&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">LandingItemStyle</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ); LandingItem.fragment = gql` fragment LandingItem on Landing { ... status } `;</span></span></code> </pre> <br><h4 id="kakaya-u-nas-esche-byla-problema">  ¬øQu√© otro problema tuvimos? </h4><br><p>  Tenemos una serie de widgets en nuestro sitio que hicieron sus solicitudes individuales. </p><br><p><img src="https://habrastorage.org/webt/ab/li/-x/abli-xjzcmoq9_p2rtnorl-y3qu.png"></p><br><p>  Durante las pruebas, result√≥ que todo esto se ralentiza.  Tenemos controles de seguridad muy largos y cada solicitud es muy costosa.  Esto tambi√©n result√≥ no ser un problema, hay Apollo-link-batch-http </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">new</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BatchHttpLink</span></span>({ <span class="hljs-attribute"><span class="hljs-attribute">batchMax</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, batchInterval: <span class="hljs-number"><span class="hljs-number">10</span></span> });</code> </pre> <br><p>  Se configura de la siguiente manera: pasamos el n√∫mero de solicitudes que podemos combinar y cu√°nto tiempo esperar√° este enlace despu√©s de que aparezca la primera solicitud. <br>  Y result√≥ as√≠: al mismo tiempo, todo se est√° cargando, y al mismo tiempo todo llega.  Vale la pena se√±alar que si durante esta fusi√≥n cualquiera de las subconsultas regresa con un error, entonces el error solo estar√° con √©l, y no con toda la solicitud. </p><br><h4 id="hochetsya-otdelno-rasskazat-chto-proshloy-osenyu-proizoshlo-obnovlenie-s-pervogo-apollo-na-vtoroy">  Me gustar√≠a decir por separado que el oto√±o pasado hubo una actualizaci√≥n del primer Apolo al segundo </h4><br><p>  Al principio era Apolo y Redux. </p><br><pre> <code class="hljs cs"><span class="hljs-string"><span class="hljs-string">'react-apollo'</span></span> <span class="hljs-string"><span class="hljs-string">'redux'</span></span></code> </pre> <br><p>  Luego, Apollo se volvi√≥ m√°s modular y expandible, estos m√≥dulos se pueden desarrollar de forma independiente.  El mismo apollo-cache-inmemory. </p><br><pre> <code class="hljs cs"><span class="hljs-string"><span class="hljs-string">'react-apollo'</span></span> <span class="hljs-string"><span class="hljs-string">'apollo-client'</span></span> <span class="hljs-string"><span class="hljs-string">'apollo-link-batch-http'</span></span> <span class="hljs-string"><span class="hljs-string">'apollo-cache-inmemory'</span></span> <span class="hljs-string"><span class="hljs-string">'graphql-tag'</span></span></code> </pre> <br><p>  Vale la pena se√±alar que Redux no lo es, y result√≥ que, en principio, no es necesario. </p><br><h2 id="vyvody">  Conclusiones: </h2><br><ol><li>  El tiempo de entrega de funciones ha disminuido, no perdemos el tiempo describiendo acciones, reducimos en Redux y tocamos menos el backend </li><li>  La antifragilidad apareci√≥ porque  El an√°lisis est√°tico de la API le permite anular los problemas cuando el frontend espera una cosa y el backend devuelve uno completamente diferente. </li><li>  Si comienza a trabajar con GraphQL, pruebe Apollo, no se decepcione. </li></ol><br><p>  PD: Tambi√©n puedes ver un video de mi presentaci√≥n en Rambler Front &amp; Meet up # 4 </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/rCEoy-V3x8k" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es418417/">https://habr.com/ru/post/es418417/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es418403/index.html">Ejemplo de programaci√≥n del acelerador FPGA</a></li>
<li><a href="../es418405/index.html">El principio de la pir√°mide invertida en anal√≠tica. Construimos un tablero entendible</a></li>
<li><a href="../es418407/index.html">La miner√≠a en la nube Hashflare se ha cerrado. El dinero no vuelve</a></li>
<li><a href="../es418411/index.html">Tirador de red del navegador en Node.js</a></li>
<li><a href="../es418415/index.html">Telegram present√≥ su propio servicio de pasaportes para verificaci√≥n y autorizaci√≥n de usuarios</a></li>
<li><a href="../es418419/index.html">C√≥mo Dodo Pizza resuelve los problemas comerciales con el aprendizaje autom√°tico</a></li>
<li><a href="../es418423/index.html">Hogar inteligente: una nueva dimensi√≥n de confort y la b√∫squeda de la excelencia. Primera parte</a></li>
<li><a href="../es418427/index.html">Mobile-first indexing. ¬øC√≥mo y por qu√© cambiar√° el gr√°fico de enlaces?</a></li>
<li><a href="../es418429/index.html">Mi experiencia laboral para el papel del entrenador √°gil en Europa, segunda parte</a></li>
<li><a href="../es418431/index.html">Problemas imaginarios: la ra√≠z del mal software</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>