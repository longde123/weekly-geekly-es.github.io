<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶à üì° üèÑ Site-Statistiken und Ihr kleines Repository üèùÔ∏è üë©üèø‚Äçüåæ üçâ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Das Webalizer-Dienstprogramm und das Google Analytics-Tool haben mir seit vielen Jahren geholfen, eine Vorstellung davon zu bekommen, was auf Websites...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Site-Statistiken und Ihr kleines Repository</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462337/"> Das Webalizer-Dienstprogramm und das Google Analytics-Tool haben mir seit vielen Jahren geholfen, eine Vorstellung davon zu bekommen, was auf Websites geschieht.  Jetzt verstehe ich, dass sie sehr wenig n√ºtzliche Informationen liefern.  Der Zugriff auf Ihre Datei access.log ist sehr einfach und f√ºr die Implementierung relativ einfacher Tools wie SQLite, HTML, SQL und einer beliebigen Skriptprogrammiersprache geeignet. <br><br>  Die Datenquelle f√ºr Webalizer ist die Datei server access.log.  So sehen die Spalten und Zahlen aus, von denen nur die Gesamtmenge des Datenverkehrs klar ist: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/n1/br/xb/n1brxbufrqnd4t0j6nzlbv1jkzq.png" alt="Bild"></div><a name="habracut"></a><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/u1/fe/mk/u1femkuxt4sompxtu4dhyr75ito.png" alt="Bild"></div><br>  Tools wie Google Analytics erfassen selbst Daten von der geladenen Seite.  Sie zeigen uns einige Diagramme und Linien, auf deren Grundlage es oft schwierig ist, die richtigen Schlussfolgerungen zu ziehen.  Vielleicht war mehr Aufwand n√∂tig?  Wei√ü nicht. <br><br>  Was wollte ich in der Statistik der Besuche vor Ort sehen? <br><br><h4>  Benutzer- und Bot-Verkehr </h4><br>  Oft hat der Site-Verkehr ein Limit und Sie m√ºssen sehen, wie viel n√ºtzlicher Verkehr verwendet wird.  Zum Beispiel so: <br><br><img src="https://habrastorage.org/webt/zx/ns/in/zxnsin0lv74jmiaupcbtmwbuaca.png" alt="Bild"><br><br><div class="spoiler">  <b class="spoiler_title">SQL-Berichtsanforderung</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">'StackedArea: Traffic generated by Users and Bots'</span></span>, strftime(<span class="hljs-string"><span class="hljs-string">'%d.%m'</span></span>, datetime(FCT.EVENT_DT, <span class="hljs-string"><span class="hljs-string">'unixepoch'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Day'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> USG.AGENT_BOT!=<span class="hljs-string"><span class="hljs-string">'na'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> FCT.BYTES <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>)/<span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Bots, KB'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> USG.AGENT_BOT=<span class="hljs-string"><span class="hljs-string">'na'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> FCT.BYTES <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>)/<span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Users, KB'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> FCT_ACCESS_USER_AGENT_DD FCT, DIM_USER_AGENT USG <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> FCT.DIM_USER_AGENT_ID=USG.DIM_USER_AGENT_ID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> datetime(FCT.EVENT_DT, <span class="hljs-string"><span class="hljs-string">'unixepoch'</span></span>) &gt;= <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>(<span class="hljs-string"><span class="hljs-string">'now'</span></span>, <span class="hljs-string"><span class="hljs-string">'-14 day'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> strftime(<span class="hljs-string"><span class="hljs-string">'%d.%m'</span></span>, datetime(FCT.EVENT_DT, <span class="hljs-string"><span class="hljs-string">'unixepoch'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> FCT.EVENT_DT</code> </pre> <br></div></div><br>  In der Grafik sehen Sie die konstante Aktivit√§t der Bots.  Es w√§re interessant, die aktivsten Vertreter im Detail zu untersuchen. <br><br><h4>  √Ñrgerliche Bots </h4><br>  Wir klassifizieren Bots basierend auf Benutzeragenteninformationen.  Zus√§tzliche Statistiken zum t√§glichen Datenverkehr, zur Anzahl der erfolgreichen und erfolglosen Anforderungen geben einen guten √úberblick √ºber die Aktivit√§t von Bots. <br><br><img src="https://habrastorage.org/webt/ly/ue/2g/lyue2grwohunkb13gxwqrrsmrz4.png" alt="Bild"><br><br><div class="spoiler">  <b class="spoiler_title">SQL-Berichtsanforderung</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Table: Annoying Bots'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(USG.AGENT_BOT) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Bot'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ROUND</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(FCT.BYTES)/<span class="hljs-number"><span class="hljs-number">1000</span></span> / <span class="hljs-number"><span class="hljs-number">14.0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'KB per Day'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ROUND</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(FCT.IP_CNT) / <span class="hljs-number"><span class="hljs-number">14.0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'IPs per Day'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ROUND</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> STS.STATUS_GROUP <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-string"><span class="hljs-string">'Client Error'</span></span>, <span class="hljs-string"><span class="hljs-string">'Server Error'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> FCT.REQUEST_CNT / <span class="hljs-number"><span class="hljs-number">14.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Error Requests per Day'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ROUND</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> STS.STATUS_GROUP <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-string"><span class="hljs-string">'Successful'</span></span>, <span class="hljs-string"><span class="hljs-string">'Redirection'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> FCT.REQUEST_CNT / <span class="hljs-number"><span class="hljs-number">14.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Success Requests per Day'</span></span>, USG.USER_AGENT_NK <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Agent'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> FCT_ACCESS_USER_AGENT_DD FCT, DIM_USER_AGENT USG, DIM_HTTP_STATUS STS <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> FCT.DIM_USER_AGENT_ID = USG.DIM_USER_AGENT_ID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> FCT.DIM_HTTP_STATUS_ID = STS.DIM_HTTP_STATUS_ID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> USG.AGENT_BOT != <span class="hljs-string"><span class="hljs-string">'na'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> datetime(FCT.EVENT_DT, <span class="hljs-string"><span class="hljs-string">'unixepoch'</span></span>) &gt;= <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>(<span class="hljs-string"><span class="hljs-string">'now'</span></span>, <span class="hljs-string"><span class="hljs-string">'-14 day'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> USG.USER_AGENT_NK <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre> <br></div></div><br>  In diesem Fall f√ºhrte die Analyse zu der Entscheidung, den Zugriff auf die Site durch Hinzuf√ºgen von robots.txt zur Datei einzuschr√§nken <br><br> <code>User-agent: AhrefsBot <br> Disallow: / <br> User-agent: dotbot <br> Disallow: / <br> User-agent: bingbot <br> Crawl-delay: 5</code> <br>  Die ersten beiden Bots verschwanden vom Tisch, und MS-Roboter bewegten sich von den ersten Zeilen nach unten. <br><br><h4>  Tag und Uhrzeit der meisten Aktivit√§t </h4><br>  Der Verkehr zeigt sich.  Um sie im Detail zu untersuchen, ist es notwendig, den Zeitpunkt ihres Auftretens zu identifizieren, w√§hrend nicht alle Stunden und Tage der Zeitmessung angezeigt werden m√ºssen.  So ist es einfacher, einzelne Abfragen in der Protokolldatei zu finden, wenn Sie eine detaillierte Analyse ben√∂tigen. <br><br><img src="https://habrastorage.org/webt/0d/az/jb/0dazjba9u6qctbppnqmvmlbfapo.png" alt="Bild"><br><br><div class="spoiler">  <b class="spoiler_title">SQL-Berichtsanforderung</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Line: Day and Hour of Hits from Users and Bots'</span></span>, strftime(<span class="hljs-string"><span class="hljs-string">'%d.%m-%H'</span></span>, datetime(EVENT_DT, <span class="hljs-string"><span class="hljs-string">'unixepoch'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Date Time'</span></span>, HIB <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Bots, Hits'</span></span>, HIU <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Users, Hits'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> EVENT_DT, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> AGENT_BOT!=<span class="hljs-string"><span class="hljs-string">'na'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> LINE_CNT <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> HIB, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> AGENT_BOT=<span class="hljs-string"><span class="hljs-string">'na'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> LINE_CNT <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> HIU <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> FCT_ACCESS_REQUEST_REF_HH <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> datetime(EVENT_DT, <span class="hljs-string"><span class="hljs-string">'unixepoch'</span></span>) &gt;= <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>(<span class="hljs-string"><span class="hljs-string">'now'</span></span>, <span class="hljs-string"><span class="hljs-string">'-14 day'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> EVENT_DT <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(LINE_CNT) <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> EVENT_DT</code> </pre> <br></div></div><br>  Wir beobachten die aktivsten Stunden 11, 14 und 20 des ersten Tages auf der Karte.  Aber am n√§chsten Tag um 13 Uhr waren die Bots aktiv. <br><br><h4>  W√∂chentliche durchschnittliche t√§gliche Benutzeraktivit√§t </h4><br>  Mit Aktivit√§t und Verkehr ein wenig herausgefunden.  Die n√§chste Frage war die Aktivit√§t der Benutzer selbst.  F√ºr solche Statistiken sind gro√üe Aggregationsperioden, beispielsweise eine Woche, w√ºnschenswert. <br><br><img src="https://habrastorage.org/webt/2j/cq/-a/2jcq-aaudo2zn21ewcr8ukr3mrq.png" alt="Bild"><br><br><div class="spoiler">  <b class="spoiler_title">SQL-Berichtsanforderung</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">'Line: Average Daily User Activity by Week'</span></span>, strftime(<span class="hljs-string"><span class="hljs-string">'%W week'</span></span>, datetime(FCT.EVENT_DT, <span class="hljs-string"><span class="hljs-string">'unixepoch'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Week'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ROUND</span></span>(<span class="hljs-number"><span class="hljs-number">1.0</span></span>*<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(FCT.PAGE_CNT)/<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(FCT.IP_CNT),<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Pages per IP per Day'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ROUND</span></span>(<span class="hljs-number"><span class="hljs-number">1.0</span></span>*<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(FCT.FILE_CNT)/<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(FCT.IP_CNT),<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Files per IP per Day'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> FCT_ACCESS_USER_AGENT_DD FCT, DIM_USER_AGENT USG, DIM_HTTP_STATUS HST <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> FCT.DIM_USER_AGENT_ID=USG.DIM_USER_AGENT_ID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> FCT.DIM_HTTP_STATUS_ID = HST.DIM_HTTP_STATUS_ID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> USG.AGENT_BOT=<span class="hljs-string"><span class="hljs-string">'na'</span></span> <span class="hljs-comment"><span class="hljs-comment">/* users only */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> HST.STATUS_GROUP <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-string"><span class="hljs-string">'Successful'</span></span>) <span class="hljs-comment"><span class="hljs-comment">/* good pages */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> datetime(FCT.EVENT_DT, <span class="hljs-string"><span class="hljs-string">'unixepoch'</span></span>) &gt; <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>(<span class="hljs-string"><span class="hljs-string">'now'</span></span>, <span class="hljs-string"><span class="hljs-string">'-3 month'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> strftime(<span class="hljs-string"><span class="hljs-string">'%W week'</span></span>, datetime(FCT.EVENT_DT, <span class="hljs-string"><span class="hljs-string">'unixepoch'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> FCT.EVENT_DT</code> </pre> <br></div></div><br>  Statistiken f√ºr die Woche zeigen, dass durchschnittlich ein Benutzer 1,6 Seiten pro Tag √∂ffnet.  Die Anzahl der angeforderten Dateien pro Benutzer h√§ngt in diesem Fall vom Hinzuf√ºgen neuer Dateien zur Site ab. <br><br><h4>  Alle Anfragen und deren Status </h4><br>  Webalizer zeigte immer bestimmte Seitencodes an und wollte immer nur die Anzahl der erfolgreichen Anfragen und Fehler sehen. <br><br><img src="https://habrastorage.org/webt/-0/tl/l_/-0tll_vfgjgf2yzzofonmztakke.png" alt="Bild"><br><br><div class="spoiler">  <b class="spoiler_title">SQL-Berichtsanforderung</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">'Line: All Requests by Status'</span></span>, strftime(<span class="hljs-string"><span class="hljs-string">'%d.%m'</span></span>, datetime(FCT.EVENT_DT, <span class="hljs-string"><span class="hljs-string">'unixepoch'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Day'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> STS.STATUS_GROUP=<span class="hljs-string"><span class="hljs-string">'Successful'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> FCT.REQUEST_CNT <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Success'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> STS.STATUS_GROUP=<span class="hljs-string"><span class="hljs-string">'Redirection'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> FCT.REQUEST_CNT <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Redirect'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> STS.STATUS_GROUP=<span class="hljs-string"><span class="hljs-string">'Client Error'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> FCT.REQUEST_CNT <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Customer Error'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> STS.STATUS_GROUP=<span class="hljs-string"><span class="hljs-string">'Server Error'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> FCT.REQUEST_CNT <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Server Error'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> FCT_ACCESS_USER_AGENT_DD FCT, DIM_HTTP_STATUS STS <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> FCT.DIM_HTTP_STATUS_ID=STS.DIM_HTTP_STATUS_ID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> datetime(FCT.EVENT_DT, <span class="hljs-string"><span class="hljs-string">'unixepoch'</span></span>) &gt;= <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>(<span class="hljs-string"><span class="hljs-string">'now'</span></span>, <span class="hljs-string"><span class="hljs-string">'-14 day'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> strftime(<span class="hljs-string"><span class="hljs-string">'%d.%m'</span></span>, datetime(FCT.EVENT_DT, <span class="hljs-string"><span class="hljs-string">'unixepoch'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> FCT.EVENT_DT</code> </pre> <br></div></div><br>  Der Bericht zeigt Anforderungen an, keine Klicks (Treffer). Im Gegensatz zu LINE_CNT wird die REQUEST_CNT-Metrik als COUNT (DISTINCT STG.REQUEST_NK) betrachtet.  Ziel ist es, effektive Ereignisse anzuzeigen, z. B. MS-Bots, die hunderte Male am Tag eine robots.txt-Datei abfragen. In diesem Fall werden solche Abfragen einmal gez√§hlt.  Auf diese Weise k√∂nnen Sie die Spr√ºnge auf dem Diagramm gl√§tten. <br><br>  In der Grafik sehen Sie viele Fehler - dies sind nicht vorhandene Seiten.  Das Ergebnis der Analyse war das Hinzuf√ºgen von Weiterleitungen von entfernten Seiten. <br><br><h4>  Fehlerhafte Anfragen </h4><br>  F√ºr eine detaillierte √úberpr√ºfung von Anforderungen k√∂nnen Sie detaillierte Statistiken anzeigen. <br><br><img src="https://habrastorage.org/webt/sv/67/o4/sv67o47nnbg41zchmmaioaguv1e.png" alt="Bild"><br><br><div class="spoiler">  <b class="spoiler_title">SQL-Berichtsanforderung</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Table: Top Error Requests'</span></span>, REQ.REQUEST_NK <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Request'</span></span>, <span class="hljs-string"><span class="hljs-string">'Error'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Request Status'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ROUND</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(FCT.LINE_CNT) / <span class="hljs-number"><span class="hljs-number">14.0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Hits per Day'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ROUND</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(FCT.IP_CNT) / <span class="hljs-number"><span class="hljs-number">14.0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'IPs per Day'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ROUND</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(FCT.BYTES)/<span class="hljs-number"><span class="hljs-number">1000</span></span> / <span class="hljs-number"><span class="hljs-number">14.0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'KB per Day'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> FCT_ACCESS_REQUEST_REF_HH FCT, DIM_REQUEST_V_ACT REQ <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> FCT.DIM_REQUEST_ID = REQ.DIM_REQUEST_ID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> FCT.STATUS_GROUP <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-string"><span class="hljs-string">'Client Error'</span></span>, <span class="hljs-string"><span class="hljs-string">'Server Error'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> datetime(FCT.EVENT_DT, <span class="hljs-string"><span class="hljs-string">'unixepoch'</span></span>) &gt;= <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>(<span class="hljs-string"><span class="hljs-string">'now'</span></span>, <span class="hljs-string"><span class="hljs-string">'-14 day'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> REQ.REQUEST_NK <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span></code> </pre> <br></div></div><br>  Diese Liste enth√§lt alle Dialer, z. B. eine Anforderung an /wp-login.php. Durch Anpassen der Regeln zum Umschreiben von Anforderungen durch den Server k√∂nnen Sie die Antwort des Servers auf solche Anforderungen anpassen und an die Startseite senden. <br><br>  Einige einfache Berichte, die auf der Server-Protokolldatei basieren, geben also ein ziemlich vollst√§ndiges Bild davon, was auf der Site passiert. <br><br><h4>  Wie bekomme ich Informationen? </h4><br>  Die SQLite-Datenbank ist v√∂llig ausreichend.  Erstellen wir Tabellen: Hilfsmittel f√ºr die Protokollierung von ETL-Prozessen. <br><br><img src="https://habrastorage.org/webt/zw/nr/4i/zwnr4iijmghgjtw9kytl2h5ohha.png" alt="Bild"><br><br>  Stufentabelle, in der wir Protokolldateien mit PHP schreiben.  Zwei aggregierte Tabellen.  Erstellen Sie eine t√§gliche Tabelle mit Statistiken zu Benutzeragenten und Anforderungsstatus.  St√ºndlich mit Statistiken zu Anfragen, Statusgruppen und Agenten.  Vier Tabellen mit relevanten Messungen. <br><br>  Das Ergebnis ist das folgende relationale Modell: <br><br><div class="spoiler">  <b class="spoiler_title">Datenmodell</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ge/no/8t/geno8thwxmohdagflkzzurien-u.png" alt="Bild"><br></div></div><br>  Skript zum Erstellen eines Objekts in einer SQLite-Datenbank: <br><br><div class="spoiler">  <b class="spoiler_title">DDL-Objekterstellung</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> DIM_USER_AGENT; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> DIM_USER_AGENT ( DIM_USER_AGENT_ID <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> AUTOINCREMENT, USER_AGENT_NK <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'na'</span></span>, AGENT_OS <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'na'</span></span>, AGENT_ENGINE <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'na'</span></span>, AGENT_DEVICE <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'na'</span></span>, AGENT_BOT <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'na'</span></span>, UPDATE_DT <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (USER_AGENT_NK) ); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> DIM_USER_AGENT (DIM_USER_AGENT_ID) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">-1</span></span>);</code> </pre> </div></div><br><h4>  B√ºhne </h4><br>  Im Fall der Datei access.log m√ºssen Sie alle Anforderungen lesen, analysieren und in die Datenbank schreiben.  Dies kann entweder direkt mit der Skriptsprache oder mit SQLite erfolgen. <br><br>  Protokolldateiformat: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//67.221.59.195 - - [28/Dec/2012:01:47:47 +0100] "GET /files/default.css HTTP/1.1" 200 1512 "https://project.edu/" "Mozilla/4.0" //host ident auth time method request_nk protocol status bytes ref browser $log_pattern = '/^([^ ]+) ([^ ]+) ([^ ]+) (\[[^\]]+\]) "(.*) (.*) (.*)" ([0-9\-]+) ([0-9\-]+) "(.*)" "(.*)"$/';</span></span></code> </pre><br><h4>  Schl√ºsselpropaganda </h4><br>  Wenn sich die Rohdaten in der Datenbank befinden, m√ºssen Sie Schl√ºssel aufzeichnen, die nicht in den Messtabellen enthalten sind.  Dann ist es m√∂glich, einen Verweis auf die Messungen zu erstellen.  In der Tabelle DIM_REFERRER ist der Schl√ºssel beispielsweise eine Kombination aus drei Feldern. <br><br><div class="spoiler">  <b class="spoiler_title">Abfrage zur Weitergabe von SQL-Schl√ºsseln</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">/* Propagate the referrer from access log */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> DIM_REFERRER (HOST_NK, PATH_NK, QUERY_NK, UPDATE_DT) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> CLS.HOST_NK, CLS.PATH_NK, CLS.QUERY_NK, STRFTIME(<span class="hljs-string"><span class="hljs-string">'%s'</span></span>,<span class="hljs-string"><span class="hljs-string">'now'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> UPDATE_DT <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> REFERRER_HOST <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> HOST_NK, REFERRER_PATH <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> PATH_NK, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSTR</span></span>(REFERRER_QUERY,<span class="hljs-string"><span class="hljs-string">'&amp;sid'</span></span>)&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SUBSTR</span></span>(REFERRER_QUERY, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">INSTR</span></span>(REFERRER_QUERY,<span class="hljs-string"><span class="hljs-string">'&amp;sid'</span></span>)<span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-comment"><span class="hljs-comment">/*  sid -   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> REFERRER_QUERY <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> QUERY_NK <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> STG_ACCESS_LOG ) CLS <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> DIM_REFERRER TRG <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (CLS.HOST_NK = TRG.HOST_NK <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> CLS.PATH_NK = TRG.PATH_NK <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> CLS.QUERY_NK = TRG.QUERY_NK) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> TRG.DIM_REFERRER_ID <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span></code> </pre> </div></div><br>  Die Weitergabe an die Benutzeragententabelle kann eine Bot-Logik enthalten, z. B. einen SQL-Auszug: <br><br><pre> <code class="sql hljs">CASE WHEN INSTR(LOWER(CLS.BROWSER),'yandex.com')&gt;0 THEN 'yandex' WHEN INSTR(LOWER(CLS.BROWSER),'googlebot')&gt;0 THEN 'google' WHEN INSTR(LOWER(CLS.BROWSER),'bingbot')&gt;0 THEN 'microsoft' WHEN INSTR(LOWER(CLS.BROWSER),'ahrefsbot')&gt;0 THEN 'ahrefs' WHEN INSTR(LOWER(CLS.BROWSER),'mj12bot')&gt;0 THEN 'majestic-12' WHEN INSTR(LOWER(CLS.BROWSER),'compatible')&gt;0 OR INSTR(LOWER(CLS.BROWSER),'http')&gt;0 OR INSTR(LOWER(CLS.BROWSER),'libwww')&gt;0 OR INSTR(LOWER(CLS.BROWSER),'spider')&gt;0 OR INSTR(LOWER(CLS.BROWSER),'java')&gt;0 OR INSTR(LOWER(CLS.BROWSER),'python')&gt;0 OR INSTR(LOWER(CLS.BROWSER),'robot')&gt;0 OR INSTR(LOWER(CLS.BROWSER),'curl')&gt;0 OR INSTR(LOWER(CLS.BROWSER),'wget')&gt;0 THEN 'other' ELSE 'na' <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> AGENT_BOT</code> </pre> <br><h4>  Einheitentabellen </h4><br>  Zuletzt werden wir aggregierte Tabellen laden, zum Beispiel kann eine t√§gliche Tabelle wie folgt geladen werden: <br><br><div class="spoiler">  <b class="spoiler_title">SQL-Aggregatladeanforderung</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">/* Load fact from access log */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> FCT_ACCESS_USER_AGENT_DD (EVENT_DT, DIM_USER_AGENT_ID, DIM_HTTP_STATUS_ID, PAGE_CNT, FILE_CNT, REQUEST_CNT, LINE_CNT, IP_CNT, <span class="hljs-keyword"><span class="hljs-keyword">BYTES</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> STG <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> STRFTIME( <span class="hljs-string"><span class="hljs-string">'%s'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SUBSTR</span></span>(TIME_NK,<span class="hljs-number"><span class="hljs-number">9</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>) || <span class="hljs-string"><span class="hljs-string">'-'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SUBSTR</span></span>(TIME_NK,<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'Jan'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'01'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'Feb'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'02'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'Mar'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'03'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'Apr'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'04'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'May'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'05'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'Jun'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'06'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'Jul'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'07'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'Aug'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'08'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'Sep'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'09'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'Oct'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'10'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'Nov'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'11'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'12'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> || <span class="hljs-string"><span class="hljs-string">'-'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">SUBSTR</span></span>(TIME_NK,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) || <span class="hljs-string"><span class="hljs-string">' 00:00:00'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> EVENT_DT, BROWSER <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> USER_AGENT_NK, REQUEST_NK, IP_NR, <span class="hljs-keyword"><span class="hljs-keyword">STATUS</span></span>, LINE_NK, <span class="hljs-keyword"><span class="hljs-keyword">BYTES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> STG_ACCESS_LOG ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(STG.EVENT_DT <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> EVENT_DT, USG.DIM_USER_AGENT_ID, HST.DIM_HTTP_STATUS_ID, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSTR</span></span>(STG.REQUEST_NK,<span class="hljs-string"><span class="hljs-string">'.'</span></span>)=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> STG.REQUEST_NK <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> PAGE_CNT, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSTR</span></span>(STG.REQUEST_NK,<span class="hljs-string"><span class="hljs-string">'.'</span></span>)&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> STG.REQUEST_NK <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> FILE_CNT, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> STG.REQUEST_NK) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> REQUEST_CNT, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> STG.LINE_NK) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> LINE_CNT, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> STG.IP_NR) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> IP_CNT, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">BYTES</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BYTES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> STG, DIM_HTTP_STATUS HST, DIM_USER_AGENT USG <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> STG.STATUS = HST.STATUS_NK <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> STG.USER_AGENT_NK = USG.USER_AGENT_NK <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(STG.EVENT_DT <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>) &gt; $param_epoch_from <span class="hljs-comment"><span class="hljs-comment">/* load epoch date */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(STG.EVENT_DT <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>) &lt; strftime(<span class="hljs-string"><span class="hljs-string">'%s'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>(<span class="hljs-string"><span class="hljs-string">'now'</span></span>, <span class="hljs-string"><span class="hljs-string">'start of day'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> STG.EVENT_DT, HST.DIM_HTTP_STATUS_ID, USG.DIM_USER_AGENT_ID</code> </pre> </div></div><br>  Mit der SQLite-Datenbank k√∂nnen Sie komplexe Abfragen schreiben.  WITH enth√§lt die Vorbereitung von Daten und Schl√ºsseln.  Die Hauptabfrage sammelt alle Verweise auf Dimensionen. <br><br>  Die Bedingung erlaubt nicht das erneute Laden der Story: CAST (STG.EVENT_DT AS INTEGER)&gt; $ param_epoch_from, wobei der Parameter das Ergebnis der Anforderung ist <br>  'COALESCE AUSW√ÑHLEN (MAX (EVENT_DT), \' 3600 \ ') AS LAST_EVENT_EPOCH FROM FCT_ACCESS_USER_AGENT_DD' <br><br>  Die Bedingung wird nur den ganzen Tag geladen: CAST (STG.EVENT_DT AS INTEGER) &lt;strftime ('% s', Datum ('jetzt', 'Tagesbeginn')) <br><br>  Das Z√§hlen von Seiten oder Dateien erfolgt primitiv, indem nach einem Punkt gesucht wird. <br><br><h4>  Berichte </h4><br>  In komplexen Visualisierungssystemen ist es m√∂glich, ein Metamodell basierend auf Datenbankobjekten zu erstellen, Filter und Aggregationsregeln dynamisch zu verwalten.  Letztendlich generieren alle anst√§ndigen Tools eine SQL-Abfrage. <br><br>  In diesem Beispiel erstellen wir vorgefertigte SQL-Abfragen und speichern sie als Ansicht in der Datenbank - dies sind die Berichte. <br><br><h4>  Visualisierung </h4><br>  Bluff: Sch√∂ne Grafiken in JavaScript wurden als Visualisierungswerkzeug verwendet. <br><br>  Dazu musste PHP verwendet werden, um alle Berichte zu durchsuchen und eine HTML-Datei mit Tabellen zu generieren. <br><br><pre> <code class="php hljs">$sqls = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'SELECT * FROM RPT_ACCESS_USER_VS_BOT'</span></span>, <span class="hljs-string"><span class="hljs-string">'SELECT * FROM RPT_ACCESS_ANNOYING_BOT'</span></span>, <span class="hljs-string"><span class="hljs-string">'SELECT * FROM RPT_ACCESS_TOP_HOUR_HIT'</span></span>, <span class="hljs-string"><span class="hljs-string">'SELECT * FROM RPT_ACCESS_USER_ACTIVE'</span></span>, <span class="hljs-string"><span class="hljs-string">'SELECT * FROM RPT_ACCESS_REQUEST_STATUS'</span></span>, <span class="hljs-string"><span class="hljs-string">'SELECT * FROM RPT_ACCESS_TOP_REQUEST_PAGE'</span></span>, <span class="hljs-string"><span class="hljs-string">'SELECT * FROM RPT_ACCESS_TOP_REQUEST_REFERRER'</span></span>, <span class="hljs-string"><span class="hljs-string">'SELECT * FROM RPT_ACCESS_NEW_REQUEST'</span></span>, <span class="hljs-string"><span class="hljs-string">'SELECT * FROM RPT_ACCESS_TOP_REQUEST_SUCCESS'</span></span>, <span class="hljs-string"><span class="hljs-string">'SELECT * FROM RPT_ACCESS_TOP_REQUEST_ERROR'</span></span> );</code> </pre> <br>  Das Tool visualisiert einfach die Ergebnistabellen. <br><br><h4>  Fazit </h4><br>  Am Beispiel der Webanalyse beschreibt der Artikel die Mechanismen, die zum Erstellen von Data Warehouses erforderlich sind.  Wie aus den Ergebnissen hervorgeht, reichen die einfachsten Werkzeuge f√ºr eine eingehende Analyse und Datenvisualisierung aus. <br><br>  In Zukunft werden wir am Beispiel dieses Speichers versuchen, Strukturen wie sich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">langsam √§ndernde Messungen</a> , Stammdaten, Aggregationsebenen und Datenintegration aus verschiedenen Quellen zu implementieren. <br><br>  Au√üerdem werden wir uns das einfachste <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ETL-Prozessmanagement-Tool</a> anhand einer einzelnen Tabelle genauer ansehen. <br><br>  Kehren wir zum Thema der Messung der Datenqualit√§t und der Automatisierung dieses Prozesses zur√ºck. <br><br>  Wir werden die Probleme der technischen Umgebung und der Wartung von Data Warehouses untersuchen, f√ºr die wir einen Speicherserver mit minimalen Ressourcen implementieren, beispielsweise basierend auf dem Raspberry Pi. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de462337/">https://habr.com/ru/post/de462337/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de462327/index.html">Quietschen eines Krebstumors: Wissenschaftler von NUST ‚ÄûMISiS‚Äú haben einen Laser-Ultraschall zur Diagnose von Krebs entwickelt</a></li>
<li><a href="../de462329/index.html">Bewegen Sie das Netzteil zur Vorderseite des Geh√§uses</a></li>
<li><a href="../de462331/index.html">GAZ-66 Spielzeug auf dem Bedienfeld. Teil 2</a></li>
<li><a href="../de462333/index.html">Erstellen eines einfachen Chatbots f√ºr Konversationen in Python</a></li>
<li><a href="../de462335/index.html">Nicht lesen, erneut lesen</a></li>
<li><a href="../de462339/index.html">Wie h√§ngen Handheld-Schulungen mit den internen Standards von Amazon zusammen und wie hat sich dies auf das Weltbild des Unternehmens ausgewirkt?</a></li>
<li><a href="../de462347/index.html">Die ersten zehn Tage auf dem Weg von einer Eule zu einem Fr√ºhaufsteher: Schlaf, Di√§t, Di√§t und Bewegung</a></li>
<li><a href="../de462349/index.html">RESTinio ist ein asynchroner HTTP-Server. Ein einfaches Beispiel aus der Praxis: Als Antwort eine gro√üe Datenmenge zur√ºckgeben</a></li>
<li><a href="../de462353/index.html">H√§ufig gestellte Fragen zur LoRaWAN-Protokollsicherheit</a></li>
<li><a href="../de462355/index.html">Asynchrone JavaScript-Programmierung (Callback, Promise, RxJs)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>