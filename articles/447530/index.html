<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§Ωüèª ü§ó üìé OceanLotus: actualizaci√≥n de Malvari para macOS üÜñ üéÆ üêæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En marzo de 2019, VirusTotal, un popular servicio de escaneo en l√≠nea, carg√≥ una nueva muestra de malware para macOS del cybergroup OceanLotus. El arc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>OceanLotus: actualizaci√≥n de Malvari para macOS</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/eset/blog/447530/"> En marzo de 2019, VirusTotal, un popular servicio de escaneo en l√≠nea, carg√≥ una nueva muestra de malware para macOS del cybergroup OceanLotus.  El archivo ejecutable de puerta trasera tiene las mismas capacidades que la versi√≥n anterior de malvari que estudiamos para macOS, pero su estructura ha cambiado y se ha vuelto m√°s dif√≠cil de detectar.  Desafortunadamente, no pudimos encontrar el gotero asociado con esta muestra, por lo que a√∫n no conocemos el vector de infecci√≥n. <br><br>  Recientemente, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">publicamos</a> una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">publicaci√≥n sobre OceanLotus</a> y c√≥mo los operadores intentan mantener la persistencia, acelerar la ejecuci√≥n del c√≥digo y minimizar los rastros de presencia en los sistemas Windows.  Tambi√©n se sabe que este cybergroup tiene un componente para macOS.  Esta publicaci√≥n describe en detalle los cambios en la √∫ltima versi√≥n de Malware para macOS en comparaci√≥n con la versi√≥n anterior ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">descrita por Trend Micro</a> ), as√≠ como c√≥mo el an√°lisis puede automatizar el descifrado de cadenas utilizando la API IDA Hex-Rays. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/b9/2i/bc/b92ibc95cbufdprulqgxtcrrh2q.jpeg"></div><a name="habracut"></a><br><h2>  An√°lisis </h2><br>  Las siguientes tres partes describen el an√°lisis de muestra con el hash SHA-1 <code>E615632C9998E4D3E5ACD8851864ED09B02C77D2</code> .  El archivo se llama <b>flashlightd</b> , los productos antivirus ESET lo detectan como OSX / OceanLotus.D. <br><br><h4>  Anti-depuraci√≥n y protecci√≥n sandbox </h4><br>  Como todos los binarios de OceanLotus macOS, la muestra est√° empaquetada con UPX, pero la mayor√≠a de las herramientas de identificaci√≥n de empaquetadores no la reconocen como tal.  Probablemente porque contienen principalmente una firma, dependiendo de la presencia de la cadena "UPX", adem√°s, las firmas Mach-O son menos comunes y no se actualizan con tanta frecuencia.  Esta caracter√≠stica dificulta la detecci√≥n est√°tica.  Curiosamente, despu√©s de desempacar, el punto de entrada se encuentra al comienzo de la secci√≥n <code>__cfstring</code> en el segmento <code>.TEXT</code> .  Hay atributos de marca en esta secci√≥n, como se muestra en la imagen a continuaci√≥n. <br><br><img src="https://habrastorage.org/webt/9f/-e/nv/9f-envxqfnhv8qxtp-gjeitht1q.png"><br>  <i>Figura 1. Atributos de la secci√≥n MACH-O __cfstring</i> <br><br>  Como se muestra en la Figura 2, la ubicaci√≥n del c√≥digo en la secci√≥n <code>__cfstring</code> permite enga√±ar algunas herramientas de desensamblaje al mostrar el c√≥digo como cadenas. <br><br><img src="https://habrastorage.org/webt/qw/q0/s3/qwq0s3-lc2tj86cb3wtcx91y8d0.png"><br>  <i>Figura 2. El IDA define el c√≥digo de puerta trasera como datos</i> <br><br>  Despu√©s de iniciar el archivo binario, se crea una secuencia como medio de protecci√≥n contra la depuraci√≥n, cuyo √∫nico prop√≥sito es verificar constantemente el depurador.  Para este hilo: <br><br><ul><li>  Intenta desenganchar cualquier depurador llamando a <code>ptrace</code> con <code>PT_DENY_ATTACH</code> como par√°metro de solicitud </li><li>  Comprueba si algunos puertos de excepci√≥n est√°n abiertos llamando a <code>task_get_exception_ports</code> </li><li>  Verifica si el depurador est√° conectado, como se muestra en la figura a continuaci√≥n, verificando la presencia del indicador <code>P_TRACED</code> en el proceso actual </li></ul><br><img src="https://habrastorage.org/webt/hi/cz/hd/hiczhdrsr9kgk9kkhfr72fv_xsg.png"><br>  <i>Figura 3. Comprobaci√≥n de la conexi√≥n del depurador utilizando la funci√≥n sysctl</i> <br><br>  Si el perro guardi√°n detecta la presencia de un depurador, se llama a la funci√≥n de <code>exit</code> .  Adem√°s, la muestra comprueba el entorno ejecutando dos comandos: <br><br> <code>ioreg -l | grep -e "Manufacturer"  sysctl hw.model</code> <br> <br>  Despu√©s de eso, la muestra verifica el valor de retorno con una lista codificada de cadenas de sistemas de virtualizaci√≥n conocidos: <b>acle</b> , <b>vmware</b> , <b>virtualbox</b> o <b>paralelos</b> .  Finalmente, el siguiente comando verifica si la m√°quina es uno de los siguientes "MBP", "MBA", "MB", "MM", "IM", "MP" y "XS".  Estos son c√≥digos de modelo del sistema, por ejemplo, "MBP" significa MacBook Pro, "MBA" significa MacBook Air, etc. <br><br> <code>system_profiler SPHardwareDataType 2&gt;/dev/null | awk '/Boot ROM Version/ {split($0, line, ":");printf("%s", line[2]);}</code> <br> <br><h4>  Adiciones clave </h4><br>  A pesar de que los equipos de puerta trasera no han cambiado desde el estudio de Trend Micro, notamos varias otras modificaciones.  Los servidores C&amp;C utilizados en esta muestra son bastante nuevos, la fecha de su creaci√≥n es el 22/10/2018. <br><br><ul><li>  <b>daff.faybilodeau [.] com</b> </li><li>  <b>sarc.onteagleroad [.] com</b> </li><li>  <b>au.charlineopkesston [.] com</b> </li></ul><br>  La URL del recurso cambi√≥ a <code>/dp/B074WC4NHW/ref=gbps_img_m-9_62c3_750e6b35</code> . <br>  El primer paquete enviado al servidor C&amp;C contiene m√°s informaci√≥n sobre la m√°quina host, incluidos todos los datos recopilados por los comandos de la tabla a continuaci√≥n. <br><br><img src="https://habrastorage.org/webt/xb/9k/xo/xb9kxohiu-1pdfbxnxbcrmnewqq.png"><br><br>  Adem√°s de este cambio de configuraci√≥n, la muestra no usa la biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">libcurl</a> para el filtrado de la red, sino una biblioteca externa.  Para encontrarlo, la puerta trasera intenta descifrar cada archivo en el directorio actual usando AES-256-CBC con la clave <code>gFjMXBgyXWULmVVVzyxy</code> con ceros.  Cada archivo se descifra y se guarda como <code>/tmp/store</code> , y se intent√≥ cargarlo como una biblioteca utilizando la funci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">dlopen</a> .  Cuando un intento de descifrado conduce a una llamada <code>dlopen</code> exitosa, la puerta trasera recupera las <code>Boriry</code> exportadas de <code>Boriry</code> y <code>ChadylonV</code> , que parecen ser responsables de la comunicaci√≥n de red con el servidor.  No tenemos un cuentagotas u otros archivos de la ubicaci√≥n de origen de la muestra, por lo que no podemos analizar esta biblioteca.  Adem√°s, dado que el componente est√° encriptado, la regla YARA basada en estas l√≠neas no coincidir√° con el archivo encontrado en el disco. <br><br>  Como se describe en el art√≠culo anterior, se crea <i>cliendID</i> .  Este identificador es un hash MD5 del valor de retorno de uno de los siguientes comandos: <br><br>  - <code>ioreg -rd1 -c IOPlatformExpertDevice | awk '/IOPlatformSerialNumber/ { split($0, line, "\""); printf("%s", line[4]); }'</code> <code>ioreg -rd1 -c IOPlatformExpertDevice | awk '/IOPlatformSerialNumber/ { split($0, line, "\""); printf("%s", line[4]); }'</code> <br>  - <code>ioreg -rd1 -c IOPlatformExpertDevice | awk '/IOPlatformUUID/ { split($0, line, "\""); printf("%s", line[4]); }'</code> <code>ioreg -rd1 -c IOPlatformExpertDevice | awk '/IOPlatformUUID/ { split($0, line, "\""); printf("%s", line[4]); }'</code> <br>  - <code>ifconfig en0 | awk \'/ether /{print $2}\'</code>  <code>ifconfig en0 | awk \'/ether /{print $2}\'</code> (obtener la direcci√≥n MAC) <br>  - comando desconocido (" <code>\x1e\x72\x0a</code> "), que se utiliza en muestras anteriores <br><br>  Antes del hash, el car√°cter "0" o "1" se agrega al valor devuelto, lo que indica la presencia de privilegios de root.  Este <i>ID de cliente</i> se almacena en <code>/Library/Storage/File System/HFS/25cf5d02-e50b-4288-870a-528d56c3cf6e/pivtoken.appex</code> si el c√≥digo se ejecuta como root o en ~ / Library / SmartCardsServices / Technology / PlugIns / drivers / snippets.ecgML en todos los dem√°s casos.  Un archivo generalmente se oculta usando la funci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">_chflags</a> ; su marca de tiempo se cambia usando el comando <code>touch ‚Äìt</code> con un valor aleatorio. <br><br><h4>  Decodificar cuerdas </h4><br>  Como en versiones anteriores, las cadenas se encriptan usando AES-256-CBC (clave hexadecimal: <code>9D7274AD7BCEF0DED29BDBB428C251DF8B350B92</code> con ceros, y IV se rellena con ceros) usando la funci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">CCCrypt</a> .  La clave se ha cambiado de versiones anteriores, pero dado que el grupo todav√≠a usa el mismo algoritmo de cifrado de cadenas, el descifrado se puede automatizar.  Adem√°s de esta publicaci√≥n, estamos lanzando un script IDA que usa la API Hex-Rays para descifrar las cadenas presentes en un archivo binario.  Este script puede ayudar en el an√°lisis futuro de OceanLotus y el an√°lisis de muestras existentes que a√∫n no hemos podido obtener.  El script se basa en un m√©todo universal para recibir argumentos pasados ‚Äã‚Äãa una funci√≥n.  Tambi√©n est√° buscando la configuraci√≥n de destino.  El m√©todo se puede reutilizar para obtener una lista de argumentos de funci√≥n y luego pasarlo a una devoluci√≥n de llamada. <br><br>  Conociendo el prototipo de la funci√≥n de <i>descifrado</i> , el script encuentra todas las referencias cruzadas a esta funci√≥n, todos los argumentos, luego descifra los datos y coloca texto plano dentro del comentario en la direcci√≥n de la referencia cruzada.  Para que el script funcione correctamente, debe tener el alfabeto definido por el usuario utilizado por la funci√≥n de decodificaci√≥n base64 y debe definirse una variable global que contenga la longitud de la clave (en este caso, DWORD, consulte la Figura 4). <br><br><img src="https://habrastorage.org/webt/eh/24/ci/eh24cifpohyeyx3jvtsyodn6v8s.png"><br>  <i>Figura 4. Definici√≥n de la variable global key_len</i> <br><br>  En la ventana Funci√≥n, puede hacer clic con el bot√≥n derecho en la funci√≥n de descifrado y hacer clic en "Extraer y descifrar argumentos".  El script debe poner las l√≠neas descifradas en los comentarios, como se muestra en la Figura 5. <br><br><img src="https://habrastorage.org/webt/sy/or/e5/syore5rq9pnlbtdp_f4l4bq0aoe.png"><br>  <i>Figura 5. El texto descifrado se coloca en el comentario</i> <br><br>  Por lo tanto, las l√≠neas descifradas se colocan convenientemente juntas en la ventana IDA <i>xrefs</i> para esta funci√≥n, como se muestra en la Figura 6. <br><br><img src="https://habrastorage.org/webt/sl/v8/ok/slv8okoh1m44vxl1wpcv8hxqleo.png"><br>  <i>Figura 6. Xrefs a la funci√≥n f_decrypt</i> <br><br>  El gui√≥n final se puede encontrar en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">repositorio de Github</a> . <br><br><h2>  Conclusi√≥n </h2><br>  Como ya se mencion√≥, OceanLotus est√° constantemente mejorando y actualizando su conjunto de herramientas.  Esta vez, el cybergroup mejor√≥ el malware para trabajar con usuarios de Mac.  El c√≥digo no ha cambiado mucho, pero dado que muchos usuarios de Mac ignoran los productos de seguridad, proteger Malware de la detecci√≥n es de importancia secundaria. <br><br>  Los productos de ESET ya han detectado este archivo en el momento del estudio.  Dado que la biblioteca de red utilizada para la comunicaci√≥n C&amp;C ahora est√° encriptada en el disco, a√∫n no se conoce el protocolo de red exacto utilizado por los atacantes. <br><br><h2>  Indicadores de compromiso </h2><br>  Los indicadores de compromiso, as√≠ como los atributos MITER ATT y CK tambi√©n est√°n disponibles en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GitHub</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/447530/">https://habr.com/ru/post/447530/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../447516/index.html">C√≥mo overclockeamos CAD COMPASS-3D ‚Üí Parte 2</a></li>
<li><a href="../447520/index.html">Funciones de nivelaci√≥n autom√°tica en el almacenamiento Qsan XCubeSAN</a></li>
<li><a href="../447522/index.html">Qu√© cosas √∫tiles se pueden extraer de los registros de una estaci√≥n de trabajo basada en Windows</a></li>
<li><a href="../447526/index.html">Bicicleta propia para sincronizar MariaDB y Sphinx</a></li>
<li><a href="../447528/index.html">¬øQui√©n es responsable de la calidad?</a></li>
<li><a href="../447532/index.html">Splunk Universal Forwarder en el Docker como recopilador de registros del sistema</a></li>
<li><a href="../447534/index.html">El cosmonauta Aleksandr Laveykin sobre la mejor pel√≠cula espacial, fuerza G de 20 g y aterrizaje suave</a></li>
<li><a href="../447536/index.html">Implementar IdM. Preparaci√≥n para la implementaci√≥n por parte del cliente.</a></li>
<li><a href="../447538/index.html">CUBA 7: ¬øqu√© hay de nuevo?</a></li>
<li><a href="../447540/index.html">Taller Beta de RHEL 8: Creaci√≥n de aplicaciones web en vivo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>