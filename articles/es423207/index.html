<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>游뚧 鮫勇 游뱆游낕 C칩mo hacer una actualizaci칩n autom치tica de un cliente de juego en l칤nea 游꾽 游본 游뛎</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En este art칤culo, hablar칠 sobre c칩mo hice un sistema de actualizaci칩n autom치tica para un juego de cliente en l칤nea. Enlace a la fuente (Delphi) al fin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C칩mo hacer una actualizaci칩n autom치tica de un cliente de juego en l칤nea</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/423207/">  En este art칤culo, hablar칠 sobre c칩mo hice un sistema de actualizaci칩n autom치tica para un juego de cliente en l칤nea.  Enlace a la fuente (Delphi) al final del art칤culo.  De hecho, implement칠 tal caracter칤stica en mis dos juegos, y si el primer panqueque sali칩 un poco irregular (en el juego Spectromancer), entonces la segunda implementaci칩n result칩 ser muy conveniente y efectiva.  Este es mi primer art칤culo sobre Habr칠, as칤 que no golpees con fuerza, sino que se침ala los defectos en los comentarios :) <br><br><h2>  Algoritmo de actualizaci칩n del juego </h2><br><ul><li>  Comprobando la versi칩n para actualizar. </li><li>  Descargue la lista de archivos de la versi칩n actual. </li><li>  Descargar archivos nuevos o modificados a una carpeta temporal. </li><li>  Instalaci칩n de la actualizaci칩n: trae los archivos del cliente instalado de acuerdo con la lista. </li><li>  Iniciando un cliente actualizado. </li></ul><a name="habracut"></a><br><h3>  Verificaci칩n de versi칩n </h3><br>  En primer lugar, al iniciar, el cliente solicita al servidor el n칰mero de la versi칩n actual (X) y el n칰mero m칤nimo permitido sin actualizar (Y).  Si la versi칩n del cliente no es inferior a Y, no se requiere una actualizaci칩n; de lo contrario, el cliente inicia la utilidad de actualizaci칩n " <b>GetNewVersion.exe X</b> " y se apaga. <br><br>  Como puede ver, el par치metro pasa el n칰mero de versi칩n; esto le permite actualizar el juego a cualquier versi칩n disponible en el servidor e incluso reducirlo.  Si no se pasa el par치metro, la utilidad solicitar치 el n칰mero de versi칩n actual del servidor.  El n칰mero de versi칩n es solo un n칰mero entero, el esquema de numeraci칩n puede ser cualquiera, por ejemplo, mi versi칩n 1.12 corresponde al n칰mero 1120. <br><br>  La respuesta del servidor no llega instant치neamente, y antes de que la recibamos, no podemos crear la ventana del juego, ya que es posible que deba cerrarla de inmediato, y el parpadeo incomprensible en la pantalla no es lo que necesitamos.  El tiempo de espera de respuesta deber칤a tomar algo, y el cliente est치 ocupado cargando / desempacando los archivos JPEG m치s pesados.  Tampoco puedes esperar demasiado: el jugador lanz칩 el juego, pero no sucede nada en la pantalla, es un desastre.  Por lo tanto, si dentro de 1.0 seg.  la respuesta del servidor no lleg칩: la carga del juego contin칰a de la manera habitual.  Esto no es gran cosa: tan pronto como el jugador intente iniciar sesi칩n en el servidor, recibir치 un mensaje sobre la necesidad de actualizar el cliente o que el servidor no est치 disponible. <br><br><h3>  Descargar lista de archivos </h3><br>  Conociendo el n칰mero de versi칩n, la utilidad de actualizaci칩n descarga la lista de archivos en: <code>[base_ur]&gt;/[]/filelist</code> <br>  Esta es solo una lista de archivos CSV con sumas de verificaci칩n, as칤 como tama침os comprimidos y sin comprimir, cada l칤nea se ve as칤: <br> <code>18*Priest.tga;1053151921D9;91719;107372</code> <br>  Aqu칤 "18 *" significa que 18 caracteres en el nombre del archivo son los mismos que el archivo anterior.  Dado que los archivos generalmente van en orden alfab칠tico, y las rutas pueden ser largas, esto ahorra significativamente el tama침o del archivo de lista.  Para un servidor web en el que la compresi칩n no est치 habilitada, esto significa que el archivo se descargar치 m치s r치pido y la actualizaci칩n comenzar치 antes. <br><br><h3>  Descargar archivos nuevos o modificados </h3><br>  No sabemos cu치ntos a침os tiene el cliente del juego, tal vez algunos archivos se hayan cambiado o eliminado manualmente.  No queremos descargar demasiado, por lo tanto, despu칠s de recibir la lista de archivos, la utilidad comienza a verificarlos para obtener actualizaciones: si el archivo falta en la carpeta del juego o su suma de comprobaci칩n es diferente, el archivo se agrega a la cola de descarga.  Al mismo tiempo, no se pueden cargar m치s de 2 archivos; esto es suficiente para que, por un lado, la descarga no se ralentice, pero por otro lado, se produce de forma secuencial. <br><br><img src="https://habrastorage.org/webt/a1/ka/fw/a1kafw5r2dgdbsow7gd0pou5a5o.png"><br><br>  Un tema especial es la visualizaci칩n del progreso.  Hasta que se haya procesado toda la lista, no sabemos exactamente cu치ntos archivos descargar y de qu칠 tama침o son.  Sin embargo, tan pronto como se carga el primer archivo, ya podemos mostrar cierta informaci칩n.  De hecho, el progreso muestra la cola de descarga: cu치nto descargar y cu치nto ya se ha descargado. <br><br>  Los archivos descargados se descomprimen inmediatamente y se guardan en una carpeta temporal. Utilizo la biblioteca <code>zlib</code> para la compresi칩n. <br><br>  Cuando se ha procesado la lista completa de archivos y se han completado todas las descargas, la utilidad verifica la presencia del archivo <code>changes.txt</code> y, si existe, lo muestra.  Se le solicita al usuario que inicie el procedimiento de actualizaci칩n.  Antes de hacer clic en el bot칩n "Actualizar", todav칤a no se han realizado cambios en la carpeta del juego, por lo que puede optar por no participar sin ning칰n problema. <br><br>  Por cierto, si el usuario interrumpe la descarga o se niega a instalar, la pr칩xima vez no tendr치 que descargar todos los archivos nuevamente: antes de descargar el siguiente archivo, la utilidad verifica su presencia en la carpeta temporal y si la suma de verificaci칩n coincide, la descarga se considera exitosa. <br><br><img src="https://habrastorage.org/webt/kj/e_/rf/kje_rfnc4gaxycjafbze_3zurli.png"><br><br>  Pero cuando hace clic en "Actualizar", la utilidad inicia otra utilidad: " <b>InstallUpdate.exe</b> ", y se apaga. <br><br><h3>  Instalar actualizaci칩n </h3><br>  쯇or qu칠 necesito otra utilidad?  Es simple: para actualizar los archivos del juego, debe ejecutar con derechos de administrador.  Pero para descargar la actualizaci칩n, por el contrario, est치 contraindicada.  Porque, a menos que sea un feliz propietario de un certificado de firma de c칩digo EV, comenzar el proceso con derechos de administrador mostrar치 la ventana UAC.  Y si, al comenzar el juego, en lugar de la interfaz habitual, el jugador ve esto: <br><br><img src="https://habrastorage.org/webt/mo/gl/6p/mogl6p0zghhphcq9rlpivwskle0.png"><br><br>  ... entonces esta es, al menos, una raz칩n para tener cuidado, o incluso abandonar por completo el lanzamiento.  Otra cosa, con el consentimiento manual para instalar la actualizaci칩n, en este contexto, la ventana de UAC se percibe normalmente.  Desafortunadamente, un proceso en Windows no puede elevar sus derechos en tiempo de ejecuci칩n; esta propiedad no ha cambiado desde su lanzamiento.  Por lo tanto, uso dos archivos separados.  De hecho, <code>GetNewVersion.exe</code> e <code>InstallUpdate.exe</code> son la misma utilidad, los archivos son id칠nticos.  Y la acci칩n est치 determinada por los par치metros transmitidos y el nombre del archivo ejecutable. <br><br>  Entonces, al iniciarse, InstallUpdate copia los archivos del cliente del juego desde la carpeta temporal a la carpeta del juego, y luego inicia el cliente actualizado y finaliza.  En este caso, el archivo <code>GetNewVersion.exe</code> tambi칠n se puede actualizar. <br><br>  Todas las acciones, as칤 como los errores que ocurren, se registran en detalle en el registro; esto es muy 칰til para la depuraci칩n. <br><br><h2>  El proceso de preparaci칩n de una nueva versi칩n. </h2><br>  Examinamos el esquema de operaci칩n de actualizaci칩n desde el punto de vista del cliente del juego, pero 쯖칩mo hacer que todo funcione?  Para preparar nuevas compilaciones, escrib칤 otra utilidad: <b>CompressBuild</b> .  Escanea recursivamente una carpeta, comprime archivos usando el m칠todo Deflate y escribe informaci칩n sobre ellos en la lista de archivos: lista de <code>filelist</code> .  Despu칠s de la compresi칩n, el s칤mbolo "_" se agrega al nombre del archivo.  Los archivos comprimidos no se comprimen nuevamente, por lo tanto, si es necesario, solo los archivos individuales se pueden actualizar en la carpeta de compilaci칩n, CompressBuild solo los actualizar치. <br><br>  Algunos archivos en el cliente del juego cambian durante la operaci칩n, por ejemplo, contienen configuraciones.  Dichos archivos deben ignorarse, la utilidad toma las plantillas apropiadas del archivo de exclusi칩n.  Es decir, estos archivos simplemente no entran en la lista de <code>filelist</code> y no se estropean en el cliente cuando se actualizan. <br><br>  Por lo tanto, para preparar una nueva compilaci칩n, necesito: <br><br>  1. Copie la carpeta <code>\master</code> en <code>\[_]</code> <br>  2. Ejecute <b>CompressBuild</b> , que empacar치 los archivos y har치 una lista de ellos. <br>  3. Sube todo al sitio web del juego. <br>  4. Cambie en el servidor del juego el n칰mero de la versi칩n actual al n칰mero que acaba de descargar.  Voila! <br><br>  A partir de ahora, al actualizar, las personas recibir치n una nueva versi칩n. <br><br>  Bueno, las carpetas con compilaciones antiguas en el servidor se pueden eliminar para no ocupar espacio. <br><br><h2>  Conclusi칩n </h2><br>  Por supuesto, mi sistema de actualizaci칩n no es perfecto y no tiene fallas.  Por ejemplo, si se elimin칩 un archivo en el cliente, permanecer치 con los reproductores.  Si el archivo ha cambiado de nombre, se descargar치 como nuevo y la instancia anterior no se eliminar치.  Por supuesto, puede refinar la utilidad de actualizaci칩n agregando comandos para eliminar / cambiar el nombre de los archivos a la lista de archivos, pero en general estos problemas no son relevantes para mi juego, por lo que no me molest칠. <br><br>  Bueno, puedes obtener la fuente aqu칤: <a href="">astralheroes.com/files/UpdaterSrc.zip</a> <br>  (compilado en Delphi-2006 / Turbo Delphi, no puedo responder por otros compiladores). </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es423207/">https://habr.com/ru/post/es423207/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es423193/index.html">Configure las Notificaciones Web Push usando pywebpush paso a paso</a></li>
<li><a href="../es423195/index.html">Qu칠 hay de nuevo en JPA 2.2</a></li>
<li><a href="../es423197/index.html">LOLWUT: una obra de arte en un equipo de db</a></li>
<li><a href="../es423203/index.html">El l칤der del equipo ser치 responsable del servicio.</a></li>
<li><a href="../es423205/index.html">Proyecto de almacenamiento en MS SQL Server, integraci칩n con 1C 7.7 y automatizaci칩n del desarrollo en SSDT</a></li>
<li><a href="../es423209/index.html">Killer Form 2? Descripci칩n general de la impresora 3D Dental MoonRay S100</a></li>
<li><a href="../es423211/index.html">Comit칠 Estatal de la Duma: los Me gusta y los reenv칤os seguir치n siendo penalmente responsables</a></li>
<li><a href="../es423213/index.html">Como en ruso antiguo habr치 "esto es una prueba"</a></li>
<li><a href="../es423215/index.html">쮻칩nde est치 mi dinero, hombre?</a></li>
<li><a href="../es423217/index.html">Regreso al futuro: confirmaci칩n pr치ctica de la teor칤a de Tomonaga-Luttinger despu칠s de casi 56 a침os</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>