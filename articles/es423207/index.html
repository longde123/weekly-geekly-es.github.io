<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚌 ♿️ 🤘🏻 Cómo hacer una actualización automática de un cliente de juego en línea 🎆 🥥 🚸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En este artículo, hablaré sobre cómo hice un sistema de actualización automática para un juego de cliente en línea. Enlace a la fuente (Delphi) al fin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cómo hacer una actualización automática de un cliente de juego en línea</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/423207/">  En este artículo, hablaré sobre cómo hice un sistema de actualización automática para un juego de cliente en línea.  Enlace a la fuente (Delphi) al final del artículo.  De hecho, implementé tal característica en mis dos juegos, y si el primer panqueque salió un poco irregular (en el juego Spectromancer), entonces la segunda implementación resultó ser muy conveniente y efectiva.  Este es mi primer artículo sobre Habré, así que no golpees con fuerza, sino que señala los defectos en los comentarios :) <br><br><h2>  Algoritmo de actualización del juego </h2><br><ul><li>  Comprobando la versión para actualizar. </li><li>  Descargue la lista de archivos de la versión actual. </li><li>  Descargar archivos nuevos o modificados a una carpeta temporal. </li><li>  Instalación de la actualización: trae los archivos del cliente instalado de acuerdo con la lista. </li><li>  Iniciando un cliente actualizado. </li></ul><a name="habracut"></a><br><h3>  Verificación de versión </h3><br>  En primer lugar, al iniciar, el cliente solicita al servidor el número de la versión actual (X) y el número mínimo permitido sin actualizar (Y).  Si la versión del cliente no es inferior a Y, no se requiere una actualización; de lo contrario, el cliente inicia la utilidad de actualización " <b>GetNewVersion.exe X</b> " y se apaga. <br><br>  Como puede ver, el parámetro pasa el número de versión; esto le permite actualizar el juego a cualquier versión disponible en el servidor e incluso reducirlo.  Si no se pasa el parámetro, la utilidad solicitará el número de versión actual del servidor.  El número de versión es solo un número entero, el esquema de numeración puede ser cualquiera, por ejemplo, mi versión 1.12 corresponde al número 1120. <br><br>  La respuesta del servidor no llega instantáneamente, y antes de que la recibamos, no podemos crear la ventana del juego, ya que es posible que deba cerrarla de inmediato, y el parpadeo incomprensible en la pantalla no es lo que necesitamos.  El tiempo de espera de respuesta debería tomar algo, y el cliente está ocupado cargando / desempacando los archivos JPEG más pesados.  Tampoco puedes esperar demasiado: el jugador lanzó el juego, pero no sucede nada en la pantalla, es un desastre.  Por lo tanto, si dentro de 1.0 seg.  la respuesta del servidor no llegó: la carga del juego continúa de la manera habitual.  Esto no es gran cosa: tan pronto como el jugador intente iniciar sesión en el servidor, recibirá un mensaje sobre la necesidad de actualizar el cliente o que el servidor no está disponible. <br><br><h3>  Descargar lista de archivos </h3><br>  Conociendo el número de versión, la utilidad de actualización descarga la lista de archivos en: <code>[base_ur]&gt;/[]/filelist</code> <br>  Esta es solo una lista de archivos CSV con sumas de verificación, así como tamaños comprimidos y sin comprimir, cada línea se ve así: <br> <code>18*Priest.tga;1053151921D9;91719;107372</code> <br>  Aquí "18 *" significa que 18 caracteres en el nombre del archivo son los mismos que el archivo anterior.  Dado que los archivos generalmente van en orden alfabético, y las rutas pueden ser largas, esto ahorra significativamente el tamaño del archivo de lista.  Para un servidor web en el que la compresión no está habilitada, esto significa que el archivo se descargará más rápido y la actualización comenzará antes. <br><br><h3>  Descargar archivos nuevos o modificados </h3><br>  No sabemos cuántos años tiene el cliente del juego, tal vez algunos archivos se hayan cambiado o eliminado manualmente.  No queremos descargar demasiado, por lo tanto, después de recibir la lista de archivos, la utilidad comienza a verificarlos para obtener actualizaciones: si el archivo falta en la carpeta del juego o su suma de comprobación es diferente, el archivo se agrega a la cola de descarga.  Al mismo tiempo, no se pueden cargar más de 2 archivos; esto es suficiente para que, por un lado, la descarga no se ralentice, pero por otro lado, se produce de forma secuencial. <br><br><img src="https://habrastorage.org/webt/a1/ka/fw/a1kafw5r2dgdbsow7gd0pou5a5o.png"><br><br>  Un tema especial es la visualización del progreso.  Hasta que se haya procesado toda la lista, no sabemos exactamente cuántos archivos descargar y de qué tamaño son.  Sin embargo, tan pronto como se carga el primer archivo, ya podemos mostrar cierta información.  De hecho, el progreso muestra la cola de descarga: cuánto descargar y cuánto ya se ha descargado. <br><br>  Los archivos descargados se descomprimen inmediatamente y se guardan en una carpeta temporal. Utilizo la biblioteca <code>zlib</code> para la compresión. <br><br>  Cuando se ha procesado la lista completa de archivos y se han completado todas las descargas, la utilidad verifica la presencia del archivo <code>changes.txt</code> y, si existe, lo muestra.  Se le solicita al usuario que inicie el procedimiento de actualización.  Antes de hacer clic en el botón "Actualizar", todavía no se han realizado cambios en la carpeta del juego, por lo que puede optar por no participar sin ningún problema. <br><br>  Por cierto, si el usuario interrumpe la descarga o se niega a instalar, la próxima vez no tendrá que descargar todos los archivos nuevamente: antes de descargar el siguiente archivo, la utilidad verifica su presencia en la carpeta temporal y si la suma de verificación coincide, la descarga se considera exitosa. <br><br><img src="https://habrastorage.org/webt/kj/e_/rf/kje_rfnc4gaxycjafbze_3zurli.png"><br><br>  Pero cuando hace clic en "Actualizar", la utilidad inicia otra utilidad: " <b>InstallUpdate.exe</b> ", y se apaga. <br><br><h3>  Instalar actualización </h3><br>  ¿Por qué necesito otra utilidad?  Es simple: para actualizar los archivos del juego, debe ejecutar con derechos de administrador.  Pero para descargar la actualización, por el contrario, está contraindicada.  Porque, a menos que sea un feliz propietario de un certificado de firma de código EV, comenzar el proceso con derechos de administrador mostrará la ventana UAC.  Y si, al comenzar el juego, en lugar de la interfaz habitual, el jugador ve esto: <br><br><img src="https://habrastorage.org/webt/mo/gl/6p/mogl6p0zghhphcq9rlpivwskle0.png"><br><br>  ... entonces esta es, al menos, una razón para tener cuidado, o incluso abandonar por completo el lanzamiento.  Otra cosa, con el consentimiento manual para instalar la actualización, en este contexto, la ventana de UAC se percibe normalmente.  Desafortunadamente, un proceso en Windows no puede elevar sus derechos en tiempo de ejecución; esta propiedad no ha cambiado desde su lanzamiento.  Por lo tanto, uso dos archivos separados.  De hecho, <code>GetNewVersion.exe</code> e <code>InstallUpdate.exe</code> son la misma utilidad, los archivos son idénticos.  Y la acción está determinada por los parámetros transmitidos y el nombre del archivo ejecutable. <br><br>  Entonces, al iniciarse, InstallUpdate copia los archivos del cliente del juego desde la carpeta temporal a la carpeta del juego, y luego inicia el cliente actualizado y finaliza.  En este caso, el archivo <code>GetNewVersion.exe</code> también se puede actualizar. <br><br>  Todas las acciones, así como los errores que ocurren, se registran en detalle en el registro; esto es muy útil para la depuración. <br><br><h2>  El proceso de preparación de una nueva versión. </h2><br>  Examinamos el esquema de operación de actualización desde el punto de vista del cliente del juego, pero ¿cómo hacer que todo funcione?  Para preparar nuevas compilaciones, escribí otra utilidad: <b>CompressBuild</b> .  Escanea recursivamente una carpeta, comprime archivos usando el método Deflate y escribe información sobre ellos en la lista de archivos: lista de <code>filelist</code> .  Después de la compresión, el símbolo "_" se agrega al nombre del archivo.  Los archivos comprimidos no se comprimen nuevamente, por lo tanto, si es necesario, solo los archivos individuales se pueden actualizar en la carpeta de compilación, CompressBuild solo los actualizará. <br><br>  Algunos archivos en el cliente del juego cambian durante la operación, por ejemplo, contienen configuraciones.  Dichos archivos deben ignorarse, la utilidad toma las plantillas apropiadas del archivo de exclusión.  Es decir, estos archivos simplemente no entran en la lista de <code>filelist</code> y no se estropean en el cliente cuando se actualizan. <br><br>  Por lo tanto, para preparar una nueva compilación, necesito: <br><br>  1. Copie la carpeta <code>\master</code> en <code>\[_]</code> <br>  2. Ejecute <b>CompressBuild</b> , que empacará los archivos y hará una lista de ellos. <br>  3. Sube todo al sitio web del juego. <br>  4. Cambie en el servidor del juego el número de la versión actual al número que acaba de descargar.  Voila! <br><br>  A partir de ahora, al actualizar, las personas recibirán una nueva versión. <br><br>  Bueno, las carpetas con compilaciones antiguas en el servidor se pueden eliminar para no ocupar espacio. <br><br><h2>  Conclusión </h2><br>  Por supuesto, mi sistema de actualización no es perfecto y no tiene fallas.  Por ejemplo, si se eliminó un archivo en el cliente, permanecerá con los reproductores.  Si el archivo ha cambiado de nombre, se descargará como nuevo y la instancia anterior no se eliminará.  Por supuesto, puede refinar la utilidad de actualización agregando comandos para eliminar / cambiar el nombre de los archivos a la lista de archivos, pero en general estos problemas no son relevantes para mi juego, por lo que no me molesté. <br><br>  Bueno, puedes obtener la fuente aquí: <a href="">astralheroes.com/files/UpdaterSrc.zip</a> <br>  (compilado en Delphi-2006 / Turbo Delphi, no puedo responder por otros compiladores). </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es423207/">https://habr.com/ru/post/es423207/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es423193/index.html">Configure las Notificaciones Web Push usando pywebpush paso a paso</a></li>
<li><a href="../es423195/index.html">Qué hay de nuevo en JPA 2.2</a></li>
<li><a href="../es423197/index.html">LOLWUT: una obra de arte en un equipo de db</a></li>
<li><a href="../es423203/index.html">El líder del equipo será responsable del servicio.</a></li>
<li><a href="../es423205/index.html">Proyecto de almacenamiento en MS SQL Server, integración con 1C 7.7 y automatización del desarrollo en SSDT</a></li>
<li><a href="../es423209/index.html">Killer Form 2? Descripción general de la impresora 3D Dental MoonRay S100</a></li>
<li><a href="../es423211/index.html">Comité Estatal de la Duma: los Me gusta y los reenvíos seguirán siendo penalmente responsables</a></li>
<li><a href="../es423213/index.html">Como en ruso antiguo habrá "esto es una prueba"</a></li>
<li><a href="../es423215/index.html">¿Dónde está mi dinero, hombre?</a></li>
<li><a href="../es423217/index.html">Regreso al futuro: confirmación práctica de la teoría de Tomonaga-Luttinger después de casi 56 años</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>