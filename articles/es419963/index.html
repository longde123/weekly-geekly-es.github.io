<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèª‚Äçü§ù‚Äçüë®üèΩ ‚úåüèª ‚≠êÔ∏è Hacemos un controlador "inteligente" para el aire acondicionado en el ESP8266 üòº üóÇÔ∏è üïò</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ha llegado el verano, con el calor, y tambi√©n es hora de encender los aires acondicionados. Y si le gustan las tecnolog√≠as modernas y el hogar intelig...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Hacemos un controlador "inteligente" para el aire acondicionado en el ESP8266</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/419963/">  Ha llegado el verano, con el calor, y tambi√©n es hora de encender los aires acondicionados.  Y si le gustan las tecnolog√≠as modernas y el hogar inteligente, entonces desea controlar el aire acondicionado de manera inteligente (o al menos de una manera moderna).  A continuaci√≥n hay una serie de notas sobre mi intento de integrar el clima en una casa con control de voz y una interfaz multiplataforma. <br><br><h2>  Desaf√≠o </h2><br>  Hay cuatro aires acondicionados en el departamento, debe aprender a manejarlos: <br><br><ul><li>  Desde la interfaz web (lo tengo en Home Assistant, girando en una Raspberry Pi separada, pero idealmente quiero una conexi√≥n simple a cualquier sistema); </li><li>  Voz (Google Assistant lo har√°, luego piense en Alice); </li><li>  Guiones; </li><li>  Barato ... </li></ul><br><a name="habracut"></a><h2>  Estudio de mercado </h2><br><h3>  Soluci√≥n nativa </h3><br>  Quiz√°s ni siquiera lo cuente.  La decisi√≥n del fabricante de mis acondicionadores de aire implic√≥ un mont√≥n de cables, al menos dos m√≥dulos adicionales por cada unidad y un precio de aproximadamente $ 200 por habitaci√≥n.  Adem√°s de un protocolo propietario, una aplicaci√≥n antigua y todo eso.  Tachar <br><br><h3>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Cielo sensibo</a> </h3><br>  Aproximadamente $ 100 por habitaci√≥n, funciona de forma nativa con Google Assistant e IFTTT, se ve hermoso, pero sigue siendo un poco caro. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gw/yk/1c/gwyk1cvd9ukjhx9swiorxomydaw.jpeg"></div><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tado ¬∞</a> - de manera similar (e incluso m√°s caro). <br><br><h3>  Xiaomi Aqara / Mi Home, Broadlink RM Pro / Mini </h3><br>  Los transmisores IR universales, algunos te√≥ricamente admiten los aires acondicionados necesarios "listos para usar", se integran con Home Assistant por la mitad, pero en general, una soluci√≥n regular, aunque el precio ya est√° mucho m√°s cerca del asequible ($ 20-35 por habitaci√≥n, dependiendo de las capacidades )  S√≠, y las aplicaciones en chino (en algunos casos) no son a lo que aspiraba. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/5e/jy/ox/5ejyoxdz-way61igy_qqt1xk1n8.jpeg"></div><br><h3>  Bricolaje </h3><br>  La forma m√°s barata y flexible, de la que hablar√© m√°s. <br><br><h2>  Selecci√≥n de componentes </h2><br>  Hay algo en qu√© pensar, pero en general necesitaremos: <br><br><h3>  Hierro </h3><br><h4>  Controlador </h4><br>  Est√∫pidamente tomamos ESP8266, y por simplicidad de firmware y fuente de alimentaci√≥n, usaremos D1 mini.  Obviamente gestionaremos el sistema a trav√©s de WiFi. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/lj/ky/l1/ljkyl1s6uubm_thvjuhnj6zggoi.jpeg"></div><br><h4>  Transmisor IR </h4><br>  Para el prototipo, utilizaremos un LED IR simple, resistencia y un transistor, luego pensaremos en c√≥mo se puede mejorar. <br><br><h4>  Sensor de temperatura </h4><br>  Es m√°s divertido, puede establecer la temperatura objetivo y hacer el encendido / apagado autom√°tico.  Para comenzar, tome est√∫pidamente DHT22. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cc/qb/tm/ccqbtm6-pkoe1xnxzetkaj8by98.jpeg"></div><br><h4>  Pantalla </h4><br>  Mostraremos el estado actual del sistema (para la depuraci√≥n), y tal vez la direcci√≥n IP actual (¬øser√° √∫til?). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/br/ha/gd/brhagdvncv5xxv8dos3nk_c9saw.jpeg"></div><br><h3>  Software </h3><br><h4>  IDE </h4><br>  Implementaremos todo en Arduino IDE (con el que nunca he trabajado antes) usando bibliotecas abiertas. <br>  Mucho m√°s tarde, cuando el proyecto ya estaba funcionando, cambi√© a Visual Studio Code con el complemento <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PlatformIO</a> . <br><br><h4>  Protocolo </h4><br>  Nos comunicaremos con Home Assistant a trav√©s de MQTT (biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PubSubClient</a> ), porque  Es un protocolo abierto y tiene un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">componente</a> especial. <br><br>  La configuraci√≥n se ver√°, por ejemplo, algo as√≠: <br><br><pre><code class="hljs pgsql">climate: - platform: mqtt <span class="hljs-type"><span class="hljs-type">name</span></span>: Living Room HVAC modes: - "off" - "auto" - "heat" - "cool" - "dry" - "fan" swing_modes: - "auto" - "off" fan_modes: - "auto" - "low" - "medium" - "high" mode_command_topic: "livingroom/meteo/mode/set" mode_state_topic: "livingroom/meteo/mode" temperature_command_topic: "livingroom/meteo/target/set" temperature_state_topic: "livingroom/meteo/target" fan_mode_command_topic: "livingroom/meteo/fan/set" fan_mode_state_topic: "livingroom/meteo/fan" swing_mode_command_topic: "livingroom/meteo/swing/set" swing_mode_state_topic: "livingroom/meteo/swing" current_temperature_topic: "livingroom/meteo/temperature"</code> </pre> <br><h4>  Gesti√≥n </h4><br>  La biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">HeatpumpIR</a> nos ayudar√° a enviar se√±ales al aire acondicionado (el modelo del aire acondicionado todav√≠a est√° codificado). <br><br><h4>  Miscel√°neo </h4><br>  Necesitar√° m√°s bibliotecas para el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">temporizador</a> , para trabajar con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el sensor de temperatura</a> y con la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pantalla</a> , pero estos son peque√±os.  Agregaremos WiFiManager y ArduinoOTA con el gesto habitual para actualizar el firmware a trav√©s de la interfaz web, y no USB. <br><br><h2>  Prototipo (00) </h2><br>  Compramos componentes aleatorios en aliexpress, los juntamos en una placa de enga√±o y probamos la idea. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/n2/ve/_3/n2ve_3e4xbgeselooxb_z34j2zq.jpeg"></div><br>  Entendemos que: <br><br><ul><li>  La pantalla se orden√≥ demasiado grande y tiene demasiadas patas. </li><li>  Un LED no llega muy lejos y no es muy confiable. </li></ul><br>  ¬°Pero en general la idea funciona!  El componente HVAC "nativo" aparece en la interfaz de Home Assistant, lo que significa que el control desde cualquier parte del mundo ya est√° en nuestro bolsillo.  La integraci√≥n nativa de Home Assistant con Google Assistant agrega comandos de voz y comentarios: puede preguntarle al asistente sobre la temperatura en la habitaci√≥n y √©l responder√° tanto el objetivo como la temperatura actual. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sy/wv/zh/sywvzhrpxflr_8k7izcu-gkwfms.png"></div><br>  El cambio de la temperatura objetivo, la velocidad de soplado y el modo de aire acondicionado en la interfaz web tambi√©n est√°n en su lugar (y, lo m√°s importante, ¬°funciona!). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zv/ly/4k/zvly4k9nokvr_n_x0gc0knfurfk.png"></div><br><h2>  Muestra de prueba (01) </h2><br>  Cambiemos un par de componentes: solicite una pantalla m√°s peque√±a y trabaje a trav√©s de I2C (y usaremos una biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">diferente</a> ). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9c/ld/zp/9cldzpkypgzfejdxaqujwm17qkq.jpeg"></div><br>  Tambi√©n reemplazamos el LED IR con un m√≥dulo listo para usar. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pu/ob/ml/puobml0kneoraufy6fft9x9vt1g.jpeg"></div><br>  Result√≥ que no vale la pena pedir m√≥dulos con un LED (en la foto de la izquierda) en aliexpress: no contienen un transistor, y una de las patas (VCC) que tienen es esencialmente una farsa. <br><br>  Pero si solicita un m√≥dulo con dos LED (en la foto de la derecha), entonces todos los componentes necesarios ya est√°n en su lugar, y dicho m√≥dulo se conecta de forma f√°cil y natural, y termina un poco m√°s. <br><br>  Tambi√©n era hora de poner todo junto en mi placa de circuito impreso ... Fue uno de los momentos m√°s dif√≠ciles para una persona que nunca dise√±√≥ placas de circuito impreso, y seguro que hice todo mal. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/z3/ea/sc/z3eascuagsayu7zqhb7_shrp0ia.png"></div><br>  Para el dise√±o, utilic√© EasyEDA, ped√≠ productos terminados para OSHPark (de nuevo, seguro, podr√≠a encontrar una opci√≥n m√°s barata), y como resultado obtuve algo como esto: <br><table><tbody><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/webt/bs/cf/jr/bscfjrgse7belqqio_hc-3zmdwi.jpeg"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/webt/l8/-q/dd/l8-qddx1ifl49weei8ic6wbrntm.jpeg"></div></td></tr></tbody></table><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rb/3l/iv/rb3liv9-vm-pnsaueafbpendiui.jpeg"></div><br>  El bot√≥n fue agregado en el √∫ltimo momento, y un lugar para √©l fue encontrado completamente por accidente.  Result√≥ que con el bot√≥n todo es un poco m√°s divertido, no puede mantener la pantalla encendida todo el tiempo (lo cual es malo para OLED), pero muestra el estado presionando. <br><br>  Bueno, ya est√° bien, queda por agregar el caso.  Para hacer esto, ejecute Blender, haga un mont√≥n de paralelep√≠pedos, aplique varias operaciones booleanas ... <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/fl/ig/h_/fligh_cx6xgegg5lrsoydl2azji.png"></div><br>  Y enviar a la impresora 3D. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/au/b8/ck/aub8ck2fywfbds1ytgiwbc5ia6s.jpeg"></div><br>  En total, result√≥ econ√≥mico (menos de $ 10 por copia), de manera flexible (funcionar√° con casi cualquier aire acondicionado), se integra f√°cilmente, se controla por voz y, a trav√©s de la web, se termina constantemente desde cinco metros.  En general, sobre lo que quer√≠a. <br><br>  ¬øC√≥mo se har√≠a todo esto un poco mejor? <br><br><h2>  Modelo de serie (02) </h2><br>  Existen varias instrucciones para mejorar el producto resultante (m√°s precisamente, oportunidades de mejora que har√≠an posible convertir un experimento en un producto): <br><br><ol><li>  El sensor de temperatura se puede tomar m√°s peque√±o y m√°s preciso, por ejemplo, BME280, HTU21D o Si7021, lo que le permitir√° colgarlo en las mismas patas que la pantalla (I2C), reducir significativamente el tama√±o del dispositivo terminado y simplificar el dise√±o de la PCB.  En la pr√°ctica, result√≥ que el mismo BME280 comienza a verse fuertemente afectado por el calentamiento del ESP8266 en s√≠, y las lecturas emitidas deben ajustarse. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sr/ws/wo/srwswovbxfecsxk0nre5sjqjm3m.jpeg"></div></li><li>  (Se deduce del primer p√°rrafo) Mantener el ESP8266 funcionando constantemente no es algo com√∫n; debe ir peri√≥dicamente a Sue√±o profundo, solo ocasionalmente se despierta para enviar testimonios y recibir comandos; </li><li>  (se deduce del segundo punto) MQTT normal ya no es muy adecuado, debe usar MQTT-SN para que los comandos de control se recuerden y se entreguen al controlador en el momento del despertar; </li><li>  La implementaci√≥n de los elementos anteriores le permitir√° cambiar la energ√≠a "cableada" de la bater√≠a; </li><li>  El m√©todo actual de fijaci√≥n de componentes a una placa de circuito impreso (soldadura convencional) es dif√≠cil de implementar y no lo suficientemente flexible: tiene sentido soldar los cabezales para que los mismos sensores de temperatura puedan cambiarse como guantes; </li><li>  Finalmente (al contrario del p√°rrafo anterior), de todos modos, los m√≥dulos terminados son buenos y simples, pero un poco voluminosos, idealmente en lugar del D1 mini habr√≠a un ESP8266 desnudo, y el sensor de temperatura, el bot√≥n y los LED IR se soldar√≠an en una placa ( como lo hacen en productos en serie), lo que reducir√≠a el tama√±o del dispositivo y su precio de serie; </li><li>  De todos modos, ser√≠a bueno incluir en el firmware la capacidad de seleccionar f√°cilmente su modelo de aire acondicionado con un solo clic ... </li></ol><br><h2>  Conclusi√≥n </h2><br>  Fue una aventura gloriosa, y entend√≠ mucho.  Por ejemplo, entend√≠ por qu√© los dispositivos seriales son tan caros y cu√°nto esfuerzo tendr√≠a que aplicarse para llegar al mismo nivel que ellos.  Por otro lado, hice mucho por primera vez en este proyecto (trabajando en el IDE de Arduino, ordenando placas de circuito impreso, creando un modelo para una impresora 3D), y obtener esta experiencia fue invaluable.  Sin embargo, el c√≥digo fuente no se mostrar√°: estoy avergonzado de ellos :) <br><br>  Pero a√∫n as√≠ logr√© mi objetivo, y el control barato y flexible de los aires acondicionados result√≥ bastante factible. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es419963/">https://habr.com/ru/post/es419963/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es419949/index.html">¬øQu√© c√≥decs de video (no) usan los navegadores para las videollamadas?</a></li>
<li><a href="../es419951/index.html">Experiencia usando WebRTC. Conferencia de Yandex</a></li>
<li><a href="../es419953/index.html">Estoy escribiendo un libro sobre la primera "nuestra" startup que conquist√≥ el mundo: ayuda</a></li>
<li><a href="../es419955/index.html">Caracter√≠sticas del b√∫fer FIFO UART en ESP32</a></li>
<li><a href="../es419961/index.html">El resumen de materiales interesantes para el desarrollador m√≥vil # 265 (6 de agosto - 12 de agosto)</a></li>
<li><a href="../es419965/index.html">Caracter√≠sticas de configuraci√≥n del conmutador ExtremeXOS</a></li>
<li><a href="../es419969/index.html">Ocultamiento en Ruby. Ocultar tambi√©n clases de nivel superior</a></li>
<li><a href="../es419971/index.html">El laboratorio de cohetes repara, expande y acelera</a></li>
<li><a href="../es419973/index.html">Eventos digitales en Mosc√∫ del 13 al 19 de agosto.</a></li>
<li><a href="../es419975/index.html">C√≥mo nos escapamos de Windows corporativo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>