<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õÑÔ∏è üíÉüèº üë©üèΩ‚Äçü§ù‚Äçüë®üèª Conectamos um medidor de √°gua a uma casa inteligente üì∂ üë®üèø‚Äçüè≠ üöù</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Os sistemas de automa√ß√£o residencial, como costumam ser chamados de ‚Äúcasa inteligente‚Äù, eram terrivelmente caros e apenas pessoas ricas podiam pagar p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Conectamos um medidor de √°gua a uma casa inteligente</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/411259/">  Os sistemas de automa√ß√£o residencial, como costumam ser chamados de ‚Äúcasa inteligente‚Äù, eram terrivelmente caros e apenas pessoas ricas podiam pagar por eles.  Hoje, no mercado, voc√™ encontra kits bastante baratos com sensores, bot√µes / interruptores e atuadores para controlar a ilumina√ß√£o, tomadas, ventila√ß√£o, fornecimento de √°gua e outros consumidores.  E mesmo o DIY-shnik <s>mais krivoruky</s> pode se juntar aos belos e coletar dispositivos para uma casa inteligente e barata. <br><br><img src="https://habrastorage.org/webt/-a/k2/x6/-ak2x6li6an5gyqbrg2ett_-_au.jpeg"><br><br>  Como regra, os dispositivos propostos s√£o sensores ou atuadores.  Eles facilitam a implementa√ß√£o de cen√°rios como "acender a luz quando o sensor de movimento √© acionado" ou "o interruptor na sa√≠da apaga a luz em todo o apartamento".  Mas a telemetria de alguma forma n√£o deu certo.  Na melhor das hip√≥teses, este √© um gr√°fico de temperatura e umidade ou pot√™ncia instant√¢nea em uma tomada espec√≠fica. <br><br>  Recentemente, instalei um hidr√¥metro com uma sa√≠da de pulso.  Um interruptor de palheta √© acionado atrav√©s de cada litro atrav√©s do medidor e fecha o contato.  A √∫nica coisa que resta √© agarrar-se aos fios e tentar obter lucro com isso.  Por exemplo, analise o consumo de √°gua por hora e dia da semana.  Bem, se houver v√°rios risers de √°gua no apartamento, √© mais conveniente ver todos os indicadores atuais em uma tela do que escalar nichos de dif√≠cil acesso com uma lanterna. <br><br>  Sob o corte, minha vers√£o do dispositivo √© baseada no ESP8266, que conta pulsos de hidr√¥metros e envia leituras para o servidor dom√©stico inteligente via MQTT.  Vamos programar em micropython usando a biblioteca uasyncio.  Ao criar o firmware, me deparei com v√°rias dificuldades interessantes, que tamb√©m ser√£o discutidas neste artigo.  Vamos l√°! <br><a name="habracut"></a><br><h3>  Esquema </h3><br><img src="https://habrastorage.org/webt/i-/w2/o7/i-w2o7b8mfsommteri_mss88oa8.png"><br><br>  O cora√ß√£o de todo o circuito √© o m√≥dulo no microcontrolador ESP8266.  O ESP-12 foi originalmente planejado, mas o meu acabou com defeito.  Eu precisava me contentar com o m√≥dulo ESP-07, que estava dispon√≠vel.  Felizmente, eles s√£o os mesmos nas conclus√µes e na funcionalidade, a diferen√ßa est√° apenas na antena - o ESP-12 o possui e o ESP-07 possui um externo.  No entanto, mesmo sem uma antena WiFi, o sinal no meu banheiro √© capturado normalmente. <br><br>  A liga√ß√£o do m√≥dulo √© padr√£o: <br><br><ul><li>  bot√£o de reset com um suspensor e um capacitor (embora ambos j√° estejam dentro do m√≥dulo) </li><li>  Ativar sinal (CH_PD) puxado para energia </li><li>  GPIO15 puxado para o ch√£o.  Isso √© necess√°rio apenas no in√≠cio, mas ainda n√£o tenho mais nada a que me agarrar a essa perna </li></ul><br>  Para colocar o m√≥dulo no modo de firmware, voc√™ precisa fechar o GPIO2 e aterr√°-lo e, para torn√°-lo mais conveniente, forneci o bot√£o Boot.  Em condi√ß√µes normais, este pino √© puxado para a energia. <br><br>  O status da linha GPIO2 √© verificado apenas no in√≠cio do trabalho - quando a energia √© aplicada ou imediatamente ap√≥s uma redefini√ß√£o.  Portanto, o m√≥dulo carrega como de costume ou entra no modo de firmware.  Ap√≥s o carregamento, essa sa√≠da pode ser usada como um GPIO comum.  Bem, como j√° existe um bot√£o l√°, voc√™ pode colocar alguma fun√ß√£o √∫til nele. <br><br>  Para programa√ß√£o e depura√ß√£o, usarei o UART, que trouxe para o pente.  Quando necess√°rio - basta conectar um adaptador USB-UART.  Voc√™ s√≥ precisa se lembrar que o m√≥dulo √© alimentado por 3.3V.  Se voc√™ esquecer de mudar o adaptador para essa tens√£o e aplicar 5V, o m√≥dulo provavelmente queimar√°. <br><br>  N√£o tenho problemas com eletricidade no banheiro - a tomada est√° localizada a cerca de um metro dos medidores, por isso vou aliment√°-lo a partir de 220V.  Como fonte de energia, vou trabalhar com um pequeno <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">bloco de HLK-PM03</a> da Tenstar Robot.  Pessoalmente, sou forte com eletr√¥nicos anal√≥gicos e de energia, mas aqui est√° uma fonte de alimenta√ß√£o pronta em um estojo pequeno. <br><br>  Para sinalizar os modos de opera√ß√£o, forneci um LED conectado ao GPIO2.  No entanto, n√£o comecei a sold√°-lo, porque  al√©m disso, o m√≥dulo ESP-07 possui um LED conectado ao mesmo GPIO2.  Mas deixe isso acontecer - de repente, quero trazer esse LED para o gabinete. <br><br>  Passamos para o mais interessante.  Os contadores de √°gua n√£o t√™m l√≥gica, n√£o podem ser solicitadas as leituras atuais.  A √∫nica coisa que est√° dispon√≠vel para n√≥s s√£o pulsos - fechando os contatos da palheta a cada litro.  As conclus√µes dos comutadores reed est√£o definidas no GPIO12 / GPIO13.  Vou ligar o resistor pull-up programaticamente dentro do m√≥dulo. <br><br>  Inicialmente, esqueci de fornecer os resistores R8 e R9 e, na minha vers√£o do quadro, eles n√£o s√£o.  Mas como eu j√° estou colocando o esquema em exibi√ß√£o p√∫blica, vale a pena corrigir essa supervis√£o.  Os resistores s√£o necess√°rios para n√£o queimar a porta se o firmware estiver com defeito e colocar a unidade no pino, e o interruptor reed colocar esta linha no ch√£o (no m√°ximo, 3.3V / 1000Ohm = 3.3mA fluir√° com o resistor). <br><br>  √â hora de pensar no que fazer se a eletricidade acabar.  A primeira op√ß√£o √© solicitar ao servidor os contadores iniciais no in√≠cio.  Mas isso exigiria uma complica√ß√£o significativa do protocolo de troca.  Al√©m disso, a operacionalidade do dispositivo, neste caso, depende do status do servidor.  Se, depois de desligar a luz, o servidor n√£o iniciar (ou iniciar mais tarde), o hidr√¥metro n√£o poder√° solicitar os valores iniciais e funcionar√° incorretamente. <br><br>  Portanto, decidi implementar o armazenamento de valores de contador em um chip de mem√≥ria conectado via I2C.  N√£o tenho requisitos especiais para o tamanho da mem√≥ria flash - preciso salvar apenas 2 n√∫meros (o n√∫mero de litros por medidores de √°gua quente e fria).  At√© o menor m√≥dulo serve.  Mas no n√∫mero de ciclos de grava√ß√£o, voc√™ precisa prestar aten√ß√£o.  Para a maioria dos m√≥dulos, s√£o 100 mil ciclos, para alguns at√© um milh√£o. <br><br>  Parece que um milh√£o √© muito.  Mas, durante 4 anos morando no meu apartamento, consumi pouco mais de 500 metros c√∫bicos de √°gua, ou seja, 500 mil litros!  E 500 mil entradas no flash.  E isso √© apenas √°gua fria.  Voc√™ pode, √© claro, soldar o chip a cada dois anos, mas acontece que existem chips FRAM.  Do ponto de vista da programa√ß√£o, √© o mesmo I2C EEPROM, mas com um n√∫mero muito grande de ciclos de reescrita (centenas de milh√µes).  Isso √© apenas at√© que tudo chegue √† loja com esses chips de qualquer maneira, ent√£o por enquanto o 24LC512 usual permanecer√°. <br><br><h3>  Placa de circuito </h3><br>  Inicialmente, planejei fazer uma taxa em casa.  Portanto, o quadro foi projetado como unilateral.  Mas, depois de uma longa hora com um ferro a laser e uma m√°scara de solda (sem ela de alguma forma vir il il), eu ainda decidi pedir placas aos chineses. <br><br><img src="https://habrastorage.org/webt/en/si/rz/ensirzhmczp3bs9n7a6a8plmzl4.png"><br><br>  Quase antes de encomendar a placa, percebi que, al√©m do chip de mem√≥ria flash no barramento I2C, voc√™ pode pegar outra coisa √∫til, como uma tela.  O que exatamente produzir para ele ainda √© uma pergunta, mas voc√™ precisa criar no quadro.  Bem, desde que eu encomendaria as placas na f√°brica, n√£o fazia sentido me limitar a uma placa de um lado, ent√£o as linhas no I2C s√£o as √∫nicas na parte de tr√°s da placa. <br><br>  Um batente grande tamb√©m foi associado √† fia√ß√£o unilateral.  Porque  a placa foi desenhada de um lado, as faixas e os componentes SMD foram planejados para serem colocados de um lado e os componentes de sa√≠da, conectores e a fonte de alimenta√ß√£o do outro.  Quando recebi as placas em um m√™s, esqueci o plano inicial e descompactei todos os componentes na parte frontal.  E somente quando se tratava de soldar a fonte de alimenta√ß√£o, descobriu-se que o mais e o menos eram divorciados pelo contr√°rio.  Eu tive que fazer fazendas coletivas com jumpers.  Na figura acima, eu j√° mudei a fia√ß√£o, mas o solo √© jogado de uma parte da placa para outra atrav√©s das sa√≠das do bot√£o Boot (embora seja poss√≠vel desenhar uma trilha na segunda camada). <br><br>  Acabou assim <br><br><img src="https://habrastorage.org/webt/au/-d/cs/au-dcsvpehh9p5g9iqyob5hjslu.jpeg"><br><br><h3>  Habita√ß√£o </h3><br>  O pr√≥ximo passo √© a caixa.  Com uma impressora 3D, isso n√£o √© um problema.  N√£o me incomodei muito - apenas desenhei uma caixa do tamanho certo e fiz recortes nos lugares certos.  A tampa est√° presa ao corpo em pequenos parafusos. <br><br><img src="https://habrastorage.org/webt/qq/lu/zp/qqluzptanq4d24dsv4jdlb9uif8.png"><br><br>  Eu j√° mencionei que o bot√£o Boot pode ser usado como um bot√£o de uso geral - aqui n√≥s o trazemos para o painel frontal.  Para fazer isso, desenhei um "po√ßo" especial onde o bot√£o mora. <br><br><img src="https://habrastorage.org/webt/dv/xg/gn/dvxggnexv-fiqy0jqtptpdk1dvy.png"><br><br>  Dentro do gabinete, tamb√©m existem tocos nos quais a placa √© instalada e fixada com um √∫nico parafuso M3 (n√£o havia mais espa√ßo na placa) <br><br>  A exibi√ß√£o foi selecionada quando imprimi a primeira vers√£o de encaixe do estojo.  O padr√£o de duas linhas n√£o se encaixava nesse caso, mas um display OLED SSD1306 128x32 foi encontrado no cardan.  √â pequeno, mas n√£o preciso olhar para ele todos os dias - ele vai rolar. <br><br>  Estimando o caminho e como os fios ser√£o colocados a partir dele, decidi colocar a tela no meio do gabinete.  Ergonomia, √© claro, abaixo do rodap√© - um bot√£o na parte superior, uma exibi√ß√£o na parte inferior.  Mas eu j√° disse que a id√©ia de estragar a tela veio tarde demais e era muito pregui√ßoso reorganizar a placa para mover o bot√£o. <br><br>  O dispositivo est√° completo.  O m√≥dulo de exibi√ß√£o √© colado aos bicos de fus√£o a quente <br><br><img src="https://habrastorage.org/webt/sn/qr/xf/snqrxfyyihzqwiwwwf-1yly545m.jpeg"><br><br><img src="https://habrastorage.org/webt/ow/bh/2o/owbh2oguwv4tiez2basnv11hgvw.jpeg"><br><br>  O resultado final pode ser visto no KDPV <br><br><h3>  Firmware </h3><br>  Vamos para a parte do software.  Para trabalhos t√£o pequenos, gosto muito de usar a linguagem Python ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">micropython</a> ) - o c√≥digo √© muito compacto e compreens√≠vel.  Felizmente, n√£o h√° necessidade de diminuir o n√≠vel de registros para comprimir microssegundos - tudo pode ser feito a partir de python. <br><br>  Parece ser tudo simples, mas n√£o muito - v√°rias fun√ß√µes independentes est√£o descritas no dispositivo: <br><br><ul><li>  O usu√°rio aperta um bot√£o e olha para o visor </li><li>  Litros marcam e atualizam valores na mem√≥ria flash </li><li>  O m√≥dulo monitora o sinal WiFi e reconecta, se necess√°rio </li><li>  Bem, sem uma luz piscando, voc√™ n√£o consegue fazer nada </li></ul><br>  √â imposs√≠vel supor que uma fun√ß√£o n√£o funcione se a outra for est√∫pida por algum motivo.  J√° comi cactos em outros projetos e agora vejo falhas no estilo de ‚Äúperdi outro litro, porque naquele momento a tela foi atualizada‚Äù ou ‚Äúo usu√°rio n√£o pode fazer nada enquanto o m√≥dulo se conecta ao WiFi‚Äù.  Obviamente, algumas coisas podem ser feitas atrav√©s de interrup√ß√µes, mas voc√™ pode ter uma limita√ß√£o na dura√ß√£o, aninhamento de chamadas ou altera√ß√£o n√£o at√¥mica de vari√°veis.  Bem, o c√≥digo que faz tudo e imediatamente se transforma rapidamente em uma bagun√ßa. <br><br>  Em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um projeto mais s√©rio,</a> usei a multitarefa preemptiva cl√°ssica e o FreeRTOS, mas, neste caso, o modelo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">corotinas e a biblioteca uasync</a> mostraram-se muito mais adequados.  Al√©m disso, a implementa√ß√£o Pitonovskiy do corutin √© apenas uma bomba - para o programador, tudo foi feito de forma simples e conveniente.  Apenas escreva sua pr√≥pria l√≥gica, diga-me em quais lugares voc√™ pode alternar entre threads. <br><br>  Sugiro explorar as diferen√ßas entre crowding out e multitarefa competitiva opcionalmente.  Agora, vamos finalmente avan√ßar para o c√≥digo. <br><br><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">##################################### # Counter class - implements a single water counter on specified pin ##################################### class Counter(): debounce_ms = const(25) def __init__(self, pin_num, value_storage): self._value_storage = value_storage self._value = self._value_storage.read() self._value_changed = False self._pin = Pin(pin_num, Pin.IN, Pin.PULL_UP) loop = asyncio.get_event_loop() loop.create_task(self._switchcheck()) # Thread runs forever</span></span></code> </pre> <br>  Cada contador √© processado por uma inst√¢ncia da classe Counter.  Primeiro, o valor inicial do contador √© subtra√≠do da EEPROM (value_storage) - √© assim que a recupera√ß√£o da falta de energia √© implementada. <br><br>  O pino √© inicializado com um pull-up integrado √† energia: se o interruptor reed estiver fechado, ser√° zero na linha, se a linha estiver aberta, a linha ser√° puxada para a energia e o controlador ler√° um. <br><br>  Al√©m disso, uma tarefa separada √© iniciada aqui, que far√° a pesquisa do pino.  Cada contador executar√° sua pr√≥pria tarefa.  Aqui est√° o c√≥digo dela <br><br><pre> <code class="python hljs"> <span class="hljs-string"><span class="hljs-string">""" Poll pin and advance value when another litre passed """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_switchcheck</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> last_checked_pin_state = self._pin.value() <span class="hljs-comment"><span class="hljs-comment"># Get initial state # Poll for a pin change while True: state = self._pin.value() if state != last_checked_pin_state: # State has changed: act on it now. last_checked_pin_state = state if state == 0: self._another_litre_passed() # Ignore further state changes until switch has settled await asyncio.sleep_ms(Counter.debounce_ms)</span></span></code> </pre> <br>  √â necess√°rio um atraso de 25ms para filtrar a rejei√ß√£o do contato e, ao mesmo tempo, regula a frequ√™ncia com que a tarefa √© ativada (enquanto esta tarefa est√° em suspens√£o, outras tarefas funcionam).  A cada 25ms, a fun√ß√£o √© ativada, verifica o pino e, se os contatos do interruptor reed est√£o fechados, outro litro passa pelo contador e isso precisa ser processado. <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_another_litre_passed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self._value += <span class="hljs-number"><span class="hljs-number">1</span></span> self._value_changed = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> self._value_storage.write(self._value)</code> </pre> <br>  Processar o pr√≥ximo litro √© trivial - o contador simplesmente aumenta.  Bem, seria bom escrever um novo valor em uma unidade flash. <br><br>  Para facilitar o uso, s√£o fornecidos "acessadores". <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self._value_changed = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self._value <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, value)</span></span></span><span class="hljs-function">:</span></span> self._value = value self._value_changed = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span></code> </pre> <br>  Bem, agora vamos aproveitar os prazeres do python e da biblioteca uasync e tornar o objeto contador esper√°vel (como isso pode ser traduzido para o russo? O que √© esperado?) <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__await__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> self._value_changed: <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.value() __iter__ = __await__</code> </pre> <br>  Essa √© uma fun√ß√£o t√£o conveniente que aguarda at√© que o valor do contador seja atualizado - a fun√ß√£o √© ativada periodicamente e verifica o sinalizador _value_changed.  A piada dessa fun√ß√£o √© que o c√≥digo de chamada pode adormecer em uma chamada para essa fun√ß√£o e dormir at√© que um novo valor seja recebido. <br><br><div class="spoiler">  <b class="spoiler_title">Mas e as interrup√ß√µes?</b> <div class="spoiler_text">  Sim, neste lugar voc√™ pode me enganar, dizendo que ele mesmo falou sobre interrup√ß√µes, mas na verdade ele organizou uma pesquisa est√∫pida do alfinete.  De fato, interrup√ß√µes s√£o a primeira coisa que tentei.  No ESP8266, voc√™ pode organizar uma interrup√ß√£o na borda e at√© escrever um manipulador para essa interrup√ß√£o em python.  Nesta interrup√ß√£o, voc√™ pode atualizar o valor de uma vari√°vel.  Provavelmente, isso seria suficiente se o contador fosse um dispositivo escravo - um que aguarde at√© que seja solicitado esse valor. <br><br>  Infelizmente (ou felizmente?) Meu dispositivo est√° ativo, ele deve enviar mensagens usando o protocolo MQTT e gravar dados na EEPROM.  E aqui est√£o as restri√ß√µes - voc√™ n√£o pode alocar mem√≥ria e usar uma pilha grande em interrup√ß√µes, o que significa que voc√™ pode esquecer o envio de mensagens pela rede.  Existem p√£ezinhos como micropython.schedule () que permitem executar algum tipo de fun√ß√£o "o mais r√°pido poss√≠vel", mas a pergunta √© "qual √© o sentido?".  De repente, estamos enviando algum tipo de mensagem agora, e aqui a interrup√ß√£o muda e estraga os valores das vari√°veis.  Ou, por exemplo, um novo valor de contador chegou do servidor enquanto ainda n√£o anotamos o antigo.  Em geral, voc√™ precisa cercar a sincroniza√ß√£o ou sair de alguma maneira diferente. <br><br>  E, de tempos em tempos, o RuntimeError falha: agende a pilha cheia e quem sabe por qu√™? <br><br>  Com uma pesquisa expl√≠cita e uasync, nesse caso, √© de alguma forma mais bonita e mais confi√°vel. <br></div></div><br>  Comecei a trabalhar com a EEPROM em uma turma pequena <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EEPROM</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">:</span></span> i2c_addr = const(<span class="hljs-number"><span class="hljs-number">80</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, i2c)</span></span></span><span class="hljs-function">:</span></span> self.i2c = i2c self.i2c_buf = bytearray(<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-comment"><span class="hljs-comment"># Avoid creation/destruction of the buffer on each call def read(self, eeprom_addr): self.i2c.readfrom_mem_into(self.i2c_addr, eeprom_addr, self.i2c_buf, addrsize=16) return ustruct.unpack_from("&lt;I", self.i2c_buf)[0] def write(self, eeprom_addr, value): ustruct.pack_into("&lt;I", self.i2c_buf, 0, value) self.i2c.writeto_mem(self.i2c_addr, eeprom_addr, self.i2c_buf, addrsize=16)</span></span></code> </pre> <br>  Em python, trabalhar com bytes diretamente √© dif√≠cil, mas s√£o bytes gravados na mem√≥ria.  Eu tive que corrigir a convers√£o entre n√∫meros inteiros e bytes usando a biblioteca ustruct. <br><br>  Para n√£o transferir o objeto I2C e o endere√ßo da c√©lula de mem√≥ria de cada vez, envolvi tudo em um cl√°ssico pequeno e conveniente <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EEPROMValue</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, i2c, eeprom_addr)</span></span></span><span class="hljs-function">:</span></span> self._eeprom = EEPROM(i2c) self._eeprom_addr = eeprom_addr <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self._eeprom.read(self._eeprom_addr) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, value)</span></span></span><span class="hljs-function">:</span></span> self._eeprom.write(self._eeprom_addr, value)</code> </pre> <br>  O pr√≥prio objeto I2C √© criado com esses par√¢metros <br><br><pre> <code class="python hljs">i2c = I2C(freq=<span class="hljs-number"><span class="hljs-number">400000</span></span>, scl=Pin(<span class="hljs-number"><span class="hljs-number">5</span></span>), sda=Pin(<span class="hljs-number"><span class="hljs-number">4</span></span>))</code> </pre> <br>  Abordamos a coisa mais interessante - a implementa√ß√£o da comunica√ß√£o com o servidor via MQTT.  Bem, o pr√≥prio protocolo n√£o precisa ser implementado - uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">implementa√ß√£o ass√≠ncrona pronta</a> foi encontrada na Internet.  Aqui vamos us√°-lo. <br><br>  Tudo o mais interessante √© coletado na classe CounterMQTTClient, que √© baseada na biblioteca MQTTClient.  Vamos come√ßar da periferia <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">##################################### # Class handles both counters and sends their status to MQTT ##################################### class CounterMQTTClient(MQTTClient): blue_led = Pin(2, Pin.OUT, value = 1) button = Pin(0, Pin.IN) hot_counter = Counter(12, EEPROMValue(i2c, EEPROM_ADDR_HOT_VALUE)) cold_counter = Counter(13, EEPROMValue(i2c, EEPROM_ADDR_COLD_VALUE))</span></span></code> </pre> <br>  Aqui, s√£o criados e configurados pinos de l√¢mpadas e bot√µes, al√©m de objetos de medidores de √°gua fria e quente. <br><br>  Com a inicializa√ß√£o, nem tudo √© t√£o trivial <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.internet_outage = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> self.internet_outages = <span class="hljs-number"><span class="hljs-number">0</span></span> self.internet_outage_start = ticks_ms() <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">"config.txt"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> config_file: config[<span class="hljs-string"><span class="hljs-string">'ssid'</span></span>] = config_file.readline().rstrip() config[<span class="hljs-string"><span class="hljs-string">'wifi_pw'</span></span>] = config_file.readline().rstrip() config[<span class="hljs-string"><span class="hljs-string">'server'</span></span>] = config_file.readline().rstrip() config[<span class="hljs-string"><span class="hljs-string">'client_id'</span></span>] = config_file.readline().rstrip() self._mqtt_cold_water_theme = config_file.readline().rstrip() self._mqtt_hot_water_theme = config_file.readline().rstrip() self._mqtt_debug_water_theme = config_file.readline().rstrip() config[<span class="hljs-string"><span class="hljs-string">'subs_cb'</span></span>] = self.mqtt_msg_handler config[<span class="hljs-string"><span class="hljs-string">'wifi_coro'</span></span>] = self.wifi_connection_handler config[<span class="hljs-string"><span class="hljs-string">'connect_coro'</span></span>] = self.mqtt_connection_handler config[<span class="hljs-string"><span class="hljs-string">'clean'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> config[<span class="hljs-string"><span class="hljs-string">'clean_init'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> super().__init__(config) loop = asyncio.get_event_loop() loop.create_task(self._heartbeat()) loop.create_task(self._counter_coro(self.cold_counter, self._mqtt_cold_water_theme)) loop.create_task(self._counter_coro(self.hot_counter, self._mqtt_hot_water_theme)) loop.create_task(self._display_coro())</code> </pre> <br>  Para definir os par√¢metros de opera√ß√£o da biblioteca mqtt_as, um dicion√°rio grande de diferentes configura√ß√µes √© usado - config.  A maioria das configura√ß√µes padr√£o nos conv√©m, mas muitas configura√ß√µes precisam ser definidas explicitamente.  Para n√£o registrar as configura√ß√µes diretamente no c√≥digo, eu as guardo no arquivo de texto config.txt.  Isso permite alterar o c√≥digo, independentemente das configura√ß√µes, al√©m de rebitar v√°rios dispositivos id√™nticos com par√¢metros diferentes. <br><br>  O √∫ltimo bloco de c√≥digo executa v√°rias corotinas para atender a v√°rias fun√ß√µes do sistema.  Aqui est√° um exemplo de corotina que serve contadores <br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_counter_coro</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, counter, topic)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># Publish initial value value = counter.value() await self.publish(topic, str(value)) # Publish each new value while True: value = await counter await self.publish_msg(topic, str(value))</span></span></code> </pre> <br>  Em um ciclo, Corutin aguarda um novo valor de contador e, assim que aparece, envia uma mensagem usando o protocolo MQTT.  O primeiro trecho de c√≥digo envia o valor inicial, mesmo que a √°gua n√£o flua atrav√©s do contador. <br><br>  A classe base MQTTClient serve a si mesma, inicia uma conex√£o WiFi e reconecta quando a conex√£o √© perdida.  Quando o status da conex√£o WiFi muda, a biblioteca informa-nos chamando wifi_connection_handler <br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wifi_connection_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, state)</span></span></span><span class="hljs-function">:</span></span> self.internet_outage = <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> state <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> state: self.dprint(<span class="hljs-string"><span class="hljs-string">'WiFi is up.'</span></span>) duration = ticks_diff(ticks_ms(), self.internet_outage_start) // <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self.publish_debug_msg(<span class="hljs-string"><span class="hljs-string">'ReconnectedAfter'</span></span>, duration) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: self.internet_outages += <span class="hljs-number"><span class="hljs-number">1</span></span> self.internet_outage_start = ticks_ms() self.dprint(<span class="hljs-string"><span class="hljs-string">'WiFi is down.'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre> <br>  A fun√ß√£o √© honestamente lambida dos exemplos.  Nesse caso, considera o n√∫mero de desconex√µes (internet_outages) e sua dura√ß√£o.  Quando uma conex√£o √© restaurada, o tempo de inatividade √© enviado ao servidor. <br><br>  A prop√≥sito, o √∫ltimo sono √© necess√°rio apenas para que a fun√ß√£o se torne ass√≠ncrona - na biblioteca √© chamada via aguardar, e somente as fun√ß√µes no corpo das quais h√° outro aguardam podem ser chamadas. <br><br>  Al√©m de conectar-se ao WiFi, voc√™ tamb√©m precisa estabelecer uma conex√£o com o broker MQTT (servidor).  A biblioteca tamb√©m faz isso, mas temos a oportunidade de fazer algo √∫til quando a conex√£o √© estabelecida. <br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mqtt_connection_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, client)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> client.subscribe(self._mqtt_cold_water_theme) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> client.subscribe(self._mqtt_hot_water_theme)</code> </pre> <br>  Aqui, assinamos v√°rias mensagens - o servidor agora tem a capacidade de definir os valores atuais do contador enviando a mensagem apropriada. <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mqtt_msg_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, topic, msg)</span></span></span><span class="hljs-function">:</span></span> topicstr = str(topic, <span class="hljs-string"><span class="hljs-string">'utf8'</span></span>) self.dprint(<span class="hljs-string"><span class="hljs-string">"Received MQTT message topic={}, msg={}"</span></span>.format(topicstr, msg)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> topicstr == self._mqtt_cold_water_theme: self.cold_counter.set_value(int(msg)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> topicstr == self._mqtt_hot_water_theme: self.hot_counter.set_value(int(msg))</code> </pre> <br>  Esta fun√ß√£o processa as mensagens recebidas e, dependendo do t√≥pico (nome da mensagem), os valores de um dos contadores s√£o atualizados <br><br>  Algumas fun√ß√µes auxiliares <br><br><pre> <code class="python hljs"> <span class="hljs-comment"><span class="hljs-comment"># Publish a message if WiFi and broker is up, else discard async def publish_msg(self, topic, msg): self.dprint("Publishing message on topic {}: {}".format(topic, msg)) if not self.internet_outage: await self.publish(topic, msg) else: self.dprint("Message was not published - no internet connection")</span></span></code> </pre> <br>  Esta fun√ß√£o envia mensagens se uma conex√£o for estabelecida.  Se n√£o houver conex√£o, a mensagem ser√° ignorada. <br><br>  E esta √© apenas uma fun√ß√£o conveniente que gera e envia mensagens de depura√ß√£o. <br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publish_debug_msg</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, subtopic, msg)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self.publish_msg(<span class="hljs-string"><span class="hljs-string">"{}/{}"</span></span>.format(self._mqtt_debug_water_theme, subtopic), str(msg))</code> </pre><br>  Muito texto, mas n√£o piscamos um LED.  Aqui <br><br><pre> <code class="python hljs"> <span class="hljs-comment"><span class="hljs-comment"># Blink flash LED if WiFi down async def _heartbeat(self): while True: if self.internet_outage: self.blue_led(not self.blue_led()) # Fast blinking if no connection await asyncio.sleep_ms(200) else: self.blue_led(0) # Rare blinking when connected await asyncio.sleep_ms(50) self.blue_led(1) await asyncio.sleep_ms(5000)</span></span></code> </pre> <br>  Eu forneci 2 modos de piscar.  Se a conex√£o for perdida (ou est√° sendo estabelecida), o dispositivo piscar√° rapidamente.  Se a conex√£o for estabelecida, o dispositivo pisca uma vez a cada 5 segundos.  Se necess√°rio, aqui voc√™ pode implementar outros modos de piscar. <br><br>  Mas o LED √© t√£o mimos.  Ainda acenamos para a tela. <br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_display_coro</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> display = SSD1306_I2C(<span class="hljs-number"><span class="hljs-number">128</span></span>,<span class="hljs-number"><span class="hljs-number">32</span></span>, i2c) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: display.poweron() display.fill(<span class="hljs-number"><span class="hljs-number">0</span></span>) display.text(<span class="hljs-string"><span class="hljs-string">"COLD: {:.3f}"</span></span>.format(self.cold_counter.value() / <span class="hljs-number"><span class="hljs-number">1000</span></span>), <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>) display.text(<span class="hljs-string"><span class="hljs-string">"HOT: {:.3f}"</span></span>.format(self.hot_counter.value() / <span class="hljs-number"><span class="hljs-number">1000</span></span>), <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>) display.show() <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">3</span></span>) display.poweroff() <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> self.button(): <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep_ms(<span class="hljs-number"><span class="hljs-number">20</span></span>)</code> </pre> <br>  √â sobre isso que eu falei - qu√£o simples e conveniente com as corotinas.  Esta pequena fun√ß√£o descreve TODA a intera√ß√£o do usu√°rio.  Corutin apenas espera que um bot√£o seja pressionado e liga o visor por 3 segundos.  O visor mostra as leituras atuais do medidor. <br><br>  Ainda existem algumas pequenas coisas.  Aqui est√° a fun√ß√£o que executa o farm inteiro (re).  O ciclo principal lida apenas com o envio de v√°rias informa√ß√µes de depura√ß√£o uma vez por minuto.  Em geral, cito como √© - especialmente o coment√°rio, eu acho, n√£o √© necess√°rio <br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self._connect_to_WiFi() <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self._run_main_loop() <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Exception <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> e: self.dprint(<span class="hljs-string"><span class="hljs-string">'Global communication failure: '</span></span>, e) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_connect_to_WiFi</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.dprint(<span class="hljs-string"><span class="hljs-string">'Connecting to WiFi and MQTT'</span></span>) sta_if = network.WLAN(network.STA_IF) sta_if.connect(config[<span class="hljs-string"><span class="hljs-string">'ssid'</span></span>], config[<span class="hljs-string"><span class="hljs-string">'wifi_pw'</span></span>]) conn = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> conn: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self.connect() conn = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> self.dprint(<span class="hljs-string"><span class="hljs-string">'Connected!'</span></span>) self.internet_outage = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_run_main_loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># Loop forever mins = 0 while True: gc.collect() # For RAM stats. mem_free = gc.mem_free() mem_alloc = gc.mem_alloc() try: await self.publish_debug_msg("Uptime", mins) await self.publish_debug_msg("Repubs", self.REPUB_COUNT) await self.publish_debug_msg("Outages", self.internet_outages) await self.publish_debug_msg("MemFree", mem_free) await self.publish_debug_msg("MemAlloc", mem_alloc) except Exception as e: self.dprint("Exception occurred: ", e) mins += 1 await asyncio.sleep(60)</span></span></code> </pre> <br>  Bem, mais algumas configura√ß√µes e constantes para completar a descri√ß√£o <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">##################################### # Constants and configuration ##################################### config['keepalive'] = 60 config['clean'] = False config['will'] = ('/ESP/Wemos/Water/LastWill', 'Goodbye cruel world!', False, 0) MQTTClient.DEBUG = True EEPROM_ADDR_HOT_VALUE = const(0) EEPROM_ADDR_COLD_VALUE = const(4)</span></span></code> </pre> <br>  Come√ßa todo esse caminho <br><br><pre> <code class="python hljs">client = CounterMQTTClient() loop = asyncio.get_event_loop() loop.run_until_complete(client.main())</code> </pre> <br><br><h3>  Algo com a minha mem√≥ria se tornou </h3><br>  Ent√£o, todo o c√≥digo est√° l√°.  Carreguei os arquivos usando o utilit√°rio ampy - ele permite que eles sejam carregados na unidade flash interna (a que est√° no pr√≥prio ESP-07) e depois acessados ‚Äã‚Äãdo programa como arquivos normais.  L√°, eu enviei as bibliotecas mqtt_as, uasyncio, ssd1306 e cole√ß√µes (usadas dentro de mqtt_as) que eu uso. <br><br>  Come√ßamos e ... Recebemos MemoryError.  Al√©m disso, quanto mais eu tentava entender exatamente onde a mem√≥ria estava vazando, mais eu organizava a depura√ß√£o de impress√µes, mais cedo esse erro ocorria.  Um pequeno gugelezh me levou a entender que, em princ√≠pio, o microcontrolador tem apenas 30kb de mem√≥ria, no qual 65kb de c√≥digo (junto com bibliotecas) n√£o se encaixam de forma alguma. <br><br>  Mas existe um caminho.  Acontece que o micropython n√£o executa o c√≥digo diretamente do arquivo .py - esse arquivo √© compilado primeiro.  E compila diretamente no microcontrolador, transforma-se em bytecode, que √© ent√£o armazenado na mem√≥ria.  Bem, para o compilador funcionar, voc√™ tamb√©m precisa de uma certa quantidade de RAM. <br><br>  O truque √© salvar o microcontrolador da compila√ß√£o que consome muitos recursos.  Voc√™ pode compilar arquivos em um computador grande e preencher o c√≥digo de c√≥digo finalizado no microcontrolador.  Para fazer isso, fa√ßa o download do firmware micropython e crie o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">utilit√°rio mpy-cross</a> . <br><br>  N√£o escrevi um Makefile, mas passei manualmente e compilei todos os arquivos necess√°rios (incluindo bibliotecas) como este <br><br><pre> <code class="bash hljs">mpy-cross water_counter.py</code> </pre> <br>  Resta apenas fazer upload de arquivos com a extens√£o .mpy, sem esquecer de excluir o .py correspondente do sistema de arquivos do dispositivo. <br><br>  Realizei todo o desenvolvimento do programa (IDE?) ESPlorer.  Ele permite que voc√™ envie scripts para o microcontrolador e os execute imediatamente.  No meu caso, toda a l√≥gica e cria√ß√£o de todos os objetos est√£o localizadas no arquivo water_counter.py (.mpy).  Mas, para que tudo isso inicie automaticamente, no in√≠cio deve haver outro arquivo chamado main.py.  E deve ser exatamente .py, e n√£o um .mpy pr√©-compilado.  Aqui est√° o seu conte√∫do trivial <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> water_counter</code> </pre> <br>  Come√ßamos - tudo funciona.  Mas h√° perigosamente pouca mem√≥ria livre - cerca de 1kb.  Ainda tenho planos de expandir a funcionalidade do dispositivo, e esse kilobyte obviamente n√£o ser√° suficiente para mim.  Mas acabou que existe uma sa√≠da para este caso. <br><br>  Aqui est√° a coisa.  Embora os arquivos sejam compilados no c√≥digo de bytes e estejam localizados no sistema de arquivos interno, na verdade eles ainda s√£o carregados na RAM e executados a partir da√≠.  Mas o micropython √© capaz de executar o bytecode diretamente da mem√≥ria flash, mas para isso voc√™ precisa incorpor√°-lo diretamente no firmware.  Isso n√£o √© dif√≠cil, embora tenha levado um tempo decente no meu netbook (somente l√° eu tenho o Linux). <br><br>  O algoritmo √© o seguinte: <br><br><ul><li>  Baixe e instale o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ESP Open SDK</a> .  Essa coisa cria um compilador e bibliotecas para programas no ESP8266.  √â montado de acordo com as instru√ß√µes na p√°gina principal do projeto (eu escolhi a configura√ß√£o STANDALONE = yes) </li><li>  Baixar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Micropython Sorts</a> </li><li>  Solte as bibliotecas necess√°rias nas portas / esp8266 / modules dentro da √°rvore do micropython </li><li>  Montamos o firmware de acordo com as instru√ß√µes no <a href="">arquivo ports / esp8266 / README.md</a> </li><li>  Coloque o firmware no microcontrolador (eu fa√ßo isso no Windows com programas ESP8266Flasher ou Python esptool) </li></ul><br>  √â isso, agora 'import ssd1306' aumentar√° o c√≥digo diretamente do firmware e a RAM n√£o ser√° gasta para isso.  Com esse truque, baixei apenas o c√≥digo da biblioteca no firmware, enquanto o c√≥digo principal do programa √© executado no sistema de arquivos.  Isso permite que voc√™ modifique facilmente o programa sem recompilar o firmware.  No momento, tenho cerca de 8,5kb de RAM livre.  Isso permitir√° implementar muitas funcionalidades √∫teis diferentes no futuro.  Bem, se n√£o houver mem√≥ria suficiente, voc√™ tamb√©m pode enviar o programa principal para o firmware. <br><br><h3>  E o que fazer com isso agora? </h3><br>  Ok, o hardware est√° soldado, o firmware est√° escrito, a caixa est√° impressa, o dispositivo est√° preso na parede e pisca alegremente com uma l√¢mpada.  Mas enquanto tudo isso √© uma caixa preta (no sentido literal e figurativo) e o sentido dela ainda n√£o √© suficiente.  √â hora de fazer algo com as mensagens MQTT enviadas ao servidor. <br><br>  Minha ‚Äúcasa inteligente‚Äù est√° girando no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sistema Majordomo</a> .  O m√≥dulo MQTT est√° pronto para uso ou pode ser facilmente instalado no mercado de complementos - n√£o me lembro mais de onde ele veio.  A coisa do MQTT n√£o √© auto-suficiente - o chamado  broker - um servidor que recebe, classifica e redireciona mensagens MQTT para clientes.  Eu uso mosquito, que (como o majordomo) roda no mesmo netbook. <br><br>  Ap√≥s o dispositivo enviar uma mensagem pelo menos uma vez, o valor aparecer√° imediatamente na lista. <br><br><img src="https://habrastorage.org/webt/hf/ip/db/hfipdb1coxh_lsaaz600mi-39y0.png"><br><br>  Esses valores agora podem ser associados a objetos do sistema, podem ser usados ‚Äã‚Äãem scripts de automa√ß√£o e submetidos a v√°rias an√°lises - tudo isso est√° fora do escopo deste artigo.  Quem est√° interessado no sistema majordomo, posso recomendar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">o canal Electronics In Lens</a> - um amigo tamb√©m constr√≥i uma casa inteligente e fala de maneira inteligente sobre a instala√ß√£o do sistema. <br><br>  Vou mostrar apenas alguns gr√°ficos.  Este √© um gr√°fico simples de valores di√°rios. <br><br><img src="https://habrastorage.org/webt/km/hw/xr/kmhwxruql1fk0kmykb1gpcpci_0.png"><br>  Pode-se ver que quase ningu√©m usava √°gua √† noite.  Algumas vezes algu√©m foi ao banheiro, e parece que um filtro de osmose reversa suga alguns litros por noite.  De manh√£, o consumo aumenta significativamente.  Normalmente, uso √°gua de uma caldeira, mas depois queria tomar um banho e mudar temporariamente para a √°gua quente da cidade - isso tamb√©m √© claramente vis√≠vel no gr√°fico inferior. <br><br>  A partir dessa programa√ß√£o, aprendi que ir ao banheiro √© de 6 a 7 litros de √°gua, tomar banho - 20 a 30 litros, lavar a lou√ßa cerca de 20 litros e, para tomar um banho, voc√™ precisa de 160 litros.  Por um dia, minha fam√≠lia consome algo em torno de 500-600l. <br><br>  Para os mais curiosos, voc√™ pode ver as entradas para cada valor individual <br><br><img src="https://habrastorage.org/webt/8l/8i/su/8l8isu_aiaswajdeeuexytpwffi.png"><br><br>  A partir daqui, aprendi que, com a torneira aberta, a √°gua flui a uma velocidade de cerca de 1 litro em 5 segundos. <br><br>  Mas, dessa forma, as estat√≠sticas provavelmente n√£o s√£o muito convenientes de se assistir.  No majordomo ainda h√° a oportunidade de ver gr√°ficos de consumo por dia, semana e m√™s.  Por exemplo, um gr√°fico de consumo em colunas <br><br><img src="https://habrastorage.org/webt/m3/wa/sf/m3wasfzbvxb2tz1yhemod2ewwdy.png"><br><br>  At√© agora, s√≥ tenho dados por uma semana.  Em um m√™s, esse gr√°fico ser√° mais indicativo - uma coluna separada corresponder√° a cada dia.  Os ajustes nos valores inseridos manualmente prejudicam um pouco a imagem (a maior coluna).  E ainda n√£o est√° claro se defini incorretamente os primeiros valores com quase um cubo a menos, ou se isso √© um bug no firmware e nem todos os litros foram para a compensa√ß√£o.  Leva mais tempo. <br><br>  Ainda √© necess√°rio conjurar sobre os pr√≥prios gr√°ficos, embranquecer, cores.  Talvez eu tamb√©m construa um gr√°fico do consumo de mem√≥ria para fins de depura√ß√£o - de repente algo vaza por a√≠.  Talvez eu exiba de alguma forma per√≠odos em que a Internet n√£o estava dispon√≠vel.  Enquanto tudo isso est√° girando no n√≠vel das id√©ias. <br><br><h3>  Conclus√£o </h3><br>  Hoje, meu apartamento ficou um pouco mais inteligente.  Com um dispositivo t√£o pequeno, ser√° mais conveniente para mim monitorar o consumo de √°gua em casa.  Se antes eu estava indignado "novamente eles consumiram muita √°gua em um m√™s", agora posso encontrar a fonte desse consumo. <br><br>  Parece estranho para algu√©m assistir as leituras na tela se estiver a um metro de dist√¢ncia do pr√≥prio medidor.  Mas em um futuro n√£o muito distante, pretendo mudar para outro apartamento, onde haver√° v√°rios risers, e os medidores provavelmente estar√£o localizados no patamar.  Portanto, um dispositivo de leitura remota seria muito √∫til. <br><br>  Tamb√©m pretendo expandir a funcionalidade do dispositivo.  Eu j√° estou olhando para v√°lvulas motorizadas.  Agora, para trocar a √°gua da cidade das caldeiras, preciso abrir 3 torneiras em um nicho inacess√≠vel.  Seria muito mais conveniente fazer isso com um bot√£o com a indica√ß√£o apropriada.  Bem, √© claro, vale a pena implementar prote√ß√£o contra vazamentos. <br><br>  No artigo, contei a minha vers√£o do dispositivo com base no ESP8266.  Na minha opini√£o, recebi uma vers√£o muito interessante do firmware micropython usando a coroutine - simples e bonita.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tentei descrever as muitas nuances e escolas que encontrei na campanha. </font><font style="vertical-align: inherit;">Talvez eu tenha descrito tudo com muitos detalhes; para mim, pessoalmente, como leitor, √© mais f√°cil desperdi√ßar muito do que pensar no que n√£o foi dito. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como sempre, estou aberto a cr√≠ticas construtivas. </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">Modelo de Gabinete de </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">Circuito e Placa de </font></a></font><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo Fonte</font></font></a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"></font></a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"></font></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt411259/">https://habr.com/ru/post/pt411259/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt411249/index.html">Como fiz meu Yandex.Transporte com hor√°rios e √¥nibus</a></li>
<li><a href="../pt411251/index.html">Os usu√°rios reenviam os arquivos de verifica√ß√£o do Chrome na unidade local</a></li>
<li><a href="../pt411253/index.html">A fus√£o de estrelas de n√™utrons p√¥s fim √†s alternativas de mat√©ria escura e energia escura</a></li>
<li><a href="../pt411255/index.html">Aplicativos descentralizados para milh√µes de usu√°rios no Ethereum</a></li>
<li><a href="../pt411257/index.html">Nos EUA, eles criam um sistema de laser que assusta o inimigo com som</a></li>
<li><a href="../pt411261/index.html">Resposta vibrat√≥ria em pr√≥teses: uma nova maneira de melhorar o controle dos membros bi√¥nicos</a></li>
<li><a href="../pt411263/index.html">Bot√£o m√°gico para LED no ATtiny4</a></li>
<li><a href="../pt411265/index.html">Casos de espi√£o (parte 3)</a></li>
<li><a href="../pt411267/index.html">Quem est√° realmente por tr√°s dos novos smartphones da marca Nokia?</a></li>
<li><a href="../pt411269/index.html">Os tr√™s componentes de "LOAD"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>