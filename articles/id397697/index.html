<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏉 😲 ✌🏽 Bagaimana saya melakukan prosthetisasi pada indikator UPS ♐️ ↩️ 👨‍❤️‍👨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pada akhir 90-an saya mendapat UPS. Cantik, dengan indikator LED dan banyak tombol, ia memiliki dua baterai di dalam dan dapat mendukung kehidupan kom...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bagaimana saya melakukan prosthetisasi pada indikator UPS</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/397697/"><img src="https://habrastorage.org/files/4f0/b42/8eb/4f0b428ebdd6405db46834adaf3a9543.jpg" alt="selama debugging"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada akhir 90-an saya mendapat UPS. Cantik, dengan indikator LED dan banyak tombol, ia memiliki dua baterai di dalam dan dapat mendukung kehidupan komputer saya pada saat itu (bersama dengan monitor!) Selama 15 menit. Waktu di Kamchatka sulit saat itu, lampu dimatikan secara teratur, jadi perangkat ini sangat berguna. Saya melewati seluruh krisis energi bersamanya, dan lebih dari sekali dia menyelamatkan surat-surat saya dari listrik yang tiba-tiba hilang. Dan juga, Anda dapat menghubungkan tape recorder ke sana dan, dengan cahaya lilin, dengarkan radio atau kaset favorit Anda, siapkan diri Anda makan malam di atas kompor gas portabel ...</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara alami, UPS rusak. Pertama kali transformernya terbakar. Bukan yang besar dan ada di inverter, tapi ada yang kecil, mungkin untuk mengukur tegangan di jaringan. Tidak menemukan pabrik yang sama, saya membuat yang buatan sendiri, dan perangkat bekerja lebih lama. Lalu berhenti. Untuk waktu yang sangat lama, saya tidak dapat menemukan alasannya. Saya harus menyolder bagian yang berbeda, memeriksanya untuk kinerja dan menyoldernya kembali. Masalahnya tidak ditemukan. Perangkat yang patah jatuh di bawah tempat tidur selama beberapa tahun, sampai, suatu hari, ide datang kepada saya untuk menerapkan 5 volt langsung ke controller. Dan lihatlah: ada bunyi bip speaker terpasang dan angka muncul pada indikator LED. Dia hidup! Lebih jauh, ini masalah teknologi: Saya berjalan di sepanjang rangkaian catu daya dengan voltmeter dan menemukan bahwa sekring telah disolder di papan, yang tampak seperti resistor!Sekring (ditiup secara alami) diganti dan UPS hidup kembali.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sayangnya, perbaikan saya dan dua tahun di bawah tempat tidur tidak hilang begitu saja. Dalam beberapa cara yang tidak dapat dipahami, port terbakar di controller, yang bertanggung jawab atas cahaya LED "On-Line" hijau dan segmen terendah dari semua indikator segmen digital. Tidak ada yang bisa dilakukan tentang hal itu - saya harus berdamai. Setelah beberapa waktu, saya meninggalkan Kamchatka dan jalan kami berbeda. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tahun-tahun berlalu dan, setelah tiba untuk mengunjungi orang tua saya, di sudut jauh saya menemukan baterai favorit saya yang tidak terputus: ditinggalkan, kotor, tanpa baterai dan kaki karet. Pada saat itu, saya sudah mendapatkan perumahan saya sendiri di kota lain, jadi keputusan dibuat untuk mengambil perlindungan untuk diri saya sendiri, memulihkan efisiensinya dan menggunakannya untuk tujuan yang dimaksudkan. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tantangan</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama-tama, UPS dicuci dan dikeringkan. Kemudian, di toko bagian radio tertentu, kaki karet yang cocok dan baterai baru dibeli. Yang mengejutkan saya, transformator yang cocok ditemukan di toko yang sama, sebagai imbalan untuk produk buatan saya. Beberapa hari kerja, dan baterai tanpa gangguan yang diperbarui dan diperbarui dengan gembira berdecit dan mulai mengisi baterai baru. Semuanya baik-baik saja, tetapi indikatornya masih tidak berfungsi.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gagasan untuk memperbaikinya datang kepada saya sebelumnya. Setelah menggambar semua angka (dan beberapa huruf) dari tujuh segmen indikator pada lembar notebook, saya menyadari bahwa adalah mungkin untuk menentukan keadaan segmen terendah dengan keadaan sisanya. LED hijau dapat menyala ketika LED lain tidak menyala. Ada banyak pemikiran tentang bagaimana hal ini dapat dilakukan: dari chip ROM sederhana hingga FPGA sederhana. Tetapi, karena saya adalah seorang mahasiswa dan tinggal di Kamchatka, saya tidak memiliki kesempatan untuk mendapatkan sesuatu yang lebih rumit daripada logika kecil. Memperbaiki indikator ditunda.</font></font><br>
<br>
<img src="https://habrastorage.org/files/0d1/175/f43/0d1175f43d72446383ebd4f0dcb687db.jpg" alt="menggambar segmen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kali ini saya memutuskan untuk menangani masalah ini dengan serius. Setelah mencari-cari di tempat sampah, saya kembali tidak menemukan pada saya baik ROM, maupun FPGA dan CPLD. Tetapi, Arduino Pro Mini, atau lebih tepatnya, tiruan Cina murahnya dengan Ali Express, jatuh ke tangan. Saya membeli Arduin untuk membuat komputer mini berbasis WiFi SD card dari Transcend. Sayangnya, kartu itu mati selama percobaan, dan papan dengan mikrokontroler tetap menganggur. Tidak ada, kami menemukannya tantangan baru! </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bekerja</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tampilan dinamis diimplementasikan dalam modul display: sinyal segmen adalah umum untuk keempat indikator sehingga hanya satu yang menyala secara bersamaan. Selain itu: seolah-olah dengan indikator kelima, tiga LED juga terhubung. Lima sinyal pilihan memungkinkan Anda menentukan indikator (atau garis LED) mana yang sedang digunakan sekarang. Sinyal seleksi ini dipindai secara berurutan pada kecepatan yang cukup tinggi dan, karena inersia penglihatan, tampaknya semua indikator menyala secara bersamaan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada awalnya, saya ingin menyiasati solusi paling sederhana: siklus biasa yang memeriksa sinyal dari enam segmen kerja, dan menghidupkan atau mematikan yang tidak berfungsi ketujuh. Sebenarnya, ini hanyalah emulasi dari ROM, yang saya pikirkan di awal.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk melakukan ini, saya harus menghubungkan enam segmen kerja ke input mikrokontroler, dan segmen yang tidak bekerja ke output. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah membuat sketsa array kecil yang membandingkan berbagai keadaan input dengan output dan loop yang mem-bypass array ini, saya memuat semuanya ke controller dan segera mendapat masalah: segmen bawah selalu bersinar. Pikiran pertama: cant dalam program. Namun, tidak peduli seberapa banyak saya melihat kode, tidak ada kesalahan yang ditemukan. Pada akhirnya, dapat dipahami bahwa siklus saya sama sekali tidak disinkronkan dengan pergantian indikator. Jika kita membaca status segmen pada akhir siklus pemilihan satu indikator, maka kemungkinan kita akan menyalakan atau menurunkan segmen berikutnya pada yang berikutnya. Kekacauan.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tanpa berpikir dua kali, saya menyolder lima sinyal pemilihan indikator ke input Arduino gratis yang tersisa, mengaturnya untuk menghasilkan interupsi, dan mulai menggunakan interrupt handler alih-alih loop. Itu menjadi lebih baik, tetapi tidak memecahkan masalah. Di tempat yang tepat, ruasnya terbakar seperti seharusnya, tetapi di tempat-tempat di mana ia seharusnya padam, tidak ada cahaya sisa yang terang.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah berpikir untuk beberapa waktu lagi, saya memutuskan bahwa efek ini dapat muncul jika siklus pencarian dalam array keadaan yang diinginkan untuk segmen membutuhkan waktu lebih lama daripada waktu pembakaran indikator. Dalam hal ini, kami juga keluar dari fase kami dan mengelola segmen indikator berikutnya. Adalah perlu bahwa sesedikit mungkin waktu berlalu antara saat menerima interupsi dari sinyal seleksi ke perintah kontrol segmen. Ini bisa dilakukan hanya dengan satu cara: untuk menghapus kode yang membuat keputusan tentang keadaan segmen dari interrupt handler, jalankan di loop utama dengan prioritas minimal, dan simpan hasilnya dalam semacam buffer global. Interrupt handler hanya perlu membaca nilai buffer global ini dan memadamkan atau menyalakan segmen tersebut, tergantung pada isinya. Dalam kasus terburukkita hanya bisa terlambat dengan perubahan status segmen dalam indikator tertentu, tetapi kita tidak akan naik ke yang berikutnya.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Itu adalah keputusan yang tepat. </font><font style="vertical-align: inherit;">Tapi akhirnya itu bekerja hanya setelah saya mensinkronisasi siklus pengambilan keputusan dengan interupsi menggunakan spin-lock dan melarang pemrosesan interupsi selama siklus ini. </font><font style="vertical-align: inherit;">Dan itu tidak hanya diperoleh, tetapi diterima sebagaimana mestinya!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada masalah lain dengan indikator: sebagian besar waktu mereka hanya menunjukkan angka. </font><font style="vertical-align: inherit;">Namun, setelah menyalakan UPS, proses pengujian dimulai, di mana, di samping angkanya, dua kata lagi muncul: TEST dan PASS. </font><font style="vertical-align: inherit;">Dan jika, huruf T, E dan P dapat dengan mudah ditambahkan ke array karakter yang valid, dan S sama dengan 5s, maka huruf A tidak ada artinya, dari sudut pandang program saya, dari angka delapan. </font><font style="vertical-align: inherit;">Siklus keputusan hanya menemukan pola yang sesuai dalam array dan menggambar segmen bawah. </font><font style="vertical-align: inherit;">Itu perlu untuk datang dengan sesuatu untuk menghindari ini.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan saya datang dengan. Selama kedatangan sinyal tentang perubahan indikator, perlu untuk menentukan indikator mana yang dimiliki dan menyimpan status segmennya dalam variabel yang dialokasikan secara khusus untuknya. Sekarang, kapan saja, saya dapat secara akurat menentukan konten saat ini dari keempat indikator sekaligus. Dan jika simbol P, 5 dan 5 masing-masing ditampilkan pada yang pertama, ketiga dan keempat, maka simbol kedua pasti A, dan Anda tidak perlu menyalakan segmen bawah. Untuk berjaga-jaga, saya juga menambahkan pemrosesan kata FAIL, yang belum pernah saya lihat, tetapi yang saya harapkan akan muncul.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semuanya, dengan indikator digital berakhir. Tetap hanya untuk memperbaiki LED On-Line hijau. Tapi di sini kejutan menunggu saya ... Idenya adalah ini: LED hijau (On-Line) selalu menyala sendiri. Jika LED kuning (Baterai) atau merah (Baterai Rendah) menyala, warna hijau seharusnya tidak menyala. Jadi, kami menyolder kabel dari LED ini ke mikrokontroler, menempatkan if () sederhana dengan "OR" yang logis dan semuanya harus bekerja. Tapi ternyata ketika LED kuning menyala, nyatanya, tidak menyala terus-menerus, tetapi berkedip cepat. Cepat, tetapi tidak cukup untuk jika () melompati dan tidak menyalakan LED hijau. Ternyata ketika bekerja dari jaringan, LED hijau menyala dengan kecerahan penuh, tetapi ketika beralih ke baterai, ia menyala setengah kecerahan, tetapi masih menyala. Yah, tidak masalah, saya pikir, saya akan memasang filter low-pass sederhana:Saya akan memotong semua flash cepat, tetapi saya hanya akan meninggalkan yang lambat yang sesuai dengan transisi ke baterai dan sebaliknya. Analisis waktu berkedip LED kuning membawa kejutan berikut: periode pulsa yang dipasok ke itu sangat tidak stabil dan dapat mencapai nilai yang cukup besar. Ternyata filter harus melewati sinyal tidak lebih tinggi dari 0,5-1 Hz. Ini tidak terlalu baik, karena kami mendapat penundaan yang agak besar dalam mengubah sinyal On-Line, tetapi cukup dapat ditoleransi.karena kita mendapatkan penundaan yang agak besar dalam mengubah sinyal On-Line, tetapi itu cukup lumayan.karena kita mendapatkan penundaan yang agak besar dalam mengubah sinyal On-Line, tetapi itu cukup lumayan.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya memutuskan untuk membuat filter sangat sederhana. </font><font style="vertical-align: inherit;">Kami 50 kali, secara berkala, memantau status LED kuning dan merah. </font><font style="vertical-align: inherit;">Jika salah satunya terbakar, maka kami menambah penghitung khusus dengan satu. </font><font style="vertical-align: inherit;">Kemudian, kami memeriksa nilai penghitung, dan jika LED kontrol menyala untuk 50% dari waktu yang dicentang, maka kami percaya bahwa itu menyala, dan jika kurang, maka itu mati. </font><font style="vertical-align: inherit;">Dalam proses debugging, saya harus mengurangi angka ini menjadi 10%. </font><font style="vertical-align: inherit;">Mengapa - tidak mengetahuinya. </font></font><br>
<br>
<img src="https://habrastorage.org/files/88e/bd5/51b/88ebd551ba62430ba32362657836bd94.jpg" alt="perakitan akhir"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan itu semua berhasil! </font><font style="vertical-align: inherit;">Hanya tersisa untuk dengan indah memasang papan Arduino dalam wadah UPS dengan selotip dua sisi dan pistol berperekat.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/Elb8pT4lWlQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk yang penasaran:</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kode yang dihasilkan</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdint.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;avr/io.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;avr/interrupt.h&gt;</span></span></span></span><font></font>
<font></font>
<font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> AVG_TIME    50</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> THS_TIME    45</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SEG_A    _BV(0)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SEG_B    _BV(1)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SEG_C    _BV(2)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SEG_D    _BV(3)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SEG_E    _BV(4)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SEG_F    _BV(5)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SEG_G    _BV(6)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_LED_RED  SD_SEG_A</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_LED_YLW  SD_SEG_C</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LD_SEL_LED  _BV(0)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LD_SEL_1    _BV(1)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LD_SEL_2    _BV(2)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LD_SEL_3    _BV(3)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LD_SEL_4    _BV(4)</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> GET_SEL     (PINC &amp; 0x1f)</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_NONE (0)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_0    (SD_SEG_A | SD_SEG_B | SD_SEG_C | SD_SEG_D | SD_SEG_E | SD_SEG_F)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_1    (SD_SEG_B | SD_SEG_C)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_2    (SD_SEG_A | SD_SEG_B | SD_SEG_D | SD_SEG_E | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_3    (SD_SEG_A | SD_SEG_B | SD_SEG_C | SD_SEG_D | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_4    (SD_SEG_B | SD_SEG_C | SD_SEG_F | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_5    (SD_SEG_A | SD_SEG_C | SD_SEG_D | SD_SEG_F | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_6    (SD_SEG_A | SD_SEG_C | SD_SEG_D | SD_SEG_E | SD_SEG_F | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_7    (SD_SEG_A | SD_SEG_B | SD_SEG_C)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_8    (SD_SEG_A | SD_SEG_B | SD_SEG_C | SD_SEG_D | SD_SEG_E | SD_SEG_F | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_9    (SD_SEG_A | SD_SEG_B | SD_SEG_C | SD_SEG_D | SD_SEG_F | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_E    (SD_SEG_A | SD_SEG_D | SD_SEG_E | SD_SEG_F | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_P    (SD_SEG_A | SD_SEG_B | SD_SEG_E | SD_SEG_F | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_T    (SD_SEG_D | SD_SEG_E | SD_SEG_F | SD_SEG_G)</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> GET_SYM     (~PIND &amp; 0x7f)</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> BROKEN_SEG  (SD_SEG_D)</span></span><font></font>
<font></font>
<font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> sd_symbols[] = {                 <span class="hljs-comment"><span class="hljs-comment">// list of known symbols</span></span><font></font>
    SD_SYM_NONE,<font></font>
    SD_SYM_0, SD_SYM_1, SD_SYM_2, SD_SYM_3, SD_SYM_4,<font></font>
    SD_SYM_5, SD_SYM_6, SD_SYM_7, SD_SYM_8, SD_SYM_9,<font></font>
    SD_SYM_E, SD_SYM_P, SD_SYM_T<font></font>
};<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> sel, symbol;            <span class="hljs-comment"><span class="hljs-comment">// current input signals</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> fb0, fb1, fb2, fb3, fb4;  <span class="hljs-comment"><span class="hljs-comment">// display frame buffer</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// display routine</span></span><font></font>
ISR(PCINT1_vect) {<font></font>
    sel = GET_SEL;<font></font>
    symbol = GET_SYM;<font></font>
<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (((sel &amp; LD_SEL_LED) &amp;&amp; fb0) ||<font></font>
            ((sel &amp; LD_SEL_1) &amp;&amp; fb1) ||<font></font>
            ((sel &amp; LD_SEL_2) &amp;&amp; fb2) ||<font></font>
            ((sel &amp; LD_SEL_3) &amp;&amp; fb3) ||<font></font>
            ((sel &amp; LD_SEL_4) &amp;&amp; fb4)){<font></font>
        PORTD &amp;= ~BROKEN_SEG;<font></font>
    }<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {<font></font>
        PORTD |= BROKEN_SEG;<font></font>
    }<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//</span></span>
<span class="hljs-comment"><span class="hljs-comment">// entry point</span></span>
<span class="hljs-comment"><span class="hljs-comment">//</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">
</span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> cur_time;
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> led_on_time;
    <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> last_symbol_1, last_symbol_2, last_symbol_3, last_symbol_4;
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i;<font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// setup GPIO ports</span></span>
    DDRC = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
    DDRD = BROKEN_SEG;<font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// setup pin change interrupt</span></span><font></font>
    PCICR |= _BV(PCIE1);<font></font>
    PCMSK1 |= _BV(PCINT8) | _BV(PCINT9) | _BV(PCINT10) | _BV(PCINT11) | _BV(PCINT12);<font></font>
<font></font>
    cur_time = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
    led_on_time = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
    last_symbol_1 = last_symbol_2 = last_symbol_3 = last_symbol_4 = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
    fb0 = fb1 = fb2 = fb3 = fb4 = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) {
        <span class="hljs-comment"><span class="hljs-comment">// sync with display strobe</span></span><font></font>
        sei();<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (sel == <span class="hljs-number"><span class="hljs-number">0</span></span>) {}<font></font>
        cli();<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// if select one of segment indicator</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sel &amp; (LD_SEL_1 | LD_SEL_2 | LD_SEL_3 | LD_SEL_4)) {
            <span class="hljs-comment"><span class="hljs-comment">// looking for displayed symbol</span></span>
            <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">14</span></span>; i++) {
                <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> sd_symbol = sd_symbols[i];
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((symbol &amp; ~BROKEN_SEG) == (sd_symbol &amp; ~BROKEN_SEG)) {
                    <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> val;
                    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sd_symbol &amp; BROKEN_SEG) {<font></font>
                        val = <span class="hljs-number"><span class="hljs-number">1</span></span>;<font></font>
                    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {<font></font>
                        val = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
                    }<font></font>
<font></font>
                    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sel &amp; LD_SEL_1) {<font></font>
                        last_symbol_1 = sd_symbol;<font></font>
                        fb1 = val;<font></font>
                    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sel &amp; LD_SEL_2) {<font></font>
                        last_symbol_2 = sd_symbol;<font></font>
                        fb2 = val;<font></font>
                    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sel &amp; LD_SEL_3) {<font></font>
                        last_symbol_3 = sd_symbol;<font></font>
                        fb3 = val;<font></font>
                    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sel &amp; LD_SEL_4) {<font></font>
                        last_symbol_4 = sd_symbol;<font></font>
                        fb4 = val;<font></font>
                    }<font></font>
<font></font>
                    <span class="hljs-comment"><span class="hljs-comment">// PASS workaround</span></span>
                    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((last_symbol_1 == SD_SYM_P) &amp;&amp;(last_symbol_2 == SD_SYM_8) &amp;&amp;<font></font>
                            (last_symbol_3 == SD_SYM_5) &amp;&amp; (last_symbol_4 == SD_SYM_5)) {<font></font>
                        fb2 = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
                    }<font></font>
                    <span class="hljs-comment"><span class="hljs-comment">// FAIL workaround</span></span>
                    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((last_symbol_1 == SD_SYM_E) &amp;&amp;(last_symbol_2 == SD_SYM_8) &amp;&amp;<font></font>
                            (last_symbol_3 == SD_SYM_1) &amp;&amp; (last_symbol_4 == SD_SYM_1)) {<font></font>
                        fb1 = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
                        fb2 = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
                        fb4 = <span class="hljs-number"><span class="hljs-number">1</span></span>;<font></font>
                    }<font></font>
<font></font>
                    <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// if select LED line</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sel &amp; LD_SEL_LED) {
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cur_time++ &gt; AVG_TIME) {
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (led_on_time &lt; THS_TIME) {<font></font>
                    fb0 = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
                } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {<font></font>
                    fb0 = <span class="hljs-number"><span class="hljs-number">1</span></span>;<font></font>
                }<font></font>
                cur_time = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
                led_on_time = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
            } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((symbol &amp; (SD_LED_RED | SD_LED_YLW)) == <span class="hljs-number"><span class="hljs-number">0</span></span>) {<font></font>
                    led_on_time++;<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// reset sync flag</span></span>
        sel = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
}<font></font>
</code></pre><br>
</div></div></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id397697/">https://habr.com/ru/post/id397697/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id397687/index.html">Pada beberapa laptop dengan Windows 10 Anda tidak dapat mengirimkan Linux</a></li>
<li><a href="../id397689/index.html">Kenapa kita selalu merasa sibuk</a></li>
<li><a href="../id397691/index.html">Beli sebagai PRO, bro</a></li>
<li><a href="../id397693/index.html">Para ilmuwan pertama kali menyusun model 3D otak Drosophila</a></li>
<li><a href="../id397695/index.html">Apa itu plasticizer dan apa yang mereka makan</a></li>
<li><a href="../id397699/index.html">Manfaat kaligrafi dan mitos pendidikan lainnya</a></li>
<li><a href="../id397701/index.html">Kartu video dinamai menurut saya: cara menjadi overclocker profesional</a></li>
<li><a href="../id397703/index.html">Pemenang Hadiah Shnobel 2016</a></li>
<li><a href="../id397705/index.html">Baterai lithium-ion dan lithium-polimer: trik pemasaran dan kesalahan umum</a></li>
<li><a href="../id397707/index.html">Otak kecil yang menakjubkan</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>