<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ…ğŸ¾ ğŸ¦‚ ğŸ¤œğŸ¼ ç±»ä¼¼äºUnixçš„OSå¼€å‘-Shellã€‚ ç»“è®ºï¼ˆ9ï¼‰ ğŸ¨ ğŸ•µï¸ ğŸ‘ƒ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ç°åœ¨è¯¥ä¸ºæˆ‘ä»¬çš„å†…æ ¸ç¼–å†™ç¬¬ä¸€ä¸ªå•ç‹¬çš„ç¨‹åº-shellã€‚ å®ƒä¼šå­˜å‚¨åœ¨å•ç‹¬çš„.elfæ–‡ä»¶ä¸­ï¼Œå¹¶åœ¨å†…æ ¸å¯åŠ¨æ—¶ç”±initè¿›ç¨‹å¯åŠ¨ã€‚ 

 è¿™æ˜¯æˆ‘ä»¬æ“ä½œç³»ç»Ÿå¼€å‘å‘¨æœŸä¸­çš„æœ€åä¸€ç¯‡æ–‡ç« ã€‚ 

 ç›®å½• 
 æ„å»ºç³»ç»Ÿï¼ˆmakeï¼Œgccï¼Œgasï¼‰ã€‚ åˆå§‹å¼•å¯¼ï¼ˆå¤šæ¬¡å¼•å¯¼ï¼‰ã€‚ å¯åŠ¨ï¼ˆqemuï¼‰ã€‚ Cåº“ï¼ˆstrcpyï¼Œmemc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ç±»ä¼¼äºUnixçš„OSå¼€å‘-Shellã€‚ ç»“è®ºï¼ˆ9ï¼‰</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/468719/"> ç°åœ¨è¯¥ä¸ºæˆ‘ä»¬çš„å†…æ ¸ç¼–å†™ç¬¬ä¸€ä¸ªå•ç‹¬çš„ç¨‹åº-shellã€‚ å®ƒä¼šå­˜å‚¨åœ¨å•ç‹¬çš„.elfæ–‡ä»¶ä¸­ï¼Œå¹¶åœ¨å†…æ ¸å¯åŠ¨æ—¶ç”±initè¿›ç¨‹å¯åŠ¨ã€‚ <br><br> è¿™æ˜¯æˆ‘ä»¬æ“ä½œç³»ç»Ÿå¼€å‘å‘¨æœŸä¸­çš„æœ€åä¸€ç¯‡æ–‡ç« ã€‚ <br><a name="habracut"></a><br><h4> ç›®å½• </h4><br> æ„å»ºç³»ç»Ÿï¼ˆmakeï¼Œgccï¼Œgasï¼‰ã€‚ åˆå§‹å¼•å¯¼ï¼ˆå¤šæ¬¡å¼•å¯¼ï¼‰ã€‚ å¯åŠ¨ï¼ˆqemuï¼‰ã€‚  Cåº“ï¼ˆstrcpyï¼Œmemcpyï¼Œstrextï¼‰ã€‚ <br><br>  Cåº“ï¼ˆsprintfï¼Œstrcpyï¼Œstrcmpï¼Œstrtokï¼Œva_list ...ï¼‰ã€‚ ä»¥å†…æ ¸æ¨¡å¼å’Œç”¨æˆ·åº”ç”¨ç¨‹åºæ¨¡å¼æ„å»ºåº“ã€‚ <br><br> å†…æ ¸ç³»ç»Ÿæ—¥å¿—ã€‚ æ˜¾å­˜ è¾“å‡ºåˆ°ç»ˆç«¯ï¼ˆkprintfï¼Œkpanicï¼Œkassertï¼‰ã€‚ <br> åŠ¨æ€å†…å­˜ï¼Œå †ï¼ˆkmallocï¼Œkfreeï¼‰ã€‚ <br><br> å†…å­˜å’Œä¸­æ–­å¤„ç†çš„ç»„ç»‡ï¼ˆGDTï¼ŒIDTï¼ŒPICï¼Œsyscallï¼‰ã€‚ ä¾‹å¤–æƒ…å†µ <br> è™šæ‹Ÿå†…å­˜ï¼ˆé¡µé¢ç›®å½•å’Œé¡µé¢è¡¨ï¼‰ã€‚ <br><br> è¿‡ç¨‹ã€‚ ç­–åˆ’äºº å¤šä»»åŠ¡å¤„ç†ã€‚ ç³»ç»Ÿè°ƒç”¨ï¼ˆkillï¼Œexitï¼Œpsï¼‰ã€‚ <br><br> å­—ç¬¦è®¾å¤‡é©±åŠ¨ç¨‹åºã€‚ ç³»ç»Ÿè°ƒç”¨ï¼ˆioctlï¼Œfopenï¼Œfreadï¼Œfwriteï¼‰ã€‚  Cåº“ï¼ˆfopenï¼Œfcloseï¼Œfprintfï¼Œfscanfï¼‰ã€‚ <br><br>  <b>å†…æ ¸ï¼ˆinitrdï¼‰ï¼ŒelfåŠå…¶å†…éƒ¨æ–‡ä»¶ç³»ç»Ÿã€‚</b>  <b>ç³»ç»Ÿè°ƒç”¨ï¼ˆæ‰§è¡Œï¼‰ã€‚</b>  <b>Shellä½œä¸ºå†…æ ¸çš„å®Œæ•´ç¨‹åºã€‚</b> <br><br> ç”¨æˆ·ä¿æŠ¤æ¨¡å¼ï¼ˆring3ï¼‰ã€‚ ä»»åŠ¡çŠ¶æ€æ®µï¼ˆtssï¼‰ã€‚ <br><br><h4>  Shellä½œä¸ºå®Œæ•´çš„å†…æ ¸ç¨‹åº </h4><br> åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ç ”ç©¶äº†å­—ç¬¦è®¾å¤‡é©±åŠ¨ç¨‹åºï¼Œå¹¶ç¼–å†™äº†ä¸€ä¸ªç»ˆç«¯é©±åŠ¨ç¨‹åºã€‚ <br><br> ç°åœ¨ï¼Œæˆ‘ä»¬æ‹¥æœ‰åˆ›å»ºç¬¬ä¸€ä¸ªæ§åˆ¶å°åº”ç”¨ç¨‹åºæ‰€éœ€çš„ä¸€åˆ‡ã€‚ <br><br> æˆ‘ä»¬å°†ç¼–å†™æ§åˆ¶å°åº”ç”¨ç¨‹åºæœ¬èº«ï¼Œç„¶åå°†å…¶ç¼–è¯‘ä¸ºå•ç‹¬çš„elfã€‚ <br><br><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Elf entry point */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ u_int errno; stdio_init(); errno = main(); stdio_deinit(); <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(errno); }</code> </pre> <br> æˆ‘ä»¬å°†éœ€è¦åˆå§‹åŒ–æ ‡å‡†åº“ï¼Œå¹¶å°†æ§åˆ¶æƒè½¬ç§»åˆ°ç†Ÿæ‚‰çš„mainå‡½æ•°ã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> cmd[<span class="hljs-number"><span class="hljs-number">255</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(prompt); flush(); <span class="hljs-built_in"><span class="hljs-built_in">scanf</span></span>(cmd); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!execute_command(cmd)) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br> åœ¨å¾ªç¯çš„æ›´æ·±å¤„ï¼Œæˆ‘ä»¬åªéœ€è¯»å–è¯¥è¡Œå¹¶æ‰§è¡Œå‘½ä»¤å³å¯ã€‚ <br><br> å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™é€šè¿‡strtok_rè¿›è¡ŒParsimå‘½ä»¤ã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute_command</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* cmd)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-built_in"><span class="hljs-built_in">strcmp</span></span>(cmd, cmd_ps)) { <span class="hljs-comment"><span class="hljs-comment">/* show tasks list */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">clist_definition_t</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">task_list</span></span></span><span class="hljs-class">;</span></span> task_list = ps(); <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">" -- process list\n"</span></span>); clist_for_each(task_list, print_task_info); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-built_in"><span class="hljs-built_in">strcmp</span></span>(cmd, cmd_clear)) { <span class="hljs-comment"><span class="hljs-comment">/* clear screen */</span></span> clear(); flush(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>(cmd, cmd_kill, <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(cmd_kill))) { <span class="hljs-comment"><span class="hljs-comment">/* kill task */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* save_ptr = null; strtok_r(cmd, <span class="hljs-string"><span class="hljs-string">" "</span></span>, &amp;save_ptr); <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* str_tid = strtok_r(null, <span class="hljs-string"><span class="hljs-string">" "</span></span>, &amp;save_ptr); u_short tid = atou(str_tid); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!kill(tid)) { <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">" There is no process with pid %u\n"</span></span>, tid); }; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>(cmd, cmd_exit, <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(cmd_exit))) { <span class="hljs-comment"><span class="hljs-comment">/* exit */</span></span> clear(); <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(prompt); flush(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>(cmd, cmd_exec, <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(cmd_exec))) { <span class="hljs-comment"><span class="hljs-comment">/* exec file on intrd */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* save_ptr = null; strtok_r(cmd, <span class="hljs-string"><span class="hljs-string">" "</span></span>, &amp;save_ptr); <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* str_file = strtok_r(null, <span class="hljs-string"><span class="hljs-string">" "</span></span>, &amp;save_ptr); exec(str_file); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>(cmd, cmd_dev, <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(cmd_dev))) { <span class="hljs-comment"><span class="hljs-comment">/* show device list */</span></span> struct <span class="hljs-keyword"><span class="hljs-keyword">clist_definition_t</span></span> *dev_list; dev_list = devs(); <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">" -- device list\n"</span></span>); clist_for_each(dev_list, print_dev_info); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">" There is no such command.\n Available command list:\n"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">" %s %s %s &lt;pid&gt; %s &lt;file.elf&gt; %s %s\n"</span></span>, cmd_ps, cmd_exit, cmd_kill, cmd_exec, cmd_clear, cmd_dev); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre><br> å®é™…ä¸Šï¼Œæˆ‘ä»¬åªæ˜¯åœ¨æ‹‰ç³»ç»Ÿè°ƒç”¨ã€‚ <br> è®©æˆ‘æé†’æ‚¨æœ‰å…³æ ‡å‡†åº“çš„åˆå§‹åŒ–ã€‚ <br><br> åœ¨ä¸Šä¸€è¯¾ä¸­ï¼Œæˆ‘ä»¬åœ¨åº“ä¸­ç¼–å†™äº†ä»¥ä¸‹å‡½æ•°ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stdio_init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">stdin</span></span> = fopen(tty_dev_name, MOD_R); <span class="hljs-built_in"><span class="hljs-built_in">stdout</span></span> = fopen(tty_dev_name, MOD_W); asm_syscall(SYSCALL_IOCTL, <span class="hljs-built_in"><span class="hljs-built_in">stdout</span></span>, IOCTL_INIT); asm_syscall(SYSCALL_IOCTL, <span class="hljs-built_in"><span class="hljs-built_in">stdin</span></span>, IOCTL_READ_MODE_LINE); asm_syscall(SYSCALL_IOCTL, <span class="hljs-built_in"><span class="hljs-built_in">stdin</span></span>, IOCTL_READ_MODE_ECHO); }</code> </pre><br> å®ƒåªæ˜¯æ‰“å¼€ç”¨äºè¯»å–å’Œå†™å…¥çš„ç‰¹æ®Šç»ˆç«¯é©±åŠ¨ç¨‹åºæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å¯¹åº”äºé”®ç›˜è¾“å…¥å’Œè¾“å‡ºåˆ°å±å¹•ã€‚ <br><br> åœ¨ç”¨å¤–å£³ç»„è£…ç²¾çµä¹‹åï¼Œå¿…é¡»å°†å…¶æ”¾ç½®åœ¨åŸå§‹å†…æ ¸æ–‡ä»¶ç³»ç»Ÿï¼ˆinitrdï¼‰ä¸Šã€‚ <br><br> åˆå§‹ramç£ç›˜ç”±å†…æ ¸åŠ è½½ç¨‹åºä½œä¸ºå¤šé‡å¼•å¯¼æ¨¡å—åŠ è½½ï¼Œå› æ­¤æˆ‘ä»¬çŸ¥é“initrdå†…å­˜ä¸­çš„åœ°å€ã€‚ <br><br> æ ¹æ®James Molloyçš„æ–‡ç« ï¼Œä»ç„¶å¾ˆå®¹æ˜“ä¸ºinitrdç»„ç»‡æ–‡ä»¶ç³»ç»Ÿã€‚ <br><br> å› æ­¤ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initrd_node_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> magic; <span class="hljs-comment"><span class="hljs-comment">/* magic number */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> name[<span class="hljs-number"><span class="hljs-number">8</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/* file name */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> offset; <span class="hljs-comment"><span class="hljs-comment">/* file base */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> length; <span class="hljs-comment"><span class="hljs-comment">/* file length */</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initrd_fs_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count; <span class="hljs-comment"><span class="hljs-comment">/* files count */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initrd_node_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">node</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">INITRD_MAX_FILES</span></span></span><span class="hljs-class">];</span></span> <span class="hljs-comment"><span class="hljs-comment">/* files headers */</span></span> };</code> </pre><br> æ¥ä¸‹æ¥ï¼Œè¯·è®°ä½32ä½elfçš„æ ¼å¼ã€‚ <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">elf_header_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">elf_header_ident_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">e_ident</span></span></span><span class="hljs-class">;</span></span> u16 e_type; u16 e_machine; u32 e_version; u32 e_entry; <span class="hljs-comment"><span class="hljs-comment">/* virtual address of entry point */</span></span> u32 e_phoff; <span class="hljs-comment"><span class="hljs-comment">/* program headers table offset */</span></span> u32 e_shoff; <span class="hljs-comment"><span class="hljs-comment">/* program headers sections table offset */</span></span> u32 e_flags; u16 e_ehsize; <span class="hljs-comment"><span class="hljs-comment">/* file header size */</span></span> u16 e_phentsize; <span class="hljs-comment"><span class="hljs-comment">/* single header size */</span></span> u16 e_phnum; <span class="hljs-comment"><span class="hljs-comment">/* headers count */</span></span> u16 e_shentsize; <span class="hljs-comment"><span class="hljs-comment">/* section header size */</span></span> u16 e_shnum; <span class="hljs-comment"><span class="hljs-comment">/* sections headers count */</span></span> u16 e_shstrndx; };</code> </pre><br> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯¹ç¨‹åºå¤´è¡¨çš„å…¥å£å’Œåœ°å€æ„Ÿå…´è¶£ã€‚ <br><br> ä»£ç å’Œæ•°æ®éƒ¨åˆ†å°†æ˜¯ç¬¬ä¸€ä¸ªæ ‡é¢˜ï¼Œè€Œå †æ ˆéƒ¨åˆ†å°†æ˜¯ç¬¬äºŒä¸ªæ ‡é¢˜ï¼ˆæ ¹æ®é€šè¿‡objdumpç ”ç©¶elfçš„ç»“æœï¼‰ã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">elf_program_header_t</span></span></span><span class="hljs-class"> {</span></span> u32 p_type; <span class="hljs-comment"><span class="hljs-comment">/* segment type */</span></span> u32 p_offset; <span class="hljs-comment"><span class="hljs-comment">/* segment offset from file begin */</span></span> u32 p_vaddr; <span class="hljs-comment"><span class="hljs-comment">/* target virtual address */</span></span> u32 p_paddr; <span class="hljs-comment"><span class="hljs-comment">/* target physical address */</span></span> u32 p_filesz; <span class="hljs-comment"><span class="hljs-comment">/* segment size in file */</span></span> u32 p_memsz; <span class="hljs-comment"><span class="hljs-comment">/* segment size in memory */</span></span> u32 p_flags; <span class="hljs-comment"><span class="hljs-comment">/* permissions and etc */</span></span> u32 p_align; <span class="hljs-comment"><span class="hljs-comment">/* alignment */</span></span> } attribute(packed);</code> </pre><br> è¯¥ä¿¡æ¯è¶³ä»¥ç¼–å†™elfæ–‡ä»¶åŠ è½½å™¨ã€‚ <br> æˆ‘ä»¬å·²ç»çŸ¥é“å¦‚ä½•ä¸ºè‡ªå®šä¹‰æµç¨‹é€‰æ‹©é¡µé¢ã€‚ <br> å› æ­¤ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸ºæ ‡é¢˜åˆ†é…è¶³å¤Ÿæ•°é‡çš„é¡µé¢å¹¶å°†å†…å®¹å¤åˆ¶åˆ°å…¶ä¸­å³å¯ã€‚ <br> æˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°å°†åŸºäºå·²è§£æçš„elfæ–‡ä»¶åˆ›å»ºä¸€ä¸ªè¿›ç¨‹ã€‚ <br> åœ¨è§†é¢‘æ•™ç¨‹ä¸­äº†è§£å¦‚ä½•è§£æelfikã€‚ <br> æˆ‘ä»¬åªéœ€è¦ä¸‹è½½ä¸€ä¸ªåŒ…å«ä»£ç å’Œæ•°æ®çš„ç¨‹åºæ ‡å¤´ï¼Œå› æ­¤æˆ‘ä»¬ä¸ä¼šä¸€æ¦‚è€Œè®ºï¼Œè€Œåªå…³æ³¨è¿™ç§æƒ…å†µã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Api - execute elf as a task */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">elf_exec</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">elf_header_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* header)</span></span></span><span class="hljs-function"> </span></span>{ assert(header-&gt;e_ident.ei_magic == EI_MAGIC); <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(MSG_KERNEL_ELF_LOADING, header-&gt;e_phnum); <span class="hljs-comment"><span class="hljs-comment">// elf_dump(header); size_t elf_base = (size_t)header; size_t entry_point = header-&gt;e_entry; struct task_mem_t task_mem; memset(&amp;task_mem, 0, sizeof(struct task_mem_t)); // load sections in memory for (int i = 0; i &lt; header-&gt;e_phnum; ++i) { struct elf_program_header_t* p_header = (void*)(header-&gt;e_phoff + elf_base + i * header-&gt;e_phentsize); task_mem.pages_count = (p_header-&gt;p_memsz / MM_PAGE_SIZE) + 1; if (p_header-&gt;p_memsz == 0) { continue; } // allocate pages assert(task_mem.pages_count &gt; 0); assert(task_mem.pages == null); task_mem.pages = mm_phys_alloc_pages(task_mem.pages_count); void* section = (void*)(elf_base + p_header-&gt;p_offset); memcpy(task_mem.pages, section, p_header-&gt;p_memsz); // setup virtual memory task_mem.page_table = mmu_create_user_page_table(); task_mem.page_dir = mmu_create_user_page_directory(task_mem.page_table); for (int i = 0; i &lt; task_mem.pages_count; ++i) { mmu_occupy_user_page(task_mem.page_table, (void*)((size_t)task_mem.pages + i * MM_PAGE_SIZE)); } } // create task u_short tid = next_tid++; assert(task_create(tid, (void*)entry_point, &amp;task_mem)); // run task struct task_t* task; task = task_get_by_id(tid); task-&gt;status = TASK_RUNNING; strncpy(task-&gt;name, "elf", sizeof(task-&gt;name)); printf(MSG_KERNEL_ELF_LOADED); }</span></span></code> </pre><br> è¿™é‡Œæœ€æœ‰è¶£çš„æ˜¯åˆ›å»ºé¡µé¢ç›®å½•å’Œé¡µé¢è¡¨ã€‚ <br> è¯·æ³¨æ„ï¼Œé¦–å…ˆæˆ‘ä»¬é€‰æ‹©ç‰©ç†é¡µé¢ï¼ˆmm_phys_alloc_pagesï¼‰ï¼Œç„¶åå°†å®ƒä»¬æ˜ å°„åˆ°é€»è¾‘é¡µé¢ï¼ˆmmu_occupy_user_pageï¼‰ã€‚ <br> è¿™é‡Œå‡è®¾ç‰©ç†å­˜å‚¨å™¨ä¸­çš„é¡µé¢æ˜¯è¿ç»­åˆ†é…çš„ã€‚ <br> ä»…æ­¤è€Œå·²ã€‚ ç°åœ¨ï¼Œæ‚¨å¯ä»¥ä¸ºå†…æ ¸å®ç°è‡ªå·±çš„shellï¼ è§‚çœ‹è§†é¢‘æ•™ç¨‹å¹¶æ·±å…¥ç ”ç©¶ç»†èŠ‚ã€‚ <br><br><h4> ç»“è®º </h4><br> æˆ‘å¸Œæœ›æ‚¨å‘ç°è¿™ä¸€ç³»åˆ—æ–‡ç« æœ‰ç”¨ã€‚ <br> æˆ‘ä»¬å°šæœªè€ƒè™‘è¿‡ä¿æŠ¤ç¯ï¼Œä½†æ˜¯ç”±äºè¯¥ä¸»é¢˜çš„ç›¸å…³æ€§è¾ƒä½ä¸”è¯„è®ºä¸ä¸€ï¼Œæˆ‘ä»¬å°†ç»§ç»­ä¸­æ–­ã€‚ <br> æˆ‘è®¤ä¸ºæ‚¨ç°åœ¨å·²ç»å‡†å¤‡å¥½è¿›è¡Œè¿›ä¸€æ­¥çš„ç ”ç©¶ï¼Œå› ä¸ºæ‚¨å’Œæˆ‘éƒ½æ£€æŸ¥äº†æ‰€æœ‰æœ€é‡è¦çš„å†…å®¹ã€‚ <br><br> å› æ­¤ï¼ŒæŸç´§è…°å¸¦ï¼ŒæŠ•å…¥æˆ˜æ–—ï¼ é€šè¿‡ç¼–å†™è‡ªå·±çš„æ“ä½œç³»ç»Ÿï¼ <br> æˆ‘èŠ±äº†å¤§çº¦ä¸€ä¸ªæœˆçš„æ—¶é—´ï¼ˆå¦‚æœæˆ‘ä»¬è€ƒè™‘å…¨å¤©å·¥ä½œ6-8ä¸ªå°æ—¶ï¼‰æ¥å®æ–½æ‚¨å’Œæˆ‘ä»å¤´å¼€å§‹å­¦åˆ°çš„ä¸€åˆ‡ã€‚ <br><br> å› æ­¤ï¼Œåœ¨2-3ä¸ªæœˆå†…ï¼Œæ‚¨å°†èƒ½å¤Ÿç¼–å†™ä¸€ä¸ªå…·æœ‰çœŸå®æ–‡ä»¶ç³»ç»Ÿçš„æˆç†ŸOSï¼Œè€Œæˆ‘ä»¬æ²¡æœ‰å®ç°è¯¥æ–‡ä»¶ç³»ç»Ÿã€‚ <br><br> åªæ˜¯çŸ¥é“qemuä¸çŸ¥é“å¦‚ä½•ä½¿ç”¨ä»»æ„æ ¼å¼çš„initrdå¹¶å°†å…¶å‰ªåˆ‡ä¸º4kbï¼Œæ‰€ä»¥æ‚¨å°†éœ€è¦åƒåœ¨Linuxä¸­é‚£æ ·ä½¿å®ƒæˆä¸ºä¸€ä¸ªï¼Œæˆ–è€…ä½¿ç”¨borschä»£æ›¿qemuã€‚ <br> å¦‚æœæ‚¨çŸ¥é“å¦‚ä½•è§£å†³æ­¤é—®é¢˜ï¼Œè¯·å†™ä¸€å°ç§äººä¿¡ä»¶ï¼Œæˆ‘å°†éå¸¸æ„Ÿè°¢æ‚¨ã€‚ <br><br> ä»…æ­¤è€Œå·²ï¼ ç›´åˆ°æ–°çš„ä¸å†è§é¢ï¼ <br><br><h4> å‚è€ƒæ–‡çŒ® </h4><br> è§‚çœ‹<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è§†é¢‘æ•™ç¨‹</a>ä»¥è·å–æ›´å¤šä¿¡æ¯ã€‚ <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">gitå­˜å‚¨åº“ä¸­</a>çš„æºä»£ç ï¼ˆæ‚¨éœ€è¦lesson9åˆ†æ”¯ï¼‰ã€‚ <br><br><h4> å‚è€ƒæ–‡çŒ® </h4><br>  1.è©¹å§†æ–¯Â·è«æ´›ä¼Šï¼ˆJames Molloyï¼‰ã€‚ æ»šåŠ¨è‡ªå·±çš„ç©å…·UNIXå…‹éš†æ“ä½œç³»ç»Ÿã€‚ <br>  2.ç‰™é½¿ã€‚  DOSï¼ŒWindowsï¼ŒUnixçš„æ±‡ç¼–å™¨ <br>  3.å¡æ‹‰ä»€å°¼ç§‘å¤«ã€‚ æ±‡ç¼–ç¨‹åºå¾ˆç®€å•ï¼ <br>  4. Tanenbaumã€‚ æ“ä½œç³»ç»Ÿã€‚ å®æ–½ä¸å¼€å‘ã€‚ <br>  5.ç½—ä¼¯ç‰¹Â·æ´›å¤«ï¼ˆRobert Loveï¼‰ã€‚  Linuxå†…æ ¸ å¼€å‘è¿‡ç¨‹çš„æè¿°ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN468719/">https://habr.com/ru/post/zh-CN468719/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN468703/index.html">ç¨‹åºå‘˜å¦‚ä½•èµšå–æ›´å¤šï¼Ÿ</a></li>
<li><a href="../zh-CN468705/index.html">åœ¨PeerJSçš„æµè§ˆå™¨ä¸­è¿›è¡Œè§†é¢‘é€šè¯ã€‚ å¿«é€Ÿä¸Šæ‰‹</a></li>
<li><a href="../zh-CN468707/index.html">æ‰“å¼€PostgreSQL Meetup UPDå½•åˆ¶å¹¿æ’­å’Œæ¼”ç¤º</a></li>
<li><a href="../zh-CN468713/index.html">åˆæ³•åŠ å¯†è´§å¸äº¤æ¢é¡¹ç›®</a></li>
<li><a href="../zh-CN468715/index.html">åº”å¯¹Aviasalesçš„æµ‹è¯•å¼€å‘ç»éªŒ</a></li>
<li><a href="../zh-CN468721/index.html">Retentioneeringï¼šæˆ‘ä»¬å¦‚ä½•ä½¿ç”¨Pythonå’ŒPandaså¼€æºäº§å“åˆ†æå·¥å…·</a></li>
<li><a href="../zh-CN468723/index.html">JSè®¾è®¡æ¨¡å¼ï¼šå¯¹è±¡åˆ›å»ºæ¨¡å¼</a></li>
<li><a href="../zh-CN468725/index.html">æ ¹æ®Voximplantå’ŒDialogflowè¿›è¡ŒGoogleé€šè¯ç­›é€‰</a></li>
<li><a href="../zh-CN468727/index.html">è”æƒ³ThinkShieldï¼šå¼ºå¤§çš„é€‰é¡¹å’ŒæœåŠ¡å¥—ä»¶å¯ç»´æŠ¤ä¼ä¸šPCçš„å®‰å…¨æ€§</a></li>
<li><a href="../zh-CN468729/index.html">æˆ‘ä»¬å°†github actionç”¨äºCIå’Œåœ¨npmä¸Šè‡ªåŠ¨å‘å¸ƒ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>