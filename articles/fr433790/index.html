<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë£ üëâüèª ‚úä Mod√®les de construction avanc√©s en plusieurs √©tapes üëû üèáüèª üìò</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La fonction de construction en plusieurs √©tapes dans les fichiers Dockerfile vous permet de cr√©er de petites images de conteneur avec un niveau de mis...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mod√®les de construction avanc√©s en plusieurs √©tapes</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/433790/"><p><img src="https://habrastorage.org/getpro/habr/post_images/ae4/9db/b18/ae49dbb18f8454823b9e133b737cacf0.png" alt="image"></p><br><p>  La fonction de construction en plusieurs √©tapes dans les fichiers Dockerfile vous permet de cr√©er de petites images de conteneur avec un niveau de mise en cache plus √©lev√© et moins de protection.  Dans cet article, je vais vous montrer quelques mod√®les avanc√©s - quelque chose de plus que la copie de fichiers entre la g√©n√©ration et l'ex√©cution.  Ils vous permettent d'atteindre des fonctions d'efficacit√© maximale.  Cependant, si vous √™tes un d√©butant dans le domaine de l'assemblage en plusieurs √©tapes, alors tout d'abord, il ne sera probablement pas inutile de lire le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">manuel d'</a> utilisation. </p><a name="habracut"></a><br><h3 id="sovmestimost-versiy">  Compatibilit√© des versions </h3><br><p>  La prise en charge de la construction en plusieurs √©tapes a √©t√© ajout√©e √† Docker dans la version v17.05.  Tous les mod√®les fonctionnent avec n'importe quelle version ult√©rieure, mais certains sont beaucoup plus efficaces, gr√¢ce aux <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©diteurs de liens</a> utilisant le c√¥t√© serveur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">BuildKit</a> .  Supposons que BuildKit ignore efficacement les √©tapes inutilis√©es et, si possible, cr√©e des √©tapes en m√™me temps (j'ai mis en √©vidence ces exemples s√©par√©ment).  BuildKit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">est</a> actuellement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ajout√© √† Moby en</a> tant que backend exp√©rimental <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pour la</a> construction et devrait √™tre disponible dans Docker CE v18.06.  Il peut √©galement √™tre utilis√© de mani√®re <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">autonome</a> ou dans le cadre du projet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">img</a> . </p><br><hr><br><h4 id="nasledovanie-ot-etapa">  H√©ritage de sc√®ne </h4><br><p> La construction en plusieurs √©tapes ajoute plusieurs nouveaux concepts de syntaxe.  Tout d'abord, vous pouvez donner √† l'√©tape commen√ßant par la commande <code>FROM</code> le nom <code>AS stagename</code> et utiliser l' <code>--from=stagename</code> dans la <code>COPY</code> pour copier les fichiers de cette √©tape.  En fait, la commande <code>FROM</code> et le label <code>--from</code> ont beaucoup plus en commun, pas pour rien qu'ils portent le m√™me nom.  Les deux prennent le m√™me argument, le reconnaissent et d√©marrent une nouvelle √©tape √† partir de ce point ou l'utilisent comme source pour copier le fichier.  Autrement dit, pour utiliser l'√©tape pr√©c√©dente dans la qualit√© d'image d'origine de l'√©tape actuelle, vous pouvez prendre non seulement <code>--from=stagename</code> , mais √©galement le nom d'√©tape <code>FROM stagename</code> .  Il est utile si vous utilisez les m√™mes parties communes dans plusieurs commandes du Dockerfile: il r√©duit le code commun et simplifie sa maintenance, en gardant les √©tapes enfants s√©par√©es.  Ainsi, la reconstruction d'une √©tape n'affecte pas le cache d'assemblage pour les autres.  En cons√©quence, chaque √©tape peut √™tre assembl√©e individuellement √† l'aide de l'√©tiquette <code>--target</code> lors de l'appel √† la <code>docker build</code> . </p><br><pre> <code class="plaintext hljs">FROM ubuntu AS base RUN apt-get update &amp;&amp; apt-get install git FROM base AS src1 RUN git clone ‚Ä¶ FROM base as src2 RUN git clone ‚Ä¶</code> </pre> <br><p>  Dans cet exemple, les deuxi√®me et troisi√®me phases de BuildKit sont g√©n√©r√©es en m√™me temps. </p><br><h3 id="neposredstvennoe-ispolzovanie-obrazov">  Utilisation directe des images </h3><br><p>  Au lieu d'utiliser des noms de stade d'assemblage dans les commandes <code>FROM</code> qui auparavant ne prenaient en charge que les r√©f√©rences d'image, vous pouvez directement utiliser des images √† l'aide de l'√©tiquette <code>--from</code> .  Il s'av√®re que de copier des fichiers directement √† partir de ces images.  Par exemple, <code>linuxkit/ca-certificatesimage</code> dans le code suivant copie directement les racines de l'autorit√© de certification TLS dans l'√©tape en cours. </p><br><pre> <code class="plaintext hljs">FROM alpine COPY --from=linuxkit/ca-certificates / /</code> </pre> <br><h3 id="psevdonim-obschego-obraza">  Alias ‚Äã‚Äãd'image commun </h3><br><p>  La phase de construction ne comprend pas n√©cessairement de commandes;  il peut consister en une seule ligne <code>FROM</code> .  Si vous utilisez l'image √† plusieurs endroits, cela simplifiera la lecture et fera en sorte que si vous avez besoin de mettre √† jour l'image globale, vous n'avez qu'√† changer une ligne. </p><br><pre> <code class="plaintext hljs">FROM alpine:3.6 AS alpine FROM alpine RUN ‚Ä¶ FROM alpine RUN ‚Ä¶</code> </pre> <br><p>  Dans cet exemple, chaque endroit utilisant l'image alpine est r√©ellement engag√© dans <code>alpine:3.6</code> , pas <code>alpine:latest</code> .  Lorsque le moment sera venu de passer √† la version <code>alpine:3.7</code> , vous devrez modifier une seule ligne, et cela ne fait aucun doute: tous les √©l√©ments de l'assemblage utilisent d√©sormais une version mise √† jour. </p><br><p>  Ceci est d'autant plus important lorsque l'argument build est utilis√© dans l'alias.  L'exemple suivant est similaire au pr√©c√©dent, mais permet √† l'utilisateur de red√©finir toutes les instances de l'assembly dans lesquelles l'image alpine est impliqu√©e en d√©finissant l' <code>--build-arg ALPINE_VERSION=value</code> .  N'oubliez pas: tous les arguments utilis√©s dans les commandes <code>FROM</code> doivent √™tre d√©termin√©s <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">avant la premi√®re phase de g√©n√©ration</a> . </p><br><pre> <code class="plaintext hljs">ARG ALPINE_VERSION=3.6 FROM alpine:${ALPINE_VERSION} AS alpine FROM alpine RUN ‚Ä¶</code> </pre> <br><h3 id="ispolzovanie-argumentov-sborki-v-from">  Utilisation des arguments de construction dans "- de" </h3><br><p>  La valeur sp√©cifi√©e dans l'√©tiquette <code>--from</code> de la <code>COPY</code> ne doit pas contenir d'arguments d'assembly.  Par exemple, l'exemple suivant n'est pas valide. </p><br><pre> <code class="plaintext hljs">// THIS EXAMPLE IS INTENTIONALLY INVALID FROM alpine AS build-stage0 RUN ‚Ä¶ FROM alpine ARG src=stage0 COPY --from=build-${src} . .</code> </pre> <br><p>  Cela est d√ª au fait que les d√©pendances entre les √©tapes doivent √™tre d√©termin√©es avant le d√©but de l'assemblage.  Une √©valuation constante de toutes les √©quipes n'est alors pas requise.  Par exemple, une variable d'environnement d√©finie dans une image <code>alpine</code> peut affecter l'√©valuation de la valeur <code>--from</code> .  La raison pour laquelle nous pouvons √©valuer les arguments de la commande <code>FROM</code> est que ces arguments sont d√©finis globalement avant le d√©but de toute √©tape.  Heureusement, comme nous l'avons d√©couvert pr√©c√©demment, il suffit de d√©finir l'√©tape de l'alias √† l'aide d'une commande <code>FROM</code> et de s'y r√©f√©rer. </p><br><pre> <code class="plaintext hljs">ARG src=stage0 FROM alpine AS build-stage0 RUN ‚Ä¶ FROM build-${src} AS copy-src FROM alpine COPY --from=copy-src . .</code> </pre> <br><p>  Maintenant, si vous remplacez l'argument d'assemblage <code>src</code> , l'√©tape initiale du dernier √©l√©ment <code>COPY</code> changera.  Remarque: si certaines √©tapes ne sont plus utilis√©es, seuls les √©diteurs de liens bas√©s sur BuildKit peuvent les ignorer efficacement. </p><br><h3 id="usloviya-ispolzuyuschie-argumenty-sborki">  Conditions utilisant des arguments de g√©n√©ration </h3><br><p>  On nous a demand√© d'ajouter la prise en charge des conditions de style <code>IF/ELSE</code> au Dockerfile.  Nous ne savons pas encore si nous ajouterons quelque chose de similaire, mais √† l'avenir, nous essaierons d'utiliser le support client dans BuildKit.  Pendant ce temps, afin d'obtenir un comportement similaire, vous pouvez utiliser les concepts multi-√©tapes actuels (avec une certaine planification). </p><br><pre> <code class="plaintext hljs">// THIS EXAMPLE IS INTENTIONALLY INVALID FROM alpine RUN ‚Ä¶ ARG BUILD_VERSION=1 IF $BUILD_VERSION==1 RUN touch version1 ELSE IF $BUILD_VERSION==2 RUN touch version2 DONE RUN ‚Ä¶</code> </pre> <br><p>  L'exemple pr√©c√©dent montre un pseudo-code pour les conditions d'enregistrement √† l'aide de <code>IF/ELSE</code> .  Pour obtenir un comportement similaire avec les g√©n√©rations √† plusieurs √©tapes actuelles, vous devrez peut-√™tre d√©finir diverses conditions de branche en tant qu'√©tapes distinctes et utiliser un argument pour s√©lectionner le chemin de d√©pendance correct. </p><br><pre> <code class="plaintext hljs">ARG BUILD_VERSION=1 FROM alpine AS base RUN ‚Ä¶ FROM base AS branch-version-1 RUN touch version1 FROM base AS branch-version-2 RUN touch version2 FROM branch-version-${BUILD_VERSION} AS after-condition FROM after-condition RUN ‚Ä¶</code> </pre> <br><p>  La derni√®re √©tape du Dockerfile est bas√©e sur l'√©tape de <code>after-condition</code> , qui est l'alias d'image (reconnu en fonction de l' <code>BUILD_VERSION</code> construction <code>BUILD_VERSION</code> ).  Selon la valeur de <code>BUILD_VERSION</code> , telle ou telle √©tape de la section centrale est s√©lectionn√©e. </p><br><p>  Remarque: seuls les √©diteurs de liens bas√©s sur BuildKit peuvent ignorer les branches inutilis√©es.  Dans les versions pr√©c√©dentes des √©diteurs de liens, toutes les √©tapes √©taient construites, mais avant de cr√©er l'image finale, leurs r√©sultats √©taient ignor√©s. </p><br><h3 id="pomoschnik-po-razrabotketestirovaniyu-dlya-minimalnogo-proizvodstvennogo-etapa">  Assistant d√©veloppement / test pour la phase de production minimale </h3><br><p>  En conclusion, regardons un exemple de combinaison de mod√®les pr√©c√©dents pour montrer comment cr√©er un Dockerfile qui cr√©e une image de production minimale et peut ensuite utiliser son contenu pour tester et cr√©er une image de d√©veloppement.  Commen√ßons par l'exemple de base Dockerfile: </p><br><pre> <code class="plaintext hljs">FROM golang:alpine AS stage0 ‚Ä¶ FROM golang:alpine AS stage1 ‚Ä¶ FROM scratch COPY --from=stage0 /binary0 /bin COPY --from=stage1 /binary1 /bin</code> </pre> <br><p>  Lorsqu'une image de production minimale est cr√©√©e, il s'agit d'une option assez courante.  Mais que se passe-t-il si vous devez √©galement obtenir une image de d√©veloppeur alternative ou ex√©cuter des tests avec ces fichiers binaires √† l'√©tape finale?  La premi√®re chose qui me vient √† l'esprit est simplement de copier des fichiers binaires similaires aux stades des tests et du d√©veloppement.  Le probl√®me est le suivant: rien ne garantit que vous testerez tous les binaires de production dans la m√™me combinaison.  Au stade final, quelque chose peut changer, mais vous oublierez d'apporter des modifications similaires √† d'autres stades ou de faire une erreur dans la mani√®re de copier des fichiers binaires.  Au final, nous ne testons pas un fichier binaire s√©par√©, mais l'image finale. </p><br><p>  Une alternative est de d√©terminer la phase de d√©veloppement et de test apr√®s la phase de production et de copier tout le contenu de la phase de production.  Utilisez ensuite une commande <code>FROM</code> pour l'√©tape de production pour faire de l'√©tape de production par d√©faut la derni√®re √©tape. </p><br><pre> <code class="plaintext hljs">FROM golang:alpine AS stage0 ‚Ä¶ FROM scratch AS release COPY --from=stage0 /binary0 /bin COPY --from=stage1 /binary1 /bin FROM golang:alpine AS dev-env COPY --from=release / / ENTRYPOINT ["ash"] FROM golang:alpine AS test COPY --from=release / / RUN go test ‚Ä¶ FROM release</code> </pre> <br><p>  Par d√©faut, ce Dockerfile continuera √† construire une image minimale par d√©faut, tandis que, par exemple, un assembly avec l'option <code>--target=dev-env</code> cr√©era une image avec un shell contenant tous les binaires de la version finale. </p><br><hr><br><p>  J'esp√®re que cela a √©t√© utile et a sugg√©r√© comment cr√©er des Dockerfiles multi-√©tapes plus efficaces.  Si vous participez √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DockerCon2018</a> et souhaitez en savoir plus sur les builds multi-√©tapes, Dockerfiles, BuildKit ou tout autre sujet connexe, inscrivez-vous √† l'√©diteur de liens de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">piste Hallway</a> ou suivez les r√©unions internes de la plateforme Docker sur les pistes <a href="">Contribute et Collaborate</a> ou <a href="">Black Belt</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr433790/">https://habr.com/ru/post/fr433790/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr433776/index.html">Tutoriel du pilote MongoDB Go</a></li>
<li><a href="../fr433780/index.html">Transition du kit d'interface utilisateur au syst√®me de conception dans QIWI</a></li>
<li><a href="../fr433782/index.html">Un exemple pratique de cr√©ation de votre propre composant View</a></li>
<li><a href="../fr433786/index.html">Fintech Digest: la crypto-monnaie est la propri√©t√©, un nombre record de cartes de cr√©dit ont √©t√© √©mises en F√©d√©ration de Russie</a></li>
<li><a href="../fr433788/index.html">Offre s√©curis√©e et nouveaux avis ind√©pendants</a></li>
<li><a href="../fr433792/index.html">Scripts shell dans Ansible</a></li>
<li><a href="../fr433796/index.html">Comment Homo Sapiens a conquis le monde. Comp√©tences en communication et n√©gociation</a></li>
<li><a href="../fr433798/index.html">HomeKit et ioBroker Faisons des amis √† la maison</a></li>
<li><a href="../fr433800/index.html">Utilisation des contr√¥leurs UDB PSoC de Cypress pour r√©duire les interruptions dans une imprimante 3D</a></li>
<li><a href="../fr433802/index.html">Comment et pourquoi nous avons remport√© la piste Big Data au Urban Tech Challenge Hackathon</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>