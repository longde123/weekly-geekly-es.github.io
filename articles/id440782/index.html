<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💱 👇🏼 🍲 Saya akan lebih dalam di bawah tanah, atau apa yang harus Anda ketahui, mengoptimalkan aplikasi jaringan 👊🏿 🧔🏻 🧥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salam sahabat! 

 Dalam dua artikel sebelumnya ( satu , dua ), kami terjun ke kompleksitas pilihan antara teknologi dan mencari pengaturan optimal unt...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Saya akan lebih dalam di bawah tanah, atau apa yang harus Anda ketahui, mengoptimalkan aplikasi jaringan</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ostrovok/blog/440782/">  Salam sahabat! <br><br>  Dalam dua artikel sebelumnya ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">satu</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dua</a> ), kami terjun ke kompleksitas pilihan antara teknologi dan mencari pengaturan optimal untuk solusi kami di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Ostrovok.ru</a> .  Topik apa yang akan kita angkat hari ini? <br><br>  Setiap layanan harus bekerja pada beberapa server, berkomunikasi dengan perangkat keras melalui alat sistem operasi.  Ada banyak sekali alat-alat ini, serta pengaturan untuk mereka.  Dalam kebanyakan kasus, pengaturan default mereka akan lebih dari cukup.  Pada artikel ini, saya ingin berbicara tentang kasus-kasus ketika pengaturan standar masih tidak cukup, dan saya harus mengenal sistem operasi sedikit lebih dekat - dalam kasus kami dengan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Linux</a> . <br><br><img src="https://habrastorage.org/webt/0w/me/l7/0wmel7l-0ya2c0kwfpsmxerm5sq.jpeg"><br><a name="habracut"></a><br><h3>  Kami menggunakan kernel dengan bijak </h3><br>  Dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">artikel sebelumnya,</a> saya berbicara tentang opsi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">cpu-map</a> di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Haproxy</a> .  Dengan itu, kami mengikat proses Haproxy ke utas dari satu inti pada server prosesor ganda.  Kami memberikan inti kedua untuk penanganan interupsi kartu jaringan. <br><br>  Di bawah ini adalah layar di mana Anda dapat melihat pemisahan serupa.  Di sebelah kiri, kernel ditempati oleh Haproxy di <code>user space</code> , dan di sebelah kanan, dengan memproses interupsi dalam <code>kernel space</code> . <br><br><img src="https://habrastorage.org/webt/4g/lj/6v/4glj6vaeqz4yrna_dvlacxhp200.png"><br><br>  Binding interupsi ke kartu jaringan dilakukan secara otomatis menggunakan ini <div class="spoiler">  <b class="spoiler_title">Skrip bash:</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#! /bin/bash interface=${1} if [ -z "${interface}" ];then echo "no interface specified" echo "usage: ${0} eth1" exit 1 fi nproc=$(grep 'physical id' /proc/cpuinfo|sort -u|wc -l) ncpu=$(grep -c 'processor' /proc/cpuinfo) cpu_per_proc=$[ncpu / nproc] queue_threads=$[cpu_per_proc / 2] binary_map="" cpumap="" for(( i=0; i &lt; ncpu; i++ ));do cpumap=${cpumap}1 b+='{0..1}' done binary_map=($(eval echo ${b})) ###         ###    ,      . ethtool -L ${interface} combined ${queue_threads} || true count=${ncpu} while read irq queue;do let "cpu_num=$[count-1]" let "cpu_index=$[2**cpu_num]" printf "setting ${queue} to %d (%d)\n" $((2#${binary_map[${cpu_index}]})) ${cpu_num} printf "%x\n" "$((2#${binary_map[${cpu_index}]}))" &gt; /proc/irq/${irq}/smp_affinity [ ${interface} != ${queue} ] &amp;&amp; count=$[count-1] [ $[ncpu - count] -gt ${queue_threads} ] &amp;&amp; count=${ncpu} done &lt; &lt;(awk "/${interface}/ {if(NR &gt; 1){ sub(\":\", \"\", \$1); print \$1,\$(NF)} }" /proc/interrupts) exit 0</span></span></code> </pre><br></div></div><br>  Ada banyak skrip sederhana dan lebih kompleks yang cocok di Internet yang melakukan pekerjaan yang sama, tetapi skrip ini cukup untuk kebutuhan kita. <br><br>  Di Haproxy, kami menautkan proses ke kernel, dimulai dengan kernel pertama.  Script yang sama mengikat interupsi, dimulai dengan yang terakhir.  Dengan demikian, kita dapat membagi prosesor server menjadi dua kubu. <br><br>  Untuk wawasan yang lebih dalam tentang gangguan dan jaringan, saya sangat merekomendasikan membaca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">artikel</a> ini. <br><br><h3>  Kami mengungkapkan kemampuan perangkat jaringan </h3><br>  Kebetulan banyak frame dapat terbang melalui jaringan pada satu saat, dan antrian kartu mungkin tidak siap untuk masuknya tamu, bahkan jika ia memiliki kesempatan untuk melakukannya. <br><br>  Mari kita bicara tentang buffer kartu jaringan.  Paling sering, nilai default tidak menggunakan seluruh buffer yang tersedia.  Anda dapat melihat pengaturan saat ini menggunakan utilitas ethtool yang kuat. <br><br>  Contoh penggunaan perintah: <br><br><pre> <code class="bash hljs">&gt; ethtool -g eno1 Ring parameters <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> eno1: Pre-set maximums: RX: 4096 RX Mini: 0 RX Jumbo: 0 TX: 4096 Current hardware settings: RX: 256 RX Mini: 0 RX Jumbo: 0 TX: 256</code> </pre><br>  Sekarang mari kita ambil semuanya dari kehidupan: <br><br><pre> <code class="bash hljs">&gt; ethtool -G eno1 rx 4096 tx 4096 &gt; ethtool -g eno1 Ring parameters <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> eno1: Pre-set maximums: RX: 4096 RX Mini: 0 RX Jumbo: 0 TX: 4096 Current hardware settings: RX: 4096 RX Mini: 0 RX Jumbo: 0 TX: 4096</code> </pre><br>  Sekarang Anda dapat yakin bahwa kartu tidak tertahan dan berfungsi maksimal dari kemampuannya. <br><br><h3>  Pengaturan sysctl minimum untuk manfaat maksimal </h3><br>  Sysctl memiliki beragam pilihan dalam semua warna dan ukuran yang dapat Anda bayangkan.  Dan, sebagai suatu peraturan, artikel-artikel di Internet, yang membahas masalah optimisasi, mencakup bagian yang agak mengesankan dari parameter-parameter ini.  Saya akan mempertimbangkan hanya mereka yang benar-benar berguna untuk berubah dalam kasus kami. <br><br>  <b>net.core.netdev_max_backlog</b> - antrian di mana frame dari kartu jaringan dapatkan, yang kemudian diproses oleh kernel.  Dengan antarmuka cepat dan sejumlah besar lalu lintas, ia dapat terisi dengan cepat.  <i>Default</i> : 1000. <br>  Kita dapat mengamati kelebihan antrian ini dengan melihat kolom kedua di file / proc / net / softnet_stat. <br><pre> <code class="bash hljs">awk <span class="hljs-string"><span class="hljs-string">'{print $2}'</span></span> /proc/net/softnet_stat</code> </pre> <br>  File itu sendiri menjelaskan struktur <a href="">netif_rx_stats</a> per baris untuk setiap CPU dalam sistem. <br>  Secara khusus, kolom kedua menjelaskan jumlah paket dalam status yang dijatuhkan.  Jika nilai di kolom kedua tumbuh seiring waktu, maka mungkin layak meningkatkan nilai <code>net.core.netdev_max_backlog</code> atau menempatkan CPU lebih cepat. <br><br>  <b>net.core.rmem_default</b> / <b>net.core.rmem_max</b> &amp;&amp; <b>net.core.wmem_default</b> / <b>net.core.wmem_max</b> - parameter ini menunjukkan nilai default / nilai maksimum untuk buffer baca dan tulis soket.  <i>Nilai default</i> dapat diubah pada level aplikasi pada saat soket dibuat (omong-omong, Haproxy memiliki <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">parameter</a> yang melakukan ini).  Kami memiliki kasus ketika kernel melempar lebih banyak paket daripada yang berhasil Haproxy rake, dan kemudian masalah dimulai.  Karena itu, masalahnya penting. <br><br>  <b>net.ipv4.tcp_max_syn_backlog</b> - bertanggung jawab atas batas koneksi baru yang belum dibuat untuk paket <code>SYN</code> yang diterima.  Jika ada aliran besar koneksi baru (misalnya, banyak permintaan HTTP dari <code>Connection: close</code> ), masuk akal untuk meningkatkan nilai ini agar tidak membuang waktu mengirim paket yang diteruskan. <br><br>  <b>net.core.somaxconn</b> - di sini kita berbicara tentang koneksi yang dibuat, tetapi belum diproses oleh aplikasi.  Jika server single-threaded, dan dua permintaan datang ke sana, maka permintaan pertama akan diproses oleh fungsi <code>accept()</code> , dan yang kedua akan menggantung di <code>backlog</code> , yang ukurannya bertanggung jawab atas parameter ini. <br><br>  <b>nf_conntrack_max</b> mungkin yang paling terkenal dari semua parameter.  Saya pikir hampir semua orang yang berurusan dengan iptables tahu tentang itu.  Idealnya, tentu saja, jika Anda tidak perlu menggunakan iptables yang menyamar, maka Anda dapat membongkar modul conntrack dan tidak memikirkannya.  Dalam kasus saya, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Docker</a> digunakan, jadi Anda tidak akan mengunggah sesuatu yang istimewa. <br><br><h3>  Pemantauan  Jelas dan tidak terlalu </h3><br>  Agar tidak secara membabi buta mencari mengapa "proksi Anda melambat," akan berguna untuk membuat beberapa grafik dan menatanya dengan pemicu. <br><br>  <b>nf_conntrack_count</b> adalah metrik yang paling jelas.  Di atasnya, Anda dapat memantau berapa banyak koneksi yang sekarang ada di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tabel conntrack</a> .  Ketika tabel meluap, jalur untuk koneksi baru akan ditutup. <br><br>  Nilai saat ini dapat ditemukan di sini: <br><br><pre> <code class="bash hljs">cat /proc/sys/net/netfilter/nf_conntrack_count</code> </pre> <br><img src="https://habrastorage.org/webt/qp/eg/1l/qpeg1lpltda2b1cos5bzwijprfq.png"><br><br>  <b>Segmen Tcp mentransmisikan kembali</b> - jumlah transfer segmen.  Metriknya sangat tebal, karena dapat berbicara tentang masalah di tingkat yang berbeda.  Peningkatan transfer dapat mengindikasikan masalah jaringan, kebutuhan untuk mengoptimalkan pengaturan sistem, atau bahkan bahwa perangkat lunak akhir (misalnya, Haproxy) tidak melakukan tugasnya.  Bagaimanapun, pertumbuhan abnormal dari nilai ini dapat berfungsi sebagai alasan untuk proses. <br><br><img src="https://habrastorage.org/webt/st/-m/vp/st-mvpahwxgcdord_zzvaml2dru.png"><br><br>  Di negara kami, peningkatan nilai paling sering menunjukkan masalah dengan salah satu pemasok, meskipun ada masalah dengan kinerja server dan jaringan. <br><br>  Contoh untuk verifikasi: <br><br><pre> <code class="bash hljs">netstat -s|grep <span class="hljs-string"><span class="hljs-string">'segments retransmited'</span></span></code> </pre> <br>  <b>Socket Recv-Q</b> - ingat, kita berbicara tentang saat-saat ketika sebuah aplikasi mungkin tidak memiliki cukup waktu untuk memproses permintaan, dan kemudian <code>socket backlog</code> akan bertambah?  Pertumbuhan indikator ini memperjelas bahwa ada sesuatu yang salah dengan aplikasi tersebut dan tidak dapat mengatasinya. <br><br>  Saya melihat pegunungan dalam grafik dengan metrik ini, ketika parameter maxconn di Haproxy memiliki nilai default (2000), dan itu sama sekali tidak menerima koneksi baru. <br><br>  Dan lagi sebuah contoh: <br><br><pre> <code class="bash hljs">ss -lntp|awk <span class="hljs-string"><span class="hljs-string">'/LISTEN/ {print $2}'</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/9l/ni/be/9lnibeyuhs2qb0ta8w7rr2k9shs.png"><br><br>  Tidak akan berlebihan untuk memiliki grafik dengan gangguan menurut status koneksi TCP: <br><br><img src="https://habrastorage.org/webt/uo/1i/aa/uo1iaapuogduuk-9bk5elmahaus.png"><br><br>  Dan secara terpisah membuat <code>time-wait/established</code> , karena  nilai-nilai mereka, sebagai suatu peraturan, sangat berbeda dari yang lain: <br><br><img src="https://habrastorage.org/webt/np/v8/g-/npv8g-clm27mdnj4bhzlol7kshm.png"><br><br>  Selain metrik ini, ada banyak lainnya, tetapi lebih jelas - misalnya, beban pada antarmuka jaringan atau CPU.  Pilihan mereka akan lebih bergantung pada spesifikasi beban kerja Anda. <br><br><h3>  Alih-alih sebuah kesimpulan </h3><br>  Secara umum, itu saja - saya mencoba menggambarkan poin-poin kunci yang harus saya hadapi ketika menyiapkan proxy reverse http.  Tampaknya tugas itu tidak sulit, tetapi dengan peningkatan beban, jumlah jebakan yang selalu muncul pada waktu yang salah juga meningkat.  Saya harap artikel ini membantu Anda menghindari kesulitan yang harus saya hadapi. <br><br>  Semua Damai </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id440782/">https://habr.com/ru/post/id440782/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id440772/index.html">Desain berbasis domain: resep untuk seorang pragmatis</a></li>
<li><a href="../id440774/index.html">Kesalahan matematika NHTSA yang serius memungkinkan Tesla mengklaim keselamatan autopilot</a></li>
<li><a href="../id440776/index.html">Email, tampilan dalam</a></li>
<li><a href="../id440778/index.html">Pertemuan OpenStack kedua di Mail.ru Group: 22 Februari</a></li>
<li><a href="../id440780/index.html">Google tidak akan memblokir pemblokir iklan pihak ketiga di browser Chromium</a></li>
<li><a href="../id440784/index.html">Saat pergi, matikan lampu dan matikan air</a></li>
<li><a href="../id440786/index.html">Tampilan baru dalam mempelajari dan mendokumentasikan kode sumber</a></li>
<li><a href="../id440788/index.html">Menggunakan mesin Spring state dalam contoh praktis</a></li>
<li><a href="../id440790/index.html">Hi-Fi - masalah klasifikasi: tentang sejarah, standar, pemasaran, dan terminologi</a></li>
<li><a href="../id440792/index.html">Efek penyaringan SVG. Bagian 5. Mencocokkan teks dengan tekstur permukaan dengan feDisplacementMap</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>