<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äçüöí üë©üèº‚Äçüéì ü§∞üèº Salir de las redes de Tarantool. Sincronizaci√≥n de nodos al filtrar tr√°fico üßõüèø üèà üèáüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Variti se especializa en protecci√≥n contra bots y ataques DDoS, y tambi√©n realiza pruebas de estr√©s y carga. Dado que trabajamos como un servicio inte...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Salir de las redes de Tarantool. Sincronizaci√≥n de nodos al filtrar tr√°fico</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/variti/blog/459264/"><img src="https://habrastorage.org/getpro/habr/post_images/479/4d3/c95/4794d3c95e7b9d2fe9155a3083f674eb.jpg" alt="imagen"><br><br>  <i>Variti se especializa en protecci√≥n contra bots y ataques DDoS, y tambi√©n realiza pruebas de estr√©s y carga.</i>  <i>Dado que trabajamos como un servicio internacional, es extremadamente importante para nosotros asegurar el intercambio ininterrumpido de informaci√≥n entre servidores y cl√∫steres en tiempo real.</i>  <i>En la conferencia Saint HighLoad ++ 2019, el desarrollador de Variti, Anton Barabanov, dijo c√≥mo usamos UDP y Tarantool, por qu√© tomamos tanto y c√≥mo tuvimos que reescribir el m√≥dulo Tarantool de Lua a C.</i> <br><br>  Tambi√©n puede leer el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">resumen del</a> informe a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">trav√©s del</a> enlace y ver el video a continuaci√≥n debajo del spoiler. <br><br><div class="spoiler">  <b class="spoiler_title">Informar video</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/R0-POaXC0lI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br></div></div><br>  Cuando comenzamos a hacer un servicio de filtrado de tr√°fico, inmediatamente decidimos no tratar con el tr√°nsito IP, sino proteger los servicios HTTP, API y de juegos.  Por lo tanto, terminamos el tr√°fico en el nivel L7 en el protocolo TCP y lo transmitimos.  La protecci√≥n en L3 y 4 al mismo tiempo se produce autom√°ticamente.  El siguiente diagrama muestra el diagrama de servicio: las solicitudes de las personas pasan por un cl√∫ster, es decir, los servidores y equipos de red, y los robots (que se muestran como fantasmas) se filtran. <br><br><img src="https://habrastorage.org/webt/g0/eg/qd/g0egqdye_eghswvgjsdpkek9cda.jpeg"><br><br>  Para el filtrado, es necesario dividir el tr√°fico en solicitudes separadas, analizar las sesiones de manera precisa y r√°pida, y dado que no bloqueamos por direcciones IP, definimos bots y personas dentro de la conexi√≥n desde la misma direcci√≥n IP. <a name="habracut"></a><br><br><h4>  ¬øQu√© sucede dentro del cl√∫ster? </h4><br>  Dentro del cl√∫ster, tenemos nodos de filtro independientes, es decir, cada nodo funciona solo y solo con su propio tr√°fico.  El tr√°fico se distribuye aleatoriamente entre los nodos: si, por ejemplo, se reciben 10 conexiones de un usuario, todas ellas divergen en diferentes servidores. <br><br>  Tenemos requisitos de rendimiento muy estrictos ya que nuestros clientes se encuentran en diferentes pa√≠ses.  Y si, por ejemplo, un usuario de Suiza visita un sitio franc√©s, entonces ya se enfrenta a 15 milisegundos de retraso de la red debido a un aumento en la ruta del tr√°fico.  Por lo tanto, no tenemos derecho a agregar otros 15-20 milisegundos dentro de nuestro centro de procesamiento; la solicitud continuar√° durante mucho tiempo.  Adem√°s, si procesamos cada solicitud HTTP durante 15-20 milisegundos, entonces un simple ataque de 20 mil RPS sumar√° todo el cl√∫ster.  Esto, por supuesto, es inaceptable. <br><br>  Otro requisito para nosotros no era solo rastrear la solicitud, sino tambi√©n comprender el contexto.  Supongamos que un usuario abre una p√°gina web y env√≠a una solicitud de barra diagonal.  Despu√©s de eso, la p√°gina se carga, y si es HTTP / 1.1, entonces el navegador abre 10 conexiones al backend y en 10 flujos est√°ticos y din√°micos de solicitudes, realiza solicitudes ajax y subconsultas.  Si, en lugar de enviar una subconsulta, en el proceso de enviar la p√°gina, comienza a interactuar con el navegador e intenta darle, por ejemplo, JS Challenge para la subconsulta, lo m√°s probable es que rompa la p√°gina.  En la primera solicitud, puede dar CAPTCHA (aunque esto es malo) o desaf√≠os JS, hacer una redirecci√≥n, y luego cualquier navegador procesar√° todo correctamente.  Despu√©s de la prueba, es necesario difundir informaci√≥n en todos los cl√∫steres de que la sesi√≥n es leg√≠tima.  Si no hay intercambio de informaci√≥n entre los cl√∫steres, los otros nodos recibir√°n la sesi√≥n desde el medio y no sabr√°n si omitirla o no. <br><br>  Tambi√©n es importante responder r√°pidamente a todas las sobrecargas de carga y cambios en el tr√°fico.  Si algo salt√≥ en un nodo, entonces, despu√©s de 50-100 milisegundos, se producir√° un salto en todos los dem√°s nodos.  Por lo tanto, es mejor si los nodos conocen los cambios de antemano y establecen los par√°metros de protecci√≥n por adelantado para que no se produzca ning√∫n salto en todos los dem√°s nodos. <br>  Un servicio adicional para protegerse contra los bots fue el servicio posterior al marcado: colocamos un p√≠xel en el sitio, escribimos informaci√≥n de bot / persona y enviamos estos datos a trav√©s de API.  Estos veredictos deben mantenerse en alg√∫n lugar.  Es decir, si antes habl√°bamos de la sincronizaci√≥n dentro de un cl√∫ster, ahora tambi√©n estamos agregando sincronizaci√≥n de informaci√≥n entre cl√∫steres.  A continuaci√≥n mostramos el esquema del servicio en el nivel L7. <br><br><img src="https://habrastorage.org/webt/_t/lj/ah/_tljahe28yfpufxw6suxf9ay14y.jpeg"><br><br><h4>  Entre racimos </h4><br>  Despu√©s de hacer el cl√∫ster, comenzamos a escalar.  Trabajamos a trav√©s de BGP anycast, es decir, nuestras subredes se anuncian desde todos los cl√∫steres y el tr√°fico llega al m√°s cercano.  En pocas palabras, se env√≠a una solicitud desde Francia a un grupo en Frankfurt y desde San Petersburgo a un grupo en Mosc√∫.  Los grupos deber√≠an ser independientes.  Los flujos de red son permitidos independientemente. <br><br>  ¬øPor qu√© es esto importante?  Supongamos que una persona conduce un autom√≥vil, trabaja con un sitio web desde Internet m√≥vil y cruza un cierto Rubicon, despu√©s de lo cual el tr√°fico cambia repentinamente a otro grupo.  U otro caso: la ruta de tr√°fico se reconstruy√≥ porque en alg√∫n lugar se quem√≥ el conmutador o enrutador, algo se cay√≥ y el segmento de red se desconect√≥.  En este caso, proporcionamos al navegador (por ejemplo, en cookies) informaci√≥n suficiente para que al cambiar a otro cl√∫ster sea posible informar los par√°metros necesarios sobre las pruebas aprobadas o reprobadas. <br>  Adem√°s, debe sincronizar el modo de protecci√≥n entre cl√∫steres.  Esto es importante en el caso de ataques de bajo volumen, que a menudo se llevan a cabo bajo la cobertura de inundaciones.  Dado que los ataques se ejecutan en paralelo, las personas piensan que su sitio est√° rompiendo la inundaci√≥n y no ven un ataque de bajo volumen.  Para el caso en que un volumen bajo llega a un cl√∫ster y se inunda a otro, es necesaria la sincronizaci√≥n del modo de protecci√≥n. <br><br>  Y como ya se mencion√≥, sincronizamos entre los cl√∫steres los veredictos que se acumulan y son dados por API.  En este caso, puede haber muchos veredictos y deben sincronizarse de manera confiable.  En el modo de protecci√≥n, puede perder algo dentro del cl√∫ster, pero no entre los cl√∫steres. <br><br>  Vale la pena se√±alar que hay una gran latencia entre los grupos: en el caso de Mosc√∫ y Frankfurt, esto es 20 milisegundos.  Las solicitudes s√≠ncronas no se pueden realizar aqu√≠; toda la interacci√≥n debe ir en modo as√≠ncrono. <br><br>  A continuaci√≥n mostramos la interacci√≥n entre los grupos.  M, l, p son algunos par√°metros t√©cnicos para un intercambio.  U1, u2 es el marcado del usuario como ileg√≠timo y leg√≠timo. <br><br><img src="https://habrastorage.org/webt/a1/xl/si/a1xlsi20avhzuiv_s1uljdmubic.jpeg"><br><br><h4>  Interacci√≥n interna entre nodos </h4><br>  Inicialmente, cuando realizamos el servicio, el filtrado en el nivel L7 se inici√≥ en un solo nodo.  Esto funcion√≥ bien para dos clientes, pero no m√°s.  Al escalar, quer√≠amos lograr la m√°xima capacidad de respuesta y la latencia m√≠nima. <br><br>  Era importante minimizar los recursos de CPU gastados en el procesamiento de paquetes, por lo que la interacci√≥n a trav√©s de, por ejemplo, HTTP no ser√≠a adecuada.  Tambi√©n era necesario garantizar un consumo m√≠nimo de gastos generales no solo de los recursos inform√°ticos, sino tambi√©n de la velocidad de los paquetes.  Sin embargo, estamos hablando de ataques de filtrado, y estas son situaciones en las que obviamente no hay suficiente rendimiento.  Por lo general, al construir un proyecto web, x3 o x4 es suficiente para la carga, pero siempre tenemos x1, ya que siempre puede venir un ataque a gran escala. <br><br>  Otro requisito para la interfaz de interacci√≥n es la presencia de un lugar donde escribiremos informaci√≥n y desde donde podamos calcular en qu√© estado nos encontramos ahora.  No es ning√∫n secreto que C ++ se usa a menudo para desarrollar sistemas de filtrado.  Pero desafortunadamente, los programas escritos en C ++ a veces fallan.  A veces, dichos programas deben reiniciarse para actualizarse o, por ejemplo, porque la configuraci√≥n no se volvi√≥ a leer.  Y si reiniciamos el nodo bajo ataque, entonces debemos llevar a alg√∫n lado el contexto en el que exist√≠a este nodo.  Es decir, el servicio no debe ser ap√°trida, debe recordar que hay un cierto n√∫mero de personas a las que bloqueamos, a quienes verificamos.  Debe haber la misma comunicaci√≥n interna para que el servicio pueda recibir un conjunto primario de informaci√≥n.  Pensamos poner cerca de una determinada base de datos, por ejemplo, SQLite, pero r√°pidamente descartamos esa soluci√≥n, porque es extra√±o escribir Entrada-Salida en cada servidor, esto funcionar√° mal en la memoria. <br><br>  De hecho, trabajamos con solo tres operaciones.  La primera funci√≥n es "enviar" a todos los nodos.  Esto se aplica, por ejemplo, a los mensajes sobre la sincronizaci√≥n de la carga actual: cada nodo debe conocer la carga total en el recurso dentro del cl√∫ster para rastrear los picos.  La segunda operaci√≥n es "guardar", se trata de veredictos de verificaci√≥n.  Y la tercera operaci√≥n es una combinaci√≥n de "enviar a todos" y "guardar".  Aqu√≠ estamos hablando de mensajes de cambio de estado que enviamos a todos los nodos y luego guardamos para poder restar.  A continuaci√≥n se muestra el esquema de interacci√≥n resultante, en el que necesitaremos agregar par√°metros para guardar. <br><br><img src="https://habrastorage.org/webt/s7/__/8c/s7__8c-cnmitihkranlrso0ukza.jpeg"><br><br><h4>  Opciones y resultados </h4><br>  ¬øQu√© opciones para preservar los veredictos hemos analizado?  En primer lugar, est√°bamos pensando en los cl√°sicos, RabbitMQ, RedisMQ y nuestro propio servicio basado en TCP.  Rechazamos estas decisiones porque funcionan lentamente.  El mismo TCP agrega x2 a la tasa de paquetes.  Adem√°s, si enviamos un mensaje de un nodo a todos los dem√°s, entonces necesitamos tener muchos nodos de env√≠o, o este nodo puede envenenar 1/16 de esos mensajes que 16 m√°quinas pueden enviarle.  Est√° claro que esto es inaceptable. <br><br>  Como resultado, tomamos la multidifusi√≥n UDP, porque en este caso el centro de env√≠o es un equipo de red, que no est√° limitado en rendimiento y le permite resolver completamente los problemas con la velocidad de env√≠o y recepci√≥n.  Est√° claro que en el caso de UDP, no pensamos en formatos de texto, sino que enviamos datos binarios. <br><br>  Adem√°s, agregamos inmediatamente el empaque y una base de datos.  Tomamos Tarantool, porque, en primer lugar, los tres fundadores de la compa√±√≠a ten√≠an experiencia trabajando con esta base de datos, y en segundo lugar, es lo m√°s flexible posible, es decir, tambi√©n es alg√∫n tipo de servicio de aplicaciones.  Adem√°s, Tarantool tiene CAPI, y la capacidad de escribir en C es una cuesti√≥n de principios para nosotros porque se requiere la m√°xima protecci√≥n para proteger contra DDoS.  Ning√∫n lenguaje interpretado puede proporcionar un rendimiento suficiente, a diferencia de C. <br><br>  En el diagrama a continuaci√≥n, agregamos una base de datos dentro del cl√∫ster, en la que se almacenan los estados para la comunicaci√≥n interna. <br><br><img src="https://habrastorage.org/webt/k3/py/60/k3py60c1-_z4uirabzit7-otlri.jpeg"><br><br><h4>  Agregar base de datos </h4><br>  En la base de datos, almacenamos el estado en forma de un registro de llamadas.  Cuando se nos ocurri√≥ c√≥mo guardar informaci√≥n, hab√≠a dos opciones.  Fue posible almacenar alg√∫n estado con actualizaciones y cambios constantes, pero es bastante dif√≠cil de implementar.  Por lo tanto, usamos un enfoque diferente. <br><br>  El hecho es que la estructura de los datos enviados a trav√©s de UDP est√° unificada: hay sincronizaci√≥n, alg√∫n tipo de c√≥digo, tres o cuatro campos de datos.  Entonces comenzamos a escribir esta estructura en el espacio Tarantool y agregamos un registro TTL all√≠, lo que deja en claro que la estructura est√° desactualizada y necesita ser eliminada.  Por lo tanto, se acumula un registro de mensajes en Tarantool, que borramos con el tiempo especificado.  Para eliminar datos antiguos, inicialmente expiramos.  Posteriormente, tuvimos que abandonarlo, porque caus√≥ ciertos problemas, que discutiremos a continuaci√≥n.  Hasta ahora, el esquema: en √©l se agregaron dos bases de datos a nuestra estructura. <br><br><img src="https://habrastorage.org/webt/p-/li/-m/p-li-mkvdsa7ks9bxqz00ywlrey.jpeg"><br><br>  Como ya mencionamos, adem√°s de almacenar estados de cl√∫ster, tambi√©n es necesario sincronizar los veredictos.  Veredictos sincronizamos intercluster.  En consecuencia, fue necesario agregar una instalaci√≥n adicional de Tarantool.  Ser√≠a extra√±o usar otra soluci√≥n, porque Tarantool ya est√° all√≠ y es ideal para nuestro servicio.  En la nueva instalaci√≥n, comenzamos a escribir veredictos y a replicarlos con otros cl√∫steres.  En este caso, no utilizamos maestro / esclavo, sino maestro / maestro.  Ahora en Tarantool solo hay un maestro / maestro as√≠ncrono, que para muchos casos no es adecuado, pero para nosotros este modelo es √≥ptimo.  Con una latencia m√≠nima entre los cl√∫steres, la replicaci√≥n sincr√≥nica estar√≠a en el camino, mientras que la replicaci√≥n asincr√≥nica no causa problemas. <br><br><h4>  Los problemas </h4><br>  Pero tuvimos muchos problemas.  <i>El primer bloque de complejidad est√° relacionado con UDP</i> : no es ning√∫n secreto que el protocolo puede vencer y perder paquetes.  Resolvimos estos problemas por el m√©todo del avestruz, es decir, simplemente escondimos nuestras cabezas en la arena.  Sin embargo, el da√±o de los paquetes y la reorganizaci√≥n de sus lugares es imposible con nosotros, ya que la comunicaci√≥n se lleva a cabo dentro del marco de un solo conmutador, y no hay conexiones inestables ni equipos de red inestables. <br><br>  Puede haber un problema de p√©rdida de paquetes si una m√°quina se congela, se produce una entrada-salida en alg√∫n lugar o se sobrecarga un nodo.  Si tal bloqueo se produjo por un corto per√≠odo de tiempo, digamos, 50 milisegundos, entonces esto es terrible, pero se resuelve mediante el aumento de las colas sysctl.  Es decir, tomamos sysctl, configuramos el tama√±o de las colas y obtenemos un b√∫fer en el que todo se encuentra hasta que el nodo comienza a funcionar nuevamente.  Si se produce una congelaci√≥n m√°s prolongada, el problema no ser√° la p√©rdida de conectividad, sino parte del tr√°fico que va al nodo.  Hasta ahora, simplemente no hemos tenido tales casos. <br><br>  <i>Los problemas de replicaci√≥n asincr√≥nica de Tarantool</i> fueron mucho m√°s complejos.  Inicialmente, no tomamos maestro / maestro, sino un modelo m√°s tradicional para operar maestro / esclavo.  Y todo funcion√≥ exactamente hasta que el esclavo se hizo cargo de la carga maestra durante mucho tiempo.  Como resultado, los datos caducados y eliminados en el maestro, pero en el esclavo, no fue as√≠.  En consecuencia, cuando cambiamos varias veces de maestro a esclavo y viceversa, se acumularon tantos datos en el esclavo que en alg√∫n momento todo se rompi√≥.  Entonces, para una tolerancia total a fallas, tuve que cambiar a replicaci√≥n maestro / maestro as√≠ncrono. <br><br>  Y aqu√≠ nuevamente surgieron dificultades.  En primer lugar, las claves pueden cruzarse entre diferentes r√©plicas.  Supongamos que, dentro del cl√∫ster, escribimos datos en un maestro, en este punto la conexi√≥n se rompi√≥, escribimos todo al segundo maestro, y despu√©s de realizar la replicaci√≥n asincr√≥nica, result√≥ que la misma clave primaria en el espacio y la replicaci√≥n se desmoronaron. <br><br>  Resolvimos este problema simplemente: tomamos un modelo en el que la clave primaria necesariamente contiene el nombre del nodo Tarantool en el que estamos escribiendo.  Debido a esto, los conflictos dejaron de surgir, pero una situaci√≥n se hizo posible cuando se duplicaron los datos del usuario.  Este es un caso extremadamente raro, por lo que nuevamente simplemente lo descuidamos.  Si la duplicaci√≥n ocurre con frecuencia, Tarantool tiene muchos √≠ndices diferentes, por lo que siempre puede hacer deduplicaci√≥n. <br><br>  Otro problema se refiere a la preservaci√≥n de veredictos y surge cuando los datos registrados en un maestro a√∫n no han aparecido en otro, y una solicitud ya ha llegado al primer maestro.  Para ser sincero, a√∫n no hemos resuelto este problema y simplemente estamos retrasando el veredicto.  Si esto es inaceptable, organizaremos una especie de impulso sobre la disponibilidad de datos.  As√≠ es como lidiamos con la replicaci√≥n maestro / maestro y sus problemas. <br><br>  <i>Hubo un bloque de problemas relacionados directamente con Tarantool</i> , sus controladores y el m√≥dulo caducado.  Alg√∫n tiempo despu√©s del lanzamiento, los ataques comenzaron a llegar a nosotros todos los d√≠as, respectivamente, el n√∫mero de mensajes que guardamos en la base de datos para sincronizaci√≥n y almacenamiento de contexto se ha vuelto muy grande.  Y durante la eliminaci√≥n, se comenzaron a eliminar tantos datos que el recolector de basura dej√≥ de hacer frente.  Resolvimos este problema escribiendo en C nuestro propio m√≥dulo caducado llamado IExpire. <br><br>  Sin embargo, con la fecha de vencimiento hay una dificultad m√°s con la que a√∫n no nos hemos manejado y que radica en el hecho de que la fecha de vencimiento solo funciona en un maestro.  Y si el nodo caducado cae, el cl√∫ster perder√° la funcionalidad cr√≠tica.  Supongamos que limpiamos todos los datos anteriores a una hora: est√° claro que si un nodo miente, por ejemplo, cinco horas, la cantidad de datos ser√° x5 a la habitual.  Y si en ese momento llega un gran ataque, es decir, dos casos graves coinciden, entonces el grupo caer√°.  Todav√≠a no sabemos c√≥mo lidiar con esto. <br><br>  Finalmente, segu√≠a habiendo dificultades con el conductor de Tarantool para C. Cuando interrumpimos el servicio (por ejemplo, debido a la condici√≥n de la carrera), nos llev√≥ mucho tiempo encontrar el motivo y la depuraci√≥n.  Por lo tanto, acabamos de escribir nuestro controlador Tarantool.  Nos llev√≥ cinco d√≠as implementar el protocolo junto con las pruebas, la depuraci√≥n y el lanzamiento en producci√≥n, pero ya ten√≠amos nuestro propio c√≥digo para trabajar con la red. <br><br><h4>  Problemas afuera </h4><br>  Recuerde que ya tenemos preparada la replicaci√≥n de Tarantool, ya sabemos c√≥mo sincronizar los veredictos, pero no existe una infraestructura para transferir mensajes sobre ataques o problemas entre grupos. <br>  Ten√≠amos muchas ideas diferentes sobre la infraestructura, incluida la idea de escribir nuestro propio servicio TCP.  Pero todav√≠a hay un m√≥dulo de Cola de Tarantool del equipo de Tarantool.  Adem√°s, ya ten√≠amos Tarantool con replicaci√≥n de cl√∫ster cruzado, los "agujeros" estaban retorcidos, es decir, no hab√≠a necesidad de ir a los administradores y pedir abrir puertos o conducir tr√°fico.  Nuevamente, la integraci√≥n en la filtraci√≥n de software estaba lista. <br><br>  Hubo una dificultad con el nodo host.  Suponga que hay n nodos independientes dentro de un cl√∫ster y necesita elegir el que interactuar√° con la cola de escritura.  Porque de lo contrario se enviar√°n 16 mensajes o se restar√° 16 veces el mismo mensaje de la cola.  Resolvimos este problema simplemente: registramos un nodo responsable en el espacio Tarantool, y si el nodo se quema, simplemente cambiamos el espacio si no lo olvidamos.  Pero si lo olvidamos, entonces este es un problema que tambi√©n queremos resolver en el futuro. <br><br>  A continuaci√≥n se muestra un diagrama ya detallado de un cl√∫ster con una interfaz de interacci√≥n. <br><br><img src="https://habrastorage.org/webt/8f/f3/9o/8ff39og9opl3e4rjwydmtpdsola.jpeg"><br><br><h4>  Lo que quiero mejorar y agregar </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En primer lugar, queremos publicar en c√≥digo abierto IExpire. Nos parece que este es un m√≥dulo √∫til, ya que le permite hacer todo lo mismo que caducado, pero con casi cero gastos generales. All√≠ debe agregar un √≠ndice de clasificaci√≥n para eliminar solo la tupla m√°s antigua. Hasta ahora, no hemos hecho esto, ya que la operaci√≥n principal en Tarantool para nosotros es "escribir", y un √≠ndice adicional implicar√° una carga adicional debido a su soporte. Tambi√©n queremos reescribir la mayor√≠a de los m√©todos en CAPI para evitar doblar la base de datos.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La pregunta permanece con la elecci√≥n de un maestro l√≥gico, pero parece que este problema es completamente imposible de resolver. </font><font style="vertical-align: inherit;">Es decir, si el nodo con caducidad cae, solo queda seleccionar manualmente otro nodo y ejecutarlo caducado. </font><font style="vertical-align: inherit;">Es poco probable que esto suceda autom√°ticamente, porque la replicaci√≥n es as√≠ncrona. </font><font style="vertical-align: inherit;">Aunque probablemente consultaremos sobre esto con el equipo de Tarantool.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En caso de un crecimiento exponencial de grupos, tambi√©n tendremos que pedir ayuda al equipo de Tarantool. </font><font style="vertical-align: inherit;">El hecho es que la replicaci√≥n de todos a todos se usa para Tarantool Queue y el guardado de veredictos entre grupos. </font><font style="vertical-align: inherit;">Esto funciona bien, mientras que hay tres grupos, por ejemplo, pero cuando hay 100 de ellos, la cantidad de conexiones que deben monitorearse ser√° incre√≠blemente grande y algo se romper√° constantemente. </font><font style="vertical-align: inherit;">En segundo lugar, no es un hecho que Tarantool pueda soportar tal carga.</font></font><br><br><h4>  Conclusiones </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Las primeras conclusiones se refieren a UDP multicast y Tarantool. La multidifusi√≥n no necesita tenerle miedo; su uso dentro del cl√∫ster es bueno, correcto y r√°pido. Hay muchos casos cuando hay una sincronizaci√≥n constante de estados, y despu√©s de 50 milisegundos, no importa lo que sucedi√≥ antes. Y en este caso, lo m√°s probable es que la p√©rdida de un estado no sea un problema. Por lo tanto, el uso de la multidifusi√≥n UDP est√° justificado, ya que no limita el rendimiento y obtiene la tasa de paquetes √≥ptima. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El segundo punto es Tarantool. Si tiene un servicio en marcha, php, etc., lo m√°s probable es que Tarantool sea aplicable tal como est√°. Pero si tiene cargas pesadas, necesitar√° un archivo. Pero para ser sincero, en este caso, el archivo es necesario para todo: tanto para Oracle como para PostgeSQL.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por supuesto, existe la opini√≥n de que no necesita reinventar la rueda, y si tiene un equipo peque√±o, entonces debe tomar una soluci√≥n preparada: Redis para sincronizaci√≥n, go est√°ndar, python, etc. </font><font style="vertical-align: inherit;">Esto no es verdad </font><font style="vertical-align: inherit;">Si est√° seguro de que necesita una nueva soluci√≥n, si trabaj√≥ con c√≥digo abierto, descubri√≥ que nada le conviene o sabe de antemano que ni siquiera tiene sentido intentarlo, entonces considerar su decisi√≥n es √∫til. </font><font style="vertical-align: inherit;">Otra conversaci√≥n que es importante parar a tiempo. </font><font style="vertical-align: inherit;">Es decir, no necesita escribir su Tarantool, no necesita implementar su mensaje, y si solo necesita un corredor, tome Redis ya y estar√° feliz.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/459264/">https://habr.com/ru/post/459264/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../459252/index.html">Semana de la seguridad 28: hackear una casa inteligente</a></li>
<li><a href="../459254/index.html">Bomba Zip a√∫n mejor</a></li>
<li><a href="../459256/index.html">C√≥mo optimizamos nuestro hospital tem√°tico para diferentes plataformas</a></li>
<li><a href="../459258/index.html">14,000 millas no enganchadas</a></li>
<li><a href="../459262/index.html">Retirado a los 22</a></li>
<li><a href="../459272/index.html">Escribir una API para componentes React, parte 1: no cree accesorios conflictivos</a></li>
<li><a href="../459274/index.html">Vulnerabilidad de bloqueo de pantalla en Astra Linux Special Edition (Smolensk)</a></li>
<li><a href="../459276/index.html">Epic fail resistance 2 o por qu√© no deber√≠as involucrarte en la privacidad con los complementos de FireFox</a></li>
<li><a href="../459280/index.html">¬øPor qu√© a los desarrolladores les encanta crear aplicaciones nativas?</a></li>
<li><a href="../459284/index.html">Breve introducci√≥n a la estrategia del producto y priorizaci√≥n de caracter√≠sticas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>