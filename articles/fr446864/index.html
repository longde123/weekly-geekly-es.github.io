<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ℹ️ 👨🏼‍⚕️ 📆 Énergie, chaleur et eau 💢 🧖🏽 🧑🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Préface 
 Année 2019. Dans presque tous les magasins d'électronique, vous pouvez acheter l'un des centaines d'ensembles possibles de maisons intellige...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Énergie, chaleur et eau</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/446864/"><h2>  Préface </h2><br>  <i>Année 2019.</i>  <i>Dans presque tous les magasins d'électronique, vous pouvez acheter l'un des centaines d'ensembles possibles de maisons intelligentes.</i>  <i>Prenez et configurez en "2 clics", connectez-vous aux nuages, recevez des événements push dans l'application / SMS, et en général recevez toutes les informations nécessaires partout dans le monde.</i> <br><br>  Idéal, mais dans mon cas, cela n'a pas fonctionné.  Quelques décisions qui sont tombées entre mes mains se sont avérées être un ensemble limité de certaines fonctions, ne couvrant qu'une partie de mes requêtes, et en plus, imposant des restrictions presque insurmontables.  Et, comme cela arrive généralement, moins il y a de restrictions, plus vous avez besoin de plonger dans le domaine, de réfléchir indépendamment aux solutions, aux architectures.  Par conséquent - la ferme collective nous-mêmes :) <br><br><h2>  Les tâches </h2><br>  1. recevoir des informations sur la qualité du réseau électrique (surtensions, arrêt complet, etc.). <br><br>  2. Ayez une surveillance complète de l'onduleur.  Mais en fait, avoir ce même UPS basé sur les conséquences de p2. <br><br>  3. Recevez les informations de température: <br><br><ol><li>  dans la rue </li><li>  à la maison </li><li>  dans le grenier (quand les ordures et les tomates jetées là gèlent) </li></ol><br>  4. Surveillez l’état de la consommation d’eau, alertez si la consommation a augmenté (soudainement une fuite, vous ne pouvez pas tout peser avec des capteurs d’humidité). <br><br>  5. Comprendre quand quelqu'un est à la maison pour automatiser la fermeture / ouverture de l'eau. <br><br>  6. Lecture du compteur de gaz et alerte lorsque la réserve payée s'épuise. <br>  + autres capteurs de toutes sortes (humidité, ouverture, pression de l'eau, pression dans le circuit de chauffage, etc.). <br><br>  L'objectif global est d'avoir une interface commune où vous pouvez regarder tout cela.  Recevez des notifications en cas de problème.  <s>Et pour qu'il n'y ait rien pour cela</s> et pour ne pas donner beaucoup d'argent pour cela. <br><br><h2>  La composition du complexe en ce moment </h2><br><ul><li>  Batterie UPS Energy PN-750 + 100 Ah </li><li>  Convertisseur USB-&gt; RS232 basé sur PL2303 </li><li>  Routeur Tp-link tl-wr1043nd + </li><li>  Maître de réseau à 1 fil basé sur un thermomètre USB acheté DS18B20 + PL-2303TA </li><li>  1 fil 3 capteurs DS18B20 </li><li>  Module de compteur d'eau Radioseti DS2423 à 1 fil </li></ul><br>  Une machine virtuelle avec un serveur Zabbix en dehors du réseau domestique. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/38f/096/8dc/38f0968dcb30102ff286561853581a96.png" alt="image"><br><br><a name="habracut"></a><br><h2>  Étape 1. Préparation de l'infrastructure </h2><br>  La première étape a été la question de la réorganisation physique: le routeur a été déplacé vers la table de nuit près de la mine d'évent, où UPS devait être installé plus loin.  L'antenne du fournisseur Internet Ubiquiti Nanostation Loco M2 PoE a été connectée à la même prise que le routeur, afin de continuer à être alimentée par UPS. <br><br>  J'avais déjà une installation dédiée de Zabbix sur un serveur distant et une certaine expérience avec cette application, il n'y avait donc aucun problème avec la théorie de l'organisation des alertes et le tableau de bord lui-même. <br><br>  Le routeur est flashé dans OpenWRT Chaos Calmer, un VPN est configuré sur le réseau où se trouvait le serveur Zabbix. <br><br>  J'ai immédiatement ajouté les métriques à zabbix, après avoir obtenu le modèle d'élément pour openwrt.  Ainsi, j'ai eu l'occasion de surveiller à la fois le système et, par exemple, combien et quelles adresses MAC sont connectées au point.  À l'avenir, ce qui aurait dû servir de décision sur l'arrêt de l'eau dans la maison. <br><br><h2>  Étape 2. Choisir un onduleur </h2><br>  Les critères de sélection étaient: <br><br><ul><li>  la possibilité d'une chaudière à gaz (buderus) </li><li>  à partir de 5 heures d'autonomie chaudière + équipement Internet </li><li>  présence d'une interface de surveillance </li><li>  faible bruit (placement - table de chevet dans la cuisine près de la bouche de ventilation) </li><li>  en raison de restrictions sur l'emplacement et le prix - de préférence une conception à batterie unique </li></ul><br>  Nous examinerons la possibilité de répondre aux critères dans l'ordre. <br><br>  <b>La capacité de la chaudière à gaz à fonctionner</b> s'explique par le fait que la chaudière nécessite un sinus propre, sinon le moteur de la pompe vibre et s'use.  À ce sujet, vous pouvez consulter de nombreux articles sur Google. <br>  L'ordinaire (ordinateur UPS) ne donne pas un tel sinus, ce qui donne une onde sinusoïdale approximative. <br>  Le deuxième facteur important est la présence de «à travers neutre».  Tout est un peu plus compliqué ici, mais c'est aussi facilement google, donc je ne m'arrêterai pas.  Je ne dirai qu'une chose - sans neutre traversant, le buderus n'a pas fonctionné, ou plutôt il est tombé dans l'erreur, car le capteur d'ionisation n'a pas fonctionné et la chaudière n'a tout simplement pas vu de flamme. <br><br>  En remplacement d'UPS, il y a eu un changement d'orientation vers les UPS en ligne et interactifs en ligne. <br>  <b>A partir de 5 heures d'autonomie de la chaudière + équipement Internet</b> donne principalement des UPS avec une batterie externe.  <b>En raison de l'emplacement et des restrictions de prix, une conception à batterie unique est souhaitable</b> .  La batterie de 100 Ah devait durer plus de 8 heures. <br><br>  <b>La présence d'une interface de surveillance</b> pour au moins savoir quand le système est passé à la batterie, afin de rentrer chez soi en hiver et de démarrer le générateur.  Je n'avais aucune exigence particulière ici (ainsi qu'une expérience de mise en œuvre).  Je cherchais tout ce qui vient avec une interface RS232 ou USB. <br><br>  L'exigence d'un <b>faible niveau de bruit</b> s'est en fait avérée être une limitation sérieuse et a mis au rebut toute une classe d'équipements - UPS en ligne, car ils fonctionnent tous en mode de ventilation constante du transformateur (le ventilateur ne s'arrête pas). <br><br>  En appelant le magasin d'énergie, j'ai obtenu le dernier PN-750 avec rs232 de la devanture.  Assez bon marché, car il n'y avait pas de fils dans le kit. <br><br><h2>  Étape 3: Configuration de l'onduleur </h2><br>  Il y a des problèmes de connexion de l'onduleur.  J'ai acheté plusieurs convertisseurs USB-&gt; RS232, lisez sur les forums que l'énergie utilise le protocole Megatec standard et vous pouvez au moins travailler avec lui via le logiciel Upsilon2000.  Mais peu importe combien j'ai lutté, il y avait un silence complet sur l'interface série.  Après une semaine d'épreuves, j'ai décidé de démonter l'onduleur et de voir ce qu'il y avait, cracher sur la garantie.  Le problème s'est avéré être banal - la carte RS232 n'était pas connectée à la carte principale de l'onduleur et le connecteur était légèrement cassé.  J'ai remplacé le connecteur, je l'ai connecté et à propos d'un miracle, tout a décollé, bien que le firmware ait donné l'étrange nom UPS - SIN800 (il semble maintenant que je comprenne pourquoi l'énergie dans les nouveaux modèles a été coupée par rs232). <br><br>  Sous OpenWRT, il y avait un P / O standard pour travailler avec UPS: les outils de mise en réseau, qui ont tout ce dont vous avez besoin pour afficher les métriques dans la console. <br><br><pre><code class="bash hljs">root@OpenWrt:/<span class="hljs-comment"><span class="hljs-comment"># upsc myups@127.0.0.1 battery.charge: 100 battery.voltage: 13.32 battery.voltage.high: 13.00 battery.voltage.low: 10.40 battery.voltage.nominal: 12.0 device.mfr: GERMANY device.model: SIN 800S device.type: ups driver.name: blazer_ser driver.parameter.cablepower: both driver.parameter.pollinterval: 2 driver.parameter.port: /dev/ttyUSB0 driver.parameter.protocol: megatec driver.version: 2.6.5 driver.version.internal: 1.55 input.current.nominal: 2.7 input.frequency: 50.0 input.frequency.nominal: 50 input.voltage: 225.7 input.voltage.fault: 225.7 input.voltage.nominal: 220 output.voltage: 219.6 ups.beeper.status: enabled ups.delay.shutdown: 30 ups.delay.start: 180 ups.firmware: Z1911F100 ups.load: 5 ups.mfr: GERMANY ups.model: SIN 800S ups.status: OL ups.temperature: 48.0 ups.type: online</span></span></code> </pre> <br>  Et le plus intéressant est que sous Zabbix il y a un modèle prêt à l'emploi pour les noix.  Vobschem - nous scions dans l'agent zabbix le script shell du kit tempate et nous avons une belle image dans zabbix en dynamique.  Les tâches 1 et 2 à ce stade ont été résolues (et l'idée de surveiller la consommation totale d'énergie est apparue à l'avenir). <br><br><h2>  Étape 4: 1 fil et température </h2><br>  Il y a quelque temps, j'ai acheté un thermomètre USB sur ebay (une carte convertisseur combinée et un capteur). <br>  OpenWRT s'est également avéré être un logiciel approprié, l'utilitaire digitemp_DS9097.  Elle a affiché la température d'un seul capteur soudé.  Après avoir lu qu'il y a 1 fil, j'ai réalisé que vous pouvez essayer de ne pas vous limiter à un seul capteur et prendre un bus de capteur complet vers le convertisseur USB acheté.  Ayant pris plusieurs microcircuits DS18B20 et «barils» sous une paire torsadée dans le magasin, j'ai construit une construction avec le capteur retiré à l'extérieur du baril et connecté en interne avec 3 fils. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/758/029/d61/758029d613c7dfe66d3f45adee62c043.png" alt="image"><br><br>  Je connais cette conception depuis de nombreuses années, nous l'avons utilisée pour prendre des mesures dans les centres de données, mais je ne connaissais toujours pas 1wire.  Lors de la connexion des barils les uns aux autres avec des cordons de brassage standard et le passage de cette ferme au «thermomètre USB», j'ai obtenu les valeurs des 3 capteurs de température. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dc2/7d5/d6f/dc27d5d6fac92cc21834fb59c6e0a759.png" alt="image"><br><br>  Reste à les jeter autour des lieux.  La longueur totale du pneu était d'environ 30 mètres.  Le signal ne disparaît pas.  Un tonneau placé dans la rue est rempli d'un pistolet à colle.  A vécu l'hiver. <br><br><h2>  Étape 5: l'eau </h2><br>  J'ai dû changer le compteur d'eau à l'entrée (ce n'était pas une impulsion, sans interrupteur à lames).  Grâce à la vie dans une maison de campagne, la plomberie ne pose pas de question.  Je l'ai acheté au magasin de plomberie le plus proche et l'ai remplacé.  Dans le nouveau compteur, une impulsion se produit tous les 10 litres d'eau.  Maintenant, ces impulsions doivent être considérées comme quelque chose. <br><br>  Pour une raison quelconque, ils ont abandonné un microcircuit de compteur numérique intéressant - DS2423.  Mais il s'est avéré que les gars de Volgograd (radioseti) ont un appareil prêt à l'emploi qui, grâce à la batterie intégrée, compte également la valeur du nombre d'impulsions en cas de panne de courant.  Cependant, l'appareil lui-même a été adapté à sa propre architecture réseau.  Des connecteurs RJ-11 à une alimentation 12V séparée.  Dans mon cas, je voulais me limiter à alimenter le bus existant (5V).  J'ai dû contourner directement le cerclage "supplémentaire" et souder directement aux conclusions du DS2423.  Puis l'appareil a fonctionné, les valeurs de registre sont devenues visibles sur le bus.  Il y en a deux, l'appareil implique la connexion à deux compteurs d'eau en même temps - eau chaude et eau chaude.  Je n'ai qu'une seule entrée d'eau, donc j'utilise le deuxième registre uniquement pour les tests. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f9b/fd5/05a/f9bfd505a9f2bcb9f93c0b9bc996c33f.png" alt="image"><br><br>  Le résultat final pour la topologie 1wire: <br><br><pre> <code class="bash hljs">root@OpenWrt:/etc/zabbix<span class="hljs-comment"><span class="hljs-comment"># digitemp_DS9097 -c /etc/digitemp.conf -a DigiTemp v3.5.0 Copyright 1996-2007 by Brian C. Lane GNU Public License v2.0 - http://www.digitemp.com Apr 04 16:16:35 Sensor 0 C: 29.81 F: 85.66 Apr 04 16:16:36 Sensor 1 C: 14.00 F: 57.20 Apr 04 16:16:37 Sensor 2 C: 6.56 F: 43.81 Apr 04 16:16:37 Sensor 3 #0 6609 Apr 04 16:16:37 Sensor 3 #1 9</span></span></code> </pre><br><br>  Soit dit en passant, puisqu'un nouveau compteur d'eau a été installé simultanément avec un compteur d'impulsions numérique, nous pouvons tirer des conclusions sur l'écart des lectures / rebonds des contacts.  Visuellement, ces écarts sont presque absents (jusqu'à plusieurs centaines de litres à la lecture actuelle de 60 000). <br><br><h2>  Étape 6: Alerte </h2><br>  En utilisant les informations collectées, il a été possible de faire des alertes utiles: <br><br><ul><li>  température extérieure en sms tous les matins (+ participation des capteurs au projet narodmon) </li><li>  Message de transfert de batterie UPS </li><li>  Batterie de l'onduleur faible </li><li>  message basse / haute tension </li><li>  un message sur la chaleur de la table de nuit avec l'équipement </li><li>  rapport de basse température dans le grenier (sauvetage de tomates) </li><li>  message sur l'adresse mac "alien / new" sur le réseau </li><li>  message sur la consommation élevée d'eau (dans un certain délai) </li></ul><br><h2>  Étape 7: l'avenir </h2><br>  Une jauge numérique a été achetée sur aliexpress avec une sortie rs232 sous forme d'USB.  Mais alors qu'il ne s'est pas battu avec lui, il ne répond pas aux paquets.  Nous réfléchirons plus loin.  J'espère serrer. <br><br>  Je prévois d'acheter un relais de contrôle du robinet à boisseau sphérique (le robinet lui-même existe déjà) pour le contrôle à distance du robinet et la mise en place éventuelle d'un arrêt automatique de l'eau en l'absence de domicile. <br><br>  D'une manière ou d'une autre d'intégrer le compteur de gaz numérique gallus dans le circuit pour notifier un dépôt en cours. <br><br><h3>  Enfin, quelques graphiques: </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/802/69c/2a6/80269c2a692b6c6ae3468404b106fbd7.png" alt="image"><br><img src="https://habrastorage.org/getpro/habr/post_images/fe6/6ae/85f/fe66ae85fdeb1184ed5a11a141a78d11.png" alt="image"><br><img src="https://habrastorage.org/getpro/habr/post_images/9b6/68b/a9a/9b668ba9a480320da3ad48dfab0b56fa.png" alt="image"><br><img src="https://habrastorage.org/getpro/habr/post_images/896/aa8/da6/896aa8da673ed49a69f28d4a4f39942b.png" alt="image"></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr446864/">https://habr.com/ru/post/fr446864/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr446852/index.html">TEMPEST et EMSEC: est-il possible d'utiliser des ondes électromagnétiques dans les cyberattaques?</a></li>
<li><a href="../fr446854/index.html">Azure Tech Lab, 11 avril à Moscou</a></li>
<li><a href="../fr446858/index.html">Comment déployer SAP HANA: analyser différentes méthodes</a></li>
<li><a href="../fr446860/index.html">Histoire de 3dfx Voodoo1</a></li>
<li><a href="../fr446862/index.html">À quoi s'attendent les concepteurs à DUMP-2019: Aperçu de la section Conception</a></li>
<li><a href="../fr446866/index.html">Systèmes d'exploitation: trois pièces faciles. Partie 2: Abstraction: Processus (traduction)</a></li>
<li><a href="../fr446870/index.html">Systèmes de particules: une histoire de Noël</a></li>
<li><a href="../fr446872/index.html">Explorer OpenCV sur StereoPi: carte de profondeur à partir de la vidéo</a></li>
<li><a href="../fr446876/index.html">Moscou, 18 avril - QIWI SERVER PARTY 4.0</a></li>
<li><a href="../fr446880/index.html">Graphiques incorrects: notre expérience</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>