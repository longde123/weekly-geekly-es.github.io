<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ÑπÔ∏è üë®üèº‚Äç‚öïÔ∏è üìÜ √ânergie, chaleur et eau üí¢ üßñüèΩ üßëüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pr√©face 
 Ann√©e 2019. Dans presque tous les magasins d'√©lectronique, vous pouvez acheter l'un des centaines d'ensembles possibles de maisons intellige...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>√ânergie, chaleur et eau</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/446864/"><h2>  Pr√©face </h2><br>  <i>Ann√©e 2019.</i>  <i>Dans presque tous les magasins d'√©lectronique, vous pouvez acheter l'un des centaines d'ensembles possibles de maisons intelligentes.</i>  <i>Prenez et configurez en "2 clics", connectez-vous aux nuages, recevez des √©v√©nements push dans l'application / SMS, et en g√©n√©ral recevez toutes les informations n√©cessaires partout dans le monde.</i> <br><br>  Id√©al, mais dans mon cas, cela n'a pas fonctionn√©.  Quelques d√©cisions qui sont tomb√©es entre mes mains se sont av√©r√©es √™tre un ensemble limit√© de certaines fonctions, ne couvrant qu'une partie de mes requ√™tes, et en plus, imposant des restrictions presque insurmontables.  Et, comme cela arrive g√©n√©ralement, moins il y a de restrictions, plus vous avez besoin de plonger dans le domaine, de r√©fl√©chir ind√©pendamment aux solutions, aux architectures.  Par cons√©quent - la ferme collective nous-m√™mes :) <br><br><h2>  Les t√¢ches </h2><br>  1. recevoir des informations sur la qualit√© du r√©seau √©lectrique (surtensions, arr√™t complet, etc.). <br><br>  2. Ayez une surveillance compl√®te de l'onduleur.  Mais en fait, avoir ce m√™me UPS bas√© sur les cons√©quences de p2. <br><br>  3. Recevez les informations de temp√©rature: <br><br><ol><li>  dans la rue </li><li>  √† la maison </li><li>  dans le grenier (quand les ordures et les tomates jet√©es l√† g√®lent) </li></ol><br>  4. Surveillez l‚Äô√©tat de la consommation d‚Äôeau, alertez si la consommation a augment√© (soudainement une fuite, vous ne pouvez pas tout peser avec des capteurs d‚Äôhumidit√©). <br><br>  5. Comprendre quand quelqu'un est √† la maison pour automatiser la fermeture / ouverture de l'eau. <br><br>  6. Lecture du compteur de gaz et alerte lorsque la r√©serve pay√©e s'√©puise. <br>  + autres capteurs de toutes sortes (humidit√©, ouverture, pression de l'eau, pression dans le circuit de chauffage, etc.). <br><br>  L'objectif global est d'avoir une interface commune o√π vous pouvez regarder tout cela.  Recevez des notifications en cas de probl√®me.  <s>Et pour qu'il n'y ait rien pour cela</s> et pour ne pas donner beaucoup d'argent pour cela. <br><br><h2>  La composition du complexe en ce moment </h2><br><ul><li>  Batterie UPS Energy PN-750 + 100 Ah </li><li>  Convertisseur USB-&gt; RS232 bas√© sur PL2303 </li><li>  Routeur Tp-link tl-wr1043nd + </li><li>  Ma√Ætre de r√©seau √† 1 fil bas√© sur un thermom√®tre USB achet√© DS18B20 + PL-2303TA </li><li>  1 fil 3 capteurs DS18B20 </li><li>  Module de compteur d'eau Radioseti DS2423 √† 1 fil </li></ul><br>  Une machine virtuelle avec un serveur Zabbix en dehors du r√©seau domestique. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/38f/096/8dc/38f0968dcb30102ff286561853581a96.png" alt="image"><br><br><a name="habracut"></a><br><h2>  √âtape 1. Pr√©paration de l'infrastructure </h2><br>  La premi√®re √©tape a √©t√© la question de la r√©organisation physique: le routeur a √©t√© d√©plac√© vers la table de nuit pr√®s de la mine d'√©vent, o√π UPS devait √™tre install√© plus loin.  L'antenne du fournisseur Internet Ubiquiti Nanostation Loco M2 PoE a √©t√© connect√©e √† la m√™me prise que le routeur, afin de continuer √† √™tre aliment√©e par UPS. <br><br>  J'avais d√©j√† une installation d√©di√©e de Zabbix sur un serveur distant et une certaine exp√©rience avec cette application, il n'y avait donc aucun probl√®me avec la th√©orie de l'organisation des alertes et le tableau de bord lui-m√™me. <br><br>  Le routeur est flash√© dans OpenWRT Chaos Calmer, un VPN est configur√© sur le r√©seau o√π se trouvait le serveur Zabbix. <br><br>  J'ai imm√©diatement ajout√© les m√©triques √† zabbix, apr√®s avoir obtenu le mod√®le d'√©l√©ment pour openwrt.  Ainsi, j'ai eu l'occasion de surveiller √† la fois le syst√®me et, par exemple, combien et quelles adresses MAC sont connect√©es au point.  √Ä l'avenir, ce qui aurait d√ª servir de d√©cision sur l'arr√™t de l'eau dans la maison. <br><br><h2>  √âtape 2. Choisir un onduleur </h2><br>  Les crit√®res de s√©lection √©taient: <br><br><ul><li>  la possibilit√© d'une chaudi√®re √† gaz (buderus) </li><li>  √† partir de 5 heures d'autonomie chaudi√®re + √©quipement Internet </li><li>  pr√©sence d'une interface de surveillance </li><li>  faible bruit (placement - table de chevet dans la cuisine pr√®s de la bouche de ventilation) </li><li>  en raison de restrictions sur l'emplacement et le prix - de pr√©f√©rence une conception √† batterie unique </li></ul><br>  Nous examinerons la possibilit√© de r√©pondre aux crit√®res dans l'ordre. <br><br>  <b>La capacit√© de la chaudi√®re √† gaz √† fonctionner</b> s'explique par le fait que la chaudi√®re n√©cessite un sinus propre, sinon le moteur de la pompe vibre et s'use.  √Ä ce sujet, vous pouvez consulter de nombreux articles sur Google. <br>  L'ordinaire (ordinateur UPS) ne donne pas un tel sinus, ce qui donne une onde sinuso√Ødale approximative. <br>  Le deuxi√®me facteur important est la pr√©sence de ¬´√† travers neutre¬ª.  Tout est un peu plus compliqu√© ici, mais c'est aussi facilement google, donc je ne m'arr√™terai pas.  Je ne dirai qu'une chose - sans neutre traversant, le buderus n'a pas fonctionn√©, ou plut√¥t il est tomb√© dans l'erreur, car le capteur d'ionisation n'a pas fonctionn√© et la chaudi√®re n'a tout simplement pas vu de flamme. <br><br>  En remplacement d'UPS, il y a eu un changement d'orientation vers les UPS en ligne et interactifs en ligne. <br>  <b>A partir de 5 heures d'autonomie de la chaudi√®re + √©quipement Internet</b> donne principalement des UPS avec une batterie externe.  <b>En raison de l'emplacement et des restrictions de prix, une conception √† batterie unique est souhaitable</b> .  La batterie de 100 Ah devait durer plus de 8 heures. <br><br>  <b>La pr√©sence d'une interface de surveillance</b> pour au moins savoir quand le syst√®me est pass√© √† la batterie, afin de rentrer chez soi en hiver et de d√©marrer le g√©n√©rateur.  Je n'avais aucune exigence particuli√®re ici (ainsi qu'une exp√©rience de mise en ≈ìuvre).  Je cherchais tout ce qui vient avec une interface RS232 ou USB. <br><br>  L'exigence d'un <b>faible niveau de bruit</b> s'est en fait av√©r√©e √™tre une limitation s√©rieuse et a mis au rebut toute une classe d'√©quipements - UPS en ligne, car ils fonctionnent tous en mode de ventilation constante du transformateur (le ventilateur ne s'arr√™te pas). <br><br>  En appelant le magasin d'√©nergie, j'ai obtenu le dernier PN-750 avec rs232 de la devanture.  Assez bon march√©, car il n'y avait pas de fils dans le kit. <br><br><h2>  √âtape 3: Configuration de l'onduleur </h2><br>  Il y a des probl√®mes de connexion de l'onduleur.  J'ai achet√© plusieurs convertisseurs USB-&gt; RS232, lisez sur les forums que l'√©nergie utilise le protocole Megatec standard et vous pouvez au moins travailler avec lui via le logiciel Upsilon2000.  Mais peu importe combien j'ai lutt√©, il y avait un silence complet sur l'interface s√©rie.  Apr√®s une semaine d'√©preuves, j'ai d√©cid√© de d√©monter l'onduleur et de voir ce qu'il y avait, cracher sur la garantie.  Le probl√®me s'est av√©r√© √™tre banal - la carte RS232 n'√©tait pas connect√©e √† la carte principale de l'onduleur et le connecteur √©tait l√©g√®rement cass√©.  J'ai remplac√© le connecteur, je l'ai connect√© et √† propos d'un miracle, tout a d√©coll√©, bien que le firmware ait donn√© l'√©trange nom UPS - SIN800 (il semble maintenant que je comprenne pourquoi l'√©nergie dans les nouveaux mod√®les a √©t√© coup√©e par rs232). <br><br>  Sous OpenWRT, il y avait un P / O standard pour travailler avec UPS: les outils de mise en r√©seau, qui ont tout ce dont vous avez besoin pour afficher les m√©triques dans la console. <br><br><pre><code class="bash hljs">root@OpenWrt:/<span class="hljs-comment"><span class="hljs-comment"># upsc myups@127.0.0.1 battery.charge: 100 battery.voltage: 13.32 battery.voltage.high: 13.00 battery.voltage.low: 10.40 battery.voltage.nominal: 12.0 device.mfr: GERMANY device.model: SIN 800S device.type: ups driver.name: blazer_ser driver.parameter.cablepower: both driver.parameter.pollinterval: 2 driver.parameter.port: /dev/ttyUSB0 driver.parameter.protocol: megatec driver.version: 2.6.5 driver.version.internal: 1.55 input.current.nominal: 2.7 input.frequency: 50.0 input.frequency.nominal: 50 input.voltage: 225.7 input.voltage.fault: 225.7 input.voltage.nominal: 220 output.voltage: 219.6 ups.beeper.status: enabled ups.delay.shutdown: 30 ups.delay.start: 180 ups.firmware: Z1911F100 ups.load: 5 ups.mfr: GERMANY ups.model: SIN 800S ups.status: OL ups.temperature: 48.0 ups.type: online</span></span></code> </pre> <br>  Et le plus int√©ressant est que sous Zabbix il y a un mod√®le pr√™t √† l'emploi pour les noix.  Vobschem - nous scions dans l'agent zabbix le script shell du kit tempate et nous avons une belle image dans zabbix en dynamique.  Les t√¢ches 1 et 2 √† ce stade ont √©t√© r√©solues (et l'id√©e de surveiller la consommation totale d'√©nergie est apparue √† l'avenir). <br><br><h2>  √âtape 4: 1 fil et temp√©rature </h2><br>  Il y a quelque temps, j'ai achet√© un thermom√®tre USB sur ebay (une carte convertisseur combin√©e et un capteur). <br>  OpenWRT s'est √©galement av√©r√© √™tre un logiciel appropri√©, l'utilitaire digitemp_DS9097.  Elle a affich√© la temp√©rature d'un seul capteur soud√©.  Apr√®s avoir lu qu'il y a 1 fil, j'ai r√©alis√© que vous pouvez essayer de ne pas vous limiter √† un seul capteur et prendre un bus de capteur complet vers le convertisseur USB achet√©.  Ayant pris plusieurs microcircuits DS18B20 et ¬´barils¬ª sous une paire torsad√©e dans le magasin, j'ai construit une construction avec le capteur retir√© √† l'ext√©rieur du baril et connect√© en interne avec 3 fils. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/758/029/d61/758029d613c7dfe66d3f45adee62c043.png" alt="image"><br><br>  Je connais cette conception depuis de nombreuses ann√©es, nous l'avons utilis√©e pour prendre des mesures dans les centres de donn√©es, mais je ne connaissais toujours pas 1wire.  Lors de la connexion des barils les uns aux autres avec des cordons de brassage standard et le passage de cette ferme au ¬´thermom√®tre USB¬ª, j'ai obtenu les valeurs des 3 capteurs de temp√©rature. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dc2/7d5/d6f/dc27d5d6fac92cc21834fb59c6e0a759.png" alt="image"><br><br>  Reste √† les jeter autour des lieux.  La longueur totale du pneu √©tait d'environ 30 m√®tres.  Le signal ne dispara√Æt pas.  Un tonneau plac√© dans la rue est rempli d'un pistolet √† colle.  A v√©cu l'hiver. <br><br><h2>  √âtape 5: l'eau </h2><br>  J'ai d√ª changer le compteur d'eau √† l'entr√©e (ce n'√©tait pas une impulsion, sans interrupteur √† lames).  Gr√¢ce √† la vie dans une maison de campagne, la plomberie ne pose pas de question.  Je l'ai achet√© au magasin de plomberie le plus proche et l'ai remplac√©.  Dans le nouveau compteur, une impulsion se produit tous les 10 litres d'eau.  Maintenant, ces impulsions doivent √™tre consid√©r√©es comme quelque chose. <br><br>  Pour une raison quelconque, ils ont abandonn√© un microcircuit de compteur num√©rique int√©ressant - DS2423.  Mais il s'est av√©r√© que les gars de Volgograd (radioseti) ont un appareil pr√™t √† l'emploi qui, gr√¢ce √† la batterie int√©gr√©e, compte √©galement la valeur du nombre d'impulsions en cas de panne de courant.  Cependant, l'appareil lui-m√™me a √©t√© adapt√© √† sa propre architecture r√©seau.  Des connecteurs RJ-11 √† une alimentation 12V s√©par√©e.  Dans mon cas, je voulais me limiter √† alimenter le bus existant (5V).  J'ai d√ª contourner directement le cerclage "suppl√©mentaire" et souder directement aux conclusions du DS2423.  Puis l'appareil a fonctionn√©, les valeurs de registre sont devenues visibles sur le bus.  Il y en a deux, l'appareil implique la connexion √† deux compteurs d'eau en m√™me temps - eau chaude et eau chaude.  Je n'ai qu'une seule entr√©e d'eau, donc j'utilise le deuxi√®me registre uniquement pour les tests. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f9b/fd5/05a/f9bfd505a9f2bcb9f93c0b9bc996c33f.png" alt="image"><br><br>  Le r√©sultat final pour la topologie 1wire: <br><br><pre> <code class="bash hljs">root@OpenWrt:/etc/zabbix<span class="hljs-comment"><span class="hljs-comment"># digitemp_DS9097 -c /etc/digitemp.conf -a DigiTemp v3.5.0 Copyright 1996-2007 by Brian C. Lane GNU Public License v2.0 - http://www.digitemp.com Apr 04 16:16:35 Sensor 0 C: 29.81 F: 85.66 Apr 04 16:16:36 Sensor 1 C: 14.00 F: 57.20 Apr 04 16:16:37 Sensor 2 C: 6.56 F: 43.81 Apr 04 16:16:37 Sensor 3 #0 6609 Apr 04 16:16:37 Sensor 3 #1 9</span></span></code> </pre><br><br>  Soit dit en passant, puisqu'un nouveau compteur d'eau a √©t√© install√© simultan√©ment avec un compteur d'impulsions num√©rique, nous pouvons tirer des conclusions sur l'√©cart des lectures / rebonds des contacts.  Visuellement, ces √©carts sont presque absents (jusqu'√† plusieurs centaines de litres √† la lecture actuelle de 60 000). <br><br><h2>  √âtape 6: Alerte </h2><br>  En utilisant les informations collect√©es, il a √©t√© possible de faire des alertes utiles: <br><br><ul><li>  temp√©rature ext√©rieure en sms tous les matins (+ participation des capteurs au projet narodmon) </li><li>  Message de transfert de batterie UPS </li><li>  Batterie de l'onduleur faible </li><li>  message basse / haute tension </li><li>  un message sur la chaleur de la table de nuit avec l'√©quipement </li><li>  rapport de basse temp√©rature dans le grenier (sauvetage de tomates) </li><li>  message sur l'adresse mac "alien / new" sur le r√©seau </li><li>  message sur la consommation √©lev√©e d'eau (dans un certain d√©lai) </li></ul><br><h2>  √âtape 7: l'avenir </h2><br>  Une jauge num√©rique a √©t√© achet√©e sur aliexpress avec une sortie rs232 sous forme d'USB.  Mais alors qu'il ne s'est pas battu avec lui, il ne r√©pond pas aux paquets.  Nous r√©fl√©chirons plus loin.  J'esp√®re serrer. <br><br>  Je pr√©vois d'acheter un relais de contr√¥le du robinet √† boisseau sph√©rique (le robinet lui-m√™me existe d√©j√†) pour le contr√¥le √† distance du robinet et la mise en place √©ventuelle d'un arr√™t automatique de l'eau en l'absence de domicile. <br><br>  D'une mani√®re ou d'une autre d'int√©grer le compteur de gaz num√©rique gallus dans le circuit pour notifier un d√©p√¥t en cours. <br><br><h3>  Enfin, quelques graphiques: </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/802/69c/2a6/80269c2a692b6c6ae3468404b106fbd7.png" alt="image"><br><img src="https://habrastorage.org/getpro/habr/post_images/fe6/6ae/85f/fe66ae85fdeb1184ed5a11a141a78d11.png" alt="image"><br><img src="https://habrastorage.org/getpro/habr/post_images/9b6/68b/a9a/9b668ba9a480320da3ad48dfab0b56fa.png" alt="image"><br><img src="https://habrastorage.org/getpro/habr/post_images/896/aa8/da6/896aa8da673ed49a69f28d4a4f39942b.png" alt="image"></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr446864/">https://habr.com/ru/post/fr446864/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr446852/index.html">TEMPEST et EMSEC: est-il possible d'utiliser des ondes √©lectromagn√©tiques dans les cyberattaques?</a></li>
<li><a href="../fr446854/index.html">Azure Tech Lab, 11 avril √† Moscou</a></li>
<li><a href="../fr446858/index.html">Comment d√©ployer SAP HANA: analyser diff√©rentes m√©thodes</a></li>
<li><a href="../fr446860/index.html">Histoire de 3dfx Voodoo1</a></li>
<li><a href="../fr446862/index.html">√Ä quoi s'attendent les concepteurs √† DUMP-2019: Aper√ßu de la section Conception</a></li>
<li><a href="../fr446866/index.html">Syst√®mes d'exploitation: trois pi√®ces faciles. Partie 2: Abstraction: Processus (traduction)</a></li>
<li><a href="../fr446870/index.html">Syst√®mes de particules: une histoire de No√´l</a></li>
<li><a href="../fr446872/index.html">Explorer OpenCV sur StereoPi: carte de profondeur √† partir de la vid√©o</a></li>
<li><a href="../fr446876/index.html">Moscou, 18 avril - QIWI SERVER PARTY 4.0</a></li>
<li><a href="../fr446880/index.html">Graphiques incorrects: notre exp√©rience</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>