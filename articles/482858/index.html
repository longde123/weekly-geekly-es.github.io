<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï∫üèª ü§º üßõüèæ Sensores de ventana inal√°mbricos caseros: STM32L051 + RFM69 + Android üí≤ üïñ ü•®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Buenas tardes, queridos Khabrovites! Hace unos a√±os, compr√© un anuncio colorido de zWave e instal√© sensores de ventana basados ‚Äã‚Äãen este protocolo. Se...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sensores de ventana inal√°mbricos caseros: STM32L051 + RFM69 + Android</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482858/"> Buenas tardes, queridos Khabrovites!  Hace unos a√±os, compr√© un anuncio colorido de zWave e instal√© sensores de ventana basados ‚Äã‚Äãen este protocolo.  Se conect√≥ un zWave-Stick USB al servidor dom√©stico, que desempe√±aba el papel de un controlador, se escribi√≥ un peque√±o m√≥dulo Java que recibi√≥ datos de este controlador y se escribi√≥ una peque√±a aplicaci√≥n para Android que mostraba maravillosamente el estado de todos los sensores.  Las bater√≠as est√°n insertadas, los sensores est√°n registrados en el controlador, todo funcion√≥.  Pero despu√©s de un par de meses hubo una terrible decepci√≥n.  En primer lugar, estos sensores zWave funcionan seg√∫n el principio de "enviar un mensaje y quedarse dormido sin esperar la confirmaci√≥n".  En mi caso, esto condujo al hecho de que la se√±al de los sensores m√°s lejanos del controlador simplemente no lleg√≥ al controlador.  Incluso la instalaci√≥n de un repetidor zWave adicional no ayud√≥.  En segundo lugar, agotaron la bater√≠a tan r√°pido que despu√©s de unos seis meses, todos los sensores dejaron de funcionar.  La raz√≥n es que se despertaban cada hora para informar al controlador de su condici√≥n.  Desactivar o cambiar esta opci√≥n no funcion√≥, ya que el software est√°ndar categ√≥ricamente no lo permiti√≥.  Despu√©s de dos a√±os de tormento con esta tecnolog√≠a cruda, poco confiable y poco amigable, decid√≠ que ten√≠a suficiente.  Pero en lugar de guardar todo y tirarlo a la basura, tuve la idea de dejar los estuches, pero cambiar la electr√≥nica en ellos.  La elecci√≥n recay√≥ en un transceptor RFM69 bastante simple (433 MHz), sobre la base de lo cual fue posible hacer una placa para el sensor y un controlador conectado a trav√©s de USB al servidor.  El nuevo sistema ya ha estado en funcionamiento durante 5 meses, la fiabilidad es cercana al 100% (pero todav√≠a hubo algunas fallas), las bater√≠as a√∫n no parecen estar agotadas.  Es decir, ya es visible que se han eliminado todas las deficiencias del sistema antiguo basado en zWave, y quiero compartir los detalles t√©cnicos de este art√≠culo, vea la imagen. <br><br><img src="https://habrastorage.org/webt/n-/gz/rd/n-gzrd4pxnz2h38utebhqhtakjg.png"><br><br>  A qui√©n le importa, por favor, debajo del gato. <br><a name="habracut"></a><br>  Me parece que zWave en mi caso result√≥ inoperante por dos razones: la casa tiene dos pisos con pisos de concreto reforzado y un √°rea grande (es decir, una eliminaci√≥n significativa de algunos sensores del controlador).  Bueno, fallas en el software propietario, que no permitieron desactivar el despertar peri√≥dico de los sensores, lo que condujo a una descarga r√°pida de la bater√≠a.  Cuando se hizo evidente que no estaba en camino con zWave, comenc√© a buscar otras opciones que pudieran introducirse en las mismas carcasas de sensores. <br><br>  Mi primer prototipo de sensores se bas√≥ en el ESP8266.  El controlador: sobre la base de mi pago sobre el que ya <a href="https://habr.com/en/post/413101">escrib√≠ en Habr√©</a> .  El sistema incluso funcion√≥ como un prototipo, pero tuve que abandonarlo por dos razones.  La primera raz√≥n es la misma: en la casa hab√≠a rincones con un nivel muy bajo de se√±al WiFi, lo que condujo a un tiempo de activaci√≥n muy largo del ESP8266 al despertar y, como resultado, a una fuerte descarga de la bater√≠a.  Aunque admito que simplemente no s√© c√≥mo cocinar esto ESP8266 (art√≠culos <a href="https://habr.com/ru/post/480316">como este</a> confirman esta tesis).  Pero la segunda raz√≥n fue m√°s seria.  Como decid√≠ dejar no solo la carcasa, sino tambi√©n el compartimento de la bater√≠a, me limit√© a una bater√≠a CR123A, que es de 3.0 voltios.  Es decir, el precio y la complejidad del sensor aumentaron debido al aumento del convertidor CC / CC.  Aunque <a href="https://habr.com/ru/post/304936">hay un art√≠culo maravilloso</a> sobre este tema en Habr√©.  Pero, de todos modos, estas dos razones han superado y rechac√© ESP8266. <br><br>  El segundo prototipo fue conectado.  Hice un prototipo tanto del sensor como del controlador USB, agregu√© un m√≥dulo de servidor para que entendiera este controlador adem√°s del zWave-Stick.  Hubo una idea de tirar gradualmente los cables y el sensor tras sensor para cambiar la placa zWave a una cableada.  Pero al final, no eligi√≥ paredes y este prototipo tambi√©n se descart√≥. <br><br>  Luego decidi√≥ mirar hacia los m√≥dulos de radio a 433 y 868 MHz y orden√≥ varios m√≥dulos para experimentos: <a href="https://www.sparkfun.com/products/13910" rel="nofollow">RFM69HCW</a> , <a href="https://www.mouser.de/datasheet/2/21/A110LR09A_ProductBrief-1511797.pdf" rel="nofollow">A110LR09A</a> y <a href="https://www.mouser.de/datasheet/2/268/70651A-60467.pdf" rel="nofollow">MRF89XAM8A</a> .  En t√©rminos de tama√±o del m√≥dulo, precio y tambi√©n debido a la disponibilidad de ambas bibliotecas y <a href="https://learn.sparkfun.com/tutorials/rfm69hcw-hookup-guide" rel="nofollow">buenos ejemplos, me</a> decid√≠ por RFM69HCW, que form√≥ la base del sistema. <br><br>  El sistema tiene solo cuatro componentes: <br><br><ul><li>  sensores inal√°mbricos (433 MHz, bater√≠a CR123A 3.0V), </li><li>  controlador de red (433 MHz, alimentado por USB desde el servidor) </li><li>  el servidor (sobre el cual ya escrib√≠ sobre Habr√© <a href="https://habr.com/en/post/268197">en este art√≠culo</a> ) y el m√≥dulo del programa del servidor </li><li>  cliente m√≥vil (aplicaci√≥n de Android) </li></ul><br>  A continuaci√≥n describir√© cada m√≥dulo en detalle, y al final dar√© estad√≠sticas sobre el funcionamiento del sistema durante los √∫ltimos meses de funcionamiento. <br><br><h3>  Sensores </h3><br>  Los sensores utilizan el <a href="https://www.sparkfun.com/products/13910" rel="nofollow">m√≥dulo de</a> radio <a href="https://www.sparkfun.com/products/13910" rel="nofollow">RFM69HCW</a> .  Tiene un amplio rango de voltaje de funcionamiento (1.8V-2.4V 17dBm, 2.4V-3.6V 20dBm) y se controla a trav√©s de SPI.  Es decir, necesitas un microcontrolador.  Hace alg√∫n tiempo, me familiaric√© con la serie STM32L y ped√≠ el STM32L051 para experimentos.  Me soborn√≥ como una peque√±a corriente en modo de suspensi√≥n (0.27 ŒºA), y el voltaje de funcionamiento, casi id√©ntico al voltaje del m√≥dulo de radio (1.65V-3.6V).  M√°s bajo precio. <br><br>  Result√≥ el siguiente esquema: <br><br><img src="https://habrastorage.org/webt/0b/xx/kb/0bxxkbtvavy113lz23izewdi4yk.png" alt="imagen"><br><br>  La tensi√≥n de alimentaci√≥n tanto del microcontrolador como del m√≥dulo de radio es tal que pueden alimentarse directamente desde el elemento CR123A.  STM32L051 tiene una referencia de voltaje interno conectada al canal 17 del ADC, as√≠ como el valor de calibraci√≥n de esta fuente, que le permite medir el valor actual del voltaje de suministro VDD.  El m√≥dulo de radio est√° conectado a la alimentaci√≥n a trav√©s del dispositivo de campo Q1, que le permite controlar su alimentaci√≥n desde el microcontrolador. <br><br>  El modo de suspensi√≥n se implementa transfiriendo el microcontrolador a "En espera".  En este modo, el STM32L051 tiene un n√∫cleo deshabilitado, casi todos los perif√©ricos y un regulador de voltaje interno, que asegura el consumo al nivel de 0.29 ŒºA (con el reloj en tiempo real deshabilitado).  Pero en este modo hay una caracter√≠stica: el microcontrolador se activa solo a lo largo del borde ascendente de la se√±al en el pin WKUP (A0).  Como se usa un interruptor magn√©tico, que est√° activado / desactivado (cerrado o abierto), necesita un peque√±o bloque que genere un pulso de corta duraci√≥n tanto al cerrar como al abrir un contacto magn√©tico.  Este pulso se alimenta a la entrada A0 del microcontrolador y lo despierta.  Tal convertidor se implementa en el chip exclusivo IC3 de la serie 74AUP de eficiencia energ√©tica (74AUP1G86), que opera en el rango de voltaje de 0.8V-3.6V y consume 0.2 ŒºA.  Por lo tanto, el consumo total en el modo de reposo debe ser de alrededor de 0,5 ŒºA, lo que se confirma mediante mediciones en un sensor completamente ensamblado. <br><br>  Cuando el microcontrolador se despierta, primero mide el voltaje de suministro y, si es inferior a 1,8 voltios, entonces no es el destino: el transmisor no se puede encender y el microcontrolador se queda dormido. <br><br>  Si el voltaje de la bater√≠a es superior a 1,8 voltios, el microcontrolador se enciende e inicializa el m√≥dulo de radio, transfiere el estado al controlador de red y espera la confirmaci√≥n.  El paquete de datos incluye un n√∫mero √∫nico de paquete de 32 bits (evento), voltaje de la bater√≠a, temperatura, estado de contacto magn√©tico, byte de control (CRC7).  En caso de confirmaci√≥n exitosa, el microcontrolador se duerme nuevamente.  Si no, env√≠a el estado nuevamente, pero un m√°ximo de 10 veces.  Establec√≠ este l√≠mite para que el sensor no intente esperar indefinidamente una respuesta en una situaci√≥n en la que el controlador de red simplemente est√° apagado.  El √∫ltimo n√∫mero de evento √∫nico transmitido se almacena en la EEPROM interna del microcontrolador. <br><br>  Durante la transferencia de datos, el microcontrolador parpadea un LED (sin √©l).  El LED se enciende mediante PWM, donde el ciclo de trabajo depende del valor de voltaje actual, lo que le permite tener casi el mismo brillo en casi todo el rango de voltaje de funcionamiento. <br><br>  Los tableros est√°n dise√±ados en EagleCAD, el dise√±o del tablero <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/pcb" rel="nofollow">est√° disponible aqu√≠</a> .  Los tableros son de doble cara: el microcontrolador y su arn√©s se encuentran en la parte superior hacia el marco de la ventana, y el m√≥dulo de radio y el LED est√°n en la parte inferior hacia la habitaci√≥n.  Ped√≠ en China, me solde en un horno de cocina convencional (capa superior) y un secador de pelo (capa inferior). <br><br><img src="https://habrastorage.org/webt/rj/io/9l/rjio9lhfs3psrwyw8_xefn1lcmi.jpeg" alt="imagen"><br><br>  El m√≥dulo de radio necesita una antena.  Esto es solo un trozo de alambre de 164 mm de largo. <br><br>  Despu√©s de la instalaci√≥n, cada sensor debe ser programado, para lo cual se proporciona un conector SWD.  Dej√© los contactos restantes en el tablero para posibles experimentos en el futuro. <br>  El firmware est√° escrito en C ++, parte del c√≥digo se lleva a cabo en clases b√°sicas bastante universales que encapsulan las llamadas a la biblioteca ST HAL.  El c√≥digo fuente <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/src" rel="nofollow">est√° aqu√≠</a> .  Para el desarrollo, se utiliz√≥ System Workbench para STM32.  El tama√±o del archivo de firmware binario final es de 22 kB. <br><br>  Y aqu√≠ est√° el sensor en el caso: <br><br><img src="https://habrastorage.org/webt/91/fx/ap/91fxapzu7uwnpr0wp2cjydbpwaa.jpeg" alt="imagen"><br><br>  Dependiendo de la posici√≥n del sensor, para algunos sensores dej√© la antena afuera (contra el fondo del marco blanco, sin embargo, no es visible), y para algunos sensores dobl√© el cable dentro del marco y lo met√≠ completamente dentro de la carcasa. <br><br>  En aras del inter√©s, calcul√© el costo de los componentes para un sensor (a los precios del cat√°logo de Mouser, el precio y el precio total en euros) <br><table cellspacing="0" border="0"><tbody><tr><td align="left">  <b><font>Art√≠culo</font></b> </td><td align="left">  <b><font>Descripci√≥n</font></b> </td><td align="left">  <b><font>Valor</font></b> </td><td align="left">  <b><font>N√∫mero de MOUSER</font></b> </td><td align="left">  <b><font>Cantidad</font></b> </td><td align="left">  <b><font>Costo</font></b> </td></tr><tr><td align="left">  <font>IC3</font> </td><td align="left">  <font>O exclusivo</font> </td><td align="left">  <font>1G86</font> </td><td align="left">  <font>771-74AUP1G86GW-G</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0.254</font> </td></tr><tr><td align="left">  <font>IC1</font> </td><td align="left">  <font>Microcontrolador</font> </td><td align="left">  <font>STM32L051</font> </td><td align="left">  <font>511-STM32L051K6T6</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>2,14</font> </td></tr><tr><td align="left">  <font>SV1</font> </td><td align="left">  <font>Conector</font> </td><td align="left">  <font>Swd</font> </td><td align="left">  <font>68602-406HLF</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,157</font> </td></tr><tr><td align="left">  <font>LED1</font> </td><td align="left">  <font>LED 3 mm</font> </td><td align="left">  <font>3mm</font> </td><td align="left">  <font>630-HLMP-K155</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0.351</font> </td></tr><tr><td align="left">  <font>Q1</font> </td><td align="left">  <font>P-mosfet</font> </td><td align="left">  <font>BSH205</font> </td><td align="left">  <font>771-BSH205G2R</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0.276</font> </td></tr><tr><td align="left">  <font>S1</font> </td><td align="left">  <font>Contacto magn√©tico</font> </td><td align="left">  <font>ORD211-0810</font> </td><td align="left">  <font>876-ORD211-0810</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0.625</font> </td></tr><tr><td align="left">  <font>IC2</font> </td><td align="left">  <font>M√≥dulo de radio RFM69HCW</font> </td><td align="left">  <font>RFM69HCW</font> </td><td align="left">  <font>474-COM-13910</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>5.36</font> </td></tr><tr><td align="left">  <font>C1, C2, C3, C6</font> </td><td align="left">  <font>Condensador SMD</font> </td><td align="left">  <font>0.1uF</font> </td><td align="left">  <font>80-C0805C104J5RAC</font> </td><td align="left">  <font>4 4</font> </td><td align="left">  <font>0.1</font> </td></tr><tr><td align="left">  <font>C5</font> </td><td align="left">  <font>Condensador SMD</font> </td><td align="left">  <font>0.4nF</font> </td><td align="left">  <font>C0805C471K8HACTU</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,021</font> </td></tr><tr><td align="left">  <font>C4</font> </td><td align="left">  <font>Condensador SMD (tantalio)</font> </td><td align="left">  <font>47uF</font> </td><td align="left">  <font>581-TAJR225K016RNJ</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,333</font> </td></tr><tr><td align="left">  <font>R1</font> </td><td align="left">  <font>Resistencia SMD</font> </td><td align="left">  <font>10K</font> </td><td align="left">  <font>660-RK73H2ATTDD1002F</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,01</font> </td></tr><tr><td align="left">  <font>R10</font> </td><td align="left">  <font>Resistencia SMD</font> </td><td align="left">  <font>330</font> </td><td align="left">  <font>660-RK73H2ATTDD3300F</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,01</font> </td></tr><tr><td align="left">  <font>R3, R4, R6, R7, R8, R11</font> </td><td align="left">  <font>Resistencia SMD</font> </td><td align="left">  <font>47K</font> </td><td align="left">  <font>660-RK73H2ATTDD4702F</font> </td><td align="left">  <font>6 6</font> </td><td align="left">  <font>0,06</font> </td></tr><tr><td align="left">  <font>R5</font> </td><td align="left">  <font>Resistencia SMD</font> </td><td align="left">  <font>56</font> </td><td align="left">  <font>660-RK73H2ATTD56R0F</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,013</font> </td></tr><tr><td align="left">  <font>R9</font> </td><td align="left">  <font>Resistencia SMD</font> </td><td align="left">  <font>56 millones</font> </td><td align="left">  <font>603-RC0805JR-0756ML</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,037</font> </td></tr><tr><td align="left"></td><td align="left"></td><td align="left"></td><td align="left"></td><td align="left"></td><td align="left">  <b><font>9,748</font></b> </td></tr></tbody></table><br>  Por cierto, result√≥ exactamente tres veces m√°s barato que el sensor zWave original.  Aunque esto es solo el costo de las piezas, excluyendo el caso.  Pero, en mi opini√≥n, en el comercio minorista, los sensores zWave son excesivamente caros. <br><br><h3>  Controlador de red </h3><br>  Para el controlador, se utilizaron el mismo m√≥dulo de radio y el mismo microcontrolador que para los sensores.  Esto permiti√≥ reutilizar la mayor parte del c√≥digo de firmware.  Para el controlador, eleg√≠ este factor de forma de la placa para usar el estuche ya preparado de Raspberry Pi.  En comparaci√≥n con el sensor, se agregaron un conector de antena externa y un circuito USB basado en el aislador FT232RL y SI-8621.  Por supuesto, en cambio, uno podr√≠a tomar un STM32 con USB a bordo.  Pero luego, en primer lugar, ser√≠a necesario separar el c√≥digo del firmware y, en segundo lugar, realizar la implementaci√≥n del software del propio USB.  La opci√≥n con un FT232RL externo, aunque es m√°s costosa, es m√°s confiable y m√°s r√°pida de implementar.  El resultado es el <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/pcb" rel="nofollow">siguiente esquema</a> : <br><br><img src="https://habrastorage.org/webt/wh/ij/_k/whij_k04j8jqetojnlz0hblpnom.png" alt="imagen"><br><br>  Y en forma ensamblada result√≥ as√≠: <br><br><img src="https://habrastorage.org/webt/f2/-4/io/f2-4iog6apig6hfmq-6zhhxmzno.jpeg" alt="imagen"><br><br><img src="https://habrastorage.org/webt/dp/gg/cu/dpggcuqsrdegbwobtujrbf1rlck.jpeg" alt="imagen"><br><br>  El microcontrolador no se pone en suspensi√≥n aqu√≠, el m√≥dulo de radio funciona para la recepci√≥n, pero despu√©s de recibir con √©xito un paquete de cualquiera de los sensores, el m√≥dulo pasa al modo de transmisi√≥n y env√≠a un acuse de recibo.  Adem√°s, cualquier paquete recibido con √©xito se transmite a trav√©s de USB al servidor.  El formato del paquete es una cadena de valores separados por el s√≠mbolo ";": <br>  GW; 3; 12; -57; 0; 146; 30; 18 <br>  donde: <br><br><ul><li>  La primera posici√≥n es la etiqueta del paquete (siempre "GW") </li><li>  segunda posici√≥n - tipo de datos (estado del sensor o c√≥digo de error) </li><li>  tercera posici√≥n - n√∫mero de sensor </li><li>  cuarta posici√≥n: calidad de la se√±al en el lateral del controlador de red (RFM69HCW conserva la calidad de la se√±al durante la recepci√≥n y le permite interrogarla cuando finaliza la recepci√≥n) </li><li>  quinta posici√≥n - estado de la ventana (0 abierto, 1 cerrado) </li><li>  sexta posici√≥n: un n√∫mero √∫nico del paquete (evento) del sensor.  Este n√∫mero le permite controlar en el lado del servidor si todos los eventos fueron recibidos por el servidor o si uno o m√°s eventos se perdieron. </li><li>  s√©ptima posici√≥n - voltaje actual de la bater√≠a (30 corresponde a 3.0V) </li><li>  la √∫ltima, octava posici√≥n es la temperatura del sensor interno del microcontrolador.  Todav√≠a no he descubierto c√≥mo usarlo </li></ul><br>  El c√≥digo fuente para el firmware est√° <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/src" rel="nofollow">en el mismo lugar que para el sensor</a> .  Tienen un archivo principal com√∫n y una biblioteca com√∫n de clases base.  La opci√≥n de firmware (sensor o controlador) se selecciona utilizando la directiva define en el archivo main.cpp. <br><br>  El costo del controlador de red es mayor debido al circuito USB, la antena y los conectores adicionales.  Pero este aditivo se puede descuidar, ya que solo hay un controlador.  Pero incluso con este suplemento, tambi√©n result√≥ ser tres veces m√°s barato que el zWave-Stick, que antes estaba en su lugar. <br><br><h3>  M√≥dulo de servidor </h3><br>  El controlador de red est√° conectado a un servidor que ejecuta CentOS 7. El servidor ejecuta un programa escrito en Java.  Y en su estructura, implementaci√≥n y tareas, el programa es bastante simple: <br><br><ul><li>  Utilizando una biblioteca <a href="http://rxtx.qbang.org/wiki/index.php/Main_Page" rel="nofollow">RxTx</a> muy antigua y que aparentemente ya no es compatible, se <a href="http://rxtx.qbang.org/wiki/index.php/Main_Page" rel="nofollow">supervisa</a> el puerto USB especificado en la configuraci√≥n (en mi caso / dev / ttyUSB0).  Por el momento, esta es la parte menos optimizada de todo el sistema, ya que la biblioteca carga mucho el procesador del servidor. </li><li>  Si se reciben datos del puerto USB, se registran en un archivo de registro y se almacenan en la clase de estado del sensor.  Cuando reinicia el servidor, se pierde el estado.  Para restaurarlo, debe recorrer la casa y abrir y cerrar manualmente todas las ventanas.  Este es probablemente el mayor inconveniente de mi sistema, pero conscientemente me negu√© a sondear peri√≥dicamente los sensores para ahorrar bater√≠as. </li><li>  La aplicaci√≥n tambi√©n es un peque√±o servidor TCP / IP y escucha en el puerto TCP / IP especificado en la configuraci√≥n.  En este puerto, puede aceptar conexiones desde un cliente m√≥vil. </li><li>  Si el cliente m√≥vil se conecta al servidor, env√≠a el estado actual de todos los sensores.  Usando mensajes peri√≥dicos de heartbit, el servidor tambi√©n monitorea la actividad de la conexi√≥n. </li><li>  El servidor y el cliente m√≥vil intercambian mensajes en formato XML.  Estos mensajes se implementan en forma de una peque√±a <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/zNetMonitor/common" rel="nofollow">biblioteca Java</a> , que se comparte tanto en el lado del servidor como en el lado de la aplicaci√≥n m√≥vil de Android. </li><li>  Aunque esto no tiene mucho sentido, por razones de inter√©s, agregu√© la funci√≥n de autorizar un cliente m√≥vil a trav√©s de IMEI, as√≠ como el cifrado AES de mensajes entre el servidor y el cliente utilizando una clave cosida en el c√≥digo fuente (paquete javax.crypto Java).  Pero esto es solo para el experimento, ya que el puerto TCP / IP de este m√≥dulo de servidor solo es accesible desde la red interna y no es visible desde el exterior.  Aunque, si quiero abrir este puerto al gran mundo, ahora no ser√° tan aterrador hacerlo. </li></ul><br>  A qui√©n le importa, el c√≥digo fuente del m√≥dulo del servidor est√° <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/zNetMonitor/server" rel="nofollow">aqu√≠</a> . <br><br><h3>  Cliente m√≥vil (aplicaci√≥n de Android) </h3><br>  No escribir√° mucho aqu√≠, a pesar de que esta aplicaci√≥n es el resultado final de todo el proyecto.  Esta es una aplicaci√≥n Java est√°ndar y muy simple con tres pesta√±as: el estado de las ventanas del primer piso, el estado del segundo piso y una peque√±a telemetr√≠a del servidor (vea el <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/zNetMonitor/app" rel="nofollow">c√≥digo fuente aqu√≠</a> ): <br><br><img src="https://habrastorage.org/webt/j5/hz/hd/j5hzhduedoxedwhuuhrpe0e4s8e.png" alt="imagen"><br><br>  Los gr√°ficos se basan en un conjunto de archivos SVG, que se apilan uno encima del otro seg√∫n el estado de los sensores.  Se admite una pulsaci√≥n larga en el √°rea de cada ventana, de acuerdo con la cual se muestra una pista con la hora a la que se abri√≥ esta ventana: <br><br><img src="https://habrastorage.org/webt/4e/_z/42/4e_z42j_o2j11j7tl9lzzefeffi.png" alt="imagen"><br><br>  En principio, nada le impide agregar un icono de bater√≠a a esta informaci√≥n sobre herramientas, pero sus manos a√∫n no lo han alcanzado. <br><br><h3>  Experiencia operativa </h3><br>  "Cada estornudo" se registra en un archivo de registro en el lado del servidor.  El an√°lisis de estos archivos en los √∫ltimos 5 meses nos permite comprender con un poco m√°s de detalle c√≥mo se siente este sistema. <br><br>  El an√°lisis es muy simple: simplemente grep en la carpeta de archivos de registro en el servidor. <br><br>  ¬øCu√°ntos errores hubo en la transmisi√≥n de datos en el canal de radio?  Durante 5 meses, se registraron 8 errores cuando el mensaje se recibi√≥ en el tama√±o incorrecto y 25 errores en el CRC incorrecto.  En ambos casos, no puede decir directamente qu√© sensor tuvo problemas, ya que el paquete de datos en este caso est√° completamente da√±ado.  Dado que el controlador de red no confirma la recepci√≥n de datos en todos estos casos, el sensor debe enviar los datos de una manera nueva, que en la mayor√≠a de los casos corrige estos errores. <br><br>  Y aqu√≠ hay una tabla resumen sobre el funcionamiento de los sensores durante 5 meses. <br><table cellspacing="0" border="0"><tbody><tr><td align="center">  <b><font>Piso</font></b> </td><td align="center">  <b><font>Sensor</font></b> </td><td align="center">  <b><font>Cantidad</font></b> <b><font><br></font></b>  <b><font>De eventos</font></b> </td><td align="center">  <b><font>De los perdidos</font></b> <b><font><br></font></b>  <b><font>De eventos</font></b> </td><td align="center">  <b><font>Voltaje</font></b> <b><font><br></font></b>  <b><font>Las pilas</font></b> </td><td align="center">  <b><font>Mediana</font></b> <b><font><br></font></b>  <b><font>Poder</font></b> <b><font><br></font></b>  <b><font>Se√±al</font></b> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>10</font> </td><td align="center">  <font>105</font> </td><td align="center">  <font>0 0</font> </td><td align="center">  <font color="#800000">3.1</font> </td><td align="center">  <font>-66</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>11</font> </td><td align="center">  <font>52</font> </td><td align="center">  <font>0 0</font> </td><td align="center">  <font>3,3</font> </td><td align="center">  <font>-70</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>12</font> </td><td align="center">  <font>122</font> </td><td align="center">  <font>0 0</font> </td><td align="center">  <font>3,3</font> </td><td align="center">  <font>-61</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>13</font> </td><td align="center">  <font>89</font> </td><td align="center">  <font>0 0</font> </td><td align="center">  <font>3,3</font> </td><td align="center">  <font>-74</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>14</font> </td><td align="center">  <font>2573</font> </td><td align="center">  <font>0 0</font> </td><td align="center">  <font>3,3</font> </td><td align="center">  <font>-68</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>15</font> </td><td align="center">  <font>261</font> </td><td align="center">  <font>0 0</font> </td><td align="center">  <font>3,3</font> </td><td align="center">  <font>-60</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>16</font> </td><td align="center">  <font>543</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3,3</font> </td><td align="center">  <font>-70</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>17</font> </td><td align="center">  <font>156</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3,3</font> </td><td align="center">  <font>-74</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>18 a√±os</font> </td><td align="center">  <font>177</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3.2</font> </td><td align="center">  <font>-68</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>19</font> </td><td align="center">  <font>384</font> </td><td align="center">  <font color="#800000">3</font> </td><td align="center">  <font>3,3</font> </td><td align="center">  <font>-56</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>3</font> </td><td align="center">  <font>368</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3,3</font> </td><td align="center">  <font>-62</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>4 4</font> </td><td align="center">  <font>86</font> </td><td align="center">  <font>0 0</font> </td><td align="center">  <font>3,3</font> </td><td align="center">  <font>-71</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>5 5</font> </td><td align="center">  <font>521</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3,3</font> </td><td align="center">  <font>-59</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>6 6</font> </td><td align="center">  <font>115</font> </td><td align="center">  <font>0 0</font> </td><td align="center">  <font>3,3</font> </td><td align="center">  <font>-62</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>7 7</font> </td><td align="center">  <font>316</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3,3</font> </td><td align="center">  <font>-63</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>8</font> </td><td align="center">  <font>419</font> </td><td align="center">  <font color="#800000">1</font> </td><td align="center">  <font>3,3</font> </td><td align="center">  <font>-60</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>9 9</font> </td><td align="center">  <font>89</font> </td><td align="center">  <font>0 0</font> </td><td align="center">  <font>3,3</font> </td><td align="center">  <font>-68</font> </td></tr></tbody></table><br>  El sensor n. ¬∞ 10 se congela una vez.  Esto aparentemente condujo a una disminuci√≥n significativa en el voltaje de la bater√≠a.  La raz√≥n de la congelaci√≥n a√∫n no est√° clara.  Se cuelga de nuevo, tienes que resolverlo. <br><br>  El sensor n. ¬∞ 14 est√° instalado en la puerta frontal, por lo que tiene una gran cantidad de respuestas.  Pero una cantidad tan grande de viajes a√∫n no ha afectado el voltaje de la bater√≠a. <br><br>  Un evento perdido es cuando el sensor intent√≥ enviar un estado, pero el servidor no lo confirm√≥.  Todos los eventos perdidos se deben al hecho de que apagu√© el servidor durante aproximadamente medio d√≠a para la limpieza. <br><br>  La columna Median Strength Signal Strength muestra el valor medio de RSSI (en dBm), donde se obtiene cada valor individual despu√©s de recibir cada paquete.  El sensor con la mejor se√±al (No. 19, -56 dBm) se encuentra a una distancia de 2 metros en visibilidad directa desde el controlador de red, pero la antena en este sensor est√° plegada con un marco dentro de la carcasa.  El controlador de red en s√≠ est√° ubicado en la planta baja.  Sin embargo, la se√±al de los sensores del segundo piso es muy buena.  Esto se debe al hecho de que en todos los sensores del segundo piso, la antena se retira de la carcasa del sensor. <br><br><h3>  En lugar de un ep√≠logo </h3><br>  Por un lado, me alegro de que por mi cuenta, como hobby, haya resultado desde cero dise√±ar, ensamblar y ejecutar un sistema de este nivel.  Y a√∫n m√°s contento de que funcione mejor que el sistema "patentado" basado en la tecnolog√≠a zWave hype.  Tambi√©n hay espacio para desarrollar y mejorar este sistema.  Solo me corroen las peque√±as dudas.  Es decir, que una persona sin una educaci√≥n el√©ctrica especializada recolecta en su rodilla algo que funciona de manera m√°s confiable que los productos de marca conocidos en los c√≠rculos estrechos de las marcas IOT.  Probablemente, el progreso gir√≥ en alguna direcci√≥n equivocada. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/482858/">https://habr.com/ru/post/482858/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../482846/index.html">AirPods Pro, Apple TV + y mucho dinero: por qu√© las acciones de Apple alcanzaron un precio r√©cord</a></li>
<li><a href="../482848/index.html">Live bot, parte 2</a></li>
<li><a href="../482850/index.html">Perspectivas de los biocombustibles en la aviaci√≥n.</a></li>
<li><a href="../482852/index.html">La era del audio compacto: c√≥mo llegaron las cintas a los autom√≥viles</a></li>
<li><a href="../482856/index.html">Extra√±o Divino</a></li>
<li><a href="../482860/index.html">Fui jefe de relaciones internacionales en Google. Por eso me fui</a></li>
<li><a href="../482862/index.html">¬øHay un GameDev en Sakhalin? 1.V</a></li>
<li><a href="../482864/index.html">Videovigilancia en el hogar. Esquema de mantener un archivo de video sin un registrador casero</a></li>
<li><a href="../482866/index.html">¬øVale la pena comprar Bitcoin el pr√≥ximo a√±o y cu√°nto costar√°?</a></li>
<li><a href="../482870/index.html">C√≥mo compr√© una computadora port√°til bloqueada en eBay y trat√© de hacer mi AntiTheft basado en IntelAMT</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>