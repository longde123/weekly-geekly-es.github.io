<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐠 🌵 🙇 Python3。 多供应商网络设备配置自动化 🛌🏾 👩🏽‍💻 💛</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="前言 
 祝大家有美好的一天！ 

 我是一家大型电信运营商的网络工程师，在我的控制下，整个动物园遍布各种网络设备，但我们将讨论接入交换机。 

 本文不是行动指南，也不是唯一的解决方案，并且显然也不假装是年度提名的剧本，但我想分享这个创意，也许对某人有用。 

 本文将在扰流板下提供一个代码块，并...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Python3。 多供应商网络设备配置自动化</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/415453/"><h4> 前言 </h4><br> 祝大家有美好的一天！ <br><br> 我是一家大型电信运营商的网络工程师，在我的控制下，整个动物园遍布各种网络设备，但我们将讨论接入交换机。 <br><br> 本文不是行动指南，也不是唯一的解决方案，并且显然也不假装是年度提名的剧本，但我想分享这个创意，也许对某人有用。 <br><br> 本文将在扰流板下提供一个代码块，并在下面进行剪辑和说明，并说明其原因和用途。 <br><br><h4> 挑战赛 </h4><br> 专门使用python3。 该脚本应该能够从列表中转到交换机，确定哪种供应商，给出所需的命令，进行日志。 <br><br><h4> 其实我怎么来的 </h4><br> 面对在大量交换机上更改配置的小问题，我将立即对我们拥有的网络设备的集中管理系统保留一下，我的同事也有许多以脚本形式进行开发以方便手动工作的工具，主要是bash，perl。 <br><br> 但是对我来说，做点不同的事情很重要，因为 我最近开始学习python，我需要提高编程技能，并且我的工具应该看起来像锤子（易于使用且易于维护）。 如果仍然有兴趣，那么我要猫。 <br><a name="habracut"></a><br> 谷歌搜索并没有找到合适的解决方案（好像在论坛上提出了这个问题，但那里一切都错了），我决定开始编写自己的脚本。 <br><br> 我们有以下开关： <br><br><ul><li>  Raisecom </li><li>  Qtech版本  1.0 </li><li>  Qtech版本  2.0（语法差异） </li><li>  Eltex </li><li>  D链接 </li><li> 用Qtech版本1.0的枪口产生弗兰肯斯坦开关，而Raisecom的铁杆我们称之为ROS </li></ul><br> 首先，导入所需的库： <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> telnetlib <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> getpass <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pexpect <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> telnetlib <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Telnet <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> subprocess</code> </pre> <br> 最初，我们描述供应商定义功能，因为 决定使用两种方法： <br><br>  1）假设它是哪种类型的供应商（应邀输入登录名），因为我注意到每个人都不同：Qtech（登录:)，Raisecom和ROS（登录:)，Eltex（用户名:)，D-link（用户名）。 <br><br>  2）登录后-确保第一项均已正确完成，并能更好地识别我们所处的开关。 <br><br><div class="spoiler">  <b class="spoiler_title">功能介绍</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">who_is</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#   global ver_status global sab_versus global versus sab_versus='' ver_status='' versus='' #  a = 'Serial No.:1405' # #qtech rev1 d = 'Command: show switch' # #d-link f = 'Raisecom Operating System Software' # #raisecom h = 'QOS' # #raisecom-qtech j = 'MES1124M' # #eltex k = 'eltex' # #eltex n = 'Build245' #qtech2.0 parser=open('servers_&amp;_log/ver.txt', 'r') #  for line in parser.readlines(): line1 = line.find(a) line4 = line.find(d) line5 = line.find(f) line6 = line.find(h) line7 = line.find(j) line8 = line.find(k) line10 = line.find(n) if line1 != -1: ver_status='qtech_rev_1.0' if line4 != -1: ver_status='d-link' if line5 != -1: ver_status='raisecom' if line6 != -1: ver_status='raisecom-qtech' sab_versus=1 if line7 !=-1: ver_status='eltex' if line8 !=-1: ver_status='eltex' if line10 != -1: ver_status = 'qtech_rev_2.0' time.sleep(0.1) parser.close() os.remove('servers_&amp;_log/ver.txt') return ver_status,sab_versus</span></span></code> </pre> <br></div></div><br> 整个功能在扰流板之下。 我们声明对整个脚本可见的全局变量： <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">global</span></span> ver_status <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> sab_versus <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> versus</code> </pre> <br> 变量a，d，f，h，j，k，n存储关键字，通过这些关键字我们随后将确定开关的模型。 <br><br><pre> <code class="python hljs">a = <span class="hljs-string"><span class="hljs-string">'Serial No.:1405'</span></span> <span class="hljs-comment"><span class="hljs-comment"># #qtech rev1 d = 'Command: show switch' # #d-link f = 'Raisecom Operating System Software' # #raisecom h = 'QOS' # #raisecom-qtech j = 'MES1124M' # #eltex k = 'eltex' # #eltex n = 'Build245' #qtech2.0</span></span></code> </pre> <br> 打开ver.txt文件后，我们逐行读取并检查关键字输入，因为 如果此结果为负，则find（）函数返回-1，我们将建立分支。 <br><br><pre> <code class="python hljs">parser=open(<span class="hljs-string"><span class="hljs-string">'servers_&amp;_log/ver.txt'</span></span>, <span class="hljs-string"><span class="hljs-string">'r'</span></span>) <span class="hljs-comment"><span class="hljs-comment">#  for line in parser.readlines(): line1 = line.find(a) line4 = line.find(d) line5 = line.find(f) line6 = line.find(h) line7 = line.find(j) line8 = line.find(k) line10 = line.find(n) if line1 != -1: ver_status='qtech_rev_1.0'</span></span></code> </pre> <br>  ... <br><br> 我给出了代码的示例部分，其余部分在上面的扰流器下。 <br><br> 该文件的内容将在下面描述。 在完成所有操作并定义了供应商之后，删除ver.txt文件。 <br><br><div class="spoiler">  <b class="spoiler_title">主变量声明，主循环主体</b> <div class="spoiler_text"><pre> <code class="python hljs">user=<span class="hljs-string"><span class="hljs-string">'user'</span></span> password=<span class="hljs-string"><span class="hljs-string">'password'</span></span> komm=open(<span class="hljs-string"><span class="hljs-string">'servers_&amp;_log/komm.txt'</span></span>) log=open(<span class="hljs-string"><span class="hljs-string">'servers_&amp;_log/log.txt'</span></span>,<span class="hljs-string"><span class="hljs-string">'a'</span></span>) <span class="hljs-comment"><span class="hljs-comment">######### counter_komm=0 counter_dlink=0 counter_qtech=0 counter_eltex=0 counter_raisecom=0 counter_ROS=0 counter_qtech1_0=0 counter_qtech2_0=0 ########## for host in komm.readlines(): print('connect....',host) vend = '' response = os.system('ping -c 1 ' + host) verinfo = open('servers_&amp;_log/ver.txt', 'w') ver_status = '' sab_versus = '' if response == 0: telnet = pexpect.spawn('telnet ' + host,timeout=40) vend = telnet.expect(['login:', 'Login:', 'User Name:', 'Username']) telnet.close() tn = Telnet(host.replace('\n', ''), 23,30) try: print('Ok'+'\n') tn.read_until(b':') tn.write((user +'\n').encode('ascii')) tn.read_until(b':') tn.write((password + '\n').encode('ascii')) time.sleep(3) tn.read_until(b'#',timeout=20) except: print('connection refused' + '\n') f = open('servers_&amp;_log/log.txt', 'a') print(host, 'connection refused', file=log) print('#' * 100, host, file=log) ###   ######################################################### if vend == 0:#    Qtech tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=verinfo) verinfo.close() who_is() ...</span></span></code> </pre> <br></div></div><br> 我决定不打扰，并在正文中使用用户名和密码设置变量，我知道这不是安全的，我正在努力。 <br><br> 打开日志文件和开关列表 <br><br><pre> <code class="python hljs">komm=open(<span class="hljs-string"><span class="hljs-string">'servers_&amp;_log/komm.txt'</span></span>) log=open(<span class="hljs-string"><span class="hljs-string">'servers_&amp;_log/log.txt'</span></span>,<span class="hljs-string"><span class="hljs-string">'a'</span></span>)</code> </pre> <br> 在使用for循环之后，读取带有交换机ip地址的行 <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> host <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> komm.readlines(): print(<span class="hljs-string"><span class="hljs-string">'connect....'</span></span>,host) vend = <span class="hljs-string"><span class="hljs-string">''</span></span></code> </pre><br> 我们检查它的可用性 <br><br><pre> <code class="python hljs">response = os.system(<span class="hljs-string"><span class="hljs-string">'ping -c 1 '</span></span> + host)</code> </pre> <br> 如果可以使用pexpect库访问它，我们将在此迭代中尝试通过telnet进行连接，并在邀请时进行第一次检查，这是我在开始时写到的。 <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> response == <span class="hljs-number"><span class="hljs-number">0</span></span>: telnet = pexpect.spawn(<span class="hljs-string"><span class="hljs-string">'telnet '</span></span> + host,timeout=<span class="hljs-number"><span class="hljs-number">40</span></span>) vend = telnet.expect([<span class="hljs-string"><span class="hljs-string">'login:'</span></span>, <span class="hljs-string"><span class="hljs-string">'Login:'</span></span>, <span class="hljs-string"><span class="hljs-string">'User Name:'</span></span>, <span class="hljs-string"><span class="hljs-string">'Username'</span></span>]) telnet.close() tn = Telnet(host.replace(<span class="hljs-string"><span class="hljs-string">'\n'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>), <span class="hljs-number"><span class="hljs-number">23</span></span>,<span class="hljs-number"><span class="hljs-number">30</span></span>)</code> </pre><br>  vend变量的值将介于0到3之间（含0和3），并且根据看到的登录提示，将形成另一个分支。 <br><br> 从这段代码中，细心的读者可能会注意到我正在与交换机建立连接并立即关闭连接，这并非没有道理。 我尝试仅使用telnetlib库，但是在第一次测试中，该脚本会定期卡住，并因超时而掉落，这对我们很有帮助。 <br><br> 关闭连接后，我们仅使用telnetlib库进行重新连接。 <br><br> 为了避免出错，我们已经在上面检查了该开关是否可访问，并排除了由于一个空闲开关而在操​​作期间导致脚本中断的问题，请尝试将所有内容包装在try除块之外。 <br><br> 反复出现的情况是，在100台交换机中，有1台不让自己进入。 <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: print(<span class="hljs-string"><span class="hljs-string">'Ok'</span></span>+<span class="hljs-string"><span class="hljs-string">'\n'</span></span>) tn.read_until(<span class="hljs-string"><span class="hljs-string">b':'</span></span>) tn.write((user +<span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>)) tn.read_until(<span class="hljs-string"><span class="hljs-string">b':'</span></span>) tn.write((password + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>)) time.sleep(<span class="hljs-number"><span class="hljs-number">3</span></span>) tn.read_until(<span class="hljs-string"><span class="hljs-string">b'#'</span></span>,timeout=<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: print(<span class="hljs-string"><span class="hljs-string">'connection refused'</span></span> + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) f = open(<span class="hljs-string"><span class="hljs-string">'servers_&amp;_log/log.txt'</span></span>, <span class="hljs-string"><span class="hljs-string">'a'</span></span>) print(host, <span class="hljs-string"><span class="hljs-string">'connection refused'</span></span>, file=log) print(<span class="hljs-string"><span class="hljs-string">'#'</span></span> * <span class="hljs-number"><span class="hljs-number">100</span></span>, host, file=log)</code> </pre> <br>  ... <br> 如果一切正常，并且我们已建立连接，那么我们需要输入用户名和密码， <br> 我们肯定知道任何冒号提示都使用冒号。 <br><br> 所以我们在等他 <br><br><pre> <code class="python hljs">tn.read_until(<span class="hljs-string"><span class="hljs-string">b':'</span></span>)</code> </pre> <br> 输入登录名后 <br><br><pre> <code class="python hljs">tn.write((user +<span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>))</code> </pre> <br> 等待密码冒号 <br><br><pre> <code class="python hljs">tn.read_until(<span class="hljs-string"><span class="hljs-string">b':'</span></span>)</code> </pre> <br> 输入密码 <br><br><pre> <code class="python hljs">tn.write((password + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>))</code> </pre> <br> 然后我们等待3秒（尽管如此，否则我们做了很多工作） <br><br><pre> <code class="python hljs">time.sleep(<span class="hljs-number"><span class="hljs-number">3</span></span>)</code> </pre> <br> 等待邀请后 <br><br><pre> <code class="python hljs">tn.read_until(<span class="hljs-string"><span class="hljs-string">b'#'</span></span>,timeout=<span class="hljs-number"><span class="hljs-number">20</span></span>)</code> </pre> <br> 在此阶段，我们进入第二级以检查供应商。 <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> vend == <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-comment"><span class="hljs-comment">#    Qtech tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=verinfo) verinfo.close() who_is()</span></span></code> </pre> <br> 因为 我们以为我们到达了Qtech，如果您仔细阅读，则在我们的动物园中有两种版本的qtech语法不同，我们仍然需要调和。 <br><br> 因此，我们给出show ver命令，将所有输出放入ver.txt文件 <br> 并调用如上所述的who_is（）过程。 表演团队对所有Qtech，Raisecom，Eltex， <br><br> 不幸的是，D-link并不理解，他需要说点swich，但是我们很聪明，并没有白费力气地使用假定的供应商定义进行迭代。 <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> vend == <span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-comment"><span class="hljs-comment">#   D-link tn.write(('show sw' + '\n').encode('ascii')) tn.write(('a' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=verinfo) verinfo.close() who_is()</span></span></code> </pre><br> 因此，立即在输入show swich后打了一个小字，该开关显示不完整的信息，并等待用户按任意键以进一步输出，因此，我们然后发送“ a”字符以显示完整的信息。 <br><br><pre> <code class="python hljs">tn.write((<span class="hljs-string"><span class="hljs-string">'a'</span></span> + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>))</code> </pre> <br> 为避免这种情况，您可以关闭clipadding <br><br> 这是供应商验证结束的地方，我们可以以99％的概率假定我们已经正确识别了交换机的型号，然后可以继续进行配置。 <br><br> 对于每个开关，我们都有一个单独的文件，其中包含一组命令。 <br><br><div class="spoiler">  <b class="spoiler_title">配置块</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">... </span></span><span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> ver_status == <span class="hljs-string"><span class="hljs-string">'qtech_rev_1.0'</span></span>: tn.write((<span class="hljs-string"><span class="hljs-string">'show ver'</span></span> + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>)) print((tn.read_until(<span class="hljs-string"><span class="hljs-string">b'#'</span></span>).decode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>)), file=log) counter_qtech1_0+=<span class="hljs-number"><span class="hljs-number">1</span></span> komand_qtech1_0=open(<span class="hljs-string"><span class="hljs-string">'servers_&amp;_log/komand_qtech_ver1.0.txt'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> kommand <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> komand_qtech1_0.readlines(): tn.write((kommand.replace(<span class="hljs-string"><span class="hljs-string">'\n'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>)) tn.write((<span class="hljs-string"><span class="hljs-string">'exit'</span></span> + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>)) print(tn.read_all().decode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>), file=log) print(<span class="hljs-string"><span class="hljs-string">'   qtech1.0'</span></span>) print(<span class="hljs-string"><span class="hljs-string">'Qtech rev1.0 '</span></span> + host, file=log) print(<span class="hljs-string"><span class="hljs-string">'#'</span></span> * <span class="hljs-number"><span class="hljs-number">100</span></span>, file=log) <span class="hljs-comment"><span class="hljs-comment">################################################################################ elif ver_status == 'qtech_rev_2.0': tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) counter_qtech2_0+=1 komand_qtech2_0=open('servers_&amp;_log/komand_qtech_ver2.0.txt') print('   qtech2.0') for kommand in komand_qtech2_0.readlines(): tn.write((kommand.replace('\n', '') + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) print('Qtech rev2.0 ' + host, file=log) print('#' * 100, file=log) ...</span></span></code> </pre><br></div></div><br> 函数计算完并返回ver_status变量后，我们可以继续进行分支工作，因为 我们确切知道当前正在使用哪个开关。 <br> 首先，我们给switch命令show ver，并将输出写入日志（关于d-link，记住我们给它命令sh sw） <br><br><pre> <code class="python hljs">tn.write((<span class="hljs-string"><span class="hljs-string">'show ver'</span></span> + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>)) print((tn.read_until(<span class="hljs-string"><span class="hljs-string">b'#'</span></span>).decode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>)), file=log)</code> </pre> <br> 确保保留计数器以识别不符合项。 <br><pre> <code class="python hljs">counter_qtech1_0+=<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br> 我们用命令打开一个文件 <br><pre> <code class="python hljs">komand_qtech1_0=open(<span class="hljs-string"><span class="hljs-string">'servers_&amp;_log/komand_qtech_ver1.0.txt'</span></span>)</code> </pre> <br> 文件中命令的顺序必须与管理员手动输入的顺序相同 <br><br> 一个例子： <br><br> <code>conf <br> vlan 2525 <br> name SPD <br> int ethe 1/1 <br> sw mode access <br> sw acc vl 2525 <br> exit <br> exit <br> save <br> y <br></code> <br> 然后一切都取决于场景-我们读取文件直到行结束并执行它们 <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> kommand <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> komand_qtech1_0.readlines(): tn.write((kommand.replace(<span class="hljs-string"><span class="hljs-string">'\n'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>))</code> </pre> <br> 退出循环后，我们告诉交换机退出并将所有输出读取到文件中，因此我们仅使用qtech1.0，因为 有时，脚本会预料到某些事情，并且这种切换就是这样，以免大惊小怪，这种解决方案在我看来似乎更优雅。 <br><br> 配置完交换机后，我们将总计数器增加一。 <br><br><pre> <code class="python hljs">counter_komm+=<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br> 然后，我们重新开始，使用开关从文件中读取下一行，确定模型并进行配置。 <br><br> 退出主要周期后，您需要总结已完成的工作， <br> 在日志末尾，我们输入所有处理过的模型，并且日期是必填项，那么，如果没有日期，该怎么办。 <br><br><pre> <code class="python hljs">print(<span class="hljs-string"><span class="hljs-string">'\n\n\n : '</span></span>, counter_komm,file=log) print(<span class="hljs-string"><span class="hljs-string">'\n\nD-link:'</span></span>, counter_dlink,<span class="hljs-string"><span class="hljs-string">'\nQtech ver1.0:'</span></span>, counter_qtech1_0,<span class="hljs-string"><span class="hljs-string">'\nROS:'</span></span>, counter_ROS,<span class="hljs-string"><span class="hljs-string">'\nRaisecom:'</span></span>,counter_raisecom,<span class="hljs-string"><span class="hljs-string">'\nEltex:'</span></span>, counter_eltex,<span class="hljs-string"><span class="hljs-string">'\nQtech ver2.0 :'</span></span>, counter_qtech2_0,file=log) print(<span class="hljs-string"><span class="hljs-string">'\n: '</span></span>, datetime.datetime.now().isoformat(),<span class="hljs-string"><span class="hljs-string">'\n'</span></span>, <span class="hljs-string"><span class="hljs-string">'#'</span></span>*<span class="hljs-number"><span class="hljs-number">100</span></span>,<span class="hljs-string"><span class="hljs-string">'\n\n\n\n\n'</span></span>,file=log) verinfo.close() log.close()</code> </pre> <br> 该脚本已被重复处理，并且该过程不会在那里停止。 <br> 谢谢大家的关注。 欢迎进行建设性的批评。 <br><br> 所有代码都在扰流器下。 <br><br><div class="spoiler">  <b class="spoiler_title">源代码</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python3 #22/06/2017 17:17 import telnetlib import time import os import sys import getpass import pexpect from telnetlib import Telnet import datetime import subprocess def who_is(): #     ,      . global ver_status global sab_versus global versus sab_versus='' ver_status='' versus='' a = 'Serial No.:1405' # #qtech rev1 #b = 'Serial No.:3922' # #qtech rev2 #c = 'Serial No.:5436' # #qtech rev2 #l = 'Serial No.:16101' # #qtech rev2 d = 'Command: show switch' # #d-link f = 'Raisecom Operating System Software' # #raisecom h = 'QOS' # #raisecom-qtech j = 'MES1124M' # #eltex k = 'eltex' # #eltex n = 'Build245' #qtech2.0 parser=open('servers_&amp;_log/ver.txt', 'r') for line in parser.readlines(): line1 = line.find(a) #line2 = line.find(b) #line3 = line.find(c) line4 = line.find(d) line5 = line.find(f) line6 = line.find(h) line7 = line.find(j) line8 = line.find(k) #line9 = line.find(l) line10 = line.find(n) if line1 != -1: ver_status='qtech_rev_1.0' #if line2 != -1 or line3 != -1 or line9 !=-1: #ver_status='qtech_rev_2.0' if line4 != -1: ver_status='d-link' if line5 != -1: ver_status='raisecom' if line6 != -1: ver_status='raisecom-qtech' sab_versus=1 if line7 !=-1: ver_status='eltex' if line8 !=-1: ver_status='eltex' if line10 != -1: ver_status = 'qtech_rev_2.0' time.sleep(0.1) parser.close() os.remove('servers_&amp;_log/ver.txt') return ver_status,sab_versus user='user' password='password' komm=open('servers_&amp;_log/komm.txt') log=open('servers_&amp;_log/log.txt','a') counter_komm=0 counter_dlink=0 counter_qtech=0 counter_eltex=0 counter_raisecom=0 counter_ROS=0 # counter_qtech1_0=0 counter_qtech2_0=0 for host in komm.readlines(): print('connect....',host) vend = '' #tn = Telnet(host.replace('\n', ''), 23, 20) response = os.system('ping -c 1 ' + host) verinfo = open('servers_&amp;_log/ver.txt', 'w') ver_status = '' sab_versus = '' if response == 0: telnet = pexpect.spawn('telnet ' + host,timeout=40) vend = telnet.expect(['login:', 'Login:', 'User Name:', 'Username']) telnet.close() tn = Telnet(host.replace('\n', ''), 23,30) try: print('Ok'+'\n') tn.read_until(b':') tn.write((user +'\n').encode('ascii')) tn.read_until(b':') tn.write((password + '\n').encode('ascii')) time.sleep(3) tn.read_until(b'#',timeout=20) except: print('connection refused' + '\n') f = open('servers_&amp;_log/log.txt', 'a') print(host, 'connection refused', file=log) print('#' * 100, host, file=log) ###   ################################################################################ if vend == 0:#    Qtech tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=verinfo) verinfo.close() who_is() ################################################################################ if vend == 1: #   Raisecom,Raisecom-Qtech tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=verinfo) verinfo.close() who_is() ################################################################################ if vend == 2:#   Eltex tn.write(('show system' + '\n').encode('ascii')) tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=verinfo) verinfo.close() who_is() ################################################################################ if vend == 3:#   D-link tn.write(('show sw' + '\n').encode('ascii')) tn.write(('a' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=verinfo) verinfo.close() who_is() # ###  # ################################################################################ if ver_status == 'd-link': tn.read_until(b'#', timeout=20) tn.write(('show sw' + '\n').encode('ascii')) tn.write(('a' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) print('D-link ' + host,file=log) print('#'*100,file=log) counter_dlink+=1 ################################################################################ elif ver_status == 'qtech_rev_1.0': tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) counter_qtech1_0+=1 komand_qtech1_0=open('servers_&amp;_log/komand_qtech_ver1.0.txt') for kommand in komand_qtech1_0.readlines(): tn.write((kommand.replace('\n', '') + '\n').encode('ascii')) #print((tn.read_until(b'#').decode('ascii')), file=log) tn.write(('exit' + '\n').encode('ascii')) print(tn.read_all().decode('ascii'), file=log) print('Qtech rev1.0 ' + host, file=log) print('#' * 100, file=log) ################################################################################ elif ver_status == 'qtech_rev_2.0': tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) counter_qtech2_0+=1 komand_qtech2_0=open('servers_&amp;_log/komand_qtech_ver2.0.txt') for kommand in komand_qtech2_0.readlines(): tn.write((kommand.replace('\n', '') + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) time.sleep(1) print('Qtech rev2.0 ' + host, file=log) print('#' * 100, file=log) ################################################################################ elif ver_status == 'raisecom-qtech': tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) raisecom_command = open('servers_&amp;_log/komand_raisecom.txt') for komand in raisecom_command.readlines(): tn.write((komand.replace('\n', '') + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) print('ROS '+ host,file=log) print('#'*100,file=log) counter_ROS+=1 ################################################################################ elif ver_status == 'raisecom': tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) counter_raisecom+=1 raisecom_command = open('servers_&amp;_log/komand_raisecom.txt') for komand in raisecom_command.readlines(): tn.write((komand.replace('\n', '') + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) print(host, ':', 'RAISECOM', file=log) print('#' * 100, host, file=log) ################################################################################ elif ver_status == 'eltex': tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) eltex_command=open('servers_&amp;_log/komand_eltex.txt') for komand in eltex_command.readlines(): tn.write((komand.replace('\n', '') + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) print('Eltex ' + host, file=log) print('#' * 100, file=log) counter_eltex+=1 else: print('no ping') counter_komm+=1 print('\n\n\n : ', counter_komm,file=log) print('\n\nD-link:', counter_dlink,'\nQtech ver1.0:', counter_qtech1_0,'\nROS:', counter_ROS,'\nRaisecom:',counter_raisecom,'\nEltex:', counter_eltex,'\nQtech ver2.0 :', counter_qtech2_0,file=log) print('\n: ', datetime.datetime.now().isoformat(),'\n', '#'*100,'\n\n\n\n\n',file=log) verinfo.close() log.close()</span></span></code> </pre><br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN415453/">https://habr.com/ru/post/zh-CN415453/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN415441/index.html">在美国，对政府机构的勒索软件攻击越来越多</a></li>
<li><a href="../zh-CN415443/index.html">MDG和ITMO大学邀请参加机器学习暑期学校</a></li>
<li><a href="../zh-CN415445/index.html">2018年7月IT领域人力资源专业人员的事件摘要</a></li>
<li><a href="../zh-CN415447/index.html">实用程序令牌发行是死胡同</a></li>
<li><a href="../zh-CN415451/index.html">Biostar Racing P1：从简单到复杂</a></li>
<li><a href="../zh-CN415455/index.html">问伊森：我们可以做一个太阳能屏来应对气候变化吗？</a></li>
<li><a href="../zh-CN415457/index.html">找到存在新的基本粒子的证据</a></li>
<li><a href="../zh-CN415459/index.html">中国人有迷信吗？</a></li>
<li><a href="../zh-CN415461/index.html">OpenAI在Dota 2中取得进步：半专业团队被击败</a></li>
<li><a href="../zh-CN415463/index.html">HPE Superdome Flex：性能和扩展的新水平</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>