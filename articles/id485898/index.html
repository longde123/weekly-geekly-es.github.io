<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçç ‚ò™Ô∏è üìÑ Ekspor Formulir Google + unduh Google Script melalui REST API (Python) üìâ üë©üèø‚Äçü§ù‚Äçüë®üèª üè®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kami memiliki dua formulir google, masing-masing 75 pertanyaan, 5 pengguna bisnis yang secara aktif mengedit formulir ini, dan juga skrip google yang ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ekspor Formulir Google + unduh Google Script melalui REST API (Python)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485898/"><img src="https://habrastorage.org/webt/gi/tl/nl/gitlnlklzpbmybk3jz3utl4_uow.png"><br><br>  Kami memiliki dua formulir google, masing-masing 75 pertanyaan, 5 pengguna bisnis yang secara aktif mengedit formulir ini, dan juga skrip google yang mengekspor formulir ke JSON.  Bukan berarti akan sulit untuk menjalankannya setiap kali dengan tangan Anda, tetapi begitu Anda mulai mengotomatisasi pekerjaan Anda, maka pergilah dalam hobi ini sampai akhir. <br><br>  Dalam dokumentasi resmi, iblis akan mematahkan kakinya, jadi di bawah kucing kita akan melihat lebih dekat pada unduhan jarak jauh dan peluncuran Google Apps Script melalui REST API menggunakan Python. <br><a name="habracut"></a><br><h2>  Pendahuluan </h2><br>  Di Dokter Dekat, kami sedang mengembangkan platform untuk bot obrolan, di mana formulir Google digunakan untuk menggambarkan skenario.  Oleh karena itu, saya ingin menerima dari formulir di klik tombol JSON yang berisi node (form points) dan metadata ke mereka (transisi antara node, jenis node, nama mereka).  Tampaknya keinginannya sederhana, tetapi Google tidak mendukung fungsi ini dan Anda harus mengumpulkan "pengekspor" ini dengan tangan Anda sendiri.  Pertimbangkan langkah-langkah untuk membuatnya. <br><br><h2>  LANGKAH 1. Skrip Google Apps </h2><br>  Google telah menyediakan kemampuan untuk berinteraksi dengan layanannya (Lembar, Dokumen, Formulir) melalui Google Apps Script - skrip yang ditulis dalam skrip google (.gs).  Artikel ini tidak menyediakan penguraian bahasa skrip google, jadi saya akan memberikan contoh skrip siap pakai yang membuat JSON dari formulir Google yang ada.  <a href="" rel="nofollow">Kode</a> pengguna <a href="https://github.com/stevenschmatz" rel="nofollow">Steven Schmatz</a> diambil dari github sebagai dasar, yang untuknya saya mengucapkan terima kasih kepadanya. <br><br><div class="spoiler">  <b class="spoiler_title">Kode skrip</b> <div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// Steven Schmatz // Humanitas Labs // 13 October, 2016. // Roman Shekhovtsov // dr-telemed.ru // Autumn 2019 // Nikita Orekhov // dr-telemed.ru // Autumn 2019 /** * Converts the given form URL into a JSON object. */ function main() { form_url = "&lt;YOUR_FORM_URL&gt;" var form = FormApp.openByUrl(form_url); var items = form.getItems(); var result = { "metadata": getFormMetadata(form), "items": items.map(itemToObject), "count": items.length }; // sendEmail("&lt;YOUR_EMAIL&gt;", result) return result; } /** If we want to receive data by email * Sends JSON as text to recipient email * @param recipient: String * @param result: JSON */ function sendEmail(recipient, json_file){ var subject = "google form json import" var body = JSON.stringify(json_file); Logger.log(body); MailApp.sendEmail(recipient, subject, body); } /** * Returns the form metadata object for the given Form object. * @param form: Form * @returns (Object) object of form metadata. */ function getFormMetadata(form) { return { "title": form.getTitle(), "id": form.getId(), "description": form.getDescription(), "publishedUrl": form.getPublishedUrl(), "editorEmails": form.getEditors().map(function(user) { return user.getEmail() }), "count": form.getItems().length, "confirmationMessage": form.getConfirmationMessage(), "customClosedFormMessage": form.getCustomClosedFormMessage() }; } /** * Returns an Object for a given Item. * @param item: Item * @returns (Object) object for the given item. */ function itemToObject(item) { var data = {}; data.type = item.getType().toString(); // Downcast items to access type-specific properties var itemTypeConstructorName = snakeCaseToCamelCase("AS_" + item.getType().toString() + "_ITEM"); var typedItem = item[itemTypeConstructorName](); // Keys with a prefix of "get" have "get" stripped var getKeysRaw = Object.keys(typedItem).filter(function(s) {return s.indexOf("get") == 0}); getKeysRaw.map(function(getKey) { var propName = getKey[3].toLowerCase() + getKey.substr(4); // Image data, choices, and type come in the form of objects / enums if (["image", "choices", "type", "alignment"].indexOf(propName) != -1) {return}; // Skip feedback-related keys if ("getFeedbackForIncorrect".equals(getKey) || "getFeedbackForCorrect".equals(getKey) || "getGeneralFeedback".equals(getKey)) {return}; var propValue = typedItem[getKey](); data[propName] = propValue; }); // Bool keys are included as-is var boolKeys = Object.keys(typedItem).filter(function(s) { return (s.indexOf("is") == 0) || (s.indexOf("has") == 0) || (s.indexOf("includes") == 0); }); boolKeys.map(function(boolKey) { var propName = boolKey; var propValue = typedItem[boolKey](); data[propName] = propValue; }); // Handle image data and list choices switch (item.getType()) { case FormApp.ItemType.LIST: case FormApp.ItemType.CHECKBOX: data.choices = typedItem.getChoices().map(function(choice) { return choice.getValue() }); case FormApp.ItemType.MULTIPLE_CHOICE: data.choices = typedItem.getChoices().map(function(choice) { gotoPage = choice.getGotoPage() if (gotoPage == null) return choice.getValue() else return { "value": choice.getValue(), "gotoPage":choice.getGotoPage().getId() }; }); break; case FormApp.ItemType.IMAGE: data.alignment = typedItem.getAlignment().toString(); if (item.getType() == FormApp.ItemType.VIDEO) { return; } var imageBlob = typedItem.getImage(); data.imageBlob = { "dataAsString": "", //imageBlob.getDataAsString(), - BLOB too big "name": imageBlob.getName(), "isGoogleType": imageBlob.isGoogleType() }; break; case FormApp.ItemType.PAGE_BREAK: data.pageNavigationType = typedItem.getPageNavigationType().toString(); break; default: break; } // Have to do this because for some reason Google Scripts API doesn't have a // native VIDEO type if (item.getType().toString() === "VIDEO") { data.alignment = typedItem.getAlignment().toString(); } return data; } /** * Converts a SNAKE_CASE string to a camelCase string. * @param s: string in snake_case * @returns (string) the camelCase version of that string */ function snakeCaseToCamelCase(s) { return s.toLowerCase().replace(/(\_\w)/g, function(m) {return m[1].toUpperCase();}); }</span></span></code> </pre> <br></div></div><br>  Apa yang terjadi dalam kode: <br><br><ul><li>  fungsi <i>getFormMetadata</i> - mengembalikan JSON dengan form metadata </li><li>  Fungsi <i>itemToObject</i> - mengubah objek <i>form.item</i> ke JSON dengan bidang yang diperlukan </li><li>  fungsi <i>sendEmail</i> - mengirim file JSON ke email yang ditentukan dalam teks </li><li>  fungsi <i>utama</i> - mengembalikan JSON yang dihasilkan </li><li>  variabel <i>form_url</i> di fungsi <i>utama</i> adalah alamat formulir google kami </li></ul><br><h2>  LANGKAH 2. Menguji skrip </h2><br>  Saat ini, kinerja skrip dapat diperiksa sebagai berikut: <br><br><ol><li>  <a href="https://script.google.com/home/start" rel="nofollow">buat</a> proyek skrip aplikasi Anda sendiri </li><li>  salin kodenya ke dalamnya </li><li>  alih-alih <i>&lt;YOUR_FORM_URL&gt; kami</i> mengganti alamat formulir kami dari formulir <i><a href="https://docs.google.com/forms/d/FORM_IDENTIFICATOR/edit" rel="nofollow">docs.google.com/forms/d/FORM_IDENTIFICATOR/edit</a></i> </li><li>  batalkan komentar pada panggilan untuk <i>mengirimEmail</i> dalam fungsi <i>utama</i> </li><li>  alih-alih <i>&lt;YOUR_EMAIL&gt; kami</i> mengganti alamat email yang ingin kami terima JSON </li><li>  selamatkan proyek </li><li>  jalankan fungsi <i>utama</i> </li><li>  jika ini adalah skrip pertama yang dijalankan, sistem akan memberi tahu Anda tentang perlunya memberikan skrip izin untuk mengirim email dari alamat Anda.  Jangan takut.  Ini adalah prosedur standar yang diperlukan untuk menguji skrip.  Buka "Tinjau izin" -&gt; pilih akun Anda -&gt; "Tingkat Lanjut" -&gt; "Masuk ke proyek PROJECT_NAME (tidak aman)" -&gt; "Izinkan" </li><li>  menunggu skrip bekerja </li><li>  lihat di kotak surat dan lihat file JSON dalam bentuk teks </li></ol><br>  Semuanya akan baik-baik saja, tetapi penggunaan lebih lanjut dari data yang diperoleh melibatkan penyalinan manual dari surat, pemrosesan teks ini (dengan python, misalnya) dan menyimpan file yang dihasilkan.  Kedengarannya tidak terlalu siap produksi.  Kami mengotomatiskan peluncuran skrip ini dan mendapatkan hasilnya melalui API Skrip Google Apps, tetapi pertama-tama kami menyiapkan proyek Google kami sesuai dengan itu. <br><br>  <b>Perhatian:</b> Untuk kenyamanan memahami apa yang terjadi, di bawah ini saya akan merujuk hanya dua halaman, oleh karena itu disarankan untuk membukanya di tab yang berdekatan: <br><br><ol><li>  Halaman Skrip / Penyuntingan Script - <i>‚ÄúHalaman 1‚Äù</i> </li><li>  Google Cloud Platform Page - <i>‚ÄúHalaman 2‚Äù</i> </li></ol><br><h2>  LANGKAH 3. Konfigurasikan Platform Google Cloud </h2><br>  Kami pergi ke Google Cloud Platform (halaman 2), membuat proyek baru.  Diperlukan untuk membuat proyek baru, karena secara default status proyek adalah Default, dan Standart diperlukan untuk tujuan kita.  Rincian lebih lanjut dapat ditemukan di <a href="https://developers.google.com/apps-script/guides/cloud-platform-projects" rel="nofollow">sini</a> (poin 3). <br><br>  Kami kembali ke halaman 2, buka tab "API dan Layanan", lalu "Jendela Permintaan Akses OAuth".  Setel Jenis Pengguna ke "Eksternal." <br><br>  Di jendela yang muncul, isi "Nama Aplikasi". <br><br>  Buka halaman beranda di Google Cloud Platform.  Dari blok "Informasi Proyek" salin nomor proyek. <br><br>  Pergi ke halaman 1. Buka skrip yang dibuat sebelumnya.  Di jendela pengeditan skrip yang dibuka, buka "Sumber Daya" -&gt; "proyek Platform Cloud".  Di bidang "Ubah proyek", masukkan nomor proyek yang sebelumnya disalin.  Sekarang skrip ini dikaitkan dengan proyek yang dibuat. <br><br><h2>  LANGKAH 4. API Python REST </h2><br>  Saatnya untuk mengotomatiskan skrip menggunakan <a href="https://developers.google.com/apps-script/api/reference/rest" rel="nofollow">REST API</a> .  Python digunakan sebagai bahasa. <br><br><h3>  Login API Aplikasi Script </h3><br>  Kode harus memiliki akses ke proyek, sehingga prosedur pertama dan yang sangat penting adalah login di API Script Aplikasi.  Buka halaman 2 -&gt; "API dan Layanan" -&gt; "Kredensial" -&gt; "Buat Kredensial" -&gt; "Pengidentifikasi Klien OAuth" -&gt; "Jenis Lain".  Kami memanggil pengidentifikasi kami, buka.  Berada di tab "Kredensial", pilih "Unduh file JSON."  Ini akan memuat file kunci untuk akses dari kode ke proyek di Google.  Kami menempatkan file ini di folder kredensial. <br><br>  Sekarang Anda perlu memberikan izin untuk menggunakan API (dalam kasus kami, API Skrip Aplikasi) sebagai bagian dari proyek ini.  Untuk melakukan ini, buka "API dan Layanan" -&gt; "Perpustakaan" -&gt; ketik "Apps Script API" dalam pencarian dan klik "Aktifkan". <br><br>  Aplikasi yang berinteraksi dengan Google memiliki banyak izin yang harus diberikan pengguna saat meluncurkannya.  Salinan ini tergantung pada fungsi yang digunakan oleh skrip tertentu dan Anda dapat menemukannya dengan membuka halaman 1 di jendela pengeditan skrip di ‚ÄúFile‚Äù -&gt; ‚ÄúProject Properties‚Äù -&gt; ‚ÄúScopes‚Äù.  Izin ini harus disimpan untuk digunakan di masa depan dalam kode. <br><br>  Dalam hal ini, fungsi login akan terlihat seperti ini: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pickle <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os.path <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> googleapiclient.discovery <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> build <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google_auth_oauthlib.flow <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> InstalledAppFlow <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google.auth.transport.requests <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Request <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(config)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: creds = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-comment"><span class="hljs-comment"># The file token.pickle stores the user's access and refresh tokens, and is # created automatically when the authorization flow completes for the first # time. token_file = config['credentials_path'] + config['token_file'] credentials_file = config['credentials_path'] + config['credentials_file'] if os.path.exists(token_file): with open(token_file, 'rb') as token: creds = pickle.load(token) # If there are no (valid) credentials available, let the user log in. if not creds or not creds.valid: if creds and creds.expired and creds.refresh_token: creds.refresh(Request()) else: flow = InstalledAppFlow.from_client_secrets_file(credentials_file, config['SCOPES']) creds = flow.run_local_server(port=0) # Save the credentials for the next run with open(token_file, 'wb') as token: pickle.dump(creds, token) service = build('script', 'v1', credentials=creds) pprint('Login successful') return service except Exception as e: pprint(f'Login failure: {e}') return None</span></span></code> </pre><br>  Blok kode ini adalah prosedur standar untuk memulai dengan Google App Script. <br>  Kami menggunakan token otentikasi dan, dengan masuk, baik membuat token baru atau menggunakan yang sudah ada. <br><br>  Untuk kenyamanan, file konfigurasi JSON dibuat, yang memiliki bentuk berikut: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"SCOPES"</span></span>: [<span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/auth/forms"</span></span>, <span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/auth/script.send_mail"</span></span>], <span class="hljs-attr"><span class="hljs-attr">"credentials_path"</span></span>: <span class="hljs-string"><span class="hljs-string">"credentials/"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"credentials_file"</span></span>: <span class="hljs-string"><span class="hljs-string">"google_test_project.json"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"token_file"</span></span>: <span class="hljs-string"><span class="hljs-string">"token.pickle"</span></span> }</code> </pre><br>  <b>Penting:</b> token dibuat untuk otentikasi dengan ruang lingkup izin khusus.  Dengan kata lain, saat mengubah ruang lingkup izin, Anda harus menghapus token dan membuat token baru saat login. <br><br><h3>  Kode skrip pembaruan jarak jauh </h3><br>  Sekarang kita akan belajar cara memperbarui kode skrip dari jarak jauh, kemudian jalankan kode ini dan dapatkan hasilnya.  Bahkan, selain kode yang kami jalankan di editor Google, ada juga <a href="https://developers.google.com/apps-script/concepts/manifests" rel="nofollow">file manifes</a> yang berisi hak peluncuran, pengaturan penempatan, dll.  Informasi lebih lanjut tentang strukturnya dapat ditemukan di <a href="https://developers.google.com/apps-script/manifest/" rel="nofollow">sini</a> . <br>  Untuk melihat file manifes default yang dibuat oleh Google untuk skrip Anda, buka editor skrip di "Lihat" -&gt; "Tampilkan file manifes".  Manifes akan muncul di daftar file yang terkait dengan skrip ini. <br><br>  Pidato tentang manifes bukan tanpa alasan: pembaruan skrip jarak jauh memerlukan pengunduhan kode kedua file (* .gs) dan manifes (appscript.json). <br><br>  Pertama, baca kode file .gs yang ingin kita gunakan: <br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'export-google-form.gs'</span></span>, <span class="hljs-string"><span class="hljs-string">'r'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: sample_code = f.read()</code> </pre><br>  Sekarang salin manifes yang dibuat secara otomatis dan modifikasi sedikit untuk keperluan kita.  Dokumentasinya cukup komprehensif menggambarkan struktur file manifes, jadi saya tidak akan membahas hal ini.  Agar skrip berfungsi, Anda perlu menambahkan bagian "executionApi" ke manifes default, yang diperlukan untuk menjalankan skrip dari jarak jauh melalui API.  Di bagian ini kami menunjukkan lingkaran orang yang memiliki kemampuan untuk menjalankannya.  Saya telah mengizinkan peluncuran untuk semua yang telah lulus otorisasi, yang sesuai dengan pengidentifikasi "SIAPA PUN": <br><br><pre> <code class="python hljs">MANIFEST = <span class="hljs-string"><span class="hljs-string">''' { "timeZone": "America/New_York", "exceptionLogging": "STACKDRIVER", "executionApi": { "access": "ANYONE" } } '''</span></span>.strip()</code> </pre><br>  Badan permintaan pembaruan harus berisi larik file dengan struktur berikut: <br><br><ul><li>  <i>name</i> : nama file yang akan dibuat di server, tanpa ekstensi </li><li>  <i>ketik</i> : <i>jenis</i> file (JSON untuk manifes, SERVER_JS untuk .gs) </li><li>  <i>sumber</i> : kode file </li></ul><br><pre> <code class="python hljs">request = { <span class="hljs-string"><span class="hljs-string">'files'</span></span>: [{ <span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'hello'</span></span>, <span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'SERVER_JS'</span></span>, <span class="hljs-string"><span class="hljs-string">'source'</span></span>: sample_code }, { <span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'appsscript'</span></span>, <span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'JSON'</span></span>, <span class="hljs-string"><span class="hljs-string">'source'</span></span>: MANIFEST } ] }</code> </pre><br>  Akhirnya, permintaan pembaruan itu sendiri harus berisi isi (permintaan yang dijelaskan di atas) dan ID skrip.  Yang terakhir dapat diperoleh dengan pergi ke "File" -&gt; "Project Properties" di editor skrip dan menyalin "Script ID": <br><br><pre> <code class="python hljs">script_id = <span class="hljs-string"><span class="hljs-string">'qwertyuiopQWERTYUIOPasdfghjkl123456789zxcvbnmASDFGHJKL54'</span></span></code> </pre><br>  Untuk objek layanan yang diperoleh sebagai hasil dari login, kami mendapatkan bidang project () dan memanggil metode updateContent (), setelah itu kami memanggil metode execute () untuk objek HttpRequest yang diterima: <br><br><pre> <code class="python hljs">service.projects().updateContent( body=request, scriptId=script_id ).execute()</code> </pre><br>  Namun, untuk saat ini, menjalankan kode akan menghasilkan kesalahan: <br><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"error"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"code"</span></span>: <span class="hljs-number"><span class="hljs-number">403</span></span>, <span class="hljs-attr"><span class="hljs-attr">"message"</span></span>: <span class="hljs-string"><span class="hljs-string">"Request had insufficient authentication scopes."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"status"</span></span>: <span class="hljs-string"><span class="hljs-string">"PERMISSION_DENIED"</span></span> }</code> </pre><br>  Seperti yang Anda lihat, tidak ada cukup izin dalam osprey otentikasi, yang telah kami sebutkan sebelumnya.  Kami beralih ke dokumentasi resmi tentang API, yaitu metode <a href="https://developers.google.com/apps-script/api/reference/rest/v1/projects/updateContent" rel="nofollow">updateContent</a> , yang kami gunakan untuk memperbarui skrip dari jarak jauh.  Dokumentasi mengatakan bahwa menggunakan metode ini memerlukan akses yang memungkinkan ke script.projects: <br><br><pre> <code class="python hljs">https://www.googleapis.com/auth/script.projects</code> </pre> <br>  Tambahkan ke file konfigurasi kami di bagian RUANG LINGKUP.  Seperti yang saya tulis di atas, ketika mengubah osprey, perlu untuk menghapus token yang dihasilkan secara otomatis. <br><br>  Hebat!  Saat ini, kami telah belajar memperbarui skrip Google dari jarak jauh.  Tetap menjalankannya dan mendapatkan hasil eksekusi. <br><br><h3>  Jalankan skrip </h3><br>  Permintaan <a href="https://developers.google.com/apps-script/api/reference/rest/v1/scripts/run" rel="nofollow">peluncuran skrip</a> berisi skripID dan isi dengan struktur berikut: <br><br><ul><li>  <i>function</i> : nama fungsi yang ingin kita jalankan </li><li>  <i>parameter</i> : <i>(opsional) satu</i> set parameter dari tipe primitif (string, array ...) diteruskan ke fungsi </li><li>  <i>sessionState</i> : <i>(opsional)</i> hanya diperlukan untuk aplikasi Android </li><li>  <i>devMode</i> : <i>(opsional)</i> Benar jika pengguna adalah pemilik skrip dan kemudian versi terbaru akan diluncurkan daripada yang digunakan menggunakan Apps Script API.  (secara default - Salah) </li></ul><br>  Agar tidak menjahit URL formulir Google di skrip, kami akan meneruskan <i>form_url</i> ke fungsi <i>utama</i> sebagai argumen. <br><br>  <b>Perhatian</b>  Saat kami menguji skrip, fungsi <i>utama</i> tidak menerima apa pun, jadi kami akan mengubah baris kode pertama dalam file .gs sebagai berikut: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">form_url</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> form = FormApp.openByUrl(form_url); .......</code> </pre><br>  Karena aplikasi kami bukan untuk Android dan kami adalah pemilik skrip, maka tubuh akan terlihat seperti ini: <br><br><pre> <code class="python hljs">body = { <span class="hljs-string"><span class="hljs-string">"function"</span></span>: <span class="hljs-string"><span class="hljs-string">"main"</span></span>, <span class="hljs-string"><span class="hljs-string">"devMode"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">"parameters"</span></span>: form_url }</code> </pre><br>  Jalankan skrip dan tulis hasil eksekusi ke variabel resp: <br><br><pre> <code class="python hljs">resp = service.scripts().run(scriptId=script_id, body=body).execute()</code> </pre><br>  Simpan resp ke file dengan pemformatan JSON yang nyaman: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'habr_auto.json'</span></span>, <span class="hljs-string"><span class="hljs-string">'w'</span></span>, encoding=<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: json.dump(resp[<span class="hljs-string"><span class="hljs-string">'response'</span></span>][<span class="hljs-string"><span class="hljs-string">'result'</span></span>], f, ensure_ascii=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, indent=<span class="hljs-number"><span class="hljs-number">4</span></span>)</code> </pre><br>  <b>Perhatian</b>  Karena kenyataan bahwa permintaan script.run () sedang menunggu hasil melalui soket, ketika batas waktu terlampaui oleh waktu eksekusi, kesalahan dari tipe berikut akan terjadi: <br><br><pre> <code class="python hljs">socket.timeout: The read operation timed out</code> </pre><br>  Untuk menghindari perilaku ini, saya sarankan bahwa pada awal program menetapkan batas waktu soket terbuka, jelas cukup untuk menunggu skrip untuk menyelesaikan eksekusi.  Dalam kasus saya, 120 detik sudah cukup: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> socket socket.setdefaulttimeout(<span class="hljs-number"><span class="hljs-number">120</span></span>)</code> </pre><br>  Voila!  Jalur pipa yang nyaman untuk memperbarui dan meluncurkan skrip Google dari jarak jauh sudah siap.  Kode lengkap yang diadaptasi untuk peluncuran dari terminal diberikan di <a href="https://github.com/nikanor97/habr_google_script_api" rel="nofollow">github</a> saya. <br><br>  Juga, saya akan memberikan kode fungsi utama di bawah ini <br><br><div class="spoiler">  <b class="spoiler_title">login.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pprint <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pprint <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pickle <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os.path <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> googleapiclient.discovery <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> build <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google_auth_oauthlib.flow <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> InstalledAppFlow <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google.auth.transport.requests <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Request <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(config)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: creds = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-comment"><span class="hljs-comment"># The file token.pickle stores the user's access and refresh tokens, and is # created automatically when the authorization flow completes for the first # time. token_file = config['credentials_path'] + config['token_file'] credentials_file = config['credentials_path'] + config['credentials_file'] if os.path.exists(token_file): with open(token_file, 'rb') as token: creds = pickle.load(token) # If there are no (valid) credentials available, let the user log in. if not creds or not creds.valid: if creds and creds.expired and creds.refresh_token: creds.refresh(Request()) else: flow = InstalledAppFlow.from_client_secrets_file(credentials_file, config['SCOPES']) creds = flow.run_local_server(port=0) # Save the credentials for the next run with open(token_file, 'wb') as token: pickle.dump(creds, token) service = build('script', 'v1', credentials=creds) pprint('Login successful') return service except Exception as e: pprint(f'Login failure: {e}') return None</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">update_script.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pprint <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pprint <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> googleapiclient <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> errors <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google_habr_login <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> login MANIFEST = <span class="hljs-string"><span class="hljs-string">''' { "timeZone": "America/New_York", "exceptionLogging": "STACKDRIVER", "executionApi": { "access": "ANYONE" } } '''</span></span>.strip() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update_project</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(service, script_id, script_file_name)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># Read from file code we want to deploy with open(script_file_name, 'r') as f: sample_code = f.read() # Upload two files to the project request = { 'files': [{ 'name': 'hello', 'type': 'SERVER_JS', 'source': sample_code }, { 'name': 'appsscript', 'type': 'JSON', 'source': MANIFEST } ] } # Update files in the project service.projects().updateContent( body=request, scriptId=script_id ).execute() pprint('Project was successfully updated') def main(): try: args = sys.argv if len(args) != 4: raise TypeError('Wrong number of arguments. Three argument required: &lt;config_file_name&gt;, &lt;script_id&gt; and ' '&lt;script_file_name&gt;') config_file_name = args[1] script_id = args[2] script_file_name = args[3] with open(config_file_name, "r") as f: config = json.load(f) service = login(config) update_project(service, script_id, script_file_name) except (errors.HttpError, ) as error: # The API encountered a problem. pprint(error.content.decode('utf-8')) if __name__ == '__main__': main()</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">export_form.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pprint <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pprint <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> socket <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> googleapiclient <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> errors <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google_habr_login <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> login socket.setdefaulttimeout(<span class="hljs-number"><span class="hljs-number">120</span></span>) <span class="hljs-comment"><span class="hljs-comment"># Get JSON, which is returned by script def get_json(service, file_name, script_id, form_url): pprint('Exporting form...') body = { "function": "main", "devMode": True, "parameters": form_url } # Get JSON from script resp = service.scripts().run(scriptId=script_id, body=body).execute() # Write out JSON to file with open(file_name, 'w', encoding='utf-8') as f: json.dump(resp['response']['result'], f, ensure_ascii=False, indent=4) pprint('Form was successfully exported') def main(): try: args = sys.argv if len(args) != 5: raise TypeError('Wrong number of arguments. Four arguments required: &lt;config_file_name&gt;, ' '&lt;result_file_name&gt;, &lt;script_id&gt; and &lt;google_form_url&gt;') config_file_name = args[1] file_name = args[2] script_id = args[3] form_url = args[4] with open(config_file_name, "r") as f: config = json.load(f) service = login(config) get_json(service, file_name, script_id, form_url) except (errors.HttpError, ) as error: # The API encountered a problem. pprint(error.content.decode('utf-8')) if __name__ == '__main__': main()</span></span></code> </pre><br></div></div><br>  Untuk memulai, Anda harus meletakkan file JSON dengan kunci akses Google di folder kredensial, dan konfigurasi JSON di direktori yang sama dengan skrip. <br><br>  Kemudian, jika kita ingin memperbarui skrip dari jarak jauh, maka dalam panggilan terminal: <br><br><pre> <code class="bash hljs">python update_script.py &lt;config_file_name&gt; &lt;script_id&gt; &lt;script_file_name&gt;</code> </pre><br>  Dalam hal ini: <br><br><ul><li>  <i>config_file_name</i> - nama file JSON konfigurasi </li><li>  <i>script_id</i> - ID skrip </li><li>  <i>script_file_name</i> - nama file .gs yang akan diunggah ke google </li></ul><br>  Untuk menjalankan skrip, hubungi: <br><br><pre> <code class="bash hljs">python export_form.py &lt;config_file_name&gt; &lt;result_file_name&gt; &lt;script_id&gt; &lt;google_form_url&gt;</code> </pre><br>  Dalam hal ini: <br><br><ul><li>  <i>config_file_name</i> - nama file JSON konfigurasi </li><li>  <i>result_file_name</i> - nama file JSON di mana formulir akan dibongkar </li><li>  <i>script_id</i> - ID skrip </li><li>  <i>google_form_url</i> - google form url </li></ul><br>  Terima kasih atas perhatian Anda, menunggu saran dan komentar Anda :) </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id485898/">https://habr.com/ru/post/id485898/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id485876/index.html">Kami mempercepat OpenVPN pada router Openwrt. Versi alternatif tanpa menyolder besi dan ekstremisme keras</a></li>
<li><a href="../id485878/index.html">Urutan langkah-langkah untuk mengatur akuntansi manajemen pada platform JetCalc</a></li>
<li><a href="../id485884/index.html">Cara mengatur Imamat China</a></li>
<li><a href="../id485888/index.html">Pemalsuan permintaan server, operasi Blind SSRF</a></li>
<li><a href="../id485896/index.html">Basis data besar-besaran Greenplum - program pendidikan singkat</a></li>
<li><a href="../id485904/index.html">Muat Pengujian Rapat di Raiffeisenbank</a></li>
<li><a href="../id485908/index.html">Berkat kesalahan luar biasa di Ocarina of Time, dimungkinkan untuk menambahkan model dari Star Fox 64</a></li>
<li><a href="../id485910/index.html">Menyebarkan API dengan AWS Elastic Beanstalk</a></li>
<li><a href="../id485912/index.html">Mengapa translit dalam penamaan adalah fitur buruk dan menarik lainnya dari persepsi kita tentang kode</a></li>
<li><a href="../id485914/index.html">Didukung oleh ZeroTier. Panduan praktis untuk membangun jaringan virtual. Bagian 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>