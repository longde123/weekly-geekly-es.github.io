<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕞 👩🏽‍🌾 💯 Discovery.js-Handbuch: Schnellstart 🎚️ 📹 👆🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Diese und die folgenden Anleitungen führen Sie durch den Prozess der Erstellung einer Lösung basierend auf dem Discovery.js- Projekt. Unser Ziel ist e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Discovery.js-Handbuch: Schnellstart</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/469115/"><p> Diese und die folgenden Anleitungen führen Sie durch den Prozess der Erstellung einer Lösung basierend auf dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Discovery.js-</a> Projekt.  Unser Ziel ist es, einen Inspektor für NPM-Abhängigkeiten zu erstellen, <code>node_modules</code> eine Schnittstelle zur Untersuchung der Struktur von <code>node_modules</code> . </p><br><p><img src="https://habrastorage.org/webt/ih/d_/sc/ihd_schofzsmx1xbptuvltrxmu8.png"></p><br><blockquote>  Hinweis: Discovery.js befindet sich in einem frühen Entwicklungsstadium, sodass sich im Laufe der Zeit etwas vereinfacht und nützlicher wird.  Wenn Sie Ideen zur Verbesserung haben, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">schreiben Sie uns</a> . </blockquote><br><h2 id="annotaciya">  Anmerkung </h2><br><p>  Im Folgenden finden Sie eine Übersicht über die wichtigsten Konzepte von Discovery.js.  Sie können den gesamten manuellen Code <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">im Repository auf GitHub</a> lernen oder versuchen, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">wie er online funktioniert</a> . </p><a name="habracut"></a><br><h2 id="nachalnye-usloviya">  Ausgangsbedingungen </h2><br><p>  Zunächst müssen wir ein Projekt für die Analyse auswählen.  Dies kann ein frisch erstelltes oder ein vorhandenes Projekt sein. Hauptsache, es enthält <code>node_modules</code> (das Objekt unserer Analyse). </p><br><p>  Installieren Sie zunächst das Kernpaket von <code>discoveryjs</code> und seine Konsolentools: </p><br><pre> <code class="bash hljs">npm install @discoveryjs/discovery @discoveryjs/cli</code> </pre> <br><p>  Starten Sie als Nächstes den Discovery.js-Server: </p><br><pre> <code class="plaintext hljs">&gt; npx discovery No config is used Models are not defined (model free mode is enabled) Init common routes ... OK Server listen on http://localhost:8123</code> </pre> <br><p>  Wenn Sie <code>http://localhost:8123</code> im Browser öffnen, sehen Sie Folgendes: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/4e6/fc9/228/4e6fc922872955e6a2f3355e2856b3d1.png" alt="Erkennung ohne Konfiguration"></p><br><p>  Dies ist ein Modus ohne Modell, dh ein Modus, in dem nichts konfiguriert ist.  Mit der Schaltfläche "Daten laden" können Sie jetzt eine beliebige JSON-Datei auswählen oder einfach auf die Seite ziehen und die Analyse starten. </p><br><p>  Wir brauchen jedoch etwas Bestimmtes.  Insbesondere müssen wir uns einen Überblick über die Struktur <code>node_modules</code> .  Fügen Sie dazu die Konfiguration hinzu. </p><br><h2 id="dobavlyaem-konfiguraciyu">  Konfiguration hinzufügen </h2><br><p>  Wie Sie vielleicht bemerkt haben, <code>No config is used</code> beim Start des Servers die Meldung <code>No config is used</code> angezeigt.  Erstellen wir eine Konfigurationsdatei <code>.discoveryrc.js</code> mit den folgenden Inhalten: </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'Node modules structure'</span></span>, data() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">hello</span></span>: <span class="hljs-string"><span class="hljs-string">'world'</span></span> }; } };</code> </pre> <br><p>  Hinweis: Wenn Sie eine Datei im aktuellen Arbeitsverzeichnis (dh im Stammverzeichnis des Projekts) erstellen, ist nichts anderes erforderlich.  Andernfalls müssen Sie den Pfad mit der Option <code>--config</code> an die Konfigurationsdatei <code>--config</code> oder den Pfad in <code>package.json</code> : </p><br><pre> <code class="json hljs">{ ... <span class="hljs-attr"><span class="hljs-attr">"discovery"</span></span>: <span class="hljs-string"><span class="hljs-string">"path/to/discovery/config.js"</span></span>, ... }</code> </pre> <br><p>  Starten Sie den Server neu, damit die Konfiguration angewendet wird: </p><br><pre> <code class="plaintext hljs">&gt; npx discovery Load config from .discoveryrc.js Init single model default Define default routes ... OK Cache: DISABLED Init common routes ... OK Server listen on http://localhost:8123</code> </pre> <br><p>  Wie Sie sehen können, wird jetzt die von uns erstellte Datei verwendet.  Und das von uns beschriebene Standardmodell wird angewendet (Discovery kann im Modus vieler Modelle funktionieren, wir werden in den folgenden Handbüchern auf diese Funktion eingehen).  Mal sehen, was sich im Browser geändert hat: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/16f/f45/ac8/16ff45ac8eef467b6ccd0ff5624c9652.png" alt="Mit Grundkonfiguration"></p><br><p>  Was ist hier zu sehen: </p><br><ul><li>  <code>name</code> als Seitentitel verwendet; </li><li>  Das Ergebnis des Aufrufs der Datenmethode wird als Hauptinhalt der Seite angezeigt. </li></ul><br><blockquote>  Hinweis: Die Datenmethode muss Daten oder Promise zurückgeben, die in Daten aufgelöst werden. </blockquote><p>  Grundeinstellungen werden vorgenommen, Sie können weitermachen. </p><br><h2 id="kontekst">  Kontext </h2><br><p>  Schauen wir uns die Seite mit den benutzerdefinierten Berichten an (klicken <code>Make report</code> ): </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/def/52b/57a/def52b57a6be174730f07fe55273517a.png" alt="Berichtsseite"></p><br><p>  Auf den ersten Blick unterscheidet sich dies nicht sehr von der Startseite ... Aber hier können Sie alles ändern!  Zum Beispiel können wir das Erscheinungsbild der Startseite einfach neu erstellen: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c6c/919/de1/c6c919de17d2fed5bdb0501fe1ff9dae.png" alt="Neuerstellung der Startseite"></p><br><p>  Beachten Sie, wie der Header definiert ist: <code>"h1:#.name"</code> .  Dies ist der Header der ersten Ebene mit dem Inhalt von <code>#.name</code> , einer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Jora-</a> Anforderung.  <code>#</code> bezieht sich auf den Anforderungskontext.  Um den Inhalt anzuzeigen, geben Sie einfach <code>#</code> in den Abfrageeditor ein und verwenden Sie die Standardanzeige: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/524/7a6/2cc/5247a62cc6194ab9bd4797c21ab084b9.png" alt="Kontextwerte"></p><br><p>  Jetzt wissen Sie, wie Sie die ID der aktuellen Seite, ihre Parameter und andere nützliche Werte erhalten. </p><br><h2 id="sbor-dannyh">  Datenerfassung </h2><br><p>  Jetzt verwenden wir im Projekt einen Stub anstelle von realen Daten, aber wir benötigen reale Daten.  Erstellen Sie dazu ein Modul und ändern Sie den <code>data</code> in der Konfiguration (nach diesen Änderungen muss der Server übrigens nicht neu gestartet werden): </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'Node modules structure'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./collect-node-modules-data'</span></span>) };</code> </pre> <br><p>  Der Inhalt von <code>collect-node-modules-data.js</code> : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> path = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> scanFs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'@discoveryjs/scan-fs'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> packages = []; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> scanFs({ <span class="hljs-attr"><span class="hljs-attr">include</span></span>: [<span class="hljs-string"><span class="hljs-string">'node_modules'</span></span>], <span class="hljs-attr"><span class="hljs-attr">rules</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\/package.json$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">extract</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file, content</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pkg = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(content); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pkg.name &amp;&amp; pkg.version) { packages.push({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: pkg.name, <span class="hljs-attr"><span class="hljs-attr">version</span></span>: pkg.version, <span class="hljs-attr"><span class="hljs-attr">path</span></span>: path.dirname(file.filename), <span class="hljs-attr"><span class="hljs-attr">dependencies</span></span>: pkg.dependencies }); } } }] }).then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> packages); };</code> </pre> <br><p>  Ich habe das Paket <code>@discoveryjs/scan-fs</code> , das das Scannen von Dateisystemen vereinfacht.  Ein Beispiel für die Verwendung des Pakets ist in der Readme-Datei beschrieben. Ich habe dieses Beispiel als Grundlage genommen und nach Bedarf fertiggestellt.  Jetzt haben wir einige Informationen über den Inhalt von <code>node_modules</code> : </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/d0c/f24/64c/d0cf2464cadda8a8bc0433871200ae9b.png" alt="Daten gesammelt"></p><br><p>  Was du brauchst!  Und trotz der Tatsache, dass dies gewöhnlicher JSON ist, können wir ihn bereits analysieren und einige Schlussfolgerungen ziehen.  Mithilfe des Popups der Datenstruktur können Sie beispielsweise die Anzahl der Pakete ermitteln und herausfinden, wie viele von ihnen mehr als eine physische Instanz haben (aufgrund unterschiedlicher Versionen oder Probleme bei der Deduplizierung). </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/8f3/93e/5e0/8f393e5e05a1385aa11aad92d8ad15a0.png" alt="Datenstrukturforschung"></p><br><p>  Trotz der Tatsache, dass wir bereits einige Daten haben, benötigen wir weitere Details.  Zum Beispiel wäre es schön zu wissen, welche physische Instanz jede der deklarierten Abhängigkeiten eines bestimmten Moduls auflöst.  Die Arbeit zur Verbesserung der Datenextraktion geht jedoch über den Rahmen dieses Handbuchs hinaus.  Daher werden wir es durch das Paket <code>@discoveryjs/node-modules</code> (das ebenfalls auf <code>@discoveryjs/scan-fs</code> basiert) ersetzen, um die Daten abzurufen und die erforderlichen Details zu den Paketen abzurufen.  Infolgedessen wird <code>collect-node-modules-data.js</code> erheblich vereinfacht: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fetchNodeModules = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'@discoveryjs/node-modules'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fetchNodeModules(); };</code> </pre> <br><p>  Die Informationen zu <code>node_modules</code> aus: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/1f5/1c2/187/1f51c2187d527694cbf71089e8d74ba8.png" alt="Neue Datenstruktur"></p><br><h2 id="skript-podgotovki">  Vorbereitungsskript </h2><br><p>  Wie Sie vielleicht bemerkt haben, enthalten einige Objekte, die Pakete beschreiben, <code>deps</code> - eine Liste von Abhängigkeiten.  Jede Abhängigkeit hat ein <code>resolved</code> Feld, dessen Wert eine Referenz auf eine physische Instanz des Pakets ist.  Ein solcher Link ist der <code>path</code> eines der Pakete, er ist eindeutig.  Um den Link zum Paket aufzulösen, müssen Sie zusätzlichen Code verwenden (z. B. <code>#.data.pick(&lt;path=resolved&gt;)</code> ).  Und natürlich wäre es viel bequemer, wenn solche Links bereits in Objektreferenzen aufgelöst würden. </p><br><p>  Leider können wir die Links zum Zeitpunkt der Datenerfassung nicht auflösen, da dies zu zirkulären Verbindungen führt, die das Problem der Übertragung solcher Daten in Form von JSON verursachen.  Es gibt jedoch eine Lösung: Dies ist ein spezielles <code>prepare</code> .  Sie wird in der Konfiguration definiert und jedes Mal aufgerufen, wenn der Discovery-Instanz neue Daten zugewiesen werden.  Beginnen wir mit der Konfiguration: </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { ... prepare: __dirname + <span class="hljs-string"><span class="hljs-string">'/prepare.js'</span></span>, <span class="hljs-comment"><span class="hljs-comment">// :   ,    ... };</span></span></code> </pre> <br><p>  Definieren Sie <code>prepare.js</code> : </p><br><pre> <code class="javascript hljs">discovery.setPrepare(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  -  data /   discovery });</span></span></code> </pre> <br><p>  In diesem Modul haben wir die <code>prepare</code> für die Discovery-Instanz definiert.  Diese Funktion wird jedes Mal aufgerufen, bevor Daten auf die Discovery-Instanz angewendet werden.  Dies ist ein guter Ort, um Werte in Objektreferenzen zuzulassen: </p><br><pre> <code class="javascript hljs">discovery.setPrepare(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> packageIndex = data.reduce(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">map, pkg</span></span></span><span class="hljs-function">) =&gt;</span></span> map.set(pkg.path, pkg), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Map</span></span>()); data.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">pkg</span></span></span><span class="hljs-function"> =&gt;</span></span> pkg.deps.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dep</span></span></span><span class="hljs-function"> =&gt;</span></span> dep.resolved = packageIndex.get(dep.resolved) ) ); });</code> </pre> <br><p>  Hier haben wir einen Paketindex erstellt, in dem der Schlüssel der Paketpfadwert (eindeutig) ist.  Dann gehen wir alle Pakete und ihre Abhängigkeiten durch und ersetzen in den Abhängigkeiten den <code>resolved</code> Wert durch einen Verweis auf das Paketobjekt.  Ergebnis: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/95b/277/dd6/95b277dd63dc3aff1fdf3716c6881356.png" alt="Konvertierte deps.gelöst"></p><br><p>  Jetzt ist es viel einfacher, Abhängigkeitsdiagrammabfragen durchzuführen.  Auf diese Weise können Sie einen Cluster von Abhängigkeiten (d. H. Abhängigkeiten, Abhängigkeitsabhängigkeiten usw.) für ein bestimmtes Paket abrufen: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c64/793/a78/c64793a78d40961af1b234fc111e4dc2.png" alt="Beispiel für einen Abhängigkeitscluster"></p><br><blockquote>  Eine unerwartete Erfolgsgeschichte: Während ich die Daten während des Schreibens des Handbuchs studierte, fand ich ein Problem in <code>@discoveryjs/cli</code> (unter Verwendung der Abfrage <code>.[deps.[not resolved]]</code> ), das einen Tippfehler in PeerDependencies hatte.  Das Problem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">wurde</a> sofort <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">behoben</a> .  Der Fall ist ein gutes Beispiel dafür, wie solche Tools helfen. </blockquote><p>  Vielleicht ist es an der Zeit, auf der Startseite mehrere Nummern und Pakete mit Takes anzuzeigen. </p><br><h2 id="nastraivaem-startovuyu-stranicu">  Startseite anpassen </h2><br><p>  Zuerst müssen wir ein Seitenmodul erstellen, zum Beispiel <code>pages/default.js</code> .  Wir verwenden die <code>default</code> , da dies die Kennung für die Startseite ist, die wir überschreiben können (in Discovery.js können Sie viel überschreiben).  Beginnen wir mit etwas Einfachem, zum Beispiel: </p><br><pre> <code class="javascript hljs">discovery.page.define(<span class="hljs-string"><span class="hljs-string">'default'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'h1:#.name'</span></span>, <span class="hljs-string"><span class="hljs-string">'text:"Hello world!"'</span></span> ]);</code> </pre> <br><p>  In der Konfiguration müssen Sie nun das Seitenmodul anschließen: </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'Node modules structure'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./collect-node-modules-data'</span></span>), <span class="hljs-attr"><span class="hljs-attr">view</span></span>: { <span class="hljs-attr"><span class="hljs-attr">assets</span></span>: [ <span class="hljs-string"><span class="hljs-string">'pages/default.js'</span></span> <span class="hljs-comment"><span class="hljs-comment">//     ] } };</span></span></code> </pre> <br><p>  Überprüfen Sie im Browser: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/e0c/d07/8d5/e0cd078d55637ef62a697809544909b9.png" alt="Überschriebene Startseite"></p><br><p>  Es funktioniert! </p><br><p>  Jetzt holen wir uns ein paar Zähler.  Nehmen Sie dazu Änderungen an <code>pages/default.js</code> : </p><br><pre> <code class="javascript hljs">discovery.page.define(<span class="hljs-string"><span class="hljs-string">'default'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'h1:#.name'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">view</span></span>: <span class="hljs-string"><span class="hljs-string">'inline-list'</span></span>, <span class="hljs-attr"><span class="hljs-attr">item</span></span>: <span class="hljs-string"><span class="hljs-string">'indicator'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-string"><span class="hljs-string">`[ { label: 'Package entries', value: size() }, { label: 'Unique packages', value: name.size() }, { label: 'Dup packages', value: group(&lt;name&gt;).[value.size() &gt; 1].size() } ]`</span></span> } ]);</code> </pre> <br><p>  Hier definieren wir eine Inline-Liste von Indikatoren.  Der <code>data</code> ist eine Jora-Abfrage, die ein Array von Datensätzen erstellt.  Die Liste der Pakete (Datenstamm) wird als Grundlage für Abfragen verwendet, sodass wir die <code>name.size()</code> <code>size()</code> ), die Anzahl der eindeutigen Paketnamen ( <code>name.size()</code> ) und die Anzahl der Paketnamen mit Duplikaten ( <code>group(&lt;name&gt;).[value.size() &gt; 1].size()</code> ). </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ebf/c97/8a2/ebfc978a2b2da44214a99a8382e17107.png" alt="Fügen Sie der Startseite Indikatoren hinzu"></p><br><p>  Nicht schlecht.  Trotzdem wäre es besser, zusätzlich zu den Zahlen Links zu den entsprechenden Stichproben zu haben: </p><br><pre> <code class="javascript hljs">discovery.page.define(<span class="hljs-string"><span class="hljs-string">'default'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'h1:#.name'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">view</span></span>: <span class="hljs-string"><span class="hljs-string">'inline-list'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">label</span></span>: <span class="hljs-string"><span class="hljs-string">'Package entries'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">label</span></span>: <span class="hljs-string"><span class="hljs-string">'Unique packages'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-string"><span class="hljs-string">'name'</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">label</span></span>: <span class="hljs-string"><span class="hljs-string">'Dup packages'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-string"><span class="hljs-string">'group(&lt;name&gt;).[value.size() &gt; 1]'</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">item</span></span>: <span class="hljs-string"><span class="hljs-string">`indicator:{ label, value: value.query(#.data, #).size(), href: pageLink('report', { query: value, title: label }) }`</span></span> } ]);</code> </pre> <br><p>  Zuerst haben wir den Wert von <code>data</code> geändert, jetzt ist es ein reguläres Array mit einigen Objekten.  Außerdem wurde die <code>size()</code> -Methode aus Wertanforderungen entfernt. </p><br><p>  Zusätzlich wurde der <code>indicator</code> eine Unterabfrage hinzugefügt.  Diese Abfragetypen erstellen für jedes Element ein neues Objekt, in dem <code>value</code> und <code>href</code> berechnet werden.  Für den <code>value</code> wird eine Abfrage mit der <code>query()</code> -Methode ausgeführt, auf die Daten aus dem Kontext übertragen werden, und anschließend wird die <code>size()</code> -Methode auf das Abfrageergebnis angewendet.  Für <code>href</code> wird die <code>pageLink()</code> -Methode verwendet, die einen Link zur Berichtsseite mit einer bestimmten Anforderung und einem bestimmten Header generiert.  Nach all diesen Änderungen wurden die Indikatoren anklickbar (beachten Sie, dass ihre Werte blau geworden sind) und funktionaler. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/e72/104/33c/e7210433ca45798701f34c6625cae050.gif" alt="Klickbare Indikatoren"></p><br><p>  Fügen Sie eine Tabelle mit Paketen mit Duplikaten hinzu, um die Startseite nützlicher zu gestalten. </p><br><pre> <code class="javascript hljs">discovery.page.define(<span class="hljs-string"><span class="hljs-string">'default'</span></span>, [ <span class="hljs-comment"><span class="hljs-comment">// ...      'h2:"Packages with more than one physical instance"', { view: 'table', data: ` group(&lt;name&gt;) .[value.size() &gt; 1] .sort(&lt;value.size()&gt;) .reverse() `, cols: [ { header: 'Name', content: 'text:key' }, { header: 'Version &amp; Location', content: { view: 'list', data: 'value.sort(&lt;version&gt;)', item: [ 'badge:version', 'text:path' ] } } ] } ]);</span></span></code> </pre> <br><p>  Die Tabelle verwendet dieselben Daten wie der Indikator für <code>Dup packages</code> .  Die Liste der Pakete wurde nach Gruppengröße in umgekehrter Reihenfolge sortiert.  Der Rest des Setups bezieht sich auf die Spalten (normalerweise müssen sie normalerweise nicht optimiert werden).  Für die Spalte <code>Version &amp; Location</code> haben wir eine verschachtelte Liste (sortiert nach Version) definiert, in der jedes Element ein Paar aus der Versionsnummer und dem Pfad zur Instanz ist. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/a50/5fd/4ab/a505fd4aba48f6a0d025fc5cd4b84b24.png" alt="Tabelle mit Paketen hinzugefügt, die mehr als eine physische Instanz haben"></p><br><h2 id="stranica-paketov">  Paketseite </h2><br><p>  Jetzt haben wir nur noch einen allgemeinen Überblick über Pakete.  Es wäre jedoch nützlich, eine Seite mit Details zu einem bestimmten Paket zu haben.  Erstellen Sie dazu ein neues Modul <code>pages/package.js</code> und definieren Sie eine neue Seite: </p><br><pre> <code class="javascript hljs">discovery.page.define(<span class="hljs-string"><span class="hljs-string">'package'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">view</span></span>: <span class="hljs-string"><span class="hljs-string">'context'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-string"><span class="hljs-string">`{ name: #.id, instances: .[name = #.id] }`</span></span>, <span class="hljs-attr"><span class="hljs-attr">content</span></span>: [ <span class="hljs-string"><span class="hljs-string">'h1:name'</span></span>, <span class="hljs-string"><span class="hljs-string">'table:instances'</span></span> ] });</code> </pre> <br><p>  In diesem Modul haben wir die Seite mit dem Bezeichnerpaket definiert.  Die Kontextkomponente wurde als anfängliche Darstellung verwendet.  Dies ist eine nicht visuelle Komponente, mit der Sie Daten für verschachtelte Zuordnungen definieren können.  Beachten Sie, dass wir <code>#.id</code> , um den Namen des Pakets abzurufen, das von einer URL wie dieser abgerufen wird <code>http://localhost:8123/#package:{id}</code> . </p><br><p>  Vergessen Sie nicht, das neue Modul in die Konfiguration aufzunehmen: </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { ... view: { <span class="hljs-attr"><span class="hljs-attr">assets</span></span>: [ <span class="hljs-string"><span class="hljs-string">'pages/default.js'</span></span>, <span class="hljs-string"><span class="hljs-string">'pages/package.js'</span></span> <span class="hljs-comment"><span class="hljs-comment">//   ] } };</span></span></code> </pre> <br><p>  Ergebnis im Browser: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/3ee/698/da0/3ee698da0907aebaa1ace032942c0575.png" alt="Beispiel für eine Paketseite"></p><br><p>  Nicht allzu beeindruckend, aber vorerst.  In den folgenden Handbüchern werden komplexere Zuordnungen erstellt. </p><br><h2 id="bokovaya-panel">  Seitenwand </h2><br><p>  Da wir bereits eine Paketseite haben, wäre es schön, eine Liste aller Pakete zu haben.  Zu diesem Zweck können Sie eine spezielle Ansichtseitenleiste definieren, die angezeigt wird, wenn sie definiert ist (nicht standardmäßig definiert).  Erstellen Sie eine neue <code>views/sidebar.js</code> : </p><br><pre> <code class="javascript hljs">discovery.view.define(<span class="hljs-string"><span class="hljs-string">'sidebar'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">view</span></span>: <span class="hljs-string"><span class="hljs-string">'list'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-string"><span class="hljs-string">'name.sort()'</span></span>, <span class="hljs-attr"><span class="hljs-attr">item</span></span>: <span class="hljs-string"><span class="hljs-string">'link:{ text: $, href: pageLink("package") }'</span></span> });</code> </pre> <br><p>  Jetzt haben wir eine Liste aller Pakete: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/503/326/a02/503326a020869af76a3b2076c5df2394.png" alt="Seitenleiste hinzugefügt"></p><br><p>  Es sieht gut aus.  Aber mit einem Filter wäre es noch besser.  Wir erweitern die Definition der <code>sidebar</code> : </p><br><pre> <code class="javascript hljs">discovery.view.define(<span class="hljs-string"><span class="hljs-string">'sidebar'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">view</span></span>: <span class="hljs-string"><span class="hljs-string">'content-filter'</span></span>, <span class="hljs-attr"><span class="hljs-attr">content</span></span>: { <span class="hljs-attr"><span class="hljs-attr">view</span></span>: <span class="hljs-string"><span class="hljs-string">'list'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-string"><span class="hljs-string">'name.[no #.filter or $~=#.filter].sort()'</span></span>, <span class="hljs-attr"><span class="hljs-attr">item</span></span>: { <span class="hljs-attr"><span class="hljs-attr">view</span></span>: <span class="hljs-string"><span class="hljs-string">'link'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-string"><span class="hljs-string">'{ text: $, href: pageLink("package"), match: #.filter }'</span></span>, <span class="hljs-attr"><span class="hljs-attr">content</span></span>: <span class="hljs-string"><span class="hljs-string">'text-match'</span></span> } } });</code> </pre> <br><p>  Hier haben wir die Liste in eine <code>content-filter</code> , die den Eingabewert im Eingabefeld in reguläre Ausdrücke konvertiert (oder <code>null</code> wenn das Feld leer ist) und als <code>filter</code> im Kontext speichert (der Name kann mit der Option name geändert werden).  <code>#.filter</code> die Daten für die Liste zu filtern, haben wir <code>#.filter</code> .  Schließlich haben wir die Linkzuordnung angewendet, um übereinstimmende Teile mit <code>text-match</code> hervorzuheben.  Ergebnis: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/d55/74f/67e/d5574f67e7a2dd222194c66f5ecf0673.png" alt="Filterliste"></p><br><p>  Falls Ihnen das Standarddesign nicht gefällt, können Sie die Stile nach Ihren Wünschen anpassen.  Angenommen, Sie möchten die Breite der Seitenleiste ändern. Dazu müssen Sie eine <code>views/sidebar.css</code> erstellen (z. B. <code>views/sidebar.css</code> ): </p><br><pre> <code class="css hljs"><span class="hljs-selector-class"><span class="hljs-selector-class">.discovery-sidebar</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">width</span></span>: <span class="hljs-number"><span class="hljs-number">300px</span></span>; }</code> </pre> <br><p>  Fügen Sie in der Konfiguration einen Link zu dieser Datei sowie zu JavaScript-Modulen hinzu: </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { ... view: { <span class="hljs-attr"><span class="hljs-attr">assets</span></span>: [ ... <span class="hljs-string"><span class="hljs-string">'views/sidebar.css'</span></span>, <span class="hljs-comment"><span class="hljs-comment">//  assets    *.css  'views/sidebar.js' ] } };</span></span></code> </pre> <br><h2 id="avtossylki">  AutoLinks </h2><br><p>  Das letzte Kapitel dieses Handbuchs ist Links gewidmet.  Zuvor haben wir mithilfe der <code>pageLink()</code> -Methode einen Link zur <code>pageLink()</code> erstellt.  Zusätzlich zum Link müssen Sie aber auch den Linktext festlegen.  Aber wie würden wir es einfacher machen? </p><br><p>  Um die Arbeit von Links zu vereinfachen, müssen wir eine Regel zum Generieren von Links definieren.  Dies geschieht am besten im <code>prepare</code> : </p><br><pre> <code class="javascript hljs">discovery.setPrepare(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ ... const packageIndex = data.reduce( <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">map, item</span></span></span><span class="hljs-function">) =&gt;</span></span> map .set(item, item) <span class="hljs-comment"><span class="hljs-comment">// key is item itself .set(item.name, item), // and `name` value new Map() ); discovery.addEntityResolver(value =&gt; { value = packageIndex.get(value) || packageIndex.get(value.name); if (value) { return { type: 'package', id: value.name, name: value.name }; } }); });</span></span></code> </pre> <br><p>  Wir haben eine neue Karte (Index) von Paketen hinzugefügt und diese für den Entity Resolver verwendet.  Der Entity Resolver versucht nach Möglichkeit, den an ihn übergebenen Wert in einen Entity Deskriptor umzuwandeln.  Der Deskriptor enthält: </p><br><ul><li>  <code>type</code> - Entitätstyp </li><li>  <code>id</code> - Ein eindeutiger Verweis auf eine Entitätsinstanz, die in Links als ID verwendet wird </li><li>  <code>name</code> - wird als Linktext verwendet </li></ul><br><p>  Schließlich müssen Sie diesen Typ einer bestimmten Seite zuweisen (der Link sollte irgendwohin führen, oder?). </p><br><pre> <code class="javascript hljs">discovery.page.define(<span class="hljs-string"><span class="hljs-string">'package'</span></span>, { ... }, { <span class="hljs-attr"><span class="hljs-attr">resolveLink</span></span>: <span class="hljs-string"><span class="hljs-string">'package'</span></span> <span class="hljs-comment"><span class="hljs-comment">//    `package`    });</span></span></code> </pre> <br><p>  Die erste Folge dieser Änderungen ist, dass einige Werte in der <code>struct</code> jetzt mit einem Link zur <code>struct</code> gekennzeichnet sind: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/eb2/dcd/502/eb2dcd5024f589a3ba8180f2b1ec538f.png" alt="Automatische Links in struct"></p><br><p>  Und jetzt können Sie die <code>auto-link</code> Komponente auch auf einen Objekt- oder Paketnamen anwenden: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/64d/3c2/f24/64d3c2f244164a22c55ff433409f6e22.png" alt="Verwenden der automatischen Verknüpfung"></p><br><p>  Und als Beispiel können Sie die Seitenleiste leicht überarbeiten: </p><br><pre> <code class="javascript hljs"> <span class="hljs-comment"><span class="hljs-comment">//   item: { view: 'link', data: '{ text: $, href: pageLink("package"), match: #.filter }', content: 'text-match' }, //   `auto-link` item: { view: 'auto-link', content: 'text-match:{ text, match: #.filter }' }</span></span></code> </pre> <br><h2 id="zaklyuchenie">  Fazit </h2><br><p>  Sie haben jetzt ein grundlegendes Verständnis der Schlüsselkonzepte von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Discovery.js</a> .  In den folgenden Handbüchern werden wir uns die behandelten Themen genauer ansehen. </p><br><p>  Sie können den gesamten Quellcode des Handbuchs im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Repository auf GitHub anzeigen</a> oder <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">versuchen, wie es online funktioniert</a> . </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Folgen Sie @js_discovery</a> auf Twitter, um über die neuesten Nachrichten auf dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Laufenden</a> zu bleiben! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de469115/">https://habr.com/ru/post/de469115/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de469097/index.html">CentOS 8 Webserver mit PHP7, Node.js und Redis</a></li>
<li><a href="../de469099/index.html">Testaufgaben beim Interview des Entwicklers - macht das Sinn?</a></li>
<li><a href="../de469101/index.html">Englisch lernen: wie man lernt, als Muttersprachler zu sprechen</a></li>
<li><a href="../de469109/index.html">Holzspielzeug, Teil Drei - 1989</a></li>
<li><a href="../de469111/index.html">Objekt durch var ersetzen: Was könnte schief gehen?</a></li>
<li><a href="../de469117/index.html">Programmierung unter BC 0010 im Jahr 2019</a></li>
<li><a href="../de469119/index.html">Die IPv4-Adressen in RIPE sind beendet. Völlig vorbei ...</a></li>
<li><a href="../de469125/index.html">Dunkles Thema von Thunderbird als Grund, einen Code-Analysator auszuführen</a></li>
<li><a href="../de469127/index.html">Optimierung oder wie man sich nicht in den Fuß schießt</a></li>
<li><a href="../de469129/index.html">Aufgrund des dunklen Themas musste Thunderbird einen Code-Analysator ausführen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>