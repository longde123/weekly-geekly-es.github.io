<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•ô üëéüèΩ ‚òùüèø PHPUnit. Manajer Entitas Doktrin Menangis ‚åöÔ∏è ü§òüèø üëåüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Banyak aplikasi database modern menggunakan proyek ORM Doctrine . 


 Ini dianggap praktik yang baik untuk membawa pekerjaan dengan database ke layana...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PHPUnit. Manajer Entitas Doktrin Menangis</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/452244/"><p>  Banyak aplikasi database modern menggunakan proyek <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">ORM Doctrine</a> . </p><br><p>  Ini dianggap praktik yang baik untuk membawa pekerjaan dengan database ke layanan.  Dan layanan perlu diuji. </p><br><p>  Untuk menguji layanan, Anda bisa menyambungkan database pengujian, atau Anda bisa mengunci Entity Manager dan repositori.  Dengan opsi pertama, semuanya jelas, tetapi tidak selalu masuk akal untuk menggunakan database untuk menguji layanan.  Kami akan membicarakan ini. </p><a name="habracut"></a><br><p>  Misalnya, ambil layanan berikut: </p><br><div class="spoiler">  <b class="spoiler_title">src / Layanan / Pengguna / UserService.php</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// src/Service/User/UserService.php namespace App\Service\User; use App\Entity\Code; use App\Entity\User; use App\Repository\CodeRepository; use App\Repository\UserRepository; use App\Service\Generator\CodeGenerator; use App\Service\Sender\SenderService; use App\Service\User\Exception\LoginAlreadyExistsException; use App\Service\User\Exception\ReferrerUserNotFoundException; use Doctrine\ORM\EntityManagerInterface; class UserService { /** @var EntityManagerInterface */ private $em; /** @var UserRepository */ private $users; /** @var CodeRepository */ private $codes; /** @var SenderService */ private $sender; /** @var CodeGenerator */ private $generator; public function __construct(EntityManagerInterface $em, SenderService $sender, CodeGenerator $generator) { $this-&gt;em = $em; $this-&gt;users = $em-&gt;getRepository(User::class); $this-&gt;codes = $em-&gt;getRepository(Code::class); $this-&gt;sender = $sender; $this-&gt;generator = $generator; } /** * @param string $login * @param string $email * @param string|null $referrerLogin * @return User * @throws LoginAlreadyExistsException * @throws ReferrerUserNotFoundException */ public function create(string $login, string $email, ?string $referrerLogin = null): User { $exists = $this-&gt;users-&gt;findOneByLogin($login); if ($exists) throw new LoginAlreadyExistsException(); $referrer = null; if ($referrerLogin) { $referrer = $this-&gt;users-&gt;findOneByLogin($referrerLogin); if (!$referrer) throw new ReferrerUserNotFoundException(); } $user = (new User())-&gt;setLogin($login)-&gt;setEmail($email)-&gt;setReferrer($referrer); $code = (new Code())-&gt;setEmail($email)-&gt;setCode($this-&gt;generator-&gt;generate()); $this-&gt;sender-&gt;sendCode($code); $this-&gt;em-&gt;persist($user); $this-&gt;em-&gt;persist($code); $this-&gt;em-&gt;flush(); return $user; } }</span></span></code> </pre> </div></div><br><p>  Kita perlu menguji satu-satunya metode <code>create()</code> . <br>  Pilih kasus berikut: </p><br><ul><li>  Pembuatan pengguna yang berhasil tanpa pengarah </li><li>  Pembuatan pengguna yang berhasil dengan pengarah </li><li>  Kesalahan "Login sudah diambil" </li><li>  Kesalahan "Perujuk tidak ditemukan" </li></ul><br><p>  Untuk menguji layanan, kita memerlukan objek yang mengimplementasikan antarmuka <code>Doctrine\ORM\EntityManagerInterface</code> </p><br><h2 id="variant-1-ispolzuem-realnuyu-bazu-dannyh">  Opsi 1. Kami menggunakan database nyata </h2><br><p>  Kami akan menulis kelas dasar untuk tes, yang nantinya akan kami warisi. </p><br><div class="spoiler">  <b class="spoiler_title">tes / TestCase.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// tests/TestCase.php namespace Tests; use Doctrine\Common\Annotations\AnnotationReader; use Doctrine\Common\Cache\ArrayCache; use Doctrine\ORM\EntityManager; use Doctrine\ORM\EntityManagerInterface; use Doctrine\ORM\Mapping\Driver\AnnotationDriver; use Doctrine\ORM\Tools\SchemaTool; use Doctrine\ORM\Tools\Setup; use PHPUnit\Framework\TestCase as BaseTestCase; abstract class TestCase extends BaseTestCase { protected function getEntityManager(): EntityManagerInterface { $paths = [ dirname(__DIR__) . DIRECTORY_SEPARATOR . 'src' . DIRECTORY_SEPARATOR . 'Entity', ]; $cache = new ArrayCache(); $driver = new AnnotationDriver(new AnnotationReader(), $paths); $config = Setup::createAnnotationMetadataConfiguration($paths, false); $config-&gt;setMetadataCacheImpl($cache); $config-&gt;setQueryCacheImpl($cache); $config-&gt;setMetadataDriverImpl($driver); $connection = array( 'driver' =&gt; getenv('DB_DRIVER'), 'path' =&gt; getenv('DB_PATH'), 'user' =&gt; getenv('DB_USER'), 'password' =&gt; getenv('DB_PASSWORD'), 'dbname' =&gt; getenv('DB_NAME'), ); $em = EntityManager::create($connection, $config); /* *       . *          */ $schema = new SchemaTool($em); $schema-&gt;dropSchema($em-&gt;getMetadataFactory()-&gt;getAllMetadata()); $schema-&gt;createSchema($em-&gt;getMetadataFactory()-&gt;getAllMetadata()); return $em; } }</span></span></code> </pre> </div></div><br><p>  Sekarang masuk akal untuk tes untuk mengatur variabel lingkungan.  Tambahkan mereka ke file <code>phpunit.xml</code> di bagian <code>php</code> .  Saya akan menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sqlite</a> db </p><br><div class="spoiler">  <b class="spoiler_title">phpunit.xml</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">phpunit</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:noNamespaceSchemaLocation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://schema.phpunit.de/8.1/phpunit.xsd"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">bootstrap</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"vendor/autoload.php"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">executionOrder</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"depends,defects"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">forceCoversAnnotation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">beStrictAboutCoversAnnotation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">beStrictAboutOutputDuringTests</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">beStrictAboutTodoAnnotatedTests</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">verbose</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">colors</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">php</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">env</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DB_DRIVER"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"pdo_sqlite"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">env</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DB_PATH"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"var/db-test.sqlite"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">env</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DB_USER"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">env</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DB_PASSWORD"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">env</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DB_NAME"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">php</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuites</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuite</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"default"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">directory</span></span></span><span class="hljs-tag">&gt;</span></span>tests/Unit<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">directory</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuite</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuites</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">whitelist</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">processUncoveredFilesFromWhitelist</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">directory</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">suffix</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".php"</span></span></span><span class="hljs-tag">&gt;</span></span>src<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">directory</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">whitelist</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">phpunit</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><p>  Sekarang kita akan menulis tes layanan </p><br><div class="spoiler">  <b class="spoiler_title">tes / Unit / Layanan / UserServiceTest.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// tests/Unit/Service/UserServiceTest.php namespace Tests\Unit\Service; use App\Entity\Code; use App\Entity\User; use App\Repository\CodeRepository; use App\Repository\UserRepository; use App\Service\Generator\CodeGenerator; use App\Service\Sender\SenderService; use App\Service\User\Exception\LoginAlreadyExistsException; use App\Service\User\Exception\ReferrerUserNotFoundException; use App\Service\User\UserService; use Tests\TestCase; use Doctrine\ORM\EntityManagerInterface; class UserServiceTest extends TestCase { /** * @var UserService */ protected $service; /** * @var EntityManagerInterface */ protected $em; public function setUp(): void { parent::setUp(); $this-&gt;em = $this-&gt;getEntityManager(); $this-&gt;service = new UserService($this-&gt;em, new SenderService(), new CodeGenerator()); } /** * @throws LoginAlreadyExistsException * @throws ReferrerUserNotFoundException */ public function testCreateSuccessWithoutReferrer() { //        $login = 'case1'; $email = $login . '@localhost'; $user = $this-&gt;service-&gt;create($login, $email); // ,       $this-&gt;assertInstanceOf(User::class, $user); $this-&gt;assertSame($login, $user-&gt;getLogin()); $this-&gt;assertSame($email, $user-&gt;getEmail()); $this-&gt;assertFalse($user-&gt;isApproved()); // ,      /** @var UserRepository $userRepo */ $userRepo = $this-&gt;em-&gt;getRepository(User::class); $u = $userRepo-&gt;findOneByLogin($login); $this-&gt;assertInstanceOf(User::class, $u); $this-&gt;assertSame($login, $u-&gt;getLogin()); $this-&gt;assertSame($email, $u-&gt;getEmail()); $this-&gt;assertFalse($u-&gt;isApproved()); // ,       /** @var CodeRepository $codeRepo */ $codeRepo = $this-&gt;em-&gt;getRepository(Code::class); $c = $codeRepo-&gt;findLastByEmail($email); $this-&gt;assertInstanceOf(Code::class, $c); } /** * @throws LoginAlreadyExistsException * @throws ReferrerUserNotFoundException */ public function testCreateSuccessWithReferrer() { //      $referrerLogin = 'referer'; $referrer = new User(); $referrer -&gt;setLogin($referrerLogin) -&gt;setEmail($referrerLogin.'@localhost') ; $this-&gt;em-&gt;persist($referrer); $this-&gt;em-&gt;flush(); //        $login = 'case2'; $email = $login . '@localhost'; $user = $this-&gt;service-&gt;create($login, $email, $referrerLogin); // ,       $this-&gt;assertInstanceOf(User::class, $user); $this-&gt;assertSame($login, $user-&gt;getLogin()); $this-&gt;assertSame($email, $user-&gt;getEmail()); $this-&gt;assertFalse($user-&gt;isApproved()); $this-&gt;assertSame($referrer, $user-&gt;getReferrer()); // ,      /** @var UserRepository $userRepo */ $userRepo = $this-&gt;em-&gt;getRepository(User::class); $u = $userRepo-&gt;findOneByLogin($login); $this-&gt;assertInstanceOf(User::class, $u); $this-&gt;assertSame($login, $u-&gt;getLogin()); $this-&gt;assertSame($email, $u-&gt;getEmail()); $this-&gt;assertFalse($u-&gt;isApproved()); // ,       /** @var CodeRepository $codeRepo */ $codeRepo = $this-&gt;em-&gt;getRepository(Code::class); $c = $codeRepo-&gt;findLastByEmail($email); $this-&gt;assertInstanceOf(Code::class, $c); } /** * @throws LoginAlreadyExistsException * @throws ReferrerUserNotFoundException */ public function testCreateFailWithNonexistentReferrer() { //   ,     ReferrerUserNotFoundException $this-&gt;expectException(ReferrerUserNotFoundException::class); $referrerLogin = 'nonexistent-referer'; $login = 'case3'; $email = $login . '@localhost'; //       $this-&gt;service-&gt;create($login, $email, $referrerLogin); } /** * @throws LoginAlreadyExistsException * @throws ReferrerUserNotFoundException */ public function testCreateFailWithExistentLogin() { //   ,     LoginAlreadyExistsException $this-&gt;expectException(LoginAlreadyExistsException::class); //       $login = 'case4'; $email = $login . '@localhost'; //       ,    $existentUser = new User(); $existentUser -&gt;setLogin($login) -&gt;setEmail($login.'@localhost') ; $this-&gt;em-&gt;persist($existentUser); $this-&gt;em-&gt;flush(); //       $this-&gt;service-&gt;create($login, $email, null); } }</span></span></code> </pre> </div></div><br><p>  Pastikan layanan kami berfungsi dengan baik </p><br><pre> <code class="plaintext hljs">./vendor/bin/phpunit</code> </pre> <br><h2 id="variant-2-ispolzuem-mockbuilder">  Opsi 2. Menggunakan MockBuilder </h2><br><p>  Membangun database setiap saat itu sulit.  Terutama phpunit memberi kita kesempatan untuk mengumpulkan moki on the fly menggunakan mockBuilder.  Contohnya dapat ditemukan di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dokumentasi Symfony.</a> </p><br><div class="spoiler">  <b class="spoiler_title">Contoh dokumentasi Symfony</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// tests/Salary/SalaryCalculatorTest.php namespace App\Tests\Salary; use App\Entity\Employee; use App\Salary\SalaryCalculator; use Doctrine\Common\Persistence\ObjectManager; use Doctrine\Common\Persistence\ObjectRepository; use PHPUnit\Framework\TestCase; class SalaryCalculatorTest extends TestCase { public function testCalculateTotalSalary() { $employee = new Employee(); $employee-&gt;setSalary(1000); $employee-&gt;setBonus(1100); // Now, mock the repository so it returns the mock of the employee $employeeRepository = $this-&gt;createMock(ObjectRepository::class); // use getMock() on PHPUnit 5.3 or below // $employeeRepository = $this-&gt;getMock(ObjectRepository::class); $employeeRepository-&gt;expects($this-&gt;any()) -&gt;method('find') -&gt;willReturn($employee); // Last, mock the EntityManager to return the mock of the repository $objectManager = $this-&gt;createMock(ObjectManager::class); // use getMock() on PHPUnit 5.3 or below // $objectManager = $this-&gt;getMock(ObjectManager::class); $objectManager-&gt;expects($this-&gt;any()) -&gt;method('getRepository') -&gt;willReturn($employeeRepository); $salaryCalculator = new SalaryCalculator($objectManager); $this-&gt;assertEquals(2100, $salaryCalculator-&gt;calculateTotalSalary(1)); } }</span></span></code> </pre> </div></div><br><p>  Opsi ini berfungsi, tetapi ada masalah.  Anda perlu mengetahui dengan jelas dalam urutan apa kode mengakses metode EntityManager. <br>  Misalnya, jika pengembang bertukar cek untuk keberadaan pengarah dan cek untuk login yang sibuk, tes akan gagal.  Tetapi aplikasinya tidak. </p><br><p>  Saya mengusulkan opsi EntingManager pintar-moking, yang menyimpan semua datanya dalam memori dan tidak menggunakan database nyata. </p><br><h2 id="variant-3-ispolzuem-mockbuilder-s-hraneniem-dannyh-v-pamyati">  Opsi 3. Kami menggunakan MockBuilder dengan penyimpanan data dalam memori. </h2><br><p>  Untuk fleksibilitas, kami akan menambahkan variabel lingkungan sehingga Anda dapat menggunakan database nyata.  Mari kita <code>phpunit.xml</code> musim dingin di <code>phpunit.xml</code> </p><br><div class="spoiler">  <b class="spoiler_title">perubahan phpunit.xml</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- ... --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">php</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- ... --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">env</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"EMULATE_BD"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- ... --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">php</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- ... --&gt;</span></span></code> </pre> </div></div><br><p>  Sekarang modifikasi kelas dasar </p><br><div class="spoiler">  <b class="spoiler_title">tes yang dimodifikasi / TestCase.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// tests/TestCase.php namespace Tests; use App\Entity\Code; use App\Entity\User; use App\Repository\CodeRepository; use App\Repository\UserRepository; use Closure; use Doctrine\Common\Annotations\AnnotationReader; use Doctrine\Common\Cache\ArrayCache; use Doctrine\ORM\EntityManager; use Doctrine\ORM\EntityManagerInterface; use Doctrine\ORM\Mapping\Driver\AnnotationDriver; use Doctrine\ORM\Tools\SchemaTool; use Doctrine\ORM\Tools\Setup; use PHPUnit\Framework\MockObject\MockObject; use PHPUnit\Framework\TestCase as BaseTestCase; use ReflectionClass; abstract class TestCase extends BaseTestCase { /** * @var MockObject[] */ private $_mock = []; private $_data = [ User::class =&gt; [], Code::class =&gt; [], ]; private $_persist = [ User::class =&gt; [], Code::class =&gt; [], ]; /** * @var Closure[][] */ private $_fn = []; public function __construct($name = null, array $data = [], $dataName = '') { parent::__construct($name, $data, $dataName); $this-&gt;initFn(); } protected function getEntityManager(): EntityManagerInterface { $emulate = (int)getenv('EMULATE_BD'); return $emulate ? $this-&gt;getMockEntityManager() : $this-&gt;getRealEntityManager(); } protected function getRealEntityManager(): EntityManagerInterface { $paths = [ dirname(__DIR__) . DIRECTORY_SEPARATOR . 'src' . DIRECTORY_SEPARATOR . 'Entity', ]; $cache = new ArrayCache(); $driver = new AnnotationDriver(new AnnotationReader(), $paths); $config = Setup::createAnnotationMetadataConfiguration($paths, false); $config-&gt;setMetadataCacheImpl($cache); $config-&gt;setQueryCacheImpl($cache); $config-&gt;setMetadataDriverImpl($driver); $connection = array( 'driver' =&gt; getenv('DB_DRIVER'), 'path' =&gt; getenv('DB_PATH'), 'user' =&gt; getenv('DB_USER'), 'password' =&gt; getenv('DB_PASSWORD'), 'dbname' =&gt; getenv('DB_NAME'), ); $em = EntityManager::create($connection, $config); /* *       . *          */ $schema = new SchemaTool($em); $schema-&gt;dropSchema($em-&gt;getMetadataFactory()-&gt;getAllMetadata()); $schema-&gt;createSchema($em-&gt;getMetadataFactory()-&gt;getAllMetadata()); return $em; } protected function getMockEntityManager(): EntityManagerInterface { return $this-&gt;mock(EntityManagerInterface::class); } protected function mock($class) { if (!array_key_exists($class, $this-&gt;_mock)) { /* *     */ $mock = $this-&gt;getMockBuilder($class) -&gt;disableOriginalConstructor() -&gt;getMock() ; /* *     */ foreach ($this-&gt;_fn[$class] as $method =&gt; $fn) { $mock /*    */ -&gt;expects($this-&gt;any()) /*  $method */ -&gt;method($method) /*  (  )  */ -&gt;with() /*     */ -&gt;will($this-&gt;returnCallback($fn)) ; } $this-&gt;_mock[$class] = $mock; } return $this-&gt;_mock[$class]; } /* *    . *     $fn_[][] */ private function initFn() { /* * EntityManagerInterface::persist($object) -      */ $this-&gt;_fn[EntityManagerInterface::class]['persist'] = function ($object) { $entity = get_class($object); switch ($entity) { case User::class: /** @var User $object */ if (!$object-&gt;getId()) { $id = count($this-&gt;_persist[$entity]) + 1; $reflection = new ReflectionClass($object); $property = $reflection-&gt;getProperty('id'); $property-&gt;setAccessible(true); $property-&gt;setValue($object, $id); } $id = $object-&gt;getId(); break; case Code::class: /** @var Code $object */ if (!$object-&gt;getId()) { $id = count($this-&gt;_persist[$entity]) + 1; $reflection = new ReflectionClass($object); $property = $reflection-&gt;getProperty('id'); $property-&gt;setAccessible(true); $property-&gt;setValue($object, $id); } $id = $object-&gt;getId(); break; default: $id = spl_object_hash($object); } $this-&gt;_persist[$entity][$id] = $object; }; /* * EntityManagerInterface::flush() -      */ $this-&gt;_fn[EntityManagerInterface::class]['flush'] = function () { $this-&gt;_data = array_replace_recursive($this-&gt;_data, $this-&gt;_persist); }; /* * EntityManagerInterface::getRepository($className) -    */ $this-&gt;_fn[EntityManagerInterface::class]['getRepository'] = function ($className) { switch ($className) { case User::class: return $this-&gt;mock(UserRepository::class); break; case Code::class: return $this-&gt;mock(CodeRepository::class); break; } return null; }; /* * UserRepository::findOneByLogin($login) -       */ $this-&gt;_fn[UserRepository::class]['findOneByLogin'] = function ($login) { foreach ($this-&gt;_data[User::class] as $user) { /** @var User $user */ if ($user-&gt;getLogin() == $login) return $user; } return null; }; /* * CodeRepository::findOneByCodeAndEmail -      *        */ $this-&gt;_fn[CodeRepository::class]['findOneByCodeAndEmail'] = function ($code, $email) { $result = []; foreach ($this-&gt;_data[Code::class] as $c) { /** @var Code $c */ if ($c-&gt;getEmail() == $email &amp;&amp; $c-&gt;getCode() == $code) { $result[$c-&gt;getId()] = $c; } } if (!$result) return null; return array_shift($result); }; /* * CodeRepository::findLastByEmail($email) -  ()    *     */ $this-&gt;_fn[CodeRepository::class]['findLastByEmail'] = function ($email) { $result = []; foreach ($this-&gt;_data[Code::class] as $c) { /** @var Code $c */ if ($c-&gt;getEmail() == $email) { $result[$c-&gt;getId()] = $c; } } if (!$result) return null; return array_shift($result); }; } }</span></span></code> </pre> </div></div><br><p>  Sekarang kita dapat menjalankan tes lagi dan memastikan bahwa layanan kami berfungsi tanpa terhubung ke database. </p><br><pre> <code class="plaintext hljs">./vendor/bin/phpunit</code> </pre> <br><p>  Kode Sumber Tersedia di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Github</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id452244/">https://habr.com/ru/post/id452244/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id452230/index.html">Kami mempelajari dioda terowongan pada contoh 3I306M</a></li>
<li><a href="../id452232/index.html">ObjectRepository - .NET dalam memori repositori pola untuk proyek-proyek rumah Anda</a></li>
<li><a href="../id452234/index.html">Termometer & Hygrometer pada ATMEGA 328P-MU - Meningkatkan Level Pengembangan Arduino</a></li>
<li><a href="../id452236/index.html">Harmoni skrip di dalam aplikasi Android</a></li>
<li><a href="../id452240/index.html">Apa yang umum antara orgasme dan Wi-Fi</a></li>
<li><a href="../id452246/index.html">Wawancara dengan Vitaly Bragilevsky: ‚ÄúDunia di mana semua orang akan memprogram di Haskell bukan dunia yang baik‚Äù</a></li>
<li><a href="../id452248/index.html">Kami memompa pengembangan pada Vue menggunakan pola: HOC</a></li>
<li><a href="../id452252/index.html">Keamanan bergaya Google</a></li>
<li><a href="../id452254/index.html">Tip & Trik Forensik Digital: Cara Menemukan Koin Keberuntungan Penyelundup</a></li>
<li><a href="../id452258/index.html">Corda - open source blockchain untuk bisnis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>