<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍁 🌧️ 💚 MotionLayout：动画效果更好，代码更少 💪🏼 💟 📥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Google通过发布新的便捷库和API不断改善我们的生活。 其中包括新的MotionLayout。 鉴于我们的应用程序中有大量动画，我的同事塞德里克·霍尔茨（Cedric Holtz）立即使用新的API实现了我们应用程序中最重要的动画-约会投票-使用新的API，同时节省了大量代码。 我分享他文章的翻...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>MotionLayout：动画效果更好，代码更少</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/458854/"><img src="https://habrastorage.org/webt/wk/q7/cq/wkq7cqwqisgnz3lof9qfobt5bte.png"><br>  <i>Google通过发布新的便捷库和API不断改善我们的生活。</i>  <i>其中包括新的MotionLayout。</i>  <i>鉴于我们的应用程序中有大量动画，我的同事塞德里克·霍尔茨（Cedric Holtz）立即使用新的API实现了我们应用程序中最重要的动画-约会投票-使用新的API，同时节省了大量代码。</i>  <i>我分享他文章的翻译。</i> <br><br>  Google I / O 2019大会近日结束，宣布了我们钟爱的SDK的更新和最新改进。 就个人而言，我对Nicholas Road和John Hoford的有关ConstraintLayout未来功能的演示特别感兴趣。 更具体地说，关于其以MotionLayout形式的扩展。 <br><br> 测试版发布后，我想基于此库实现一个约会动画。 <a name="habracut"></a><br><br> 首先，让我们定义术语： <br><br><blockquote>  “ MotionLayout是一种ConstraintLayout，可用于在不同状态之间设置布局动画。”  - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">文档</a> </blockquote><br><br> 如果您尚未阅读Nicholas Road <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">撰写</a>的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">一系列文章，这些文章</a>解释了MotionLayout的关键思想，那么我强烈建议您阅读它。 <br><br> 因此，在完成介绍之后，现在让我们看看我们想要得到什么： <br><br><img src="https://habrastorage.org/webt/wm/kb/qm/wmkbqmy_ulwafy_jvkvpadfafyu.gif"><br><br><h2> 卡堆 </h2><br><h3> 我们显示移动后的地图 </h3><br> 首先，将MotionLayout添加到布局目录中，该目录到目前为止仅包含一张顶层卡片： <br><br><pre><code class="kotlin hljs">&lt;androidx.constraintlayout.motion.widget.MotionLayout android:id=<span class="hljs-string"><span class="hljs-string">"@+id/motionLayout"</span></span>     xmlns:android=<span class="hljs-string"><span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span>     xmlns:app=<span class="hljs-string"><span class="hljs-string">"http://schemas.android.com/apk/res-auto"</span></span>     android:layout_width=<span class="hljs-string"><span class="hljs-string">"match_parent"</span></span>     android:layout_height=<span class="hljs-string"><span class="hljs-string">"match_parent"</span></span>     app:layoutDescription=<span class="hljs-string"><span class="hljs-string">"@xml/scene_swipe"</span></span>     app:motionDebug=<span class="hljs-string"><span class="hljs-string">"SHOW_ALL"</span></span>&gt;     &lt;FrameLayout         android:id=<span class="hljs-string"><span class="hljs-string">"@+id/topCard"</span></span>         android:layout_width=<span class="hljs-string"><span class="hljs-string">"0dp"</span></span>         android:layout_height=<span class="hljs-string"><span class="hljs-string">"0dp"</span></span> /&gt; &lt;/androidx.constraintlayout.motion.widget.MotionLayout&gt;</code> </pre> <br> 请注意以下行：app：motionDebug =“ SHOW_ALL”。 它使我们能够显示调试信息，对象的轨迹，动画开始和结束的状态以及当前进度。 该行在调试时有很大帮助，但不要忘记在将其发送到产品之前将其删除：对此没有任何提醒。 <br><br> 如您所见，我们在这里没有为视图设置任何限制。 它们将从我们现在定义的场景（MotionScene）中获取。 <br><br> 让我们从定义初始状态开始：一张卡位于屏幕中央，周围有凹痕。 <br><br><pre> <code class="kotlin hljs">&lt;MotionScene xmlns:android=<span class="hljs-string"><span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span>    xmlns:app=<span class="hljs-string"><span class="hljs-string">"http://schemas.android.com/apk/res-auto"</span></span>&gt;    &lt;ConstraintSet android:id=<span class="hljs-string"><span class="hljs-string">"@+id/rest"</span></span>&gt;        &lt;Constraint            android:id=<span class="hljs-string"><span class="hljs-string">"@id/topCard"</span></span>            android:layout_width=<span class="hljs-string"><span class="hljs-string">"match_parent"</span></span>            android:layout_height=<span class="hljs-string"><span class="hljs-string">"match_parent"</span></span>            android:layout_marginBottom=<span class="hljs-string"><span class="hljs-string">"50dp"</span></span>            android:layout_marginEnd=<span class="hljs-string"><span class="hljs-string">"50dp"</span></span>            android:layout_marginStart=<span class="hljs-string"><span class="hljs-string">"50dp"</span></span>            android:layout_marginTop=<span class="hljs-string"><span class="hljs-string">"50dp"</span></span>            app:layout_constraintEnd_toEndOf=<span class="hljs-string"><span class="hljs-string">"parent"</span></span>            app:layout_constraintStart_toStartOf=<span class="hljs-string"><span class="hljs-string">"parent"</span></span>&gt;    &lt;/ConstraintSet&gt; &lt;/MotionScene&gt;</code> </pre> <br> 添加约束集（ConstraintSet）通过等。 当顶部卡完全向左或向右移动时，它们将反映顶部卡的状态。 我们希望地图停止运行，然后从屏幕上消失，以显示精美的动画来确认我们的决定。 <br><br><pre> <code class="kotlin hljs">&lt;ConstraintSet    android:id=<span class="hljs-string"><span class="hljs-string">"@+id/pass"</span></span>    app:deriveConstraintsFrom=<span class="hljs-string"><span class="hljs-string">"@+id/rest"</span></span>&gt;    &lt;Constraint        android:id=<span class="hljs-string"><span class="hljs-string">"@id/topCard"</span></span>        android:layout_width=<span class="hljs-string"><span class="hljs-string">"0dp"</span></span>        android:layout_height=<span class="hljs-string"><span class="hljs-string">"match_parent"</span></span>        android:layout_marginBottom=<span class="hljs-string"><span class="hljs-string">"80dp"</span></span>        android:layout_marginEnd=<span class="hljs-string"><span class="hljs-string">"200dp"</span></span>        android:layout_marginStart=<span class="hljs-string"><span class="hljs-string">"50dp"</span></span>        android:layout_marginTop=<span class="hljs-string"><span class="hljs-string">"20dp"</span></span>        app:layout_constraintEnd_toEndOf=<span class="hljs-string"><span class="hljs-string">"parent"</span></span>        app:layout_constraintWidth_percent=<span class="hljs-string"><span class="hljs-string">"0.7"</span></span> /&gt; &lt;/ConstraintSet&gt; &lt;ConstraintSet    android:id=<span class="hljs-string"><span class="hljs-string">"@+id/like"</span></span>    app:deriveConstraintsFrom=<span class="hljs-string"><span class="hljs-string">"@id/rest"</span></span>&gt;    &lt;Constraint        android:id=<span class="hljs-string"><span class="hljs-string">"@id/topCard"</span></span>        android:layout_width=<span class="hljs-string"><span class="hljs-string">"0dp"</span></span>        android:layout_height=<span class="hljs-string"><span class="hljs-string">"match_parent"</span></span>        android:layout_marginBottom=<span class="hljs-string"><span class="hljs-string">"80dp"</span></span>        android:layout_marginEnd=<span class="hljs-string"><span class="hljs-string">"50dp"</span></span>        android:layout_marginStart=<span class="hljs-string"><span class="hljs-string">"200dp"</span></span>        android:layout_marginTop=<span class="hljs-string"><span class="hljs-string">"20dp"</span></span>        app:layout_constraintStart_toStartOf=<span class="hljs-string"><span class="hljs-string">"parent"</span></span>        app:layout_constraintWidth_percent=<span class="hljs-string"><span class="hljs-string">"0.7"</span></span> /&gt; &lt;/ConstraintSet&gt;</code> </pre><br> 将两组约束添加到上一个场景。 它们几乎是相同的，仅在屏幕的两面都镜像。 <br><br> 现在我们有了三组限制-开始，喜欢和通过。 让我们定义这些状态之间的过渡。 <br><br> 为此，请在左侧添加一个过渡以进行滑动，在右侧添加另一个过渡以进行滑动。 <br><br><pre> <code class="kotlin hljs">&lt;Transition    app:constraintSetEnd=<span class="hljs-string"><span class="hljs-string">"@+id/pass"</span></span>    app:constraintSetStart=<span class="hljs-string"><span class="hljs-string">"@+id/rest"</span></span>    app:duration=<span class="hljs-string"><span class="hljs-string">"300"</span></span>&gt;    &lt;OnSwipe        app:dragDirection=<span class="hljs-string"><span class="hljs-string">"dragLeft"</span></span>        app:onTouchUp=<span class="hljs-string"><span class="hljs-string">"autoComplete"</span></span>        app:touchAnchorId=<span class="hljs-string"><span class="hljs-string">"@id/topCard"</span></span>        app:touchAnchorSide=<span class="hljs-string"><span class="hljs-string">"left"</span></span>        app:touchRegionId=<span class="hljs-string"><span class="hljs-string">"@id/topCard"</span></span> /&gt; &lt;/Transition&gt; &lt;Transition    app:constraintSetEnd=<span class="hljs-string"><span class="hljs-string">"@+id/like"</span></span>    app:constraintSetStart=<span class="hljs-string"><span class="hljs-string">"@+id/rest"</span></span>    app:duration=<span class="hljs-string"><span class="hljs-string">"300"</span></span>&gt;    &lt;OnSwipe        app:dragDirection=<span class="hljs-string"><span class="hljs-string">"dragRight"</span></span>        app:onTouchUp=<span class="hljs-string"><span class="hljs-string">"autoComplete"</span></span>        app:touchAnchorId=<span class="hljs-string"><span class="hljs-string">"@+id/topCard"</span></span>        app:touchAnchorSide=<span class="hljs-string"><span class="hljs-string">"right"</span></span>        app:touchRegionId=<span class="hljs-string"><span class="hljs-string">"@id/topCard"</span></span> /&gt; &lt;/Transition&gt;</code> </pre><br> 因此，对于最上面的卡片，我们将滑动动画设置在左侧，而将相同动画-镜像设置在右侧。 <br><br> 这些属性将有助于改善与场景的交互： <br><br><ul><li>  touchRegionId：由于我们在地图周围添加了填充，因此我们需要确保仅在地图本身的区域而不是整个MotionLayout中识别触摸。 可以使用touchRegionId完成。 <br></li><li>  onTouchUp：放开卡片后动画会发生什么？ 它应该继续前进或返回其初始状态，因此适用于autoComplete。 <br></li></ul><br> 让我们看看发生了什么： <br><br><img src="https://habrastorage.org/webt/zs/zq/ox/zszqoxe4dsdpphvu3fro0_3tjtk.gif"><br><br><h3> 地图会自动从屏幕上消失 </h3><br> 现在，我们将处理动画，动画将在地图离开屏幕时开始。 <br><br> 我们为动画的每个最终状态添加了另外两个ConstraintSet集：贴图离开屏幕的左侧和右侧。 <br><br> 在下面的示例中，我将显示如何设置like状态，并且pass状态将对其进行镜像。 在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">存储库中</a>可以完全看到一个工作示例。 <br><br><pre> <code class="kotlin hljs">&lt;ConstraintSet android:id=<span class="hljs-string"><span class="hljs-string">"@+id/offScreenLike"</span></span>&gt;    &lt;Constraint        android:id=<span class="hljs-string"><span class="hljs-string">"@id/topCard"</span></span>        android:layout_width=<span class="hljs-string"><span class="hljs-string">"0dp"</span></span>        android:layout_height=<span class="hljs-string"><span class="hljs-string">"match_parent"</span></span>        android:layout_marginBottom=<span class="hljs-string"><span class="hljs-string">"80dp"</span></span>        android:layout_marginEnd=<span class="hljs-string"><span class="hljs-string">"50dp"</span></span>        android:layout_marginTop=<span class="hljs-string"><span class="hljs-string">"20dp"</span></span>        app:layout_constraintStart_toEndOf=<span class="hljs-string"><span class="hljs-string">"parent"</span></span>        app:layout_constraintWidth_percent=<span class="hljs-string"><span class="hljs-string">"0.7"</span></span> /&gt;   &lt;/ConstraintSet&gt;</code> </pre> <br> 现在，与前面的示例一样，您需要确定从滑动状态到最终状态的过渡。 滑动动画后，过渡应立即自动工作。 这可以使用autoTransition完成： <br><br><pre> <code class="kotlin hljs">&lt;Transition app:autoTransition=<span class="hljs-string"><span class="hljs-string">"animateToEnd"</span></span> app:constraintSetEnd=<span class="hljs-string"><span class="hljs-string">"@+id/offScreenLike"</span></span> app:constraintSetStart=<span class="hljs-string"><span class="hljs-string">"@+id/like"</span></span> app:duration=<span class="hljs-string"><span class="hljs-string">"150"</span></span> /&gt;</code> </pre><br> 现在，我们有了可以从屏幕上刷卡的刷卡！ <br><br><img src="https://habrastorage.org/webt/vt/ip/i0/vtipi0xzpmomh5mlkqpoytwedze.gif"><br><br><h3> 底图动画 </h3><br><br> 现在让我们制作底牌，以创造甲板无限的错觉。 <br><br> 向布局添加一个地图，类似于第一个： <br><br><pre> <code class="kotlin hljs">&lt;FrameLayout    android:id=<span class="hljs-string"><span class="hljs-string">"@+id/bottomCard"</span></span>    android:layout_width=<span class="hljs-string"><span class="hljs-string">"0dp"</span></span>    android:layout_height=<span class="hljs-string"><span class="hljs-string">"0dp"</span></span>    android:background=<span class="hljs-string"><span class="hljs-string">"@color/colorAccent"</span></span> /&gt;</code> </pre> <br> 更改XML以设置在动画的每个阶段应用于此贴图的限制： <br><br><pre> <code class="kotlin hljs">&lt;ConstraintSet android:id=<span class="hljs-string"><span class="hljs-string">"@id/rest"</span></span>&gt;    &lt;!-- ... --&gt;    &lt;Constraint android:id=<span class="hljs-string"><span class="hljs-string">"@id/bottomCard"</span></span>&gt;        &lt;Layout            android:layout_width=<span class="hljs-string"><span class="hljs-string">"match_parent"</span></span>            android:layout_height=<span class="hljs-string"><span class="hljs-string">"match_parent"</span></span>            android:layout_marginBottom=<span class="hljs-string"><span class="hljs-string">"50dp"</span></span>            android:layout_marginEnd=<span class="hljs-string"><span class="hljs-string">"50dp"</span></span>            android:layout_marginStart=<span class="hljs-string"><span class="hljs-string">"50dp"</span></span>            android:layout_marginTop=<span class="hljs-string"><span class="hljs-string">"50dp"</span></span> /&gt;        &lt;Transform            android:scaleX=<span class="hljs-string"><span class="hljs-string">"0.90"</span></span>            android:scaleY=<span class="hljs-string"><span class="hljs-string">"0.90"</span></span> /&gt;    &lt;/Constraint&gt; &lt;/ConstraintSet&gt; &lt;ConstraintSet    android:id=<span class="hljs-string"><span class="hljs-string">"@+id/offScreenLike"</span></span>    app:deriveConstraintsFrom=<span class="hljs-string"><span class="hljs-string">"@id/like"</span></span>&gt;    &lt;!-- ... --&gt;    &lt;Constraint android:id=<span class="hljs-string"><span class="hljs-string">"@id/bottomCard"</span></span>&gt;        &lt;Transform            android:scaleX=<span class="hljs-string"><span class="hljs-string">"1"</span></span>            android:scaleY=<span class="hljs-string"><span class="hljs-string">"1"</span></span> /&gt;    &lt;/Constraint&gt; &lt;/ConstraintSet&gt;</code> </pre> <br> 为此，我们可以使用便捷的ConstraintSet属性。 <br><br> 默认情况下，每个新集都采用父级MotionLayout的属性。 但是，使用emergeConstraintsFrom标志，可以为我们的集合设置另一个父对象。 应该记住的是，如果我们使用约束标签设置约束，那么我们将从父集合中重新定义所有约束。 为避免这种情况，您可以在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">标签中</a>设置特定的属性，以便仅替换它们。 <br><br><img src="https://habrastorage.org/webt/vz/ff/zb/vzffzb5u7rlwpayywz7zfm6gnyk.png"><br><br> 在我们的情况下，这意味着在通行证集中，我们没有定义Layout标签，而是从父级复制它。 但是，我们覆盖了Transform，因此，我们将Transform标记中指定的所有属性替换为我们自己的属性，在这种情况下，将更改比例。 <br><br> 这就是使用MotionLayout添加新元素并将其与场景的动画无缝集成起来非常容易的过程。 <br><br><img src="https://habrastorage.org/webt/_-/73/jp/_-73jp-vstz02uondgcnyzwcxqe.gif"><br><br><h3> 使动画永无止境 </h3><br><br> 动画完成后，不能将顶部的卡片刷掉，因为现在它已成为底部的卡片。 要获得无尽的动画，您需要交换卡片。 <br><br> 首先，我想通过一个新的过渡来做到这一点： <br><br><pre> <code class="kotlin hljs">&lt;Transition    app:autoTransition=<span class="hljs-string"><span class="hljs-string">"jumpToEnd"</span></span>    app:constraintSetEnd=<span class="hljs-string"><span class="hljs-string">"@+id/rest"</span></span>    app:constraintSetStart=<span class="hljs-string"><span class="hljs-string">"@+id/offScreenLike"</span></span>    app:duration=<span class="hljs-string"><span class="hljs-string">"0"</span></span> /&gt;</code> </pre> <br><img src="https://habrastorage.org/webt/jb/6h/lz/jb6hlzynphpyptximrzq1wgfqfw.gif"><br><br> 整个动画将按预期播放。 现在，我们有一堆纸牌，您可以无休止地刷卡！ <br><br> 轻扫一下，我发现了一些东西。 触摸卡片时，将停止过渡到卡片组动画的结尾。 即使动画持续时间为零，它仍然会停止，这很糟糕。 <br><br><img src="https://habrastorage.org/webt/yv/nq/mo/yvnqmowevaznpjimh5kbtiplwco.gif"><br><br> 我设法仅以一种方式获胜-通过以编程方式更改MotionLayout中的活动过渡。 <br><br> 为此，我们将在动画完成时设置一个回调。 一旦完成offScreenLike和offScreenPass，我们只需将转换重置回休止状态并将进度归零。 <br><br><pre> <code class="kotlin hljs">motionLayout.setTransitionListener(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> : TransitionAdapter() {    <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onTransitionCompleted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(motionLayout: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">MotionLayout</span></span></span></span><span class="hljs-function"><span class="hljs-params">, currentId: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> {        <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (currentId) {            R.id.offScreenPass,            R.id.offScreenLike -&gt; {                motionLayout.progress = <span class="hljs-number"><span class="hljs-number">0f</span></span>                motionLayout.setTransition(R.id.rest, R.id.like)            }        }    }   })</code> </pre> <br> 设置，通过或喜欢哪种过渡都没关系，滑动时切换到所需的过渡。 <br><br><img src="https://habrastorage.org/webt/li/9b/yo/li9byopqw8itzxzsgj2wgwbufxm.gif"><br><br> 看起来一样，但是动画不会停止！ 让我们继续前进！ <br><br><h3> 资料绑定 </h3><br> 创建测试数据以显示在地图上。 目前，我们将仅限于更改每张卡的背景颜色。 <br><br> 我们使用svayp方法创建一个ViewModel，该方法仅替换新数据。 通过以下方式将其绑定到活动： <br><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> viewModel = ViewModelProviders .of(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) .<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(SwipeRightViewModel::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">viewModel</span></span></span><span class="hljs-class"> .</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">modelStream</span></span></span><span class="hljs-class"> .</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">observe</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, Observer { bindCard(it) }) motionLayout.setTransitionListener(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> : TransitionAdapter() { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onTransitionCompleted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(motionLayout: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">MotionLayout</span></span></span></span><span class="hljs-function"><span class="hljs-params">, currentId: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (currentId) { R.id.offScreenPass, R.id.offScreenLike -&gt; { motionLayout.progress = <span class="hljs-number"><span class="hljs-number">0f</span></span> motionLayout.setTransition(R.id.rest, R.id.like) viewModel.swipe() } } } })</code> </pre><br> 仍然需要通知ViewModel滑动动画的完成，并且它将更新当前显示的数据。 <br><br><img src="https://habrastorage.org/webt/vl/j6/ar/vlj6arofcxa3lc7ny2z-ww1yxxg.gif"><br><br><h2> 弹出图标 </h2><br> 添加两个视图，这些视图在滑动时会出现在屏幕的一侧（下面仅显示一个，第二个已镜像）。 <br><br><pre> <code class="kotlin hljs">&lt;ImageView android:id=<span class="hljs-string"><span class="hljs-string">"@+id/likeIndicator"</span></span> android:layout_width=<span class="hljs-string"><span class="hljs-string">"0dp"</span></span> android:layout_height=<span class="hljs-string"><span class="hljs-string">"0dp"</span></span> /&gt;</code> </pre><br> 现在，对于地图，您需要使用这些视图设置动画状态。 <br><br><pre> <code class="kotlin hljs">&lt;ConstraintSet android:id=<span class="hljs-string"><span class="hljs-string">"@id/rest"</span></span>&gt;    &lt;!-- ... --&gt;    &lt;Constraint android:id=<span class="hljs-string"><span class="hljs-string">"@+id/like"</span></span>&gt;        &lt;Layout            android:layout_width=<span class="hljs-string"><span class="hljs-string">"40dp"</span></span>            android:layout_height=<span class="hljs-string"><span class="hljs-string">"40dp"</span></span>            app:layout_constraintBottom_toBottomOf=<span class="hljs-string"><span class="hljs-string">"parent"</span></span>            app:layout_constraintStart_toEndOf=<span class="hljs-string"><span class="hljs-string">"parent"</span></span>            app:layout_constraintTop_toTopOf=<span class="hljs-string"><span class="hljs-string">"parent"</span></span> /&gt;        &lt;Transform            android:scaleX=<span class="hljs-string"><span class="hljs-string">"0.5"</span></span>            android:scaleY=<span class="hljs-string"><span class="hljs-string">"0.5"</span></span> /&gt;        &lt;PropertySet android:alpha=<span class="hljs-string"><span class="hljs-string">"0"</span></span> /&gt;    &lt;/Constraint&gt;   &lt;/ConstraintSet&gt; &lt;ConstraintSet    android:id=<span class="hljs-string"><span class="hljs-string">"@+id/like"</span></span>    app:deriveConstraintsFrom=<span class="hljs-string"><span class="hljs-string">"@id/rest"</span></span>&gt;    &lt;!-- ... --&gt;    &lt;Constraint android:id=<span class="hljs-string"><span class="hljs-string">"@+id/like"</span></span>&gt;        &lt;Layout            android:layout_width=<span class="hljs-string"><span class="hljs-string">"100dp"</span></span>            android:layout_height=<span class="hljs-string"><span class="hljs-string">"100dp"</span></span>            app:layout_constraintBottom_toBottomOf=<span class="hljs-string"><span class="hljs-string">"@id/topCard"</span></span>            app:layout_constraintEnd_toEndOf=<span class="hljs-string"><span class="hljs-string">"@id/topCard"</span></span>            app:layout_constraintStart_toStartOf=<span class="hljs-string"><span class="hljs-string">"@id/topCard"</span></span>            app:layout_constraintTop_toTopOf=<span class="hljs-string"><span class="hljs-string">"@id/topCard"</span></span> /&gt;        &lt;Transform            android:scaleX=<span class="hljs-string"><span class="hljs-string">"1"</span></span>            android:scaleY=<span class="hljs-string"><span class="hljs-string">"1"</span></span> /&gt;        &lt;PropertySet android:alpha=<span class="hljs-string"><span class="hljs-string">"1"</span></span> /&gt;    &lt;/Constraint&gt; &lt;/ConstraintSet&gt;</code> </pre><br> 由于动画是从父级继承的，因此无需对超出屏幕的动画设置限制。 在我们的情况下，这是滑动状态。 <br><br> 这就是我们要做的。 现在，您可以非常轻松地将组件添加到动画链中。 <br><br><img src="https://habrastorage.org/webt/wg/4g/1g/wg4g1grirk3zwqrfzwyahfp8i3i.gif"><br><br><h2> 以编程方式运行动画 </h2><br><br> 我们可以在卡上创建两个按钮，以便用户不仅可以滑动，还可以使用按钮进行控制。 <br><br> 每个按钮与滑动一样开始相同的动画。 <br><br> 与往常一样，订阅按钮单击，然后直接在MotionLayout对象上启动动画： <br><br><pre> <code class="kotlin hljs">likeButton.setOnClickListener {    motionLayout.transitionToState(R.id.like) } passButton.setOnClickListener {    motionLayout.transitionToState(R.id.pass) }</code> </pre><br> 我们需要在顶部和底部卡片上都添加按钮，以便动画连续播放。 但是，对于下部地图，不需要单击订阅，因为它不可见或已为上部地图设置了动画，并且我们不想中断它。 <br><br><img src="https://habrastorage.org/webt/ic/zj/_v/iczj_vz8nrpdzlxtmjsaqc3bmiu.gif"><br><br>  MotionLayout如何为我们处理状态变化的另一个很好的例子。 让我们稍微放慢动画的速度： <br><br><img src="https://habrastorage.org/webt/d6/bk/ne/d6bkne2bvugopppwypug25l30m8.gif"><br><br> 看一下Pass替换时MotionLayout执行的过渡。 魔术！ <br><br><h1> 沿曲线滑动地图 </h1><br> 假设我们喜欢地图不是沿直线移动而是沿曲线移动（说实话，我只是想尝试这样做）。 <br><br> 然后，您需要为两个方向上的移动定义KeyPosition，以使移动路径被弧形弯曲。 <br><br> 将此添加到运动场景： <br><br><pre> <code class="kotlin hljs">&lt;Transition    app:constraintSetEnd=<span class="hljs-string"><span class="hljs-string">"@+id/like"</span></span>    app:constraintSetStart=<span class="hljs-string"><span class="hljs-string">"@+id/rest"</span></span>    app:duration=<span class="hljs-string"><span class="hljs-string">"300"</span></span>&gt;    &lt;!-- ... --&gt;    &lt;KeyFrameSet&gt;        &lt;KeyPosition            app:drawPath=<span class="hljs-string"><span class="hljs-string">"path"</span></span>            app:framePosition=<span class="hljs-string"><span class="hljs-string">"50"</span></span>            app:keyPositionType=<span class="hljs-string"><span class="hljs-string">"pathRelative"</span></span>            app:motionTarget=<span class="hljs-string"><span class="hljs-string">"@id/topCard"</span></span>            app:percentX=<span class="hljs-string"><span class="hljs-string">"0.5"</span></span>            app:percentY=<span class="hljs-string"><span class="hljs-string">"-0.1"</span></span> /&gt;           &lt;/KeyFrameSet&gt; &lt;/Transition&gt;</code> </pre> <br><img src="https://habrastorage.org/webt/ij/z4/4m/ijz44micij7kdu81k4-tc-zggjc.gif"><br> 现在，地图沿着非平直的弯曲路径移动。 神奇地！ <br><br><h1> 结论 </h1><br> 当您将创建这些动画时获得的代码量与当前生产中类似动画的实现进行比较时，结果令人震惊。 <br><br>  MotionLayout不知不觉地处理取消过渡（例如，在触摸时），创建动画链，在过渡期间更改属性等等。 该工具从根本上改变了一切，从而大大简化了UI逻辑。 <br><br> 还有其他一些值得努力的事情（主要是在RecyclerView中禁用动画和双向滚动），但是我确信这是可以解决的。 <br><br> 请记住，该库仍处于beta状态，但它已经为我们带来了许多激动人心的机会。 我们期待着MotionLayout的发布，我相信它会在将来多次派上用场。 您可以从<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">存储库中的</a>本文中看到功能全面的应用程序。 <br><br>  <i>附注：由于他们让我担任翻译，因此我们的Android团队拥有<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">开发人员的位置</a> 。</i>  <i>谢谢您的关注。</i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN458854/">https://habr.com/ru/post/zh-CN458854/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN458842/index.html">耐心和劳动将摘录全文</a></li>
<li><a href="../zh-CN458844/index.html">通过VeriSM™适应方法进行筒仓破坏</a></li>
<li><a href="../zh-CN458846/index.html">如何使用Unity开发另一个平台游戏。 另一个教程</a></li>
<li><a href="../zh-CN458848/index.html">Rust 1.36.0版本：未来特性，分配稳定和MaybeUninit <T></a></li>
<li><a href="../zh-CN458850/index.html">廉价而高效地学习英语。 第二部分</a></li>
<li><a href="../zh-CN458856/index.html">便宜和昂贵的AAA电池</a></li>
<li><a href="../zh-CN458860/index.html">调整Linux内核参数以优化PostgreSQL</a></li>
<li><a href="../zh-CN458864/index.html">Bot开发人员争夺TamTam</a></li>
<li><a href="../zh-CN458866/index.html">团队平衡器在《战车世界：闪击战》中的运作方式</a></li>
<li><a href="../zh-CN458868/index.html">大数据中的噪音。 熵分析</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>