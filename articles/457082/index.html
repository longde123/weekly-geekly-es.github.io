<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìù üö∂üèø ü•© Concesi√≥n imperceptible de derechos de administrador üëè ‚úåüèª üë®üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Todo el viernes, amigos. Hoy compartimos con ustedes otro material traducido en v√≠speras del lanzamiento del curso de ingenier√≠a inversa . 



 Tuve u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Concesi√≥n imperceptible de derechos de administrador</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/457082/">  Todo el viernes, amigos.  Hoy compartimos con ustedes otro material traducido en v√≠speras del lanzamiento del curso de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ingenier√≠a inversa</a> . <br><br><img src="https://habrastorage.org/webt/cv/me/5s/cvme5snsza_im0wjpdevttzzcz4.png"><br><br>  Tuve una idea genial de c√≥mo hacer que un usuario ejecute su aplicaci√≥n sin ingenier√≠a social o utilizando exploits de terceros.  Adem√°s, simplemente puede avanzar e iniciar una infecci√≥n masiva de archivos ejecutables, pero esto puede causar muchos problemas imprevistos, y tambi√©n significa que las aplicaciones firmadas digitalmente de proveedores confiables aparecer√°n como archivos no confiables.  Es una buena idea "capturar" solo un dll.  No llamar√© a este m√©todo para omitir UAC (Control de cuenta de usuario), porque a√∫n necesita obtener permiso para ejecutar la aplicaci√≥n (no la suya). <br><a name="habracut"></a><br><h2>  Loadlibrary </h2><br>  Es posible que ya est√© familiarizado con este concepto, pero sin embargo le explicar√© de qu√© se trata.  Cuando la aplicaci√≥n llama a LoadLibrary en el archivo dll, pero no proporciona la ruta completa al archivo, el sistema primero verifica la clave de registro KnownDlls, en la que busca la ruta, si no est√° all√≠, el sistema buscar√° en el directorio desde el que se ejecut√≥ la aplicaci√≥n y luego buscar√° en rutas de sistema como system32 / syswow64. <br><br>  Puede colocar su archivo dll en el mismo directorio que la aplicaci√≥n y asignarle el mismo nombre que tendr√≠a un archivo dll del sistema cargado normalmente, pero en cualquier caso, su archivo dll debe cumplir los siguientes requisitos: <br><br><ul><li>  La aplicaci√≥n debe descargar el dll por nombre y no por la ruta completa (como suele ser el caso); </li><li>  La biblioteca requerida no debe existir en HKLM \ SYSTEM \ CurrentControlSet \ Control \ Session Manager \ KnownDLLs; </li><li>  Su dll debe coincidir con la arquitectura del procesador (recuerde que los procesadores de 64 bits simplemente omitir√°n las bibliotecas de 32 bits y viceversa); </li><li>  La biblioteca est√° ubicada en System32 o Syswow64, ya que las rutas espec√≠ficas a menudo no funcionan. </li></ul><br>  El virus ZeroAccess utiliz√≥ este m√©todo para aprovechar la "ingenier√≠a social" y obligar al usuario a ejecutar el archivo.  Para empezar, el instalador de Adobe Flash se descarg√≥ del oficial, el dll del bot se grab√≥ en el mismo directorio que el instalador y luego se inici√≥ el instalador.  Cuando se ejecuta el instalador, el control de cuenta de usuario muestra un mensaje de que la aplicaci√≥n es suministrada por una fuente confiable de "Adobe Systems Incorporated", y es m√°s probable que el usuario instale esta aplicaci√≥n (esto lleva a la ejecuci√≥n de un dll de bot malicioso). <br><br><img src="https://habrastorage.org/webt/nv/9y/me/nv9ymec9x5znwvun7_kiiihga6a.png"><br>  <i>¬øEs esta una actualizaci√≥n real de Flash Player?</i>  <i>¬øO ZeroAccess?</i>  <i>Nadie lo sabe</i> <br><br><h2>  M√©todo menos invasivo </h2><br>  Imagine que hay una carpeta en la que se encuentran el 90% de las aplicaciones que requieren derechos de cuenta elevados y que se puede escribir sin este tipo de derechos.  Bueno, dicha carpeta existe y esta es la <code>%userprofile%Downloads</code> .  Probablemente entiendas a lo que me refiero. <br><br>  No esperaba encontrar un archivo DLL que carga la mayor√≠a de las aplicaciones y al mismo tiempo cumple con todos los criterios para un <code>dwmapi.dll</code> malicioso, y despu√©s de unos cinco minutos de b√∫squeda encontr√© una mina de oro: <code>dwmapi.dll</code> .  Esta biblioteca no solo cumpli√≥ con todos los criterios, sino que tambi√©n descarg√≥ todos los archivos de instalaci√≥n.  Ahora <code>‚Äúdwmapi.dll‚Äù</code> nuestro propio dll, <code>‚Äúdwmapi.dll‚Äù</code> nombre <code>‚Äúdwmapi.dll‚Äù</code> , <code>‚Äúdwmapi.dll‚Äù</code> en la carpeta Descargas y ejecute el archivo de instalaci√≥n. <br><br><img src="https://habrastorage.org/webt/8w/qr/2u/8wqr2u8hmdbdwm4nkuzb81leen4.png"><br><br>  √âxito!  Pero el hecho es que tan pronto como comencemos la instalaci√≥n, no funcionar√°, ya que hemos reemplazado una biblioteca importante, pero esto es f√°cil de solucionar.  Infectamos el dll. <br><br><h2>  Crear un dll infectar </h2><br>  Al principio, solo quer√≠a agregar un nuevo encabezado de secci√≥n, cambiar el campo NumberOfSections en el encabezado PE y luego agregar mi secci√≥n al final del archivo PE.  Result√≥ que inmediatamente despu√©s del √∫ltimo encabezado de secci√≥n hay un directorio de importaci√≥n relacionado que ser√° sobrescrito por nuestro encabezado de secci√≥n.  Por lo tanto, despu√©s de aproximadamente 2 horas de escribir una aplicaci√≥n para restaurar todo el PE desde cero, alguien me record√≥ que el directorio de importaci√≥n vinculado solo existe para acelerar la descarga de archivos importados y puede sobrescribirse, y luego simplemente deshabilitarse en el encabezado del PE. <br><br>  Durante los siguientes 15 minutos sostuve CTRL + Z para volver a donde comenc√© y me sent√≠ est√∫pido.  Despu√©s de dos l√≠neas de c√≥digo, mi infector funcion√≥ como deber√≠a y podr√≠a pasar al siguiente paso.  Ahora el infector simplemente desconecta y reescribe el directorio de importaci√≥n relacionado con un nuevo encabezado de secci√≥n, agrega una nueva secci√≥n al final del archivo PE, ajusta SizeOfImage para acomodar la nueva secci√≥n y luego cambia AddressOfEntryPoint para que apunte a nuestra nueva secci√≥n. <br><br>  Todo lo que necesitamos ahora es el c√≥digo que ponemos all√≠. <br><br><h2>  Shellcode </h2><br>  La elecci√≥n obvia era forzar a la secci√≥n agregada a ejecutar shellcode, por lo que no ten√≠amos que preocuparnos por las reubicaciones e importaciones.  El c√≥digo real es bastante simple y est√° escrito usando algunas macros FASM convenientes, voy a repasar r√°pidamente c√≥mo funciona. <br><br><ul><li>  La pila se verifica para asegurarse de que DLL_PROCESS_ATTACH ha llamado a dwmapi.dll; </li><li>  La estructura Ldr PEB se utiliza para obtener la direcci√≥n base de Kernel32 y Ntdll; </li><li>  Se utiliza una implementaci√≥n simple de GetProcAddress para importar las siguientes funciones: NtOpenProcessToken, NtQueryInformationToken, NtClose, ExpandEnvironmentStringsA, CreateProcessA; </li><li>  El token de proceso actual se abre y el c√≥digo le solicita que confirme que la aplicaci√≥n desde la que estamos comenzando tiene derechos de administrador de UAC; </li><li>  Resulta la ruta cmd.exe y luego se llama a la l√≠nea de comando; </li><li>  La ejecuci√≥n se transfiere nuevamente al punto de entrada real de dwmapi.dll, por lo que la ejecuci√≥n puede continuar. </li></ul><br><h2>  Poniendo todo junto </h2><br>  El resultado final de la operaci√≥n infecta dwmapi.dll con nuestro shellcode y lo coloca en la carpeta de descarga, tan pronto como el usuario descarga y ejecuta el instalador, que requiere derechos de administrador, se llamar√° a una l√≠nea de comando como administrador (debido a Wow64FsRedirect y al hecho de que la mayor√≠a de las configuraciones funcionan con wow64, podemos usar el mismo c√≥digo en sistemas Windows de 32 bits y 64 bits). <br><br>  Puede encontrar el infector completo y el c√≥digo de shell en mi github: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/MalwareTech/UACElevator</a> . <br><br>  Eso es todo.  ¬°Nos vemos en el curso! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/457082/">https://habr.com/ru/post/457082/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../457068/index.html">Colas: ¬øqu√© es, por qu√© y c√≥mo usarlo? Eche un vistazo a las caracter√≠sticas de AWS SQS</a></li>
<li><a href="../457070/index.html">Textolita en lugar de cart√≥n. Algunas palabras sobre la insignia interactiva OFFZONE 2019</a></li>
<li><a href="../457072/index.html">C√≥mo resolver un viejo problema usando ML en Python y .Net</a></li>
<li><a href="../457074/index.html">La evoluci√≥n de los desarrolladores: qu√© juegos debemos esperar en el futuro</a></li>
<li><a href="../457078/index.html">C√≥mo convertir tu avatar de Telegram en un reloj</a></li>
<li><a href="../457086/index.html">Patr√≥n arquitect√≥nico "Constructor" en el universo de "Swift" y "iOS" / "macOS"</a></li>
<li><a href="../457090/index.html">Cunas de seguridad: JWT</a></li>
<li><a href="../457094/index.html">Complemento de Excel que facilita la configuraci√≥n de filtros cuando se trabaja con cubos (VBA)</a></li>
<li><a href="../457096/index.html">Liberamos nuestras manos a varios analistas: API Livy para la automatizaci√≥n de tareas bancarias t√≠picas</a></li>
<li><a href="../457098/index.html">Elegante manejo de errores de JavaScript con la m√≥nada Either</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>