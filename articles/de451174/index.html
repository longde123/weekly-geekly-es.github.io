<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏾‍🤝‍👨🏽 👨🏾‍🔧 👈🏿 Anpassung von Programmen für ZX Spectrum an TR-DOS mit modernen Mitteln. Teil 1 👂🏾 ⏏️ ☯️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Im Gegensatz zu modernen Computern war das Konzept eines Dateisystems in den Spektren nicht so. Dies bedeutet, dass für das Herunterladen von jedem Me...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Anpassung von Programmen für ZX Spectrum an TR-DOS mit modernen Mitteln. Teil 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451174/"><p>  Im Gegensatz zu modernen Computern war das Konzept eines Dateisystems in den Spektren nicht so.  Dies bedeutet, dass für das Herunterladen von jedem Medientyp eine separate Implementierung erforderlich war und das Programm in den meisten Fällen nicht einfach vom Band auf die Festplatte kopiert werden konnte.  In Fällen, in denen der Programmlader in BASIC geschrieben wurde, konnte er mit einer relativ einfachen Überarbeitung an TR-DOS angepasst werden.  Die Situation wurde jedoch durch die Tatsache kompliziert, dass in vielen Spielen (sowohl mit Marken als auch mit Hacking) die Lader in Maschinencodes geschrieben waren und manchmal einen Kopierschutz enthielten. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/d31/cb0/62d/d31cb062dbd020dbb43d9379fc640042.jpg" alt="5,25 &quot;Diskette"></p><br><p> Trotz des Vorhandenseins eines „magischen Knopfes“, der lediglich den Speicher des Computers vollständig entleerte und es ermöglichte, das Programm auf einer Diskette zu speichern, wurde von Experten in Betracht gezogen, Diskettenversionen von Spielen zu erstellen, wobei das ursprüngliche Startabbild und andere Attribute beibehalten wurden. </p><br><p>  In diesem Artikel werde ich Ihnen <a href="">erklären</a> , wie Sie eine solche Anpassung am Beispiel des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Pac-Man-</a> Spiels durchführen, nämlich am Originalbild von <a href="">Pac-Man.tzx</a> . </p><a name="habracut"></a><br><h2 id="instrumenty">  Die Werkzeuge </h2><br><p>  Trotz der Tatsache, dass früher alle diese Arbeiten direkt auf dem ZX Spectrum ausgeführt wurden (ohne andere Optionen), werde ich das Spiel mithilfe des Emulators und der Befehlszeilenprogramme anpassen.  Der Hauptgrund ist, dass der Anpassungsprozess insbesondere zunächst aus einer großen Anzahl von Versuchen und Irrtümern besteht und bei Automatisierung viel weniger schmerzhaft verläuft.  Gleiches kann direkt auf dem Spektrum erfolgen. </p><br><p>  Im ersten Teil werden wir die folgenden Werkzeuge verwenden: </p><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Sicherungsemulator</a> zum Debuggen und Testen. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">SkoolKit</a> zum Zerlegen. </li></ol><br><h2 id="otklyuchenie-avtozapuska-v-zagruzchike">  Deaktivieren des Starts im Bootloader </h2><br><p>  Da die Bild- und Datendatei ohne Headerblock heruntergeladen wird (17 Byte mit Name und Dateityp), bedeutet dies, dass der Loader in Maschinencodes geschrieben ist.  Sie müssen herausfinden, wo sich diese Codes befinden und von welcher Adresse aus sie gestartet werden. </p><br><p>  Es gibt verschiedene Möglichkeiten, den Bootloader-Code anzuzeigen: </p><br><ol><li><p> Am einfachsten ist es, das Programm herunterzuladen, auf den Start des Bootloaders zu warten und es durch Drücken der Leertaste zu stoppen.  In vielen Fällen funktioniert dies, aber im Fall von Pacman führt dies wie in vielen anderen Fällen zu einem Zurücksetzen. </p><br></li><li><p>  Der nächste Weg ist das Laden des Programms mit <code>MERGE ""</code> anstelle von <code>LOAD ""</code> .  Im Gegensatz zu <code>LOAD</code> ignoriert <code>MERGE</code> die Programmautorun.  Im Fall von Pac-Man führt das Booten über <code>MERGE</code> dass der Computer mit einer charakteristischen Verschiebung des linken Bildschirms einfriert.  Dies liegt daran, dass <code>MERGE</code> das Programm nicht zeilenweise ausführt, sondern versucht, es vollständig zu analysieren und mit dem bereits geladenen Programm zusammenzuführen.  Wenn das Programm jedoch einen Block mit Maschinencodes hat, der gegen die Syntax des Programms verstößt, führt dies zu einem Absturz. </p><br></li><li><p>  Wenn Sie sich nicht den <code>listbasic</code> zerbrechen möchten, können Sie das Bandabbild von TZX in TAP konvertieren und das mit Fuse <code>listbasic</code> Dienstprogramm verwenden: </p><br><pre> <code class="plaintext hljs">$ tzx2tap Pac-Man.tzx $ listbasic Pac-Man.tap 1 RANDOMIZE USR (PEEK 23635+256*PEEK 23636+91)</code> </pre> <br><p>  Die Adresse <code>23635</code> ( <code>$5C53</code> ) entspricht der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>PROG</code></a> Systemvariablen, die die Startadresse des BASIC-Bereichs enthält.  Somit ist der Einstiegspunkt zum Bootloader gegenüber dem BASIC-Bereich um 91 Bytes versetzt. </p><br></li><li><p>  Eine andere Möglichkeit, den Bootloader zu betrachten, ist im Artikel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Desativando a autoexecução de um programa BASIC beschrieben</a> .  Im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Fuse-Debugger müssen</a> Sie einen Haltepunkt <code>br 2053</code> festlegen, das Programm laden und nach Abschluss des Downloads und Beendigung der Codeausführung den <code>set 23619 128</code> ausführen.  Dadurch wird verhindert, dass das Programm gestartet wird, und Sie können BASIC beenden. </p><br></li></ol><br><h2 id="dizassemblirovanie-zagruzchika">  Demontage des Bootloaders </h2><br><p>  Wenn Sie die Verschiebung des Einstiegspunkts relativ zum BASIC-Bereich kennen, können Sie seine absolute Adresse berechnen.  Beim ZX Spectrum 48K ohne geladenes TR-DOS beginnt der BASIC-Bereich bei <code>23755</code> ( <code>$5CCB</code> ).  Folglich startet der Bootloader bei <code>23755 + 91 = 23846</code> ( <code>$5D26</code> ). </p><br><p>  Um zu beginnen, setzen Sie einfach einen Haltepunkt an die Startadresse und sehen Sie sich die Maschinencodes an.  In Fuse können Sie <code>br 23846</code> und mit dem Herunterladen des Programms beginnen.  Sobald der Bootloader ausgeführt wird, stoppt der Emulator: </p><br><p><img src="https://habrastorage.org/webt/g7/8k/ih/g78kihkxufy7bakgg9qey9a0d7c.png" alt="Debugger"></p><br><p>  Wenn der Loader sehr einfach ist, sehen Sie sich einfach den zerlegten Code im mittleren Bereich an und verstehen Sie, was geladen wird.  Normalerweise sieht der Download-Code für eine Datei ohne Header ungefähr so ​​aus: </p><br><pre> <code class="plaintext hljs">LD IX, $8000 ;    LD DE, $4000 ;    LD A, $FF ;    CALL $0556 ;  LD-BYTES JP $8000 ;   </code> </pre> <br><p>  In einem komplexeren Fall mit Codeausführung müssen Sie die Schritte verstehen und Notizen machen.  Die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">SkoolKit</a> Utility Suite ist dafür gut geeignet.  Wenn Sie sich ein Ziel setzen, kann das Spiel mit seiner Hilfe bis zur letzten Schraube (Nachricht, Sprite, Sound) analysiert werden.  Wie dies gemacht wird, wird in der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dokumentation</a> ausführlich beschrieben. </p><br><p>  Kurz gesagt, gehen Sie wie folgt vor: </p><br><ol><li>  <code>Pac-Man.z80</code> mit <code>tap2sna.py</code> oder den Emulatorfunktionen einen Schnappschuss des <code>Pac-Man.z80</code> Computerspeichers. </li><li>  Erstellen Sie eine <code>Pac-Man.ctl</code> Steuerdatei mit einer ersten Anleitung zum Zerlegen: <br><pre> <code class="plaintext hljs">i 16384 Ignore for now c $5D26 Loader</code> </pre> </li><li>  Führen Sie die Demontage aus: <code>sna2skool.py -H -c Pac-Man.ctl Pac-Man.z80 &gt; Pac-Man.skool</code> . </li><li>  Fügen Sie der Lerndatei neue Anweisungen und Kommentare hinzu, während Sie den Code studieren. </li><li>  Wiederholen, bis alles vollständig erleuchtet ist. </li></ol><br><p>  Als Ergebnis erhalten wir nach dem ersten Durchgang Folgendes (meine Kommentare, Adressen werden weggelassen): </p><br><pre> <code class="plaintext hljs">ORG $5D26 ;   23846,   ;   DI IM 1 ;   LD D, IYh ; LD E, IYl ; LD B, $25 ;    EX DE, HL ; LD DE, $0019 ; ADD HL, DE ;    HL  $5C53 (  PROG) LD E, (HL) ;   PROG  DE  IX INC HL ; LD D, (HL) ; LD IXh, D ; LD IXl, E ; LD A, (IX+$7F) ;      (  $7F-  ;  PROG) LD HL, $0035 ;    ($35   PROG) ADD HL, DE ; PUSH HL ;      XOR (HL) ;    LD (HL), A ; INC HL ; DJNZ $5D43 ;   AND (HL) ; RET NZ ;           ;    DEFB $77</code> </pre> <br><h2 id="rasshifrovka-zagruzchika">  Bootloader-Entschlüsselung </h2><br><p>  Alles, was wirklich wichtig ist, ist, dass sich der entschlüsselte Bootloader bei <code>PROG + $35</code> .  Dies bedeutet, dass, wenn wir einen Haltepunkt auf <code>br 23808</code> , zu diesem Zeitpunkt die Entschlüsselung abgeschlossen ist, wir den entschlüsselten Bootloader sehen: </p><br><p><img src="https://habrastorage.org/webt/to/qq/4b/toqq4bfw1kqi5vzbmbvzmlno0e8.png" alt="Lader"></p><br><p>  Dieses Programm ist dem oben erwähnten typischen Fall bereits viel ähnlicher.  Der Wert <code>$4000</code> ( <code>16384</code> ) wird in die Register <code>IX</code> und <code>DE</code> geladen, etwas anderes wird getan und die Steuerung wird bei <code>$055A</code> an die ROM-Routine <code>$055A</code> (dies ist einige Bytes niedriger als der Standardeintrittspunkt in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>LD-BYTES</code></a> ).  Es scheint, dass dieser Ansatz eine Art Kopierschutz implementiert, weil  Die Standardprozedur lädt diese Datei nicht und einige Kopisten verstehen sie nicht. </p><br><h2 id="tochka-vhoda-v-programmu">  Programmeinstiegspunkt </h2><br><p>  Es bleibt abzuwarten, wie das Programm nach dem Laden aufgerufen wird.  Anstelle der üblichen <code>CALL LD-BYTES</code> und <code>JP</code> werden hier <code>LD SP, XXXX</code> und <code>JP LD-BYTES</code> verwendet.  Die erste (übliche) Option funktioniert wie folgt: </p><br><ol><li>  <code>CALL</code> schiebt den aktuellen Wert des Software-Zählers ( <code>PC</code> ) auf den Stapel. </li><li>  Die Steuerung wird an die aufgerufene Routine übergeben. </li><li>  Bei der Rückkehr von einem Unterprogramm ( <code>RET</code> ) wird der Wert vom Stapel entfernt und es erfolgt ein Übergang zum aufrufenden Programm. </li></ol><br><p>  Warum wird es hier anders gemacht?  Tatsache ist, dass Pac-Man mit dem ZX Spectrum 16K kompatibel ist und absolut den gesamten RAM belegt (siehe Dateigröße oben).  Daher überschreibt sich das Programm beim Laden sowohl den Loader als auch den Stack, wo immer sie sich befinden.  Wenn wir mithilfe des Stacks vom ROM zum Bootloader wechseln und dann das heruntergeladene Programm über <code>JP</code> aufrufen möchten, gibt es zum Zeitpunkt des Downloads weder eine Speicheradresse, in der sich <code>JP</code> befindet, noch die Anweisung selbst. </p><br><p>  Stattdessen bewegt sich der Stapelzeiger in den Speicherbereich, in dem nach dem Laden die Adresse des Einstiegspunkts in das Programm angezeigt wird, und der Prozessor, der das Spoofing nicht bemerkt, entfernt es mit dem neuen Zeiger vom Stapel und wechselt zur angegebenen Adresse. </p><br><p>  Das vollständige <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Demontageergebnis</a> kann im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Projekt-Repository</a> auf dem Github angezeigt werden. </p><br><h2 id="itogo">  Insgesamt </h2><br><p>  Als Ergebnis des Studiums des Bootloaders haben wir Folgendes herausgefunden: </p><br><ol><li>  Eine Datei ohne Header mit einer Länge von 16384 Bytes wird bei 16384 heruntergeladen (im Bildschirmbereich, der im Allgemeinen während des Downloadvorgangs offensichtlich ist). </li><li>  Am Ende des Downloads befindet sich der Stapelzeiger bei <code>$5D7C</code> , wo die Steuerung übertragen wird. </li></ol><br><p>  In den folgenden Abschnitten werde ich darüber sprechen, wie Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dateien</a> für das Schreiben auf die Festplatte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">vorbereiten</a> und einen Monoblock-Datei-Loader in Assembler schreiben. </p><br><h3 id="ssylki-po-teme">  Verwandte Links: </h3><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Profil "TRUB Spectrumist".</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Reverse Engineering von ZX Spectrum (Z80) -Spielen</a> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Adaptação de jogos de fita für Beta 48</a> . </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de451174/">https://habr.com/ru/post/de451174/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de451162/index.html">Fehlerkorrektur - Physikalische Konstanten in der gegenwärtigen und neuen Version des Internationalen Einheitensystems (SI)</a></li>
<li><a href="../de451164/index.html">Auf der Suche nach freien Parkplätzen mit Python</a></li>
<li><a href="../de451166/index.html">Was bieten die neuen Repositories für AI- und MO-Systeme?</a></li>
<li><a href="../de451170/index.html">Jeff Bezos kündigte Pläne an, den Mond zu erobern</a></li>
<li><a href="../de451172/index.html">Julia: Funktionen und Strukturen als Funktionen</a></li>
<li><a href="../de451176/index.html">Nachrichten aus der Welt von OpenStreetMap Nr. 458 (23.04.2019 - 09.04.2019)</a></li>
<li><a href="../de451178/index.html">Crew Dragon Parachute Landing Crash Test</a></li>
<li><a href="../de451180/index.html">PCB ersetzt zwei Linearmotoren</a></li>
<li><a href="../de451182/index.html">Wie Größen von C-Arrays Teil der binären Schnittstelle der Bibliothek wurden</a></li>
<li><a href="../de451184/index.html">Blue Origin Blue Moon-Projekt: Menschen auf dem Mond bis 2024</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>