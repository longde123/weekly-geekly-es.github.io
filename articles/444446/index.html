<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ÜîÔ∏è ü§õüèº üçí Hacer una aplicaci√≥n web moderna desde cero ‚¨ÜÔ∏è üíÜ üë®‚Äçüë®‚Äçüëß‚Äçüë¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Entonces, decidiste hacer un nuevo proyecto. Y este proyecto es una aplicaci√≥n web. ¬øCu√°nto tiempo llevar√° crear un prototipo b√°sico? Que tan dificil ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Hacer una aplicaci√≥n web moderna desde cero</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/444446/"> Entonces, decidiste hacer un nuevo proyecto.  Y este proyecto es una aplicaci√≥n web.  ¬øCu√°nto tiempo llevar√° crear un prototipo b√°sico?  Que tan dificil es  ¬øQu√© debe hacer un sitio web moderno desde el principio? <br><br>  En este art√≠culo, intentaremos esbozar la plantilla de una aplicaci√≥n web simple con la siguiente arquitectura: <br><br><div style="text-align:center;"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/ul/ne/9v/ulne9vljujdrtxnf-qeqrrux7da.png"></a> </div><br>  Lo que cubriremos: <br><br><ul><li>  configurando el entorno de desarrollo en docker-compose. </li><li>  Creaci√≥n de backend en Flask. </li><li>  creando una interfaz en Express. </li><li>  Construye JS usando Webpack. </li><li>  Reacci√≥n, Redux y representaci√≥n del lado del servidor. </li><li>  colas de tareas con RQ. </li></ul><a name="habracut"></a><br><h2>  Introduccion </h2><br>  Antes del desarrollo, por supuesto, ¬°primero debes decidir qu√© estamos desarrollando!  Como una aplicaci√≥n modelo para este art√≠culo, decid√≠ hacer un motor wiki primitivo.  Tendremos tarjetas emitidas en Markdown;  se pueden ver y (en alg√∫n momento en el futuro) ofrecer ediciones.  Todo esto lo organizaremos como una aplicaci√≥n de una p√°gina con representaci√≥n del lado del servidor (que es absolutamente necesaria para indexar nuestros futuros terabytes de contenido). <br><br>  Echemos un vistazo un poco m√°s detallado a los componentes que necesitamos para esto: <br><br><ul><li>  <b>Cliente</b>  Creemos una aplicaci√≥n de una p√°gina (es decir, con transiciones de p√°gina usando AJAX) en el paquete <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">React</a> + <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Redux</a> , que es muy com√∫n en el mundo front-end. </li><li>  <b>Frontend</b>  Creemos un servidor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Express</a> simple que muestre nuestra aplicaci√≥n React (solicitando todos los datos necesarios en el backend de forma asincr√≥nica) y se la emita al usuario. </li><li>  <b>Backend</b>  Maestro de la l√≥gica de negocios, nuestro backend ser√° una peque√±a aplicaci√≥n de Flask.  Almacenaremos datos (nuestras tarjetas) en el popular repositorio de documentos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">MongoDB</a> , y para la cola de tareas y, posiblemente, en el futuro, el almacenamiento en cach√©, usaremos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Redis</a> . </li><li>  <b>TRABAJADOR</b>  La biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">RQ</a> lanzar√° un contenedor separado para tareas pesadas. </li></ul><br><h2>  Infraestructura: git </h2><br>  Probablemente, no podr√≠amos hablar de esto, pero, por supuesto, llevaremos a cabo el desarrollo en el repositorio de git. <br><br><pre><code class="bash hljs">git init git remote add origin git@github.com:Saluev/habr-app-demo.git git commit --allow-empty -m <span class="hljs-string"><span class="hljs-string">"Initial commit"</span></span> git push</code> </pre> <br>  (Aqu√≠ debe completar de inmediato <code>.gitignore</code> ). <br><br>  El borrador final se puede ver <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en Github</a> .  Cada secci√≥n del art√≠culo corresponde a una confirmaci√≥n (¬°rebautic√© mucho para lograr esto!). <br><br><h2>  Infraestructura: docker-compose </h2><br>  Comencemos por configurar el entorno.  Con la abundancia de componentes que tenemos, una soluci√≥n de desarrollo muy l√≥gica ser√≠a usar docker-compose. <br><br>  Agregue el archivo <code>docker-compose.yml</code> al repositorio <code>docker-compose.yml</code> siguiente contenido: <br><br><pre> <code class="plaintext hljs">version: '3' services: mongo: image: "mongo:latest" redis: image: "redis:alpine" backend: build: context: . dockerfile: ./docker/backend/Dockerfile environment: - APP_ENV=dev depends_on: - mongo - redis ports: - "40001:40001" volumes: - .:/code frontend: build: context: . dockerfile: ./docker/frontend/Dockerfile environment: - APP_ENV=dev - APP_BACKEND_URL=backend:40001 - APP_FRONTEND_PORT=40002 depends_on: - backend ports: - "40002:40002" volumes: - ./frontend:/app/src worker: build: context: . dockerfile: ./docker/worker/Dockerfile environment: - APP_ENV=dev depends_on: - mongo - redis volumes: - .:/code</code> </pre><br>  Echemos un vistazo r√°pido a lo que est√° sucediendo aqu√≠. <br><br><ul><li>  Se crean un contenedor MongoDB y un contenedor Redis. </li><li>  Se crea un contenedor para nuestro backend (que describimos a continuaci√≥n).  Se le pasa la variable de entorno APP_ENV = dev (la veremos para comprender qu√© configuraciones de Flask cargar), y su puerto 40001 se abrir√° afuera (a trav√©s de √©l, nuestro cliente de navegador ir√° a la API). </li><li>  Se crea un contenedor de nuestra interfaz.  Tambi√©n se incluyen una variedad de variables de entorno, que nos ser√°n √∫tiles m√°s adelante, y se abre el puerto 40002. Este es el puerto principal de nuestra aplicaci√≥n web: en el navegador iremos a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http: // localhost: 40002</a> . </li><li>  Se crea el contenedor de nuestro trabajador.  No necesita puertos externos, y solo se requiere acceso en MongoDB y Redis. </li></ul><br>  Ahora creemos dockerfiles.  En este momento, una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">serie de</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">traducciones de</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">excelentes</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culos</a> sobre Docker est√° llegando a Habr√©: puede ir all√≠ con seguridad para todos los detalles. <br><br>  Comencemos con el backend. <br><br><pre> <code class="plaintext hljs"># docker/backend/Dockerfile FROM python:stretch COPY requirements.txt /tmp/ RUN pip install -r /tmp/requirements.txt ADD . /code WORKDIR /code CMD gunicorn -w 1 -b 0.0.0.0:40001 --worker-class gevent backend.server:app</code> </pre><br>  Se entiende que corremos a trav√©s de la aplicaci√≥n Gunicorn Flask, escondi√©ndonos bajo la <code>app</code> nombre en el m√≥dulo <code>backend.server</code> . <br><br>  No menos importante <code>docker/backend/.dockerignore</code> : <br><br><pre> <code class="plaintext hljs">.git .idea .logs .pytest_cache frontend tests venv *.pyc *.pyo</code> </pre><br>  El trabajador generalmente es similar al backend, solo que en lugar de gunicorn tenemos el lanzamiento habitual de un m√≥dulo de pozo: <br><br><pre> <code class="plaintext hljs"># docker/worker/Dockerfile FROM python:stretch COPY requirements.txt /tmp/ RUN pip install -r /tmp/requirements.txt ADD . /code WORKDIR /code CMD python -m worker</code> </pre><br>  Haremos todo el trabajo en <code>worker/__main__.py</code> . <br><br>  <code>.dockerignore</code> trabajador <code>.dockerignore</code> es completamente similar al backend <code>.dockerignore</code> . <br><br>  Finalmente, la interfaz.  Hay un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo completamente separado</a> sobre √©l sobre Habr√©, pero a juzgar por la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">extensa discusi√≥n sobre StackOverflow</a> y los comentarios en el esp√≠ritu de "Chicos, ¬øya es 2018, todav√≠a no hay una soluci√≥n normal?"  No todo es tan simple all√≠.  Me decid√≠ por esta versi√≥n del archivo acoplable. <br><br><pre> <code class="plaintext hljs"># docker/frontend/Dockerfile FROM node:carbon WORKDIR /app #  package.json  package-lock.json   npm install,   . COPY frontend/package*.json ./ RUN npm install #       , #     PATH. ENV PATH /app/node_modules/.bin:$PATH #      . ADD frontend /app/src WORKDIR /app/src RUN npm run build CMD npm run start</code> </pre><br>  Pros: <br><br><ul><li>  todo se almacena en cach√© como se esperaba (en la capa inferior - dependencias, en la parte superior - la compilaci√≥n de nuestra aplicaci√≥n); </li><li>  <code>docker-compose exec frontend npm install --save newDependency</code> funciona como deber√≠a y modifica <code>package.json</code> en nuestro repositorio (que no ser√≠a el caso si <code>docker-compose exec frontend npm install --save newDependency</code> COPY, como muchas personas sugieren).  No ser√≠a deseable ejecutar <code>npm install --save newDependency</code> fuera del contenedor de todos modos, porque algunas dependencias del nuevo paquete ya pueden estar presentes y construirse bajo una plataforma diferente (debajo de la del acoplador, y no bajo nuestro macbook de trabajo, por ejemplo ) y, sin embargo, generalmente no queremos exigir la presencia de Node en la m√°quina de desarrollo.  ¬°Un Docker para gobernarlos a todos! </li></ul><br>  Bueno y por supuesto <code>docker/frontend/.dockerignore</code> : <br><br><pre> <code class="plaintext hljs">.git .idea .logs .pytest_cache backend worker tools node_modules npm-debug tests venv</code> </pre><br>  Por lo tanto, nuestro marco contenedor est√° listo y puede llenarlo con contenido. <br><br><h2>  Backend: marco de matraz </h2><br>  Agregue <code>flask</code> , <code>flask-cors</code> , <code>gevent</code> y <code>gunicorn</code> a <code>gunicorn</code> y cree una aplicaci√≥n Flask simple en <code>backend/server.py</code> . <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># backend/server.py import os.path import flask import flask_cors class HabrAppDemo(flask.Flask): def __init__(self, *args, **kwargs): super().__init__(*args, **kwargs) # CORS        #    ,      # (  Access-Control-Origin  ). #   - . flask_cors.CORS(self) app = HabrAppDemo("habr-app-demo") env = os.environ.get("APP_ENV", "dev") print(f"Starting application in {env} mode") app.config.from_object(f"backend.{env}_settings")</span></span></code> </pre><br>  Le dijimos a Flask que extraiga la configuraci√≥n del archivo de fondo <code>backend.{env}_settings</code> , lo que significa que tambi√©n tendremos que crear un archivo (al menos vac√≠o) <code>backend/dev_settings.py</code> para que todo despegue. <br><br>  ¬°Ahora podemos LEVANTAR oficialmente nuestro backend! <br><br><pre> <code class="plaintext hljs">habr-app-demo$ docker-compose up backend ... backend_1 | [2019-02-23 10:09:03 +0000] [6] [INFO] Starting gunicorn 19.9.0 backend_1 | [2019-02-23 10:09:03 +0000] [6] [INFO] Listening at: http://0.0.0.0:40001 (6) backend_1 | [2019-02-23 10:09:03 +0000] [6] [INFO] Using worker: gevent backend_1 | [2019-02-23 10:09:03 +0000] [9] [INFO] Booting worker with pid: 9</code> </pre><br>  Seguimos adelante. <br><br><h2>  Frontend: marco Express </h2><br>  Comencemos creando un paquete.  Despu√©s de haber creado la carpeta frontend y ejecutar <code>npm init</code> en ella, despu√©s de algunas preguntas poco sofisticadas, obtenemos el paquete.json terminado en el esp√≠ritu <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"habr-app-demo"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"This is an app demo for Habr article."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"main"</span></span>: <span class="hljs-string"><span class="hljs-string">"index.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"scripts"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"test"</span></span>: <span class="hljs-string"><span class="hljs-string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"repository"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"git"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"git+https://github.com/Saluev/habr-app-demo.git"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"author"</span></span>: <span class="hljs-string"><span class="hljs-string">"Tigran Saluev &lt;tigran@saluev.com&gt;"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"license"</span></span>: <span class="hljs-string"><span class="hljs-string">"MIT"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"bugs"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://github.com/Saluev/habr-app-demo/issues"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"homepage"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://github.com/Saluev/habr-app-demo#readme"</span></span> }</code> </pre><br>  En el futuro, no necesitamos Node.js en absoluto en la m√°quina del desarrollador (aunque todav√≠a podr√≠amos esquivar e iniciar <code>npm init</code> trav√©s de Docker, pero bueno). <br><br>  En <code>Dockerfile</code> mencionamos <code>npm run build</code> y <code>npm run start</code> : debe agregar los comandos apropiados a <code>package.json</code> : <br><br><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- a/frontend/package.json +++ b/frontend/package.json @@ -4,6 +4,8 @@ "description": "This is an app demo for Habr article.", "main": "index.js", "scripts": { + "build": "echo 'build'", + "start": "node index.js", "test": "echo \"Error: no test specified\" &amp;&amp; exit 1" }, "repository": {</span></span></code> </pre><br>  El comando de <code>build</code> todav√≠a no hace nada, pero a√∫n nos ser√° √∫til. <br><br>  Agregue dependencias <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Express</a> y cree una aplicaci√≥n simple en <code>index.js</code> : <br><br><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- a/frontend/package.json +++ b/frontend/package.json @@ -17,5 +17,8 @@ "bugs": { "url": "https://github.com/Saluev/habr-app-demo/issues" }, - "homepage": "https://github.com/Saluev/habr-app-demo#readme" + "homepage": "https://github.com/Saluev/habr-app-demo#readme", + "dependencies": { + "express": "^4.16.3" + } }</span></span></code> </pre><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/index.js const express = require("express"); app = express(); app.listen(process.env.APP_FRONTEND_PORT); app.get("*", (req, res) =&gt; { res.send("Hello, world!") });</span></span></code> </pre><br>  ¬°Ahora <code>docker-compose up frontend</code> eleva nuestro frontend!  Adem√°s, en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http: // localhost: 40002</a> , el cl√°sico "Hola, mundo" ya deber√≠a presumir. <br><br><h2>  Frontend: compilaci√≥n con webpack y aplicaci√≥n React </h2><br>  Es hora de representar algo m√°s que texto sin formato en nuestra aplicaci√≥n.  En esta secci√≥n, agregaremos el componente React m√°s simple de la <code>App</code> y configuraremos el ensamblaje. <br><br>  Al programar en React, es muy conveniente usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">JSX</a> , un dialecto de JavaScript extendido por construcciones sint√°cticas del formulario <br><br><pre> <code class="javascript hljs">render() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">MyButton</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">color</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"blue"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">{this.props.caption}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">MyButton</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>; }</code> </pre><br>  Sin embargo, los motores de JavaScript no lo entienden, por lo que generalmente la fase de compilaci√≥n se agrega a la interfaz.  Los compiladores especiales de JavaScript (s√≠, s√≠) convierten el az√∫car sint√°ctico en JavaScript <s>feo</s> cl√°sico, manejan importaciones, minimizan, etc. <br><br><img src="https://habrastorage.org/webt/f1/rl/0j/f1rl0jer0cxs_ll69yagvwm_0gc.jpeg"><br><br>  <i>2014 a√±o.</i>  <i>apt-cache search java</i> <br><br>  Entonces, el componente React m√°s simple parece muy simple. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/components/app.js import React, {Component} from 'react' class App extends Component { render() { return &lt;h1&gt;Hello, world!&lt;/h1&gt; } } export default App</span></span></code> </pre><br>  Simplemente mostrar√° nuestro saludo con un alfiler m√°s convincente. <br><br>  Agregue el archivo <code>frontend/src/template.js</code> contiene el marco HTML m√≠nimo de nuestra futura aplicaci√≥n: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/template.js export default function template(title) { let page = ` &lt;!DOCTYPE html&gt; &lt;html lang="en"&gt; &lt;head&gt; &lt;meta charset="utf-8"&gt; &lt;title&gt;${title}&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;div id="app"&gt;&lt;/div&gt; &lt;script src="/dist/client.js"&gt;&lt;/script&gt; &lt;/body&gt; &lt;/html&gt; `; return page; }</span></span></code> </pre><br>  Agregue un punto de entrada de cliente: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/client.js import React from 'react' import {render} from 'react-dom' import App from './components/app' render( &lt;App/&gt;, document.querySelector('#app') );</span></span></code> </pre><br>  Para construir toda esta belleza, necesitamos: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">webpack</a> es un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">creador</a> juvenil de moda para JS (aunque no he le√≠do art√≠culos en la interfaz durante tres horas, por lo que no estoy seguro de la moda); <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">babel</a> es un compilador para todo tipo de lociones como JSX y, al mismo tiempo, un proveedor de polyfill para todos los casos de IE. <br><br>  Si la iteraci√≥n anterior de la interfaz a√∫n se est√° ejecutando, todo lo que tiene que hacer es <br><br><pre> <code class="bash hljs">docker-compose <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> frontend npm install --save \ react \ react-dom docker-compose <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> frontend npm install --save-dev \ webpack \ webpack-cli \ babel-loader \ @babel/core \ @babel/polyfill \ @babel/preset-env \ @babel/preset-react</code> </pre><br>  instalar nuevas dependencias  Ahora configure webpack: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/webpack.config.js const path = require("path"); //  . clientConfig = { mode: "development", entry: { client: ["./src/client.js", "@babel/polyfill"] }, output: { path: path.resolve(__dirname, "../dist"), filename: "[name].js" }, module: { rules: [ { test: /\.js$/, exclude: /node_modules/, loader: "babel-loader" } ] } }; //  .     : // 1. target: "node" -      import path. // 2.   ..,    ../dist --   //    ,   ! serverConfig = { mode: "development", target: "node", entry: { server: ["./index.js", "@babel/polyfill"] }, output: { path: path.resolve(__dirname, ".."), filename: "[name].js" }, module: { rules: [ { test: /\.js$/, exclude: /node_modules/, loader: "babel-loader" } ] } }; module.exports = [clientConfig, serverConfig];</span></span></code> </pre><br>  Para que Babel funcione, debe configurar <code>frontend/.babelrc</code> : <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"presets"</span></span>: [<span class="hljs-string"><span class="hljs-string">"@babel/env"</span></span>, <span class="hljs-string"><span class="hljs-string">"@babel/react"</span></span>] }</code> </pre><br>  Finalmente, haga que nuestro <code>npm run build</code> significativo: <br><br><pre> <code class="json hljs">// frontend/package.json ... <span class="hljs-string"><span class="hljs-string">"scripts"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"build"</span></span>: <span class="hljs-string"><span class="hljs-string">"webpack"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: <span class="hljs-string"><span class="hljs-string">"node /app/server.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"test"</span></span>: <span class="hljs-string"><span class="hljs-string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span></span> }, ...</code> </pre><br>  Ahora nuestro cliente, junto con un paquete de polyfills y todas sus dependencias, se ejecuta a trav√©s de babel, compila y se pliega en un archivo <code>../dist/client.js</code> monol√≠tico <code>../dist/client.js</code> .  Agregue la capacidad de cargarlo como un archivo est√°tico a nuestra aplicaci√≥n Express, y en la ruta predeterminada comenzaremos a devolver nuestro HTML: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/index.js // ,    , //  - . import express from 'express' import template from './src/template' let app = express(); app.use('/dist', express.static('../dist')); app.get("*", (req, res) =&gt; { res.send(template("Habr demo app")); }); app.listen(process.env.APP_FRONTEND_PORT);</span></span></code> </pre><br>  √âxito!  Ahora, si ejecutamos <code>docker-compose up --build frontend</code> , veremos "¬°Hola, mundo!"  en un envoltorio nuevo y brillante, y si tiene instalada la extensi√≥n React Developer Tools ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Chrome</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Firefox</a> ), tambi√©n hay un √°rbol de componentes React en las herramientas de desarrollador: <br><br><img src="https://habrastorage.org/webt/q1/it/gu/q1itgukw2k0ko60pghlwwkfqfn0.png"><br><br><h2>  Backend: Datos en MongoDB </h2><br>  Antes de continuar y dar vida a nuestra aplicaci√≥n, primero debe respirarla por el backend.  Parece que √≠bamos a almacenar las tarjetas marcadas en Markdown, es hora de hacerlo. <br><br>  Si bien <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">hay ORM para MongoDB en python</a> , considero que el uso de ORM es despiadado y le dejo el estudio de las soluciones adecuadas.  En cambio, haremos una clase simple para la tarjeta y el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">DAO que</a> la acompa√±a: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># backend/storage/card.py import abc from typing import Iterable class Card(object): def __init__(self, id: str = None, slug: str = None, name: str = None, markdown: str = None, html: str = None): self.id = id self.slug = slug #    self.name = name self.markdown = markdown self.html = html class CardDAO(object, metaclass=abc.ABCMeta): @abc.abstractmethod def create(self, card: Card) -&gt; Card: pass @abc.abstractmethod def update(self, card: Card) -&gt; Card: pass @abc.abstractmethod def get_all(self) -&gt; Iterable[Card]: pass @abc.abstractmethod def get_by_id(self, card_id: str) -&gt; Card: pass @abc.abstractmethod def get_by_slug(self, slug: str) -&gt; Card: pass class CardNotFound(Exception): pass</span></span></code> </pre><br>  (Si a√∫n no utiliza anotaciones de tipo en Python, ¬°aseg√∫rese de consultar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">estos</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culos</a> !) <br><br>  Ahora <code>CardDAO</code> una implementaci√≥n de la interfaz <code>CardDAO</code> que toma un objeto de <code>Database</code> de <code>pymongo</code> (s√≠, es hora de agregar <code>pymongo</code> a <code>pymongo</code> ): <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># backend/storage/card_impl.py from typing import Iterable import bson import bson.errors from pymongo.collection import Collection from pymongo.database import Database from backend.storage.card import Card, CardDAO, CardNotFound class MongoCardDAO(CardDAO): def __init__(self, mongo_database: Database): self.mongo_database = mongo_database # , slug   . self.collection.create_index("slug", unique=True) @property def collection(self) -&gt; Collection: return self.mongo_database["cards"] @classmethod def to_bson(cls, card: Card): # MongoDB     BSON.  #       BSON- #  ,      . result = { k: v for k, v in card.__dict__.items() if v is not None } if "id" in result: result["_id"] = bson.ObjectId(result.pop("id")) return result @classmethod def from_bson(cls, document) -&gt; Card: #   ,     #     ,     #  .    id    # ,   -   . document["id"] = str(document.pop("_id")) return Card(**document) def create(self, card: Card) -&gt; Card: card.id = str(self.collection.insert_one(self.to_bson(card)).inserted_id) return card def update(self, card: Card) -&gt; Card: card_id = bson.ObjectId(card.id) self.collection.update_one({"_id": card_id}, {"$set": self.to_bson(card)}) return card def get_all(self) -&gt; Iterable[Card]: for document in self.collection.find(): yield self.from_bson(document) def get_by_id(self, card_id: str) -&gt; Card: return self._get_by_query({"_id": bson.ObjectId(card_id)}) def get_by_slug(self, slug: str) -&gt; Card: return self._get_by_query({"slug": slug}) def _get_by_query(self, query) -&gt; Card: document = self.collection.find_one(query) if document is None: raise CardNotFound() return self.from_bson(document)</span></span></code> </pre><br>  Es hora de registrar la configuraci√≥n de Monga en la configuraci√≥n del backend.  Simplemente <code>MONGO_HOST = "mongo"</code> nuestro contenedor con mongo <code>mongo</code> , entonces <code>MONGO_HOST = "mongo"</code> : <br><br><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- a/backend/dev_settings.py +++ b/backend/dev_settings.py @@ -0,0 +1,3 @@ +MONGO_HOST = "mongo" +MONGO_PORT = 27017 +MONGO_DATABASE = "core"</span></span></code> </pre><br>  Ahora necesitamos crear <code>MongoCardDAO</code> y darle acceso a la aplicaci√≥n Flask.  Aunque ahora tenemos una jerarqu√≠a de objetos muy simple (configuraci√≥n ‚Üí cliente de pymongo ‚Üí base de datos de pymongo ‚Üí <code>MongoCardDAO</code> ), <code>MongoCardDAO</code> de inmediato un componente centralizado que realice la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">inyecci√≥n de dependencia</a> (ser√° √∫til nuevamente cuando hagamos el trabajo y las herramientas). <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># backend/wiring.py import os from pymongo import MongoClient from pymongo.database import Database import backend.dev_settings from backend.storage.card import CardDAO from backend.storage.card_impl import MongoCardDAO class Wiring(object): def __init__(self, env=None): if env is None: env = os.environ.get("APP_ENV", "dev") self.settings = { "dev": backend.dev_settings, # (    # ,   !) }[env] #        . #        DI,  . self.mongo_client: MongoClient = MongoClient( host=self.settings.MONGO_HOST, port=self.settings.MONGO_PORT) self.mongo_database: Database = self.mongo_client[self.settings.MONGO_DATABASE] self.card_dao: CardDAO = MongoCardDAO(self.mongo_database)</span></span></code> </pre><br><br>  ¬°Es hora de agregar una nueva ruta a la aplicaci√≥n Flask y disfrutar de la vista! <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># backend/server.py import os.path import flask import flask_cors from backend.storage.card import CardNotFound from backend.wiring import Wiring env = os.environ.get("APP_ENV", "dev") print(f"Starting application in {env} mode") class HabrAppDemo(flask.Flask): def __init__(self, *args, **kwargs): super().__init__(*args, **kwargs) flask_cors.CORS(self) self.wiring = Wiring(env) self.route("/api/v1/card/&lt;card_id_or_slug&gt;")(self.card) def card(self, card_id_or_slug): try: card = self.wiring.card_dao.get_by_slug(card_id_or_slug) except CardNotFound: try: card = self.wiring.card_dao.get_by_id(card_id_or_slug) except (CardNotFound, ValueError): return flask.abort(404) return flask.jsonify({ k: v for k, v in card.__dict__.items() if v is not None }) app = HabrAppDemo("habr-app-demo") app.config.from_object(f"backend.{env}_settings")</span></span></code> </pre><br>  Reinicie con el <code>docker-compose up --build backend</code> : <br><br><img src="https://habrastorage.org/webt/ts/_a/1l/ts_a1ljldp9jztjvlupm4z6f29i.png"><br><br>  Vaya ... oh, exactamente.  ¬°Necesitamos agregar contenido!  Abriremos la carpeta de herramientas y agregaremos un script que agrega una tarjeta de prueba: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># tools/add_test_content.py from backend.storage.card import Card from backend.wiring import Wiring wiring = Wiring() wiring.card_dao.create(Card( slug="helloworld", name="Hello, world!", markdown=""" This is a hello-world page. """))</span></span></code> </pre><br>  El <code>docker-compose exec backend python -m tools.add_test_content</code> llenar√° nuestra monga con contenido desde el interior del contenedor de <code>docker-compose exec backend python -m tools.add_test_content</code> . <br><br><img src="https://habrastorage.org/webt/em/n2/la/emn2laspljezpnoc66oeccj42l4.png"><br><br>  √âxito!  Ahora es el momento de apoyar esto en la parte frontal. <br><br><h2>  Frontend: Redux </h2><br>  Ahora queremos hacer la ruta <code>/card/:id_or_slug</code> , mediante la cual se abrir√° nuestra aplicaci√≥n React, cargar los datos de la tarjeta desde la API y <code>/card/:id_or_slug</code> alguna manera.  Y aqu√≠, quiz√°s, la parte m√°s dif√≠cil comienza, porque queremos que el servidor nos proporcione inmediatamente HTML con el contenido de la tarjeta, adecuado para la indexaci√≥n, pero al mismo tiempo, cuando la aplicaci√≥n navega entre las tarjetas, recibe todos los datos en forma de JSON de la API, y la p√°gina no se sobrecarga.  Y para que todo esto, ¬°sin copiar y pegar! <br><br>  Comencemos agregando Redux.  Redux es una biblioteca de JavaScript para almacenar estados.  La idea es que, en lugar de los miles de estados impl√≠citos que sus componentes cambian durante las acciones del usuario y otros eventos interesantes, tienen un estado centralizado y realizan cualquier cambio a trav√©s de un mecanismo centralizado de acciones.  Entonces, si antes para la navegaci√≥n primero activamos el GIF de carga, luego hicimos una solicitud a trav√©s de AJAX y finalmente, en la devoluci√≥n de llamada exitosa, actualizamos las partes necesarias de la p√°gina, luego en el paradigma de Redux estamos invitados a enviar la acci√≥n "cambiar el contenido a un gif con animaci√≥n", que cambiar√° el estado global para que uno de sus componentes arroje el contenido anterior y coloque la animaci√≥n, luego haga una solicitud y env√≠e otra acci√≥n en su devoluci√≥n de llamada exitosa, "cambie el contenido a cargado".  En general, ahora lo veremos nosotros mismos. <br><br>  Comencemos instalando nuevas dependencias en nuestro contenedor. <br><br><pre> <code class="bash hljs">docker-compose <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> frontend npm install --save \ redux \ react-redux \ redux-thunk \ redux-devtools-extension</code> </pre><br>  El primero es, de hecho, Redux, el segundo es una biblioteca especial para cruzar React y Redux (escrito por expertos en apareamiento), el tercero es algo muy necesario, cuya necesidad est√° bien fundamentada en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">su README</a> , y, finalmente, el cuarto es la biblioteca necesaria para que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Redux DevTools</a> funcione. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Extensi√≥n</a> . <br><br>  Comencemos con el c√≥digo repetitivo de Redux: creando un reductor que no hace nada e inicializando el estado. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/redux/reducers.js export default function root(state = {}, action) { return state; }</span></span></code> </pre><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/redux/configureStore.js import {createStore, applyMiddleware} from "redux"; import thunkMiddleware from "redux-thunk"; import {composeWithDevTools} from "redux-devtools-extension"; import rootReducer from "./reducers"; export default function configureStore(initialState) { return createStore( rootReducer, initialState, composeWithDevTools(applyMiddleware(thunkMiddleware)), ); }</span></span></code> </pre><br>  Nuestro cliente cambia un poco, prepar√°ndose mentalmente para trabajar con Redux: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/client.js import React from 'react' import {render} from 'react-dom' import {Provider} from 'react-redux' import App from './components/app' import configureStore from './redux/configureStore' //      ... const store = configureStore(); render( // ...      , //     &lt;Provider store={store}&gt; &lt;App/&gt; &lt;/Provider&gt;, document.querySelector('#app') );</span></span></code> </pre><br>  Ahora podemos ejecutar docker-compose up --build frontend para asegurarnos de que nada est√© roto, y nuestro estado primitivo ha aparecido en Redux DevTools: <br><br><img src="https://habrastorage.org/webt/x0/hr/_e/x0hr_empfso4poji4s8egshlcye.png"><br><br><h2>  Frontend: P√°gina de tarjeta </h2><br>  ¬°Antes de poder crear p√°ginas con SSR, debe crear p√°ginas sin SSR!  Finalmente usemos nuestra ingeniosa API para acceder a las tarjetas y compongamos la p√°gina de la tarjeta en el front-end. <br><br>  Es hora de aprovechar la inteligencia y redise√±ar nuestra estructura estatal.  Hay <a href="">muchos</a> materiales sobre este tema, por lo que sugiero no abusar de la inteligencia y me enfocar√© en lo simple.  Por ejemplo, tales: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"page"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"card"</span></span>, //     //       type=card: <span class="hljs-string"><span class="hljs-string">"cardSlug"</span></span>: <span class="hljs-string"><span class="hljs-string">"..."</span></span>, //     <span class="hljs-attr"><span class="hljs-attr">"isFetching"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, //      API <span class="hljs-attr"><span class="hljs-attr">"cardData"</span></span>: {...}, //   (  ) // ... }, // ... }</code> </pre><br>  Consigamos el componente "tarjeta", que toma el contenido de cardData como accesorios (en realidad es el contenido de nuestra tarjeta en mongo): <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/components/card.js import React, {Component} from 'react'; class Card extends Component { componentDidMount() { document.title = this.props.name } render() { const {name, html} = this.props; return ( &lt;div&gt; &lt;h1&gt;{name}&lt;/h1&gt; &lt;!---,  HTML  React  - !--&gt; &lt;div dangerouslySetInnerHTML={{__html: html}}/&gt; &lt;/div&gt; ); } } export default Card;</span></span></code> </pre><br>  Ahora obtengamos un componente para toda la p√°gina con la tarjeta.  Ser√° responsable de obtener los datos necesarios de la API y transferirlos a la Tarjeta.  Y haremos la recuperaci√≥n de datos en la forma React-Redux. <br><br>  Primero, cree el archivo <code>frontend/src/redux/actions.js</code> y cree una acci√≥n que extraiga el contenido de la tarjeta de la API, si no es as√≠: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchCardIfNeeded</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dispatch, getState</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> state = getState().page; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state.cardData === <span class="hljs-literal"><span class="hljs-literal">undefined</span></span> || state.cardData.slug !== state.cardSlug) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dispatch(fetchCard()); } }; }</code> </pre><br>  La acci√≥n <code>fetchCard</code> , que en realidad hace que la b√∫squeda, sea un poco m√°s complicada: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchCard</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dispatch, getState</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">//    ,    . //     , , //    . dispatch(startFetchingCard()); //    API. let url = apiPath() + "/card/" + getState().page.cardSlug; // , ,   ,  //    . , ,  //    . return fetch(url) .then(response =&gt; response.json()) .then(json =&gt; dispatch(finishFetchingCard(json))); }; // ,  redux-thunk   //     . } function startFetchingCard() { return { type: START_FETCHING_CARD }; } function finishFetchingCard(json) { return { type: FINISH_FETCHING_CARD, cardData: json }; } function apiPath() { //    .    server-side // rendering,   API     -  //         localhost, //   backend. return "http://localhost:40001/api/v1"; }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬°Oh, tenemos una acci√≥n que ALGO HACE! </font><font style="vertical-align: inherit;">Esto debe ser compatible con el reductor:</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/redux/reducers.js import { START_FETCHING_CARD, FINISH_FETCHING_CARD } from "./actions"; export default function root(state = {}, action) { switch (action.type) { case START_FETCHING_CARD: return { ...state, page: { ...state.page, isFetching: true } }; case FINISH_FETCHING_CARD: return { ...state, page: { ...state.page, isFetching: false, cardData: action.cardData } } } return state; }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Preste atenci√≥n a la sintaxis moderna para clonar un objeto con campos individuales cambiantes). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora que toda la l√≥gica se lleva a cabo en las acciones de Redux, el componente en s√≠ </font></font><code>CardPage</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se ver√° relativamente simple:</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/components/cardPage.js import React, {Component} from 'react'; import {connect} from 'react-redux' import {fetchCardIfNeeded} from '../redux/actions' import Card from './card' class CardPage extends Component { componentWillMount() { //   ,  React  //   .      //   ,    " // "   ,    //  - .    -   //       HTML  // renderToString,      SSR. this.props.dispatch(fetchCardIfNeeded()) } render() { const {isFetching, cardData} = this.props; return ( &lt;div&gt; {isFetching &amp;&amp; &lt;h2&gt;Loading...&lt;/h2&gt;} {cardData &amp;&amp; &lt;Card {...cardData}/&gt;} &lt;/div&gt; ); } } //       ,   //  .        //  react-redux.   page    //  dispatch,   . function mapStateToProps(state) { const {page} = state; return page; } export default connect(mapStateToProps)(CardPage);</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Agregue un simple procesamiento page.type a nuestro componente ra√≠z de la aplicaci√≥n: </font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/components/app.js import React, {Component} from 'react' import {connect} from "react-redux"; import CardPage from "./cardPage" class App extends Component { render() { const {pageType} = this.props; return ( &lt;div&gt; {pageType === "card" &amp;&amp; &lt;CardPage/&gt;} &lt;/div&gt; ); } } function mapStateToProps(state) { const {page} = state; const {type} = page; return { pageType: type }; } export default connect(mapStateToProps)(App);</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y ahora queda el √∫ltimo momento: necesita inicializar de alguna manera </font></font><code>page.type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>page.cardSlug</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dependiendo de la URL de la p√°gina. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero todav√≠a hay muchas secciones en este art√≠culo, pero no podemos hacer una soluci√≥n de alta calidad en este momento. </font><font style="vertical-align: inherit;">Hag√°moslo est√∫pido por ahora. </font><font style="vertical-align: inherit;">Eso es completamente est√∫pido. </font><font style="vertical-align: inherit;">Por ejemplo, un habitual al inicializar la aplicaci√≥n!</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/client.js import React from 'react' import {render} from 'react-dom' import {Provider} from 'react-redux' import App from './components/app' import configureStore from './redux/configureStore' let initialState = { page: { type: "home" } }; const m = /^\/card\/([^\/]+)$/.exec(location.pathname); if (m !== null) { initialState = { page: { type: "card", cardSlug: m[1] }, } } const store = configureStore(initialState); render( &lt;Provider store={store}&gt; &lt;App/&gt; &lt;/Provider&gt;, document.querySelector('#app') );</span></span></code> </pre><br>        <code>docker-compose up --build frontend</code> ,     <code>helloworld</code> ‚Ä¶ <br><br><img src="https://habrastorage.org/webt/vj/qi/iu/vjqiiu9iu3c0ieigltqbu35smfw.png"><br><br> , ‚Ä¶     ? ,      Markdown! <br><br><h2> : RQ </h2><br>  Markdown   HTML      ‚Äî  ¬´¬ª ,   ,        ,          ‚Äî . <br><br>      ;   Redis    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">RQ</a> (Redis Queue),       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pickle</a>         . <br><br>     ,   ! <br><br><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- a/requirements.txt +++ b/requirements.txt @@ -3,3 +3,5 @@ flask-cors gevent gunicorn pymongo +redis +rq --- a/backend/dev_settings.py +++ b/backend/dev_settings.py @@ -1,3 +1,7 @@ MONGO_HOST = "mongo" MONGO_PORT = 27017 MONGO_DATABASE = "core" +REDIS_HOST = "redis" +REDIS_PORT = 6379 +REDIS_DB = 0 +TASK_QUEUE_NAME = "tasks" --- a/backend/wiring.py +++ b/backend/wiring.py @@ -2,6 +2,8 @@ import os from pymongo import MongoClient from pymongo.database import Database +import redis +import rq import backend.dev_settings from backend.storage.card import CardDAO @@ -21,3 +23,11 @@ class Wiring(object): port=self.settings.MONGO_PORT) self.mongo_database: Database = self.mongo_client[self.settings.MONGO_DATABASE] self.card_dao: CardDAO = MongoCardDAO(self.mongo_database) + + self.redis: redis.Redis = redis.StrictRedis( + host=self.settings.REDIS_HOST, + port=self.settings.REDIS_PORT, + db=self.settings.REDIS_DB) + self.task_queue: rq.Queue = rq.Queue( + name=self.settings.TASK_QUEUE_NAME, + connection=self.redis)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Un poco de c√≥digo repetitivo para el trabajador. </font></font><br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># worker/__main__.py import argparse import uuid import rq import backend.wiring parser = argparse.ArgumentParser(description="Run worker.") #   ,      #  .  ,       rq. parser.add_argument( "--burst", action="store_const", const=True, default=False, help="enable burst mode") args = parser.parse_args() #       Redis. wiring = backend.wiring.Wiring() with rq.Connection(wiring.redis): w = rq.Worker( queues=[wiring.settings.TASK_QUEUE_NAME], #         # ,    . name=uuid.uuid4().hex) w.work(burst=args.burst)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para el an√°lisis en s√≠, conecta la biblioteca de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mistune</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y escribe una funci√≥n simple:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># backend/tasks/parse.py import mistune from backend.storage.card import CardDAO def parse_card_markup(card_dao: CardDAO, card_id: str): card = card_dao.get_by_id(card_id) card.html = _parse_markdown(card.markdown) card_dao.update(card) _parse_markdown = mistune.Markdown(escape=True, hard_wrap=False)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L√≥gicamente: necesitamos </font></font><code>CardDAO</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">obtener el c√≥digo fuente de la tarjeta y guardar el resultado. </font><font style="vertical-align: inherit;">Pero un objeto que contiene una conexi√≥n a un almacenamiento externo no se puede serializar a trav√©s de pickle, lo que significa que esta tarea no se puede tomar y poner en cola de inmediato para RQ. </font><font style="vertical-align: inherit;">En el buen sentido, necesitamos crear </font></font><code>Wiring</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un trabajador a un lado y tirarlo de todo tipo ... Hag√°moslo:</font></font><br><br><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- a/worker/__main__.py +++ b/worker/__main__.py @@ -2,6 +2,7 @@ import argparse import uuid import rq +from rq.job import Job import backend.wiring @@ -16,8 +17,23 @@ args = parser.parse_args() wiring = backend.wiring.Wiring() + +class JobWithWiring(Job): + + @property + def kwargs(self): + result = dict(super().kwargs) + result["wiring"] = backend.wiring.Wiring() + return result + + @kwargs.setter + def kwargs(self, value): + super().kwargs = value + + with rq.Connection(wiring.redis): w = rq.Worker( queues=[wiring.settings.TASK_QUEUE_NAME], - name=uuid.uuid4().hex) + name=uuid.uuid4().hex, + job_class=JobWithWiring) w.work(burst=args.burst)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Declaramos nuestra clase de trabajos, lanzando el cableado como un argumento adicional de kwargs en todos los problemas. </font><font style="vertical-align: inherit;">(Tenga en cuenta que crea un cableado NUEVO cada vez, porque algunos clientes no pueden crearse antes de la bifurcaci√≥n que ocurre dentro de RQ antes de que la tarea comience a procesarse). De modo que todas nuestras tareas no dependen del cableado, es decir, de TODOS nuestros objetos, vamos a Hagamos un decorador que obtenga solo lo necesario del cableado:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># backend/tasks/task.py import functools from typing import Callable from backend.wiring import Wiring def task(func: Callable): #    : varnames = func.__code__.co_varnames @functools.wraps(func) def result(*args, **kwargs): #  .  .pop(),     # ,        . wiring: Wiring = kwargs.pop("wiring") wired_objects_by_name = wiring.__dict__ for arg_name in varnames: if arg_name in wired_objects_by_name: kwargs[arg_name] = wired_objects_by_name[arg_name] #          #   ,  -   . return func(*args, **kwargs) return result</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Agregue un decorador a nuestra tarea y disfrute de la vida: </font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> mistune <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> backend.storage.card <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> CardDAO <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> backend.tasks.task <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> task @task <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_card_markup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(card_dao: CardDAO, card_id: str)</span></span></span><span class="hljs-function">:</span></span> card = card_dao.get_by_id(card_id) card.html = _parse_markdown(card.markdown) card_dao.update(card) _parse_markdown = mistune.Markdown(escape=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, hard_wrap=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>)</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øDisfrutas la vida? </font><font style="vertical-align: inherit;">Ugh, quer√≠a decir, comenzamos el trabajador:</font></font><br><br><pre> <code class="plaintext hljs">$ docker-compose up worker ... Creating habr-app-demo_worker_1 ... done Attaching to habr-app-demo_worker_1 worker_1 | 17:21:03 RQ worker 'rq:worker:49a25686acc34cdfa322feb88a780f00' started, version 0.13.0 worker_1 | 17:21:03 *** Listening on tasks... worker_1 | 17:21:03 Cleaning registries for queue: tasks</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">III ... no hace nada! </font><font style="vertical-align: inherit;">Por supuesto, ¬°porque no establecimos una sola tarea! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reescribamos nuestra herramienta, que crea una tarjeta de prueba, de modo que: a) no se caiga si la tarjeta ya est√° creada (como en nuestro caso); </font><font style="vertical-align: inherit;">b) poner tarea en el an√°lisis de marqdown.</font></font><br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># tools/add_test_content.py from backend.storage.card import Card, CardNotFound from backend.tasks.parse import parse_card_markup from backend.wiring import Wiring wiring = Wiring() try: card = wiring.card_dao.get_by_slug("helloworld") except CardNotFound: card = wiring.card_dao.create(Card( slug="helloworld", name="Hello, world!", markdown=""" This is a hello-world page. """)) # ,   card_dao.get_or_create,  #      ! wiring.task_queue.enqueue_call( parse_card_markup, kwargs={"card_id": card.id})</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Las herramientas ahora se pueden ejecutar no solo en el backend, sino tambi√©n en el trabajador. </font><font style="vertical-align: inherit;">En principio, ahora no nos importa. </font><font style="vertical-align: inherit;">Lo lanzamos </font></font><code>docker-compose exec worker python -m tools.add_test_content</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y en una pesta√±a vecina de la terminal vemos un milagro: ¬°el trabajador hizo ALGO!</font></font><br><br><pre> <code class="plaintext hljs">worker_1 | 17:34:26 tasks: backend.tasks.parse.parse_card_markup(card_id='5c715dd1e201ce000c6a89fa') (613b53b1-726b-47a4-9c7b-97cad26da1a5) worker_1 | 17:34:27 tasks: Job OK (613b53b1-726b-47a4-9c7b-97cad26da1a5) worker_1 | 17:34:27 Result is kept for 500 seconds</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Despu√©s de reconstruir el contenedor con el backend, finalmente podemos ver el contenido de nuestra tarjeta en el navegador: </font></font><br><br><img src="https://habrastorage.org/webt/ii/5f/zb/ii5fzb_nh2p4-hbv7obhjmxr5kk.png"><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Navegaci√≥n Frontend </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Antes de pasar a SSR, debemos hacer que todo nuestro alboroto React sea un poco significativo y hacer que nuestra aplicaci√≥n de una sola p√°gina sea realmente una sola p√°gina. </font><font style="vertical-align: inherit;">Actualicemos nuestra herramienta para crear dos (¬°NO UNA, Y DOS! ¬°MAM√Å, AHORA GRANDE DESARROLLADOR DE FECHA!) Tarjetas que se unen entre s√≠, y luego nos ocuparemos de la navegaci√≥n entre ellas.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Texto oculto</font></font></b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># tools/add_test_content.py def create_or_update(card): try: card.id = wiring.card_dao.get_by_slug(card.slug).id card = wiring.card_dao.update(card) except CardNotFound: card = wiring.card_dao.create(card) wiring.task_queue.enqueue_call( parse_card_markup, kwargs={"card_id": card.id}) create_or_update(Card( slug="helloworld", name="Hello, world!", markdown=""" This is a hello-world page. It can't really compete with the [demo page](demo). """)) create_or_update(Card( slug="demo", name="Demo Card!", markdown=""" Hi there, habrovchanin. You've probably got here from the awkward ["Hello, world" card](helloworld). Well, **good news**! Finally you are looking at a **really cool card**! """ ))</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora podemos seguir los enlaces y contemplar c√≥mo cada vez que se reinicia nuestra maravillosa aplicaci√≥n. </font><font style="vertical-align: inherit;">Basta! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Primero, coloque su controlador en los clics en los enlaces. </font><font style="vertical-align: inherit;">Dado que HTML con enlaces proviene del backend, y la aplicaci√≥n es con React, necesitamos un peque√±o enfoque espec√≠fico de React.</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/components/card.js class Card extends Component { componentDidMount() { document.title = this.props.name } navigate(event) { //       .  //      ,    . if (event.target.tagName === 'A' &amp;&amp; event.target.hostname === window.location.hostname) { //     event.preventDefault(); //      this.props.dispatch(navigate(event.target)); } } render() { const {name, html} = this.props; return ( &lt;div&gt; &lt;h1&gt;{name}&lt;/h1&gt; &lt;div dangerouslySetInnerHTML={{__html: html}} onClick={event =&gt; this.navigate(event)} /&gt; &lt;/div&gt; ); } }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dado que toda la l√≥gica con la carga de las tarjetas en nuestro componente </font></font><code>CardPage</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, en la acci√≥n en s√≠ (¬°incre√≠ble!), No es necesario tomar ninguna acci√≥n:</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">navigate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">link</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: NAVIGATE, <span class="hljs-attr"><span class="hljs-attr">path</span></span>: link.pathname } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Agregue un reductor tonto para este caso: </font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/redux/reducers.js import { START_FETCHING_CARD, FINISH_FETCHING_CARD, NAVIGATE } from "./actions"; function navigate(state, path) { //     react-router,    ! // (       SSR.) let m = /^\/card\/([^/]+)$/.exec(path); if (m !== null) { return { ...state, page: { type: "card", cardSlug: m[1], isFetching: true } }; } return state } export default function root(state = {}, action) { switch (action.type) { case START_FETCHING_CARD: return { ...state, page: { ...state.page, isFetching: true } }; case FINISH_FETCHING_CARD: return { ...state, page: { ...state.page, isFetching: false, cardData: action.cardData } }; case NAVIGATE: return navigate(state, action.path) } return state; }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como ahora el estado de nuestra aplicaci√≥n puede cambiar, </font></font><code>CardPage</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">necesitamos agregar un m√©todo </font></font><code>componentDidUpdate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">id√©ntico al que ya agregamos </font></font><code>componentWillMount</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ahora, despu√©s de actualizar las propiedades </font></font><code>CardPage</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(por ejemplo, propiedades </font></font><code>cardSlug</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">durante la navegaci√≥n), tambi√©n se solicitar√° el contenido de la tarjeta desde el backend (lo </font></font><code>componentWillMount</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hizo solo cuando se inicializ√≥ el componente). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Muy bien, </font></font><code>docker-compose up --build frontend</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y tenemos una navegaci√≥n de trabajo! </font></font><br><br><img src="https://habrastorage.org/webt/4l/ov/b_/4lovb_vai0fxv0tjx6zfcmwb8y8.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un lector atento notar√° que la URL de la p√°gina no cambiar√° al navegar entre tarjetas, incluso en la captura de pantalla vemos Hello, la tarjeta mundial en la direcci√≥n de la tarjeta de demostraci√≥n. </font><font style="vertical-align: inherit;">En consecuencia, la navegaci√≥n hacia adelante y hacia atr√°s tambi√©n se cay√≥. </font><font style="vertical-align: inherit;">¬°Agreguemos algo de magia negra con historia de inmediato para solucionarlo! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lo m√°s simple que puede hacer es agregar a la acci√≥n.</font></font><code>navigate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un desaf√≠o </font></font><code>history.pushState</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">navigate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">link</span></span></span><span class="hljs-function">) </span></span>{ history.pushState(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, link.href); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: NAVIGATE, <span class="hljs-attr"><span class="hljs-attr">path</span></span>: link.pathname } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora, al hacer clic en los enlaces, la URL en la barra de direcciones del navegador realmente cambiar√°. </font><font style="vertical-align: inherit;">¬°Sin embargo, el bot√≥n de retroceso </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se romper√°</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para que funcione, necesitamos escuchar el evento del </font></font><code>popstate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">objeto </font></font><code>window</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Adem√°s, si en este caso queremos hacer la navegaci√≥n hacia atr√°s y hacia adelante (es decir, a trav√©s </font></font><code>dispatch(navigate(...))</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), tendremos que </font></font><code>navigate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">agregar un indicador especial de "no </font></font><code>pushState</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font><font style="vertical-align: inherit;">a la funci√≥n </font><font style="vertical-align: inherit;">(de lo contrario, ¬°todo se romper√° a√∫n m√°s!). </font><font style="vertical-align: inherit;">Adem√°s, para distinguir entre "nuestros" estados, debemos usar la capacidad </font></font><code>pushState</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de guardar metadatos. </font><font style="vertical-align: inherit;">Hay mucha magia y depuraci√≥n, ¬°as√≠ que vamos directamente al c√≥digo! </font><font style="vertical-align: inherit;">As√≠ se ver√° la aplicaci√≥n:</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/components/app.js class App extends Component { componentDidMount() { //     --   //      "". history.replaceState({ pathname: location.pathname, href: location.href }, ""); //     . window.addEventListener("popstate", event =&gt; this.navigate(event)); } navigate(event) { //    "" ,   //        ,    //   (or is it a good thing?..) if (event.state &amp;&amp; event.state.pathname) { event.preventDefault(); event.stopPropagation(); //      "  pushState". this.props.dispatch(navigate(event.state, true)); } } render() { // ... } }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Y aqu√≠ est√° la acci√≥n de navegaci√≥n: </font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/redux/actions.js export function navigate(link, dontPushState) { if (!dontPushState) { history.pushState({ pathname: link.pathname, href: link.href }, "", link.href); } return { type: NAVIGATE, path: link.pathname } }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora la historia funcionar√°. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bueno, el √∫ltimo toque: dado que ahora tenemos una acci√≥n </font></font><code>navigate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ¬øpor qu√© no renunciamos al c√≥digo adicional en el cliente que calcula el estado inicial? </font><font style="vertical-align: inherit;">Podemos llamar a navegar a la ubicaci√≥n actual:</font></font><br><br><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- a/frontend/src/client.js +++ b/frontend/src/client.js @@ -3,23 +3,16 @@ import {render} from 'react-dom' import {Provider} from 'react-redux' import App from './components/app' import configureStore from './redux/configureStore' +import {navigate} from "./redux/actions"; let initialState = { page: { type: "home" } }; -const m = /^\/card\/([^\/]+)$/.exec(location.pathname); -if (m !== null) { - initialState = { - page: { - type: "card", - cardSlug: m[1] - }, - } -} const store = configureStore(initialState); +store.dispatch(navigate(location));</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Copiar y pegar destruido! </font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Frontend: representaci√≥n del lado del servidor </font></font></h2><br>      (  )  ‚Äî SEO-.      ,     React-,        React,          . <br><br>   . :   HTML-    HTML,   React- <code>App</code> .  HTML     (    JS, -). :      <code>&lt;script&gt;</code> ,  - (,   <code>window</code> )  ,     HTML.                 (    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">hydrate</a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">al HTML generado, para no volver a crear el √°rbol DOM de la aplicaci√≥n). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comencemos escribiendo una funci√≥n que devuelva HTML renderizado y el estado final.</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/server.js import "@babel/polyfill" import React from 'react' import {renderToString} from 'react-dom/server' import {Provider} from 'react-redux' import App from './components/app' import {navigate} from "./redux/actions"; import configureStore from "./redux/configureStore"; export default function render(initialState, url) { //  store,    . const store = configureStore(initialState); store.dispatch(navigate(url)); let app = ( &lt;Provider store={store}&gt; &lt;App/&gt; &lt;/Provider&gt; ); // ,        ! // ,         ? let content = renderToString(app); let preloadedState = store.getState(); return {content, preloadedState}; };</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Agregue nuevos argumentos y l√≥gica a nuestra plantilla, de la que hablamos anteriormente: </font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/template.js function template(title, initialState, content) { let page = ` &lt;!DOCTYPE html&gt; &lt;html lang="en"&gt; &lt;head&gt; &lt;meta charset="utf-8"&gt; &lt;title&gt;${title}&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;div id="app"&gt;${content}&lt;/div&gt; &lt;script&gt; window.__STATE__ = ${JSON.stringify(initialState)} &lt;/script&gt; &lt;script src="/dist/client.js"&gt;&lt;/script&gt; &lt;/body&gt; &lt;/html&gt; `; return page; } module.exports = template;</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nuestro servidor Express se vuelve un poco m√°s complicado: </font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/index.js app.get("*", (req, res) =&gt; { const initialState = { page: { type: "home" } }; const {content, preloadedState} = render(initialState, {pathname: req.url}); res.send(template("Habr demo app", preloadedState, content)); });</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pero el cliente es m√°s f√°cil: </font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/client.js import React from 'react' import {hydrate} from 'react-dom' import {Provider} from 'react-redux' import App from './components/app' import configureStore from './redux/configureStore' import {navigate} from "./redux/actions"; //         ! const store = configureStore(window.__STATE__); // render   hydrate. hydrate    // DOM tree,       . hydrate( &lt;Provider store={store}&gt; &lt;App/&gt; &lt;/Provider&gt;, document.querySelector('#app') );</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A continuaci√≥n, debe limpiar los errores multiplataforma como "el historial no est√° definido". </font><font style="vertical-align: inherit;">Para hacer esto, agregue una funci√≥n simple (hasta ahora) en alg√∫n lugar </font></font><code>utility.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/utility.js export function isServerSide() { //   ,      process, //     -   . return process.env.APP_ENV !== undefined; }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lo siguiente ser√° un cierto n√∫mero de cambios de rutina que no traer√© aqu√≠ (pero se pueden encontrar en la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">confirmaci√≥n correspondiente</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Como resultado, nuestra aplicaci√≥n React podr√° renderizar tanto en el navegador como en el servidor.</font></font><br><br>  Funciona!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero hay, como dicen, una advertencia ... </font></font><br><br><img src="https://habrastorage.org/webt/gd/ac/ut/gdacut18knqjvzftjhkkuhnzxgk.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øCARGANDO? ¬°Todo lo que Google ve en mi servicio de moda s√∫per genial es CARGANDO? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bueno, parece que todo nuestro asincronismo ha jugado contra nosotros. Ahora necesitamos una manera de que el servidor comprenda que la respuesta del backend con el contenido de la tarjeta debe esperar antes de procesar la aplicaci√≥n React en una cadena y enviarla al cliente. Y es deseable que este m√©todo sea bastante general. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puede haber muchas soluciones. Un enfoque es describir en un archivo separado para qu√© rutas se deben proteger los datos, y hacer esto antes de presentar la aplicaci√≥n ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">art√≠culo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Esta soluci√≥n tiene muchas ventajas. Es simple, es expl√≠cito y funciona.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como experimento (¬°el contenido original debe estar en el art√≠culo al menos en alg√∫n lugar!) Propongo otro esquema. </font><font style="vertical-align: inherit;">Cada vez que ejecutemos algo as√≠ncrono, que debemos esperar, agreguemos la promesa adecuada (por ejemplo, la que devuelve la b√∫squeda) en alg√∫n lugar de nuestro estado. </font><font style="vertical-align: inherit;">Entonces tendremos un lugar donde siempre puede verificar si todo se ha descargado. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agrega dos nuevas acciones.</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/redux/actions.js function addPromise(promise) { return { type: ADD_PROMISE, promise: promise }; } function removePromise(promise) { return { type: REMOVE_PROMISE, promise: promise, }; }</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El primero se llamar√° cuando se inicie la b√∫squeda, el segundo, al final </font></font><code>.then()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora agregue su procesamiento al reductor:</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/redux/reducers.js export default function root(state = {}, action) { switch (action.type) { case ADD_PROMISE: return { ...state, promises: [...state.promises, action.promise] }; case REMOVE_PROMISE: return { ...state, promises: state.promises.filter(p =&gt; p !== action.promise) }; ...</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora mejoraremos la acci√≥n </font></font><code>fetchCard</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/redux/actions.js function fetchCard() { return (dispatch, getState) =&gt; { dispatch(startFetchingCard()); let url = apiPath() + "/card/" + getState().page.cardSlug; let promise = fetch(url) .then(response =&gt; response.json()) .then(json =&gt; { dispatch(finishFetchingCard(json)); // " ,  " dispatch(removePromise(promise)); }); // "  ,  " return dispatch(addPromise(promise)); }; }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬°Queda por agregar </font></font><code>initialState</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">promesas </font><font style="vertical-align: inherit;">a la </font><font style="vertical-align: inherit;">matriz vac√≠a y hacer que el servidor las espere a todas! </font><font style="vertical-align: inherit;">La funci√≥n de procesamiento se vuelve as√≠ncrona y toma la siguiente forma:</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/server.js function hasPromises(state) { return state.promises.length &gt; 0 } export default async function render(initialState, url) { const store = configureStore(initialState); store.dispatch(navigate(url)); let app = ( &lt;Provider store={store}&gt; &lt;App/&gt; &lt;/Provider&gt; ); //  renderToString     // (  ). CardPage     . renderToString(app); // ,   !    - //    (  // , ),     //    . let preloadedState = store.getState(); while (hasPromises(preloadedState)) { await preloadedState.promises[0]; preloadedState = store.getState() } //  renderToString.    HTML. let content = renderToString(app); return {content, preloadedState}; };</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Debido a la </font></font><code>render</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asincron√≠a </font><font style="vertical-align: inherit;">adquirida </font><font style="vertical-align: inherit;">, el controlador de solicitudes tambi√©n es un poco m√°s complicado:</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/index.js app.get("*", (req, res) =&gt; { const initialState = { page: { type: "home" }, promises: [] }; render(initialState, {pathname: req.url}).then(result =&gt; { const {content, preloadedState} = result; const response = template("Habr demo app", preloadedState, content); res.send(response); }, (reason) =&gt; { console.log(reason); res.status(500).send("Server side rendering failed!"); }); });</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Et voil√†! </font></font><br><br><img src="https://habrastorage.org/webt/vt/ed/uj/vteduj-6tnshnodaw0setd3b0wu.png"><br><br><h2>  Conclusi√≥n </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como puede ver, crear una aplicaci√≥n de alta tecnolog√≠a no es tan simple. </font><font style="vertical-align: inherit;">¬°Pero no es tan dif√≠cil! </font><font style="vertical-align: inherit;">La aplicaci√≥n final est√° en el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">repositorio en Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y, en teor√≠a, solo necesita Docker para ejecutarla. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si el art√≠culo tiene demanda, ¬°este repositorio ni siquiera ser√° abandonado! </font><font style="vertical-align: inherit;">Podremos verlo con algo de otro conocimiento que sea necesario:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> registro, monitoreo, prueba de carga. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> prueba, CI, CD. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> caracter√≠sticas m√°s interesantes como la autorizaci√≥n o la b√∫squeda de texto completo. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Configuraci√≥n y desarrollo del entorno de producci√≥n. </font></font></li></ul><br>  Gracias por su atencion! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/444446/">https://habr.com/ru/post/444446/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../444434/index.html">¬°Ha llegado el momento de Java 12! Revisi√≥n de los JEP calientes</a></li>
<li><a href="../444436/index.html">¬øQu√© es una botnet Mirai y c√≥mo puedo proteger mis dispositivos?</a></li>
<li><a href="../444438/index.html">Una breve historia del c√≥digo abierto: c√≥mo el software libre luch√≥ con el propietario</a></li>
<li><a href="../444442/index.html">Jetson Nano: Nvidia Machine Learning Single Board</a></li>
<li><a href="../444444/index.html">Los mejores fracasos de nuestras conferencias (Joker, JPoint, DotNext, Mobius, TechTrain, etc.)</a></li>
<li><a href="../444448/index.html">Mirai Clone agrega una docena de nuevas vulnerabilidades para dispositivos de IoT empresariales dirigidos</a></li>
<li><a href="../444456/index.html">Atari 65XE - Teclado USB</a></li>
<li><a href="../444460/index.html">Del analizador del p√≥ster del teatro Python al bot Telegram. Parte 1</a></li>
<li><a href="../444462/index.html">Prueba de Samsung Galaxy S10: ¬øcu√°ndo se alcanzar√°n los tel√©fonos inteligentes con las c√°maras?</a></li>
<li><a href="../444464/index.html">Otra forma de dispararle a la pierna usando std :: thread</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>