<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üê¢ üë≥üèø üë©üèº‚Äçüé§ Comment fonctionne la recherche Yandex.Market et que se passera-t-il si l'un des serveurs plante ü§∞üèø üí© üßôüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut, je m'appelle Eugene. Je travaille dans l'infrastructure de recherche Yandex.Market. Je veux parler √† la communaut√© Habr de la cuisine interne d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment fonctionne la recherche Yandex.Market et que se passera-t-il si l'un des serveurs plante</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/475848/">  Salut, je m'appelle Eugene.  Je travaille dans l'infrastructure de recherche Yandex.Market.  Je veux parler √† la communaut√© Habr de la cuisine interne du march√© - mais il y a quelque chose √† dire.  Tout d'abord, comment fonctionnent la recherche de march√©, les processus et l'architecture.  Comment g√©rer les situations d'urgence: que se passe-t-il si un serveur tombe en panne?  Et s'il y a 100 serveurs de ce type? <br><br>  Vous apprendrez √©galement comment nous impl√©mentons imm√©diatement de nouvelles fonctionnalit√©s sur un groupe de serveurs.  Et comment tester des services complexes directement en production, sans d√©ranger les utilisateurs.  En g√©n√©ral, comment fonctionne la recherche du march√©, pour que tout le monde aille bien. <br><br><img src="https://habrastorage.org/webt/-x/ye/eb/-xyeebvixa2pxxh3ad-peaoukyo.png"><br><a name="habracut"></a><br><h2>  Un peu sur nous: quel probl√®me r√©solvons-nous </h2><br>  Lorsque vous saisissez du texte, recherchez des produits par param√®tres ou comparez les prix dans diff√©rents magasins, toutes les demandes arrivent au service de recherche.  La recherche est le plus grand service du march√©. <br><br>  Nous traitons toutes les requ√™tes de recherche: depuis market.yandex.ru, beru.ru, le service Supercheck, Yandex.Advisor et les applications mobiles.  Nous incluons √©galement des offres de produits dans les r√©sultats de recherche sur yandex.ru. <br><br><img width="500" src="https://habrastorage.org/webt/yt/_h/5d/yt_h5de7hmx0zmkv8gdk7glq-kc.png"><br><br>  Par service de recherche, je veux dire non seulement la recherche directe, mais aussi une base de donn√©es avec toutes les offres sur le march√©.  L'√©chelle est la suivante: plus d'un milliard de requ√™tes de recherche sont trait√©es par jour.  Et tout devrait fonctionner rapidement, sans interruption et toujours produire le r√©sultat souhait√©. <br><br><h2>  Qu'est-ce que: l'architecture du march√© </h2><br>  D√©crivez bri√®vement l'architecture actuelle du march√©.  Classiquement, il peut √™tre d√©crit par le sch√©ma ci-dessous: <br><img src="https://habrastorage.org/webt/ra/yq/jv/rayqjvvmbjvxhsc8lokpysg_rvw.jpeg"><br>  Disons qu'un magasin partenaire vient √† nous.  Il dit que je veux vendre un jouet: ce m√©chant chat avec un couineur.  Et un chat diabolique sans tweeter.  Et juste un chat.  Ensuite, le magasin doit pr√©parer des offres sur lesquelles le march√© recherche.  Le magasin forme un xml sp√©cial avec des offres et communique le chemin vers ce xml via une interface partenaire.  Ensuite, l'indexeur t√©l√©charge p√©riodiquement ce fichier XML, v√©rifie les erreurs et stocke toutes les informations dans une √©norme base de donn√©es. <br><br>  Il existe de nombreux fichiers XML de ce type.  Un index de recherche est cr√©√© √† partir de cette base de donn√©es.  L'index est stock√© au format interne.  Apr√®s avoir cr√©√© l'index, le service Layouts le t√©l√©charge sur les moteurs de recherche. <br><br>  En cons√©quence, un chat mal√©fique avec un couineur appara√Æt dans la base de donn√©es et un index de chat appara√Æt sur le serveur. <br><br>  Je vais parler de la fa√ßon dont nous recherchons un chat dans la partie sur l'architecture de recherche. <br><br><h2>  Architecture de recherche de march√© </h2><br>  Nous vivons dans le monde des microservices: chaque demande entrante sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">market.yandex.ru</a> provoque de nombreuses sous-requ√™tes, et des dizaines de services participent √† leur traitement.  Le diagramme n'en montre que quelques-uns: <br><br><img src="https://habrastorage.org/webt/92/n9/iu/92n9iutvet9ls6k7djh29brfdq0.jpeg"><br>  <i>Sch√©ma de traitement des demandes simplifi√©</i> <br><br>  Chaque service a une chose merveilleuse - son propre √©quilibreur avec un nom unique: <br><br><img src="https://habrastorage.org/webt/qb/_c/t4/qb_ct4mdpio2xprdlos2pi1oym8.jpeg"><br><br>  L'√©quilibreur nous offre une grande flexibilit√© dans la gestion du service: par exemple, vous pouvez d√©sactiver les serveurs, ce qui est souvent n√©cessaire pour les mises √† jour.  L'√©quilibreur voit que le serveur n'est pas disponible et redirige automatiquement les demandes vers d'autres serveurs ou centres de donn√©es.  Lorsque vous ajoutez ou supprimez un serveur, la charge est automatiquement redistribu√©e entre les serveurs. <br><br>  Le nom unique de l'√©quilibreur ne d√©pend pas du centre de donn√©es.  Lorsque le service A fait une demande √† B, alors par d√©faut, l'√©quilibreur B redirige la demande vers le centre de donn√©es actuel.  Si le service n'est pas disponible ou absent dans le centre de donn√©es actuel, la demande est redirig√©e vers d'autres centres de donn√©es. <br><br>  Un FQDN unique pour tous les centres de donn√©es permet au service A de se d√©sengager g√©n√©ralement des emplacements.  Sa demande au service B sera toujours trait√©e.  Une exception est le cas lorsque le service est dans tous les centres de donn√©es. <br><br>  Mais tout n'est pas si rose avec cet √©quilibreur: nous avons un composant interm√©diaire suppl√©mentaire.  L'√©quilibreur peut √™tre instable et ce probl√®me est r√©solu par des serveurs redondants.  Il existe √©galement un d√©lai suppl√©mentaire entre les services A et B. Mais en pratique, il est inf√©rieur √† 1 ms et pour la plupart des services, ce n'est pas critique. <br><br><h3>  Lutter contre l'inattendu: services de recherche √©quilibr√©s et r√©silients </h3><br>  Imaginez qu'un effondrement se soit produit: vous devez trouver un chat avec un couinement, mais le serveur tombe en panne.  Ou 100 serveurs.  Comment sortir?  Allons-nous vraiment laisser l'utilisateur sans chat? <br><br>  La situation est terrible, mais nous y sommes pr√™ts.  Je vais te le dire dans l'ordre. <br><br>  L'infrastructure de recherche est situ√©e dans plusieurs centres de donn√©es: <br><br><img src="https://habrastorage.org/webt/_i/wa/f9/_iwaf97__hrhmaspgxcl-euqqnq.jpeg"><br><br>  Lors de la conception, nous laissons la possibilit√© de d√©sactiver un centre de donn√©es.  La vie est pleine de surprises - par exemple, une excavatrice peut couper un c√¢ble souterrain (oui, c'√©tait comme √ßa).  Les capacit√©s des autres centres de donn√©es devraient √™tre suffisantes pour r√©sister √† la charge de pointe. <br><br>  Prenons un seul centre de donn√©es.  Dans chaque centre de donn√©es, le m√™me sch√©ma d'√©quilibreurs: <br><br><img src="https://habrastorage.org/webt/x6/rp/hx/x6rphx-hrlcb1gciennukyjeudi.jpeg"><br>  Un √©quilibreur est compos√© d'au moins trois serveurs physiques.  Une telle redondance est faite pour la fiabilit√©.  Les √©quilibreurs travaillent sur HAProx. <br><br>  Nous avons choisi HAProx en raison de ses performances √©lev√©es, de ses faibles besoins en ressources et de ses nombreuses fonctionnalit√©s.  √Ä l'int√©rieur de chaque serveur, notre logiciel de recherche fonctionne. <br><br>  La probabilit√© de d√©faillance d'un serveur est faible.  Mais si vous avez plusieurs serveurs, la probabilit√© qu'au moins une chute augmente. <br><br>  C'est ce qui se passe en r√©alit√©: les serveurs se bloquent.  Par cons√©quent, vous devez constamment surveiller l'√©tat de tous les serveurs.  Si le serveur ne r√©pond plus, il est automatiquement d√©connect√© du trafic.  Pour cela, HAProxy a un bilan de sant√© int√©gr√©.  Il va √† tous les serveurs avec la requ√™te HTTP ¬´/ ping¬ª une fois par seconde. <br><br>  Une autre fonctionnalit√© de HAProxy: l'agent-check vous permet de charger tous les serveurs de mani√®re uniforme.  Pour ce faire, HAProxy se connecte √† tous les serveurs et renvoie leur poids en fonction de la charge actuelle de 1 √† 100. Le poids est calcul√© en fonction du nombre de demandes dans la file d'attente de traitement et de la charge sur le processeur. <br><br>  Maintenant sur la recherche d'un chat.  Demandes du formulaire <b>/ recherche? Texte = en col√®re + chat</b> arrive √† la <b>recherche</b> .  Pour que la recherche soit rapide, l'index de chat entier doit √™tre plac√© dans la RAM.  M√™me la lecture √† partir d'un SSD n'est pas assez rapide. <br><br>  Il √©tait une fois, la base de l'offre √©tait petite et il y avait suffisamment de RAM pour un serveur.  Au fur et √† mesure que la base de donn√©es des propositions s'est d√©velopp√©e, tout a cess√© de tenir dans cette RAM et les donn√©es ont √©t√© divis√©es en deux parties: le fragment 1 et le fragment 2. <br><br><img src="https://habrastorage.org/webt/kz/od/j5/kzodj5ghrqccc_necth6gmylzgy.jpeg"><br>  Mais cela arrive toujours: toute solution, m√™me bonne, pose d'autres probl√®mes. <br><br>  L'√©quilibreur est toujours all√© sur n'importe quel serveur.  Mais sur la machine d'o√π venait la demande, il n'y avait que la moiti√© de l'index.  Le reste √©tait sur d'autres serveurs.  Par cons√©quent, le serveur devait se rendre sur une machine voisine.  Apr√®s avoir re√ßu les donn√©es des deux serveurs, les r√©sultats ont √©t√© combin√©s et r√©organis√©s. <br><br>  √âtant donn√© que l'√©quilibreur distribue les demandes de mani√®re √©gale, tous les serveurs ont √©t√© impliqu√©s dans la r√©organisation, et pas seulement dans la transmission des donn√©es. <br><br>  Le probl√®me s'est produit si le serveur voisin n'√©tait pas disponible.  La solution a √©t√© de sp√©cifier plusieurs serveurs avec des priorit√©s diff√©rentes comme serveur "voisin".  Tout d'abord, la demande a √©t√© envoy√©e aux serveurs du rack actuel.  Si aucune r√©ponse n'a √©t√© re√ßue, la demande a √©t√© envoy√©e √† tous les serveurs de ce centre de donn√©es.  Enfin et surtout, la demande a √©t√© envoy√©e √† d'autres centres de donn√©es. <br>  √Ä mesure que le nombre de propositions augmentait, les donn√©es √©taient divis√©es en quatre parties.  Mais ce n'√©tait pas la limite. <br><br>  Maintenant, une configuration de huit fragments est utilis√©e.  De plus, pour √©conomiser davantage de m√©moire, l'index a √©t√© divis√© en la partie de recherche (par laquelle la recherche a lieu) et la partie d'extrait de code (qui n'est pas impliqu√©e dans la recherche). <br><br>  Un serveur contient des informations sur un seul fragment.  Par cons√©quent, pour effectuer une recherche sur l'index complet, vous devez rechercher sur huit serveurs contenant des fragments diff√©rents. <br><br>  Les serveurs sont regroup√©s en clusters.  Chaque cluster contient huit moteurs de recherche et un extrait. <br><br><img src="https://habrastorage.org/webt/1b/om/dl/1bomdlbzui-uxhswoq1kfq9h7os.jpeg"><br>  La base de donn√©es de valeurs-cl√©s avec des donn√©es statiques s'ex√©cute sur le serveur d'extraits de code.  Ils sont n√©cessaires pour d√©livrer des documents, par exemple, une description d'un chat avec un couineur.  Les donn√©es sont sp√©cialement extraites sur un serveur s√©par√© afin de ne pas charger la m√©moire des moteurs de recherche. <br><br>  √âtant donn√© que les ID de document sont uniques uniquement dans le cadre d'un index, une situation peut se produire en l'absence de documents dans les extraits de code.  Eh bien ou que sur un ID il y aura un autre contenu.  Par cons√©quent, pour que la recherche fonctionne et que la recherche se produise, un besoin est apparu pour la coh√©rence de l'ensemble du cluster.  Je parlerai de la fa√ßon dont nous surveillons la coh√©rence un peu plus tard. <br><br>  La recherche elle-m√™me est organis√©e comme suit: une requ√™te de recherche peut arriver √† l'un des huit serveurs.  Disons qu'il est venu sur le serveur 1. Ce serveur traite tous les arguments et comprend quoi et comment chercher.  Selon la demande entrante, le serveur peut faire des demandes suppl√©mentaires aux services externes pour les informations n√©cessaires.  Une demande peut √™tre suivie par jusqu'√† dix demandes adress√©es √† des services externes. <br><br>  Apr√®s avoir collect√© les informations n√©cessaires, une recherche commence dans la base de donn√©es des offres.  Pour ce faire, des sous-requ√™tes sont effectu√©es pour les huit serveurs du cluster. <br><br>  Apr√®s avoir re√ßu les r√©ponses, les r√©sultats sont combin√©s.  Au final, pour g√©n√©rer le probl√®me, vous devrez peut-√™tre plusieurs sous-requ√™tes suppl√©mentaires sur le serveur d'extraits de code. <br><br>  Les requ√™tes de recherche au sein du cluster sont: <b>/ shard1? Text = angry + cat</b> .  De plus, des sous-requ√™tes de la forme: <b>/ status</b> sont constamment effectu√©es entre tous les serveurs du cluster une fois par seconde. <br><br>  La demande <b>/ status</b> d√©tecte une situation o√π le serveur n'est pas disponible. <br><br>  Il contr√¥le √©galement que sur tous les serveurs, la version du moteur de recherche et la version d'index sont identiques, sinon il y aura des donn√©es incoh√©rentes √† l'int√©rieur du cluster. <br><br>  Malgr√© le fait qu'un serveur d'extraits de code traite les demandes de huit moteurs de recherche, son processeur est tr√®s l√©g√®rement charg√©.  Par cons√©quent, nous transf√©rons maintenant les donn√©es d'extrait de code vers un service distinct. <br><br><img src="https://habrastorage.org/webt/3u/q5/ng/3uq5ngicgxwxg60diggqot7iiky.jpeg"><br><br>  Pour transf√©rer des donn√©es, nous avons introduit des cl√©s universelles pour les documents.  Maintenant, la situation est impossible lorsqu'une cl√© renvoie le contenu d'un autre document. <br><br>  Mais la transition vers une autre architecture n'est pas encore termin√©e.  Nous voulons maintenant nous d√©barrasser du serveur d'extraits d√©di√©.  Et ensuite, √©loignez-vous g√©n√©ralement de la structure du cluster.  Cela nous permettra de continuer √† √©voluer facilement.  Un bonus suppl√©mentaire est une importante √©conomie de fer. <br><br>  Et maintenant aux histoires effrayantes avec une fin heureuse.  Consid√©rez plusieurs cas d'indisponibilit√© du serveur. <br><br><h4>  Terrible s'est produit: un serveur n'est pas disponible </h4><br>  Disons qu'un serveur n'est pas disponible.  Les autres serveurs du cluster peuvent alors continuer de r√©pondre, mais les r√©sultats de la recherche seront incomplets. <br><br>  Gr√¢ce √† une v√©rification de l'√©tat, les serveurs voisins comprennent que l'un n'est pas disponible.  Par cons√©quent, pour maintenir l'exhaustivit√©, tous les serveurs du cluster commencent √† r√©pondre √† la demande <b>/ ping</b> √† l'√©quilibreur qu'ils sont √©galement indisponibles.  Il s'av√®re que tous les serveurs du cluster sont morts (ce qui n'est pas le cas).  C'est le principal inconv√©nient de notre sch√©ma de cluster - par cons√©quent, nous voulons nous en √©loigner. <br><br><img src="https://habrastorage.org/webt/hr/ko/2o/hrko2ovb9b5q2hjb8xqgnubynec.jpeg"><br><br>  Demandes qui se sont termin√©es par une erreur, l'√©quilibreur demande √† nouveau sur d'autres serveurs. <br>  De plus, l'√©quilibreur cesse d'envoyer du trafic utilisateur aux serveurs morts, mais continue de v√©rifier leur √©tat. <br><br>  Lorsque le serveur devient disponible, il commence √† r√©pondre √† <b>/ ping</b> .  D√®s que les r√©ponses normales aux pings des serveurs morts commencent √† arriver, les √©quilibreurs commencent √† y envoyer du trafic utilisateur.  Le cluster est r√©tabli, applaudissements. <br><br><h4>  Pire encore: de nombreux serveurs indisponibles </h4><br>  Une partie importante des serveurs du centre de donn√©es est coup√©e.  Que faire, o√π courir?  L'√©quilibreur vient √† nouveau √† la rescousse.  Chaque √©quilibreur garde constamment en m√©moire le nombre actuel de serveurs actifs.  Il consid√®re toujours la quantit√© maximale de trafic que le centre de donn√©es actuel peut g√©rer. <br><br>  Lorsque de nombreux serveurs du centre de donn√©es tombent, l'√©quilibreur comprend que ce centre de donn√©es ne peut pas traiter tout le trafic. <br><br>  Ensuite, le trafic exc√©dentaire commence distribu√© de mani√®re al√©atoire vers d'autres centres de donn√©es.  Tout fonctionne, tout le monde est content. <br><br><img src="https://habrastorage.org/webt/cp/g-/if/cpg-ifevj3dzyvmedn1v-g5lzpg.jpeg"><br><h2>  Comment nous le faisons: versions de sortie </h2><br>  Maintenant, comment nous publions les modifications apport√©es au service.  Ici, nous avons emprunt√© la voie de la rationalisation des processus: le d√©ploiement d'une nouvelle version est presque enti√®rement automatis√©. <br>  Lorsqu'un certain nombre de modifications sont accumul√©es dans le projet, une nouvelle version est automatiquement cr√©√©e et son assemblage est lanc√©. <br><br><img src="https://habrastorage.org/webt/cy/to/0f/cyto0f3qhsuxs7bgd2momnccebe.jpeg"><br><br>  Ensuite, le service est d√©ploy√© pour les tests, o√π la stabilit√© est v√©rifi√©e. <br><br>  Parall√®lement, les tests de performances automatiques sont lanc√©s.  Il est engag√© dans un service sp√©cial.  Je ne parlerai pas de lui maintenant - sa description m√©rite un article s√©par√©. <br><br>  Si la publication dans testing est r√©ussie, la publication de la version dans prestable d√©marre automatiquement.  Prestable est un cluster sp√©cial o√π le trafic utilisateur normal est dirig√©.  S'il renvoie une erreur, l'√©quilibreur fait une nouvelle demande en production. <br><br>  En pr√©-stable, les temps de r√©ponse sont mesur√©s et compar√©s √† la version pr√©c√©dente en production.  Si tout va bien, la personne se connecte: v√©rifie les graphiques et les r√©sultats des tests de charge, puis commence le d√©ploiement en production. <br><br><h2>  Tout le meilleur pour l'utilisateur: test A / B </h2><br>  Il n'est pas toujours √©vident que les changements apport√©s au service apporteront de r√©els avantages.  Pour mesurer l'utilit√© du changement, les gens ont propos√© des tests A / B.  Je vais parler un peu de la fa√ßon dont cela fonctionne dans la recherche Yandex.Market. <br><br>  Tout commence par l'ajout d'un nouveau param√®tre CGI qui inclut de nouvelles fonctionnalit√©s.  Soit notre param√®tre: <i>market_new_functionality = 1</i> .  Ensuite, dans le code, activez cette fonctionnalit√© avec l'indicateur: <br><br><pre><code class="cpp hljs">If (cgi.experiments.market_new_functionality) { <span class="hljs-comment"><span class="hljs-comment">// enable new functionality }</span></span></code> </pre> <br>  De nouvelles fonctionnalit√©s sont d√©ploy√©es en production. <br><br>  Il existe un service d√©di√© √† l'automatisation des tests A / B, qui est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©crit</a> en d√©tail <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> .  Une exp√©rience est cr√©√©e dans le service.  La part du trafic est fix√©e, par exemple, √† 15%.  L'int√©r√™t n'est pas d√©fini pour les demandes, mais pour les utilisateurs.  Le temps de l'exp√©rience, par exemple une semaine, est √©galement indiqu√©. <br><br>  Plusieurs exp√©riences peuvent √™tre lanc√©es en m√™me temps.  Dans les param√®tres, vous pouvez sp√©cifier si l'intersection avec d'autres exp√©riences est possible. <br><br>  Par cons√©quent, le service ajoute automatiquement l'argument <i>market_new_functionality = 1</i> √† 15% des utilisateurs.  Il calcule √©galement automatiquement les m√©triques s√©lectionn√©es.  Apr√®s l'exp√©rience, les analystes examinent les r√©sultats et tirent des conclusions.  Sur la base des r√©sultats, une d√©cision est prise de d√©ployer en production ou en raffinement. <br><br><h2>  Agilit√© du march√©: tests de production </h2><br>  Il arrive souvent qu'il soit n√©cessaire de v√©rifier le fonctionnement de nouvelles fonctionnalit√©s en production, mais il n'y a aucune certitude sur la mani√®re dont elles se comporteront dans des conditions de ¬´combat¬ª sous forte charge. <br><br>  Il existe une solution: les indicateurs des param√®tres CGI peuvent √™tre utilis√©s non seulement pour les tests A / B, mais √©galement pour tester de nouvelles fonctionnalit√©s. <br><br>  Nous avons cr√©√© un outil qui vous permet de modifier instantan√©ment la configuration sur des milliers de serveurs sans exposer le service √† des risques.  Cela s'appelle "Stop Crane".  L'id√©e originale √©tait la possibilit√© de d√©sactiver rapidement certaines fonctionnalit√©s sans mise en page.  Ensuite, l'outil s'est d√©velopp√© et est devenu plus complexe. <br><br>  Le sch√©ma du service est pr√©sent√© ci-dessous: <br><br><img src="https://habrastorage.org/webt/va/la/n8/valan8guj5dkld2j788pw7ytbwy.jpeg"><br><br>  L'API d√©finit des valeurs d'indicateur.  Le service de gestion stocke ces valeurs dans une base de donn√©es.  Tous les serveurs acc√®dent √† la base de donn√©es toutes les dix secondes, pompent les valeurs des indicateurs et appliquent ces valeurs √† chaque demande. <br><br>  Dans Stop Crane, vous pouvez d√©finir deux types de valeurs: <br><br>  1) Expressions conditionnelles.  Appliquer lorsque l'une des valeurs est ex√©cut√©e.  Par exemple: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"condition"</span></span>:<span class="hljs-string"><span class="hljs-string">"IS_DC1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>:<span class="hljs-string"><span class="hljs-string">"3"</span></span>, }, { <span class="hljs-attr"><span class="hljs-attr">"condition"</span></span>: <span class="hljs-string"><span class="hljs-string">"CLUSTER==2 and IS_BERU"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"4!"</span></span> }</code> </pre> <br>  La valeur ¬´3¬ª sera appliqu√©e lorsque la demande sera trait√©e dans l'emplacement DC1.  Et la valeur est ¬´4¬ª lorsque la demande est trait√©e sur le deuxi√®me cluster pour le site beru.ru. <br><br>  2) Valeurs inconditionnelles.  Ils sont utilis√©s par d√©faut si aucune des conditions n'est remplie.  Par exemple: <br><br>  <i>valeur, valeur!</i> <br><br>  Si la valeur se termine par un point d'exclamation, elle re√ßoit une priorit√© plus √©lev√©e. <br><br>  L'analyseur des param√®tres CGI analyse l'URL.  Applique ensuite les valeurs du robinet d'arr√™t. <br><br>  Les valeurs avec les priorit√©s suivantes s'appliquent: <br><br><ol><li>  Priorit√© plus √©lev√©e √† l'arr√™t du robinet (point d'exclamation). </li><li>  La valeur de la requ√™te. </li><li>  La valeur par d√©faut provient du robinet d'arr√™t. </li><li>  La valeur par d√©faut dans le code. </li></ol><br>  Il y a beaucoup de drapeaux qui sont indiqu√©s dans des valeurs conditionnelles - ils sont suffisants pour tous les sc√©narios que nous connaissons: <br><br><ul><li>  Centre de donn√©es. </li><li>  Environnement: production, tests, ombre. </li><li>  Lieu: march√©, beru. </li><li>  Num√©ro de cluster. </li></ul><br>  Avec cet outil, vous pouvez activer de nouvelles fonctionnalit√©s sur un groupe de serveurs (par exemple, uniquement dans un centre de donn√©es) et tester la fonctionnalit√© de cette fonctionnalit√© sans risque particulier pour l'ensemble du service.  M√™me si vous avez fait une grave erreur quelque part, tout a commenc√© √† tomber et tout le centre de donn√©es a baiss√©, les √©quilibreurs redirigeront les demandes vers un autre centre de donn√©es.  Les utilisateurs finaux ne remarqueront rien. <br><br>  Si vous remarquez un probl√®me, vous pouvez imm√©diatement renvoyer la valeur pr√©c√©dente de l'indicateur et les modifications seront annul√©es. <br><br>  Ce service a ses inconv√©nients: les d√©veloppeurs l'aiment beaucoup et essaient souvent de pousser tous les changements dans le Stop Crane.  Nous essayons de lutter contre les abus. <br><br>  L'approche Stop Crane fonctionne bien lorsque vous disposez d√©j√† d'un code stable, pr√™t √† √™tre d√©ploy√© en production.  Dans le m√™me temps, vous avez encore des doutes et vous souhaitez v√©rifier le code dans des conditions de "combat". <br><br>  Cependant, le robinet d'arr√™t n'est pas adapt√© aux tests pendant le d√©veloppement.  Pour les d√©veloppeurs, il existe un cluster s√©par√© appel√© ¬´cluster virtuel¬ª. <br><br><h2>  Test secret: cluster fant√¥me </h2><br>  Les demandes de l'un des clusters sont dupliqu√©es sur le cluster reflet.  Mais l'√©quilibreur ignore compl√®tement les r√©ponses de ce cluster.  Le sch√©ma de son travail est pr√©sent√© ci-dessous. <br><br><img src="https://habrastorage.org/webt/ie/xt/dp/iextdpgmvcam7ehqatcbwdjyjxe.jpeg"><br><br>  Nous obtenons un cluster de test qui est en conditions r√©elles de ¬´combat¬ª.  Le trafic normal des utilisateurs y circule.  Le mat√©riel des deux clusters est le m√™me, vous pouvez donc comparer les performances et les erreurs. <br><br>  Et puisque l'√©quilibreur ignore compl√®tement les r√©ponses, les utilisateurs finaux ne verront pas les r√©ponses du cluster fant√¥me.  Par cons√©quent, il n'est pas effrayant de se tromper. <br><br><h2>  Conclusions </h2><br>  Alors, comment avons-nous construit une recherche de march√©? <br><br>  Pour que tout se passe bien, nous s√©parons la fonctionnalit√© en services distincts.  Vous ne pouvez donc mettre √† l'√©chelle que les composants dont nous avons besoin et simplifier les composants.  Il est facile de donner un composant s√©par√© √† une autre √©quipe et de partager les responsabilit√©s pour y travailler.  Et des √©conomies importantes de fer avec cette approche sont un avantage √©vident. <br><br>  Le cluster virtuel nous aide √©galement: vous pouvez d√©velopper des services, les tester dans le processus et en m√™me temps ne pas d√©ranger l'utilisateur. <br><br>  Eh bien et v√©rifiez la production, bien s√ªr.  Besoin de changer la configuration sur mille serveurs?  Facile, utilisez une grue d'arr√™t.  Ainsi, vous pouvez imm√©diatement d√©ployer une solution complexe pr√™te √† l'emploi et revenir √† une version stable en cas de probl√®me. <br><br>  J'esp√®re avoir pu montrer comment nous rendons le march√© rapide et stable avec une base d'offres toujours croissante.  Comment r√©soudre les probl√®mes de serveur, traiter un grand nombre de demandes, am√©liorer la flexibilit√© des services et le faire sans interrompre les processus de travail. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr475848/">https://habr.com/ru/post/fr475848/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr475830/index.html">Console r√©tro portable √† faire soi-m√™me</a></li>
<li><a href="../fr475832/index.html">Les expressions multim√©dias CSS ont une largeur sup√©rieure √† la largeur maximale</a></li>
<li><a href="../fr475834/index.html">Scrum ne vous aidera pas. Nous comprenons pourquoi</a></li>
<li><a href="../fr475838/index.html">CHANGER les gens. Ou ... changer les gens. Comment ¬´d√©coller¬ª le projet de transformation</a></li>
<li><a href="../fr475842/index.html">Remplacer l'URL d'action et l'URI dans les t√©l√©phones SIP ou g√©rer via des sockets Web?</a></li>
<li><a href="../fr475850/index.html">Comment commencer √† construire une carri√®re dans l'informatique, si vous n'avez pas encore d'exp√©rience</a></li>
<li><a href="../fr475854/index.html">Pools JDBC et gestion efficace des fichiers: Java mitap le 3 d√©cembre √† Saint-P√©tersbourg</a></li>
<li><a href="../fr475856/index.html">Google App Script, Mikrotik, Telegram et VPNBook ont ‚Äã‚Äãcommenc√© √† jouer un quatuor</a></li>
<li><a href="../fr475858/index.html">Divertir la crypto-√©nergie: la chaleur de l'exploitation mini√®re pour les humains et la chaleur des humains pour l'exploitation mini√®re</a></li>
<li><a href="../fr475860/index.html">Apache NiFi. 28 novembre √† la salle de conf√©rence Deworkacy</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>