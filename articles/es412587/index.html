<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë´ üíì üßëüèª Marioneta + Hiera. Exprimir al m√°ximo üñïüèø ü•ï üë©üèæ‚Äçü§ù‚Äçüë®üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En este art√≠culo, me gustar√≠a hablar sobre c√≥mo usamos Puppet y Hiera para configurar servidores virtuales y de hierro. B√°sicamente, se tratar√° de la ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Marioneta + Hiera. Exprimir al m√°ximo</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/semrush/blog/412587/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/vq/z-/bj/vqz-bjm4yx2wvhzcf-frffyuh04.png"></div><br><p>  En este art√≠culo, me gustar√≠a hablar sobre c√≥mo usamos <strong>Puppet</strong> y <strong>Hiera</strong> para configurar servidores virtuales y de hierro.  B√°sicamente, se tratar√° de la arquitectura y la jerarqu√≠a que inventamos, lo que facilita y sistematiza la configuraci√≥n de los servidores. </p><br><p>  Me incitaron a escribir este art√≠culo por el hecho de que en Internet no encontr√© particularmente buenos ejemplos realmente buenos de c√≥mo puede trabajar con hiera y para qu√© sirve.  B√°sicamente, estos son tutoriales con ejemplos para ingresar al tema.  Pero la aplicaci√≥n pr√°ctica real de hiera no est√° escrita all√≠.  Tal vez no me ve√≠a bien, pero aqu√≠ hay un ejemplo real que probablemente te ayudar√° a poner todos los puntos sobre i, como lo hice una vez. </p><br><h3 id="dlya-kogo-byla-by-polezna-dannaya-statya">  Para qui√©n ser√≠a √∫til este art√≠culo </h3><br><p>  Si: </p><br><ul><li>  Sabes lo que son Puppet y Hiera, pero realmente no los usas juntos, porque no est√° claro c√≥mo hacerlo y por qu√© </li><li>  Tiene muchos equipos en su empresa y necesita diferenciar de alguna manera la configuraci√≥n del servidor en el nivel de comando </li><li>  Usas un pappet y los archivos de nodo que has crecido a tama√±os incre√≠bles. </li><li>  ¬øTe gusta leer la configuraci√≥n del servidor en formato divino yaml :) </li><li>  B√°sicamente, le interesa el tema de la gesti√≥n de la configuraci√≥n y la administraci√≥n del sistema. </li></ul><br><p>  Este art√≠culo es para ti. </p><a name="habracut"></a><br><h3 id="prezhde-chem-nachat">  Antes de empezar </h3><br><p>  Te advertir√© de inmediato, el art√≠culo result√≥ ser largo, pero espero que sea √∫til.  Adem√°s, se entiende que ya ha conectado hiera a la marioneta, y que al menos de alguna manera est√° familiarizado con la marioneta.  Si hiera no est√° conectado, no es dif√≠cil de hacer. </p><br><ul><li>  Lea m√°s sobre qu√© es Puppet aqu√≠: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Puppet para principiantes</a> . </li><li>  C√≥mo funciona Hiera - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Presentaci√≥n en Hiera</a> . </li></ul><br><h3 id="vvodnye-dannye">  Datos de entrada </h3><br><ul><li>  Tenemos alrededor de 30 equipos de desarrollo en SEMrush, cada uno de los cuales tiene sus propios servidores </li><li>  Cada equipo trabaja con su propio conjunto de tecnolog√≠as (PL, DBMS, etc.) </li><li>  Los equipos pueden y deber√≠an (idealmente) usar una configuraci√≥n com√∫n para proyectos espec√≠ficos (reutilizaci√≥n de c√≥digo) </li><li>  Los equipos mismos administran la implementaci√≥n de aplicaciones en sus servidores (esto no se hace a trav√©s del pappet) </li></ul><br><h3 id="nemnogo-istorii">  Un poco de historia </h3><br><p>  Inicialmente, ten√≠amos todo en el pappet de la versi√≥n 3, luego decidimos implementar el cuarto pappet, y todos los nuevos servidores comenzaron a colocarse en √©l, y los antiguos se transfirieron lentamente al cuarto. </p><br><p>  En el tercer papel, sol√≠amos usar el sistema cl√°sico de m√≥dulos y archivos de nodos.  Los m√≥dulos se crearon en un grupo especial de proyectos en Gitlab, se clonaron en un servidor de pappet (usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">r10k</a> ), luego los agentes de pappet acudieron al asistente y recibieron un directorio para aplicarlo al servidor. </p><br><p>  Luego comenzaron a tratar de no hacer esto y no usar m√≥dulos locales, sino poner enlaces a los m√≥dulos necesarios y sus repositorios en el Puppetfile.  Por qu√©  Porque esos m√≥dulos son constantemente compatibles y mejorados (bueno, idealmente) por la comunidad y los desarrolladores, y nuestros locales no lo son.  M√°s tarde, introdujeron hiera y lo cambiaron por completo, y los archivos de nodos (como node.pp) se han hundido en el olvido. </p><br><p>  En el cuarto documento, intentamos abandonar completamente los m√≥dulos locales y usar solo m√≥dulos remotos.  Desafortunadamente, una reserva debe insertarse aqu√≠ nuevamente, ya que "no funcion√≥ por completo", a veces todav√≠a tiene que inclinarse y terminar algo usted mismo.  Por supuesto, solo hay hiera y no hay archivos de nodo. </p><br><p>  <strong>Cuando tienes 30 equipos con un zool√≥gico tecnol√≥gico, el problema de c√≥mo mantener esta colecci√≥n con&gt; 1000 servidores se vuelve especialmente grave.</strong>  <strong>Adem√°s, contar√© c√≥mo nos ayuda Hiera en esto.</strong> </p><br><h3 id="ierarhiya">  Jerarqu√≠a </h3><br><p>  Hiera (de hecho, de donde obtuvo su nombre) establece una jerarqu√≠a.  Con nosotros, se ve as√≠: </p><br><pre><code class="hljs axapta">--- :hierarchy: - <span class="hljs-string"><span class="hljs-string">"nodes/%{::fqdn}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/nodes/%{::fqdn}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/projects/%{::project}/tiers/%{::tier}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/projects/%{::project}/%{::role}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/projects/%{::project}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/roles/%{::role}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/%{::team}"</span></span> - <span class="hljs-string"><span class="hljs-string">"projects/%{::project}/tiers/%{::tier}/%{::role}"</span></span> - <span class="hljs-string"><span class="hljs-string">"projects/%{::project}/tiers/%{::tier}"</span></span> - <span class="hljs-string"><span class="hljs-string">"projects/%{::project}/%{::role}"</span></span> - <span class="hljs-string"><span class="hljs-string">"projects/%{::project}"</span></span> - <span class="hljs-string"><span class="hljs-string">"tiers/%{::tier}"</span></span> - <span class="hljs-string"><span class="hljs-string">"virtual/%{::virtual}"</span></span> - <span class="hljs-string"><span class="hljs-string">"os/%{::operatingsystem}/%{::operatingsystemmajrelease}"</span></span> - <span class="hljs-string"><span class="hljs-string">"os/%{::operatingsystem}"</span></span> - users - <span class="hljs-keyword"><span class="hljs-keyword">common</span></span></code> </pre> <br><p>  Primero, tratemos con variables oscuras (hechos). </p><br><p>  Idealmente, cada servidor en SEMrush debe tener 4 hechos especiales expuestos que describan su afiliaci√≥n: </p><br><ul><li>  hecho del <strong><code>team</code></strong> - a qu√© equipo pertenece </li><li>  <strong><code>project</code></strong> hecho - con qu√© proyecto se relaciona </li><li>  hecho de <strong><code>role</code></strong> - qu√© rol tiene este proyecto </li><li>  hecho de <strong><code>tier</code></strong> : qu√© tipo de puesta en escena tiene (prod, test, dev) </li></ul><br><p>  Como funciona  El agente de Pappet acude al maestro de Pappet y, bas√°ndose en estos hechos, busca archivos para s√≠ mismo, revisando las carpetas de acuerdo con nuestra jerarqu√≠a.  No es necesario indicar que los archivos de configuraci√≥n pertenecen a los servidores.  En cambio, los propios servidores saben qu√© archivos les pertenecen, solo mirando su ruta y sus hechos. </p><br><p>  Durante la configuraci√≥n del servidor, los administradores contactan a los desarrolladores y especifican estos par√°metros (a menudo, por el contrario, las personas con conocimiento contactan a los administradores) para construir una jerarqu√≠a en hiera en el futuro, sobre la base de la cual luego se describe la configuraci√≥n del servidor.  Tal sistema ayuda a reutilizar el c√≥digo y ser m√°s flexible en t√©rminos de configuraci√≥n del servidor. </p><br><p>  Por ejemplo, tenemos un proyecto <em>especial</em> .  En este proyecto, puede haber alg√∫n servidor frontend con nginx, un servidor back-end con python, un cl√∫ster db con mysql, un servidor redis para el almacenamiento en cach√©.  Todos estos servidores deben colocarse en un proyecto llamado <strong>especial</strong> , y luego asignar <strong>roles</strong> a los servidores. </p><br><p>  En el archivo del proyecto, describimos los par√°metros comunes a todo el proyecto.  Lo primero que viene a la mente es la creaci√≥n en todos los servidores del usuario para su implementaci√≥n con la cuesti√≥n de los derechos necesarios para √©l y el despliegue de sus claves ssh. </p><br><p>  En el rol de cada servidor, el servicio generalmente se describe y personaliza, para lo que est√° destinado este servidor (nginx, python, mysql, etc.). En este caso, definitivamente necesitaremos si tambi√©n necesitamos implementar una copia del entorno de producci√≥n en la plataforma de desarrollo, pero cambie algo en √©l (contrase√±as, por ejemplo).  En este caso, el servidor de desarrollo y el servidor de producci√≥n solo diferir√°n en el hecho de que el nivel se establece en la "posici√≥n" deseada (producci√≥n o desarrollo).  Y luego un poco de magia y hiera har√°n el truco. </p><br><p>  Si necesitamos implementar dos servidores id√©nticos en el mismo rol, pero algo en ellos deber√≠a diferir, por ejemplo, algunas l√≠neas en la configuraci√≥n, entonces otra parte de la jerarqu√≠a vendr√° al rescate.  Ponemos los archivos con el nombre del formato <strong><code>{fqdn }.yaml</code></strong> en el lugar correcto (por ejemplo, <strong><code>nodes/myserver.domain.net</code></strong> ), establecemos los valores necesarios de las variables al nivel de un servidor espec√≠fico, y el pappet aplicar√° la misma configuraci√≥n para ambos servidores para el rol, y √∫nico para cada uno. de los servidores </p><br><p>  Ejemplo: dos backends con c√≥digo php tienen el mismo rol y son completamente id√©nticos.  Est√° claro que no queremos hacer una copia de seguridad de ambos servidores, no tiene sentido.  Podemos crear una funci√≥n para describir la misma configuraci√≥n para ambos servidores, y luego crear otro archivo <strong><code>nodes/backend1.semrush.net</code></strong> en el que colocar la configuraci√≥n para la copia de seguridad. </p><br><p>  El archivo por lotes <strong><code>teams/team-name.yaml</code></strong> indica la configuraci√≥n de todos los servidores que pertenecen al equipo.  Muy a menudo, describe a los usuarios que pueden interactuar con estos servidores, as√≠ como sus derechos de acceso. </p><br><p>  En base a estas variables, hemos construido esta <strong>jerarqu√≠a</strong> .  Cuanto mayor sea el archivo encontrado en la jerarqu√≠a, mayor ser√° la prioridad de la configuraci√≥n especificada en √©l. </p><br><p>  Se deduce que las variables pueden <strong>anularse en</strong> funci√≥n de esta jerarqu√≠a.  Es decir, la variable en el archivo de rol " <strong><code>projects/%{::project}/%{::role}</code></strong> " tiene prioridad sobre la variable en el archivo de proyecto " <strong><code>projects/%{::project}</code></strong> ".  Las variables tambi√©n pueden fusionarse en todos los niveles de la jerarqu√≠a si tiene un m√≥dulo y / o perfil / rol escrito de tal manera que le permita hacer esto.  Al especificar la parte com√∫n de la configuraci√≥n de mysql para todos los servidores de proyectos, puede agregar partes especiales que tengan peso para este rol a la misma variable en otros niveles de la jerarqu√≠a (habr√° una secci√≥n adicional en la configuraci√≥n para el esclavo). </p><br><p>  Resulta que el archivo del nodo espec√≠fico ubicado a lo largo de la ruta " <strong><code>hieradata/nodes/%{::fqdn}</code></strong> " tiene la m√°s alta prioridad.  Luego viene el archivo de nodo, pero ya en el nivel de comando.  A continuaci√≥n se muestra el bloque que describe otros hechos m√°s generales: </p><br><pre> <code class="hljs axapta"> - <span class="hljs-string"><span class="hljs-string">"virtual/%{::virtual}"</span></span> - <span class="hljs-string"><span class="hljs-string">"os/%{::operatingsystem}/%{::operatingsystemmajrelease}"</span></span> - <span class="hljs-string"><span class="hljs-string">"os/%{::operatingsystem}"</span></span> - users - <span class="hljs-keyword"><span class="hljs-keyword">common</span></span></code> </pre> <br><p>  En consecuencia, en el archivo <strong><code>common.yaml</code></strong> tenemos una configuraci√≥n que definitivamente deber√≠a llegar a <strong>todos los</strong> servidores, en el archivo <strong><code>users.yaml</code></strong> se describen todos los usuarios (pero no todos se crean en servidores, por supuesto), en <strong><code>os/%{::operatingsystem}</code></strong> configuraci√≥n general t√≠pica para servidores con un sistema operativo espec√≠fico ( <code>::operatingsystem</code> fact <code>::operatingsystem</code> ) y as√≠ sucesivamente. </p><br><p>  Creo que, mirando esta jerarqu√≠a, todo se vuelve claro.  A continuaci√≥n considerar√© un ejemplo del uso de dicha jerarqu√≠a.  Pero primero debes hablar de perfiles. </p><br><h3 id="profili">  Perfiles </h3><br><p>  Un punto importante en la configuraci√≥n de servidores mediante m√≥dulos es el uso de perfiles.  Est√°n ubicados en el <strong><code>site/profiles</code></strong> ruta y son los puntos de entrada a los m√≥dulos.  Gracias a ellos, puede configurar con mayor precisi√≥n los m√≥dulos colgantes en el servidor y crear los recursos necesarios. </p><br><p>  Considere un ejemplo simple.  Hay un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">m√≥dulo</a> que instala y configura redis.  Y tambi√©n queremos establecer el par√°metro sysctl <code>vm.overcommit_memory</code> en 1 al conectar este m√≥dulo, porque <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> .  Luego escribimos un peque√±o perfil que proporciona esta funcionalidad: </p><br><pre> <code class="hljs lua"># standalone redis server class profiles::db::redis ( Hash $<span class="hljs-built_in"><span class="hljs-built_in">config</span></span> = {}, String $output_buffer_limit_slave = <span class="hljs-string"><span class="hljs-string">'256mb 64mb 60'</span></span>, ) { # https://redis.<span class="hljs-built_in"><span class="hljs-built_in">io</span></span>/topics/faq#background-saving-fails-with-a-fork-<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>-under-linux-even-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-i-have-a-lot-of-free-ram sysctl { <span class="hljs-string"><span class="hljs-string">'vm.overcommit_memory'</span></span>: ensure =&gt; present, value =&gt; <span class="hljs-string"><span class="hljs-string">'1'</span></span>, } class { <span class="hljs-string"><span class="hljs-string">'::redis'</span></span>: * =&gt; $<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>, } }</code> </pre> <br><p>  Como se mencion√≥ anteriormente, los perfiles son una herramienta que le permite cambiar / mejorar el comportamiento del m√≥dulo, as√≠ como reducir el n√∫mero de configuraciones en hiera.  Si usa m√≥dulos remotos, a menudo puede encontrar el problema de que los m√≥dulos "aprobados" a menudo no tienen la funcionalidad que necesita, o tienen alg√∫n tipo de errores / fallas.  Luego, en principio, puede clonar este m√≥dulo y corregir / agregar funcionalidad.  Pero la decisi√≥n correcta ser√≠a, si es posible, escribir un buen perfil que pueda "preparar" el m√≥dulo de la manera que lo necesite.  A continuaci√≥n se presentan algunos ejemplos de perfiles, y puede comprender mejor por qu√© son necesarios. </p><br><h3 id="sokrytie-sekretov-v-hiera">  Ocultando secretos en hiera </h3><br><p>  Una de las ventajas importantes de hiera en comparaci√≥n con la pappet desnuda es su capacidad de almacenar datos confidenciales en archivos de configuraci√≥n en forma cifrada en el repositorio.  Tus contrase√±as estar√°n a salvo. </p><br><p>  En resumen, utiliza la clave p√∫blica para cifrar la informaci√≥n que necesita y colocarla con dicha l√≠nea en el archivo hiera.  La parte privada de la clave se almacena en el maestro de pappet, que le permite descifrar estos datos.  Se pueden encontrar m√°s detalles en la p√°gina del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">proyecto</a> . </p><br><p>  En el cliente (computadora en funcionamiento), la herramienta se instala simplemente usando <strong><code>gem install hiera-eyaml</code></strong> .  Adem√°s, utilizando un comando de la forma <strong><code>eyaml encrypt --pkcs7-public-key=/path/to/public_key.pkcs7.pem -s 'hello'</code></strong> puede cifrar datos y pegarlos en un archivo con la extensi√≥n eyaml o solo yaml, dependiendo de c√≥mo configure, y luego el pappet lo resolver√°.  Obtienes algo como: </p><br><pre> <code class="hljs ruby">roles::postrgresql::<span class="hljs-symbol"><span class="hljs-symbol">password:</span></span> <span class="hljs-string"><span class="hljs-string">'ENC[PKCS7,MIIBeQYJKoZIhvcNAQcDoIIBajCCAWYCAQAxggEhMIIBHQIBADAFMAACAQEwDQYJKoZIhvcNAQEBBQAEggEAbIz1ihQlThMWa9T+Lq194Y6QdElMD1XTev5y+VPSHtkPTu6Al6TJaSrXF+7phJIjue+NF4ZVtJCLkHxUR6nJJqks0fcGS1vF2+6mmM9cy69sIU1A3HqpOHZLuqHAc7jUqljYxpwWSIGOK6I2FygdAp5FfOTewqfcVVmXj97EJdcv3DKrbAlSrIMO2iZRYwQvyv+qnptnZ7pilR2veOCPW2UMm6zagDLutX9Ft5vERbdaiCiEfTOpVa9Qx0GqveNRVJLV/5lfcL5ajdNBJXkvKqDbx8d3ZBtEVAAqeKlw0LqzScgmCbWQx2kUzukX5LSxbTpT0Th984Vp1sl7iPk7UTA8BgkqhkiG9w0BBwEwHQYJYIZIAWUDBAEqBBCp5GcwidcEMA+0wjAMblkKgBCR/f9KGXUgLh3/Ok60OIT5]'</span></span></code> </pre> <br><p>  O una cadena de varias l√≠neas: </p><br><pre> <code class="hljs powershell">roles::postgresql::password: &gt; ENC[<span class="hljs-type"><span class="hljs-type">PKCS7</span></span>,<span class="hljs-type"><span class="hljs-type">MIIBeQYJKoZIhvcNAQcDoIIBajCCAWYCAQAxggEhMIIBHQIBADAFMAACAQEw</span></span> <span class="hljs-type"><span class="hljs-type">DQYJKoZIhvcNAQEBBQAEggEAbIz1ihQlThMWa9T</span></span>+<span class="hljs-type"><span class="hljs-type">Lq194Y6QdElMD1XTev5y</span></span> +<span class="hljs-type"><span class="hljs-type">VPSHtkPTu6Al6TJaSrXF</span></span>+<span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-type"><span class="hljs-type">phJIjue</span></span>+<span class="hljs-type"><span class="hljs-type">NF4ZVtJCLkHxUR6nJJqks0fcGS1vF</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>+<span class="hljs-number"><span class="hljs-number">6</span></span><span class="hljs-type"><span class="hljs-type">mmM9cy69sIU1A3HqpOHZLuqHAc7jUqljYxpwWSIGOK6I2FygdAp5FfOTe</span></span> <span class="hljs-type"><span class="hljs-type">wqfcVVmXj97EJdcv3DKrbAlSrIMO2iZRYwQvyv</span></span>+<span class="hljs-type"><span class="hljs-type">qnptnZ7pilR2veOCPW2UM</span></span> <span class="hljs-type"><span class="hljs-type">m6zagDLutX9Ft5vERbdaiCiEfTOpVa9Qx0GqveNRVJLV</span></span>/<span class="hljs-number"><span class="hljs-number">5</span></span><span class="hljs-type"><span class="hljs-type">lfcL5ajdNBJXkv</span></span> <span class="hljs-type"><span class="hljs-type">KqDbx8d3ZBtEVAAqeKlw0LqzScgmCbWQx2kUzukX5LSxbTpT0Th984Vp1sl7</span></span> <span class="hljs-type"><span class="hljs-type">iPk7UTA8BgkqhkiG9w0BBwEwHQYJYIZIAWUDBAEqBBCp5GcwidcEMA</span></span>+<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">wjAM</span></span> <span class="hljs-type"><span class="hljs-type">blkKgBCR</span></span>/<span class="hljs-type"><span class="hljs-type">f9KGXUgLh3</span></span>/<span class="hljs-type"><span class="hljs-type">Ok60OIT5</span></span>]</code> </pre> <br><p>  Parece que hemos terminado con la preparaci√≥n, ahora podemos considerar un ejemplo. </p><br><h3 id="primer-na-palcah">  Ejemplo de dedo </h3><br><p>  <strong>Spoiler</strong> : <em>habr√° muchas m√°s configuraciones, por lo que aquellos que est√©n interesados ‚Äã‚Äãen este art√≠culo de inter√©s puramente te√≥rico pueden omitir esta secci√≥n e ir al final.</em> </p><br><p>  Veamos ahora un ejemplo de c√≥mo configurar un servidor usando hiera en puppet4.  No publicar√© el c√≥digo para todos los perfiles, porque de lo contrario la publicaci√≥n ser√° bastante grande.  Me enfocar√© en la jerarqu√≠a y configuraci√≥n de hiera. </p><br><p>  <strong>La tarea es esta:</strong> necesitamos implementar: </p><br><ul><li>  Dos servidores db id√©nticos en los que se implementa postgresql </li><li>  Dos servidores m√°s: interfaz con nginx </li><li>  Quinto y sexto servidor: backends de Python en Docker </li><li>  Todo es igual en el entorno de desarrollo, excepto algunas configuraciones de servidor </li></ul><br><p>  Crearemos nuestra jerarqu√≠a en orden y comenzaremos con el archivo del proyecto. </p><br><h4 id="proekt">  Proyecto </h4><br><p>  Cree el archivo de <strong><code>projects/kicker.yaml</code></strong> .  Ponemos en √©l lo que es com√∫n a todos los servidores: necesitamos algunos repositorios y carpetas para la implementaci√≥n, as√≠ como el propio usuario de implementaci√≥n. </p><br><pre> <code class="hljs ruby">--- <span class="hljs-symbol"><span class="hljs-symbol">classes:</span></span> - apt::debian::semrush <span class="hljs-symbol"><span class="hljs-symbol">files:</span></span> <span class="hljs-string"><span class="hljs-string">"/srv/data"</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">ensure:</span></span> <span class="hljs-string"><span class="hljs-string">'directory'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">owner:</span></span> <span class="hljs-string"><span class="hljs-string">'deploy'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">group:</span></span> <span class="hljs-string"><span class="hljs-string">'www-data'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">mode:</span></span> <span class="hljs-string"><span class="hljs-string">'0755'</span></span> <span class="hljs-string"><span class="hljs-string">'/srv/data/shared_temp'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">ensure:</span></span> <span class="hljs-string"><span class="hljs-string">'directory'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">owner:</span></span> <span class="hljs-string"><span class="hljs-string">'deploy'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">group:</span></span> <span class="hljs-string"><span class="hljs-string">'www-data'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">mode:</span></span> <span class="hljs-string"><span class="hljs-string">'0775'</span></span> user_management::<span class="hljs-symbol"><span class="hljs-symbol">present:</span></span> - deploy</code> </pre> <br><h4 id="rol-db">  Rol db </h4><br><p>  Cree un archivo de roles para los servidores de bases de datos <strong><code>projects/kicker/db.yaml</code></strong> .  Hasta ahora, lo haremos sin dividir los servidores en entornos: </p><br><pre> <code class="hljs ruby">--- <span class="hljs-symbol"><span class="hljs-symbol">classes:</span></span> - profiles::db::postgresql profiles::db::postgresql::<span class="hljs-symbol"><span class="hljs-symbol">globals:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">manage_package_repo:</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-symbol"><span class="hljs-symbol">version:</span></span> <span class="hljs-string"><span class="hljs-string">'10'</span></span> profiles::db::postgresql::<span class="hljs-symbol"><span class="hljs-symbol">db_configs:</span></span> <span class="hljs-string"><span class="hljs-string">'listen_addresses'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">value:</span></span> <span class="hljs-string"><span class="hljs-string">'*'</span></span> profiles::db::postgresql::<span class="hljs-symbol"><span class="hljs-symbol">databases:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">kicker:</span></span> {} profiles::db::postgresql::<span class="hljs-symbol"><span class="hljs-symbol">hba_rules:</span></span> <span class="hljs-string"><span class="hljs-string">'local connect to kicker'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> <span class="hljs-string"><span class="hljs-string">'local'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">database:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">user:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">auth_method:</span></span> <span class="hljs-string"><span class="hljs-string">'md5'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">order:</span></span> <span class="hljs-string"><span class="hljs-string">'001'</span></span> <span class="hljs-string"><span class="hljs-string">'allow connect from 192.168.1.100'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> <span class="hljs-string"><span class="hljs-string">'host'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">database:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">user:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">auth_method:</span></span> <span class="hljs-string"><span class="hljs-string">'md5'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">address:</span></span> <span class="hljs-string"><span class="hljs-string">'192.168.1.100/32'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">order:</span></span> <span class="hljs-string"><span class="hljs-string">'002'</span></span></code> </pre> <br><p>  Aqu√≠ conectamos un perfil escrito para uso general de todos los que quieran instalar postgres en su servidor.  El perfil es configurable y le permite configurar de manera flexible el m√≥dulo antes de aplicarlo. </p><br><p>  Para los m√°s curiosos, debajo del c√≥digo cat para este perfil: </p><br><div class="spoiler">  <b class="spoiler_title">Perfil :: db :: postgresql</b> <div class="spoiler_text"><pre> <code class="hljs mel">class profiles::db::postgresql ( Hash $globals = {}, Hash $params = {}, Hash $recovery = {}, Hash[String, Hash[String, Variant[String, Boolean, Integer]]] $roles = {}, Hash[String, Hash[String, Variant[String, Boolean]]] $db_configs = {}, Hash[String, Hash[String, Variant[String, Boolean]]] $databases = {}, Hash[String, String] $db_grants = {}, Hash[String, Hash[String, String]] $extensions = {}, Hash[String, String] $table_grants = {}, Hash[String, Hash[String, String]] $hba_rules = {}, Hash[String, String] $indent_rules = {}, Optional[String] $role = undef, # <span class="hljs-string"><span class="hljs-string">'master'</span></span>, <span class="hljs-string"><span class="hljs-string">'slave'</span></span> Optional[String] $master_host = undef, Optional[String] $replication_password = undef, Integer $master_port = <span class="hljs-number"><span class="hljs-number">5432</span></span>, String $replication_user = <span class="hljs-string"><span class="hljs-string">'repl'</span></span>, String $trigger_file = <span class="hljs-string"><span class="hljs-string">'/tmp/pg_trigger.file'</span></span>, ){ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> $role { <span class="hljs-string"><span class="hljs-string">'slave'</span></span>: { $_params = { manage_recovery_conf =&gt; true, } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $globals[<span class="hljs-string"><span class="hljs-string">'datadir'</span></span>] { <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> { <span class="hljs-string"><span class="hljs-string">"${globals['datadir']}/recovery.done"</span></span>: ensure =&gt; absent, } } $_recovery = { <span class="hljs-string"><span class="hljs-string">'recovery config'</span></span> =&gt; { standby_mode =&gt; <span class="hljs-string"><span class="hljs-string">'on'</span></span>, primary_conninfo =&gt; <span class="hljs-string"><span class="hljs-string">"host=${master_host} port=${master_port} user=${replication_user} password=${replication_password}"</span></span>, trigger_file =&gt; $trigger_file, } } $_conf = { <span class="hljs-string"><span class="hljs-string">'hot_standby'</span></span> =&gt; { value =&gt; <span class="hljs-string"><span class="hljs-string">'on'</span></span>, }, } <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> { $trigger_file: ensure =&gt; absent, } } <span class="hljs-string"><span class="hljs-string">'master'</span></span>: { $_conf = { <span class="hljs-string"><span class="hljs-string">'wal_level'</span></span> =&gt; { value =&gt; <span class="hljs-string"><span class="hljs-string">'replica'</span></span>, }, <span class="hljs-string"><span class="hljs-string">'max_wal_senders'</span></span> =&gt; { value =&gt; <span class="hljs-number"><span class="hljs-number">5</span></span>, }, <span class="hljs-string"><span class="hljs-string">'wal_keep_segments'</span></span> =&gt; { value =&gt; <span class="hljs-number"><span class="hljs-number">32</span></span>, }, } <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> { $trigger_file: ensure =&gt; present, } } <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: { $_params = {} $_recovery = {} $_conf = {} } } class { <span class="hljs-string"><span class="hljs-string">'::postgresql::globals'</span></span>: * =&gt; $globals, } class { <span class="hljs-string"><span class="hljs-string">'::postgresql::server'</span></span>: * =&gt; deep_merge($_params, $params), } create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::config_entry'</span></span>, deep_merge($_conf, $db_configs)) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::role'</span></span>, $roles) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::database'</span></span>, $databases) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::database_grant'</span></span>, $db_grants) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::extension'</span></span>, $extensions) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::table_grant'</span></span>, $table_grants) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::pg_hba_rule'</span></span>, $hba_rules) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::pg_indent_rule'</span></span>, $indent_rules) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::recovery'</span></span>, deep_merge($_recovery, $recovery)) }</code> </pre> </div></div><br><p>  Por lo tanto, instalamos <code>Postgresql 10</code> una sola vez, configuramos la configuraci√≥n ( <code>listen</code> ), creamos la base de datos <code>kicker</code> y tambi√©n escribimos dos reglas para acceder a esta base de datos en <code>pg_hba.conf</code> .  Genial! </p><br><h4 id="rol-frontend">  Rol frontend </h4><br><p>  Nos <code>frontend</code> la <code>frontend</code> .  Cree el archivo <strong><code>projects/kicker/frontend.yaml</code></strong> con los siguientes contenidos: </p><br><pre> <code class="hljs ruby">--- <span class="hljs-symbol"><span class="hljs-symbol">classes:</span></span> - profiles::webserver::nginx profiles::webserver::nginx::<span class="hljs-symbol"><span class="hljs-symbol">servers:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker.semrush.com'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">use_default_location:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-symbol"><span class="hljs-symbol">listen_port:</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-symbol"><span class="hljs-symbol">server_name:</span></span> - <span class="hljs-string"><span class="hljs-string">'kicker.semrush.com'</span></span> profiles::webserver::nginx::<span class="hljs-symbol"><span class="hljs-symbol">locations:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker-root'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">location:</span></span> <span class="hljs-string"><span class="hljs-string">'/'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">server:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker.semrush.com'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy:</span></span> <span class="hljs-string"><span class="hljs-string">'http://kicker-backend.semrush.com:8080'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy_set_header:</span></span> - <span class="hljs-string"><span class="hljs-string">'X-Real-IP $remote_addr'</span></span> - <span class="hljs-string"><span class="hljs-string">'X-Forwarded-for $remote_addr'</span></span> - <span class="hljs-string"><span class="hljs-string">'Host kicker.semrush.com'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">location_cfg_append:</span></span> <span class="hljs-string"><span class="hljs-string">'proxy_next_upstream'</span></span>: <span class="hljs-string"><span class="hljs-string">'error timeout invalid_header http_500 http_502 http_503 http_504'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy_connect_timeout:</span></span> <span class="hljs-string"><span class="hljs-string">'5'</span></span></code> </pre> <br><p>  Todo es simple aqu√≠.  Conectamos los <strong><code>profiles::webserver::nginx</code></strong> perfil <strong><code>profiles::webserver::nginx</code></strong> , que prepara la entrada en el m√≥dulo nginx, y tambi√©n definimos las variables, espec√≠ficamente el <code>server</code> y la <code>location</code> de este sitio. </p><br><p>  Un lector atento notar√° que ser√≠a m√°s apropiado colocar la descripci√≥n del sitio m√°s arriba en la jerarqu√≠a, porque todav√≠a tendremos un entorno de desarrollo, y all√≠ se usar√°n otras variables ( <code>server_name</code> , <code>proxy</code> ), pero esto no es demasiado importante.  Al describir el rol de esta manera, podemos ver c√≥mo estas variables se redefinen solo por jerarqu√≠a. </p><br><h4 id="rol-docker">  Rol Docker </h4><br><p>  El papel de <code>docker</code> <strong><code>projects/kicker/docker.yaml</code></strong> : </p><br><pre> <code class="hljs ruby">--- <span class="hljs-symbol"><span class="hljs-symbol">classes:</span></span> - profiles::docker profiles::docker::<span class="hljs-symbol"><span class="hljs-symbol">params:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">version:</span></span> <span class="hljs-string"><span class="hljs-string">'17.05.0~ce-0~debian-stretch'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">packages:</span></span> <span class="hljs-string"><span class="hljs-string">'python3-pip'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">provider:</span></span> apt <span class="hljs-string"><span class="hljs-string">'Fabric3'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">provider:</span></span> pip3 <span class="hljs-symbol"><span class="hljs-symbol">ensure:</span></span> <span class="hljs-number"><span class="hljs-number">1.12</span></span>.post1 user_management::<span class="hljs-symbol"><span class="hljs-symbol">users:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">deploy:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">groups:</span></span> - docker</code> </pre> <br><p>  El <strong><code>profiles/docker.pp</code></strong> muy simple y elegante.  Le dar√© su c√≥digo: </p><br><div class="spoiler">  <b class="spoiler_title">Perfil :: docker</b> <div class="spoiler_text"><pre> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">profiles</span></span></span><span class="hljs-class">:</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">:docker </span></span></span></span>( Hash $params = {}, <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> $install_kernel = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, ){ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-string"><span class="hljs-string">'docker'</span></span>: * =&gt; $params, } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($install_kernel) { include profiles::docker::kernel } }</code> </pre> </div></div><br><p>  Todo esta listo.  Esto ya es suficiente para implementar el producto que necesitamos en muchos servidores, simplemente asign√°ndoles un proyecto y una funci√≥n espec√≠ficos (por ejemplo, colocando el archivo en el formato deseado en el directorio facts.d, cuya ubicaci√≥n depende del m√©todo de instalaci√≥n de Puppet). </p><br><p>  Ahora tenemos la siguiente estructura de archivos: </p><br><pre> <code class="bash hljs">. ‚îú‚îÄ‚îÄ kicker ‚îÇ ‚îú‚îÄ‚îÄ db.yaml ‚îÇ ‚îú‚îÄ‚îÄ docker.yaml ‚îÇ ‚îî‚îÄ‚îÄ frontend.yaml ‚îî‚îÄ‚îÄ kicker.yaml 1 directory, 4 files</code> </pre> <br><p>  Ahora nos ocuparemos de los entornos y la definici√≥n de una configuraci√≥n √∫nica para un rol en un sitio en particular. </p><br><h4 id="okruzheniya-i-override">  Medio ambiente y anulaci√≥n </h4><br><p>  Creemos la configuraci√≥n general para todas las ventas.  El archivo <strong><code>projects/kicker/tiers/prod.yaml</code></strong> contiene una indicaci√≥n de que necesitamos conectar una clase con un firewall a este entorno (bueno, prod lo mismo), as√≠ como una clase determinada que proporciona un mayor nivel de seguridad: </p><br><pre> <code class="hljs pgsql"><span class="hljs-comment"><span class="hljs-comment">--- classes: - semrush_firewall - strict_security_level</span></span></code> </pre> <br><p>  Para un entorno de desarrollo, si necesitamos describir algo espec√≠fico, se crea el mismo archivo y se ingresa la configuraci√≥n necesaria. </p><br><p>  A continuaci√≥n, a√∫n necesita redefinir las variables para la configuraci√≥n nginx de la funci√≥n <code>frontend</code> en el entorno de desarrollo.  Para hacer esto, debe crear el archivo <strong><code>projects/kicker/tiers/dev/frontend.yaml</code></strong> .  Presta atenci√≥n a un nuevo nivel de jerarqu√≠a. </p><br><pre> <code class="hljs ruby">--- profiles::webserver::nginx::<span class="hljs-symbol"><span class="hljs-symbol">servers:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker-dev.semrush.com'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">use_default_location:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-symbol"><span class="hljs-symbol">listen_port:</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-symbol"><span class="hljs-symbol">server_name:</span></span> - <span class="hljs-string"><span class="hljs-string">'kicker-dev.semrush.com'</span></span> profiles::webserver::nginx::<span class="hljs-symbol"><span class="hljs-symbol">locations:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker-root'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">location:</span></span> <span class="hljs-string"><span class="hljs-string">'/'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">server:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker-dev.semrush.com'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy:</span></span> <span class="hljs-string"><span class="hljs-string">'http://kicker-backend-dev.semrush.com:8080'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy_set_header:</span></span> - <span class="hljs-string"><span class="hljs-string">'X-Real-IP $remote_addr'</span></span> - <span class="hljs-string"><span class="hljs-string">'X-Forwarded-for $remote_addr'</span></span> - <span class="hljs-string"><span class="hljs-string">'Host kicker-dev.semrush.com'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">location_cfg_append:</span></span> <span class="hljs-string"><span class="hljs-string">'proxy_next_upstream'</span></span>: <span class="hljs-string"><span class="hljs-string">'error timeout invalid_header http_500 http_502 http_503 http_504'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy_connect_timeout:</span></span> <span class="hljs-string"><span class="hljs-string">'5'</span></span></code> </pre> <br><p>  La clase ya no es necesaria; se hereda de los niveles anteriores de la jerarqu√≠a.  Aqu√≠ hemos cambiado <code>server_name</code> y <code>proxy_pass</code> .  Un servidor que tiene los hechos role = frontend y tier = dev primero encontrar√° el archivo <strong><code>projects/kicker/frontend.yaml</code></strong> por s√≠ mismo, pero luego las variables de este archivo ser√°n anuladas por el archivo <strong><code>projects/kicker/tiers/dev/frontend.yaml</code></strong> con mayor prioridad . </p><br><h4 id="sokrytie-parolya-dlya-postgresql">  Contrase√±a oculta para PostgreSQL </h4><br><p>  Y as√≠ tenemos el √∫ltimo elemento en la agenda: establecer contrase√±as para PostgreSQL. </p><br><p>  Las contrase√±as deben variar en los entornos.  Usaremos eyaml para almacenar contrase√±as de forma segura.  Crea contrase√±as: </p><br><pre> <code class="bash hljs">eyaml encrypt -s <span class="hljs-string"><span class="hljs-string">'verysecretpassword'</span></span> eyaml encrypt -s <span class="hljs-string"><span class="hljs-string">'testpassword'</span></span></code> </pre> <br><p>  Pegamos las l√≠neas resultantes en los archivos <code>**projects/kicker/tiers/prod/db.yaml**</code> y <code>**projects/kicker/tiers/dev/db.yaml**</code> (o puede usar la extensi√≥n eyaml, esto es personalizable), respectivamente.  Aqu√≠ hay un ejemplo: </p><br><pre> <code class="hljs ruby">--- profiles::db::postgresql::<span class="hljs-symbol"><span class="hljs-symbol">roles:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">password_hash:</span></span> &gt; <span class="hljs-string"><span class="hljs-string">'ENC[PKCS7,MIIBeQYJKoZIhvcNAQcDoIIBajCCAWYCAQAxggEhMIIBHQIBADAFMAACAQEwDQYJKoZIhvcNAQEBBQAEggEAsdpb2P0axUJzyWr2duRKAjh0WooGYUmoQ5gw0nO9Ym5ftv6uZXv25DRMKh7vsbzrrOR5/lLesx/pAVmcs2qbhd/y0Vr1oc2ohHlZBBKtCSEYwem5VN+kTMhWPvlt93x/S9ERoBp8LrrsIvicSYZByNfpS2DXCFbogSXCfEPxTTmCOtlOnxdjidIc9Q1vfAXv7FRQanYIspr2UytScm56H/ueeAc/8RYK51/nXDMtdPOiAP5VARioUKyTDSk8FqNvdUZRqA3cl+hA+xD5PiBHn5T09pnH8HyE/39q09gE0pXRe5+mOnU/4qfqFPc/EvAgAq5mVawlCR6c/cCKln5wJTA8BgkqhkiG9w0BBwEwHQYJYIZIAWUDBAEqBBDNKijGHBLPCth0sfwAjfl/gBAaPsfvzZQ/Umgjy1n+im0s]'</span></span></code> </pre> <br><p>  A continuaci√≥n, la contrase√±a para el rol de <code>kicker</code> vendr√°, se descifrar√° y se aplicar√° en el servidor de la base de datos en PostgreSQL. </p><br><p>  Eso, de hecho, es todo.  S√≠, el ejemplo result√≥ ser masivo, pero, espero, funcional, sin dejar preguntas, claro y √∫til.  La jerarqu√≠a resultante en hiera es esta: </p><br><pre> <code class="bash hljs">. ‚îú‚îÄ‚îÄ db.yaml ‚îú‚îÄ‚îÄ docker.yaml ‚îú‚îÄ‚îÄ frontend.yaml ‚îî‚îÄ‚îÄ tiers ‚îú‚îÄ‚îÄ dev ‚îÇ ‚îú‚îÄ‚îÄ db.yaml ‚îÇ ‚îî‚îÄ‚îÄ frontend.yaml ‚îú‚îÄ‚îÄ prod ‚îÇ ‚îî‚îÄ‚îÄ db.yaml ‚îî‚îÄ‚îÄ prod.yaml 3 directories, 7 files</code> </pre> <br><p>  Puede ver estos archivos en vivo clonando un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">repositorio</a> especialmente creado </p><br><h3 id="zaklyuchenie">  Conclusi√≥n </h3><br><p>  La marioneta es buena y f√°cil de usar con hiera.  No lo llamar√≠a una herramienta de configuraci√≥n ideal en el mundo moderno, en absoluto, pero merece atenci√≥n.  Hace frente a algunas tareas muy bien, y su "filosof√≠a" de mantener un estado de recursos y configuraci√≥n constantemente id√©nticos puede desempe√±ar un papel importante para garantizar la seguridad y la uniformidad de las configuraciones. </p><br><p>  El mundo moderno se est√° sinergizando y desarrollando gradualmente.  Pocas personas ahora usan solo un sistema de configuraci√≥n, a menudo en el arsenal de desarrolladores y administradores hay varios sistemas a la vez.  Y esto es bueno, ya que hay mucho para elegir.  Lo principal es que todo debe ser l√≥gico y comprensible, c√≥mo y d√≥nde se puede configurar. </p><br><p>  Como resultado, nuestro objetivo como administradores es no configurar nada nosotros mismos.  Idealmente, todo esto debe ser realizado por los propios equipos.  Y debemos darles una herramienta o producto que nos permita hacer esto de forma segura, f√°cil y, lo m√°s importante, con un resultado preciso.  Bueno, y ayuda a resolver problemas arquitect√≥nicos y m√°s serios que "Necesitas instalar PostgreSQL en el servidor y crear un usuario".  ¬°Camon, 2018 est√° en el patio! <del>  As√≠ que arroja t√≠teres y ansibles y pasa al futuro sin servidor. </del></p><br><p>  Con el desarrollo de los sistemas de nubes, contenedorizaci√≥n y orquestaci√≥n de contenedores, los sistemas de gesti√≥n de configuraci√≥n est√°n retrocediendo lentamente en segundo plano para usuarios y clientes.  Tambi√©n puede generar un cl√∫ster de contenedores a prueba de fallas en la nube y mantener sus aplicaciones en contenedores con skeling autom√°tico, copia de seguridad, replicaci√≥n, descubrimiento autom√°tico, etc., sin escribir una sola l√≠nea para ansible, puppet, chef, etc.  No tienes que ocuparte de nada (bueno, casi).  Por otro lado, hay menos servidores de hierro debido a las nubes.  Es solo que ya no necesita configurarlos, esta acci√≥n es responsabilidad del proveedor de la nube.  Pero es poco probable que usen los mismos sistemas que los mortales comunes. </p><br><h4 id="credits">  Cr√©ditos </h4><br><p>  Gracias </p><br><ul><li>  Dmitry Tupitsin, Dmitry Loginov, Stepan Fedorov y todo el equipo de administradores de sistemas por su ayuda en la preparaci√≥n de este art√≠culo. </li><li>  Vladimir Legkostupov para la foto </li><li>  Yana Tabakova por organizar todo esto y ayudar a pasar por todas las etapas previas a la publicaci√≥n </li><li>  Nikita Zakharov por asistencia en asuntos de licencias </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es412587/">https://habr.com/ru/post/es412587/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es412573/index.html">Lo que est√° mal con Geektimes regresa a Habr</a></li>
<li><a href="../es412575/index.html">Cada a√±o, la m√∫sica pop se vuelve cada vez m√°s mon√≥tona, porque la misma gente la compone.</a></li>
<li><a href="../es412579/index.html">Marvel: Infinity War o C√≥mo recopilar datos para su proyecto en un par de minutos</a></li>
<li><a href="../es412581/index.html">Desde la Edad de Piedra hasta la Segunda Guerra Mundial: c√≥mo se utilizan los robots para investigar artefactos hist√≥ricos</a></li>
<li><a href="../es412583/index.html">Desmontamos el protocolo de hervidor de agua Redmond G200S y lo conectamos a HomeAssistant</a></li>
<li><a href="../es412589/index.html">25 entretenidas bibliotecas de Android. Primavera 2018</a></li>
<li><a href="../es412591/index.html">Construyendo un jetpack: el 29 de mayo es el D√≠a de los Ca√≠dos de Wendell Moore</a></li>
<li><a href="../es412593/index.html">Nuevos productos, plataformas y todo como servicio: seminarios web de HPE</a></li>
<li><a href="../es412595/index.html">Informe del Club de Roma 2018, Cap√≠tulo 1.1.2: ‚ÄúFinanciaci√≥n‚Äù</a></li>
<li><a href="../es412597/index.html">Jeff Bezos va a construir una colonia en la superficie de la luna</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>