<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∑üèª üöµüèΩ üéº Spielfunktionen mit ECS: F√ºgen Sie dem Sch√ºtzen ein Erste-Hilfe-Set hinzu üà∫ üë®üèº‚Äçüíº üë©üèæ‚Äçüíª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Gehen wir von Teppichen zu ernsten Dingen √ºber. Wir haben bereits √ºber ECS gesprochen, welche Frameworks es f√ºr Unity gibt und warum sie ihre eigenen ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Spielfunktionen mit ECS: F√ºgen Sie dem Sch√ºtzen ein Erste-Hilfe-Set hinzu</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pixonic/blog/431660/"><img src="https://habrastorage.org/webt/qi/7x/ws/qi7xwsjwk196kqfg3ulcss6d3eo.jpeg"><br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gehen wir</a> von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teppichen</a> zu ernsten Dingen √ºber.  Wir haben bereits √ºber ECS gesprochen, welche Frameworks es f√ºr Unity gibt und warum sie ihre eigenen geschrieben haben (die Liste finden Sie am Ende des Artikels).  Konzentrieren wir uns nun auf konkrete Beispiele, wie wir ECS in unserem neuen mobilen PvP-Shooter verwenden und wie wir Spielfunktionen implementieren.  Ich stelle fest, dass wir diese Architektur nur verwenden, um die Welt auf dem Server und das Vorhersagesystem auf dem Client zu simulieren.  Objektvisualisierung und -rendering werden nach dem MVP-Muster implementiert - aber heute nicht mehr. <a name="habracut"></a><br><br>  Die ECS-Architektur ist datenorientiert, alle Daten der Spielwelt werden im sogenannten GameState gespeichert und sind eine Liste von Entit√§ten (Entit√§ten) mit einigen Komponenten auf jeder von ihnen.  Eine Reihe von Komponenten bestimmt das Verhalten eines Objekts.  Und die Logik des Komponentenverhaltens konzentriert sich auf Systeme. <br><br>  Der Gamestate in unserem ECS besteht aus zwei Teilen: RuleBook und WorldState.  RuleBook ist eine Reihe von Komponenten, die sich w√§hrend eines Spiels nicht √§ndern.  Alle statischen Daten werden dort gespeichert (Eigenschaften von Waffen / Charakteren, Zusammensetzung der Teams) und nur einmal an den Client gesendet - w√§hrend der Autorisierung auf dem Spielserver. <br><br>  Stellen Sie sich ein einfaches Beispiel vor: Spawnen Sie einen Charakter und verschieben Sie ihn mit zwei Joysticks in einen 2D-Raum.  Deklarieren Sie zun√§chst die Komponenten. <br><br>  Dies definiert den Spieler und ist f√ºr die Charaktervisualisierung erforderlich: <br><br><pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Component</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Player</span></span> { }</code> </pre> <br>  Die n√§chste Komponente ist eine Anforderung zum Erstellen eines neuen Zeichens.  Es enth√§lt zwei Felder: Zeichen-Spawn-Zeit (in Ticks) und seine ID: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Component</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PlayerSpawnRequest</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> SpawnTime; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> unit PlayerId; }</code> </pre> <br>  Die Komponente der Ausrichtung des Objekts im Raum: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Component</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Transform</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Vector2 Position; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> Rotation; }</code> </pre> <br>  Die Komponente, die die aktuelle Geschwindigkeit des Objekts speichert: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Component</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Movement</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Vector2 Velocity; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> RotateToAngle; }</code> </pre> <br>  Die Komponente, die die Eingaben des Players speichert (Bewegungs-Joystick-Vektor und Joystick-Vektor f√ºr die Zeichendrehung): <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Component</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Input</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Vector2 MoveVector; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Vector2 RotateVector; }</code> </pre> <br>  Komponente mit statischen Eigenschaften des Charakters (sie wird im Regelbuch gespeichert, da dies eine grundlegende Eigenschaft ist und sich w√§hrend der Spielsitzung nicht √§ndert): <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Component</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PlayerStats</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> MoveSpeed; }</code> </pre> <br>  Bei der Zerlegung eines Features in Systeme orientieren wir uns h√§ufig am Prinzip der Einzelverantwortung: Jedes System muss nur eine Funktion erf√ºllen. <br><br>  Features k√∂nnen aus mehreren Systemen bestehen.  Beginnen wir mit der Definition des Charakter-Spawn-Systems.  Das System durchl√§uft alle Anforderungen zum Erstellen eines Charakters in einem Spielstatus. Wenn die aktuelle Weltzeit mit der erforderlichen √ºbereinstimmt, erstellt es eine neue Entit√§t und f√ºgt ihr die Komponenten hinzu, die den Spieler definieren: <i>Spieler</i> , <i>Transformieren</i> , <i>Bewegung</i> . <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SpawnPlayerSystem</span></span> : <span class="hljs-title"><span class="hljs-title">ExecutableSystem</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gs</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> deleter = gs.Pools.Deferred.GetDeleter(gs.WorldState.SpawnAvatarRequest); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> avatarRequest <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gs.WorldState.SpawnAvatarRequest) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (avatarRequest.Value.SpawnTime == gs.Time) { <span class="hljs-comment"><span class="hljs-comment">// create new entity with player ID var playerEntity = gs.WorldState.CreateEntity(avatarRequest.Value.PlayerId); // add components to determinate player behaviour playerEntity.AddPlayer(); playerEntity.AddTransform(Vector2.zero, 0); playerEntity.AddMovement(Vector2.zero, 0); // delete player spawn request deleter.Delete(avatarRequest.Key); } } } }</span></span></code> </pre><br>  Betrachten Sie nun die Bewegung des Players auf dem Joystick.  Wir brauchen ein System, das Eingaben verarbeitet.  Es durchl√§uft alle Komponenten der Eingabe, berechnet die Geschwindigkeit des Spielers (er steht oder bewegt sich) und wandelt den Vektor des Joysticks in einen Drehwinkel um: <br><br><pre> <code class="cs hljs">MovementControlSystem <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MovementControlSystem</span></span> : <span class="hljs-title"><span class="hljs-title">ExecutableSystem</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gs</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> playerStats = gs.RuleBook.PlayerStats[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pair <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gs.Input) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> movement = gs.WorldState.Movement[pair.Key]; movement.Velocity = pair.Value.MoveVector.normalized * playerStats.MoveSpeed; movement.RotateToAngle = Math.Atan2(pair.Value.RotateVector.y, pair.Value.RotateVector.x); } } }</code> </pre> <br>  Das n√§chste ist das Bewegungssystem: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MovementSystem</span></span> : <span class="hljs-title"><span class="hljs-title">ExecutableSystem</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gs</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pair <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gs.WorldState.Movement) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> transform = gs.WorldState.Transform[pair.Key]; transform.Position += pair.Value.Velocity * GameState.TickDurationSec; } } }</code> </pre> <br>  Das System, das f√ºr die Drehung des Objekts verantwortlich ist: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RotationSystem</span></span> : <span class="hljs-title"><span class="hljs-title">ExecutableSystem</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gs</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pair <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gs.WorldState.Movement) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> transform = gs.WorldState.Transform[pair.Key]; transform.Angle = pair.Value.RotateToAngle; } } }</code> </pre> <br>  <i>MovementSystem</i> und <i>RotationSystem</i> funktionieren nur mit <i>Transformations-</i> und <i>Bewegungskomponenten</i> .  Sie sind unabh√§ngig von der Essenz des Spielers.  Wenn andere Objekte mit <i>Bewegungs-</i> und <i>Transformationskomponenten</i> in unserem Spiel erscheinen, funktioniert auch die Bewegungslogik mit ihnen. <br><br>  F√ºgen Sie beispielsweise ein Erste-Hilfe-Set hinzu, das sich in einer geraden Linie entlang des Spawns bewegt und bei Auswahl die Gesundheit des Charakters wieder auff√ºllt.  Deklarieren Sie die Komponenten: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Component</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Health</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> CurrentHealth; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> MaxHealth; } [Component] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HealthPowerUp</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> NextChangeDirection; } [Component] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HealthPowerUpSpawnRequest</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> SpawnRequest; } [Component] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HealthPowerUpStats</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> HealthRestorePercent; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> MoveSpeed; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> SecondsToChangeDirection; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> PickupRadius; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> TimeToSpawn; }</code> </pre> <br>  Wir √§ndern die Komponente der Statistiken des Charakters, indem wir die maximale Anzahl von Leben dort hinzuf√ºgen: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Component</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PlayerStats</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> MoveSpeed; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> MaxHealth; }</code> </pre> <br>  Jetzt modifizieren wir das Charakter-Spawn-System so, dass der Charakter mit maximaler Gesundheit erscheint: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SpawnPlayerSystem</span></span> : <span class="hljs-title"><span class="hljs-title">ExecutableSystem</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gs</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> deleter = gs.Pools.Deferred.GetDeleter(gs.WorldState.SpawnAvatarRequest); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> playerStats = gs.RuleBook.PlayerStats[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> avatarRequest <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gs.WorldState.SpawnAvatarRequest) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (avatarRequest.Value.SpawnTime &lt;= gs.Time) { <span class="hljs-comment"><span class="hljs-comment">// create new entity with player ID var playerEntity = gs.WorldState.CreateEntity(avatarRequest.Value.PlayerId); // add components to determinate player behaviour playerEntity.AddPlayer(); playerEntity.AddTransform(Vector2.zero, 0); playerEntity.AddMovement(Vector2.zero, 0); playerEntity.AddHealth(playerStats.MaxHealth, playerStats.MaxHealth); // delete player spawn request deleter.Delete(avatarRequest.Key); } } } }</span></span></code> </pre> <br>  Dann erkl√§ren wir das Spawn-System unserer Erste-Hilfe-Sets: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SpawnHealthPowerUpSystem</span></span> : <span class="hljs-title"><span class="hljs-title">ExecutableSystem</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gs</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> deleter = gs.Pools.Deferred.GetDeleter(gs.WorldState.HealthPowerUpSpawnRequest); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> healthPowerUpStats = gs.RoolBook.healthPowerUpStats[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> spawnRequest <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gs.WorldState.HealthPowerUpSpawnRequest) { <span class="hljs-comment"><span class="hljs-comment">// create new entity var powerUpEntity = gs.WorldState.CreateEntity(); // add components to determine healthPowerUp behaviour powerUpEntity.AddHealthPowerUp((uint)(healthPowerUpStats.SecondsToChangeDirection * GameState.Hz)); playerEntity.AddTransform(Vector2.zero, 0); playerEntity.AddMovement(healthPowerUpStats.MoveSpeed, 0); // delete player spawn request deleter.Delete(spawnRequest.Key); } } }</span></span></code> </pre> <br>  Und ein System zum √Ñndern der Geschwindigkeit des Erste-Hilfe-Kits.  Zur Vereinfachung √§ndert das Erste-Hilfe-Set alle paar Sekunden die Richtung: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HealthPowerUpMovementSystem</span></span> : <span class="hljs-title"><span class="hljs-title">ExecutableSystem</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gs</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> healthPowerUpStats = gs.RoolBook.healthPowerUpStats[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pair <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gs.WorldState.HealthPowerUp) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> movement = gs.WorldState.Movement[pair.Key]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(pair.Value.NextChangeDirection &lt;= gs.Time) { pair.Value.NextChangeDirection = (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>) (healthPowerUpStats.SecondsToChangeDirection * GameState.Hz); movement.Velocity *= <span class="hljs-number"><span class="hljs-number">-1</span></span>; } } } }</code> </pre> <br>  Da wir bereits ein <i>MovementSystem</i> angek√ºndigt haben, um Objekte im Spiel zu bewegen, ben√∂tigen wir nur das <i>HealthPowerUpMovementSystem</i> , um den Geschwindigkeitsvektor alle N Sekunden zu √§ndern. <br><br>  Jetzt beenden wir die Auswahl des Erste-Hilfe-Kits und die Anh√§ufung von HP f√ºr den Charakter.  Wir ben√∂tigen eine weitere Hilfskomponente, um die Anzahl der Leben zu speichern, die der Charakter nach Auswahl des Erste-Hilfe-Sets erh√§lt. <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Component</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HealthToAdd</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Health; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Entity Target; }</code> </pre><br>  Und eine Komponente, um unsere Kraft zu entfernen: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Component</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DeleteHealthPowerUpRequest</span></span> { }</code> </pre> <br>  Wir schreiben ein System, das die Auswahl des Erste-Hilfe-Kits verarbeitet: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HealthPowerUpPickUpSystem</span></span> : <span class="hljs-title"><span class="hljs-title">ExecutableSystem</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gs</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> healthPowerUpStats = gs.RoolBook.healthPowerUpStats[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> powerUpPair <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gs.WorldState.HealthPowerUp) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> powerUpTransform = gs.WorldState.Transform[powerUpPair.Key]; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> playerPair <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gs.WorldState.Player) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> playerTransform = gs.WorldState.Transform[playerPair.Key]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> distance = Vector2.Distance(powerUpTransform.Position, playerTransform.Position) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(distance &lt; healthPowerUpStats.PickupRadius) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> healthToAdd = gs.WorldState.Health[playerPair.Key].MaxHealth * healthPowerUpStats.HealthRestorePercent; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> entity = gs.WorldState.CreateEntity(); entity.AddHealthToAdd(healthToAdd, gs.WorldState.Player[playerPair.Key]); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> powerUpEnity = gs.WorldState[powerUpPair.Key]; powerUpEnity.AddDeleteHealthPowerUpRequest(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } } }</code> </pre> <br>  Das System durchl√§uft alle aktiven Power-Ups und berechnet die Entfernung zum Spieler.  Befindet sich ein Spieler innerhalb des Auswahlradius, erstellt das System zwei Anforderungskomponenten: <br><br>  <i>HealthToAdd</i> - "Anfrage" zum Hinzuf√ºgen von Leben zu einem Charakter; <br>  <i>DeleteHealthPowerUpRequest</i> - "Anfrage" zum Entfernen des Erste-Hilfe-Kits. <br><br>  Warum nicht die richtige Anzahl von Leben im selben System hinzuf√ºgen?  Wir gehen davon aus, dass der Spieler HP nicht nur aus Erste-Hilfe-Sets, sondern auch aus anderen Quellen erh√§lt.  In diesem Fall ist es zweckm√§√üiger, die Auswahlsysteme f√ºr Erste-Hilfe-Sets und das Lebensabgrenzungssystem des Charakters zu trennen.  Dar√ºber hinaus steht dies im Einklang mit dem Prinzip der Einzelverantwortung. <br><br>  Wir implementieren das System, dem Charakter Leben zu verschaffen: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HealingSystem</span></span> : <span class="hljs-title"><span class="hljs-title">ExecutableSystem</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gs</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> deleter = gs.Pools.Deferred.GetDeleter(gs.WorldState.HealthToAdd); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> healtToAddPair <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gs.WorldState.HealthToAdd) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> healthToAdd = healtToAddPair.Value.Health; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> health = healtToAddPair.Value.Target.Health; health.CurrentHealth += healthToAdd; health.CurrentHealth = Mathf.Clamp(health.CurrentHealth, <span class="hljs-number"><span class="hljs-number">0</span></span>, health.MaxHealth); deleter.Delete(healtToAddPair.Key); } } }</code> </pre> <br>  Das System durchl√§uft alle Komponenten von <i>HealthToAdd</i> und berechnet die erforderliche Anzahl von Leben in der <i>Health-</i> Komponente der <i>Zielzielentit√§t</i> .  Diese Entit√§t wei√ü nichts √ºber die Quelle und das Ziel und ist ziemlich universell.  Dieses System kann nicht nur zur Berechnung des Lebens des Charakters verwendet werden, sondern auch f√ºr alle Objekte, bei denen Leben vorhanden sind und deren Regeneration. <br><br>  Um die Funktion mit Erste-Hilfe-Kits zu implementieren, muss noch das letzte System hinzugef√ºgt werden: das Erste-Hilfe-Kit-Entfernungssystem nach seiner Auswahl. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DeleteHealthPowerUpSystem</span></span> : <span class="hljs-title"><span class="hljs-title">ExecutableSystem</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gs</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> deleter = gs.Pools.Deferred.GetDeleter(gs.WorldState.DeleteHealthPowerUpReques); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> healthRequest <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gs.WorldState.DeleteHealthPowerUpReques) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> id = healthRequest.Key; gs.WorldState.DelHealthPowerUp(id); gs.WorldState.DelTransform(id); gs.WorldState.DelMovement(id); deleter.Delete(id); } } }</code> </pre> <br>  Das <i>HealthPowerUpPickUpSystem</i> erstellt eine Anforderung zum Entfernen des Erste-Hilfe-Kits.  Das <i>DeleteHealthPowerUpSystem-</i> System durchl√§uft alle derartigen Anforderungen und entfernt alle Komponenten, die zum Kern des Erste-Hilfe-Kits geh√∂ren. <br><br>  Fertig.  Alle Systeme aus unseren Beispielen sind implementiert.  Es gibt einen Punkt bei der Arbeit mit ECS: Alle Systeme werden nacheinander ausgef√ºhrt, und diese Reihenfolge ist wichtig. <br><br>  In unserem Beispiel ist die Reihenfolge der Systeme wie folgt: <br><br><pre> <code class="cs hljs">_systems = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;ExecutableSystem&gt; { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpawnPlayerSystem(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpawnHealthPowerUpSystem(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MovementControlSystem(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HealthPowerUpMovementSystem(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MovementSystem(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RotationSystem(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HealthPowerUpPickUpSystem(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HealingSystem(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DeleteHealthPowerUpSystem() };</code> </pre> <br>  Im allgemeinen Fall stehen die Systeme an erster Stelle, die f√ºr die Erstellung neuer Entit√§ten und Komponenten verantwortlich sind.  Dann die Behandlungssysteme und schlie√ülich die Entfernungs- und Reinigungssysteme. <br><br>  Bei richtiger Zersetzung weist ECS eine gro√üe Flexibilit√§t auf.  Ja, unsere Implementierung ist nicht perfekt, aber Sie k√∂nnen Funktionen in kurzer Zeit implementieren und haben auch eine gute Leistung auf modernen Mobilger√§ten.  Weitere Informationen zu ECS finden Sie hier: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Wie und warum haben wir unser ECS geschrieben?</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Wie wir ein selbst geschriebenes ECS in einem Browser auf einem Spieleserver debuggen</a> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Wie ECS √§ndern das C # Job System und SRP die Architektur</a> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Einheit ECS</a> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Einheit, ECS und alles in allem.</a>  Guter Artikel zu ECS in Beispielen. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de431660/">https://habr.com/ru/post/de431660/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de431648/index.html">NB-IoT: Wie funktioniert es? Teil 2</a></li>
<li><a href="../de431650/index.html">Lernlatenz: Warteschlangentheorie</a></li>
<li><a href="../de431652/index.html">Reservoir Sampling Algorithmus</a></li>
<li><a href="../de431654/index.html">Trends in den Programmiersprachen 2019</a></li>
<li><a href="../de431656/index.html">CraSSh: Brechen Sie alle modernen Browser mit CSS-Berechnungen</a></li>
<li><a href="../de431664/index.html">Antenna Phase Center (FCA) und seine Suche in Ansys HFSS</a></li>
<li><a href="../de431666/index.html">K√ºnstliche Intelligenz. Geistiges Eigentum. Gefahr</a></li>
<li><a href="../de431668/index.html">Was ist neu in GoLand 2018.3?</a></li>
<li><a href="../de431670/index.html">Zen und die Kunst der reinen Code-Unterst√ºtzung</a></li>
<li><a href="../de431674/index.html">Nanoleaf Canvas: Bald an allen W√§nden</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>