<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÜüèæ ‚òùüèª üë©‚Äçüîß werf - notre outil pour CI / CD √† Kubernetes (revue et reportage vid√©o) üåà üõåüèª üõ£Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le 27 mai, dans le hall principal de la conf√©rence DevOpsConf 2019, organis√©e dans le cadre du festival RIT ++ 2019 , dans le cadre de la section Livr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>werf - notre outil pour CI / CD √† Kubernetes (revue et reportage vid√©o)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/460351/">  Le 27 mai, dans le hall principal de la conf√©rence DevOpsConf 2019, organis√©e dans le cadre du festival <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RIT ++ 2019</a> , dans le cadre de la section Livraison continue, un rapport a √©t√© r√©dig√© ¬´werf est notre outil pour CI / CD √† Kubernetes¬ª.  Il parle des <b>probl√®mes et des d√©fis auxquels tout le monde est confront√© lors du d√©ploiement sur Kubernetes</b> , ainsi que des nuances qui peuvent ne pas √™tre imm√©diatement perceptibles.  En analysant les solutions possibles, nous montrons comment cela est mis en ≈ìuvre dans l'outil <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">werf</a> Open Source. <br><br>  Depuis le salon, notre utilitaire (anciennement connu sous le nom de dapp) a d√©pass√© la limite historique de <b>1000 √©toiles sur GitHub</b> - nous esp√©rons que la communaut√© croissante de ses utilisateurs simplifiera la vie de nombreux ing√©nieurs DevOps. <br><br><img src="https://habrastorage.org/webt/lh/k9/x1/lhk9x1wf3gzo6bk1lsjosnvjg1g.jpeg"><br><br>  Nous pr√©sentons donc la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><b>vid√©o avec le rapport</b></a> (~ 47 minutes, beaucoup plus informatif que l'article) et son extrait principal sous forme de texte.  C'est parti! <a name="habracut"></a><br><br><h2>  Livraison de code dans Kubernetes </h2><br>  La discussion ne portera plus sur werf, mais sur CI / CD dans Kubernetes, ce qui implique que notre logiciel est emball√© dans des conteneurs Docker <i>(j'en ai parl√© dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le rapport 2016</a> )</i> , et des K8 seront utilis√©s pour le lancer en production <i>(√† propos de ce - en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">2017</a> )</i> . <br><br>  √Ä quoi ressemble la livraison de Kubernetes? <br><br><ul><li>  Il existe un r√©f√©rentiel Git avec du code et des instructions pour le construire.  L'application est compil√©e dans une image Docker et publi√©e dans le registre Docker. </li><li>  Dans le m√™me r√©f√©rentiel, il y a des instructions sur la fa√ßon de d√©ployer et d'ex√©cuter l'application.  Au stade du d√©ploiement, ces instructions sont envoy√©es √† Kubernetes, qui re√ßoit l'image souhait√©e du registre et la d√©marre. </li><li>  De plus, il y a g√©n√©ralement des tests.  Certains d'entre eux peuvent √™tre effectu√©s lors de la publication d'une image.  Vous pouvez √©galement (par les m√™mes instructions) d√©ployer une copie de l'application (dans un espace de noms K8 s√©par√© ou dans un cluster s√©par√©) et y ex√©cuter des tests. </li><li>  Enfin, nous avons besoin d'un syst√®me CI qui re√ßoit les √©v√©nements de Git (ou clics sur les boutons) et appelle toutes les √©tapes indiqu√©es: construire, publier, d√©ployer, tester. </li></ul><br><img src="https://habrastorage.org/webt/vd/jh/ks/vdjhksq3874swybast6v7oerqe4.gif"><br><br>  Il y a quelques notes importantes ici: <br><br><ol><li>  Comme nous avons une infrastructure immuable, l'image de l'application utilis√©e √† toutes les √©tapes (mise en sc√®ne, production, etc.) <b>doit √™tre une</b> .  <i>J'en ai parl√© davantage et avec des exemples <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> .</i> </li><li>  √âtant donn√© que nous <i>suivons</i> l'infrastructure en tant <i>qu'approche de</i> code <i>(IaC)</i> , le code de l'application et les instructions pour sa cr√©ation et son ex√©cution doivent se trouver <b>dans un r√©f√©rentiel</b> .  <i>Pour en savoir plus √† ce sujet, voir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le m√™me rapport</a> .</i> </li><li>  Nous voyons g√©n√©ralement la cha√Æne de livraison <i>(livraison)</i> comme ceci: l'application a √©t√© assembl√©e, test√©e, publi√©e <i>(√©tape de publication)</i> et c'est tout - la livraison a eu lieu.  Mais en r√©alit√©, l'utilisateur re√ßoit ce que vous avez d√©ploy√©, <b>non pas</b> lorsque vous l'avez livr√© √† la production, mais quand il a pu s'y rendre et que cette production a fonctionn√©.  Par cons√©quent, je pense que la cha√Æne de livraison <b>ne</b> se termine <b>qu'au stade op√©rationnel</b> <i>(run)</i> , et plus pr√©cis√©ment, m√™me au moment o√π le code a √©t√© retir√© de la production (en le rempla√ßant par un nouveau). </li></ol><br>  Revenons au sch√©ma de livraison de Kubernetes d√©crit ci-dessus: il a √©t√© invent√© non seulement par nous, mais litt√©ralement par tous ceux qui ont trait√© ce probl√®me.  Essentiellement, ce mod√®le est maintenant appel√© GitOps <i>(vous</i> trouverez <i>plus d'informations sur le terme et les id√©es qui le sous-tendent <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> )</i> .  Regardons les √©tapes du sch√©ma. <br><br><h2>  √âtape de construction </h2><br>  Il semblerait qu'en 2019, vous pouvez parler de l'assemblage d'images Docker, quand tout le monde sait comment √©crire des Dockerfiles et ex√©cuter la <code>docker build</code> de Docker? .. Voici les nuances auxquelles je voudrais faire attention: <br><br><ol><li>  <b>Le poids de l'image est</b> important, utilisez donc <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plusieurs √©tapes</a> pour ne laisser que l'application vraiment n√©cessaire √† l'image. </li><li>  <b>Le nombre de couches</b> doit √™tre minimis√© en combinant les cha√Ænes de commandes <code>RUN</code> dans le sens. </li><li>  Cependant, cela ajoute aux probl√®mes de <b>d√©bogage</b> , car lorsque l'assembly se bloque, vous devez trouver la commande n√©cessaire dans la cha√Æne √† l'origine du probl√®me. </li><li>  <b>La vitesse de construction est</b> importante car nous voulons d√©ployer rapidement les modifications et regarder le r√©sultat.  Par exemple, je ne veux pas r√©assembler les d√©pendances dans les biblioth√®ques de langues avec chaque build de l'application. </li><li>  Souvent, √† partir d'un r√©f√©rentiel Git, de <b>nombreuses images</b> sont requises, qui peuvent √™tre r√©solues par un ensemble de Dockerfiles (ou des √©tapes nomm√©es dans un seul fichier) et un script Bash avec leur assemblage s√©quentiel. </li></ol><br>  Ce n'√©tait que la pointe de l'iceberg √† laquelle tout le monde fait face.  Mais il y a d'autres probl√®mes, et en particulier: <br><br><ol><li>  Souvent, au stade de l'assemblage, nous devons <b>monter</b> quelque chose (par exemple, mettre en cache le r√©sultat d'une commande comme apt dans un r√©pertoire tiers). </li><li>  Nous voulons <b>Ansible</b> au lieu d'√©crire sur le shell. </li><li>  Nous voulons <b>construire sans Docker</b> (pourquoi avons-nous besoin d'une machine virtuelle suppl√©mentaire dans laquelle vous devez tout configurer pour cela alors qu'il existe d√©j√† un cluster Kubernetes dans lequel vous pouvez ex√©cuter des conteneurs?). </li><li>  <b>Assemblage parall√®le</b> , qui peut √™tre compris de diff√©rentes mani√®res: diff√©rentes commandes du Dockerfile (si plusieurs √©tapes sont utilis√©es), plusieurs validations d'un r√©f√©rentiel, plusieurs Dockerfiles. </li><li>  <b>Assemblage distribu√©</b> : nous voulons collecter quelque chose dans des pods qui sont ¬´√©ph√©m√®res¬ª, car  leur cache dispara√Æt, ce qui signifie qu'il doit √™tre stock√© quelque part s√©par√©ment. </li><li>  Enfin, j'ai appel√© <b>le</b> summum de l'auto- <b>magie</b> des d√©sirs: il serait id√©al d'aller dans le r√©f√©rentiel, de taper une √©quipe et d'obtenir une image pr√™te √† l'emploi, assembl√©e avec une compr√©hension de comment et quoi faire correctement.  Cependant, je ne suis personnellement pas s√ªr que toutes les nuances puissent √™tre pr√©vues de cette mani√®re. </li></ol><br>  Et voici les projets: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">moby / buildkit</a> - un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">constructeur</a> de la soci√©t√© Docker Inc (d√©j√† int√©gr√© dans les versions actuelles de Docker), qui essaie de r√©soudre tous ces probl√®mes; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">kaniko</a> - un collectionneur de Google, qui vous permet de construire sans Docker; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Buildpacks.io</a> - une tentative de la CNCF de faire de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">l'</a> automagie et, en particulier, une solution int√©ressante avec rebase pour les couches; </li><li>  et un tas d'autres utilitaires comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">buildah</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">genuinetools / img</a> ... </li></ul><br>  ... et voyez combien d'√©toiles ils ont sur GitHub.  C'est-√†-dire, d'une part, que la <code>docker build</code> est et peut faire quelque chose, mais en r√©alit√©, le <b>probl√®me n'a pas √©t√© compl√®tement r√©solu</b> - cela est d√©montr√© par le d√©veloppement parall√®le de constructeurs alternatifs, chacun r√©solvant certains des probl√®mes. <br><br><h2>  Construire en werf </h2><br>  Nous sommes donc arriv√©s √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">werf</a> <i>(anciennement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">connu</a> sous <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le</a> nom de dapp)</i> - l'utilitaire Open Source de Flant, ce que nous faisons depuis de nombreuses ann√©es.  Tout a commenc√© il y a environ 5 ans avec des scripts Bash qui optimisent l'assemblage des Dockerfiles, et les 3 derni√®res ann√©es, le d√©veloppement complet s'est poursuivi dans le cadre d'un projet avec son propre r√©f√©rentiel Git <i>(d'abord en Ruby, puis <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©√©crit</a> en Go, et en m√™me temps renomm√©)</i> .  Quels probl√®mes de build sont r√©solus dans werf? <br><br><img src="https://habrastorage.org/webt/--/1-/ca/--1-cakzswwfhrcrgnees6cvf-a.png"><br><br>  Les probl√®mes ombr√©s de bleu ont d√©j√† √©t√© mis en ≈ìuvre, l'assemblage parall√®le a √©t√© fait au sein du m√™me h√¥te, et nous pr√©voyons de terminer les questions jaunes d'ici la fin de l'√©t√©. <br><br><h2>  Stade de publication dans le registre (publier) </h2><br>  Nous avons tap√© <code>docker push</code> ... - qu'est-ce qui peut √™tre difficile √† t√©l√©charger une image dans le registre?  Et puis la question se pose: "Quelle balise pour mettre l'image?"  Cela vient du fait que nous avons <b>Gitflow</b> (ou une autre strat√©gie Git) et Kubernetes, et l'industrie est d√©termin√©e √† s'assurer que ce qui se passe √† Kubernetes suit ce qui se fait √† Git.  Git est notre seule source de v√©rit√©. <br><br>  Qu'est-ce qui est si compliqu√©?  <b>Assurer la reproductibilit√©</b> : d'une validation dans Git, qui est intrins√®quement <i>immuable</i> , √† une image Docker qui doit rester la m√™me. <br><br>  Il est √©galement important pour nous de <b>d√©terminer l'origine</b> , car nous voulons comprendre √† partir de quel commit l'application lanc√©e dans Kubernetes a √©t√© construite (nous pouvons alors faire des diff√©rences et des choses similaires). <br><br><h3>  Strat√©gies de marquage </h3><br>  Le premier est une simple <b>balise git</b> .  Nous avons un registre avec une image √©tiquet√©e <code>1.0</code> .  Kubernetes a une sc√®ne et une production o√π cette image est pomp√©e.  Dans Git, nous faisons des commits et √† un moment donn√© nous mettons le tag <code>2.0</code> .  Nous le collectons selon les instructions du r√©f√©rentiel et le mettons dans le registre avec la balise <code>2.0</code> .  Nous le d√©ployons sur sc√®ne et, si tout va bien, alors en production. <br><br><img src="https://habrastorage.org/webt/4f/ub/u4/4fubu4r-0obh9gkzs4_kftnlqxs.gif"><br><br>  Le probl√®me avec cette approche est que nous avons d'abord d√©fini la balise, puis seulement test√© et d√©ploy√©.  Pourquoi?  Tout d'abord, c'est tout simplement illogique: nous distribuons une version de logiciel que nous n'avons m√™me pas test√©e (nous ne pouvons pas faire autrement, car pour v√©rifier, vous devez mettre une balise).  Deuxi√®mement, cette fa√ßon n'est pas compatible avec Gitflow. <br><br>  La deuxi√®me option est <b>git commit + tag</b> .  Il y a une balise <code>1.0</code> dans la branche principale;  pour lui dans le registre - une image d√©ploy√©e en production.  De plus, le cluster Kubernetes poss√®de des boucles de pr√©visualisation et de transfert.  Ensuite, nous suivons Gitflow: dans la branche principale pour le d√©veloppement, nous <code>develop</code> nouvelles fonctionnalit√©s, √† la suite desquelles il y a un commit avec l'identifiant <code>#c1</code> .  Nous le collectons et le publions dans le registre en utilisant cet identifiant ( <code>#c1</code> ).  Nous d√©ployons l'aper√ßu avec le m√™me identifiant.  Nous faisons de m√™me avec les commits <code>#c2</code> et <code>#c3</code> . <br><br>  Lorsque nous avons r√©alis√© qu'il y avait suffisamment de fonctionnalit√©s, nous commen√ßons √† tout stabiliser.  Dans Git, cr√©ez la branche <code>release_1.1</code> (bas√©e sur <code>#c3</code> de <code>develop</code> ).  La collecte de cette version n'est pas requise, car  Cela a √©t√© fait √† l'√©tape pr√©c√©dente.  Par cons√©quent, nous pouvons simplement le d√©ployer vers la mise en sc√®ne.  Nous corrigeons les bogues dans <code>#c4</code> et <code>#c4</code> m√™me mani√®re sur la mise en sc√®ne.  Dans le m√™me temps, le d√©veloppement est en cours √† <code>develop</code> , o√π des modifications par rapport √† la <code>release_1.1</code> sont effectu√©es p√©riodiquement.  √Ä un moment donn√©, nous obtenons un commit valid√© et pomp√© pour la mise en sc√®ne, ce dont nous sommes satisfaits ( <code>#c25</code> ). <br><br>  Ensuite, nous faisons une fusion (avec avance rapide) de la branche de publication ( <code>release_1.1</code> ) dans master.  Nous avons mis une balise avec la nouvelle version ( <code>1.1</code> ) sur ce commit.  Mais cette image est d√©j√† assembl√©e dans le registre, donc afin de ne pas la collecter √† nouveau, nous ajoutons juste une deuxi√®me balise √† l'image existante (maintenant elle a les balises <code>#c25</code> et <code>1.1</code> dans le registre).  Apr√®s cela, nous le d√©ployons en production. <br><br>  Il y a un inconv√©nient qu'une image ( <code>#c25</code> ) est <code>#c25</code> sur la mise en sc√®ne, et une autre ( <code>1.1</code> ) est <code>#c25</code> sur la production, mais nous savons que ¬´physiquement¬ª, c'est la m√™me image du registre. <br><br><img src="https://habrastorage.org/webt/mb/pq/iu/mbpqiumzomvrouhp8llx5aishza.gif"><br><br>  Le vrai inconv√©nient est qu'il n'y a pas de support pour merge commit'ov, vous devez faire une avance rapide. <br><br>  Vous pouvez aller plus loin et faire l'affaire ... Prenons un exemple de Dockerfile simple: <br><br><pre> <code class="plaintext hljs">FROM ruby:2.3 as assets RUN mkdir -p /app WORKDIR /app COPY . ./ RUN gem install bundler &amp;&amp; bundle install RUN bundle exec rake assets:precompile CMD bundle exec puma -C config/puma.rb FROM nginx:alpine COPY --from=assets /app/public /usr/share/nginx/www/public</code> </pre> <br>  Nous en construisons un fichier selon ce principe, que nous prenons: <br><br><ul><li>  SHA256 √† partir des identifiants des images utilis√©es ( <code>ruby:2.3</code> et <code>nginx:alpine</code> ), qui sont des sommes de contr√¥le de leur contenu; </li><li>  toutes les √©quipes ( <code>RUN</code> , <code>CMD</code> , etc.); </li><li>  SHA256 √† partir de fichiers ajout√©s. </li></ul><br>  ... et prenez la somme de contr√¥le (√† nouveau SHA256) d'un tel fichier.  Il s'agit de la <b>signature de</b> tout ce qui d√©finit le contenu d'une image Docker. <br><br><img src="https://habrastorage.org/webt/zp/w2/ju/zpw2jup54xa66mit1bt9u7amwlk.gif"><br><br>  Revenons au sch√©ma et <b>au lieu des validations, nous utiliserons de telles signatures</b> , c'est-√†-dire  √©tiqueter les images avec des signatures. <br><br><img src="https://habrastorage.org/webt/pr/d3/wf/prd3wfn6ctkod9ddqqmgtqnr1ew.gif"><br><br>  Maintenant, lorsque vous avez besoin, par exemple, de fusionner des modifications de la version au master, nous pouvons faire un vrai commit de fusion: il aura un identifiant diff√©rent, mais la m√™me signature.  Avec le m√™me identifiant, nous d√©ploierons √©galement l'image en production. <br><br>  L'inconv√©nient est qu'il ne sera d√©sormais plus possible de d√©terminer quel type d'engagement a √©t√© inject√© dans la production - les sommes de contr√¥le ne fonctionnent que dans un sens.  Ce probl√®me est r√©solu par une couche suppl√©mentaire avec des m√©tadonn√©es - je vous en dirai plus plus tard. <br><br><h3>  Marquage dans werf </h3><br>  Dans werf, nous sommes all√©s encore plus loin et nous nous pr√©parons √† faire un assemblage distribu√© avec un cache qui n'est pas stock√© sur la m√™me machine ... Donc, nous avons deux types d'images Docker, nous les appelons <i>stage</i> et <i>image</i> . <br><br>  Le r√©f√©rentiel werf Git stocke des instructions de build sp√©cifiques qui d√©crivent les diff√©rentes √©tapes de la build ( <i>beforeInstall</i> , <i>install</i> , <i>beforeSetup</i> , <i>setup</i> ).  Nous collectons l'image de la premi√®re √©tape avec une signature d√©finie comme la somme de contr√¥le des premi√®res √©tapes.  Ensuite, nous ajoutons le code source, pour la nouvelle image de sc√®ne, nous consid√©rons sa somme de contr√¥le ... Ces op√©rations sont r√©p√©t√©es pour toutes les √©tapes, √† la suite de quoi nous obtenons un ensemble d'images de sc√®ne.  Ensuite, nous faisons l'image-image finale contenant √©galement des m√©tadonn√©es sur son origine.  Et nous marquons cette image de diff√©rentes mani√®res (d√©tails plus tard). <br><br><img src="https://habrastorage.org/webt/4a/uw/am/4auwamdra7bm0xtvht35kpbstye.gif"><br><br>  Apr√®s cela, un nouveau commit appara√Æt, dans lequel seul le code d'application est modifi√©.  Que va-t-il se passer?  Un patch sera cr√©√© pour les changements de code, une nouvelle image de stage sera pr√©par√©e.  Sa signature sera d√©finie comme la somme de contr√¥le de l'ancienne image de la sc√®ne et du nouveau patch.  A partir de cette image, une nouvelle image-image finale sera form√©e.  Un comportement similaire se produira avec des changements √† d'autres √©tapes. <br><br>  Ainsi, les images de sc√®ne sont un cache qui peut √™tre distribu√© distribu√©, et les images d'image d√©j√† cr√©√©es √† partir de celui-ci sont charg√©es dans le Docker Registry. <br><br><img src="https://habrastorage.org/webt/sc/8j/me/sc8jme4f1jfqbrbwt1anf2-rja8.gif"><br><br><h3>  Nettoyage du registre </h3><br>  Il ne s'agit pas de supprimer des couches qui restent suspendues apr√®s la suppression de balises - c'est une fonctionnalit√© standard du Docker Registry lui-m√™me.  Il s'agit d'une situation o√π de nombreuses balises Docker s'accumulent et nous comprenons que nous n'en avons plus besoin et qu'elles prennent de la place (et / ou nous la payons). <br><br>  Quelles sont les strat√©gies de nettoyage? <br><br><ol><li>  Vous ne pouvez <b>rien nettoyer</b> .  Parfois, il est vraiment plus facile de payer un peu pour l'espace suppl√©mentaire que de d√©m√™ler une √©norme boule de balises.  Mais cela ne fonctionne que jusqu'√† un certain point. </li><li>  <b>R√©initialisation compl√®te</b> .  Si vous supprimez toutes les images et reconstruisez uniquement les images pertinentes dans le syst√®me CI, un probl√®me peut survenir.  Si le conteneur red√©marre en production, une nouvelle image sera charg√©e pour celui-ci - celle qui n'a encore √©t√© test√©e par personne.  Cela tue l'id√©e d'une infrastructure immuable. </li><li>  <b>Bleu-vert</b> .  Un registre a commenc√© √† d√©border - chargeant des images dans un autre.  Le m√™me probl√®me que dans la m√©thode pr√©c√©dente: √† quel moment pouvez-vous nettoyer le registre qui a commenc√© √† d√©border? </li><li>  <b>Par le temps</b> .  Supprimer toutes les images de plus d'un mois?  Mais il y a s√ªrement un service qui n'a pas √©t√© mis √† jour depuis un mois ... </li><li>  D√©terminez <b>manuellement</b> ce qui peut d√©j√† √™tre supprim√©. </li></ol><br>  Il existe deux options vraiment viables: ne pas nettoyer ou une combinaison de bleu-vert + manuellement.  Dans ce dernier cas, nous parlons de ce qui suit: lorsque vous comprenez qu'il est temps de nettoyer le registre, cr√©ez-en un nouveau et ajoutez-y toutes les nouvelles images pendant, par exemple, un mois.  Un mois plus tard, voyez quels pods dans Kubernetes utilisent toujours l'ancien registre et transf√©rez-les √©galement dans le nouveau registre. <br><br>  <b>O√π</b> sommes-nous <b>all√©s</b> √† <b>werf</b> ?  Nous collectons: <br><br><ol><li>  Git head: toutes les balises, toutes les branches, - en supposant que tout ce qui est test√© dans Git, nous en avons besoin dans les images (et sinon, nous devons les supprimer dans le Git lui-m√™me); </li><li>  tous les pods qui sont maintenant t√©l√©charg√©s dans Kubernetes; </li><li>  anciens ReplicaSets (quelque chose qui a √©t√© r√©cemment pomp√©), ainsi que nous pr√©voyons de num√©riser les versions de Helm et de s√©lectionner les derni√®res images l√†-bas. </li></ol><br>  ... et nous faisons une liste blanche √† partir de cet ensemble - une liste d'images que nous ne supprimerons pas.  Nous nettoyons tout le reste, apr√®s quoi nous trouvons les images de sc√®ne orphelines et les supprimons aussi. <br><br><h2>  √âtape de d√©ploiement (d√©ploiement) </h2><br><h3>  D√©claration forte </h3><br>  Le premier point sur lequel je voudrais attirer l'attention dans le d√©ploiement est de d√©ployer la configuration de ressource mise √† jour, d√©clar√©e de mani√®re d√©clarative.  Le document YAML d'origine d√©crivant les ressources Kubernetes est toujours tr√®s diff√©rent du r√©sultat qui fonctionne r√©ellement dans le cluster.  Parce que Kubernetes ajoute √† la configuration: <br><br><ol><li>  identifiants </li><li>  informations de service; </li><li>  de nombreuses valeurs par d√©faut; </li><li>  section avec l'√©tat actuel; </li><li>  les modifications apport√©es dans le cadre du webhook d'admission; </li><li>  le r√©sultat du travail de diff√©rents contr√¥leurs (et ordonnanceur). </li></ol><br>  Par cons√©quent, lorsqu'une nouvelle configuration d'une ressource ( <i>nouvelle</i> ) appara√Æt, nous ne pouvons pas simplement prendre et √©craser avec elle la configuration actuelle ¬´en direct¬ª (en <i>direct</i> ).  Pour ce faire, nous devons comparer <i>nouveau</i> avec la derni√®re configuration appliqu√©e ( <i>derni√®re appliqu√©e</i> ) et lancer le patch r√©sultant en <i>direct</i> . <br><br>  Cette approche est appel√©e <b>fusion bidirectionnelle</b> .  Il est utilis√©, par exemple, dans Helm. <br><br>  Il existe √©galement une <b>fusion √† 3 voies</b> , qui diff√®re en ce que: <br><br><ul><li>  en comparant la <i>derni√®re application</i> et la <i>nouvelle</i> , nous examinons ce qui a √©t√© supprim√©; </li><li>  en comparant le <i>nouveau</i> et le <i>vivant</i> , nous voyons ce qui a √©t√© ajout√© ou chang√©; </li><li>  appliquer le patch r√©sum√© pour <i>vivre</i> . </li></ul><br>  Nous d√©ployons plus de 1000 applications avec Helm, nous vivons donc r√©ellement avec une fusion bidirectionnelle.  Cependant, il a un certain nombre de probl√®mes que nous avons r√©solus avec nos correctifs qui aident Helm √† fonctionner normalement. <br><br><h3>  Statut de d√©ploiement r√©el </h3><br>  Apr√®s le prochain √©v√©nement, notre syst√®me CI a g√©n√©r√© une nouvelle configuration pour Kubernetes, il l'envoie √† <i>appliquer</i> au cluster en utilisant Helm ou <code>kubectl apply</code> .  Ensuite, la fusion N-way d√©j√† d√©crite a lieu, √† laquelle l'API Kubernetes approuve le syst√®me CI, et ce dernier r√©pond √† son utilisateur. <br><br><img src="https://habrastorage.org/webt/sk/vh/-u/skvh-uifcwg6_d5mgxhehh39q9i.png"><br><br>  Cependant, il y a un √©norme probl√®me: apr√®s tout, une <b>application r√©ussie ne signifie pas un d√©ploiement r√©ussi</b> .  Si Kubernetes comprend les changements √† appliquer, l'applique - nous ne savons toujours pas quel sera le r√©sultat.  Par exemple, la mise √† jour et le red√©marrage des pods dans le frontend peuvent r√©ussir, mais pas dans le backend, et nous obtiendrons diff√©rentes versions des images d'application en cours d'ex√©cution. <br><br>  Pour tout faire correctement, un lien suppl√©mentaire appara√Æt dans ce sch√©ma - un tracker sp√©cial qui recevra les informations d'√©tat de l'API Kubernetes et les transmettra pour une analyse plus approfondie de l'√©tat r√©el des choses.  Nous avons cr√©√© une biblioth√®que Open Source sur Go - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><b>kubedog</b></a> <i>(voir son annonce <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> )</i> - qui r√©sout ce probl√®me et est int√©gr√©e √† werf. <br><br>  Le comportement de ce tracker au niveau werf est configur√© √† l'aide d'annotations plac√©es sur Deployments ou StatefulSets.  L'annotation principale, <code>fail-mode</code> , comprend les significations suivantes: <br><br><ul><li>  <code>IgnoreAndContinueDeployProcess</code> - ignore les probl√®mes de <code>IgnoreAndContinueDeployProcess</code> de ce composant et continue le d√©ploiement; </li><li>  <code>FailWholeDeployProcessImmediately</code> - une erreur dans ce composant arr√™te le processus de d√©ploiement; </li><li>  <code>HopeUntilEndOfDeployProcess</code> - nous esp√©rons que ce composant fonctionnera d'ici la fin du d√©ploiement. </li></ul><br>  Par exemple, une combinaison de ressources et de valeurs d'annotation en <code>fail-mode</code> : <br><br><img src="https://habrastorage.org/webt/ja/qf/ot/jaqfotxaxoxwznieu2lvnnyhih0.png"><br><br>  Lors du premier d√©ploiement, la base de donn√©es (MongoDB) n'est peut-√™tre pas encore pr√™te - Les d√©ploiements se bloqueront.  Mais vous pouvez attendre le moment o√π il d√©marre et le d√©ploiement se poursuivra. <br><br>  Il y a deux annotations suppl√©mentaires pour kubedog dans werf: <br><br><ul><li>  <code>failures-allowed-per-replica</code> - le nombre de suppressions autoris√©es par r√©plique; </li><li>  <code>show-logs-until</code> - ajuste le moment jusqu'√† lequel werf affiche (dans stdout) les journaux de tous les pods en cours de d√©ploiement.  Par d√©faut, il s'agit de <code>PodIsReady</code> (pour ignorer les messages dont nous avons √† peine besoin lorsque le trafic commence √† arriver sur le pod), cependant, les valeurs <code>ControllerIsReady</code> et <code>EndOfDeploy</code> √©galement <code>EndOfDeploy</code> . </li></ul><br><h3>  Que voulons-nous d'autre du d√©ploiement? </h3><br>  En plus des deux points d√©j√† d√©crits, nous souhaitons: <br><br><ul><li>  pour voir les <b>journaux</b> - et seulement n√©cessaire, mais pas tout; </li><li>  suivre les <b>progr√®s</b> , car si un travail se "suspend" en silence pendant plusieurs minutes, il est important de comprendre ce qui s'y passe; </li><li>  avoir une <b>restauration automatique</b> en cas de probl√®me (et il est donc essentiel de conna√Ætre l'√©tat r√©el du d√©ploiement).  Le d√©ploiement doit √™tre atomique: soit il se termine, soit tout revient √† son √©tat pr√©c√©dent. </li></ul><br><h2>  R√©sum√© </h2><br>  En tant qu'entreprise, pour nous, pour impl√©menter toutes les nuances d√©crites √† diff√©rents stades de livraison (construire, publier, d√©ployer), le syst√®me CI et l'utilitaire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">werf suffisent</a> . <br><br>  Au lieu d'une conclusion: <br><br><img src="https://habrastorage.org/webt/ja/1y/tc/ja1ytcqobpkbw5rtf78ykb4clnm.png"><br><br>  Avec l'aide de werf, nous avons bien progress√© dans la r√©solution d'un grand nombre de probl√®mes des ing√©nieurs DevOps et serons heureux si la communaut√© plus large essaie au moins cet utilitaire dans la pratique.  Obtenir un bon r√©sultat ensemble sera plus facile. <br><br><h2>  Vid√©os et diapositives </h2><br>  Vid√©o de la performance (~ 47 minutes): <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/cK3ackGUTLw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Pr√©sentation du rapport: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/https://translate" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><h2>  PS </h2><br>  Autres rapports Kubernetes sur notre blog: <br><br><ul><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Auto-scaling et gestion des ressources √† Kubernetes</a> ¬ª <i>(Dmitry Stolyarov; 27 avril 2019 lors de la ¬´Strike¬ª)</i> ; </li><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√âtendre et compl√©ter Kubernetes</a> ¬ª <i>(Andrey Polov; 8 avril 2019 √† Saint HighLoad ++)</i> ; </li><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Bases de donn√©es et Kubernetes</a> ¬ª <i>(Dmitry Stolyarov; 8 novembre 2018 sur HighLoad ++)</i> ; </li><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Monitoring and Kubernetes</a> ¬ª <i>(Dmitry Stolyarov; 28 mai 2018 √† RootConf)</i> ; </li><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Meilleures pratiques CI / CD avec Kubernetes et GitLab</a> ¬ª <i>(Dmitry Stolyarov; 7 novembre 2017 √† HighLoad ++)</i> ; </li><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Notre exp√©rience avec Kubernetes dans les petits projets</a> ¬ª <i>(Dmitry Stolyarov; 6 juin 2017 chez RootConf)</i> . </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr460351/">https://habr.com/ru/post/fr460351/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr460341/index.html">Poursuite de l'ASO: tendances, notes et commentaires</a></li>
<li><a href="../fr460343/index.html">L'histoire de la fa√ßon dont le d√©veloppement de jeux est devenu une partie de ma vie</a></li>
<li><a href="../fr460345/index.html">Installer et configurer Sonata Admin sur Symfony 4</a></li>
<li><a href="../fr460347/index.html">Gestion des appareils mobiles et plus encore avec la solution UEM de Sophos</a></li>
<li><a href="../fr460349/index.html">Cartes d'acc√©l√©ration Check Point Falcon - Acc√©l√©ration du traitement du trafic</a></li>
<li><a href="../fr460353/index.html">R√©seau de neurones dans le verre. Ne n√©cessite pas d'alimentation, reconna√Æt les chiffres</a></li>
<li><a href="../fr460355/index.html">Sauver la noyade est notre m√©tier: comment g√©rer la d√©motivation des √©quipes</a></li>
<li><a href="../fr460359/index.html">Cours Young Game Designer 2: √©quilibrer la progression et la dynamique sans math√©matiques</a></li>
<li><a href="../fr460361/index.html">Grande FAQ sur la cybers√©curit√© des syst√®mes d'information m√©dicale</a></li>
<li><a href="../fr460363/index.html">7 facteurs manquants dans l'approche 12 Factor App</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>