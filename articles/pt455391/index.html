<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üå≤ üçû ü§úüèº Parte 1: RISC-V / RocketChip em um habitat n√£o natural üíÖüèª üë®üèº‚Äçüîß üë©üèΩ‚Äç‚úàÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recentemente, foi publicado um artigo na Habr sobre como experimentar a arquitetura RISC-V sem o custo de hardware. Mas e se voc√™ fizer isso no quadro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Parte 1: RISC-V / RocketChip em um habitat n√£o natural</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/455391/"><img src="https://habrastorage.org/webt/it/on/yz/itonyz90xq9l_bvyih5h20xhuds.png" alt="Configurando o RocketChip" align="left"><br><p>  Recentemente, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">foi</a> publicado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um artigo</a> na Habr sobre como experimentar a arquitetura RISC-V sem o custo de hardware.  Mas e se voc√™ fizer isso no quadro de depura√ß√£o?  Lembre-se de memes sobre o gerador de jogos: cerca de 20 marcas de sele√ß√£o no estilo "Os gr√°ficos n√£o s√£o piores que a crise", "Voc√™ pode roubar corovans" e o bot√£o "Gerar".  O gerador RocketChip SoC √© organizado aproximadamente da mesma maneira, apenas n√£o h√° uma janela com marcas de sele√ß√£o, mas um c√≥digo Scala e um pouco de montador e arquivos Make.  Neste artigo, mostrarei como √© f√°cil portar esse RocketChip do Xilinx nativo para Altera / Intel. </p><a name="habracut"></a><br><p> <strong>AVISO LEGAL: o</strong> autor n√£o √© respons√°vel pela placa ‚Äúqueimada‚Äù - observe cuidadosamente como voc√™ configura os pinos, o que voc√™ fisicamente conecta etc.  Bem, observe tamb√©m as precau√ß√µes de seguran√ßa.  Voc√™ n√£o deve pensar que, como tudo est√° conectado via USB, √© definitivamente seguro para uma pessoa: como eu entendi nas minhas experi√™ncias anteriores, mesmo se voc√™ trabalha com uma placa USB, ainda n√£o precisa tocar a bateria de aquecimento com o p√©, porque a diferen√ßa de potencial ... Ah, sim , Eu n√£o sou quase um plisovode profissional ou engenheiro eletr√¥nico - sou apenas um programador Scala. </p><br><p> At√© onde eu entendi, a plataforma inicial para depura√ß√£o do RocketChip era o FPGA da Xilinx.  A julgar pelo reposit√≥rio, que estamos clonando em breve, ele tamb√©m foi portado para o Microsemi.  Em algum lugar, ouvi falar sobre o uso de Altera, mas n√£o vi a fonte.  Como se viu, esse n√£o √© um grande problema: desde o momento em que recebemos a placa e come√ßamos a estudar o reposit√≥rio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SiFive Freedom</a> at√© um ‚Äúsem mem√≥ria‚Äù (isto √©, tendo apenas registradores de processador, BootROM e registradores mapeados na mem√≥ria) ‚Äúmicrocontrolador‚Äù de 32 bits (embora isso j√° seja o que algo que o <em>nanocontrolador produz</em> ...) 3 dias de folga e 4 noites de semana se passaram, e levaria menos ainda se viesse imediatamente a mim definir definir <code>SYNTHESIS</code> globalmente. </p><br><h1 id="materialy">  Materiais </h1><br><p>  Para iniciantes - uma lista de <em>materiais</em> no sentido amplo da palavra.  Precisamos do seguinte software: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">RocketChip</a> - cont√©m o pr√≥prio processador e o ambiente de montagem (incluindo, descreve v√°rios sub-reposit√≥rios).  Capaz de criar o RocketChip com o processador em ordem do n√∫cleo da Rocket. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SiFive Freedom</a> - obrigat√≥rio para v√°rias placas de depura√ß√£o - l√° adicionaremos suporte para nossos </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">rocket-tools</a> - ferramentas para constru√ß√£o de c√≥digo e depura√ß√£o para arquiteturas RISC-V de 32 e 64 bits </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">openocd-riscv</a> - Porta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">OpenOCD</a> para trabalhar em JTAG com kernels RISC-V (pelo menos RocketChip) </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Comunidade IntelliJ IDEA</a> para editar o c√≥digo Scala, que √© a maioria no RocketChip </li><li>  A cadeia de ferramentas pr√©-montada do SiFive tamb√©m pode ser √∫til, um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">link</a> para o qual eu vi no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo</a> j√° mencionado </li></ul><br><p>  O que √© necess√°rio do ferro: </p><br><ul><li>  Kit Zeowaa da Aliexpress: placa com Cyclone 4 EP4CE115 e (clone?) USB Blaster </li><li>  RaspberryPi como depurador JTAG para soft core </li></ul><br><p>  A m√°quina host √© considerada um computador relativamente poderoso com o Ubuntu e o Quartus Lite 18 instalados. </p><br><p>  Na verdade, existe uma op√ß√£o para iniciar na nuvem Amazon em suas inst√¢ncias FPGA a partir do mesmo SiFive, chamado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">FireSim</a> , mas n√£o √© t√£o interessante, <del>  Sim, e os LEDs est√£o pouco vis√≠veis </del>  .  Al√©m disso, nesse caso, voc√™ precisar√° especificar sua chave de API na inst√¢ncia de controle para iniciar outras m√°quinas virtuais e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">cuidar muito dela</a> , caso contr√°rio, de acordo com os rumores, um dia voc√™ poder√° acordar com uma d√≠vida de dezenas de milhares de d√≥lares ... </p><br><h1 id="izuchaem-obstanovku">  Estudamos a situa√ß√£o </h1><br><p>  Para come√ßar, peguei o projeto de teste <code>read_write_1G</code> do fornecedor do conselho e tentei adicionar as fontes necess√°rias.  Por que n√£o criar um novo?  Porque eu sou novo, e neste projeto os nomes dos pinos j√° foram mapeados.  Ent√£o, voc√™ precisa pegar o c√≥digo fonte de algum lugar.  Para fazer isso, precisaremos do reposit√≥rio de <code>freedom</code> j√° especificado (n√£o confunda com o <code>freedom-e-sdk</code> ).  Para obter pelo menos alguma coisa, coletaremos <code>rocket-tools</code> acordo com as instru√ß√µes (literalmente, lan√ßando dois scripts e muita espera) e, em seguida, executaremos </p><br><pre> <code class="plaintext hljs">RISCV=$(pwd)/../rocket-tools make -f Makefile.e300artydevkit verilog mcs</code> </pre> <br><p>  O <code>verilog</code> destino gerar√° um enorme arquivo Verilog com fontes de processador para n√≥s, e o <code>mcs</code> compilar√° o BootROM.  N√£o precisa se preocupar com o fato de o <code>mcs</code> falhar - simplesmente n√£o temos o Xilinx Vivado, portanto o BootROM compilado n√£o pode ser convertido no formato que o Vivado precisa. </p><br><p>  Atrav√©s do item de menu <strong>Projeto</strong> Quartus <strong>-&gt; Adicionar / Remover Arquivos no Projeto ...</strong> adicione <code>freedom/builds/e300artydevkit/sifive.freedom.everywhere.e300artydevkit.E300ArtyDevKitConfig.v</code> , defina a entidade de n√≠vel superior: <strong>E300ArtyDevKitFPGAChip</strong> na guia Geral e inicie a compila√ß√£o (possivelmente , a lista de preenchimento autom√°tico da entidade de n√≠vel superior ser√° exibida somente ap√≥s a primeira compila√ß√£o).  Como resultado, recebemos <code>IOBUF</code> erros informando sobre a aus√™ncia dos m√≥dulos <code>AsyncResetReg</code> , <code>IOBUF</code> etc.  Se n√£o houver erros, voc√™ esqueceu de alterar a entidade de n√≠vel superior.  Se voc√™ vasculhar a fonte, poder√° encontrar diretamente o arquivo <code>AsyncResetReg.v</code> , mas o <code>IOBUF</code> √© uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">liga√ß√£o</a> ao n√∫cleo IP do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Xilinx</a> .  Primeiro, adicione <code>freedom/rocket-chip/src/main/resources/vsrc/AsyncResetReg.v</code> .  E <code>plusarg_reader.v</code> tamb√©m ser√° adicionado. </p><br><p>  Execute a compila√ß√£o e obtenha outro erro: </p><br><pre> <code class="plaintext hljs">Error (10174): Verilog HDL Unsupported Feature error at plusarg_reader.v(18): system function "$value$plusargs" is not supported for synthesis</code> </pre> <br><p>  Em princ√≠pio, constru√ß√µes n√£o sintetizadas podem ser esperadas de um arquivo com um nome semelhante. </p><br><div class="spoiler">  <b class="spoiler_title">plusarg_reader.v</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">// See LICENSE.SiFive for license details. //VCS coverage exclude_file // No default parameter values are intended, nor does IEEE 1800-2012 require them (clause A.2.4 param_assignment), // but Incisive demands them. These default values should never be used. module plusarg_reader #(parameter FORMAT="borked=%d", DEFAULT=0) ( output [31:0] out ); `ifdef SYNTHESIS assign out = DEFAULT; `else reg [31:0] myplus; assign out = myplus; initial begin if (!$value$plusargs(FORMAT, myplus)) myplus = DEFAULT; end `endif endmodule</code> </pre> </div></div><br><p>  Como podemos ver, este m√≥dulo provavelmente l√™ as op√ß√µes de simula√ß√£o na linha de comando e, quando sintetizado, simplesmente retorna o valor padr√£o.  O problema √© que nosso projeto n√£o define define chamado <code>SYNTHESIS</code> .  Seria poss√≠vel <code>ifdef</code> <code>`define SYNTHESIS</code> na linha anterior logo antes do <code>ifdef</code> e passar meia semana tentando entender por que o kernel n√£o inicia (e, afinal, a infec√ß√£o √© sintetizada ...).  N√£o repita meus erros, mas simplesmente abra as propriedades do projeto novamente e, na guia <strong>Configura√ß√µes</strong> do <strong>compilador-&gt; Verilog HDL Input</strong> , defina a macro <code>SYNTHESIS</code> e pelo menos 1, n√£o em <code>&lt;NONE&gt;</code> (linha vazia). </p><br><p>  Aqui!  Agora, o Quartus jura por falta de liga√ß√µes - √© hora de configurar um projeto no Idea e come√ßar a portar. </p><br><h1 id="znakomimsya-s-proektom">  Conhecendo o projeto </h1><br><p>  Contamos a ideia do projeto Importar, especificamos o caminho para o reposit√≥rio Freedom, indicamos o tipo de projeto sbt, verificamos o uso do shell sbt para importa√ß√µes e para as caixas de sele√ß√£o Builds.  Aqui, o conto de fadas termina, ao que parece, mas n√£o encontra a id√©ia de um meio projeto - todos os c√≥digos-fonte est√£o marcados em vermelho.  Com base nas informa√ß√µes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">daqui</a> , obtive o seguinte procedimento: </p><br><ul><li>  abra a janela shell sbt </li><li>  entre <code>clean</code> </li><li>  pressione o bot√£o verde Reiniciar √† esquerda </li><li>  ap√≥s reiniciar o sbt, digite o primeiro comando <code>++2.12.4</code> , alternando todos os subprojetos para o Scala vers√£o 2.12.4, e executaremos a <code>compile</code> </li><li>  clique em Atualizar todos os projetos sbt Idea </li><li>  LUCRO !, agora a luz de fundo funciona corretamente </li></ul><br><p>  At√© agora, tentarei de alguma forma montar o projeto, pelo menos no modo semi-manual.  <strong>A prop√≥sito, algu√©m, diga- <code>quartus_ipcreate</code> , √© o <code>quartus_ipcreate</code> na Lite Edition?</strong>  Por enquanto, criaremos varia√ß√µes de IP manualmente, e as liga√ß√µes estar√£o apenas no Scala na forma de BlackBox. </p><br><p>  Nesse caso, estamos interessados ‚Äã‚Äãna seguinte hierarquia de diret√≥rios: </p><br><pre> <code class="plaintext hljs">fpga-shells () | +-src/main/scala | +- ip/intel &lt;--     IP Variations | | | +- Intel.scala | +- shell/intel &lt;--       | +- ZeowaaShell.scala src/main/scala | +- everywhere.e300artydevkit &lt;--   "" ,    | +- zeowaa/e115 &lt;--      "" SoC | +- Config +- FPGAChip +- Platform +- System</code> </pre> <br><p>  Voc√™ tamb√©m precisa adicionar um Makefile semelhante ao <code>Makefile.e300artydevkit</code> , algo como isto: </p><br><p>  <strong>Makefile.zeowaa-e115:</strong> </p><br><pre> <code class="plaintext hljs"># See LICENSE for license details. base_dir := $(patsubst %/,%,$(dir $(abspath $(lastword $(MAKEFILE_LIST))))) BUILD_DIR := $(base_dir)/builds/zeowaa-e115 FPGA_DIR := $(base_dir)/fpga-shells/intel MODEL := FPGAChip PROJECT := sifive.freedom.zeowaa.e115 export CONFIG_PROJECT := sifive.freedom.zeowaa.e115 export CONFIG := ZeowaaConfig export BOARD := zeowaa export BOOTROM_DIR := $(base_dir)/bootrom/xip rocketchip_dir := $(base_dir)/rocket-chip sifiveblocks_dir := $(base_dir)/sifive-blocks include common.mk</code> </pre> <br><h1 id="bindingi">  Liga√ß√µes </h1><br><p>  Para come√ßar, implementamos esse <code>IOBUF</code> - dificilmente ser√° dif√≠cil.  A julgar pelo c√≥digo Scala, este √© um m√≥dulo que controla a ‚Äúperna‚Äù (bola?) F√≠sica do microcircuito: pode ser ligado, pode ser ligado ou pode ser completamente desligado.  √Ä direita da janela do Quartus, inseriremos ‚ÄúIOBUF‚Äù no Cat√°logo de IP e obteremos imediatamente um componente chamado <code>ALTIOBUF</code> .  Vamos definir um nome para o arquivo de varia√ß√£o, selecione "Como um buffer bidirecional".  Depois disso, um m√≥dulo chamado <code>iobuf</code> aparecer√° em nosso projeto: </p><br><pre> <code class="plaintext hljs">// ... module obuf ( datain, oe, dataout); input [0:0] datain; input [0:0] oe; output [0:0] dataout; wire [0:0] sub_wire0; wire [0:0] dataout = sub_wire0[0:0]; obuf_iobuf_out_d5t obuf_iobuf_out_d5t_component ( .datain (datain), .oe (oe), .dataout (sub_wire0)); endmodule // ...</code> </pre> <br><p>  Vamos escrever um m√≥dulo de caixa preta para ele: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> ip.intel <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> chisel3._ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> chisel3.core.{<span class="hljs-type"><span class="hljs-type">Analog</span></span>, <span class="hljs-type"><span class="hljs-type">BlackBox</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> freechips.rocketchip.jtag.<span class="hljs-type"><span class="hljs-type">Tristate</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IOBUF</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BlackBox</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> io = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Bundle</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> datain = <span class="hljs-type"><span class="hljs-type">Input</span></span>(<span class="hljs-type"><span class="hljs-type">Bool</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> dataout = <span class="hljs-type"><span class="hljs-type">Output</span></span>(<span class="hljs-type"><span class="hljs-type">Bool</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> oe = <span class="hljs-type"><span class="hljs-type">Input</span></span>(<span class="hljs-type"><span class="hljs-type">Bool</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> dataio = <span class="hljs-type"><span class="hljs-type">Analog</span></span>(<span class="hljs-number"><span class="hljs-number">1.</span></span><span class="hljs-type"><span class="hljs-type">W</span></span>) }) <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">desiredName</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">"iobuf"</span></span> } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IOBUF</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span></span>(a: <span class="hljs-type"><span class="hljs-type">Analog</span></span>, t: <span class="hljs-type"><span class="hljs-type">Tristate</span></span>): <span class="hljs-type"><span class="hljs-type">IOBUF</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> res = <span class="hljs-type"><span class="hljs-type">Module</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">IOBUF</span></span>) res.io.datain := t.data res.io.oe := t.driven a &lt;&gt; res.io.dataio res } }</code> </pre> <br><p>  Descrevemos o Verilogue <code>inout</code> tipo <code>Analog</code> , e o m√©todo <code>desiredName</code> permite alterar o nome da classe do m√≥dulo.  Isso √© especialmente importante porque geramos ligantes, n√£o implementa√ß√µes. </p><br><p>  Tamb√©m precisamos do BootROM - para isso, criamos uma varia√ß√£o da <strong>ROM: 1-PORT</strong> (palavras de 2048 x 32 bits, apenas registro de endere√ßo, crie a porta <code>rden</code> ).  Criamos um bloco com o nome <code>rom</code> , porque temos que escrever um adaptador para a interface que a classe <code>ROMGenerator</code> : <code>ROMGenerator</code> vez de <code>me</code> e <code>oe</code> faltando em n√≥s (ainda est√° anexado a 1): </p><br><p>  <strong>BootROM.v:</strong> </p><br><pre> <code class="plaintext hljs">module BootROM( input wire [10:0] address, input wire clock, input wire me, input wire oe, output wire [31:0] q ); rom r( .address(address), .clock(clock), .rden(me), .q(q) ); endmodule</code> </pre><br><p>  Mais um problema √© descoberto imediatamente: os arquivos hexadecimais gerados pelo coletor, por algum motivo, acabam sendo incompat√≠veis com o Quartus.  Depois de pesquisar um pouco sobre o t√≥pico dos arquivos Intel HEX (a Intel demorou muito antes da compra deste Intel Altera, como eu o entendo), chegamos a um comando que converte arquivos bin√°rios em HEX: </p><br><pre> <code class="plaintext hljs">srec_cat -Output builds/zeowaa-e115/xip.hex -Intel builds/zeowaa-e115/xip.bin -Binary -Output_Block_Size 128</code> </pre> <br><p>  Portanto, nosso Makefile ser√° transformado um pouco: </p><br><div class="spoiler">  <b class="spoiler_title">Texto oculto</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">base_dir := $(patsubst %/,%,$(dir $(abspath $(lastword $(MAKEFILE_LIST))))) BUILD_DIR := $(base_dir)/builds/zeowaa-e115 FPGA_DIR := $(base_dir)/fpga-shells/intel MODEL := FPGAChip PROJECT := sifive.freedom.zeowaa.e115 export CONFIG_PROJECT := sifive.freedom.zeowaa.e115 export CONFIG := ZeowaaConfig export BOARD := zeowaa export BOOTROM_DIR := $(base_dir)/bootrom/xip rocketchip_dir := $(base_dir)/rocket-chip sifiveblocks_dir := $(base_dir)/sifive-blocks all: verilog $(MAKE) -C $(BOOTROM_DIR) clean romgen || true srec_cat -Output $(BUILD_DIR)/xip.hex -Intel $(BUILD_DIR)/xip.bin -Binary -Output_Block_Size 128 include common.mk</code> </pre> </div></div><br><h1 id="ono-shevelitsyaw-sinteziruetsya">  Move ^ W √© sintetizado </h1><br><p>  Portanto, o projeto como um todo √© sintetizado, agora a coisa mais interessante √© a depura√ß√£o.  O gato √© primeiro autorizado a entrar em casa, e talvez o JTAG no microcontrolador.  Vamos criar um sistema quase m√≠nimo para depura√ß√£o: BootROM para inicializar, GPIO para piscar LEDs e JTAG para entender por que nada est√° carregando e n√£o est√° piscando.  Por analogia com o <code>E300ArtyDevKit</code> crie um pacote com quatro arquivos.  Em primeiro lugar </p><br><p>  <strong>Config.scala:</strong> </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DefaultZeowaaConfig</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class"> (</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> new </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">WithNBreakpoints</span></span></span></span><span class="hljs-class"><span class="hljs-params">(2</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">++</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WithNExtTopInterrupts</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">0</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">++</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WithJtagDTM</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">++</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TinyConfig</span></span></span><span class="hljs-class"> ) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Peripherals</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(site, here, up</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">=&gt;</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">PeripheryGPIOKey</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>( <span class="hljs-type"><span class="hljs-type">GPIOParams</span></span>(address = <span class="hljs-type"><span class="hljs-type">BigInt</span></span>(<span class="hljs-number"><span class="hljs-number">0x64002000</span></span>L), width = <span class="hljs-number"><span class="hljs-number">6</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">PeripheryMaskROMKey</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>( <span class="hljs-type"><span class="hljs-type">MaskROMParams</span></span>(address = <span class="hljs-number"><span class="hljs-number">0x10000</span></span>, name = <span class="hljs-string"><span class="hljs-string">"BootROM"</span></span>)) }) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ZeowaaConfig</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> new </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Peripherals</span></span></span></span><span class="hljs-class"><span class="hljs-params"> ++ new </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">DefaultZeowaaConfig</span></span></span></span><span class="hljs-class"><span class="hljs-params">(</span></span></span><span class="hljs-class">).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">alter</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(site, here, up</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">=&gt;</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">JtagDTMKey</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">JtagDTMConfig</span></span> ( idcodeVersion = <span class="hljs-number"><span class="hljs-number">2</span></span>, idcodePartNum = <span class="hljs-number"><span class="hljs-number">0xe31</span></span>, idcodeManufId = <span class="hljs-number"><span class="hljs-number">0x489</span></span>, debugIdleCycles = <span class="hljs-number"><span class="hljs-number">5</span></span>) }) )</code> </pre> <br><p>  A descri√ß√£o √© na maioria das vezes copiada e truncada do E300: perguntamos em que consiste nosso kernel e onde ele estar√° no espa√ßo de endere√ßo.  Observe que, embora n√£o tenhamos RAM (essa √© a <code>TinyConfig</code> padr√£o no <code>TinyConfig</code> ), h√° um espa√ßo de endere√ßo, al√©m disso, de 32 bits! </p><br><p>  H√° tamb√©m um arquivo que carrega uma certa quantidade de clich√™. <br>  <strong>System.scala:</strong> </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">System</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">implicit p: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Parameters</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RocketSubsystem</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasPeripheryMaskROMSlave</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasPeripheryDebug</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasPeripheryGPIO</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lazy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> module = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">SystemModule</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SystemModule</span></span></span><span class="hljs-class">[+</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">L</span></span></span><span class="hljs-class"> &lt;: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">System</span></span></span><span class="hljs-class">](</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">_outer: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">L</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RocketSubsystemModuleImp</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">_outer</span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasPeripheryDebugModuleImp</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasPeripheryGPIOModuleImp</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Reset vector is set to the location of the mask rom val maskROMParams = p(PeripheryMaskROMKey) global_reset_vector := maskROMParams(0).address.U }</span></span></code> </pre> <br><p>  Na verdade, o layout da nossa "placa-m√£e" est√° em tr√™s (at√© agora) arquivos simples: <br>  <strong>Platform.scala:</strong> </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlatformIO</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">implicit val p: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Parameters</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Bundle</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> jtag = <span class="hljs-type"><span class="hljs-type">Flipped</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">JTAGIO</span></span>(hasTRSTn = <span class="hljs-literal"><span class="hljs-literal">false</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> jtag_reset = <span class="hljs-type"><span class="hljs-type">Input</span></span>(<span class="hljs-type"><span class="hljs-type">Bool</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> gpio = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">GPIOPins</span></span>(() =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">BasePin</span></span>(), p(<span class="hljs-type"><span class="hljs-type">PeripheryGPIOKey</span></span>)(<span class="hljs-number"><span class="hljs-number">0</span></span>)) } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Platform</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">implicit p: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Parameters</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Module</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> sys = <span class="hljs-type"><span class="hljs-type">Module</span></span>(<span class="hljs-type"><span class="hljs-type">LazyModule</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">System</span></span>).module) <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> io = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">PlatformIO</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> sjtag = sys.debug.systemjtag.get sjtag.reset := io.jtag_reset sjtag.mfr_id := p(<span class="hljs-type"><span class="hljs-type">JtagDTMKey</span></span>).idcodeManufId.<span class="hljs-type"><span class="hljs-type">U</span></span>(<span class="hljs-number"><span class="hljs-number">11.</span></span><span class="hljs-type"><span class="hljs-type">W</span></span>) sjtag.jtag &lt;&gt; io.jtag io.gpio &lt;&gt; sys.gpio.head }</code> </pre> <br><p>  <strong>FPGAChip.scala:</strong> </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FPGAChip</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">override implicit val p: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Parameters</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ZeowaaShell</span></span></span><span class="hljs-class"> </span></span>{ withClockAndReset(cpu_clock, cpu_rst) { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> dut = <span class="hljs-type"><span class="hljs-type">Module</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Platform</span></span>) dut.io.jtag.<span class="hljs-type"><span class="hljs-type">TCK</span></span> := jtag_tck dut.io.jtag.<span class="hljs-type"><span class="hljs-type">TDI</span></span> := jtag_tdi <span class="hljs-type"><span class="hljs-type">IOBUF</span></span>(jtag_tdo, dut.io.jtag.<span class="hljs-type"><span class="hljs-type">TDO</span></span>) dut.io.jtag.<span class="hljs-type"><span class="hljs-type">TMS</span></span> := jtag_tms dut.io.jtag_reset := jtag_rst <span class="hljs-type"><span class="hljs-type">Seq</span></span>(led_0, led_1, led_2, led_3) zip dut.io.gpio.pins foreach { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> (led, pin) =&gt; led := <span class="hljs-type"><span class="hljs-type">Mux</span></span>(pin.o.oe, pin.o.oval, <span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>) } dut.io.gpio.pins.foreach(_.i.ival := <span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>) dut.io.gpio.pins(<span class="hljs-number"><span class="hljs-number">4</span></span>).i.ival := key1 dut.io.gpio.pins(<span class="hljs-number"><span class="hljs-number">5</span></span>).i.ival := key2 } }</code> </pre> <br><p>  Como voc√™ pode ver, voc√™ pode escrever geradores no Chisel em um estilo funcional (um caso muito simples √© mostrado aqui).  Mas voc√™ pode escrever e claramente todos os fios: </p><br><div class="spoiler">  <b class="spoiler_title">ZeowaaShell.scala</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ZeowaaShell</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MemIf</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Bundle</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> mem_addr = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Analog</span></span>(<span class="hljs-number"><span class="hljs-number">14.</span></span><span class="hljs-type"><span class="hljs-type">W</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> mem_ba = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Analog</span></span>(<span class="hljs-number"><span class="hljs-number">3.</span></span><span class="hljs-type"><span class="hljs-type">W</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> mem_cas_n = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Analog</span></span>(<span class="hljs-number"><span class="hljs-number">1.</span></span><span class="hljs-type"><span class="hljs-type">W</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> mem_cke = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Analog</span></span>(<span class="hljs-number"><span class="hljs-number">2.</span></span><span class="hljs-type"><span class="hljs-type">W</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> mem_clk = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Analog</span></span>(<span class="hljs-number"><span class="hljs-number">2.</span></span><span class="hljs-type"><span class="hljs-type">W</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> mem_clk_n = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Analog</span></span>(<span class="hljs-number"><span class="hljs-number">2.</span></span><span class="hljs-type"><span class="hljs-type">W</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> mem_cs_n = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Analog</span></span>(<span class="hljs-number"><span class="hljs-number">2.</span></span><span class="hljs-type"><span class="hljs-type">W</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> mem_dm = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Analog</span></span>(<span class="hljs-number"><span class="hljs-number">8.</span></span><span class="hljs-type"><span class="hljs-type">W</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> mem_dq = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Analog</span></span>(<span class="hljs-number"><span class="hljs-number">64.</span></span><span class="hljs-type"><span class="hljs-type">W</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> mem_dqs = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Analog</span></span>(<span class="hljs-number"><span class="hljs-number">8.</span></span><span class="hljs-type"><span class="hljs-type">W</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> mem_odt = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Analog</span></span>(<span class="hljs-number"><span class="hljs-number">2.</span></span><span class="hljs-type"><span class="hljs-type">W</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> mem_ras_n = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Analog</span></span>(<span class="hljs-number"><span class="hljs-number">1.</span></span><span class="hljs-type"><span class="hljs-type">W</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> mem_we_n = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Analog</span></span>(<span class="hljs-number"><span class="hljs-number">1.</span></span><span class="hljs-type"><span class="hljs-type">W</span></span>)) } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ZeowaaShell</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">implicit val p: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Parameters</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RawModule</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> clk25 = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Input</span></span>(<span class="hljs-type"><span class="hljs-type">Clock</span></span>())) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> clk27 = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Input</span></span>(<span class="hljs-type"><span class="hljs-type">Clock</span></span>())) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> clk48 = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Input</span></span>(<span class="hljs-type"><span class="hljs-type">Clock</span></span>())) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> key1 = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Input</span></span>(<span class="hljs-type"><span class="hljs-type">Bool</span></span>())) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> key2 = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Input</span></span>(<span class="hljs-type"><span class="hljs-type">Bool</span></span>())) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> key3 = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Input</span></span>(<span class="hljs-type"><span class="hljs-type">Bool</span></span>())) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> led_0 = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Output</span></span>(<span class="hljs-type"><span class="hljs-type">Bool</span></span>())) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> led_1 = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Output</span></span>(<span class="hljs-type"><span class="hljs-type">Bool</span></span>())) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> led_2 = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Output</span></span>(<span class="hljs-type"><span class="hljs-type">Bool</span></span>())) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> led_3 = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Output</span></span>(<span class="hljs-type"><span class="hljs-type">Bool</span></span>())) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> jtag_tdi = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Input</span></span>(<span class="hljs-type"><span class="hljs-type">Bool</span></span>())) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> jtag_tdo = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Analog</span></span>(<span class="hljs-number"><span class="hljs-number">1.</span></span><span class="hljs-type"><span class="hljs-type">W</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> jtag_tck = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Input</span></span>(<span class="hljs-type"><span class="hljs-type">Clock</span></span>())) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> jtag_tms = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Input</span></span>(<span class="hljs-type"><span class="hljs-type">Bool</span></span>())) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> uart_rx = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Input</span></span>(<span class="hljs-type"><span class="hljs-type">Bool</span></span>())) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> uart_tx = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-type"><span class="hljs-type">Analog</span></span>(<span class="hljs-number"><span class="hljs-number">1.</span></span><span class="hljs-type"><span class="hljs-type">W</span></span>)) <span class="hljs-comment"><span class="hljs-comment">// Internal wiring val cpu_clock = Wire(Clock()) val cpu_rst = Wire(Bool()) val jtag_rst = Wire(Bool()) withClockAndReset(cpu_clock, false.B) { val counter = Reg(UInt(64.W)) counter := counter + 1.U cpu_rst := (counter &gt; 1000.U) &amp;&amp; (counter &lt; 2000.U) jtag_rst := (counter &gt; 3000.U) &amp;&amp; (counter &lt; 4000.U) } cpu_clock &lt;&gt; clk25 }</span></span></code> </pre> </div></div><br><p>  Por que √© dividido em tr√™s arquivos?  Bem, em primeiro lugar, era assim no prot√≥tipo :) A l√≥gica de separar o <code>Shell</code> do <code>FPGAChip</code> , aparentemente, era que o Shell √© uma descri√ß√£o da interface para o mundo exterior: que conclus√µes temos em um quadro espec√≠fico (e como ser√£o exibidas no conclus√µes de chip!) e o <code>FPGAChip</code> √© ditado pelo fato de que queremos inserir um SoC espec√≠fico.  Bem, o Platform √© separado de maneira l√≥gica: nota: o <code>ZeowaaShell</code> (e, portanto, o <code>Platform</code> ) √© um <code>RawModule</code> , em particular, eles n√£o t√™m um <code>clock</code> impl√≠cito e s√£o <code>reset</code> - isso √© natural para "conectar a placa", mas inconveniente para o trabalho (e, provavelmente, repleto de erros complicados com dom√≠nios de frequ√™ncia prol√≠ficos).  Bem, o Platform j√° √© um m√≥dulo Chisel comum, no qual voc√™ pode descrever com seguran√ßa registros, etc. </p><br><h1 id="jtag">  Jtag </h1><br><p>  Algumas palavras sobre como configurar o JTAG.  Como eu j√° tinha o RaspberryPi 3 Modelo B +, a solu√ß√£o √≥bvia era tentar, de alguma forma, usar seu GPIO.  Felizmente, <em>tudo j√° foi implementado antes de n√≥s</em> : no OpenOCD novo, h√° uma descri√ß√£o da <code>interface/sysfsgpio-raspberrypi.cfg</code> , com a qual voc√™ pode <code>interface/sysfsgpio-raspberrypi.cfg</code> ao depurador que se conecte atrav√©s do bloco (TCK = 11, TMS = 25, TDI = 10, TDO = 9 e GND sair como exerc√≠cio) - pinagem <a href="">aqui</a> . </p><br><p>  Al√©m disso, tomando o <a href="">Freedom.cfg</a> como base do reposit√≥rio <code>riscv-tests</code> , obtive o seguinte: </p><br><pre> <code class="plaintext hljs">adapter_khz 10000 source [find interface/sysfsgpio-raspberrypi.cfg] set _CHIPNAME riscv jtag newtap $_CHIPNAME cpu -irlen 5 -expected-id 0x20e31913 set _TARGETNAME $_CHIPNAME.cpu target create $_TARGETNAME riscv -chain-position $_TARGETNAME -rtos riscv init halt echo "Ready for Remote Connections"</code> </pre> <br><p>  Para funcionar, voc√™ precisar√° da porta <a href="">riscv-openocd</a> criada no ARM, portanto <del>  o brinde n√£o passou </del>  em vez da vers√£o pr√©-montada do SiFive, voc√™ deve clonar o reposit√≥rio e coletar: </p><br><pre> <code class="plaintext hljs">./configure --enable-remote-bitbang --enable-sysfsgpio</code> </pre> <br><p>  Se algu√©m souber executar o bitbang remoto, talvez n√£o seja necess√°rio criar uma porta personalizada para o ARM ... </p><br><p>  Como resultado, lan√ßamos a partir da raiz em Malinka </p><br><pre> <code class="plaintext hljs">root@ubuntu:~/riscv-openocd# ./src/openocd -s tcl -f ../riscv.tcl Open On-Chip Debugger 0.10.0+dev-00614-g998fed1fe-dirty (2019-06-03-10:27) Licensed under GNU GPL v2 For bug reports, read http://openocd.org/doc/doxygen/bugs.html adapter speed: 10000 kHz SysfsGPIO nums: tck = 11, tms = 25, tdi = 10, tdo = 9 SysfsGPIO nums: swclk = 11, swdio = 25 Info : auto-selecting first available session transport "jtag". To override use 'transport select &lt;transport&gt;'. Info : SysfsGPIO JTAG/SWD bitbang driver Info : JTAG and SWD modes enabled Warn : gpio 11 is already exported Warn : gpio 25 is already exported Info : This adapter doesn't support configurable speed Info : JTAG tap: riscv.cpu tap/device found: 0x20e31913 (mfg: 0x489 (SiFive, Inc.), part: 0x0e31, ver: 0x2) Info : datacount=1 progbufsize=16 Info : Disabling abstract command reads from CSRs. Info : Examined RISC-V core; found 1 harts Info : hart 0: XLEN=32, misa=0x40001105 Info : Listening on port 3333 for gdb connections Ready for Remote Connections Info : Listening on port 6666 for tcl connections Info : Listening on port 4444 for telnet connections</code> </pre> <br><p>  Depois de efetuar login no SSH com o encaminhamento de porta 3333, substituindo o IP desejado: </p><br><pre> <code class="plaintext hljs">ssh -L 3333:127.0.0.1:3333 ubuntu@192.168.1.104</code> </pre> <br><p>  Agora, no host, voc√™ pode executar o GDB <strong>sob a arquitetura riscv32</strong> : </p><br><pre> <code class="plaintext hljs">$ ../../rocket-tools/bin/riscv32-unknown-elf-gdb -q (gdb) target remote :3333 Remote debugging using :3333 warning: No executable has been specified and target does not support determining executable automatically. Try using the "file" command. 0x00000000 in ?? ()</code> </pre> <br><p>  Iremos pular algumas depura√ß√µes cegas do JTAG n√£o aderente devido ao fato de que a macro <code>SYNTHESIS</code> √© usada ativamente no arquivo principal gerado e rebobinar a situa√ß√£o para o estado "JTAG est√° conectado, mas as luzes n√£o piscam". </p><br><h1 id="pervyy-kod">  Primeiro c√≥digo </h1><br><p>  Como vimos no Makefile, o c√≥digo para bootrom √© obtido no <code>bootrom/xip/xip.S</code>  Agora fica assim: </p><br><pre> <code class="plaintext hljs">// See LICENSE for license details. // Execute in place // Jump directly to XIP_TARGET_ADDR .section .text.init .option norvc .globl _start _start: csrr a0, mhartid la a1, dtb li t0, XIP_TARGET_ADDR jr t0 .section .rodata dtb: .incbin DEVICE_TREE</code> </pre> <br><p>  Entendo que deve haver uma √°rvore de dispositivos (o conte√∫do do arquivo dtb) para ser lida pelo sistema operacional, mas que tipo de sistema operacional existe sem RAM.  Portanto, substitua-o temporariamente com ousadia por l√¢mpadas intermitentes: </p><br><div class="spoiler">  <b class="spoiler_title">Texto oculto</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"> .section .text.init .option norvc .globl _start _start: li a5, 0x64002000 li a1, 0x0F li a2, 0x01 li a3, 0x30 li a6, 0x10 li a7, 0x20 sw zero, 0x38(a5) // iof_en sw a1, 0x08(a5) // output_en sw a2, 0x00(a5) // value sw a1, 0x14(a5) // drive sw a3, 0x04(a5) // input_en // a0 &lt;- timer // a1 &lt;- 0x0F // a2 &lt;- [state] // a3 &lt;- 0x30 // a4 &lt;- [buttons] // a5 &lt;- [gpio addr] // a6 &lt;- 0x10 // a7 &lt;- 0x20 loop: li a4, 0x1000 add a0, a0, a4 bgtu a0, zero, loop lw a4, 0x00(a5) // value beq a4, a6, plus beq a4, a7, minus j store plus: srai a2, a2, 1 beq a2, zero, pzero j store pzero: li a2, 0x08 j store minus: slli a2, a2, 1 beq a2, a6, mzero j store mzero: li a2, 0x01 store: sw a2, 0x0c(a5) // value j loop</code> </pre> </div></div><br><p>  Esse c√≥digo foi desenvolvido iterativamente; portanto, desculpe-me pela estranha numera√ß√£o dos registros.  Al√©m disso, estudei honestamente o montador RISC-V usando o m√©todo "compilar um peda√ßo de c√≥digo em um arquivo de objeto, desmontar, ver".  Quando li um livro de eletr√¥nica h√° alguns anos, ele falou sobre a programa√ß√£o do ATTiny na linguagem assembly.  "Aqui est√£o as coisas chatas e a rotina, provavelmente", pensei, mas agora, aparentemente, o <em>efeito de uma loja sueca apareceu</em> : <del>  arm√°rio </del>  processador montado a partir de pe√ßas de reposi√ß√£o, at√© o montador parece ser nativo e interessante.  Como resultado da execu√ß√£o desse c√≥digo, o LED aceso deve ‚Äúcorrer‚Äù para a esquerda ou direita, dependendo de qual bot√£o for pressionado. </p><br><p>  Come√ßamos ... E nada: todas as luzes est√£o acesas, elas n√£o respondem aos bot√µes.  Vamos nos conectar via JTAG: contador de programa = 0x00000000 - de alguma forma tudo est√° triste.  Mas em <code>0x64002000</code> , temos registros GPIO dispon√≠veis: </p><br><div class="spoiler">  <b class="spoiler_title">GPIOCtrlRegs.scala</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">// See LICENSE for license details. package sifive.blocks.devices.gpio object GPIOCtrlRegs { val value = 0x00 val input_en = 0x04 val output_en = 0x08 val port = 0x0c val pullup_en = 0x10 val drive = 0x14 val rise_ie = 0x18 val rise_ip = 0x1c val fall_ie = 0x20 val fall_ip = 0x24 val high_ie = 0x28 val high_ip = 0x2c val low_ie = 0x30 val low_ip = 0x34 val iof_en = 0x38 val iof_sel = 0x3c val out_xor = 0x40 }</span></span></code> </pre> </div></div><br><p>  Vamos tentar mov√™-los manualmente: </p><br><pre> <code class="plaintext hljs">(gdb) set variable *0x64002038=0 (gdb) set variable *0x64002008=0xF (gdb) set variable *0x64002000=0x1 (gdb) set variable *0x64002014=0xF (gdb) set variable *0x6400200c=0x1</code> </pre> <br><p>  Ent√£o ... Um dos LEDs apagou ... E se n√£o for <code>0x1</code> , mas <code>0x5</code> ... Est√° certo, agora os LEDs est√£o acesos atrav√©s de um.  Tamb√©m ficou claro que eles precisam ser invertidos, mas voc√™ n√£o precisa gravar no registro 0x00 - √© necess√°rio ler a partir da√≠. </p><br><pre> <code class="plaintext hljs">(gdb) x/x 0x64002000 0x64002000: 0x00000030 //    (gdb) x/x 0x64002000 0x64002000: 0x00000020 //   (gdb) x/x 0x64002000 0x64002000: 0x00000010 //   (gdb) x/x 0x64002000 0x64002000: 0x00000000</code> </pre> <br><p>  √ìtimos registros de mapeamento de mem√≥ria s√£o atualizados sem iniciar o processador; voc√™ n√£o pode pressionar cont + Ctrl-C todas as vezes - um pouco, mas √© legal. </p><br><p>  Mas por que n√£o estamos girando em um loop, mas estamos em <code>$pc=0x0000000</code> ? </p><br><pre> <code class="plaintext hljs">(gdb) x/10i 0x10000 0x10000: addi s1,sp,12 0x10002: fsd ft0,-242(ra) 0x10006: srli a4,a4,0x21 0x10008: addi s0,sp,32 0x1000a: slli t1,t1,0x21 0x1000c: lb zero,-1744(a2) 0x10010: nop 0x10012: addi a0,sp,416 0x10014: c.slli zero,0x0 0x10016: 0x9308</code> </pre> <br><p>  Qual √© o Pokemon ???  Eu n√£o escrevi essas instru√ß√µes, eles me jogaram!  Vamos dar uma olhada: </p><br><pre> <code class="plaintext hljs">(gdb) x/10x 0x10000 0x10000: 0xb7270064 0x9305f000 0x13061000 0x93060003 0x10010: 0x13080001 0x93080002 0x23ac0702 0x23a4b700 0x10020: 0x23a0c700 0x23aab700</code> </pre> <br><p>  Por outro lado, o que deveria estar l√°? </p><br><pre> <code class="plaintext hljs">$ ../../rocket-tools/bin/riscv32-unknown-elf-objdump -d builds/zeowaa-e115/xip.elf builds/zeowaa-e115/xip.elf:   elf32-littleriscv   .text: 00010054 &lt;_start&gt;: 10054: 640027b7 lui a5,0x64002 10058: 00f00593 li a1,15 1005c: 00100613 li a2,1 10060: 03000693 li a3,48 10064: 01000813 li a6,16 10068: 02000893 li a7,32 1006c: 0207ac23 sw zero,56(a5) # 64002038 &lt;__global_pointer$+0x63ff0770&gt; 10070: 00b7a423 sw a1,8(a5) 10074: 00c7a023 sw a2,0(a5) 10078: 00b7aa23 sw a1,20(a5) 1007c: 00d7a223 sw a3,4(a5) ...</code> </pre> <br><p>  Como voc√™ pode ver, o Quartus honestamente colocou as mesmas palavras que estavam no arquivo de inicializa√ß√£o, mas mudou sua capacidade de endianismo.  Voc√™ pode pesquisar por um longo tempo no Google como resolv√™-lo, mas <em>eu sou programador</em> , as muletas s√£o nossas, ent√£o, apenas reescrevo </p><br><div class="spoiler">  <b class="spoiler_title">BootROM.v</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">module BootROM( input wire [10:0] address, input wire clock, input wire me, input wire oe, output wire [31:0] q ); wire [31:0] q_r; rom r( .address(address), .clock(clock), .rden(me), .q(q_r) ); assign q[31:24] = q_r[7:0]; assign q[23:16] = q_r[15:8]; assign q[15:8] = q_r[23:16]; assign q[7:0] = q_r[31:24]; endmodule</code> </pre> </div></div><br><p>  Ent√£o, n√≥s coletamos, come√ßamos, n√£o brilha.   JTAG: <code>$pc</code>   -  ,    = 4,  ,   <code>output_en</code> : <code>set variable *0x64002008=0xF</code> ,  <code>c</code> (continue) ‚Äî  ! ,      . -,        ,  ‚Ä¶        ,   <code>output_en</code>    . </p><br><p>      : </p><br><pre> <code class="plaintext hljs">Total logic elements 17,370 / 114,480 ( 15 % ) Total registers 8357 Total pins 16 / 281 ( 6 % ) Total virtual pins 0 Total memory bits 264,000 / 3,981,312 ( 7 % ) Embedded Multiplier 9-bit elements 4 / 532 ( &lt; 1 % )</code> </pre> <br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  Chisel</a> </p><br><p> <em> ...</em> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt455391/">https://habr.com/ru/post/pt455391/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt455377/index.html">Arquitetura IoT</a></li>
<li><a href="../pt455379/index.html">(Est√°tico) Sele√ß√£o de cont√™ineres ideais em programas C ++</a></li>
<li><a href="../pt455381/index.html">O suporte t√©cnico da 3CX responde: captura o tr√°fego SIP no servidor PBX</a></li>
<li><a href="../pt455387/index.html">Compreendendo o aprendizado de m√°quina no Elastic Stack (aka Elasticsearch, aka ELK)</a></li>
<li><a href="../pt455389/index.html">Haxe 4: O que h√° de novo?</a></li>
<li><a href="../pt455393/index.html">Sobre o uso de m√©todos param√©tricos de estimativa espectral em radar - o m√©todo MUSIC. Adi√ß√£o ao artigo</a></li>
<li><a href="../pt455397/index.html">Como projetamos e implementamos a nova rede na Huawei no escrit√≥rio de Moscou, parte 1</a></li>
<li><a href="../pt455401/index.html">Tcl para Cisco IOS em exemplos simples</a></li>
<li><a href="../pt455403/index.html">De cinco centavos ao jogo das divindades</a></li>
<li><a href="../pt455405/index.html">Como um pequeno programa transformou um pequeno escrit√≥rio em uma empresa federal com um lucro de mais de 100 milh√µes de rublos / m√™s</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>