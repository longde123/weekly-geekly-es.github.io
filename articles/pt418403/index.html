<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äçüë©‚Äçüëß‚Äçüëß üëÄ üë©üèΩ‚Äçü§ù‚Äçüë®üèæ Exemplo de programa√ß√£o do acelerador FPGA üåµ üçò ü§õ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="H√° pouco tempo, falamos sobre o novo servi√ßo Selectel - computa√ß√£o em nuvem de alto desempenho em aceleradores FPGA . Em um novo artigo sobre este ass...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Exemplo de programa√ß√£o do acelerador FPGA</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/selectel/blog/418403/"><img src="https://habrastorage.org/webt/u-/s-/li/u-s-liwcm4mufz__x0fd8yxbznk.png"><br><br>  H√° pouco tempo, falamos sobre o novo servi√ßo Selectel - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="noopener noreferrer">computa√ß√£o em nuvem de alto desempenho em aceleradores FPGA</a> .  Em um novo artigo sobre este assunto, consideramos um exemplo de programa√ß√£o FPGA para a constru√ß√£o de um conjunto de Mandelbrot, um conhecido algoritmo matem√°tico para visualiza√ß√£o de imagens fractais.  O artigo utilizou material do site <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="noopener noreferrer">Euler Project</a> . <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Em vez do pref√°cio</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Olhando para o futuro: experimente o FPGA no trabalho</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Sobre o padr√£o OpenCL para programa√ß√£o FPGA</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ambiente OpenCL para criar c√≥digo execut√°vel</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">V√° direto ao ponto: construindo um fractal</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Conclus√£o</a> </li></ul><br><a name="habracut"></a><br><h2>  Em vez do pref√°cio </h2><br>  Primeiro, alguns termos.  Um sistema de computador com um acelerador FPGA - como regra, este √© um adaptador PCIe com um chip FPGA como parte do servidor x64.  O acelerador assume uma tarefa separada de uso intensivo de recursos, na qual a computa√ß√£o paralela pode estar envolvida e executa muitas ordens de magnitude mais rapidamente que o processador x64, descarregando-o e aumentando o desempenho de todo o sistema de computa√ß√£o.  Por exemplo, um ciclo de c√°lculo com 100 mil repeti√ß√µes pode ser realizado em um FPGA em apenas uma passagem, em vez de executar sequencialmente 100 mil vezes em um processador x64 cl√°ssico.  Elementos l√≥gicos, recursos de hardware, links de comunica√ß√£o, chips FPGA s√£o programados pelo usu√°rio diretamente para a tarefa em si, o que permite implementar a tarefa como uma implementa√ß√£o de um algoritmo em sil√≠cio - algoritmo em sil√≠cio e, assim, alcan√ßar alto desempenho e com um consumo de energia muito modesto. <br><br>  Hoje, o limite para a entrada na tecnologia FPGA √© bastante acess√≠vel, mesmo para as startups - um servidor com um acelerador FPGA e todo o software necess√°rio (SDK) podem ser alugados na nuvem Selectel por um pre√ßo razo√°vel (o chamado "cloud FPGA"), e o suporte ao padr√£o Open CL no FPGA leva a que um programador que sabe trabalhar com C √© capaz de preparar e executar um programa no FPGA. <br><br><h2>  Olhando para o futuro: experimente o FPGA no trabalho </h2><br>  O exemplo de programa√ß√£o descrito abaixo para a constru√ß√£o de um conjunto Mandelbrot j√° foi implementado em um servidor de teste <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="noopener noreferrer">no laborat√≥rio Selectel</a> , onde qualquer pessoa pode avaliar seu desempenho (o registro ser√° necess√°rio). <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/3AxNR1jXQWg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  O projeto √© fornecido em c√≥digo e preparado para compila√ß√£o.  Selectel oferece acesso remoto a um servidor com o acelerador Intel Arria 10 FPGA.  No lado do servidor, s√£o implementadas as ferramentas SDK e BSP para desenvolvimento, depura√ß√£o e compila√ß√£o do c√≥digo OpenCL, Visual Studio para preparar aplicativos host (aplicativos de controle para o processador central do servidor). <br><blockquote> Observe que o exemplo em si n√£o tem nenhum valor aplicado; foi escolhido por raz√µes de demonstra√ß√£o dos m√©todos de acelera√ß√£o usando os princ√≠pios do paralelismo.  Com este exemplo, o leitor se familiariza com a rota de design de um aplicativo em um sistema de computa√ß√£o heterog√™neo com FPGA - posteriormente, essa rota pode ser usada para desenvolver seus pr√≥prios aplicativos com computa√ß√£o paralela. </blockquote>  <strong>ATUALIZA√á√ÉO</strong> : Na primavera de 2018, a Intel lan√ßou o processador h√≠brido de alto desempenho Xeon Gold 6138P com um chip FPGA Arria 10 integrado.  At√© o final de 2018, espera-se que os processadores seriais desse tipo estejam dispon√≠veis para os clientes por meio de parceiros da Intel.  Na Selectel, esperamos ansiosamente por esse chip e esperamos ser os primeiros na R√∫ssia a oferecer aos nossos clientes a oportunidade de testar este novo produto exclusivo. <br><br><h2>  Sobre o padr√£o OpenCL para programa√ß√£o FPGA </h2><br>  O padr√£o OpenCL foi desenvolvido pelo Khronos Group, os principais fabricantes de chips e software do mundo, incluindo Intel, AMD, Apple, ARM, Nvidia, Sony Computer Entertainment, etc. Ele foi projetado para escrever aplicativos que usam computa√ß√£o paralela em v√°rios tipos de processadores, incluindo FPGA.  O padr√£o OpenCL inclui a linguagem de programa√ß√£o C baseada na vers√£o da linguagem C99 (a vers√£o mais recente da C99 √© ISO / IEC 9899: 1999 / Cor 3: 2007 de 15-11-2007) e um ambiente de programa√ß√£o de aplicativos. <br><br>  A popularidade do uso do OpenCL para computa√ß√£o de alto desempenho baseia-se no fato de ser um padr√£o aberto e seu uso n√£o requer uma licen√ßa.  Al√©m disso, o OpenCL n√£o limita a gama de dispositivos suportados a nenhuma marca em particular, permitindo o uso de hardware de diferentes fabricantes na mesma plataforma de software. <br><blockquote><p>  Al√©m disso, sobre o OpenCL: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow noopener noreferrer">Introdu√ß√£o ao OpenCL no Habr</a> . </p><br></blockquote>  Um pouco de hist√≥ria - a rota de design do FPGA que existia antes do padr√£o OpenCL era extremamente espec√≠fica e demorada, enquanto em termos de complexidade ultrapassava o design de microcircuitos personalizados (ASIC, circuito integrado espec√≠fico da aplica√ß√£o, "circuito integrado para fins especiais").  Foi necess√°rio um entendimento completo da estrutura de hardware do FPGA, cuja configura√ß√£o teve que ser realizada em uma linguagem de descri√ß√£o de hardware (HDL) de baixo n√≠vel.  A posse dessa rota de design e verifica√ß√£o foi e continua sendo uma arte que, devido √† extrema complexidade, est√° dispon√≠vel para um c√≠rculo limitado de desenvolvedores. <br><br>  O advento do kit de ferramentas de suporte OpenCL da Intel para FPGAs abordou parcialmente a quest√£o da acessibilidade da programa√ß√£o FPGA para desenvolvedores de software.  O programador seleciona independentemente a parte do algoritmo que √© adequada para processamento paralelo e a descreve em C; em seguida, o compilador Intel OpenCL para FPGA cria um arquivo de configura√ß√£o bin√°ria para executar esse fragmento do algoritmo no acelerador. <br>  Usando o ambiente normal do Visual Studio ou o compilador gcc padr√£o, um aplicativo host √© preparado (um aplicativo do tipo .exe, executado no processador x64 principal), enquanto todas as bibliotecas de suporte necess√°rias est√£o inclu√≠das no SDK.  Quando o aplicativo host √© iniciado, o firmware do FPGA √© carregado, os dados s√£o carregados no n√∫cleo do chip e o processamento come√ßa de acordo com o algoritmo concebido. <br><blockquote><p>  O FPGA (FPGA) √© uma estrutura de hardware paralelo em massa reprogram√°vel pelo usu√°rio com milh√µes de elementos l√≥gicos, milhares de blocos de sinal DSP e dezenas de megabytes de cache para c√°lculos a bordo, sem acessar os principais m√≥dulos de mem√≥ria do servidor.  Interfaces de E / S r√°pidas (10GE, 40GE, 100GE, PCIe Gen 3, etc.) permitem que voc√™ troque dados com o processador principal do servidor. </p><br></blockquote>  O padr√£o OpenCL √© um ambiente para a execu√ß√£o de software heterog√™neo.  O ambiente consiste em duas partes separadas: <br><br><ol><li>  Software host - um aplicativo em execu√ß√£o no processador central principal do servidor, escrito em C / C ++ e usando o conjunto de fun√ß√µes da API OpenCL.  O servidor host organiza todo o processo de computa√ß√£o, fornecendo a fonte e recebendo dados de sa√≠da e interage com todos os sistemas de servidor com o acelerador FPGA. </li><li>  Software Accelerator - um programa escrito na linguagem C do OpenCL (linguagem C com v√°rias restri√ß√µes), compilado para ser executado no chip FPGA. </li></ol><br>  Um servidor t√≠pico para computa√ß√£o paralela √© um computador baseado em x64 (para executar aplicativos host), que inclui um acelerador FPGA de hardware, geralmente conectado via barramento PCI-Express.  A prop√≥sito, apenas esse sistema √© apresentado no laborat√≥rio Selectel. <br><br>  A sequ√™ncia de programa√ß√£o e compila√ß√£o para o acelerador FPGA consiste em dois est√°gios.  O c√≥digo do aplicativo host √© compilado por um compilador padr√£o (Visual C ++, GCC) para obter um arquivo execut√°vel no sistema operacional do servidor (por exemplo, * .exe).  O c√≥digo fonte do acelerador FPGA (kernel, kernel) √© preparado pelo compilador AOC como parte do SDK, com o recebimento de um arquivo bin√°rio (* .aocx).  Este arquivo √© apenas para programa√ß√£o do acelerador. <br><br> <a href=""><img title="Arquitetura do ambiente de compila√ß√£o de software OpenCL" src="https://habrastorage.org/getpro/habr/post_images/d7d/f21/34b/d7df2134b9135739340bced60509484c.png" alt="Arquitetura do ambiente de compila√ß√£o de software OpenCL" width="640" height="403"></a> <br>  Fig.  Arquitetura do ambiente de compila√ß√£o de software OpenCL <br><br>  Considere um c√≥digo de exemplo para calcular um vetor grande de duas maneiras <br>  ( <b>PS N√£o atire no pianista - daqui em diante o c√≥digo do site do Projeto Euler √© usado</b> ): <br><br><pre><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inc</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> c, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> N</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;N; i++) a[i] = a[i] + c; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ... inc(a,c,N); ... }</code> </pre> <br><pre> <code class="hljs cs">_<span class="hljs-function"><span class="hljs-function">kernel </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inc</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_global </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> c</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = get_global_id(<span class="hljs-number"><span class="hljs-number">0</span></span>); a[i] = a[i] + c; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ... clEnqueueNDRangeKernel(...,&amp;N,...) ... }</code> </pre> <br>  O c√≥digo no in√≠cio √© um exemplo de como uma implementa√ß√£o de thread √∫nico em C pode parecer usando o m√©todo de c√°lculo seq√ºencial de elementos escalares. <br><br>  A segunda vers√£o do c√≥digo √© uma poss√≠vel implementa√ß√£o do algoritmo no OpenCL na forma de uma fun√ß√£o calculada em um acelerador FPGA.  N√£o h√° loop, e o c√°lculo ocorre em uma itera√ß√£o do loop.  O c√°lculo de uma matriz de vetores ocorre como a execu√ß√£o de N c√≥pias desta fun√ß√£o.  Cada c√≥pia possui seu pr√≥prio √≠ndice, substitu√≠do no iterador em um loop, e o n√∫mero de tentativas √© definido no host quando o c√≥digo √© executado.  A a√ß√£o do iterador √© fornecida pela fun√ß√£o get_global_id (), que trabalha com um √≠ndice dentro de 0 ‚â§ index &lt;N. <br><br><h2>  V√° direto ao ponto: construindo um fractal </h2><br>  O conjunto de Mandelbrot √© uma matriz de pontos ‚Äúc‚Äù no plano complexo para o qual a rela√ß√£o de recorr√™ncia Zn + 1 = Zn¬≤ + c para Z0 = 0 define uma sequ√™ncia limitada. <br><br>  Definimos Zn = Zn + IYn, e tamb√©m c = p + iq. <br>  Para cada ponto, a seguinte sequ√™ncia √© calculada: <br><p>  Xn + 1 = Xn¬≤ + Yn¬≤ + p <br>  Yn + 1 = 2XnYn + q </p><br>  O c√°lculo da perten√ßa de um ponto ao conjunto em cada itera√ß√£o √© realizado como a equa√ß√£o <br>  Xn¬≤ + Yn¬≤ &lt;4. <br><br>  Para exibir o conjunto de Mandelbrot na tela, definimos uma regra: <br><br><ol><li>  Se a desigualdade se mantiver em qualquer itera√ß√£o, o ponto entra no conjunto e ser√° mostrado em preto. </li><li>  Se a desigualdade n√£o se mantiver, come√ßando com um certo valor de itera√ß√£o n = N, a cor √© determinada pelo n√∫mero de itera√ß√µes N. </li></ol><br>  O processo de c√°lculo no host ser√° o seguinte: <br><br><ul><li>  O c√°lculo do n√∫mero de itera√ß√µes para cada ponto dentro da janela de pixel √© atribu√≠do √† fun√ß√£o mandel_pixel (). </li><li>  A enumera√ß√£o seq√ºencial dos pontos da imagem ser√° fornecida pela fun√ß√£o softwareCalculateFrame ().  Os par√¢metros especificam o intervalo real dos pontos calculados, a etapa real do algoritmo e um ponteiro para o buffer de cores do tamanho da imagem (theWidth * theHeight). </li><li>  A cor do ponto √© ajustada pelaSoftColorTable. </li></ul><br>  Vamos para o c√≥digo: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> mandel_pixel( <span class="hljs-type"><span class="hljs-type">double</span></span> x0, <span class="hljs-type"><span class="hljs-type">double</span></span> y0, unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> maxIterations ) { // variables <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the calculation <span class="hljs-type"><span class="hljs-type">double</span></span> x = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; <span class="hljs-type"><span class="hljs-type">double</span></span> y = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; <span class="hljs-type"><span class="hljs-type">double</span></span> xSqr = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; <span class="hljs-type"><span class="hljs-type">double</span></span> ySqr = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> iterations = <span class="hljs-number"><span class="hljs-number">0</span></span>; // <span class="hljs-keyword"><span class="hljs-keyword">perform</span></span> up <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the maximum number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> iterations <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> solve // the <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> <span class="hljs-type"><span class="hljs-type">point</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the image <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( xSqr + ySqr &lt; <span class="hljs-number"><span class="hljs-number">4.0</span></span> &amp;&amp;iterations &lt; maxIterations ) { // <span class="hljs-keyword"><span class="hljs-keyword">perform</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> iteration xSqr = x*x; ySqr = y*y; y = <span class="hljs-number"><span class="hljs-number">2</span></span>*x*y + y0; x = xSqr - ySqr + x0; // <span class="hljs-keyword"><span class="hljs-keyword">increment</span></span> iteration count iterations++; } // return the iteration count return iterations; }</code> </pre> <br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">int</span></span> softwareCalculateFrame( <span class="hljs-type"><span class="hljs-type">double</span></span> aStartX, <span class="hljs-type"><span class="hljs-type">double</span></span> aStartY, <span class="hljs-type"><span class="hljs-type">double</span></span> aScale, unsigned <span class="hljs-type"><span class="hljs-type">int</span></span>* aFrameBuffer ) { // <span class="hljs-keyword"><span class="hljs-keyword">temporary</span></span> pointer <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> variables unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> * fb_ptr = aFrameBuffer; unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> j, k, pixel; // <span class="hljs-keyword"><span class="hljs-keyword">window</span></span> position variables <span class="hljs-type"><span class="hljs-type">double</span></span> x = aStartX; <span class="hljs-type"><span class="hljs-type">double</span></span> y = aStartY; <span class="hljs-type"><span class="hljs-type">double</span></span> cur_x, cur_y; <span class="hljs-type"><span class="hljs-type">double</span></span> cur_step_size = aScale; // <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> pixel <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the y dimension <span class="hljs-keyword"><span class="hljs-keyword">window</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( j = <span class="hljs-number"><span class="hljs-number">0</span></span>, cur_y = y; j &lt; theHeight; j++, cur_y -= cur_step_size ) { // <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> pixel <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the x dimension <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">window</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( cur_x = x, k = <span class="hljs-number"><span class="hljs-number">0</span></span>; k&lt; theWidth; k++, cur_x += cur_step_size ) { // <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the pixel <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">window</span></span> pixel = mandel_pixel(cur_x, cur_y, theSoftColorTableSize); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( pixel == theSoftColorTableSize ) *fb_ptr++ = <span class="hljs-number"><span class="hljs-number">0x0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> *fb_ptr++ = theSoftColorTable[pixel]; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  Cada pixel √© calculado independentemente do outro e, portanto, esse processo pode ser paralelo.  Ao implementar o algoritmo para o acelerador FPGA, uma instru√ß√£o SIMD √© criada para calcular o n√∫mero de cada pixel de itera√ß√£o (determinando o c√≥digo de cores da paleta).  A implementa√ß√£o de dois loops aninhados no buffer de imagem √© enquadrada pelo OpenCL executando a opera√ß√£o (theWidth * theHeight). <br><br>  As inst√¢ncias do kernel na lista abaixo s√£o chamadas de item de trabalho e o conjunto de todas as inst√¢ncias √© chamado de espa√ßo de √≠ndice.  Os recursos da fun√ß√£o de hardware incluem o seguinte: <br><br><ul><li>  Uma declara√ß√£o de fun√ß√£o come√ßa com a palavra-chave __kernel. </li><li>  Tipo de fun√ß√£o de hardware - o tipo do valor de retorno √© sempre nulo. </li><li>  O retorno de valores √© feito atrav√©s de buffers passados ‚Äã‚Äãcomo par√¢metros. <br><ul><li>  Os tr√™s primeiros par√¢metros definem a grade do material, cujos n√≥s correspondem aos pixels da imagem de sa√≠da. </li><li>  O quarto par√¢metro limita o n√∫mero de itera√ß√µes, impedindo o loop de pontos pertencentes ao conjunto Mandelbrot. </li><li>  O quinto par√¢metro √© um ponteiro para o buffer de cores de sa√≠da. </li><li>  A palavra-chave global indica o tipo de mem√≥ria atrav√©s da qual o buffer ser√° transmitido: esta √© a mem√≥ria DDR geral (QDR) no pr√≥prio acelerador. </li><li>  A palavra-chave restringir pro√≠be o otimizador de usar refer√™ncias indiretas de buffer. </li><li>  No sexto par√¢metro, um ponteiro para a paleta √© passado. </li><li>  A palavra-chave __constant otimiza os acessos ao buffer, gerando um cache com um atributo somente leitura. </li></ul><br>  A descri√ß√£o da fun√ß√£o na listagem est√° pr√≥xima da implementa√ß√£o do processador x64.  Aqui, a defini√ß√£o da inst√¢ncia atual do kernel √© feita atrav√©s da fun√ß√£o get_global_id, na qual o n√∫mero da dimens√£o (0, 1) √© passado como par√¢metro. <br><br>  Para uma melhor otimiza√ß√£o, uma indica√ß√£o expl√≠cita do in√≠cio do ciclo foi introduzida.  Na aus√™ncia de informa√ß√µes sobre o n√∫mero de itera√ß√µes no momento da compila√ß√£o, o n√∫mero de etapas do loop √© indicado explicitamente, pois seus pr√≥prios blocos de hardware ser√£o criados para eles.  Com esse tipo de codifica√ß√£o, deve-se "olhar para tr√°s" na capacidade de um chip espec√≠fico instalado no acelerador, devido ao consumo de recursos do FPGA por um n√∫mero maior de ciclos. <br><br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ mandelbrot_kernel.cl : Hardware implementation of the mandelbrot algorithm /</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Amount of loop unrolling. #ifndef UNROLL #define UNROLL 20 #endif /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Define the color black as 0 #define BLACK 0x00000000 __kernel void hw_mandelbrot_frame ( const double x0, const double y0, const double stepSize, const unsigned int maxIterations, __global unsigned int *restrict framebuffer, __constant const unsigned int *restrict colorLUT, const unsigned int windowWidth) { /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Work-item position const size_t windowPosX = get_global_id(0); const size_t windowPosY = get_global_id(1); const double stepPosX = x0 + (windowPosX * stepSize); const double stepPosY = y0 - (windowPosY * stepSize); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Variables for the calculation double x = 0.0; double y = 0.0; double xSqr = 0.0; double ySqr = 0.0;&lt;/code</span></span>&gt; &lt;code&gt;unsigned <span class="hljs-comment"><span class="hljs-comment">#pragma while { int iterations = 0; // Perform up to the maximum number of iterations to solve // the current work-item's position in the image // The loop unrolling factor can be adjusted based on the amount of FPGA // resources available. unroll UNROLL xSqr + ySqr &lt; 4.0 &amp;&amp; iterations &lt; maxIterations ) // Perform the current iteration xSqr = x*x; ySqr = y*y; y = 2*x*y + stepPosY; x = xSqr - ySqr + stepPosX; // Increment iteration count iterations++; } // Output black if we never finished, and a color from the look up table otherwise framebuffer[windowWidth * windowPosY + windowPosX] = (iterations == maxIterations) ? BLACK : colorLUT[iterations]; }</span></span></code> </pre> <br>  O pacote de utilit√°rios Intel FPGA SDK para OpenCL precisar√° ser instalado no host antes de compilar a implementa√ß√£o de hardware do algoritmo.  Entre o software pr√©-instalado, voc√™ deve incluir o BSP (Board Support Package) do fabricante da placa aceleradora espec√≠fica.  No exemplo, o Intel Quartus Prime Pro 16.1 √© instalado com suporte para OpenCL e BSP do acelerador Euler Thread (Intel Arria 10). <br><br>  A seguir, √© apresentada a configura√ß√£o de caminhos e vari√°veis ‚Äã‚Äãde ambiente.  A vari√°vel ALTERAOCLSDKROOT cont√©m o caminho para o Intel FPGA SDK, a vari√°vel AOCL_BOARD_PACKAGE_ROOT cont√©m o caminho para o acelerador BSP. <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ALTERAOCLSDKROOT=C:\intelFPGA_pro\<span class="hljs-number"><span class="hljs-number">16.1</span></span>\hld <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> AOCL_BOARD_PACKAGE_ROOT=C:\intelFPGA_pro\<span class="hljs-number"><span class="hljs-number">16.1</span></span>\hld\board\euler_thread <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">path</span></span>=%<span class="hljs-keyword"><span class="hljs-keyword">path</span></span>%;C:\intelFPGA_pro\16.1\hld\bin <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">path</span></span>=%<span class="hljs-keyword"><span class="hljs-keyword">path</span></span>%;C:\intelFPGA_pro\16.1\quartus\bin64 <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">path</span></span>=%<span class="hljs-keyword"><span class="hljs-keyword">path</span></span>%;C:\intelFPGA_pro\16.1\hld\board\a10_ref\windows64\bin <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">path</span></span>=%<span class="hljs-keyword"><span class="hljs-keyword">path</span></span>%;C:\intelFPGA_pro\16.1\hld\host\windows64\bin <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">path</span></span>=%<span class="hljs-keyword"><span class="hljs-keyword">path</span></span>%;C:\intelFPGA_pro\16.1\qsys\bin <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">path</span></span>=%<span class="hljs-keyword"><span class="hljs-keyword">path</span></span>%;C:\Program Files (x86)\GnuWin32\bin\</code> </pre> <br>  Para compila√ß√£o, o compilador aoc do SDK √© usado. <br><br><pre> <code class="hljs powershell">aoc mandelbrot_kernel.cl <span class="hljs-literal"><span class="hljs-literal">-o</span></span> mandelbrot_kernel.aocx -<span class="hljs-literal"><span class="hljs-literal">-board</span></span> thread <span class="hljs-literal"><span class="hljs-literal">-v</span></span> <span class="hljs-literal"><span class="hljs-literal">-v</span></span> -<span class="hljs-literal"><span class="hljs-literal">-report</span></span></code> </pre> <br>  Descriptografamos: mandelbrot_kernel.cl - o arquivo com o texto de origem, mandelbrot_kernel.aocx - o arquivo de objeto de sa√≠da para programa√ß√£o de FPGA, thread - o nome do acelerador do pacote BSP.  A op√ß√£o --report exibe um relat√≥rio de uso de recursos do FPGA.  A op√ß√£o ‚Äìv exibe informa√ß√µes de diagn√≥stico durante a compila√ß√£o.  O relat√≥rio de consumo de recursos para o kernel √© o seguinte: <br><br>  + ------------------------------------------------- ------------------- + <br>  ;  Resumo de uso estimado de recursos; <br>  + ---------------------------------------- + -------- ------------------- + <br>  ;  Recurso + Uso; <br>  + ---------------------------------------- + -------- ------------------- + <br>  ;  Utiliza√ß√£o l√≥gica;  49% <br>  ;  ALUTs;  26%; <br>  ;  Registradores l√≥gicos dedicados;  25%; <br>  ;  Blocos de mem√≥ria;  21% <br>  ;  Blocos DSP;  16%; <br>  + ---------------------------------------- + -------- -------------------; <br><br>  Para compilar o aplicativo host, o exemplo usou o pacote Microsoft Visual Studio 2010 Express com o Microsoft SDK 7.1 instalado.  Nas configura√ß√µes do projeto, a configura√ß√£o para x64 √© selecionada.  Em seguida, conecte a pasta para arquivos de cabe√ßalho externos e especifique o caminho para bibliotecas adicionais do Intel FPGA SDK nas configura√ß√µes do vinculador. <br>  Diret√≥rios adicionais para incluir arquivos = $ (ALTERAOCLSDKROOT) \ host \ include; <br>  Diret√≥rios adicionais da biblioteca = $ (AOCL_BOARD_PACKAGE_ROOT) \ windows64 \ lib; <br><pre> <code class="hljs tex"><span class="hljs-formula"><span class="hljs-formula">$(ALTERAOCLSDKROOT)</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">host</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">windows</span></span></span></span></span><span class="hljs-formula">64</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">lib</span></span></span></span></span><span class="hljs-formula">;</span></span></code> </pre> <br>  O plano de a√ß√£o geral para iniciar o kernel no acelerador ser√° o seguinte: <br><br><ol><li>  Obtenha uma lista de plataformas </li><li>  Obter uma lista de dispositivos </li><li>  criar contexto; </li><li>  carregar o kernel no dispositivo; </li><li>  envie buffers de entrada para o dispositivo; </li><li>  execute o kernel para execu√ß√£o; </li><li>  leia o buffer de sa√≠da do dispositivo; </li><li>  contexto livre. </li></ol><br>  Considere alguns pontos diretamente relacionados ao lan√ßamento do kernel.  Portanto, um n√∫cleo √© projetado para processar um pixel da imagem.  Portanto, voc√™ precisa executar N inst√¢ncias do kernel, em que N √© o n√∫mero total de pixels na imagem. <br><br>  Abaixo, observamos o caso em que existem v√°rias placas aceleradoras no servidor e a tarefa pode ser distribu√≠da entre elas.  Em cada um dos aceleradores, voc√™ precisa carregar o kernel (arquivo mandelbrot_kernel.aocx).  Suponha que o n√∫mero de aceleradores seja numDevices e as linhas da imagem sejam divididas entre todos os aceleradores: <br><br><pre> <code class="hljs django"><span class="xml"><span class="xml">#define MAXDEV 10 static cl_context theContext; static cl_program theProgram; static cl_kernel theKernels[MAXDEV]; //.. // Create the program object theProgram = createProgramFromBinary( theContext, "mandelbrot_kernel.aocx", theDevices, numDevices); // Create the kernels for ( unsigned i = 0; i </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">numDevices</span></span></span></span><span class="xml"><span class="hljs-tag">; ++</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> ) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theKernels</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">] = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clCreateKernel(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theProgram</span></span></span></span><span class="xml"><span class="hljs-tag">, "</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">hw_mandelbrot_frame</span></span></span></span><span class="xml"><span class="hljs-tag">", &amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> ); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Create</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">output</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pixel</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">buffers</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">every</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">kernel</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag">( </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">numDevices</span></span></span></span><span class="xml"><span class="hljs-tag">; ++</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> ) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">thePixelData</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">] = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clCreateBuffer(theContext,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">CL_MEM_WRITE_ONLY</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">thePixelDataWidth</span></span></span></span><span class="xml"><span class="hljs-tag">*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowsPerDevice</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">]*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag">), </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">, &amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag">); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Preparing</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">and</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">writing</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">palette</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">buffer</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">to</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">every</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">device</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theHardColorTable</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clCreateBuffer(theContext,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">CL_MEM_READ_ONLY</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aColorTableSize</span></span></span></span><span class="xml"><span class="hljs-tag">*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag">), </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">, &amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag">( </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">numDevices</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">++ ) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clEnqueueWriteBuffer(theQueues[i],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theHardColorTable</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">CL_TRUE</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aColorTableSize</span></span></span></span><span class="xml"><span class="hljs-tag">*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag">), </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aColorTable</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Preparing</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">kernels</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">and</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">run</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowOffset</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag"> ( </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">numDevices</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowOffset</span></span></span></span><span class="xml"><span class="hljs-tag"> += </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">rowsPerDevice[i++]</span></span></span></span><span class="xml"><span class="hljs-tag"> ) { // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Create</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ND</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">range</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">size</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">size_t</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">globalSize</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">] = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">thePixelDataWidth</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowsPerDevice</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">] }; // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Set</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">the</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">arguments</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">argi</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clSetKernelArg</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theKernels</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">argi</span></span></span></span><span class="xml"><span class="hljs-tag">++, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cl_double</span></span></span></span><span class="xml"><span class="hljs-tag">), (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">void</span></span></span></span><span class="xml"><span class="hljs-tag">*) &amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aStartX</span></span></span></span><span class="xml"><span class="hljs-tag"> ); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">const</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">double</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">offsetedStartY</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">aStartY</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowOffset</span></span></span></span><span class="xml"><span class="hljs-tag"> * </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aScale</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clSetKernelArg(theKernels[i],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">argi</span></span></span></span><span class="xml"><span class="hljs-tag">++, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cl_double</span></span></span></span><span class="xml"><span class="hljs-tag">), (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">void</span></span></span></span><span class="xml"><span class="hljs-tag">*)&amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">offsetedStartY</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clSetKernelArg(theKernels[i],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">argi</span></span></span></span><span class="xml"><span class="hljs-tag">++, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cl_double</span></span></span></span><span class="xml"><span class="hljs-tag">), (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">void</span></span></span></span><span class="xml"><span class="hljs-tag">*)&amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aScale</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clSetKernelArg(theKernels[i],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">argi</span></span></span></span><span class="xml"><span class="hljs-tag">++, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cl_uint</span></span></span></span><span class="xml"><span class="hljs-tag">), (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">void</span></span></span></span><span class="xml"><span class="hljs-tag">*)&amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theHardColorTableSize</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clSetKernelArg(theKernels[i],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">argi</span></span></span></span><span class="xml"><span class="hljs-tag">++, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cl_mem</span></span></span></span><span class="xml"><span class="hljs-tag">), (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">void</span></span></span></span><span class="xml"><span class="hljs-tag">*)&amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">thePixelData</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">]); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clSetKernelArg(theKernels[i],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">argi</span></span></span></span><span class="xml"><span class="hljs-tag">++, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cl_mem</span></span></span></span><span class="xml"><span class="hljs-tag">), (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">void</span></span></span></span><span class="xml"><span class="hljs-tag">*)&amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theHardColorTable</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clSetKernelArg(theKernels[i],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">argi</span></span></span></span><span class="xml"><span class="hljs-tag">++, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cl_uint</span></span></span></span><span class="xml"><span class="hljs-tag">), (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">void</span></span></span></span><span class="xml"><span class="hljs-tag">*)&amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theWidth</span></span></span></span><span class="xml"><span class="hljs-tag">); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Launch</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">kernel</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clEnqueueNDRangeKernel(theQueues[i],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theKernels</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">globalSize</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">); } </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowOffset</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag">( </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">numDevices</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowOffset</span></span></span></span><span class="xml"><span class="hljs-tag"> += </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">rowsPerDevice[i++]</span></span></span></span><span class="xml"><span class="hljs-tag"> ) { // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Read</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">the</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">output</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clEnqueueReadBuffer(theQueues[i],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">thePixelData</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">CL_TRUE</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">thePixelDataWidth</span></span></span></span><span class="xml"><span class="hljs-tag">*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowsPerDevice</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">]*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag">), &amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aFrameBuffer</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowOffset</span></span></span></span><span class="xml"><span class="hljs-tag"> * </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theWidth</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">); } / / </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span></span></span></span></code> </pre><br><ul><li>  A fun√ß√£o createProgramFromBinary cria um objeto de programa OpenCL a partir de um arquivo de objeto. </li><li>  Em seguida, para cada dispositivo, um kernel √© criado com base no objeto do programa. </li><li>  Os buffersPixelData s√£o criados para receber a sa√≠da de cada n√∫cleo. </li><li>  Um buffer √© criado para armazenar a paleta de cores e carregado em cada um dos aceleradores. </li><li>  Em seguida, para cada dispositivo, a liga√ß√£o dos par√¢metros locais do aplicativo e dos par√¢metros do kernel √© definida usando a fun√ß√£o clSetKernelArg. </li><li>  Os par√¢metros s√£o determinados pelos n√∫meros de s√©rie na declara√ß√£o da fun√ß√£o do kernel, come√ßando do zero. </li></ul><br>  O pr√≥ximo ponto importante √© determinar o tamanho da tarefa com base no espa√ßo do √≠ndice de acordo com a matriz globalSize.  Essa matriz pode ser unidimensional, bidimensional ou tridimensional.  Para cada dimens√£o, uma dimens√£o √© fornecida como um n√∫mero inteiro.  A dimens√£o do espa√ßo determinar√° a ordem do √≠ndice do item de trabalho no kernel. <br><br>  No exemplo, para cada n√∫cleo, √© especificado um espa√ßo bidimensional, em que um dos eixos s√£o os elementos da linha de pixels, o segundo √© o conjunto de linhas de imagem processadas neste dispositivo.  No c√≥digo do kernel, o n√∫mero de pixels na linha √© obtido chamando get_global_id (0), o n√∫mero da linha √© get_global_id (1).  A vari√°vel globalSize √© passada para a fun√ß√£o clEnqueueNDRangeKernel para iniciar o n√∫mero necess√°rio de inst√¢ncias do kernel a serem executadas. <br><br>  Ap√≥s a conclus√£o da execu√ß√£o dos n√∫cleos, os buffers de pixel s√£o lidos do dispositivo para matrizes locais.  Vamos avaliar o desempenho pelo n√∫mero de quadros por segundo - o resultado √© vis√≠vel na demonstra√ß√£o realizada na confer√™ncia SelectelTechDay ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">consulte o in√≠cio do artigo</a> ). <br><br><h2>  Conclus√£o </h2><br>  A programa√ß√£o de aceleradores FPGA em uma linguagem de alto n√≠vel sem d√∫vida reduziu o limiar para os desenvolvedores acessarem essa tecnologia.  Por exemplo, para aqueles que est√£o apenas dominando este kit de ferramentas, h√° at√© uma implementa√ß√£o em FPGA do famoso exemplo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="noopener noreferrer">"Hello World"</a> . <br><br>  Mas n√£o √© t√£o simples.  Escrever - e especialmente - depurar um algoritmo claramente funcional de um problema real aplicado ainda requer alto profissionalismo.  Outra limita√ß√£o √© que cada chip FPGA pode executar apenas uma tarefa computacional dentro do aplicativo.  Para outra tarefa, ela deve ser reprogramada novamente. <br><blockquote>  A prop√≥sito, o modelo de uso da plataforma permite que voc√™ tenha mais de um acelerador FPGA no host, embora essa seja uma solu√ß√£o bastante cara. <br>  O host (aplicativo host) gerencia o processo de cria√ß√£o do contexto (estrutura de dados para o acelerador) e a fila de comandos.  I.e.  Um √∫nico aplicativo host, no qual existem v√°rias subtarefas para computa√ß√£o paralela no FPGA, pode carreg√°-las em diferentes aceleradores: <br>  KERNEL1 =&gt; ACELERADOR A <br>  KERNEL2 =&gt; ACELERADOR B </blockquote><br>  No entanto, os esfor√ßos para dominar os aceleradores FPGA valem a pena - em muitas √°reas de aplica√ß√£o, essa tecnologia est√° se tornando indispens√°vel: telecomunica√ß√µes, biotecnologia, processamento de big data, reconhecimento de padr√µes, processamento de sinais e imagens, em matem√°tica computacional e modelagem de campos f√≠sicos. <br><br>  Informa√ß√µes adicionais para o artigo: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="noopener noreferrer">www.altera.com</a> √© o principal recurso do Intel FPGA. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="noopener noreferrer">www.eulerproject.com</a> √© o site oficial do Projeto Euler. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="noopener noreferrer">Altera + OpenCL: programamos em FPGA sem o conhecimento de VHDL / Verilog</a> - um artigo sobre Habr. <br><cut></cut></li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt418403/">https://habr.com/ru/post/pt418403/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt418393/index.html">[Sexta-feira] Como serramos 3D na Web</a></li>
<li><a href="../pt418395/index.html">Elon Musk: geradores locais de campo eletromagn√©tico proteger√£o colonos em Marte</a></li>
<li><a href="../pt418397/index.html">Gerenciamento de sexta-feira: Webinars gratuitos do Skillbox</a></li>
<li><a href="../pt418399/index.html">Na onda da Selectel FM</a></li>
<li><a href="../pt418401/index.html">Como eu n√£o me tornei voc√™: um post de amor para administradores de sistemas</a></li>
<li><a href="../pt418405/index.html">O princ√≠pio da pir√¢mide invertida na an√°lise. Criamos um painel compreens√≠vel</a></li>
<li><a href="../pt418407/index.html">A minera√ß√£o em nuvem Hashflare foi fechada. O dinheiro n√£o volta</a></li>
<li><a href="../pt418411/index.html">Atirador de rede do navegador no Node.js</a></li>
<li><a href="../pt418415/index.html">O Telegram lan√ßou seu pr√≥prio servi√ßo de passaporte para verifica√ß√£o e autoriza√ß√£o de usu√°rios</a></li>
<li><a href="../pt418417/index.html">Apollo: 9 meses - voo normal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>