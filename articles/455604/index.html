<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèº‚Äçüöí üë©üèæ‚Äç‚úàÔ∏è üÜí Ansible para administrar la configuraci√≥n de Windows. Historia de √©xito üë©üèª‚Äçüåæ üëºüèΩ ‚è≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En una de las reuniones de la comunidad St.Net .Net de desarrolladores de la comunidad SpbDotNet, realizamos un experimento y decidimos hablar sobre c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ansible para administrar la configuraci√≥n de Windows. Historia de √©xito</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/veeam/blog/455604/"><p>  En una de las reuniones de la comunidad St.Net .Net de desarrolladores de la comunidad SpbDotNet, realizamos un experimento y decidimos hablar sobre c√≥mo puede aplicar enfoques que se han convertido en est√°ndar en el mundo Linux para automatizar las infraestructuras de Windows.  Pero para no llevar todo al punto de marcar el marcador Ansible, se decidi√≥ mostrar esto con el ejemplo de implementaci√≥n de una aplicaci√≥n ASP.Net. </p><br><p>  Aleksey Chernov, Desarrollador Senior del equipo que desarrolla la biblioteca de componentes de UI para nuestros proyectos, se ofreci√≥ como orador.  Y s√≠, no te pareci√≥: un desarrollador de JavaScript se present√≥ frente a una audiencia .Net. </p><br><p>  Cualquiera que est√© interesado en el resultado de tal experimento, bienvenido, bajo el corte para decodificar. </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/nEA3sSE33U4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><a name="habracut"></a><br><p>  Hola) Ya se han echado a perder un poco aqu√≠ y han dicho que soy front-end, por lo que ya pueden divergir =) Mi nombre es Alexey, he estado haciendo todo tipo de cosas sobre desarrollo web durante bastante tiempo.  Comenc√© con Perl, luego estaba PHP, un peque√±o RoR, un poco, un poco de eso.  Y luego JavaScript irrumpi√≥ en mi vida, y desde entonces he estado haciendo casi todo esto. </p><br><p>  Adem√°s de JS, √∫ltimamente he estado escribiendo bastantes autotests (adem√°s, en el mismo JS) y, por lo tanto, tengo que lidiar con la automatizaci√≥n del despliegue de bancos de pruebas y la infraestructura para ellos. </p><br><p>  <strong>Antecedentes</strong> </p><br><p>  Hace dos a√±os, termin√© en Veeam, donde est√°n desarrollando productos para Windows.  En ese momento me sorprendi√≥ mucho, pero result√≥ que sucede =).  Pero, sobre todo, me sorprendi√≥ el nivel inusualmente bajo de automatizaci√≥n de todo lo relacionado con la implementaci√≥n, la implementaci√≥n de aplicaciones, las pruebas, etc. </p><br><p>  Nosotros, los que estamos desarrollando para Linux, nos hemos acostumbrado al hecho de que todo deber√≠a estar en Docker, hay Kubernetes, y todo se desarrolla con un solo clic.  Y cuando termin√© en un entorno donde todo esto no est√° all√≠, me sorprendi√≥.  Y cuando comenc√© a hacer pruebas autom√°ticas, me di cuenta de que esto era solo un 20% de √©xito, y todo lo dem√°s estaba preparando la infraestructura para ellos. </p><br><p><img src="https://habrastorage.org/webt/5v/rm/ca/5vrmcacwrpdrkb1dejapgmjzfqa.png"><br>  <em>Mis sentimientos al principio</em> </p><br><p>  <strong>Condiciones actuales</strong> </p><br><p>  Te contar√© un poco sobre c√≥mo se arregla todo con nosotros, qu√© tenemos que automatizar y qu√© hacemos. </p><br><p> Tenemos un mont√≥n de productos diferentes, la mayor√≠a de ellos bajo Windows, hay varios bajo Linux e incluso algo bajo Solaris.  Se recopilan muchas compilaciones diariamente para todos los productos.  En consecuencia, es necesario implementarlo todo en los laboratorios de prueba, tanto para el control de calidad como para los propios desarrolladores, para que puedan verificar la integraci√≥n de la aplicaci√≥n.  Todo esto requiere una gran infraestructura de muchos servidores de hierro y m√°quinas virtuales.  Y a veces hacemos pruebas de rendimiento, cuando necesitamos levantar de inmediato mil m√°quinas virtuales y ver qu√© tan r√°pido funcionar√°n nuestras aplicaciones. </p><br><p>  <strong>Los problemas</strong> </p><br><p>  Por supuesto, en las primeras etapas (leer, hace mucho tiempo), cuando intentaba automatizar todo de frente, se usaba PowerShell.  La herramienta es poderosa, pero los scripts de implementaci√≥n son extremadamente complicados.  Otro problema fue la falta de gesti√≥n centralizada de este proceso.  Algunos scripts fueron ejecutados localmente por desarrolladores, algunos en m√°quinas virtuales creadas en la era de los mamuts, etc.  Como resultado: fue dif√≠cil obtener un solo resultado y comprender qu√© funciona y qu√© no.  Vienes a trabajar, abres el navegador: el servidor no est√° disponible.  Por qu√© no est√° disponible, qu√© sucedi√≥, d√≥nde se rompi√≥, no estaba completamente claro.  No hab√≠a un √∫nico punto de entrada, y ten√≠a que buscar la verdad en las salas de chat en funcionamiento, y es bueno que alguien responda. </p><br><p>  Otro problema, no tan obvio, son los novatos.  Fue dif√≠cil para ellos.  La primera semana de trabajo, solo profundizaron en lo que estaba sucediendo.  Habitualmente viv√≠amos con esto, asegur√°ndonos a nosotros mismos que la vida es algo dif√≠cil y que debemos soportarlo.  Para comprender y perdonar, por as√≠ decirlo. </p><br><p>  Pero en alg√∫n momento encontraron la fuerza interior para superarlo y mirar a su alrededor.  Probablemente de alguna manera puedes manejarlo. </p><br><p><img src="https://habrastorage.org/webt/kg/ra/io/kgraiod0cirwgawpngochydtu2e.png"><br>  <em>El primer paso para resolver el problema es aceptarlo.</em> </p><br><p>  <strong>Selecci√≥n de soluciones</strong> </p><br><p>  Cuando no sabes qu√© hacer, mira lo que otros est√°n haciendo. </p><br><p>  Y para empezar, hicimos nuestra lista de requisitos para lo que queremos obtener al final. </p><br><ul><li>  C√≥digo de base unificado.  Todos los scripts de implementaci√≥n deben estar en el mismo lugar.  Desea implementar algo o ver c√≥mo se desarrolla: aqu√≠ hay un repositorio para usted, vaya all√≠. </li><li>  Todos saben c√≥mo funciona.  Las preguntas deber√≠an desaparecer a la "No entiendo c√≥mo implementarlo, as√≠ que el segundo d√≠a no puedo cerrar el error". </li><li>  Posibilidad de comenzar por bot√≥n.  Necesitamos poder controlar las implementaciones.  Por ejemplo, alg√∫n tipo de interfaz web, donde vayas, presionas un bot√≥n, y el producto deseado se implementa en el host deseado. </li></ul><br><p>  Despu√©s de asegurarnos de que esta lista cubra el m√≠nimo de requisitos necesarios y suficientes para nuestra felicidad, comenzamos a intentarlo.  Tradicionalmente, lo primero que intentaron resolver problemas fue el m√©todo de ataque frontal.  ¬øTenemos muchos scripts de PowerShell?  As√≠ que combin√©moslos en un solo repositorio.  Pero el problema no es que haya demasiados guiones, sino que diferentes equipos hicieron lo mismo con diferentes guiones.  Camin√© por diferentes equipos, escuch√© sus requisitos, recopil√© los mismos scripts, intent√© peinarlos y parametrizarlos de alguna manera, y luego los puse en un solo repositorio. </p><br><p>  <strong>Fallo: el</strong> intento fall√≥.  En primer lugar, comenzamos a discutir mucho sobre por qu√© estamos haciendo esto y no de esa manera.  ¬øPor qu√© se utiliz√≥ este m√©todo, y no otro, etc.  Y como resultado, hab√≠a muchos que quer√≠an rehacer todo "como deber√≠a", en el principio de "Voy a bifurcar y reescribir todo por usted".  Y, por supuesto, no ser√° posible combinar ramas con este enfoque. </p><br><p>  Intento n√∫mero dos: se supon√≠a que deb√≠a tomar nuestro servidor CI (TeamCity), hacer algunas plantillas y, utilizando la herencia, cerrar el problema principal desde el primer intento.  Pero, como habr√°s adivinado de inmediato, <strong>Fail</strong> tambi√©n nos <strong>estaba</strong> esperando <strong>:</strong> puedes usar la plantilla solo para la √∫ltima versi√≥n, lo que significa que no lograremos las versiones necesarias.  Y la consecuencia de una gran cantidad de equipos: las plantillas se volvieron muy numerosas, se hizo m√°s dif√≠cil administrarlas y en el horizonte era claramente visible un nuevo pantano. </p><br><p><img src="https://habrastorage.org/webt/10/mb/ai/10mbain0xddl-fwxwkvtmebrl-i.png"></p><br><p>  Cansado de caer boca abajo en cualquier intento de despegar, se decidi√≥ volver a sentarse y pensar mucho.  Entonces, tenemos una gran cantidad de scripts ps por un lado y una gran cantidad de virtuales por el otro.  Pero nos equivocamos, porque  esa no era la ra√≠z del problema.  El problema era que siempre hab√≠a una persona entre estas cosas.  No importa si se trata de un desarrollador, un probador u otra persona, la siguiente cadena l√≥gica siempre ha ocurrido en la cabeza: </p><br><ul><li>  Entonces, necesito una m√°quina virtual para las pruebas </li><li>  S√≠, aqu√≠ tenemos un grupo de servidores. </li><li>  Y aqu√≠ est√° el script que necesito, ahora lo ejecutar√© y todo suceder√° </li></ul><br><p>  Con la realizaci√≥n de algo aparentemente tan simple, el problema general comenz√≥ a jugar con nuevos colores.  Result√≥ que todos nuestros dolores son por la falta de una descripci√≥n √∫nica de nuestra infraestructura.  Estaba en la mente de las personas que lo crearon, se sentaron en diferentes departamentos, no buscaron documentarlo de alguna manera y, en general, cada uno vivi√≥ en su propio estado. <br>  En este momento, llegamos a la conclusi√≥n de que la respuesta a todos nuestros problemas es: </p><br><p>  <strong>Infraestructura como c√≥digo</strong> </p><br><p>  Es precisamente que toda nuestra infraestructura debe describirse en c√≥digo y depositarse en el repositorio.  Todas las m√°quinas virtuales, todos sus par√°metros, todo lo que est√° instalado all√≠, todo debe describirse en el c√≥digo. </p><br><p>  Surge una pregunta leg√≠tima: ¬øpor qu√©? </p><br><p>  Respondemos: este enfoque nos dar√° la oportunidad de aplicar las mejores pr√°cticas del mundo del desarrollo, al que todos estamos tan acostumbrados: </p><br><ul><li>  Control de versiones.  Siempre podemos entender qu√© y cu√°ndo ha cambiado.  No m√°s anfitriones saliendo de la nada o ido a ninguna parte.  Siempre estar√° claro qui√©n hizo los cambios. </li><li>  Revisi√≥n de c√≥digo.  Podremos controlar los procesos de implementaci√≥n para que algunos no infrinjan a otros. </li><li>  Integraci√≥n continua. </li></ul><br><p>  <strong>Selecci√≥n de herramienta</strong> </p><br><p>  Como todos sabemos, hay muchas herramientas de administraci√≥n de configuraci√≥n.  Optamos por Ansible, porque contiene un conjunto de caracter√≠sticas que necesitamos. <br>  En primer lugar, queremos que el sistema de automatizaci√≥n no ejecute ning√∫n instalador, algo para migrar a alg√∫n lado, etc.  En primer lugar, desde ese sistema queremos que despu√©s de presionar un bot√≥n veamos la interfaz de usuario de la aplicaci√≥n que necesitamos. </p><br><p>  Por lo tanto, la caracter√≠stica clave para nosotros es la idempotencia.  Ansible no importa lo que pas√≥ antes.  Despu√©s de comenzar el libro de jugadas deseado, siempre obtenemos el mismo resultado.  Esto es muy importante cuando dices no "Instalar IIS", sino "Debe haber IIS", y no tienes que pensar si estuvo all√≠ antes o no.  Es muy dif√≠cil lograr esto con los guiones, y los libros de jugadas de Ansible brindan esa oportunidad. </p><br><p>  Tambi√©n vale la pena mencionar la falta de agente de Ansible.  La mayor√≠a de los sistemas de automatizaci√≥n funcionan a trav√©s de agentes.  Hay muchas ventajas en esto, por ejemplo, el mejor rendimiento, pero era importante para nosotros que no hubiera un agente para que el sistema no tuviera que estar preparado de alguna manera adicional. </p><br><p>  PowerShell: </p><br><pre><code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$url</span></span> = <span class="hljs-string"><span class="hljs-string">"http://buildserver/build.msi"</span></span> <span class="hljs-variable"><span class="hljs-variable">$output</span></span> = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$PSSscriptRoot</span></span></span><span class="hljs-string">\build.msi"</span></span> Invoke-WebRequest -Uri <span class="hljs-variable"><span class="hljs-variable">$url</span></span> -OutFile <span class="hljs-variable"><span class="hljs-variable">$output</span></span></code> </pre> <br><p>  Ansible: </p><br><pre> <code class="bash hljs">name: Download build hosts: all tasks: name: Download installer win_get_url: url: <span class="hljs-string"><span class="hljs-string">"http://buildserver/build.msi"</span></span> dest: <span class="hljs-string"><span class="hljs-string">"build.msi"</span></span> force: no</code> </pre> <br><p>  Aqu√≠ vemos que en el ejemplo b√°sico, el script ps ser√° a√∫n m√°s conciso que el libro de jugadas de Ansible.  3 l√≠neas de gui√≥n versus 7 l√≠neas de libro de jugadas para descargar un archivo. </p><br><p>  Pero, Petka, hay un matiz (s).  Tan pronto como queramos observar el principio de idempotencia y, por ejemplo, asegurarnos de que el archivo en el servidor no haya cambiado y no necesite descargarlo, deber√° implementar una solicitud HEAD en el script, que agrega aproximadamente 200 l√≠neas.  Y en el libro de jugadas, uno.  El m√≥dulo Ansible win_get_url, que realiza todas las comprobaciones por usted, contiene 257 l√≠neas de c√≥digo que no tiene que insertar en cada secuencia de comandos. </p><br><p>  Y este es solo un ejemplo de una tarea muy simple. </p><br><p><img src="https://habrastorage.org/webt/ca/tz/el/catzel2r3lxpzk_yaz0moo6s-c0.png"></p><br><p>  Y si lo piensas, necesitamos idempotencia en todas partes: </p><br><ul><li>  Verificar la existencia de una m√°quina virtual.  En el caso de los scripts, corremos el riesgo de producir un n√∫mero infinito de ellos, o el script se bloquear√° al principio. </li><li>  ¬øQu√© paquetes msi hay en la m√°quina?  En el mejor de los casos, aqu√≠ no caer√° nada; en el peor de los casos, la m√°quina dejar√° de funcionar adecuadamente. </li><li>  ¬øTengo que volver a descargar artefactos de compilaci√≥n?  Es bueno si tus construcciones pesan una docena de megabytes.  ¬øY los que tienen un par de gigabytes? </li></ul><br><p>  Y otros ejemplos, donde la salida es inflar scripts con ramificaciones interminables de ifs que no se pueden depurar adecuadamente e imposibles de administrar. </p><br><p>  Entre otras cosas que son importantes para nosotros, Ansible no utiliza agentes para administrar sus hosts y m√°quinas.  En Linux, por supuesto, se ejecuta en ssh, mientras que en Windows se usa WinRM.  De ah√≠ la consecuencia obvia: Ansible es multiplataforma.  Admite una cantidad fant√°stica de plataformas, hasta equipos de red. </p><br><p>  Y el √∫ltimo, pero no menos importante, es el formato de grabaci√≥n de configuraci√≥n YAML.  Todos est√°n acostumbrados, es f√°cil de leer y es f√°cil darse cuenta de lo que est√° sucediendo all√≠. </p><br><p>  Pero no todo es tan dulce, hay problemas: </p><br><ul><li>  El problema es dudoso: para ejecutar libros de jugadas, a√∫n necesita una m√°quina Linux, incluso si toda su infraestructura es exclusivamente Windows.  Aunque este no es un gran problema en el mundo moderno, porque  en Windows 10 ahora hay WSL, donde puedes ejecutar Ubuntu, bajo el cual manejar playbooks. </li><li>  A veces, los libros de jugadas son realmente dif√≠ciles de depurar.  Ansible est√° escrito en python, y lo √∫ltimo que quiero ver es una hoja de pila de pila de python de cinco pantallas.  Y un error tipogr√°fico en el nombre del m√≥dulo </li></ul><br><p>  <strong>Como funciona</strong> <br>  Primero, necesitamos una m√°quina Linux.  En la terminolog√≠a de Ansible, esto se llama la m√°quina de control. <br>  Los libros de jugadas comenzar√°n a partir de √©l, y toda la magia sucede en √©l. </p><br><p>  En esta m√°quina necesitaremos: </p><br><ul><li>  Python y el administrador de paquetes python pip.  Muchas distribuciones tienen fuera de la caja, por lo que no hay sorpresas aqu√≠. </li><li>  Instale Ansible a trav√©s de pip, como la forma m√°s universal: pip install ansible </li><li>  Agregue un m√≥dulo winrm para ir a m√°quinas Windows: pip install pywinrm [credssp] </li><li>  Y en las m√°quinas que queremos controlar, necesitamos habilitar winrm, porque  Est√° desactivado por defecto.  Hay muchas formas de hacer esto, y todas se describen en la documentaci√≥n de Ansible.  Pero lo m√°s simple es tomar la secuencia de comandos finalizada del repositorio de Ansible y ejecutarla con la opci√≥n de autorizaci√≥n requerida: ConfigureRemotingForAnsible.ps1 -EnableCredSSP </li></ul><br><p>  La parte m√°s importante que necesit√°bamos para dejar de sufrir con los scripts ps era Inventory.  Un archivo YAML (en nuestro caso), que describe nuestra infraestructura y d√≥nde siempre puede mirar para entender d√≥nde se implementa.  Y, por supuesto, los propios libros de jugadas.  En el futuro, el trabajo parece lanzar un libro de jugadas con el archivo de inventario necesario y par√°metros adicionales. </p><br><pre> <code class="bash hljs">all: children: webservers: hosts: spbdotnet-test-host.dev.local: dbservers: hosts: spbdotnet-test-host.dev.local: vars: ansible_connection: winrm ansible_winrm_transport: credssp ansible_winrm_server_cert_validation: ignore ansible_user: administrator ansible_password: 123qweASD</code> </pre> <br><p>  Aqu√≠ todo es simple: el grupo ra√≠z es todos y dos subgrupos, servidores web y servidores de base de datos.  Todo lo dem√°s es intuitivo, pero llamar√© su atenci√≥n sobre el hecho de que Ansible por defecto cree que Linux est√° en todas partes, por lo que para Windows debe especificar winrm y el tipo de autorizaci√≥n. </p><br><p>  Por supuesto, no necesita almacenar la contrase√±a de forma clara en el libro de jugadas, aqu√≠ hay solo un ejemplo.  Las contrase√±as se pueden almacenar, por ejemplo, en Ansible-Vault.  Usamos TeamCity para esto, que pasa secretos a trav√©s de variables de entorno y no dispara nada. </p><br><p>  <strong>M√≥dulos</strong> </p><br><p>  Todo lo que Ansible hace, lo hace con la ayuda de m√≥dulos.  Los m√≥dulos para Linux est√°n escritos en python, para Windows en PowerShell.  Y una reverencia por la idempotencia: el resultado del m√≥dulo siempre viene en forma de un archivo json, que indica si ha habido cambios en el host o no. </p><br><p>  En el caso general, ejecutaremos una construcci√≥n de la lista de m√≥dulos de archivo de inventario de grupo de host ansible del formulario: </p><br><p><img src="https://habrastorage.org/webt/dt/ww/s7/dtwws7ix1i1k1jqbtpp0cnowrus.png"></p><br><p>  <strong>Libros de jugadas</strong> </p><br><p>  Un libro de jugadas es una descripci√≥n de c√≥mo y d√≥nde ejecutaremos los m√≥dulos Ansible. </p><br><pre> <code class="bash hljs">- name: Install AWS CLI hosts: all vars: aws_cli_download_dir: c:\downloads aws_cli_msi_url: https://s3.amazonaws.com/aws-cli/AWSCLI32PY3.msi tasks: - name: Ensure target directory exists win_file: path: <span class="hljs-string"><span class="hljs-string">"{{ aws_cli_download_dir }}"</span></span> state: directory - name: Download installer win_get_url: url: <span class="hljs-string"><span class="hljs-string">"{{ aws_cli_msi_url }}"</span></span> dest: <span class="hljs-string"><span class="hljs-string">"{{ aws_cli_download_dir }}\\awscli.msi"</span></span> force: no - name: Install AWS CLI win_package: path: <span class="hljs-string"><span class="hljs-string">"{{ aws_cli_download_dir }}\\awscli.msi"</span></span> state: present</code> </pre> <br><p>  En este ejemplo, tenemos tres tareas.  Cada tarea es una llamada de m√≥dulo.  En este libro de jugadas, primero creamos un directorio (nos aseguramos de que exista), luego descargamos la AWS CLI all√≠ e lo instalamos utilizando el m√≥dulo win_packge. </p><br><p>  Al ejecutar este libro de jugadas, obtenemos este resultado. </p><br><p><img src="https://habrastorage.org/webt/ga/2x/sd/ga2xsdh7zgvlxvioliy_g3ijkxo.png"></p><br><p>  El informe muestra que cuatro tareas se completaron con √©xito y tres de las cuatro realizaron algunos cambios en el host. </p><br><p>  Pero, ¬øqu√© sucede si vuelves a ejecutar este libro de jugadas?  No hemos escrito en ning√∫n lugar que debamos crear el directorio, descargar el archivo instalador y ejecutarlo.  Simplemente verificamos la disponibilidad de cada art√≠culo y omitimos si est√° disponible. </p><br><p><img src="https://habrastorage.org/webt/8m/ro/de/8mrodes1ld9oocapp3qhnypwkcw.png"></p><br><p>  Esta es la idempotencia que no podr√≠amos lograr con PowerShell. </p><br><p>  <strong>Practica</strong> </p><br><p>  Este es un ejemplo ligeramente simplificado, pero, en principio, esto es exactamente lo que hacemos todos los d√≠as. <br>  Implementaremos una aplicaci√≥n que consta de un servicio de Windows y una aplicaci√≥n web bajo IIS. </p><br><pre> <code class="bash hljs">- name: Setup App hosts: webservers tasks: - name: Install IIS win_feature: name: - Web-Server - Web-Common-Http include_sub_features: True include_management_tools: True state: present register: win_feature - name: reboot <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> installing Web-Server feature requires it win_reboot: when: win_feature.reboot_required</code> </pre> <br><p>  Primero, necesitamos ver si hay alg√∫n IIS en el host e instalarlo si no.  Y ser√≠a bueno agregar de inmediato herramientas de administraci√≥n y todas las funciones dependientes.  Y es muy bueno si el host se reinicia si es necesario. </p><br><p>  La primera tarea que resolvemos es el m√≥dulo win_feature, que se dedica a administrar las funciones de Windows.  Y aqu√≠ por primera vez tenemos las variables de entorno Ansible, en el elemento de registro.  ¬øRecuerdas que dije que las tareas siempre devuelven un objeto json?  Ahora, despu√©s de completar la tarea Instalar IIS, la salida del m√≥dulo win_feature se encuentra en la variable win_feature (disc√∫lpeme por la tautolog√≠a). </p><br><p>  En la siguiente tarea, llamaremos al m√≥dulo win_reboot.  Pero no necesitamos reiniciar nuestro servidor cada vez.  Lo volveremos a cargar solo si el m√≥dulo win_feature nos devuelve este requisito en forma de variable. </p><br><p>  El siguiente paso es instalar SQL.  Ya se han inventado un mill√≥n de formas para hacer esto.  Estoy usando el m√≥dulo win_chocolatey aqu√≠.  Este es un administrador de paquetes para Windows.  S√≠, eso es exactamente a lo que estamos tan acostumbrados en Linux.  Los m√≥dulos son compatibles con la comunidad, y ahora ya hay m√°s de seis mil de ellos.  Te recomiendo encarecidamente que lo intentes. </p><br><pre> <code class="bash hljs">- name: SQL Server hosts: dbservers tasks: - name: Install MS SQL Server 2014 win_chocolatey: name: mssqlserver2014express state: present</code> </pre> <br><p>  Entonces, preparamos el host para iniciar la aplicaci√≥n, ¬°implem√©ntelo! </p><br><pre> <code class="plaintext hljs">- name: Deploy binaries hosts: webservers vars: myapp_artifacts: files/MyAppService.zip myapp_workdir: C:\myapp tasks: - name: Remove Service if exists win_service: name: MyAppService state: absent path: "{{ myapp_workdir }}\\MyAppService.exe"</code> </pre> <br><p>  Por si acaso, lo primero que hacemos es eliminar el servicio existente. </p><br><pre> <code class="plaintext hljs">- name: Delete old files win_file: path: "{{ myapp_workdir }}\\" state: absent - name: Copy artifacts to remote machine win_copy: src: "{{ myapp_artifacts }}" dest: "{{ myapp_workdir }}\\" - name: Unzip build artifacts win_unzip: src: "{{ myapp_workdir }}\\MyAppService.zip" dest: "{{ myapp_workdir }}"</code> </pre> <br><p>  El siguiente paso es cargar nuevos artefactos en el host.  Este libro de jugadas implica que se ejecuta en un servidor de compilaci√≥n, todos los archivos est√°n en una carpeta conocida e indicamos la ruta a ellos con variables.  Despu√©s de copiar (win_copy), los archivos se desempaquetan (win_unzip).  Luego solo registramos el servicio, decimos la ruta a exe y que deber√≠a iniciarse. </p><br><pre> <code class="plaintext hljs"> - name: Register and start the service win_service: name: ReporterService start_mode: auto state: started path: "{{ myapp_workdir }}\\MyAppService.exe"</code> </pre> <br><p>  <strong>Listo?</strong> </p><br><p>  Parece que nuestro servicio est√° listo para el trabajo y la defensa, sin embargo, hay un "pero": no observamos el principio de idempotencia.  Siempre eliminamos el c√≥digo existente y luego implementamos el nuevo. </p><br><p>  Y ese es el problema.  Si eliminamos el antiguo servicio fuera de servicio, y despu√©s de que ocurriera alg√∫n tipo de error y el libro de jugadas no completara su trabajo, obtendremos un host roto.  O, por ejemplo, implementamos varias aplicaciones al mismo tiempo, de las cuales una no ha cambiado, entonces no necesitamos implementarla tambi√©n. </p><br><p>  Que se puede hacer  Alternativamente, puede verificar la suma de verificaci√≥n de nuestros artefactos y compararlos con los del servidor. </p><br><pre> <code class="plaintext hljs"> - name: Get arifacts checksum stat: path: "{{ myapp_artifacts }}" delegate_to: localhost register: myapp_artifacts_stat - name: Get remote artifacts checksum win_stat: path: "{{ myapp_workdir }}\\MyAppService.zip" register: myapp_remote_artifacts_stat</code> </pre> <br><p>  Utilizamos el m√≥dulo stat, que proporciona todo tipo de informaci√≥n sobre archivos, incluida la suma de verificaci√≥n.  Luego, usando el registro de directivas familiar, escribimos el resultado en una variable.  De interesante: delegate_to indica que esto debe hacerse en la m√°quina local donde se inicia el libro de jugadas. </p><br><pre> <code class="plaintext hljs"> - name: Stop play if checksums match meta: end_play when: - myapp_artifacts_stat.stat.checksum is defined - myapp_remote_artifacts_stat.stat.checksum is defined - myapp_artifacts_stat.stat.checksum == myapp_remote_artifacts_stat.stat.checksum</code> </pre> <br><p>  Y con la ayuda del metam√≥dulo, decimos que necesitamos terminar el libro de jugadas si las sumas de verificaci√≥n de los artefactos en las m√°quinas locales y remotas coinciden.  As√≠ es como observamos el principio de idempotencia. </p><br><pre> <code class="plaintext hljs"> - name: Ensure that the WebApp application exists win_iis_webapplication: name: WebApp physical_path: c:\webapp site: Default Web Site state: present</code> </pre> <br><p>  Ahora echemos un vistazo a nuestra aplicaci√≥n web.  Omitimos la parte sobre la copia de archivos, vamos directamente al grano.  Nuestro servidor de compilaci√≥n cre√≥ el editor, carg√≥ todos los archivos sueltos en el host y us√≥ el m√≥dulo incorporado para trabajar con aplicaciones IIS.  Crear√° la aplicaci√≥n y la ejecutar√°. </p><br><p>  <strong>Reutilizaci√≥n de c√≥digo</strong> </p><br><p>  Una de las tareas que establecimos fue: permitir que cualquier ingeniero de la empresa inicie f√°cilmente una implementaci√≥n.  Escribe su libro de jugadas a partir de m√≥dulos listos para usar, dice que necesita ejecutar tal o cual producto en tal y tal host. </p><br><p>  Para esto, Ansible tiene roles.  Esto es esencialmente una convenci√≥n.  Creamos una carpeta / roles / en el servidor y ponemos nuestros roles en √©l.  Cada rol es un conjunto de archivos de configuraci√≥n: una descripci√≥n de nuestros dispositivos, variables, archivos de servicio, etc.  Por lo general, una entidad aislada hace un papel.  Instalar IIS es un gran ejemplo si necesitamos no solo instalarlo, sino tambi√©n configurarlo de alguna manera o verificarlo con tareas adicionales.  Hacemos un rol separado y, por lo tanto, aislamos todos los libros de jugadas relacionados con IIS en la carpeta de roles.  En el futuro, simplemente llamamos a este rol con la directiva include_role% role_name%. </p><br><p>  Naturalmente, creamos roles para todas las aplicaciones, dejando a los ingenieros la oportunidad de personalizar de alguna manera el proceso utilizando par√°metros de configuraci√≥n. </p><br><pre> <code class="plaintext hljs">- name: Run App hosts: webservers tasks: - name: "Install IIS" include_role: name: IIS - name: Run My App include_role: name: MyAppService vars: myapp_artifacts: ./buld.zip</code> </pre> <br><p>  En este ejemplo, la funci√≥n Ejecutar mi aplicaci√≥n tiene la capacidad de transferir alguna ruta a artefactos. </p><br><p>  Aqu√≠ tiene que poner una palabra sobre Ansible Galaxy, un repositorio de soluciones est√°ndar com√∫nmente disponibles.  Como es habitual en una sociedad decente, muchos problemas ya se han resuelto ante nosotros.  Y si existe la sensaci√≥n de que ahora comenzaremos a reinventar la rueda, primero debe mirar la lista de m√≥dulos integrados y luego profundizar en Ansible Galaxy.  Es probable que el libro de jugadas que necesita ya haya sido creado por otra persona.  Hay una gran cantidad de m√≥dulos all√≠, para todas las ocasiones. </p><br><p>  <strong>Mayor flexibilidad</strong> </p><br><p>  Pero, ¬øqu√© pasa si no hay un m√≥dulo incorporado o una funci√≥n adecuada en Galaxy?  Hay dos opciones: o estamos haciendo algo mal, o realmente tenemos una tarea √∫nica. </p><br><p>  En el caso de la segunda opci√≥n, siempre podemos escribir nuestro m√≥dulo.  Como te mostr√© al principio, Ansible hace posible escribir el m√≥dulo m√°s simple en literalmente 10 minutos, y cuando profundizas, te ayuda una documentaci√≥n bastante detallada que cubre muchas preguntas. </p><br><p>  <strong>Ci</strong> <br>  En nuestro departamento, realmente amamos TeamCity, pero puede haber cualquier otro servidor de CI que elija.  ¬øPor qu√© necesitamos compartirlos? </p><br><p>  En primer lugar, siempre podemos verificar la sintaxis de nuestros libros de jugadas.  Si bien YAML considera que las pesta√±as son un error de sintaxis, esta es una caracter√≠stica muy √∫til. </p><br><p>  Tambi√©n en el servidor CI ejecutamos ansible-lint.  Este es un analizador est√°tico de configuraciones ansibles, que ofrece una lista de recomendaciones. </p><br><p><img src="https://habrastorage.org/webt/mc/rf/ks/mcrfks9tz2igullrdgqeedqkyim.png"></p><br><p>  Por ejemplo, aqu√≠ dice que tenemos un espacio extra al final de la l√≠nea, y para una tarea no se da ning√∫n nombre.  Esto es importante porque  el nombre del m√≥dulo puede aparecer varias veces en el mismo libro de jugadas y todas las tareas deben nombrarse. </p><br><p>  Por supuesto, a√∫n puede escribir pruebas para libros de jugadas.  Podemos permitirnos no hacer esto porque  implementaremos en el entorno de prueba y no suceder√° nada cr√≠tico.  Pero si se implementa en el producto, ser√≠a mejor verificarlo todo.  El beneficio de ansible le permite probar no solo libros de jugadas, sino tambi√©n m√≥dulos individuales.  As√≠ que aseg√∫rese de prestarle atenci√≥n. </p><br><p>  Y la segunda raz√≥n principal para usar el servidor CI es lanzar playbooks.  Este es el mismo bot√≥n m√°gico "Hacer bien", que nos da TeamCity.  Simplemente creamos algunas configuraciones simples para diferentes productos, donde decimos: ansible-playbook reporter_vm.yml -i Inventory.yml -vvvv y obtenemos el bot√≥n Implementar. </p><br><p>  Comodidad adicional: puede construir compilaciones dependiendo de las compilaciones.  Tan pronto como algo se ha consolidado, TeamCity comienza el proceso de reimplementaci√≥n, despu√©s de lo cual solo podemos mirar los registros si algo se rompe repentinamente. </p><br><p>  <strong>Total</strong> </p><br><ul><li>  Scripts de PowerShell confusos y dispares que reemplazamos con configuraciones YAML. </li><li>  Reemplazamos varias implementaciones de los mismos problemas con roles comunes que pueden reutilizarse.  Se ha creado un repositorio donde se encuentran los roles.  Si el rol te conviene, solo util√≠zalo.  Si no le conviene, simplemente env√≠e la solicitud de grupo, y le conviene =) </li><li>  Ahora puede verificar el √©xito de la implementaci√≥n en un solo lugar. </li><li>  Todos saben d√≥nde buscar registros. </li><li>  Los problemas de comunicaci√≥n tambi√©n se resolvieron a trav√©s de un repositorio com√∫n y TeamCity.  Todas las personas interesadas saben d√≥nde est√°n los libros de jugadas y c√≥mo funcionan. </li></ul><br><p>  PD Todos los ejemplos del art√≠culo se pueden tomar en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/455604/">https://habr.com/ru/post/455604/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../455594/index.html">Microsoft Edge de CVE a RCE en Windows 10</a></li>
<li><a href="../455596/index.html">DevConfX :: Gesti√≥n - informes de gerentes en palabras simples</a></li>
<li><a href="../455598/index.html">Actualice urgentemente Exim a 4.92: hay una infecci√≥n activa</a></li>
<li><a href="../455600/index.html">La plataforma 3DEXPERIENCE ayuda a crear el transporte p√∫blico del futuro</a></li>
<li><a href="../455602/index.html">Provocar bloqueos del navegador con fuzzing conductual</a></li>
<li><a href="../455606/index.html">Aprendizaje autom√°tico y an√°lisis de datos: programa de maestr√≠a en la Escuela Superior de Econom√≠a de San Petersburgo</a></li>
<li><a href="../455608/index.html">√çndices de mapa de bits en Go: velocidad de b√∫squeda incre√≠ble</a></li>
<li><a href="../455610/index.html">El legendario Intel Core i7-2600K: prueba de Sandy Bridge en 2019 (parte 1)</a></li>
<li><a href="../455612/index.html">Pensamos a trav√©s de los personajes de los juegos y los di√°logos siguiendo los consejos de los escritores y el ejemplo de los partidarios de la teor√≠a de una Tierra plana.</a></li>
<li><a href="../455614/index.html">FFI: escribir en Rust en un programa PHP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>