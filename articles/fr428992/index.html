<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçÑ üë®üèª‚Äçüé§ üõ≥Ô∏è Contournement s√©lectif des verrous sur les routeurs avec le firmware Padavan et Keenetic OS ü§ì üë®üèæ‚Äçüéì üòæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Un grand nombre d'instructions ont √©t√© publi√©es avec diverses options pour contourner le blocage des ressources Internet. Mais le sujet ne perd pas de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Contournement s√©lectif des verrous sur les routeurs avec le firmware Padavan et Keenetic OS</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/428992/"> Un grand nombre d'instructions ont √©t√© publi√©es avec diverses options pour contourner le blocage des ressources Internet.  Mais le sujet ne perd pas de sa pertinence.  Plus souvent encore, des initiatives sont entendues au niveau l√©gislatif pour bloquer les articles sur les m√©thodes de contournement des serrures.  Et il y avait des rumeurs selon lesquelles Roskomnadzor recevrait un autre paquet d'argent des contribuables pour de "meilleures" serrures.  Les utilisateurs exp√©riment√©s n'apprendront rien de nouveau ou d'utile de l'article.  Mais d'autres recevront des instructions √©tape par √©tape pr√©d√©finies pour un contournement s√©lectif simple et efficace des verrous sur les routeurs populaires avec le firmware Padavan et Keenetic. <br><br><img src="https://habrastorage.org/webt/is/kb/td/iskbtdxuaisqiyg3r4tsrjhj6aw.jpeg"><br><a name="habracut"></a><br><h1>  Table des mati√®res </h1><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Pr√©sentation</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Comment allez-vous r√©ussir √† contourner les verrous apr√®s la configuration?</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Principe de fonctionnement</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Configuration d'un routeur Padavan</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Configuration d'un routeur avec Keenetic OS</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">M√©thodes de base pour diagnostiquer les erreurs apr√®s la configuration</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Contournement suppl√©mentaire pour filtrer les requ√™tes DNS par le fournisseur</a> </li></ul><br><a name="con1"></a><h1>  Pr√©sentation </h1><br>  J'ai utilis√© l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">option de contournement de verrouillage</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Zolg</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pendant</a> environ deux ans.  De nombreuses instructions sur le r√©seau sont bas√©es sur celui-ci.  Le mien inclus. <br><br>  Tout √©tait bien, mais "le meilleur est toujours l'ennemi du bien".  Premi√®rement, certains nouveaux programmes sont devenus trop ¬´intelligents¬ª et r√©soudront les domaines en utilisant leurs propres m√©thodes, contournant le serveur DNS du routeur.  Cela ne permet pas √† dnsmasq sur le routeur d'ajouter l'adresse √† l'ensemble ipset pour le d√©verrouillage et conduit √† un r√©sultat logique - la ressource reste verrouill√©e.  Dans Android 9, prise en charge native de DNS sur TLS, c'est-√†-dire  cette m√©thode de contournement du verrou cesse de fonctionner (si l'autre p√©riph√©rique n'a pas acc√©d√© √† dnsmasq auparavant).  Deuxi√®mement, la mise √† jour de la liste compl√®te des domaines depuis antizapret conduit √† des r√©sultats impr√©visibles √† chaque fois.  La liste peut inclure des domaines qui ne sont pas vraiment bloqu√©s et dont le fonctionnement est important via le canal principal.  Vous devez √™tre constamment en alerte et modifier les fichiers g√©n√©r√©s avec vos mains.  Troisi√®mement, je suis fatigu√© de "tra√Æner" une √©norme liste de domaines avec des dizaines de milliers de casinos et autres, qui ne sont tout simplement pas n√©cessaires.  Au fil du temps, j'ai r√©alis√© que je n'avais besoin que d'une petite liste sp√©cifique de ressources bloqu√©es. <br><br>  Donc, depuis un an, j'utilise une m√©thode de d√©verrouillage l√©g√®rement modifi√©e, dont je suis enti√®rement satisfait: <br><br><ul><li>  Simplicit√© et facilit√© de contr√¥le (apr√®s configuration). </li><li>  Contr√¥le total sur les ressources dont vous avez besoin pour d√©bloquer. </li><li>  Configuration minimale requise pour les ressources processeur et la RAM du routeur. </li><li>  Large couverture des nuances lors du contournement des verrous. </li></ul><br>  Il est important de noter que mon option n'est pas destin√©e au cas o√π vous devez d√©verrouiller des centaines et des milliers de domaines.  Parce que lorsque le routeur d√©marre, chaque domaine de la liste donn√©e est r√©solu.  Plus il y a de domaines dans la liste, plus l'initialisation de nombreux ipsets √† d√©bloquer est longue. <br><br>  La base pour contourner les verrous est la m√™me - le r√©seau Tor.  Son utilisation est due √† deux facteurs simples - gratuits, et la probabilit√© que Tor soit bloqu√© en Russie est proche de z√©ro, contrairement √† tout service VPN.  Tor est le fondement du trafic de drogue en Russie du milieu vers le bas.  Le verrouillage de Tor conduira √† la recherche de nouveaux outils pour le march√© et √† une diminution de l'anonymat, ce qui entra√Ænera l'activation r√©ussie du travail des services r√©pressifs locaux.  En fin de compte, cela, comme un virus, commencera √† affecter n√©gativement le lien sup√©rieur.  Compte tenu des derni√®res nouvelles √©tonnantes sur la relation des hauts responsables du gouvernement avec le trafic mondial de drogue en Russie, le blocage de Tor en Russie n'est qu'un tabou, bien qu'il soit trivial.  Ni Roskomnadzor, quel que soit le nombre de milliards allou√©s √† cette agence, aucun tribunal russe n'a la permission d'en haut pour bloquer Tor.  Et cela ne surprend m√™me personne et n'effraie personne, m√™me si la Russie se noie simplement dans la drogue (tout √©colier sait ce que √ßa va faire, et apr√®s 30 minutes, il est en fait possible dans n'importe quelle ville de 10 000 habitants de se procurer librement des drogues pratiquement en toute quantit√© - une si mauvaise v√©rit√© de la vie).  Dans le mode actuel, la probabilit√© de bloquer le r√©seau Tor est inf√©rieure √† la probabilit√© de bloquer le site du mus√©e de l'Ermitage. <br><br>  Les instructions donn√©es sont faciles √† adapter pour les routeurs avec OpenWrt.  De plus, de petits changements facilitent le remplacement de Tor par OpenVPN. <br><br><a name="con11"></a><h1>  Comment allez-vous r√©ussir √† contourner les verrous apr√®s la configuration? </h1><br>  Tout est tr√®s simple.  Vous avez le fichier /opt/etc/unblock.txt - une liste simple √† d√©verrouiller.  Vous pouvez d√©verrouiller un domaine, une adresse IP, une plage d'adresses ou un CIDR.  Une ligne - un √©l√©ment.  Les lignes vides sont autoris√©es et vous pouvez utiliser le caract√®re # au d√©but de la ligne pour ignorer. <br><br><div class="spoiler">  <b class="spoiler_title">Voici un exemple de mon dossier personnel</b> <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">###- rutracker.org rutor.info rutor.is mega-tor.org kinozal.tv nnm-club.me nnm-club.ws tfile.me tfile-home.org tfile1.cc megatfile.cc megapeer.org megapeer.ru tapochek.net tparser.org tparser.me rustorka.com uniongang.tv fast-torrent.ru ###    rezka.ag hdrezka.ag hdrezka.me filmix.co filmix.cc seasonvar.ru ### lib.rus.ec flibusta.is flibs.me flisland.net flibusta.site ### telegram.org tdesktop.com tdesktop.org tdesktop.info tdesktop.net telesco.pe telegram.dog telegram.me t.me telegra.ph web.telegram.org desktop.telegram.org updates.tdesktop.com venus.web.telegram.org flora.web.telegram.org vesta.web.telegram.org pluto.web.telegram.org aurora.web.telegram.org 149.154.160.0/20 91.108.4.0/22 91.108.8.0/22 91.108.12.0/22 91.108.16.0/22 91.108.56.0/22 109.239.140.0/24 67.198.55.0/24 ### 7-zip.org edem.tv 4pna.com 2019.vote ### Tor check.torproject.org ###   IP ( #   ) #195.82.146.214 ###   CIDR ( #   ) #103.21.244.0/22 ###    ( #   ) #100.100.100.200-100.100.100.210</span></span></code> </pre> <br></div></div><br>  Apr√®s avoir √©dit√© ce fichier, vous ex√©cutez simplement la commande pour appliquer la nouvelle configuration: <br><br><pre> <code class="bash hljs">unblock_update.sh</code> </pre> <br>  Toutes les ressources de unblock.txt sont d√©verrouill√©es sans avoir √† red√©marrer le routeur. <br><br><a name="con12"></a><h1>  Principe de fonctionnement </h1><br><ul><li>  L'initialisation du routeur cr√©e un ensemble vide d'adresses IP ipset appel√© d√©bloquer. </li><li>  Une r√®gle pour rediriger tous les paquets avec des destinations de d√©blocage vers le service Tor est ajout√©e au pare-feu. </li><li>  Le service Tor d√©marre en mode proxy transparent. </li><li>  Le script sp√©cial unblock_ipset.sh est lanc√©, qui r√©sout tous les domaines de unblock.txt et ajoute leurs adresses IP √† l'ensemble de d√©blocage.  Les adresses IP, les plages et les CIDR de ce fichier sont √©galement ajout√©s pour d√©bloquer. </li><li>  Dnsmasq est lanc√© avec un fichier de configuration suppl√©mentaire, unblock.dnsmasq, qui indique l'ajout d'adresses IP de domaine de unblock.txt √† l'ensemble de d√©blocage lors de la r√©solution. </li><li>  cron ex√©cute unblock_ipset.sh avec une certaine fr√©quence pour compenser partiellement les √©ventuels cas avec des nuances. </li><li>  Si n√©cessaire, tous les domaines de unblock.txt (et seulement eux) se r√©solvent via dnscrypt-proxy si le fournisseur filtre le DNS. </li></ul><br><a name="con2"></a><h1>  Configuration d'un routeur Padavan </h1><br>  Vous devez avoir un routeur avec le firmware Padavan install√© et un gestionnaire de packages Entware d√©j√† configur√©.  Sous Windows, vous pouvez utiliser le client <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PuTTY</a> pour vous connecter au routeur via SSH. <br><br>  Assurez-vous que vous utilisez Entware, pas l'ancien Entware-ng.  Affichez le contenu du dossier / opt / var / opkg-lists.  Il y aura un fichier entware ou entware-ng.  Dans le second cas, vous devez mettre √† jour le firmware Padavan de votre routeur vers la derni√®re version et r√©installer le gestionnaire de packages Entware.  Ensuite, continuez avec les instructions √©tape par √©tape. <br><br>  Comme l'ont montr√© les critiques, des probl√®mes surviennent principalement pour ceux qui ont configur√© Entware incorrectement au d√©part (c'est-√†-dire que les scripts d'init.d ne sont pas charg√©s) dans la m√©moire interne du routeur.  Si vous avez Xiaomi Mi Router 3 ou 3G, et que vous n'√™tes pas s√ªr que Entware dans votre m√©moire interne fonctionne correctement (d√©marrage automatique), alors r√©installez tout.  Prenez PROMETHEUS.  Met √† jour le script (1).  Mettez √† jour le code source (2).  R√©cup√©rez et flashez le firmware le plus r√©cent (4).  R√©initialiser les param√®tres du firmware (NVRAM et stockage de fichiers) - Avanc√©&gt; Administration&gt; Param√®tres.  Configurez l'acc√®s Internet sur le routeur et activez SSH.  Effectuez dans PROMETHEUS Firmware&gt; Formatage RWFS.  Choisissez Avanc√©&gt; Administration&gt; Param√®tres&gt; Monter le syst√®me de fichiers dans la section R / W&gt; UBIFS.  Red√©marrez le routeur.  Tous les scripts de d√©marrage Entware actuels de la m√©moire interne seront enregistr√©s automatiquement et tout fonctionnera comme une horloge. <br><br>  Pour les tests, j'ai utilis√© le populaire Xiaomi Mi Router 3G (Entware est install√© dans la m√©moire interne) avec le dernier firmware - 32a93db.  Tout fonctionnera m√™me sur le l√©gendaire b√©b√© WT3020 AD / F / H pour 10 $. <br><br><img src="https://habrastorage.org/webt/th/kf/2k/thkf2kvtt2rhtnbxvmx0qri7dsk.jpeg"><br><br><h3>  1. Installation du logiciel n√©cessaire sur le routeur </h3><br><pre> <code class="bash hljs">opkg update opkg install mc tor tor-geoip <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span>-dig cron</code> </pre> <br>  <b>mc</b> - Gestionnaire de fichiers Midnight Commander.  Il n'est n√©cessaire qu'en raison de l'√©diteur mcedit pratique.  Si vous avez l'habitude d'utiliser un autre √©diteur de texte, alors mc ne peut pas √™tre install√©. <br>  <b>tor</b> - Service Tor. <br>  <b>tor-geoip</b> - base de donn√©es g√©o-IP pour Tor. <br>  <b>bind-dig</b> - client DNS (analogue de nslookup et h√¥te). <br>  <b>cron</b> - planificateur de t√¢ches. <br><cut></cut><br><h3>  2. Initialisez l'ipset, cr√©ez plusieurs adresses IP de d√©blocage (start_script.sh) </h3><br>  Connectez les modules n√©cessaires et cr√©ez un ensemble d'adresses vide avec le nom <b>d√©bloquer au</b> d√©marrage du routeur.  Pour ce faire, ouvrez le fichier <b>/etc/storage/start_script.sh</b> dans l'√©diteur: <br><br><pre> <code class="bash hljs">mcedit /etc/storage/start_script.sh</code> </pre> <br>  Ajouter √† la fin: <br><br><pre> <code class="bash hljs">modprobe ip_set modprobe ip_set_hash_ip modprobe ip_set_hash_net modprobe ip_set_bitmap_ip modprobe ip_set_list_set modprobe xt_set ipset create unblock <span class="hljs-built_in"><span class="hljs-built_in">hash</span></span>:net</code> </pre> <br>  Pour coller √† partir du tampon, utilisez Shift + Insert, enregistrez - F2, quittez - F10. <br><br><img src="https://habrastorage.org/webt/tr/zp/cq/trzpcqqnadbonhsb0x3ebe7ltpo.png"><br><br>  Si vous le souhaitez, vous pouvez modifier le fichier start_script.sh via l'interface Web du routeur - "Avanc√©"&gt; "Personnalisation"&gt; "Scripts"&gt; "Ex√©cuter avant d'initialiser le routeur".  Apr√®s la modification, cliquez sur "Appliquer". <br><br><img src="https://habrastorage.org/webt/yr/aa/8q/yraa8qgcfwu-vesrp3wvvne2vui.png"><br><br><h3>  3. Configuration de Tor </h3><br>  Supprimez le contenu du fichier de configuration Tor: <br><br><pre> <code class="bash hljs">cat /dev/null &gt; /opt/etc/tor/torrc</code> </pre> <br>  Ouvrez le fichier de configuration Tor: <br><br><pre> <code class="bash hljs">mcedit /opt/etc/tor/torrc</code> </pre> <br>  Collez (Maj + Ins√©rer) le contenu: <br><br><pre> <code class="bash hljs">User admin PidFile /opt/var/run/tor.pid ExcludeExitNodes {RU},{UA},{AM},{KG},{BY} StrictNodes 1 TransPort 192.168.0.1:9141 ExitRelay 0 ExitPolicy reject *:* ExitPolicy reject6 *:* GeoIPFile /opt/share/tor/geoip GeoIPv6File /opt/share/tor/geoip6 DataDirectory /opt/var/lib/tor</code> </pre> <br>  Si n√©cessaire, remplacez <b>192.168.0.1</b> par l'adresse interne de votre routeur (LAN).  Br√®ve description de la configuration: <br><br><ul><li>  Exclure les n≈ìuds de sortie: Russie, Ukraine, Arm√©nie Kirghizistan, B√©larus. </li><li>  Accrochez un proxy transparent √† l'adresse 192.168.0.1, port 9141. </li><li>  Refuser d'√™tre un point de sortie. </li></ul><br><h3>  4. La liste des domaines (et pas seulement) pour contourner le verrou (unblock.txt) </h3><br>  unblock.txt est une liste simple √† d√©verrouiller.  Vous pouvez d√©verrouiller un domaine, une adresse IP, une plage ou un CIDR.  Une ligne - un √©l√©ment.  Les lignes vides (y compris les espaces et les tabulations) sont ignor√©es.  Vous pouvez utiliser le caract√®re # au d√©but d'une ligne pour l'ignorer. <br><br>  Cr√©ez le fichier <b>/opt/etc/unblock.txt</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/etc/unblock.txt</code> </pre> <br>  Chaque ligne peut contenir un nom de domaine, une adresse IP, une plage ou un CIDR.  Vous pouvez utiliser le caract√®re # pour commenter les lignes. <br><br><div class="spoiler">  <b class="spoiler_title">Voici un exemple de mon dossier personnel</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">###- rutracker.org rutor.info rutor.is mega-tor.org kinozal.tv nnm-club.me nnm-club.ws tfile.me tfile-home.org tfile1.cc megatfile.cc megapeer.org megapeer.ru tapochek.net tparser.org tparser.me rustorka.com uniongang.tv fast-torrent.ru ###    rezka.ag hdrezka.ag hdrezka.me filmix.co filmix.cc seasonvar.ru ### lib.rus.ec flibusta.is flibs.me flisland.net flibusta.site ### telegram.org tdesktop.com tdesktop.org tdesktop.info tdesktop.net telesco.pe telegram.dog telegram.me t.me telegra.ph web.telegram.org desktop.telegram.org updates.tdesktop.com venus.web.telegram.org flora.web.telegram.org vesta.web.telegram.org pluto.web.telegram.org aurora.web.telegram.org 149.154.160.0/20 91.108.4.0/22 91.108.8.0/22 91.108.12.0/22 91.108.16.0/22 91.108.56.0/22 109.239.140.0/24 67.198.55.0/24 ### 7-zip.org edem.tv 4pna.com 2019.vote ### Tor check.torproject.org ###   IP ( #   ) #195.82.146.214 ###   CIDR ( #   ) #103.21.244.0/22 ###    ( #   ) #100.100.100.200-100.100.100.210</span></span></code> </pre> <br></div></div><br><h3>  5. Un script pour remplir un ensemble d'adresses IP de d√©blocage d'une liste donn√©e de domaines (unblock_ipset.sh) </h3><br>  Cr√©ez le script <b>/opt/bin/unblock_ipset.sh</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_ipset.sh</code> </pre> <br>  Collez (Maj + Ins√©rer) le contenu: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh until ADDRS=$(dig +short google.com @localhost) &amp;&amp; [ -n "$ADDRS" ] &gt; /dev/null 2&gt;&amp;1; do sleep 5; done while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue cidr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/[0-9]{1,2}') if [ ! -z "$cidr" ]; then ipset -exist add unblock $cidr continue fi range=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}-[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$range" ]; then ipset -exist add unblock $range continue fi addr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$addr" ]; then ipset -exist add unblock $addr continue fi dig +short $line @localhost | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | awk '{system("ipset -exist add unblock "$1)}' done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br>  Donner des droits d'ex√©cution: <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_ipset.sh</code> </pre> <br>  Le script est assez simple, c'est l'essence m√™me de son travail ... Nous attendons que la r√©solution du domaine google.com fonctionne (si ce n'est pas fait, beaucoup de d√©blocages ne seront pas effectu√©s au d√©marrage du routeur, car le routeur sera toujours en cours d'initialisation).  Nous lisons les lignes du fichier unblock.txt.  Les lignes de lecture suppriment automatiquement les espaces et les tabulations au d√©but et √† la fin.  √âvitez les lignes vides.  Ignorez les lignes commen√ßant par le caract√®re #.  Nous cherchons dans la ligne CIDR.  Si CIDR est trouv√©, ajoutez-le pour d√©bloquer.  Nous recherchons une gamme dans la cha√Æne.  S'il est trouv√©, ajoutez-le pour d√©bloquer.  Nous recherchons l'adresse IP dans la cha√Æne.  Si l'IP est trouv√©e, ajoutez-la pour d√©bloquer.  R√©solvons une ligne en creusant.  Toutes les adresses IP du r√©sultat sont ajout√©es au d√©blocage. <br><br><h3>  6. Un script pour g√©n√©rer un fichier de configuration dnsmasq suppl√©mentaire √† partir d'une liste donn√©e de domaines (unblock_dnsmasq.sh) </h3><br>  Cr√©ez le script <b>/opt/bin/unblock_dnsmasq.sh</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_dnsmasq.sh</code> </pre> <br>  Collez (Maj + Ins√©rer) le contenu: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh cat /dev/null &gt; /opt/etc/unblock.dnsmasq while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue echo $line | grep -Eq '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' &amp;&amp; continue echo "ipset=/$line/unblock" &gt;&gt; /opt/etc/unblock.dnsmasq done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br>  Donner des droits d'ex√©cution: <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_dnsmasq.sh</code> </pre> <br>  Le script est assez simple, c'est l'essence de son travail ... Nous lisons s√©quentiellement les lignes de /opt/etc/unblock.txt.  Les lignes de lecture suppriment automatiquement les espaces et les tabulations au d√©but et √† la fin.  √âvitez les lignes vides.  √âvitez les lignes qui commencent par #.  Nous sautons les lignes qui contiennent l'adresse IP (IP, plage, CIDR), c'est-√†-dire  nous ne sommes int√©ress√©s que par les cha√Ænes avec des noms de domaine.  Dans le fichier /opt/etc/unblock.dnsmasq nous ajoutons des lignes de la forme "ipset = / nom_domaine / d√©bloquer".  Cela signifie qu'apr√®s avoir d√©termin√© les adresses IP d'un domaine particulier, elles seront automatiquement ajout√©es √† l'ensemble de d√©blocage. <br><br>  Assurez-vous d'ex√©cuter le script pour g√©n√©rer le fichier unblock.dnsmasq: <br><br><pre> <code class="bash hljs">unblock_dnsmasq.sh</code> </pre> <br>  V√©rifiez que le fichier unblock.dnsmasq est cr√©√©: <br><br><pre> <code class="bash hljs">cat /opt/etc/unblock.dnsmasq</code> </pre> <br><h3>  7. Le script de mise √† jour forc√©e manuelle du syst√®me apr√®s avoir √©dit√© la liste des domaines (unblock_update.sh) </h3><br>  Cr√©ez le script <b>/opt/bin/unblock_update.sh</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_update.sh</code> </pre> <br>  Collez (Maj + Ins√©rer) le contenu: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh ipset flush unblock /opt/bin/unblock_dnsmasq.sh restart_dhcpd sleep 3 /opt/bin/unblock_ipset.sh &amp;</span></span></code> </pre> <br>  Donner des droits d'ex√©cution: <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_update.sh</code> </pre> <br><h3>  8. Script pour remplir automatiquement un ensemble de d√©blocage lors du d√©marrage d'un routeur (S99unblock) </h3><br>  Cr√©ez le script <b>/opt/etc/init.d/S99unblock</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/etc/init.d/S99unblock</code> </pre> <br>  Collez (Maj + Ins√©rer) le contenu: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh [ "$1" != "start" ] &amp;&amp; exit 0 /opt/bin/unblock_ipset.sh &amp;</span></span></code> </pre><br>  Donner des droits d'ex√©cution: <br><br><pre> <code class="bash hljs">chmod +x /opt/etc/init.d/S99unblock</code> </pre> <br><h3>  9. Transfert de paquets avec des destinations de d√©blocage √† Tor (post_iptables_script.sh) </h3><br>  Ouvrez le fichier <b>/etc/storage/post_iptables_script.sh</b> dans l'√©diteur: <br><br><pre> <code class="bash hljs">mcedit /etc/storage/post_iptables_script.sh</code> </pre> <br>  Ajouter √† la fin: <br><br><pre> <code class="bash hljs">iptables -t nat -A PREROUTING -i br0 -p tcp -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set unblock dst -j REDIRECT --to-port 9141</code> </pre> <br><img src="https://habrastorage.org/webt/af/u2/dl/afu2dld3v0nrhtjwfekvo6i-wsi.png"><br><br>  Si vous le souhaitez, vous pouvez modifier le fichier post_iptables_script.sh via l'interface Web du routeur - "Avanc√©"&gt; "Personnalisation"&gt; "Scripts"&gt; "Ex√©cuter apr√®s red√©marrage des r√®gles de pare-feu".  Apr√®s la modification, cliquez sur "Appliquer". <br><br><img src="https://habrastorage.org/webt/pv/be/ot/pvbeotspo0xhzrukgp3dgvu5aws.png"><br><br>  Vous pouvez ajouter (c'est facultatif) au m√™me fichier pour rediriger toutes les demandes vers le port externe 53 vers vous-m√™me.  Cela est n√©cessaire pour que les clients du r√©seau local n'utilisent pas de services DNS tiers.  Les demandes passeront par le serveur DNS standard. <br><br><pre> <code class="bash hljs">iptables -t nat -I PREROUTING -i br0 -p udp --dport 53 -j DNAT --to 192.168.0.1 iptables -t nat -I PREROUTING -i br0 -p tcp --dport 53 -j DNAT --to 192.168.0.1</code> </pre> <br>  Si n√©cessaire, remplacez <b>192.168.0.1</b> par l'adresse interne de votre routeur (LAN). <br><br><h3>  10. Connexion d'un fichier de configuration suppl√©mentaire √† dnsmasq </h3><br>  Nous devons connecter le fichier unblock.dnsmasq cr√©√© √† dnsmasq.  Pour ce faire, ouvrez le fichier <b>/etc/storage/dnsmasq/dnsmasq.conf</b> dans l'√©diteur: <br><br><pre> <code class="bash hljs">mcedit /etc/storage/dnsmasq/dnsmasq.conf</code> </pre> <br>  Ajouter √† la fin: <br><br><pre> <code class="bash hljs">conf-file=/opt/etc/unblock.dnsmasq</code> </pre> <br>  Si vous le souhaitez (ceci est facultatif), vous pouvez ajouter un serveur suppl√©mentaire pour la r√©solution et la fiabilit√©: <br><br><pre> <code class="bash hljs">server=8.8.8.8</code> </pre> <br>  Si vous le souhaitez, vous pouvez modifier le fichier dnsmasq.conf via l'interface Web du routeur - "Avanc√©"&gt; "LAN"&gt; "Serveur DHCP"&gt; "Fichier de configuration utilisateur dnsmasq.conf".  Apr√®s la modification, cliquez sur "Appliquer". <br><br><img src="https://habrastorage.org/webt/x0/ar/4c/x0ar4cm6v9pgsluqabh74qck-s0.png"><br><br><h3>  11. Ajout d'une t√¢che √† cron pour mettre √† jour p√©riodiquement le contenu de l'ensemble de d√©blocage </h3><br>  Il s'agit d'une assurance suppl√©mentaire si les programmes / appareils utilisent leur propre m√©thode de r√©solution et si l'adresse IP du domaine a chang√©.  Il vous suffit d'ex√©cuter le script unblock_ipset.sh √† la fr√©quence souhait√©e.  Par exemple, nous lancerons tous les jours √† 6 heures du matin. <br><br>  Remplacez le nom racine par admin dans le fichier de configuration cron: <br><br><pre> <code class="bash hljs">sed -i <span class="hljs-string"><span class="hljs-string">'s/root/admin/g'</span></span> /opt/etc/crontab</code> </pre> <br>  Ouvrez le fichier <b>/ opt / etc / crontab</b> dans l'√©diteur: <br><br><pre> <code class="bash hljs">mcedit /opt/etc/crontab</code> </pre> <br>  Ajouter √† la fin: <br><br><pre> <code class="bash hljs">00 06 * * * admin /opt/bin/unblock_ipset.sh</code> </pre> <br>  Si vous le souhaitez, vous pouvez commenter toutes les autres t√¢ches du mod√®le.  Voici √† quoi ressemblera votre fichier crontab: <br><br><img src="https://habrastorage.org/webt/hf/lb/fc/hflbfcv04lpvzlrjmehoc3l51ts.png"><br><br><h3>  12. Red√©marrage du routeur </h3><br>  Ex√©cutez la commande: <br><br><pre> <code class="bash hljs">reboot</code> </pre> <br>  Apr√®s le red√©marrage, ouvrez le site Web check.torproject.org dans votre navigateur (il doit √™tre ajout√© √† unblock.txt).  Si vous avez tout fait correctement, vous verrez l'inscription ¬´F√©licitations.  Ce navigateur est configur√© pour utiliser Tor. ": <br><br><img src="https://habrastorage.org/webt/wa/19/dz/wa19dzxbu8qtldwrvkeijfqna7q.png"><br><br><br><a name="con3"></a><h1>  Configuration d'un routeur avec Keenetic OS </h1><br>  Vous devez disposer d'un routeur Keenetic / Zyxel avec Entware Package Manager (OPKG) d√©j√† configur√©.  Par exemple, voici une liste de certains routeurs qui prennent en charge Entware: Keenetic II, Keenetic III, Extra, Extra II, Giga II, Giga III, Omni, Omni II, Viva, Ultra, Ultra II, Omni (KN-1410), Extra (KN -1710), Giga (KN-1010), Ultra (KN-1810), Viva (KN-1910), DSL (KN-2010), Duo (KN-2110).  Les instructions pour configurer Entware peuvent √™tre trouv√©es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> (jusqu'√† 10 points). <br><br>  Si auparavant (avec un firmware sous 2.07) vous avez d√©j√† ajout√© la prise en charge Entware, assurez-vous que vous <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utilisez l'Entware-ng obsol√®te</a> . <br><br>  Assurez-vous d'activer "Modules du noyau du sous-syst√®me Netfilter" - Param√®tres g√©n√©raux&gt; Modifier le jeu de composants.  S'il ne figure pas dans la liste de ceux disponibles, essayez d'abord d'installer le composant de protocole IPv6.  Si apr√®s cela n'appara√Æt pas, essayez sans cela, mais il y a une forte probabilit√© que vous ne puissiez pas d√©verrouiller par plage et CIDR (car il n'y aura pas de support pour le hash: net set). <br><br><img src="https://habrastorage.org/webt/vv/dh/hi/vvdhhirhcktuefrgbxh3fkx5i0i.png"><br><br>  Pour les tests, j'ai utilis√© Keenetic Ultra (KN-1810) avec le dernier firmware - 2.14.C.0.0-4. <br><br>  <u>Remarque importante.</u>  <u>Vous devrez d√©sactiver le serveur DNS standard dans le syst√®me, nous utiliserons plut√¥t dnsmasq.</u>  <u>Vous perdrez la possibilit√© d'attribuer des services DNS (Yandex.DNS / SkyDNS / AdGuard DNS) individuellement aux clients, mais vous pouvez les utiliser globalement via les param√®tres dnsmasq si n√©cessaire.</u> <br><br><h3>  1. Installation du logiciel n√©cessaire sur le routeur </h3><br><pre> <code class="bash hljs">opkg update opkg install mc tor tor-geoip <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span>-dig cron dnsmasq-full ipset iptables</code> </pre> <br>  <b>mc</b> - Gestionnaire de fichiers Midnight Commander.  Il n'est n√©cessaire qu'en raison de l'√©diteur mcedit pratique.  Si vous avez l'habitude d'utiliser un autre √©diteur de texte, alors mc ne peut pas √™tre install√©. <br>  <b>tor</b> - Service Tor. <br>  <b>tor-geoip</b> - base de donn√©es g√©o-IP pour Tor. <br>  <b>bind-dig</b> - client DNS (analogue de nslookup et h√¥te). <br>  <b>cron</b> - planificateur de t√¢ches. <br>  <b>dnsmasq-full</b> - serveur DNS. <br>  <b>ipset et iptables</b> sont des utilitaires de console <b>ipset et iptables</b> (ils peuvent d√©j√† √™tre sur le syst√®me et ne sont pas n√©cessaires, je les ai ajout√©s pour des <b>raisons</b> de s√©curit√©). <br><br><h3>  2. Initialisez l'ipset, cr√©ez plusieurs adresses IP de d√©blocage (100-ipset.sh) </h3><br>  V√©rifiez que votre syst√®me de routeur prend en charge beaucoup de hash: net (comme il s'est av√©r√©, tous les routeurs Keenetic ne l'ont pas): <br><br><pre> <code class="bash hljs">ipset create <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> <span class="hljs-built_in"><span class="hljs-built_in">hash</span></span>:net</code> </pre> <br>  Si l'√©quipe n'a pas donn√© d'erreurs ou de messages, il y a du support et suivez simplement les instructions.  Sinon (il y a une erreur) dans le script suivant, vous devez remplacer <b>hash: net</b> par <b>hash: ip</b> .  Dans ce cas, vous perdez la possibilit√© de d√©verrouiller la plage et le CIDR. <br><br>  Cr√©ez un ensemble d'adresses vide appel√© <b>d√©bloquer</b> lorsque le routeur d√©marre.  Pour ce faire, cr√©ez le fichier <b>/opt/etc/ndm/fs.d/100-ipset.sh</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/etc/ndm/fs.d/100-ipset.sh</code> </pre> <br>  Collez (Maj + Ins√©rer) le contenu: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh [ "$1" != "start" ] &amp;&amp; exit 0 ipset create unblock hash:net -exist exit 0</span></span></code> </pre> <br>  Pour coller √† partir du tampon, utilisez Shift + Insert, enregistrez - F2, quittez - F10. <br><br>  Donner des droits d'ex√©cution: <br><br><pre> <code class="bash hljs">chmod +x /opt/etc/ndm/fs.d/100-ipset.sh</code> </pre> <br><h3>  3. Configuration de Tor </h3><br>  Supprimez le contenu du fichier de configuration Tor: <br><br><pre> <code class="bash hljs">cat /dev/null &gt; /opt/etc/tor/torrc</code> </pre> <br>  Ouvrez le fichier de configuration Tor: <br><br><pre> <code class="bash hljs">mcedit /opt/etc/tor/torrc</code> </pre> <br>  Collez (Maj + Ins√©rer) le contenu: <br><br><pre> <code class="bash hljs">User root PidFile /opt/var/run/tor.pid ExcludeExitNodes {RU},{UA},{AM},{KG},{BY} StrictNodes 1 TransPort 192.168.0.1:9141 ExitRelay 0 ExitPolicy reject *:* ExitPolicy reject6 *:* GeoIPFile /opt/share/tor/geoip GeoIPv6File /opt/share/tor/geoip6 DataDirectory /opt/var/lib/tor</code> </pre> <br>  Si n√©cessaire, remplacez <b>192.168.0.1</b> par l'adresse interne de votre routeur (LAN).  Br√®ve description de la configuration: <br><br><ul><li>  Exclure les n≈ìuds de sortie: Russie, Ukraine, Arm√©nie Kirghizistan, B√©larus. </li><li>  Accrochez un proxy transparent √† l'adresse 192.168.0.1, port 9141. </li><li>  Refuser d'√™tre un point de sortie. </li></ul><br><h3>  4. La liste des domaines (et pas seulement) pour contourner le verrou (unblock.txt) </h3><br>  unblock.txt est une liste simple √† d√©verrouiller.  Vous pouvez d√©verrouiller un domaine, une adresse IP, une plage ou un CIDR.  Une ligne - un √©l√©ment.  Les lignes vides (y compris les espaces et les tabulations) sont ignor√©es.  Vous pouvez utiliser le caract√®re # au d√©but d'une ligne pour l'ignorer. <br><br>  Cr√©ez le fichier <b>/opt/etc/unblock.txt</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/etc/unblock.txt</code> </pre> <br>  Chaque ligne peut contenir un nom de domaine, une adresse IP, une plage ou un CIDR.  Vous pouvez utiliser le caract√®re # pour commenter les lignes. <br><br><div class="spoiler">  <b class="spoiler_title">Voici un exemple de mon dossier personnel</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">###- rutracker.org rutor.info rutor.is mega-tor.org kinozal.tv nnm-club.me nnm-club.ws tfile.me tfile-home.org tfile1.cc megatfile.cc megapeer.org megapeer.ru tapochek.net tparser.org tparser.me rustorka.com uniongang.tv fast-torrent.ru ###    rezka.ag hdrezka.ag hdrezka.me filmix.co filmix.cc seasonvar.ru ### lib.rus.ec flibusta.is flibs.me flisland.net flibusta.site ### telegram.org tdesktop.com tdesktop.org tdesktop.info tdesktop.net telesco.pe telegram.dog telegram.me t.me telegra.ph web.telegram.org desktop.telegram.org updates.tdesktop.com venus.web.telegram.org flora.web.telegram.org vesta.web.telegram.org pluto.web.telegram.org aurora.web.telegram.org 149.154.160.0/20 91.108.4.0/22 91.108.8.0/22 91.108.12.0/22 91.108.16.0/22 91.108.56.0/22 109.239.140.0/24 67.198.55.0/24 ### 7-zip.org edem.tv 4pna.com 2019.vote ### Tor check.torproject.org ###   IP ( #   ) #195.82.146.214 ###   CIDR ( #   ) #103.21.244.0/22 ###    ( #   ) #100.100.100.200-100.100.100.210</span></span></code> </pre> <br></div></div><br><h3>  5. Un script pour remplir un ensemble d'adresses IP de d√©blocage d'une liste donn√©e de domaines (unblock_ipset.sh) </h3><br>  Cr√©ez le script <b>/opt/bin/unblock_ipset.sh</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_ipset.sh</code> </pre> <br>  Collez (Maj + Ins√©rer) le contenu: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh until ADDRS=$(dig +short google.com @localhost) &amp;&amp; [ -n "$ADDRS" ] &gt; /dev/null 2&gt;&amp;1; do sleep 5; done while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue cidr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/[0-9]{1,2}') if [ ! -z "$cidr" ]; then ipset -exist add unblock $cidr continue fi range=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}-[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$range" ]; then ipset -exist add unblock $range continue fi addr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$addr" ]; then ipset -exist add unblock $addr continue fi dig +short $line @localhost | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | awk '{system("ipset -exist add unblock "$1)}' done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br>  Donner des droits d'ex√©cution: <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_ipset.sh</code> </pre> <br>  Le script est assez simple, c'est l'essence m√™me de son travail ... Nous attendons que la r√©solution du domaine google.com fonctionne (si ce n'est pas fait, beaucoup de d√©blocages ne seront pas effectu√©s au d√©marrage du routeur, car le routeur sera toujours en cours d'initialisation).  Nous lisons les lignes du fichier unblock.txt.  Les lignes de lecture suppriment automatiquement les espaces et les tabulations au d√©but et √† la fin.  √âvitez les lignes vides.  Ignorez les lignes commen√ßant par le caract√®re #.  Nous cherchons dans la ligne CIDR.  Si CIDR est trouv√©, ajoutez-le pour d√©bloquer.  Nous recherchons une gamme dans la cha√Æne.  S'il est trouv√©, ajoutez-le pour d√©bloquer.  Nous recherchons l'adresse IP dans la cha√Æne.  Si l'IP est trouv√©e, ajoutez-la pour d√©bloquer.  R√©solvons une ligne en creusant.  Toutes les adresses IP du r√©sultat sont ajout√©es au d√©blocage. <br><br><h3>  6. Un script pour g√©n√©rer un fichier de configuration dnsmasq suppl√©mentaire √† partir d'une liste donn√©e de domaines (unblock_dnsmasq.sh) </h3><br>  Cr√©ez le script <b>/opt/bin/unblock_dnsmasq.sh</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_dnsmasq.sh</code> </pre> <br>  Collez (Maj + Ins√©rer) le contenu: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh cat /dev/null &gt; /opt/etc/unblock.dnsmasq while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue echo $line | grep -Eq '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' &amp;&amp; continue echo "ipset=/$line/unblock" &gt;&gt; /opt/etc/unblock.dnsmasq done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br>  Donner des droits d'ex√©cution: <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_dnsmasq.sh</code> </pre> <br>  Le script est assez simple.  Nous lisons s√©quentiellement les lignes de /opt/etc/unblock.txt.  Les lignes de lecture suppriment automatiquement les espaces et les tabulations au d√©but et √† la fin.  √âvitez les lignes vides.  √âvitez les lignes qui commencent par #.  Ignorer les lignes contenant une adresse IP (IP ou CIDR), c'est-√†-dire  nous ne sommes int√©ress√©s que par les cha√Ænes avec des noms de domaine.  Dans le fichier /opt/etc/unblock.dnsmasq nous ajoutons des lignes de la forme "ipset = / nom_domaine / d√©bloquer".  Cela signifie qu'apr√®s avoir d√©termin√© les adresses IP d'un domaine particulier, elles seront automatiquement ajout√©es √† l'ensemble de d√©blocage. <br><br>  Assurez-vous d'ex√©cuter le script pour g√©n√©rer le fichier unblock.dnsmasq: <br><br><pre> <code class="bash hljs">unblock_dnsmasq.sh</code> </pre> <br>  V√©rifiez que le fichier unblock.dnsmasq est cr√©√©: <br><br><pre> <code class="bash hljs">cat /opt/etc/unblock.dnsmasq</code> </pre> <br><h3>  7. Le script de mise √† jour forc√©e manuelle du syst√®me apr√®s avoir √©dit√© la liste des domaines (unblock_update.sh) </h3><br>  Cr√©ez le script <b>/opt/bin/unblock_update.sh</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_update.sh</code> </pre> <br>  Collez (Maj + Ins√©rer) le contenu: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh ipset flush unblock /opt/bin/unblock_dnsmasq.sh /opt/etc/init.d/S56dnsmasq restart /opt/bin/unblock_ipset.sh &amp;</span></span></code> </pre> <br>  Donner des droits d'ex√©cution: <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_update.sh</code> </pre> <br><h3>  8. Script pour remplir automatiquement un ensemble de d√©blocage lors du d√©marrage d'un routeur (S99unblock) </h3><br>  Cr√©ez le script <b>/opt/etc/init.d/S99unblock</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/etc/init.d/S99unblock</code> </pre> <br>  Collez (Maj + Ins√©rer) le contenu: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh [ "$1" != "start" ] &amp;&amp; exit 0 /opt/bin/unblock_ipset.sh &amp;</span></span></code> </pre><br>  Donner des droits d'ex√©cution: <br><br><pre> <code class="bash hljs">chmod +x /opt/etc/init.d/S99unblock</code> </pre> <br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 9. Transfert de paquets avec des destinations de d√©blocage √† Tor (100-redirect.sh) </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour ce faire, cr√©ez le fichier </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/opt/etc/ndm/netfilter.d/100-redirect.sh</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="bash hljs">mcedit /opt/etc/ndm/netfilter.d/100-redirect.sh</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Collez (Maj + Ins√©rer) le contenu: </font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh [ "$type" == "ip6tables" ] &amp;&amp; exit 0 if [ -z "$(iptables-save 2&gt;/dev/null | grep unblock)" ]; then ipset create unblock hash:net -exist iptables -w -t nat -A PREROUTING -i br0 -p tcp -m set --match-set unblock dst -j REDIRECT --to-port 9141 fi exit 0</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si vous avez utilis√© </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hash: ip</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √† l'√©tape 2 </font><font style="vertical-align: inherit;">et non </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hash: net</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , remplacez hash: net par hash: ip. En fait, nous dupliquons √©galement la fonction de cr√©ation d'un ensemble de d√©blocage en 2 √©tapes. Ceci est n√©cessaire pour la s√©curit√©, si les scripts de fs.d n'ont pas encore commenc√© √† s'ex√©cuter et que les scripts netfilter.d sont d√©j√† en cours d'ex√©cution. Ce n'est pas grave si le d√©blocage a d√©j√† √©t√© cr√©√© plus t√¥t, la commande sera simplement ignor√©e. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous pouvez ajouter (c'est facultatif) au m√™me fichier pour rediriger toutes les demandes vers le port externe 53 vers vous-m√™me. Cela est n√©cessaire pour que les clients du r√©seau local n'utilisent pas de services DNS tiers. Les demandes passeront par le serveur DNS standard. Avant la derni√®re sortie, ajoutez:</font></font><br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -z <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(iptables-save 2&gt;/dev/null | grep "udp \-\-dport 53 \-j DNAT")</span></span></span><span class="hljs-string">"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> iptables -w -t nat -I PREROUTING -i br0 -p udp --dport 53 -j DNAT --to 192.168.0.1 <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -z <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(iptables-save 2&gt;/dev/null | grep "tcp \-\-dport 53 \-j DNAT")</span></span></span><span class="hljs-string">"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> iptables -w -t nat -I PREROUTING -i br0 -p tcp --dport 53 -j DNAT --to 192.168.0.1 <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si n√©cessaire, remplacez </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.0.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> par l'adresse interne de votre routeur (LAN). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Donner des droits d'ex√©cution:</font></font><br><br><pre> <code class="bash hljs">chmod +x /opt/etc/ndm/netfilter.d/100-redirect.sh</code> </pre> <br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 10. Configurer dnsmasq et attacher un fichier de configuration suppl√©mentaire √† dnsmasq </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Supprimez le contenu du fichier de configuration dnsmasq: </font></font><br><br><pre> <code class="bash hljs">cat /dev/null &gt; /opt/etc/dnsmasq.conf</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ouvrez le fichier de configuration dnsmasq: </font></font><br><br><pre> <code class="bash hljs">mcedit /opt/etc/dnsmasq.conf</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Collez (Maj + Ins√©rer) le contenu: </font></font><br><br><pre> <code class="bash hljs">user=nobody bogus-priv no-negcache clear-on-reload <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span>-dynamic listen-address=192.168.0.1 listen-address=127.0.0.1 min-port=4096 cache-size=1536 expand-hosts <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-async conf-file=/opt/etc/unblock.dnsmasq server=8.8.8.8</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si n√©cessaire, remplacez </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.0.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> par l'adresse interne de votre routeur (LAN).</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 11. Ajout d'une t√¢che √† cron pour mettre √† jour p√©riodiquement le contenu de l'ensemble de d√©blocage </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il s'agit d'une assurance suppl√©mentaire si les programmes / appareils utilisent leur propre m√©thode de r√©solution et si l'adresse IP du domaine a chang√©. </font><font style="vertical-align: inherit;">Il vous suffit d'ex√©cuter le script unblock_ipset.sh √† la fr√©quence souhait√©e. </font><font style="vertical-align: inherit;">Par exemple, nous lancerons tous les jours √† 6 heures du matin. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ouvrez le fichier </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ opt / etc / crontab</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans l'√©diteur </font><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="bash hljs">mcedit /opt/etc/crontab</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ajouter √† la fin: </font></font><br><br><pre> <code class="bash hljs">00 06 * * * root /opt/bin/unblock_ipset.sh</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si vous le souhaitez, vous pouvez commenter toutes les autres t√¢ches du mod√®le. </font><font style="vertical-align: inherit;">Voici √† quoi ressemblera votre fichier crontab:</font></font><br><br><img src="https://habrastorage.org/webt/le/y5/sl/ley5slcvjfvs-9odj9air9qdd8s.png"><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 12. D√©sactiver le serveur DNS normal et red√©marrer le routeur </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Connectez-vous √† la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CLI du routeur Keenetic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (port 23 pour Telnet et 22 pour SSH si le composant ¬´SSH Server¬ª est ajout√© au syst√®me). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ex√©cutez la commande:</font></font><br><br><pre> <code class="bash hljs">opkg dns-override system configuration save system reboot</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le serveur DNS int√©gr√© au firmware sera d√©sactiv√© et dnsmasq d'Entware sera utilis√© √† la place. </font><font style="vertical-align: inherit;">Le routeur, au d√©marrage, v√©rifie si le dossier opt est mont√© (y a-t-il un lecteur flash USB / lecteur avec Entware). </font><font style="vertical-align: inherit;">Si tel est le cas, un serveur DNS standard n'est pas utilis√©. </font><font style="vertical-align: inherit;">Sinon, utilisez.</font></font> C'est-√†-dire<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retirer le lecteur flash et red√©marrer le routeur, tout fonctionnera pour vous, comme avant (avant la configuration). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apr√®s le red√©marrage, ouvrez le site Web check.torproject.org dans votre navigateur (il doit √™tre ajout√© √† unblock.txt). </font><font style="vertical-align: inherit;">Si vous avez tout fait correctement, vous verrez l'inscription ¬´F√©licitations. </font><font style="vertical-align: inherit;">Ce navigateur est configur√© pour utiliser Tor. ":</font></font><br><br><img src="https://habrastorage.org/webt/wa/19/dz/wa19dzxbu8qtldwrvkeijfqna7q.png"><br><br><br><a name="con31"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> M√©thodes de base pour diagnostiquer les erreurs apr√®s la configuration </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si la v√©rification avec le site check.torproject.org (il doit √™tre ajout√© √† unblock.txt) r√©ussit, mais que le talon du fournisseur continue de s'ouvrir pour d'autres ressources (ou ne s'ouvre pas), le fournisseur interf√©rera probablement avec le trafic DNS, rempla√ßant les r√©ponses - vous Une solution de contournement suppl√©mentaire est n√©cessaire pour filtrer les requ√™tes DNS. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si apr√®s la configuration, quelque chose ne fonctionne pas comme il se doit, utilisez des commandes simples pour d√©terminer l'√©tape du probl√®me. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Affichez le contenu de l'ensemble de d√©blocage:</font></font><br><br><pre> <code class="bash hljs">ipset list unblock</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si le syst√®me signale qu'il n'y a pas de tels ensembles, l'erreur se trouve √† l'√©tape 2 ou vous n'avez pas activ√© le module Netfilter dans le syst√®me (dans le cas de Keenetic). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si l'ensemble s'av√®re vide, le script unblock_ipset.sh n'a pas fonctionn√©, qui √† son tour doit √™tre d√©marr√© par le script de d√©marrage S99unblock. Ex√©cutez ce script unblock_ipset.sh manuellement. Si l'ensemble est plein, l'erreur est √† l'√©tape 8. Si le script ne peut pas √™tre ex√©cut√© (tr√®s probablement, il attend la r√©solution de google.com), l'erreur se situe quelque part du c√¥t√© du serveur DNS, √©ventuellement √† l'√©tape 10 ou 6. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recherchez une redirection dans iptables :</font></font><br><br><pre> <code class="bash hljs">iptables-save 2&gt;/dev/null | grep unblock</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S'il n'est pas l√†, l'erreur est √† l'√©tape 9. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si tous les sites sont en panne, c'est-√†-dire </font><font style="vertical-align: inherit;">DNS ne fonctionne pas, l'erreur se situe quelque part √† l'√©tape 6 ou 10. Peut-√™tre, √† l'√©tape 9. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si tous les sites de unblock.txt ne fonctionnent pas (le d√©lai est d√©pass√©), mais que tous les autres fonctionnent, le probl√®me se situe quelque part du c√¥t√© de Tor, erreur au stade 3.</font></font><br><br><br><a name="con4"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Contournement suppl√©mentaire pour filtrer les requ√™tes DNS par le fournisseur </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si un fournisseur interf√®re avec le trafic DNS en rempla√ßant les r√©ponses pour les ressources bloqu√©es, cela est tr√®s facile √† contourner. </font><font style="vertical-align: inherit;">Pour cela, nous utiliserons dnscrypt-proxy. </font><font style="vertical-align: inherit;">Si vous le souhaitez et exp√©rimentez, vous pouvez facilement remplacer dnscrypt par stubby (DNS sur TLS). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dnscrypt ne sera utilis√© que pour les domaines r√©pertori√©s dans unblock.txt. </font><font style="vertical-align: inherit;">Toutes les autres requ√™tes passeront par des serveurs DNS classiques. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si vous √™tes s√ªr que votre fournisseur ne filtre pas les requ√™tes DNS, vous n'avez pas besoin d'effectuer cette configuration suppl√©mentaire. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous devez d√©j√† avoir configur√© le contournement des verrous d√©crits ci-dessus. </font><font style="vertical-align: inherit;">Les param√®tres suivants sont identiques pour Padavan et Keenetic OS. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installez des logiciels suppl√©mentaires sur le routeur:</font></font><br><br><pre> <code class="bash hljs">opkg update opkg install dnscrypt-proxy2</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ouvrez le fichier de configuration dnscrypt-proxy: </font></font><br><br><pre> <code class="bash hljs">mcedit /opt/etc/dnscrypt-proxy.toml</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Recherchez les adresses listen_address, fallback_resolver, cache et modifiez-les: </font></font><br><br><pre> <code class="bash hljs">listen_addresses = [<span class="hljs-string"><span class="hljs-string">'127.0.0.1:9153'</span></span>] fallback_resolver = <span class="hljs-string"><span class="hljs-string">'77.88.8.8:1253'</span></span> cache = <span class="hljs-literal"><span class="hljs-literal">false</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">77.88.8.8:1253 est l'adresse du serveur DNS Yandex avec un port non standard. </font><font style="vertical-align: inherit;">Il s'agit d'une sauvegarde en cas de probl√®me avec dnscrypt-proxy. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ex√©cutez dnscrypt-proxy:</font></font><br><br><pre> <code class="bash hljs">/opt/etc/init.d/S09dnscrypt-proxy2 start</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Assurez-vous que dnscrypt-proxy fonctionne (vous devriez voir une liste d'adresses IP en r√©ponse): </font></font><br><br><pre> <code class="bash hljs">dig +short google.com @localhost -p 9153</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ouvrez le script </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/opt/bin/unblock_ipset.sh</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans l'√©diteur </font><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_ipset.sh</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Remplacez le contenu par: </font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh until ADDRS=$(dig +short google.com @localhost -p 9153) &amp;&amp; [ -n "$ADDRS" ] &gt; /dev/null 2&gt;&amp;1; do sleep 5; done while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue cidr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/[0-9]{1,2}') if [ ! -z "$cidr" ]; then ipset -exist add unblock $cidr continue fi range=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}-[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$range" ]; then ipset -exist add unblock $range continue fi addr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$addr" ]; then ipset -exist add unblock $addr continue fi dig +short $line @localhost -p 9153 | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | awk '{system("ipset -exist add unblock "$1)}' done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons fait un petit changement - maintenant creuser pour r√©soudre n'utilise pas un serveur DNS normal, mais dnscrypt-proxy avec le port 9153. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ouvrez le script </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/opt/bin/unblock_dnsmasq.sh</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans l'√©diteur </font><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_dnsmasq.sh</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Remplacez le contenu par: </font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh cat /dev/null &gt; /opt/etc/unblock.dnsmasq while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue echo $line | grep -Eq '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' &amp;&amp; continue echo "ipset=/$line/unblock" &gt;&gt; /opt/etc/unblock.dnsmasq echo "server=/$line/127.0.0.1#9153" &gt;&gt; /opt/etc/unblock.dnsmasq done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons fait un petit changement - maintenant lors de la g√©n√©ration du fichier unblock.dnsmasq, des lignes suppl√©mentaires comme ¬´server = / domain_name / 127.0.0.1 # 9153¬ª sont ajout√©es. </font><font style="vertical-align: inherit;">Cela signifie que la r√©solution des domaines de la liste se fera via dnscrypt-proxy. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ex√©cutez unblock_update.sh:</font></font><br><br><pre> <code class="bash hljs">unblock_update.sh</code> </pre> <br>  C'est fait.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tous les param√®tres compliqu√©s sont derri√®re. </font><font style="vertical-align: inherit;">Maintenant, vous ne modifierez la liste unblock.txt que si n√©cessaire, en ajoutant ou supprimant des domaines ou des adresses IP pour le d√©verrouiller et en activant les modifications apport√©es avec la commande unblock_update.sh. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MISE √Ä JOUR 04/01/2019</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Viennent souvent des messages personnels sur l'article avec des questions typiques. </font><font style="vertical-align: inherit;">Je r√©pondrai ici le plus courant. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment mettre √† disposition des sites de zone de domaine .onion? </font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En torrc, ajouter:</font></font><br><pre> <code class="bash hljs">VirtualAddrNetwork 10.254.0.0/16 DNSPort 127.0.0.1:9053 AutomapHostsOnResolve 1</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pour acc√©der √† tous les domaines de la zone oignon, ajoutez √† dnsmasq.conf: </font></font><br><pre> <code class="bash hljs">server=/onion/127.0.0.1<span class="hljs-comment"><span class="hljs-comment">#9053 ipset=/onion/unblock</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Si vous ne souhaitez pas ouvrir l'acc√®s √† tous les domaines de la zone oignon, mais uniquement √† des domaines sp√©cifiques, ajoutez les entr√©es suivantes dans dnsmasq.conf: </font></font><br><pre> <code class="bash hljs">server=/rutorc6mqdinc4cz.onion/127.0.0.1<span class="hljs-comment"><span class="hljs-comment">#9053 ipset=/rutorc6mqdinc4cz.onion/unblock server=/nnmclub5toro7u65.onion/127.0.0.1#9053 ipset=/nnmclub5toro7u65.onion/unblock server=/flibustahezeous3.onion/127.0.0.1#9053 ipset=/flibustahezeous3.onion/unblock</span></span></code> </pre> <br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment contourner les verrous pour les clients d'un serveur VPN fonctionnant sur un routeur? </font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans torrc, remplacez la ligne par TransPort par:</font></font><br><pre> <code class="bash hljs">TransPort 0.0.0.0:9141</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ajoutez une redirection suppl√©mentaire avec l'interface n√©cessaire (INTERFACE - Interface r√©seau VPN): </font></font><br><pre> <code class="bash hljs">iptables -t nat -A PREROUTING -i  -p tcp -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set unblock dst -j REDIRECT --to-port 9141</code> </pre> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr428992/">https://habr.com/ru/post/fr428992/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr428982/index.html">Comment √©crire D sur ARM</a></li>
<li><a href="../fr428984/index.html">Julia et portraits de phases de syst√®mes dynamiques</a></li>
<li><a href="../fr428986/index.html">Conf√©rence ThinkJava n ¬∞ 8 √† Kharkov</a></li>
<li><a href="../fr428988/index.html">Conseils nature - Veilleuse nuageuse</a></li>
<li><a href="../fr428990/index.html">Exemples de configuration d'UIViewControllers utilisant RouteComposer</a></li>
<li><a href="../fr428994/index.html">Mise en r√©seau sous Android avec Corutin et Retrofit</a></li>
<li><a href="../fr428996/index.html">Club de Santa Clauses anonymes 2018-2019 sur Habrahabr</a></li>
<li><a href="../fr428998/index.html">Comment utiliser la nouvelle fonctionnalit√© Profiler exp√©rimentale dans React</a></li>
<li><a href="../fr429000/index.html">Pourquoi Bill Gates a invent√© les toilettes pour 233 milliards de dollars</a></li>
<li><a href="../fr429006/index.html">Chine: ¬´l'atelier de montage mondial¬ª n'est pas aussi simple qu'il y para√Æt</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>