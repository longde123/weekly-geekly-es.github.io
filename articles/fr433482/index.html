<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí¥ üëº üóÉÔ∏è Django sous microscope üìº ü§ò üë©‚Äçüé®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Si, selon le rapport d'Artyom Malyshev ( proofit404 ), ils feront un film, alors le r√©alisateur sera Quentin Tarantino - il a d√©j√† fait un film sur Dj...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Django sous microscope</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/433482/">  Si, selon le rapport d'Artyom Malyshev ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">proofit404</a> ), ils feront un film, alors le r√©alisateur sera Quentin Tarantino - il a d√©j√† fait un film sur Django, il tournera √©galement le second.  Tous les d√©tails de la vie des m√©canismes internes de Django du premier octet de la requ√™te HTTP au dernier octet de la r√©ponse.  L'extravagance des formulaires d'analyse, la compilation de SQL pleine d'action, les effets sp√©ciaux de la mise en ≈ìuvre du moteur de mod√®le pour HTML.  Qui g√®re le pool de connexions et comment?  Tout cela par ordre chronologique de traitement des objets WSGI.  Sur tous les √©crans du pays - le d√©codage "Django sous microscope". <br><br><img src="https://habrastorage.org/webt/np/fq/rq/npfqrqbbgfwn2lktbgdq9h4xhgg.jpeg"><br><br>  <strong>√Ä propos de l'orateur: Artyom Malyshev</strong> est le fondateur du projet Dry Python et le d√©veloppeur principal de Django Channels version 1.0.  Il √©crit du Python depuis 5 ans et a aid√© √† organiser des r√©unions Python Rannts √† Nizhny Novgorod.  Artyom vous est peut-√™tre familier sous le surnom <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">PROOFIT404</a> .  La pr√©sentation du rapport est stock√©e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/AvGl7Vi2yT4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Il √©tait une fois, nous avons lanc√© l'ancienne version de Django.  Puis elle avait l'air effrayante et triste. <br><br><img src="https://habrastorage.org/webt/yv/i5/a9/yvi5a9ueicvuhwgsyf8npzvojne.jpeg"><br><br>  Ils ont vu que <code>self_check</code> pass√©, nous avons tout install√© correctement, tout fonctionnait et maintenant vous pouvez √©crire du code.  Pour y parvenir, nous avons d√ª ex√©cuter la commande <code>django-admin runserver</code> . <br><br><pre> <code class="plaintext hljs">$ django-admin runserver Performing system checks‚Ä¶ System check identified no issues (0 silenced). You have unapplied migrations; your app may not work properly until they are applied. Run 'python manage.py migrate1 to apply them. August 21, 2018 - 15:50:53 Django version 2.1, using settings 'mysite.settings' Starting development server at http://127.0.0.1:8000/Quit the server with CONTROL-C.</code> </pre><br>  Le processus d√©marre, traite les requ√™tes HTTP et toute la magie se produit √† l'int√©rieur et tout le code que nous voulons montrer aux utilisateurs en tant que site est ex√©cut√©. <br><br><h2>  L'installation <br></h2><br>  <code>django-admin</code> appara√Æt sur le syst√®me lorsque nous installons Django en utilisant, par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pip, le gestionnaire de paquets</a> . <br><br><pre> <code class="python hljs">$ pip install Django <span class="hljs-comment"><span class="hljs-comment"># setup.py from setuptools import find_packages, setup setup( name='Django', entry_points={ 'console_scripts': [ 'django-admin = django.core.management:execute_from_command_line' ] }, )</span></span></code> </pre><br>  <code>entry_points setuptools</code> appara√Æt, qui pointe vers la fonction <code>execute_from_command_line</code> .  Cette fonction est un point d'entr√©e pour toute op√©ration avec Django, pour tout processus en cours. <br><br><h3>  Bootstrap <br></h3><br>  Que se passe-t-il √† l'int√©rieur d'une fonction?  <strong>Bootstrap</strong> , qui est divis√© en deux it√©rations. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.management django.setup().</span></span></code> </pre><br><h4>  Configurer les param√®tres <br></h4><br>  Le premier est la <strong>lecture des configs</strong> : <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> django.conf.global_settings import_module(os.environ[<span class="hljs-string"><span class="hljs-string">"DJANGO_SETTINGS_MODULE"</span></span>])</code> </pre><br>  Les param√®tres <code>global_settings</code> par d√©faut <code>global_settings</code> , puis √† partir de la variable d'environnement, nous essayons de trouver le module avec <code>DJANGO_SETTINGS_MODULE</code> , que l'utilisateur a √©crit.  Ces param√®tres sont combin√©s dans un espace de nom. <br><br>  Quiconque √©crit dans Django au moins ¬´Hello, world¬ª sait qu'il y a <code>INSTALLED_APPS</code> - o√π nous √©crivons le code utilisateur. <br><br><h4>  Remplissez les applications <br></h4><br>  Dans la deuxi√®me partie, toutes ces applications, essentiellement des packages, sont it√©r√©es une par une.  Nous cr√©ons pour chaque config, nous importons des mod√®les pour travailler avec une base de donn√©es et nous v√©rifions l'int√©grit√© des mod√®les.  En outre, le framework ex√©cute <code>Check</code> , c'est-√†-dire qu'il v√©rifie que chaque mod√®le a une cl√© primaire, que toutes les cl√©s √©trang√®res pointent vers des champs existants et que le champ Null n'est pas √©crit dans le BooleanField, mais le NullBooleanField est utilis√©. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> entry <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> settings.INSTALLED_APPS: cfg = AppConfig.create(entry) cfg.import_models()</code> </pre><br>  C'est le contr√¥le de sant√© mentale minimum pour les mod√®les, pour le panneau d'administration, pour n'importe quoi - sans se connecter √† la base de donn√©es, sans quelque chose de super compliqu√© et sp√©cifique.  √Ä ce stade, Django ne sait pas encore quelle commande vous avez demand√© d'ex√©cuter, c'est-√†-dire qu'il ne distingue pas <code>migrate</code> de <code>runserver</code> ou <code>shell</code> . <br><br>  Ensuite, nous nous retrouvons dans un module qui essaie de deviner par des arguments de ligne de commande quelle commande nous voulons ex√©cuter et dans quelle application elle se trouve. <br><br><h2>  Commande de gestion <br></h2><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.management subcommand = sys.argv[1] app_name = find(pkgutils.iter_modules(settings.INSTALLED_APPS)) module = import_module( '%s.management.commands.%s' % (app_name, subcommand) ) cmd = module.Command() cmd.run_from_argv(self.argv)</span></span></code> </pre><br>  Dans ce cas, le module runserver aura un module <code>django.core.management.commands.runserver</code> int√©gr√©.  Apr√®s avoir import√© le module, par convention, la classe globale <code>Command</code> est appel√©e √† l'int√©rieur, est instanci√©e, et nous disons: " <em>Je vous ai trouv√©, ici vous avez les arguments de ligne de commande que l'utilisateur a pass√©s, faites quelque chose avec eux</em> ." <br><br>  Ensuite, nous allons au module runserver et voyons que <b>Django est fait de "regexp et sticks"</b> , dont je parlerai en d√©tail aujourd'hui: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.management.commands.runserver naiveip_re = re.compile(r"""^(?: (?P&lt;addr&gt; (?P&lt;ipv4&gt;\d{1,3}(?:\.\d{1,3}){3}) | # IPv4 address (?P&lt;ipv6&gt;\[[a-fA-F0-9:]+\]) | # IPv6 address (?P&lt;fqdn&gt;[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*) # FQDN ):)?(?P&lt;port&gt;\d+)$""", re.X)</span></span></code> </pre><br><h3>  Commandes <br></h3><br>  Faites d√©filer un √©cran et demi - enfin, nous entrons dans la d√©finition de notre √©quipe qui d√©marre le serveur. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.management.commands.runserver class Command(BaseCommand): def handle(self, *args, **options): httpd = WSGIServer(*args, **options) handler = WSGIHandler() httpd.set_app(handler) httpd.serve_forever()</span></span></code> </pre><br>  <code>BaseCommand</code> effectue un ensemble minimal d'op√©rations afin que les arguments de la ligne de commande aboutissent √† des arguments pour appeler les fonctions d' <code>**options</code> <code>*args</code> et <code>**options</code> .  Nous voyons que l'instance du serveur WSGI est en cours de cr√©ation ici, le WSGIHandler global est install√© sur ce serveur WSGI - c'est exactement <strong>God Object Django</strong> .  Nous pouvons dire que c'est la seule instance du cadre.  L'instance est install√©e sur le serveur globalement - via l' <code>set application</code> et dit: "Tournez dans la boucle d'√©v√©nement, ex√©cutez les requ√™tes." <br><br><blockquote>  Il y a toujours une boucle d'√©v√©nement quelque part et un programmeur qui lui confie des t√¢ches. <br></blockquote><br><h2>  Serveur WSGI <br></h2><br>  Qu'est-ce que <strong>WSGIHandler</strong> ?  WSGI est une interface qui vous permet de traiter les requ√™tes HTTP avec un niveau d'abstraction minimum, et ressemble √† quelque chose sous la forme d'une fonction. <br><br><h3>  Gestionnaire WSGI <br></h3><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.handlers.wsgi class WSGIHandler: def __call__(self, environ, start_response): signals.request_started.send() request = WSGIRequest(environ) response = self.get_response(request) start_response(response.status, response.headers) return response</span></span></code> </pre><br>  Par exemple, ici, c'est une instance d'une classe qui a un <code>call</code> d√©fini.  Il attend son entr√©e de dictionnaire, dans laquelle les en-t√™tes seront pr√©sent√©s comme des octets et un gestionnaire de fichiers.  Le gestionnaire est n√©cessaire pour lire le <code>&lt;body&gt;</code> la demande.  Le serveur lui-m√™me donne √©galement un rappel <code>start_response</code> afin que nous puissions envoyer <code>response.headers</code> et son en-t√™te, par exemple, status, dans un seul paquet. <br><br>  De plus, nous pouvons transmettre le corps de la r√©ponse au serveur via l'objet de r√©ponse.  <strong>Response</strong> est un g√©n√©rateur que vous pouvez parcourir. <br><br>  Tous les serveurs √©crits pour WSGI - Gunicorn, uWSGI, Waitress, fonctionnent sur cette interface et sont interchangeables.  Nous envisageons maintenant un serveur pour le d√©veloppement, mais tout serveur arrive au point que dans Django, il passe √† travers environ et le rappel. <br><br><h2>  Qu'y a-t-il √† l'int√©rieur de Dieu Object? <br></h2><br>  Que se passe-t-il √† l'int√©rieur de cette fonction globale d'objet divin √† l'int√©rieur de Django? <br><br><ul><li>  DEMANDE. </li><li>  MIDDLEWARES. </li><li>  ROUTAGE demande de visualisation. </li><li>  VIEW - traitement du code utilisateur dans la vue. </li><li>  FORM - travailler avec des formulaires. </li><li>  ORM. </li><li>  MOD√àLE </li><li>  R√âPONSE. </li></ul><br>  Toutes les machines que nous voulons de Django se d√©roulent dans une seule fonction, qui est r√©partie sur l'ensemble du cadre. <br><br><h3>  Demande <br></h3><br>  Nous enveloppons l'environnement WSGI, qui est un dictionnaire simple, dans un objet sp√©cial, pour la commodit√© de travailler avec l'environnement.  Par exemple, il est plus pratique de d√©terminer la longueur d'une demande utilisateur en travaillant avec quelque chose de similaire √† un dictionnaire qu'avec une cha√Æne d'octets qui doit √™tre analys√©e et y rechercher des entr√©es de valeur-cl√©.  Lorsque je travaille avec des cookies, je ne veux pas non plus calculer manuellement si la p√©riode de stockage a expir√© ou non, et en quelque sorte l'interpr√©ter. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.handlers.wsgi class WSGIRequest(HttpRequest): @cached_property def GET(self): return QueryDict(self.environ['QUERY_STRING']) @property def POST(self): self._load_post_and_files() return self._post @cached_property def COOKIES(self): return parse_cookie(self.environ['HTTP_COOKIE'])</span></span></code> </pre><br>  La requ√™te contient des analyseurs, ainsi qu'un ensemble de gestionnaires pour contr√¥ler le traitement du corps de la requ√™te POST: qu'il s'agisse d'un fichier en m√©moire ou temporaire en stockage sur disque.  Tout est d√©cid√© dans la demande.  La requ√™te dans Django est √©galement un objet agr√©gateur dans lequel tous les middlewares peuvent mettre les informations dont nous avons besoin sur la session, l'authentification et l'autorisation utilisateur.  Nous pouvons dire que c'est aussi un objet divin, mais plus petit. <br><br>  La demande suppl√©mentaire parvient au middleware. <br><br><h3>  Middlewares <br></h3><br>  <strong>Le middleware</strong> est un wrapper qui enveloppe d'autres fonctions comme un d√©corateur.  Avant de renoncer au contr√¥le du middleware, dans la m√©thode d'appel, nous donnons une r√©ponse ou appelons un middleware d√©j√† encapsul√©. <br><br>  Voici √† quoi ressemble le middleware du point de vue du programmeur. <br><br><h4>  Param√®tres <br></h4><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># settings.py MIDDLEWARE = [ 'django.middleware.security.SecurityMiddleware', 'django.middleware.csrf.CsrfViewMiddleware', 'django.contrib.sessions.middleware.SessionMiddleware', 'django.contrib.auth.middleware.AuthenticationMiddleware', ]</span></span></code> </pre><br><h4>  D√©finir <br></h4><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Middleware</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, get_response=None)</span></span></span><span class="hljs-function">:</span></span> self.get_response = get_response <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__call__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, request)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.get_response(request)</code> </pre><br>  Du point de vue de Django, les middlewares ressemblent √† une sorte de pile: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.handlers.base def load_middleware(self): handler = convert_exception_to_response(self._get_response) for middleware_path in reversed(settings.MIDDLEWARE): middleware = import_string(middleware_path) instance = middleware(handler) handler = convert_exception_to_response(instance) self._middleware_chain = handler</span></span></code> </pre><br><h4>  Postuler <br></h4><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_response</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, request)</span></span></span><span class="hljs-function">:</span></span> set_urlconf(settings.ROOT_URLCONF) response = self._middleware_chain(request) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response</code> </pre><br>  Nous prenons la fonction <code>get_response</code> initiale, l'enveloppons dans un gestionnaire, qui traduira, par exemple, une <code>permission error</code> et une <code>not found error</code> dans le code HTTP correct.  Nous emballons tout dans le middleware lui-m√™me de la liste.  La pile des middlewares s'agrandit et chaque suivant encapsule le pr√©c√©dent.  Cela est tr√®s similaire √† l'application de la m√™me pile de d√©corateurs √† toutes les vues d'un projet, uniquement de mani√®re centrale.  Pas besoin de faire le tour et d'organiser les emballages avec vos mains selon le projet, tout est pratique et logique. <br><br>  Nous sommes pass√©s par 7 cercles de middlewares, notre demande a surv√©cu et avons d√©cid√© de la traiter en vue.  Nous arrivons ensuite au module de routage. <br><br><h3>  Acheminement <br></h3><br>  C'est l√† que nous d√©cidons quel gestionnaire appeler pour une demande particuli√®re.  Et cela est r√©solu: <br><br><ul><li>  bas√© sur l'url; </li><li>  dans la sp√©cification WSGI, o√π request.path_info est appel√©. </li></ul><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.handlers.base def _get_response(self, request): resolver = get_resolver() view, args, kwargs = resolver.resolve(request.path_info) response = view(request, *args, **kwargs) return response</span></span></code> </pre><br><h4>  URL <br></h4><br>  Nous prenons le r√©solveur, lui fournissons l'url de requ√™te actuelle et attendons qu'il renvoie la fonction de vue elle-m√™me, et √† partir de la m√™me URL, nous obtenons les arguments avec lesquels appeler view.  Ensuite, <code>get_response</code> appelle view, g√®re les exceptions et fait quelque chose avec. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># urls.py urlpatterns = [ path('articles/2003/', views.special_case_2003), path('articles/&lt;int:year&gt;/', views.year_archive), path('articles/&lt;int:year&gt;/&lt;int:month&gt;/', views.month_archive) ]</span></span></code> </pre><br><h4>  Resolver <br></h4><br>  Voici √† quoi ressemble le r√©solveur: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.urls.resolvers _PATH_RE = re.compile( r'&lt;(?:(?P&lt;converter&gt;[^&gt;:]+):)?(?P&lt;parameter&gt;\w+)&gt;' ) def resolve(self, path): for pattern in self.url_patterns: match = pattern.search(path) if match: return ResolverMatch( self.resolve(match[0]) ) raise Resolver404({'path': path})</span></span></code> </pre><br>  C'est aussi regexp, mais r√©cursif.  Il va dans certaines parties de l'URL, cherche ce que l'utilisateur veut: d'autres utilisateurs, des publications, des blogs, ou est-ce une sorte de convertisseur, par exemple, une ann√©e sp√©cifique qui doit √™tre r√©solue, mise en arguments, cast√©e en int. <br><br>  Il est caract√©ristique que la profondeur de r√©cursivit√© de la m√©thode de r√©solution soit toujours √©gale au nombre d'arguments avec lesquels la vue est appel√©e.  Si quelque chose s'est mal pass√© et que nous n'avons pas trouv√© d'URL sp√©cifique, une erreur non trouv√©e se produit. <br><br>  Ensuite, nous voyons enfin - le code que le programmeur a √©crit. <br><br><h3>  Afficher <br></h3><br>  Dans sa repr√©sentation la plus simple, il s'agit d'une fonction qui renvoie une demande de r√©ponse, mais √† l'int√©rieur, nous effectuons des t√¢ches logiques: ¬´pour, si, un jour¬ª - de nombreuses t√¢ches r√©p√©titives.  Django nous fournit une vue bas√©e sur la classe o√π vous pouvez sp√©cifier des d√©tails sp√©cifiques, et tout le comportement sera interpr√©t√© au format correct par la classe elle-m√™me. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.views.generic.edit class ContactView(FormView): template_name = 'contact.html' form_class = ContactForm success_url = '/thanks/'</span></span></code> </pre><br><h4>  Organigramme de la m√©thode <br></h4><br><pre> <code class="python hljs">self.dispatch() self.post() self.get_form() self.form_valid() self.render_to_response()</code> </pre><br>  La m√©thode de <code>dispatch</code> de cette instance est d√©j√† dans le mappage d'URL au lieu d'une fonction.  La r√©partition bas√©e sur le verbe HTTP comprend la m√©thode √† appeler: POST nous est parvenue et nous souhaitons tr√®s probablement instancier l'objet formulaire, si le formulaire est valide, l'enregistrer dans la base de donn√©es et afficher le mod√®le.  Tout cela se fait gr√¢ce au grand nombre de mixins qui composent cette classe. <br><br><h3>  Formulaire <br></h3><br>  Le formulaire doit √™tre lu √† partir du socket avant d'entrer dans la vue Django - via le m√™me gestionnaire de fichiers qui se trouve dans l'environnement WSGI.  form-data est un flux d'octets, dans lequel les s√©parateurs sont d√©crits - nous pouvons lire ces blocs et en faire quelque chose.  Il peut s'agir d'une correspondance cl√©-valeur, s'il s'agit d'un champ, d'une partie d'un fichier, puis √† nouveau d'un champ - tout est m√©lang√©. <br><br><pre> <code class="python hljs">Content-Type: multipart/form-data;boundary=<span class="hljs-string"><span class="hljs-string">"boundary"</span></span> --boundary name=<span class="hljs-string"><span class="hljs-string">"field1"</span></span> value1 --boundary name=<span class="hljs-string"><span class="hljs-string">"field2"</span></span>; value2</code> </pre><br><h4>  Analyseur <br></h4><br>  L'analyseur se compose de 3 parties. <br><br>  L'it√©rateur de bloc qui cr√©e les lectures attendues √† partir du flux d'octets se transforme en un it√©rateur qui peut produire des <code>boundaries</code> .  Il garantit que si quelque chose revient, ce sera la fronti√®re.  Ceci est n√©cessaire pour qu'√† l'int√©rieur de l'analyseur, il ne soit pas n√©cessaire de stocker l'√©tat de la connexion, lu depuis le socket ou non lu pour minimiser la logique du traitement des donn√©es. <br><br>  Ensuite, le g√©n√©rateur <strong>encapsule</strong> dans <strong>LazyStream</strong> , qui cr√©e √† nouveau un fichier objet √† partir de celui-ci, mais avec la lecture attendue.  Ainsi, l'analyseur peut d√©j√† parcourir des morceaux d'octets et cr√©er une valeur-cl√© √† partir d'eux. <br><br>  <strong>champ et donn√©es ici seront toujours des cha√Ænes</strong> .  Si nous avons re√ßu une heure au format ISO, le formulaire Django (qui a √©t√© √©crit par le programmeur) recevra, en utilisant certains champs, par exemple, l'horodatage. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.http.multipartparser self._post = QueryDict(mutable=True) stream = LazyStream(ChunkIter(self._input_data)) for field, data in Parser(stream): self._post.append(field, force_text(data))</span></span></code> </pre><br>  De plus, le formulaire, tr√®s probablement, veut se sauvegarder dans une base de donn√©es, et ici Django ORM commence. <br><br><h3>  ORM <br></h3><br>  Environ √† travers de telles requ√™tes DSL pour ORM sont ex√©cut√©es: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># models.py Entry.objects.exclude( pub_date__gt=date(2005, 1, 3), headline='Hello', )</span></span></code> </pre><br>  √Ä l'aide de cl√©s, vous pouvez collecter des expressions SQL similaires: <br><br><pre> <code class="python hljs">SELECT * WHERE NOT (pub_date &gt; <span class="hljs-string"><span class="hljs-string">'2005-1-3'</span></span> AND headline = <span class="hljs-string"><span class="hljs-string">'Hello'</span></span>)</code> </pre><br>  Comment √ßa se passe? <br><br><h4>  Queryset <br></h4><br>  La m√©thode <code>exclude</code> a un objet <code>Query</code> sous le capot.  L'objet re√ßoit des arguments de la fonction et cr√©e une hi√©rarchie d'objets, chacun pouvant se transformer en une partie distincte de la requ√™te SQL sous forme de cha√Æne. <br><br>  Lors de la travers√©e de l'arborescence, chacune des sections interroge ses n≈ìuds enfants, re√ßoit des requ√™tes SQL imbriqu√©es et, par cons√©quent, nous pouvons construire SQL en tant que cha√Æne.  Par exemple, la valeur-cl√© ne sera pas un champ SQL distinct, mais sera compar√©e √† la valeur-valeur.  La concat√©nation et le refus des requ√™tes fonctionnent de la m√™me mani√®re qu'une travers√©e d'arborescence r√©cursive, pour chaque n≈ìud dont une conversion en SQL est appel√©e. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.db.models.query sql.Query(Entry).where.add( ~Q( Q(F('pub_date') &gt; date(2005, 1, 3)) &amp; Q(headline='Hello') ) )</span></span></code> </pre><br><h4>  Compilateur <br></h4><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.db.models.expressions class Q(tree.Node): AND = 'AND' OR = 'OR' def as_sql(self, compiler, connection): return self.template % self.field.get_lookup('gt')</span></span></code> </pre><br><h3>  Sortie <br></h3><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>Q(headline=<span class="hljs-string"><span class="hljs-string">'Hello'</span></span>) <span class="hljs-comment"><span class="hljs-comment"># headline = 'Hello' &gt;&gt;&gt; F('pub_date') # pub_date &gt;&gt;&gt; F('pub_date') &gt; date(2005, 1, 3) # pub_date &gt; '2005-1-3' &gt;&gt;&gt; Q(...) &amp; Q(...) # ... AND ... &gt;&gt;&gt; ~Q(...) # NOT ‚Ä¶</span></span></code> </pre><br>  Un petit assistant-compilateur est pass√© √† cette m√©thode, qui peut distinguer le dialecte MySQL de PostgreSQL et organiser correctement le sucre syntaxique utilis√© dans le dialecte d'une base de donn√©es particuli√®re. <br><br><h3>  Routage DB <br></h3><br>  Lorsque nous avons re√ßu la requ√™te SQL, le mod√®le frappe sur le routage DB et demande dans quelle base de donn√©es il se trouve.  Dans 99% des cas, ce sera la base de donn√©es par d√©faut, dans le 1% restant - une sorte de sienne. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.db.utils class ConnectionRouter: def db_for_read(self, model, **hints): if model._meta.app_label == 'auth': return 'auth_db'</span></span></code> </pre><br>  Envelopper un pilote de base de donn√©es √† partir d'une interface de biblioth√®que sp√©cifique, telle que Python MySQL ou Psycopg2, cr√©e un objet universel avec lequel Django peut travailler.  Il existe un wrapper pour les curseurs, un wrapper pour les transactions. <br><br><h4>  Piscine communicante <br></h4><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.db.backends.base.base class BaseDatabaseWrapper: def commit(self): self.validate_thread_sharing() self.validate_no_atomic_block() with self.wrap_database_errors: return self.connection.commit()</span></span></code> </pre><br>  Dans cette connexion particuli√®re, nous envoyons des requ√™tes au socket qui frappe sur la base de donn√©es et attendons l'ex√©cution.  L'encapsuleur sur la biblioth√®que lira la r√©ponse humaine de la base de donn√©es sous la forme d'un enregistrement, et Django collecte l'instance de mod√®le √† partir de ces donn√©es dans des types Python.  Ce n'est pas une it√©ration compliqu√©e. <br><br>  Nous avons √©crit quelque chose dans la base de donn√©es, lu quelque chose et d√©cid√© d'en informer l'utilisateur √† l'aide de la page HTML.  Pour ce faire, Django dispose d'un langage de mod√®le d√©test√© par la communaut√© qui ressemble √† quelque chose comme un langage de programmation, uniquement dans un fichier HTML. <br><br><h3>  Gabarit <br></h3><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.template.loader <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> render_to_string render_to_string(<span class="hljs-string"><span class="hljs-string">'my_template.html'</span></span>, {<span class="hljs-string"><span class="hljs-string">'entries'</span></span>: ...})</code> </pre><br><h4>  Code <br></h4><br><pre> <code class="python hljs">&lt;ul&gt; {% <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> entry <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> entries %} &lt;li&gt;{{ entry.name }}&lt;/li&gt; {% endfor %} &lt;/ul&gt;</code> </pre><br><h4>  Analyseur <br></h4><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.template.base BLOCK_TAG_START = '{%' BLOCK_TAG_END = '%}' VARIABLE_TAG_START = '{{' VARIABLE_TAG_END = '}}' COMMENT_TAG_START = '{#' COMMENT_TAG_END = '#}' tag_re = (re.compile('(%s.*?%s|%s.*?%s|%s.*?%s)' % (re.escape(BLOCK_TAG_START), re.escape(BLOCK_TAG_END), re.escape(VARIABLE_TAG_START), re.escape(VARIABLE_TAG_END), re.escape(COMMENT_TAG_START), re.escape(COMMENT_TAG_END))))</span></span></code> </pre><br>  Surprise - regexp √† nouveau.  Ce n'est qu'√† la fin qu'il devrait y avoir une virgule, et la liste ira tr√®s loin.  C'est probablement l'expression rationnelle la plus difficile que j'ai vue dans ce projet. <br><br><h3>  Lexer <br></h3><br>  Le gestionnaire de mod√®les et l'interpr√©teur sont assez simples.  Il existe un lexer qui utilise regexp pour traduire le texte en une liste de petits jetons. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.template.base def tokenize(self): for bit in tag_re.split(template_string): lineno += bit.count('\n') yield bit</span></span></code> </pre><br>  Nous parcourons la liste des jetons, regardons: ¬´Qui √™tes-vous?  Enveloppez-vous dans un n≈ìud de tag. "  Par exemple, s'il s'agit du d√©but de certains <code>if</code> <code>for</code> ou <code>for</code> , le gestionnaire de balises prendra le gestionnaire appropri√©.  Le gestionnaire <code>for</code> lui-m√™me dit √† nouveau √† l'analyseur: "Lisez-moi une liste de jetons jusqu'√† la balise de fermeture." <br><br>  L'op√©ration revient √† l'analyseur. <br><br><blockquote>  Un n≈ìud, une balise et un analyseur sont des choses r√©currentes mutuellement, et la profondeur de r√©cursivit√© est g√©n√©ralement √©gale √† l'imbrication du mod√®le lui-m√™me par des balises. <br></blockquote><br><h4>  Analyseur <br></h4><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> tokens: token = tokens.pop() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> token.startswith(BLOCK_TAG_START): <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> TagNode(token) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> token.startswith(VARIABLE_TAG_START): ...</code> </pre><br>  Le gestionnaire de balises nous donne un n≈ìud sp√©cifique, par exemple, avec une boucle for, pour lequel la m√©thode de <code>render</code> appara√Æt. <br><br><h4>  Pour boucle <br></h4><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.template.defaulttags @register.tag('for') def do_for(parser, token): args = token.split_contents() body = parser.parse(until=['endfor']) return ForNode(args, body)</span></span></code> </pre><br><h4>  Pour le n≈ìud <br></h4><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ForNode</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Node)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, context)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> context.push(): <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self.args: <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> self.body.render(context)</code> </pre><br>  La m√©thode de <code>render</code> est un arbre de rendu.  Chaque n≈ìud sup√©rieur peut acc√©der √† un n≈ìud fille, lui demander de rendre.  Les programmeurs ont l'habitude d'afficher certaines variables dans ce mod√®le.  Cela se fait par le <code>context</code> - il est pr√©sent√© sous la forme d'un dictionnaire r√©gulier.  Il s'agit d'une pile de dictionnaires pour √©muler une port√©e lorsque nous entrons une balise.  Par exemple, si le <code>context</code> lui-m√™me change une autre balise √† l'int√©rieur de la boucle <code>for</code> , alors lorsque nous quitterons la boucle, les modifications seront annul√©es.  C'est pratique parce que quand tout est global, c'est difficile de travailler. <br><br><h3>  R√©ponse <br></h3><br>  Enfin, nous avons obtenu notre ligne avec la r√©ponse HTTP: <br><br><blockquote>  Bonjour tout le monde! <br></blockquote><br>  Nous pouvons donner la ligne √† l'utilisateur. <br><br><ul><li>  Renvoyez cette r√©ponse de la vue. </li><li>  Afficher les middlewares de listes. </li><li>  Les middlewares modifient, compl√®tent et am√©liorent cette r√©ponse. </li><li>  La r√©ponse commence √† it√©rer dans WSGIHandler, est partiellement √©crite dans le socket et le navigateur re√ßoit une r√©ponse de notre serveur. </li></ul><br>  Toutes les startups c√©l√®bres qui ont √©t√© √©crites dans Django, comme Bitbucket ou Instagram, ont commenc√© avec un cycle si petit que chaque programmeur a travers√©. <br><br>  Tout cela, et une pr√©sentation √† Moscou Python Conf ++, sont n√©cessaires pour mieux comprendre ce qui est entre vos mains et comment l'utiliser.  Dans toute magie, il y a une grande partie de l'expression rationnelle que vous devez pouvoir cuisiner. <br><br><blockquote>  Artyom Malyshev et 23 autres grands orateurs <strong>le 5 avril</strong> nous donneront √† nouveau beaucoup de mati√®re √† r√©flexion et √† discussion sur le th√®me du Python lors de la conf√©rence <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Python Conf ++ de Moscou</a> .  √âtudiez le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">calendrier</a> et participez √† l'√©change d'exp√©riences dans la r√©solution de divers probl√®mes √† l'aide de Python. <br></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr433482/">https://habr.com/ru/post/fr433482/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr433472/index.html">Unity 2018.3 est sorti</a></li>
<li><a href="../fr433474/index.html">Pylint de l'int√©rieur vers l'ext√©rieur. Comment fait-il</a></li>
<li><a href="../fr433476/index.html">50 nuances de c√©leri</a></li>
<li><a href="../fr433478/index.html">Pourquoi Django est choisi dans Tinkoff Magazine</a></li>
<li><a href="../fr433480/index.html">Histoire d'Holivarny sur Linter</a></li>
<li><a href="../fr433486/index.html">Quoi encore? Le renouveau des cartes de d√©bit non bancaires</a></li>
<li><a href="../fr433488/index.html">Christmas Scrum Meetup UPD Broadcast mitap</a></li>
<li><a href="../fr433490/index.html">Critique de l'imprimante 3D Creality CR-X</a></li>
<li><a href="../fr433494/index.html">10 idiomes anglais que vous ne conna√Ætrez jamais</a></li>
<li><a href="../fr433496/index.html">Les entreprises publiques oblig√©es de passer aux logiciels nationaux d'ici 2022</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>