<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ò£Ô∏è üòü üõí Rapports sur l'√©tat du stockage √† l'aide de R. Calcul parall√®le, graphiques, xlsx, e-mail et tout cela üßôüèª üçà üíÉüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="L'article fournit du code pour g√©n√©rer des rapports r√©guliers sur l'√©tat des disques de stockage EMC VNX avec des approches alternatives et un histori...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Rapports sur l'√©tat du stockage √† l'aide de R. Calcul parall√®le, graphiques, xlsx, e-mail et tout cela</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461441/"><p>  L'article fournit du code pour g√©n√©rer des rapports r√©guliers sur l'√©tat des <strong>disques de</strong> stockage <strong>EMC VNX</strong> avec des approches alternatives et un historique de cr√©ation. </p><br><p>  J'ai essay√© d'√©crire du code avec les commentaires les plus d√©taill√©s et un fichier.  Remplacez uniquement vos mots de passe.  Le format des donn√©es source est √©galement indiqu√©, je serai donc heureux si quelqu'un essaie de les appliquer √† la maison. </p><br><p><img src="https://habrastorage.org/webt/um/it/no/umitnoobcf6fiyywqho_5gsbvjk.png" alt="Apparence graphique"></p><a name="habracut"></a><br><h2 id="predystoriya">  Contexte </h2><br><p>  Vous pouvez sauter si ce n'est pas int√©ressant d'o√π viennent les "jambes". <br>  Nous avons un centre de donn√©es.  Il n'y a pas de syst√®mes de stockage tr√®s r√©cents.  Il existe de nombreux syst√®mes de stockage, des pannes de disque aussi.  Plusieurs fois par semaine, des personnes se rendent au centre de donn√©es et changent de lecteur dans le syst√®me de stockage.  La d√©cision de remplacer les disques est prise apr√®s une alarme du syst√®me " <strong>Remplacement de disque recommand√©</strong> ". </p><br><p>  <em>Rien d'extraordinaire.</em> </p><br><p><img src="https://habrastorage.org/webt/5l/ho/ne/5lhonedh_eha1d0gm2vnzrv2ry4.png" alt="C'est bien"></p><br><p>  Mais r√©cemment, les LUN individuels collect√©s sur ces syst√®mes de stockage et pr√©sent√©s √† l'environnement virtuel ont commenc√© √† se d√©grader s√©rieusement.  Apr√®s avoir discut√© avec le support technique du fournisseur, il est devenu clair que les disques doivent d√©j√† √™tre chang√©s non seulement lorsque le message d'alarme ci-dessus appara√Æt, mais √©galement lorsqu'un grand nombre d'autres messages apparaissent que le syst√®me ne prend pas en compte les erreurs critiques. </p><br><p>  La surveillance SNMP par ces syst√®mes de stockage n'est pas prise en charge.  Vous devez utiliser soit un logiciel propri√©taire co√ªteux (nous ne l'avons pas), soit l' <strong>utilitaire de</strong> console <strong>NaviSECCli</strong> , qui doit √™tre connect√© √† chaque contr√¥leur (il y en a deux) de chaque syst√®me de stockage, mais ce n'√©tait pas tr√®s souhaitable. </p><br><p>  Il a √©t√© d√©cid√© d'automatiser la collecte des journaux et de rechercher des erreurs dans ceux-ci.  Et la d√©cision de remplacer les disques devrait √™tre laiss√©e aux ing√©nieurs responsables sur la base des r√©sultats de l'analyse du rapport. </p><br><h2 id="pervye-shagi">  Premiers pas </h2><br><p>  Initialement, un de mes coll√®gues a √©crit du code <strong>PowerShell</strong> qui faisait ce qui suit: </p><br><ul><li>  A pris une table d'entr√©e qui contenait les adresses IP des contr√¥leurs de stockage; </li><li>  le cycle est all√© aux adresses ip des contr√¥leurs <em>A</em> , puis aux adresses ip des contr√¥leurs <em>B</em> ; </li><li>  au cours du processus, ils les ont √©galement interrog√©s pour conna√Ætre les num√©ros de s√©rie des disques; </li><li>  trait√© toutes les lignes des journaux et filtr√© pour le contenu des messages recherch√©s; </li><li>  cr√©√© un objet <strong>PowerShell</strong> et analys√© dans ses propri√©t√©s les donn√©es n√©cessaires √† partir des lignes obtenues ci-dessus; </li><li>  fusionn√© tous les objets r√©sultants dans une table qui a √©t√© √©mise sous forme de csv. </li></ul><br><p>  Le code est ci-dessous.  Faites imm√©diatement une r√©servation qu'il travaille, mais nous avons introduit une solution alternative. </p><br><div class="spoiler">  <b class="spoiler_title">Source PowerShell</b> <div class="spoiler_text"><pre><code class="perl hljs">cd <span class="hljs-string"><span class="hljs-string">'d:\Navisphere CLI\' $csv = "D:\VNX-IP.csv" $Filter1 = "name1" $Filter2 = "name2" $Filter3 = "name3" $Data = import-csv $csv -Delimiter '</span></span>;<span class="hljs-string"><span class="hljs-string">' | Where {$_.cl -EQ $Filter1 -Or $_.cl -EQ $Filter2 -Or $_.cl -EQ $Filter3} | Sort-Object -Property @{Expression={$_.cl}; Ascending=$true}, @{Expression={$_.Name} ;Ascending=$true} #$Filter1 = "nameOfcl" #$Data = import-csv $csv -Delimiter '</span></span>;<span class="hljs-string"><span class="hljs-string">' | Where {$_.Name -EQ $Filter1} $Data | select Name,IP,cl $yStart = (Get-Date).AddDays(-30).ToString('</span></span>yyyy<span class="hljs-string"><span class="hljs-string">') $yEnd = (Get-Date).ToString('</span></span>yyyy<span class="hljs-string"><span class="hljs-string">') $mStart = (Get-Date).AddDays(-30).ToString('</span></span>MM<span class="hljs-string"><span class="hljs-string">') $mEnd = (Get-Date).ToString('</span></span>MM<span class="hljs-string"><span class="hljs-string">') $dStart = (Get-Date).AddDays(-30).ToString('</span></span>dd<span class="hljs-string"><span class="hljs-string">') $dEnd = (Get-Date).ToString('</span></span>dd<span class="hljs-string"><span class="hljs-string">') #$start = (Get-Date).AddDays(-3).ToString('</span></span>MM\/dd\/yy<span class="hljs-string"><span class="hljs-string">') #$end = (Get-Date).ToString('</span></span>MM\/dd\/yy<span class="hljs-string"><span class="hljs-string">') $i = 1 $table = ForEach ($row in $Data) { Write-Host $row.Name -ForegroundColor "Yellow" Write-Host "SP A" Write-Host (Get-Date).ToString('</span></span>HH:mm:ss<span class="hljs-string"><span class="hljs-string">') $txt = .\NaviSECCli.exe -scope 0 -h $row.newA -user myusername -password mypassword getlog -date $mStart/$dStart/$yStart $mEnd/$dEnd/$yEnd | Select-String -Pattern "\(820\)","\(803\)","\(801\)","\(920\)","\(901\)" ForEach ($n in $txt) { $x = $n -Split('</span></span> <span class="hljs-string"><span class="hljs-string">') $disk = $x[3] + "_" + $x[5] + "_" + $x[7].Split("(")[0] $sn = (.\NaviSECCli.exe -scope 0 -h $row.newA -user myusername -password mypassword getdisk $disk -serial)[1] | %{$_ -replace "Serial Number: ",""} | %{$_ -replace "State: ",""} | %{$_ -replace " ",""} New-Object PSObject -Property @{ i = $i cl = $row.cl Storage = $row.Name SP = "A" Date = $x[0] Time = $x[1] Disk = $disk Error = (($n -Split('</span></span>\[<span class="hljs-string"><span class="hljs-string">'))[0] -Split('</span></span>\)<span class="hljs-string"><span class="hljs-string">'))[1].Trim() eCode = (($n -Split('</span></span>\(<span class="hljs-string"><span class="hljs-string">'))[1] -Split('</span></span>\)<span class="hljs-string"><span class="hljs-string">'))[0] SN = $sn } $i = $i + 1 } Write-Host "SP B" Write-Host (Get-Date).ToString('</span></span>HH:mm:ss<span class="hljs-string"><span class="hljs-string">') $txt = .\NaviSECCli.exe -scope 0 -h $row.newB -user myusername -password mypassword getlog -date $mStart/$dStart/$yStart $mEnd/$dEnd/$yEnd | Select-String -Pattern "\(820\)","\(803\)","\(801\)","\(920\)","\(901\)" ForEach ($n in $txt) { $x = $n -Split('</span></span> <span class="hljs-string"><span class="hljs-string">') $disk = $x[3] + "_" + $x[5] + "_" + $x[7].Split("(")[0] $sn = (.\NaviSECCli.exe -scope 0 -h $row.newA -user myusername -password mypassword getdisk $disk -serial)[1] | %{$_ -replace "Serial Number: ",""} | %{$_ -replace "State: ",""} | %{$_ -replace " ",""} New-Object PSObject -Property @{ i = $i cl = $row.cl Storage = $row.Name SP = "B" Date = $x[0] Time = $x[1] Disk = $disk Error = (($n -Split('</span></span>\[<span class="hljs-string"><span class="hljs-string">'))[0] -Split('</span></span>\)<span class="hljs-string"><span class="hljs-string">'))[1].Trim() eCode = (($n -Split('</span></span>\(<span class="hljs-string"><span class="hljs-string">'))[1] -Split('</span></span>\)<span class="hljs-string"><span class="hljs-string">'))[0] SN = $sn } $i = $i + 1 } Write-Host " " } $table | select i,cl,Storage,SP,Date,Time,Disk,Error,eCode,SN | Export-Csv -Path '</span></span>d:\VNX-Errors.csv<span class="hljs-string"><span class="hljs-string">' -NoTypeInformation -UseCulture -Encoding UTF8</span></span></code> </pre> </div></div><br><p>  Tout allait bien, il ne restait plus qu'√† ajouter un ¬´gloss¬ª sous la forme d'un envoi automatique d'une lettre aux coll√®gues int√©ress√©s et d'une mise en forme minimale du csv obtenu.  Mais (!) Tous ces probl√®mes ont fonctionn√© pendant tr√®s longtemps.  Les donn√©es d'un mois, par exemple, ont √©t√© collect√©es environ <strong>45 minutes</strong> , ce qui n'√©tait pas tr√®s appropri√©, car en plus des rapports r√©guliers, je voulais faire une analyse pour l'ann√©e en cours, et ce serait tr√®s long.  Mais "rejeter - offrir".  Ils ont commenc√© √† r√©fl√©chir. </p><br><p><img src="https://habrastorage.org/webt/jn/85/ts/jn85tsztuso-z7ulzxh2a1jk7yq.jpeg"></p><br><p>  De toute √©vidence, vous devez optimiser le code et activer le calcul parall√®le.  Dans <strong>PowerShell</strong> , nous n'avons pas r√©ussi √† utiliser plus de 5 threads simultan√©s √† l'aide du <strong>workflow</strong> et nous n'avons pas encore "fum√©" d'autres m√©thodes.  Il a donc √©t√© d√©cid√© d'essayer de d√©placer la logique du script vers <strong>R.</strong>  L'utilitaire <strong>NaviSECCli</strong> , qui peut √™tre ex√©cut√© sous <strong>R</strong> , effectue l'√©tude du stockage dans le code source, donc la solution est tout √† fait appropri√©e. <br>  On dit - <del>  quelques jours </del>  - c'est fait! </p><br><p>  Nous avons d√©cid√© qu'√† la sortie, j'aimerais recevoir une newsletter quotidienne contenant le <strong>nombre total d'erreurs</strong> dans le texte de la lettre, une sorte de <strong>calendrier</strong> pour le nombre d'accidents (afin qu'il y ait quelque chose √† montrer √† la direction), ainsi <strong>qu'une pi√®ce jointe</strong> sous la forme d'un tableau xlsx.  Nous avons d√©termin√© que dans le tableau, je veux avoir 3 onglets: </p><br><ul><li>  Donn√©es sur les accidents pendant 3 jours par disque et type d'accident </li><li>  Un onglet similaire, mais pendant 30 jours </li><li>  Donn√©es brutes (si quelqu'un veut les ex√©cuter lui-m√™me dans Excel) </li></ul><br><h4 id="algoritm-skripta">  Algorithme de script </h4><br><p>  <strong>1.</strong> T√©l√©chargez depuis csv les donn√©es disponibles sur les contr√¥leurs; <br>  <strong>2.</strong> ex√©cuter en parall√®le le calcul d'un cycle pour tous les contr√¥leurs avec une recherche d'enregistrements des messages d'alarme requis; <br>  <strong>3.</strong> combiner les r√©sultats dans un bloc de donn√©es; <br>  <strong>4.</strong> faire le traitement et la conversion des donn√©es; <br>  <strong>5.</strong> g√©n√©rer un document xlsx; <br>  <strong>6. nous</strong> formons le programme que nous enregistrons en png; <br>  <strong>7.</strong> former une lettre contenant les donn√©es collect√©es; <br>  <strong>8.</strong> envoyez une lettre. </p><br><h2 id="proydyom-po-punktam-algoritma">  Passons en revue les points de l'algorithme </h2><br><h3 id="1-zagruzhaem-iz-csv-imeyuschiesya-dannye-po-kontrolleram">  1. T√©l√©chargez les donn√©es disponibles sur les contr√¥leurs depuis csv </h3><br><div class="spoiler">  <b class="spoiler_title">Format de table source avec param√®tres VNX</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># A tibble: 83 x 9 Name IP cl type newA newB oldA oldB cntIP &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 1 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ 2 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ 3 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ 4 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ 5 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ 6 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ 7 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ 8 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ 9 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ 10 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ # ... with 73 more rows</span></span></code> </pre> </div></div><br><p>  Pour collecter des informations d'urgence, vous devez vous connecter en s√©rie aux deux contr√¥leurs ( <em>colonnes</em> <em>newA</em> et <em>newB</em> ) √† l'aide d'un logiciel <em>EMC</em> sp√©cialis√© - <strong>NaviCLI</strong> avec certaines cl√©s. <br>  Pour plus de commodit√©, nous reformatons la table r√©sultante apr√®s le chargement afin que les adresses IP des deux contr√¥leurs soient dans la m√™me colonne, afin que vous puissiez effectuer un cycle dans la liste, et non deux cons√©cutives.  Nous le faisons en utilisant la fonction de <strong>collecte</strong> .  Les probl√®mes de travailler avec des formats de donn√©es "verticaux" ou "horizontaux" sont tr√®s bien d√©crits dans la documentation officielle de la biblioth√®que <strong>tidyverse</strong> .  Vous pouvez le lire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">ici</a> . </p><br><p>  Nous lisons les donn√©es √† l'aide de la fonction <strong>read_csv2</strong> , nous d√©terminons √©galement manuellement les types de colonnes via le param√®tre suppl√©mentaire <strong>col_types</strong> .  Il s'agit d'une bonne pratique, car  acc√©l√®re consid√©rablement le chargement.  Dans notre cas, ce n'est pas si important, car  Le csv d'origine contient moins de 100 lignes, mais nous nous habituons √† √©crire correctement. </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   IP VNX. #         , #   ip        . VNX_ip &lt;- vnxIPfilePath %&gt;% read_csv2( col_types = cols( Name = col_character(), IP = col_character(), cl = col_character(), type = col_character(), newA = col_character(), newB = col_character(), oldA = col_character(), oldB = col_character() ) ) %&gt;% filter(cl %in% productCls) %&gt;% gather(key = "cntName", value = "cntIP", 5:6)</span></span></code> </pre> <br><p>  En sortie, nous obtenons une telle trame de donn√©es (les nouvelles colonnes sont <strong>cntName</strong> et <strong>cntIP</strong> ): </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># A tibble: 30 x 8 Name IP cl type oldA oldB cntName cntIP &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 1 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ 2 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ 3 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ 4 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ 5 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ 6 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ 7 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ 8 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ 9 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ 10 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ # ... with 20 more rows</span></span></code> </pre> <br><h3 id="2-3-zapuskaem-cherez-parallelnye-vychisleniya-cikl-po-vsem-kontrolleram-s-poiskom-zapisey-o-trebuemyh-avariynyh-soobscheniyah-rezultaty-obedinyaem-v-data-frame">  2-3.  Nous effectuons des calculs parall√®les un cycle pour tous les contr√¥leurs avec une recherche d'enregistrements des messages d'alarme requis.  Combinez les r√©sultats dans une trame de donn√©es </h3><br><p>  Le suivant est le plus int√©ressant.  <em>Informatique parall√®le</em> . </p><br><p>  Dans <strong>R, il existe</strong> plusieurs (plut√¥t, m√™me plusieurs) options pour le calcul parall√®le.  J'ai plus aim√© le lien des biblioth√®ques <strong>foreach</strong> et <strong>doParallel</strong> .  Vous pouvez lire √† leur sujet et d'autres options de calcul parall√®le dans <strong>R</strong> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">ici</a> . </p><br><p>  En bref, nous prenons seulement <strong>3 √©tapes</strong> : <br>  <strong>√âtape 1</strong>  Enregistrer les noyaux <del>  √©meraude pure </del>  CPU pour travailler en informatique parall√®le via <strong>registerDoParallel</strong> (dans notre cas, nous d√©tectons d'abord le nombre de c≈ìurs en cas) </p><br><div class="spoiler">  <b class="spoiler_title">Enregistrer les c≈ìurs de processeur</b> <div class="spoiler_text"><pre> <code class="python hljs">numCores &lt;- detectCores() registerDoParallel(numCores)</code> </pre> </div></div><br><p>  <strong>√âtape 2</strong>  Nous commen√ßons le cycle par <strong>foreach</strong> (n'oubliez pas de sp√©cifier l'op√©rateur <strong>% dopar%</strong> pour que le cycle se d√©roule en parall√®le et d'indiquer, via le param√®tre <strong>.combine, la</strong> mani√®re dont nous allons collecter le r√©sultat).  Dans notre cas <strong>.combine = rbind</strong> , car √† la sortie de chaque boucle, nous aurons une <strong>trame de donn√©es</strong> . </p><br><div class="spoiler">  <b class="spoiler_title">Code de r√©cup√©ration de table d'erreur</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#      VNX   ip   . #      ,      #   ,      dataframe #  %dopar%   . #    ,   system.time   , #    %dopar%  %do%.      4-5. # system.time({ errors_df &lt;- foreach(i = 1:nrow(VNX_ip), .combine = rbind, .packages = "tidyverse") %dopar% { errors_raw &lt;- system( paste( "NaviSECCli.exe -scope 0 -h", VNX_ip$cntIP[i], "-user myusername -password mypassword getlog -date", bigPeriodForm, currDateForm ), intern = TRUE ) %&gt;% str_subset(pattern = regex(paste0(errorNumbers, collapse = "|"))) #      ,       if (length(errors_raw) &gt; 0) { #     #       , #     , #       . errorsDescr &lt;- errors_raw %&gt;% gsub("(.*\\) )(.*)(\\s+\\[.*)", "\\2", x = .) %&gt;% trimws() %&gt;% gsub('([[:punct:]])|\\s+', '_', .) #           errors &lt;- errors_raw %&gt;% str_split(pattern = "\\s+", simplify = T) %&gt;% as_tibble() %&gt;% mutate(Disk = paste0(V4, "_", V6, "_", V8) %&gt;% gsub( pattern = "\\([0-9]{3}\\)", replacement = "", x = .) ) #  dataframe    data_frame(cl = VNX_ip$cl[i], Storage = VNX_ip$Name[i], Date = errors$V1 %&gt;% as.Date(format = "%m/%d/%Y"), Time = errors$V2, Disk = errors$Disk, Error = errorsDescr, eCode = errors$V8 %&gt;% str_extract(paste0(errorNumbers, collapse = "|")) %&gt;% str_extract("[0-9]+")) %&gt;% mutate(DateTime = as.POSIXct(paste(Date, Time), format = "%Y-%m-%d %H:%M:%S")) } } # })</span></span></code> </pre> </div></div><br><p>  <strong>√âtape 3</strong>  Nous <strong>effa√ßons le</strong> cluster de parall√©lisme cr√©√© via <strong>stopImplicitCluster ()</strong> </p><br><h4 id="chut-podrobnee-po-poluchenii-chitaemoy-tablicy-iz-raw-teksta-oshibok">  Un peu plus de d√©tails sur l'obtention d'un tableau lisible √† partir d'un texte d'erreur brut </h4><br><p>  Sous forme de texte, les erreurs sont les suivantes: </p><br><pre> <code class="python hljs">head(errors_raw) [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"07/13/2019 00:01:46 Bus 0 Enclosure 3 Disk 9(801) Soft SCSI Bus Error [0x00] 841d1080 10006 "</span></span> [<span class="hljs-number"><span class="hljs-number">2</span></span>] <span class="hljs-string"><span class="hljs-string">"07/13/2019 00:01:46 Bus 0 Enclosure 3 Disk 9(801) Soft SCSI Bus Error [0x00] 841e1a00 10006 "</span></span> [<span class="hljs-number"><span class="hljs-number">3</span></span>] <span class="hljs-string"><span class="hljs-string">"07/13/2019 00:01:46 Bus 0 Enclosure 3 Disk 9(801) Soft SCSI Bus Error [0x00] 8420b600 10006 "</span></span> [<span class="hljs-number"><span class="hljs-number">4</span></span>] <span class="hljs-string"><span class="hljs-string">"07/13/2019 00:01:46 Bus 0 Enclosure 3 Disk 9(801) Soft SCSI Bus Error [0x00] 84206900 10006 "</span></span> [<span class="hljs-number"><span class="hljs-number">5</span></span>] <span class="hljs-string"><span class="hljs-string">"07/13/2019 00:01:46 Bus 0 Enclosure 3 Disk 9(801) Soft SCSI Bus Error [0x00] 841fc900 10006 "</span></span> [<span class="hljs-number"><span class="hljs-number">6</span></span>] <span class="hljs-string"><span class="hljs-string">"07/13/2019 00:01:46 Bus 0 Enclosure 3 Disk 9(801) Soft SCSI Bus Error [0x00] 841fc000 10006</span></span></code> </pre> <br><p>  Ici, nous avons des valeurs s√©par√©es par un espace qui, √† premi√®re vue, m√™me en <em>csv sera</em> ins√©r√© normalement.  Mais ce n'est pas si simple.  La complexit√© de l'analyse ici est la suivante: </p><br><ul><li>  la date et l'heure sont √©galement s√©par√©es par un espace (le plus petit des maux); </li><li>  le texte d'erreur est constitu√© de "mots", c'est-√†-dire  √©galement s√©par√© par un espace; </li><li>  pour une raison quelconque, il n'y a pas d'espace entre le num√©ro de disque et le code d'erreur (qui est entre crochets). <br>  En g√©n√©ral, un paradis pour un amoureux des expressions r√©guli√®res :) </li></ul><br><p><img src="https://habrastorage.org/webt/yk/rf/2i/ykrf2irog7eq_o3j3d0-ijnild0.jpeg" alt="B√¢tard malade"></p><br><p>  Je ne m'attarderai pas sur l'analyse, car c'est une question de go√ªt, mais je pr√©ciserai que le texte d'erreur devait √™tre d√©chir√©, car les valeurs situ√©es entre la parenth√®se fermante du num√©ro d'erreur et le crochet ouvrant d'une autre valeur.  Dans une boucle, c'est la variable des <strong>erreurs</strong> . </p><br><p>  Il est √©galement int√©ressant de noter que, pour faciliter la cr√©ation de la trame de donn√©es finale, nous, souhaitant parcourir les adresses IP des contr√¥leurs, d√©finissons la s√©quence non pas via la colonne avec les adresses IP des contr√¥leurs (c'est-√†-dire <strong>i = VNX_ip $ cntIP</strong> ), mais via le num√©ro de ligne (c'est-√†-dire e. <strong>i = 1: nrow (VNX_ip)</strong> ).  Cela nous permet, lors de la formation d'une trame de donn√©es avec des erreurs d√©j√† analys√©es, d'ajouter le num√©ro de cluster et le nom de stockage via les appels <strong>VNX_ip $ cl [i]</strong> et <strong>VNX_ip $ Name [i]</strong> respectivement.  Sans cela, des jointures devraient √™tre faites, ce qui serait plus lent et pire √† lire dans le code. </p><br><p>  En fin de compte, nous obtenons une trame de donn√©es (pour √™tre honn√™te, puis <strong>tibble</strong> , mais la diff√©rence d√©passe la port√©e de l'article), qui contient toutes les donn√©es dont nous avons besoin.  C'est-√†-dire  sur quel syst√®me de stockage, sur quel disque, quand quelle erreur s'est produite. </p><br><div class="spoiler">  <b class="spoiler_title">Vue finale Trame de donn√©es</b> <div class="spoiler_text"><pre> <code class="python hljs">&gt; errors_df <span class="hljs-comment"><span class="hljs-comment"># A tibble: 2,705 x 8 cl Storage Date Time Disk Error eCode DateTime &lt;chr&gt; &lt;chr&gt; &lt;date&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;dttm&gt; 1 XclNam~ XStorageN~ 2019-07-18 12:09:~ 0_1_3 Soft_SCSI_~ 801 2019-07-18 12:09:55 2 XclNam~ XStorageN~ 2019-07-18 15:09:~ 0_1_3 Soft_SCSI_~ 801 2019-07-18 15:09:56 3 XclNam~ XStorageN~ 2019-07-18 16:28:~ 0_1_3 Soft_SCSI_~ 801 2019-07-18 16:28:50 4 XclNam~ XStorageN~ 2019-07-19 06:36:~ 0_1_6 Soft_SCSI_~ 801 2019-07-19 06:36:39 5 XclNam~ XStorageN~ 2019-07-19 20:57:~ 0_1_6 Soft_Media~ 820 2019-07-19 20:57:35 6 XclNam~ XStorageN~ 2019-07-22 11:00:~ 0_2_~ Soft_SCSI_~ 801 2019-07-22 11:00:43 7 XclNam~ XStorageN~ 2019-07-22 11:00:~ 0_2_~ Soft_SCSI_~ 801 2019-07-22 11:00:44 8 XclNam~ XStorageN~ 2019-07-22 12:02:~ 0_2_~ Soft_SCSI_~ 801 2019-07-22 12:02:31 9 XclNam~ XStorageN~ 2019-07-23 23:29:~ 0_3_8 Soft_SCSI_~ 801 2019-07-23 23:29:49 10 XclNam~ XStorageN~ 2019-07-13 00:01:~ 0_3_9 Soft_SCSI_~ 801 2019-07-13 00:01:46 # ... with 2,695 more rows</span></span></code> </pre> </div></div><br><p>  La chose la plus intelligente est que le cycle entier d'interrogation parall√®le de tous les syst√®mes de stockage ne prend <strong>pas 30 minutes, mais 30 secondes</strong> . </p><br><p>  <em>Dieu merci, ce n'est pas le cas lorsque 30 secondes sont trop rapides.</em> <br><img src="https://habrastorage.org/webt/pr/nf/u9/prnfu9eet3au2ktv5-uk1vauskk.jpeg" alt="une blague"></p><br><p>  Il convient de pr√©ciser que le code <strong>PowerShell a</strong> √©galement collect√© les num√©ros de s√©rie des disques de tous les syst√®mes de stockage dans un cycle, et au moment de la r√©√©criture du code sur <strong>R,</strong> ces donn√©es √©taient redondantes.  La comparaison de l'ex√©cution n'est donc pas tout √† fait honn√™te, mais reste impressionnante. </p><br><h3 id="4-5-obrabotka-i-preobrazovanie-dannyh-formirovanie-xlsx-dokumenta">  4-5.  Traitement et conversion des donn√©es.  G√©n√©ration d'un document xlsx </h3><br><p>  La conversion des donn√©es pour les documents xlsx a √©t√© r√©duite au filtrage de la table source au cours des 3 derniers jours, ainsi qu'au mois dernier et √† la conversion des colonnes avec les noms d'erreur au format "horizontal", de sorte que chaque type d'erreur se trouvait dans une colonne distincte.  Une fonction distincte a √©t√© √©crite pour cela (afin de ne pas dupliquer les m√™mes √©tapes 2 fois) </p><br><div class="spoiler">  <b class="spoiler_title">Fonction de filtrage des sources</b> <div class="spoiler_text"><pre> <code class="python hljs">myErrorStats &lt;- function(data, period, orderColname = quo(Soft_Media_Error)) { data %&gt;% filter(Date &gt; period) %&gt;% group_by(cl, Storage, Disk, Error) %&gt;% summarise(count = n()) %&gt;% spread(Error, count, fill = <span class="hljs-number"><span class="hljs-number">0</span></span>) %&gt;% arrange(desc(!!orderColname)) }</code> </pre> </div></div><br><p>  Pour afficher les types d'erreurs dans une colonne distincte, la fonction d' <strong>√©talement a</strong> √©t√© appliqu√©e avec la cl√© suppl√©mentaire <strong>fill = 0</strong> , avec laquelle les valeurs manquantes ont √©t√© remplies avec <strong>0</strong> .  Sans cette cl√©, s'il n'y avait pas un jour un certain type d'erreur, la colonne correspondante aurait des valeurs <strong>NA</strong> . </p><br><p>  De plus, dans la fonction, je voulais garder la possibilit√© de passer le nom de la colonne pour le tri en tant que variable, mais en m√™me temps avoir des valeurs par d√©faut pour cette variable.  Pour cela, la syntaxe particuli√®re <strong>dplyr est utilis√©e</strong> , dont vous pouvez lire plus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">ici</a> . </p><br><p>  Dans notre cas, lors de la d√©finition des param√®tres d'une fonction, nous mettons l'un d'entre eux √† la valeur par d√©faut et le <em>citons</em> ( <strong>orderColname = quo (Soft_Media_Error)</strong> ), puis, lorsqu'il est appel√©, nous mettons des caract√®res devant lui <strong>!!</strong>  pour obtenir l' <strong>arrangement (desc (!! orderColname))</strong> . </p><br><div class="spoiler">  <b class="spoiler_title">L'apparence du tableau avec des erreurs pour le mois</b> <div class="spoiler_text"><pre> <code class="python hljs">&gt; errorsBigPeriod <span class="hljs-comment"><span class="hljs-comment"># A tibble: 77 x 7 cl Storage Disk Hard_SCSI_Bus_E~ Recommend_Disk_~ Soft_Media_Error &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; 1 XclN~ XStora~ 1_1_~ 0 1 64 2 XclN~ XStora~ 0_2_5 0 0 29 3 XclN~ XStora~ 1_1_~ 0 1 29 4 XclN~ XStora~ 0_3_2 0 0 27 5 XclN~ XStora~ 0_3_~ 1 0 25 6 XclN~ XStora~ 1_3_5 0 1 23 7 XclN~ XStora~ 0_2_9 0 0 21 8 XclN~ XStora~ 0_3_4 0 0 14 9 XclN~ XStora~ 0_1_~ 0 0 14 10 XclN~ XStora~ 1_0_1 0 0 12 # ... with 67 more rows, and 1 more variable: Soft_SCSI_Bus_Error &lt;dbl&gt;</span></span></code> </pre> </div></div><br><p>  J'ai analys√© la formation du document xlsx dans l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article sur les rapports sur l'√©tat de la VM</a> , donc je ne m'attarderai pas sur les d√©tails.  Tout le code est donn√© √† la fin de l'article. </p><br><p><img src="https://habrastorage.org/webt/td/7v/vx/td7vvxmj5guiwtxhjyxif4cany8.jpeg"></p><br><p>  Voici des fonctionnalit√©s importantes qui am√©liorent la lisibilit√© du rapport: </p><br><ul><li>  Onglets sign√©s (par d√©faut le plus int√©ressant est ouvert); </li><li>  Noms de colonnes en surbrillance </li><li>  Mise en forme automatique de toutes les colonnes afin que tout le texte soit lisible sans avoir √† d√©velopper les colonnes. </li></ul><br><h3 id="6-formiruem-grafik-kotoryy-sohranyaem-v-png">  6. cr√©er un calendrier que nous enregistrons en png </h3><br><p>  Sur le graphique, je voulais obtenir le nombre total d'erreurs par jour pour tous les syst√®mes de stockage par type.  En tant qu'outil de dessin, il a √©t√© d√©cid√© d'utiliser la biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">ggplot2</a> standard. </p><br><p>  La premi√®re version du graphique montrait toutes les erreurs sur un graphique et ressemblait √† ceci: </p><br><p><img src="https://habrastorage.org/webt/7t/jc/aj/7tjcajacotjzcoo3y0j9oc2od80.png"></p><br><p>  Des coll√®gues ont d√©clar√© que cela s'est av√©r√© illisible. <br><del>  Que comprendraient-ils? !!!! </del><br>  Les remarques ont √©t√© prises en compte et la fonction <strong>facet_grid a</strong> √©t√© ajout√©e aux colonnes standard ( <strong>geom_bar</strong> ) pour diviser le r√©sultat en graphiques s√©par√©s par type d'erreur. <br>  Le r√©sultat final convenait √† tout le monde. </p><br><p><img src="https://habrastorage.org/webt/l1/vc/v5/l1vcv5950ji9iymrlyrij0uds3w.png" alt="Calendrier r√©capitulatif"></p><br><div class="spoiler">  <b class="spoiler_title">Pr√©paration des donn√©es, repr√©sentation graphique, enregistrement dans un fichier</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">####   #### #       errorsTotal &lt;- errors_df %&gt;% group_by(Date, Error) %&gt;% summarise(count = n()) %&gt;% # spread(Error, count, fill = 0) %&gt;% arrange(desc(Date)) #        . #       ,   . plot &lt;- errorsTotal %&gt;% ggplot(aes(x = Date, y = count, fill = Error)) + geom_bar(stat = "identity", width = 0.5, color = "grey") + theme_minimal() + # theme(legend.position="top") + scale_color_grey() + labs(title = "  EMC VNX", subtitle = "        ", fill = " ") + xlab("") + ylab("   ") + scale_fill_brewer(palette = "Spectral") + facet_grid(rows = vars(factor( Error, levels = c( "Soft_SCSI_Bus_Error", "Soft_Media_Error", "Hard_SCSI_Bus_Error", "Recommend_Disk_Replacement" ) ))) # #   # plot #   png,     plot_filePath &lt;- file.path("results", "plot.png") #    png     ggsave(filename = plot_filePath, plot = plot)</span></span></code> </pre> </div></div><br><p>  De l'int√©ressant dans la formation du calendrier. </p><br><p>  Je voulais que les graphiques soient dans un certain ordre.  Pour ce faire, le param√®tre de formation de lignes dans <strong>facet_grid</strong> a d√ª √™tre transf√©r√© en tant que facteur, ou plut√¥t m√™me en tant <strong>que facteur ordonn√©</strong> .  Le facteur est un format de donn√©es aussi astucieux dans R, qui est un ensemble de valeurs (dans notre cas, des cha√Ænes, c'est-√†-dire des <strong>caract√®res</strong> ), et l'ensemble de ces valeurs est strictement d√©fini (appel√© niveaux de facteur), et m√™me ces niveaux sont tri√©s.  Cela semble compliqu√©, mais tout se met en place si vous dites que les noms des mois sont un excellent exemple d'un facteur ordonn√©.  C'est-√†-dire  nous savons quels noms les mois peuvent avoir, et nous savons aussi (enfin, j'esp√®re) que viennent d'abord janvier, puis f√©vrier, puis mars, etc.  C'est sur le m√™me principe que nous cr√©ons un facteur. </p><br><h3 id="7-8-formiruem-pismo-soderzhaschee-sobrannye-dannye-otpravlyaem-pismo">  7-8.  Nous formons une lettre contenant les donn√©es collect√©es.  Envoyez une lettre </h3><br><p>  La formation et l'envoi de lettres, ainsi que la formation de t√¢ches dans <strong>le planificateur Windows ont</strong> √©galement <strong>√©t√©</strong> examin√©es dans l'article sur les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rapports sur l'√©tat de la machine virtuelle</a> .  On met simplement quelques variables dans le texte et on le formate plus ou moins clairement.  N'oubliez pas la pi√®ce jointe. </p><br><div class="spoiler">  <b class="spoiler_title">La forme finale de la lettre</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/w6/rg/fi/w6rgfilewjuf24olnavadpu6zhm.jpeg"></p></div></div><br><h2 id="vyvody">  Conclusions </h2><br><p>  <strong>R</strong> s'est de nouveau r√©v√©l√© √™tre un outil universel pour effectuer les t√¢ches quotidiennes et visualiser leurs r√©sultats.  Et avec le calcul parall√®le activ√©, cet outil devient √©galement rapide. <br>  La pratique a √©galement montr√© que <strong>PowerShell</strong> est extr√™mement lent √† analyser les journaux et √† les traduire dans un format lisible. <br>  Un grand merci √† tous ceux qui ont lu tant de lettres jusqu'√† la fin. </p><br><h4 id="polnostyu-kod-prilozheniya">  Code d'application complet </h4><br><div class="spoiler">  <b class="spoiler_title">Code d'application Full R</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#### ENV #### #         (    system32) setwd("C:\\Scripts\\VNX_disks_check/") #   library(tidyverse) library(lubridate) library(zoo) library(stringi) library(xlsx) library(mailR) library(foreach) library(doParallel) #### CONST #### #            vnxIPfilePath &lt;- file.path("data", "VNX-IP.csv") #     bigPeriod &lt;- Sys.Date() - 30 #     smallPeriod &lt;- Sys.Date() - 3 #    productCls &lt;- c("name1", "name2", "name3") #   IP VNX. #         , #   ip        . VNX_ip &lt;- vnxIPfilePath %&gt;% read_csv2( col_types = cols( Name = col_character(), IP = col_character(), cl = col_character(), type = col_character(), newA = col_character(), newB = col_character(), oldA = col_character(), oldB = col_character() ) ) %&gt;% filter(cl %in% productCls) %&gt;% gather(key = "cntName", value = "cntIP", 5:6) ####    VNX #### #         (      ) # NaviSECCli.exe -scope 0 -h 10.201.16.15 -user root -password Secrt4yo getlog -date 07/16/2019 07/17/2019 #   ,   . #      ,       errorNumbers &lt;- c("\\(820\\)", "\\(803\\)", "\\(801\\)", "\\(920\\)", "\\(901\\)") ##   ## #         numCores &lt;- detectCores() registerDoParallel(numCores) #    ,   NaviCLI #  1    ,     "" , # ..   ,      ,     . bigPeriodForm &lt;- bigPeriod %&gt;% format(format = "%m/%d/%Y") currDateForm &lt;- (Sys.Date() + 1) %&gt;% format(format = "%m/%d/%Y") #    . #      VNX   ip   . #      ,      #   ,      dataframe #  %dopar%   . #    ,   system.time   , #    %dopar%  %do%.      4-5. # system.time({ errors_df &lt;- foreach(i = 1:nrow(VNX_ip), .combine = rbind, .packages = "tidyverse") %dopar% { errors_raw &lt;- system( paste( "NaviSECCli.exe -scope 0 -h", VNX_ip$cntIP[i], "-user myusername -password mypassword getlog -date", bigPeriodForm, currDateForm ), intern = TRUE ) %&gt;% str_subset(pattern = regex(paste0(errorNumbers, collapse = "|"))) #      ,       if (length(errors_raw) &gt; 0) { #       , #     , #       . errorsDescr &lt;- errors_raw %&gt;% gsub("(.*\\) )(.*)(\\s+\\[.*)", "\\2", x = .) %&gt;% trimws() %&gt;% gsub('([[:punct:]])|\\s+', '_', .) #           errors &lt;- errors_raw %&gt;% str_split(pattern = "\\s+", simplify = T) %&gt;% as_tibble() %&gt;% mutate(Disk = paste0(V4, "_", V6, "_", V8) %&gt;% gsub( pattern = "\\([0-9]{3}\\)", replacement = "", x = .) ) #  dataframe    data_frame(cl = VNX_ip$cl[i], Storage = VNX_ip$Name[i], Date = errors$V1 %&gt;% as.Date(format = "%m/%d/%Y"), Time = errors$V2, Disk = errors$Disk, Error = errorsDescr, eCode = errors$V8 %&gt;% str_extract(paste0(errorNumbers, collapse = "|")) %&gt;% str_extract("[0-9]+")) %&gt;% mutate(DateTime = as.POSIXct(paste(Date, Time), format = "%Y-%m-%d %H:%M:%S")) } } # }) #     .      ,    . stopImplicitCluster() ####  #### #    .    ,     .  . # https://dplyr.tidyverse.org/articles/programming.html myErrorStats &lt;- function(data, period, orderColname = quo(Soft_Media_Error)) { data %&gt;% filter(Date &gt; period) %&gt;% group_by(cl, Storage, Disk, Error) %&gt;% summarise(count = n()) %&gt;% spread(Error, count, fill = 0) %&gt;% arrange(desc(!!orderColname)) } #           .  . errorsBigPeriod &lt;- errors_df %&gt;% myErrorStats(bigPeriod) #             errorsSmallPeriod &lt;- errors_df %&gt;% myErrorStats(smallPeriod) #   ,     errors_filePath &lt;- file.path("results", "VNX_Errors.xlsx") ####  xlsx  #### #    wb&lt;-createWorkbook(type="xlsx") #         TABLE_ROWNAMES_STYLE &lt;- CellStyle(wb) + Font(wb, isBold=TRUE) TABLE_COLNAMES_STYLE &lt;- CellStyle(wb) + Font(wb, isBold=TRUE) + Alignment(wrapText=TRUE, horizontal="ALIGN_CENTER") + Border(color="black", position=c("TOP", "BOTTOM"), pen=c("BORDER_THIN", "BORDER_THICK")) #  t s sheetSmall &lt;- createSheet(wb, sheetName = " 3 ") sheetBig &lt;- createSheet(wb, sheetName = " ") sheetRaw &lt;- createSheet(wb, sheetName = " ") ##   addDataFrame( errorsSmallPeriod %&gt;% as.data.frame(), sheetSmall, startRow = 1, startColumn = 1, row.names = FALSE, byrow = FALSE, colnamesStyle = TABLE_COLNAMES_STYLE, rownamesStyle = TABLE_ROWNAMES_STYLE ) addDataFrame( errorsBigPeriod %&gt;% as.data.frame(), sheetBig, startRow = 1, startColumn = 1, row.names = FALSE, byrow = FALSE, colnamesStyle = TABLE_COLNAMES_STYLE, rownamesStyle = TABLE_ROWNAMES_STYLE ) #          DateTime     addDataFrame( errors_df %&gt;% as.data.frame() %&gt;% arrange(desc(DateTime)), sheetRaw, startRow = 1, startColumn = 1, row.names = FALSE, byrow = FALSE, colnamesStyle = TABLE_COLNAMES_STYLE, rownamesStyle = TABLE_ROWNAMES_STYLE ) #  ,     autoSizeColumn(sheet = sheetSmall, colIndex=c(1:ncol(errorsSmallPeriod))) autoSizeColumn(sheet = sheetBig, colIndex=c(1:ncol(errorsBigPeriod))) autoSizeColumn(sheet = sheetRaw, colIndex=c(1:ncol(errors_df))) #     .   - . if (file.exists(errors_filePath)) {file.remove(errors_filePath)} #  xlsx  saveWorkbook(wb, errors_filePath) ####   #### #       errorsTotal &lt;- errors_df %&gt;% group_by(Date, Error) %&gt;% summarise(count = n()) %&gt;% # spread(Error, count, fill = 0) %&gt;% arrange(desc(Date)) #         plot &lt;- errorsTotal %&gt;% ggplot(aes(x = Date, y = count, fill = Error)) + geom_bar(stat = "identity", width = 0.5, color = "grey") + theme_minimal() + # theme(legend.position="top") + scale_color_grey() + labs(title = "  EMC VNX", subtitle = "        ", fill = " ") + xlab("") + ylab("   ") + scale_fill_brewer(palette = "Spectral") + facet_grid(rows = vars(factor( Error, levels = c( "Soft_SCSI_Bus_Error", "Soft_Media_Error", "Hard_SCSI_Bus_Error", "Recommend_Disk_Replacement" ) ))) # #   # plot #   png,     plot_filePath &lt;- file.path("results", "plot.png") #    png     ggsave(filename = plot_filePath, plot = plot) ####    #### #    emailRecepientsList &lt;- c("sendall-tech@domain.ru") #      emailParams &lt;- list( from = "login@domain.ru", to = emailRecepientsList, smtpParams = list( host.name = "10.10.10.1", port = 25, user.name = "login@domain.ru", passwd = "mypassword", ssl = FALSE ) ) #     (    ). #     ,          ,     . errorsTotal &lt;- errorsSmallPeriod[-c(1,2,3)] %&gt;% sum() #    emailBody &lt;- paste0( '&lt;html&gt; &lt;h3&gt; ,  .&lt;/h3&gt; &lt;p&gt;  3    &lt;strong&gt;', errorsTotal, '&lt;/strong&gt;    EMC VNX&lt;/p&gt; &lt;p&gt;       ,      .&lt;/p&gt; &lt;p&gt;  3 : &lt;ul&gt; &lt;li&gt;   3 .   &lt;strong&gt;Soft_Media_Error&lt;/strong&gt;.&lt;/li&gt; &lt;li&gt;  30 .   &lt;strong&gt;Soft_Media_Error&lt;/strong&gt;.&lt;/li&gt; &lt;li&gt; .   &lt;strong&gt;&lt;/strong&gt;.&lt;/li&gt; &lt;/ul&gt;          .   .&lt;/p&gt; &lt;p&gt;&lt;img src="', plot_filePath, '"&gt;&lt;/p&gt; &lt;/html&gt;' ) ####      #### send.mail(from = emailParams$from, to = emailParams$to, subject = "     EMC VNX", body = emailBody, encoding = "utf-8", html = TRUE, inline = TRUE, smtp = emailParams$smtpParams, authenticate = TRUE, send = TRUE, attach.files = c(errors_filePath), debug = FALSE)</span></span></code> </pre> </div></div><br><h2 id="parametry-okruzheniya-i-versii-ispolzuemogo-po">       </h2><br><ul><li> <strong> </strong> : EMC VNX 5300 </li><li> <strong>    </strong> : NaviCLI-Win-32-x86-en_US-7.31.25.1.29-1 </li><li> <strong>  ,    </strong> : 4*2 CPU, 8 Gb RAM </li></ul><br><div class="spoiler"> <b class="spoiler_title">  R</b> <div class="spoiler_text"><pre> <code class="python hljs">&gt; sessionInfo() R version <span class="hljs-number"><span class="hljs-number">3.5</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> (<span class="hljs-number"><span class="hljs-number">2019</span></span><span class="hljs-number"><span class="hljs-number">-03</span></span><span class="hljs-number"><span class="hljs-number">-11</span></span>) Platform: x86_64-w64-mingw32/x64 (<span class="hljs-number"><span class="hljs-number">64</span></span>-bit) Running under: Windows Server <span class="hljs-number"><span class="hljs-number">2012</span></span> R2 x64 (build <span class="hljs-number"><span class="hljs-number">9600</span></span>) Matrix products: default locale: [<span class="hljs-number"><span class="hljs-number">1</span></span>] LC_COLLATE=Russian_Russia<span class="hljs-number"><span class="hljs-number">.1251</span></span> LC_CTYPE=Russian_Russia<span class="hljs-number"><span class="hljs-number">.1251</span></span> LC_MONETARY=Russian_Russia<span class="hljs-number"><span class="hljs-number">.1251</span></span> [<span class="hljs-number"><span class="hljs-number">4</span></span>] LC_NUMERIC=C LC_TIME=Russian_Russia<span class="hljs-number"><span class="hljs-number">.1251</span></span> attached base packages: [<span class="hljs-number"><span class="hljs-number">1</span></span>] parallel stats graphics grDevices utils datasets methods base other attached packages: [<span class="hljs-number"><span class="hljs-number">1</span></span>] taskscheduleR_1<span class="hljs-number"><span class="hljs-number">.4</span></span> pander_0<span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> doParallel_1<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.14</span></span> iterators_1<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> foreach_1<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> mailR_0<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> [<span class="hljs-number"><span class="hljs-number">7</span></span>] xlsx_0<span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> stringi_1<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> zoo_1<span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">-6</span></span> lubridate_1<span class="hljs-number"><span class="hljs-number">.7</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> wesanderson_0<span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span> forcats_0<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> [<span class="hljs-number"><span class="hljs-number">13</span></span>] stringr_1<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> dplyr_0<span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> purrr_0<span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> readr_1<span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> tidyr_0<span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> tibble_2<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> [<span class="hljs-number"><span class="hljs-number">19</span></span>] ggplot2_3<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> tidyverse_1<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> loaded via a namespace (<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> attached): [<span class="hljs-number"><span class="hljs-number">1</span></span>] tidyselect_0<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> reshape2_1<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> rJava_0<span class="hljs-number"><span class="hljs-number">.9</span></span><span class="hljs-number"><span class="hljs-number">-11</span></span> haven_2<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> lattice_0<span class="hljs-number"><span class="hljs-number">.20</span></span><span class="hljs-number"><span class="hljs-number">-38</span></span> colorspace_1<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span> [<span class="hljs-number"><span class="hljs-number">7</span></span>] vctrs_0<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> generics_0<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> utf8_1<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> rlang_0<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> R.oo_1<span class="hljs-number"><span class="hljs-number">.22</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> pillar_1<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> [<span class="hljs-number"><span class="hljs-number">13</span></span>] glue_1<span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> withr_2<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> R.utils_2<span class="hljs-number"><span class="hljs-number">.9</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> RColorBrewer_1<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span> modelr_0<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> readxl_1<span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> [<span class="hljs-number"><span class="hljs-number">19</span></span>] plyr_1<span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> munsell_0<span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> gtable_0<span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> cellranger_1<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> rvest_0<span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> R.methodsS3_1<span class="hljs-number"><span class="hljs-number">.7</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> [<span class="hljs-number"><span class="hljs-number">25</span></span>] codetools_0<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">-16</span></span> labeling_0<span class="hljs-number"><span class="hljs-number">.3</span></span> fansi_0<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> xlsxjars_0<span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> broom_0<span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> Rcpp_1<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> [<span class="hljs-number"><span class="hljs-number">31</span></span>] scales_1<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> backports_1<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> jsonlite_1<span class="hljs-number"><span class="hljs-number">.6</span></span> digest_0<span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.20</span></span> hms_0<span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> grid_3<span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> [<span class="hljs-number"><span class="hljs-number">37</span></span>] cli_1<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> tools_3<span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> magrittr_1<span class="hljs-number"><span class="hljs-number">.5</span></span> lazyeval_0<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> crayon_1<span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> pkgconfig_2<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> [<span class="hljs-number"><span class="hljs-number">43</span></span>] zeallot_0<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> data.table_1<span class="hljs-number"><span class="hljs-number">.12</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> xml2_1<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> assertthat_0<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> httr_1<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> rstudioapi_0<span class="hljs-number"><span class="hljs-number">.10</span></span> [<span class="hljs-number"><span class="hljs-number">49</span></span>] R6_2<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> nlme_3<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">-137</span></span> compiler_3<span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span></code> </pre> </div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr461441/">https://habr.com/ru/post/fr461441/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr461431/index.html">¬´Aime et n'aime pas¬ª: DNS sur HTTPS</a></li>
<li><a href="../fr461433/index.html">Utilisation d'Identity Server 4 dans Net Core 3.0</a></li>
<li><a href="../fr461435/index.html">Reconnaissance des √©motions √† l'aide d'un r√©seau neuronal convolutif</a></li>
<li><a href="../fr461437/index.html">370 ampoules</a></li>
<li><a href="../fr461439/index.html">D√©marrage de la biblioth√®que de composants React et TypeScript</a></li>
<li><a href="../fr461443/index.html">Post-analyse: ce que l'on sait de la derni√®re attaque contre le r√©seau de serveurs de cl√©s cryptographiques SKS Keyserver</a></li>
<li><a href="../fr461447/index.html">L'√©pop√©e des administrateurs syst√®me en tant qu'esp√®ce menac√©e</a></li>
<li><a href="../fr461449/index.html">PhpStorm 2019.2: propri√©t√©s typ√©es PHP 7.4, recherche de doublons, EditorConfig, scripts de shell, etc.</a></li>
<li><a href="../fr461451/index.html">Mon deuxi√®me jour avec Haiku: ravi, mais pas encore pr√™t √† partir</a></li>
<li><a href="../fr461453/index.html">Aventures √† Ba√Økonour: fus√©es, astronautes, lancement de l'Union MS-13 et Internet spatial</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>