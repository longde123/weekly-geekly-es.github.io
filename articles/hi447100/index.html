<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯПВЁЯП╜ ЁЯзЦЁЯП╝ ЁЯСиЁЯП╜тАНЁЯПл Linux рдкрд░ Powershell рд╕реЗ MS SQL рдХреЗ рд╕рд╛рде рдХрд╛рд░реНрдп рдХрд░рдирд╛ ЁЯд╝ ЁЯУи ЁЯП╝</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рдпрд╣ рд▓реЗрдЦ рд╡рд┐рд╢реБрджреНрдз рд░реВрдк рд╕реЗ рд╡реНрдпрд╛рд╡рд╣рд╛рд░рд┐рдХ рд╣реИ рдФрд░ рдореЗрд░реА рджреБрдЦрдж рдХрд╣рд╛рдиреА рдХреЛ рд╕рдорд░реНрдкрд┐рдд рд╣реИред 
 RDS (MS SQL) рдХреЗ рд▓рд┐рдП Zero Touch PROD рдХреЗ рд▓рд┐рдП рддреИрдпрд╛рд░реА рдХрд░рдирд╛, рдЬрд┐рд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╣рдорд╛рд░реЗ рд╕...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Linux рдкрд░ Powershell рд╕реЗ MS SQL рдХреЗ рд╕рд╛рде рдХрд╛рд░реНрдп рдХрд░рдирд╛</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/447100/"><h2>  рдпрд╣ рд▓реЗрдЦ рд╡рд┐рд╢реБрджреНрдз рд░реВрдк рд╕реЗ рд╡реНрдпрд╛рд╡рд╣рд╛рд░рд┐рдХ рд╣реИ рдФрд░ рдореЗрд░реА рджреБрдЦрдж рдХрд╣рд╛рдиреА рдХреЛ рд╕рдорд░реНрдкрд┐рдд рд╣реИред </h2><br>  RDS (MS SQL) рдХреЗ рд▓рд┐рдП <b>Zero Touch PROD рдХреЗ</b> рд▓рд┐рдП рддреИрдпрд╛рд░реА рдХрд░рдирд╛, рдЬрд┐рд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╣рдорд╛рд░реЗ рд╕рднреА рдХрд╛рди рдЧреБрд▓рдЬрд╛рд░ рдереЗ, рдореИрдВрдиреЗ рд╕реНрд╡рдЪрд╛рд▓рди рдХреА рдПрдХ рдкреНрд░рд╕реНрддреБрддрд┐ (POC - рдкреНрд░реВрдл рдСрдл рдХреЙрдиреНрд╕реЗрдкреНрдЯ) рдмрдирд╛рдИ: рдкреЙрд╡рд░рд╢реЗрд▓ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХрд╛ рдПрдХ рд╕реЗрдЯред  рдкреНрд░рд╕реНрддреБрддрд┐ рдХреЗ рдмрд╛рдж, рдЬрдм рдЬреЛрд░ рд╕реЗ, рд▓рдВрдмреЗ рд╕рдордп рддрдХ рддрд╛рд▓рд┐рдпрд╛рдВ рдмрдЬрддреА рд░рд╣реАрдВ, рддреЛ рдПрдХ рд╡рд┐рдореЛрдЪрд┐рдд рдУрд╡реЗрд╢рди рдореЗрдВ рдмрджрд▓ рдЧрдпрд╛, рдореБрдЭреЗ рдмрддрд╛рдпрд╛ рдЧрдпрд╛ рдХрд┐ рдпрд╣ рд╕рдм рдЕрдЪреНрдЫрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдХреЗрд╡рд▓ рд╡реИрдЪрд╛рд░рд┐рдХ рдХрд╛рд░рдгреЛрдВ рд╕реЗ рд╣рдо рд╕рднреА рдХреЗ рдкрд╛рд╕ рдЬреЗрдиреЗрдХрд╕ рджрд╛рд╕ рд▓рд┐рдирдХреНрд╕ рдХреЗ рддрд╣рдд рдЪрд▓ рд░рд╣реЗ рд╣реИрдВ! <br><br>  рдХреНрдпрд╛ рдпрд╣ рд╕рдВрднрд╡ рд╣реИ?  рд╡рд┐рдВрдбреЛрдЬ рдХреЗ рдиреАрдЪреЗ рд╕реЗ рдРрд╕реА рдЧрд░реНрдо, рдЯреНрдпреВрдм рдбреАрдмреАрдП рд▓реЗрдиреЗ рдХреЗ рд▓рд┐рдП рдФрд░ рдЗрд╕реЗ рд▓рд┐рдирдХреНрд╕ рдХреЗ рддрд╣рдд рдкрд╛рд╡рд░рд╢реЗрд▓ рдХреА рдмрд╣реБрдд рдЧрд░реНрдореА рдореЗрдВ рдбрд╛рд▓реЗрдВ?  рдХреНрдпрд╛ рд╡рд╣ рдХреНрд░реВрд░ рдирд╣реАрдВ рд╣реИ? <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/no/ah/qm/noahqmkdy7zdvyywgyno-gzeh6e.jpeg" width="500"></div><br>  рдореБрдЭреЗ рдкреНрд░реМрджреНрдпреЛрдЧрд┐рдХреА рдХреЗ рдЗрд╕ рдЕрдЬреАрдм рд╕рдВрдпреЛрдЬрди рдореЗрдВ рдЧреЛрддрд╛ рд▓рдЧрд╛рдирд╛ рдерд╛ред  рдмреЗрд╢рдХ, рдореЗрд░реА рд╕рднреА 30+ рд╕реНрдХреНрд░рд┐рдкреНрдЯреНрд╕ рдиреЗ рдХрд╛рдо рдХрд░рдирд╛ рдмрдВрдж рдХрд░ рджрд┐рдпрд╛ред  рдореЗрд░реЗ рдЖрд╢реНрдЪрд░реНрдп рдХреЗ рд▓рд┐рдП, рдПрдХ рдХрд╛рд░реНрдп рджрд┐рд╡рд╕ рдореЗрдВ рдореИрдВ рд╕рдм рдХреБрдЫ рдареАрдХ рдХрд░рдиреЗ рдореЗрдВ рдХрд╛рдордпрд╛рдм рд░рд╣рд╛ред  рдореИрдВ рдЧрд░реНрдо рдЦреЛрдЬ рдореЗрдВ рд▓рд┐рдЦ рд░рд╣рд╛ рд╣реВрдВред  рддреЛ, рд╡рд┐рдВрдбреЛрдЬ рд╕реЗ рд▓рд┐рдирдХреНрд╕ рдореЗрдВ рдкреЙрд╡рд░рд╢реЗрд▓ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рдкреЛрд░реНрдЯ рдХрд░рддреЗ рд╕рдордп рдЖрдк рдХрд┐рди рдиреБрдХрд╕рд╛рдиреЛрдВ рдХрд╛ рд╕рд╛рдордирд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ? <br><a name="habracut"></a><br><h2>  sqlcmd рдмрдирд╛рдо рдЖрд╣реНрд╡рд╛рди-SqlCmd </h2><br>  рдореБрдЭреЗ рдЙрдирдХреЗ рдмреАрдЪ рдореБрдЦреНрдп рдЕрдВрддрд░ рдХреА рдпрд╛рдж рджрд┐рд▓рд╛рдПрдВред  рдЕрдЪреНрдЫреА рдкреБрд░рд╛рдиреА <b>sqlcmd</b> рдЙрдкрдпреЛрдЧрд┐рддрд╛ рд▓рдЧрднрдЧ рд╕рдорд╛рди рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдХреЗ рд╕рд╛рде, рд▓рд┐рдирдХреНрд╕ рдХреЗ рддрд╣рдд <b>рднреА</b> рдХрд╛рдо рдХрд░рддреА рд╣реИред  рд╣рдо -рдХреНрд╡реЗрд░реА рдХреЛ -Q, рдЗрдирдкреБрдЯ рдлрд╛рдЗрд▓ as -i, рдФрд░ рдЖрдЙрдЯрдкреБрдЯ -o рдкрд╛рд╕ рдХрд░рддреЗ рд╣реИрдВред  рдпрд╣рд╛рдБ рдХреЗрд╡рд▓ рдлрд╝рд╛рдЗрд▓ рдирд╛рдо рд╣реИрдВ, рдЬрд╝рд╛рд╣рд┐рд░ рд╣реИ, рдХреЗрд╕-рд╕рдВрд╡реЗрджреАред  рдпрджрд┐ рдЖрдк -i рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЕрдВрдд рдореЗрдВ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд▓рд┐рдЦреЗрдВ: <br><br><pre><code class="sql hljs">GO EXIT</code> </pre> <br>  рдпрджрд┐ рдЕрдВрдд рдореЗрдВ рдХреЛрдИ EXIT рдирд╣реАрдВ рд╣реИ, рддреЛ sqlcmd рдЗрдирдкреБрдЯ рдХреА рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЬрд╛рдПрдЧрд╛, рдФрд░ рдЕрдЧрд░ <b>EXIT</b> рд╕реЗ рдкрд╣рд▓реЗ рдХреЛрдИ <b>GO</b> рдирд╣реАрдВ рд╣реИ, рддреЛ рдЕрдВрддрд┐рдо рдХрдорд╛рдВрдб рдХрд╛рдо рдирд╣реАрдВ рдХрд░реЗрдЧрд╛ред  рд╕рднреА рдЖрдЙрдЯрдкреБрдЯ, рд╕реЗрд▓реЗрдХреНрдЯ, рдореИрд╕реЗрдЬ, рдкреНрд░рд┐рдВрдЯ рдЗрддреНрдпрд╛рджрд┐, рдЖрдЙрдЯрдкреБрдЯ рдлрд╛рдЗрд▓ рдХреЛ рдкреНрд░рд╛рдкреНрдд рд╣реЛрддреЗ рд╣реИрдВред <br><br>  Invoke-SqlCmd рдПрдХ DataSet, DataTables рдпрд╛ DataRows рдХреЗ рд░реВрдк рдореЗрдВ рдкрд░рд┐рдгрд╛рдо рджреЗрддрд╛ рд╣реИред  рдЗрд╕рд▓рд┐рдП, рдпрджрд┐ рдЖрдк <b>sqlcmd рдХреЗ</b> рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХ рд╕рд░рд▓ рдЪрдпрди рдХреЗ рдкрд░рд┐рдгрд╛рдо рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЗрд╕рдХреЗ рдЖрдЙрдЯрдкреБрдЯ рдХреЛ <b>рдкрд╛рд░реНрд╕</b> рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рддреЛ рдХреБрдЫ рдЬрдЯрд┐рд▓ рдЖрдЙрдЯрдкреБрдЯ рдХрд░рдирд╛ рд▓рдЧрднрдЧ рдЕрд╕рдВрднрд╡ рд╣реИ: <b>рдЗрд╕рдХреЗ</b> рд▓рд┐рдП <b>Invoke-SqlCmd</b> рд╣реИред  рд▓реЗрдХрд┐рди рдЗрд╕ рдЯреАрдо рдХреЗ рдЕрдкрдиреЗ рдЪреБрдЯрдХреБрд▓реЗ рд╣реИрдВ: <br><br><ul><li>  рдпрджрд┐ рдЖрдк рдЗрд╕реЗ <b>-InputFile рдХреЗ</b> рдорд╛рдзреНрдпрдо рд╕реЗ рдлрд╝рд╛рдЗрд▓ рдкрд╛рд╕ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ <b>EXIT рдХреА</b> рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ, рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдпрд╣ рдПрдХ рд╕рд┐рдВрдЯреИрдХреНрд╕ рддреНрд░реБрдЯрд┐ рджреЗрддрд╛ рд╣реИ </li><li>  <b>-OutputFile</b> рдирд╣реАрдВ, рдХрдорд╛рдВрдб рдЖрдкрдХреЛ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдкрд░рд┐рдгрд╛рдо рджреЗрддрд╛ рд╣реИ </li><li>  рдПрдХ рд╕рд░реНрд╡рд░ рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рджреЛ рд╡рд╛рдХреНрдпрд╡рд┐рдиреНрдпрд╛рд╕ рд╣реИрдВ: <b>-ServerInstance -Username -Password -Database</b> рдФрд░ through <b>-ConnectionString</b> ред  рдЕрдЬреАрдм рддрд░рд╣ рд╕реЗ, рдкрд╣рд▓реЗ рдорд╛рдорд▓реЗ рдореЗрдВ, рдЖрдк 1433 рдХреЗ рдЕрд▓рд╛рд╡рд╛ рдПрдХ рдкреЛрд░реНрдЯ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗред </li><li>  рдкрд╛рда рдЖрдЙрдЯрдкреБрдЯ, рдЯрд╛рдЗрдк PRINT, рдЬреЛ рдХрд┐ рдкреНрд░рд╛рдердорд┐рдХ рд░реВрдк рд╕реЗ <b>sqlcmd</b> рджреНрд╡рд╛рд░рд╛ "рдкрдХрдбрд╝рд╛ рдЧрдпрд╛" рд╣реИ, <b>Invoke-SqlCmd рдХреЗ</b> рд▓рд┐рдП <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдПрдХ рдореБрджреНрджрд╛ рд╣реИ</a> </li><li>  рдФрд░ рд╕рдмрд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдмрд╛рдд: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╕рдмрд╕реЗ рдЕрдзрд┐рдХ рд╕рдВрднрд╛рд╡рдирд╛ рд╣реИ рдХрд┐ рдпрд╣ cmdlet рдЖрдкрдХреЗ рд▓рд┐рдирдХреНрд╕ рдореЗрдВ рдирд╣реАрдВ рд╣реИ!</a> </li></ul><br>  рдФрд░ рдпрд╣ рдореБрдЦреНрдп рд╕рдорд╕реНрдпрд╛ рд╣реИред  рдХреЗрд╡рд▓ рдорд╛рд░реНрдЪ рдореЗрдВ рдпрд╣ cmdlet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдиреЙрди-рд╡рд┐рдВрдбреЛрдЬ рдкреНрд▓реЗрдЯрдлреЙрд░реНрдо рдХреЗ рд▓рд┐рдП рдЙрдкрд▓рдмреНрдз рд╣реЛ рдЧрдпрд╛</a> , рдФрд░ рдЖрдЦрд┐рд░рдХрд╛рд░ рд╣рдо рдЖрдЧреЗ рдмрдврд╝ рд╕рдХрддреЗ рд╣реИрдВ! <br><br><h2>  рдЪрд░ рдкреНрд░рддрд┐рд╕реНрдерд╛рдкрди </h2><br>  Sqlcmd -v рдХреЗ рд╕рд╛рде рдЪрд░ рдкреНрд░рддрд┐рд╕реНрдерд╛рдкрди рд╣реИ, рдЬреИрд╕реЗ: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># $conn    sqlcmd $cmd = $conn + " -i D:\apps\SlaveJobs\KillSpid.sql -o killspid.res -v spid =`"" + $spid + "`" -v age =`"" + $age + "`"" Invoke-Expression $cmd</span></span></code> </pre> <br>  SQL рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЗрдВ, рд╣рдо рдкреНрд░рддрд┐рд╕реНрдерд╛рдкрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @spid=$(spid) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @age=$(age)</code> </pre> <br>  рддреЛ рдпрд╣рд╛рдБ рд╣реИред  * рдирд┐рдХреНрд╕ рдореЗрдВ <b>, рдЪрд░ рдкреНрд░рддрд┐рд╕реНрдерд╛рдкрди рдХрд╛рд░реНрдп рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВ</b> ред  <b>-V рд╡рд┐рдХрд▓реНрдк рдХреЛ</b> рдирдЬрд░рдЕрдВрджрд╛рдЬ рдХрд┐рдпрд╛ <b>рдЬрд╛рддрд╛</b> рд╣реИред  <b>рдЖрд╣реНрд╡рд╛рди-</b> <b>SqlCmd</b> рдЙрдкреЗрдХреНрд╖рд╛ <b>-рд╡рд░рд┐</b> ред  рд╣рд╛рд▓рд╛рдБрдХрд┐ рдЬреЛ рдкреИрд░рд╛рдореАрдЯрд░ рд╕реНрд╡рдпрдВ рдЪрд░ рд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИ, рдЙрд╕реЗ рдЕрдирджреЗрдЦрд╛ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдкреНрд░рддрд┐рд╕реНрдерд╛рдкрди рд╕реНрд╡рдпрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ - рдЖрдк рд╢реЗрд▓ рд╕реЗ рдХрд┐рд╕реА рднреА рдЪрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред  рд╣рд╛рд▓рд╛рдБрдХрд┐, рдореИрдВ рдЪрд░ рд╕реЗ рдирд╛рд░рд╛рдЬ рдерд╛ рдФрд░ рдЙрди рдкрд░ рдирд┐рд░реНрднрд░ рди рд░рд╣рдиреЗ рдХрд╛ рдлреИрд╕рд▓рд╛ рдХрд┐рдпрд╛, рдФрд░ рдореИрдВрдиреЗ рдореЛрдЯреЗ рддреМрд░ рдкрд░ рдФрд░ рдЖрджрд┐рдо рд░реВрдк рд╕реЗ рдХрд╛рдо рдХрд┐рдпрд╛, рдХреНрдпреЛрдВрдХрд┐ рдПрд╕рдХреНрдпреВрдПрд▓ рдХреЗ рд▓рд┐рдП рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХрдо рд╣реИрдВ: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># prepend the parameters "declare @age int, @spid int" | Add-Content "q.sql" "set @spid=" + $spid | Add-Content "q.sql" "set @age=" + $age | Add-Content "q.sql" foreach ($line in Get-Content "Sqlserver/Automation/KillSpid.sql") { $line | Add-Content "q.sql" } $cmd = "/opt/mssql-tools/bin/" + $conn + " -i q.sql -o res.log"</span></span></code> </pre> <br>  рдпрд╣, рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рд╕рдордЭрддреЗ рд╣реИрдВ, рдпреВрдирд┐рдХреНрд╕ рд╕рдВрд╕реНрдХрд░рдг рд╕реЗ рдПрдХ рдкрд░реАрдХреНрд╖рдг рд╣реИред <br><br><h2>  рдлрд╛рдЗрд▓реЗрдВ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ </h2><br>  рд╡рд┐рдВрдбреЛрдЬ рд╕рдВрд╕реНрдХрд░рдг рдореЗрдВ, рдореЗрд░реЗ рдкрд╛рд╕ рдХреЛрдИ рднреА рдСрдкрд░реЗрд╢рди рдПрдХ рдСрдбрд┐рдЯ рдХреЗ рд╕рд╛рде рдерд╛: рд╣рдордиреЗ sqlcmd рдХрд╛ рдкреНрд░рджрд░реНрд╢рди рдХрд┐рдпрд╛, рдЖрдЙрдЯрдкреБрдЯ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдХрд┐рд╕реА рдкреНрд░рдХрд╛рд░ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд┐рдпрд╛, рдЗрд╕ рдлрд╛рдЗрд▓ рдХреЛ рдСрдбрд┐рдЯ рдкреНрд▓реЗрдЯ рдореЗрдВ рд╕рдВрд▓рдЧреНрди рдХрд┐рдпрд╛ред  рд╕реМрднрд╛рдЧреНрдп рд╕реЗ, SQL рд╕рд░реНрд╡рд░ рдиреЗ рдЬреЗрдирдХрд┐рдиреНрд╕ рдХреЗ рд╕рдорд╛рди рд╕рд░реНрд╡рд░ рдкрд░ рдХрд╛рдо рдХрд┐рдпрд╛, рдпрд╣ рдХреБрдЫ рдЗрд╕ рддрд░рд╣ рд╕реЗ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> AuditUpload @<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, @filename <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> nocount <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">sql</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-comment"><span class="hljs-comment">#multi (filer NVARCHAR(MAX)) set @sql='BULK INSERT #multi FROM '''+@filename +''' WITH (ROWTERMINATOR = ''\0'',CODEPAGE = ''ACP'')' exec (@sql) select @sql=filer from #multi update JenkinsAudit set multiliner=@sql where ID=@id return</span></span></code> </pre> <br>  рдЗрд╕ рдкреНрд░рдХрд╛рд░, рд╣рдо рдкреВрд░реА BCP рдлрд╝рд╛рдЗрд▓ рдХреЛ рдирд┐рдЧрд▓ рд▓реЗрддреЗ рд╣реИрдВ, рдФрд░ рдСрдбрд┐рдЯ рдЯреЗрдмрд▓ рдХреЛ nvarchar (рдЕрдзрд┐рдХрддрдо) рдлрд╝реАрд▓реНрдб рдореЗрдВ рд╣рд┐рд▓рд╛рддреЗ рд╣реИрдВред  рдмреЗрд╢рдХ, рдпрд╣ рдкреВрд░реА рдкреНрд░рдгрд╛рд▓реА рдЪрд░рдорд░рд╛ рдЧрдИ, рдХреНрдпреЛрдВрдХрд┐ SQL рд╕рд░реНрд╡рд░ рдХреЗ рдмрдЬрд╛рдп рдореБрдЭреЗ RDS рдорд┐рд▓рд╛, рдФрд░ BULK INSERT рдиреЗ \\ UNC рдкрд░ рдХрд╛рдо рдирд╣реАрдВ рдХрд┐рдпрд╛, рдХреНрдпреЛрдВрдХрд┐ рдХрд┐рд╕реА рдлрд╝рд╛рдЗрд▓ рдкрд░ рдЕрдирдиреНрдп рд▓реЙрдХ рд▓рдЧрд╛рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХреА рдЬрд╛ рд░рд╣реА рдереА, рдФрд░ RDS рдХреЗ рд╕рд╛рде рдпрд╣ рдЖрдорддреМрд░ рдкрд░ рд╢реБрд░реБрдЖрдд рд╕реЗ рд╣реА рд▓рд╛рдЧреВ рд╣реИред  рдЗрд╕рд▓рд┐рдП рдореИрдВрдиреЗ рдСрдбрд┐рдЯ рд▓рд╛рдЗрди рдХреЛ рд▓рд╛рдЗрди рд╕реЗ рд╕реНрдЯреЛрд░ рдХрд░рддреЗ рд╣реБрдП рд╕рд┐рд╕реНрдЯрдо рдХреЗ рдбрд┐рдЬрд╝рд╛рдЗрди рдХреЛ рдмрджрд▓рдиреЗ рдХрд╛ рдлреИрд╕рд▓рд╛ рдХрд┐рдпрд╛: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> AuditOut ( <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, TextLine <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, n <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IDENTITY</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> )</code> </pre> <br>  рдФрд░ рдЗрд╕ рддрд╛рд▓рд┐рдХрд╛ рдХреЛ рдЗрд╕ рддрд░рд╣ рд▓рд┐рдЦреЗрдВ: <br><br><pre> <code class="python hljs">function WriteAudit([string]$Filename, [string]$ConnStr, [string]$Tabname, [string]$Jobname) { <span class="hljs-comment"><span class="hljs-comment"># get $lastid of the last execution --    #create grid and populate it with data from file $audit = Get-Content $Filename $DT = new-object Data.DataTable $COL1 = new-object Data.DataColumn; $COL1.ColumnName = "ID"; $COL1.DataType = [System.Type]::GetType("System.Int32") $COL2 = new-object Data.DataColumn; $COL2.ColumnName = "TextLine"; $COL2.DataType = [System.Type]::GetType("System.String") $DT.Columns.Add($COL1) $DT.Columns.Add($COL2) foreach ($line in $audit) { $DR = $dt.NewRow() $DR.Item("ID") = $lastid $DR.Item("TextLine") = $line $DT.Rows.Add($DR) } # write it to table $conn=new-object System.Data.SqlClient.SQLConnection $conn.ConnectionString = $ConnStr $conn.Open() $bulkCopy = new-object ("Data.SqlClient.SqlBulkCopy") $ConnStr $bulkCopy.DestinationTableName = $Tabname $bulkCopy.BatchSize = 50000 $bulkCopy.BulkCopyTimeout = 0 $bulkCopy.WriteToServer($DT) $conn.Close() }</span></span></code> </pre><br>  рд╕рд╛рдордЧреНрд░реА рдХрд╛ рдЪрдпрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдИрдбреА рджреНрд╡рд╛рд░рд╛ рдЪрдпрди рдХрд░реЗрдВ, рдХреНрд░рдо рдореЗрдВ n (рдкрд╣рдЪрд╛рди) рдХрд╛ рдЪрдпрди рдХрд░реЗрдВред <br><br>  рдЕрдЧрд▓реЗ рд▓реЗрдЦ рдореЗрдВ рдореИрдВ рдФрд░ рдЕрдзрд┐рдХ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рдмрддрд╛рдКрдВрдЧрд╛ рдХрд┐ рдпрд╣ рд╕рдм рдЬреЗрдирдХрд┐рдиреНрд╕ рдХреЗ рд╕рд╛рде рдХреИрд╕реЗ рдмрд╛рддрдЪреАрдд рдХрд░рддрд╛ рд╣реИред </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi447100/">https://habr.com/ru/post/hi447100/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi447090/index.html">рдмреИрдХрдЧреНрд░рд╛рдЙрдВрдб: рдХрдВрдЯреАрдиреНрдпреВрдЕрд╕ рдЗрдВрдЯреАрдЧреНрд░реЗрд╢рди рдкреНрд░реЛрд╕реЗрд╕ рдХреИрд╕реЗ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ</a></li>
<li><a href="../hi447092/index.html">рдпрд╣ рдПрдВрдЯреАрдирд╛ рдХрд┐рд╕ рд░реЗрдВрдЬ рдХрд╛ рд╣реИ? OSA103 рдорд┐рдиреА рдХреЗ рд╕рд╛рде рдПрдВрдЯреАрдирд╛ рдкреНрд░рджрд░реНрд╢рди рдХреЛ рдорд╛рдкрдиреЗ</a></li>
<li><a href="../hi447094/index.html">рдорд╢реАрди рд▓рд░реНрдирд┐рдВрдЧ рдлреЙрд░ рдореИрдиреЗрдЬрд░реНрд╕: рдж рд╕реИрдХреНрд░рд╛рдореЗрдВрдЯ рдСрдл рд╕реЗрдкрд▓реЗрд╢рди</a></li>
<li><a href="../hi447096/index.html">рдЗрд╕ рд╕рд╛рд▓ рдХреЛрдИ рдбрд╛рдХреВ рдирд╣реАрдВ рд╣реЛрдЧрд╛, рдХреЛрдИ рдлрд░реНрдХ рдирд╣реАрдВ рдкрдбрд╝рддрд╛ рдХрд┐ рдЗрд▓реЛрди рдХреНрдпрд╛ рдХрд╣рддрд╛ рд╣реИред</a></li>
<li><a href="../hi447098/index.html">рд╕реНрд╡рд┐рдлреНрдЯ 4.2 рд╕реЗ рд╕реНрд╡рд┐рдлреНрдЯ 5.0 рдХреЗ рд▓рд┐рдП рдПрдХ рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреЛ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░рдирд╛</a></li>
<li><a href="../hi447102/index.html">рдкреНрд░рдЧрддрд┐ MS-11 рд░рд┐рдХреЙрд░реНрдб: рд╕рдмрд╕реЗ рджрд┐рд▓рдЪрд╕реНрдк рдЖрдЧреЗ</a></li>
<li><a href="../hi447104/index.html">рдореИрдВрдиреЗ рдЕрдкрдиреЗ рд╣рд╛рде рдореЗрдВ рдЖрд░рдПрдлрдЖрдИрдбреА рдХреИрд╕реЗ рдкреНрд░рддреНрдпрд╛рд░реЛрдкрд┐рдд рдХрд┐рдпрд╛, рдФрд░ рдлрд┐рд░ рдПрдирдПрдлрд╕реАред рднрд╛рдЧ реи</a></li>
<li><a href="../hi447106/index.html">рдирд┐рдореНрди, рдЙрдЪреНрдЪ, рдЕрдВрддрд┐рдоред рдЬреАрдПрд▓рд╕реА - рд▓рдЦрддрд╛ рдХреЗрдВрджреНрд░ рдХрд╛ рдкрд╛рдВрдЪрд╡рд╛ рддрддреНрд╡</a></li>
<li><a href="../hi447108/index.html">рд╡рд┐рдХреЗрдВрджреНрд░реАрдХрд░рдг: рдмреНрд▓реЙрдХрдЪреЗрди рдХреЗ рд▓рд┐рдП рдПрдХ рдмрдбрд╝реА рд╕рдорд╕реНрдпрд╛</a></li>
<li><a href="../hi447110/index.html"># 293 рдбреЗрд╡рд▓рдкрд░ рдореЛрдмрд╛рдЗрд▓ рдкрд░ рджрд┐рд▓рдЪрд╕реНрдк рд╕рд╛рдордЧреНрд░реА рдХрд╛ рдкрд╛рдЪрди (1 рдЕрдкреНрд░реИрд▓ - 7 рдХреЛ)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>