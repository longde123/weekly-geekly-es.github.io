<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôÖüèº üîß üìπ R√©cup√©rer des donn√©es avec ORM est facile! Ou pas? üçÆ üì∂ üë¥üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pr√©sentation 


 Presque n'importe quel syst√®me d'information interagit d'une mani√®re ou d'une autre avec des magasins de donn√©es externes. Dans la pl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>R√©cup√©rer des donn√©es avec ORM est facile! Ou pas?</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/haulmont/blog/451986/"><p><img src="https://habrastorage.org/webt/uv/4h/wb/uv4hwblmcfkf-f6018hxpbkf1s8.jpeg"></p><br><h2 id="vvedenie">  Pr√©sentation </h2><br><p>  Presque n'importe quel syst√®me d'information interagit d'une mani√®re ou d'une autre avec des magasins de donn√©es externes.  Dans la plupart des cas, il s'agit d'une base de donn√©es relationnelle et, souvent, une sorte de cadre ORM est utilis√© pour travailler avec des donn√©es.  ORM √©limine la plupart des op√©rations de routine, offrant √† la place un petit ensemble d'abstractions suppl√©mentaires pour travailler avec des donn√©es. </p><br><p>  Martin Fowler a publi√© un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> int√©ressant, l'une des principales r√©flexions: ¬´Les ORM nous aident √† r√©soudre un grand nombre de probl√®mes dans les applications d'entreprise ... Cet outil ne peut pas √™tre qualifi√© de joli, mais les probl√®mes qu'il traite ne sont pas non plus agr√©ables.  Je pense que l'ORM m√©rite plus de respect et de compr√©hension. ¬ª </p><br><p>  Nous utilisons ORM de mani√®re tr√®s intensive dans le cadre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CUBA</a> , nous connaissons donc de premi√®re main les probl√®mes et les limites de cette technologie, car CUBA est utilis√© dans divers projets √† travers le monde.  De nombreux sujets peuvent √™tre abord√©s en relation avec l'ORM, mais nous nous concentrerons sur l'un d'entre eux: le choix entre les m√©thodes ¬´paresseuses¬ª (paresseuses) et ¬´gourmandes¬ª (avides) d'√©chantillonnage de donn√©es.  Nous parlerons de diff√©rentes approches pour r√©soudre ce probl√®me avec des illustrations de l'API JPA et de Spring, et d√©crirons √©galement comment (et pourquoi exactement) ORM est utilis√© dans CUBA et quel travail nous faisons pour am√©liorer le travail avec les donn√©es dans notre cadre. </p><a name="habracut"></a><br><h2 id="vyborka-dannyh-lenivaya-ili-net">  √âchantillonnage des donn√©es: paresseux ou non? </h2><br><p> Si votre mod√®le de donn√©es n'a qu'une seule entit√©, vous ne remarquerez probablement aucun probl√®me lorsque vous travaillez avec ORM.  Regardons un petit exemple.  Supposons que nous ayons une entit√© <code>User ()</code> qui poss√®de deux attributs: <code>ID</code> et <code>Name ()</code> : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-meta"><span class="hljs-meta">@GeneratedValue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String name; <span class="hljs-comment"><span class="hljs-comment">//Getters and Setters here }</span></span></code> </pre> <br><p>  Pour obtenir une instance de cette entit√© √† partir de la base de donn√©es, il suffit d'appeler une m√©thode de l'objet <code>EntityManager</code> : </p><br><pre> <code class="java hljs">EntityManager em = entityManagerFactory.createEntityManager(); User user = em.find(User.class, id);</code> </pre> <br><p>  Les choses deviennent un peu plus int√©ressantes lorsqu'une relation un-√†-plusieurs appara√Æt: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-meta"><span class="hljs-meta">@GeneratedValue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String name; <span class="hljs-meta"><span class="hljs-meta">@OneToMany</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;Address&gt; addresses; <span class="hljs-comment"><span class="hljs-comment">//Getters and Setters here }</span></span></code> </pre> <br><p>  Si nous devons extraire une instance d'utilisateur de la base de donn√©es, la question se pose: ¬´S√©lectionnons-nous √©galement des adresses?¬ª.  Et la ¬´bonne¬ª r√©ponse ici est: ¬´Cela d√©pend de ...¬ª Dans certains cas, nous aurons besoin d'adresses, dans d'autres - pas.  En r√®gle g√©n√©rale, ORM propose deux fa√ßons de r√©cup√©rer des enregistrements d√©pendants: paresseux et gourmand.  Par d√©faut, la plupart des ORM utilisent la m√©thode paresseuse.  Mais, si nous √©crivons ce code: </p><br><pre> <code class="java hljs">EntityManager em = entityManagerFactory.createEntityManager(); User user = em.find(User.class, <span class="hljs-number"><span class="hljs-number">1</span></span>); em.close(); System.out.println(user.getAddresses().get(<span class="hljs-number"><span class="hljs-number">0</span></span>));</code> </pre> <br><p>  ... puis nous obtenons l'exception <code>‚ÄúLazyInitException‚Äù</code> , ce qui <code>‚ÄúLazyInitException‚Äù</code> terriblement les nouveaux arrivants qui viennent de commencer √† travailler avec ORM.  Et voici le moment o√π vous devez commencer une histoire sur ce que sont les instances ¬´attach√©es¬ª et ¬´d√©tach√©es¬ª d'une entit√©, quelles sont les sessions et les transactions. <br>  Oui, cela signifie que l'entit√© doit √™tre ¬´attach√©e¬ª √† la session afin que vous puissiez s√©lectionner les donn√©es d√©pendantes.  Eh bien, ne fermons pas les transactions tout de suite, et la vie deviendra imm√©diatement plus facile.  Et ici, un autre probl√®me se pose: les transactions s'allongent, ce qui augmente le risque de blocage.  Raccourcir les transactions?  C'est possible, mais si vous cr√©ez beaucoup, beaucoup de petites transactions, nous obtenons le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´Conte de Komar Komarovich - un long nez et une Misha poilue - une courte queue¬ª</a> sur la fa√ßon dont la horde de minuscules moustiques ours a gagn√© - cela se produira avec la base de donn√©es.  Si le nombre de petites transactions augmente consid√©rablement, des probl√®mes de performances se poseront. <br>  Comme cela a √©t√© dit, lors de la r√©cup√©ration des donn√©es sur un utilisateur, les adresses peuvent √™tre requises ou non.Par cons√©quent, selon la logique m√©tier, vous devez s√©lectionner la collection ou non.  Il est n√©cessaire d'ajouter de nouvelles conditions au code ... Hmmm ... Quelque chose se complique. </p><br><p>  Et si vous essayez un autre type d'√©chantillon? </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-meta"><span class="hljs-meta">@GeneratedValue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String name; <span class="hljs-meta"><span class="hljs-meta">@OneToMany</span></span>(fetch = FetchType.EAGER) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;Address&gt; addresses; <span class="hljs-comment"><span class="hljs-comment">//Getters and Setters here }</span></span></code> </pre> <br><p>  Eh bien ... vous ne pouvez pas dire que cela aidera beaucoup.  Oui, nous allons nous d√©barrasser du <code>LazyInit</code> d√©test√© et il n'est pas n√©cessaire de v√©rifier si l'entit√© est attach√©e √† la session ou non.  Mais maintenant, nous pouvons avoir des probl√®mes de performances, car nous n'avons pas toujours besoin d'adresses, mais nous s√©lectionnons toujours ces objets dans la m√©moire du serveur. <br>  Avez-vous d'autres id√©es? </p><br><h2 id="spring-jdbc">  Spring jdbc </h2><br><p>  Certains d√©veloppeurs sont tellement fatigu√©s d'ORM qu'ils passent √† des cadres alternatifs.  Par exemple, sur Spring JDBC, qui offre la possibilit√© de convertir des donn√©es relationnelles en donn√©es d'objet en mode "semi-automatique".  Le d√©veloppeur √©crit des requ√™tes pour chaque cas o√π un ensemble particulier d'attributs est n√©cessaire (ou le m√™me code est r√©utilis√© pour les cas o√π les m√™mes structures de donn√©es sont n√©cessaires). </p><br><p>  Cela nous donne une grande flexibilit√©.  Par exemple, vous pouvez s√©lectionner un seul attribut sans cr√©er l'objet entit√© correspondant: </p><br><pre> <code class="java hljs">String name = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.jdbcTemplate.queryForObject( <span class="hljs-string"><span class="hljs-string">"select name from t_user where id = ?"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object[]{<span class="hljs-number"><span class="hljs-number">1L</span></span>}, String.class);</code> </pre> <br><p>  Ou s√©lectionnez un objet sous la forme habituelle: </p><br><pre> <code class="java hljs">User user = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.jdbcTemplate.queryForObject( <span class="hljs-string"><span class="hljs-string">"select id, name from t_user where id = ?"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object[]{<span class="hljs-number"><span class="hljs-number">1L</span></span>}, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RowMapper&lt;User&gt;() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> User </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mapRow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ResultSet rs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rowNum)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> SQLException </span></span>{ User user = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(); user.setName(rs.getString(<span class="hljs-string"><span class="hljs-string">"name"</span></span>)); user.setId(rs.getInt(<span class="hljs-string"><span class="hljs-string">"id"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> user; } });</code> </pre> <br><p>  Vous pouvez √©galement s√©lectionner une liste d'adresses pour l'utilisateur, il vous suffit d'√©crire un peu plus de code et de composer correctement la requ√™te SQL pour √©viter le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">probl√®me des requ√™tes n + 1</a> . </p><br><p>  Soooo, encore compliqu√©.  Oui, nous contr√¥lons toutes les requ√™tes et la fa√ßon dont les donn√©es sont mapp√©es sur des objets, mais nous devons √©crire plus de code, apprendre le SQL et savoir comment les requ√™tes sont ex√©cut√©es dans la base de donn√©es.  Personnellement, je pense que la connaissance de SQL est une comp√©tence requise pour un programmeur d'applications, mais tout le monde ne pense pas de cette fa√ßon, et je ne vais pas m'engager dans des pol√©miques.  Apr√®s tout, la connaissance des instructions d'assemblage x86 de nos jours est √©galement facultative.  R√©fl√©chissons mieux √† la fa√ßon de faciliter la vie des programmeurs. </p><br><h2 id="jpa-entitygraph">  JPA EntityGraph </h2><br><p>  Et prenons un peu de recul et pensons, de quoi avons-nous besoin?  Il semble que nous devons simplement indiquer exactement les attributs dont nous avons besoin dans chaque cas.  Eh bien, faisons-le!  JPA 2.1 a introduit une nouvelle API - EntityGraph (graphique d'entit√©).  L'id√©e est tr√®s simple: nous utilisons des annotations pour d√©crire ce que nous choisirons dans la base de donn√©es.  Voici un exemple: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-meta"><span class="hljs-meta">@NamedEntityGraphs</span></span>({ <span class="hljs-meta"><span class="hljs-meta">@NamedEntityGraph</span></span>(name = <span class="hljs-string"><span class="hljs-string">"user-only-entity-graph"</span></span>), <span class="hljs-meta"><span class="hljs-meta">@NamedEntityGraph</span></span>(name = <span class="hljs-string"><span class="hljs-string">"user-addresses-entity-graph"</span></span>, attributeNodes = {<span class="hljs-meta"><span class="hljs-meta">@NamedAttributeNode</span></span>(<span class="hljs-string"><span class="hljs-string">"addresses"</span></span>)}) }) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-meta"><span class="hljs-meta">@GeneratedValue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String name; <span class="hljs-meta"><span class="hljs-meta">@OneToMany</span></span>(fetch = FetchType.LAZY) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Set&lt;Address&gt; addresses; <span class="hljs-comment"><span class="hljs-comment">//Getters and Setters here }</span></span></code> </pre> <br><p>  Deux graphiques sont d√©crits pour cette entit√©: <code>user-only-entity-graph</code> graphique d'entit√© <code>user-only-entity-graph</code> ne s√©lectionne pas l'attribut <code>Addresses</code> (marqu√© comme paresseux), tandis que le deuxi√®me graphique indique √† ORM de s√©lectionner cet attribut.  Si nous marquons les <code>Addresses</code> comme d√©sireuses, le graphique sera ignor√© et les adresses seront s√©lectionn√©es de toute fa√ßon. </p><br><p>  Ainsi, dans JPA 2.1, vous pouvez √©chantillonner des donn√©es comme ceci: </p><br><pre> <code class="java hljs">EntityManager em = entityManagerFactory.createEntityManager(); EntityGraph graph = em.getEntityGraph(<span class="hljs-string"><span class="hljs-string">"user-addresses-entity-graph"</span></span>); Map&lt;String, Object&gt; properties = Map.of(<span class="hljs-string"><span class="hljs-string">"javax.persistence.fetchgraph"</span></span>, graph); User user = em.find(User.class, <span class="hljs-number"><span class="hljs-number">1</span></span>, properties); em.close();</code> </pre> <br><p>  Cette approche simplifie consid√©rablement le travail, pas besoin de penser s√©par√©ment aux attributs paresseux et √† la longueur des transactions.  Un avantage suppl√©mentaire est que le graphique est appliqu√© au niveau de la requ√™te SQL, donc les donn√©es ¬´suppl√©mentaires¬ª ne sont pas s√©lectionn√©es dans l'application Java.  Mais il y a un petit probl√®me: vous ne pouvez pas dire quels attributs ont √©t√© s√©lectionn√©s et lesquels ne l'ont pas √©t√©.  Il existe une API pour v√©rifier, cela se fait en utilisant la classe <code>PersistenceUtil</code> : </p><br><pre> <code class="java hljs">PersistenceUtil pu = entityManagerFactory.getPersistenceUnitUtil(); System.out.println(<span class="hljs-string"><span class="hljs-string">"User.addresses loaded: "</span></span> + pu.isLoaded(user, <span class="hljs-string"><span class="hljs-string">"addresses"</span></span>));</code> </pre> <br><p>  Mais c'est assez ennuyeux et tout le monde n'est pas pr√™t √† faire de telles v√©rifications.  Y a-t-il autre chose que vous pouvez simplifier et ne pas afficher les attributs qui n'ont pas √©t√© s√©lectionn√©s? </p><br><h2 id="proekcii-spring">  Projections de printemps </h2><br><p>  Le Spring Framework a une grande chose appel√©e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Projections</a> (et ce n'est pas la m√™me chose que les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">projections dans Hibernate</a> ).  Si vous devez s√©lectionner uniquement certains attributs d'une entit√©, une interface avec les attributs n√©cessaires est cr√©√©e et Spring s√©lectionne les ¬´instances¬ª de cette interface dans la base de donn√©es.  √Ä titre d'exemple, consid√©rons l'interface suivante: </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NamesOnly</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br><p>  Vous pouvez maintenant d√©finir un r√©f√©rentiel Spring JPA pour r√©cup√©rer les entit√©s utilisateur comme suit: </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserRepository</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CrudRepository</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Integer</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-function">Collection&lt;NamesOnly&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findByName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String lastname)</span></span></span></span>; }</code> </pre> <br><p>  Dans ce cas, apr√®s avoir appel√© la m√©thode findByName, dans la liste r√©sultante, nous obtenons des entit√©s qui n'ont acc√®s qu'aux attributs d√©finis dans l'interface!  Selon le m√™me principe, on peut choisir des entit√©s d√©pendantes, c'est-√†-dire  s√©lectionnez imm√©diatement la relation ¬´ma√Ætre-d√©tail¬ª.  De plus, Spring g√©n√®re du SQL ¬´correct¬ª dans la plupart des cas, c'est-√†-dire  seuls les attributs d√©crits dans la projection sont s√©lectionn√©s dans la base de donn√©es, ce qui est tr√®s similaire au fonctionnement des graphiques d'entit√©. <br>  Il s'agit d'une API tr√®s puissante. Lorsque vous d√©finissez des interfaces, vous pouvez utiliser des expressions SpEL, utiliser des classes avec une sorte de logique int√©gr√©e au lieu d'interfaces, et bien plus encore, tout est d√©crit en d√©tail dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> . <br>  Le seul probl√®me avec les projections est qu'√† l'int√©rieur, elles sont impl√©ment√©es en tant que paires cl√©-valeur, c'est-√†-dire  sont en lecture seule.  Cela signifie que m√™me si nous d√©finissons une m√©thode de d√©finition pour la projection, nous ne pourrons pas enregistrer les modifications via les r√©f√©rentiels CRUD ou via EntityManager.  Les projections sont donc des DTO qui peuvent √™tre reconvertis en Entit√© et enregistr√©s uniquement si vous √©crivez votre propre code pour cela. </p><br><h2 id="kak-vybirayutsya-dannye-v-cuba">  Comment s√©lectionner des donn√©es dans CUBA </h2><br><p>  D√®s le d√©but du d√©veloppement du framework CUBA, nous avons essay√© d'optimiser la partie du code qui fonctionne avec la base de donn√©es.  Chez CUBA, nous utilisons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">EclipseLink</a> comme base pour l'API d'acc√®s aux donn√©es.  Ce qui est bien avec EclipseLink, c'est qu'il a pris en charge le chargement partiel d'entit√© d√®s le d√©but, et c'√©tait un facteur d√©cisif dans le choix entre lui et Hibernate.  Dans EclipseLink, vous pouvez sp√©cifier des attributs √† charger bien avant l'apparition de la norme JPA 2.1.  CUBA a sa propre fa√ßon de d√©crire un graphe d'entit√©, appel√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vues CUBA</a> .  Repr√©sentations CUBA est une API plut√¥t d√©velopp√©e, vous pouvez h√©riter de certaines repr√©sentations d'autres, les combiner, en appliquant √† la fois aux entit√©s ma√Ætre et d√©tail.  Une autre motivation pour cr√©er des vues CUBA est que nous voulions utiliser des transactions courtes afin de pouvoir travailler avec des entit√©s d√©tach√©es dans l'interface utilisateur Web. <br>  Dans CUBA, les vues sont d√©crites dans un fichier XML, comme dans l'exemple ci-dessous: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">view</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.sample.User"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">extends</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_minimal"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"user-minimal-view"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"name"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"addresses"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">view</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"address-street-only-view"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">view</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Cette vue s√©lectionne l'entit√© <code>User</code> et son <code>name</code> attribut local, et s√©lectionne √©galement des adresses en leur appliquant la vue <code>address-street-only-view</code> .  Tout cela se produit (attention!) Au niveau de la requ√™te SQL.  Lorsque la vue est cr√©√©e, vous pouvez l'utiliser dans la s√©lection de donn√©es √† l'aide de la classe DataManager: </p><br><pre> <code class="java hljs">List&lt;User&gt; users = dataManager.load(User.class).view(<span class="hljs-string"><span class="hljs-string">"user-edit-view"</span></span>).list();</code> </pre> <br><p>  Cette approche fonctionne bien, tout en consommant du trafic r√©seau de mani√®re √©conomique, car les attributs inutilis√©s ne sont tout simplement pas transf√©r√©s de la base de donn√©es vers l'application, mais, comme dans le cas de JPA, il y a un probl√®me: on ne peut pas dire quels attributs de l'entit√© ont √©t√© charg√©s.  Et dans CUBA, il y a une exception <code>‚ÄúIllegalStateException: Cannot get unfetched attribute [...] from detached object‚Äù</code> , qui, comme <code>LazyInit</code> , doit avoir √©t√© rencontr√© par tous ceux qui √©crivent en utilisant notre framework.  Comme dans le JPA, il existe des moyens de v√©rifier quels attributs ont √©t√© charg√©s et lesquels ne le sont pas, mais, encore une fois, √©crire de tels contr√¥les est une t√¢che fastidieuse et laborieuse qui d√©range beaucoup les d√©veloppeurs.  Il faut inventer autre chose pour ne pas alourdir les gens avec un travail que, en th√©orie, les machines peuvent faire. </p><br><h2 id="koncept---cuba-view-interfaces">  Concept - CUBA View Interfaces </h2><br><p>  Mais que faire si vous essayez de combiner des graphiques d'entit√©s et des projections?  Nous avons d√©cid√© de l'essayer et d√©velopp√© des interfaces pour les interfaces de vue d'entit√© qui suivent l'approche de projection Spring.  Ces interfaces sont traduites en vues CUBA au d√©marrage de l'application et peuvent √™tre utilis√©es dans le DataManager.  L'id√©e est simple: nous d√©crivons une interface (ou un ensemble d'interfaces), qui est un graphe d'entit√©. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserMinimalView</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseEntityView</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Integer</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String val)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">List&lt;AddressStreetOnly&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAddresses</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddressStreetOnly</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseEntityView</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Address</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Integer</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getStreet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setStreet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String street)</span></span></span></span>; } }</code> </pre> <br><p>  Il est √† noter que pour certains cas sp√©cifiques, vous pouvez r√©aliser des interfaces locales, comme dans le cas d' <code>AddressStreetOnly</code> partir de l'exemple ci-dessus, afin de ne pas ¬´polluer¬ª l'API publique de votre application. </p><br><p>  Dans le processus de d√©marrage d'une application CUBA (dont la plupart est l'initialisation du contexte Spring), nous cr√©ons par programmation des vues CUBA et les pla√ßons dans le r√©f√©rentiel du bean interne en contexte. <br>  Vous devez maintenant modifier l√©g√®rement l'impl√©mentation de la classe DataManager afin qu'elle accepte les vues d'interface, et vous pouvez s√©lectionner des entit√©s de cette mani√®re: </p><br><pre> <code class="java hljs">List&lt;UserMinimalView&gt; users = dataManager.load(UserMinimalView.class).list();</code> </pre> <br><p>  Sous le capot, un objet proxy est g√©n√©r√© qui impl√©mente l'interface et encapsule l'instance d'entit√© s√©lectionn√©e dans la base de donn√©es (de la m√™me mani√®re que dans Hibernate).  Et, lorsque le d√©veloppeur appelle la valeur d'attribut, le proxy d√©l√®gue l'appel de m√©thode √† l'instance ¬´r√©elle¬ª de l'entit√©. </p><br><p>  En d√©veloppant ce concept, nous essayons de tuer deux oiseaux avec une pierre: </p><br><ul><li>  Les donn√©es qui ne sont pas d√©crites dans l'interface ne sont pas charg√©es dans l'application, ce qui permet d'√©conomiser les ressources du serveur. </li><li>  Le d√©veloppeur ne peut utiliser que les attributs accessibles via l'interface (et, par cons√©quent, s√©lectionn√©s dans la base de donn√©es), √©liminant ainsi les exceptions <code>UnfetchedAttribute</code> dont nous avons parl√© plus haut. </li></ul><br><p>  Contrairement aux projections Spring, nous encapsulons les entit√©s dans des objets proxy, de plus, chaque interface h√©rite de l'interface CUBA standard - <code>Entity</code> .  Cela signifie que les attributs Entity View peuvent √™tre modifi√©s, puis enregistrez ces modifications dans la base de donn√©es √† l'aide de l'API CUBA standard pour travailler avec les donn√©es. <br>  Et, soit dit en passant, le ¬´troisi√®me li√®vre¬ª - vous pouvez rendre les attributs en lecture seule si vous d√©finissez une interface avec des m√©thodes getter uniquement.  Ainsi, nous avons d√©j√† d√©fini les r√®gles de modification au niveau de l'API d'entit√©. <br>  De plus, vous pouvez effectuer certaines op√©rations locales pour les entit√©s d√©tach√©es √† l'aide des attributs disponibles, par exemple, la conversion de cha√Æne de nom, comme dans l'exemple ci-dessous: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@MetaProperty</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getNameLowercase</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getName().toLowerCase(); }</code> </pre> <br><p>  Notez que les attributs calcul√©s peuvent √™tre retir√©s du mod√®le de classe d'entit√© et transf√©r√©s vers des interfaces applicables √† une logique m√©tier particuli√®re. </p><br><p>  Une autre caract√©ristique int√©ressante est l'h√©ritage d'interface.  Vous pouvez cr√©er plusieurs vues avec diff√©rents ensembles d'attributs, puis les combiner.  Par exemple, vous pouvez cr√©er une interface pour une entit√© Utilisateur avec les attributs nom et e-mail, et une autre avec les attributs nom et adresses.  Maintenant, si vous devez s√©lectionner le nom, l'adresse e-mail et les adresses, vous n'avez pas besoin de copier ces attributs dans la troisi√®me interface, il vous suffit d'h√©riter des deux premi√®res vues.  Et oui, les instances de la troisi√®me interface peuvent √™tre transmises √† des m√©thodes qui acceptent des param√®tres avec le type d'interface parent, les r√®gles de POO sont les m√™mes pour tout le monde. </p><br><p>  Une conversion entre les vues a √©galement √©t√© impl√©ment√©e - chaque interface a une m√©thode reload (), dans laquelle vous pouvez passer la classe de vue comme param√®tre: </p><br><pre> <code class="java hljs">UserFullView userFull = userMinimal.reload(UserFullView.class);</code> </pre> <br><p>  UserFullView peut contenir des attributs suppl√©mentaires, de sorte que l'entit√© sera recharg√©e √† partir de la base de donn√©es, si n√©cessaire.  Et ce processus est retard√©.  L'acc√®s √† la base de donn√©es se fera uniquement lors du premier acc√®s aux attributs de l'entit√©.  Cela ralentira un peu le premier appel, mais cette approche a √©t√© choisie intentionnellement - si l'instance d'entit√© est utilis√©e dans le module ¬´Web¬ª, qui contient l'interface utilisateur et ses propres contr√¥leurs REST, ce module peut √™tre d√©ploy√© sur un serveur distinct.  Et cela signifie que la surcharge forc√©e de l'entit√© cr√©era un trafic r√©seau suppl√©mentaire - acc√®s au module principal puis √† la base de donn√©es.  Ainsi, en reportant la surcharge jusqu'au moment o√π cela est n√©cessaire, nous √©conomisons du trafic et r√©duisons le nombre de requ√™tes de base de donn√©es. </p><br><p>  Le concept est con√ßu comme un module pour CUBA, un exemple d'utilisation peut √™tre t√©l√©charg√© depuis <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GitHub</a> . </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  Il semble que dans un avenir proche, nous continuerons √† utiliser massivement ORM dans les applications d'entreprise simplement parce que nous avons besoin de quelque chose qui transformera les donn√©es relationnelles en objets.  Bien s√ªr, des solutions sp√©cifiques seront d√©velopp√©es pour des applications complexes, uniques et √† tr√®s haute charge, mais il semble que les frameworks ORM vivront aussi longtemps que les bases de donn√©es relationnelles. <br>  Dans CUBA, nous essayons de simplifier au maximum le travail avec ORM, et dans les futures versions, nous introduirons de nouvelles fonctionnalit√©s pour travailler avec les donn√©es.  Il sera difficile de dire si ce seront des interfaces de pr√©sentation ou autre chose, mais je suis s√ªr d'une chose: nous continuerons √† simplifier le travail avec les donn√©es dans les futures versions du framework. </p><cut></cut></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr451986/">https://habr.com/ru/post/fr451986/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr451970/index.html">Thrangrycat: une vuln√©rabilit√© critique dans le micrologiciel des p√©riph√©riques Cisco permet aux pirates informatiques d'y installer des portes d√©rob√©es</a></li>
<li><a href="../fr451972/index.html">QuadCast - Sons r√©els</a></li>
<li><a href="../fr451974/index.html">Histoire d'AMD: 50 ans de d√©veloppement rapide</a></li>
<li><a href="../fr451976/index.html">Combien co√ªte un Runet ¬´souverain¬ª?</a></li>
<li><a href="../fr451982/index.html">Plus vite vous oubliez la POO, mieux c'est pour vous et vos programmes.</a></li>
<li><a href="../fr451990/index.html">FAQ sur les transferts et les vols de correspondance: quelle est la diff√©rence qu'un passager peut et ne peut pas faire</a></li>
<li><a href="../fr451996/index.html">Mon exp√©rience des erreurs</a></li>
<li><a href="../fr451998/index.html">Probl√®mes de l'agriculture de pr√©cision et comment vivre avec eux</a></li>
<li><a href="../fr452000/index.html">Comment √† Leroy Merlin vous pouvez acheter des marchandises de l'entrep√¥t d'un fournisseur qui ne fait pas partie de l'assortiment du magasin</a></li>
<li><a href="../fr452004/index.html">Trouv√© l'emplacement de la chute de l'appareil "Bereshit" sur la lune</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>