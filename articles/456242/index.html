<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñçÔ∏è ‚öìÔ∏è üö¢ Un poco m√°s sobre la multitarea en microcontroladores üè£ ü§µüèæ üçå</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En un art√≠culo anterior , hablamos sobre c√≥mo, seg√∫n el autor, es posible programar las acciones habituales de un microcontrolador en tiempo real, div...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Un poco m√°s sobre la multitarea en microcontroladores</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/456242/"><p>  En un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo</a> anterior <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">,</a> hablamos sobre c√≥mo, seg√∫n el autor, es posible programar las acciones habituales de un microcontrolador en tiempo real, dividi√©ndolas en varias tareas que son independientes (o casi independientes) entre s√≠. </p><br><p>  Se eligi√≥ un microcontrolador, con un n√∫cleo de una familia muy extendida de ARM Cortex M. De las opciones familiares para muchos, y no solo para el autor, con los n√∫meros 0,3,4 y 7, se eligi√≥ M4, porque estaba a la mano. </p><br><p>  Las dos consideraciones que nos llevaron a embarcarnos en el camino resbaladizo e inestable de "inventar la bicicleta", como algunos lectores comentaron ingeniosamente, en realidad eran simples.  La primera fue que todav√≠a tenemos que vivir y vivir con estas "cortezas".  Y el segundo es intentar no hacer algo universal (ganar fama y fortuna), sino hacer algo m√°s centrado, con la esperanza de lograr eficiencia y simplicidad.  Aquellos que a veces hacen algo con sus manos recordar√°n f√°cilmente que, por regla general, un destornillador especialmente seleccionado es mejor que el que se toma de un juego universal brillante. </p><a name="habracut"></a><br><p>  Se proporcion√≥ un ejemplo de ensamblador para mostrar que no se gastan m√°s de 80 ciclos de reloj en la conmutaci√≥n.  Y a una velocidad de reloj de 72 megahercios resulta un poco m√°s de 1 microsegundo.  Por lo tanto, una marca de 50 microsegundos de tama√±o no ser√° tan costosa.  Solo el 2 por ciento de los gastos generales.  Por lo tanto, como dijo uno de los personajes favoritos del autor, "es aconsejable sufrir". </p><br><p>  Por lo tanto, tenemos N tareas, cada una de las cuales est√° garantizada para ejecutar una parte (marca T) de tiempo y est√° garantizada para repetir este segmento a m√°s tardar despu√©s de (N-1) <em>T marcas, m√°s un retraso que no exceda D. Este retraso molesto, afortunadamente , est√° limitado por el tama√±o m√°ximo posible en el tiempo, que es igual a la suma de la duraci√≥n de la operaci√≥n de todas las interrupciones permitidas.</em>  <em>En otras palabras, la tarea que tiene la mayor cantidad de interrupciones potenciales durante un per√≠odo determinado antes del pr√≥ximo tic es muy desafortunada.</em>  <em>Durante m√°s tiempo, la tarea no se puede retrasar.</em>  <em>Inevitablemente recibir√° su intervalo de tiempo a m√°s tardar en (N-1)</em> T + D microsegundos.  En mi opini√≥n, esto se llama tiempo real dif√≠cil. </p><br><p>  Las tareas deben completar sus tareas e informar sobre la implementaci√≥n.  ¬øA qui√©n debo informar?  Aparentemente, alguien est√° a cargo, y sucede que, por regla general, son mucho m√°s peque√±os que los subordinados (en verdad, el autor tambi√©n encontr√≥ excepciones cuando hab√≠a cuatro jefes para tres trabajadores con ambas manos izquierdas, de los cuales solo uno conoc√≠a y respetaba la palabra " adecuaci√≥n "). </p><br><p>  Y si "ustedes son muchos, pero yo soy uno", entonces esto significa una cola.  Muchos comenzar√°n a empujar e intentar√°n deslizarse.  Y alguien tendr√° que esperar, y luego llegar tarde y explicar.  A pesar de que todo esto parece terrible, se llama hermoso: la lucha por el recurso.  Las colas son una soluci√≥n bien conocida para todos.  Conoc√≠ a muchos que no alimentan el pan; d√©jenme hacer cola. </p><br><p>  ¬°Pero el nuestro no puede esperar!  En el sentido, tareas.  Son de tiempo real dif√≠cil.  Suponga que dos tareas leen lecturas una vez cada segundo, y la tercera debe medir algo cada 10 milisegundos, ponerla en una pila e informar al principio.  Y le dicen: "Dime, no hemos terminado con los chefs". </p><br><p>  Aparentemente, tienes que girar, por decirlo suavemente, a un tiempo no del todo real (tiempo real suave). </p><br><p>  Tengamos una tarea especial que sepa esperar y le encanta hacerlo.  El recurso que servir√° ser√° el canal de comunicaci√≥n.  Como sabes, no meter√°s todo de una vez. <br>  Pero, puede averiguar de inmediato qu√© velocidad debe ser el canal para que no se pierda nada.  Para hacer esto, necesita conocer el rendimiento con el que trabajan todos nuestros grafoman√≠acos, pah, tareas.  Obviamente, tambi√©n debe calcular el tama√±o del b√∫fer o los b√∫feres desde los que se enviar√°n todos los paquetes (o hacia la derecha). </p><br><p>  Si el canal no es uno, entonces la esencia no cambia.  Para cada canal, simplemente se agrega una tarea separada, que est√° dise√±ada para esperar (y, por supuesto, esperar y creer). </p><br><p>  Algunas palabras sobre el canal de comunicaci√≥n con el operador, o m√°s simplemente, con la persona.  Aqu√≠ el canal es bidireccional, pero la direcci√≥n hacia afuera es m√°s interesante.  Inmediatamente haga una reserva, hay una circunstancia que, incluso con un fuerte deseo, es imposible de excluir.  Esta es la sobrecarga del canal.  Durante las pruebas, debemos alcanzarlo y tener un mecanismo para ver su aparici√≥n.  No discuto, no es bueno enga√±ar, pero se puede omitir un poco.  Vaughn, Gerasim, lo abus√≥ por completo. </p><br><p>  Por lo tanto, asumimos de inmediato que el mensaje al operador de la tarea puede perderse.  Y para que una persona sepa sobre esto, los numeraremos.  Esto determinar√° d√≥nde y cu√°ntas veces nuestro operador se qued√≥ sin nada.  En √∫ltima instancia, siempre puede hacer algo en el c√≥digo, agregar los c√°lculos o incluso adjuntarlo al circuito el√©ctrico para corregir la situaci√≥n.  Parece que, por el momento, ser√° m√°s f√°cil.  Pero, por supuesto, esto no es necesario para aplicaciones militares.  Para ser sincero, perder un mensaje no parece una desgracia solo cuando se depura. </p><br><p>  Por ejemplo, tengamos una interfaz serie d√∫plex sin reconocimiento a 115200 baudios.  Por ejemplo, RS422 en la configuraci√≥n "econom√≠a" de dos cables - all√≠, dos - atr√°s.  Su capacidad es de aproximadamente 10,000 bytes por segundo.  Tomemos el tama√±o promedio de mensaje para una persona igual a 50 bytes.  Recibimos 200 mensajes por segundo o un mensaje en 5 milisegundos.  Si tenemos tres tareas que quieren comunicar algo, entonces perm√≠tales hacerlo cada 15 milisegundos cada una.  En promedio, por supuesto.  Y si no es en promedio, entonces se requerir√°n c√°lculos estad√≠sticos serios o un experimento a gran escala.  Elige el √∫ltimo.  Despu√©s de todo, hemos aprendido a detectar mensajes faltantes y veremos todo en la pantalla del emulador de terminal. <br>  Entonces, deje que las tres tareas creen mensajes individuales.  Permita que los mensajes difieran en importancia o urgencia del contenido y nuestras tareas los coloquen en el b√∫fer apropiado.  Asigne estos tres amortiguadores de anillo para tres niveles de urgencia como se muestra en la Figura 1. </p><br><p><img src="https://habrastorage.org/webt/my/7m/uu/my7muue1i6hn5gjv3ugckhxsxzy.jpeg"></p><br><p>  La cuarta tarea selecciona de estos buffers un mensaje de acuerdo con nuestro plan aprobado e intenta entregarlo.  Si el env√≠o a√∫n no es posible, la cuarta tarea estima cu√°nto puede dormir y lo hace.  Despu√©s de dormir, ella ya tiene el espacio necesario en el b√∫fer de anillo para enviar. </p><br><p>  Los buffers de diversa urgencia, por supuesto, no almacenan los mensajes en s√≠, sino sus direcciones (enlaces).  Al mismo tiempo, las tareas en s√≠ mismas no necesitan esperar en absoluto.  Ok?  No, en realidad no.  Eso no funciona, y he aqu√≠ por qu√©.  Cada uno de estos tres buffers de anillo es un recurso compartido.  Imagina que la tarea 1 estaba a punto de poner una direcci√≥n en un buffer intermedio.  Ella lee la palabra, comprueba que el lugar est√° vac√≠o, es decir, el valor es cero y (en este momento es reemplazada por otra tarea 2, que quiere hacer exactamente lo mismo y tiene √©xito), la primera tarea, regresar, pone la palabra all√≠, sobrescribiendo todo lo que tuvo √©xito en segundo lugar.  Aqu√≠ hay un colega que pide palabras.  Parece que s√© lo que dir√°. <br>  -S√≠, todo es muy simple, puedes prohibir las interrupciones durante la prueba y no pasar√° nada malo, no es por mucho tiempo. <br>  - Cierto, no por mucho tiempo, pero ¬øcu√°ntas veces?  ¬øCu√°nto tiempo le quitaremos a la tarea?  ¬øY cu√°l de ellos?  Olvid√© advertir, nunca prohibimos las interrupciones, nuestra dura secta del tiempo real nos proh√≠be hacer esto. <br>  -Y si no proh√≠be las interrupciones, puede solicitar a nuestro conmutador de tareas que coloque la direcci√≥n del mensaje all√≠.  √âl puede hacerlo at√≥micamente. <br>  - S√≠, tal vez, pero luego quiero preguntarle algo m√°s, luego otra.  ¬øY por qu√© entonces logramos 72 grados y luego diluimos todo con agua?  Lo siento, quise decir 72 ciclos para cambiar de contexto. <br>  Intentemos hacerlo m√°s f√°cil, como en la Figura 2. </p><br><p><img src="https://habrastorage.org/webt/oq/u0/mk/oqu0mkfpi0g7l5ralfun_qk2vaw.jpeg"></p><br><p>  En este caso, cada tarea tiene su propio b√∫fer o su propio conjunto de b√∫feres, si desea una urgencia, pompa e importancia diferentes.  Personalmente, yo, como operador simple, sigo teniendo la misma importancia para todos. </p><br><p>  Tal esquema no te hace luchar por el recurso.  Ahora tenemos una opci√≥n muy funcional.  Simplemente no me gusta.  Pero, ¬øqu√© pasa si las tareas a la izquierda en la imagen no tienen nada que enviar?  Entonces ser√≠a m√°s prudente pedir que se despertara la tarea a la derecha cuando aparezca la raz√≥n, y no despertarse solo para configurar la alarma nuevamente.  Las tareas a la izquierda son m√°s f√°ciles de hacer.  Adem√°s, una funci√≥n que ayuda a despertar a un amigo se mencion√≥ en una publicaci√≥n anterior. </p><br><p>  Preveo una propuesta de racionalizaci√≥n: "Deje que la interrupci√≥n del puerto serie (UART) se involucre en lo que la tarea 4 est√° haciendo ahora, habr√° ahorros".  Puedes hacer esto, pero no creo que sea bueno.  Tratar√© de aclararlo.  Las tareas a la izquierda, de hecho, pueden activar el procedimiento de interrupci√≥n UART, y comenzar√° a funcionar y no se detendr√° hasta que haga todo.  El procedimiento de interrupci√≥n ahora deber√≠a hacer todo lo que sol√≠a hacer la tarea 4. El tiempo necesario para procesar la interrupci√≥n aumentar√°, ni una sola tarea podr√° encenderse hasta que termine el pr√≥ximo "spool".  ¬øY qu√© les decimos a nuestros camaradas del c√≠rculo persistente en tiempo real?  Pero nos dijeron que la respuesta a cualquier interrupci√≥n externa deber√≠a ser lo m√°s breve posible.  Este es solo un buen tono.  O, en otras palabras: es necesario hacer el bien, el mal y sin ti funcionar√°. </p><br><p>  La Figura 3 explica qu√© es el proceso y qu√© desaf√≠os se encuentran. </p><br><p><img src="https://habrastorage.org/webt/hs/jj/_h/hsjj_h0riitsgnqvcutjqrfb9ow.jpeg"></p><br><p>  Ahora pasamos a la situaci√≥n, se podr√≠a decir, un espejo.  Esto es cuando la informaci√≥n proviene del exterior.  Que sea un canal SPI con varios gondoleros con g√≥ndolas y una peque√±a orquesta de cuerdas amateur.  No, es muy temprano para pensar en descansar.  Deje solo la interfaz SPI y algunos chips.  Por ejemplo, sensor de presi√≥n atmosf√©rica, aceler√≥metro y memoria almacenada. </p><br><p>  Debo decir de inmediato: un ejemplo est√∫pido.  No por el gondolero con su eterno "debo agregar, caballero".  No, es est√∫pido, de hecho, mezclar en una interfaz datos de entrada de diferente importancia.  De hecho, si necesita conocer la aceleraci√≥n, entonces, con seguridad, para determinar r√°pidamente cu√°ndo quitar el pedal del acelerador, o girar las aletas, o cerrar los ojos, finalmente.  Esta informaci√≥n es a menudo necesaria.  Pero la presi√≥n, cambia lentamente y tendr√° que volar unos tres metros hacia abajo, por lo que en los rangos inferiores la vida se volver√° m√°s c√°lida. </p><br><p>  En cuanto a la memoria almacenada, ¬øy qui√©n generalmente la incluye en este SPI?  ¬øHay un segundo SPI?  ¬øY no se espera?  No hay a d√≥nde ir, hay que hacer algo.  Redireccione las flechas en la direcci√≥n opuesta en la Figura 2 y comience a pensar. </p><br><p>  La tarea 4 ahora sirve al SPI y se despierta solo por sus se√±ales.  Su conexi√≥n con la tarea 1, que quiere poner algo en la memoria almacenada, se dirige hacia afuera y se lleva a cabo a trav√©s de la cola.  Tambi√©n es necesario proporcionar un mecanismo para monitorear el desbordamiento del b√∫fer en anillo.  La producci√≥n de valores de aceleraci√≥n y presi√≥n de la tarea 4 debe proporcionarse sin la participaci√≥n de dos tareas consumidoras.  Solo necesitas girar y seguir el ritmo.  Ahora podemos esbozar una imagen explicativa y escribir una nota explicativa.  En la Figura 4, estos <br>  Las acciones se muestran esquem√°ticamente (o diagrama de bloques). </p><br><p><img src="https://habrastorage.org/webt/qs/1p/n0/qs1pn0mxzu5642c1kwrttvpvhtw.jpeg"></p><br><p>  Comprobaci√≥n de flujo insuficiente: estas acciones lo ayudan a descubrir si el valor de aceleraci√≥n tiene tiempo de cambiar antes de que la tarea de consumo lo lea nuevamente.  Esta verificaci√≥n se muestra mediante una acci√≥n separada en la Figura 4 solo para llamar la atenci√≥n.  De hecho, este paso ocurre junto con la lectura del valor del aceler√≥metro de acuerdo con el esquema, como se muestra en la Figura 5. </p><br><p><img src="https://habrastorage.org/webt/2z/6l/tx/2z6ltxiu6jeuvtizhjjurmodhq8.jpeg"></p><br><p>  Cabe se√±alar que existe un recurso compartido, ya que el lugar de almacenamiento del resultado tambi√©n es un indicador de acciones (sem√°foro).  Las carreras son posibles aqu√≠, hablando el lenguaje de los circuitos, pero para nosotros esto no es una omisi√≥n.  Despu√©s de todo, deslizarse por la puerta de cierre de un veh√≠culo solo en la vida puede considerarse una fortuna.  Aqu√≠ lo consideraremos con confianza un retraso. </p><br><p>  El acceso a la memoria ocurre en porciones para limitar el tiempo de cada paso.  Por lo tanto, aseguraremos una lectura uniforme de los valores de aceleraci√≥n que cambian r√°pidamente, y en el medio estaremos a tiempo ocup√°ndonos del resto. </p><br><p>  Bueno, ahora queda por encontrar algo adecuado de hierro y experimentar como deber√≠a.  Esta, creo, ser√° la pr√≥xima historia. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/456242/">https://habr.com/ru/post/456242/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../456232/index.html">Gu√≠a: Actualizaci√≥n de interfaces con miembros predeterminados en C # 8.0</a></li>
<li><a href="../456234/index.html">¬øPor qu√© Cisco no compra Splunk o habla sobre c√≥mo funciona la plataforma Cisco para la caza de amenazas?</a></li>
<li><a href="../456236/index.html">Peter - Insider Dev Tour: Conferencia Insider para desarrolladores de Microsoft</a></li>
<li><a href="../456238/index.html">Tutorial: Actualizar interfaces con miembros de interfaz predeterminados en C # 8.0</a></li>
<li><a href="../456240/index.html">Desarrollo de chatbot (laravel + botman)</a></li>
<li><a href="../456246/index.html">Elemento cero</a></li>
<li><a href="../456248/index.html">C√≥mo atrap√©: antes de los estilos para un elemento de enfoque</a></li>
<li><a href="../456250/index.html">Localizaci√≥n de aplicaciones y soporte RTL. Informe Yandex.Taxi</a></li>
<li><a href="../456256/index.html">Gu√≠a de arquitectura de aplicaciones de Android</a></li>
<li><a href="../456258/index.html">Gratis como viento y gratis como cerveza traducci√≥n de "Gratis como en libertad" al ruso bajo la licencia GNU FDL 1.3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>