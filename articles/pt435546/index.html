<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôÑ üë¥ ü§≥üèø Dicas pr√°ticas, exemplos e t√∫neis SSH üßëüèø‚Äçü§ù‚Äçüßëüèæ üî¢ üì´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Exemplos pr√°ticos de SSH que levar√£o suas habilidades de administrador de sistema remoto para o pr√≥ximo n√≠vel. Comandos e dicas ajudar√£o n√£o apenas a ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Dicas pr√°ticas, exemplos e t√∫neis SSH</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435546/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/oz/pn/4x/ozpn4xuna3odpakxmdgnlwqxwto.jpeg"></div><br>  Exemplos pr√°ticos de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SSH</a> que levar√£o suas habilidades de administrador de sistema remoto para o pr√≥ximo n√≠vel.  Comandos e dicas ajudar√£o n√£o apenas a usar o <code>SSH</code> , mas tamb√©m a navegar com mais compet√™ncia na rede. <br><br>  Conhecer alguns truques <code>ssh</code> √© √∫til para qualquer administrador de sistemas, engenheiro de rede ou especialista em seguran√ßa. <br><a name="habracut"></a><br><h3>  Exemplos pr√°ticos de SSH </h3><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Proxy de meias SSH</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">T√∫nel SSH (encaminhamento de porta)</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">T√∫nel SSH para o terceiro host</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">T√∫nel reverso SSH</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Proxy reverso SSH</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Instalando VPN sobre SSH</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Copiar chave SSH (ssh-copy-id)</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Execu√ß√£o de comando remoto (n√£o interativo)</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Captura e visualiza√ß√£o remotas de pacotes no Wireshark</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Copiando uma pasta local para um servidor remoto via SSH</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Aplicativos GUI de encaminhamento SSH X11 remoto</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">C√≥pia remota de arquivos usando rsync e SSH</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SSH na rede Tor</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Inst√¢ncia SSH para EC2</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Editando arquivos de texto usando o VIM via ssh / scp</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Montando SSH remoto como uma pasta local com SSHFS</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Multiplexa√ß√£o SSH com ControlPath</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Streaming de v√≠deo SSH usando VLC e SFTP</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Autentica√ß√£o de dois fatores</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Salto de host com SSH e -J</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Bloqueando tentativas de for√ßa bruta SSH com iptables</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Escape SSH para alterar o encaminhamento de porta</a> </li></ol><br><h1>  No√ß√µes b√°sicas primeiro </h1><br><h4>  An√°lise de linha de comando SSH </h4><br>  O exemplo a seguir usa os par√¢metros usuais frequentemente encontrados ao conectar-se a um servidor <code>SSH</code> remoto. <br><br><pre> <code class="bash hljs">localhost:~$ ssh -v -p 22 -C neo@remoteserver</code> </pre> <br><ul><li>  <code>-v</code> : a sa√≠da de depura√ß√£o √© especialmente √∫til ao analisar problemas de autentica√ß√£o.  Voc√™ pode us√°-lo v√°rias vezes para exibir informa√ß√µes adicionais. </li><li>  <code>- p 22</code> : <b>porta para conectar-se</b> a um servidor SSH remoto.  22 n√£o √© necess√°rio especificar, porque esse √© o valor padr√£o, mas se o protocolo estiver em outra porta, n√≥s o especificaremos usando o par√¢metro <code>-p</code> .  A porta de <code>sshd_config</code> √© especificada no arquivo <code>sshd_config</code> no formato <code>Port 2222</code> . </li><li>  <code>-C</code> : compacta√ß√£o para a conex√£o.  Se voc√™ tem um feed lento ou visualiza muito texto, isso pode acelerar a conex√£o. </li><li>  <code>neo@</code> : a linha antes do s√≠mbolo @ indica o nome de usu√°rio para autentica√ß√£o no servidor remoto.  Se voc√™ n√£o especificar, por padr√£o, o nome de usu√°rio da conta em que voc√™ est√° conectado no momento ser√° usado (~ $ whoami).  O usu√°rio tamb√©m pode ser especificado com a op√ß√£o <code>-l</code> . </li><li>  <code>remoteserver</code> : o nome do host ao qual o <code>ssh</code> conecta, pode ser um nome de dom√≠nio totalmente qualificado, endere√ßo IP ou qualquer host no arquivo de hosts locais.  Para conectar-se a um host compat√≠vel com IPv4 e IPv6, voc√™ pode adicionar a op√ß√£o <code>-4</code> ou <code>-6</code> √† linha de comando para obter uma resolu√ß√£o adequada. </li></ul><br>  Todas as op√ß√µes acima s√£o opcionais, exceto <code>remoteserver</code> . <br><br><h4>  Usando arquivo de configura√ß√£o </h4><br>  Embora muitos estejam familiarizados com o arquivo <code>sshd_config</code> , tamb√©m h√° um arquivo de configura√ß√£o do cliente para o comando <code>ssh</code> .  O valor padr√£o √© <code>~/.ssh/config</code> , mas pode ser definido como um par√¢metro para a op√ß√£o <code>-F</code> . <br><br><pre> <code class="bash hljs">Host * Port 2222 Host remoteserver HostName remoteserver.thematrix.io User neo Port 2112 IdentityFile /home/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/.ssh/remoteserver.private_key</code> </pre> <br>  O arquivo de configura√ß√£o ssh de exemplo acima possui duas entradas de host.  O primeiro indica todos os hosts, o par√¢metro de configura√ß√£o da Porta 2222 √© usado para <b>todos.O</b> segundo diz que, para o host do servidor de <b>controle remoto</b> , use um nome de usu√°rio, porta, FQDN e IdentityFile diferentes. <br><br>  Um arquivo de configura√ß√£o pode economizar muito tempo digitando caracteres, permitindo aplicar automaticamente a configura√ß√£o avan√ßada ao conectar-se a hosts espec√≠ficos. <br><br><h4>  Copiar arquivos por SSH usando o SCP </h4><br>  O cliente SSH vem com duas outras ferramentas muito convenientes para copiar arquivos em uma <b>conex√£o ssh criptografada</b> .  Veja abaixo um exemplo de uso padr√£o dos comandos scp e sftp.  Observe que muitas das op√ß√µes do ssh tamb√©m se aplicam a esses comandos. <br><br><pre> <code class="bash hljs">localhost:~$ scp mypic.png neo@remoteserver:/media/data/mypic_2.png</code> </pre> <br>  Neste exemplo, o arquivo <b>mypic.png √©</b> copiado para o <b>servidor de controle remoto</b> na pasta <b>/ media / data</b> e renomeado para <b>mypic_2.png</b> . <br><br>  N√£o se esque√ßa da diferen√ßa no par√¢metro port.  Isso ocorre com muitos que executam o <code>scp</code> na linha de comando.  Aqui o par√¢metro da porta √© <code>-P</code> , n√£o <code>-p</code> , como no cliente ssh!  Voc√™ esquecer√°, mas n√£o se preocupe, todos esquecer√£o. <br><br>  Para aqueles familiarizados com o <code>ftp</code> console, muitos dos comandos s√£o semelhantes no <code>sftp</code> .  Voc√™ pode <b>empurrar</b> , <b>colocar</b> e <b>sl</b> como seu cora√ß√£o deseja. <br><br><pre> <code class="bash hljs">sftp neo@remoteserver</code> </pre> <br><h1>  Exemplos pr√°ticos </h1><br>  Em muitos desses exemplos, o resultado pode ser alcan√ßado por v√°rios m√©todos.  Como em todos os nossos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">livros</a> e exemplos, √© dada prefer√™ncia a exemplos pr√°ticos que simplesmente fazem seu trabalho. <br><br><a name="1"></a><h3>  1. proxy meias SSH </h3><br>  Proxy SSH no n√∫mero 1 por um bom motivo.  √â mais poderoso do que muitos pensam e fornece acesso a qualquer sistema ao qual um servidor remoto tenha acesso, usando quase qualquer aplicativo.  O cliente ssh pode encapsular o tr√°fego atrav√©s do proxy SOCKS com um comando simples.  √â importante entender que o tr√°fego para sistemas remotos vir√° de um servidor remoto, conforme ser√° indicado nos logs do servidor da web. <br><br><pre> <code class="bash hljs">localhost:~$ ssh -D 8888 user@remoteserver localhost:~$ netstat -pan | grep 8888 tcp 0 0 127.0.0.1:8888 0.0.0.0:* LISTEN 23880/ssh</code> </pre> <br>  Aqui, executamos o proxy socks na porta TCP 8888, o segundo comando verifica se a porta est√° ativa no modo de escuta.  127.0.0.1 indica que o servi√ßo √© executado apenas no host local.  Podemos usar um comando ligeiramente diferente para ouvir todas as interfaces, incluindo ethernet ou wifi, isso permitir√° que outros aplicativos (navegadores, etc.) em nossa rede se conectem ao servi√ßo de proxy via ssh socks proxy. <br><br><pre> <code class="bash hljs">localhost:~$ ssh -D 0.0.0.0:8888 user@remoteserver</code> </pre> <br>  Agora podemos configurar o navegador para conectar-se ao proxy de meias.  No Firefox, selecione <b>Configura√ß√µes |</b>  <b>Destaques |</b>  <b>Configura√ß√µes de rede</b>  Especifique o endere√ßo IP e a porta para conectar. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/daa/f8b/545/daaf8b54515ce6eee864c8416d41eef9.png"><br><br>  Preste aten√ß√£o na op√ß√£o na parte inferior do formul√°rio para que as consultas DNS do navegador tamb√©m passem pelos proxies do SOCKS.  Se voc√™ usa um servidor proxy para criptografar o tr√°fego da web na rede local, provavelmente deseja selecionar esta op√ß√£o para que as consultas DNS sejam encapsuladas por meio de uma conex√£o SSH. <br><br><h4>  Ativa√ß√£o de proxy de meias no Chrome </h4><br>  A execu√ß√£o do Chrome com certas op√ß√µes de linha de comando ativa os proxies de meias, bem como encapsula as consultas DNS do navegador.  Confie, mas verifique.  Use <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tcpdump</a> para verificar se as consultas DNS n√£o est√£o mais vis√≠veis. <br><br><pre> <code class="bash hljs">localhost:~$ google-chrome --proxy-server=<span class="hljs-string"><span class="hljs-string">"socks5://192.168.1.10:8888"</span></span></code> </pre> <br><h4>  Usando outros aplicativos proxy </h4><br>  Lembre-se de que muitos outros aplicativos tamb√©m podem usar proxies de meias.  Um navegador da web √© simplesmente o mais popular deles.  Alguns aplicativos t√™m op√ß√µes de configura√ß√£o para ativar um servidor proxy.  Outros precisam de uma pequena ajuda com o programa auxiliar.  Por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">proxychains</a> permite executar o Microsoft RDP, etc. por meio de socks-proxies. <br><br><pre> <code class="bash hljs">localhost:~$ proxychains rdesktop <span class="hljs-variable"><span class="hljs-variable">$RemoteWindowsServer</span></span></code> </pre> <br>  Os par√¢metros de configura√ß√£o do proxy socks s√£o definidos no arquivo de configura√ß√£o proxychains. <br><br><blockquote>  Dica: se voc√™ usa a √°rea de trabalho remota do Linux no Windows?  Experimente o cliente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">FreeRDP</a> .  Essa √© uma implementa√ß√£o mais moderna que o <code>rdesktop</code> , com uma intera√ß√£o muito mais suave. </blockquote><br><h4>  Op√ß√£o SSH atrav√©s do proxy de meias </h4><br>  Voc√™ est√° sentado em um caf√© ou hotel - e √© for√ßado a usar Wi-Fi n√£o confi√°vel.  No laptop, inicie localmente o proxy ssh e instale o t√∫nel ssh na rede dom√©stica no Rasberry Pi local.  Usando um navegador ou outros aplicativos configurados para proxies de meias, podemos acessar quaisquer servi√ßos de rede em nossa rede dom√©stica ou acessar a Internet atrav√©s de uma conex√£o dom√©stica.  Tudo entre o seu laptop e o servidor dom√©stico (via Wi-Fi e Internet na sua casa) √© criptografado no t√∫nel SSH. <br><br><a name="2"></a><h3>  2. T√∫nel SSH (encaminhamento de porta) </h3><br>  Na sua forma mais simples, um t√∫nel SSH simplesmente abre uma porta no sistema local que se conecta a outra porta na outra extremidade do t√∫nel. <br><br><pre> <code class="bash hljs">localhost:~$ ssh -L 9999:127.0.0.1:80 user@remoteserver</code> </pre> <br>  Vamos examinar a op√ß√£o <code>-L</code> .  Pode ser representado como o lado local da escuta.  Assim, no exemplo acima, a porta 9999 √© escutada no lado do host local e √© encaminhada pela porta 80 para o servidor de controle remoto.  Por favor note que 127.0.0.1 refere-se ao host local no servidor remoto! <br><br>  Vamos subir um passo.  No exemplo a seguir, as portas de atendimento se comunicam com outros n√≥s na rede local. <br><br><pre> <code class="bash hljs">localhost:~$ ssh -L 0.0.0.0:9999:127.0.0.1:80 user@remoteserver</code> </pre> <br>  Nestes exemplos, nos conectamos √† porta no servidor web, mas pode ser um servidor proxy ou qualquer outro servi√ßo TCP. <br><br><a name="3"></a><h3>  3. T√∫nel SSH para um host de terceiros </h3><br>  Podemos usar os mesmos par√¢metros para conectar um t√∫nel de um servidor remoto a outro servi√ßo em execu√ß√£o em um terceiro sistema. <br><br><pre> <code class="bash hljs">localhost:~$ ssh -L 0.0.0.0:9999:10.10.10.10:80 user@remoteserver</code> </pre> <br>  Neste exemplo, estamos redirecionando o t√∫nel do remoteserver para um servidor Web em execu√ß√£o em 10.10.10.10.  O tr√°fego com servidor de controle remoto at√© 10.10.10.10 <b>n√£o</b> est√° <b>mais no t√∫nel SSH</b> .  Em 10.10.10.10, o servidor da web considerar√° o remoteserver como a fonte de solicita√ß√µes da web. <br><br><a name="4"></a><h3>  4. T√∫nel SSH reverso </h3><br>  Aqui, configuramos a porta de atendimento no servidor remoto, que ser√° conectada novamente √† porta local em nosso host local (ou outro sistema). <br><br><pre> <code class="bash hljs">localhost:~$ ssh -v -R 0.0.0.0:1999:127.0.0.1:902 192.168.1.100 user@remoteserver</code> </pre> <br>  Nesta sess√£o SSH, √© estabelecida uma conex√£o da porta 1999 no servidor de controle remoto para a porta 902 em nosso cliente local. <br><br><a name="5"></a><h3>  5. Proxy SSH Reverso </h3><br>  Nesse caso, instalamos o proxy socks em nossa conex√£o ssh, no entanto, o proxy escuta na extremidade remota do servidor.  As conex√µes com esse proxy remoto agora aparecem no t√∫nel como tr√°fego de nosso host local. <br><br><pre> <code class="bash hljs">localhost:~$ ssh -v -R 0.0.0.0:1999 192.168.1.100 user@remoteserver</code> </pre> <br><h4>  Solu√ß√£o de problemas de t√∫neis SSH remotos </h4><br>  Se voc√™ tiver problemas com as op√ß√µes SSH remotas, verifique com o <code>netstat</code> quais outras interfaces a porta de atendimento est√° conectada.  Embora tenhamos especificado 0.0.0.0 nos exemplos, mas se o valor <b>GatewayPorts</b> em <b>sshd_config estiver</b> definido como <b>no</b> , o ouvinte ser√° vinculado apenas ao localhost (127.0.0.1). <br><br><blockquote><h4>  Aviso de seguran√ßa </h4><br>  Observe que, ao abrir t√∫neis e proxies de meias, os recursos internos da rede podem estar dispon√≠veis para redes n√£o confi√°veis ‚Äã‚Äã(por exemplo, a Internet!).  Isso pode ser um s√©rio risco √† seguran√ßa, portanto, entenda o que √© o ouvinte e o que ele tem acesso. </blockquote><br><a name="6"></a><h3>  6. Instalando VPN sobre SSH </h3><br>  O termo geral entre especialistas em m√©todos de ataque (pentesters etc.) √© "o ponto de apoio da rede".  Ap√≥s estabelecer uma conex√£o em um sistema, esse sistema se torna um gateway para acesso adicional √† rede.  O ponto de apoio que permite mover em largura. <br><br>  Para esse ponto de apoio, podemos usar proxies e <b>proxychains</b> SSH, no entanto, existem algumas limita√ß√µes.  Por exemplo, voc√™ n√£o poder√° trabalhar diretamente com soquetes; portanto, n√£o ser√° poss√≠vel verificar portas dentro da rede via <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Nmap</a> <code>SYN</code> . <br><br>  Usando esta op√ß√£o de VPN mais avan√ßada, a conex√£o cai para o <b>n√≠vel 3</b> .  Em seguida, podemos simplesmente rotear o tr√°fego pelo t√∫nel usando o roteamento de rede padr√£o. <br><br>  O m√©todo usa <code>ssh</code> , <code>iptables</code> , <code>tun interfaces</code> e roteamento. <br><br>  Primeiro, voc√™ precisa definir esses par√¢metros em <code>sshd_config</code> .  Como estamos fazendo altera√ß√µes nas interfaces dos sistemas remoto e cliente, <b>precisamos de privil√©gios de root nos dois lados</b> . <br><br><pre> <code class="bash hljs">PermitRootLogin yes PermitTunnel yes</code> </pre> <br>  Em seguida, estabele√ßa uma conex√£o ssh usando um par√¢metro que solicite a inicializa√ß√£o dos dispositivos tun. <br><br><pre> <code class="bash hljs">localhost:~<span class="hljs-comment"><span class="hljs-comment"># ssh -v -w any root@remoteserver</span></span></code> </pre> <br>  Agora devemos ter um dispositivo tun ao mostrar interfaces ( <code># ip a</code> ).  A pr√≥xima etapa adicionar√° endere√ßos IP √†s interfaces do t√∫nel. <br><br>  Lado do Cliente SSH: <br><br><pre> <code class="bash hljs">localhost:~<span class="hljs-comment"><span class="hljs-comment"># ip addr add 10.10.10.2/32 peer 10.10.10.10 dev tun0 localhost:~# ip tun0 up</span></span></code> </pre> <br>  Lado do servidor SSH: <br><br><pre> <code class="bash hljs">remoteserver:~<span class="hljs-comment"><span class="hljs-comment"># ip addr add 10.10.10.10/32 peer 10.10.10.2 dev tun0 remoteserver:~# ip tun0 up</span></span></code> </pre> <br>  Agora temos uma rota direta para outro host ( <code>route -n</code> e <code>ping 10.10.10.10</code> ). <br><br>  Voc√™ pode rotear qualquer sub-rede pelo host do outro lado. <br><br><pre> <code class="bash hljs">localhost:~<span class="hljs-comment"><span class="hljs-comment"># route add -net 10.10.10.0 netmask 255.255.255.0 dev tun0</span></span></code> </pre> <br>  No lado remoto, voc√™ deve ativar o <code>ip_forward</code> e o <code>iptables</code> . <br><br><pre> <code class="bash hljs">remoteserver:~<span class="hljs-comment"><span class="hljs-comment"># echo 1 &gt; /proc/sys/net/ipv4/ip_forward remoteserver:~# iptables -t nat -A POSTROUTING -s 10.10.10.2 -o enp7s0 -j MASQUERADE</span></span></code> </pre> <br>  Boom!  <b>T√∫nel VPN sobre SSH na camada de rede 3</b> .  Isso j√° √© uma vit√≥ria. <br><br>  Se voc√™ encontrar algum problema, use <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tcpdump</a> e <code>ping</code> para determinar a causa.  Como jogamos no n√≠vel 3, nossos pacotes icmp passar√£o por esse t√∫nel. <br><br><a name="7"></a><h3>  7. Copiando a chave SSH (ssh-copy-id) </h3><br>  Existem v√°rias maneiras, mas esse comando economiza tempo para n√£o copiar arquivos manualmente.  Ele simplesmente copia ~ / .ssh / id_rsa.pub (ou a chave padr√£o) do seu sistema para <code>~/.ssh/authorized_keys</code> no servidor remoto. <br><br><pre> <code class="bash hljs">localhost:~$ ssh-copy-id user@remoteserver</code> </pre> <br><a name="8"></a><h3>  8. Execu√ß√£o de comando remoto (n√£o interativo) </h3><br>  O comando <code>ssh</code> pode ser associado a outros comandos da interface amig√°vel ao usu√°rio.  Basta adicionar o comando que voc√™ deseja executar no host remoto como o √∫ltimo par√¢metro entre aspas. <br><br><pre> <code class="bash hljs">localhost:~$ ssh remoteserver <span class="hljs-string"><span class="hljs-string">"cat /var/log/nginx/access.log"</span></span> | grep badstuff.php</code> </pre> <br>  Neste exemplo, o <code>grep</code> √© executado no sistema local ap√≥s o download do log pelo canal ssh.  Se o arquivo for grande, √© mais conveniente executar o <code>grep</code> no lado remoto, simplesmente colocando os dois comandos entre aspas duplas. <br><br>  Outro exemplo executa a mesma fun√ß√£o que <code>ssh-copy-id</code> do exemplo 7. <br><br><pre> <code class="bash hljs">localhost:~$ cat ~/.ssh/id_rsa.pub | ssh remoteserver <span class="hljs-string"><span class="hljs-string">'cat &gt;&gt; .ssh/authorized_keys'</span></span></code> </pre> <br><a name="9"></a><h3>  9. Captura remota de pacotes e visualiza√ß√£o no Wireshark </h3><br>  Eu peguei um dos nossos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">exemplos de tcpdump</a> .  Use-o para interceptar remotamente pacotes com o resultado diretamente na GUI do Wireshark local. <br><br><pre> <code class="bash hljs">:~$ ssh root@remoteserver <span class="hljs-string"><span class="hljs-string">'tcpdump -c 1000 -nn -w - not port 22'</span></span> | wireshark -k -i -</code> </pre> <br><a name="10"></a><h3>  10. Copiando uma pasta local para um servidor remoto via SSH </h3><br>  Um belo truque que comprime uma pasta usando <code>bzip2</code> (esta √© a op√ß√£o -j no comando <code>tar</code> ) e extrai o fluxo <code>bzip2</code> do outro lado, criando uma duplicata da pasta no servidor remoto. <br><br><pre> <code class="bash hljs">localhost:~$ tar -cvj /datafolder | ssh remoteserver <span class="hljs-string"><span class="hljs-string">"tar -xj -C /datafolder"</span></span></code> </pre> <br><a name="11"></a><h3>  11. Aplicativos da GUI de encaminhamento SSH X11 remoto </h3><br>  Se o cliente e o servidor remoto tiverem o X instalado, voc√™ poder√° executar remotamente o comando da GUI, com uma janela na √°rea de trabalho local.  Esse recurso existe h√° muito tempo, mas ainda √© muito √∫til.  Inicie um navegador da Web remoto ou at√© o console da Esta√ß√£o de Trabalho VMWawre, como eu fa√ßo neste exemplo. <br><br><pre> <code class="bash hljs">localhost:~$ ssh -X remoteserver vmware</code> </pre> <br>  Requer a linha <code>X11Forwarding yes</code> no arquivo <code>sshd_config</code> . <br><br><a name="12"></a><h3>  12. C√≥pia remota de arquivos usando rsync e SSH </h3><br>  <code>rsync</code> √© muito mais conveniente que o <code>scp</code> se voc√™ precisar fazer backup peri√≥dico de um diret√≥rio, um grande n√∫mero de arquivos ou arquivos muito grandes.  H√° uma fun√ß√£o para se recuperar de uma falha de transmiss√£o e copiar apenas arquivos modificados, o que economiza tr√°fego e tempo. <br><br>  Este exemplo usa a compress√£o <code>gzip</code> (-z) e o modo de arquivamento (-a), que permite a c√≥pia recursiva. <br><br><pre> <code class="bash hljs">:~$ rsync -az /home/testuser/data remoteserver:backup/</code> </pre> <br><a name="13"></a><h3>  13. SSH na rede Tor </h3><br>  Uma rede Tor an√¥nima pode encapsular o tr√°fego SSH usando o <code>torsocks</code> .  O comando a seguir lan√ßar√° um proxy ssh atrav√©s do Tor. <br><br><pre> <code class="bash hljs">localhost:~$ torsocks ssh myuntracableuser@remoteserver</code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O Torsocks</a> usar√° a porta 9050 para proxy no host local.  Como sempre, ao usar o Tor, voc√™ precisa verificar seriamente qual tr√°fego est√° sendo encapsulado e outros problemas de seguran√ßa operacional (opsec).  <b>Para onde est√£o indo suas consultas DNS?</b> <br><br><a name="14"></a><h3>  14. Inst√¢ncia SSH para EC2 </h3><br>  √â necess√°ria uma chave privada para conectar-se a uma inst√¢ncia do EC2.  Fa√ßa o download (extens√£o .pem) no painel de controle do Amazon EC2 e altere as permiss√µes ( <code>chmod 400 my-ec2-ssh-key.pem</code> ).  Mantenha a chave em um local seguro ou coloque-a na sua pasta <code>~/.ssh/</code> . <br><br><pre> <code class="bash hljs">localhost:~$ ssh -i ~/.ssh/my-ec2-key.pem ubuntu@my-ec2-public</code> </pre> <br>  A <b>op√ß√£o -i</b> simplesmente diz ao cliente ssh para usar essa op√ß√£o.  O <code>~/.ssh/config</code> √© ideal para configurar automaticamente o uso de chaves ao conectar-se ao host ec2. <br><br><pre> <code class="bash hljs">Host my-ec2-public Hostname ec2???.compute-1.amazonaws.com User ubuntu IdentityFile ~/.ssh/my-ec2-key.pem</code> </pre> <br><a name="15"></a><h3>  15. Editando arquivos de texto usando o VIM via ssh / scp </h3><br>  Para todos os amantes do <code>vim</code> , essa dica economizar√° um pouco de tempo.  Usando o <code>vim</code> arquivos s√£o editados usando o scp com um √∫nico comando.  Este m√©todo simplesmente cria o arquivo localmente em <code>/tmp</code> e o copia novamente assim que o salvamos do <code>vim</code> . <br><br><pre> <code class="bash hljs">localhost:~$ vim scp://user@remoteserver//etc/hosts</code> </pre> <br>  Nota: o formato √© um pouco diferente do <code>scp</code> normal.  Ap√≥s o host, temos double <code>//</code> .  Este √© um link para o caminho absoluto.  Uma barra significa o caminho relativo √† pasta pessoal dos <code>users</code> . <br><br><pre> <code class="bash hljs">**warning** (netrw) cannot determine method (format: protocol://[user@]hostname[:port]/[path])</code> </pre> <br>  Se voc√™ vir esse erro, verifique duas vezes o formato do comando.  Isso geralmente significa um erro de sintaxe. <br><br><a name="16"></a><h3>  16. Montando o SSH remoto como uma pasta local com o SSHFS </h3><br>  Usando o <code>sshfs</code> , o cliente do sistema de arquivos <code>ssh</code> , podemos conectar o diret√≥rio local a um local remoto com todas as intera√ß√µes de arquivos em uma sess√£o <code>ssh</code> criptografada. <br><br><pre> <code class="bash hljs">localhost:~$ apt install sshfs</code> </pre> <br>  Instalamos o pacote <code>sshfs</code> no Ubuntu e Debian e montamos o local remoto em nosso sistema. <br><br><pre> <code class="bash hljs">localhost:~$ sshfs user@remoteserver:/media/data ~/data/</code> </pre> <br><a name="17"></a><h3>  17. Multiplexa√ß√£o SSH com ControlPath </h3><br>  Por padr√£o, se voc√™ possui uma conex√£o existente com o servidor remoto usando <code>ssh</code> segunda conex√£o usando <code>ssh</code> ou <code>scp</code> estabelece uma nova sess√£o com autentica√ß√£o adicional.  A op√ß√£o <code>ControlPath</code> permite usar uma sess√£o existente para todas as conex√µes subseq√ºentes.  Isso acelerar√° significativamente o processo: o efeito √© percept√≠vel at√© na rede local e, mais ainda, quando conectado a recursos remotos. <br><br><pre> <code class="bash hljs">Host remoteserver HostName remoteserver.example.org ControlMaster auto ControlPath ~/.ssh/control/%r@%h:%p ControlPersist 10m</code> </pre> <br>  O ControlPath diz ao soquete para verificar novas conex√µes para uma sess√£o <code>ssh</code> ativa.  A √∫ltima op√ß√£o significa que, mesmo ap√≥s sair do console, a sess√£o existente permanecer√° aberta por 10 minutos; portanto, durante esse per√≠odo, voc√™ poder√° reconectar-se ao soquete existente.  Veja a ajuda do <code>ssh_config man</code> para mais informa√ß√µes. <br><br><a name="18"></a><h3>  18. Streaming de v√≠deo sobre SSH usando VLC e SFTP </h3><br>  Mesmo usu√°rios antigos de <code>ssh</code> e <code>vlc</code> (Video Lan Client) nem sempre conhecem essa op√ß√£o conveniente quando voc√™ realmente precisa assistir a v√≠deos na rede.  Nas configura√ß√µes <b>Arquivo |</b>  <b>O programa Open Network Stream</b> <code>vlc</code> pode inserir o local como <code>sftp://</code> .  Se uma senha for necess√°ria, um prompt ser√° exibido. <br><br><pre> <code class="bash hljs">sftp://remoteserver//media/uploads/myvideo.mkv</code> </pre> <br><a name="19"></a><h3>  19. Autentica√ß√£o de dois fatores </h3><br>  A mesma autentica√ß√£o de dois fatores que sua conta banc√°ria ou conta do Google se aplica ao servi√ßo SSH. <br><br>  Obviamente, o <code>ssh</code> inicialmente possui uma fun√ß√£o de autentica√ß√£o de dois fatores, o que significa a senha e a chave SSH.  A vantagem de um token de hardware ou aplicativo do Google Authenticator √© que ele geralmente √© um dispositivo f√≠sico diferente. <br><br>  Consulte o nosso guia de 8 minutos sobre o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">uso do Google Authenticator e SSH</a> . <br><br><a name="20"></a><h3>  20. Host pulando com ssh e -J </h3><br>  Se, devido √† segmenta√ß√£o da rede, voc√™ precisar atravessar v√°rios hosts ssh para alcan√ßar a rede de destino final, o atalho -J economizar√° tempo. <br><br><pre> <code class="bash hljs">localhost:~$ ssh -J host1,host2,host3 user@host4.internal</code> </pre> <br>  O principal a entender aqui √© que isso n√£o √© an√°logo ao <code>ssh host1</code> , ent√£o <code>user@host1:~$ ssh host2</code> , etc. O par√¢metro -J usa astuciosamente o encaminhamento para que o host local estabele√ßa uma sess√£o com o pr√≥ximo host da cadeia.  Assim, no exemplo acima, nosso host local se autentica no host4.  Ou seja, nossas chaves do host local s√£o usadas e a sess√£o do host local ao host4 √© totalmente criptografada. <br><br>  Para fazer isso, especifique a op√ß√£o de configura√ß√£o <b>proxyJump</b> em <b>ssh_config</b> .  Se voc√™ precisar passar por v√°rios hosts regularmente, a automa√ß√£o atrav√©s da configura√ß√£o economizar√° muito tempo. <br><br><a name="21"></a><h3>  21. Bloqueando tentativas de for√ßa bruta SSH usando iptables </h3><br>  Qualquer pessoa que executou o servi√ßo SSH e examinou os logs sabe do n√∫mero de tentativas de for√ßa bruta que ocorrem a cada hora todos os dias.  Uma maneira r√°pida de reduzir o ru√≠do nos logs √© migrar o SSH para uma porta n√£o padr√£o.  Fa√ßa altera√ß√µes no arquivo <code>sshd_config</code> usando o par√¢metro de configura√ß√£o da <b>porta ##</b> . <br><br>  Usando o <code>iptables</code> , voc√™ tamb√©m pode bloquear facilmente as tentativas de conex√£o com uma porta ap√≥s atingir um determinado limite.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma maneira f√°cil de fazer isso √© usar o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSSEC</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pois ele n√£o apenas bloqueia o SSH, mas executa v√°rias outras medidas de detec√ß√£o de intrus√£o (HIDS) baseadas em host.</font></font><br><br><a name="22"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 22. SSH Escape para alterar o encaminhamento de porta </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E nosso √∫ltimo exemplo </font></font><code>ssh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√© para alterar o encaminhamento de porta em tempo real em uma sess√£o existente </font></font><code>ssh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Imagine esse cen√°rio. </font><font style="vertical-align: inherit;">Voc√™ est√° profundamente online; </font><font style="vertical-align: inherit;">voc√™ pode ter pulado mais de meia d√∫zia de hosts e precisa de uma porta local na esta√ß√£o de trabalho que seja redirecionada para o Microsoft SMB do antigo sistema Windows 2003 (algu√©m se lembra do ms08-67?). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ao clicar </font></font><code>enter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, tente digitar no console </font></font><code>~C</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Esta √© uma sequ√™ncia de controle em uma sess√£o que permite fazer altera√ß√µes em uma conex√£o existente.</font></font><br><br><pre> <code class="bash hljs">localhost:~$ ~C ssh&gt; -h Commands: -L[bind_address:]port:host:hostport Request <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> forward -R[bind_address:]port:host:hostport Request remote forward -D[bind_address:]port Request dynamic forward -KL[bind_address:]port Cancel <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> forward -KR[bind_address:]port Cancel remote forward -KD[bind_address:]port Cancel dynamic forward ssh&gt; -L 1445:remote-win2k3:445 Forwarding port.</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqui voc√™ pode ver que redirecionamos nossa porta local 1445 para o host do Windows 2003 que encontramos na rede interna. </font><font style="vertical-align: inherit;">Agora basta execut√°- </font></font><code>msfconsole</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lo e voc√™ pode seguir em frente (supondo que planeja usar este host).</font></font><br><br><h1>  Conclus√£o </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esses exemplos, dicas e comandos </font></font><code>ssh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devem fornecer um ponto de partida; </font><font style="vertical-align: inherit;">Mais informa√ß√µes sobre cada um dos comandos e recursos dispon√≠veis nas p√°ginas de ajuda ( </font></font><code>man ssh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>man ssh_config</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>man sshd_config</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sempre fui fascinado pela capacidade de acessar sistemas e executar comandos em qualquer lugar do mundo. </font><font style="vertical-align: inherit;">O desenvolvimento de suas habilidades no trabalho com ferramentas como </font></font><code>ssh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">voc√™ se tornar√° mais eficaz em qualquer jogo que voc√™ jogar.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt435546/">https://habr.com/ru/post/pt435546/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt435536/index.html">Rob√¥s human√≥ides: benef√≠cios e problemas de mecanismos antropom√≥rficos</a></li>
<li><a href="../pt435538/index.html">Em 2018, mais energia "verde" foi recebida na Alemanha do que eletricidade proveniente da combust√£o de carv√£o</a></li>
<li><a href="../pt435540/index.html">Novas palavras-chave em Java</a></li>
<li><a href="../pt435542/index.html">Desenvolvimento de jogos e defesa de um diploma ou "Como matei dois coelhos com uma panqueca de uma cajadada s√≥"</a></li>
<li><a href="../pt435544/index.html">Funcion√°rio da Innopolis University recebeu uma bolsa do Facebook</a></li>
<li><a href="../pt435548/index.html">Hacking de servi√ßos p√∫blicos - poss√≠vel, se realmente necess√°rio</a></li>
<li><a href="../pt435550/index.html">GitLab 11.6 lan√ßado com recursos sem servidor e clusters Kubernetes para grupos</a></li>
<li><a href="../pt435552/index.html">Substitui√ß√£o de importa√ß√£o - epit√°fio da digitaliza√ß√£o</a></li>
<li><a href="../pt435556/index.html">Mudando para o data center: como foi</a></li>
<li><a href="../pt435558/index.html">Testando o PostgreSQL com HugePages no Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>