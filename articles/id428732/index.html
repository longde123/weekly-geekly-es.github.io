<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèæ‚Äçü§ù‚Äçüë®üèΩ üëäüèΩ üîç Cara membuat ekstensi di PHP7 lebih sulit daripada "halo, dunia", dan tidak menjadi mata merah. Bagian 2 üóíÔ∏è ‚Ü™Ô∏è üêí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ringkasan bagian pertama 
 Pada bagian pertama, saya membuat ekstensi kosong, membuatnya bekerja dengan benar di IDE Clion, menulis fungsi analog, my_...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cara membuat ekstensi di PHP7 lebih sulit daripada "halo, dunia", dan tidak menjadi mata merah. Bagian 2</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/428732/"><h2>  Ringkasan bagian pertama </h2><br>  Pada bagian <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pertama,</a> saya membuat ekstensi kosong, membuatnya bekerja dengan benar di IDE Clion, menulis fungsi analog, my_array_fill (), dan memeriksa kinerjanya di php. <br><br><h2>  Apa sekarang? </h2><br>  Sekarang saya akan memasukkan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">kode</a> libtrie library ke ekstensi kita. <br><br>  Saya akan berbicara sedikit tentang bagaimana Anda dapat membuat ekstensi php5 lama berfungsi di php7. <br>  Selanjutnya saya akan membuat beberapa fungsi dasar dari perpustakaan ini di php dan memeriksa apa yang terjadi. <br><a name="habracut"></a><br><h2>  Ayo pergi </h2><br><h3>  Dapatkan kode libtrie di ekstensi kami </h3><br>  Saya pergi ke direktori ekstensi <br><br><pre><code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/Documents/libtrie/</code> </pre> <br>  Mengkloning repositori libtrie <br><br><pre> <code class="hljs php">git <span class="hljs-keyword"><span class="hljs-keyword">clone</span></span> https:<span class="hljs-comment"><span class="hljs-comment">//github.com/legale/libtrie</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/xg/qz/pu/xgqzpu-aaergrdemyad5c7srze0.png"><br><br>  Saya membuka file dengan kode ekstensi <code>php_libtrie.c</code> dan file dengan kode perpustakaan <code>libtrie/src/libtrie.c</code> . <br><br><img src="https://habrastorage.org/webt/mb/xm/-n/mbxm-ni0ebfdytmh4nocds6ilfk.png"><br><br>  Saya akan menggunakan yang terakhir untuk memeriksa nama dan sintaks fungsi. <br><br>  Fungsi-fungsi yang dibuat dalam php yang akan saya gunakan sama dengan di perpustakaan itu sendiri. <br>  Pertama-tama, Anda perlu memasukkan file header perpustakaan dalam kode ekstensi kami. <br>  Kami menulis di php_libtrie.c: <br><br><pre> <code class="hljs cpp"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"libtrie/src/libtrie.h"</span></span></span></span></code> </pre> <br><h4>  Fungsi Yatrie_new </h4><br>  Saya membuat fungsi pertama yang akan membuat pohon awalan.  Di perpustakaan itu disebut <br><br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-function">trie_s *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">yatrie_new</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> max_nodes, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> max_refs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> max_deallocated_size)</span></span></span><span class="hljs-function"> </span></span>{...}</code> </pre><br>  Seperti yang dapat Anda lihat dari kode, fungsi mengambil 3 argumen numerik pada input dan mengembalikan pointer ke struktur <code>trie_s</code> .  Sederhananya, mengembalikan tautan ke pohon awalan yang dibuat. <br><br>  Untuk menarik pohon awalan kami ke dalam PHP, PHP memiliki tipe data sumber daya khusus.  Ketika suatu fungsi dieksekusi dalam PHP <br><br><pre> <code class="php hljs">fopen(<span class="hljs-string"><span class="hljs-string">"filename.ext"</span></span>);</code> </pre><br>  Berbicara dalam bahasa C, program meminta sistem operasi untuk membuka file yang ditentukan, membuat pointer ke file ini, yang dalam bentuk sumber daya dan kembali ke luar ke PHP. <br><br>  Kami akan melakukan hal yang sama dengan pohon kami. <br><br>  Mari kita membuat fungsi di php_libtrie.c: <br><br><div class="spoiler">  <b class="spoiler_title">Kode fungsi</b> <div class="spoiler_text"><pre> <code class="hljs ruby">PHP_FUNCTION (yatrie_new) { <span class="hljs-regexp"><span class="hljs-regexp">/*     */</span></span> trie_s *trie; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     zend_long max_nodes; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> -      zend_long max_refs; <span class="hljs-regexp"><span class="hljs-regexp">/*  -   . *        . -  +25%     . * ,    OpenCorpora ~3.    5.   5.  */</span></span> zend_long max_deallocated_size; <span class="hljs-regexp"><span class="hljs-regexp">/*        *    .    96    , 1  ,  95. *              95,  , *  .         94. */</span></span> /<span class="hljs-regexp"><span class="hljs-regexp">/   PHP if (zend_parse_parameters(ZEND_NUM_ARGS(), "lll", &amp;max_nodes, &amp;max_refs, &amp;max_deallocated_size) == FAILURE) { RETURN_FALSE; } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/             trie = yatrie_new((uint32_t)max_nodes, (uint32_t)max_refs, (uint32_t)max_deallocated_size); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   -   if (!trie) { RETURN_NULL(); } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  2  /</span></span>*  zend_register_resource()     Zend, *        le_libtrie,   ZVAL_RES() *     zval return_value *<span class="hljs-regexp"><span class="hljs-regexp">/ ZVAL_RES(return_value, zend_register_resource(trie, le_libtrie)); }</span></span></code> </pre><br></div></div><br>  Sekarang Anda perlu menambahkan fungsi yang dibuat ke array fungsi ekstensi, jika tidak fungsi tersebut tidak akan terlihat dari PHP. <br><br><pre> <code class="hljs lisp">PHP_FE(<span class="hljs-name"><span class="hljs-name">yatrie_new</span></span>, NULL)</code> </pre><br><img src="https://habrastorage.org/webt/2a/vu/qg/2avuqgxgwedjw0jjxrj2r1neaf0.png"><br><br>  Agar terlihat indah, saya akan menambahkan deklarasi fungsi ke file header.  Ini tidak perlu, karena fungsi PHP kami tidak berinteraksi satu sama lain, tetapi saya masih lebih suka untuk mendeklarasikan semua fungsi dalam file header. <br><br>  Cukup tambahkan baris: <br><br><pre> <code class="hljs lisp">PHP_FUNCTION(<span class="hljs-name"><span class="hljs-name">confirm_libtrie_compiled</span></span>)<span class="hljs-comment"><span class="hljs-comment">; PHP_FUNCTION(my_array_fill); PHP_FUNCTION(yatrie_new);</span></span></code> </pre>  ke file php_libtrie.h.  Di mana saja di antara: <br><pre> <code class="hljs cpp"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> PHP_LIBTRIE_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PHP_LIBTRIE_H</span></span></code> </pre>  dan <br><pre> <code class="hljs cpp"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* PHP_LIBTRIE_H */</span></span></span></span></code> </pre> <br><img src="https://habrastorage.org/webt/uk/jc/sc/ukjcscch9ozcfpoux0ewnn9byp0.png"><br><br><h4>  PHP menciptakan destruktor sumber daya </h4><br>  Fungsi yatrie_new () yang dibuat membuat pohon dan juga mendaftarkan sumber daya PHP.  Sekarang kita membutuhkan fungsi yang akan menutup sumber daya yang dibuat dan membebaskan memori yang ditempati oleh pohon awalan. <br><br><pre> <code class="hljs java"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@brief</span></span></span><span class="hljs-comment">  ,           * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> rsrc : zend_resource *  * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> void */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">php_libtrie_dtor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(zend_resource *rsrc TSRMLS_DC)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     trie   trie_s *trie = (trie_s *) rsrc-&gt;ptr; //   ,   , //   trie yatrie_free(trie); }</span></span></code> </pre><br>  Karena fungsi internal untuk berbagai fungsi ekstensi, itu tidak termasuk.  Tambahkan deklarasi ke php_libtrie.h: <br><br><img src="https://habrastorage.org/webt/z3/nb/nh/z3nbnhwgsndugygpalj3ua-fhoy.png"><br><br>  Sekarang Anda perlu mendaftarkan fungsi destruktor yang dibuat di PHP.  Ini dilakukan melalui fungsi inisialisasi ekstensi khusus.  Sebelum ini, fungsi ini langsung mengembalikan SUKSES.  Perlu menambahkan pendaftaran destruktor di sana. <br><br><pre> <code class="hljs powershell">//  PHP     trie PHP_MINIT_<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">FUNCTION</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(libtrie)</span></span></span></span> { le_libtrie = zend_register_list_destructors_ex( php_libtrie_dtor, NULL, PHP_LIBTRIE_RES_NAME, module_number); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SUCCESS; }</code> </pre><br><img src="https://habrastorage.org/webt/fr/xk/fq/frxkfq1wti5opa7tvq9ed0htgiy.png"><br><br><h4>  Hapus fungsi pohon yang dibuat </h4><br>  Sama seperti fungsi <code>fopen()</code> memiliki beberapa <code>fclose()</code> , jadi fungsi pembuatan pohon saya harus memiliki pacar yang akan menyeimbangkannya. <br><br><div class="spoiler">  <b class="spoiler_title">Kode</b> <div class="spoiler_text"><pre> <code class="hljs julia">/** * <span class="hljs-meta"><span class="hljs-meta">@brief</span></span>     * <span class="hljs-meta"><span class="hljs-meta">@param</span></span> trie : resource * <span class="hljs-meta"><span class="hljs-meta">@return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>/<span class="hljs-literal"><span class="hljs-literal">false</span></span> : bool */ PHP_FUNCTION (yatrie_free) { zval *resource; //  zval    //    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, <span class="hljs-string"><span class="hljs-string">"r"</span></span>, &amp;resource) == FAILURE) { RETURN_FALSE; } /*    ,    zend_resource, *      zval.     Z_RES_P() */ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (zend_list_close(Z_RES_P(resource)) == SUCCESS) { //  <span class="hljs-literal"><span class="hljs-literal">true</span></span>  return_vale   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RETURN_TRUE; } //  <span class="hljs-literal"><span class="hljs-literal">false</span></span>  return_vale   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RETURN_FALSE; }</code> </pre><br></div></div><br>  Tambahkan fungsi ke array fungsi ekstensi: <br><br><pre> <code class="hljs lisp">PHP_FE(<span class="hljs-name"><span class="hljs-name">yatrie_free</span></span>, NULL)</code> </pre><br>  Tambahkan deklarasi fungsi ke file header: <br><br><pre> <code class="hljs lisp">PHP_FUNCTION(<span class="hljs-name"><span class="hljs-name">yatrie_free</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre><br><img src="https://habrastorage.org/webt/vr/hh/2j/vrhh2jigm3obaa9cetb8lsx6bqe.png"><br><br>  Seperti yang dapat Anda lihat di tangkapan layar, saya menambahkan nama internal sumber daya dalam PHP ke file header, serta makro PHP5, yang karena alasan tertentu dihapus dari PHP7.  Saya tidak menggunakannya, tetapi jika seseorang ingin menggunakannya, Anda dapat dengan mudah membangun ekstensi PHP5 ke PHP7. <br><br><pre> <code class="hljs cpp"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PHP_LIBTRIE_VERSION </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"0.1.0"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Replace with version number for your extension */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PHP_LIBTRIE_RES_NAME </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"libtrie data structure"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* PHP resource name */</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//previously (php5) used MACROS #define ZEND_FETCH_RESOURCE(rsrc, rsrc_type, passed_id, default_id, resource_type_name, resource_type) \ (rsrc = (rsrc_type) zend_fetch_resource(Z_RES_P(*passed_id), resource_type_name, resource_type)) #define ZEND_REGISTER_RESOURCE(return_value, result, le_result) ZVAL_RES(return_value,zend_register_resource(result, le_result))</span></span></span></span></code> </pre><br><h4>  Fungsi menambahkan kata dalam trie </h4><br>  Sekarang mari kita membuat fungsi menambahkan kata ke pohon awalan. <br><br><ol><li><br><div class="spoiler">  <b class="spoiler_title">Kode</b> <div class="spoiler_text"><pre> <code class="hljs ruby">/** * @brief   trie    node_id     * @param trie : resource * @param word : string * @return node_id : int *<span class="hljs-regexp"><span class="hljs-regexp">/ PHP_FUNCTION (yatrie_add) { trie_s *trie; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   zval *resource; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  zval    unsigned char *word = NULL; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     size_t word_len; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  word uint32_t node_id; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/id  ,   /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, "rs", &amp;resource, &amp;word, &amp;word_len) == FAILURE) { RETURN_FALSE } /</span></span>*    PHP,  : * <span class="hljs-number"><span class="hljs-number">1</span></span>    PHP ( zval,   ), * <span class="hljs-number"><span class="hljs-number">2</span></span>    *         * <span class="hljs-number"><span class="hljs-number">3</span></span>   id ,       *     void *,        trie_s * *  PHP5      ZEND_FETCH_RESOURCE(),  -    PHP7. *<span class="hljs-regexp"><span class="hljs-regexp">/ trie = (trie_s *) zend_fetch_resource(Z_RES_P(resource), PHP_LIBTRIE_RES_NAME, le_libtrie); /</span></span>*    trie *   -      *   - id     ,      *   -    . *<span class="hljs-regexp"><span class="hljs-regexp">/ node_id = yatrie_add(word, 0, trie); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   RETURN_LONG(node_id); }</span></span></code> </pre><br></div></div><br></li><li>  Tambahkan entri ke berbagai fungsi: <br><br><pre> <code class="hljs lisp">PHP_FE(<span class="hljs-name"><span class="hljs-name">yatrie_add</span></span>, NULL)</code> </pre></li><li>  Tambahkan deklarasi ke file header: <br><br><pre> <code class="hljs lisp">PHP_FUNCTION(<span class="hljs-name"><span class="hljs-name">yatrie_add</span></span>)</code> </pre></li></ol><br><h4>  Fungsi untuk mengeluarkan semua kata dari kamus </h4><br>  Sekarang mari kita membuat fungsi yang akan memilih semua kata dari pohon awalan dan mengeluarkannya dalam PHP sebagai array. <br><br><ol><li><br><div class="spoiler">  <b class="spoiler_title">Kode</b> <div class="spoiler_text"><pre> <code class="hljs ruby">/** * @brief    ,    ,      * ,     * @param trie : resource * @param node_id : int * @param head () : string ,   *       * @return array *<span class="hljs-regexp"><span class="hljs-regexp">/ PHP_FUNCTION (node_traverse) { trie_s *trie; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  trie words_s *words; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     trie zval * resource; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  zval  zend_long node_id; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  unsigned char *head = NULL; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    size_t head_len; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   PHP if (zend_parse_parameters(ZEND_NUM_ARGS(), "rl|s", &amp;resource, &amp;node_id, &amp;head, &amp;head_len) == FAILURE) { RETURN_NULL(); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ null    } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     trie = (trie_s *) zend_fetch_resource(Z_RES_P(resource), PHP_LIBTRIE_RES_NAME, le_libtrie); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    trie  node_traverse()    words_s /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    words = (words_s *) calloc(1, sizeof(words_s)); words-&gt;counter = 0; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    0 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  1     string_s *head_libtrie = calloc(1, sizeof(string_s)); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ head  if(head != NULL) { head_libtrie-&gt;length = (uint32_t)head_len; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  memcpy(&amp;head_libtrie-&gt;letters, head, head_len); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   head_libtrie } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    trie node_traverse(words, (uint32_t) node_id, head_libtrie, trie); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  PHP ,       words array_init_size(return_value, words-&gt;counter); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    php while (words-&gt;counter--) { /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  trie     ,    /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     uint8_t dst[256]; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   libtrie decode_string(dst, words-&gt;words[words-&gt;counter]); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  Zend API,        php string    char * add_next_index_string(return_value, (const char *) dst); } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      words  head_libtrie free(words); free(head_libtrie); }</span></span></code> </pre><br></div></div></li><li>  Tambahkan entri ke berbagai fungsi: <br><br><pre> <code class="hljs lisp">PHP_FE(<span class="hljs-name"><span class="hljs-name">node_traverse</span></span>, NULL)</code> </pre><br></li><li>  Tambahkan deklarasi ke file header: <br><br><pre> <code class="hljs lisp">PHP_FUNCTION(<span class="hljs-name"><span class="hljs-name">node_traverse</span></span>)</code> </pre><br></li></ol><br><h3>  Perakitan ekstensi </h3><br>  Karena ekstensi sekarang menggunakan file perpustakaan pihak ketiga, file-file ini juga harus dikompilasi.  Saya membuka file config.m4 dan menambahkan file sumber 2 libtrie di sana: <br><br> <code>libtrie/src/libtrie.c <br> libtrie/src/single_list.c <br></code> <br><br>  Berikut adalah isi lengkap file setelah perubahan. <br><br><div class="spoiler">  <b class="spoiler_title">config.m4</b> <div class="spoiler_text"><pre> <code class="bash hljs">PHP_ARG_ENABLE(libtrie, whether to <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> libtrie support, [ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libtrie Enable libtrie support]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$PHP_LIBTRIE</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">"no"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-comment"><span class="hljs-comment">#    -    # PHP_ADD_INCLUDE(libtrie/src/) #   PHP_NEW_EXTENSION(libtrie, \ libtrie/src/libtrie.c \ libtrie/src/single_list.c \ php_libtrie.c \ , $ext_shared) # PHP_NEW_EXTENSION(libtrie, php_libtrie.c libtrie/src/libtrie.c libtrie/src/single_list.c, $ext_shared,, -DZEND_ENABLE_STATIC_TSRMLS_CACHE=1) fi</span></span></code> </pre><br></div></div><br><img src="https://habrastorage.org/webt/kc/ti/z5/kctiz5lsns7ey_f37b_qhqn1wp8.png"><br><br>  Sekarang Anda perlu melakukan kembali skrip ./configure.  Saya menjalankan dari direktori root ekstensi: <br><br><pre> <code class="bash hljs">phpize &amp;&amp; ./configure</code> </pre><br>  Sekarang saya sedang membangun ekstensi: <br><br><pre> <code class="bash hljs">make</code> </pre><br><h3>  Pengujian </h3><br>  Untuk pengujian, yang terbaik adalah membuat skrip php agar tidak banyak menulis di konsol.  Saya akan melakukan ini: <br><br><pre> <code class="bash hljs">nano yatrie_test.php</code> </pre><br>  Dan ini adalah isi file: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"C   500   500 \n\n"</span></span>; $trie = yatrie_new(<span class="hljs-number"><span class="hljs-number">500</span></span>, <span class="hljs-number"><span class="hljs-number">500</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"!\n  ,  id    \$nodes\n"</span></span>; $nodes[] = yatrie_add($trie, <span class="hljs-string"><span class="hljs-string">""</span></span>); $nodes[] = yatrie_add($trie, <span class="hljs-string"><span class="hljs-string">""</span></span>); $nodes[] = yatrie_add($trie, <span class="hljs-string"><span class="hljs-string">""</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"     .\n    2 ,    2.\n    3 ,  2     ,\n   1  \n"</span></span>; print_r($nodes); print_r(node_traverse($trie, <span class="hljs-number"><span class="hljs-number">0</span></span>)); yatrie_free($trie);</code> </pre><br>  Kami mengeksekusi di konsol: <br><br><pre> <code class="bash hljs">php -d extension=modules/libtrie.so yatrie_test.php</code> </pre><br>  Inilah yang harus Anda dapatkan: <br><br><img src="https://habrastorage.org/webt/ef/io/qf/efioqf0hubn_dhbykzbvcxah12k.png"><br><br>  Kami mengambil kode sumber ekstensi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dari sini</a> .  Jangan malu dan letakkan tanda bintang :-) </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id428732/">https://habr.com/ru/post/id428732/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id428722/index.html">20th Century Fox dan Google telah mengembangkan teknologi yang memprediksi apakah mereka yang menonton trailer akan pergi ke bioskop</a></li>
<li><a href="../id428724/index.html">Sekarang layanan streaming di AS akan membayar musisi lebih banyak - kami sedang membahas undang-undang baru</a></li>
<li><a href="../id428726/index.html">Perekrutan staf. Bagaimana tidak menginjak menyapu yang sama</a></li>
<li><a href="../id428728/index.html">Ulasan App Store: 15 Upaya untuk Rilis Pertama, atau "You Won't Pass!"</a></li>
<li><a href="../id428730/index.html">Panel surya terapung - simbol besar untuk pembangkit listrik tenaga air</a></li>
<li><a href="../id428734/index.html">Kesalahan yang telah terjadi di Windows sejak 1974</a></li>
<li><a href="../id428736/index.html">Menggunakan Retrofit 2.x sebagai REST Client - Tutorial</a></li>
<li><a href="../id428738/index.html">Ilmu Data dalam Visual Studio Code menggunakan Neuron</a></li>
<li><a href="../id428740/index.html">Jaringan kuantum: prospek dan kesulitan implementasi</a></li>
<li><a href="../id428744/index.html">emulator ritme studio jDrum</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>