<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèáüèº üëèüèª üë∏üèª Interoperabilidade segura em sistemas distribu√≠dos üêÖ ‚ú°Ô∏è üë©üèª‚Äçüéì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Oi Habr! 

 Meu nome √© Alexey Solodky, sou desenvolvedor de PHP no Badoo. E hoje vou compartilhar uma vers√£o em texto da minha palestra para o primeir...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Interoperabilidade segura em sistemas distribu√≠dos</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/413555/"><img src="https://habrastorage.org/webt/ag/m-/8r/agm-8r1daffwnqqhzqagmayd4uc.png" width="800"><br><br>  Oi Habr! <br><br>  Meu nome √© Alexey Solodky, sou desenvolvedor de PHP no Badoo.  E hoje vou compartilhar uma vers√£o em texto da minha palestra para o primeiro Meetup do Badoo PHP.  Um v√≠deo deste e de outros relat√≥rios da mitap pode ser encontrado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br>  Qualquer sistema que consiste em pelo menos dois componentes (e se voc√™ possui PHP e um banco de dados, esses s√£o dois componentes), enfrenta classes inteiras de riscos na intera√ß√£o entre esses componentes. <br><br>  O departamento de plataforma em que trabalho integra novos servi√ßos internos ao nosso aplicativo.  E resolvendo esses problemas, acumulamos experi√™ncia, que eu quero compartilhar. <br><br>  Nosso back-end √© um mon√≥lito PHP interagindo com muitos servi√ßos (atualmente existem cerca de 50 deles).  Os servi√ßos raramente interagem entre si.  Mas os problemas que falo no artigo tamb√©m s√£o relevantes para a arquitetura de microsservi√ßos.  De fato, nesse caso, os servi√ßos interagem muito ativamente entre si e, quanto mais intera√ß√£o voc√™ tiver, mais problemas ter√°. <br><br>  Considere o que fazer quando o servi√ßo falhar ou diminuir, como organizar a cole√ß√£o de m√©tricas e o que fazer quando todas as op√ß√µes acima n√£o salvarem voc√™. <br><a name="habracut"></a><br><h2>  Falha no servi√ßo </h2><br>  Mais cedo ou mais tarde, o servidor no qual seu servi√ßo est√° instalado cair√°.  Isso acontecer√° com certeza e voc√™ n√£o poder√° se defender - apenas reduza a probabilidade.  Voc√™ pode se decepcionar com hardware, rede, c√≥digo, implanta√ß√£o malsucedida - qualquer coisa.  E quanto mais servidores voc√™ tiver, mais frequentemente isso acontecer√°. <br><br>  Como fazer seus servi√ßos sobreviverem em um mundo em que os servidores travam constantemente?  Uma abordagem geral para resolver essa classe de problemas √© a redund√¢ncia. <br><br>  A redund√¢ncia √© usada em todos os lugares, em diferentes n√≠veis: do ferro aos data centers inteiros.  Por exemplo, RAID1 para proteger contra falhas no disco r√≠gido ou uma fonte de alimenta√ß√£o de backup para o servidor em caso de falha do primeiro.  Al√©m disso, esse esquema √© amplamente aplicado aos bancos de dados.  Por exemplo, voc√™ pode usar master-slave para isso. <br><br>  Vamos considerar problemas t√≠picos de redund√¢ncia usando o esquema mais simples como exemplo: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/lo/9b/rb/lo9brbsy29ca8b0i-1ygtyckncq.png" width="300"></div><br>  O aplicativo se comunica exclusivamente com o mestre, enquanto em segundo plano, de forma ass√≠ncrona, os dados s√£o transferidos para o escravo.  Quando o mestre travar, mudaremos para o escravo e continuaremos trabalhando. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ga/lt/o5/galto5cgws3ed44dfwhnqq9zvd4.png" width="300"></div><br><br>  Depois de restaurar o mestre, apenas criamos um novo escravo, e o antigo se transforma em um mestre. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/6h/c8/gc/6hc8gc6qzhzso3xscnjblfn1frm.png" width="300"></div><br>  O esquema √© simples, mas mesmo com muitas nuances caracter√≠sticas de qualquer esquema redundante. <br><br><h3>  Carregar </h3><br>  Digamos que um servidor do exemplo acima possa suportar cerca de 100k RPS.  Agora, a carga √© de 60k RPS e tudo funciona como um rel√≥gio. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/99/gw/j1/99gwj19rezs-ywa-hdopmqcudk8.png" width="300"></div><br>  Por√©m, com o tempo, a carga no aplicativo e, portanto, a carga no mestre aumentam.  Voc√™ pode equilibrar movendo parte da leitura para um escravo. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sv/r4/si/svr4sicizgym8gqndznsygpi0-o.png" width="300"></div><br>  Parece muito bom.  Mant√©m a carga, o servidor n√£o est√° mais ocioso.  Mas isso √© uma p√©ssima ideia.  √â importante lembrar por que voc√™ criou o escravo inicialmente - para mudar para ele em caso de problemas com o principal.  Se voc√™ come√ßou a carregar os dois servidores, quando o seu mestre travar - e mais cedo ou mais tarde ele travar√° - voc√™ ter√° que alternar o tr√°fego principal do mestre para o servidor de backup, e ele j√° estar√° carregado.  Essa sobrecarga tornar√° seu sistema terrivelmente lento ou o desativar√° completamente. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9t/py/la/9tpylanqp3whk7tcr4csdln6yo0.png" width="300"></div><br><h3>  Dados </h3><br>  O principal problema ao adicionar toler√¢ncia a falhas em um servi√ßo √© o estado local.  Se o seu servi√ßo for sem estado, ou seja, n√£o armazena dados mut√°veis, a sua escala n√£o apresenta um problema.  N√≥s apenas levantamos quantas inst√¢ncias precisamos e equilibramos as solicita√ß√µes entre elas. <br><br>  No caso em que o servi√ßo √© est√°vel, n√£o podemos mais fazer isso.  Voc√™ precisa pensar em como armazenar os mesmos dados em todas as inst√¢ncias do nosso servi√ßo para que eles permane√ßam consistentes. <br><br>  Para resolver esse problema, uma das duas abordagens √© usada: replica√ß√£o s√≠ncrona ou ass√≠ncrona.  No caso geral, recomendo que voc√™ use a op√ß√£o ass√≠ncrona, pois geralmente √© mais simples e r√°pido escrever e, de acordo com as circunst√¢ncias, verifique se voc√™ precisa mudar para s√≠ncrono. <br><br>  Uma nuance importante a considerar ao trabalhar com replica√ß√£o ass√≠ncrona √© a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">consist√™ncia eventual</a> .  Isso significa que, em um determinado momento no tempo em diferentes escravos, os dados podem ficar para tr√°s do mestre em intervalos de tempo imprevis√≠veis e diferentes. <br>  Assim, voc√™ n√£o pode ler dados todas as vezes em um servidor aleat√≥rio, porque respostas diferentes podem chegar √†s mesmas solicita√ß√µes do usu√°rio.  Para contornar esse problema, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">√© usado</a> o mecanismo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sess√µes fixas</a> , o que garante que todas as solicita√ß√µes de um usu√°rio v√£o para uma inst√¢ncia. <br><br>  As vantagens de uma abordagem s√≠ncrona s√£o que os dados est√£o sempre em um estado consistente e o risco de perda de dados √© menor (porque √© considerado gravado somente depois de todos os servidores).  No entanto, voc√™ deve pagar por isso com a velocidade de grava√ß√£o e a complexidade do pr√≥prio sistema (por exemplo, v√°rios algoritmos de quorum para prote√ß√£o contra o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">c√©rebro dividido</a> ). <br><br><h3>  Conclus√µes </h3><br><ul><li>  <b>Reserve.</b>  Se os dados em si e a disponibilidade de um servi√ßo espec√≠fico forem importantes, verifique se o servi√ßo sobreviver√° √† queda de uma m√°quina espec√≠fica. <br></li><li>  <b>Ao calcular a carga, considere a queda de alguns servidores.</b>  Se o cluster tiver quatro servidores, verifique se, quando um cai, os tr√™s restantes puxam a carga. <br></li><li>  <b>Escolha o tipo de replica√ß√£o, dependendo das tarefas.</b> <br></li><li>  <b>N√£o coloque todos os seus ovos em uma cesta.</b>  Verifique se voc√™ est√° distante o suficiente dos servidores.  Dependendo da criticidade da disponibilidade do servi√ßo, seus servidores podem estar em diferentes racks em um data center ou em diferentes data centers em diferentes pa√≠ses.  Tudo depende de quanto desastre global voc√™ deseja e est√° pronto para sobreviver. <br></li></ul><br><h2>  Servi√ßo de sil√™ncio </h2><br>  Em algum momento, seu servi√ßo pode come√ßar a funcionar muito lentamente.  Esse problema pode ocorrer por v√°rios motivos: carga excessiva, atrasos na rede, problemas de hardware ou erros de c√≥digo.  Parece um problema n√£o t√£o terr√≠vel, mas na verdade √© mais insidioso do que parece. <br><br>  Imagine: um usu√°rio solicita uma p√°gina.  Acessamos simult√¢nea e sequencialmente os quatro dem√¥nios para desenh√°-lo.  Eles respondem rapidamente, tudo funciona bem. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/vo/u9/q5/vou9q5svtrqqptnxti-vkeuhmbm.png" width="400"></div><br>  Suponha que este caso seja tratado usando nginx com um n√∫mero fixo de trabalhadores do PHP FPM (com dez, por exemplo).  Se cada solicita√ß√£o for processada por aproximadamente 20 ms, com a ajuda de c√°lculos simples, pode-se entender que nosso sistema √© capaz de processar cerca de quinhentas solicita√ß√µes por segundo. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tq/h2/o2/tqh2o239lvw7qiobm8scwzrjma4.png" width="450"></div><br>  O que acontece quando um desses quatro servi√ßos come√ßa a ficar embotado e o processamento de solicita√ß√µes para ele aumenta de 20 ms para um tempo limite de 1000 ms?  √â importante lembrar que, quando trabalhamos com a rede, o atraso pode ser infinitamente grande.  Portanto, voc√™ sempre deve definir um tempo limite (nesse caso, √© igual a um segundo). <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rn/uq/ae/rnuqaevpyknuwpgd9a94oygknia.png" width="400"></div><br>  Acontece que o back-end √© for√ßado a aguardar o tempo limite expirar e receber e processar o erro do daemon.  Isso significa que o usu√°rio recebe a p√°gina em um segundo em vez de dez milissegundos.  Lento, mas n√£o fatal. <br><br>  Mas qual √© o verdadeiro problema aqui?  O fato √© que, quando temos todas as solicita√ß√µes processadas por segundo, a taxa de transfer√™ncia cai tragicamente para dez solicita√ß√µes por segundo.  E o d√©cimo primeiro usu√°rio n√£o poder√° mais obter uma resposta, mesmo que ele tenha solicitado uma p√°gina que n√£o esteja de modo algum associada a um servi√ßo sem gra√ßa.  S√≥ porque todos os dez funcion√°rios est√£o aguardando um tempo limite e n√£o podem processar novas solicita√ß√µes. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sk/tn/dz/sktndzfsfdbjsgobqxmm5sy_xkw.png" width="450"></div><br>  √â importante entender que esse problema n√£o pode ser resolvido aumentando o n√∫mero de trabalhadores.  Afinal, cada trabalhador exige uma certa quantidade de RAM para o seu trabalho, mesmo que ele n√£o execute um trabalho real, mas simplesmente trava na expectativa de um tempo limite.  Portanto, se voc√™ n√£o limitar o n√∫mero de trabalhadores de acordo com os recursos do seu servidor, aumentar cada vez mais novos trabalhadores colocar√° o servidor inteiro.  Este caso √© um exemplo de falha em cascata, quando a queda de qualquer servi√ßo, mesmo que n√£o seja cr√≠tica para o usu√°rio, causa uma falha em todo o sistema. <br><br><h3>  Solu√ß√£o </h3><br>  Existe um padr√£o chamado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">disjuntor</a> .  Sua tarefa √© bastante simples: ele deve, em algum momento, reduzir um servi√ßo mon√≥tono.  Para isso, um proxy √© colocado entre o servi√ßo e os trabalhadores.  Pode ser um c√≥digo PHP com armazenamento ou um daemon no host local.  √â importante observar que, se voc√™ tiver v√°rias inst√¢ncias (seu servi√ßo √© replicado), esse proxy dever√° rastrear separadamente cada uma delas. <br><br>  Escrevemos nossa implementa√ß√£o desse padr√£o.  Mas n√£o porque gostamos de escrever c√≥digo, mas porque quando resolvemos esse problema h√° muitos anos, n√£o havia solu√ß√µes prontas. <br><br>  Agora, descreverei em termos gerais sobre nossa implementa√ß√£o e como isso ajuda a evitar esse problema.  E mais sobre ela e suas diferen√ßas em rela√ß√£o a outras solu√ß√µes podem ser ouvidas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">em um relat√≥rio de Mikhail Kurmaev na Highload Siberia</a> no final de junho.  A transcri√ß√£o de seu relat√≥rio tamb√©m estar√° neste blog. <br><br>  Parece algo como isto: <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/dz/em/-d/dzem-dkkbiq6qx04cknxzdo99bc.png" width="500"></div><br>  Existe um servi√ßo Sphinx abstrato, que √© enfrentado por um disjuntor.  O disjuntor armazena o n√∫mero de conex√µes ativas para um daemon espec√≠fico.  Assim que esse valor atinge o limite, que definimos como uma porcentagem dos trabalhadores dispon√≠veis do FPM na m√°quina, acreditamos que o servi√ßo come√ßou a ficar mais lento.  Ao atingir o primeiro limite, enviamos uma notifica√ß√£o para a pessoa respons√°vel pelo servi√ßo.  Tal situa√ß√£o √© um sinal de que os limites precisam ser revistos ou um indicador de problemas de embotamento. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/_g/ou/k6/_gouk6h_xfurcn_o04rslmiwsh8.png" width="500"></div><br>  Se a situa√ß√£o piorar e o n√∫mero de trabalhadores inibidores atingir o segundo valor limite - em nossa produ√ß√£o, √© de cerca de 10% -, reduzimos completamente esse host.  Mais precisamente, o servi√ßo realmente continua a funcionar, mas paramos de enviar solicita√ß√µes para ele.  O navegador do Circuit os rejeita e imediatamente d√° um erro aos trabalhadores, como se o servi√ßo estivesse mentindo. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/co/ao/pd/coaopdx7tp0swvu8qu0t01jf81u.png" width="500"></div><br>  Periodicamente, pulamos automaticamente uma solicita√ß√£o de um trabalhador para ver se o servi√ßo ganhou vida.  Se ele responder adequadamente, n√≥s o incluiremos novamente no trabalho. <br><br>  Tudo isso √© feito para reduzir a situa√ß√£o ao esquema de replica√ß√£o anterior.  Em vez de esperar um segundo antes de perceber que o host est√° indispon√≠vel, imediatamente obtemos um erro e vamos para o host de backup. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9c/s8/iz/9cs8iz-aepaztqroslluwwregt0.png" width="400"></div><br><br><h3>  Implementa√ß√µes </h3><br>  Felizmente, o Open Source n√£o fica parado e hoje voc√™ pode usar uma solu√ß√£o pronta para usar no Github. <br><br>  Existem duas abordagens principais para implementar o disjuntor: uma biblioteca em n√≠vel de c√≥digo e um daemon independente que solicita proxies por meio de si mesmo. <br><br>  A op√ß√£o com a biblioteca √© mais adequada se voc√™ tiver um mon√≥lito principal em PHP, que interage com v√°rios servi√ßos, e os servi√ßos quase n√£o se comunicam.  Aqui est√£o algumas implementa√ß√µes dispon√≠veis: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ganesha</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Disjuntor PHP</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Phystrix</a> <br></li></ul><br>  Se voc√™ tiver muitos servi√ßos em idiomas diferentes e todos interagirem, a op√ß√£o no n√≠vel do c√≥digo dever√° ser duplicada em todos esses idiomas.  Isso √© inconveniente no suporte e, finalmente, leva a diferen√ßas nas implementa√ß√µes. <br><br>  Colocar um daemon nesse caso √© muito mais f√°cil.  Nesse caso, voc√™ n√£o precisa editar especialmente o c√≥digo.  O dem√¥nio est√° tentando tornar a intera√ß√£o transparente.  No entanto, essa op√ß√£o √© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">muito mais complicada em termos de arquitetura</a> . <br><br>  Aqui est√£o algumas op√ß√µes (a funcionalidade √© mais rica l√°, mas tamb√©m h√° um disjuntor): <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Enviado</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Linkerd</a> <br></li></ul><br><h3>  Conclus√µes </h3><br><ul><li>  N√£o confie na rede. <br></li><li>  Todas as solicita√ß√µes de rede devem ter um tempo limite, porque a rede pode demorar infinitamente. <br></li><li>  Use um disjuntor se desejar evitar falhas de aplicativos em cascata devido ao fato de um pequeno servi√ßo ficar mais lento. <br></li></ul><br><h2>  Monitoramento e telemetria </h2><br><h3>  O que isso d√° </h3><br><ul><li>  <b>Previsibilidade.</b>  √â importante prever qual √© a carga e o que ser√° em um m√™s para aumentar atempadamente o n√∫mero de inst√¢ncias de servi√ßo.  Isso √© especialmente verdadeiro se voc√™ estiver lidando com uma infraestrutura de ferro, pois a encomenda de novos servidores leva tempo. </li><li>  <b>Investiga√ß√£o de incidentes.</b>  Mais cedo ou mais tarde, algo vai dar errado de qualquer maneira, e voc√™ ter√° que investig√°-lo.  E √© importante ter dados suficientes para entender o problema e ser capaz de evitar essas situa√ß√µes no futuro. </li><li>  <b>Preven√ß√£o de acidentes.</b>  Idealmente, voc√™ deve entender quais padr√µes levam a falhas.  √â importante acompanhar esses padr√µes e notificar a equipe sobre eles em tempo h√°bil. </li></ul><br><br><h3>  O que medir </h3><br>  <b>M√©tricas de integra√ß√£o</b> <br><br>  Como estamos falando da intera√ß√£o entre servi√ßos, monitoramos tudo o que √© poss√≠vel em rela√ß√£o √† comunica√ß√£o do servi√ßo com o aplicativo.  Por exemplo: <br><br><ul><li>  n√∫mero de solicita√ß√µes; <br></li><li>  tempo de processamento da solicita√ß√£o (incluindo percentis); <br></li><li>  n√∫mero de erros l√≥gicos; <br></li><li>  n√∫mero de erros do sistema. <br></li></ul><br>  √â importante distinguir erros l√≥gicos dos erros do sistema.  Se o servi√ßo cair, √© uma situa√ß√£o regular: simplesmente mudamos para o segundo.  Mas n√£o √© t√£o assustador.  Se voc√™ iniciar algum tipo de erro l√≥gico, por exemplo, dados estranhos entram no servi√ßo ou os deixam, ent√£o isso j√° precisa ser investigado.  Provavelmente, o erro est√° relacionado a um erro no c√≥digo.  Ela pr√≥pria n√£o vai passar. <br><br>  <b>M√©tricas internas</b> <br><br>  Por padr√£o, o servi√ßo √© uma caixa preta que faz seu trabalho de maneira incompreens√≠vel.  Ainda √© desej√°vel entender e coletar o m√°ximo de dados que o servi√ßo pode fornecer.  Se o servi√ßo for um banco de dados especializado que armazena alguns dados da l√≥gica de neg√≥cios, acompanhe exatamente quantos dados, qual o tipo e outras m√©tricas de conte√∫do.  Se voc√™ tiver intera√ß√£o ass√≠ncrona, tamb√©m √© importante monitorar as filas pelas quais o servi√ßo se comunica: velocidade de chegada e partida, hor√°rio em diferentes est√°gios (se voc√™ tiver v√°rios pontos intermedi√°rios), n√∫mero de eventos na fila. <br><br>  Vamos ver quais m√©tricas podem ser coletadas usando o memcached como exemplo: <br><br><ul><li>  taxa de acerto / erro; <br></li><li>  tempo de resposta para v√°rias opera√ß√µes; <br></li><li>  RPS de v√°rias opera√ß√µes; <br></li><li>  discrimina√ß√£o dos mesmos dados em chaves diferentes; <br></li><li>  chaves com carregamento superior; <br></li><li>  todas as m√©tricas internas fornecidas pelo comando stats. <br></li></ul><br><br><h3>  Como fazer </h3><br>  Se voc√™ tem uma empresa pequena, um projeto pequeno e poucos servidores, √© uma boa solu√ß√£o conectar algum tipo de SaaS para coletar e visualizar - √© mais f√°cil e mais barato.  Nesse caso, geralmente o SaaS possui uma funcionalidade abrangente e n√£o precisa se preocupar com muitas coisas.  Exemplos de tais servi√ßos: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Datadog</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Rollbar</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Nova rel√≠quia</a> <br></li></ul><br>  Como alternativa, voc√™ sempre pode instalar o Zabbix, Grafana ou qualquer outra solu√ß√£o auto-hospedada em sua pr√≥pria m√°quina. <br><br><h3>  Conclus√µes </h3><br><ul><li>  <b>Colete todas as m√©tricas que puder.</b>  Os dados n√£o s√£o sup√©rfluos.  Quando voc√™ tiver que investigar alguma coisa, agradecer√° sua premissa. </li><li>  <b>N√£o se esque√ßa da intera√ß√£o ass√≠ncrona.</b>  Se voc√™ possui linhas que alcan√ßam gradualmente, √© importante entender a rapidez com que atingem, o que acontece com seus eventos no cruzamento entre os servi√ßos. </li><li>  <b>Se voc√™ escrever seu servi√ßo, ensine-o a fornecer estat√≠sticas sobre o trabalho.</b>  Parte dos dados pode ser medida na camada de integra√ß√£o quando nos comunicamos com este servi√ßo.  O restante do servi√ßo deve poder fornecer estat√≠sticas de acordo com o comando condicional.  Por exemplo, em todos os nossos servi√ßos on Go, essa funcionalidade √© padr√£o. </li><li>  <b>Personalize gatilhos.</b>  <b>Os gr√°ficos s√£o bons, mas apenas enquanto voc√™ os olha.</b>  √â importante que voc√™ tenha um sistema personalizado que informar√° se algo der errado. </li></ul><br><h2>  Memento mori </h2><br>  E agora um pouco sobre coisas tristes.  Voc√™ pode ter a sensa√ß√£o de que o exposto acima √© uma panac√©ia e agora nada cair√°.  Mas, mesmo que voc√™ aplique tudo o que foi descrito acima, algo cair√°.  √â importante considerar isso. <br>  As raz√µes para a queda s√£o muitas.  Por exemplo, voc√™ pode escolher um esquema de replica√ß√£o insuficientemente paran√≥ico.  Um meteorito caiu no seu data center e depois no segundo.  Ou voc√™ acabou de implantar o c√≥digo com um erro complicado que apareceu inesperadamente. <br><br>  Por exemplo, no Badoo, h√° uma p√°gina "Pessoas pr√≥ximas".  L√°, os usu√°rios pesquisam outras pessoas pr√≥ximas para conversar com eles. <br><br><img src="https://habrastorage.org/webt/3q/l4/xm/3ql4xmmqeobxu4vsrqygagstflw.png"><br><br>  Agora, para renderizar a p√°gina, o back-end faz chamadas s√≠ncronas para cerca de sete servi√ßos.  Para maior clareza, reduza esse n√∫mero para dois.  Um servi√ßo √© respons√°vel por renderizar o bloco central com fotos.  O segundo √© para o bloco de publicidade no canto inferior esquerdo.  Quem quiser se tornar mais vis√≠vel pode chegar l√°.  Se temos um servi√ßo que exibe esse an√∫ncio, o bloco simplesmente desaparece. <br><br><img src="https://habrastorage.org/webt/rg/tu/pj/rgtupjtztftw7pgvxpwg7auwa1q.png"><br><br>  A maioria dos usu√°rios nem sabe desse fato: nossa equipe responde rapidamente e logo o bloco reaparece. <br><br>  Mas nem todas as funcionalidades que podemos remover silenciosamente.  Se perdermos o servi√ßo respons√°vel pela parte central da p√°gina, isso n√£o funcionar√° para ocultar.  Portanto, √© importante informar ao usu√°rio em seu idioma o que est√° acontecendo. <br><br><img src="https://habrastorage.org/webt/eh/1q/c3/eh1qc3sr6laokkydqscq_ydilue.png"><br><br>  Tamb√©m √© desej√°vel que a falha de um servi√ßo n√£o leve a uma falha em cascata.  Para cada servi√ßo, √© necess√°rio escrever um c√≥digo que lide com a queda, caso contr√°rio, o aplicativo poder√° falhar como um todo. <br><br>  Mas isso n√£o √© tudo.  √Äs vezes, algo cai, sem o qual voc√™ n√£o pode viver de forma alguma.  Por exemplo, um banco de dados central ou servi√ßo de sess√£o.  √â importante resolv√™-lo corretamente e mostrar ao usu√°rio algo adequado, de alguma forma entret√™-lo, para dizer que tudo est√° sob controle.  Ao mesmo tempo, √© importante que tudo esteja realmente sob controle e os monitores sejam notificados do problema. <br><br><img src="https://habrastorage.org/webt/e6/hs/wt/e6hswt9cdlv2kfnt47zuujzyoyq.png"><br><br><img src="https://habrastorage.org/webt/lr/ch/g9/lrchg9mdfortw-jjnzi9ejdzr8u.png"><br><br><h3>  Morrer t√£o certo </h3><br><ul><li>  <b>Prepare-se para o outono.</b>  N√£o h√° bala de prata; portanto, sempre coloque canudos caso o servi√ßo caia completamente, mesmo se voc√™ usar redund√¢ncia. </li><li>  <b>Evite falhas em cascata</b> quando problemas com um dos servi√ßos matam o aplicativo inteiro. </li><li>  <b>Desative a funcionalidade n√£o cr√≠tica do usu√°rio.</b>  Isso √© normal.  Muitos servi√ßos s√£o usados ‚Äã‚Äãapenas para necessidades internas e n√£o afetam a funcionalidade fornecida.  Por exemplo, um servi√ßo de estat√≠sticas.  N√£o importa para o usu√°rio se as estat√≠sticas s√£o coletadas de voc√™ ou n√£o.  √â importante para ele que o site funcione. </li></ul><br><h2>  Sum√°rio </h2><br>  Para integrar de forma confi√°vel o novo servi√ßo ao sistema, escrevemos uma API de wrapper especial em torno dele no Badoo, que executa as seguintes tarefas: <br><br><ul><li>  balanceamento de carga; </li><li>  timeouts; </li><li>  failover l√≥gico; </li><li>  disjuntor; </li><li>  monitoramento e telemetria; </li><li>  l√≥gica de autoriza√ß√£o; </li><li>  serializa√ß√£o e desserializa√ß√£o de dados. </li></ul><br>  √â melhor garantir que todos esses itens tamb√©m sejam abordados na sua camada de integra√ß√£o.  Especialmente se voc√™ estiver usando um cliente API de c√≥digo-fonte pronto.  √â importante lembrar que a camada de integra√ß√£o √© uma fonte de maior risco de falha em cascata do seu aplicativo. <br><br>  Obrigado pela aten√ß√£o! <br><br>  <b>Literatura</b> <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Solte-o!</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Engenharia de confiabilidade do site</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Criando microsservi√ßos</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt413555/">https://habr.com/ru/post/pt413555/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt413545/index.html">Humor na marca - por que nem sempre √© bom</a></li>
<li><a href="../pt413547/index.html">Experimente 2 milh√µes de sess√µes sem cabe√ßa</a></li>
<li><a href="../pt413549/index.html">Curso de Desenvolvimento Web</a></li>
<li><a href="../pt413551/index.html">Rolagem e aten√ß√£o (estudo de 2018)</a></li>
<li><a href="../pt413553/index.html">O registrador REG.RU privou o parceiro de acesso a 70 mil dom√≠nios e levou o servi√ßo para si</a></li>
<li><a href="../pt413557/index.html">NewSQL: SQL n√£o vai a lugar nenhum</a></li>
<li><a href="../pt413559/index.html">Degrada√ß√£o da Web ou como tornar a Web leg√≠vel para humanos</a></li>
<li><a href="../pt413561/index.html">Velocidade da √°rvore de express√£o Linq compilada</a></li>
<li><a href="../pt413563/index.html">4 maneiras de importar um pacote para o Go</a></li>
<li><a href="../pt413565/index.html">An√°lise de hackers do Kubernetes - backdoor via kubelet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>