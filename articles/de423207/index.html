<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏼‍🤝‍👨🏽 👏🏽 🧕🏿 So erstellen Sie ein automatisches Update eines Online-Spieleclients ✳️ 🧡 ☝🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In diesem Artikel werde ich darüber sprechen, wie ich ein Auto-Update-System für ein Online-Client-Spiel erstellt habe. Link zur Quelle (Delphi) am En...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>So erstellen Sie ein automatisches Update eines Online-Spieleclients</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/423207/">  In diesem Artikel werde ich darüber sprechen, wie ich ein Auto-Update-System für ein Online-Client-Spiel erstellt habe.  Link zur Quelle (Delphi) am Ende des Artikels.  Tatsächlich habe ich eine solche Funktion in meinen beiden Spielen implementiert, und wenn der erste Pfannkuchen (im Spectromancer-Spiel) etwas klumpig herauskam, erwies sich die zweite Implementierung als sehr praktisch und effektiv.  Dies ist mein erster Artikel über Habré, also nicht hart treffen, sondern auf die Mängel in den Kommentaren hinweisen :) <br><br><h2>  Spielaktualisierungsalgorithmus </h2><br><ul><li>  Überprüfen der Version auf Aktualisierung. </li><li>  Laden Sie die Liste der Dateien der aktuellen Version herunter. </li><li>  Herunterladen neuer oder geänderter Dateien in einen temporären Ordner. </li><li>  Installieren des Updates - Bringen Sie die Dateien des installierten Clients gemäß der Liste. </li><li>  Starten eines aktualisierten Clients. </li></ul><a name="habracut"></a><br><h3>  Versionsprüfung </h3><br>  Zunächst fragt der Client beim Start den Server nach der Nummer der aktuellen Version (X) und der Nummer des Minimums, das ohne Aktualisierung zulässig ist (Y).  Wenn die Client-Version nicht niedriger als Y ist, ist kein Update erforderlich. Andernfalls startet der Client das Update-Dienstprogramm " <b>GetNewVersion.exe X</b> " und fährt sich selbst herunter. <br><br>  Wie Sie sehen können, wird die Versionsnummer vom Parameter übergeben. Auf diese Weise können Sie das Spiel auf jede auf dem Server verfügbare Version aktualisieren und sogar senken.  Wenn der Parameter nicht übergeben wird, fordert das Dienstprogramm selbst die aktuelle Versionsnummer vom Server an.  Die Versionsnummer ist nur eine ganze Zahl, das Nummerierungsschema kann beliebig sein, zum Beispiel entspricht meine Version 1.12 der Nummer 1120. <br><br>  Die Antwort vom Server kommt nicht sofort und bevor wir sie erhalten, können wir das Spielfenster nicht erstellen, da Sie es möglicherweise sofort schließen müssen und unverständliches Flackern auf dem Bildschirm überhaupt nicht das ist, was wir brauchen.  Das Zeitlimit für die Antwort müsste etwas dauern, und der Client ist damit beschäftigt, die schwersten JPEGs zu laden / zu entpacken.  Sie können auch nicht zu lange warten: Der Spieler hat das Spiel gestartet - aber auf dem Bildschirm passiert nichts, ein Durcheinander.  Wenn daher innerhalb von 1,0 Sekunden.  Die Antwort vom Server ist nicht eingetroffen. Das Laden des Spiels wird auf die übliche Weise fortgesetzt.  Dies ist keine große Sache: Sobald der Spieler versucht, sich beim Server anzumelden, erhält er eine Nachricht über die Notwendigkeit, den Client zu aktualisieren, oder dass der Server nicht verfügbar ist. <br><br><h3>  Dateiliste herunterladen </h3><br>  Bei Kenntnis der Versionsnummer lädt das Update-Dienstprogramm die Liste der Dateien unter folgender <code>[base_ur]&gt;/[]/filelist</code> herunter: <code>[base_ur]&gt;/[]/filelist</code> <br>  Dies ist nur eine Liste von CSV-Dateien mit Prüfsummen sowie komprimierten und unkomprimierten Größen. Jede Zeile sieht ungefähr so ​​aus: <br> <code>18*Priest.tga;1053151921D9;91719;107372</code> <br>  Hier bedeutet "18 *", dass 18 Zeichen im Dateinamen mit der vorherigen Datei identisch sind.  Da Dateien normalerweise in alphabetischer Reihenfolge abgelegt sind und die Pfade lang sein können, wird die Größe der Listendatei erheblich gespart.  Für einen Webserver, auf dem die Komprimierung nicht aktiviert ist, bedeutet dies, dass die Datei schneller heruntergeladen wird und das Update früher gestartet wird. <br><br><h3>  Laden Sie neue oder geänderte Dateien herunter </h3><br>  Wir wissen nicht, wie alt der Spielclient ist, möglicherweise wurden einige Dateien manuell geändert oder gelöscht.  Wir möchten nicht zu viel herunterladen. Nachdem das Dienstprogramm die Liste der Dateien erhalten hat, überprüft es sie auf Aktualisierungen. Wenn sich die Datei nicht im Ordner des Spiels befindet oder die Prüfsumme anders ist, wird die Datei zur Download-Warteschlange hinzugefügt.  Gleichzeitig können nicht mehr als 2 Dateien geladen werden - dies reicht völlig aus, damit der Download einerseits nicht verlangsamt wird, andererseits aber nacheinander erfolgt. <br><br><img src="https://habrastorage.org/webt/a1/ka/fw/a1kafw5r2dgdbsow7gd0pou5a5o.png"><br><br>  Ein besonderes Thema ist die Anzeige des Fortschritts.  Bis die gesamte Liste verarbeitet wurde, wissen wir nicht genau, wie viele Dateien heruntergeladen werden sollen und wie groß sie sind.  Sobald jedoch die erste Datei hochgeladen wird, können wir bereits einige Informationen anzeigen.  Tatsächlich zeigt der Fortschritt die Download-Warteschlange an: wie viel heruntergeladen werden muss und wie viel bereits heruntergeladen wurde. <br><br>  Heruntergeladene Dateien werden sofort entpackt und in einem temporären Ordner gespeichert. Ich verwende die <code>zlib</code> Bibliothek zur Komprimierung. <br><br>  Wenn die gesamte Liste der Dateien verarbeitet wurde und alle Downloads abgeschlossen sind, prüft das Dienstprogramm, ob die Datei " <code>changes.txt</code> vorhanden ist, und zeigt sie an, falls vorhanden.  Der Benutzer wird aufgefordert, den Aktualisierungsvorgang zu starten.  Bevor Sie auf die Schaltfläche "Aktualisieren" klicken, wurden noch keine Änderungen am Ordner des Spiels vorgenommen, sodass Sie sich problemlos abmelden können. <br><br>  Übrigens, wenn der Benutzer den Download unterbricht oder die Installation ablehnt, muss er beim nächsten Mal nicht alle Dateien erneut herunterladen: Vor dem Herunterladen der nächsten Datei überprüft das Dienstprogramm das Vorhandensein im temporären Ordner, und wenn die Prüfsumme übereinstimmt, wird der Download als erfolgreich angesehen. <br><br><img src="https://habrastorage.org/webt/kj/e_/rf/kje_rfnc4gaxycjafbze_3zurli.png"><br><br>  Wenn Sie jedoch auf "Aktualisieren" klicken, startet das Dienstprogramm ein anderes Dienstprogramm - " <b>InstallUpdate.exe</b> " - und <b>fährt</b> sich selbst herunter. <br><br><h3>  Update installieren </h3><br>  Warum brauche ich ein anderes Dienstprogramm?  Es ist ganz einfach: Um die Spieledateien zu aktualisieren, müssen Sie sie mit Administratorrechten ausführen.  Das Herunterladen des Updates ist jedoch im Gegenteil kontraindiziert.  Denn wenn Sie kein glücklicher Besitzer eines EV-Code-Signaturzertifikats sind, wird beim Starten des Prozesses mit Administratorrechten das UAC-Fenster angezeigt.  Und wenn der Spieler beim Starten des Spiels anstelle der üblichen Benutzeroberfläche Folgendes sieht: <br><br><img src="https://habrastorage.org/webt/mo/gl/6p/mogl6p0zghhphcq9rlpivwskle0.png"><br><br>  ... dann ist dies zumindest ein Grund, sich vor dem Start zu hüten oder ihn sogar ganz abzubrechen.  Eine andere Sache, mit der manuellen Zustimmung zur Installation des Updates - in diesem Zusammenhang wird das UAC-Fenster normal wahrgenommen.  Leider kann ein Prozess in Windows seine Rechte zur Laufzeit nicht erhöhen - diese Eigenschaft wurde seit dem Start nicht geändert.  Daher verwende ich zwei separate Dateien.  Tatsächlich sind <code>GetNewVersion.exe</code> und <code>InstallUpdate.exe</code> dasselbe Dienstprogramm, die Dateien sind identisch.  Die Aktion wird durch die übertragenen Parameter und den Namen der ausführbaren Datei bestimmt. <br><br>  Beim Start kopiert InstallUpdate die Spielclientdateien aus dem temporären Ordner in den Spielordner, startet dann den aktualisierten Client und wird beendet.  In diesem Fall kann auch die Datei <code>GetNewVersion.exe</code> aktualisiert werden. <br><br>  Alle Aktionen sowie auftretende Fehler werden im Protokoll detailliert protokolliert. Dies ist sehr nützlich für das Debuggen. <br><br><h2>  Der Prozess der Vorbereitung einer neuen Version </h2><br>  Wir haben das Update-Schema aus Sicht des Spiel-Clients untersucht, aber wie kann alles funktionieren?  Um neue Builds vorzubereiten, habe ich ein anderes Dienstprogramm geschrieben - <b>CompressBuild</b> .  Es scannt rekursiv einen Ordner, komprimiert Dateien mit der Deflate-Methode und schreibt Informationen darüber in die Dateiliste - <code>filelist</code> .  Nach der Komprimierung wird das Symbol "_" an den Dateinamen angehängt.  Komprimierte Dateien werden nicht erneut komprimiert. Daher können bei Bedarf nur einzelne Dateien im Build-Ordner aktualisiert werden. CompressBuild aktualisiert sie nur. <br><br>  Einige Dateien im Spieleclient, die sich während des Betriebs ändern, enthalten beispielsweise Einstellungen.  Solche Dateien müssen ignoriert werden, das Dienstprogramm entnimmt die entsprechenden Vorlagen aus der Ausschlussdatei.  Das heißt, diese Dateien werden einfach nicht in die <code>filelist</code> und verderben beim Aktualisieren nicht auf dem Client. <br><br>  Um einen neuen Build vorzubereiten, brauche ich also: <br><br>  1. Kopieren Sie den Ordner <code>\master</code> nach <code>\[_]</code> <br>  2. Führen Sie <b>CompressBuild aus</b> , das die darin enthaltenen Dateien packt und eine Liste erstellt. <br>  3. Laden Sie alles auf die Website des Spiels hoch. <br>  4. Ändern Sie auf dem Spieleserver die Nummer der aktuellen Version in die gerade heruntergeladene Nummer.  Voila! <br><br>  Ab sofort erhalten Benutzer beim Aktualisieren eine neue Version. <br><br>  Nun, Ordner mit alten Builds auf dem Server können gelöscht werden, um keinen Speicherplatz zu beanspruchen. <br><br><h2>  Fazit </h2><br>  Natürlich ist mein Update-System nicht perfekt und nicht ohne Mängel.  Wenn beispielsweise eine Datei im Client gelöscht wurde, verbleibt sie bei den Spielern.  Wenn die Datei umbenannt wurde, wird sie als neue heruntergeladen und die alte Instanz wird nicht gelöscht.  Sie können das Update-Dienstprogramm natürlich verfeinern, indem Sie Befehle zum Löschen / Umbenennen von Dateien zur Liste der Dateien hinzufügen. Im Allgemeinen sind solche Probleme jedoch für mein Spiel nicht relevant, sodass ich mich nicht darum gekümmert habe. <br><br>  Die Quelle finden Sie hier: <a href="">astralheroes.com/files/UpdaterSrc.zip</a> <br>  (kompiliert in Delphi-2006 / Turbo Delphi, ich kann nicht für andere Compiler bürgen). </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de423207/">https://habr.com/ru/post/de423207/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de423193/index.html">Konfigurieren Sie Web-Push-Benachrichtigungen mithilfe von pywebpush Schritt für Schritt</a></li>
<li><a href="../de423195/index.html">Was ist neu in JPA 2.2?</a></li>
<li><a href="../de423197/index.html">LOLWUT: ein Kunstwerk in einem DB-Team</a></li>
<li><a href="../de423203/index.html">Cooler Teamleiter wird für den Service verantwortlich sein</a></li>
<li><a href="../de423205/index.html">Speicherprojekt auf MS SQL Server, Integration in 1C 7.7 und Entwicklungsautomatisierung in SSDT</a></li>
<li><a href="../de423209/index.html">Killer Form 2? Übersicht über den MoonRay S100 Dental 3D-Drucker</a></li>
<li><a href="../de423211/index.html">State Duma Committee: Likes und Reposts bleiben strafrechtlich haftbar</a></li>
<li><a href="../de423213/index.html">Wie im alten Russisch wird es "das ist ein Test" geben</a></li>
<li><a href="../de423215/index.html">Wo ist mein Geld, Mann? Worüber schweigt Steam?</a></li>
<li><a href="../de423217/index.html">Zurück in die Zukunft: Praktische Bestätigung der Tomonaga-Luttinger-Theorie nach fast 56 Jahren</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>