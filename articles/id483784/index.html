<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😲 🤷 👩🏼‍🤝‍👨🏻 Cara membuat aplikasi multi-tenant dari aplikasi non-tenant 👲🏻 🖕🏼 🔷</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Saya tidak akan memberikan definisi multi-tenancy, mereka sudah menulis beberapa kali tentang ini di sini dan di sini . Dan lebih baik langsung ke top...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cara membuat aplikasi multi-tenant dari aplikasi non-tenant</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/directum/blog/483784/"><p><img src="https://habrastorage.org/webt/-8/wa/hf/-8wahfnvtijn8bqkeopcgo0an1g.png" alt="gambar"></p><br><p>  Saya tidak akan memberikan definisi multi-tenancy, mereka sudah menulis beberapa kali tentang ini di <a href="https://habr.com/ru/company/microsoft/blog/145027/">sini</a> dan di <a href="https://habr.com/ru/company/1c/blog/326654/">sini</a> .  Dan lebih baik langsung ke topik artikel dan mulai dengan pertanyaan-pertanyaan berikut: </p><br><h2 id="pochemu-prilozhenie-ne-delayut-srazu-multitenantnym">  Mengapa aplikasi ini tidak langsung multitenant? </h2><br><p>  Kebetulan aplikasi pada awalnya dikembangkan untuk instalasi hanya di sisi klien.  Anda dapat memanggil aplikasi seperti kotak atau <i>perangkat lunak sebagai produk</i> .  Seorang klien membeli sebuah kotak dan menyebarkan aplikasi di server mereka (ada banyak contoh aplikasi semacam itu). </p><br><p>  Namun seiring berjalannya waktu, perusahaan pengembang mungkin berpikir bahwa akan menyenangkan untuk menempatkan aplikasi di cloud untuk disewa (perangkat lunak sebagai layanan).  Metode penyebaran ini memiliki keuntungan untuk klien dan perusahaan pengembang.  Pelanggan dapat dengan cepat mendapatkan sistem kerja dan tidak khawatir tentang penyebaran dan administrasi.  Saat menyewa aplikasi, Anda tidak perlu investasi besar satu kali. </p><br><p>  Dan perusahaan pengembang akan menerima pelanggan baru, serta tugas-tugas baru: menyebarkan aplikasi di cloud, mengelola, memperbarui ke versi baru, memigrasikan data selama memperbarui, cadangan data, kecepatan dan kesalahan pemantauan, memperbaiki masalah jika terjadi. </p><a name="habracut"></a><br><h2 id="pochemu-prilozhenie-v-oblake-dolzhno-byt-multitenantnym">  Mengapa aplikasi di cloud harus multi-tenant? </h2><br><p>  Untuk menempatkan aplikasi di cloud, tidak perlu membuatnya multi-tenant.  Tetapi kemudian akan ada masalah berikut: untuk setiap klien, Anda harus menggunakan stand khusus di cloud dengan aplikasi sewaan, dan ini sudah mahal, baik dalam hal konsumsi sumber daya stand cloud dan dalam hal administrasi.  Lebih menguntungkan untuk mengimplementasikan multi-tenancy dalam aplikasi sehingga satu instance dapat melayani beberapa klien (organisasi). </p><br><p>  Jika aplikasi menarik 1000 pengguna yang bekerja secara bersamaan, itu menguntungkan untuk mengelompokkan klien (organisasi) sehingga secara total mereka memberikan beban yang diinginkan dari 1000 pengguna per instance aplikasi.  Dan kemudian akan ada konsumsi sumber daya cloud yang paling optimal. </p><br><p>  Asumsikan bahwa aplikasi tersebut disewa oleh organisasi untuk 20 pengguna (karyawan organisasi).  Maka Anda perlu mengelompokkan 50 organisasi ini untuk mencapai beban yang tepat.  Penting untuk mengisolasi organisasi dari satu sama lain.  Suatu organisasi menyewakan suatu aplikasi, membiarkan karyawannya pergi ke sana, hanya menyimpan datanya, dan tidak melihat bahwa organisasi lain juga dilayani oleh aplikasi yang sama. </p><br><p>  Menerapkan multi-tenancy tidak berarti bahwa aplikasi tidak lagi dapat digunakan secara lokal di server organisasi.  Anda dapat mendukung dua metode penerapan sekaligus: </p><br><ul><li>  aplikasi multi-tenant di cloud; </li><li>  aplikasi penyewa tunggal di server klien. </li></ul><br><p>  Aplikasi kami memiliki cara yang serupa: dari non-penyewa hingga multi-penyewa.  Dan dalam artikel ini saya akan membagikan beberapa pendekatan dalam mengembangkan multi-tenancy. </p><br><h2 id="kak-realizovat-multitenantnost-v-prilozhenii-kotoroe-sproektirovano-kak-ne-tenantnoe">  Bagaimana menerapkan multi-tenancy dalam aplikasi yang dirancang sebagai non-tenant? </h2><br><p>  Kami akan segera membatasi topik, kami hanya akan mempertimbangkan pengembangan, kami tidak akan menyentuh masalah pengujian, rilis versi, penyebaran, dan administrasi.  Di semua bidang ini, kemunculan multi-tenancy juga harus diperhitungkan, tetapi untuk saat ini kita hanya akan berbicara tentang pembangunan. </p><br><p>  Untuk memahami apa itu aplikasi yang bukan tenanty dan menjadi multi-tenant, saya akan menjelaskan tujuannya, daftar layanan dan teknologi yang digunakan. </p><br><p>  Ini adalah sistem ECM (DirectumRX), yang terdiri dari 10 layanan (5 layanan monolitik dan 5 layanan mikro).  Semua layanan ini dapat ditempatkan di satu server yang kuat, atau di beberapa server. </p><br><div class="spoiler">  <b class="spoiler_title">Layanan</b> <div class="spoiler_text"><ul><li>  Layanan web - untuk melayani klien web (browser). </li><li>  Layanan WCF - untuk melayani klien desktop (aplikasi WPF). </li><li>  Layanan untuk aplikasi seluler. </li><li>  Layanan untuk melakukan proses latar belakang. </li><li>  Layanan untuk perencanaan proses latar belakang. </li><li>  Layanan Eksekusi Skema Alur Kerja </li><li>  Layanan Eksekusi Blok Workflow </li><li>  Layanan penyimpanan dokumen (data biner). </li><li>  Layanan untuk mengonversi dokumen menjadi html (pratinjau di browser). </li><li>  Layanan untuk menyimpan hasil konversi dalam html </li></ul></div></div><br><p>  Tumpukan teknologi yang digunakan: <br>  .NET + SQLServer / Postgres + NHibernate + IIS + RabbitMQ + Redis </p><br><p> Jadi, apa yang membuat layanan menjadi multi-tenant?  Untuk melakukan ini, Anda perlu memperbaiki mekanisme berikut dalam layanan, yaitu, menambah pengetahuan tentang penyewa ke: </p><br><ul><li>  penyimpanan data; </li><li>  ORM; </li><li>  caching data; </li><li>  pemrosesan permintaan; </li><li>  memproses pesan antrian; </li><li>  konfigurasi; </li><li>  penebangan; </li><li>  melakukan tugas-tugas latar belakang; </li><li>  interaksi dengan layanan microser; </li><li>  interaksi dengan broker pesan. </li></ul><br><p>  Dalam hal aplikasi kami, ini adalah tempat utama yang membutuhkan perbaikan.  Mari kita pertimbangkan secara terpisah. </p><br><h2 id="vybor-sposoba-hraneniya-dannyh">  Memilih metode penyimpanan data </h2><br><p>  Saat Anda membaca artikel tentang multi-tenancy, hal pertama yang harus mereka pilah adalah bagaimana mengatur penyimpanan data.  Memang, intinya penting. </p><br><p>  Untuk sistem ECM kami, penyimpanan utama adalah basis data relasional, yang memiliki sekitar 100 tabel.  Bagaimana cara mengatur penyimpanan data banyak organisasi sehingga organisasi A sama sekali tidak melihat data organisasi B? </p><br><p>  Beberapa skema diketahui (banyak yang telah ditulis tentang skema ini): </p><br><ul><li>  buat database Anda sendiri untuk setiap organisasi (untuk setiap penyewa); </li><li>  menggunakan satu database untuk semua organisasi, tetapi untuk setiap organisasi membuat skema sendiri dalam database; </li><li>  gunakan satu database untuk semua organisasi, tetapi tambahkan kolom "kunci penyewa / organisasi" di setiap tabel. </li></ul><br><p>  Pilihan skema tidak disengaja.  Dalam kasus kami, cukup mempertimbangkan kasus-kasus administrasi sistem untuk memahami opsi yang disukai.  Kasus adalah sebagai berikut: </p><br><ul><li>  tambah penyewa (organisasi baru menyewa sistem); </li><li>  menghapus penyewa (organisasi menolak untuk menyewa); </li><li>  memindahkan penyewa ke tegakan cloud lainnya (mendistribusikan kembali beban di antara tegakan cloud saat salah satu tegakan berhenti untuk mengatasi beban). </li></ul><br><p>  Pertimbangkan kasus transfer penyewa.  Tugas utama transfer adalah untuk mentransfer data organisasi ke stand lain.  Transfer tidak sulit dilakukan jika penyewa memiliki basis datanya sendiri, tetapi akan merepotkan jika Anda mencampur data berbagai organisasi dalam 100 tabel.  Cobalah untuk mengekstrak hanya data yang diperlukan dari tabel, mentransfernya ke database lain, di mana sudah ada data dari penyewa lain, dan agar pengidentifikasi mereka tidak berpotongan. </p><br><p>  Kasus selanjutnya adalah penambahan penyewa baru.  Kasusnya juga tidak sederhana.  Menambahkan penyewa adalah kebutuhan untuk mengisi direktori sistem, pengguna, hak, sehingga Anda dapat masuk ke sistem sama sekali.  Tugas ini paling baik diselesaikan dengan mengkloning database referensi, yang sudah memiliki semua yang Anda butuhkan. </p><br><p>  Kasus penghapusan penyewa sangat mudah diselesaikan dengan menonaktifkan basis data penyewa. </p><br><p>  Karena alasan ini, kami memilih skema: <strong>satu penyewa - satu basis data</strong> . </p><br><h2 id="orm">  ORM </h2><br><p>  Kami memilih metode penyimpanan data, pertanyaan berikutnya: bagaimana cara mengajar ORM untuk bekerja dengan skema yang dipilih? </p><br><p>  Kami menggunakan Nhibernate.  Diperlukan bahwa Nhibernate bekerja dengan beberapa database dan secara berkala beralih ke yang benar, misalnya, tergantung pada permintaan http.  Jika kami memproses permintaan organisasi A, maka basis data A digunakan, dan jika permintaan berasal dari organisasi B, maka basis data B. </p><br><p>  NHibernate memiliki kesempatan seperti itu.  Anda perlu mengganti implementasi <em>NHibernate.Connection.DriverConnectionProvider</em> .  Setiap kali NHibernate ingin membuka koneksi database, ia memanggil <em>DriverConnectionProvider</em> untuk mendapatkan string koneksi.  Di sini kita akan menggantinya dengan yang diperlukan: </p><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyDriverConnectionProvider</span></span> : <span class="hljs-title"><span class="hljs-title">DriverConnectionProvider</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConnectionString =&gt; TenantRegistry.Instance.CurrentTenant.ConnectionString; }</code> </pre> <br><p>  Apa itu <em>TenantRegistry.Instance.CurrentTenant</em> akan saya ceritakan nanti. </p><br><h2 id="keshirovanie-dannyh">  Caching data </h2><br><p>  Layanan sering kali menyimpan data untuk meminimalkan permintaan basis data atau tidak menghitung hal yang sama berulang kali.  Masalahnya adalah bahwa cache harus dipecah oleh penyewa jika data penyewa di-cache.  Tidak dapat diterima bahwa cache data dari satu organisasi digunakan saat memproses permintaan dari organisasi lain.  Solusi paling sederhana adalah dengan menambahkan pengidentifikasi penyewa ke kunci setiap cache: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tenantCacheKey = cacheKey + TenantRegistry.Instance.CurrentTenant.Id;</code> </pre> <br><p>  Masalah ini harus diingat ketika membuat setiap cache.  Ada banyak cache di layanan kami.  Agar tidak lupa memperhitungkan pengidentifikasi penyewa di masing-masing, lebih baik menyatukan pekerjaan dengan cache.  Misalnya, buat mekanisme caching umum yang akan melakukan cache keluar dari kotak dalam konteks penyewa. </p><br><h2 id="logirovanie">  Penebangan </h2><br><p>  Cepat atau lambat, ada sesuatu yang salah dalam sistem, Anda harus membuka file log dan mulai mempelajarinya.  Pertanyaan pertama adalah: atas nama pengguna mana dan organisasi mana tindakan ini dilakukan? </p><br><p>  Akan lebih mudah jika di setiap baris log ada pengidentifikasi penyewa dan nama pengguna penyewa.  Informasi ini menjadi seperlunya, misalnya, waktu pesan: </p><br><pre> <code class="plaintext hljs">2019-05-24 17:05:27.985 &lt;message&gt; [User2 :Tenant1] 2019-05-24 17:05:28.126 &lt;message&gt; [User3 :Tenant2] 2019-05-24 17:05:28.173 &lt;message&gt; [User4 :Tenant3]</code> </pre> <br><p>  Pengembang tidak boleh berpikir tentang penyewa mana untuk menulis ke log, itu harus otomatis, disembunyikan "di bawah kap" dari sistem logging. </p><br><p>  Kami menggunakan NLog, jadi saya akan memberikan contohnya.  Cara termudah untuk mengamankan pengidentifikasi penyewa adalah dengan membuat <em>NLog.LayoutRenderers.LayoutRenderer</em> , yang akan memungkinkan Anda untuk mendapatkan pengidentifikasi penyewa untuk setiap entri log: </p><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">LayoutRenderer(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"tenant"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TenantLayoutRenderer</span></span> : <span class="hljs-title"><span class="hljs-title">LayoutRenderer</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Append</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">StringBuilder builder, LogEventInfo logEvent</span></span></span><span class="hljs-function">)</span></span> { builder.Append(TenantRegistry.Instance.CurrentTenant.Id); } }</code> </pre> <br><p>  Dan kemudian gunakan LayoutRenderer ini di templat log: </p><br><pre> <code class="plaintext hljs">&lt;target layout="${odate} ${message} [${user} :${tenant}]"/&gt;</code> </pre> <br><h2 id="vypolnenie-koda">  Eksekusi kode </h2><br><p>  Dalam contoh di atas, saya sering menggunakan kode berikut: </p><br><pre> <code class="cs hljs">TenantRegistry.Instance.CurrentTenant</code> </pre> <br><p>  Sudah waktunya untuk mengatakan apa artinya itu.  Tetapi pertama-tama Anda perlu memahami pendekatan yang kami ikuti dalam layanan: </p><br><blockquote>  Setiap eksekusi kode (memproses permintaan http, memproses pesan antrian, melakukan tugas latar belakang di utas terpisah) harus dikaitkan dengan beberapa penyewa. </blockquote><p>  Ini berarti bahwa di setiap tempat dalam eksekusi kode orang dapat bertanya: "Untuk penyewa mana thread ini bekerja?"  atau dengan cara lain, "Apa penyewa saat ini?" </p><br><p>  <em>TenantRegistry.Instance.CurrentTenant</em> adalah penyewa saat ini untuk aliran saat ini.  Streaming dan penyewa dapat ditautkan dalam aplikasi kami.  Mereka terhubung sementara, misalnya, saat memproses permintaan http atau saat memproses pesan dari antrian.  Salah satu cara untuk mengikat penyewa ke aliran dilakukan seperti ini: </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//    . using (TenantRegistry.Instance.SwitchTo(tenantId)) { // ,     . var tenant = TenantRegistry.Instance.CurrentTenant; //     . var connectionString = tenant.ConnectionString; //  . var id = tenant.Id; }</span></span></code> </pre> <br><p>  Penyewa yang diikat ke utas dapat diperoleh di mana saja dalam kode, dengan menghubungi <em>TenantRegistry</em> - ini adalah singleton, titik akses untuk bekerja dengan penyewa.  Oleh karena itu, Nhibernate dan NLog dapat mengakses singleton ini (pada titik ekstensi) untuk mengetahui string koneksi atau pengidentifikasi penyewa. </p><br><h2 id="fonovye-zadachi">  Tugas Latar Belakang </h2><br><p>  Layanan seringkali memiliki tugas latar belakang yang perlu dilakukan pada timer.  Tugas latar belakang dapat mengakses database organisasi, dan kemudian tugas latar belakang harus dilakukan untuk setiap penyewa.  Untuk melakukan ini, Anda tidak perlu memulai timer atau utas terpisah untuk setiap penyewa.  Dimungkinkan untuk melakukan tugas dalam penyewa yang berbeda dalam satu utas / penghitung waktu.  Untuk melakukan ini, di pengatur waktu, kami memilah penyewa, menghubungkan setiap penyewa dengan aliran dan melakukan tugas latar belakang: </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//    . foreach (var tenant in TenantRegistry.Instance.Tenants) { //    . using (TenantRegistry.Instance.SwitchTo(tenant.Id)) { //     . } }</span></span></code> </pre> <br><p>  Dua penyewa tidak dapat dilampirkan ke aliran pada saat yang sama, jika kita lampirkan satu, yang lain terlepas dari aliran.  Kami secara aktif menggunakan pendekatan ini agar tidak menghasilkan utas / penghitung waktu untuk tugas latar belakang. </p><br><h2 id="kak-sootnesti-http-zapros-c-tenantom">  Bagaimana cara menghubungkan permintaan http dengan penyewa </h2><br><p>  Untuk memproses permintaan http klien, Anda perlu tahu dari organisasi mana ia datang.  Jika pengguna sudah diautentikasi, maka pengenal penyewa dapat disimpan dalam cookie otentikasi (jika bekerja dengan aplikasi dilakukan melalui browser) atau dalam token JWT.  Tetapi bagaimana jika pengguna belum diautentikasi?  Misalnya, pengguna anonim telah membuka situs web aplikasi dan ingin mengautentikasi.  Untuk melakukan ini, ia mengirim permintaan dengan login dan kata sandi.  Dalam database organisasi mana yang mencari pengguna ini? </p><br><p>  Juga, permintaan anonim akan diterima untuk mendapatkan halaman login ke aplikasi, dan mungkin berbeda untuk organisasi yang berbeda, misalnya, bahasa lokalisasi. </p><br><p>  Untuk mengatasi masalah korelasi antara permintaan http-anonim dan organisasi (penyewa), kami menggunakan subdomain untuk organisasi.  Nama subdomain dibentuk oleh nama organisasi.  Pengguna harus menggunakan subdomain untuk bekerja dengan sistem: </p><br><pre> <code class="plaintext hljs">https://company1.service.com https://company2.service.com</code> </pre> <br><p>  Layanan web multi-penyewa yang sama tersedia di alamat ini.  Tapi sekarang layanan memahami dari mana organisasi permintaan http anonim akan datang, dengan fokus pada nama domain. <br>  Pengikatan nama domain dan penyewa dilakukan dalam file konfigurasi layanan web: </p><br><pre> <code class="json hljs">&lt;tenant name=<span class="hljs-string"><span class="hljs-string">"company1"</span></span> db=<span class="hljs-string"><span class="hljs-string">"database1"</span></span> host=<span class="hljs-string"><span class="hljs-string">"company1.service.com"</span></span> /&gt; &lt;tenant name=<span class="hljs-string"><span class="hljs-string">"company2"</span></span> db=<span class="hljs-string"><span class="hljs-string">"database2"</span></span> host=<span class="hljs-string"><span class="hljs-string">"company2.service.com"</span></span> /&gt;</code> </pre> <br><p>  Tentang mengkonfigurasi layanan akan dijelaskan di bawah ini. </p><br><h2 id="mikroservisy-hranenie-dannyh">  Layanan microser.  Penyimpanan data </h2><br><p>  Ketika saya mengatakan bahwa sistem ECM membutuhkan 100 tabel, saya berbicara tentang layanan monolitik.  Tetapi kebetulan bahwa suatu layanan microser memerlukan penyimpanan relasional, di mana 2-3 tabel diperlukan untuk menyimpan datanya.  Idealnya, setiap microservice memiliki penyimpanan sendiri, yang hanya dapat diakses olehnya.  Dan layanan mikro memutuskan bagaimana menyimpan data dalam konteks penyewa. </p><br><p>  Tapi kami pergi ke arah lain: kami memutuskan untuk menyimpan semua data organisasi dalam satu database.  Jika suatu layanan mikro memerlukan penyimpanan relasional, maka ia menggunakan basis data organisasi yang ada sehingga data tidak tersebar di berbagai penyimpanan, tetapi dikumpulkan dalam satu basis data.  Layanan monolitik menggunakan database yang sama. </p><br><p>  Layanan microser hanya bekerja dengan tabel mereka di database, dan jangan mencoba untuk bekerja dengan tabel monolith atau layanan microser lainnya.  Ada pro dan kontra untuk pendekatan ini. </p><br><p>  Pro: </p><br><ul><li>  data organisasi di satu tempat; </li><li>  mudah membuat cadangan dan memulihkan data organisasi; </li><li>  Dalam cadangan, data semua layanan konsisten. </li></ul><br><p>  Cons: </p><br><ul><li>  satu database untuk semua layanan adalah leher sempit ketika penskalaan (persyaratan untuk sumber daya DBMS meningkat); </li><li>  microservices memiliki akses fisik ke tabel masing-masing, tetapi jangan gunakan fitur ini. </li></ul><br><h2 id="mikroservisy-znanie-o-tenantah-ne-vsegda-trebuetsya">  Layanan microser.  Pengetahuan tentang penyewa tidak selalu dibutuhkan. </h2><br><p>  Layanan Microsoft mungkin tidak tahu bahwa ia berfungsi di lingkungan multi-penyewa.  Pertimbangkan salah satu layanan kami, yang terlibat dalam mengonversi dokumen menjadi html. </p><br><p>  Apa layanan ini: </p><br><ol><li>  Mengambil pesan dari antrian RabbitMQ untuk mengonversi dokumen. <br><ul><li>  mengambil pengidentifikasi dokumen dan penyewa penyewa dari pesan </li></ul></li><li>  Unduh dokumen dari layanan penyimpanan dokumen. <br><ul><li>  untuk ini menghasilkan permintaan di mana ia mengirimkan pengidentifikasi dokumen dan pengidentifikasi penyewa </li></ul></li><li>  Mengonversi dokumen menjadi html. </li><li>  Memberikan html ke layanan untuk menyimpan hasil konversi. </li></ol><br><p>  Layanan tidak menyimpan dokumen dan tidak menyimpan hasil konversi.  Dia memiliki pengetahuan tidak langsung tentang penyewa: pengidentifikasi penyewa melewati layanan dalam perjalanan. </p><br><h2 id="mikroservisy-poddomeny-ne-nuzhny">  Layanan microser.  Subdomain tidak diperlukan </h2><br><p>  Saya menulis di atas bahwa subdomain membantu menyelesaikan masalah permintaan http anonim: </p><br><pre> <code class="plaintext hljs">https://company1.service.com https://company2.service.com</code> </pre> <br><p>  Tetapi tidak semua layanan berfungsi dengan permintaan anonim, sebagian besar memerlukan otentikasi yang sudah terlewati.  Oleh karena itu, layanan microser yang berfungsi melalui http sering tidak peduli dari hostName apa permintaan berasal, mereka menerima semua informasi tentang penyewa dari token JWT atau cookie otentikasi yang datang dengan setiap permintaan. </p><br><h2 id="konfigurirovanie">  Konfigurasi </h2><br><p>  Layanan perlu dikonfigurasi agar mereka tahu tentang penyewa.  Yaitu: </p><br><ul><li>  tentukan string untuk menghubungkan ke basis data penyewa; </li><li>  ikat nama domain ke penyewa; </li><li>  tentukan bahasa default dan zona waktu penyewa. </li></ul><br><p>  Penyewa dapat memiliki banyak pengaturan.  Untuk layanan kami, kami menetapkan pengaturan penyewa dalam file konfigurasi xml.  Ini bukan web.config dan bukan app.config.  Ini adalah file xml terpisah, yang perubahannya harus dapat ditangkap tanpa me-reboot layanan sehingga menambahkan penyewa baru tidak me-restart seluruh sistem. </p><br><p>  Daftar pengaturannya kira-kira seperti ini: </p><br><pre> <code class="xml hljs"><span class="hljs-comment"><span class="hljs-comment">&lt;!--  . --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">block</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TENANTS"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tenant</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Jupiter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">db</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DirectumRX_Jupiter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">login</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"admin"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">password</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkUriScheme</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"jupiter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkFileExtension</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".jupiter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkServer</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://jupiter-rx.directum.ru/Sungero"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">helpAddress</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://jupiter-rx.directum.ru/Sungero/help"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">devHelpAddress</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://jupiter-rx.directum.ru/Sungero/dev_help"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">language</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Ru-ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">isAttributesSignatureAbsenceAllowed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">endorsingSignatureLocksSignedProperties</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">administratorEmail</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"admin@jupiter-company.ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">feedbackEmail</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"support@jupiter-company.ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">isSendFeedbackAllowed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">serviceUserPassword</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">utcOffset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"5"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">collaborativeEditingEnabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">collaborativeEditingForced</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tenant</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Mars"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">db</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DirectumRX_Mars"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">login</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"admin"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">password</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkUriScheme</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"mars"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkFileExtension</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".mars"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkServer</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://mars-rx.directum.ru/Sungero"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">helpAddress</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://mars-rx.directum.ru/Sungero/help"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">devHelpAddress</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://mars-rx.directum.ru/Sungero/dev_help"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">language</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Ru-ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">isAttributesSignatureAbsenceAllowed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">endorsingSignatureLocksSignedProperties</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">administratorEmail</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"root@mars-ooo.ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">feedbackEmail</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"support@mars-ooo.ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">isSendFeedbackAllowed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">serviceUserPassword</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">utcOffset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"-1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">collaborativeEditingEnabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">collaborativeEditingForced</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">block</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Ketika organisasi baru menyewakan layanan, ia perlu menambahkan penyewa baru ke file konfigurasi untuknya.  Dan diharapkan bahwa organisasi lain tidak merasakan ini.  Idealnya, tidak boleh ada restart layanan. </p><br><p>  Pada kami, tidak semua layanan dapat mengambil konfigurasi tanpa memulai ulang, tetapi layanan yang paling penting (monolith) dapat melakukan ini. </p><br><h2 id="itog">  Ringkasan </h2><br><p>  Ketika sebuah aplikasi menjadi multi-tenant, tampaknya kompleksitas pengembangan telah meningkat secara dramatis.  Tetapi kemudian Anda terbiasa dengan multitenantness, dan memperlakukan dukungannya sebagai persyaratan normal. </p><br><p>  Perlu juga diingat bahwa multi-tenancy tidak hanya pengembangan, tetapi juga pengujian, administrasi, penyebaran, pemutakhiran, pencadangan, migrasi data.  Tapi lebih baik tentang mereka lain kali. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id483784/">https://habr.com/ru/post/id483784/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id483768/index.html">MVCC di PostgreSQL-5. Vakum dalam halaman dan pembaruan HOT</a></li>
<li><a href="../id483774/index.html">Intisari acara untuk profesional SDM di bidang TI untuk Januari 2020</a></li>
<li><a href="../id483776/index.html">Pengantar metode diferensial semantik dalam 5 menit</a></li>
<li><a href="../id483778/index.html">Minggu Keamanan 03: Prinsip-prinsip Laporan Bug yang Bertanggung Jawab</a></li>
<li><a href="../id483780/index.html">Apa itu Kendur dan Bagaimana Cara Kerjanya?</a></li>
<li><a href="../id483786/index.html">Sortasi Hibrid</a></li>
<li><a href="../id483788/index.html">Negara kepulauan kecil menghasilkan berkat Twitch</a></li>
<li><a href="../id483790/index.html">Catatan dari penyedia IoT. Teknologi dan ekonomi LoRaWAN dalam pencahayaan perkotaan</a></li>
<li><a href="../id483794/index.html">Meninggalkan: mengapa Anda tidak mengambil kontroffer</a></li>
<li><a href="../id483796/index.html">Parameter Opsional dalam Repositori Data Musim Semi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>