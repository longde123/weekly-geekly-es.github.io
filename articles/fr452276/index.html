<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üâê ü§Ø „Ä∞Ô∏è Ing√©nierie inverse du client Dropbox üà∑Ô∏è üëµüèΩ üïç</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="TL; DR. L'article parle du d√©veloppement inverse du client Dropbox, du piratage des m√©canismes d'obscurcissement et de d√©compilation du client en Pyth...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ing√©nierie inverse du client Dropbox</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/452276/">  <i>TL; DR.</i>  <i>L'article parle du d√©veloppement inverse du client Dropbox, du piratage des m√©canismes d'obscurcissement et de d√©compilation du client en Python, ainsi que de la modification du programme pour activer les fonctions de d√©bogage masqu√©es en mode normal.</i>  <i>Si vous n'√™tes int√©ress√© que par le code et les instructions appropri√©s, faites d√©filer jusqu'√† la fin.</i>  <i>Au moment d'√©crire ces lignes, le code est compatible avec les derni√®res versions de Dropbox bas√©es sur l'interpr√©teur CPython 3.6.</i> <br><br><h3>  Pr√©sentation </h3><br>  Dropbox m'a tout de suite fascin√©.  Le concept est encore d'une simplicit√© trompeuse.  Voici le dossier.  Mettez-y des fichiers.  Il est synchronis√©.  Aller sur un autre appareil.  Il est √† nouveau synchronis√©.  Le dossier et les fichiers y sont √©galement apparus! <br><br>  La quantit√© de travail d'arri√®re-plan cach√© est vraiment incroyable.  Tout d'abord, tous les probl√®mes que vous devez g√©rer lors de la cr√©ation et de la maintenance d'une application multiplateforme pour les principaux syst√®mes d'exploitation de bureau (OS X, Linux, Windows) ne disparaissent pas.  Ajoutez √† cela la prise en charge de divers navigateurs Web, de divers syst√®mes d'exploitation mobiles.  Et nous ne parlons que du c√¥t√© client.  Je suis √©galement int√©ress√© par le backend Dropbox, qui m'a permis d'atteindre une telle √©volutivit√© et une faible latence avec la charge de travail incroyablement lourde cr√©√©e par un demi-milliard d'utilisateurs. <br><a name="habracut"></a><br>  C'est pour ces raisons que j'ai toujours aim√© regarder ce que Dropbox fait sous le capot et comment il a √©volu√© au fil des ans.  Il y a environ huit ans, j'ai d'abord essay√© de savoir comment fonctionnait le client Dropbox lorsque j'ai remarqu√© la diffusion d'un trafic inconnu √† l'h√¥tel.  L'enqu√™te a montr√© que cela faisait partie de la fonctionnalit√© Dropbox appel√©e LanSync, qui vous permet de synchroniser plus rapidement si les h√¥tes Dropbox sur le m√™me LAN ont acc√®s aux m√™mes fichiers.  Cependant, le protocole n'√©tait pas document√© et je voulais en savoir plus.  Par cons√©quent, j'ai d√©cid√© de jeter un coup d'≈ìil plus en d√©tail et, par cons√©quent, j'ai effectu√© l'ing√©nierie inverse de presque tout le programme.  Cette √©tude n'a jamais √©t√© publi√©e, m√™me si j'ai parfois partag√© des notes avec certaines personnes. <br><br>  Lorsque nous avons ouvert Anvil Ventures, Chris et moi avons appr√©ci√© un certain nombre d'outils pour le stockage, le partage et la collaboration de documents.  √âvidemment, l'un d'eux √©tait Dropbox, et pour moi, c'est une autre raison de d√©terrer les anciennes √©tudes et de les v√©rifier sur la version actuelle du client. <br><br><h3>  D√©cryptage et d√©sobfuscation </h3><br>  Tout d'abord, j'ai t√©l√©charg√© le client pour Linux et j'ai rapidement d√©couvert qu'il √©tait √©crit en Python.  √âtant donn√© que la licence Python est assez permissive, il est facile pour les gens de modifier et de distribuer l'interpr√©teur Python avec d'autres d√©pendances comme les logiciels commerciaux.  J'ai ensuite commenc√© l'ing√©nierie inverse pour comprendre comment fonctionne le client. <br><br>  A cette √©poque, les fichiers avec le bytecode √©taient dans un fichier ZIP combin√© √† un binaire ex√©cutable.  Le binaire principal √©tait juste un interpr√©teur Python modifi√© qui a √©t√© charg√© en capturant les m√©canismes d'importation Python.  Chaque appel d'importation suivant a √©t√© redirig√© vers ce binaire avec une analyse de fichier ZIP.  Bien s√ªr, il est facile d'extraire ce ZIP du binaire.  Par exemple, l'outil <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">binwalk</a> utile le r√©cup√®re avec tous les fichiers .pyc compil√©s en octets. <br><br>  Ensuite, je n'ai pas pu casser le cryptage des fichiers .pyc, mais √† la fin j'ai pris l'objet g√©n√©ral de la biblioth√®que Python standard et l'ai recompil√©, en injectant une porte d√©rob√©e √† l'int√©rieur.  Maintenant que le client Dropbox chargeait cet objet, je pouvais facilement ex√©cuter du code Python arbitraire dans un interpr√©teur fonctionnel.  Bien que je l'ai d√©couvert par moi-m√™me, Florian Leda et Nicolas Raff ont utilis√© la m√™me m√©thode lors d'une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pr√©sentation</a> sur Hack.lu en 2012. <br><br>  La possibilit√© d'explorer et de manipuler du code en cours d'ex√©cution dans Dropbox a beaucoup r√©v√©l√©.  Le code a utilis√© plusieurs astuces de protection pour rendre difficile le vidage d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">objets de code</a> .  Par exemple, dans un interpr√©teur CPython standard, il est facile de r√©cup√©rer un bytecode compil√© repr√©sentant une fonction.  Un exemple simple: <br><br><pre><code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> i * i ... &gt;&gt;&gt; f.__code__ &lt;code object f at <span class="hljs-number"><span class="hljs-number">0x109deb540</span></span>, file <span class="hljs-string"><span class="hljs-string">"&lt;stdin&gt;"</span></span>, line <span class="hljs-number"><span class="hljs-number">1</span></span>&gt; &gt;&gt;&gt; f.__code__.co_code <span class="hljs-string"><span class="hljs-string">b'|\x00|\x00\x14\x00S\x00'</span></span> &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> dis &gt;&gt;&gt; dis.dis(f) <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> LOAD_FAST <span class="hljs-number"><span class="hljs-number">0</span></span> (i) <span class="hljs-number"><span class="hljs-number">2</span></span> LOAD_FAST <span class="hljs-number"><span class="hljs-number">0</span></span> (i) <span class="hljs-number"><span class="hljs-number">4</span></span> BINARY_MULTIPLY <span class="hljs-number"><span class="hljs-number">6</span></span> RETURN_VALUE &gt;&gt;&gt;</code> </pre> <br>  Mais dans la version compil√©e d' <i>Objects / codeobject.c, la</i> propri√©t√© <i>co_code a</i> <code>co_code</code> supprim√©e de la liste ouverte.  Cette liste de membres ressemble g√©n√©ralement √† ceci: <br><br><pre> <code class="python hljs"> static PyMemberDef code_memberlist[] = { ... {<span class="hljs-string"><span class="hljs-string">"co_flags"</span></span>, T_INT, OFF(co_flags), READONLY}, {<span class="hljs-string"><span class="hljs-string">"co_code"</span></span>, T_OBJECT, OFF(co_code), READONLY}, {<span class="hljs-string"><span class="hljs-string">"co_consts"</span></span>, T_OBJECT, OFF(co_consts), READONLY}, ... };</code> </pre> <br>  La disparition de la propri√©t√© <code>co_code</code> rend impossible le vidage de ces objets de code. <br><br>  De plus, d'autres biblioth√®ques, comme le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©sassembleur</a> Python standard, ont √©t√© supprim√©es.  Au final, j'ai quand m√™me r√©ussi √† vider les objets de code dans des fichiers, mais je n'ai toujours pas pu les d√©compiler.  Il m'a fallu un certain temps avant de r√©aliser que les opcodes utilis√©s par l'interpr√©teur Dropbox ne correspondent pas aux opcodes standard de Python.  Ainsi, il √©tait n√©cessaire de comprendre les nouveaux opcodes afin de r√©√©crire les objets de code dans le bytecode Python d'origine. <br><br>  Une option est le remappage opcode.  Pour autant que je sache, cette technique a √©t√© d√©velopp√©e par Rich Smith et introduite au <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Defcon 18</a> .  Dans cette conf√©rence, il a √©galement montr√© l'outil <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pyREtic</a> pour la r√©tro-ing√©nierie du bytecode Python en m√©moire.  Il semble que le code pyREtic soit mal support√©, et l'outil cible les "anciens" binaires Python 2.x.  Pour se familiariser avec les techniques d√©velopp√©es par Rich, il est fortement recommand√© de regarder sa performance. <br><br>  La m√©thode de traduction opcode prend tous les objets de code de la biblioth√®que Python standard et les compare aux objets extraits du binaire Dropbox.  Par exemple, <i>codez les</i> objets de <i>hashlib.pyc</i> ou <i>socket.pyc</i> , qui se trouvent dans la biblioth√®que standard.  Disons que si chaque fois que l'opcode <code>0x43</code> correspond √† l' <code>0x21</code> 0x21 d√©sobfusqu√©, nous pouvons progressivement construire une table de traduction pour r√©√©crire les objets de code.  Ces objets de code peuvent ensuite √™tre transmis via le d√©compilateur Python.  Pour vider, vous avez toujours besoin d'un interpr√©teur corrig√© avec le bon objet <code>co_code</code> . <br><br>  Une autre option consiste √† pirater le format de s√©rialisation.  En Python, la s√©rialisation est appel√©e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">marshaling</a> .  La d√©s√©rialisation des fichiers obscurcis de la mani√®re habituelle n'a pas fonctionn√©.  Lors de l'ing√©nierie inverse du binaire dans IDA Pro, j'ai d√©couvert l'√©tape de d√©cryptage.  Pour autant que je sache, le premier √† publier publiquement quelque chose √† ce sujet a √©t√© Hagen Fritch sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">son blog</a> .  L√†, il fait r√©f√©rence aux changements dans les nouvelles versions de Dropbox (lorsque Dropbox est pass√© de Python 2.5 √† Python 2.7).  L'algorithme fonctionne comme suit: <br><br><ul><li>  Lors du d√©ballage d'un fichier pyc, un en-t√™te est lu pour d√©terminer la version du marshaling.  Ce format n'est pas document√©, √† l'exception de l'impl√©mentation de CPython lui-m√™me. <br></li><li>  Le format d√©finit une liste de types qui y sont encod√©s.  Types <code>True</code> , <code>False</code> , <code>floats</code> , etc., mais le plus important est le type des <code>code object</code> Python ci-dessus, <code>code object</code> . <br></li><li>  Lors du chargement de l' <code>code object</code> , deux valeurs suppl√©mentaires sont d'abord lues dans le fichier d'entr√©e. <br></li><li>  Le premier est la valeur <code>random</code> 32 bits. <br></li><li>  Le second est une valeur de <code>length</code> 32 bits indiquant la taille de l'objet de code s√©rialis√©. <br></li><li>  Ensuite, les valeurs de <code>rand</code> et de <code>length</code> sont <code>rand</code> √† une simple fonction RNG qui g√©n√®re des <code>seed</code> . <br></li><li>  Cette graine est livr√©e au <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vortex de Mersenne</a> , qui g√©n√®re quatre valeurs 32 bits. <br></li><li>  Combin√©es ensemble, ces quatre valeurs fournissent une cl√© de chiffrement pour les donn√©es s√©rialis√©es.  L'algorithme de chiffrement d√©chiffre ensuite les donn√©es √† l'aide de l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">algorithme de chiffrement minuscule</a> . </li></ul><br>  Dans mon code, j'ai √©crit la proc√©dure de d√©masquage Python √† partir de z√©ro.  La partie qui d√©chiffre les objets de code ressemble √† quelque chose comme le fragment ci-dessous.  Il est √† noter que cette m√©thode devra √™tre appel√©e r√©cursivement.  L'objet de niveau sup√©rieur pour un fichier pyc est un objet de code qui contient lui-m√™me des objets de code, qui peuvent √™tre des classes, des fonctions ou des lambdas.  √Ä leur tour, ils peuvent √©galement contenir des m√©thodes, des fonctions ou des lambdas.  Ce sont tous des objets de code dans la hi√©rarchie! <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load_code</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> rand = self.r_long() length = self.r_long() seed = rng(rand, length) mt = MT19937(seed) key = [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>): key.append(mt.extract_number()) <span class="hljs-comment"><span class="hljs-comment"># take care of padding for size calculation sz = (length + 15) &amp; ~0xf words = sz / 4 # convert data to list of dwords buf = self._read(sz) data = list(struct.unpack("&lt;%dL" % words, buf)) # decrypt and convert back to stream of bytes data = tea.tea_decipher(data, key) data = struct.pack("&lt;%dL" % words, *data)</span></span></code> </pre> <br>  La possibilit√© de d√©chiffrer les objets de code signifie qu'apr√®s d√©s√©rialisation des proc√©dures, vous devez r√©√©crire le code d'octets r√©el.  Les objets de code contiennent des informations sur les num√©ros de ligne, les constantes et d'autres informations.  Le bytecode r√©el se trouve dans l'objet <code>co_code</code> .  Lorsque nous avons cr√©√© la table de traduction d'opcode, nous pouvons simplement remplacer les valeurs Dropbox masqu√©es par les √©quivalents Python 3.6 standard. <br><br>  Maintenant, les objets de code sont au format Python 3.6 habituel, et ils peuvent √™tre pass√©s au d√©compilateur.  La qualit√© des d√©compilateurs Python a consid√©rablement augment√© gr√¢ce au projet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">uncompyle6 de</a> R. Bernstein.  La d√©compilation a donn√© un assez bon r√©sultat, et j'ai pu tout rassembler dans un outil qui d√©compile la version actuelle du client Dropbox au mieux de ses capacit√©s. <br><br>  Si vous clonez ce <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©f√©rentiel</a> et suivez les instructions, le r√©sultat sera quelque chose comme ceci: <br><br><pre>  ...
     __main__ - INFO - Dropbox / client / features / Browse_search / __ init __. pyc d√©compil√© avec succ√®s
     __main__ - INFO - D√©chiffrement, correction et d√©compilation _bootstrap_overrides.pyc
     __main__ - INFO - D√©compilation r√©ussie de _bootstrap_overrides.pyc
     __main__ - INFO - 3713 fichiers trait√©s (3591 d√©compil√©s avec succ√®s, 122 √©checs)
     opcodemap - AVERTISSEMENT - NE PAS √©crire de carte d'opcode car l'√©crasement forc√© n'est pas d√©fini </pre><br>  Cela signifie que vous avez maintenant un r√©pertoire <code>out/</code> avec une version d√©compil√©e du code source Dropbox. <br><br><h3>  Activation du suivi Dropbox </h3><br>  Dans l'open source, j'ai commenc√© √† chercher quelque chose d'int√©ressant, et le fragment suivant a attir√© mon attention.  Les gestionnaires de trace dans <code>out/dropbox/client/high_trace.py</code> sont install√©s uniquement si l'assembly n'est pas fig√© ou si la cl√© magique ou le cookie limitant la fonctionnalit√© n'est pas d√©fini √† la ligne <code>1430</code> . <br><br><pre> <code class="python hljs"> <span class="hljs-number"><span class="hljs-number">1424</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">install_global_trace_handlers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(flags=None, args=None)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-number"><span class="hljs-number">1425</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> _tracing_initialized <span class="hljs-number"><span class="hljs-number">1426</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> _tracing_initialized: <span class="hljs-number"><span class="hljs-number">1427</span></span> TRACE(<span class="hljs-string"><span class="hljs-string">'!! Already enabled tracing system'</span></span>) <span class="hljs-number"><span class="hljs-number">1428</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1429</span></span> _tracing_initialized = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-number"><span class="hljs-number">1430</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> build_number.is_frozen() <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> magic_trace_key_is_set() <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> limited_support_cookie_is_set(): <span class="hljs-number"><span class="hljs-number">1431</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> os.getenv(<span class="hljs-string"><span class="hljs-string">'DBNOLOCALTRACE'</span></span>): <span class="hljs-number"><span class="hljs-number">1432</span></span> add_trace_handler(db_thread(LtraceThread)().trace) <span class="hljs-number"><span class="hljs-number">1433</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> os.getenv(<span class="hljs-string"><span class="hljs-string">'DBTRACEFILE'</span></span>): <span class="hljs-number"><span class="hljs-number">1434</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre> <br>  La mention de versions fig√©es fait r√©f√©rence aux versions de d√©bogage interne de Dropbox.  Et un peu plus haut dans le m√™me fichier, vous pouvez trouver de telles lignes: <br><br><pre> <code class="python hljs"> <span class="hljs-number"><span class="hljs-number">272</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_valid_time_limited_cookie</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cookie)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-number"><span class="hljs-number">273</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-number"><span class="hljs-number">274</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-number"><span class="hljs-number">275</span></span> t_when = int(cookie[:<span class="hljs-number"><span class="hljs-number">8</span></span>], <span class="hljs-number"><span class="hljs-number">16</span></span>) ^ <span class="hljs-number"><span class="hljs-number">1686035233</span></span> <span class="hljs-number"><span class="hljs-number">276</span></span> <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> ValueError: <span class="hljs-number"><span class="hljs-number">277</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-number"><span class="hljs-number">278</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-number"><span class="hljs-number">279</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> abs(time.time() - t_when) &lt; SECONDS_PER_DAY * <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> md5(make_bytes(cookie[:<span class="hljs-number"><span class="hljs-number">8</span></span>]) + <span class="hljs-string"><span class="hljs-string">b'traceme'</span></span>).hexdigest()[:<span class="hljs-number"><span class="hljs-number">6</span></span>] == cookie[<span class="hljs-number"><span class="hljs-number">8</span></span>:]: <span class="hljs-number"><span class="hljs-number">280</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-number"><span class="hljs-number">281</span></span> <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Exception: <span class="hljs-number"><span class="hljs-number">282</span></span> report_exception() <span class="hljs-number"><span class="hljs-number">283</span></span> <span class="hljs-number"><span class="hljs-number">284</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-number"><span class="hljs-number">285</span></span> <span class="hljs-number"><span class="hljs-number">286</span></span> <span class="hljs-number"><span class="hljs-number">287</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">limited_support_cookie_is_set</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-number"><span class="hljs-number">288</span></span> dbdev = os.getenv(<span class="hljs-string"><span class="hljs-string">'DBDEV'</span></span>) <span class="hljs-number"><span class="hljs-number">289</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dbdev <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> is_valid_time_limited_cookie(dbdev) build_number/environment.py</code> </pre> <br>  Comme vous pouvez le voir dans la m√©thode <code>limited_support_cookie_is_set</code> √† la ligne <code>287</code> , le tra√ßage n'est activ√© que si la variable d'environnement nomm√©e <code>DBDEV</code> correctement d√©finie sur les cookies avec une dur√©e de vie limit√©e.  Et bien c'est int√©ressant!  Et maintenant, nous savons comment g√©n√©rer de tels cookies √† dur√©e limit√©e.  √Ä en juger par le nom, les ing√©nieurs de Dropbox peuvent g√©n√©rer de tels cookies, puis activer temporairement le tra√ßage dans certains cas, lorsque cela est n√©cessaire pour prendre en charge les clients.  Apr√®s avoir red√©marr√© Dropbox ou red√©marr√© l'ordinateur, m√™me si le cookie sp√©cifi√© est toujours en place, il expirera automatiquement.  Je suppose que cela devrait emp√™cher, par exemple, la d√©gradation des performances due au suivi continu.  Cela rend √©galement difficile l'ing√©nierie inverse de Dropbox. <br><br>  Cependant, un petit script peut simplement g√©n√©rer et d√©finir constamment ces cookies.  Quelque chose comme √ßa: <br><br><pre> <code class="python hljs"> <span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python3 def output_env(name, value): print("%s=%s; export %s" % (name, value, name)) def generate_time_cookie(): t = int(time.time()) c = 1686035233 s = "%.8x" % (t ^ c) h = md5(s.encode("utf-8?") + b"traceme").hexdigest() ret = "%s%s" % (s, h[:6]) return ret c = generate_time_cookie() output_env("DBDEV", c)</span></span></code> </pre> <br>  Ensuite, un cookie temporel est cr√©√©: <br><br><pre> <code class="python hljs"> $ python3 setenv.py DBDEV=<span class="hljs-number"><span class="hljs-number">38</span></span>b28b3f349714; export DBDEV;</code> </pre> <br>  Chargez ensuite correctement la sortie de ce script dans l'environnement et ex√©cutez le client Dropbox. <br><br><pre> <code class="python hljs"> $ eval `python3 setenv.py` $ ~/.dropbox-dist/dropbox-lnx_64<span class="hljs-number"><span class="hljs-number">-71.4</span></span><span class="hljs-number"><span class="hljs-number">.108</span></span>/dropbox</code> </pre> <br>  Cela inclut la sortie de trace, avec un formatage color√© et tout √ßa.  Il ressemble √† ce client non enregistr√©: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e83/d0a/a4f/e83d0aa4f475709108cb1cfc0cb16d74.png"><br><br><h3>  Impl√©menter un nouveau code </h3><br>  Tout √ßa est un peu dr√¥le.  En √©tudiant le code d√©compil√© plus loin, nous d√©couvrons <code>out/build_number/environment.pyc</code> .  Il existe une fonction qui v√©rifie si une certaine cl√© magique est install√©e.  Cette cl√© n'est pas cod√©e en dur dans le code, mais est compar√©e au hachage SHA-256.  Voici l'extrait correspondant. <br><br><pre> <code class="python hljs"> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> hashlib, os <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> typing <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Optional, Text <span class="hljs-number"><span class="hljs-number">3</span></span> _MAGIC_TRACE_KEY_IS_SET = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">magic_trace_key_is_set</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> _MAGIC_TRACE_KEY_IS_SET <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> _MAGIC_TRACE_KEY_IS_SET <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span> dbdev = os.getenv(<span class="hljs-string"><span class="hljs-string">'DBDEV'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(dbdev, Text): <span class="hljs-number"><span class="hljs-number">10</span></span> bytes_dbdev = dbdev.encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>) <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-number"><span class="hljs-number">12</span></span> bytes_dbdev = dbdev <span class="hljs-number"><span class="hljs-number">13</span></span> dbdev_hash = hashlib.sha256(bytes_dbdev).hexdigest() <span class="hljs-number"><span class="hljs-number">14</span></span> _MAGIC_TRACE_KEY_IS_SET = dbdev_hash == <span class="hljs-string"><span class="hljs-string">'e27eae61e774b19f4053361e523c771a92e838026da42c60e6b097d9cb2bc825'</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _MAGIC_TRACE_KEY_IS_SET</code> </pre> <br>  Cette m√©thode est appel√©e plusieurs fois √† diff√©rents endroits du code pour v√©rifier si la cl√© de trace magique est d√©finie.  J'ai essay√© de casser le hachage SHA-256 avec la force brute de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">John the Ripper</a> , mais une force brute simple a pris trop de temps, et je n'ai pas pu r√©duire le nombre d'options car il n'y avait aucune supposition sur le contenu.  Dans Dropbox, les d√©veloppeurs peuvent avoir une cl√© de d√©veloppement cod√©e en dur sp√©cifique, qu'ils installent si n√©cessaire, activant le mode ¬´cl√© magique¬ª du client pour le tra√ßage. <br><br>  Cela m'a ennuy√© parce que je voulais trouver un moyen rapide et facile de lancer Dropbox avec cet ensemble de cl√©s pour le tra√ßage.  J'ai donc √©crit une proc√©dure de marshaling qui g√©n√®re des fichiers pyc crypt√©s selon le cryptage Dropbox.  Ainsi, j'ai pu entrer mon propre code ou simplement remplacer le hachage ci-dessus.  Ce code dans le r√©f√©rentiel Github se trouve dans le fichier <code>patchzip.py</code> .  Par cons√©quent, le hachage est remplac√© par le hachage SHA-256 d' <code>ANVILVENTURES</code> .  Ensuite, l'objet code est rechiffr√© et plac√© dans un zip, o√π tout le code obscurci est stock√©.  Cela vous permet d'effectuer les op√©rations suivantes: <br><br><pre>  $ DBDEV = ANVILVENTURES;  export DBDEV;
     $ ~ / .dropbox-dist / dropbox-lnx_64-71.4.108 / dropbox </pre><br>  Toutes les fonctions de d√©bogage s'affichent d√©sormais lorsque vous cliquez avec le bouton droit sur l'ic√¥ne Dropbox dans la barre d'√©tat syst√®me. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/619/c68/385/619c6838574ff7023a0dbdf27b880b2d.png"></div><br><br>  En √©tudiant plus en d√©tail les sources d√©compil√©es, dans le fichier <code>dropbox/webdebugger/server.py</code> j'ai d√©couvert une m√©thode appel√©e <code>is_enabled</code> .  Il semble qu'il v√©rifie s'il faut activer le d√©bogueur Web int√©gr√©.  Tout d'abord, il v√©rifie la cl√© magique mentionn√©e.  Puisque nous avons remplac√© le hachage SHA-256, nous pouvons simplement d√©finir la valeur sur <code>ANVILVENTURES</code> .  La deuxi√®me partie des lignes <code>201</code> et <code>202</code> v√©rifie s'il existe une variable d'environnement nomm√©e <code>DB&lt;x&gt;</code> qui a <code>x</code> √©gal au hachage SHA-256.  La valeur de l'environnement d√©finit des cookies √† dur√©e limit√©e, comme nous l'avons d√©j√† vu. <br><br><pre> <code class="python hljs"> <span class="hljs-number"><span class="hljs-number">191</span></span> @classmethod <span class="hljs-number"><span class="hljs-number">192</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_enabled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-number"><span class="hljs-number">193</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> cls._magic_key_set: <span class="hljs-number"><span class="hljs-number">194</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cls._magic_key_set <span class="hljs-number"><span class="hljs-number">195</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-number"><span class="hljs-number">196</span></span> cls._magic_key_set = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-number"><span class="hljs-number">197</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> magic_trace_key_is_set(): <span class="hljs-number"><span class="hljs-number">198</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-number"><span class="hljs-number">199</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> var <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> os.environ: <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> var.startswith(<span class="hljs-string"><span class="hljs-string">'DB'</span></span>): <span class="hljs-number"><span class="hljs-number">201</span></span> var_hash = hashlib.sha256(make_bytes(var[<span class="hljs-number"><span class="hljs-number">2</span></span>:])).hexdigest() <span class="hljs-number"><span class="hljs-number">202</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> var_hash == <span class="hljs-string"><span class="hljs-string">'5df50a9c69f00ac71f873d02ff14f3b86e39600312c0b603cbb76b8b8a433d3ff0757214287b25fb01'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> is_valid_time_limited_cookie(os.environ[var]): <span class="hljs-number"><span class="hljs-number">203</span></span> cls._magic_key_set = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-number"><span class="hljs-number">204</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-number"><span class="hljs-number">205</span></span> <span class="hljs-number"><span class="hljs-number">206</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span></code> </pre> <br>  En utilisant exactement la m√™me technique, en rempla√ßant ce hachage par le SHA-256 qui √©tait utilis√© auparavant, nous pouvons maintenant changer le script <code>setenv</code> pr√©c√©demment √©crit en quelque chose comme ceci: <br><br><pre> <code class="python hljs"> $ cat setenv.py ‚Ä¶ c = generate_time_cookie() output_env(<span class="hljs-string"><span class="hljs-string">"DBDEV"</span></span>, <span class="hljs-string"><span class="hljs-string">"ANVILVENTURES"</span></span>) output_env(<span class="hljs-string"><span class="hljs-string">"DBANVILVENTURES"</span></span>, c) $ python3 setenv.py DBDEV=ANVILVENTURES; export DBDEV; DBANVILVENTURES=<span class="hljs-number"><span class="hljs-number">38</span></span>b285c4034a67; export DBANVILVENTURES $ eval `python3 setenv.py` $ ~/.dropbox-dist/dropbox-lnx_64<span class="hljs-number"><span class="hljs-number">-71.4</span></span><span class="hljs-number"><span class="hljs-number">.108</span></span>/dropbox</code> </pre> <br>  Comme vous pouvez le voir, apr√®s le d√©marrage du client, un nouveau port TCP s'ouvre pour l'√©coute.  Il ne s'ouvrira pas si les variables d'environnement ne sont pas d√©finies correctement. <br><br><pre>  $ netstat --tcp -lnp |  grep dropbox
     tcp 0 0127.0.0.1:4242 0.0.0.0:* LISTEN 1517 / dropbox </pre><br>  Plus loin dans le code, vous pouvez trouver l'interface WebSocket dans le fichier <code>webpdb.pyc</code> .  Il s'agit d'un wrapper pour les utilitaires <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pdb</a> python standard.  L'acc√®s √† l'interface se fait via un serveur HTTP sur ce port.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Installons le client websocket</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">essayons</a> -le: <br><br><pre>  $ websocat -t ws: //127.0.0.1: 4242 / pdb
     --Retour--
    
     &gt; /home/gvb/dropbox/webdebugger/webpdb.pyc(101)run()-&gt;Aucun
     &gt;
     (Pdb) depuis build_number.environment import magic_trace_key_is_set as ms
     (Pdb) ms ()
     Vrai </pre><br>  Ainsi, nous avons maintenant un d√©bogueur √† part enti√®re dans le client, qui √† tous les autres √©gards fonctionne comme avant.  Nous pouvons ex√©cuter du code Python arbitraire, nous avons pu activer le menu de d√©bogage interne et les fonctions de trace.  Tout cela contribuera grandement √† une analyse plus approfondie du client Dropbox. <br><br><h3>  Conclusion </h3><br>  Nous avons pu effectuer une r√©tro-ing√©nierie de Dropbox, √©crire des outils de d√©cryptage et d'injection de code qui fonctionnent avec les clients Dropbox actuels bas√©s sur Python 3.6.  Nous avons proc√©d√© √† une ing√©nierie inverse des fonctions cach√©es individuelles et les avons activ√©es.  De toute √©vidence, le d√©bogueur aidera vraiment √† pirater davantage.  Surtout avec un certain nombre de fichiers qui ne peuvent pas √™tre d√©compil√©s avec succ√®s en raison des inconv√©nients de decompyle6. <br><br><h3>  Code </h3><br>  Le code peut √™tre trouv√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sur Github</a> .  Instructions d'utilisation l√†-bas.  Ce r√©f√©rentiel contient √©galement mon ancien code √©crit en 2011.  Cela devrait fonctionner avec seulement quelques modifications, √† condition que quelqu'un ait des versions plus anciennes de Dropbox bas√©es sur Python 2.7. <br><br>  Le r√©f√©rentiel contient √©galement des scripts pour diffuser des opcodes, des instructions pour d√©finir les variables d'environnement Dropbox et tout le n√©cessaire pour modifier un fichier zip. <br><br><h3>  Remerciements </h3><br>  Merci √† Brian d'Anvil Ventures d'avoir r√©vis√© mon code.  Le travail sur ce code s'est poursuivi pendant plusieurs ann√©es, de temps en temps je le mettais √† jour, introduisais de nouvelles m√©thodes et r√©√©crivais des fragments pour le restaurer pour qu'il fonctionne sur les nouvelles versions de Dropbox. <br><br>  Comme mentionn√© pr√©c√©demment, les travaux de Rich Smith, Florian Ledoux et Nicolas Raff, ainsi que Hagen Fritch, constituent un excellent point de d√©part pour les applications Python de r√©tro-ing√©nierie.  Leur travail est particuli√®rement pertinent pour le d√©veloppement inverse de l'une des plus grandes applications Python au monde - le client Dropbox. <br><br>  Il est √† noter que la d√©compilation du code Python a consid√©rablement progress√© gr√¢ce au projet uncompyle6 dirig√© par R. Bernstein.  Ce d√©compilateur a compil√© et am√©lior√© de nombreux d√©compilateurs Python diff√©rents. <br><br>  Merci √©galement √† mes coll√®gues Brian, Austin, Stefan et Chris d'avoir relu cet article. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr452276/">https://habr.com/ru/post/fr452276/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr452264/index.html">Comment nous avons cr√©√© le site du prix Mascot Car</a></li>
<li><a href="../fr452266/index.html">Racks sans serveur</a></li>
<li><a href="../fr452268/index.html">Fen√™tre analogique C # WPF.ShowDialog () ou g√©rer DispatcherFrame</a></li>
<li><a href="../fr452270/index.html">La documentation de l'API Xamarin est d√©sormais accessible au public</a></li>
<li><a href="../fr452272/index.html">Fille sous la cascade</a></li>
<li><a href="../fr452278/index.html">Bluetooth LE n'est pas si effrayant, ou comment am√©liorer l'exp√©rience utilisateur sans trop d'effort</a></li>
<li><a href="../fr452280/index.html">PostgreSQL 11: L'√©volution du partitionnement de Postgres 9.6 √† Postgres 11</a></li>
<li><a href="../fr452282/index.html">Elementary, Watson: vous int√©grez avec Voximplant</a></li>
<li><a href="../fr452284/index.html">Classification de la couverture terrestre √† l'aide de l'eo-learn. Partie 1</a></li>
<li><a href="../fr452288/index.html">Situation: des op√©rateurs de t√©l√©phonie mobile am√©ricains accus√©s de commerce ill√©gal de g√©odonn√©es d'abonn√©s</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>