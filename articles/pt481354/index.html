<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚óæÔ∏è üë©üèª‚Äçüîß üë´ TelegramBot. A funcionalidade b√°sica. Voa separadamente, costeletas separadamente. (Parte 2) üíø üï£ ‚¨áÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continuamos a desenvolver a funcionalidade b√°sica para o bot em telegramas. Nas partes anteriores, discutimos o ponto em que o trabalho do bot em rece...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>TelegramBot. A funcionalidade b√°sica. Voa separadamente, costeletas separadamente. (Parte 2)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481354/"> Continuamos a desenvolver a funcionalidade b√°sica para o bot em telegramas.  Nas partes anteriores, discutimos o ponto em que o trabalho do bot em receber mensagens, processar e enviar deve ser dividido.  Vamos tentar usar as ferramentas b√°sicas do Java Core para tornar nosso bot multithread e ass√≠ncrono.  Criaremos uma tarefa que leva muito tempo para processar.  Vamos ver como os comandos no telegrama funcionam e como eles precisam ser processados. <br><br>  Esta √© uma continua√ß√£o da primeira parte do artigo sobre programa√ß√£o de bots para telegramas em Java <br>  <a href="https://habr.com/ru/post/476306/">Instru√ß√µes do TelegramBot para criar funcionalidades b√°sicas para o bot.</a>  <a href="https://habr.com/ru/post/476306/">(Parte 1)</a> <br>  Para quem √© mais interessante, voc√™ √© bem-vindo‚Ä¶ <br><a name="habracut"></a><br>  Devo dizer imediatamente que, nesta parte, tudo foi adicionado de uma s√≥ vez e silenciosamente, analisaremos toda a funcionalidade que permitiu ao bot ser capaz de multithread e por que √© necess√°rio. <br><br>  Como de costume do principal: <br>  Voc√™ pode encontrar todo o c√≥digo pronto para este artigo na ramifica√ß√£o <a href="https://github.com/dp-ua/TelegramBotBase/tree/Part2-Handlers" rel="nofollow">Part2-Handlers</a> no reposit√≥rio git. <br>  O c√≥digo est√° funcionando perfeitamente, basta inclinar, alterar os dados para autoriza√ß√£o do bot (nome e token) e executar o m√©todo principal na classe App.class. <br><br>  <i>Observe que esta classe envia uma notifica√ß√£o ao administrador do bot quando o bot inicia que o bot foi iniciado.</i>  <i>O ID do administrador do bot tamb√©m √© especificado na classe App.class e, se voc√™ n√£o o alterar, seu bot tentar√° enviar mensagens para mim :)</i> <br><br>  E mais adiante, analisaremos as mudan√ßas que apareceram ap√≥s o lan√ßamento da primeira parte. <br><br><h3>  Processamento de comando </h3><br>  Para come√ßar, vamos lidar com esse conceito do que uma equipe √© em geral em um sistema de comunica√ß√£o com um bot de telegrama.  Dependendo das configura√ß√µes do bot, ele pode ver qualquer mensagem de qualquer formato ou apenas comandos especialmente projetados.  Qual √© a diferen√ßa e <br>  onde voc√™ pode conhecer essas op√ß√µes de mensagem. <br><br><ol><li>  <b>Texto sem formata√ß√£o, mensagens regulares.</b> <br>  Nesta forma, o bot recebe mensagens quando lhe escrevem no PM.  E, no entanto, se nas configura√ß√µes do bot <a href="https://core.telegram.org/bots" rel="nofollow">o modo de privacidade em grupos estiver</a> desativado, o bot come√ßar√° a ver todas as mensagens completamente.  Se essa configura√ß√£o estiver ativada, quando adicionada ao grupo, o bot ver√° apenas os comandos endere√ßados a ele.  Como eles se parecem - veja o segundo par√°grafo </li><li>  <b>Equipes especialmente projetadas</b> <br>  Esses comandos sempre come√ßam com uma barra: <b>/</b> <br>  Depois disso vem a pr√≥pria equipe.  O texto do comando deve estar sem espa√ßos.  Um exemplo: <br>  <b>/ start</b> <br>  Com este comando, qualquer usu√°rio sempre inicia a comunica√ß√£o com seu bot.  Portanto, de acordo com as regras de boa forma, a resposta a este comando deve ser prescrita. <br><img src="https://habrastorage.org/webt/ol/pi/ud/olpiudptbqgig5zhoqzpnpjquyq.png"><br>  Todos os comandos com os quais seu bot sabe trabalhar, √© recomend√°vel adicionar √† lista de habilidades nas configura√ß√µes do seu bot.  Tudo isso √© feito em um telegrama com o @BotFather. <br><br>  <b>Ao</b> chamar o <b>comando / myBots,</b> selecione seu bot e, em seguida, o bot√£o "Editar bot" <br>  Voc√™ ver√° uma janela onde todos os par√¢metros do bot ser√£o mostrados e, em seguida, voc√™ poder√° configurar toda a interface e indicar com quais comandos o bot pode trabalhar. <br><br><img src="https://habrastorage.org/webt/u6/7o/cl/u67oclalxrv7v3v83h1wzp91gr4.png"><br><br>  Eles s√£o definidos neste formato: <br><br><img src="https://habrastorage.org/webt/-a/4x/i-/-a4xi-kqpuxjoielhmog7oh1tom.png"><br><br>  E depois disso, quando voc√™ come√ßar a digitar um comando no seu bot, ele mostrar√° ajuda com uma lista dos comandos listados: <br><br><img src="https://habrastorage.org/webt/hn/yi/wa/hnyiwabkhmbrc7zn0rbuzkfvook.png"><br><br>  E h√° mais uma nuance.  Um grupo pode conter v√°rios bots, e se eles tiverem comandos comuns (e comandos comuns ser√£o obrigat√≥rios, a mesma inicializa√ß√£o e ajuda ser√£o implementadas na maioria dos bots), uma parte ser√° adicionada ao pr√≥prio comando, informando a qual bot esse comando pertence.  E o comando ficar√° completamente assim: <br>  <b>/ start @ test_habr_bot</b> <br></li></ol><br>  E agora, conhecendo todas essas nuances, vamos criar com voc√™ uma op√ß√£o de processamento que deve entender comandos come√ßando com uma barra e saber como distinguir se o comando √© endere√ßado especificamente ao seu bot ou a outro. <br><br>  Crie um pacote que conter√° as classes respons√°veis ‚Äã‚Äãpelo processamento dos comandos. <br>  <a href="https://github.com/dp-ua/TelegramBotBase/tree/Part2-Handlers/src/main/java/com/example/telegrambot/command" rel="nofollow">pacote com.example.telegrambot.command</a> <br><br>  Na classe Command, listamos todos os comandos que nosso bot deve entender. <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> Command { NONE, NOTFORME, NOTIFY, START, HELP, ID }</code> </pre> <br>  Como voc√™ viu anteriormente, apontei para o @BotFather que o bot eu deveria ser capaz de entender quatro equipes.  Estes ser√£o o in√≠cio e a ajuda padr√£o.  N√≥s adicionamos um √∫nico ID √∫til.  E mais um, notifique, sobre o qual falarei um pouco mais tarde.  E duas equipes NONE e NOTFORME, que nos dir√£o que a mensagem de texto n√£o √© um comando, ou esse comando n√£o √© para o nosso bot. <br><br>  <a href="" rel="nofollow">Adicionar</a> outra classe auxiliar <a href="" rel="nofollow">ParsedCommand</a> <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> lombok.AllArgsConstructor; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> lombok.Getter; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> lombok.NoArgsConstructor; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> lombok.Setter; <span class="hljs-meta"><span class="hljs-meta">@Getter</span></span> <span class="hljs-meta"><span class="hljs-meta">@Setter</span></span> <span class="hljs-meta"><span class="hljs-meta">@NoArgsConstructor</span></span> <span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ParsedCommand</span></span></span><span class="hljs-class"> </span></span>{ Command command = Command.NONE; String text=<span class="hljs-string"><span class="hljs-string">""</span></span>; }</code> </pre> <br>  Seu principal objetivo √© armazenar o resultado da an√°lise de texto em objetos desta classe.  Ele conter√° apenas o pr√≥prio time e todo o texto que vem depois do time. <br><br>  E escreveremos uma aula separada que analisar√° as equipes para n√≥s.  Classe do <a href="" rel="nofollow">analisador</a> <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javafx.util.Pair; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.log4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parser</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger log = Logger.getLogger(Parser.class); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String PREFIX_FOR_COMMAND = <span class="hljs-string"><span class="hljs-string">"/"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String DELIMITER_COMMAND_BOTNAME = <span class="hljs-string"><span class="hljs-string">"@"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String botName; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Parser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String botName)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.botName = botName; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ParsedCommand </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getParsedCommand</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String text)</span></span></span><span class="hljs-function"> </span></span>{ String trimText = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (text != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) trimText = text.trim(); ParsedCommand result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ParsedCommand(Command.NONE, trimText); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">""</span></span>.equals(trimText)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; Pair&lt;String, String&gt; commandAndText = getDelimitedCommandFromText(trimText); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isCommand(commandAndText.getKey())) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isCommandForMe(commandAndText.getKey())) { String commandForParse = cutCommandFromFullText(commandAndText.getKey()); Command commandFromText = getCommandFromText(commandForParse); result.setText(commandAndText.getValue()); result.setCommand(commandFromText); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { result.setCommand(Command.NOTFORME); result.setText(commandAndText.getValue()); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cutCommandFromFullText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String text)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text.contains(DELIMITER_COMMAND_BOTNAME) ? text.substring(<span class="hljs-number"><span class="hljs-number">1</span></span>, text.indexOf(DELIMITER_COMMAND_BOTNAME)) : text.substring(<span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Command </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCommandFromText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String text)</span></span></span><span class="hljs-function"> </span></span>{ String upperCaseText = text.toUpperCase().trim(); Command command = Command.NONE; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { command = Command.valueOf(upperCaseText); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IllegalArgumentException e) { log.debug(<span class="hljs-string"><span class="hljs-string">"Can't parse command: "</span></span> + text); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> command; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Pair&lt;String, String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDelimitedCommandFromText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String trimText)</span></span></span><span class="hljs-function"> </span></span>{ Pair&lt;String, String&gt; commandText; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (trimText.contains(<span class="hljs-string"><span class="hljs-string">" "</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> indexOfSpace = trimText.indexOf(<span class="hljs-string"><span class="hljs-string">" "</span></span>); commandText = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Pair&lt;&gt;(trimText.substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, indexOfSpace), trimText.substring(indexOfSpace + <span class="hljs-number"><span class="hljs-number">1</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> commandText = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Pair&lt;&gt;(trimText, <span class="hljs-string"><span class="hljs-string">""</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> commandText; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isCommandForMe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String command)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command.contains(DELIMITER_COMMAND_BOTNAME)) { String botNameForEqual = command.substring(command.indexOf(DELIMITER_COMMAND_BOTNAME) + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> botName.equals(botNameForEqual); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isCommand</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String text)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text.startsWith(PREFIX_FOR_COMMAND); } }</code> </pre> <br>  Em suma.  Ao inicializar o analisador, devemos passar o nome do nosso bot no construtor para que o analisador possa distinguir seus comandos de estranhos. <br><br>  Bem, ent√£o chamamos o m√©todo p√∫blico <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ParsedCommand </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getParsedCommand</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String text)</span></span></span></span></code> </pre> <br>  Para o qual passamos o texto da mensagem nos argumentos, e ele deve retornar um comando para n√≥s e o texto da mensagem que vem ap√≥s o comando. <br><br>  Voc√™ pode ver como o analisador funciona na <a href="" rel="nofollow">classe de teste</a> . <br><br><h3>  Voa separadamente, costeletas separadamente </h3><br>  Agora precisamos ensinar nosso bot a receber separadamente mensagens, processar e enviar respostas.  Ap√≥s uma s√©rie de tentativas e erros, cheguei a essa l√≥gica do aplicativo. <br>  A classe principal <a href="" rel="nofollow">Bot</a> funcionar√° no encadeamento principal do aplicativo e s√≥ estar√° ocupada com o fato de colocar todas as mensagens recebidas em uma fila especial e tamb√©m ser√° um cont√™iner para as mensagens que planejamos enviar ao usu√°rio em resposta. <br><br>  As mudan√ßas nesta classe s√£o muito pequenas.  Adicionamos duas filas: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Queue&lt;Object&gt; sendQueue = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentLinkedQueue&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Queue&lt;Object&gt; receiveQueue = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentLinkedQueue&lt;&gt;();</code> </pre><br>  e reescreveu levemente o c√≥digo de fun√ß√£o <b>public void onUpdateReceived (atualiza√ß√£o de atualiza√ß√£o)</b> <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUpdateReceived</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Update update)</span></span></span><span class="hljs-function"> </span></span>{ log.debug(<span class="hljs-string"><span class="hljs-string">"Receive new Update. updateID: "</span></span> + update.getUpdateId()); receiveQueue.add(update); }</code> </pre> <br>  Porque  Mais uma vez tentei op√ß√µes diferentes.  E o principal problema do multithreading √© trabalhar com dados compartilhados.  E acima de tudo, gostei de como a implementa√ß√£o de filas multiencadeadas <b>ConcurrentLinkedQueue &lt;&gt; ()</b> lida com isso. <br>  E como voc√™ pode ver, nas duas filas, armazenaremos os tipos de dados do objeto.  Este √© outro marcador para o futuro.  Portanto, n√£o estamos apegados aos tipos de mensagens recebidas.  Na fila de entrada, podemos adicionar n√£o apenas objetos do tipo Atualiza√ß√£o, mas tamb√©m alguns outros objetos que precisamos. <br><br>  A mesma coisa com a fila para envio.  Como podemos enviar v√°rios tipos de mensagens e eles n√£o t√™m um pai comum - tamb√©m usamos um tipo de dados comum - Object. <br>  Se voc√™ executar o bot neste formul√°rio, ele funcionar√°, mas n√£o far√° nada.  Ele gravar√° todas as mensagens recebidas no log e colocar√° na fila. <br>  Portanto, precisamos de algum tipo de encadeamento que receba as mensagens recebidas da fila e execute algumas a√ß√µes nelas e coloque a fila <b>sendQueue nos</b> resultados de seu trabalho. <br><br>  Vamos criar um pacote separado: <a href="https://github.com/dp-ua/TelegramBotBase/tree/Part2-Handlers/src/main/java/com/example/telegrambot/service" rel="nofollow">service</a> e nele teremos apenas 2 classes: <br><br>  <b>MessageReciever</b> - manipulador de mensagens recebidas <br>  <b>MessageSender</b> √© o manipulador da fila de mensagens a ser enviado ao usu√°rio. <br><br>  Consideraremos o trabalho deles um pouco menor, mas, por enquanto, descreveremos seu uso em nosso <a href="" rel="nofollow">aplicativo de</a> classe inicial <br><br>  Depois que nosso bot se conectar, iniciamos nossos manipuladores em threads separados: <br><br><pre> <code class="java hljs">MessageReciever messageReciever = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MessageReciever(test_habr_bot); MessageSender messageSender = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MessageSender(test_habr_bot); test_habr_bot.botConnect(); Thread receiver = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(messageReciever); receiver.setDaemon(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); receiver.setName(<span class="hljs-string"><span class="hljs-string">"MsgReciever"</span></span>); receiver.setPriority(PRIORITY_FOR_RECEIVER); receiver.start(); Thread sender = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(messageSender); sender.setDaemon(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); sender.setName(<span class="hljs-string"><span class="hljs-string">"MsgSender"</span></span>); sender.setPriority(PRIORITY_FOR_SENDER); sender.start();</code> </pre><br>  Para ambos os threads, especificamos o modo Daemon.  Isso √© necess√°rio para que os encadeamentos funcionem enquanto o encadeamento principal estiver em execu√ß√£o e se encerrem assim que interromper seu trabalho. <br><br>  N√£o gostar√≠amos de lidar primeiro com o manipulador de mensagens recebidas - vejamos a opera√ß√£o da classe <a href="" rel="nofollow">MessageSender</a> . <br><br>  Vamos dar uma olhada no que ele pode fazer e no que faz: <br><br><ul><li>  Naturalmente, essa √© uma heran√ßa da interface para multithreading: <br>  <b>implementa execut√°vel</b> <br>  e implementa√ß√£o da fun√ß√£o de <b>execu√ß√£o</b> <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span></code> </pre> <br>  Aqui come√ßamos o loop infinito, que s√≥ est√° ocupado com o fato de que ele verifica a fila de envio e chama o comando send <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object object)</span></span></span></span></code> </pre> <br>  se algo aparecer na fila. <br></li><li>  No construtor da classe, passamos o objeto da classe Bot, porque  a partir dele, pegaremos objetos para enviar mensagens e com ele os enviaremos. </li><li>  O m√©todo send determina o tipo de mensagem a ser enviada e aplica o comando apropriado a ela. </li></ul><br>  Bem, agora vamos <a href="" rel="nofollow">ver o</a> trabalho da classe <a href="" rel="nofollow">MessageReciever</a> <br><br>  Ele, como o MessageSender, deve ser multithread, no construtor recebe um objeto da classe Bot, no qual ele recebe as mensagens recebidas em um loop infinito, processa-as e coloca-o na fila para enviar os resultados de seu trabalho. <br><br>  Aqui usamos o analisador de comandos criado anteriormente.  E ent√£o adicionamos a capacidade de usar v√°rios tipos de manipuladores para nossas equipes e alguns deles tornaremos multiencadeados. <br><br>  O ciclo de trabalho √© muito simples: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"[STARTED] MsgReciever. Bot class: "</span></span> + bot); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Object object = bot.receiveQueue.poll(); object != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; object = bot.receiveQueue.poll()) { log.debug(<span class="hljs-string"><span class="hljs-string">"New object for analyze in queue "</span></span> + object.toString()); analyze(object); } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Thread.sleep(WAIT_FOR_NEW_MESSAGE_DELAY); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (InterruptedException e) { log.error(<span class="hljs-string"><span class="hljs-string">"Catch interrupt. Exit"</span></span>, e); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } } }</code> </pre> <br>  Verifique a fila.  Se houver algo, execute o analisador: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">analyze</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object object)</span></span></span></span></code> </pre> <br>  Se n√£o houver nada, estamos esperando. <br><br>  O analisador verifica o tipo de objeto.  Se ele souber trabalhar com ele, ele inicia o pr√≥ximo analisador.  Se voc√™ n√£o pode - jura :) <br><br>  Porque  Novamente, este √© um marcador para o futuro e, espero, divulgarei nas pr√≥ximas partes desta s√©rie de artigos.  Essa implementa√ß√£o nos permitir√° formar nossas pr√≥prias tarefas para o bot, criar listas de discuss√£o, tarefas di√°rias.  Para isso, o receptor deve ser capaz de processar n√£o apenas objetos do tipo Update, mas tamb√©m algo nosso.  Mas mais sobre isso mais tarde :) <br><br>  Vamos considerar o analisador para o tipo de atualiza√ß√£o em mais detalhes: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">analyzeForUpdateType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Update update)</span></span></span><span class="hljs-function"> </span></span>{ Long chatId = update.getMessage().getChatId(); String inputText = update.getMessage().getText(); ParsedCommand parsedCommand = parser.getParsedCommand(inputText); AbstractHandler handlerForCommand = getHandlerForCommand(parsedCommand.getCommand()); String operationResult = handlerForCommand.operate(chatId.toString(), parsedCommand, update); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-string"><span class="hljs-string">""</span></span>.equals(operationResult)) { SendMessage message = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SendMessage(); message.setChatId(chatId); message.setText(operationResult); bot.sendQueue.add(message); } }</code> </pre> <br>  Ele define o ID do bate-papo.  Obt√©m o texto da mensagem.  Usando o analisador, ele determina se a mensagem √© um comando e determina qual manipulador esse comando deve ser processado.  Ele inicia o processamento do comando e, se o processamento retornar algum texto n√£o vazio - ele forma uma mensagem para enviar ao usu√°rio e a coloca na fila. <br><br>  E ent√£o voc√™ deve ter uma pergunta: "Que tipo de manipulador?".  N√£o houve conversa sobre ele antes, e ele n√£o foi mencionado no c√≥digo.  Tudo bem.  Agora vamos analisar essa funcionalidade. <br><br>  Para fazer isso, crie um pacote separado, que armazenar√° todos os nossos manipuladores.  Chame de <a href="https://github.com/dp-ua/TelegramBotBase/tree/Part2-Handlers/src/main/java/com/example/telegrambot/handler" rel="nofollow">manipulador</a> <br>  Vamos criar uma classe <a href="" rel="nofollow">abstrata AbstractHandler</a> <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.example.telegrambot.bot.Bot; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.example.telegrambot.command.ParsedCommand; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.telegram.telegrambots.api.objects.Update; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractHandler</span></span></span><span class="hljs-class"> </span></span>{ Bot bot; AbstractHandler(Bot bot) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot = bot; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">operate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String chatId, ParsedCommand parsedCommand, Update update)</span></span></span></span>; }</code> </pre> <br>  Ele ter√° um construtor b√°sico no qual passamos com qual objeto Bot ele precisar√° interagir.  E <b>√©</b> declarada uma fun√ß√£o abstrata para <b>operar</b> , cuja implementa√ß√£o teremos que registrar nos herdeiros de nossa classe. <br><br>  Imediatamente, implementaremos o manipulador mais simples que n√£o far√° nada e o usaremos quando n√£o entendermos o tipo de comando que recebemos e nenhuma resposta for necess√°ria do bot. <br><br>  <a href="" rel="nofollow">DefaultHandler.java</a> <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.example.telegrambot.bot.Bot; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.example.telegrambot.command.ParsedCommand; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.log4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.telegram.telegrambots.api.objects.Update; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DefaultHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractHandler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger log = Logger.getLogger(DefaultHandler.class); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DefaultHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bot bot)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(bot); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">operate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String chatId, ParsedCommand parsedCommand, Update update)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>; } }</code> </pre> <br>  Como vamos aplic√°-lo e onde obteremos os resultados de seu trabalho - analisaremos um pouco mais tarde. <br><br>  O pr√≥ximo na fila √© o <a href="" rel="nofollow">SystemHandler</a> <br>  Ele lidar√° com comandos b√°sicos, como start, help, e tamb√©m o instruiremos a executar o comando id <br><br>  A base disso √© assim: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.example.telegrambot.bot.Bot; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.example.telegrambot.command.Command; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.example.telegrambot.command.ParsedCommand; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.log4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.telegram.telegrambots.api.methods.send.SendMessage; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.telegram.telegrambots.api.objects.Update; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SystemHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractHandler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger log = Logger.getLogger(SystemHandler.class); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String END_LINE = <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SystemHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bot bot)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(bot); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">operate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String chatId, ParsedCommand parsedCommand, Update update)</span></span></span><span class="hljs-function"> </span></span>{ Command command = parsedCommand.getCommand(); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (command) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> START: bot.sendQueue.add(getMessageStart(chatId)); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HELP: bot.sendQueue.add(getMessageHelp(chatId)); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ID: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Your telegramID: "</span></span> + update.getMessage().getFrom().getId(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>; }</code> </pre> <br>  Voc√™ pode ver como a resposta ao comando start e help √© formada no c√≥digo :) <br>  Formamos mensagens de texto e as colocamos em uma fila para envio.  Sobre isso, o trabalho do manipulador para.  Quem e como enviar√° essas mensagens - ele n√£o se importa. <br>  E lembre-se, mencionei um pouco acima que, como resultado do manipulador, ele retorna alguns dados de texto.  E se esta linha n√£o estiver vazia, devemos enviar este texto ao usu√°rio.  Esta √© exatamente a funcionalidade que usamos ao elaborar o comando ID: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ID: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Your telegramID: "</span></span> + update.getMessage().getFrom().getId();</code> </pre> <br>  O manipulador retornar√° o texto com o ID do usu√°rio para a pessoa que o chamou e j√° ser√° gerada uma mensagem para envio, que ser√° encaminhada para a fila. <br><br>  E no come√ßo do artigo, mencionei que estamos implementando essa op√ß√£o para processar uma mensagem de um usu√°rio que precisa de tempo para trabalhar.  E para que n√£o interfira com nossos manipuladores, aloc√°-lo-emos em um fluxo separado e deixaremos seus neg√≥cios sem distrair o resto. <br>  Como um segmento "pesado", criei o comando de notifica√ß√£o.  O princ√≠pio de seu trabalho √© esse. <br><br>  Enviando ao bot um comando como: <br>  <b>/ notificar 300</b> <br><br>  O bot deve informar que a equipe entendeu e, ap√≥s 300 segundos, enviar√° uma notifica√ß√£o de que 300 segundos se passaram.  Essa equipe pode at√© ter um uso pr√°tico :) <br><br>  Por exemplo, voc√™ coloca bolinhos no fogo e precisa remov√™-los ap√≥s 5 minutos.  O bot far√° isso perfeitamente e emitir√° uma notifica√ß√£o no chat de que o tempo acabou. <br><br>  Ou fa√ßa uma tarefa mais s√©ria.  Voc√™ vai a uma reuni√£o importante e sabe que, ao se comunicar com algu√©m, precisar√° interromper a conversa.  Para isso, eles geralmente pedem aos amigos que liguem ou escrevam uma mensagem, o que ser√° um motivo para n√£o distrair a conversa por um longo tempo e tomar alguma a√ß√£o.  Mas por que incomodar os amigos quando voc√™ tem um bot?  Depois de solicitar uma tarefa com anteced√™ncia e indicar a hora, voc√™ receber√° a notifica√ß√£o necess√°ria em telegramas.  Mas esta √© toda a letra.  A tarefa e este comando foram inventados apenas para mostrar como alocar em um fluxo separado algo cujo trabalho pode levar um per√≠odo muito longo. <br><br>  Portanto, <a href="" rel="nofollow">NotifyHandler</a> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.example.telegrambot.ability.Notify; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.example.telegrambot.bot.Bot; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.example.telegrambot.command.ParsedCommand; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.log4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.telegram.telegrambots.api.objects.Update; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NotifyHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractHandler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger log = Logger.getLogger(NotifyHandler.class); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MILLISEC_IN_SEC = <span class="hljs-number"><span class="hljs-number">1000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String WRONG_INPUT_MESSAGE = <span class="hljs-string"><span class="hljs-string">"Wrong input. Time must be specified as an integer greater than 0"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NotifyHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bot bot)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(bot); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">operate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String chatId, ParsedCommand parsedCommand, Update update)</span></span></span><span class="hljs-function"> </span></span>{ String text = parsedCommand.getText(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">""</span></span>.equals(text)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"You must specify the delay time. Like this:\n"</span></span> + <span class="hljs-string"><span class="hljs-string">"/notify 30"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> timeInSec; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { timeInSec = Long.parseLong(text.trim()); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (NumberFormatException e) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WRONG_INPUT_MESSAGE; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (timeInSec &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { Thread thread = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Notify(bot, chatId, timeInSec * MILLISEC_IN_SEC)); thread.start(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WRONG_INPUT_MESSAGE; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>; } }</code> </pre> <br>  Verificamos se o tempo de atraso nos foi dado no texto.  Se n√£o, n√≥s juramos.  Nesse caso, iniciamos um novo segmento, onde passamos o introdut√≥rio em nossas instru√ß√µes.  Esta tarefa ser√° tratada por uma classe <a href="" rel="nofollow">Notify</a> separada. <br>  A funcionalidade √© extremamente simples.  Ele dorme o n√∫mero indicado de segundos.  Mas, durante o sono dele, seu bot pode receber outras mensagens, se comunicar com voc√™ e lan√ßar notifica√ß√µes adicionais adicionais.  E tudo isso funciona separadamente um do outro. <br><br>  E para concluir logicamente todo esse grupo com manipuladores de chamada, vamos voltar √† nossa classe <a href="" rel="nofollow">MessageReciever</a> e ver como entendemos qual manipulador precisamos e como os executamos. <br>  O manipulador necess√°rio nos √© retornado pelo comando <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> AbstractHandler </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getHandlerForCommand</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Command command)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { log.warn(<span class="hljs-string"><span class="hljs-string">"Null command accepted. This is not good scenario."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultHandler(bot); } <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (command) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> START: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HELP: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ID: SystemHandler systemHandler = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SystemHandler(bot); log.info(<span class="hljs-string"><span class="hljs-string">"Handler for command["</span></span> + command.toString() + <span class="hljs-string"><span class="hljs-string">"] is: "</span></span> + systemHandler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> systemHandler; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> NOTIFY: NotifyHandler notifyHandler = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NotifyHandler(bot); log.info(<span class="hljs-string"><span class="hljs-string">"Handler for command["</span></span> + command.toString() + <span class="hljs-string"><span class="hljs-string">"] is: "</span></span> + notifyHandler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> notifyHandler; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: log.info(<span class="hljs-string"><span class="hljs-string">"Handler for command["</span></span> + command.toString() + <span class="hljs-string"><span class="hljs-string">"] not Set. Return DefaultHandler"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultHandler(bot); } }</code> </pre> <br>  Agora, se voc√™ quiser adicionar mais alguns comandos, precisar√° fazer o seguinte: <br><br><ol><li>  Na classe <a href="" rel="nofollow">Command,</a> adicione a sintaxe do comando. </li><li>  No <a href="" rel="nofollow">receptor,</a> na fun√ß√£o <b>getHandlerForCommand,</b> especifique quem ser√° o respons√°vel por processar este comando. </li><li>  E realmente escreva esse manipulador. </li></ol><br>  Eu direi antecipadamente que o processo de adi√ß√£o de novas equipes pode ser simplificado.  Manipuladores respons√°veis ‚Äã‚Äãpodem ser registrados imediatamente na classe com uma lista de comandos.  Mas receio que o c√≥digo n√£o seja f√°cil de entender.  O texto √© muito longo.  Mas n√£o posso venc√™-lo em peda√ßos.  Tr√™s fun√ß√µes b√°sicas de bot s√£o descritas aqui, que funcionam apenas juntas e n√£o √© correto falar sobre elas individualmente. <br><br>  Sobre o que falaremos nas seguintes partes? <br><br>  Precisamos entender como formar diferentes tipos de mensagens.  Como trabalhar com o teclado e os bot√µes.  Como editar suas postagens antigas.  Como trabalhar com retornos de chamada.  Como atribuir tarefas ao bot para executar algumas a√ß√µes.  Como criar uma mensagem interativa com um bot e muito mais.  Todas as outras partes dependem de voc√™ e de sua atividade. <br>  Nos coment√°rios, aguardo seus coment√°rios e orienta√ß√µes, que consideraremos como uma prioridade. <br><br>  Sinta-se livre para fazer perguntas.  Se algo n√£o estiver indicado no artigo ou em algum momento n√£o estiver claro - escreva-me sobre isso.  Definitivamente vou corrigir, editar ou esclarecer quest√µes controversas. <br><br>  Programe com prazer e que a for√ßa e o belo c√≥digo acompanhem voc√™ :) <br><br>  py.s. <br><br>  O bot escrito nesta parte do artigo funciona.  Voc√™ pode atorment√°-lo aqui: <a href="http://t.me/test_habr_bot" rel="nofollow">@test_habr_bot</a> <br>  Voc√™ tamb√©m pode atormentar meu planejador: <a href="http://t.me/EventCheckPlanner_Bot" rel="nofollow">@EventCheckPlanner_Bot</a> <br>  E o <a href="http://t.me/FilmFanAmateurBot" rel="nofollow">f√£ de cinema atrevido</a> : <a href="http://t.me/FilmFanAmateurBot" rel="nofollow">@FilmFanAmateurBot</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt481354/">https://habr.com/ru/post/pt481354/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt481344/index.html">Equipe da plataforma IntelliJ planeja 2020</a></li>
<li><a href="../pt481346/index.html">5 grandes mudan√ßas na ind√∫stria automotiva</a></li>
<li><a href="../pt481348/index.html">Pentest Active Directory. Parte 1</a></li>
<li><a href="../pt481350/index.html">Quem trabalha no cosm√≥dromo de Plesetsk</a></li>
<li><a href="../pt481352/index.html">DBA: limpando registros de clones de uma tabela sem PK</a></li>
<li><a href="../pt481356/index.html">Obrigado, 2019</a></li>
<li><a href="../pt481358/index.html">C ++ R√∫ssia: como foi</a></li>
<li><a href="../pt481360/index.html">Os resultados da semana: Rambler e Twitch concordaram, o trabalho eletr√¥nico ser√° introduzido na Federa√ß√£o Russa e o Facebook criar√° seu pr√≥prio sistema operacional</a></li>
<li><a href="../pt481362/index.html">Certificado SSL para aplicativo da web Docker</a></li>
<li><a href="../pt481364/index.html">Casa sens√≠vel est√° substituindo casas inteligentes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>