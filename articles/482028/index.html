<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üÜé üë©‚Äçüë©‚Äçüëß üë©üèΩ‚Äçüé® Dos botones rojos, soldador y React: c√≥mo hicimos un movimiento para una conferencia de TI üé° üé™ üîë</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Badoo participa regularmente con un stand en exposiciones de conferencias de TI. Por lo tanto, cada a√±o, nosotros, con colegas, ingenieros y devels, t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Dos botones rojos, soldador y React: c√≥mo hicimos un movimiento para una conferencia de TI</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/482028/"><p>  Badoo participa regularmente con un stand en exposiciones de conferencias de TI.  Por lo tanto, cada a√±o, nosotros, con colegas, ingenieros y devels, tenemos algo para hacer algo tan bueno para no aburrirnos entre los informes. </p><br><p>  Mi nombre es Ivan, soy un desarrollador frontend.  En este art√≠culo, junto con nuestro colega y entusiasta del bricolaje <a href="https://habr.com/ru/users/lilek/" class="user_link">lilek,</a> Yura Lilekov, le diremos c√≥mo, usando dos botones rojos, un microcontrolador, un c√≥digo de Reacci√≥n y 250 palabras para temas de TI, creamos el juego "Juego de adivinanzas de TI" y organizamos un acogedor encuentro en Highload ++ y Heisenbug. </p><br><p><img src="https://habrastorage.org/webt/op/k9/r9/opk9r9az9g7eovtbqkgcra83ntm.png"></p><a name="habracut"></a><br><h1 id="soderzhanie">  Contenido: </h1><br><p>  <a href="https://habr.com/ru/company/badoo/blog/482028/">TK no trivial</a> <br>  <a href="https://habr.com/ru/company/badoo/blog/482028/">Mec√°nica del juego y puntuaci√≥n</a> <br>  <a href="https://habr.com/ru/company/badoo/blog/482028/">Animaci√≥n</a> <br>  <a href="https://habr.com/ru/company/badoo/blog/482028/">Frontend</a> <br>  <a href="https://habr.com/ru/company/badoo/blog/482028/">Hardware: dos botones rojos</a> <br>  <a href="https://habr.com/ru/company/badoo/blog/482028/">Resultado</a> </p><br><h1 id="netrivialnoe-tz">  TK no trivial </h1><br><p>  Las conferencias de TI tienen su propia atm√≥sfera: hay mucha gente, no es f√°cil captar y mantener su atenci√≥n en el stand.  Para que vengan a nosotros precisamente en los descansos entre informes, debemos ofrecerles una lecci√≥n interesante pero sin complicaciones. </p><br><p>  Inspirados por el √©xito del alias de TI del a√±o pasado, formulamos los siguientes requisitos para el nuevo juego: </p><br><ul><li>  Debe ser multiusuario.  La comunicaci√≥n de los participantes es la tarea principal.  Sabemos que muchos vienen solos y no siempre comienzan f√°cilmente una conversaci√≥n con extra√±os.  El juego deber√≠a dar ocasi√≥n de hablar entre ellos y con los ingenieros de Badoo. </li><li>  Las sesiones deben ser cortas.  Podr√≠a haber de una a tres mil personas en la conferencia, y quer√≠amos llegar a la mayor cantidad de participantes posible. </li><li>  El juego deber√≠a ser espectacular.  Si una persona no participa en el juego, entonces al menos d√©jelo verlo.  Esto enciende el inter√©s, ayuda a comprender la esencia y decide participar. </li><li>  La gesti√≥n m√°s sencilla.  Como todos sabemos, si algo puede romperse, entonces ciertamente se romper√°. </li><li>  Sin registro y SMS! </li></ul><br><p>  Despu√©s de una lluvia de ideas, pensar en un sue√±o e intentar encontrar inspiraci√≥n, se nos ocurri√≥ el "Juego de adivinanzas de TI", un juego simple con palabras sobre temas de TI. </p><br><p><img src="https://habrastorage.org/webt/8r/p4/5f/8rp45fdtczsizalimesfrnb9kc4.jpeg"></p><br><p>  ¬øCu√°l es la esencia de: </p><br><ul><li>  Dos participantes juegan simult√°neamente. </li><li>  La tarea es presionar el bot√≥n m√°s r√°pido que el oponente y adivinar la palabra cifrada que se muestra en la pantalla. </li><li>  Dos etapas: la simple ("Atajos"), donde las palabras se escriben de frente a frente, y la dif√≠cil ("Agitadores"), en la que se mezclan todas las letras de las palabras. </li><li>  Si la respuesta es correcta, se cuenta un punto para el respondedor.  Incorrecto: el puntaje va para el oponente. </li><li>  Aquellos que obtuvieron al menos N puntos pueden participar en el sorteo de auriculares geniales con cancelaci√≥n de ruido. </li></ul><br><p>  Parece que todo es bastante f√°cil y simple, pero hab√≠a dificultades por delante. </p><br><h1 id="mehanika-igry-i-podschyot-ballov">  Mec√°nica del juego y puntuaci√≥n </h1><br><p><img src="https://habrastorage.org/webt/wf/vr/e_/wfvre_npwrjlh4duabj8kkxb6og.gif"></p><br><p>  De este gif, queda bastante claro c√≥mo se ve el proceso redondo: </p><br><ol><li>  Aparece una palabra encriptada. </li><li>  El temporizador comienza durante 10 segundos. </li><li>  Si uno de los jugadores presiona el bot√≥n, este temporizador se detiene y el otro comienza en su lugar, durante 3 segundos.  Durante este tiempo, el jugador debe recibir una respuesta, de lo contrario, el puntaje se acredita al oponente. </li><li>  Si nadie presion√≥ el bot√≥n, la palabra cambia autom√°ticamente y todo el proceso se repite nuevamente. </li></ol><br><p>  El principal problema al que nos enfrentamos es c√≥mo llevar el puntaje y registrar a los jugadores.  Quer√≠amos hacer el juego lo m√°s r√°pido posible y no obligar a los participantes a registrarse en ning√∫n lado.  Pero era necesario entender cu√°l de ellos obtuvo un cierto n√∫mero de puntos y podr√≠a recibir el premio principal. </p><br><p>  No se nos ocurri√≥ la mec√°nica de c√°lculo la primera vez.  Solo despu√©s de varias pruebas qued√≥ claro c√≥mo hacer que el juego sea conveniente y simple, tanto para los participantes como para los anfitriones. </p><br><h2 id="provalnye-i-genialnye-idei">  Ideas fallidas y brillantes </h2><br><h3 id="ideya-1-odin-ball--odna-malenkaya-shokoladka">  Idea # 1: un punto = una peque√±a barra de chocolate </h3><br><p>  Para cada respuesta correcta, al principio decidimos dar una barra de chocolate.  Al final, el participante trae chocolates (o al menos envoltorios de dulces de los "puntos" comidos), ¬°y eso es todo!  Contamos trofeos, reconocemos al ganador. </p><br><p>  Pero hay algunos puntos. </p><br><p>  Primero: es inconveniente.  Result√≥ imposible moderar el juego y calcular puntos simult√°neamente; se necesitaba un segundo asistente.  Esto es demasiado costoso en t√©rminos de la fuerza y ‚Äã‚Äãel tiempo de los muchachos en el stand.  Y dada la velocidad del juego, literalmente tendr√≠a que tirar chocolate a los participantes. </p><br><p>  El segundo punto: ¬øc√≥mo distinguir mis chocolates de los chocolates de otras personas?  Los jugadores podr√≠an cooperar y apilar chocolates o envoltorios de dulces de ellos.  Entonces, el circuito no funciona!  Adem√°s, las conferencias duran dos d√≠as y puedes recolectar chocolates sin cesar. </p><br><p>  Tercer punto: necesitas demasiados chocolates.  Verificamos experimentalmente cu√°ntos puntos obtiene un jugador promedio y nos dimos cuenta de que al menos un carro necesita chocolate.  Y solo ten√≠amos un carrito peque√±o. </p><br><p><img src="https://habrastorage.org/webt/1h/j_/8z/1hj_8zp8amb6-taaowqum3y54gm.jpeg"></p><br><h3 id="ideya-2-turnirnaya-tablica">  Idea # 2: clasificaci√≥n </h3><br><p>  Mientras algunos juegan, otros se grabar√°n en la clasificaci√≥n.  En este caso, encontrar√≠amos todos los problemas posibles: hom√≥nimos, hom√≥nimos, errores de escritura, escritura ilegible (o la necesidad de poner otro monitor grande y una computadora port√°til para la entrada), renuencia a dejar sus contactos y mucho m√°s. </p><br><p>  Por lo tanto, continuamos buscando. </p><br><h3 id="ideya-3-otmetki-na-beydzhah-uchastnikov">  Idea # 3: marcas en las insignias de los participantes </h3><br><p>  Para deshacernos del problema de registrar jugadores, utilizamos una soluci√≥n preparada: insignias que se distribuyeron a todos los participantes.  Esto es algo que nadie perder√° y que todos los participantes tienen.  Decidimos escribir una cuenta directamente a ellos.  El participante lleg√≥ al conteo, mir√≥ la insignia, cont√≥ los puntos y determin√≥ el ganador.  Pero tambi√©n hubo una trampa en este esquema: los jugadores pod√≠an "falsificar" el puntaje final en sus insignias. </p><br><p>  Luego abandonamos por completo la idea de grabar la partitura.  Permita que aquellos que obtienen el valor umbral de los puntos reciban una marca especial en la insignia, un sello en forma de nuestro coraz√≥n, que pasaron al c√≠rculo de los "elegidos".  Y entre estos participantes sortearemos al azar los premios principales.  Y el resto seguir√° recibiendo regalos: nuestras pegatinas, cuadernos, titulares de tarjetas y tomadores de decisiones. </p><br><p><img src="https://habrastorage.org/webt/_m/hz/u7/_mhzu7f8w8nizwmtpq57u-zdew4.jpeg" alt="Por supuesto, los empleados de Badoo no participaron en el sorteo."><br>  <em>Por supuesto, los empleados de Badoo no participaron en el sorteo.</em> </p><br><p>  El esquema es el siguiente: </p><br><ol><li>  Un invitado est√° marcado en la insignia con una marca de participaci√≥n: negro por alcanzar 20 puntos o p√∫rpura solo por jugar.  Se podr√≠an hacer tres intentos al d√≠a y obtener tres corazones. </li><li>  Todos los ganadores con marcas negras se re√∫nen en un momento determinado en el stand, y con la ayuda de un tambor de loter√≠a de tubo caliente tocamos auriculares entre ellos. </li></ol><br><p><img src="https://habrastorage.org/webt/gd/ui/bn/gduibngslf724dhlrpftt2ivxua.png"></p><br><p>  Despu√©s de probar el juego con personas vivas, calculamos el umbral: anotar 20 puntos en el juego no fue f√°cil.  Pero en cada uno de los dos d√≠as de Highload ++, ¬°unas 15 personas fueron las ganadoras! </p><br><p>  Es cierto que en la lista de palabras hab√≠a bastantes t√©rminos que el desarrollador entend√≠a en primer lugar, por lo que para la conferencia Heisenbug QA acordamos un umbral de 15 puntos.  Quiz√°s en vano: los semifinalistas resultaron ser muchas veces m√°s, lo que significa que hay menos posibilidades de ganar auriculares. </p><br><p>  PD: En la etapa inicial, decidimos que con la respuesta incorrecta, el participante perder√° el puntaje de la barra de chocolate.  Pero a nadie le gusta que le roben algo.  "¬°Esta es mi barra de chocolate, me la gan√©!" - los primeros probadores del juego estaban indignados.  Por lo tanto, como penalizaci√≥n, comenzamos a darle un punto a un oponente. </p><br><p><img src="https://habrastorage.org/webt/ry/yo/y5/ryyoy50ox1-o3zo-hyth8bae_pc.jpeg"></p><br><h1 id="animaciya">  Animaci√≥n </h1><br><p>  Una palabra de adivinanza deber√≠a aparecer con alg√∫n tipo de animaci√≥n.  Esto nos da dos ventajas: </p><br><ol><li>  Una especie de "paliza" entre palabras.  Es mucho m√°s f√°cil para los jugadores cambiar de una palabra a otra si hay alguna acci√≥n entre ellos.  Recuerda los viejos juegos de lucha.  Cada nueva ronda comenz√≥ con "3..2..1..FIGHT!".  No quer√≠a hacer otro temporizador aqu√≠, ya los tenemos a granel. </li><li>  Variedad visual  Intentamos hacer el juego lo m√°s simple posible, no ten√≠amos fondos animados ni transiciones entre niveles.  Tampoco pod√≠amos usar el sonido, para no interferir con otros participantes de la conferencia.  Por lo tanto, la animaci√≥n era necesaria. </li></ol><br><p>  Con ella, no todo sali√≥ bien de inmediato.  En las pruebas, hab√≠a muchachos astutos que no esperaban el final de la animaci√≥n y hac√≠an clic en el bot√≥n antes.  Para ense√±ar los trucos, comenzamos a evitar que apareciera la palabra cuando uno de los jugadores presion√≥ prematuramente un bot√≥n.  La parte de la palabra que a√∫n no ha tenido tiempo de aparecer, en este caso permaneci√≥ oculta detr√°s de los caracteres.  Si el jugador lo quer√≠a o no, ten√≠a que responder.  Es dif√≠cil adivinar una palabra por varias letras, por lo que el oponente obtuvo un punto. </p><br><p>  As√≠ es como se ve la palabra si hace clic en el bot√≥n con anticipaci√≥n: </p><br><p><img src="https://habrastorage.org/webt/nv/gy/cb/nvgycbadg6xh84ufckataq_izri.gif"></p><br><p>  El segundo momento dif√≠cil es la duraci√≥n de la animaci√≥n.  Siempre dur√≥ el mismo tiempo: 1,5 segundos.  Si "captas el ritmo", entonces puedes acostumbrarte a presionar un bot√≥n m√°s r√°pido que el oponente.  Para resolver el problema, agregamos una variable aleatoria que era de 0 a 500 ms.  En este caso, adaptarse al ritmo se ha vuelto mucho m√°s dif√≠cil. </p><br><h1 id="frontend">  Frontend </h1><br><p>  Te contar√© un poco sobre la parte del software.  Si no est√° interesado, vaya directamente a la <a href="https://habr.com/ru/company/badoo/blog/482028/">historia de c√≥mo buscamos los botones rojos</a> . </p><br><p> La mec√°nica del juego result√≥ ser bastante simple, y no quer√≠a reinventar la rueda.  Tom√≥ <code>create-react-app</code> para el lado del cliente.  Pero el desaf√≠o a√∫n era necesario. </p><br><p>  ¬°As√≠ que ganchos!  Los ganchos aparecieron en el horizonte durante mucho tiempo, pero su aplicaci√≥n en los principales productos de Badoo requiri√≥ un replanteamiento bastante serio del proceso de desarrollo.  Un peque√±o proyecto paralelo fue un gran trampol√≠n para su uso. </p><br><p>  No redux!  Redux es una gran cosa, y lo usamos en nuestro trabajo todos los d√≠as.  Pero para una aplicaci√≥n tan peque√±a, el uso de redux no estaba justificado.  Adem√°s, hay un nuevo gancho <code>useContext</code> . </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { score, changeScore } = useContext(SessionContext); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { next } = useContext(QuestionsContext); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> steps = useContext(StepsContext);</code> </pre> <br><p>  S√≠, en lugar de una historia global, tenemos tres contextos que no se cruzan en absoluto. </p><br><p>  <code>SessionContext</code> anotado. <br>  <code>StepsContext</code> fue responsable de cambiar las pantallas de la aplicaci√≥n: intro, loop, outro ... <br>  <code>QuestionsContext</code> sab√≠a todo acerca de las preguntas: cu√°les fueron respondidas, qu√© pregunta ser√° la siguiente, cu√°nto queda. </p><br><h2 id="provider">  Proveedor </h2><br><p>  Cada contexto necesita un proveedor que entregue datos a los componentes finales.  Como ejemplo, utilizaremos un proveedor simple para la puntuaci√≥n. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> increment = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">score</span></span></span><span class="hljs-function"> =&gt;</span></span> score + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> SessionProvider = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">props</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [leftPlayerScore, changeLeftPlayerScore] = useState(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [rightPlayerScore, changeRightPlayerScore] = useState(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> resetScore = useCallback(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { changeLeftPlayerScore(<span class="hljs-number"><span class="hljs-number">0</span></span>); changeRightPlayerScore(<span class="hljs-number"><span class="hljs-number">0</span></span>); }, []); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> changeScore = useCallback(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">player</span></span></span><span class="hljs-function"> =&gt;</span></span> { player === <span class="hljs-string"><span class="hljs-string">'left'</span></span> ? changeLeftPlayerScore(increment) : changeRightPlayerScore(increment); }, []); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> score = { <span class="hljs-attr"><span class="hljs-attr">left</span></span>: leftPlayerScore, <span class="hljs-attr"><span class="hljs-attr">right</span></span>: rightPlayerScore }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">SessionContext.Provider</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{{</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">score</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">changeScore</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">resetScore</span></span></span></span><span class="xml"><span class="hljs-tag"> }}&gt;</span></span></span><span class="xml"> {props.children} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">SessionContext.Provider</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ); };</span></span></code> </pre> <br><p>  Como puede ver en el c√≥digo, hacemos un seguimiento de los puntos de forma independiente.  Hay un estado separado para los jugadores "izquierdo" y "derecho".  Adem√°s de las funciones para administrar la cuenta: restablezca la cuenta y cambie. </p><br><p>  La API del proveedor resultante es muy simple.  En general, casi toda la l√≥gica asociada con los proveedores era muy simple, por lo que no nos centraremos en ella. </p><br><h2 id="taymery">  Temporizadores </h2><br><p>  El componente de la ronda principal del juego result√≥ ser interesante: hubo momentos ambiguos en √©l.  El componente es el mismo para ambos modos (inverso y aleatorio - "Atajos" y "Mezcladores"). </p><br><p>  Seg√∫n la descripci√≥n de la ronda, est√° claro que hay mucha interacci√≥n con el tiempo. </p><br><p>  En primer lugar, hay un temporizador responsable de la duraci√≥n de la palabra en la pantalla: 10 segundos para presionar un bot√≥n.  Si nadie ha presionado el bot√≥n, la siguiente palabra aparece autom√°ticamente. </p><br><p>  En segundo lugar, un temporizador que comienza cuando uno de los jugadores hace clic en un bot√≥n.  Luego tiene 3 segundos para adivinar la palabra. </p><br><p>  Parece que no hay nada complicado en esto, por lo que escribimos un c√≥digo aparentemente obvio: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [time, nextTick] = useState(<span class="hljs-number"><span class="hljs-number">0</span></span>); useEffect(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> id = setInterval(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { nextTick(time + <span class="hljs-number"><span class="hljs-number">1</span></span>); }, <span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> clearInterval(id); }, []);</code> </pre> <br><p>  Pero, como puedes adivinar, esto no funcion√≥.  ¬°Simplemente no funcion√≥ en absoluto! </p><br><p>  El temporizador lleg√≥ a 1 y se detuvo en eso.  El hecho es que el antiguo valor estaba "bloqueado" dentro de la funci√≥n del controlador.  Por lo tanto, con cada marca, <code>setInterval</code> refiere al valor de <code>time</code> del primer render. </p><br><p>  Hab√≠a una soluci√≥n al problema de usar una funci√≥n en lugar de un valor directo: </p><br><pre> <code class="javascript hljs">nextTick(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">currentTime</span></span></span><span class="hljs-function"> =&gt;</span></span> currentTime + <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br><p>  S√≠, de esa manera siempre tuvimos un valor "nuevo" para el temporizador.  Pero no pudimos obtener <code>props</code> "frescos", por ejemplo. </p><br><p>  Obviamente, se tuvo que encontrar un enfoque diferente.  Y la decisi√≥n m√°s segura fue hacer que la funci√≥n del controlador sea mutable.  React tiene un uso especial <code>useRef</code> gancho para <code>useRef</code> . </p><br><p>  La mayor√≠a de las veces se usa para trabajar con elementos DOM, pero esta no es su √∫nica aplicaci√≥n.  Podemos "recordar" cualquier variable en la propiedad <code>current</code> y actualizarla con cada render. </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ setCount(count + <span class="hljs-number"><span class="hljs-number">1</span></span>); } useEffect(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { savedCallback.current = callback; }); useEffect(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tick</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ savedCallback.current(); } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> id = setInterval(tick, <span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> clearInterval(id); }, []);</code> </pre> <br><p>  Hay un buen art√≠culo de Dan Abramov sobre c√≥mo trabajar con los ganchos <code>setInterval</code> y React: <a href="https://overreacted.io/making-setinterval-declarative-with-react-hooks/">hacer setInterval declarative with React Hooks</a> .  Describi√≥ perfectamente todas las trampas y todas las etapas de reflexi√≥n sobre la implementaci√≥n del gancho <code>useInterval</code> , que tomamos como soluci√≥n a nuestro problema. </p><br><p>  Como el stand estuvo abierto durante toda la conferencia, una sesi√≥n continua con el juego fue muy grande.  La p√°gina no se actualiz√≥ en absoluto (F5), por lo que era muy importante controlar la memoria en la etapa de desarrollo.  Como saben, las filtraciones van de la mano con los temporizadores, y si todo esto se condimenta con reproducciones de la reacci√≥n, entonces ser√≠a bastante f√°cil escribir c√≥digo que consuma mucha, mucha memoria. </p><br><p>  <code>Countdown</code> comenz√≥, se detuvo, reinici√≥ y reinici√≥ docenas (o tal vez cientos) de veces en una sesi√≥n de juego.  Para no molestarnos con los cheques, lo que deber√≠a haber sido mucho, utilizamos un "truco" bastante simple: agregamos accesorios <code>key</code> a este componente. </p><br><pre> <code class="javascript hljs">&lt;QuestionCountdown key={question.text} onComplete={nextQuestion} /&gt;</code> </pre> <br><p>  No nos detendremos en esto en detalle, una descripci√≥n exhaustiva del proceso de reconciliaci√≥n de la reacci√≥n sigue con el mismo Dan Abramov: <a href="https://overreacted.io/react-as-a-ui-runtime/">Reaccionar como un UI Runtime</a> . </p><br><h1 id="apparatnaya-chast-dve-krasnye-knopki">  Hardware: dos botones rojos </h1><br><p>  Entonces, ya hemos cumplido algunos de los requisitos para el juego: era multijugador, r√°pido y con una mec√°nica simple.  Queda por agregar a su entretenimiento.  La historia ser√° seguida por Yura Lilekov <a href="https://habr.com/ru/users/lilek/" class="user_link">lilek</a> , nuestro entusiasta del bricolaje, un orador constante de la comunidad, el creador del ala voladora y otros dispositivos de bricolaje. </p><br><p>  Realmente quer√≠amos encontrar dos botones mec√°nicos grandes.  Y para asegurarse de los rojos, como en ese meme con Agutin. </p><br><p>  Desafortunadamente, todo lo que se encontr√≥ en las tiendas en l√≠nea era demasiado peque√±o (5 cm de di√°metro) o no hab√≠a botones en absoluto.  Por supuesto, hab√≠a un buen AliExpress antiguo, pero no hab√≠a tiempo para esperar la entrega. </p><br><p>  Como resultado, encontramos los botones correctos en el sitio de una agencia creativa.  Botones en alg√∫n lugar de los suburbios hicieron Alexander (aparentemente, un graduado de la Facultad de Radio Electr√≥nica).  Llamamos por tel√©fono, preguntamos qu√© microcontrolador est√° cosido en la caja y pedimos que dejen acceso a √©l, porque necesitamos reprogramarlo. </p><br><p>  Alexander, por decirlo suavemente, se sorprendi√≥ de tales preguntas.  Cuando le preguntamos si los botones resistir√≠an la presi√≥n de los programadores entusiastas, nos asegur√≥ que tales botones est√°n en las m√°quinas tragamonedas en "Cosmic" y manejan perfectamente el flujo de los ni√±os.  Mirando hacia el futuro, dir√© que los ingenieros con calefacci√≥n tambi√©n mantuvieron los botones (solo la bater√≠a tuvo que cambiarse una vez). </p><br><p><img src="https://habrastorage.org/webt/bh/hb/bd/bhhbbdvztsnypogvlbn3jpo3nvg.png"></p><br><h2 id="nachinka">  Relleno </h2><br><p>  Pero, desafortunadamente, el dispositivo terminado no ten√≠a todas las cualidades que necesit√°bamos.  Y si a√∫n puede deshacerse de los efectos de sonido cortando el cable al altavoz, entonces determinar autom√°ticamente qu√© bot√≥n se presion√≥ no fue una tarea f√°cil.  Se sugiri√≥ una opci√≥n simple: de alguna manera conecte este dispositivo a la computadora y traduzca las pulsaciones de estos botones en las pulsaciones del teclado. </p><br><p>  La soluci√≥n sin lujos - para tomar el viejo teclado USB y llevar un par de botones con cables adicionales desde el teclado al dispositivo - inmediatamente se descarta como una "granja colectiva".  Y conect√≥ el poder del bricolaje. </p><br><p>  Despu√©s de algunas deliberaciones, decidimos usar la placa Arduino Pro Micro basada en el microcontrolador ATmega32u4 de la familia AVmel de Atmel con la uni√≥n necesaria.  En esta placa, entre otras cosas, los puertos de E / S y MicroUSB est√°n separados.  Y lo m√°s importante: el microcontrolador ATmega32u4 puede actuar como un dispositivo HID, es decir, en nuestro caso, emular pulsaciones de teclas bajo ciertas condiciones. </p><br><p><img src="https://habrastorage.org/webt/me/pn/d9/mepnd9yvzya5fkqdxqgbsvtwgjo.png" alt="(La foto fue tomada de uno de los vendedores de Aliexpress.com"></p><br><p>  Para programar este microcontrolador, solo necesita el cable MicroUSB habitual y el entorno de desarrollo Arduino IDE. </p><br><p>  Despu√©s de instalar el entorno de desarrollo, los ejemplos de c√≥digo m√°s simples estar√°n disponibles de inmediato. </p><br><p>  Por ejemplo, un programa que emula la escritura en un teclado cuando se presiona un bot√≥n (conectado a un puerto de entrada / salida) se encuentra aqu√≠: </p><br><p>  Archivo-&gt; Ejemplos-&gt; USB-&gt; Teclado-&gt; KeyboardMessage </p><br><p>  La emulaci√≥n de las pulsaciones de teclas se logra de manera muy simple: </p><br><pre> <code class="cmake hljs"><span class="hljs-comment"><span class="hljs-comment">#include "Keyboard.h" //      void setup() { Keyboard.begin(); //   } void loop() { Keyboard.print("Test"); //   4  delay(1000); //   1  }</span></span></code> </pre> <br><p>  Leer el estado del puerto de entrada tampoco es nada lujoso: </p><br><pre> <code class="cmake hljs">int button_pin = <span class="hljs-number"><span class="hljs-number">7</span></span>; //  ,     void setup() { pinMode(button_pin, INPUT); //     } void loop() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (digitalRead(button_pin)) { //   } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { //    } }</code> </pre> <br><p>  Dado que el puerto se abre por voltaje, y no por corriente, las corrientes inducidas m√°s peque√±as en los cables que van desde el bot√≥n al puerto pueden dar falsos positivos.  Por lo tanto, recomendamos "tirar" de los puertos de entrada con resistencias de alta resistencia: la corriente inducida fluye instant√°neamente a trav√©s de √©l hacia la "tierra", evitando que ocurra una diferencia de alto voltaje entre la entrada y la "tierra" y, por lo tanto, no habr√° disparos falsos.  Para estos fines, una resistencia de 5-10 kŒ© es suficiente, que est√° conectada entre la entrada del microcontrolador y su "tierra". </p><br><p>  Por lo tanto, obtenemos el siguiente esquema: </p><br><p><img src="https://habrastorage.org/webt/gt/na/3l/gtna3lp5_d3iag_lzxh115oug6s.png"></p><br><p>  La placa Arduino Pro Micro a trav√©s de microUSB se conecta a una computadora port√°til con la parte de software del juego, dos botones se conectan a dos entradas de la placa y la fuente de alimentaci√≥n general.  Adem√°s, estas dos entradas son llevadas a tierra por dos resistencias. </p><br><p>  Cuando se presiona uno de los botones, la corriente de la salida de la fuente de alimentaci√≥n de la placa a trav√©s del bot√≥n va a la entrada correspondiente de la placa, por lo que veremos una "unidad" l√≥gica en la entrada. </p><br><p>  En la parte del software, decidimos emular las pulsaciones de teclas "flecha izquierda" y "flecha derecha", y tambi√©n dar un retraso de 4 segundos despu√©s de determinar la presi√≥n, para evitar clics repetidos por parte de los participantes o ruidos de contactos en los botones. </p><br><pre> <code class="cmake hljs"><span class="hljs-comment"><span class="hljs-comment">#include &lt;Keyboard.h&gt; char leftKey = KEY_LEFT_ARROW; char rightKey = KEY_RIGHT_ARROW; int btn1pin = 7; int btn1value = 0; int btn2pin = 8; int btn2value = 0; void setup() { pinMode(btn1pin, INPUT); pinMode(btn2pin, INPUT); Keyboard.begin(); } void loop() { btn1value = digitalRead(btn1pin); btn2value = digitalRead(btn2pin); if (btn1value == 1 &amp;&amp; btn2value == 1) { //    =    } else if (btn1value == 0 &amp;&amp; btn2value == 0) { //    =    } else if (btn1value == 1) { //    =       4  Keyboard.press(leftKey); delay(100); Keyboard.releaseAll(); delay(4000); } else if (btn2value == 1) { //    =       4  Keyboard.press(rightKey); delay(100); Keyboard.releaseAll(); delay(4000); } }</span></span></code> </pre> <br><p>  Entonces, con la ayuda de dispositivos simples, ense√±amos los botones para identificar al jugador que hace clic en ellos m√°s r√°pido que el oponente, y para se√±alar esto al presentador. </p><br><h2 id="upravlenie">  Gesti√≥n </h2><br><p>  Completamente manual y lo m√°s simple posible: </p><br><ul><li>  <strong>Espacio</strong> - Siguiente palabra </li><li>  <strong>Entrar</strong> - muestra la palabra correcta </li><li>  <strong>+</strong> - verdadero (1 punto) </li><li>  <strong>0</strong> - incorrecto (se√±alar al oponente) </li><li>  <strong>Desplazamiento a la</strong> izquierda: siguiente paso </li><li>  <strong>Desplazamiento a la</strong> derecha: paso anterior </li></ul><br><h1 id="rezultat">  Resultado </h1><br><p>  Los cuatro d√≠as de conferencias (dos en Highload ++, dos en Heisenbug) en el stand de Badoo jugaron continuamente "juego de adivinanzas de TI".  Todas nuestras esperanzas se hicieron realidad: </p><br><ul><li>  El juego atrajo tanto a participantes como a espectadores: toda una fila de personas se reunieron en el stand.  Es especialmente agradable que en el segundo d√≠a de las conferencias el n√∫mero de participantes no disminuy√≥. </li><li>  Los botones son la parte superior!  Agregue +100 a la emoci√≥n.  Incluso si los rivales eran extra√±os entre s√≠, el juego causaba muchas emociones. </li><li>  La idea con marcas en la insignia funcion√≥: sin dificultad para encontrar ganadores y recolectar contactos.  Un par de personas pidieron dejar su placa limpia, por lo que pusimos marcas en nuestras mu√±ecas (se borraron f√°cilmente). </li><li>  Entregamos 14 pares de auriculares y varios cientos de premios peque√±os.  ¬°Nadie se qued√≥ sin un regalo! </li></ul><br><p><img src="https://habrastorage.org/webt/zd/fd/vh/zdfdvheuxobpk3y0st_kbzpkgl0.jpeg"></p><br><div class="spoiler">  <b class="spoiler_title">Para participar en el juego en la conferencia, presentamos una mercanc√≠a genial</b> <div class="spoiler_text"><p>  <strong>Tomadores de decisiones en un im√°n.</strong>  No s√© qu√© hacer con la tarea: ¬°gira el disco m√°gico!  Solo nos quedan un par de fotos, ya que entregamos todo: </p><br><p><img src="https://habrastorage.org/webt/qe/yc/fw/qeycfwgjxk5wad7b4slq5uqgmy0.jpeg"><br>  <em>Para ingenieros de control de calidad</em> </p><br><p><img src="https://habrastorage.org/webt/wy/so/ct/wysoct41vwjzn6qd-lzog7nmo7o.jpeg"><br>  <em>Para desarrolladores</em> </p><br><p>  <strong>Cookies predictivas de TI</strong> <br>  Las predicciones se inventaron ellos mismos (52 opciones).  Hecho realidad con una probabilidad de hasta el 100%. </p><br><p><img src="https://habrastorage.org/webt/ni/c9/vu/nic9vu9vf1xqh3xb7dyyli-mqni.png"></p><br><p><img src="https://habrastorage.org/webt/av/nf/vm/avnfvmkteect_rwrelfazf8kuau.png"></p></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/482028/">https://habr.com/ru/post/482028/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../482010/index.html">"Nuevas epopeyas". Para desarrolladores, operaciones y personas curiosas</a></li>
<li><a href="../482012/index.html">Raspberry Pi e iperf: probador de ancho de banda para dispositivos Smart Home y IoT</a></li>
<li><a href="../482014/index.html">Acepta y decodifica TV anal√≥gica usando SDR y Python</a></li>
<li><a href="../482020/index.html">R, Monte Carlo y tareas empresariales</a></li>
<li><a href="../482022/index.html">¬°Solo mira! 20 pel√≠culas sobre ciencia y cient√≠ficos</a></li>
<li><a href="../482030/index.html">Vue.js: ganchos de ciclo de vida de sus componentes y los de terceros</a></li>
<li><a href="../482032/index.html">Jugamos con fuego: ejecutamos c√≥digo arbitrario en el desarrollo del iPhone 7</a></li>
<li><a href="../482034/index.html">Yandex: hay de todo ... acerca de los usuarios</a></li>
<li><a href="../482038/index.html">Estamos resumiendo los resultados de 2019 en Haber Career</a></li>
<li><a href="../482040/index.html">Ofrece programas de creaci√≥n de perfiles en C ++</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>