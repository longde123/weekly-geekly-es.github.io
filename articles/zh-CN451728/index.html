<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸš´ ğŸ‘‚ğŸ¾ â˜¸ï¸ RESTinioæ˜¯ä¸€ä¸ªå¼‚æ­¥HTTPæœåŠ¡å™¨ã€‚ å¼‚æ­¥çš„ ğŸ’• ğŸ§“ğŸ¼ ğŸ‘</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å‡ å¹´å‰ï¼Œæˆ‘ä»¬å‘å¸ƒäº†RESTinio ï¼Œè¿™æ˜¯æˆ‘ä»¬çš„å°å‹OpenSource C ++æ¡†æ¶ï¼Œç”¨äºå°†HTTPæœåŠ¡å™¨åµŒå…¥C ++åº”ç”¨ç¨‹åºã€‚ RESTinioåœ¨è¿™æ®µæ—¶é—´å†…å¹¶æ²¡æœ‰å¹¿å—æ¬¢è¿ï¼Œä½†æ˜¯å®ƒå¹¶æ²¡æœ‰ä¸¢å¤± ã€‚ æœ‰äººé€‰æ‹©å®ƒæ˜¯ä¸ºäº†å¯¹Windowsçš„â€œæœ¬æœºâ€æ”¯æŒï¼Œæœ‰äººé€‰æ‹©äº†æŸäº›å•ç‹¬çš„åŠŸèƒ½ï¼ˆä¾‹å¦‚sendfileæ”¯æŒï¼‰ï¼Œ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>RESTinioæ˜¯ä¸€ä¸ªå¼‚æ­¥HTTPæœåŠ¡å™¨ã€‚ å¼‚æ­¥çš„</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451728/"><p> å‡ å¹´å‰ï¼Œæˆ‘ä»¬å‘å¸ƒäº†<a href="">RESTinio</a> ï¼Œè¿™æ˜¯æˆ‘ä»¬çš„å°å‹OpenSource C ++æ¡†æ¶ï¼Œç”¨äºå°†HTTPæœåŠ¡å™¨åµŒå…¥C ++åº”ç”¨ç¨‹åºã€‚  RESTinioåœ¨è¿™æ®µæ—¶é—´å†…å¹¶æ²¡æœ‰å¹¿å—æ¬¢è¿ï¼Œä½†æ˜¯å®ƒå¹¶<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ²¡æœ‰ä¸¢å¤±</a> ã€‚ æœ‰äººé€‰æ‹©å®ƒæ˜¯ä¸ºäº†å¯¹Windowsçš„â€œæœ¬æœºâ€æ”¯æŒï¼Œæœ‰äººé€‰æ‹©äº†æŸäº›å•ç‹¬çš„åŠŸèƒ½ï¼ˆä¾‹å¦‚sendfileæ”¯æŒï¼‰ï¼Œæœ‰äººé€‰æ‹©äº†åŠŸèƒ½çš„æ¯”ä¾‹ï¼Œæ˜“äºä½¿ç”¨å’Œè‡ªå®šä¹‰ã€‚ ä½†æ˜¯ï¼Œæˆ‘è®¤ä¸ºï¼Œæœ€åˆï¼Œè®¸å¤šRESTinioéƒ½è¢«è¿™ä¸ªç®€æ´çš„â€œ Helloï¼ŒWorldâ€æ‰€å¸å¼•ï¼š </p><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;restinio/all.hpp&gt; int main() { restinio::run( restinio::on_this_thread() .port(8080) .address("localhost") .request_handler([](auto req) { return req-&gt;create_response().set_body("Hello, World!").done(); })); return 0; }</span></span></span></span></code> </pre> <br><p> è¿™å®é™…ä¸Šæ˜¯åœ¨C ++åº”ç”¨ç¨‹åºä¸­è¿è¡ŒHTTPæœåŠ¡å™¨æ‰€éœ€çš„å…¨éƒ¨ã€‚ </p><br><p> è€Œä¸”å°½ç®¡å°½ç®¡æˆ‘ä»¬æ€»æ˜¯è¯•å›¾è¯´æˆ‘ä»¬é€šå¸¸ä½¿ç”¨RESTinioçš„ä¸»è¦åŠŸèƒ½æ˜¯ä¼ å…¥è¯·æ±‚çš„å¼‚æ­¥å¤„ç†ï¼Œä½†æ˜¯æˆ‘ä»¬ä»ç„¶å¶å°”ä¼šé‡åˆ°ä¸€äº›é—®é¢˜ï¼Œå³å¦‚æœå¿…é¡»åœ¨request_handlerä¸­æ‰§è¡Œé•¿æ—¶é—´çš„æ“ä½œï¼Œè¯¥æ€ä¹ˆåŠã€‚ </p><br><p> æ—¢ç„¶è¿™æ ·çš„é—®é¢˜æ˜¯ç›¸å…³çš„ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥å†æ¬¡è®¨è®ºå®ƒï¼Œå¹¶ä¸¾å‡ ä¸ªå°ä¾‹å­ã€‚ </p><a name="habracut"></a><br><h1 id="nebolshaya-otsylka-k-istokam"> å¯¹èµ·æºçš„ä¸€ç‚¹å‚è€ƒ </h1><br><p> æˆ‘ä»¬å†³å®šè¿ç»­å‡ æ¬¡è®©åµŒå…¥å¼HTTPæœåŠ¡å™¨é¢ä¸´éå¸¸ç›¸ä¼¼çš„ä»»åŠ¡ï¼šæœ‰å¿…è¦ä¸ºç°æœ‰çš„C ++åº”ç”¨ç¨‹åºç»„ç»‡HTTPè¾“å…¥ï¼Œæˆ–è€…æœ‰å¿…è¦ç¼–å†™å¾®æœåŠ¡ï¼Œå…¶ä¸­å¿…é¡»é‡ç”¨å·²ç»å­˜åœ¨çš„â€œç¹é‡â€ C ++ nyä»£ç ã€‚ è¿™äº›ä»»åŠ¡çš„å…±åŒç‰¹å¾æ˜¯è¯·æ±‚çš„åº”ç”¨ç¨‹åºå¤„ç†å¯èƒ½ä¼šå»¶é•¿æ•°åç§’ã€‚ </p><br><p> ç²—ç•¥åœ°è¯´ï¼Œä¸€æ¯«ç§’ä¹‹å†…ï¼ŒHTTPæœåŠ¡å™¨æ­£åœ¨æ•´ç†ä¸€ä¸ªæ–°çš„HTTPè¯·æ±‚ï¼Œä½†æ˜¯ä¸ºäº†å‘å‡ºHTTPå“åº”ï¼Œæœ‰å¿…è¦æ±‚åŠ©äºæŸäº›å…¶ä»–æœåŠ¡æˆ–è¿›è¡Œä¸€äº›å†—é•¿çš„è®¡ç®—ã€‚ å¦‚æœä»¥åŒæ­¥æ–¹å¼å¤„ç†HTTPè¯·æ±‚ï¼Œåˆ™HTTPæœåŠ¡å™¨å°†éœ€è¦æˆåƒä¸Šä¸‡ä¸ªå·¥ä½œçº¿ç¨‹æ± ï¼Œå³ä½¿åœ¨ç°ä»£æ¡ä»¶ä¸‹ï¼Œä¹Ÿå¾ˆéš¾è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚ </p><br><p> å½“HTTPæœåŠ¡å™¨åªèƒ½åœ¨ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ä¸Šæ‰§è¡ŒI / Oå¹¶è°ƒç”¨è¯·æ±‚å¤„ç†ç¨‹åºæ—¶ï¼Œè¿™å°†æ›´åŠ æ–¹ä¾¿ã€‚ è¯·æ±‚å¤„ç†ç¨‹åºä»…å§”æ‰˜å…¶ä»–å·¥ä½œçº¿ç¨‹çš„å®é™…å¤„ç†ï¼Œå¹¶å°†æ§åˆ¶æƒè¿”å›ç»™HTTPæœåŠ¡å™¨ã€‚ å½“å¾ˆæ™šä»¥åï¼Œåœ¨å¦ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ä¸Šçš„æŸä¸ªåœ°æ–¹ï¼Œä¿¡æ¯å‡†å¤‡å¥½å“åº”è¯¥è¯·æ±‚æ—¶ï¼Œå°±ä¼šç®€å•åœ°ç”Ÿæˆä¸€ä¸ªHTTPå“åº”ï¼Œè¯¥HTTPå“åº”ä¼šè‡ªåŠ¨é€‰æ‹©HTTPæœåŠ¡å™¨å¹¶å°†æ­¤å“åº”å‘é€åˆ°é€‚å½“çš„å®¢æˆ·ç«¯ã€‚ </p><br><p> ç”±äºæˆ‘ä»¬ä»æœªæ‰¾åˆ°è¿‡æ˜“äºä½¿ç”¨ä¸”æ˜“äºä½¿ç”¨çš„ç°æˆç‰ˆæœ¬ï¼Œå› æ­¤å®ƒæ˜¯è·¨å¹³å°çš„ï¼Œå¹¶ä¸”æ”¯æŒWindowsä½œä¸ºâ€œæœ¬æœºâ€å¹³å°ï¼Œå°†æˆ–å¤šæˆ–å°‘æä¾›ä¸é”™çš„æ€§èƒ½ï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œå°†å…¶ä¸“é—¨é’ˆå¯¹å¼‚æ­¥è¿›è¡Œä¼˜åŒ–ã€‚å·¥ä½œï¼Œç„¶ååœ¨2017å¹´åˆï¼Œæˆ‘ä»¬å¼€å§‹å¼€å‘RESTinioã€‚ </p><br><p> æˆ‘ä»¬å¸Œæœ›ä½¿å¼‚æ­¥åµŒå…¥å¼HTTPæœåŠ¡å™¨æ˜“äºä½¿ç”¨ï¼Œå°†ç”¨æˆ·ä»æ—¥å¸¸å·¥ä½œä¸­è§£æ”¾å‡ºæ¥ï¼ŒåŒæ—¶æˆ–å¤šæˆ–å°‘åœ°æé«˜ç”Ÿäº§åŠ›ï¼Œè·¨å¹³å°å¹¶å…è®¸é’ˆå¯¹ä¸åŒæ¡ä»¶è¿›è¡Œçµæ´»é…ç½®ã€‚ å®ƒä¼¼ä¹æ­£åœ¨è§£å†³ï¼Œä½†è®©ç”¨æˆ·æ¥åˆ¤æ–­... </p><br><h1 id="itak-est-vhodyaschiy-zapros-trebuyuschiy-mnogo-vremeni-na-obrabotku-chto-delat"> å› æ­¤ï¼Œå­˜åœ¨ä¸€ä¸ªä¼ å…¥è¯·æ±‚ï¼Œéœ€è¦å¤§é‡å¤„ç†æ—¶é—´ã€‚ æ€ä¹ˆåŠ </h1><br><h2 id="rabochie-niti-restinioasio"> å·¥ä½œçº¿ç¨‹RESTinio / Asio </h2><br><p> æœ‰æ—¶RESTinioç”¨æˆ·ä¸ä¼šè€ƒè™‘ä»€ä¹ˆå·¥ä½œçº¿ç¨‹ä»¥åŠå¦‚ä½•æ­£ç¡®ä½¿ç”¨RESTinioã€‚ ä¾‹å¦‚ï¼ŒæŸäººå¯èƒ½ä¼šè®¤ä¸ºï¼Œå½“åœ¨ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ä¸Š<code>run(on_this_thread(...))</code>å¦‚ä¸Šä¾‹æ‰€ç¤ºï¼Œä½¿ç”¨<code>run(on_this_thread(...))</code> ï¼‰ï¼Œé‚£ä¹ˆRESTinioä»…åœ¨è¯¥å·¥ä½œçº¿ç¨‹ä¸Šè°ƒç”¨è¯·æ±‚å¤„ç†ç¨‹åºã€‚ è€Œå¯¹äºI / Oï¼ŒRESTinioåœ¨åå°åˆ›å»ºäº†ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ã€‚ å½“ä¸»å·¥ä½œçº¿ç¨‹è¢«request_handlerå ç”¨æ—¶ï¼Œè¯¥å•ç‹¬çš„çº¿ç¨‹ç»§ç»­ä¸ºæ–°è¿æ¥æä¾›æœåŠ¡ã€‚ </p><br><p> å®é™…ä¸Šï¼Œç”¨æˆ·åˆ†é…ç»™RESTinioçš„æ‰€æœ‰çº¿ç¨‹éƒ½ç”¨äºæ‰§è¡ŒI / Oæ“ä½œå’Œè°ƒç”¨request_handlersã€‚ å› æ­¤ï¼Œå¦‚æœé€šè¿‡<code>run(on_this_thread(...))</code>å¯åŠ¨RESTinioæœåŠ¡å™¨ï¼Œåˆ™åœ¨å½“å‰çº¿ç¨‹çš„<code>run()</code>å†…éƒ¨ï¼Œå°†æ‰§è¡ŒI / Oå’Œè¯·æ±‚å¤„ç†ç¨‹åºã€‚ </p><br><p> ç²—ç•¥åœ°è¯´ï¼ŒRESTinioå¯åŠ¨ä¸€ä¸ªAsioäº‹ä»¶å¾ªç¯ï¼Œåœ¨è¯¥å¾ªç¯ä¸­å®ƒå¤„ç†æ–°è¿æ¥ï¼Œä»ç°æœ‰è¿æ¥ä¸­è¯»å–å’Œè§£ææ•°æ®ï¼Œå†™å…¥å‡†å¤‡å‘é€çš„æ•°æ®ï¼Œå¤„ç†å…³é—­è¿æ¥ç­‰ã€‚ é™¤å…¶ä»–äº‹é¡¹å¤–ï¼Œåœ¨ä»ä¸‹ä¸€ä¸ªè¿æ¥è¯»å–å¹¶å®Œå…¨è§£æäº†ä¼ å…¥çš„è¯·æ±‚ä¹‹åï¼Œå°†è°ƒç”¨ç”¨æˆ·æŒ‡å®šçš„request_handleræ¥å¤„ç†æ­¤è¯·æ±‚ã€‚ </p><br><p> å› æ­¤ï¼Œå¦‚æœrequest_handleré˜»æ­¢äº†å½“å‰çº¿ç¨‹çš„æ“ä½œï¼Œé‚£ä¹ˆä¹Ÿå°†é˜»æ­¢åœ¨åŒä¸€çº¿ç¨‹ä¸Šå·¥ä½œçš„Asio-actionäº‹ä»¶å¾ªç¯ã€‚ ä¸€åˆ‡éƒ½å¾ˆç®€å•ã€‚ </p><br><p> å¦‚æœRESTinioæ˜¯åœ¨å·¥ä½œçº¿ç¨‹æ± ä¸Šå¯åŠ¨çš„ï¼ˆå³é€šè¿‡<code>run(on_thread_pool(...))</code> ï¼Œå¦‚<a href="">æœ¬ä¾‹ä¸­æ‰€ç¤º</a> ï¼‰ï¼Œåˆ™ä¼šå‘ç”Ÿå‡ ä¹ç›¸åŒçš„äº‹æƒ…ï¼šä¸€ä¸ªAsio-eventäº‹ä»¶å¾ªç¯åœ¨æ± ä¸­çš„æ¯ä¸ªçº¿ç¨‹ä¸Šå¯åŠ¨ã€‚ å› æ­¤ï¼Œå¦‚æœæŸäº›request_handlerå¼€å§‹ä¹˜ä»¥å¤§çŸ©é˜µï¼Œåˆ™è¿™å°†é˜»å¡æ± ä¸­çš„å·¥ä½œçº¿ç¨‹ï¼Œå¹¶ä¸”I / Oæ“ä½œå°†ä¸å†åœ¨è¯¥çº¿ç¨‹ä¸Šæä¾›æœåŠ¡ã€‚ </p><br><p> å› æ­¤ï¼Œåœ¨ä½¿ç”¨RESTinioæ—¶ï¼Œå¼€å‘äººå‘˜çš„ä»»åŠ¡æ˜¯åœ¨åˆç†çš„æ—¶é—´ï¼ˆæœ€å¥½ä¸æ˜¯å¾ˆé•¿æ—¶é—´ï¼‰å†…å®Œæˆä»–çš„request_handlersã€‚ </p><br><h2 id="nuzhen-li-vam-pul-rabochih-potokov-dlya-restinioasio"> æ‚¨æ˜¯å¦éœ€è¦RESTinio / Asioçš„å·¥ä½œæµæ± ï¼Ÿ </h2><br><p> å› æ­¤ï¼Œå½“ç”¨æˆ·æŒ‡å®šçš„request_handleré•¿æ—¶é—´é˜»å¡äº†å¯¹å…¶è°ƒç”¨çš„å·¥ä½œçº¿ç¨‹æ—¶ï¼Œè¯¥çº¿ç¨‹å°†å¤±å»å¤„ç†I / Oæ“ä½œçš„èƒ½åŠ›ã€‚ ä½†æ˜¯ï¼Œå¦‚æœrequest_handleréœ€è¦å¤§é‡æ—¶é—´æ¥å½¢æˆå“åº”æ€ä¹ˆåŠï¼Ÿ å‡è®¾ä»–æ‰§è¡ŒæŸç§ç¹é‡çš„è®¡ç®—æ“ä½œï¼ŒåŸåˆ™ä¸Šä¸èƒ½å°†å…¶æ—¶é—´ç¼©çŸ­åˆ°å‡ æ¯«ç§’ï¼Ÿ </p><br><p> å…¶ä¸­ä¸€ä½ç”¨æˆ·å¯èƒ½ä¼šè®¤ä¸ºï¼Œç”±äºRESTinioå¯ä»¥åœ¨å·¥ä½œçº¿ç¨‹æ± ä¸­å·¥ä½œï¼Œå› æ­¤åªéœ€æŒ‡å®šæ›´å¤§çš„æ± å¤§å°å³å¯ã€‚ </p><br><p> ä¸å¹¸çš„æ˜¯ï¼Œè¿™ä»…åœ¨å¾ˆå°‘å¹¶è¡Œè¿æ¥çš„ç®€å•æƒ…å†µä¸‹æœ‰æ•ˆã€‚ è€Œä¸”æŸ¥è¯¢å¼ºåº¦ä½ã€‚ å¦‚æœå¹¶è¡ŒæŸ¥è¯¢æ•°è¾¾åˆ°æ•°åƒï¼ˆè‡³å°‘åªæœ‰å‡ ç™¾ä¸ªï¼‰ï¼Œé‚£ä¹ˆå¾ˆå®¹æ˜“å‡ºç°ä»¥ä¸‹æƒ…å†µï¼šæ± ä¸­çš„æ‰€æœ‰å·¥ä½œçº¿ç¨‹éƒ½å°†å¿™äºå¤„ç†å·²æ¥å—çš„è¯·æ±‚ã€‚ å¹¶ä¸”å°†æ²¡æœ‰æ›´å¤šçº¿ç¨‹å¯ç”¨äºæ‰§è¡ŒI / Oæ“ä½œã€‚ ç»“æœï¼ŒæœåŠ¡å™¨å°†å¤±å»å…¶å“åº”èƒ½åŠ›ã€‚ åŒ…æ‹¬RESTinioå°†å¤±å»å¤„ç†è¶…æ—¶çš„èƒ½åŠ›ï¼ŒRESTinioåœ¨æ”¶åˆ°æ–°è¿æ¥å’Œå¤„ç†è¯·æ±‚æ—¶ä¼šè‡ªåŠ¨å°†å…¶è¶…æ—¶ã€‚ </p><br><p> å› æ­¤ï¼Œå¦‚æœæ‚¨éœ€è¦æ‰§è¡Œå†—é•¿çš„é˜»å¡æ“ä½œæ¥å¤„ç†ä¼ å…¥çš„è¯·æ±‚ï¼Œæœ€å¥½åªä¸ºRESTinioåˆ†é…ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œè€Œåˆ†é…å¤§é‡çš„å·¥ä½œæµæ¥æ‰§è¡Œè¿™äº›ç›¸åŒçš„æ“ä½œã€‚ è¯·æ±‚å¤„ç†ç¨‹åºä¼šå°†ä¸‹ä¸€ä¸ªè¯·æ±‚æ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œä»è¯¥é˜Ÿåˆ—ä¸­æ£€ç´¢è¯·æ±‚å¹¶å°†å…¶æäº¤è¿›è¡Œå¤„ç†ã€‚ </p><br><p> å½“æˆ‘ä»¬åœ¨æœ¬æ–‡ä¸­è®¨è®º<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Shrimpæ¼”ç¤ºé¡¹ç›®</a>æ—¶ï¼Œæˆ‘ä»¬è¯¦ç»†ç ”ç©¶äº†è¯¥æ–¹æ¡ˆçš„ä¸€ä¸ªç¤ºä¾‹ï¼šâ€œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Shrimpï¼šä½¿ç”¨ImageMagic ++ï¼ŒSObjectizerå’ŒRESTinioåœ¨ç°ä»£C ++ä¸­ç¼©æ”¾å’Œå…±äº«HTTPå›¾åƒ</a> ã€‚â€ </p><br><h2 id="primery-delegirovaniya-obrabotki-zaprosov-na-otdelnye-rabochie-niti"> å°†è¯·æ±‚å¤„ç†å§”æ´¾ç»™å„ä¸ªå·¥ä½œçº¿ç¨‹çš„ç¤ºä¾‹ </h2><br><p> ä¸Šé¢ï¼Œæˆ‘è¯•å›¾è§£é‡Šä¸ºä»€ä¹ˆæ²¡å¿…è¦åœ¨request_handlerå†…éƒ¨æ‰§è¡Œå†—é•¿çš„å¤„ç†ã€‚ æ˜¾è€Œæ˜“è§çš„ç»“æœä»ä½•è€Œæ¥ï¼šå†—é•¿çš„è¯·æ±‚å¤„ç†å¿…é¡»å§”æ‰˜ç»™å…¶ä»–ä¸€äº›å·¥ä½œçº¿ç¨‹ã€‚ è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å®ƒçš„å¤–è§‚ã€‚ </p><br><p> åœ¨ä¸‹é¢çš„ä¸¤ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ¥è¿è¡ŒRESTinioï¼Œå¹¶éœ€è¦å¦ä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ¥æ¨¡æ‹Ÿå†—é•¿çš„è¯·æ±‚å¤„ç†ã€‚ è€Œä¸”ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æŸç§æ¶ˆæ¯é˜Ÿåˆ—æ¥å°†è¯·æ±‚ä»RESTinioçº¿ç¨‹ä¼ è¾“åˆ°å•ç‹¬çš„å·¥ä½œçº¿ç¨‹ã€‚ </p><br><p> å¯¹äºè¿™ä¸¤ä¸ªç¤ºä¾‹ï¼Œæˆ‘æ— æ³•åœ¨è†ç›–ä¸Šè¿›è¡Œçº¿ç¨‹å®‰å…¨æ¶ˆæ¯é˜Ÿåˆ—çš„æ–°å®ç°ï¼Œå› æ­¤æˆ‘ä½¿ç”¨äº†æœ¬æœºSObjectizeråŠå…¶mchainï¼Œå®ƒä»¬æ˜¯CSPé€šé“ã€‚ æ‚¨å¯ä»¥åœ¨è¿™é‡Œé˜…è¯»æœ‰å…³mchainçš„æ›´å¤šä¿¡æ¯ï¼šâ€œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å·¥ä½œçº¿ç¨‹ä¹‹é—´çš„ä¿¡æ¯äº¤æ¢æ²¡æœ‰</a>éº»çƒ¦<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ï¼ŸCSPé€šé“å¯ä¸ºæˆ‘ä»¬æä¾›å¸®åŠ©</a> ã€‚â€ </p><br><h3 id="sohranenie-obekta-request_handle"> ä¿å­˜request_handleå¯¹è±¡ </h3><br><p> å»ºç«‹è¯·æ±‚å¤„ç†å§”æ‰˜çš„åŸºæœ¬æŠ€æœ¯æ˜¯å°†<code>request_handle_t</code>å¯¹è±¡è½¬ç§»åˆ°æŸä¸ªåœ°æ–¹ã€‚ </p><br><p> å½“RESTinioè°ƒç”¨ç”¨æˆ·æŒ‡å®šçš„request_handleræ¥å¤„ç†ä¼ å…¥è¯·æ±‚æ—¶ï¼Œç±»å‹<code>request_handle_t</code>çš„å¯¹è±¡å°†ä¼ é€’ç»™æ­¤<code>request_handle_t</code> ã€‚ æ­¤ç±»å‹ä»…æ˜¯æŒ‡å‘å·²æ¥æ”¶è¯·æ±‚å‚æ•°çš„æ™ºèƒ½æŒ‡é’ˆã€‚ å› æ­¤ï¼Œå¦‚æœæœ‰äººæ–¹ä¾¿åœ°è®¤ä¸º<code>request_handle_t</code>æ˜¯<code>shared_ptr</code> ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥æ”¾å¿ƒåœ°è¿™æ ·åšã€‚ è¿™ä¸ª<code>shared_ptr</code>æ˜¯ã€‚ </p><br><p> å¹¶ä¸”ç”±äº<code>request_handle_t</code>æ˜¯<code>shared_ptr</code> ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æŸä¸ªåœ°æ–¹å®‰å…¨åœ°ä¼ é€’æ­¤æ™ºèƒ½æŒ‡é’ˆã€‚ æˆ‘ä»¬å°†åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­è¿›è¡Œæ“ä½œã€‚ </p><br><p> å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå•ç‹¬çš„å·¥ä½œçº¿ç¨‹å’Œé€šé“ä¸ä¹‹é€šä¿¡ã€‚ è®©æˆ‘ä»¬å…¨éƒ¨åˆ›å»ºï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  SObjectizer. so_5::wrapped_env_t sobj; //  std::thread    . std::thread processing_thread; //    main      join. //    RAII. auto processing_thread_joiner = so_5::auto_join(processing_thread); //      . auto req_ch = so_5::create_mchain(sobj); //       main. //    RAII. auto ch_closer = so_5::auto_close_drop_content(req_ch); //     . //      main()  - , //     ,      join(). processing_thread = std::thread{ processing_thread_func, req_ch };</span></span></code> </pre> <br><p> å·¥ä½œçº¿ç¨‹çš„ä¸»ä½“æœ¬èº«ä½äº<code>processing_thread_func()</code>å‡½æ•°å†…éƒ¨ï¼Œç¨åæˆ‘ä»¬å°†è¿›è¡Œè®¨è®ºã€‚ </p><br><p> ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰ä¸€ä¸ªå•ç‹¬çš„å·¥ä½œçº¿ç¨‹å’Œä¸ä¹‹é€šä¿¡çš„é€šé“ã€‚ æ‚¨å¯ä»¥å¯åŠ¨RESTinioæœåŠ¡å™¨ï¼š </p><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// ,     . struct traits_t : public restinio::default_traits_t { using logger_t = restinio::shared_ostream_logger_t; }; restinio::run( restinio::on_this_thread&lt;traits_t&gt;() .port(8080) .address("localhost") .request_handler([req_ch](auto req) { //   GET-   . if(restinio::http_method_t::http_get == req-&gt;header().method() &amp;&amp; "/" == req-&gt;header().path()) { //    . so_5::send&lt;handle_request&gt;(req_ch, req); return restinio::request_accepted(); } else return restinio::request_rejected(); }) .cleanup_func([&amp;] { //      . //    , ..  req_ch //          //     . so_5::close_drop_content(req_ch); }));</span></span></code> </pre> <br><p> è¯¥æœåŠ¡å™¨çš„é€»è¾‘éå¸¸ç®€å•ã€‚ å¦‚æœGETè¯·æ±‚å·²é’ˆå¯¹â€œ /â€åˆ°è¾¾ï¼Œåˆ™æˆ‘ä»¬å§”æ´¾å•ä¸ªçº¿ç¨‹çš„è¯·æ±‚å¤„ç†ã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬æ‰§è¡Œä¸¤ä¸ªé‡è¦æ“ä½œï¼š </p><br><ul><li> å‘é€<code>request_handle_t</code>å¯¹è±¡åˆ°CSPé€šé“ã€‚ å½“æ­¤å¯¹è±¡å­˜å‚¨åœ¨CSPé€šé“å†…æˆ–å…¶ä»–ä½ç½®æ—¶ï¼ŒRESTinioçŸ¥é“è¯¥è¯·æ±‚ä»ç„¶æœ‰æ•ˆã€‚ </li><li> æˆ‘ä»¬ä»è¯·æ±‚å¤„ç†ç¨‹åºä¸­è¿”å›å€¼<code>restinio::request_accepted()</code> ã€‚ è¿™ä½¿RESTinioäº†è§£è¯·æ±‚å·²è¢«æ¥å—è¿›è¡Œå¤„ç†ï¼Œå¹¶ä¸”æ— æ³•å…³é—­ä¸å®¢æˆ·ç«¯çš„è¿æ¥ã€‚ </li></ul><br><p>  request_handlerä¸ä¼šç«‹å³ç”ŸæˆRESTinioå“åº”è¿™ä¸€äº‹å®ä¸ä¼šæ‰“æ‰°ã€‚ ä¸€æ—¦<code>restinio::request_accepted()</code> ï¼Œåˆ™ç”¨æˆ·å°†è´Ÿè´£å¤„ç†è¯·æ±‚ï¼Œå¹¶æœ‰ä¸€å¤©å°†ç”Ÿæˆå¯¹è¯·æ±‚çš„å“åº”ã€‚ </p><br><p> å¦‚æœè¯·æ±‚å¤„ç†ç¨‹åºè¿”å›<code>restinio::request_rejected()</code> ï¼Œåˆ™RESTinioä¼šç†è§£å°†ä¸ä¼šå¤„ç†è¯¥è¯·æ±‚ï¼Œå¹¶å°†å‘å®¢æˆ·ç«¯è¿”å›501é”™è¯¯ã€‚ </p><br><p> å› æ­¤ï¼Œæˆ‘ä»¬ä¿®å¤äº†åˆæ­¥ç»“æœï¼š <code>request_handle_t</code>å®ä¾‹å¯ä»¥ä¼ é€’åˆ°æŸä¸ªåœ°æ–¹ï¼Œå› ä¸ºå®é™…ä¸Šå®ƒæ˜¯<code>std::shared_ptr</code> ã€‚ åœ¨æ­¤å®ä¾‹å¤„äºæ´»åŠ¨çŠ¶æ€æ—¶ï¼ŒRESTinioè®¤ä¸ºè¯¥è¯·æ±‚æ­£åœ¨å¤„ç†ä¸­ã€‚ å¦‚æœè¯·æ±‚å¤„ç†ç¨‹åºè¿”å›<code>restinio::request_accepted()</code> ï¼Œåˆ™RESTinioå°†ä¸æ‹…å¿ƒå½“å‰å°šæœªç”Ÿæˆå¯¹è¯·æ±‚çš„å“åº”ã€‚ </p><br><p> ç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªéå¸¸ç‹¬ç«‹çš„çº¿ç¨‹çš„å®ç°ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processing_thread_func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(so_5::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">mchain_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> req_ch)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//       //    . std::random_device rd; std::mt19937 generator{rd()}; std::uniform_int_distribution&lt;&gt; pause_generator{350, 3500}; //      timeout_elapsed. auto delayed_ch = so_5::create_mchain(req_ch-&gt;environment()); //     -  . bool stop = false; select( so_5::from_all() //      . .on_close([&amp;stop](const auto &amp;) { stop = true; }) //     select(). //  select()     . .stop_on([&amp;stop]{ return stop; }), //   handle_request     RESTinio. case_(req_ch, [&amp;](handle_request cmd) { //     . const std::chrono::milliseconds pause{pause_generator(generator)}; //     . so_5::send_delayed&lt;timeout_elapsed&gt;(delayed_ch, //    timeout_elapsed. pause, //      timeout_elapsed. cmd.m_req, pause); }), //   timeout_elapsed. case_(delayed_ch, [](timeout_elapsed cmd) { //     . cmd.m_req-&gt;create_response() .set_body("Hello, World! (pause:" + std::to_string(cmd.m_pause.count()) + "ms)") .done(); }) ); }</span></span></code> </pre> <br><p> è¿™é‡Œçš„é€»è¾‘éå¸¸ç®€å•ï¼šæˆ‘ä»¬ä»¥<code>handle_request</code>æ¶ˆæ¯çš„å½¢å¼æ¥æ”¶åˆå§‹è¯·æ±‚ï¼Œå¹¶ä»¥<code>timeout_elapsed</code>æ¶ˆæ¯çš„å½¢å¼å°†å…¶è½¬å‘ç»™è‡ªå·±ï¼Œè¯¥æ¶ˆæ¯ä¼šå»¶è¿Ÿä¸€æ®µæ—¶é—´ã€‚ æˆ‘ä»¬ä»…åœ¨æ”¶åˆ°<code>timeout_elapsed</code>è¯·æ±‚è¿›è¡Œå®é™…å¤„ç†ã€‚ </p><br><p>  <strong>æ›´æ–°ã€‚</strong> åœ¨å•ç‹¬çš„å·¥ä½œçº¿ç¨‹ä¸Šè°ƒç”¨<code>done()</code>æ–¹æ³•æ—¶ï¼Œå°†é€šçŸ¥RESTinioå·²å‡ºç°ç°æˆçš„å“åº”ï¼Œéœ€è¦å°†å…¶å†™å…¥TCPè¿æ¥ã€‚  RESTinioå¯åŠ¨å†™æ“ä½œï¼Œä½†æ˜¯I / Oæ“ä½œæœ¬èº«ä¸ä¼šåœ¨è°ƒç”¨<code>done()</code>æ‰§è¡Œï¼Œè€Œæ˜¯åœ¨RESTinioæ‰§è¡ŒI / Oå¹¶è°ƒç”¨request_handlersçš„ä½ç½®æ‰§è¡Œã€‚ å³ åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œåœ¨å•ç‹¬çš„å·¥ä½œçº¿ç¨‹ä¸Šè°ƒç”¨äº†<code>done()</code> ï¼Œå¹¶ä¸”å°†åœ¨<code>restinio::run()</code>å·¥ä½œçš„ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œå†™æ“ä½œã€‚ </p><br><p> æ¶ˆæ¯æœ¬èº«å¦‚ä¸‹ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handle_request</span></span></span><span class="hljs-class"> {</span></span> restinio::<span class="hljs-keyword"><span class="hljs-keyword">request_handle_t</span></span> m_req; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">timeout_elapsed</span></span></span><span class="hljs-class"> {</span></span> restinio::<span class="hljs-keyword"><span class="hljs-keyword">request_handle_t</span></span> m_req; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::chrono::milliseconds m_pause; };</code> </pre> <br><p> å³ ä¸€ä¸ªå•ç‹¬çš„å·¥ä½œçº¿ç¨‹æ¥å—<code>request_handle_t</code>å¹¶ä¿å­˜ï¼Œç›´åˆ°æœ‰æœºä¼šå½¢æˆä¸€ä¸ªå®Œæ•´çš„å“åº”ä¸ºæ­¢ã€‚ å¹¶ä¸”å½“æœºä¼šå‡ºç°æ—¶ï¼Œåœ¨å·²ä¿å­˜çš„è¯·æ±‚å¯¹è±¡ä¸Šè°ƒç”¨<code>create_response()</code> ï¼Œå¹¶å°†å“åº”è¿”å›ç»™RESTinioã€‚ ç„¶åï¼ŒRESTinioå·²ç»åœ¨å…¶å·¥ä½œä¸Šä¸‹æ–‡ä¸­ç¼–å†™äº†ä¸ç›¸åº”å®¢æˆ·ç«¯æœ‰å…³çš„å“åº”ã€‚ </p><br><p> è¿™é‡Œï¼Œç”±äºåœ¨æ­¤åŸå§‹ç¤ºä¾‹ä¸­æ²¡æœ‰å®é™…å¤„ç†ï¼Œå› æ­¤<code>request_handle_t</code>å®ä¾‹å­˜å‚¨åœ¨<code>timeout_elapsed</code>å»¶è¿Ÿæ¶ˆæ¯ä¸­ã€‚ åœ¨å®é™…çš„åº”ç”¨ç¨‹åºä¸­ï¼Œ <code>request_handle_t</code>å¯ä»¥å­˜å‚¨åœ¨æŸç§é˜Ÿåˆ—ä¸­ï¼Œä¹Ÿå¯ä»¥å­˜å‚¨åœ¨ä¸ºå¤„ç†è¯·æ±‚è€Œåˆ›å»ºçš„æŸäº›å¯¹è±¡ä¸­ã€‚ </p><br><p> å¯ä»¥<a href="">åœ¨å¸¸è§„RESTinioç¤ºä¾‹ä¸­</a>æ‰¾åˆ°è¯¥ç¤ºä¾‹çš„å®Œæ•´ä»£ç ã€‚ </p><br><h4 id="neskolko-nebolshih-poyasneniy-po-kodu"> ä¸€äº›å°ä»£ç æ³¨é‡Š </h4><br><p> æ­¤æ„é€ è®¾ç½®RESTinioæœåŠ¡å™¨åº”å…·æœ‰çš„RESTinioå±æ€§ï¼š </p><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// ,     . struct traits_t : public restinio::default_traits_t { using logger_t = restinio::shared_ostream_logger_t; }; restinio::run( restinio::on_this_thread&lt;traits_t&gt;()</span></span></code> </pre> <br><p> å¯¹äºæ­¤ç¤ºä¾‹ï¼Œæˆ‘éœ€è¦RESTinioè®°å½•å…¶è¯·æ±‚å¤„ç†æ“ä½œã€‚ å› æ­¤ï¼Œæˆ‘å°†<code>logger_t</code>è®¾ç½®<code>logger_t</code>ä¸é»˜è®¤çš„<code>null_logger_t</code>ä¸åŒã€‚ ä½†æ˜¯å› ä¸º  RESTinioå®é™…ä¸Šå°†åœ¨å¤šä¸ªçº¿ç¨‹ä¸Šå·¥ä½œï¼ˆRESTinioå¤„ç†ä¸»çº¿ç¨‹ä¸Šçš„ä¼ å…¥è¯·æ±‚ï¼Œä½†å“åº”æ¥è‡ªå•ç‹¬çš„å·¥ä½œçº¿ç¨‹ï¼‰ï¼Œé‚£ä¹ˆæ‚¨éœ€è¦ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„è®°å½•å™¨ï¼Œå³<code>shared_ostream_logger_t</code> ã€‚ </p><br><p> åœ¨<code>processing_thread_func()</code>å†…éƒ¨ï¼Œä½¿ç”¨äº†SObjectizerå‡½æ•°<code>select()</code> ï¼Œè¿™ä¸select Go-shnæ„é€ æœ‰ç‚¹ç±»ä¼¼ï¼šæ‚¨å¯ä»¥ä¸€æ¬¡ä»å¤šä¸ªé€šé“è¯»å–å’Œå¤„ç†æ¶ˆæ¯ã€‚  <code>select()</code>å‡½æ•°å°†èµ·ä½œç”¨ï¼Œç›´åˆ°ä¼ é€’ç»™å®ƒçš„æ‰€æœ‰é€šé“éƒ½å…³é—­ã€‚ æˆ–ç›´åˆ°è¢«è¿«å‘Šè¯‰å¥¹è¯¥ç»“æŸäº†ã€‚ </p><br><p> åŒæ—¶ï¼Œå¦‚æœä¸RESTinioæœåŠ¡å™¨çš„é€šä¿¡é€šé“å·²å…³é—­ï¼Œåˆ™ç»§ç»­å·¥ä½œæ¯«æ— æ„ä¹‰ã€‚ å› æ­¤ï¼Œåœ¨<code>select()</code> ï¼Œç¡®å®šå…³é—­ä»»ä½•é€šé“çš„å“åº”ï¼šä¸€æ—¦å…³é—­é€šé“ï¼Œåœæ­¢æ ‡å¿—å°±ä¼šå‡é«˜ã€‚ è¿™å°†å¯¼è‡´<code>select()</code>çš„å®Œæˆå¹¶ä»<code>processing_thread_func()</code>é€€å‡ºã€‚ </p><br><h3 id="sohranenie-obekta-response_builder"> ä¿å­˜response_builderå¯¹è±¡ </h3><br><p> åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬è€ƒè™‘äº†ä¸€ä¸ªç®€å•çš„æƒ…å†µï¼Œå³å¯ä»¥ä¿å­˜<code>request_handle_t</code>ç›´åˆ°æˆ‘ä»¬å¯ä»¥ç«‹å³å°†æ•´ä¸ªå“åº”æä¾›ç»™è¯·æ±‚ã€‚ </p><br><p> ä½†æ˜¯ï¼Œä¾‹å¦‚ï¼Œå½“æ‚¨éœ€è¦åˆ†éƒ¨åˆ†ç»™å‡ºç­”æ¡ˆæ—¶ï¼Œå¯èƒ½ä¼šæœ‰æ›´å¤æ‚çš„åœºæ™¯ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬æ”¶åˆ°ä¸€ä¸ªè¯·æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥ç«‹å³ä»…å½¢æˆå“åº”çš„ç¬¬ä¸€éƒ¨åˆ†ã€‚ æˆ‘ä»¬å½¢æˆå®ƒã€‚ ç„¶åï¼Œç»è¿‡ä¸€æ®µæ—¶é—´ï¼Œæˆ‘ä»¬æœ‰æœºä¼šå½¢æˆç­”æ¡ˆçš„ç¬¬äºŒéƒ¨åˆ†ã€‚ ç„¶åï¼Œå†ç»è¿‡ä¸€äº›æ—¶é—´ï¼Œæˆ‘ä»¬å¯ä»¥å½¢æˆä¸‹ä¸€éƒ¨åˆ†ï¼Œä¾æ­¤ç±»æ¨ã€‚ </p><br><p> è€Œä¸”ï¼Œå¯¹æˆ‘ä»¬æ¥è¯´ï¼Œå¯èƒ½å¸Œæœ›æ‰€æœ‰è¿™äº›éƒ¨åˆ†åœ¨å½¢æˆå®ƒä»¬æ—¶éƒ½æ¶ˆå¤±ã€‚ å³ é¦–å…ˆæ˜¯ç­”æ¡ˆçš„ç¬¬ä¸€éƒ¨åˆ†ï¼Œä»¥ä¾¿å®¢æˆ·å¯ä»¥å‡å»å®ƒï¼Œç„¶åæ˜¯ç¬¬äºŒéƒ¨åˆ†ï¼Œç„¶åæ˜¯ç¬¬ä¸‰éƒ¨åˆ†ï¼Œä¾æ­¤ç±»æ¨ã€‚ </p><br><p> ç”±äº<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">responce_buildersçš„ç±»å‹ä¸åŒï¼Œ</a> RESTinioå…è®¸æ‚¨æ‰§è¡Œæ­¤æ“ä½œã€‚ ç‰¹åˆ«æ˜¯è¯¸å¦‚<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">user_å—æ§_output</a>å’Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">chunked_outputä¹‹</a>ç±»çš„ç±»å‹ã€‚ </p><br><p> åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»…ä¿å­˜<code>request_handle_t</code>æ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸º<code>request_handle_t</code>ä»…åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨<code>create_reponse()</code>ä¹‹å‰æ‰æœ‰ç”¨ã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨response_builderã€‚ å¥½å§... </p><br><p> å¥½å§ï¼Œæ²¡å…³ç³»ã€‚  Response_builderæ˜¯ä¸€ç§å¯ç§»åŠ¨ç±»å‹ï¼Œæœ‰ç‚¹ç±»ä¼¼äºunique_ptrã€‚ å› æ­¤ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨éœ€è¦æ—¶ä¿ç•™å®ƒã€‚ ä¸ºäº†å±•ç¤ºå®ƒçš„å¤–è§‚ï¼Œæˆ‘ä»¬ç¨å¾®é‡åšä¸Šé¢çš„ç¤ºä¾‹ã€‚ è®©<code>processing_thread_func()</code>å‡½æ•°éƒ¨åˆ†åœ°å½¢æˆå“åº”ã€‚ </p><br><p> è¿™ä¸€ç‚¹éƒ½ä¸å›°éš¾ã€‚ </p><br><p> é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ç¡®å®šnew <code>processing_thread_func()</code>å°†éœ€è¦çš„ç±»å‹ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handle_request</span></span></span><span class="hljs-class"> {</span></span> restinio::<span class="hljs-keyword"><span class="hljs-keyword">request_handle_t</span></span> m_req; }; <span class="hljs-comment"><span class="hljs-comment">//     . using output_t = restinio::chunked_output_t; //   reponse_builder-   . using response_t = restinio::response_builder_t&lt;output_t&gt;; //     . struct timeout_elapsed { response_t m_resp; int m_counter; };</span></span></code> </pre> <br><p>  <code>handle_request</code>æ¶ˆæ¯ä¿æŒä¸å˜ã€‚ ä½†æ˜¯ï¼Œåœ¨<code>timeout_elapsed</code>æ¶ˆæ¯ä¸­<code>timeout_elapsed</code>æˆ‘ä»¬ç°åœ¨ä¸å­˜å‚¨<code>request_handle_t</code> ï¼Œè€Œæ˜¯å­˜å‚¨æ‰€éœ€ç±»å‹çš„response_builderã€‚ åŠ ä¸Šå‰©ä½™éƒ¨åˆ†çš„è®¡æ•°å™¨ã€‚ ä¸€æ—¦é‡ç½®æ­¤è®¡æ•°å™¨ï¼Œè¯·æ±‚æœåŠ¡å°±ä¼šç»“æŸâ€‹â€‹ã€‚ </p><br><p> ç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªæ–°ç‰ˆæœ¬çš„<code>processing_thread_func()</code>å‡½æ•°ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processing_thread_func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(so_5::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">mchain_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> req_ch)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::random_device rd; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::mt19937 generator{rd()}; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::uniform_int_distribution&lt;&gt; pause_generator{<span class="hljs-number"><span class="hljs-number">350</span></span>, <span class="hljs-number"><span class="hljs-number">3500</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> delayed_ch = so_5::create_mchain(req_ch-&gt;environment()); <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> stop = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; select( so_5::from_all() .on_close([&amp;stop](<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> &amp;) { stop = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }) .stop_on([&amp;stop]{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> stop; }), case_(req_ch, [&amp;](handle_request cmd) { <span class="hljs-comment"><span class="hljs-comment">//    ,    . auto resp = cmd.m_req-&gt;create_response&lt;output_t&gt;(); resp.append_header( restinio::http_field::server, "RESTinio" ) .append_header_date_field() .append_header( restinio::http_field::content_type, "text/plain; charset=utf-8" ); //    ,  RESTinio //   . resp.flush(); //       . so_5::send_delayed&lt;so_5::mutable_msg&lt;timeout_elapsed&gt;&gt;(delayed_ch, //     . std::chrono::milliseconds{pause_generator(generator)}, //    timeout_elapsed. //     response_builder-  . std::move(resp), 3); }), case_(delayed_ch, [&amp;](so_5::mutable_mhood_t&lt;timeout_elapsed&gt; cmd) { //      . cmd-&gt;m_resp.append_chunk( "this is the next part of the response\n" ); //  RESTinio   . cmd-&gt;m_resp.flush(); cmd-&gt;m_counter -= 1; if( 0 != cmd-&gt;m_counter ) { //        . so_5::send_delayed( delayed_ch, std::chrono::milliseconds{pause_generator(generator)}, std::move(cmd)); } else // ,   . cmd-&gt;m_resp.done(); }) ); }</span></span></code> </pre> <br><p> å³     ,        .       .         . </p><br><p> <strong>Upd.</strong>   <code>flush()</code>   ,     <code>done()</code> : RESTinio   ,   I/O-    ,   <code>flush()</code> ,  ,  RESTinio  -   request_handler-. å³    <code>flush()</code>     ,        , ,   <code>restinio::run()</code> . </p><br><p>       ,    RESTinio    : </p><br><pre> <code class="plaintext hljs">[2019-05-13 15:02:35.106] TRACE: starting server on 127.0.0.1:8080 [2019-05-13 15:02:35.106] INFO: init accept #0 [2019-05-13 15:02:35.106] INFO: server started on 127.0.0.1:8080 [2019-05-13 15:02:39.050] TRACE: accept connection from 127.0.0.1:49280 on socket #0 [2019-05-13 15:02:39.050] TRACE: [connection:1] start connection with 127.0.0.1:49280 [2019-05-13 15:02:39.050] TRACE: [connection:1] start waiting for request [2019-05-13 15:02:39.050] TRACE: [connection:1] continue reading request [2019-05-13 15:02:39.050] TRACE: [connection:1] received 78 bytes [2019-05-13 15:02:39.050] TRACE: [connection:1] request received (#0): GET / [2019-05-13 15:02:39.050] TRACE: [connection:1] append response (#0), flags: { not_final_parts, connection_keepalive }, write group size: 1 [2019-05-13 15:02:39.050] TRACE: [connection:1] start next write group for response (#0), size: 1 [2019-05-13 15:02:39.050] TRACE: [connection:1] start response (#0): HTTP/1.1 200 OK [2019-05-13 15:02:39.050] TRACE: [connection:1] sending resp data, buf count: 1, total size: 167 [2019-05-13 15:02:39.050] TRACE: [connection:1] outgoing data was sent: 167 bytes [2019-05-13 15:02:39.050] TRACE: [connection:1] finishing current write group [2019-05-13 15:02:39.050] TRACE: [connection:1] should keep alive [2019-05-13 15:02:40.190] TRACE: [connection:1] append response (#0), flags: { not_final_parts, connection_keepalive }, write group size: 3 [2019-05-13 15:02:40.190] TRACE: [connection:1] start next write group for response (#0), size: 3 [2019-05-13 15:02:40.190] TRACE: [connection:1] sending resp data, buf count: 3, total size: 42 [2019-05-13 15:02:40.190] TRACE: [connection:1] outgoing data was sent: 42 bytes [2019-05-13 15:02:40.190] TRACE: [connection:1] finishing current write group [2019-05-13 15:02:40.190] TRACE: [connection:1] should keep alive [2019-05-13 15:02:43.542] TRACE: [connection:1] append response (#0), flags: { not_final_parts, connection_keepalive }, write group size: 3 [2019-05-13 15:02:43.542] TRACE: [connection:1] start next write group for response (#0), size: 3 [2019-05-13 15:02:43.542] TRACE: [connection:1] sending resp data, buf count: 3, total size: 42 [2019-05-13 15:02:43.542] TRACE: [connection:1] outgoing data was sent: 42 bytes [2019-05-13 15:02:43.542] TRACE: [connection:1] finishing current write group [2019-05-13 15:02:43.542] TRACE: [connection:1] should keep alive [2019-05-13 15:02:46.297] TRACE: [connection:1] append response (#0), flags: { not_final_parts, connection_keepalive }, write group size: 3 [2019-05-13 15:02:46.297] TRACE: [connection:1] start next write group for response (#0), size: 3 [2019-05-13 15:02:46.297] TRACE: [connection:1] sending resp data, buf count: 3, total size: 42 [2019-05-13 15:02:46.297] TRACE: [connection:1] append response (#0), flags: { final_parts, connection_keepalive }, write group size: 1 [2019-05-13 15:02:46.297] TRACE: [connection:1] outgoing data was sent: 42 bytes [2019-05-13 15:02:46.298] TRACE: [connection:1] finishing current write group [2019-05-13 15:02:46.298] TRACE: [connection:1] should keep alive [2019-05-13 15:02:46.298] TRACE: [connection:1] start next write group for response (#0), size: 1 [2019-05-13 15:02:46.298] TRACE: [connection:1] sending resp data, buf count: 1, total size: 5 [2019-05-13 15:02:46.298] TRACE: [connection:1] outgoing data was sent: 5 bytes [2019-05-13 15:02:46.298] TRACE: [connection:1] finishing current write group [2019-05-13 15:02:46.298] TRACE: [connection:1] should keep alive [2019-05-13 15:02:46.298] TRACE: [connection:1] start waiting for request [2019-05-13 15:02:46.298] TRACE: [connection:1] continue reading request [2019-05-13 15:02:46.298] TRACE: [connection:1] EOF and no request, close connection [2019-05-13 15:02:46.298] TRACE: [connection:1] close [2019-05-13 15:02:46.298] TRACE: [connection:1] close: close socket [2019-05-13 15:02:46.298] TRACE: [connection:1] close: timer canceled [2019-05-13 15:02:46.298] TRACE: [connection:1] close: reset responses data [2019-05-13 15:02:46.298] TRACE: [connection:1] destructor called</code> </pre> <br><p>   ,  RESTinio           167 .          ,           , RESTinio          . </p><br><p>   ,    RESTinio   -     response_builder     ,        . </p><br><p>      .        , ,     .       response_builder   .     ,   responce_builder       ,          .. </p><br><p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> . </p><br><h2 id="chto-budet-esli-obrabotka-zaprosa-zaymet-slishkom-mnogo-vremeni">  ,       ? </h2><br><p> ,   request_handler-     -   .  ,      ,           ? </p><br><p>  RESTinio    ,   -  request_handler-.    - ,     , RESTinio       . ,         . , : </p><br><pre> <code class="plaintext hljs">[2019-05-13 15:32:23.618] TRACE: starting server on 127.0.0.1:8080 [2019-05-13 15:32:23.618] INFO: init accept #0 [2019-05-13 15:32:23.618] INFO: server started on 127.0.0.1:8080 [2019-05-13 15:32:26.768] TRACE: accept connection from 127.0.0.1:49502 on socket #0 [2019-05-13 15:32:26.768] TRACE: [connection:1] start connection with 127.0.0.1:49502 [2019-05-13 15:32:26.768] TRACE: [connection:1] start waiting for request [2019-05-13 15:32:26.768] TRACE: [connection:1] continue reading request [2019-05-13 15:32:26.768] TRACE: [connection:1] received 78 bytes [2019-05-13 15:32:26.768] TRACE: [connection:1] request received (#0): GET / [2019-05-13 15:32:30.768] TRACE: [connection:1] handle request timed out [2019-05-13 15:32:30.768] TRACE: [connection:1] close [2019-05-13 15:32:30.768] TRACE: [connection:1] close: close socket [2019-05-13 15:32:30.768] TRACE: [connection:1] close: timer canceled [2019-05-13 15:32:30.768] TRACE: [connection:1] close: reset responses data [2019-05-13 15:32:31.768] WARN: [connection:1] try to write response, while socket is closed [2019-05-13 15:32:31.768] TRACE: [connection:1] destructor called</code> </pre> <br><p>   -       . ,      ,  RESTinio   , ..     . </p><br><p>   -    <code>handle_request_timeout</code> ,     RESTinio- ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> ). </p><br><h1 id="zaklyuchenie"> ç»“è®º </h1><br><p> ,   ,      RESTinio â€”   ,   .  ,     RESTinio,    ,        RESTinio,     . </p><br><p>      RESTinio        ,  , ,  :  ? -  ? -  ? - -  ? </p><br><p>  PSã€‚    RESTinio     ,   SObjectizer,    .  ,  -   RESTinio ,     : " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> C++      HTTP-   </a> ", " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> HTTP-  C++:   RESTinio,   libcurl.  1</a> ", " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Shrimp:     HTTP    C++  ImageMagic++, SObjectizer  RESTinio</a> " </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN451728/">https://habr.com/ru/post/zh-CN451728/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN451718/index.html">åˆ›å»ºè¯­éŸ³åŠ©æ‰‹</a></li>
<li><a href="../zh-CN451720/index.html">FIASé€šè¿‡å³å…´ï¼ˆSQLXMLBULKLOADï¼‰çš„æ–¹å¼å°†FIASåŠ è½½åˆ°MSSQLSERVERä¸Šçš„æ•°æ®åº“ä¸­ã€‚ ä¸éœ€è¦æ€ä¹ˆåšï¼ˆå¯èƒ½ï¼‰</a></li>
<li><a href="../zh-CN451722/index.html">Qtå¼‚æ­¥å¼‚æ­¥å°éƒ¨ä»¶åº“</a></li>
<li><a href="../zh-CN451724/index.html">Skyrmionåˆ°Skyrmionä¸å’Œè°ï¼šé“å¼¹æ€§ä½“ä¸­çš„ä¸‰ç»´ææ€§Skyrmion</a></li>
<li><a href="../zh-CN451726/index.html">åœ¨å›½å¤–æ‰¾å·¥ä½œï¼šç»™ITä¸“ä¸šäººå‘˜çš„7ä¸ªç®€å•æŠ€å·§</a></li>
<li><a href="../zh-CN451738/index.html">å¯¹æ–‡ç« â€œ DeViSEï¼šæ·±åº¦è§†è§‰è¯­ä¹‰åµŒå…¥æ¨¡å‹â€çš„ç®€çŸ­è¯„è®º</a></li>
<li><a href="../zh-CN451742/index.html">åœ¨DotNext 2019 Piterçš„å‰ä¸€å¤©ã€‚ å…è´¹å¹¿æ’­å…¬å‘Š</a></li>
<li><a href="../zh-CN451746/index.html">é€‚ç”¨äºå·¥ç¨‹å¸ˆå’Œå»ºç­‘å¸ˆçš„MegaSlerm Kubernetes</a></li>
<li><a href="../zh-CN451748/index.html">ç›‘æ§Qsané˜µåˆ—ä¸­çš„SSDçŠ¶æ€</a></li>
<li><a href="../zh-CN451750/index.html">æœ¬ä¹¦â€œ Elasticsearchï¼ŒKibanaï¼ŒLogstashå’Œä¸‹ä¸€ä»£æœç´¢å¼•æ“â€</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>