<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßõüèº üéã üåö Distribui√ß√£o gratuita: Threads sem frenagem em Java. Tear do projeto ‚õπüèª üçÇ üí¢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Deseja threads de java que n√£o consomem mem√≥ria como se n√£o estivessem em si mesmas e n√£o diminuam a velocidade? Bom cr√©dito, e esse problema responde...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Distribui√ß√£o gratuita: Threads sem frenagem em Java. Tear do projeto</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/422519/"><p>  Deseja threads de java que n√£o consomem mem√≥ria como se n√£o estivessem em si mesmas e n√£o diminuam a velocidade?  Bom cr√©dito, e esse problema responde a essa pergunta. </p><br><p>  Explicamos o trabalho do Projeto Loom em caixas de pizza!  Vamos l√°! </p><br><p>  Tudo isso √© removido e escrito <b>especificamente para Habr</b> . </p><br><br><p><br clear="all"></p><a name="habracut"></a><br><h1 id="pozyvnye">  Indicativos de chamada </h1><br><p>  Voc√™ costuma ver esta imagem no seu servi√ßo da Web: no in√≠cio, tudo estava bem, ent√£o um milh√£o de chineses veio at√© voc√™, o servi√ßo fez um milh√£o de threads e se afogou no inferno? </p><br><p><img src="https://habrastorage.org/webt/ym/_-/3r/ym_-3rq8a8g56hsmrvjhprnih8y.png"><br><br></p><br><p>  Voc√™ quer uma imagem t√£o bonita? </p><br><p><img src="https://habrastorage.org/webt/38/s-/04/38s-04z5nak6trs_p2lei9chjku.png"><br><br></p><br><p>  Em outras palavras, voc√™ deseja em threads de java que n√£o consomem mem√≥ria, mas n√£o est√£o em si mesmos e n√£o diminuem a velocidade?  Bom cr√©dito, e esse problema responde a essa pergunta. </p><br><p>  Na verdade, estaremos envolvidos na <em>descompacta√ß√£o do novo quadro</em> .  Lembra como o Wylsacom desempacotou os iPhones?  Alguns j√° n√£o se lembram dos revisores antigos, mas por qu√™?  Porque Habr √© uma fortaleza convencional e os vidos pagos s√£o, desculpe, os <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">raios da diarr√©ia</a> .  Neste post, trataremos exclusivamente de hardcore t√©cnico. </p><br><p>  Primeiro, dois minutos para os globos oculares, isen√ß√£o de responsabilidade e outro lixo, o que deve ser dito.  Voc√™ pode pular se estiver com pregui√ßa. </p><br><p>  Antes de tudo, tudo o que foi dito no v√≠deo s√£o meus pensamentos pessoais, e eles n√£o t√™m nada a ver com o empregador ou a gloriosa corpora√ß√£o Oracle, o governo mundial de lagartos e uma coisa maldita em um morteiro.  Eu at√© escrevo isso √†s tr√™s horas da manh√£, para que fique claro que √© minha iniciativa pessoal, meu lixo pessoal.  <em>Todas as partidas s√£o puramente aleat√≥rias.</em> </p><br><p>  Mas h√° outro objetivo b√¥nus.  N√≥s falamos constantemente sobre corotinas em Kotlin.  Recentemente, houve entrevistas com <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Roma Elizarov</a> , o deus de Corutin, e com <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Pasha Finkelstein</a> , que escrever√° sobre eles.  Em breve haver√° uma entrevista com Andrei Breslav - que √© o pai de Kotlin.  E em todos os lugares o projeto Loom √© mencionado de uma maneira ou de outra, porque √© um an√°logo da corotina.  E se voc√™ n√£o sabe o que √© Loom, pode ficar burro ao ler essas entrevistas.  Existem caras legais, eles discutem coisas legais.  E a√≠ est√° voc√™, e voc√™ n√£o est√° com eles, seu idiota.  Isso √© muito est√∫pido. </p><br><p>  N√£o fa√ßa isso, leia o que √© Loom neste artigo ou assista a este v√≠deo, explicarei tudo. </p><br><p>  Ent√£o, qual √© a complica√ß√£o.  Existe um cara assim, Ron Presler. </p><br><br><p><img src="https://habrastorage.org/webt/w-/tq/ut/w-tqutfyx33olnhdavtq_asdv9u.png"><br><br></p><br><p>  No ano passado, ele <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">foi para a lista de discuss√£o</a> , disse que os threads em Java s√£o uma porcaria e sugeriu que ele executasse o tempo de execu√ß√£o e o corrigisse.  E todo mundo ria dele e atirava pedras, merda, se n√£o pelo fato de ele ter escrito <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Quasar</a> anteriormente, e isso √© realmente muito legal.  Voc√™ pode jurar no Quasar por um longo tempo, mas parece estar l√° e funciona, e, no quadro geral de tudo isso, √© mais prov√°vel que seja uma conquista. </p><br><p>  H√° um monte de govnokodery que n√£o fazem nada, apenas diga.  Bem, acerte, eu sou o mesmo.  Ou h√° pessoas que parecem ser engenheiros legais, mas em geral no inconsciente, eles dizem o seguinte: "Em Java, voc√™ precisa melhorar os threads".  O que melhorar?  O que s√£o t√≥picos? </p><br><p>  As pessoas geralmente t√™m pregui√ßa de pensar. </p><br><p>  Como em uma piada: <br>  Petka e Vasily Ivanovich voam em um avi√£o. <br>  Vasily Ivanovich pergunta: - Petka, dispositivos? <br>  Petka responde: - 200! <br>  Vasily Ivanovich: - E quanto a 200? <br>  Petka: - E os eletrodom√©sticos? </p><br><p>  Vou contar uma hist√≥ria.  Eu estava na Ucr√¢nia nesta primavera, voamos da Bielorr√∫ssia (voc√™ entende por que √© imposs√≠vel diretamente de S√£o Petersburgo).  E na alf√¢ndega, sentamos por cerca de duas horas, nada menos.  Os funcion√°rios da alf√¢ndega s√£o muito gentis, perguntando com seriedade se Java √© uma tecnologia obsoleta.  Pessoas sentadas nas proximidades que voam para o mesmo lugar.  E eu sou um tipo de orador, tenho que insistir, ficar em p√© e, como esperado, falar descaradamente sobre coisas que n√£o uso.  E ao longo do caminho, ele falou sobre a distribui√ß√£o JDK chamada Liberica, esse √© um JDK para o Raspberry Pi. </p><br><p>  E o que voc√™ acha?  Nem mesmo seis meses se passaram antes que as pessoas batessem no meu carrinho e dissessem que, olha, n√≥s colocamos uma solu√ß√£o em Liber no produto, e eu j√° tenho um relat√≥rio sobre isso no jfuture.by konf da Bielorr√∫ssia.  Essa √© a abordagem.  Este n√£o √© um evangelista ruim, mas um cara, um engenheiro normal. </p><br><blockquote>  A prop√≥sito, em breve teremos uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">confer√™ncia do Joker 2018</a> , que incluir√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Andrei Breslav</a> (obviamente vasculhando corotinas) e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Pasha Finkelshtein</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Josh Long</a> sobre o apoio da Spring ao Loom.  Bem, e um monte de especialistas proeminentes legais, vamos l√°! </blockquote><p>  E agora, retornando aos threads.  As pessoas tentam pensar nos seus dois neur√¥nios degradados, como um n√≥ sinuoso no punho e murmuram: "Em Java, os threads n√£o s√£o assim, em Java, os threads n√£o s√£o assim".  Devices!  Quais aparelhos?  Isso geralmente √© um inferno. </p><br><p>  E a√≠ vem Presler, um cara normal, n√£o degradado, e a princ√≠pio ele faz uma descri√ß√£o sensata.  Um ano depois, vendo uma demonstra√ß√£o de trabalho.  Eu disse tudo isso para que voc√™ entenda que uma descri√ß√£o normal dos problemas, a documenta√ß√£o normal √© um tipo especial de hero√≠smo.  E a demonstra√ß√£o √© geralmente espa√ßo.  Esta √© a primeira pessoa que realmente fez alguma coisa nessa dire√ß√£o.  Ele precisa mais. </p><br><p>  Juntamente com a demo, Presler falou na confer√™ncia e lan√ßou este v√≠deo: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/J31o0ZMQEnI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  De fato, este artigo inteiro √© uma revis√£o do que foi dito l√°.  Eu n√£o finjo absolutamente a singularidade desse material, tudo o que est√° neste artigo foi inventado por Ron. </p><br><p>  A discuss√£o √© sobre tr√™s t√≥picos dolorosos: </p><br><ul><li>  Continua√ß√£o </li><li>  Fibras </li><li>  Chamadas de cauda </li></ul><br><p>  Provavelmente, ele estava t√£o enojado vendo Quasar e lutando com suas falhas que n√£o h√° for√ßa - voc√™ precisa coloc√°-la em tempo de execu√ß√£o. </p><br><p>  Foi h√° um ano e desde ent√£o eles t√™m visto um prot√≥tipo.  Alguns j√° perderam a esperan√ßa de que algum dia veremos uma demonstra√ß√£o, mas h√° um m√™s eles deram √† luz e mostraram o que √© vis√≠vel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">neste tweet</a> . </p><br><br><p><img src="https://habrastorage.org/webt/ck/hp/mc/ckhpmcchdv2k6_4vfbw733evg6c.png"><br><br></p><br><p>  Todos os tr√™s t√≥picos dolorosos nesta demonstra√ß√£o est√£o diretamente no c√≥digo ou pelo menos moralmente presentes.  Bem, sim, eles ainda n√£o dominaram os chamados finais, mas querem. </p><br><h1 id="problematika">  Edi√ß√£o </h1><br><p>  Usu√°rios insatisfeitos, os desenvolvedores de aplicativos, quando criam uma API, s√£o for√ßados a escolher entre duas cadeiras.  Os picos s√£o constru√≠dos em uma cadeira, as flores crescem na outra.  E nem um nem o outro nos conv√©m. </p><br><br><p><img src="https://habrastorage.org/webt/tn/nx/k-/tnnxk-iwzuj7sybfwllour9qozq.png"><br><br></p><br><p>  Por exemplo, se voc√™ escreve um servi√ßo que funciona de forma s√≠ncrona, funciona muito bem com o c√≥digo herdado, √© f√°cil depurar e monitorar o desempenho.  Problemas surgir√£o com largura de banda e escalabilidade.  S√≥ porque o n√∫mero de threads que agora voc√™ pode executar em um simples peda√ßo de hardware, em hardware comum - bem, digamos, dois mil.  Isso √© muito menor que o n√∫mero de conex√µes que podem ser abertas para este servidor.  Que, do ponto de vista do c√≥digo de rede, pode ser quase infinito. </p><br><p>  (Bem, sim, isso tem algo a ver com o fato de que os soquetes em Java s√£o arranjados idiotas, mas esse √© um t√≥pico para outra conversa) </p><br><p>  Imagine que voc√™ est√° escrevendo algum tipo de MMO. </p><br><br><p><img src="https://habrastorage.org/webt/ye/mg/pm/yemgpm6on0pidozkhmco3epwapa.png"><br><br></p><br><p>  Por exemplo, durante a Guerra do Norte no EVE Online, dois mil e quatrocentos pilotos se reuniram em um ponto no espa√ßo, cada um deles - condicionalmente, se fosse escrito em Java - n√£o seria um segmento, mas v√°rios.  E o piloto, √© claro, √© uma l√≥gica de neg√≥cios complexa, e n√£o a emiss√£o de qualquer HTML que possa ser descartado manualmente em uma lupa. </p><br><p>  O tempo de resposta naquela batalha foi t√£o longo que o jogador teve que esperar alguns minutos para aguardar o tiro.  At√© onde eu sei, o CCP especificamente para essa batalha lan√ßou os enormes recursos de hardware de seu cluster. </p><br><p>  Embora eu provavelmente cite o EVE como um exemplo em v√£o, porque, at√© onde eu entendi, tudo est√° escrito em Python, e em Python com multithreading ainda √© pior que o nosso - e podemos considerar uma fraca competi√ß√£o de recursos da linguagem.  Mas ent√£o o exemplo √© claro e com imagens. </p><br><p>  Se voc√™ est√° interessado no assunto da OMI em geral e na hist√≥ria da ‚ÄúGuerra do Norte‚Äù em particular, recentemente um v√≠deo muito bom sobre esse assunto apareceu no canal Bulzhat (seja l√° o que esse nome significa), assista no meu registro de data e hora. </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/AkAtiTNvjz8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Voltamos ao t√≥pico. </p><br><p>  Por outro lado, voc√™ pode usar algum tipo de estrutura ass√≠ncrona.  √â escal√°vel.  Mas cairemos imediatamente em uma depura√ß√£o muito dif√≠cil, um perfil complicado do desempenho, n√£o poderemos integr√°-lo perfeitamente ao legado, voc√™ precisar√° reescrever muitas coisas, envolv√™-las em inv√≥lucros abomin√°veis ‚Äã‚Äãe, geralmente, parecer que acabamos de ser estuprados.  V√°rias vezes seguidas.  De fato, durante dias, durante todo o tempo em que escrevermos isso, voc√™ ter√° que se sentir assim. </p><br><p>  Perguntei ao especialista, o famoso acad√™mico Escobar, o que ele pensa sobre isso: </p><br><br><p><img width="300" src="https://habrastorage.org/webt/7g/hf/mg/7ghfmg3x8aqhdl0jcyrbpairqsc.png"><br><br></p><br><p>  O que fazer?  As chamadas fibras est√£o com pressa para ajudar. </p><br><p>  No caso geral, as fibras s√£o threads t√£o leves que tamb√©m vasculham o espa√ßo de endere√ßo (porque milagres n√£o acontecem, voc√™ entende).  Mas, diferentemente dos encadeamentos comuns, eles n√£o usam multitarefa preemptiva, mas multitarefa cooperativa.  Leia mais <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">na Wikipedia</a> . </p><br><p>  A fibra pode aproveitar as vantagens da programa√ß√£o s√≠ncrona e ass√≠ncrona.  Como resultado, a utiliza√ß√£o de ferro √© aumentada e usamos menos servidores no cluster para a mesma tarefa.  Bem, no nosso bolso para isso, temos lavanda.  Babos.  Lave.  Dinheiro  Bem, voc√™ entendeu.  Para o servidor salvo. </p><br><h1 id="na-raspute">  Na encruzilhada </h1><br><p>  A primeira coisa que quero discutir.  As pessoas n√£o entendem a diferen√ßa entre continua√ß√µes e fibra. <br>  Agora haver√° uma ilumina√ß√£o de culto! </p><br><p>  Anunciaremos o fato: Continua√ß√£o e Fibra s√£o duas coisas diferentes. </p><br><h1 id="continuations">  Continua√ß√µes </h1><br><p>  As fibras s√£o constru√≠das em cima de um mec√¢nico chamado Continua√ß√µes. </p><br><p>  Continua√ß√µes (mais precisamente, continua√ß√µes delimitadas) √© um certo c√°lculo, execu√ß√£o, parte de um programa que pode adormecer, depois acorda e continua a execu√ß√£o do local em que adormeceu.  √Äs vezes, pode at√© ser clonado ou serializado, mesmo enquanto ele est√° dormindo. </p><br><p>  Usarei a palavra "continua√ß√£o", e n√£o "continua√ß√£o" (como est√° escrita na Wikipedia), porque todos n√≥s nos comunicamos no <em>idioma ingl√™s</em> .  Usando a terminologia russa normal, pode-se facilmente chegar a uma situa√ß√£o em que a diferen√ßa entre o termo russo e ingl√™s se torna muito grande e ningu√©m mais entende o significado do que foi dito. </p><br><p>  √Äs vezes, tamb√©m usarei a palavra "crowding out" em vez da vers√£o em ingl√™s de "yield".  Apenas a palavra "rendimento" - √© algum tipo de desagrad√°vel.  Portanto, haver√° ‚Äúlota√ß√£o‚Äù. </p><br><p>  Ent√£o aqui.  √â muito importante que n√£o haja concorr√™ncia dentro do continuum.  √â, por si s√≥, a primitiva m√≠nima desse processo. </p><br><p> Voc√™ pode pensar na continua√ß√£o como um <code>Runnable</code> , dentro do qual voc√™ pode chamar o m√©todo <code>pause()</code> .  √â interna e diretamente, porque nossa multitarefa √© cooperativa.  E ent√£o voc√™ pode execut√°-lo novamente e, em vez de recalcular tudo, ele continuar√° de onde parou.  Esse tipo de m√°gica.  Voltaremos √† magia. </p><br><p>  Onde obter uma demonstra√ß√£o com continua√ß√µes de trabalho - discutiremos no final.  Agora vamos falar sobre o que est√° l√°. </p><br><p>  A pr√≥pria classe de continua√ß√£o est√° localizada em java.base, todos os links estar√£o na descri√ß√£o.  ( <code>src/java.base/share/classes/java/lang/Continuation.java</code> ).  Mas essa classe √© muito grande, volumosa, por isso faz sentido olhar apenas para algum tipo de press√£o dela. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Continuation</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Runnable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Continuation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ContinuationScope scope, Runnable body)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">yield</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ContinuationScope scope)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isDone</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPinned</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Reason reason)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"Pinned: "</span></span> + reason); } }</code> </pre> <br><p>  Observe que, na verdade, esse arquivo est√° mudando constantemente.  Por exemplo, no dia anterior, a continua√ß√£o n√£o implementou a interface <code>Runnable</code> .  Trate isso como uma esp√©cie de esbo√ßo. </p><br><p>  D√™ uma olhada no construtor.  <code>body</code> - este √© o c√≥digo que voc√™ est√° tentando executar e o <code>scope</code> - √© um tipo de skop que permite aninhar continua√ß√µes em continua√ß√µes. </p><br><p>  Portanto, voc√™ pode pr√©-agendar esse c√≥digo at√© o final com o m√©todo <code>run</code> ou substitu√≠-lo por uma matriz espec√≠fica usando o m√©todo <code>yield</code> (a matriz √© necess√°ria aqui para algo como a√ß√µes de encaminhamento a manipuladores aninhados, mas n√£o nos importamos como usu√°rios).  Voc√™ pode perguntar usando o m√©todo <code>isDone</code> se tudo estiver conclu√≠do at√© o fim. </p><br><p>  E por motivos ditados apenas pelas necessidades da implementa√ß√£o atual (mas, provavelmente, ela tamb√©m ser√° inclu√≠da na vers√£o), nem sempre √© poss√≠vel obter <code>yield</code> .  Por exemplo, se dentro da continua√ß√£o tivemos uma transi√ß√£o para o c√≥digo nativo e um quadro nativo apareceu na pilha, √© imposs√≠vel ficar preso.  Isso tamb√©m acontecer√° se voc√™ tentar se espremer enquanto um monitor nativo, como um m√©todo sincronizado, √© levado para dentro do corpo do continuum.  Por padr√£o, quando voc√™ tenta fingir isso, uma exce√ß√£o √© lan√ßada ... mas as fibras constru√≠das sobre as continua√ß√µes sobrecarregam esse m√©todo e fazem outra coisa.  Isso ser√° um pouco mais tarde. </p><br><p>  Voc√™ pode usar isso aproximadamente da seguinte maneira: </p><br><pre> <code class="java hljs">Continuation cont = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Continuation(SCOPE, () -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { System.out.println(<span class="hljs-string"><span class="hljs-string">"before"</span></span>); Continuation.yield(SCOPE); System.out.println(<span class="hljs-string"><span class="hljs-string">"after"</span></span>); } }); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!cont.isDone()) { cont.run(); }</code> </pre> <br><p>  Este √© um exemplo da apresenta√ß√£o de Presler.  Novamente, este n√£o √© um c√≥digo "trivial", √© algum tipo de esbo√ßo. </p><br><p>  Este √© um esbo√ßo do que estamos fazendo continua√ß√£o, no meio dessa continua√ß√£o, estamos lotados e, em um ciclo intermin√°vel, perguntamos se a continua√ß√£o funcionou at√© o fim e se deve continuar. </p><br><p>  Mas, em geral, n√£o se pretende que programadores de aplicativos comuns se relacionem com essa API.  Destina-se aos criadores de estruturas de sistema.  Estruturas formadoras de sistemas como o Spring Framework adotam imediatamente esse recurso assim que ele sai.  Voc√™ ver√°.  Considere isso uma previs√£o.  Uma previs√£o t√£o leve, porque tudo √© bastante √≥bvio aqui.  Todos os dados para previs√£o s√£o.  Esse recurso √© importante demais para n√£o se adaptar.  Portanto, n√£o h√° necessidade de se preocupar com anteced√™ncia que algu√©m o torture com a codifica√ß√£o neste formul√°rio.  Bem, se voc√™ √© desenvolvedor de Spring, sabia o que estava fazendo. </p><br><p>  E agora, al√©m das continua√ß√µes, as fibras s√£o constru√≠das. </p><br><h1 id="fibers">  Fibras </h1><br><p>  Ent√£o, o que no nosso caso significa fibra. <br><br>  Este √© um tipo de abstra√ß√£o, que √©: </p><br><ul><li>  Encadeamentos leves processados ‚Äã‚Äãna pr√≥pria JVM e n√£o no sistema operacional; </li><li>  Com custos indiretos extremamente baixos para criar, manter a vida, alternar tarefas; </li><li>  Que pode ser executado milh√µes de vezes. </li></ul><br><p>  Muitas tecnologias est√£o tentando fabricar fibra de uma maneira ou de outra.  Por exemplo, no Kotlin, existem corotinas implementadas na gera√ß√£o muito inteligente de bytecodes.  <em>MUITO INTELIGENTE</em> .  Mas o tempo de execu√ß√£o √© um lugar melhor para implementar essas coisas. </p><br><p>  No m√≠nimo, a JVM j√° sabe lidar bem com os threads, e tudo o que precisamos fazer √© otimizar o processo de codifica√ß√£o para multithreading.  Voc√™ pode usar APIs ass√≠ncronas, mas isso dificilmente pode ser chamado de "simplifica√ß√£o": mesmo usando coisas como o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Reactor</a> , o Spring Project Reactor, que permite escrever c√≥digo aparentemente linear, n√£o ajudar√° muito se voc√™ precisar depurar problemas complexos. </p><br><p>  So Fiber. </p><br><p>  Fibra consiste em dois componentes.  Isto √©: </p><br><ul><li>  Continua√ß√£o </li><li>  Programador </li></ul><br><p>  Isto √©: </p><br><ul><li>  Continua√ß√£o </li><li>  Planejador </li></ul><br><br><p><img src="https://habrastorage.org/webt/ga/wc/yk/gawcykupqgqwqjwfxcpccyltenu.jpeg"><br><br></p><br><p>  Voc√™ pode decidir quem √© o planejador aqui.  Eu acho que o planejador aqui √© Jay. </p><br><ul><li>  A fibra envolve o c√≥digo que voc√™ deseja executar em uma continua√ß√£o </li><li>  O Agendador os lan√ßa em um pool de threads de operadora </li></ul><br><p>  <em>Vou cham√°-los de segmentos de operadora.</em> </p><br><br><br><p><img src="https://habrastorage.org/webt/j4/hc/gw/j4hcgwglzzsi6qe-cxczwcewohy.jpeg"><br><br></p><br><p>  O prot√≥tipo atual usa <code>java.util.concurrent.Executor</code> e o planejador <code>ForkJoinPool</code> .  N√≥s temos tudo.  No futuro, algo mais inteligente pode aparecer l√°, mas por enquanto, assim. </p><br><p>  Como a continua√ß√£o se comporta: </p><br><ul><li>  Est√° lotado (rendimento) quando ocorre um bloqueio (por exemplo, no IO); </li><li>  Continua quando estiver pronto para continuar (por exemplo, a opera√ß√£o de E / S foi conclu√≠da e voc√™ pode prosseguir). </li></ul><br><p>  Status atual das obras: </p><br><ul><li>  O foco principal na filosofia, conceitos; </li><li>  A API n√£o √© fixa, √© "para exibi√ß√£o".  Este √© um prot√≥tipo de pesquisa; </li><li>  Existe um prot√≥tipo de trabalho codificado pronto para a classe <code>java.lang.Fiber</code> . </li></ul><br><p>  Ser√° discutido. </p><br><p>  O que j√° foi serrado na fibra: </p><br><ul><li>  Executa um lan√ßamento de tarefa; </li><li>  Estacionamento sem estacionamento em uma transportadora; </li><li>  Aguardando a conclus√£o da fibra. </li></ul><br><h1 id="principialnaya-shema">  Diagrama de circuito </h1><br><pre> <code class="java hljs">mount(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { cont.run(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> () { unmount(); }</code> </pre> <br><ul><li>  Podemos montar uma fibra em um suporte de linha; </li><li>  Em seguida, execute a continua√ß√£o; </li><li>  E espere at√© que ela esteja lotada ou pare honestamente; </li><li>  No final, sempre deixamos o t√≥pico. </li></ul><br><p>  Esse pseudoc√≥digo ser√° executado no <code>ForkJoinPool</code> ou em algum outro (que eventualmente estar√° na vers√£o final). </p><br><h1 id="ispolzovanie-v-realnosti">  Use na realidade </h1><br><pre> <code class="java hljs">Fiber f = Fiber.execute( () -&gt; { System.out.println(<span class="hljs-string"><span class="hljs-string">"Good Morning!"</span></span>); readLock.lock(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { System.out.println(<span class="hljs-string"><span class="hljs-string">"Good Afternoon"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { readLock.unlock(); } System.out.println(<span class="hljs-string"><span class="hljs-string">"Good Night"</span></span>); });</code> </pre> <br><p>  Olha, estamos criando uma fibra na qual: </p><br><ul><li>  bem vindo a todos; </li><li>  estamos bloqueando o loke reentrante; </li><li>  ao retornar, parab√©ns pelo seu almo√ßo; </li><li>  finalmente solte a trava; </li><li>  e diga adeus. </li></ul><br><p>  Tudo √© muito simples. </p><br><p>  N√£o causamos aglomera√ß√£o diretamente.  O pr√≥prio Project Loom sabe que quando <code>readLock.lock();</code> acionado <code>readLock.lock();</code>  ele deve intervir e implicitamente fazer repress√£o.  O usu√°rio n√£o v√™ isso, mas acontece l√°. </p><br><h1 id="steki-povsyudu-steki">  Pilhas, pilhas em todos os lugares! </h1><br><p>  Vamos demonstrar o que est√° acontecendo usando a pilha de pizza como exemplo. </p><br><p>  No in√≠cio, o encadeamento do transportador est√° em um estado de espera e nada acontece. </p><br><p><img src="https://habrastorage.org/webt/8y/gw/mr/8ygwmr7dc_owazfdj-wa4trrs4g.png"><br><br></p><br><p>  Topo da pilha no topo, lembre-se. </p><br><p>  Em seguida, a fibra foi agendada para execu√ß√£o e a tarefa de fibra come√ßou a ser executada. </p><br><p><img src="https://habrastorage.org/webt/pd/ya/mn/pdyamn0chhcnelgtphtxeg6eniq.png"><br><br></p><br><p>  Dentro de si, ele obviamente lan√ßa uma continua√ß√£o, na qual o c√≥digo real j√° est√° localizado. </p><br><p><img src="https://habrastorage.org/webt/33/nw/fb/33nwfb3dz0klj1oiog21iegsbuy.png"><br><br></p><br><p>  Do ponto de vista do usu√°rio, ainda n√£o lan√ßamos nada aqui. </p><br><p>  Esse √© apenas o primeiro quadro do c√≥digo do usu√°rio que aparece na pilha e est√° marcado em roxo. </p><br><p>  Al√©m disso, o c√≥digo √© executado, executado, em algum momento a tarefa est√° tentando capturar o bloqueio e bloquear nele, o que leva √† exclus√£o autom√°tica. </p><br><p><img src="https://habrastorage.org/webt/vv/lk/ah/vvlkahftvyuefpupb4fyidb5gdq.png"><br><br></p><br><p>  Tudo o que est√° na pilha de continua√ß√£o √© armazenado em um determinado lugar m√°gico.  E desaparece. </p><br><p><img src="https://habrastorage.org/webt/hz/oq/6n/hzoq6nmzmezadhp8-ntn6_qerxk.png"><br><br></p><br><p>  Como voc√™ pode ver, o fluxo retorna para a fibra, para a instru√ß√£o que segue <code>Continuation.run</code> .  E este √© o fim do c√≥digo da fibra. </p><br><p>  A tarefa de fibra termina, o suporte de m√≠dia est√° aguardando um novo trabalho. </p><br><p><img src="https://habrastorage.org/webt/l4/nt/k9/l4ntk9qfl8dpcamol4ufahy8sa0.png"><br><br></p><br><p>  A fibra est√° estacionada, em algum lugar fica, o continuum est√° completamente lotado. </p><br><p>  Mais cedo ou mais tarde, chega o momento em que quem √© dono da fechadura a libera. <br>  Isso leva ao fato de que a fibra, que estava aguardando a libera√ß√£o da trava, √© desembalada.  A tarefa dessa fibra come√ßa novamente. </p><br><ul><li>  Reentrantlock.unlock </li><li>  Locksupport.unpark </li><li>  Fiber.unpark </li><li>  ForkJoinPool.execute </li></ul><br><p>  E rapidamente retornamos √† pilha, que foi recentemente. </p><br><p><img src="https://habrastorage.org/webt/hz/oq/6n/hzoq6nmzmezadhp8-ntn6_qerxk.png"><br><br></p><br><p>  Al√©m disso, o fio transportador pode ser completamente diferente.  E isso faz sentido! </p><br><p>  Execute a continua√ß√£o novamente. </p><br><p><img src="https://habrastorage.org/webt/ll/c-/mx/llc-mxgfttlpleiqtprwm6igcju.png"><br><br></p><br><p>  E a√≠ vem a MAGIA !!!  A pilha √© restaurada e a execu√ß√£o continua com a instru√ß√£o ap√≥s <code>Continuation.yield</code> . </p><br><p><img src="https://habrastorage.org/webt/la/4t/pp/la4tppjy2spiy4_auvwdikgm8nu.png"><br><br></p><br><p>  Sa√≠mos da trava rec√©m estacionada e come√ßamos a executar todo o c√≥digo restante na continua√ß√£o: </p><br><p><img src="https://habrastorage.org/webt/yt/ce/ht/ytcehtff1fomwn5cehnzkegzpts.png"><br><br></p><br><p>  A tarefa do usu√°rio termina e o controle retorna √† tarefa de fibra imediatamente ap√≥s a instru√ß√£o continuation.run </p><br><p><img src="https://habrastorage.org/webt/sz/m8/cc/szm8ccxgwntcgjzwqcl_gcernqg.png"><br><br></p><br><p>  Ao mesmo tempo, a execu√ß√£o da fibra termina e novamente nos encontramos no modo de espera. </p><br><p><img src="https://habrastorage.org/webt/l4/nt/k9/l4ntk9qfl8dpcamol4ufahy8sa0.png"><br><br></p><br><p>  O pr√≥ximo lan√ßamento da fibra inicia novamente todo o ciclo de renascimentos descrito acima. </p><br><p><img src="https://habrastorage.org/webt/c7/z9/wm/c7z9wmktfbsithnlvyuea4mtqki.jpeg"><br><br></p><br><h1 id="zhivye-primery">  Exemplos ao vivo </h1><br><p>  E quem disse que tudo isso funciona?  Trata-se de algumas marcas de micropigmenta√ß√£o escritas durante a noite? </p><br><p>  Como exemplo da opera√ß√£o dos fogos de artif√≠cio, os oraklovitas escreveram um pequeno servidor web e o alimentaram com pedidos para que ele se engasgasse.  Ent√£o eles foram transferidos para fibra.  O servidor parou de engasgar e, a partir disso, conclu√≠mos que as fibras funcionam. </p><br><p>  N√£o tenho o c√≥digo exato para este servidor, mas se esta postagem receber curtidas e coment√°rios suficientes, tentarei escrever um exemplo e criar gr√°ficos reais. </p><br><h1 id="problemy">  Os problemas </h1><br><p>  H√° algum problema aqui?  Sim claro!  Toda a hist√≥ria com faybers √© uma hist√≥ria sobre problemas e trocas cont√≠nuas. </p><br><h2 id="filosofskie-problemy">  Problemas filos√≥ficos </h2><br><ul><li>  Precisamos reinventar threads? </li><li>  <em>Todo o</em> c√≥digo existente deve funcionar corretamente dentro da fibra? </li></ul><br><p>  O prot√≥tipo atual √© executado com limita√ß√µes.  O que pode ser lan√ßado, embora eu n√£o queira.  Ainda assim, o OpenJDK √© uma coisa que respeita a compatibilidade sem fim. </p><br><p>  Quais s√£o as limita√ß√µes t√©cnicas?  As limita√ß√µes mais √≥bvias s√£o 2 pe√ßas. </p><br><h2 id="problema-raz--nelzya-vytesnit-nativnye-freymy">  O problema √© uma vez - voc√™ n√£o pode substituir os quadros nativos </h2><br><pre> <code class="java hljs">PrivilegedAction&lt;Void&gt; pa = () -&gt; { readLock.lock(); <span class="hljs-comment"><span class="hljs-comment">// may park/yield try { // } finally { readLock.unlock(); } return null; } AccessController.doPrivileged(pa); //native method</span></span></code> </pre> <br><p>  Aqui <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">doPrivileged</a> chama o m√©todo nativo. </p><br><p>  Voc√™ chama <code>doPrivileged</code> , sai da VM, um quadro nativo aparece na sua pilha e depois tenta estacionar na linha <code>readLock.lock()</code> .  E nesse momento, o fio transportador ficar√° manchado at√© que seja retirado.  Ou seja, o segmento desaparece.  Nesse caso, os fios transportadores podem terminar e, em geral, isso quebra toda a ideia de fibra. </p><br><p>  A maneira de resolver isso j√° √© conhecida, e as discuss√µes est√£o em andamento sobre isso. </p><br><h2 id="problema-dva---synchronized-bloki">  Problema dois - blocos sincronizados </h2><br><p>  Isso √© lixo muito mais s√©rio </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (object) { <span class="hljs-comment"><span class="hljs-comment">//may park object.wait(); //may park }</span></span></code> </pre> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (object) { <span class="hljs-comment"><span class="hljs-comment">//may park socket.getInputStream().read(); //may park }</span></span></code> </pre> <br><p>  No caso de captura do monitor na fibra, os fios transportadores tamb√©m chutam. </p><br><p>  √â claro que em um c√≥digo completamente novo voc√™ pode alterar os monitores para bloqueios diretos, em vez de esperar + notificar que voc√™ pode usar objetos de condi√ß√£o, mas o que fazer com o legado?  Isso √© um problema. </p><br><h1 id="thread-api-threadcurrentthread-thread-locals">  API de thread?  Thread.currentThread ()?  Thread locals? </h1><br><p>  No prot√≥tipo atual, <code>Thread</code> e <code>Fiber</code> criaram uma superclasse comum chamada <code>Strand</code> . </p><br><p>  Isso permite que voc√™ transfira a API da maneira mais m√≠nima poss√≠vel. <br>  O que fazer a seguir - como sempre neste projeto, √© uma pergunta. </p><br><p>  O que est√° acontecendo com a API Thread agora? </p><br><ul><li>  O primeiro uso de <code>Thread.currentThread()</code> em uma fibra cria um tipo de thread de sombra, Shadow Thread; </li><li>  do ponto de vista do sistema, esse √© um encadeamento "n√£o lan√ßado" e n√£o h√° metainforma√ß√µes de VM nele; </li><li>  ST tenta emular tudo o que pode; </li><li>  mas voc√™ precisa entender que a API antiga tem muito lixo; </li><li>  mais especificamente, o Shadow Thread implementa a API do Thread para tudo, exceto <code>stop</code> , <code>suspend</code> , <code>resume</code> e manipular exce√ß√µes n√£o capturadas. </li></ul><br><p>  O que fazer com os locais de threads? </p><br><ul><li>  agora os locais de thread apenas se transformam em locais de fibra; </li><li>  existem muitos problemas com isso, tudo isso est√° sendo discutido; </li><li>  um conjunto de usos √© especialmente discutido; </li><li>  Historicamente, os threads t√™m sido usados ‚Äã‚Äãcorreta e incorretamente (aqueles que usam incorretamente ainda esperam algo, e voc√™ n√£o pode decepcion√°-los completamente); </li><li>  em geral, isso cria uma gama completa de aplicativos: <br><ul><li>  Alto n√≠vel: cache de conex√µes ou senhas no cont√™iner; </li><li>  N√≠vel baixo: processador nas bibliotecas do sistema. </li></ul></li></ul><br><h1 id="skolko-vse-eto-zhret">  Quanto tudo isso come </h1><br><p><img src="https://habrastorage.org/webt/pl/7-/pi/pl7-pidz-d2o3l98qx2srbmezxi.png"><br><br></p><br><p>  T√≥pico: </p><br><ul><li>  Pilha: 1 MB e 16 KB em estruturas de dados do kernel; </li><li>  Por inst√¢ncia do encadeamento: 2300 bytes, incluindo meta informa√ß√µes da VM. </li></ul><br><p>  Fibra: </p><br><ul><li>  Pilha de continua√ß√£o: de centenas de bytes a kilobytes; </li><li>  Por inst√¢ncia de fibra: 200-240 bytes. </li></ul><br><p>  A diferen√ßa √© enorme! <br>  E √© exatamente isso que permite que milh√µes de pessoas disparem. </p><br><h1 id="chto-mozhet-parkovatsya">  O que pode estacionar </h1><br><p>  √â claro que o mais m√°gico √© o estacionamento autom√°tico quando ocorrem alguns eventos.  O que √© suportado atualmente? </p><br><ul><li>  Thread.sleep, join; </li><li>  java.util.concurrent e LockSupport.lock; </li><li>  IO: rede em soquetes (leitura, grava√ß√£o, conex√£o, aceita√ß√£o), arquivos, tubos; </li><li>  Tudo isso est√° inacabado, mas a luz no t√∫nel √© vis√≠vel. </li></ul><br><h1 id="kommunikaciya-mezhdu-fayberami">  Comunica√ß√£o entre fibra </h1><br><p>  Outra pergunta que todo mundo faz √©: como trocar informa√ß√µes competitivas entre fibras. </p><br><ul><li>  O prot√≥tipo atual inicia tarefas em <code>Runnable</code> , pode ser convertido em <code>CompletableFuture</code> , se por algum motivo voc√™ precisar; </li><li>  java.util.concurrent "simplesmente funciona".  Voc√™ pode atrapalhar tudo de uma maneira padr√£o; </li><li>  pode haver novas APIs para multithreading, mas isso n√£o √© exato; </li><li>  um monte de pequenas perguntas como "as fibras devem retornar valores?";  tudo √© discutido, eles n√£o est√£o no prot√≥tipo. </li></ul><br><h1 id="kak-realizovany-kontinuacii-v-prototipe">  Como as continua√ß√µes s√£o implementadas no prot√≥tipo? </h1><br><p>  Requisitos √≥bvios s√£o impostos √† continua√ß√£o: voc√™ precisa usar o m√≠nimo de RAM poss√≠vel e alternar entre eles o mais r√°pido poss√≠vel.  Caso contr√°rio, n√£o funcionar√° para mant√™-los na casa dos milh√µes.  A principal tarefa aqui √©, de alguma forma, n√£o fazer uma c√≥pia completa da pilha para cada parque de estacionamento.  E existe esse esquema!  Vamos tentar explicar isso nas fotos. </p><br><p>  A maneira mais legal seria, √© claro, colocar todas as pilhas em um quadril java e us√°-las diretamente.  Mas n√£o est√° claro como codificar agora, ent√£o o prot√≥tipo usa a c√≥pia.  Mas copiar com um pequeno mas importante hack. </p><br><p>  Temos duas cadeiras ... quero dizer, duas pilhas.  Duas matrizes de java no quadril.  Uma √© uma matriz de objetos, onde armazenaremos refer√™ncias a objetos.  O segundo √© primitivo (por exemplo, √≠ntimo), que manipular√° todo o resto. </p><br><p><img src="https://habrastorage.org/webt/33/tf/cj/33tfcj897awloqfisxfwwl-4ypy.png"><br><br></p><br><p>  Agora estamos em um estado em que a continua√ß√£o est√° prestes a ser realizada pela primeira vez. </p><br><p>  <code>run</code> chama um m√©todo interno chamado <code>enter</code> : </p><br><p><img src="https://habrastorage.org/webt/j6/d5/ki/j6d5kioz8ygupanxditl3iaslbi.png"><br><br></p><br><p>  E ent√£o o c√≥digo do usu√°rio √© executado, at√© a primeira exclus√£o. </p><br><p><img src="https://habrastorage.org/webt/ab/on/6c/abon6cdsoepe-ts69pkmm9sk35i.png"><br><br></p><br><p>  Nesse ponto, √© feita uma chamada de VM, que <code>freeze</code> .  Neste prot√≥tipo, isso √© feito diretamente fisicamente - usando c√≥pia. </p><br><p><img src="https://habrastorage.org/webt/iu/or/jv/iuorjvmb6xrjnycvx3nxbdcqxxc.png"><br><br></p><br><p>  Iniciamos o processo de copiar seq√ºencialmente os quadros da pilha nativa para o java hip. </p><br><p><img src="https://habrastorage.org/webt/ln/nu/sm/lnnusmrix2hsqpwxmzkeemd_or0.png"><br><br></p><br><p>  √â necess√°rio verificar se os monitores est√£o l√° ou se o c√≥digo nativo √© usado, ou algo mais que realmente n√£o nos permita continuar trabalhando. </p><br><p><img src="https://habrastorage.org/webt/vl/5c/k0/vl5ck0i3jtouapded9snnl9brvy.png"><br><br></p><br><p>  E se tudo estiver bem, copiamos primeiro em uma matriz primitiva: </p><br><p><img src="https://habrastorage.org/webt/ka/z_/gl/kaz_glkmthfyd1x8rzdprn3v8ym.png"><br><br></p><br><p>  Em seguida, isolamos as refer√™ncias aos objetos e as salvamos na matriz de objetos: </p><br><p><img src="https://habrastorage.org/webt/xc/2q/nb/xc2qnbafy_2eybwzif-3s3vmaym.png"><br><br></p><br><p>  Na verdade, dois ch√°s para todos que leram para este lugar! </p><br><p>  Al√©m disso, continuamos este procedimento para todos os outros elementos da pilha nativa. </p><br><p><img src="https://habrastorage.org/webt/6e/sp/-0/6esp-07i4dyasxj5esb9qu6fh5i.png"><br><br></p><br><p>  Viva!  Copiamos tudo para o ninho no quadril.  Voc√™ pode pular com seguran√ßa para o local de chamada sem medo de que tenhamos perdido alguma coisa.  Tudo √© moderno. </p><br><p><img src="https://habrastorage.org/webt/bq/sz/ju/bqszjuffw-s4f14audafvzbmqzc.png"><br><br></p><br><p>  Agora, mais cedo ou mais tarde, o c√≥digo de chamada chamar√° nossa continua√ß√£o novamente.  E ela deve continuar do lugar onde foi deixada na √∫ltima vez.  Esta √© a nossa tarefa. </p><br><p><img src="https://habrastorage.org/webt/8i/bg/x9/8ibgx9r_26wedxrahar1vfqdifi.png"><br><br></p><br><p>  Verificando se a continua√ß√£o estava em execu√ß√£o, diz que sim, estava em execu√ß√£o.  Portanto, voc√™ precisa chamar a VM, limpar um pouco de espa√ßo na pilha e chamar a fun√ß√£o interna da <code>thaw</code> .  "Thaw" √© traduzido para o russo como "thaw", "descongelar", o que parece bastante l√≥gico.  √â necess√°rio descongelar os quadros da pilha de continua√ß√£o em nossa pilha nativa principal. </p><br><p>  N√£o tenho certeza de que o degelo do ch√° seja bem claro.  Abstra√ß√£o ruim √© como um gatinho com uma porta.  Mas isso far√° por n√≥s. </p><br><p><img src="https://habrastorage.org/webt/ra/sv/5v/rasv5v_5w8_dpegomn_omgtdiza.png"><br><br></p><br><p>  N√≥s fazemos c√≥pias bastante √≥bvias. </p><br><p>  Primeiro com uma matriz primitiva: </p><br><p><img src="https://habrastorage.org/webt/wc/he/vg/wchevg-fsflrnicy0itprkp0q2e.png"><br><br></p><br><p>  Em seguida, no link: </p><br><p><img src="https://habrastorage.org/webt/o_/o2/6s/o_o26sakm0n5hyq9wisbo7vouge.png"><br><br></p><br><p>  Voc√™ precisa corrigir um pouco as c√≥pias para obter a pilha correta: </p><br><p><img src="https://habrastorage.org/webt/sm/h7/0n/smh70naepp3kshxaa78zxv1g2du.png"><br><br></p><br><p>  Repita a obscenidade para todos os quadros: </p><br><p><img src="https://habrastorage.org/webt/cg/dv/61/cgdv617uqeriqmuqcyc2jkjpnbe.png"><br><br></p><br><p>  Agora voc√™ pode voltar a <code>yield</code> e continuar como se nada tivesse acontecido. </p><br><p><img src="https://habrastorage.org/webt/gn/dd/xw/gnddxwqqsrwuidc9ev2nxwmiwqc.png"><br><br></p><br><p>  O problema √© que uma c√≥pia completa da pilha n√£o √© exatamente o que gostar√≠amos de ter.  √â muito inibit√≥rio.  Tudo isso √© isolamento de links, verifica√ß√µes para fixa√ß√£o, n√£o √© r√°pido.  E o mais importante - tudo isso depende linearmente do tamanho da pilha!  Em uma palavra, inferno.  N√£o h√° necessidade de fazer isso. </p><br><p>  Em vez disso, temos outra ideia - c√≥pia pregui√ßosa. </p><br><p>  Vamos voltar ao local onde j√° temos uma continua√ß√£o congelada. </p><br><p><img src="https://habrastorage.org/webt/5b/hw/tg/5bhwtgg8cfg-agcwu_kdtrqlify.png"><br><br></p><br><p>  Continuamos o processo como antes: </p><br><p><img src="https://habrastorage.org/webt/rj/ac/f9/rjacf9tmfekskko8jwojuocxixm.png"><br><br></p><br><p>  Da mesma maneira que antes, limpamos o local na pilha nativa: </p><br><p><img src="https://habrastorage.org/webt/nm/ol/ow/nmolowac-dkmdefuobd-kaijyeq.png"><br><br></p><br><p>  Mas n√£o estamos copiando tudo em sequ√™ncia, mas apenas um ou alguns quadros: </p><br><p><img src="https://habrastorage.org/webt/3a/ca/1x/3aca1xglgfbq8yzwxkjypelxpqy.png"><br><br></p><br><p>  Agora o hack.  Voc√™ precisa corrigir o endere√ßo de retorno do m√©todo <code>C</code> para que ele aponte para uma certa barreira de retorno: </p><br><p><img src="https://habrastorage.org/webt/zs/si/3z/zssi3zgaadvvsrg883agxsmq3pc.png"><br><br></p><br><p>  Agora voc√™ pode retornar com seguran√ßa para <code>yield</code> : </p><br><p><img src="https://habrastorage.org/webt/e1/f_/2s/e1f_2snf4bh-ggjcv5lrgabqkwk.png"><br><br></p><br><p>  O que, por sua vez, levar√° a uma chamada para o c√≥digo do usu√°rio no m√©todo <code>C</code> : </p><br><p><img src="https://habrastorage.org/webt/y2/nl/rm/y2nlrmn9lczwhcaa3f41ii69nq0.png"><br><br></p><br><p>  Agora imagine que <code>C</code> quer retornar ao c√≥digo que o chamou.  Mas seu invocador √© <code>B</code> , e ele n√£o est√° na pilha!  Portanto, quando ele tenta retornar, ele ir√° para o endere√ßo de retorno, e esse endere√ßo agora √© a barreira do retorno.  E, voc√™ sabe, isso atrair√° novamente um <code>thaw</code> : </p><br><p><img src="https://habrastorage.org/webt/hb/6g/8d/hb6g8dfw35ujqntvi-y7lzyskis.png"><br><br></p><br><p>  E o <code>thaw</code> descongelar√° o pr√≥ximo quadro na pilha de continua√ß√£o, e este √© <code>B</code> : </p><br><p><img src="https://habrastorage.org/webt/cp/mp/ao/cpmpao3_arvnvgykenc9r4fgwsk.png"><br><br></p><br><p>  De fato, n√≥s o copiamos pregui√ßosamente, mediante solicita√ß√£o. </p><br><p>  Em seguida, soltamos <code>B</code> da pilha de continua√ß√£o e configuramos a barreira novamente (a barreira precisa ser configurada porque resta algo na pilha de continua√ß√£o).  E assim por diante. </p><br><p><img src="https://habrastorage.org/webt/gv/yo/0u/gvyo0u4iwzunuqovy1yv_-jbutq.png"><br><br></p><br><p>  Mas suponha que <code>B</code> n√£o retorne ao c√≥digo de chamada, mas primeiro chame outro m√©todo <code>D</code>  E esse novo m√©todo tamb√©m quer ser exclu√≠do. </p><br><p><img src="https://habrastorage.org/webt/f9/1i/t9/f91it9xn705zsxuzvvbqh5gdoqi.png"><br><br></p><br><p>  Nesse caso, quando chegar a hora de <code>freeze</code> , precisaremos copiar apenas a parte superior da pilha nativa na pilha de continua√ß√£o: </p><br><p><img src="https://habrastorage.org/webt/pt/8b/ul/pt8buljt77lsp-wj-rswobc4v_y.png"><br><br></p><br><p>  Assim, a quantidade de trabalho realizado n√£o depende linearmente do tamanho da pilha.  Linearmente, depende apenas do n√∫mero de quadros que realmente usamos no trabalho. </p><br><h1 id="chto-ostalos">  O que resta? </h1><br><p>  Os desenvolvedores mant√™m alguns recursos em mente, mas n√£o entraram no prot√≥tipo. </p><br><ul><li>  Serializa√ß√£o e clonagem.  A capacidade de continuar em outra m√°quina, em outro momento, etc. </li><li>  JVM TI e depura√ß√£o, como se fossem encadeamentos regulares.  Se voc√™ estiver bloqueado ao ler o soquete, n√£o ver√° um belo salto no rendimento, no prot√≥tipo o encadeamento ser√° simplesmente bloqueado, como qualquer outro encadeamento comum. </li><li>  A recurs√£o da cauda nem foi tocada. </li></ul><br><p>  Pr√≥ximas etapas: </p><br><ul><li>  Fa√ßa uma API humana; </li><li>  Adicione todos os recursos ausentes; </li><li>  Melhore o desempenho. </li></ul><br><h1 id="gde-vzyat">  Onde obter </h1><br><p>  O prot√≥tipo √© feito como um brunch no reposit√≥rio OpenJDK.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Voc√™ pode fazer o download do prot√≥tipo aqui</a> , alternando para as <code>fibers</code> brunch. </p><br><p>  √â feito assim: </p><br><pre> <code class="bash hljs">$ hg <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> http://hg.openjdk.java.net/loom/loom $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> loom $ hg update -r fibers $ sh configure $ make images</code> </pre> <br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como voc√™ sabe, tudo isso iniciar√° a montagem de todo o maldito OpenJDK. </font><font style="vertical-align: inherit;">Portanto, primeiro, a pr√≥xima meia hora de sua vida ter√° que fazer outra coisa, enquanto tudo isso acontecer√°.</font></font></p><br><p><img src="https://habrastorage.org/webt/gk/qz/3-/gkqz3-f8gmkcwkynnnrp4opp1rg.png"><br><br></p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em segundo lugar, voc√™ precisa ter um computador configurado corretamente com uma cadeia de ferramentas C ++ e bibliotecas GNU. </font><font style="vertical-align: inherit;">Estou sugerindo que n√£o √© recomend√°vel fazer isso no Windows. </font><font style="vertical-align: inherit;">S√©rio, mesmo com o download do VirtualBox e a instala√ß√£o de um novo Ubuntu, voc√™ gastar√° muito menos tempo do que tentar perceber outro erro desumano ao criar a partir do Cygwin ou do msys64. </font><font style="vertical-align: inherit;">√â aqui que o msys √© ainda pior que o Cygwin.</font></font></p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Embora tudo isso seja mentira, √© claro, eu me cansei de escrever as </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">instru√ß√µes de montagem</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p><br><p>   -   ,   mercurial extension   fsmonitor. ,   ,   <code>hg help -e fsmonitor</code> . <br>      ~/.hgrc  : </p><br><pre> <code class="plaintext hljs">[fsmonitor] mode = on</code> </pre> <br><p>  -           .             -, <code>cp -R ./loom ./loom-backup</code> . </p><br><p>  ,          . ,   Java-    ,       . </p><br><p> <code>sh configure</code>    - . ,     Ubuntu,     Autoconf ( <code>sudo apt-get install autoconf</code> ).  ‚Äî     OpenJDK   Ubuntu,     ,  .  Windows      ,   . </p><br><p> ,     ,   <code>hg diff --stat -r default:fibers</code> . </p><br><p>  ,          ,   ,     . </p><br><h1 id="zaklyuchenie">  Conclus√£o </h1><br><p>      ¬´, ¬ª.   ¬´¬ª, . ¬´Loom¬ª ‚Äî  ¬´ ¬ª.  Project Loom         . </p><br><p>          ,        . ,      ¬´¬ª  ,  ,      ‚Äî  , ,  , ‚Äî  . </p><br><p> ,   ,          XIX    ,        . </p><br><br><img src="https://habrastorage.org/getpro/habr/post_images/305/64e/143/30564e14316852dd18d4235b3850e134.jpg"><br><p>      . -,  . </p><br><p> ,                 .        IDE   . </p><br><p>          ,       ,   ,    ¬´ ¬ª, ¬´¬ª, ¬´ ¬ª   . </p><br><p>       ?   .   . </p><br><p>  Obrigada </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt422519/">https://habr.com/ru/post/pt422519/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt422509/index.html">Resumo do livro "Never Eat Alone"</a></li>
<li><a href="../pt422511/index.html">Carregando dados no Splunk: Universal Forwarder vs Heavy Forwarder. Qual a diferen√ßa?</a></li>
<li><a href="../pt422513/index.html">7 dicas sobre como n√£o enfurecer um colega testador em suas f√©rias</a></li>
<li><a href="../pt422515/index.html">Dois semin√°rios on-line sobre mitaps e computa√ß√£o na mem√≥ria do Apache Ignite em setembro</a></li>
<li><a href="../pt422517/index.html">TelegramBot na nuvem Wolfram</a></li>
<li><a href="../pt422521/index.html">Pressentimento do inevit√°vel</a></li>
<li><a href="../pt422525/index.html">"A matriz da amizade." O gr√°fico social mais antigo para os menores</a></li>
<li><a href="../pt422527/index.html">Resumo de not√≠cias do PostgreSQL. Edi√ß√£o 10</a></li>
<li><a href="../pt422529/index.html">Curso Especial do Grupo IB: ‚ÄúSeguran√ßa de Aplicativos M√≥veis‚Äù</a></li>
<li><a href="../pt422531/index.html">Otimiza√ß√£o da Web: a mais importante</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>