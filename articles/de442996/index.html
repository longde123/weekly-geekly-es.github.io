<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç£ üòÜ üëàüèΩ Kleinere Behandlung von C ++ - Ausnahmen unter x64 ‚õèÔ∏è ü§öüèº üë©üèº‚Äç‚öïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In Visual Studio 2019 Preview 3 wird eine neue Funktion eingef√ºhrt, mit der die Bin√§rgr√∂√üe der C ++ - Ausnahmebehandlung (try / catch und automatische...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Kleinere Behandlung von C ++ - Ausnahmen unter x64</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/microsoft/blog/442996/"><img width="140" align="left" src="https://habrastorage.org/webt/gq/ke/xi/gqkexi_dekwffzpjqtx04zp7ee8.png"><p>  In Visual Studio 2019 Preview 3 wird eine neue Funktion eingef√ºhrt, mit der die Bin√§rgr√∂√üe der C ++ - Ausnahmebehandlung (try / catch und automatische Destruktoren) unter x64 reduziert werden kann.  Mit dem Namen FH4 (f√ºr __CxxFrameHandler4 siehe unten) habe ich eine neue Formatierung und Verarbeitung f√ºr Daten entwickelt, die f√ºr die Behandlung von C ++ - Ausnahmen verwendet werden und ~ <strong>60%</strong> kleiner sind als die vorhandene Implementierung, was zu einer bin√§ren Reduzierung von bis zu <strong>20%</strong> f√ºr Programme mit starker C ++ - Nutzung f√ºhrt Ausnahmebehandlung. </p><br>  Dieser Artikel im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Blog</a> . <a name="habracut"></a><br><br><h2>  Wie schalte ich das ein? </h2><br><p>  FH4 ist derzeit <strong>standardm√§√üig</strong> deaktiviert, da die f√ºr Store-Anwendungen erforderlichen Laufzeit√§nderungen nicht in die aktuelle Version gelangen konnten.  Um FH4 f√ºr Nicht-Store-Anwendungen zu aktivieren, √ºbergeben Sie das undokumentierte Flag "/ d2FH4" an den MSVC-Compiler in Visual Studio 2019 Preview 3 und h√∂her. </p><br><p>  Wir planen, FH4 standardm√§√üig zu aktivieren, sobald die Store-Laufzeit aktualisiert wurde.  Wir hoffen, dies in Visual Studio 2019 Update 1 zu tun und diesen Beitrag zu aktualisieren, von dem wir mehr wissen. </p><br><h2>  Werkzeug√§nderungen </h2><br><p>  Bei jeder Installation von Visual Studio 2019 Preview 3 und h√∂her werden die √Ñnderungen im Compiler und in der C ++ - Laufzeit vorgenommen, um FH4 zu unterst√ºtzen.  Die Compiler√§nderungen existieren intern unter dem oben genannten Flag "/ d2FH4".  Die C ++ - Laufzeit enth√§lt eine neue DLL namens vcruntime140_1.dll, die von VCRedist automatisch installiert wird.  Dies ist erforderlich, um den neuen Ausnahmebehandler __CxxFrameHandler4 verf√ºgbar zu machen, der die √§ltere Routine __CxxFrameHandler3 ersetzt.  Statische Verkn√ºpfung und app-lokale Bereitstellung der neuen C ++ - Laufzeit werden ebenfalls unterst√ºtzt. </p><br><p>  Nun zu den lustigen Sachen!  Der Rest dieses Beitrags behandelt die internen Ergebnisse des Testens von FH4 unter Windows, Office und SQL, gefolgt von detaillierteren technischen Details hinter dieser neuen Technologie. </p><br><h2>  Motivation und Ergebnisse </h2><br><p>  Vor ungef√§hr einem Jahr kamen unsere Partner des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">C ++ / WinR</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">T-</a> Projekts mit einer Herausforderung zum Microsoft C ++ - Team: Um wie viel k√∂nnten wir die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Bin√§rgr√∂√üe</a> der C ++ - Ausnahmebehandlung f√ºr Programme reduzieren, die es h√§ufig verwenden? </p><br><p>  Im Zusammenhang mit einem Programm, das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">C ++ / WinRT verwendet</a> , wurde auf eine Windows-Komponente Microsoft.UI.Xaml.dll verwiesen, die aufgrund der Behandlung von C ++ - Ausnahmen einen gro√üen bin√§ren Footprint aufweist.  Ich best√§tigte, dass dies tats√§chlich der Fall war, und erzeugte die Aufschl√ºsselung der Bin√§rgr√∂√üe mit dem vorhandenen __CxxFrameHandler3 (siehe unten).  Die Prozents√§tze auf der rechten Seite des Diagramms sind <strong>Prozent der gesamten Bin√§rgr√∂√üe,</strong> die von bestimmten Metadatentabellen und umrissenem Code belegt wird. </p><br><h2> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/350/cf5/402/350cf5402f932176e7c40f0af3f61161.png" alt="Gr√∂√üenaufschl√ºsselung von Microsoft.UI.Xaml.dll mit __CxxFrameHandler3" width="720" height="480"></a> </h2><br><p>  In diesem Beitrag werde ich nicht erl√§utern, was die spezifischen Strukturen auf der rechten Seite des Diagramms bewirken (weitere Informationen finden Sie in James McNellis 'Vortrag dar√ºber, wie das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Abwickeln von Stapeln unter Windows funktioniert</a> ).  Bei Betrachtung der gesamten Metadaten und des gesamten Codes wurden jedoch satte <strong>26,4%</strong> der Bin√§rgr√∂√üe f√ºr die C ++ - Ausnahmebehandlung verwendet.  Dies ist eine enorme Menge an Speicherplatz und hat die Einf√ºhrung von C ++ / WinRT behindert. </p><br><p>  Wir haben in der Vergangenheit √Ñnderungen vorgenommen, um die Gr√∂√üe der C ++ - Ausnahmebehandlung im Compiler zu verringern, ohne die Laufzeit zu √§ndern.  Dies umfasst das L√∂schen von Metadaten f√ºr Codebereiche, die keine logisch identischen Zust√§nde ausl√∂sen und falten k√∂nnen.  Wir hatten jedoch das Ende dessen erreicht, was wir nur im Compiler tun konnten, und waren nicht in der Lage, etwas so Gro√ües signifikant einzudellen.  Die Analyse ergab, dass signifikante Gewinne zu verzeichnen waren, jedoch grundlegende √Ñnderungen an Daten, Code und Laufzeit erforderlich waren.  Also machten wir weiter und machten sie. </p><br><p>  Mit dem neuen __CxxFrameHandler4 und den zugeh√∂rigen Metadaten lautet die Gr√∂√üenverteilung f√ºr Microsoft.UI.XAML.dll jetzt wie folgt: </p><br><h2> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/e1d/a71/041/e1da71041bf442276ae15eb605a21e6a.png" alt="Gr√∂√üenaufschl√ºsselung von Microsoft.UI.Xaml.dll mit __CxxFrameHandler4" width="720" height="481"></a> </h2><br><p>  Die von der C ++ - Ausnahmebehandlung verwendete Bin√§rgr√∂√üe sinkt um <strong>64%,</strong> was zu einer Verringerung der Gesamtbin√§rgr√∂√üe um <strong>18,6%</strong> f√ºr diese Bin√§rdatei f√ºhrt.  Jede Art von Struktur schrumpfte um erstaunliche Grade: </p><table border="2" cellspacing="10" cellpadding="5"><tbody><tr><td>  <strong>Eh Daten</strong> </td><td>  <strong>__CxxFrameHandler3 Gr√∂√üe (Bytes)</strong> </td><td>  <strong>__CxxFrameHandler4 Gr√∂√üe (Bytes)</strong> </td><td>  <strong>% Gr√∂√üenreduzierung</strong> </td></tr><tr><td>  Pdata-Eintr√§ge </td><td>  147.864 </td><td>  118.260 </td><td>  20,0% </td></tr><tr><td>  Codes abwickeln </td><td>  224,284 </td><td>  92,810 </td><td>  58,6% </td></tr><tr><td>  Funktionsinfos </td><td>  255,440 </td><td>  27.755 </td><td>  89,1% </td></tr><tr><td>  IP2State-Karten </td><td>  186.944 </td><td>  45.098 </td><td>  75,9% </td></tr><tr><td>  Karten abwickeln </td><td>  80.952 </td><td>  69.757 </td><td>  13,8% </td></tr><tr><td>  Catch-Handler-Karten </td><td>  52.060 </td><td>  6,147 </td><td>  88,2% </td></tr><tr><td>  Probieren Sie Karten aus </td><td>  51.960 </td><td>  5,196 </td><td>  90,0% </td></tr><tr><td>  Dtor funclets </td><td>  54.570 </td><td> 45.739 </td><td>  16,2% </td></tr><tr><td>  Fang Funclets </td><td>  102.400 </td><td>  4,301 </td><td>  95,8% </td></tr><tr><td>  Insgesamt </td><td>  <strong>1.156.474</strong> </td><td>  <strong>415.063</strong> </td><td>  <strong>64,1%</strong> </td></tr></tbody></table><p>  Durch den Wechsel zu __CxxFrameHandler4 wurde die Gesamtgr√∂√üe von Microsoft.UI.Xaml.dll von 4,4 MB auf 3,6 MB gesenkt. </p><br><p>  Das Testen von FH4 auf einem repr√§sentativen Satz von Office-Bin√§rdateien zeigt eine Gr√∂√üenreduzierung von ~ 10% bei DLLs, die h√§ufig Ausnahmen verwenden.  Selbst in Word und Excel, die die Verwendung von Ausnahmen minimieren sollen, wird die Bin√§rgr√∂√üe immer noch erheblich reduziert. </p><table border="2" cellspacing="10" cellpadding="5"><tbody><tr><td>  <strong>Bin√§r</strong> </td><td>  <strong>Alte Gr√∂√üe (MB)</strong> </td><td>  <strong>Neue Gr√∂√üe (MB)</strong> </td><td>  <strong>% Gr√∂√üenreduzierung</strong> </td><td>  <strong>Beschreibung</strong> </td></tr><tr><td>  chart.dll </td><td>  17.27 </td><td>  15.10 </td><td>  12,6% </td><td>  Unterst√ºtzung f√ºr die Interaktion mit Diagrammen und Grafiken </td></tr><tr><td>  Csi.dll </td><td>  9.78 </td><td>  8.66 </td><td>  11,4% </td><td>  Unterst√ºtzung f√ºr die Arbeit mit Dateien, die in der Cloud gespeichert sind </td></tr><tr><td>  Mso20Win32Client.dll </td><td>  6.07 </td><td>  5.41 </td><td>  11,0% </td><td>  Gemeinsamer Code, der von allen Office-Apps gemeinsam genutzt wird </td></tr><tr><td>  Mso30Win32Client.dll </td><td>  8.11 </td><td>  7.30 </td><td>  9,9% </td><td>  Gemeinsamer Code, der von allen Office-Apps gemeinsam genutzt wird </td></tr><tr><td>  oart.dll </td><td>  18.21 </td><td>  16.20 </td><td>  11,0% </td><td>  Grafikfunktionen, die von Office-Apps gemeinsam genutzt werden </td></tr><tr><td>  wwlib.dll </td><td>  42.15 </td><td>  41.12 </td><td>  2,5% </td><td>  Die Hauptbin√§rdatei von Microsoft Word </td></tr><tr><td>  excel.exe </td><td>  52,86 </td><td>  50,29 </td><td>  4,9% </td><td>  Die Hauptbin√§rdatei von Microsoft Excel </td></tr></tbody></table><p>  Das Testen von FH4 auf SQL-Kernbin√§rdateien zeigt eine Reduzierung der Gr√∂√üe um 4 bis 21%, haupts√§chlich aufgrund der im n√§chsten Abschnitt beschriebenen Metadatenkomprimierung: </p><table border="2" cellspacing="10" cellpadding="5"><tbody><tr><td>  <strong>Bin√§r</strong> </td><td>  <strong>Alte Gr√∂√üe (MB)</strong> </td><td>  <strong>Neue Gr√∂√üe (MB)</strong> </td><td>  <strong>% Gr√∂√üenreduzierung</strong> </td><td>  <strong>Beschreibung</strong> </td></tr><tr><td>  sqllang.dll </td><td>  47.12 </td><td>  44.33 </td><td>  5,9% </td><td>  Top-Level-Services: Sprachparser, Binder, Optimierer und Ausf√ºhrungsmodul </td></tr><tr><td>  sqlmin.dll </td><td>  48.17 </td><td>  45,83 </td><td>  4,8% </td><td>  Low-Level-Services: Transaktionen und Speicher-Engine </td></tr><tr><td>  qds.dll </td><td>  1.42 </td><td>  1,33 </td><td>  6,3% </td><td>  Abfragespeicherfunktionalit√§t </td></tr><tr><td>  SqlDK.dll </td><td>  3.19 </td><td>  3.05 </td><td>  4,4% </td><td>  SQL OS-Abstraktionen: Speicher, Threads, Zeitplanung usw. </td></tr><tr><td>  autoadmin.dll </td><td>  1,77 </td><td>  1,64 </td><td>  7,3% </td><td>  Datenbank-Tuning-Advisor-Logik </td></tr><tr><td>  xedetours.dll </td><td>  0,45 </td><td>  0,36 </td><td>  21,6% </td><td>  Flugdatenschreiber f√ºr Anfragen </td></tr></tbody></table><h2>  Die Technik </h2><br><p>  Bei der Analyse der Ursachen f√ºr die C ++ - Ausnahmebehandlungsdaten in Microsoft.UI.Xaml.dll habe ich zwei Hauptschuldige gefunden: </p><br><ol><li>  Die Datenstrukturen selbst sind gro√ü: Metadatentabellen hatten eine feste Gr√∂√üe mit Feldern mit bildrelativen Offsets und Ganzzahlen, die jeweils vier Bytes lang sind.  Eine Funktion mit einem einzelnen try / catch und einem oder zwei automatischen Destruktoren hatte √ºber 100 Byte Metadaten. </li><li>  Die generierten Datenstrukturen und der generierte Code konnten nicht zusammengef√ºhrt werden.  Die Metadatentabellen enthielten bildbezogene Offsets, die das Falten von COMDAT verhinderten (der Prozess, bei dem der Linker identische Daten zusammenf√ºgen kann, um Platz zu sparen), sofern die von ihnen dargestellten Funktionen nicht identisch waren.  Dar√ºber hinaus konnten Catch-Funclets (umrissener Code aus den Catch-Bl√∂cken des Programms) nicht gefaltet werden, selbst wenn sie codeidentisch waren, da ihre Metadaten in ihren Eltern enthalten sind. </li></ol><br><p>  Um diese Probleme zu beheben, strukturiert FH4 die Metadaten und den Code so um, dass: </p><br><ol><li>  Fr√ºhere Werte mit fester Gr√∂√üe wurden mithilfe einer Ganzzahlcodierung mit variabler L√§nge komprimiert, die&gt; 90% der Metadatenfelder von vier Bytes auf eins reduziert.  Metadatentabellen haben jetzt auch eine variable L√§nge mit einem Header, der angibt, ob bestimmte Felder vorhanden sind, um Platz beim Ausgeben leerer Felder zu sparen. </li><li>  Alle bildrelativen Offsets, die funktionsrelativ sein k√∂nnen, wurden funktionsrelativ gemacht.  Dies erm√∂glicht die COMDAT-Faltung zwischen Metadaten verschiedener Funktionen mit √§hnlichen Merkmalen (Think Template-Instanziierungen) und erm√∂glicht die Komprimierung dieser Werte.  Catch-Funclets wurden so umgestaltet, dass ihre Metadaten nicht mehr in den Daten ihrer Eltern gespeichert sind, sodass alle codeidentischen Catch-Funclets jetzt zu einer einzigen Kopie in der Bin√§rdatei gefaltet werden k√∂nnen. </li></ol><br><p>  Schauen wir uns zur Veranschaulichung die urspr√ºngliche Definition f√ºr die Metadatentabelle "Funktionsinfo" an, die f√ºr __CxxFrameHandler3 verwendet wird.  Dies ist die Starttabelle f√ºr die Laufzeit bei der Verarbeitung von EH und zeigt auf die anderen Metadatentabellen.  Dieser Code ist in jeder VS-Installation √∂ffentlich verf√ºgbar. Suchen Sie nach &lt;VS-Installationspfad&gt; \ VC \ Tools \ MSVC \ &lt;Version&gt; \ include \ ehdata.h: </p><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s_FuncInfo</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> magicNumber:<span class="hljs-number"><span class="hljs-number">29</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Identifies version of compiler unsigned int bbtFlags:3; // flags that may be set by BBT processing __ehstate_t maxState; // Highest state number plus one (thus // number of entries in unwind map) int dispUnwindMap; // Image relative offset of the unwind map unsigned int nTryBlocks; // Number of 'try' blocks in this function int dispTryBlockMap; // Image relative offset of the handler map unsigned int nIPMapEntries; // # entries in the IP-to-state map. NYI (reserved) int dispIPtoStateMap; // Image relative offset of the IP to state map int dispUwindHelp; // Displacement of unwind helpers from base int dispESTypeList; // Image relative list of types for exception specifications int EHFlags; // Flags for some features. } FuncInfo;</span></span></code> </pre> <br><p>  Diese Struktur hat eine feste Gr√∂√üe und enth√§lt 10 Felder mit einer L√§nge von jeweils 4 Bytes.  Dies bedeutet, dass jede Funktion, die standardm√§√üig eine C ++ - Ausnahmebehandlung ben√∂tigt, 40 Byte Metadaten enth√§lt. </p><br><p>  Nun zur neuen Datenstruktur (&lt;VS Installationspfad&gt; \ VC \ Tools \ MSVC \ &lt;Version&gt; \ include \ ehdata4_export.h): </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FuncInfoHeader</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> isCatch : <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">// 1 if this represents a catch funclet, 0 otherwise uint8_t isSeparated : 1; // 1 if this function has separated code segments, 0 otherwise uint8_t BBT : 1; // Flags set by Basic Block Transformations uint8_t UnwindMap : 1; // Existence of Unwind Map RVA uint8_t TryBlockMap : 1; // Existence of Try Block Map RVA uint8_t EHs : 1; // EHs flag set uint8_t NoExcept : 1; // NoExcept flag set uint8_t reserved : 1; }; uint8_t value; }; }; struct FuncInfo4 { FuncInfoHeader header; uint32_t bbtFlags; // flags that may be set by BBT processing int32_t dispUnwindMap; // Image relative offset of the unwind map int32_t dispTryBlockMap; // Image relative offset of the handler map int32_t dispIPtoStateMap; // Image relative offset of the IP to state map uint32_t dispFrame; // displacement of address of function frame wrt establisher frame, only used for catch funclets };</span></span></code> </pre> <br><p>  Beachten Sie, dass: </p><br><ol><li>  Die magische Zahl wurde entfernt und die Ausgabe von 0x19930522 wird jedes Mal zum Problem, wenn ein Programm Tausende dieser Eintr√§ge enth√§lt. </li><li>  EHFlags wurde in den Header verschoben, w√§hrend dispESTypeList aufgrund der fehlenden Unterst√ºtzung dynamischer Ausnahmespezifikationen in C ++ 17 aus dem Programm genommen wurde.  Der Compiler verwendet standardm√§√üig den √§lteren __CxxFrameHandler3, wenn dynamische Ausnahmespezifikationen verwendet werden. </li><li>  Die L√§ngen der anderen Tabellen werden nicht mehr in ‚ÄûFunktionsinfo 4‚Äú gespeichert.  Auf diese Weise kann die COMDAT-Faltung mehr von den Tabellen, auf die gezeigt wird, falten, selbst wenn die Tabelle ‚ÄûFunktionsinfo 4‚Äú selbst nicht gefaltet werden kann. </li><li>  (Nicht explizit gezeigt) Die Felder dispFrame und bbtFlags sind jetzt Ganzzahlen variabler L√§nge.  Die √ºbergeordnete Darstellung bel√§sst es als uint32_t f√ºr eine einfache Verarbeitung. </li><li>  bbtFlags, dispUnwindMap, dispTryBlockMap und dispFrame k√∂nnen abh√§ngig von den im Header festgelegten Feldern weggelassen werden. </li></ol><br><p>  Unter Ber√ºcksichtigung all dessen betr√§gt die durchschnittliche Gr√∂√üe der neuen Struktur ‚ÄûFunktionsinfo 4‚Äú jetzt 13 Byte (1-Byte-Header + drei 4-Byte-Bild-relative Offsets zu anderen Tabellen), was sich noch weiter verkleinern l√§sst, wenn einige Tabellen nicht ben√∂tigt werden.  Die L√§ngen der Tabellen wurden verschoben, aber diese Werte sind jetzt komprimiert und 90% davon in Microsoft.UI.Xaml.dll passen in ein einzelnes Byte.  Alles in allem bedeutet dies, dass die durchschnittliche Gr√∂√üe f√ºr die Darstellung der gleichen Funktionsdaten im neuen Handler 16 Byte im Vergleich zu den vorherigen 40 Byte betr√§gt - eine dramatische Verbesserung! </p><br><p>  Schauen wir uns zum Falten die Anzahl der einzigartigen Tische und Funclets mit dem alten und dem neuen Handler an: </p><table border="2" cellspacing="10" cellpadding="5"><tbody><tr><td>  Eh Daten </td><td>  Z√§hlen Sie in __CxxFrameHandler3 </td><td>  Z√§hlen Sie in __CxxFrameHandler4 </td><td>  % Reduktion </td></tr><tr><td>  Pdata-Eintr√§ge </td><td>  12,322 </td><td>  9.855 </td><td>  20,0% </td></tr><tr><td>  Funktionsinfos </td><td>  6,386 </td><td>  2,747 </td><td>  57,0% </td></tr><tr><td>  IP2State-Karteneintr√§ge </td><td>  6,363 </td><td>  2,148 </td><td>  66,2% </td></tr><tr><td>  Karteneintr√§ge abwickeln </td><td>  1,487 </td><td>  1.464 </td><td>  1,5% </td></tr><tr><td>  Catch-Handler-Karten </td><td>  2,603 </td><td>  601 </td><td>  76,9% </td></tr><tr><td>  Probieren Sie Karten aus </td><td>  2,598 </td><td>  648 </td><td>  75,1% </td></tr><tr><td>  Dtor funclets </td><td>  2.301 </td><td>  1,527 </td><td>  33,6% </td></tr><tr><td>  Fang Funclets </td><td>  2,603 </td><td>  84 </td><td>  <strong><em>96,8%</em></strong> </td></tr><tr><td>  Insgesamt </td><td>  <strong>36.663</strong> </td><td>  <strong>19.074</strong> </td><td>  <strong>48,0%</strong> </td></tr></tbody></table><p>  Die Anzahl der eindeutigen EH-Dateneintr√§ge sinkt um <strong>48%</strong> , da zus√§tzliche Faltm√∂glichkeiten geschaffen werden, indem RVAs entfernt und Fangfunclets neu gestaltet werden.  Ich m√∂chte speziell die Anzahl der gr√ºn kursiv gedruckten Catch-Funclets nennen: Sie sinkt von 2,603 ‚Äã‚Äãauf nur 84. Dies ist eine Folge der C ++ / WinRT-√úbersetzung von HRESULTs in C ++ - Ausnahmen, die viele codeidentische Catch-Funclets generiert, die jetzt verf√ºgbar sind gefaltet.  Sicherlich liegt ein R√ºckgang dieser Gr√∂√üenordnung am oberen Ende der Ergebnisse, zeigt jedoch, welche potenziellen Einsparungen durch Gr√∂√üenfaltung erzielt werden k√∂nnen, wenn die Datenstrukturen unter Ber√ºcksichtigung dieser Kriterien entworfen werden. </p><br><h2>  Leistung </h2><br><p>  Mit dem Entwurf, der die Komprimierung einf√ºhrt und die Laufzeitausf√ºhrung √§ndert, gab es Bedenken, dass die Leistung bei der Ausnahmebehandlung beeintr√§chtigt wird.  Die Auswirkungen sind jedoch <strong>positiv</strong> : Die Leistung bei der Ausnahmebehandlung <strong>verbessert sich</strong> mit __CxxFrameHandler4 im Gegensatz zu __CxxFrameHandler3.  Ich habe den Durchsatz mit einem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Benchmark-</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Programm</a> getestet, das 100 Stack-Frames mit jeweils einem Try / Catch und 3 zu zerst√∂renden automatischen Objekten abwickelt.  Dies wurde 50.000 Mal ausgef√ºhrt, um die Ausf√ºhrungszeit des Profils zu bestimmen. Dies f√ºhrte zu Gesamtausf√ºhrungszeiten von: </p><table border="2" cellspacing="10" cellpadding="5"><tbody><tr><td></td><td>  <strong>__CxxFrameHandler3</strong> </td><td>  <strong>__CxxFrameHandler4</strong> </td></tr><tr><td>  <strong>Ausf√ºhrungszeit</strong> </td><td>  4,84 s </td><td>  4,25s </td></tr></tbody></table><p>  Die Profilerstellung ergab, dass die Dekomprimierung zwar zus√§tzliche Verarbeitungszeit bedeutet, die Kosten jedoch durch weniger Speicher f√ºr den threadlokalen Speicher im neuen Laufzeitdesign aufgewogen werden. </p><br><h2>  Zukunftspl√§ne </h2><br><p>  Wie im Titel erw√§hnt, ist FH4 derzeit nur f√ºr x64-Bin√§rdateien aktiviert.  Die beschriebenen Techniken sind jedoch auf ARM32 / ARM64 und in geringerem Umfang auf x86 erweiterbar.  Wir suchen derzeit nach guten Beispielen (wie Microsoft.UI.Xaml.dll), um die Ausweitung dieser Technologie auf andere Plattformen zu motivieren. Wenn Sie der Meinung sind, dass Sie einen guten Anwendungsfall haben, lassen Sie es uns wissen! </p><br><p>  Der Prozess der Integration der Laufzeit√§nderungen f√ºr Store-Anwendungen zur Unterst√ºtzung von FH4 ist im Gange.  Sobald dies erledigt ist, wird der neue Handler standardm√§√üig aktiviert, sodass jeder diese Einsparungen bei der Bin√§rgr√∂√üe ohne zus√§tzlichen Aufwand erzielen kann. </p><br><h2>  Schlussbemerkungen </h2><br><p>  F√ºr alle, die glauben, dass ihre x64-Bin√§rdateien etwas reduziert werden k√∂nnten: Probieren Sie noch heute FH4 (√ºber '/ d2FH4') aus!  Wir sind gespannt, welche Einsparungen dies jetzt bringen kann, da diese Funktion nicht mehr verf√ºgbar ist.  Wenn Sie auf Probleme <a href="">sto√üen</a> , <a href="">teilen</a> Sie uns dies bitte in den Kommentaren unten, per E-Mail ( <a href="">visualcpp@microsoft.com</a> ) oder √ºber die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Entwickler-Community mit</a> .  Sie finden uns auch auf Twitter ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">@VisualC</a> ). </p><br><p>  Vielen Dank an Kenny Kerr, der uns an Microsoft.UI.Xaml.dll weitergeleitet hat, an Ravi Pinjala, der die Zahlen in Office gesammelt hat, und an Robert Roessler, der dies in SQL ausprobiert hat. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de442996/">https://habr.com/ru/post/de442996/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de442984/index.html">√Ñnderung des Netzteils des IBM 5150 Modell A 230 V Computers</a></li>
<li><a href="../de442986/index.html">Tesla Autopilot: Implementierungsstrategie</a></li>
<li><a href="../de442988/index.html">DIY virtuelle Maschine</a></li>
<li><a href="../de442992/index.html">Windows Calculator jetzt Open Source</a></li>
<li><a href="../de442994/index.html">Ank√ºndigung des Open Sourcing von Windows Calculator</a></li>
<li><a href="../de442998/index.html">Under-Carpet Analytics: Ein R√ºckblick auf 18 neue Jahre</a></li>
<li><a href="../de443000/index.html">Ein Update auf C # -Versionen und C # -Tools</a></li>
<li><a href="../de443002/index.html">Der aktuelle Stand der Bewusstseinswissenschaft</a></li>
<li><a href="../de443004/index.html">Meine Freundin und das erste Videospiel. Einheitsentwicklung. Teil 1</a></li>
<li><a href="../de443006/index.html">Grafana v6 ver√∂ffentlicht - neue Funktionen eines offenen Visualisierungstools</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>