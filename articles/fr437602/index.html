<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔟 👨🏿‍⚕️ 👩🏻‍⚖️ Profil d'un projet Unity avec Android Studio 👇🏼 📄 👊</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonne journée à tous! Cet article explique comment profiler les jeux Unity sur Android avec Android Studio. Je vais vous expliquer comment configurer ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Profil d'un projet Unity avec Android Studio</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/437602/">  Bonne journée à tous!  Cet article explique comment profiler les jeux Unity sur Android avec Android Studio.  Je vais vous expliquer comment configurer Android Studio et obtenir le maximum de données.  Les questions d'analyse et de conclusions basées sur le résultat sortent du cadre de cet article. <br><a name="habracut"></a><br><h2>  Prérequis </h2><br>  Pour profiler pleinement l'application, vous avez besoin d'un téléphone avec Android 8 ou version ultérieure (API 27).  Dans l'expérience, le profilage avec les anciennes versions d'Android est plus aventureux que bon.  Pour cette raison, je recommande d'obtenir une gamme complète d'appareils Nexus, car ils ont un ancien matériel et les dernières mises à jour Android. <br><br><h2>  Configuration d'un projet Unity </h2><br>  Pour obtenir le résultat, vous devez configurer le projet Unity d'une certaine manière. <br><br><h3>  Paramètres dans les paramètres de build </h3><br><img src="https://habrastorage.org/webt/av/tr/ju/avtrjuzmsq9xk8egl88e_osxbz4.jpeg" alt="image"><br><br><ul><li>  Tout d'abord, vous devez basculer le <b>système de construction</b> sur <b>«Gradle»</b> et cocher la case à côté de <b>«Exporter le projet»</b> .  Ainsi, nous aurons un projet Android Studio prêt à l'emploi, que nous continuerons à profiler.  Le profilage d'un fichier APK fini est également possible, mais plus limité et nécessite plus de préparation. </li><li>  Il est conseillé de désactiver le mode <b>«Development Build»</b> , car les timings résultants dans le profileur seront aussi proches que possible des vrais. </li></ul><br><h3>  Paramètres dans les paramètres du lecteur </h3><br><img src="https://habrastorage.org/webt/-7/hz/ho/-7hzhozfm55alhksgs0jozpm488.jpeg" alt="image"><br><br><ul><li>  Installez le <b>backend de script</b> dans <b>IL2CPP</b> .  Si vous quittez Mono, avec le profilage natif, nous verrons de nombreuses fonctions Mono, sans informations sur la façon dont elles se rapportent au code C #. <br></li><li>  L'option <b>'Configuration du compilateur C ++'</b> pour Android n'a aucun effet (dans Unity 2018.3).  Vous pouvez le mettre dans 'Release', peut-être que dans les futures versions de la chaîne d'outils Unity Android, ce paramètre affectera les paramètres du compilateur. <br></li><li>  Il est conseillé de limiter l <b>'«architecture cible»</b> à <b>ARMv7</b> .  Ainsi, vous économisez du temps de compilation et faites l'expérience de nombreuses architectures qui mettent parfois Android Studio dans une stupeur. <br></li><li>  Il convient également de définir un certain nombre de paramètres supplémentaires: <ul><li>  Emplacement d'installation - «Préférer externe» </li><li>  Accès Internet - «Requis» </li><li>  Autorisation d'écriture - «Externe (SDCard)» </li></ul><br>  Android Studio et d'autres profileurs utilisent simpleperf pour collecter des statistiques, et il aura besoin d'accéder à une carte mémoire pour enregistrer des fichiers temporaires. <br></li></ul><br><h2>  Préparation du projet Gradle </h2><br>  Après avoir installé tous les paramètres, créez un projet Unity.  Vous devriez obtenir un dossier avec le projet Gradle. <br><img src="https://habrastorage.org/webt/vt/qq/fi/vtqqfixujd8ntg_ipoycbp9exwc.jpeg" alt="image"><br><br>  Par défaut, Unity crée un projet afin que vous envisagiez de créer le fichier APK final à partir de celui-ci.  Par conséquent, toutes les informations de débogage en ont été supprimées, mais heureusement, elles peuvent être renvoyées.  Pour ce faire, vous devez remplacer libil2cpp.so et libunity.so par la version contenant des informations de débogage. <br><br><h3>  libil2cpp.so </h3><br>  Il s'agit d'un fichier qui contient tout le code C ++ généré par IL2CPP à partir de votre code C #.  Unity génère toutes les informations nécessaires au profilage, mais pour optimiser la taille de l'APK, il les supprime pendant le processus de génération.  Pour le retourner: <br><ul><li>  Accédez à votre dossier de projet </li><li>  Localisez-y le sous-dossier <b>Temp</b> et accédez au sous-dossier <b>Temp / StagingArea / symboles / armeabi-v7a</b> </li><li>  Recherchez <b>'libil2cpp.so.debug'</b> dedans.  Il s'agit de la version de «libil2cpp.so» avec des informations de débogage. </li><li>  Maintenant, allez dans le projet Gradle et trouvez le dossier <b>'\ src \ main \ jniLibs \ armeabi-v7a' dedans</b> </li><li>  Remplacez <b>'libil2cpp.so' par le</b> fichier <b>'libil2cpp.so.debug'</b> </li></ul><br><h3>  libunity.so </h3><br>  Il s'agit du fichier qui contient la partie de bas niveau de Unity Player.  Puisque nous effectuons des versions Release, Unity place un fichier dans votre projet sans déboguer les informations.  Vous devez remplacer libunity.so par un fichier de caractères. <br><br><ul><li>  Accédez au dossier dans lequel vous avez installé Unity </li><li>  Accédez au dossier <b>"\ Data \ PlaybackEngines \ AndroidPlayer \ Variations \ il2cpp \ Development \ Libs \ armeabi-v7a \"</b> </li><li>  Prenez le fichier <b>libunity.so</b> à partir de là et remplacez le fichier dans votre projet, qui se trouve dans le dossier <b>'\ src \ main \ jniLibs \ armeabi-v7a'</b> </li></ul><br><h2>  Profilage </h2><br>  Vous pouvez maintenant démarrer le profilage dans Android Studio, cliquez simplement sur le bouton Démarrer le profileur. <br><br><img src="https://habrastorage.org/webt/le/b3/yi/leb3yimardolvn0inirdf0hh-ak.jpeg" alt="image"><br><br>  Android Studio lance l'application et la session de profilage commence <br><br><img src="https://habrastorage.org/webt/q7/jv/na/q7jvnadenwr-9ixtxu-ac7l0exe.jpeg" alt="image"><br><br>  Par défaut, Android Studio affiche des graphiques, mais n'échantillonne pas de données.  Pour démarrer le processus, vous devez cliquer sur la piste CPU afin que le profileur passe à la vue CPU.  Dans ce cas, une liste déroulante et le bouton «Enregistrer» apparaîtront en haut de la fenêtre. <br><br><img src="https://habrastorage.org/webt/_q/1t/qi/_q1tqikjnm-9vqltl3zvwh8t1am.jpeg" alt="image"><br><br>  Sélectionnez Sampled 'Native' (Dans Android Studio 3.3 - C / C ++ Native), puis cliquez sur le bouton 'Enregistrer'. <br>  Étant donné que l'enregistrement se fait sur le disque de l'appareil, il est préférable de ne pas enregistrer plus de 5 à 8 secondes d'expérience, de nombreux appareils échoueront également sur une plus petite quantité de données (voir la liste des appareils testés à la fin de l'article). <br><br>  Pour obtenir le résultat, cliquez sur «Arrêter» puis sur un carré rouge pour interrompre la session.  Il est difficile de comprendre l'idée des auteurs, mais si vous n'arrêtez pas complètement l'enregistrement, le profileur ne commence pas toujours à analyser les données reçues et votre segment avec les données ira loin. <br><br><img src="https://habrastorage.org/webt/nc/s6/wb/ncs6wbzxzmnl2ekezsbeikdalto.jpeg" alt="image"><br><br>  Après cela, il ne reste plus qu'à attendre un peu, après 30-50 secondes le profileur vous donnera le résultat.  Si tout est correctement configuré, vous obtiendrez la capture avec tous les noms de fonction <br><br><img src="https://habrastorage.org/webt/ft/ws/9a/ftws9av2ird_wbbvppc3af9smey.jpeg" alt="image"><br><br><h2>  Caractéristiques connues </h2><br><ul><li>  Les résultats les plus stables peuvent être obtenus sur les appareils racine </li><li>  N'utilisez pas Samsung, et ils ont de nombreuses cloches et sifflets de protection qui interfèrent avec le débogage </li><li>  Dans de nombreux endroits, votre pile collective ira dans des fonctions de la forme «kernel.kptr + address».  Ce sont des appels dans Android Kernel qui sont protégés en raison de politiques de sécurité.  Sur un appareil rooté, la protection peut être désactivée: <br><ul><li>  Exécutez le `adb shell` </li><li>  Exécutez `su` pour obtenir les privilèges root </li><li>  Exécutez 'sysctl -w kernel.kptr_restrict = 0' - cela supprimera la protection du noyau </li><li>  <b>[!] Une</b> fois le débogage terminé, exécutez 'sysctl -w kernel.kptr_restrict = 1'.  Certains appareils ne pourront pas démarrer le système d'exploitation sinon au redémarrage.  Dans de nombreux cas, il n'est traité qu'en faisant clignoter un noyau propre. </li></ul></li><li>  Si Android Studio se bloque fréquemment, vous pouvez essayer d'augmenter le tas de machine virtuelle Java: <ul><li>  2 Go - pour les projets de taille moyenne («-Xmx2g») </li><li>  4Gb - pour les grands projets ('-Xmx4g') </li></ul></li><li>  Sur les périphériques non rootés, le passage du noyau en «mode permissif» améliore parfois la situation. <br><ul><li>  Exécutez la commande 'adb shell setenforce 0' </li></ul></li></ul><br><h2>  Spécificités de l'unité </h2><br><ul><li>  Le thread principal Unity s'appelle UnityMain, mais vous pouvez voir beaucoup d'UnityMain lors du profilage.  Ce sont des threads utilisateur que vous créez dans le code C #.  Par défaut, ils obtiennent le même nom.  Le thread principal d'Unity est généralement facile à distinguer, car il sera le plus chargé. </li><li>  Le flux graphique est appelé UnityGfxWorkerW </li><li>  Les threads du système Unity Job sont appelés Thread Worker. </li><li>  Malheureusement, certaines fonctions d'attente qu'Unity utilise (futex-s), Android Studio affiche et considère non pas comme un temps d'attente, mais comme une activité. </li><li>  Lorsque vous regardez le graphique des appels dans la vue descendante, vous devez passer par plusieurs niveaux avec un appel Java, malheureusement vous ne pouvez pas le filtrer dans Android Studio. </li></ul><br><img src="https://habrastorage.org/webt/f_/it/lp/f_itlpp-dlvolgu5pb-ze7rz4oe.jpeg" alt="image"><br><br><h2>  Appareils recommandés </h2><br>  Nous avons utilisé les appareils suivants pour les expériences: <br><ul><li>  Samsung Galaxy S8 </li><li>  Google Pixel 2XL </li><li>  Pixel Google </li><li>  Sony Xperia XA1 </li><li>  Huawei Honor 7 </li><li>  Huawei Nexus 6P </li><li>  Moto G5P </li><li>  Asus Nexus 7 (2013) </li></ul><br>  Tous les appareils ont été installés, pour Huawei Nexus 6P, nous avons assemblé le cœur et l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">AOSP</a> .  En conséquence, Google et Sony se sont avérés être les plus faciles et les plus faciles à travailler.  Sony a un excellent site pour les développeurs - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Open Devices</a> .  Huawei ne vous permet plus de déverrouiller facilement des appareils, Samsung cause des difficultés constantes avec des niveaux de protection supplémentaires.  Le Moto G5P a souvent bloqué le processus de collecte de données du profileur (simpleperf). </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr437602/">https://habr.com/ru/post/fr437602/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr437592/index.html">Architecture de couche d'exécution de tâche asynchrone</a></li>
<li><a href="../fr437594/index.html">Comment j'ai éradiqué la cause du bégaiement et du saut de trame dans tous les jeux, et aussi abaissé accidentellement la température de 15 degrés</a></li>
<li><a href="../fr437596/index.html">OTRS: authentification, autorisation et synchronisation LDAP (FreeIPA, AD)</a></li>
<li><a href="../fr437598/index.html">Comment enregistrer le système de jeu à partir d'un PC personnel au moyen de la virtualisation</a></li>
<li><a href="../fr437600/index.html">opencv4arts: Dessine ma ville, Vincent</a></li>
<li><a href="../fr437604/index.html">Effondrement de la fonction d'onde: un algorithme inspiré de la mécanique quantique</a></li>
<li><a href="../fr437606/index.html">Qui mange la mémoire de notre iPhone? Peler les pommes</a></li>
<li><a href="../fr437610/index.html">[longrid] 20 ans de carrière en programmation dans une grande petite ville</a></li>
<li><a href="../fr437612/index.html">Le géant de l'informatique traitera de la photonique au silicium - comment cela affectera le marché des équipements de réseau</a></li>
<li><a href="../fr437614/index.html">Le modèle architectural de l'itérateur dans l'univers Swift</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>