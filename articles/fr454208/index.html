<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåå üíÆ üëé RISC-V √† partir de z√©ro üö® ‚ûó üíÑ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cet article, nous explorons divers concepts de bas niveau (compilation et mise en page, temps d'ex√©cution primitifs, assembleur, etc.) √† travers ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>RISC-V √† partir de z√©ro</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454208/">  Dans cet article, nous explorons divers concepts de bas niveau (compilation et mise en page, temps d'ex√©cution primitifs, assembleur, etc.) √† travers le prisme de l'architecture RISC-V et de son √©cosyst√®me.  Je suis moi-m√™me d√©veloppeur web, je ne fais rien au travail, mais c'est tr√®s int√©ressant pour moi, c'est de l√† que vient l'article!  Rejoignez-moi dans ce voyage mouvement√© dans les profondeurs du chaos de bas niveau. <br><br>  Tout d'abord, parlons un peu de RISC-V et de l'importance de cette architecture, configurons la cha√Æne d'outils RISC-V et ex√©cutons un programme C simple sur du mat√©riel RISC-V √©mul√©. <br><a name="habracut"></a><br><h1>  Table des mati√®res </h1><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Qu'est-ce que RISC-V?</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Configuration des outils QEMU et RISC-V</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Salut RISC-V!</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Approche na√Øve</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lever le rideau -v</a> <br></li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Rechercher dans notre pile</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Disposition</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Arr√™te √ßa!</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><s>Hammertime!</s></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Runtime!</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">D√©boguer mais maintenant pour de vrai</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Et ensuite?</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">En option</a> </li></ol><br><a name="1"></a><h1>  Qu'est-ce que RISC-V? </h1><br>  RISC-V est une architecture de jeu d'instructions gratuit.  Le projet est n√© √† l'Universit√© de Californie √† Berkeley en 2010.  Un r√¥le important dans son succ√®s a √©t√© jou√© par l'ouverture du code et la libert√© d'utilisation, qui √©taient tr√®s diff√©rentes de nombreuses autres architectures.  Prenez ARM: pour cr√©er un processeur compatible, vous devez payer une avance <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">de 1 √† 10 millions de dollars, ainsi que des redevances de 0,5 √† 2% sur les ventes</a> .  Un mod√®le gratuit et ouvert fait de RISC-V une option attrayante pour beaucoup, y compris pour les startups qui ne peuvent pas payer de licence pour un ARM ou un autre processeur, pour les chercheurs universitaires et (√©videmment) pour la communaut√© open source. <br><br>  La croissance rapide de la popularit√© de RISC-V n'est pas pass√©e inaper√ßue.  ARM a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lanc√© un site</a> qui a tent√© (plut√¥t sans succ√®s) de mettre en √©vidence les pr√©tendus avantages d'ARM sur RISC-V (le site est d√©j√† ferm√©).  Le projet RISC-V est soutenu par de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nombreuses grandes entreprises</a> , dont Google, Nvidia et Western Digital. <br><br><a name="2"></a><h1>  Configuration des outils QEMU et RISC-V </h1><br>  Nous ne pouvons pas ex√©cuter le code sur le processeur RISC-V avant d'avoir configur√© l'environnement.  Heureusement, cela ne n√©cessite pas de processeur RISC-V physique; √† la place, nous prenons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">qemu</a> .  Suivez les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">instructions d'installation</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">votre syst√®me d'exploitation</a> .  J'ai MacOS, alors entrez simplement une commande: <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># also available via MacPorts - `sudo port install qemu` brew install qemu</span></span></code> </pre> <br>  Id√©alement, <code>qemu</code> est livr√© avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plusieurs machines pr√™tes √† l'emploi</a> (voir l' <code>qemu-system-riscv32 -machine</code> ). <br><br>  Ensuite, installez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">OpenOCD</a> pour les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">outils</a> RISC-V et RISC-V. <br><br>  T√©l√©chargez les assemblages pr√™ts √† l'emploi des outils RISC-V OpenOCD et RISC-V <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br>  Nous extrayons les fichiers dans n'importe quel r√©pertoire, je l'ai <code>~/usys/riscv</code> .  N'oubliez pas cela pour une utilisation future. <br><br><pre> <code class="bash hljs">mkdir -p ~/usys/riscv <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/Downloads cp openocd-&lt;date&gt;-&lt;platform&gt;.tar.gz ~/usys/riscv cp riscv64-unknown-elf-gcc-&lt;date&gt;-&lt;platform&gt;.tar.gz ~/usys/riscv <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/usys/riscv tar -xvf openocd-&lt;date&gt;-&lt;platform&gt;.tar.gz tar -xvf riscv64-unknown-elf-gcc-&lt;date&gt;-&lt;platform&gt;.tar.gz</code> </pre> <br>  D√©finissez les variables d'environnement <code>RISCV_OPENOCD_PATH</code> et <code>RISCV_PATH</code> pour que d'autres programmes puissent trouver notre cha√Æne d'outils.  Cela peut sembler diff√©rent selon le syst√®me d'exploitation et le shell: j'ai ajout√© les chemins d'acc√®s au <code>~/.zshenv</code> . <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># I put these two exports directly in my ~/.zshenv file - you may have to do something else. export RISCV_OPENOCD_PATH="$HOME/usys/riscv/openocd-&lt;date&gt;-&lt;version&gt;" export RISCV_PATH="$HOME/usys/riscv/riscv64-unknown-elf-gcc-&lt;date&gt;-&lt;version&gt;" # Reload .zshenv with our new environment variables. Restarting your shell will have a similar effect. source ~/.zshenv</span></span></code> </pre> <br>  Cr√©ez un lien symbolique dans <code>/usr/local/bin</code> pour ce fichier ex√©cutable afin de pouvoir l'ex√©cuter √† tout moment sans sp√©cifier le chemin complet vers <code>~/usys/riscv/riscv64-unknown-elf-gcc-&lt;date&gt;-&lt;version&gt;/bin/riscv64-unknown-elf-gcc</code> . <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Symbolically link our gcc executable into /usr/local/bin. Repeat this process for any other executables you want to quickly access. ln -s ~/usys/riscv/riscv64-unknown-elf-gcc-8.2.0-&lt;date&gt;-&lt;version&gt;/bin/riscv64-unknown-elf-gcc /usr/local/bin</span></span></code> </pre> <br>  Et le tour est jou√©, nous avons une bo√Æte √† outils RISC-V fonctionnelle!  Tous nos ex√©cutables, tels que <code>riscv64-unknown-elf-gcc</code> , <code>riscv64-unknown-elf-gdb</code> , <code>riscv64-unknown-elf-ld</code> et autres, se trouvent dans <code>~/usys/riscv/riscv64-unknown-elf-gcc-&lt;date&gt;-&lt;version&gt;/bin/</code> . <br><br><a name="3"></a><h1>  Salut RISC-V! </h1><br>  <i>Patch du 26 mai 2019:</i> <i><br><br></i>  <i>Malheureusement, en raison d'un bogue dans RISC-V QEMU, le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">programme</a> ¬´hello world¬ª de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">freedom-e-sdk</a> dans QEMU ne fonctionne plus.</i>  <i>Un correctif a √©t√© publi√© pour r√©soudre ce probl√®me, mais pour l'instant, ignorez cette section.</i>  <i>Ce programme ne sera pas n√©cessaire dans les sections suivantes de l'article.</i>  <i>Je surveille la situation et met √† jour l'article apr√®s avoir corrig√© le bogue.</i> <i><br><br></i>  <i>Voir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ce commentaire</a> pour plus d'informations.</i> <br><br>  Une fois les outils configur√©s, ex√©cutons le programme RISC-V simple.  Commen√ßons par cloner le r√©f√©rentiel SiFive <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">freedom-e-sdk</a> : <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/wherever/you/want/to/<span class="hljs-built_in"><span class="hljs-built_in">clone</span></span>/this git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> --recursive https://github.com/sifive/freedom<span class="hljs-_"><span class="hljs-_">-e</span></span>-sdk.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> freedom<span class="hljs-_"><span class="hljs-_">-e</span></span>-sdk</code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Par tradition</a> , commen√ßons par le programme 'Hello, world' du r√©f√©rentiel <code>freedom-e-sdk</code> .  Nous utilisons le <code>Makefile</code> pr√™t √† l'emploi qu'ils fournissent pour compiler ce programme en mode d√©bogage: <br><br><pre> <code class="bash hljs">make PROGRAM=hello TARGET=sifive-hifive1 CONFIGURATION=debug software</code> </pre> <br>  Et ex√©cutez dans QEMU: <br><br><pre> <code class="bash hljs">qemu-system-riscv32 -nographic -machine sifive_e -kernel software/hello/debug/hello.elf Hello, World!</code> </pre> <br>  C'est un bon d√©but.  Vous pouvez ex√©cuter d'autres exemples √† partir de <code>freedom-e-sdk</code> .  Apr√®s cela, nous allons √©crire et essayer de d√©boguer notre propre programme en C. <br><br><h1>  Approche na√Øve </h1><br>  Commen√ßons par un programme simple qui ajoute infiniment deux nombres. <br><br><pre> <code class="cpp hljs">cat add.<span class="hljs-function"><span class="hljs-function">c </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> b = <span class="hljs-number"><span class="hljs-number">12</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c = a + b; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  Nous voulons ex√©cuter ce programme, et la premi√®re chose dont nous avons besoin pour le compiler pour le processeur RISC-V. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># -O0 to disable all optimizations. Without this, GCC might optimize # away our infinite addition since the result 'c' is never used. # -g to tell GCC to preserve debug info in our executable. riscv64-unknown-elf-gcc add.c -O0 -g</span></span></code> </pre> <br>  Cela cr√©e le fichier <code>a.out</code> , que <code>gcc</code> utilise par d√©faut pour les fichiers ex√©cutables.  Maintenant, ex√©cutez ce fichier dans <code>qemu</code> : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># -machine tells QEMU which among our list of available machines we want to # run our executable against. Run qemu-system-riscv64 -machine help to list # all available machines. # -m is the amount of memory to allocate to our virtual machine. # -gdb tcp::1234 tells QEMU to also start a GDB server on localhost:1234 where # TCP is the means of communication. # -kernel tells QEMU what we're looking to run, even if our executable isn't # exactly a "kernel". qemu-system-riscv64 -machine virt -m 128M -gdb tcp::1234 -kernel a.out</span></span></code> </pre> <br>  Nous avons choisi la machine <code>virt</code> <code>riscv-qemu</code> . <br><br>  Maintenant que notre programme s'ex√©cute dans QEMU avec le serveur GDB sur <code>localhost:1234</code> , nous nous y connectons avec le client RISC-V GDB √† partir d'un terminal distinct: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># --tui gives us a (t)extual (ui) for our GDB session. # While we can start GDB without any arguments, specifying 'a.out' tells GDB # to load debug symbols from that file for the newly created session. riscv64-unknown-elf-gdb --tui a.out</span></span></code> </pre> <br>  Et nous sommes √† l'int√©rieur de GDB! <br><br><pre>  Ce GDB a √©t√© configur√© comme "--host = x86_64-apple-darwin17.7.0 --target = riscv64-unknown-elf".  ‚îÇ
 Tapez "show configuration" pour les d√©tails de configuration.  ‚îÇ
 Pour les instructions de rapport de bogue, veuillez consulter: ‚îÇ
 &lt;http://www.gnu.org/software/gdb/bugs/&gt;.  ‚îÇ
 Trouvez le manuel GDB et d'autres ressources de documentation en ligne sur: ‚îÇ
     &lt;http://www.gnu.org/software/gdb/documentation/&gt;.  ‚îÇ
                                                                                                       ‚îÇ
 Pour obtenir de l'aide, tapez "help".  ‚îÇ
 Tapez "mot appropri√©" pour rechercher des commandes li√©es √† "mot" ... ‚îÇ
 Lecture des symboles de a.out ... ‚îÇ
 (gdb) </pre><br>  Nous pouvons essayer d'ex√©cuter les commandes <code>run</code> ou <code>start</code> pour le fichier ex√©cutable <code>a.out</code> dans GDB, mais pour le moment cela ne fonctionnera pas pour une raison √©vidente.  Nous avons compil√© le programme en tant que <code>riscv64-unknown-elf-gcc</code> , donc l'h√¥te devrait fonctionner sur l'architecture <code>riscv64</code> . <br><br>  Mais il y a une issue!  Cette situation est l'une des principales raisons de l'existence du mod√®le client-serveur de GDB.  Nous pouvons prendre le fichier ex√©cutable <code>riscv64-unknown-elf-gdb</code> et au lieu de le lancer sur l'h√¥te, lui sp√©cifier une cible distante (serveur GDB).  Comme vous vous en souvenez, nous venons de lancer <code>riscv-qemu</code> et nous avons dit de d√©marrer le serveur GDB sur <code>localhost:1234</code> .  Connectez-vous simplement √† ce serveur: <br><br><pre>  (gdb) cible √† distance: 1234 ‚îÇ
 D√©bogage √† distance en utilisant: 1234 </pre><br>  Vous pouvez maintenant d√©finir des points d'arr√™t: <br><br><pre> <code class="bash hljs">(gdb) b main Breakpoint 1 at 0x1018e: file add.c, line 2. (gdb) b 5 <span class="hljs-comment"><span class="hljs-comment"># this is the line within the forever-while loop. int c = a + b; Breakpoint 2 at 0x1019a: file add.c, line 5.</span></span></code> </pre> <br>  Et enfin, sp√©cifiez GDB <code>continue</code> (commande abr√©g√©e <code>c</code> ) jusqu'√† ce que nous atteignions le point d'arr√™t: <br><br><pre> <code class="bash hljs">(gdb) c Continuing.</code> </pre> <br>  Vous remarquerez rapidement que le processus ne se termine en aucune fa√ßon.  C'est √©trange ... ne devrions-nous pas imm√©diatement atteindre le point d'arr√™t <code>b 5</code> ?  Qu'est-il arriv√©? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a53/834/210/a538342106336ef7ed1b8f9e53a47f48.png"><br><br>  Ici, vous pouvez voir plusieurs probl√®mes: <br><br><ol><li>  L'interface utilisateur de texte ne peut pas trouver la source.  L'interface doit afficher notre code et tous les points d'arr√™t √† proximit√©. <br></li><li>  GDB ne voit pas la ligne d'ex√©cution actuelle ( <code>L??</code> ) et affiche le compteur 0x0 ( <code>PC: 0x0</code> ). <br></li><li>  Du texte dans la ligne d'entr√©e, qui dans son int√©gralit√© ressemble √† ceci: <code>0x0000000000000000 in ?? ()</code> <code>0x0000000000000000 in ?? ()</code> </li></ol><br>  Combin√©s au fait que nous ne pouvons pas atteindre le point d'arr√™t, ces indicateurs indiquent: nous avons fait <i>quelque chose de</i> mal.  Mais quoi? <br><br><a name="5"></a><h1>  Lever le rideau -v </h1><br>  Pour comprendre ce qui se passe, vous devez prendre du recul et parler du fonctionnement de notre programme C simple sous le capot.  La fonction <code>main</code> fait un simple ajout, mais qu'est-ce que c'est vraiment?  Pourquoi devrait-il √™tre appel√© <code>main</code> , pas d' <code>origin</code> ou <code>begin</code> ?  Selon la convention, tous les fichiers ex√©cutables commencent √† √™tre ex√©cut√©s avec la fonction <code>main</code> , mais quelle magie fournit ce comportement? <br><br>  Pour r√©pondre √† ces questions, r√©p√©tons notre √©quipe GCC avec l'indicateur <code>-v</code> pour obtenir une sortie plus d√©taill√©e de ce qui se passe r√©ellement. <br><br><pre> <code class="bash hljs">riscv64-unknown-elf-gcc add.c -O0 -g -v</code> </pre> <br>  La sortie est volumineuse, nous ne verrons donc pas la liste enti√®re.  Il est important de noter que bien que GCC soit formellement un compilateur, il est √©galement d√©fini par d√©faut sur la compilation (pour se limiter √† la compilation et √† l'assemblage, vous devez sp√©cifier l'indicateur <code>-c</code> ).  Pourquoi est-ce important?  Eh bien, jetez un ≈ìil √† l'extrait de la sortie d√©taill√©e de <code>gcc</code> : <br><br><pre>  # La commande `gcc -v` r√©elle g√©n√®re des chemins complets, mais ceux-ci sont assez
 # long, alors faites comme si ces variables existaient.
 # $ RV_GCC_BIN_PATH = / Users / twilcock / usys / riscv / riscv64-unknown-elf-gcc- &lt;date&gt; - &lt;version&gt; / bin /
 # $ RV_GCC_LIB_PATH = $ RV_GCC_BIN_PATH /../ lib / gcc / riscv64-unknown-elf / 8.2.0<font></font>
<font></font>
 $ RV_GCC_BIN_PATH /../ libexec / gcc / riscv64-unknown-elf / 8.2.0 / collect2 \
   ... tronqu√©e ... 
   $ RV_GCC_LIB_PATH /../../../../ riscv64-unknown-elf / lib / rv64imafdc / lp64d / crt0.o \ 
   $ RV_GCC_LIB_PATH / riscv64-unknown-elf / 8.2.0 / rv64imafdc / lp64d / crtbegin.o \
   -lgcc --start-group -lc -lgloss --end-group -lgcc \ 
   $ RV_GCC_LIB_PATH / rv64imafdc / lp64d / crtend.o
   ... tronqu√©e ...
 COLLECT_GCC_OPTIONS = '- O0' '-g' '-v' '-march = rv64imafdc' '-mabi = lp64d' </pre><br>  Je comprends que m√™me sous forme abr√©g√©e, c'est beaucoup, alors laissez-moi vous expliquer.  Sur la premi√®re ligne, <code>gcc</code> ex√©cute le programme <code>collect2</code> , transmet les arguments <code>crt0.o</code> , <code>crtbegin.o</code> et <code>crtend.o</code> , les <code>-lgcc</code> et <code>--start-group</code> .  La description de collect2 se trouve <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> : en bref, collect2 organise diverses fonctions d'initialisation au d√©marrage, r√©alisant la mise en page en une ou plusieurs passes. <br><br>  Ainsi, GCC compile plusieurs fichiers <code>crt</code> avec notre code.  Comme vous pouvez le deviner, <code>crt</code> signifie ¬´runtime C¬ª.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ici, il est</a> d√©crit en d√©tail √† quoi chaque <code>crt</code> destin√©, mais nous nous int√©ressons √† <code>crt0</code> , qui fait une chose importante: <br><br><blockquote>  <i>"Cet objet [crt0] devrait contenir le caract√®re <code>_start</code> , qui indique le bootstrap du programme."</i> </blockquote><br>  L'essence du ¬´bootstrap¬ª d√©pend de la plate-forme, mais elle implique g√©n√©ralement des t√¢ches importantes telles que la configuration d'un cadre de pile, la transmission d'arguments de ligne de commande et l'appel √† <code>main</code> .  Oui, nous avons <i>enfin</i> trouv√© la r√©ponse √† la question: c'est <code>_start</code> appelle notre fonction principale! <br><br><a name="6"></a><h1>  Rechercher dans notre pile </h1><br>  Nous avons r√©solu une √©nigme, mais comment cela nous rapproche-t-il de l'objectif initial - ex√©cuter un programme C simple dans <code>gdb</code> ?  Il reste √† r√©soudre plusieurs probl√®mes: le premier d'entre eux est li√© √† la fa√ßon dont <code>crt0</code> configure notre pile. <br><br>  Comme nous l'avons vu ci-dessus, <code>gcc</code> <code>crt0</code> d√©faut la <code>crt0</code> .  Les param√®tres par d√©faut sont s√©lectionn√©s en fonction de plusieurs facteurs: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Triplet cible</a> correspondant √† la structure du <code>machine-vendor-operatingsystem</code> de <code>machine-vendor-operatingsystem</code> .  Nous l'avons <code>riscv64-unknown-elf</code> <br></li><li>  Architecture cible, <code>rv64imafdc</code> <br></li><li>  ABI cible, <code>lp64d</code> </li></ul><br>  Habituellement, tout fonctionne bien, mais pas pour tous les processeurs RISC-V.  Comme mentionn√© pr√©c√©demment, l'une des t√¢ches de <code>crt0</code> est de configurer la pile.  Mais il ne sait pas exactement o√π devrait √™tre la pile pour notre CPU ( <code>-machine</code> )?  Il ne peut pas le faire sans notre aide. <br><br>  Dans la commande <code>qemu-system-riscv64 -machine virt -m 128M -gdb tcp::1234 -kernel a.out</code> nous avons utilis√© la machine <code>virt</code> .  Heureusement, <code>qemu</code> facilite le vidage des informations de la machine dans un vidage <code>dtb</code> (blob d'arbre de p√©riph√©rique). <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Go to the ~/usys/riscv folder we created before and create a new dir # for our machine information. cd ~/usys/riscv &amp;&amp; mkdir machines cd machines # Use qemu to dump info about the 'virt' machine in dtb (device tree blob) # format. # The data in this file represents hardware components of a given # machine / device / board. qemu-system-riscv64 -machine virt -machine dumpdtb=riscv64-virt.dtb</span></span></code> </pre> <br>  Les donn√©es Dtb sont difficiles √† lire car il s'agit essentiellement d'un format binaire, mais il existe un utilitaire de ligne de commande <code>dtc</code> (compilateur d'arborescence de p√©riph√©riques) qui peut convertir le fichier en quelque chose de plus lisible. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># I'm running MacOS, so I use Homebrew to install this. If you're # running another OS you may need to do something else. brew install dtc # Convert our .dtb into a human-readable .dts (device tree source) file. dtc -I dtb -O dts -o riscv64-virt.dts riscv64-virt.dtb</span></span></code> </pre> <br>  Le fichier de sortie est <code>riscv64-virt.dts</code> , o√π nous voyons beaucoup d'informations int√©ressantes sur <code>virt</code> : le nombre de c≈ìurs de processeur disponibles, l'emplacement m√©moire de divers p√©riph√©riques, tels que UART, l'emplacement de la m√©moire interne (RAM).  La pile doit √™tre dans cette m√©moire, alors recherchez-la avec <code>grep</code> : <br><br><pre> <code class="bash hljs">grep memory riscv64-virt.dts -A 3 memory@80000000 { device_type = <span class="hljs-string"><span class="hljs-string">"memory"</span></span>; reg = &lt;0x00 0x80000000 0x00 0x8000000&gt;; };</code> </pre> <br>  Comme vous pouvez le voir, ce n≈ìud a une ¬´m√©moire¬ª sp√©cifi√©e en tant que <code>device_type</code> .  Apparemment, nous avons trouv√© ce que nous recherchions.  Par les valeurs √† l'int√©rieur de <code>reg = &lt;...&gt; ;</code>  Vous pouvez d√©terminer o√π commence la banque de m√©moire et quelle est sa longueur. <br><br>  Dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">la sp√©cification devicetree, nous</a> voyons que la syntaxe <code>reg</code> est un nombre arbitraire de paires <code>(base_address, length)</code> .  Cependant, il y a quatre significations dans <code>reg</code> .  √âtrange, deux valeurs ne suffisent-elles pas pour une banque de m√©moire? <br><br>  Encore une fois, √† partir de la sp√©cification devicetree (recherche de la propri√©t√© <code>reg</code> ), nous constatons que le nombre de cellules <code>&lt;u32&gt;</code> pour sp√©cifier l'adresse et la longueur est d√©termin√© par les propri√©t√©s <code>#address-cells</code> et <code>#size-cells</code> dans le n≈ìud parent (ou dans le n≈ìud lui-m√™me).  Ces valeurs ne sont pas sp√©cifi√©es dans notre n≈ìud de m√©moire, et le n≈ìud de m√©moire parent est simplement la racine du fichier.  Regardons dedans pour ces valeurs: <br><br><pre> <code class="plaintext hljs">head -n8 riscv64-virt.dts /dts-v1/; / { #address-cells = &lt;0x02&gt;; #size-cells = &lt;0x02&gt;; compatible = "riscv-virtio"; model = "riscv-virtio,qemu";</code> </pre> <br>  Il s'av√®re que l'adresse et la longueur n√©cessitent deux valeurs 32 bits.  Cela signifie qu'avec <code>reg = &lt;0x00 0x80000000 0x00 0x8000000&gt;;</code>  notre m√©moire commence <code> 0x00 + 0x80000000 (0x80000000)</code> et occupe <code>0x00 + 0x8000000 (0x8000000)</code> octets, c'est-√†-dire qu'elle se termine √† <code>0x88000000</code> , ce qui correspond √† 128 m√©gaoctets. <br><br><a name="7"></a><h1>  Disposition </h1><br>  En utilisant <code>qemu</code> et <code>dtc</code> nous avons trouv√© les adresses RAM dans la machine virtuelle virt.  Nous savons √©galement que <code>gcc</code> compose <code>crt0</code> par d√©faut, sans configurer la pile comme nous en avons besoin.  Mais comment utiliser ces informations pour √©ventuellement ex√©cuter et d√©boguer le programme? <br><br>  Puisque <code>crt0</code> ne nous convient pas, il y a une option √©vidente: √©crire votre propre code, puis le composer avec le fichier objet que nous avons obtenu apr√®s avoir compil√© notre programme simple.  Notre <code>crt0</code> besoin de savoir o√π commence le haut de la pile pour l'initialiser correctement.  Nous pourrions <code>crt0</code> valeur <code>0x80000000</code> directement sur <code>crt0</code> , mais ce n'est pas une solution tr√®s appropri√©e, compte tenu des changements qui pourraient √™tre n√©cessaires √† l'avenir.  Et si nous voulons utiliser un autre processeur, tel que <code>sifive_e</code> , avec des caract√©ristiques diff√©rentes dans l'√©mulateur? <br><br>  Heureusement, nous ne sommes pas les premiers √† poser cette question, et une bonne solution existe d√©j√†.  L'√©diteur de liens GNU <code>ld</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vous permet de d√©finir le caract√®re</a> disponible √† partir de notre <code>crt0</code> .  Nous pouvons d√©finir le symbole <code>__stack_top</code> appropri√© pour diff√©rents processeurs. <br><br>  Au lieu d'√©crire votre propre fichier de l'√©diteur de liens √† partir de z√©ro, il est logique de prendre le script par d√©faut avec <code>ld</code> et de le modifier un peu pour prendre en charge des caract√®res suppl√©mentaires.  Qu'est-ce qu'un script de l'√©diteur de liens?  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=http://www.scoberlin.de/content/media/">Voici une bonne description</a> : <br><br><blockquote>  <i>Le but principal du script de l'√©diteur de liens est de d√©crire comment les sections de fichier sont mises en correspondance en entr√©e et en sortie, et de contr√¥ler la disposition de la m√©moire du fichier de sortie.</i> </blockquote><br>  Sachant cela, copions le script de l'√©diteur de liens par d√©faut <code>riscv64-unknown-elf-ld</code> dans un nouveau fichier: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/usys/riscv <span class="hljs-comment"><span class="hljs-comment"># Make a new dir for custom linker scripts out RISC-V CPUs may require. mkdir ld &amp;&amp; cd ld # Copy the default linker script into riscv64-virt.ld riscv64-unknown-elf-ld --verbose &gt; riscv64-virt.ld</span></span></code> </pre> <br>  Ce fichier contient de <i>nombreuses</i> informations int√©ressantes, bien plus que ce que nous pouvons discuter dans cet article.  La sortie d√©taill√©e avec l' <code>--Verbose</code> comprend des informations sur la version <code>ld</code> , les architectures prises en charge et bien plus encore.  Tout cela est bon √† savoir, mais une telle syntaxe n'est pas autoris√©e dans le script de l'√©diteur de liens, alors ouvrez un √©diteur de texte et supprimez tout ce qui est superflu du fichier. <br><br><pre>  vim riscv64-virt.ld<font></font>
<font></font>
 # Supprimez tout ce qui pr√©c√®de et y compris la ligne =============
 GNU ld (GNU Binutils) 2,32
   √âmulations prises en charge:
    elf64lriscv
    elf32lriscv
 en utilisant un script de l'√©diteur de liens interne:
 ====================================================
 / * Script pour -z combreloc: combiner et trier les sections de relocalisation * /
 / * Copyright (C) 2014-2019 Free Software Foundation, Inc.
    Copie et distribution de ce script, avec ou sans modification,
    sont autoris√©s sur tout support sans redevance √† condition que le copyright
    avis et cet avis sont conserv√©s.  * /
 OUTPUT_FORMAT ("elf64-littleriscv", "elf64-littleriscv",
	       "elf64-littleriscv")
 ... reste du script de l'√©diteur de liens ... </pre><br>  Apr√®s cela, ex√©cutez la commande <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">MEMORY</a> pour d√©terminer manuellement o√π sera <code>__stack_top</code> .  Recherchez la ligne qui commence par <code>OUTPUT_ARCH(riscv)</code> , elle doit se trouver en haut du fichier et ajoutez la commande <code>MEMORY</code> dessous: <br><br><pre> <code class="plaintext hljs">OUTPUT_ARCH(riscv) /* &gt;&gt;&gt; Our addition. &lt;&lt;&lt; */ MEMORY { /* qemu-system-risc64 virt machine */ RAM (rwx) : ORIGIN = 0x80000000, LENGTH = 128M } /* &gt;&gt;&gt; End of our addition. &lt;&lt;&lt; */ ENTRY(_start)</code> </pre> <br>  Nous avons cr√©√© un bloc de m√©moire appel√© <code>RAM</code> , pour lequel la lecture ( <code>r</code> ), l'√©criture ( <code>w</code> ) et le stockage du code ex√©cutable ( <code>x</code> ) sont autoris√©s. <br><br>  Tr√®s bien, nous avons d√©fini une disposition de m√©moire qui correspond aux sp√©cifications de notre machine <code>virt</code> RISC-V.  Vous pouvez maintenant l'utiliser.  Nous voulons mettre notre pile en m√©moire. <br><br>  Vous devez d√©finir le caract√®re <code>__stack_top</code> .  Ouvrez votre script de l'√©diteur de liens ( <code>riscv64-virt.ld</code> ) dans un √©diteur de texte et ajoutez quelques lignes: <br><br><pre> <code class="plaintext hljs">SECTIONS { /* Read-only sections, merged into text segment: */ PROVIDE (__executable_start = SEGMENT_START("text-segment", 0x10000)); . = SEGMENT_START("text-segment", 0x10000) + SIZEOF_HEADERS; /* &gt;&gt;&gt; Our addition. &lt;&lt;&lt; */ PROVIDE(__stack_top = ORIGIN(RAM) + LENGTH(RAM)); /* &gt;&gt;&gt; End of our addition. &lt;&lt;&lt; */ .interp : { *(.interp) } .note.gnu.build-id : { *(.note.gnu.build-id) }</code> </pre> <br>  Comme vous pouvez le voir, nous d√©finissons <code>__stack_top</code> √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">l'</a> aide de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">la commande</a> <code>__stack_top</code> .  Le symbole sera accessible depuis n'importe quel programme associ√© √† ce script (en supposant que le programme lui-m√™me ne d√©terminera pas quelque chose avec le nom <code>__stack_top</code> ).  D√©finissez <code>__stack_top</code> sur <code>ORIGIN(RAM)</code> .  Nous savons que cette valeur est <code>0x80000000</code> plus <code>LENGTH(RAM)</code> , qui est de 128 m√©gaoctets ( <code>0x8000000</code> octets).  Cela signifie que notre <code>__stack_top</code> d√©fini sur <code>0x88000000</code> . <br><br>  Par souci de concision, je ne r√©pertorierai pas l'int√©gralit√© du fichier de l'√©diteur de liens <a href="">ici</a> ; vous pouvez le voir <a href="">ici</a> . <br><br><a name="8"></a><h1>  Arr√™te √ßa!  <s>Hammertime!</s>  Runtime! </h1><br>  Nous avons maintenant tout ce dont nous avons besoin pour cr√©er notre propre runtime C. En fait, c'est une t√¢che assez simple, voici tout le fichier <code>crt0.s</code> : <br><br><pre> <code class="plaintext hljs">.section .init, "ax" .global _start _start: .cfi_startproc .cfi_undefined ra .option push .option norelax la gp, __global_pointer$ .option pop la sp, __stack_top add s0, sp, zero jal zero, main .cfi_endproc .end</code> </pre> <br>  Attire imm√©diatement un grand nombre de lignes commen√ßant par une p√©riode.  Il s'agit d'un fichier pour assembleur en <code>as</code> .  Les lignes avec des points sont appel√©es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">directives assembleur</a> : elles fournissent des informations √† l'assembleur.  Ce n'est pas du code ex√©cutable, comme les instructions de l'assembleur RISC-V comme <code>jal</code> et <code>add</code> . <br><br>  Passons en revue le fichier ligne par ligne.  Nous travaillerons avec divers registres RISC-V standard, alors consultez <a href="">ce tableau</a> , qui couvre tous les registres et leur fonction. <br><br><pre> <code class="plaintext hljs">.section .init, "ax"</code> </pre> <br>  Comme indiqu√© dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">l'assembleur GNU ¬´as¬ª</a> , cette ligne indique √† l'assembleur d'ins√©rer le code suivant dans la section <code>.init</code> , qui est allou√©e ( <code>a</code> ) et ex√©cutable ( <code>x</code> ).  Cette section est une autre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">convention courante</a> pour l'ex√©cution de code dans le syst√®me d'exploitation.  Nous travaillons sur du mat√©riel pur sans OS, donc dans notre cas une telle instruction peut ne pas √™tre absolument n√©cessaire, mais en tout cas c'est une bonne pratique. <br><br><pre> <code class="plaintext hljs">.global _start _start:</code> </pre> <br>  <code>.global</code> met le caract√®re suivant √† la disposition de <code>ld</code> .  Sans cela, le lien ne fonctionnera pas, car la commande <code>ENTRY(_start)</code> dans le script de l'√©diteur de liens pointe vers le symbole <code>_start</code> comme point d'entr√©e vers le fichier ex√©cutable.  La ligne suivante indique √† l'assembleur que nous commen√ßons la d√©finition du caract√®re <code>_start</code> . <br><br><pre> <code class="plaintext hljs">_start: .cfi_startproc .cfi_undefined ra ...other stuff... .cfi_endproc</code> </pre> <br>  Ces directives <code>.cfi</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vous informent</a> sur la structure du cadre et comment le g√©rer.  Les <code>.cfi_endproc</code> <code>.cfi_startproc</code> et <code>.cfi_endproc</code> signalent le d√©but et la fin d'une fonction, et <code>.cfi_undefined ra</code> indique √† l'assembleur que le registre <code>ra</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ne doit pas √™tre restaur√©</a> √† la valeur qu'il contient avant le <code>_start</code> . <br><br><pre> <code class="plaintext hljs">.option push .option norelax la gp, __global_pointer$ .option pop</code> </pre> <br>  Ces directives <code>.option</code> modifient le comportement de l'assembleur en fonction du code lorsque vous devez appliquer un ensemble d'options sp√©cifique.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Voici une</a> description d√©taill√©e des raisons pour lesquelles l'utilisation de <code>.option</code> dans ce segment est importante: <br><br><blockquote>  <i>... puisque nous assouplissons √©ventuellement l'adressage des s√©quences √† des s√©quences plus courtes par rapport au GP, le chargement initial du GP ne devrait pas √™tre affaibli et devrait ressembler √† ceci:</i> <i><br><br></i> <pre> <code class="plaintext hljs">.option push .option norelax la gp, __global_pointer$ .option pop</code> </pre> <br>  de sorte qu'apr√®s la relaxation, vous obtenez le code suivant: <br><br><pre> <code class="plaintext hljs">auipc gp, %pcrel_hi(__global_pointer$) addi gp, gp, %pcrel_lo(__global_pointer$)</code> </pre> <br>  au lieu de simple: <br><br><pre> <code class="plaintext hljs">addi gp, gp, 0</code> </pre> </blockquote><br>  Et maintenant la derni√®re partie de nos <code>crt0.s</code> : <br><br><pre> <code class="plaintext hljs">_start: ...other stuff... la sp, __stack_top add s0, sp, zero jal zero, main .cfi_endproc .end</code> </pre> <br>  Ici, nous pouvons enfin utiliser le symbole <code>__stack_top</code> , que nous avons travaill√© si dur pour cr√©er.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">La pseudo-instruction</a> <code>la</code> (adresse de chargement) charge la valeur <code>__stack_top</code> dans le registre <code>sp</code> (pointeur de pile), la d√©finissant pour une utilisation dans le reste du programme. <br><br>  Ensuite, <code>add s0, sp, zero</code> ajoute les valeurs des registres <code>sp</code> et <code>zero</code> (qui est en fait le registre <code>x0</code> avec une r√©f√©rence mat√©rielle √† 0) et place le r√©sultat dans le registre <code>s0</code> .  Il s'agit d'un <a href="">registre sp√©cial</a> qui est inhabituel √† plusieurs √©gards.  Tout d'abord, il s'agit d'un ¬´registre persistant¬ª, c'est-√†-dire qu'il est enregistr√© lors de l'appel de la fonction.  Deuxi√®mement, <code>s0</code> agit parfois comme un pointeur de trame, ce qui donne √† chaque appel de fonction un petit espace dans la pile pour stocker les param√®tres pass√©s √† cette fonction.  Le fonctionnement des appels de fonction avec la pile et les pointeurs de trame est un sujet tr√®s int√©ressant que vous pouvez facilement consacrer √† un article s√©par√©, mais pour l'instant, sachez que dans notre runtime, il est important d'initialiser le pointeur de trame <code>s0</code> . <br><br>  Ensuite, nous voyons le <code>jal zero, main</code> d√©claration <code>jal zero, main</code> .  Ici, <code>jal</code> signifie sauter et lier.  L'instruction attend des op√©randes sous la forme de <code>jal rd (destination register), offset_address</code> .  Fonctionnellement, <code>jal</code> √©crit la valeur de l'instruction suivante (registre <code>pc</code> plus quatre) dans <code>rd</code> , puis d√©finit le registre <code>pc</code> sur la valeur <code>pc</code> actuelle plus l'adresse de d√©calage avec l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">extension de signe</a> , ¬´appelant¬ª effectivement cette adresse. <br><br>  Comme mentionn√© ci-dessus, <code>x0</code> √©troitement li√© √† la valeur litt√©rale 0, et y √©crire est inutile.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Par cons√©quent, il peut sembler √©trange que nous utilisions un registre comme registre de destination </font></font><code>zero</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que les assembleurs RISC-V interpr√®tent comme un registre </font></font><code>x0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Apr√®s tout, cela signifie une transition inconditionnelle vers </font></font><code>offset_address</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Pourquoi faire cela, parce que dans d'autres architectures, il existe une instruction explicite pour une transition inconditionnelle? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ce mod√®le √©trange </font></font><code>jal zero, offset_address</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est en fait une optimisation intelligente. La prise en charge de chaque nouvelle instruction signifie une augmentation et, par cons√©quent, une augmentation du co√ªt du processeur. Par cons√©quent, plus l'ISA est simple, mieux c'est. Au lieu de polluer l'espace d'instructions avec deux instructions </font></font><code>jal</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>unconditional jump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, l'architecture RISC-V ne prend en charge que les </font></font><code>jal</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sauts inconditionnels </font></font><code>jal zero, main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RISC-V poss√®de de nombreuses optimisations de ce type, dont la plupart prennent la forme de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pseudo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">instructions</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Les assembleurs savent comment les traduire en instructions mat√©rielles r√©elles. </font><font style="vertical-align: inherit;">Par exemple, </font></font><code>j offset_address</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les assembleurs RISC-V traduisent les </font><font style="vertical-align: inherit;">pseudo- </font><font style="vertical-align: inherit;">instructions pour les sauts </font><font style="vertical-align: inherit;">inconditionnels </font><font style="vertical-align: inherit;">en </font></font><code>jal zero, offset_address</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Pour une liste compl√®te des pseudo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">instructions</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> officiellement prises en </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">charge,</font></a><font style="vertical-align: inherit;"> voir </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">la sp√©cification RISC-V (version 2.2)</font></a><font style="vertical-align: inherit;"> .</font></font><br><br><pre> <code class="plaintext hljs">_start: ...other stuff... jal zero, main .cfi_endproc .end</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notre derni√®re ligne est la directive assembleur </font></font><code>.end</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, qui marque simplement la fin du fichier.</font></font><br><br><a name="9"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> D√©boguer mais maintenant pour de vrai </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En essayant de d√©boguer un simple programme C sur un processeur RISC-V, nous avons r√©solu beaucoup de probl√®mes. </font><font style="vertical-align: inherit;">Tout d'abord, utiliser </font></font><code>qemu</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>dtc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trouver notre m√©moire dans la machine virtuelle </font></font><code>virt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RISC-V. </font><font style="vertical-align: inherit;">Ensuite, nous avons utilis√© ces informations pour contr√¥ler manuellement l'allocation de m√©moire dans notre version du script par d√©faut de l'√©diteur de liens </font></font><code>riscv64-unknown-elf-ld</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ce qui nous a permis de d√©terminer avec pr√©cision le symbole </font></font><code>__stack_top</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ensuite, nous avons utilis√© ce symbole dans notre propre version </font></font><code>crt0.s</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, qui configure notre pile et nos pointeurs globaux, et a finalement appel√© la fonction </font></font><code>main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Vous pouvez maintenant atteindre votre objectif et commencer √† d√©boguer notre programme simple dans GDB. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rappelons ici le programme C lui-m√™me:</font></font><br><br><pre> <code class="cpp hljs">cat add.<span class="hljs-function"><span class="hljs-function">c </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> b = <span class="hljs-number"><span class="hljs-number">12</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c = a + b; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Compilation et liaison: </font></font><br><br><pre> <code class="bash hljs">riscv64-unknown-elf-gcc -g -ffreestanding -O0 -Wl,--gc-sections -nostartfiles -nostdlib -nodefaultlibs -Wl,-T,riscv64-virt.ld crt0.s add.c</code> </pre> <br>      ,    ,     ,    . <br><br> <code>-ffreestanding</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> ,      </a> ,         .           (  ),       ,      . <br><br> <code>-Wl</code> ‚Äî        ( <code>ld</code> ).  <code>--gc-sections</code>  ¬´  ¬ª,  <code>ld</code>       .  <code>-nostartfiles</code> , <code>-nostdlib</code>  <code>-nodefaultlibs</code>         (,  <code>crt0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), les impl√©mentations standard du syst√®me stdlib et les biblioth√®ques li√©es par d√©faut du syst√®me standard. </font><font style="vertical-align: inherit;">Nous avons notre propre script </font></font><code>crt0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et √©diteur de liens, il est donc important de passer ces drapeaux afin que les valeurs par d√©faut n'entrent pas en conflit avec nos pr√©f√©rences utilisateur. </font></font><br><br> <code>-T</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">indique le chemin vers notre script de l'√©diteur de liens, qui est simple dans notre cas </font></font><code>riscv64-virt.ld</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Enfin, nous sp√©cifions les fichiers que nous voulons compiler, compiler et composer: </font></font><code>crt0.s</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>add.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Comme pr√©c√©demment, le r√©sultat est un fichier complet et pr√™t √† fonctionner appel√© </font></font><code>a.out</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maintenant, ex√©cutez notre tout nouvel ex√©cutable flambant neuf dans </font></font><code>qemu</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># -S freezes execution of our executable (-kernel) until we explicitly tell # it to start with a 'continue' or 'c' from our gdb client qemu-system-riscv64 -machine virt -m 128M -gdb tcp::1234 -S -kernel a.out</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maintenant, ex√©cutez </font></font><code>gdb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, n'oubliez pas de charger les symboles de d√©bogage pour </font></font><code>a.out</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, en le sp√©cifiant avec le dernier argument:</font></font><br><br><pre> <code class="bash hljs">riscv64-unknown-elf-gdb --tui a.out GNU gdb (GDB) 8.2.90.20190228-git Copyright (C) 2019 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt; This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Type <span class="hljs-string"><span class="hljs-string">"show copying"</span></span> and <span class="hljs-string"><span class="hljs-string">"show warranty"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> details. This GDB was configured as <span class="hljs-string"><span class="hljs-string">"--host=x86_64-apple-darwin17.7.0 --target=riscv64-unknown-elf"</span></span>. Type <span class="hljs-string"><span class="hljs-string">"show configuration"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> configuration details. For bug reporting instructions, please see: &lt;http://www.gnu.org/software/gdb/bugs/&gt;. Find the GDB manual and other documentation resources online at: &lt;http://www.gnu.org/software/gdb/documentation/&gt;. For <span class="hljs-built_in"><span class="hljs-built_in">help</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> <span class="hljs-string"><span class="hljs-string">"help"</span></span>. Type <span class="hljs-string"><span class="hljs-string">"apropos word"</span></span> to search <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> commands related to <span class="hljs-string"><span class="hljs-string">"word"</span></span>... Reading symbols from a.out... (gdb)</code> </pre> <br>     <code>gdb</code>   <code>gdb</code> ,       <code>qemu</code> : <br><br><pre> <code class="bash hljs">(gdb) target remote :1234 ‚îÇ Remote debugging using :1234</code> </pre> <br>     main: <br><br><pre> <code class="bash hljs">(gdb) b main Breakpoint 1 at 0x8000001e: file add.c, line 2.</code> </pre> <br>    : <br><br><pre> <code class="bash hljs">(gdb) c Continuing. Breakpoint 1, main () at add.c:2</code> </pre> <br>    ,          2!      , -     <code>L</code> ,  <code>PC:</code>  <code>L2</code> ,  <code>PC:</code> ‚Äî <code>0x8000001e</code> .       ,     : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bd8/aa9/78d/bd8aa978df4289f584b5c422cdb6e44c.png"><br><br>      <code>gdb</code>  : <code>-s</code>     , <code>info all-registers</code>           . .    ‚Ä¶ , ,    ! <br><br><a name="10"></a><h1>  Et ensuite? </h1><br>     , ,  !            ,    ,       .   ,   .        <code>jal</code> ,          ,  ,   <code>add.c</code> -     RISC-V.     - ,       - , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> . <br><br>   ! ,    ! <br><br><a name="11"></a><h1>  En option </h1><br>         ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´  :     main()¬ª</a>   CppCon2018.      ,   .   ,  ! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr454208/">https://habr.com/ru/post/fr454208/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr454190/index.html">Ce que vous n'avez pas besoin de faire en cas de vol de votre t√©l√©phone</a></li>
<li><a href="../fr454196/index.html">Impression 3D d'√©lectronique √† l'aide d'un exemple de drone: les fils et les cartes ne sont plus n√©cessaires</a></li>
<li><a href="../fr454198/index.html">Cr√©ation d'un projet Gradle SpringBoot + Angular multi-module dans IDEA</a></li>
<li><a href="../fr454204/index.html">L'exploration comportementale n'est pas une panac√©e?</a></li>
<li><a href="../fr454206/index.html">PHDays 9: Analyse AI CTF</a></li>
<li><a href="../fr454210/index.html">Enchantjs oubli√©s + nouveau 1C-Bitrix = Jeu pour la motivation du client</a></li>
<li><a href="../fr454214/index.html">Je d√©teste presque tous les logiciels</a></li>
<li><a href="../fr454216/index.html">Preuve trouv√©e que tous les changements sont un m√©lange d'ordre et de chance</a></li>
<li><a href="../fr454220/index.html">Thermom√®tre √† deux chiffres</a></li>
<li><a href="../fr454222/index.html">Mettez √† niveau le sous-syst√®me de disque de l'ancien serveur avec le bus PCIe 1.0 - 2.0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>