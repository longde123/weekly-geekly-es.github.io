<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>â€¼ï¸ ğŸ‘©ğŸ¾â€ğŸ”¬ ğŸ§œğŸ¿ åœ¨å®ä½“æ¡†æ¶ä¸­åŠ å…¥æœ¬åœ°é›†åˆå’ŒDbSet âš•ï¸ ğŸ‘¨ğŸ¼â€ğŸš’ ğŸ˜£</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="åœ¨æˆ‘å‚ä¸çš„ä¸€å¹´å¤šä¸€ç‚¹çš„æ—¶é—´é‡Œï¼Œå‘ç”Ÿäº†ä»¥ä¸‹â€œå¯¹è¯â€ï¼š 


 .Net App ï¼šå—¨ï¼Œå®ä½“æ¡†æ¶ï¼Œç»™æˆ‘å¾ˆå¤šæ•°æ®ï¼ 
 å®ä½“æ¡†æ¶ ï¼šå¯¹ä¸èµ·ï¼Œæˆ‘ä¸äº†è§£æ‚¨ã€‚ ä»€ä¹ˆæ„æ€ 
 .Net App ï¼šæ˜¯çš„ï¼Œæˆ‘åˆšåˆšæ”¶é›†äº†10ä¸‡ç¬”äº¤æ˜“ã€‚ ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦å¿«é€Ÿæ£€æŸ¥é‚£é‡Œæ˜¾ç¤ºçš„è¯åˆ¸ä»·æ ¼çš„æ­£ç¡®æ€§ã€‚ 
 å®ä½“æ¡†æ¶ ï¼šå—¯ï¼Œè®©æˆ‘ä»¬å°è¯•ä¸€...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>åœ¨å®ä½“æ¡†æ¶ä¸­åŠ å…¥æœ¬åœ°é›†åˆå’ŒDbSet</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435810/"><p> åœ¨æˆ‘å‚ä¸çš„ä¸€å¹´å¤šä¸€ç‚¹çš„æ—¶é—´é‡Œï¼Œå‘ç”Ÿäº†ä»¥ä¸‹â€œå¯¹è¯â€ï¼š </p><br><p>  <strong>.Net App</strong> ï¼šå—¨ï¼Œå®ä½“æ¡†æ¶ï¼Œç»™æˆ‘å¾ˆå¤šæ•°æ®ï¼ <br>  <strong>å®ä½“æ¡†æ¶</strong> ï¼šå¯¹ä¸èµ·ï¼Œæˆ‘ä¸äº†è§£æ‚¨ã€‚ ä»€ä¹ˆæ„æ€ <br>  <strong>.Net App</strong> ï¼šæ˜¯çš„ï¼Œæˆ‘åˆšåˆšæ”¶é›†äº†10ä¸‡ç¬”äº¤æ˜“ã€‚ ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦å¿«é€Ÿæ£€æŸ¥é‚£é‡Œæ˜¾ç¤ºçš„è¯åˆ¸ä»·æ ¼çš„æ­£ç¡®æ€§ã€‚ <br>  <strong>å®ä½“æ¡†æ¶</strong> ï¼šå—¯ï¼Œè®©æˆ‘ä»¬å°è¯•ä¸€ä¸‹... <br>  <strong>.Net App</strong> ï¼šè¿™æ˜¯ä»£ç ï¼š </p><br><pre><code class="cpp hljs">var query = from p in context.Prices join t in transactions on <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { p.Ticker, p.TradedOn, p.PriceSourceId } equals <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { t.Ticker, t.TradedOn, t.PriceSourceId } select p; query.ToList();</code> </pre> <br><p>  <strong>å®ä½“æ¡†æ¶</strong> ï¼š </p><br><p><img src="https://habrastorage.org/webt/kc/jh/lp/kcjhlpnggo_fhkdgik481svjuea.png"></p><br><p> ç»å…¸ç‰ˆ æˆ‘è®¤ä¸ºè®¸å¤šäººéƒ½ç†Ÿæ‚‰è¿™ç§æƒ…å†µï¼šå½“æˆ‘çœŸçš„æƒ³â€œç¾ä¸½â€å¹¶ä½¿ç”¨æœ¬åœ°é›†åˆçš„<em>JOIN</em>å’Œ<em>DbSet</em>å¿«é€Ÿåœ¨æ•°æ®åº“ä¸­è¿›è¡Œæœç´¢æ—¶ã€‚ é€šå¸¸ï¼Œè¿™ç§ä½“éªŒä»¤äººå¤±æœ›ã€‚ </p><br><p> åœ¨æœ¬æ–‡ï¼ˆè¿™æ˜¯<em>æˆ‘å…¶ä»–æ–‡ç« </em>çš„<em>å…è´¹ç¿»è¯‘</em> ï¼‰ä¸­ï¼Œæˆ‘å°†è¿›è¡Œä¸€ç³»åˆ—å®éªŒï¼Œå¹¶å°è¯•å„ç§æ–¹æ³•æ¥è§£å†³è¿™ä¸€é™åˆ¶ã€‚ ä¼šæœ‰ä¸€ä¸ªä»£ç ï¼ˆä¸å¤æ‚ï¼‰ï¼Œæ€æƒ³å’Œè¯¸å¦‚å¹¸ç¦çš„ç»“å±€ä¹‹ç±»çš„ä¸œè¥¿ã€‚ </p><a name="habracut"></a><br><h2 id="vvedenie"> å¼•è¨€ </h2><br><p> æ¯ä¸ªäººéƒ½çŸ¥é“<em>Entity Framework</em> ï¼Œæ¯å¤©éƒ½æœ‰å¾ˆå¤šäººä½¿ç”¨å®ƒï¼Œå¹¶ä¸”æœ‰å¾ˆå¤šå¾ˆå¥½çš„æ–‡ç« ä»‹ç»äº†å¦‚ä½•æ­£ç¡®åœ°åˆ¶ä½œå®ƒï¼ˆä½¿ç”¨æ›´ç®€å•çš„æŸ¥è¯¢ï¼Œä½¿ç”¨Skip and Takeä¸­çš„å‚æ•°ï¼Œä½¿ç”¨VIEWï¼Œä»…è¯·æ±‚å¿…è¦çš„å­—æ®µï¼Œç›‘è§†æŸ¥è¯¢ç¼“å­˜å’Œå…¶ä»–ï¼‰ï¼Œä½†æ˜¯æœ¬åœ°é›†åˆå’Œ<em>DbSet</em>çš„<em>JOIN</em>ä¸»é¢˜ä»ç„¶æ˜¯è–„å¼±ç‚¹ã€‚ </p><br><h2 id="zadacha"> æŒ‘æˆ˜èµ› </h2><br><p> å‡è®¾æœ‰ä¸€ä¸ªåŒ…å«ä»·æ ¼çš„æ•°æ®åº“ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªéœ€è¦æ£€æŸ¥ä»·æ ¼æ­£ç¡®æ€§çš„äº¤æ˜“é›†åˆã€‚ å¹¶å‡è®¾æˆ‘ä»¬æœ‰ä»¥ä¸‹ä»£ç ã€‚ </p><br><pre> <code class="cpp hljs">var localData = GetDataFromApiOrUser(); var query = from p in context.Prices join s in context.Securities on p.SecurityId equals s.SecurityId join t in localData on <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { s.Ticker, p.TradedOn, p.PriceSourceId } equals <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { t.Ticker, t.TradedOn, t.PriceSourceId } select p; var result = query.ToList();</code> </pre> <br><p> æ­¤ä»£ç æ ¹æœ¬ä¸åœ¨<em>Entity Framework 6</em>ä¸­å·¥ä½œã€‚ åœ¨<em>Entity Framework Coreä¸­</em> -å®ƒå¯ä»¥å·¥ä½œï¼Œä½†æ˜¯ä¸€åˆ‡éƒ½å°†åœ¨å®¢æˆ·ç«¯å®Œæˆï¼Œå¹¶ä¸”åœ¨æ•°æ®åº“ä¸­æœ‰æ•°ç™¾ä¸‡æ¡è®°å½•çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªé€‰æ‹©ã€‚ </p><br><p> æ­£å¦‚æˆ‘æ‰€è¯´ï¼Œæˆ‘å°†å°è¯•ä¸åŒçš„æ–¹æ³•æ¥è§£å†³æ­¤é—®é¢˜ã€‚ ä»ç®€å•åˆ°å¤æ‚ã€‚ åœ¨å®éªŒä¸­ï¼Œæˆ‘ä½¿ç”¨ä»¥ä¸‹<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å­˜å‚¨åº“ä¸­</a>çš„ä»£ç ã€‚ ä½¿ç”¨ä»¥ä¸‹ä»£ç ç¼–å†™ä»£ç ï¼š <em>Cï¼ƒ</em> <em>ï¼Œ.Net Core</em> ï¼Œ <em>EF Core</em>å’Œ<em>PostgreSQL</em> ã€‚ </p><br><p> æˆ‘è¿˜æ‹æ‘„äº†ä¸€äº›æŒ‡æ ‡ï¼šèŠ±è´¹çš„æ—¶é—´å’Œå†…å­˜æ¶ˆè€—ã€‚ å…è´£å£°æ˜ï¼šå¦‚æœæµ‹è¯•è¿›è¡Œäº†10åˆ†é’Ÿä»¥ä¸Šï¼Œæˆ‘ä¼šæ‰“æ–­å®ƒï¼ˆé™åˆ¶æ¥è‡ªä¸Šé¢ï¼‰ã€‚ æµ‹è¯•æœºå™¨Intel Core i5ã€8 GB RAMï¼ŒSSDã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">æ•°æ®åº“æ¶æ„</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/habr/post_images/1d5/f8c/cec/1d5f8ccec6ef1b7361195c18ac139d09.png" alt="å›¾ç‰‡"></p><br><p> ä»…3ä¸ªè¡¨æ ¼ï¼š <em>ä»·æ ¼</em> ï¼Œ <em>è¯åˆ¸</em>å’Œ<em>ä»·æ ¼æ¥æº</em> ã€‚  <em>ä»·æ ¼</em> -åŒ…å«1000ä¸‡ä¸ªæ¡ç›®ã€‚ </p></div></div><br><h4 id="sposob-1-naive"> æ–¹æ³•1ã€‚å¤©çœŸ </h4><br><p> è®©æˆ‘ä»¬å¼€å§‹ç®€å•å¹¶ä½¿ç”¨ä»¥ä¸‹ä»£ç ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">æ–¹æ³•1çš„ä»£ç </b> <div class="spoiler_text"><pre> <code class="cpp hljs">var result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Price&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var context = CreateContext()) { foreach (var testElement in TestData) { result.AddRange(context.Prices.Where( x =&gt; x.Security.Ticker == testElement.Ticker &amp;&amp; x.TradedOn == testElement.TradedOn &amp;&amp; x.PriceSourceId == testElement.PriceSourceId)); } }</code> </pre> </div></div><br><p> è¿™ä¸ªæƒ³æ³•å¾ˆç®€å•ï¼šåœ¨ä¸€ä¸ªå¾ªç¯ä¸­ï¼Œæˆ‘ä»¬ä¸€æ¬¡ä»æ•°æ®åº“è¯»å–ä¸€æ¡è®°å½•ï¼Œç„¶åå°†å…¶æ·»åŠ åˆ°ç»“æœé›†åˆä¸­ã€‚ è¿™æ®µä»£ç åªæœ‰ä¸€ä¸ªä¼˜ç‚¹-ç®€å•ã€‚ ç¼ºç‚¹ä¹‹ä¸€æ˜¯é€Ÿåº¦æ…¢ï¼šå³ä½¿æ•°æ®åº“ä¸­æœ‰ç´¢å¼•ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹å®ƒä¹Ÿä¼šä¸æ•°æ®åº“æœåŠ¡å™¨é€šä¿¡ã€‚ æŒ‡æ ‡å¦‚ä¸‹ï¼š </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/985/61c/b6a/98561cb6a2566faff490fc2bf7432fb9.png" alt="å›¾ç‰‡"></p><br><p> å†…å­˜æ¶ˆè€—å¾ˆå°ã€‚ å¤§é‡æ”¶è—éœ€è¦1åˆ†é’Ÿã€‚ é¦–å…ˆï¼Œè¿˜ä¸é”™ï¼Œä½†æˆ‘å¸Œæœ›æ›´å¿«ã€‚ </p><br><h4 id="sposob-2-naive-parallel"> æ–¹æ³•2ï¼šå¤©çœŸå¹¶è¡Œ </h4><br><p> è®©æˆ‘ä»¬å°è¯•æ·»åŠ å¹¶è¡Œæ€§ã€‚ è¿™ä¸ªæƒ³æ³•æ˜¯ä»å¤šä¸ªçº¿ç¨‹è®¿é—®æ•°æ®åº“ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">æ–¹æ³•2çš„ä»£ç </b> <div class="spoiler_text"><pre> <code class="cpp hljs">var result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentBag&lt;Price&gt;(); var partitioner = Partitioner.Create(<span class="hljs-number"><span class="hljs-number">0</span></span>, TestData.Count); Parallel.ForEach(partitioner, range =&gt; { var subList = TestData.Skip(range.Item1) .Take(range.Item2 - range.Item1) .ToList(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var context = CreateContext()) { foreach (var testElement in subList) { var query = context.Prices.Where( x =&gt; x.Security.Ticker == testElement.Ticker &amp;&amp; x.TradedOn == testElement.TradedOn &amp;&amp; x.PriceSourceId == testElement.PriceSourceId); foreach (var el in query) { result.Add(el); } } } });</code> </pre> </div></div><br><p> ç»“æœï¼š </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/916/d22/428/916d224282a3020dc31df6c67a18b070.png" alt="å›¾ç‰‡"></p><br><p> å¯¹äºå°å‹é¦†è—ï¼Œæ­¤æ–¹æ³•ç”šè‡³æ¯”ç¬¬ä¸€ç§æ–¹æ³•æ…¢ã€‚ è€Œæœ€å¤§çš„-å¿«2å€ã€‚ æœ‰è¶£çš„æ˜¯ï¼Œæˆ‘çš„æœºå™¨ä¸Šç”Ÿæˆäº†4ä¸ªçº¿ç¨‹ï¼Œä½†è¿™å¹¶æ²¡æœ‰å¯¼è‡´4å€çš„åŠ é€Ÿã€‚ è¿™è¡¨æ˜æ­¤æ–¹æ³•çš„å¼€é”€å¾ˆå¤§ï¼šæ— è®ºæ˜¯åœ¨å®¢æˆ·ç«¯è¿˜æ˜¯åœ¨æœåŠ¡å™¨ç«¯ã€‚ å†…å­˜æ¶ˆè€—å¢åŠ äº†ï¼Œä½†æ²¡æœ‰æ˜æ˜¾å¢åŠ ã€‚ </p><br><h4 id="sposob-3-multiple-contains"> æ–¹æ³•3ï¼šå¤šä¸ªåŒ…å« </h4><br><p> æ˜¯æ—¶å€™å°è¯•å…¶ä»–å°è¯•å¹¶å°†ä»»åŠ¡ç®€åŒ–ä¸ºä¸€ä¸ªæŸ¥è¯¢äº†ã€‚ å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤å®Œæˆï¼š </p><br><ol><li> å‡†å¤‡3ä¸ªå”¯ä¸€çš„<em>Ticker</em> ï¼Œ <em>PriceSourceId</em>å’Œ<em>Date</em>é›†åˆ </li><li> è¿è¡Œè¯·æ±‚å¹¶ä½¿ç”¨3ä¸ª<em>åŒ…å«</em> </li><li> åœ¨æœ¬åœ°é‡æ–°æ£€æŸ¥ç»“æœ </li></ol><br><div class="spoiler">  <b class="spoiler_title">æ–¹æ³•3çš„ä»£ç </b> <div class="spoiler_text"><pre> <code class="cpp hljs">var result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Price&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var context = CreateContext()) { <span class="hljs-comment"><span class="hljs-comment">//   var tickers = TestData.Select(x =&gt; x.Ticker).Distinct().ToList(); var dates = TestData.Select(x =&gt; x.TradedOn).Distinct().ToList(); var ps = TestData.Select(x =&gt; x.PriceSourceId).Distinct().ToList(); //    3 Contains var data = context.Prices .Where(x =&gt; tickers.Contains(x.Security.Ticker) &amp;&amp; dates.Contains(x.TradedOn) &amp;&amp; ps.Contains(x.PriceSourceId)) .Select(x =&gt; new { Price = x, Ticker = x.Security.Ticker, }) .ToList(); var lookup = data.ToLookup(x =&gt; $"{x.Ticker}, {x.Price.TradedOn}, {x.Price.PriceSourceId}"); //  foreach (var el in TestData) { var key = $"{el.Ticker}, {el.TradedOn}, {el.PriceSourceId}"; result.AddRange(lookup[key].Select(x =&gt; x.Price)); } }</span></span></code> </pre> </div></div><br><p> è¿™é‡Œçš„é—®é¢˜æ˜¯æ‰§è¡Œæ—¶é—´å’Œè¿”å›çš„æ•°æ®é‡é«˜åº¦ä¾èµ–äºæ•°æ®æœ¬èº«ï¼ˆåœ¨æŸ¥è¯¢å’Œæ•°æ®åº“ä¸­ï¼‰ã€‚ å³ï¼Œä»…è¿”å›å¿…è¦æ•°æ®çš„é›†åˆï¼Œå¹¶ä¸”å¯ä»¥è¿”å›é¢å¤–çš„è®°å½•ï¼ˆç”šè‡³å¤š100å€ï¼‰ã€‚ </p><br><p> å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ç¤ºä¾‹è¿›è¡Œè¯´æ˜ã€‚ å‡è®¾æœ‰åŒ…å«æ•°æ®çš„ä¸‹è¡¨ï¼š </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f3f/2bb/ea5/f3f2bbea5148127963cab9010d2b2f10.png" alt="å›¾ç‰‡"></p><br><p> è¿˜å‡è®¾æˆ‘éœ€è¦<em>TradedOn</em> = <em>2018-01-01çš„Ticker1</em>å’Œ<em>TradedOn</em> = <em>2018-01-02</em>çš„<em>Ticker2çš„</em>ä»·æ ¼ã€‚ </p><br><p> ç„¶å<em>ä»£ç çš„</em>å”¯ä¸€å€¼=ï¼ˆ <em>Ticker1</em> ï¼Œ <em>Ticker2</em> ï¼‰ <br> è€Œä¸”<em>TradedOnçš„</em>å”¯ä¸€å€¼=ï¼ˆ <em>2018-01-01ï¼Œ2018-01-02</em> ï¼‰ </p><br><p> ä½†æ˜¯ï¼Œç»“æœå°†è¿”å›4æ¡è®°å½•ï¼Œå› ä¸ºå®ƒä»¬ç¡®å®å¯¹åº”äºè¿™äº›ç»„åˆã€‚ ä¸å¥½çš„æ˜¯ï¼Œä½¿ç”¨çš„å­—æ®µè¶Šå¤šï¼Œç»“æœè·å¾—æ›´å¤šè®°å½•çš„æœºä¼šå°±è¶Šå¤§ã€‚ </p><br><p> å› æ­¤ï¼Œå¿…é¡»åœ¨å®¢æˆ·ç«¯å¦å¤–è¿‡æ»¤é€šè¿‡æ­¤æ–¹æ³•è·å¾—çš„æ•°æ®ã€‚ è¿™æ˜¯æœ€å¤§çš„ç¼ºç‚¹ã€‚ <br> æŒ‡æ ‡å¦‚ä¸‹ï¼š </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/dd5/078/5ef/dd50785efd38900c4d18467607b87a1e.png" alt="å›¾ç‰‡"></p><br><p> å†…å­˜æ¶ˆè€—æ¯”ä»¥å‰çš„æ‰€æœ‰æ–¹æ³•éƒ½è¦ç³Ÿç³•ã€‚ è¯»å–çš„è¡Œæ•°æ¯”è¯·æ±‚çš„è¡Œæ•°å¤§å¾ˆå¤šå€ã€‚ å¤§å‹é›†åˆçš„æµ‹è¯•è¿è¡Œäº†10åˆ†é’Ÿä»¥ä¸Šï¼Œå› æ­¤è¢«ä¸­æ–­ã€‚ è¿™ç§æ–¹æ³•ä¸å¥½ã€‚ </p><br><h4 id="sposob-4-predicate-builder"> æ–¹æ³•4.è°“è¯ç”Ÿæˆå™¨ </h4><br><p> è®©æˆ‘ä»¬åœ¨å¦ä¸€ä¾§å°è¯•ä¸€ä¸‹ï¼šå¥½çš„è€å¼<em>Expression</em> ã€‚ ä½¿ç”¨å®ƒä»¬ï¼Œæ‚¨å¯ä»¥æŒ‰ç…§ä»¥ä¸‹å½¢å¼æ„å»º1ä¸ªå¤§å‹æŸ¥è¯¢ï¼š </p><br><p> <code>â€¦ (.. AND .. AND ..) OR (.. AND .. AND ..) OR (.. AND .. AND ..) â€¦</code> </p> <br><p> è¿™ç»™å¸Œæœ›å»ºç«‹1ä¸ªè¯·æ±‚å¹¶ä»…è·å¾—1ä¸ªå‘¼å«çš„å¿…è¦æ•°æ®çš„å¸Œæœ›ã€‚ ä»£ç ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">æ–¹æ³•4çš„ä»£ç </b> <div class="spoiler_text"><pre> <code class="cpp hljs">var result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Price&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var context = CreateContext()) { var baseQuery = from p in context.Prices join s in context.Securities on p.SecurityId equals s.SecurityId select <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestData() { Ticker = s.Ticker, TradedOn = p.TradedOn, PriceSourceId = p.PriceSourceId, PriceObject = p }; var tradedOnProperty = typeof(TestData).GetProperty(<span class="hljs-string"><span class="hljs-string">"TradedOn"</span></span>); var priceSourceIdProperty = typeof(TestData).GetProperty(<span class="hljs-string"><span class="hljs-string">"PriceSourceId"</span></span>); var tickerProperty = typeof(TestData).GetProperty(<span class="hljs-string"><span class="hljs-string">"Ticker"</span></span>); var paramExpression = Expression.Parameter(typeof(TestData)); Expression wholeClause = null; foreach (var td in TestData) { var elementClause = Expression.AndAlso( Expression.Equal( Expression.MakeMemberAccess( paramExpression, tradedOnProperty), Expression.Constant(td.TradedOn) ), Expression.AndAlso( Expression.Equal( Expression.MakeMemberAccess( paramExpression, priceSourceIdProperty), Expression.Constant(td.PriceSourceId) ), Expression.Equal( Expression.MakeMemberAccess( paramExpression, tickerProperty), Expression.Constant(td.Ticker)) )); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wholeClause == null) wholeClause = elementClause; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> wholeClause = Expression.OrElse(wholeClause, elementClause); } var query = baseQuery.Where( (Expression&lt;Func&lt;TestData, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;&gt;)Expression.Lambda( wholeClause, paramExpression)).Select(x =&gt; x.PriceObject); result.AddRange(query); }</code> </pre> </div></div><br><p> äº‹å®è¯æ˜ï¼Œè¯¥ä»£ç æ¯”ä»¥å‰çš„æ–¹æ³•æ›´å¤æ‚ã€‚ æ‰‹åŠ¨æ„å»º<em>Expression</em>ä¸æ˜¯æœ€ç®€å•ï¼Œæœ€å¿«çš„æ“ä½œã€‚ </p><br><p> æŒ‡æ ‡ï¼š </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/312/373/4fc/3123734fc82c4fc4d783f4f9ce2cf225.png" alt="å›¾ç‰‡"></p><br><p> ä¸´æ—¶ç»“æœç”šè‡³æ¯”ä»¥å‰çš„æ–¹æ³•å·®ã€‚ çœ‹èµ·æ¥ï¼Œåœ¨æ„é€ è¿‡ç¨‹ä¸­ä»¥åŠåœ¨ç©¿è¿‡æ ‘æ—¶çš„å¼€é”€è¿œè¿œå¤§äºä½¿ç”¨ä¸€ä¸ªè¯·æ±‚æ‰€å¸¦æ¥çš„æ”¶ç›Šã€‚ </p><br><h4 id="sposob-5-shared-query-data-table"> æ–¹æ³•5ï¼šå…±äº«æŸ¥è¯¢æ•°æ®è¡¨ </h4><br><p> è®©æˆ‘ä»¬å°è¯•å¦ä¸€ä¸ªé€‰æ‹©ï¼š <br> æˆ‘åœ¨æ•°æ®åº“ä¸­åˆ›å»ºäº†ä¸€ä¸ªæ–°è¡¨ï¼Œåœ¨å…¶ä¸­å°†å†™å…¥å®Œæˆè¯·æ±‚æ‰€éœ€çš„æ•°æ®ï¼ˆè¿™æ„å‘³ç€åœ¨ä¸Šä¸‹æ–‡ä¸­æˆ‘éœ€è¦ä¸€ä¸ªæ–°çš„<em>DbSet</em> ï¼‰ã€‚ </p><br><p> ç°åœ¨ï¼Œè¦è·å¾—ç»“æœï¼Œæ‚¨éœ€è¦ï¼š </p><br><ol><li> å¼€å§‹äº¤æ˜“ </li><li> å°†æŸ¥è¯¢æ•°æ®ä¸Šä¼ åˆ°æ–°è¡¨ </li><li> è¿è¡ŒæŸ¥è¯¢æœ¬èº«ï¼ˆä½¿ç”¨æ–°è¡¨ï¼‰ </li><li> å›æ»šäº‹åŠ¡ï¼ˆæ¸…é™¤æ•°æ®è¡¨ä»¥è¿›è¡ŒæŸ¥è¯¢ï¼‰ </li></ol><br><p> ä»£ç å¦‚ä¸‹ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">æ–¹æ³•5çš„ä»£ç </b> <div class="spoiler_text"><pre> <code class="cpp hljs">var result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Price&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var context = CreateContext()) { context.Database.BeginTransaction(); var reducedData = TestData.Select(x =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SharedQueryModel() { PriceSourceId = x.PriceSourceId, Ticker = x.Ticker, TradedOn = x.TradedOn }).ToList(); <span class="hljs-comment"><span class="hljs-comment">//      context.QueryDataShared.AddRange(reducedData); context.SaveChanges(); var query = from p in context.Prices join s in context.Securities on p.SecurityId equals s.SecurityId join t in context.QueryDataShared on new { s.Ticker, p.TradedOn, p.PriceSourceId } equals new { t.Ticker, t.TradedOn, t.PriceSourceId } select p; result.AddRange(query); context.Database.RollbackTransaction(); }</span></span></code> </pre> </div></div><br><p> ç¬¬ä¸€æŒ‡æ ‡ï¼š </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/df0/ab7/d7d/df0ab7d7d01b0aeaeebf2b9a41f5e75b.png" alt="å›¾ç‰‡"></p><br><p> æ‰€æœ‰æµ‹è¯•éƒ½æœ‰æ•ˆå¹¶ä¸”å¾ˆå¿«ï¼ å†…å­˜æ¶ˆè€—ä¹Ÿæ˜¯å¯ä»¥æ¥å—çš„ã€‚ <br> å› æ­¤ï¼Œé€šè¿‡ä½¿ç”¨äº‹åŠ¡ï¼Œè¯¥è¡¨å¯ä»¥è¢«å¤šä¸ªè¿›ç¨‹åŒæ—¶ä½¿ç”¨ã€‚ ç”±äºè¿™æ˜¯ä¸€ä¸ªçœŸå®å­˜åœ¨çš„è¡¨ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<em>Entity Frameworkçš„</em>æ‰€æœ‰åŠŸèƒ½ï¼šæ‚¨åªéœ€å°†æ•°æ®åŠ è½½åˆ°è¡¨ä¸­ï¼Œä½¿ç”¨<em>JOIN</em>ç”ŸæˆæŸ¥è¯¢å¹¶æ‰§è¡Œå®ƒã€‚ ä¹ä¸€çœ‹ï¼Œè¿™æ˜¯æ‚¨æ‰€éœ€è¦çš„ï¼Œä½†æ˜¯æœ‰å¾ˆå¤šç¼ºç‚¹ï¼š </p><br><ul><li> æ‚¨å¿…é¡»ä¸ºç‰¹å®šç±»å‹çš„æŸ¥è¯¢åˆ›å»ºè¡¨ </li><li> æœ‰å¿…è¦ä½¿ç”¨äº‹åŠ¡ï¼ˆå¹¶æµªè´¹äº‹åŠ¡ä¸Šçš„DBMSèµ„æºï¼‰ </li><li> è€Œä¸”ï¼Œå½“æ‚¨éœ€è¦é˜…è¯»æ—¶ï¼Œæ‚¨éœ€è¦å†™ä¸€äº›ä¸œè¥¿çš„æƒ³æ³•çœ‹èµ·æ¥å¾ˆå¥‡æ€ªã€‚ åœ¨åªè¯»å‰¯æœ¬ä¸Šï¼Œå®ƒå°†æ— æ³•æ­£å¸¸å·¥ä½œã€‚ <br> å…¶ä½™çš„æ˜¯æˆ–å¤šæˆ–å°‘å¯ä»¥ä½¿ç”¨çš„è§£å†³æ–¹æ¡ˆã€‚ </li></ul><br><h4 id="sposob-6-memoryjoin-extension"> æ–¹æ³•6ã€‚MemoryJoinæ‰©å±• </h4><br><p> ç°åœ¨ï¼Œæ‚¨å¯ä»¥å°è¯•æ”¹è¿›ä»¥å‰çš„æ–¹æ³•ã€‚ è¿™äº›æƒ³æ³•æ˜¯ï¼š </p><br><ul><li> æ‚¨å¯ä»¥ä½¿ç”¨ä¸€äº›é€šç”¨é€‰é¡¹æ¥ä»£æ›¿ä½¿ç”¨ç‰¹å®šäºä¸€ç§æŸ¥è¯¢ç±»å‹çš„è¡¨ã€‚ å³ï¼Œåˆ›å»ºä¸€ä¸ªå…·æœ‰è¯¸å¦‚<em>shared_query_dataä¹‹</em>ç±»çš„åç§°çš„è¡¨ï¼Œå¹¶å‘å…¶ä¸­æ·»åŠ å‡ ä¸ª<em>Guid</em>å­—æ®µï¼Œå‡ ä¸ª<em>Long</em> ï¼Œå‡ ä¸ª<em>String</em>ç­‰ã€‚ å¯ä»¥é‡‡ç”¨ç®€å•çš„åç§°ï¼š <em>Guid1</em> ï¼Œ <em>Guid2</em> ï¼Œ <em>String1</em> ï¼Œ <em>Long1</em> ï¼Œ <em>Date2</em>ç­‰ã€‚ ç„¶åï¼Œè¯¥è¡¨å¯ç”¨äº95ï¼…çš„æŸ¥è¯¢ç±»å‹ã€‚ ç¨åå¯ä»¥ä½¿ç”¨â€œ <strong>é€‰æ‹©â€</strong>é€è§†å›¾â€œè°ƒæ•´â€å±æ€§åç§°ã€‚ </li><li> æ¥ä¸‹æ¥ï¼Œæ‚¨éœ€è¦ä¸º<em>shared_query_data</em>æ·»åŠ ä¸€ä¸ª<em>DbSet</em> ã€‚ </li><li> ä½†æ˜¯ï¼Œå¦‚æœä¸æ˜¯ä½¿ç”¨<strong>VALUES</strong>æ„é€ ä¼ é€’å€¼ï¼Œè€Œä¸æ˜¯å°†æ•°æ®å†™å…¥æ•°æ®åº“ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ ä¹Ÿå°±æ˜¯è¯´ï¼Œæœ‰å¿…è¦åœ¨æœ€ç»ˆçš„SQLæŸ¥è¯¢ä¸­ï¼Œè€Œä¸æ˜¯è®¿é—®<em>shared_query_dataï¼Œåº”è¯¥</em>å¸å¼•<strong>VALUES</strong> ã€‚ æ€ä¹ˆåšï¼Ÿ <br><ul><li> åœ¨Entity Framework Coreä¸­-ä»…ä½¿ç”¨<em>FromSql</em> ã€‚ </li><li> åœ¨Entity Framework 6ä¸­-æ‚¨å¿…é¡»ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">DbInterception-</a>ä¹Ÿå°±æ˜¯è¯´ï¼Œé€šè¿‡åœ¨æ‰§è¡Œä¹‹å‰æ·»åŠ <strong>VALUES</strong>æ„é€ æ¥æ›´æ”¹ç”Ÿæˆçš„SQLã€‚ è¿™å°†å¯¼è‡´é™åˆ¶ï¼šåœ¨ä¸€ä¸ªè¯·æ±‚ä¸­ï¼Œæœ€å¤šåªèƒ½æœ‰ä¸€ä¸ª<strong>VALUES</strong>æ„é€ ã€‚ ä½†è¿™ä¼šèµ·ä½œç”¨ï¼ </li></ul></li><li> ç”±äºæˆ‘ä»¬ä¸æ‰“ç®—å†™æ•°æ®åº“ï¼Œå› æ­¤æˆ‘ä»¬åœ¨<em>ç¬¬ä¸€æ­¥</em>ä¸­åˆ›å»ºäº†<em>shared_query_data</em>è¡¨ï¼Œæ˜¯å¦æ ¹æœ¬ä¸éœ€è¦å®ƒï¼Ÿ ç­”ï¼šæ˜¯çš„ï¼Œå®ƒä¸æ˜¯å¿…éœ€çš„ï¼Œä½†ä»ç„¶éœ€è¦<em>DbSet</em> ï¼Œå› ä¸ºå®ä½“æ¡†æ¶å¿…é¡»çŸ¥é“æ•°æ®æ–¹æ¡ˆæ‰èƒ½æ„å»ºæŸ¥è¯¢ã€‚ äº‹å®è¯æ˜ï¼Œå¯¹äºæŸäº›é€šç”¨æ¨¡å‹ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª<em>DbSet</em> ï¼Œè¯¥æ¨¡å‹åœ¨æ•°æ®åº“ä¸­ä¸å­˜åœ¨ï¼Œä»…ç”¨äºæ¿€å‘å®ä½“æ¡†æ¶ï¼Œå®ƒçŸ¥é“å®ƒåœ¨åšä»€ä¹ˆã€‚ </li></ul><br><div class="spoiler">  <b class="spoiler_title">å°†IEnumerableè½¬æ¢ä¸ºIQueryableç¤ºä¾‹</b> <div class="spoiler_text"><ol><li> è¾“å…¥æ¥æ”¶åˆ°ä»¥ä¸‹ç±»å‹çš„å¯¹è±¡çš„é›†åˆï¼š <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeQueryData</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> Ticker {get; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTimeTradedOn {get; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> PriceSourceId {get; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>;} }</code> </pre> </li><li> æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å­—æ®µ<em>String1</em> ï¼Œ <em>String2</em> ï¼Œ <em>Date1</em> ï¼Œ <em>Long1</em> <em>ç­‰</em> <em>DbSet</em> </li><li> è®©<em>ä»£ç </em>è¡Œå­˜å‚¨åœ¨<em>String1</em> ï¼Œ <em>Date1</em>çš„<em>TradedOn</em>ä»¥åŠ<em>Long1çš„PriceSourceId</em>ä¸­ï¼ˆ <em>int</em>æ˜ å°„ä¸º<em>long</em> ï¼Œä»¥ä¾¿ä¸å°†<em>int</em>å’Œ<em>longçš„</em>å­—æ®µåˆ†å¼€ï¼‰ </li><li> ç„¶åï¼Œ <em>FromSql</em> + <em>VALUES</em>å°†å¦‚ä¸‹æ‰€ç¤ºï¼š <br><pre> <code class="cpp hljs">var query = context.QuerySharedData.FromSql( <span class="hljs-string"><span class="hljs-string">"SELECT * FROM ( VALUES (1, 'Ticker1', @date1, @id1), (2, 'Ticker2', @date2, @id2) ) AS __gen_query_data__ (id, string1, date1, long1)"</span></span>)</code> </pre> </li><li> ç°åœ¨ï¼Œæ‚¨å¯ä»¥è¿›è¡ŒæŠ•å½±å¹¶ä½¿ç”¨ä¸è¾“å…¥ç›¸åŒçš„ç±»å‹è¿”å›ä¸€ä¸ªæ–¹ä¾¿çš„<em>IQueryable</em> ï¼š <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> query.Select(x =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SomeQueryData() { Ticker = x.String1, TradedOn = x.Date1, PriceSourceId = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)x.Long1 });</code> </pre> </li></ol></div></div><br><p> æˆ‘è®¾æ³•å®ç°äº†è¿™ç§æ–¹æ³•ï¼Œç”šè‡³å°†å…¶è®¾è®¡ä¸ºNuGetåŒ…<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">EntityFrameworkCore.MemoryJoin</a> ï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä»£ç </a>ä¹Ÿå¯ç”¨ï¼‰ã€‚ å°½ç®¡åç§°ä¸­åŒ…å«å•è¯<em>Core</em> ï¼Œä½†ä¹Ÿæ”¯æŒ<em>Entity Framework</em> 6ã€‚ æˆ‘å°†å…¶ç§°ä¸º<strong>MemoryJoin</strong> ï¼Œä½†å®é™…ä¸Šå®ƒä¼šå°†æœ¬åœ°æ•°æ®å‘é€åˆ°<em>VALUES</em>æ„é€ ä¸­çš„DBMSï¼Œå¹¶ä¸”æ‰€æœ‰å·¥ä½œéƒ½åœ¨æ­¤å®Œæˆã€‚ </p><br><p> ä»£ç å¦‚ä¸‹ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">æ–¹æ³•6çš„ä»£ç </b> <div class="spoiler_text"><pre> <code class="cpp hljs">var result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Price&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var context = CreateContext()) { <span class="hljs-comment"><span class="hljs-comment">// :    ,      var reducedData = TestData.Select(x =&gt; new { x.Ticker, x.TradedOn, x.PriceSourceId }).ToList(); //  IEnumerable&lt;&gt;   IQueryable&lt;&gt; var queryable = context.FromLocalList(reducedData); var query = from p in context.Prices join s in context.Securities on p.SecurityId equals s.SecurityId join t in queryable on new { s.Ticker, p.TradedOn, p.PriceSourceId } equals new { t.Ticker, t.TradedOn, t.PriceSourceId } select p; result.AddRange(query); }</span></span></code> </pre> </div></div><br><p> æŒ‡æ ‡ï¼š </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/6a7/d72/bb2/6a7d72bb265d9dedbc8e54d94fe16a4f.png" alt="å›¾ç‰‡"></p><br><p> è¿™æ˜¯æˆ‘å°è¯•è¿‡çš„æœ€å¥½ç»“æœã€‚ è¯¥ä»£ç éå¸¸ç®€å•æ˜äº†ï¼Œå¹¶ä¸”åŒæ—¶é€‚ç”¨äºåªè¯»å‰¯æœ¬ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">ç”Ÿæˆçš„ç”¨äºæ¥æ”¶3ä¸ªå…ƒç´ çš„è¯·æ±‚çš„ç¤ºä¾‹</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"PriceId"</span></span>, <span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"ClosePrice"</span></span>, <span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"OpenPrice"</span></span>, <span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"PriceSourceId"</span></span>, <span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"SecurityId"</span></span>, <span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"TradedOn"</span></span>, <span class="hljs-string"><span class="hljs-string">"t"</span></span>.<span class="hljs-string"><span class="hljs-string">"Ticker"</span></span>, <span class="hljs-string"><span class="hljs-string">"t"</span></span>.<span class="hljs-string"><span class="hljs-string">"TradedOn"</span></span>, <span class="hljs-string"><span class="hljs-string">"t"</span></span>.<span class="hljs-string"><span class="hljs-string">"PriceSourceId"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">"Price"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"p"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-string"><span class="hljs-string">"Security"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"s"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"SecurityId"</span></span> = <span class="hljs-string"><span class="hljs-string">"s"</span></span>.<span class="hljs-string"><span class="hljs-string">"SecurityId"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">"x"</span></span>.<span class="hljs-string"><span class="hljs-string">"string1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"Ticker"</span></span>, <span class="hljs-string"><span class="hljs-string">"x"</span></span>.<span class="hljs-string"><span class="hljs-string">"date1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"TradedOn"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-string"><span class="hljs-string">"x"</span></span>.<span class="hljs-string"><span class="hljs-string">"long1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> int4) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"PriceSourceId"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, @__gen_q_p0, @__gen_q_p1, @__gen_q_p2), (<span class="hljs-number"><span class="hljs-number">2</span></span>, @__gen_q_p3, @__gen_q_p4, @__gen_q_p5), (<span class="hljs-number"><span class="hljs-number">3</span></span>, @__gen_q_p6, @__gen_q_p7, @__gen_q_p8) ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> __gen_query_data__ (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, string1, date1, long1) ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"x"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"t"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ((<span class="hljs-string"><span class="hljs-string">"s"</span></span>.<span class="hljs-string"><span class="hljs-string">"Ticker"</span></span> = <span class="hljs-string"><span class="hljs-string">"t"</span></span>.<span class="hljs-string"><span class="hljs-string">"Ticker"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (<span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"PriceSourceId"</span></span> = <span class="hljs-string"><span class="hljs-string">"t"</span></span>.<span class="hljs-string"><span class="hljs-string">"PriceSourceId"</span></span>)</code> </pre> <br><p> åœ¨è¿™é‡Œï¼Œæ‚¨è¿˜å¯ä»¥çœ‹åˆ°ä½¿ç”¨Selectçš„å¹¿ä¹‰æ¨¡å‹ï¼ˆå…·æœ‰<em>String1</em> ï¼Œ <em>Date1</em> ï¼Œ <em>Long1</em>å­—æ®µï¼‰å¦‚ä½•å˜æˆä»£ç ä¸­ä½¿ç”¨çš„æ¨¡å‹ï¼ˆå…·æœ‰<em>Ticker</em> ï¼Œ <em>TradedOn</em> ï¼Œ <em>PriceSourceId</em>å­—æ®µï¼‰ã€‚ </p></div></div><br><p> æ‰€æœ‰å·¥ä½œéƒ½åœ¨SQLæœåŠ¡å™¨ä¸Šçš„1ä¸ªæŸ¥è¯¢ä¸­å®Œæˆã€‚ è¿™æ˜¯ä¸€ä¸ªå°å°çš„å¹¸ç¦ç»“å±€ï¼Œæˆ‘åœ¨å¼€å§‹æ—¶å°±è°ˆåˆ°äº†ã€‚ ä½†æ˜¯ï¼Œä½¿ç”¨æ­¤æ–¹æ³•éœ€è¦äº†è§£å¹¶æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š </p><br><ul><li> æ‚¨éœ€è¦åœ¨ä¸Šä¸‹æ–‡ä¸­æ·»åŠ ä¸€ä¸ªé¢å¤–çš„<em>DbSet</em> ï¼ˆå°½ç®¡è¡¨æœ¬èº«å¯ä»¥<em>çœç•¥</em> ï¼‰ </li><li> åœ¨é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨çš„é€šç”¨æ¨¡å‹ä¸­ï¼Œå£°æ˜äº†ç±»å‹ä¸º<em>Guid</em> ï¼Œ <em>String</em> ï¼Œ <em>Double</em> ï¼Œ <em>Long</em> ï¼Œ <em>Date</em>ç­‰çš„3ä¸ªå­—æ®µã€‚ å¯¹äº95ï¼…çš„è¯·æ±‚ç±»å‹ï¼Œè¿™åº”è¯¥è¶³å¤Ÿäº†ã€‚ å¹¶ä¸”ï¼Œå¦‚æœå°†å…·æœ‰20ä¸ªå­—æ®µçš„å¯¹è±¡çš„é›†åˆä¼ é€’ç»™<em>FromLocalList</em> ï¼Œåˆ™å°†å¼•å‘<em>Exception</em> ï¼Œè¡¨ç¤ºè¯¥å¯¹è±¡å¤ªå¤æ‚ã€‚ è¿™æ˜¯ä¸€ä¸ªè½¯é™åˆ¶ï¼Œå¯ä»¥ç»•å¼€-æ‚¨å¯ä»¥å£°æ˜ç±»å‹å¹¶åœ¨å…¶ä¸­æ·»åŠ è‡³å°‘100ä¸ªå­—æ®µã€‚ ä½†æ˜¯ï¼Œæ›´å¤šå­—æ®µçš„å·¥ä½œé€Ÿåº¦è¾ƒæ…¢ã€‚ </li><li> æˆ‘çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡ç« </a>ä¸­ä»‹ç»äº†æ›´å¤šæŠ€æœ¯ç»†èŠ‚ã€‚ </li></ul><br><h2 id="zaklyuchenie"> ç»“è®º </h2><br><p> åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»‹ç»äº†æœ‰å…³JOINæœ¬åœ°é›†åˆå’ŒDbSetçš„æƒ³æ³•ã€‚ åœ¨æˆ‘çœ‹æ¥ï¼Œä½¿ç”¨<em>VALUES</em>è¿›è¡Œå¼€å‘å¯èƒ½ä¼šå¼•èµ·ç¤¾åŒºçš„å…´è¶£ã€‚ å½“æˆ‘è‡ªå·±è§£å†³è¿™ä¸ªé—®é¢˜æ—¶ï¼Œè‡³å°‘æˆ‘æ²¡æœ‰é‡åˆ°è¿™ç§æ–¹æ³•ã€‚ å°±ä¸ªäººè€Œè¨€ï¼Œè¿™ç§æ–¹æ³•å¯ä»¥å¸®åŠ©æˆ‘å…‹æœå½“å‰é¡¹ç›®ä¸­çš„è®¸å¤šæ€§èƒ½é—®é¢˜ï¼Œä¹Ÿè®¸å¯¹æ‚¨ä¹Ÿæœ‰å¸®åŠ©ã€‚ </p><br><p> æœ‰äººä¼šè¯´<em>MemoryJoin</em>çš„ä½¿ç”¨è¿‡äºâ€œ <em>æŠ½è±¡</em> â€ï¼Œéœ€è¦è¿›ä¸€æ­¥å¼€å‘ï¼Œåœ¨æ­¤ä¹‹å‰ï¼Œæ‚¨ä¸éœ€è¦ä½¿ç”¨å®ƒã€‚ è¿™æ­£æ˜¯æˆ‘éå¸¸æ€€ç–‘çš„åŸå› ï¼Œå¹¶ä¸”è¿‘ä¸€å¹´æ¥æˆ‘éƒ½æ²¡æœ‰å†™è¿™ç¯‡æ–‡ç« ã€‚ æˆ‘åŒæ„æˆ‘å¸Œæœ›å®ƒæ›´è½»æ¾åœ°å·¥ä½œï¼ˆå¸Œæœ›æœ‰ä¸€å¤©èƒ½åšåˆ°ï¼‰ï¼Œä½†æ˜¯æˆ‘ä¹Ÿè¦è¯´ï¼Œä¼˜åŒ–ä»æ¥éƒ½ä¸æ˜¯Juniorçš„ä»»åŠ¡ã€‚ ä¼˜åŒ–å§‹ç»ˆéœ€è¦äº†è§£å·¥å…·çš„å·¥ä½œæ–¹å¼ã€‚ å¦‚æœæœ‰æœºä¼šè·å¾—çº¦8å€çš„åŠ é€Ÿï¼ˆ <em>Naive Parallel</em> vs <em>MemoryJoin</em> ï¼‰ï¼Œé‚£ä¹ˆæˆ‘å°†æŒæ¡2åˆ†å’Œæ–‡æ¡£ã€‚ </p><br><p> æœ€åï¼Œè¿™äº›å›¾ï¼š </p><br><p> èŠ±æ—¶é—´ã€‚ åœ¨ä¸åˆ°10åˆ†é’Ÿçš„æ—¶é—´å†…åªæœ‰4ç§æ–¹æ³•å®Œæˆäº†ä»»åŠ¡ï¼Œè€Œ<em>MemoryJoin</em>æ˜¯åœ¨ä¸åˆ°10ç§’çš„æ—¶é—´å†…å®Œæˆä»»åŠ¡çš„å”¯ä¸€æ–¹æ³•ã€‚ </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/720/256/846/72025684620477d221c0f113a6cb354f.png" alt="å›¾ç‰‡"></p><br><p> å†…å­˜æ¶ˆè€—ã€‚ é™¤äº†<em>Multiple Contains</em>ä¹‹å¤–ï¼Œæ‰€æœ‰æ–¹æ³•éƒ½æ˜¾ç¤ºå‡ºå¤§è‡´ç›¸åŒçš„å†…å­˜æ¶ˆè€—ã€‚ è¿™æ˜¯ç”±äºè¿”å›çš„æ•°æ®é‡ã€‚ </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/e07/a91/b63/e07a91b63375d49a21adb81e8213ffdb.png" alt="å›¾ç‰‡"></p><br><p> æ„Ÿè°¢æ‚¨çš„é˜…è¯»ï¼ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN435810/">https://habr.com/ru/post/zh-CN435810/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN435798/index.html">ç´¢å°¼WH-1000XM3-æœ€å¥½çš„æ— çº¿è€³æœºï¼Ÿ</a></li>
<li><a href="../zh-CN435800/index.html">åè¿›åˆ¶å­—æ¯11</a></li>
<li><a href="../zh-CN435802/index.html">OpenVPNï¼Œæ‚¨å¯¹æ­¤äº†è§£ç”šå°‘</a></li>
<li><a href="../zh-CN435804/index.html">é‡æ–°å¯åŠ¨åï¼Œè‹±ç‰¹å°”Cycloneä¸ä¼šä¿å­˜é…ç½®</a></li>
<li><a href="../zh-CN435806/index.html">æ—¥æœ¬å®£å¸ƒå¿ƒè„ç”Ÿç‰©å·¥ç¨‹å­¦çš„ä¸´åºŠè¯•éªŒ</a></li>
<li><a href="../zh-CN435812/index.html">å¹¸ç¦ç†è®ºã€‚ ç»Ÿè®¡æ˜¯ä¸€æ— æ‰€çŸ¥çš„ç§‘å­¦æ–¹æ³•</a></li>
<li><a href="../zh-CN435814/index.html">[æ—§äº‹ç‰©]æˆ‘å¯ä»¥éšä¾¿ä½¿ç”¨æˆ‘çš„å †æ ˆå—ï¼Ÿ</a></li>
<li><a href="../zh-CN435816/index.html">é©¬è¨è¯¸å¡å·åŒ»é™¢å’ŒDeepMindåˆ†åˆ«æ‰“å¼€äº†åŒ»å­¦ç•Œçš„AIé»‘åŒ£å­</a></li>
<li><a href="../zh-CN435822/index.html">å¦‚ä½•ä½¿ç”¨å£°éŸ³æ§åˆ¶æ•°æ®ä¸­å¿ƒçš„ç¡¬ä»¶</a></li>
<li><a href="../zh-CN435824/index.html">åœ¨ä»äº‹éŸ³é¢‘è¡Œä¸šä¹‹å‰éœ€è¦äº†è§£çš„å†…å®¹</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>