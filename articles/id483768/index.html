<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍹 ↪️ ❔ MVCC di PostgreSQL-5. Vakum dalam halaman dan pembaruan HOT 🤳🏻 👅 🙏🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sekadar mengingatkan Anda, kami sudah membahas masalah yang berkaitan dengan isolasi , membuat penyimpangan mengenai struktur data tingkat rendah , da...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>MVCC di PostgreSQL-5. Vakum dalam halaman dan pembaruan HOT</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/postgrespro/blog/483768/">  Sekadar mengingatkan Anda, kami sudah membahas masalah yang berkaitan dengan <a href="https://habr.com/ru/company/postgrespro/blog/467437/">isolasi</a> , membuat penyimpangan mengenai <a href="https://habr.com/ru/company/postgrespro/blog/469087/">struktur data tingkat rendah</a> , dan kemudian mengeksplorasi <a href="https://habr.com/ru/company/postgrespro/blog/477648/">versi baris</a> dan mengamati bagaimana <a href="https://habr.com/ru/company/postgrespro/blog/479512/">snapshot data</a> diperoleh dari versi baris. <br><br>  Sekarang kita akan melanjutkan ke dua masalah yang berhubungan erat: <em>vakum di halaman</em> dan <em>pembaruan HOT</em> .  Kedua teknik dapat disebut sebagai optimasi;  mereka penting, tetapi sebenarnya tidak tercakup dalam dokumentasi. <br><br><h1>  Vakum dalam halaman selama pembaruan rutin </h1><br>  Saat mengakses halaman untuk pembaruan atau membaca, jika PostgreSQL memahami bahwa halaman tersebut kehabisan ruang, itu dapat melakukan vakum cepat di dalam halaman.  Ini terjadi dalam salah satu kasus: <br><br><ol><li>  Pembaruan sebelumnya di halaman ini tidak menemukan ruang yang cukup untuk mengalokasikan versi baris baru di halaman yang sama.  Situasi seperti itu diingat di tajuk halaman, dan lain kali halaman itu disedot. </li><li> Halaman lebih dari <code>fillfactor</code> persen penuh.  Dalam hal ini, vakum dilakukan segera tanpa menunda sampai berikutnya. </li></ol><a name="habracut"></a><br>  <code>fillfactor</code> adalah parameter penyimpanan yang dapat didefinisikan untuk tabel (dan untuk indeks).  PostgresSQL menyisipkan baris baru di halaman hanya jika halaman kurang dari <code>fillfactor</code> persen penuh.  Ruang yang tersisa disediakan untuk tupel baru yang dibuat sebagai hasil dari pembaruan.  Nilai default untuk tabel adalah 100, yaitu, tidak ada ruang yang dipesan (dan nilai default untuk indeks adalah 90). <br><br>  Vakum dalam halaman menghapus tupel yang tidak terlihat dalam snapshot apa pun (yang berada di luar cakrawala transaksi dari basis data, yang telah dibahas <a href="https://habr.com/ru/company/postgrespro/blog/479512/">terakhir kali</a> ), tetapi melakukan hal ini secara ketat dalam satu halaman tabel.  Pointer ke tupel vakum tidak dirilis karena mereka dapat dirujuk dari indeks, dan indeks ada di halaman lain.  Vakum dalam halaman tidak pernah mencapai lebih dari satu halaman tabel, tetapi bekerja dengan sangat cepat. <br><br>  Untuk alasan yang sama, peta ruang bebas tidak diperbarui;  ini juga menyimpan ruang ekstra untuk pembaruan daripada untuk memasukkan.  Peta visibilitas juga tidak diperbarui. <br><br>  Fakta bahwa sebuah halaman dapat dikosongkan selama membaca berarti bahwa permintaan SELECT dapat menyebabkan perubahan halaman.  Ini adalah satu lagi kasus seperti ini, di samping perubahan bit petunjuk yang ditangguhkan, dibahas sebelumnya. <br><br>  Mari kita perhatikan contoh cara kerjanya.  Mari kita buat tabel dan indeks pada kedua kolom. <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> hot(id <span class="hljs-type"><span class="hljs-type">integer</span></span>, s <span class="hljs-type"><span class="hljs-type">char</span></span>(<span class="hljs-number"><span class="hljs-number">2000</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (fillfactor = <span class="hljs-number"><span class="hljs-number">75</span></span>); =&gt; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> hot_id <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> hot(id); =&gt; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> hot_s <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> hot(s);</code> </pre><br>  Jika kolom <code>s</code> hanya menyimpan karakter Latin, setiap versi baris akan menempati 2004 byte plus 24 byte header.  Kami menetapkan parameter penyimpanan <code>fillfactor</code> menjadi 75%, yang mencadangkan ruang yang cukup untuk tiga baris. <br><br>  Untuk melihat isi halaman tabel dengan mudah, mari kita buat kembali fungsi yang sudah akrab dengan menambahkan dua bidang ke output: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> heap_page(relname <span class="hljs-type"><span class="hljs-type">text</span></span>, pageno <span class="hljs-type"><span class="hljs-type">integer</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span>(ctid tid, state <span class="hljs-type"><span class="hljs-type">text</span></span>, xmin <span class="hljs-type"><span class="hljs-type">text</span></span>, xmax <span class="hljs-type"><span class="hljs-type">text</span></span>, hhu <span class="hljs-type"><span class="hljs-type">text</span></span>, hot <span class="hljs-type"><span class="hljs-type">text</span></span>, t_ctid tid) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$<span class="pgsql"><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> (pageno,lp)::</span><span class="hljs-type"><span class="pgsql"><span class="hljs-type">text</span></span></span><span class="pgsql">::tid </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">AS</span></span></span><span class="pgsql"> ctid, </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">CASE</span></span></span><span class="pgsql"> lp_flags </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHEN</span></span></span><span class="pgsql"> </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">0</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">THEN</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'unused'</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHEN</span></span></span><span class="pgsql"> </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">1</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">THEN</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'normal'</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHEN</span></span></span><span class="pgsql"> </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">2</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">THEN</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'redirect to '</span></span></span><span class="pgsql">||lp_off </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHEN</span></span></span><span class="pgsql"> </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">3</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">THEN</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'dead'</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">END</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">AS</span></span></span><span class="pgsql"> state, t_xmin || </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">CASE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHEN</span></span></span><span class="pgsql"> (t_infomask &amp; </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">256</span></span></span><span class="pgsql">) &gt; </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">0</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">THEN</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">' (c)'</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHEN</span></span></span><span class="pgsql"> (t_infomask &amp; </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">512</span></span></span><span class="pgsql">) &gt; </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">0</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">THEN</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">' (a)'</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">ELSE</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">''</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">END</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">AS</span></span></span><span class="pgsql"> xmin, t_xmax || </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">CASE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHEN</span></span></span><span class="pgsql"> (t_infomask &amp; </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">1024</span></span></span><span class="pgsql">) &gt; </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">0</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">THEN</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">' (c)'</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHEN</span></span></span><span class="pgsql"> (t_infomask &amp; </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">2048</span></span></span><span class="pgsql">) &gt; </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">0</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">THEN</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">' (a)'</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">ELSE</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">''</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">END</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">AS</span></span></span><span class="pgsql"> xmax, </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">CASE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHEN</span></span></span><span class="pgsql"> (t_infomask2 &amp; </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">16384</span></span></span><span class="pgsql">) &gt; </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">0</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">THEN</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'t'</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">END</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">AS</span></span></span><span class="pgsql"> hhu, </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">CASE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHEN</span></span></span><span class="pgsql"> (t_infomask2 &amp; </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">32768</span></span></span><span class="pgsql">) &gt; </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">0</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">THEN</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'t'</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">END</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">AS</span></span></span><span class="pgsql"> hot, t_ctid </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> heap_page_items(get_raw_page(relname,pageno)) </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">ORDER</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">BY</span></span></span><span class="pgsql"> lp; $$</span><span class="undefined"></span></span><span class="pgsql"><span class="undefined"></span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>;</code> </pre><br>  Mari kita juga membuat fungsi untuk melihat ke halaman indeks: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> index_page(relname <span class="hljs-type"><span class="hljs-type">text</span></span>, pageno <span class="hljs-type"><span class="hljs-type">integer</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span>(itemoffset <span class="hljs-type"><span class="hljs-type">smallint</span></span>, ctid tid) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$<span class="pgsql"><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> itemoffset, ctid </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> bt_page_items(relname,pageno); $$</span><span class="undefined"></span></span><span class="pgsql"><span class="undefined"></span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>;</code> </pre><br>  Mari kita periksa bagaimana vakum dalam halaman bekerja.  Untuk melakukan ini, kami menyisipkan satu baris dan mengubahnya beberapa kali: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'A'</span></span>); =&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'B'</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'C'</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'D'</span></span>;</code> </pre><br>  Ada empat tupel di halaman sekarang: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> heap_page(<span class="hljs-string"><span class="hljs-string">'hot'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><pre> <code class="plaintext hljs"> ctid | state | xmin | xmax | hhu | hot | t_ctid -------+--------+----------+----------+-----+-----+-------- (0,1) | normal | 3979 (c) | 3980 (c) | | | (0,2) (0,2) | normal | 3980 (c) | 3981 (c) | | | (0,3) (0,3) | normal | 3981 (c) | 3982 | | | (0,4) (0,4) | normal | 3982 | 0 (a) | | | (0,4) (4 rows)</code> </pre><br>  Seperti yang diharapkan, kami baru saja melampaui ambang <code>fillfactor</code> .  Ini jelas dari perbedaan antara <code>pagesize</code> dan nilai-nilai <code>upper</code> : ini melebihi ambang sama dengan 75% dari ukuran halaman, yang menghasilkan 6144 byte. <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> lower, upper, pagesize <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> page_header(get_raw_page(<span class="hljs-string"><span class="hljs-string">'hot'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>));</code> </pre><pre> <code class="plaintext hljs"> lower | upper | pagesize -------+-------+---------- 40 | 64 | 8192 (1 row)</code> </pre><br>  Jadi, ketika halaman diakses lain kali, kekosongan dalam halaman harus terjadi.  Mari kita periksa ini. <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'E'</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> heap_page(<span class="hljs-string"><span class="hljs-string">'hot'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><pre> <code class="plaintext hljs"> ctid | state | xmin | xmax | hhu | hot | t_ctid -------+--------+----------+-------+-----+-----+-------- (0,1) | dead | | | | | (0,2) | dead | | | | | (0,3) | dead | | | | | (0,4) | normal | 3982 (c) | 3983 | | | (0,5) (0,5) | normal | 3983 | 0 (a) | | | (0,5) (5 rows)</code> </pre><br>  Semua tupel mati (0,1), (0,2) dan (0,3) disedot;  setelah itu tuple baru (0,5) ditambahkan di ruang yang dibebaskan. <br><br>  Tuple yang selamat dari penyedotan secara fisik dipindahkan ke alamat yang tinggi dari halaman sehingga semua ruang bebas diwakili oleh satu area kontinu.  Nilai dari pointer diubah sesuai.  Berkat ini, tidak ada masalah yang muncul dengan fragmentasi ruang kosong di halaman. <br><br>  Pointer ke tupel vakum tidak dapat dilepaskan karena direferensikan dari halaman indeks.  Mari kita melihat halaman pertama dari indeks <code>hot_s</code> (karena halaman nol ditempati oleh metainformation): <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> index_page(<span class="hljs-string"><span class="hljs-string">'hot_s'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre><pre> <code class="plaintext hljs"> itemoffset | ctid ------------+------- 1 | (0,1) 2 | (0,2) 3 | (0,3) 4 | (0,4) 5 | (0,5) (5 rows)</code> </pre><br>  Kami juga melihat gambar yang sama di indeks lain: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> index_page(<span class="hljs-string"><span class="hljs-string">'hot_id'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre><pre> <code class="plaintext hljs"> itemoffset | ctid ------------+------- 1 | (0,5) 2 | (0,4) 3 | (0,3) 4 | (0,2) 5 | (0,1) (5 rows)</code> </pre><br>  Anda mungkin memperhatikan bahwa pointer ke baris tabel mengikuti di sini dalam urutan terbalik, tetapi ini tidak ada bedanya karena semua tupel memiliki nilai yang sama: id = 1.  Tetapi dalam indeks sebelumnya, pointer diurutkan berdasarkan nilai <code>s</code> , dan ini penting. <br><br>  Dengan akses indeks, PostgreSQL bisa mendapatkan (0,1), (0,2) atau (0,3) sebagai pengidentifikasi tuple.  Kemudian akan mencoba untuk mendapatkan versi baris yang sesuai dari halaman tabel, tetapi karena status pointer "mati", PostgreSQL akan menemukan bahwa versi seperti itu tidak ada lagi dan akan mengabaikannya.  (Sebenarnya, setelah menemukan bahwa versi baris tabel tidak tersedia, PostgreSQL akan mengubah status pointer di halaman indeks agar tidak mengakses halaman tabel lagi.) <br><br>  Sangat penting bahwa vakum dalam halaman hanya berfungsi dalam satu halaman tabel dan tidak vakum halaman indeks. <br><br><h1>  Pembaruan HOT </h1><br>  Mengapa tidak baik menyimpan referensi ke semua versi baris dalam indeks? <br><br>  Pertama, untuk setiap perubahan baris, semua indeks yang dibuat untuk tabel harus diperbarui: setelah versi baru dibuat, itu perlu direferensikan.  Dan kita perlu melakukan ini dalam hal apa pun, bahkan jika bidang diubah yang tidak diindeks.  Ini jelas sangat tidak efisien. <br><br>  Kedua, indeks mengumpulkan referensi ke tupel historis, yang kemudian perlu disedot bersama dengan tupel itu sendiri (kita akan membahas sedikit kemudian bagaimana ini dilakukan). <br><br>  Selain itu, B-tree di PostgreSQL memiliki spesifikasi implementasi.  Jika halaman indeks tidak memiliki ruang yang cukup untuk menyisipkan baris baru, halaman dibagi menjadi dua, dan semua data didistribusikan di antara mereka.  Ini disebut pemisahan halaman.  Namun, ketika baris dihapus, dua halaman indeks tidak digabung menjadi satu.  Karena itu, ukuran indeks mungkin gagal untuk mengurangi bahkan jika sebagian besar data dihapus. <br><br>  Secara alami, semakin banyak indeks dibuat di atas meja, semakin banyak kompleksitas yang ditemui. <br><br>  Namun, jika nilai diubah dalam kolom yang tidak diindeks sama sekali, tidak masuk akal untuk membuat baris B-tree tambahan yang berisi nilai kunci yang sama.  Inilah cara optimalisasi yang disebut <em>pembaruan PANAS</em> ( <em>pembaruan</em> Heap-Only Tuple) bekerja. <br><br>  Selama pembaruan ini, halaman indeks hanya berisi satu baris, yang mereferensikan versi pertama dari baris di halaman tabel.  Dan sudah ada di dalam halaman tabel, bahwa rantai tupel diatur: <br><br><ul><li>  Baris yang diperbarui yang ada dalam rantai diberi label dengan bit Heap Hot Updated. </li><li>  Baris yang tidak direferensikan dari indeks diberi label dengan Heap Only Tuple bit. </li><li>  Seperti biasa, versi baris ditautkan melalui bidang <code>ctid</code> . </li></ul><br>  Jika selama pemindaian indeks, PostgreSQL mengakses halaman tabel dan menemukan tupel berlabel Heap Hot Updated, ia memahami bahwa itu tidak boleh berhenti, tetapi harus mengikuti rantai HOT, mengingat setiap tuple di dalamnya.  Tentu saja, untuk semua tupel yang didapat dengan cara ini, visibilitas diperiksa sebelum mengembalikannya ke klien. <br><br>  Untuk mengamati cara kerja pembaruan PANAS, mari kita hapus satu indeks dan kosongkan tabel. <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> hot_s; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">TRUNCATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> hot;</code> </pre><br>  Sekarang kita ulangi sisipan dan perbarui satu baris. <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'A'</span></span>); =&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'B'</span></span>;</code> </pre><br>  Dan inilah yang kita lihat di halaman tabel: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> heap_page(<span class="hljs-string"><span class="hljs-string">'hot'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><pre> <code class="plaintext hljs"> ctid | state | xmin | xmax | hhu | hot | t_ctid -------+--------+----------+-------+-----+-----+-------- (0,1) | normal | 3986 (c) | 3987 | t | | (0,2) (0,2) | normal | 3987 | 0 (a) | | t | (0,2) (2 rows)</code> </pre><br>  Ada rantai perubahan di halaman: <br><br><ul><li>  Bendera Heap Hot Updated menunjukkan bahwa rantai <code>ctid</code> harus diikuti. </li><li>  Bendera Heap Only Tuple menunjukkan bahwa tupel ini tidak dirujuk dari indeks. </li></ul><br>  Rantai akan tumbuh (di dalam halaman) dengan perubahan lebih lanjut: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'C'</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'D'</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> heap_page(<span class="hljs-string"><span class="hljs-string">'hot'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><pre> <code class="plaintext hljs"> ctid | state | xmin | xmax | hhu | hot | t_ctid -------+--------+----------+----------+-----+-----+-------- (0,1) | normal | 3986 (c) | 3987 (c) | t | | (0,2) (0,2) | normal | 3987 (c) | 3988 (c) | t | t | (0,3) (0,3) | normal | 3988 (c) | 3989 | t | t | (0,4) (0,4) | normal | 3989 | 0 (a) | | t | (0,4) (4 rows)</code> </pre><br>  Tetapi hanya ada satu referensi ke kepala rantai dalam indeks: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> index_page(<span class="hljs-string"><span class="hljs-string">'hot_id'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre><pre> <code class="plaintext hljs"> itemoffset | ctid ------------+------- 1 | (0,1) (1 row)</code> </pre><br>  Untuk menekankan, pembaruan HOT bekerja dalam kasus di mana bidang untuk memperbarui tidak diindeks sama sekali.  Jika tidak, beberapa indeks akan berisi referensi langsung ke versi baris baru, dan ini tidak sesuai dengan konsep pengoptimalan ini. <br><br>  Optimalisasi hanya berfungsi dalam satu halaman, dan karenanya, jalan tambahan melalui rantai tidak memerlukan akses ke halaman lain dan tidak mempengaruhi kinerja. <br><br><h1>  Vakum dalam halaman selama pembaruan HOT </h1><br>  Vakum selama pembaruan HOT adalah kasus khusus, tetapi penting dari vakum di-halaman. <br><br>  Seperti sebelumnya, kami telah melampaui ambang <code>fillfactor</code> , sehingga pembaruan berikutnya harus menyebabkan kekosongan dalam-halaman.  Tapi kali ini ada rantai pembaruan di halaman.  Kepala rantai HOT ini harus selalu tetap di tempatnya semula karena direferensikan oleh indeks, sementara sisa pointer dapat dirilis: mereka diketahui tidak memiliki referensi dari luar. <br><br>  Agar tidak menyentuh pointer kepala, pengalamatan tidak langsung digunakan: pointer yang dirujuk oleh indeks - (0,1) dalam kasus ini - memperoleh status "redirect", yang mengarahkan ke tuple yang sesuai. <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'E'</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> heap_page(<span class="hljs-string"><span class="hljs-string">'hot'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><pre> <code class="plaintext hljs"> ctid | state | xmin | xmax | hhu | hot | t_ctid -------+---------------+----------+-------+-----+-----+-------- (0,1) | redirect to 4 | | | | | (0,2) | normal | 3990 | 0 (a) | | t | (0,2) (0,3) | unused | | | | | (0,4) | normal | 3989 (c) | 3990 | t | t | (0,2) (4 rows)</code> </pre><br>  Perhatikan bahwa: <br><br><ul><li>  Tuples (0,1), (0,2) dan (0,3) disedot pergi. </li><li>  Header pointer (0,1) tetap, tetapi memperoleh status "redirect". </li><li>  Versi baris yang baru ditimpa (0,2) karena tidak ada referensi untuk tuple itu, dan penunjuknya dilepaskan (status "tidak digunakan"). </li></ul><br>  Mari lakukan pembaruan beberapa kali lagi: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'F'</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'G'</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> heap_page(<span class="hljs-string"><span class="hljs-string">'hot'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><pre> <code class="plaintext hljs"> ctid | state | xmin | xmax | hhu | hot | t_ctid -------+---------------+----------+----------+-----+-----+-------- (0,1) | redirect to 4 | | | | | (0,2) | normal | 3990 (c) | 3991 (c) | t | t | (0,3) (0,3) | normal | 3991 (c) | 3992 | t | t | (0,5) (0,4) | normal | 3989 (c) | 3990 (c) | t | t | (0,2) (0,5) | normal | 3992 | 0 (a) | | t | (0,5) (5 rows)</code> </pre><br>  Pembaruan berikutnya menyebabkan penyedotan kembali halaman: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'H'</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> heap_page(<span class="hljs-string"><span class="hljs-string">'hot'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><pre> <code class="plaintext hljs"> ctid | state | xmin | xmax | hhu | hot | t_ctid -------+---------------+----------+-------+-----+-----+-------- (0,1) | redirect to 5 | | | | | (0,2) | normal | 3993 | 0 (a) | | t | (0,2) (0,3) | unused | | | | | (0,4) | unused | | | | | (0,5) | normal | 3992 (c) | 3993 | t | t | (0,2) (5 rows)</code> </pre><br>  Sekali lagi, beberapa tuple disedot pergi, dan penunjuk ke kepala rantai dipindahkan sesuai. <br><br>  Kesimpulan: jika kolom yang tidak diindekskan sering diperbarui, mungkin masuk akal untuk mengurangi parameter <code>fillfactor</code> untuk memesan beberapa ruang halaman untuk pembaruan.  Namun, kita harus memperhitungkan bahwa semakin sedikit <code>fillfactor</code> , semakin banyak ruang kosong yang tersisa dalam satu halaman, sehingga ukuran fisik tabel meningkat. <br><br><h1>  Istirahat dari rantai PANAS </h1><br>  Jika halaman tidak memiliki ruang kosong untuk mengalokasikan tuple baru, rantai akan putus.  Dan kita harus membuat referensi terpisah dari indeks ke versi baris yang terletak di halaman yang berbeda. <br><br>  Untuk mereproduksi situasi ini, mari kita mulai transaksi bersamaan dan buat snapshot data di dalamnya. <br><br><pre> <code class="pgsql hljs">| =&gt; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ISOLATION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEVEL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPEATABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">READ</span></span>; | =&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> count(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> hot;</code> </pre><pre> <code class="plaintext hljs">| count | ------- | 1 | (1 row)</code> </pre><br>  Snapshot tidak akan memungkinkan menyedot tupel di halaman.  Sekarang mari kita lakukan pembaruan di sesi pertama: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'I'</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'J'</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'K'</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> heap_page(<span class="hljs-string"><span class="hljs-string">'hot'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><pre> <code class="plaintext hljs"> ctid | state | xmin | xmax | hhu | hot | t_ctid -------+---------------+----------+----------+-----+-----+-------- (0,1) | redirect to 2 | | | | | (0,2) | normal | 3993 (c) | 3994 (c) | t | t | (0,3) (0,3) | normal | 3994 (c) | 3995 (c) | t | t | (0,4) (0,4) | normal | 3995 (c) | 3996 | t | t | (0,5) (0,5) | normal | 3996 | 0 (a) | | t | (0,5) (5 rows)</code> </pre><br>  Pada pembaruan berikutnya, halaman tidak akan memiliki cukup ruang, tetapi vakum di-halaman tidak akan dapat menyedot apa pun: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'L'</span></span>;</code> </pre><br><pre> <code class="pgsql hljs">| =&gt; <span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span>; <span class="hljs-comment"><span class="hljs-comment">-- snapshot no longer needed</span></span></code> </pre><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> heap_page(<span class="hljs-string"><span class="hljs-string">'hot'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><pre> <code class="plaintext hljs"> ctid | state | xmin | xmax | hhu | hot | t_ctid -------+---------------+----------+----------+-----+-----+-------- (0,1) | redirect to 2 | | | | | (0,2) | normal | 3993 (c) | 3994 (c) | t | t | (0,3) (0,3) | normal | 3994 (c) | 3995 (c) | t | t | (0,4) (0,4) | normal | 3995 (c) | 3996 (c) | t | t | (0,5) (0,5) | normal | 3996 (c) | 3997 | | t | (1,1) (5 rows)</code> </pre><br>  Dalam tupel (0,5), ada referensi ke (1,1), yang ada di halaman 1. <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> heap_page(<span class="hljs-string"><span class="hljs-string">'hot'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre><pre> <code class="plaintext hljs"> ctid | state | xmin | xmax | hhu | hot | t_ctid -------+--------+------+-------+-----+-----+-------- (1,1) | normal | 3997 | 0 (a) | | | (1,1) (1 row)</code> </pre><br>  Sekarang ada dua baris dalam indeks, yang masing-masing menunjuk ke awal rantai HOT-nya: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> index_page(<span class="hljs-string"><span class="hljs-string">'hot_id'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre><pre> <code class="plaintext hljs"> itemoffset | ctid ------------+------- 1 | (1,1) 2 | (0,1) (2 rows)</code> </pre><br><blockquote>  Sayangnya, dokumentasi ini hampir tidak memiliki informasi tentang pembaruan vakum dan panas dalam-halaman, dan Anda harus mencari jawaban dalam kode sumber.  Saya menyarankan Anda untuk mulai dengan <a href="https://git.postgresql.org/gitweb/%3Fp%3Dpostgresql.git%3Ba%3Dblob%3Bf%3Dsrc/backend/access/heap/README.HOT%3Bhb%3DHEAD">README.HOT</a> . <br></blockquote><br>  <a href="https://habr.com/ru/company/postgrespro/blog/484106/">Baca terus</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id483768/">https://habr.com/ru/post/id483768/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id483754/index.html">Bagaimana cara mengukur peningkatan tim?</a></li>
<li><a href="../id483756/index.html">Kami membuat permintaan HTTP, menurunkan dengan anggun (dan bukan celah tunggal)</a></li>
<li><a href="../id483758/index.html">10 perusahaan pemula Pengembangan Aplikasi Seluler dapat bermitra pada tahun 2020</a></li>
<li><a href="../id483762/index.html">GitLab 12.6 Dirilis dengan Peringkat Keselamatan Proyek dan Materi Rilis</a></li>
<li><a href="../id483766/index.html">Pengadilan sebagai alat peretasan sosial atau sedikit tentang keandalan informasi dalam database WHOIS</a></li>
<li><a href="../id483774/index.html">Intisari acara untuk profesional SDM di bidang TI untuk Januari 2020</a></li>
<li><a href="../id483776/index.html">Pengantar metode diferensial semantik dalam 5 menit</a></li>
<li><a href="../id483778/index.html">Minggu Keamanan 03: Prinsip-prinsip Laporan Bug yang Bertanggung Jawab</a></li>
<li><a href="../id483780/index.html">Apa itu Kendur dan Bagaimana Cara Kerjanya?</a></li>
<li><a href="../id483784/index.html">Cara membuat aplikasi multi-tenant dari aplikasi non-tenant</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>