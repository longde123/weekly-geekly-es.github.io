<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚òπÔ∏è üöÜ üåÉ En cualquier situaci√≥n incomprensible - escriba guiones üßúüèΩ üë• üë®üèø‚Äçüç≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Los scripts son una de las formas m√°s comunes de hacer que una aplicaci√≥n sea m√°s flexible, con la capacidad de arreglar algo sobre la marcha. Por sup...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>En cualquier situaci√≥n incomprensible - escriba guiones</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/haulmont/blog/431084/"><img src="https://habrastorage.org/webt/a5/ng/5b/a5ng5b6thpfbxpcasm51swkuzgk.jpeg" alt="imagen"><br><br>  Los scripts son una de las formas m√°s comunes de hacer que una aplicaci√≥n sea m√°s flexible, con la capacidad de arreglar algo sobre la marcha.  Por supuesto, este enfoque tambi√©n tiene inconvenientes; siempre debe recordar el equilibrio entre flexibilidad y capacidad de administraci√≥n.  Pero en este art√≠culo no discutiremos "en general" sobre los pros y los contras del uso de scripts, consideraremos formas pr√°cticas de implementar este enfoque, y tambi√©n presentaremos una biblioteca que proporcione una infraestructura conveniente para agregar scripts a las aplicaciones escritas en Spring Framework. <br><a name="habracut"></a><br><h2>  Algunas palabras introductorias </h2><br>  Cuando desee agregar la capacidad de cambiar la l√≥gica de negocios en una aplicaci√≥n sin recompilaci√≥n y posterior implementaci√≥n, las secuencias de comandos son una de las formas que se le ocurren en primer lugar.  A menudo, los scripts aparecen no porque se pretend√≠a, sino porque sucedieron.  Por ejemplo, en la especificaci√≥n hay una parte de la l√≥gica que no est√° completamente clara en este momento, pero para no gastar un par de d√≠as adicionales (y a veces m√°s) para el an√°lisis, puede hacer un punto de extensi√≥n y llamar a un script: un trozo.  Y luego, por supuesto, este script se reescribir√° cuando los requisitos se aclaren. <br><br>  El m√©todo no es nuevo, y sus ventajas y desventajas son bien conocidas: flexibilidad: puede cambiar la l√≥gica en una aplicaci√≥n en ejecuci√≥n y ahorrar tiempo en una reinstalaci√≥n, pero, por otro lado, los scripts son m√°s dif√≠ciles de probar, de ah√≠ los posibles problemas de seguridad, rendimiento, etc. <br><br>  Esos trucos que se discutir√°n m√°s adelante pueden ser √∫tiles tanto para los desarrolladores que ya usan scripts en su aplicaci√≥n como para aquellos que simplemente est√°n pensando en ello. <br><br><h2>  Nada personal, solo secuencias de comandos </h2><br>  Con JSR-233, las secuencias de comandos Java se han vuelto muy simples.  Hay suficientes motores de secuencias de comandos basados ‚Äã‚Äãen esta API (Nashorn, JRuby, Jython y algunos m√°s), por lo que agregar un poco de magia de secuencias de comandos a su c√≥digo no es un problema: <br><br><pre><code class="java hljs">Map&lt;String, Object&gt; parameters = createParametersMap(); ScriptEngineManager manager = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ScriptEngineManager(); ScriptEngine scriptEngine = manager.getEngineByName(<span class="hljs-string"><span class="hljs-string">"groovy"</span></span>); Object result = scriptEngine.eval(script.getScriptAsString(<span class="hljs-string"><span class="hljs-string">"discount.groovy"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleBindings(parameters));</code> </pre> <br>  Obviamente, si dicho c√≥digo est√° disperso por toda la aplicaci√≥n, se convertir√° en algo incomprensible.  Y, por supuesto, si tiene m√°s de una llamada de script en su aplicaci√≥n, debe crear una clase separada para trabajar con ellos.  A veces puede ir a√∫n m√°s lejos y hacer clases especiales que encapsular√°n las llamadas <code>evaluateGroovy()</code> en m√©todos Java escritos con mecanograf√≠a.  Estos m√©todos tendr√°n un c√≥digo de utilidad bastante uniforme, como en el ejemplo: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BigDecimal </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">applyCustomerDiscount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Customer customer, BigDecimal orderAmount)</span></span></span><span class="hljs-function"> </span></span>{ Map&lt;String, Object&gt; params = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); params.put(<span class="hljs-string"><span class="hljs-string">"cust"</span></span>, customer); params.put(<span class="hljs-string"><span class="hljs-string">"amount"</span></span>, orderAmount); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (BigDecimal)scripting.evalGroovy(getScriptSrc(<span class="hljs-string"><span class="hljs-string">"discount.groovy"</span></span>), params); }</code> </pre><br>  Este enfoque aumenta en gran medida la transparencia al llamar scripts desde el c√≥digo de la aplicaci√≥n: puede ver de inmediato qu√© par√°metros acepta el script, de qu√© tipo son y qu√© se devuelve.  ¬°Lo principal es no olvidar agregar a los est√°ndares de escritura de c√≥digos una prohibici√≥n de llamar scripts que no sean de m√©todos escritos! <br><br><h2>  Bombeamos guiones </h2><br>  A pesar del hecho de que los scripts son simples, si tiene muchos y los usa intensivamente, existe una posibilidad real de encontrarse con problemas de rendimiento.  Por ejemplo, si usa un mont√≥n de plantillas geniales para generar informes y las ejecuta al mismo tiempo, tarde o temprano se convertir√° en uno de los cuellos de botella en el rendimiento de la aplicaci√≥n. <br>  Por lo tanto, muchos marcos crean varios complementos sobre la API est√°ndar para mejorar la velocidad del trabajo, el almacenamiento en cach√©, el monitoreo de la ejecuci√≥n, el uso de diferentes lenguajes de secuencias de comandos en una aplicaci√≥n, etc. <br><br>  Por ejemplo, se cre√≥ un motor de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">secuencias</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">comandos</a> bastante ingenioso en CUBA que admite caracter√≠sticas adicionales, como: <br><br><ol><li>  Capacidad para escribir scripts en Java y Groovy </li><li>  Cach√© de clase para no recompilar scripts </li><li>  JMX bin para controlar el motor </li></ol><br>  Todo esto, por supuesto, mejora el rendimiento y la usabilidad, pero a√∫n as√≠ el motor de bajo nivel sigue siendo de bajo nivel, y a√∫n necesita leer el texto del script, pasar par√°metros y llamar a la API para ejecutar el script.  Por lo tanto, a√∫n debe hacer alg√∫n tipo de envoltura en cada proyecto para que el desarrollo sea a√∫n m√°s eficiente. <br><br>  Y ser√≠a injusto no mencionar GraalVM, un motor experimental que puede ejecutar programas en diferentes idiomas (JVM y no JVM) y le permite insertar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">m√≥dulos en estos idiomas</a> en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aplicaciones Java</a> .  Espero que Nashorn pase a la historia tarde o temprano, y tengamos la oportunidad de escribir partes del c√≥digo en diferentes idiomas en una sola fuente.  Pero esto es solo un sue√±o. <br><br><h2>  Spring Framework: ¬øuna oferta dif√≠cil de rechazar? </h2><br>  Spring tiene soporte de ejecuci√≥n de script incorporado integrado sobre la API JDK.  En el paquete <code>org.springframework.scripting.*</code> , Puede encontrar muchas clases √∫tiles, todo para que pueda usar convenientemente la API de bajo nivel para las secuencias de comandos en su aplicaci√≥n. <br><br>  Adem√°s, hay un mayor nivel de soporte, se describe en detalle en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n</a> .  En resumen: debe crear una clase en un lenguaje de secuencias de comandos (por ejemplo, Groovy) y publicarla como un bean mediante una descripci√≥n XML: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">lang:groovy</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"messenger"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">script-source</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"classpath:Messenger.groovy"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">lang:property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"message"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"I Can Do The Frug"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">lang:groovy</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Una vez que se publica un bean, se puede agregar a sus clases usando IoC.  Spring proporciona una actualizaci√≥n autom√°tica de la secuencia de comandos al cambiar el texto en el archivo, puede colgar aspectos de m√©todos, etc. <br><br>  Se ve bien, pero necesita hacer clases "reales" para publicarlas, no puede escribir una funci√≥n regular en un script.  Adem√°s, los scripts solo se pueden almacenar en el sistema de archivos, para usar la base de datos que tiene que escalar dentro de Spring.  S√≠, y muchos consideran que la configuraci√≥n XML es obsoleta, especialmente si la aplicaci√≥n ya tiene todo en las anotaciones.  Esto, por supuesto, es aromatizante, pero a menudo hay que tener en cuenta. <br><br><h2>  Guiones: dificultades e ideas </h2><br>  Entonces, cada soluci√≥n tiene su propio precio, y si hablamos de scripts en aplicaciones Java, al introducir esta tecnolog√≠a, uno puede encontrar algunas dificultades: <br><br><ol><li>  Manejabilidad  A menudo, las llamadas de script est√°n dispersas por toda la aplicaci√≥n, y con los cambios en el c√≥digo es bastante dif√≠cil rastrear las llamadas de los scripts necesarios. </li><li>  Posibilidad de encontrar pares de marcado.  Si algo sale mal en un script en particular, entonces encontrar todos sus <code>evaluateGroovy()</code> marcado ser√° un problema, a menos que aplique una b√∫squeda por nombre de archivo o llamadas a m√©todos como <code>evaluateGroovy()</code> </li><li>  Transparencia  Escribir un gui√≥n no es una tarea f√°cil en s√≠ mismo, y a√∫n m√°s dif√≠cil es para aquellos que lo llaman.  Debe recordar c√≥mo se llaman los par√°metros de entrada, qu√© tipo de datos tienen y cu√°l es el resultado de la ejecuci√≥n.  O mire el c√≥digo fuente del script cada vez. </li><li>  Prueba y actualizaci√≥n: no siempre es posible probar el script en el entorno del c√≥digo de la aplicaci√≥n, e incluso despu√©s de cargarlo en el servidor de "batalla", de alguna manera debe poder deshacer r√°pidamente todo si algo sale mal. </li></ol><br>  Parece que las llamadas de script de ajuste en m√©todos Java ayudar√°n a resolver la mayor√≠a de los problemas anteriores.  Es muy bueno si tales clases pueden publicarse en el contenedor de IoC y llamar a m√©todos con nombres normales y significativos en sus servicios, en lugar de llamar a <code>eval(‚Äúdisc_10_cl.groovy‚Äù)</code> desde alguna clase de utilidad.  Otra ventaja es que el c√≥digo se documenta autom√°ticamente, el desarrollador no tiene que preguntarse qu√© tipo de algoritmo est√° oculto detr√°s del nombre del archivo. <br><br>  Adem√°s de eso, si cada secuencia de comandos se asociar√° con un solo m√©todo, puede encontrar r√°pidamente todos los pares de marcado en la aplicaci√≥n utilizando el men√∫ "Buscar usos" del IDE y comprender el lugar de la secuencia de comandos en cada algoritmo de l√≥gica de negocios espec√≠fico. <br><br>  Las pruebas se simplifican: se convierten en pruebas de clase "normales", utilizando marcos familiares, simulacros y m√°s. <br><br>  Todo lo anterior est√° muy en consonancia con la idea mencionada al principio del art√≠culo: clases "especiales" para los m√©todos implementados por scripts.  Pero, ¬øqu√© sucede si da un paso m√°s y oculta todo el c√≥digo de servicio del mismo tipo para llamar a los motores de script del desarrollador para que ni siquiera lo piense (bueno, casi)? <br><br><h2>  Repositorios de guiones - concepto </h2><br>  La idea es bastante simple y deber√≠a ser familiar para aquellos que al menos una vez trabajaron con Spring, especialmente con Spring JPA.  Lo que necesita es crear una interfaz Java y llamar al script cuando llame a sus m√©todos.  En JPA, por cierto, se utiliza un enfoque id√©ntico: la llamada a CrudRepository se intercepta, seg√∫n el nombre del m√©todo y los par√°metros, se crea una solicitud, que luego es ejecutada por el motor de la base de datos. <br><br>  ¬øQu√© se necesita para implementar el concepto? <br><br>  Primero, una anotaci√≥n de nivel de clase para que pueda encontrar la interfaz: el repositorio y hacer un bin basado en √©l. <br><br>  Adem√°s, las anotaciones sobre los m√©todos de esta interfaz probablemente ser√°n √∫tiles para almacenar los metadatos necesarios para llamar al m√©todo.  Por ejemplo: d√≥nde obtener el texto del script y qu√© motor utilizar. <br><br>  Una adici√≥n √∫til ser√° la capacidad de usar m√©todos con implementaci√≥n en la interfaz (tambi√©n conocido como predeterminado): este c√≥digo funcionar√° hasta que el analista de negocios muestre una versi√≥n m√°s completa del algoritmo y el desarrollador cree un script basado en <br>  Esta informaci√≥n.  O deje que el analista escriba el gui√≥n y el desarrollador simplemente lo copie en el servidor.  Hay muchas opciones :-) <br><br>  Entonces, supongamos que para una tienda en l√≠nea necesita hacer un servicio para calcular descuentos basados ‚Äã‚Äãen el perfil del usuario.  No est√° claro en este momento c√≥mo hacer esto, pero el analista de negocios jura que todos los usuarios registrados tienen derecho a un descuento del 10%, √©l descubrir√° el resto del cliente dentro de una semana.  El servicio es necesario ma√±ana, temporada despu√©s de todo.  ¬øC√≥mo se ver√≠a el c√≥digo para este caso? <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@ScriptRepository</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PricingRepository</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@ScriptMethod</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> BigDecimal </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">applyCustomerDiscount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Customer customer, BigDecimal orderAmount)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> orderAmount.multiply(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BigDecimal(<span class="hljs-string"><span class="hljs-string">"0.9"</span></span>)); } }</code> </pre><br>  Y luego el algoritmo en s√≠, escrito, por ejemplo, en groovy, llegar√° a tiempo, all√≠ los descuentos ser√°n ligeramente diferentes: <br><br><pre> <code class="plaintext hljs">def age = 50 if ((Calendar.YEAR - customer.birthday.year) &gt;= age) { return orderAmount.multiply(0.75) } else { return orderAmount.multiply(0.9) }</code> </pre><br>  El prop√≥sito de todo esto es dar al desarrollador la capacidad de escribir solo el c√≥digo de la interfaz y el c√≥digo del script, y no perder el tiempo con todas estas llamadas a <code>getEngine</code> , <code>eval</code> y otras.  La biblioteca para trabajar con scripts debe hacer toda la magia: interceptar la invocaci√≥n del m√©todo de interfaz, obtener el texto del script, sustituir los valores de los par√°metros, obtener el motor de script deseado, ejecutar el script (o llamar al m√©todo predeterminado si no hay texto del script) y devolver el valor.  Idealmente, adem√°s del c√≥digo que ya se ha escrito, el programa deber√≠a tener algo como esto: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomerServiceBean</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomerService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PricingRepository pricingRepository; <span class="hljs-comment"><span class="hljs-comment">//Other injected beans here @Override public BigDecimal applyCustomerDiscount(Customer cust, BigDecimal orderAmnt) { if (customer.isRegistered()) { return pricingRepository.applyCustomerDiscount(cust, orderAmnt); } else { return orderAmnt; } //Other service methods here }</span></span></code> </pre><br>  El desaf√≠o es legible, comprensible, y para hacerlo, uno no necesita tener ninguna habilidad especial. <br><br>  Estas fueron las ideas sobre las cuales se hizo una peque√±a biblioteca para trabajar con scripts.  Est√° destinado a aplicaciones Spring, este marco se utiliz√≥ para crear la biblioteca.  Proporciona una API extensible para cargar scripts de varias fuentes y ejecutarlos, lo que oculta el trabajo de rutina con los motores de scripts. <br><br><h2>  Como funciona </h2><br>  Para todas las interfaces marcadas con <code>@ScriptRepository</code> , los objetos proxy se crean durante la inicializaci√≥n del contexto Spring utilizando el m√©todo <code>newProxyInstance</code> de la clase <code>Proxy</code> .  Estos proxies se publican en el contexto de Spring como beans singleton, por lo que puede declarar un campo de clase con un tipo de interfaz y poner la anotaci√≥n <code>@Autowired</code> o <code>@Inject</code> en √©l.  Exactamente seg√∫n lo planeado. <br><br>  El escaneo y el procesamiento de las interfaces de script se activan mediante la anotaci√≥n <code>@EnableSriptRepositories</code> , de la misma manera que Spring activa JPA o repositorios para MongoDB ( <code>@EnableJpaRepositories</code> y <code>@EnableMongoRepositories</code> respectivamente).  Como par√°metros de anotaci√≥n, debe especificar una matriz con los nombres de los paquetes a escanear. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@EnableScriptRepositories</span></span>(basePackages = {<span class="hljs-string"><span class="hljs-string">"com.example"</span></span>, <span class="hljs-string"><span class="hljs-string">"com.sample"</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CoreConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//More configuration here. }</span></span></code> </pre><br>  Los m√©todos se deben anotar con <code>@ScriptMethod</code> (tambi√©n hay <code>@GroovyScript</code> y <code>@JavaScript</code> , con la especializaci√≥n correspondiente) para agregar metadatos para llamar al script.  Por supuesto, los m√©todos predeterminados en las interfaces son compatibles. <br><br>  La estructura general de la biblioteca se muestra en el diagrama.  Componentes resaltados en azul que deben desarrollarse, blanco, que ya est√°n en la biblioteca.  El icono de Spring marca los componentes que est√°n disponibles en el contexto de Spring. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rz/h0/xc/rzh0xc48cr_kw1d97y2i3wrbdvu.png"></div><br>  Cuando se llama al m√©todo de interfaz (de hecho, el objeto proxy), se inicia el controlador de llamadas, que en el contexto de la aplicaci√≥n busca dos beans: el proveedor, que buscar√° el texto del script, y el ejecutor, que, de hecho, se ejecutar√° el texto encontrado.  Luego, el controlador devuelve el resultado al m√©todo de llamada. <br><br>  Los nombres de <code>@ScriptMethod</code> proveedor y ejecutor se especifican en la anotaci√≥n <code>@ScriptMethod</code> , donde tambi√©n puede establecer un l√≠mite de tiempo para la ejecuci√≥n del m√©todo.  A continuaci√≥n se muestra un c√≥digo de uso de la biblioteca de muestra: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@ScriptRepository</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PricingRepository</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@ScriptMethod</span></span> (providerBeanName = <span class="hljs-string"><span class="hljs-string">"resourceProvider"</span></span>, evaluatorBeanName = <span class="hljs-string"><span class="hljs-string">"groovyEvaluator"</span></span>, timeout = <span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> BigDecimal </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">applyCustomerDiscount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( @ScriptParam(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"cust"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> Customer customer, @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ScriptParam</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"amount"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> BigDecimal orderAmount) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> orderAmount.multiply(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BigDecimal(<span class="hljs-string"><span class="hljs-string">"0.9"</span></span>)); } }</code> </pre><br>  Puede observar <code>@ScriptParam</code> anotaciones de <code>@ScriptParam</code> : son necesarias para indicar los nombres de los par√°metros al pasarlos al script, ya que el compilador de Java borra los nombres originales de las fuentes (hay formas de hacer que no lo haga, pero es mejor no confiar en √©l).  Puede omitir los nombres de los par√°metros, pero en este caso, deber√° usar "arg0", "arg1" en el script, lo que no mejora en gran medida la legibilidad. <br><br>  Por defecto, la biblioteca tiene proveedores para leer archivos .groovy y .js del disco y los ejecutores correspondientes, que son envoltorios sobre la API est√°ndar JSR-233.  Puede crear sus propios beans para diferentes fuentes de script y para diferentes motores, para esto necesita implementar las interfaces correspondientes: <code>ScriptProvider</code> y <code>SpringEvaluator</code> .  La primera interfaz usa <code>org.springframework.scripting.ScriptSource</code> y la segunda es <code>org.springframework.scripting.ScriptEvaluator</code> .  Se us√≥ Spring API para que las clases preparadas se pudieran usar si ya est√°n en la aplicaci√≥n. <br>  Se busca al proveedor y al artista por nombre para una mayor flexibilidad: puede reemplazar los beans est√°ndar de la biblioteca en su aplicaci√≥n nombrando sus componentes con los mismos nombres. <br><br><h2>  Pruebas y versiones </h2><br>  Debido a que los scripts cambian con frecuencia y facilidad, debe tener una manera de asegurarse de que los cambios no rompan nada.  La biblioteca es compatible con JUnit, el repositorio simplemente se puede probar como una clase regular como parte de una unidad o prueba de integraci√≥n.  Las bibliotecas simuladas tambi√©n son compatibles, en las pruebas para la biblioteca puede encontrar un ejemplo de c√≥mo hacer simulacros en el m√©todo del repositorio de scripts. <br><br>  Si se necesitan versiones, puede crear un proveedor que lea diferentes versiones de scripts del sistema de archivos, de la base de datos o de Git, por ejemplo.  Por lo tanto, ser√° f√°cil organizar una reversi√≥n a la versi√≥n anterior del script en caso de problemas en el servidor principal. <br><br><h2>  Total </h2><br>  La biblioteca presentada ayudar√° a organizar los scripts en la aplicaci√≥n Spring: <br><br><ol><li>  El desarrollador siempre tendr√° informaci√≥n sobre qu√© par√°metros necesitan los scripts y qu√© se devuelve.  Y si los m√©todos de la interfaz tienen un nombre significativo, entonces lo que hace el script. </li><li>  Los proveedores y ejecutores ayudar√°n a mantener el c√≥digo para recibir scripts e interactuar con el motor de scripts en un solo lugar y estas llamadas no se distribuir√°n por todo el c√≥digo de la aplicaci√≥n. </li><li>  Todas las llamadas de guiones se pueden encontrar f√°cilmente utilizando Buscar usos. </li></ol><br>  Se admite la configuraci√≥n autom√°tica de Spring Boot, pruebas de unidad, simulacro.  Puede obtener datos sobre los m√©todos de "script" y sus par√°metros a trav√©s de la API.  Y tambi√©n puede ajustar el resultado de la ejecuci√≥n con un objeto ScriptResult especial, en el que habr√° un resultado o una instancia de excepci√≥n si no desea molestarse con try ... catch al invocar scripts.  La configuraci√≥n XML es compatible si se requiere por una raz√≥n u otra.  Y finalmente, puede especificar un tiempo de espera para el m√©todo de secuencia de comandos, si surge la necesidad. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Las fuentes de la biblioteca est√°n aqu√≠.</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es431084/">https://habr.com/ru/post/es431084/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es431074/index.html">Gu√≠a de JavaScript, Parte 8: Descripci√≥n general de las caracter√≠sticas de ES6</a></li>
<li><a href="../es431076/index.html">Los frameworks Node.js m√°s populares de 2018</a></li>
<li><a href="../es431078/index.html">Gu√≠a de manejo de errores de JavaScript</a></li>
<li><a href="../es431080/index.html">C√≥mo organizar oficinas remotas y no perder un equipo en el espacio</a></li>
<li><a href="../es431082/index.html">Kotlin: buscando jefe de marketing</a></li>
<li><a href="../es431086/index.html">Todo lo que quer√≠a saber sobre PVS-Studio y no dud√≥ en preguntar</a></li>
<li><a href="../es431088/index.html">La gesti√≥n de archivos se hizo mal - Parte 1: Originalmente de los a√±os 90</a></li>
<li><a href="../es431090/index.html">Un bot VK, un C # y una naranja</a></li>
<li><a href="../es431092/index.html">ROS: mapa de profundidad en la Raspberry Pi "sangre baja"</a></li>
<li><a href="../es431094/index.html">Solitario Ordenar</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>