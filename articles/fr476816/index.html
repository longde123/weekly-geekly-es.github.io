<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîØ üèÜ ü§ûüèæ Dubai Mall dans un smartphone, ou comment ajouter un plan d'√©tage d'un b√¢timent √† votre application üíü ü§∏üèΩ üëΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans un article pr√©c√©dent, j'ai expliqu√© comment cr√©er une application mobile avec une carte. Dans la suite de la s√©rie "√† genoux" je partagerai avec ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Dubai Mall dans un smartphone, ou comment ajouter un plan d'√©tage d'un b√¢timent √† votre application</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/2gis/blog/476816/"><img src="https://habrastorage.org/webt/lq/cz/8s/lqcz8slsffexqi-rc0n0bovyyju.jpeg"><br><br>  Dans un <a href="https://habr.com/ru/company/2gis/blog/453182/">article pr√©c√©dent,</a> j'ai expliqu√© comment cr√©er une application mobile avec une carte.  Dans la suite de la s√©rie "√† genoux" je partagerai avec vous les outils de mise en ≈ìuvre des plans d'√©tage. <br><br>  L'√©nonc√© initial du probl√®me sous une forme simplifi√©e: je veux pouvoir visualiser le diagramme d'√©tage dans votre application mobile et pouvoir y montrer l'emplacement d'une organisation particuli√®re.  J'aimerais aussi voir l'emplacement de l'utilisateur, mais ici le probl√®me est dans le plan technique - vous avez besoin d'un √©quipement qui vous permettra d'obtenir les coordonn√©es de l'appareil √† l'int√©rieur.  Nous laissons donc cet aspect hors du champ de l'article et nous concentrons sur la partie logicielle. <br><br>  Ci-dessous, je vais vous montrer plusieurs options avec lesquelles vous pouvez impl√©menter les exigences d√©crites ci-dessus.  Tout d√©pend des donn√©es dont vous disposez et de ce que l'application devrait √™tre en mesure de faire.  Et nous allons commencer par le plus simple. <br><a name="habracut"></a><br><h3>  La premi√®re option.  API pr√™te avec donn√©es </h3><br>  La premi√®re option que nous consid√©rerons est l'utilisation d'un widget pr√™t √† l'emploi de 2GIS.  La description de l'API peut √™tre consult√©e sur <a href="https://api.2gis.ru/">api.2gis.ru.</a>  Cela vous conviendra si le b√¢timent qui vous int√©resse est d√©j√† pr√©sent√© dans 2GIS et que les √©tages ont d√©j√† √©t√© dessin√©s dans le b√¢timent.  Autrement dit, en termes de donn√©es, tout a d√©j√† √©t√© fait.  Et surtout, vous √™tes pr√™t pour la connexion en ligne, car cette option fonctionnera exclusivement avec Internet. <br><br>  Pour afficher les sols dans ce cas, pratiquement rien n'est exig√© de vous.  Impl√©mentation de l'ex√©cution en tant que widget Web, que vous n'avez qu'√† ins√©rer dans WebView. <br><br><pre><code class="java hljs">&lt;WebView android:layout_width=<span class="hljs-string"><span class="hljs-string">"match_parent"</span></span> android:layout_height=<span class="hljs-string"><span class="hljs-string">"match_parent"</span></span> android:id=<span class="hljs-string"><span class="hljs-string">"@+id/am_webview"</span></span> android:layout_marginTop=<span class="hljs-string"><span class="hljs-string">"160dp"</span></span> /&gt;</code> </pre> <br>  Ceci est le conteneur dans lequel nous placerons notre widget.  Nous l'initialisons comme suit: <br><br><pre> <code class="kotlin hljs">webView = findViewById(R.id.am_webview) webView.settings.javaScriptEnabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span> webView.settings.useWideViewPort = <span class="hljs-literal"><span class="hljs-literal">true</span></span> webView.settings.loadWithOverviewMode = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-comment"><span class="hljs-comment">//webView.settings.setSupportZoom(true) //webView.settings.displayZoomControls = true //webView.settings.builtInZoomControls = true webView.loadUrl("file:///android_asset/map_api.html") webView.webViewClient = object : WebViewClient() { override fun onPageFinished(view: WebView, url: String) { super.onPageFinished(view, url) val js = "initMap('13933647002593772');" // The Dubai Mall webView.evaluateJavascript(js, ValueCallback { }) } }</span></span></code> </pre><br>  Nous configurons le webView lui-m√™me, assurez-vous d'activer JavaScript, javaScriptEnabled = true, car nous interagirons avec le widget √† travers lui.  Si n√©cessaire, vous pouvez activer les barres de d√©filement et les boutons de zoom (voir le code comment√©), mais cela ne fonctionne pas tr√®s bien, donc je ne le recommande pas. <br><br>  La chose la plus importante est de charger le HTML avec notre widget <i>webView.loadUrl ("fichier: ///android_asset/map_api.html")</i> et de vous abonner aux √©v√©nements, si n√©cessaire.  Dans l'exemple ci-dessus, apr√®s avoir charg√© la carte, nous appelons la m√©thode <i>initMap</i> d√©finie dans map_api.html, en passant l'identifiant du b√¢timent pour lequel nous voulons afficher les √©tages. <br><br>  HTML est un code assez simple.  La m√©thode <i>DG.FloorsWidget.init</i> est <i>appel√©e</i> , dans laquelle l'objet json contenant les donn√©es √† initialiser est pass√©.  En tant que conteneur, sp√©cifiez l'id avec lequel nous avons d√©clar√© un div dans le balisage HTML ci-dessus.  Ajustez la largeur, la hauteur.  Et dans <i>initData, nous</i> transmettons le b√¢timent dans la balise <i>complexId</i> et des param√®tres d'affichage de widget suppl√©mentaires, qui peuvent √™tre trouv√©s dans la documentation de l'API.  Soit dit en passant, l'identifiant peut √™tre vu en r√©ponse √† la requ√™te de recherche, que 2GIS envoie lorsque vous cliquez sur le b√¢timent qui vous int√©resse sur <a href="http://2gis.ru/">2gis.ru.</a>  Dans mon exemple, j'ai utilis√© le Dubai Mall.  Mais personne ne se soucie d'indiquer un autre b√¢timent avec des planchers. <br><br>  La touche finale.  Pour passer √† une entreprise sp√©cifique, appelez la m√©thode showFirm, en passant l'identifiant de l'entreprise <br><br><pre> <code class="kotlin hljs">webView.loadUrl(<span class="hljs-string"><span class="hljs-string">"javascript:showFirm('</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$firmId</span></span></span><span class="hljs-string">')"</span></span>)</code> </pre> <br><br>  C'est assez simple.  Un exemple d'impl√©mentation pr√™t √† l'emploi peut √™tre consult√© sur <a href="https://github.com/viloboda/android-2gis-tiles">Github</a> . <br><br><img src="https://habrastorage.org/webt/dj/wr/kt/djwrkts1gbnmjcatdunldu_hoam.gif"><br><br>  Avantages de l'option envisag√©e: <br><br><ul><li>  des donn√©es toutes faites avec des plans d'√©tage et des donn√©es d'entreprise; </li><li>  mise en ≈ìuvre l√©g√®re pr√™te √† l'emploi sur la visualisation Web; </li><li>  recherche pr√™te selon 2GIS. </li></ul><br>  Inconv√©nients: <br><br><ul><li>  Internet requis; </li><li>  une connaissance de base de HTML et JavaScript est requise; </li><li>  seules les donn√©es 2GIS et uniquement les b√¢timents qui ont d√©j√† des √©tages. </li></ul><br><h3>  La deuxi√®me option.  Plan d'√©tage en image </h3><br>  Si l'option avec des donn√©es pr√™tes et l'API ne vous convient pas, vous pouvez utiliser ce qui suit. <br><br>  Dans ce cas, vous aurez besoin d'un plan d'√©tage sous la forme d'une image, disons jpeg ou png.  Si une interactivit√© du type "enfonc√© dans l'image - a ouvert la carte d'objet" est requise, alors le g√©ocodage sera √©galement n√©cessaire, qui devra √™tre mis en ≈ìuvre ind√©pendamment.  Si vous accrochez aux coordonn√©es globales, l'image doit √™tre correctement mise √† l'√©chelle et l'un des coins doit √™tre tir√© aux coordonn√©es r√©elles afin que vous puissiez calculer les d√©placements √† partir de celle-ci.  Nous ne nous attarderons pas sur cette question en d√©tail, j'esp√®re que tout est clair ici. <br><br>  La chose la plus importante est de montrer cette image dans l'application.  Et pour cela, la biblioth√®que <a href="https://github.com/moagrius/TileView">TileView</a> est id√©ale pour nous.  En fait, cette biblioth√®que permet, en principe, d'afficher des tuiles de carte.  Mais cela nous convient aussi, car il offre la possibilit√© de se d√©placer et de zoomer, de se centrer dans une position sp√©cifi√©e, d'afficher des marqueurs, de transformer les coordonn√©es et de s'abonner √† divers √©v√©nements. <br><br>  Pour que la biblioth√®que fonctionne le plus efficacement possible, l'image originale doit √™tre pr√©par√©e en la d√©coupant en tuiles.  Il existe une <a href="https://github.com/moagrius/TileView/wiki/Creating-Tiles">instruction</a> assez simple <a href="https://github.com/moagrius/TileView/wiki/Creating-Tiles">pour cela</a> .  Je recommande un script √† la fin de la page sp√©cifi√©e qui cr√©era 4 ensembles de tuiles.  Nous ajoutons le r√©sultat obtenu aux actifs et affichons notre image dans l'activit√© avec un code simple: <br><br><pre> <code class="kotlin hljs">tileView.setSize(floorWidth, floorHeight) tileView.setShouldRenderWhilePanning(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) tileView.addDetailLevel(<span class="hljs-number"><span class="hljs-number">1f</span></span>, <span class="hljs-string"><span class="hljs-string">"tiles/floors1/1000/%d_%d.jpg"</span></span>) tileView.addDetailLevel(<span class="hljs-number"><span class="hljs-number">0.500f</span></span>, <span class="hljs-string"><span class="hljs-string">"tiles/floors1/500/%d_%d.jpg"</span></span>) tileView.addDetailLevel(<span class="hljs-number"><span class="hljs-number">0.250f</span></span>, <span class="hljs-string"><span class="hljs-string">"tiles/floors1/250/%d_%d.jpg"</span></span>) tileView.addDetailLevel(<span class="hljs-number"><span class="hljs-number">0.125f</span></span>, <span class="hljs-string"><span class="hljs-string">"tiles/floors1/125/%d_%d.jpg"</span></span>) tileView.defineBounds(<span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, floorWidth.toDouble(), floorHeight.toDouble()) tileView.setScaleLimits(<span class="hljs-number"><span class="hljs-number">0f</span></span>, <span class="hljs-number"><span class="hljs-number">5f</span></span>) tileView.setMinimumScaleMode(ZoomPanLayout.MinimumScaleMode.FIT)</code> </pre><br>  Tout, l'√©cran est pr√™t.  Vous pouvez vous abonner aux √©v√©nements et ajouter la logique n√©cessaire.  Par exemple, un marqueur peut √™tre affich√© comme ceci: <br><br><pre> <code class="kotlin hljs">tileView.setMarkerAnchorPoints(-<span class="hljs-number"><span class="hljs-number">0.5f</span></span>, -<span class="hljs-number"><span class="hljs-number">0.5f</span></span>) tileView.addMarker(imageView, x, floorHeight - y, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>)</code> </pre><br>  Un exemple complet est disponible sur <a href="https://github.com/viloboda/TileViewExample">Github</a> . <br><br><img src="https://habrastorage.org/webt/tb/29/bn/tb29bnjnkmnbvm5qwyjx5zztutw.gif"><br><br>  Avantages: <br><br><ul><li>  la possibilit√© de faire compl√®tement hors ligne; </li><li>  pr√©paration des donn√©es relativement simple, plan d'√©tage sous forme d'image. </li></ul><br>  Inconv√©nients: <br><br><ul><li>  manque de style dynamique. </li></ul><br><h3>  La troisi√®me option.  Donn√©es vectorielles </h3><br>  Cette option est la plus avanc√©e et la plus difficile.  Il suppose que vous avez pr√©par√© des donn√©es vectorielles, c'est-√†-dire des sols compl√®tement dessin√©s dans le vecteur.  Vous aurez besoin de plusieurs types d'objets.  Zones d'organisations, parkings, aires de restauration, sc√®nes, patinoires, etc.  Objets lin√©aires - principalement murs, directions d'√©coulement.  Objets ponctuels: entr√©es / sorties, ascenseurs, distributeurs automatiques de billets et similaires. <br><br>  Voici √† quoi ressemble un plan d'√©tage aux Fidji, syst√®me interne 2GIS: <br><br><img src="https://habrastorage.org/webt/dz/kg/uc/dzkguc7hmkwyjw2ymcaqufvkwbs.png"><br><br>  Eh bien, pour leur visualisation, le moteur vectoriel, dont j'ai parl√© dans l' <a href="https://habr.com/ru/company/2gis/blog/453182/">article pr√©c√©dent</a> , mapsforge-vtm nous convient. <br><br>  Pour d√©montrer l'approche, j'ai pr√©par√© des donn√©es de test: un ensemble de carr√©s et de lignes pour plusieurs √©tages en utilisant l'exemple d'un b√¢timent sur l'√Æle ensoleill√©e de Chypre.  Pour la pr√©paration, j'ai pris la g√©om√©trie d'origine du b√¢timent et je l'ai d√©coup√©e en morceaux correspondant aux composants de la g√©om√©trie, uniquement pour des raisons de simplicit√©.  Comme vous le savez, la partie la plus difficile est la pr√©paration de donn√©es de qualit√©.  Le reste est une question de technologie.  Vous aurez besoin de boutons pour changer d'√©tage, de styles pr√©par√©s pour le rendu de diff√©rents carr√©s et lignes et d'une superposition pour les rendre. <br><br>  Voir le code complet <a href="http://github.com/viloboda/MapMobileApp">ici</a> . <br><br>  La classe <i>FloorData</i> contient le code de g√©odonn√©es de test pour nos sols, et la classe <i>FloorsManager est</i> con√ßue pour les rendre. <br><br>  Dans le constructeur, nous d√©finissons des styles pour les carr√©s et les murs: <br><br><pre> <code class="kotlin hljs">styles.put(ObjectType.Floor, org.oscim.layers.vector.geometries.Style.builder() .fillColor(Color.GRAY) .build());</code> </pre><br>  Et dans la m√©thode <i>drawFloor</i> , <i>nous</i> d√©terminons la logique de l'ajout d'objets aux couches sur la carte: <br><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void drawFloor(int floorId) { hideFloors(); indoorLayer = new CustomVectorLayer(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.map); List&lt;GeoData&gt; geoObjects = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.floorData.getFloorData(floorId); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (GeoData geo: geoObjects) { indoorLayer.add(geo.getGeometry(), styles.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(geo.getObjectType())); } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.map.layers().add(indoorLayer); indoorLayer.update(); }</code> </pre><br>  Ici, tout est √©l√©mentaire.  Cr√©ez une nouvelle couche <i>indoorLayer</i> , ajoutez-y des donn√©es d'√©tage pr√©-pr√©par√©es avec les styles n√©cessaires et ajoutez la couche √† la carte <i>this.map.layers (). Ajoutez (indoorLayer)</i> . <br><br>  Reste √† ajouter des boutons pour changer d'√©tage.  Pour ce faire, il existe un <i>FloorPickerControl</i> bas√© sur <i>RecyclerView</i> , qui fait exactement ce dont vous avez besoin.  Ne perdons pas de temps dessus, voir la source. <br><br>  Et voici le Dubai Mall dans notre application.  Il a √©galement impl√©ment√© la modification des objets g√©ographiques. <br><br><img src="https://habrastorage.org/webt/bt/nn/ah/btnnahpkbpactvr2ywt4tflwh-w.png"><br><br>  Avantages: <br><br><ul><li>  encore une fois, la possibilit√© de faire compl√®tement hors ligne; </li><li>  image de haute qualit√©; </li><li>  la possibilit√© d'une vari√©t√© de stylisation dynamique; </li><li>  la possibilit√© d'impl√©menter un √©diteur de donn√©es. </li></ul><br>  Inconv√©nients: <br><br><ul><li>  pr√©paration de donn√©es complexes. </li></ul><br>  √Ä la fin de l'article, je tiens √† dire que la t√¢che d'afficher les plans d'√©tage dans l'application n'est pas aussi terrible que cela puisse para√Ætre √† premi√®re vue.  Vous avez plusieurs options avec vos avantages et vos inconv√©nients, parmi lesquels vous pouvez choisir la plus appropri√©e pour r√©soudre votre probl√®me. <br><br>  Toutes les r√©f√©rences en un seul endroit: <br><br>  <a href="https://habr.com/ru/company/2gis/blog/453182/">Article sur la carte dans le mobile</a> <br>  <a href="https://api.2gis.ru/">API 2GIS</a> <br>  <a href="https://github.com/viloboda/android-2gis-tiles">Exemple d'API 2GIS</a> <br>  <a href="https://github.com/moagrius/TileView">Biblioth√®que TileView</a> <br>  <a href="https://github.com/viloboda/TileViewExample">Exemple TileView</a> <br>  <a href="http://github.com/viloboda/MapMobileApp">Un exemple sur mapsforge-vtm</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr476816/">https://habr.com/ru/post/fr476816/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr476792/index.html">Swift.assert - la vie apr√®s la lib√©ration</a></li>
<li><a href="../fr476796/index.html">R√©flexions sur le corps parfait</a></li>
<li><a href="../fr476798/index.html">Nous √©tudions l'assemblage de la puce RAM sur l'exemple de Hynix GDDR3 SDRAM</a></li>
<li><a href="../fr476806/index.html">MPS 2019.2: types de donn√©es √©num√©r√©s, personnalisation des messages d'erreur, transition vers JDK 11 et bien plus</a></li>
<li><a href="../fr476812/index.html">Notes sur tout. Alimentations simples et dangereuses</a></li>
<li><a href="../fr476824/index.html">McKinsey: repenser l'architecture logicielle et √©lectronique de l'automobile</a></li>
<li><a href="../fr476826/index.html">Exp√©riences multiples: th√©orie et pratique</a></li>
<li><a href="../fr476828/index.html">Op√©ration "Migration": comment se passe le cloud DataLine</a></li>
<li><a href="../fr476830/index.html">Comment impl√©menter les fonctions de l'utilitaire JavaScript √† l'aide de Reduce?</a></li>
<li><a href="../fr476834/index.html">Red Hat OpenShift 4.2: nouveaux outils</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>