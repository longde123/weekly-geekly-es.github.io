<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèæ‚Äç‚öïÔ∏è ü§öüèª üî∑ Compilaci√≥n de C en WebAssembly sin Emscripten ‚òπÔ∏è üéüÔ∏è üê¢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El compilador es parte de Emscripten . Pero, ¬øqu√© pasa si quitas todos los silbatos y solo lo dejas? 

 Se requiere Emscripten para compilar C / C ++ ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Compilaci√≥n de C en WebAssembly sin Emscripten</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454868/"> El compilador es parte de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Emscripten</a> .  Pero, ¬øqu√© pasa si quitas todos los silbatos y solo lo dejas? <br><br>  Se requiere Emscripten para compilar C / C ++ en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">WebAssembly</a> .  Pero esto es mucho m√°s que un simple compilador.  El objetivo de Emscripten es reemplazar completamente su compilador C / C ++ y ejecutar c√≥digo en la web que <b>no</b> est√° <b>dise√±ado</b> originalmente para la Web.  Para esto, Emscripten emula todo el sistema operativo POSIX.  Si el programa usa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">fopen ()</a> , Emscripten proporcionar√° la emulaci√≥n del sistema de archivos.  Si se utiliza OpenGL, Emscripten proporcionar√° un contexto GL compatible con C compatible con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">WebGL</a> .  Esto es mucho trabajo y mucho c√≥digo que deber√° implementarse en el paquete final.  Pero, ¬øpuedes simplemente ... eliminarlo? <br><a name="habracut"></a><br>  El <i>compilador</i> real en el kit de herramientas Emscripten es LLVM.  Es √©l quien traduce el c√≥digo C al c√≥digo de bytes de WebAssembly.  Este es un marco modular moderno para el an√°lisis, transformaci√≥n y optimizaci√≥n de programas.  LLVM es modular en el sentido de que nunca se compila directamente en el c√≥digo de la m√°quina.  En cambio, el <i>compilador front-end</i> incorporado genera <i>una representaci√≥n intermedia</i> (IR).  Esta representaci√≥n intermedia, de hecho, se llama LLVM, una abreviatura de m√°quina virtual de bajo nivel, de ah√≠ el nombre del proyecto. <br><br>  El <i>compilador de fondo</i> traduce el IR al c√≥digo de m√°quina host.  La ventaja de esta separaci√≥n estricta es que las nuevas arquitecturas son compatibles con la adici√≥n "simple" de un nuevo compilador.  En este sentido, WebAssembly es solo uno de los muchos objetivos de compilaci√≥n que admite LLVM, y durante alg√∫n tiempo se ha activado con un indicador especial.  A partir de LLVM 8, el objetivo de compilaci√≥n de WebAssembly est√° disponible de forma predeterminada. <br><br>  En MacOS, puede instalar LLVM usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">homebrew</a> : <br><br><pre><code class="bash hljs">$ brew install llvm $ brew link --force llvm</code> </pre> <br>  Consulte el soporte de WebAssembly: <br><br><pre> <code class="bash hljs">$ llc --version LLVM (http://llvm.org/): LLVM version 8.0.0 Optimized build. Default target: x86_64-apple-darwin18.5.0 Host CPU: skylake Registered Targets: <span class="hljs-comment"><span class="hljs-comment"># ‚Ä¶,  ‚Ä¶ systemz - SystemZ thumb - Thumb thumbeb - Thumb (big endian) wasm32 - WebAssembly 32-bit # ! ! ! wasm64 - WebAssembly 64-bit x86 - 32-bit X86: Pentium-Pro and above x86-64 - 64-bit X86: EM64T and AMD64 xcore - XCore</span></span></code> </pre> <br>  Parece que estamos listos! <br><br><h1>  Compilando C de la manera dif√≠cil </h1><br><blockquote>  <b>Nota:</b> aqu√≠ hay algunos formatos RAW WebAssembly de bajo nivel.  Si le resulta dif√≠cil de entender, esto es normal.  <b>El buen uso de WebAssembly no requiere una comprensi√≥n del texto completo en este art√≠culo.</b>  <b>Si est√° buscando c√≥digo para copiar y pegar, consulte la llamada al compilador en la secci√≥n Optimizaci√≥n</b> .  Pero si te interesa, ¬°sigue leyendo!  Anteriormente escrib√≠ una introducci√≥n a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Webassembly puro</a> y WAT: estos son los conceptos b√°sicos necesarios para comprender esta publicaci√≥n. </blockquote>  Advertencia: Me desviar√© un poco del est√°ndar e intentar√© utilizar formatos legibles por humanos en cada paso (en la medida de lo posible).  Nuestro programa aqu√≠ ser√° muy simple para evitar situaciones fronterizas y no distraerse: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Filename: add.c int add(int a, int b) { return a*a + b; }</span></span></code> </pre> <br>  ¬°Qu√© magn√≠fica haza√±a de ingenier√≠a!  Especialmente porque el programa se llama <i>agregar</i> , pero en realidad no <i>agrega</i> nada (no agrega).  M√°s importante: el programa no usa la biblioteca est√°ndar, y de los tipos aqu√≠, solo 'int'. <br><br><h3>  Convertir C en una vista LLVM interna </h3><br>  El primer paso es convertir nuestro programa C en LLVM IR.  Esta es la tarea del compilador frontend <code>clang</code> , que se instala con LLVM: <br><br><pre> <code class="bash hljs">clang \ --target=wasm32 \ <span class="hljs-comment"><span class="hljs-comment"># Target WebAssembly -emit-llvm \ # Emit LLVM IR (instead of host machine code) -c \ # Only compile, no linking just yet -S \ # Emit human-readable assembly rather than binary add.c</span></span></code> </pre> <br>  Y como resultado, obtenemos <code>add.ll</code> con una representaci√≥n interna de LLVM IR.  <b>Lo muestro solo en aras de la integridad</b> .  Al trabajar con WebAssembly o incluso clang, usted como desarrollador C nunca entrar√° en contacto con LLVM IR. <br><br><pre> <code class="cpp hljs">; ModuleID = <span class="hljs-string"><span class="hljs-string">'add.c'</span></span> source_filename = <span class="hljs-string"><span class="hljs-string">"add.c"</span></span> target datalayout = <span class="hljs-string"><span class="hljs-string">"em:ep:32:32-i64:64-n32:64-S128"</span></span> target triple = <span class="hljs-string"><span class="hljs-string">"wasm32"</span></span> ; Function Attrs: norecurse nounwind readnone define hidden i32 @add(i32, i32) local_unnamed_addr #<span class="hljs-number"><span class="hljs-number">0</span></span> { %<span class="hljs-number"><span class="hljs-number">3</span></span> = mul nsw i32 %<span class="hljs-number"><span class="hljs-number">0</span></span>, %<span class="hljs-number"><span class="hljs-number">0</span></span> %<span class="hljs-number"><span class="hljs-number">4</span></span> = add nsw i32 %<span class="hljs-number"><span class="hljs-number">3</span></span>, %<span class="hljs-number"><span class="hljs-number">1</span></span> ret i32 %<span class="hljs-number"><span class="hljs-number">4</span></span> } attributes #<span class="hljs-number"><span class="hljs-number">0</span></span> = { norecurse nounwind readnone <span class="hljs-string"><span class="hljs-string">"correctly-rounded-divide-sqrt-fp-math"</span></span>=<span class="hljs-string"><span class="hljs-string">"false"</span></span> <span class="hljs-string"><span class="hljs-string">"disable-tail-calls"</span></span>=<span class="hljs-string"><span class="hljs-string">"false"</span></span> <span class="hljs-string"><span class="hljs-string">"less-precise-fpmad"</span></span>=<span class="hljs-string"><span class="hljs-string">"false"</span></span> <span class="hljs-string"><span class="hljs-string">"min-legal-vector-width"</span></span>=<span class="hljs-string"><span class="hljs-string">"0"</span></span> <span class="hljs-string"><span class="hljs-string">"no-frame-pointer-elim"</span></span>=<span class="hljs-string"><span class="hljs-string">"false"</span></span> <span class="hljs-string"><span class="hljs-string">"no-infs-fp-math"</span></span>=<span class="hljs-string"><span class="hljs-string">"false"</span></span> <span class="hljs-string"><span class="hljs-string">"no-jump-tables"</span></span>=<span class="hljs-string"><span class="hljs-string">"false"</span></span> <span class="hljs-string"><span class="hljs-string">"no-nans-fp-math"</span></span>=<span class="hljs-string"><span class="hljs-string">"false"</span></span> <span class="hljs-string"><span class="hljs-string">"no-signed-zeros-fp-math"</span></span>=<span class="hljs-string"><span class="hljs-string">"false"</span></span> <span class="hljs-string"><span class="hljs-string">"no-trapping-math"</span></span>=<span class="hljs-string"><span class="hljs-string">"false"</span></span> <span class="hljs-string"><span class="hljs-string">"stack-protector-buffer-size"</span></span>=<span class="hljs-string"><span class="hljs-string">"8"</span></span> <span class="hljs-string"><span class="hljs-string">"target-cpu"</span></span>=<span class="hljs-string"><span class="hljs-string">"generic"</span></span> <span class="hljs-string"><span class="hljs-string">"unsafe-fp-math"</span></span>=<span class="hljs-string"><span class="hljs-string">"false"</span></span> <span class="hljs-string"><span class="hljs-string">"use-soft-float"</span></span>=<span class="hljs-string"><span class="hljs-string">"false"</span></span> } !llvm.<span class="hljs-keyword"><span class="hljs-keyword">module</span></span>.flags = !{!<span class="hljs-number"><span class="hljs-number">0</span></span>} !llvm.ident = !{!<span class="hljs-number"><span class="hljs-number">1</span></span>} !<span class="hljs-number"><span class="hljs-number">0</span></span> = !{i32 <span class="hljs-number"><span class="hljs-number">1</span></span>, !<span class="hljs-string"><span class="hljs-string">"wchar_size"</span></span>, i32 <span class="hljs-number"><span class="hljs-number">4</span></span>} !<span class="hljs-number"><span class="hljs-number">1</span></span> = !{!<span class="hljs-string"><span class="hljs-string">"clang version 8.0.0 (tags/RELEASE_800/final)"</span></span>}</code> </pre> <br>  <i>LLVM IR est√° lleno de metadatos y anotaciones adicionales, lo que permite al compilador tomar decisiones m√°s informadas al generar c√≥digo de m√°quina.</i> <br><br><h3>  Convierta LLVM IR en archivos de objetos </h3><br>  El siguiente paso es llamar al compilador de back-end de <code>llc</code> para hacer un archivo objeto desde la representaci√≥n interna. <br><br>  El archivo de salida <code>add.o</code> ya es un m√≥dulo de WebAssembly v√°lido que contiene todo el c√≥digo compilado de nuestro archivo C. Pero, por lo general, no podr√° ejecutar archivos de objetos porque carecen de partes esenciales. <br><br>  Si omitimos <code>-filetype=obj</code> en el comando, obtendr√≠amos el ensamblador LLVM para WebAssembly, un formato legible por humanos que es algo similar a WAT.  Sin embargo, la herramienta <code>llvm-mc</code> para trabajar con dichos archivos a√∫n no es totalmente compatible con el formato y, a menudo, no puede procesar archivos.  Por lo tanto, desmontamos los archivos de objetos despu√©s del hecho.  Se necesita una herramienta espec√≠fica para verificar estos archivos de objetos.  En el caso de WebAssembly, era <code>wasm-objdump</code> , parte del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">kit de herramientas binarias de WebAssembly</a> o wabt para abreviar. <br><br><pre> <code class="bash hljs">$ brew install wabt <span class="hljs-comment"><span class="hljs-comment"># in case you haven't $ wasm-objdump -x add.o add.o: file format wasm 0x1 Section Details: Type[1]: - type[0] (i32, i32) -&gt; i32 Import[3]: - memory[0] pages: initial=0 &lt;- env.__linear_memory - table[0] elem_type=funcref init=0 max=0 &lt;- env.__indirect_function_table - global[0] i32 mutable=1 &lt;- env.__stack_pointer Function[1]: - func[0] sig=0 &lt;add&gt; Code[1]: - func[0] size=75 &lt;add&gt; Custom: - name: "linking" - symbol table [count=2] - 0: F &lt;add&gt; func=0 binding=global vis=hidden - 1: G &lt;env.__stack_pointer&gt; global=0 undefined binding=global vis=default Custom: - name: "reloc.CODE" - relocations for section: 3 (Code) [1] R_WASM_GLOBAL_INDEX_LEB offset=0x000006(file=0x000080) symbol=1 &lt;env.__stack_pointer&gt;</span></span></code> </pre> <br>  El resultado muestra que nuestra funci√≥n add () est√° en este m√≥dulo, pero tambi√©n contiene secciones <i>personalizadas</i> con metadatos y, sorprendentemente, varias importaciones.  En la siguiente etapa de <i>vinculaci√≥n,</i> se analizar√°n y eliminar√°n secciones personalizadas, y el vinculador (vinculador) se ocupar√° de la importaci√≥n. <br><br><h3>  Dise√±o </h3><br>  Tradicionalmente, la tarea del vinculador es ensamblar varios archivos de objetos en un archivo ejecutable.  El enlazador LLVM se llama <code>lld</code> , y se invoca con el enlace simb√≥lico de destino.  Para WebAssembly, este <code>wasm-ld</code> . <br><br><pre> <code class="bash hljs">wasm-ld \ --no-entry \ <span class="hljs-comment"><span class="hljs-comment"># We don't have an entry function --export-all \ # Export everything (for now) -o add.wasm \ add.o</span></span></code> </pre> <br>  El resultado es un m√≥dulo WebAssembly de 262 bytes de tama√±o. <br><br><h3>  Lanzamiento </h3><br>  Por supuesto, lo m√°s importante es ver que todo <i>realmente</i> funcione.  Como en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">√∫ltimo art√≠culo</a> , puede usar un par de l√≠neas de JavaScript incrustado para cargar y ejecutar este m√≥dulo de WebAssembly. <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"module"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">async</span></span></span><span class="javascript"> </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="javascript"><span class="hljs-function"><span class="hljs-title">init</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">const</span></span></span><span class="javascript"> { instance } = </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">await</span></span></span><span class="javascript"> WebAssembly.instantiateStreaming( fetch(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"./add.wasm"</span></span></span><span class="javascript">) ); </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">console</span></span></span><span class="javascript">.log(instance.exports.add(</span><span class="hljs-number"><span class="javascript"><span class="hljs-number">4</span></span></span><span class="javascript">, </span><span class="hljs-number"><span class="javascript"><span class="hljs-number">1</span></span></span><span class="javascript">)); } init(); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Si todo est√° bien, ver√° el n√∫mero 17 en la consola de DevTool. <b>Acabamos de compilar con √©xito C en WebAssembly sin tocar Emscripten.</b>  Tambi√©n vale la pena se√±alar que no hay middleware para configurar y cargar el m√≥dulo WebAssembly. <br><br><h1>  Compilar C es un poco m√°s simple </h1><br>  Para compilar C en WebAssembly, hemos tomado muchos pasos.  Como dije, con fines educativos, examinamos en detalle todas las etapas.  Omitamos los formatos intermedios legibles para humanos e inmediatamente apliquemos el compilador de C como una navaja suiza, tal como se desarroll√≥: <br><br><pre> <code class="bash hljs">clang \ --target=wasm32 \ -nostdlib \ <span class="hljs-comment"><span class="hljs-comment"># Don't try and link against a standard library -Wl,--no-entry \ # Flags passed to the linker -Wl,--export-all \ -o add.wasm \ add.c</span></span></code> </pre> <br>  Aqu√≠ obtenemos el mismo archivo <code>.wasm</code> , pero con un comando. <br><br><h1>  Optimizaci√≥n </h1><br>  Eche un vistazo al WAT de nuestro m√≥dulo WebAssembly ejecutando <code>wasm2wat</code> : <br><br><pre> <code class="plaintext hljs">(module (type (;0;) (func)) (type (;1;) (func (param i32 i32) (result i32))) (func $__wasm_call_ctors (type 0)) (func $add (type 1) (param i32 i32) (result i32) (local i32 i32 i32 i32 i32 i32 i32 i32) global.get 0 local.set 2 i32.const 16 local.set 3 local.get 2 local.get 3 i32.sub local.set 4 local.get 4 local.get 0 i32.store offset=12 local.get 4 local.get 1 i32.store offset=8 local.get 4 i32.load offset=12 local.set 5 local.get 4 i32.load offset=12 local.set 6 local.get 5 local.get 6 i32.mul local.set 7 local.get 4 i32.load offset=8 local.set 8 local.get 7 local.get 8 i32.add local.set 9 local.get 9 return) (table (;0;) 1 1 anyfunc) (memory (;0;) 2) (global (;0;) (mut i32) (i32.const 66560)) (global (;1;) i32 (i32.const 66560)) (global (;2;) i32 (i32.const 1024)) (global (;3;) i32 (i32.const 1024)) (export "memory" (memory 0)) (export "__wasm_call_ctors" (func $__wasm_call_ctors)) (export "__heap_base" (global 1)) (export "__data_end" (global 2)) (export "__dso_handle" (global 3)) (export "add" (func $add)))</code> </pre> <br>  Wow, qu√© gran c√≥digo.  Para mi sorpresa, el m√≥dulo usa memoria (como se ve en las <code>i32.store</code> <code>i32.load</code> e <code>i32.store</code> ), ocho variables locales y varias variables globales.  Probablemente, puede escribir manualmente una versi√≥n m√°s concisa.  Este programa es muy grande porque no aplicamos ninguna optimizaci√≥n.  Hag√°moslo: <br><br><pre> <code class="bash hljs">clang \ --target=wasm32 \ + -O3 \ <span class="hljs-comment"><span class="hljs-comment"># Agressive optimizations + -flto \ # Add metadata for link-time optimizations -nostdlib \ -Wl,--no-entry \ -Wl,--export-all \ + -Wl,--lto-O3 \ # Aggressive link-time optimizations -o add.wasm \ add.c</span></span></code> </pre> <br><blockquote>  <b>Nota:</b> t√©cnicamente, la optimizaci√≥n de dise√±o (LTO) no ofrece beneficios ya que solo componimos un archivo.  En proyectos grandes, LTO ayudar√° a reducir significativamente el tama√±o del archivo. </blockquote>  Despu√©s de ejecutar estos comandos, el archivo <code>.wasm</code> disminuy√≥ de 262 a 197 bytes, y WAT tambi√©n se volvi√≥ mucho m√°s simple: <br><br><pre> <code class="plaintext hljs">(module (type (;0;) (func)) (type (;1;) (func (param i32 i32) (result i32))) (func $__wasm_call_ctors (type 0)) (func $add (type 1) (param i32 i32) (result i32) local.get 0 local.get 0 i32.mul local.get 1 i32.add) (table (;0;) 1 1 anyfunc) (memory (;0;) 2) (global (;0;) (mut i32) (i32.const 66560)) (global (;1;) i32 (i32.const 66560)) (global (;2;) i32 (i32.const 1024)) (global (;3;) i32 (i32.const 1024)) (export "memory" (memory 0)) (export "__wasm_call_ctors" (func $__wasm_call_ctors)) (export "__heap_base" (global 1)) (export "__data_end" (global 2)) (export "__dso_handle" (global 3)) (export "add" (func $add)))</code> </pre> <br><h1>  Llame a la biblioteca est√°ndar. </h1><br>  Usar C sin la biblioteca libc est√°ndar parece bastante grosero.  Es l√≥gico agregarlo, pero ser√© sincero: <i>no</i> ser√° f√°cil.  <b>De hecho, no invocamos directamente ninguna biblioteca libc en el art√≠culo</b> .  Hay varios adecuados, especialmente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">glibc</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">musl</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">dietlibc</a> .  Sin embargo, se supone que la mayor√≠a de estas bibliotecas se ejecutan en el sistema operativo POSIX, que implementa un cierto conjunto de llamadas al sistema.  Como no tenemos una interfaz de kernel en JavaScript, tendremos que implementar estas llamadas al sistema POSIX nosotros mismos, probablemente a trav√©s de JavaScript.  Esta es una tarea dif√≠cil y no voy a hacerlo aqu√≠.  La buena noticia es que <b>esto es lo que Emscripten hace por usted</b> . <br><br>  Por supuesto, no todas las funciones de libc dependen de llamadas al sistema.  Las funciones como <code>strlen()</code> , <code>sin()</code> o incluso <code>memset()</code> se implementan en C. simple, lo que significa que puede usar estas funciones o incluso simplemente copiar / pegar su implementaci√≥n desde alguna de las bibliotecas mencionadas. <br><br><h1>  Memoria din√°mica </h1><br>  Sin libc, las interfaces fundamentales de C como <code>malloc()</code> y <code>free()</code> no est√°n disponibles para nosotros.  En el WAT no optimizado, vimos que el compilador usa memoria si es necesario.  Esto significa que no podemos usar la memoria como queramos, sin arriesgarnos a da√±arla.  Necesita entender c√≥mo se usa. <br><br><h3>  Modelos de memoria LLVM </h3><br>  El m√©todo de segmentaci√≥n de memoria de WebAssembly sorprender√° un poco a los programadores experimentados.  En primer lugar, en WebAssembly, una direcci√≥n nula es t√©cnicamente admisible, pero a menudo todav√≠a se trata como un error.  En segundo lugar, la pila viene primero y crece hacia abajo (a direcciones m√°s bajas), y el mont√≥n aparece m√°s tarde y crece.  La raz√≥n es que la memoria de WebAssembly puede aumentar en tiempo de ejecuci√≥n.  Esto significa que no hay un extremo fijo para acomodar la pila o el mont√≥n. <br><br>  Aqu√≠ est√° el dise√±o <code>wasm-ld</code> : <br><br><img src="https://habrastorage.org/webt/kz/xv/z6/kzxvz60tlxzqdv_9tvxlm4m3gca.png"><br><br>  <i><font color="gray">La pila crece y el mont√≥n crece.</font></i>  <i><font color="gray">La pila comienza con <code>__data_end</code> , y el mont√≥n <code>__heap_base</code> con <code>__heap_base</code> .</font></i>  <i><font color="gray">Debido a que la pila se coloca primero, est√° limitada por el tama√±o m√°ximo establecido durante la compilaci√≥n, es decir, <code>__heap_base</code> menos <code>__data_end</code></font></i> <br><br>  Si volvemos y miramos la secci√≥n global en nuestro WAT, encontramos estos valores: <code>__heap_base</code> establece en 66560, y <code>__data_end</code> se establece en 1024. Esto significa que la pila puede crecer hasta un m√°ximo de 64 KiB, lo cual no es mucho.  Afortunadamente, <code>wasm-ld</code> permite cambiar este valor: <br><br><pre> <code class="bash hljs">clang \ --target=wasm32 \ -O3 \ -flto \ -nostdlib \ -Wl,--no-entry \ -Wl,--<span class="hljs-built_in"><span class="hljs-built_in">export</span></span>-all \ -Wl,--lto-O3 \ + -Wl,-z,stack-size=$[8 * 1024 * 1024] \ <span class="hljs-comment"><span class="hljs-comment"># Set maximum stack size to 8MiB -o add.wasm \ add.c</span></span></code> </pre> <br><h3>  Conjunto de asignaci√≥n </h3><br>  Se sabe que el √°rea de mont√≥n comienza con <code>__heap_base</code> .  Como falta la funci√≥n <code>malloc()</code> , sabemos que la siguiente √°rea de memoria se puede usar de forma segura.  Podemos colocar los datos all√≠ como queramos, y no hay necesidad de temer la corrupci√≥n de la memoria, ya que la pila crece en la otra direcci√≥n.  Sin embargo, un mont√≥n que es gratuito para todos puede obstruirse r√°pidamente, por lo que generalmente se requiere alg√∫n tipo de administraci√≥n de memoria din√°mica.  Una opci√≥n es tomar una implementaci√≥n completa de malloc (), como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la implementaci√≥n de Dall Lee de malloc</a> , que se usa en Emscripten.  Hay varias implementaciones m√°s peque√±as con varias compensaciones. <br><br>  Pero, ¬øpor qu√© no escribes tu propio <code>malloc()</code> ?  Estamos tan empantanados que no hay diferencia.  Uno de los m√°s simples es un asignador de protuberancias: es s√∫per r√°pido, extremadamente peque√±o y f√°cil de implementar.  Pero hay un inconveniente: no puedes liberar memoria.  Aunque a primera vista, un asignador de este tipo parece incre√≠blemente in√∫til, pero al desarrollar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Squoosh,</a> encontr√© precedentes en los que ser√≠a una excelente opci√≥n.  El concepto de un asignador de protuberancias es que almacenamos la direcci√≥n inicial de la memoria no utilizada como global.  Si el programa solicita <code>n</code> bytes de memoria, movemos el marcador a <code>n</code> y devolvemos el valor anterior: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> __heap_base; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bump_pointer = &amp;__heap_base; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">malloc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> r = bump_pointer; bump_pointer += n; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *)r; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">free</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* p)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// lol }</span></span></code> </pre> <br>  Las variables globales de WAT en realidad est√°n definidas por <code>wasm-ld</code> , de modo que podemos acceder a ellas desde nuestro c√≥digo C como variables ordinarias si las declaramos <code>extern</code> .  Entonces, <b>acabamos de escribir nuestro propio <code>malloc()</code> ... en cinco l√≠neas de C.</b> <br><br><blockquote>  <b>Nota:</b> nuestro asignador de golpes no es totalmente compatible con <code>malloc()</code> de C. Por ejemplo, no ofrecemos ninguna garant√≠a de alineaci√≥n.  Pero funciona lo suficientemente bien, as√≠ que ... </blockquote><h3>  Uso de memoria din√°mica </h3><br>  Para probar, hagamos una funci√≥n C, que toma una matriz de n√∫meros de tama√±o arbitrario y calcula la suma.  No es muy interesante, pero esto nos obliga a usar memoria din√°mica, ya que no conocemos el tama√±o de la matriz durante el ensamblaje: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a[], </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> len)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> sum = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; len; i++) { sum += a[i]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sum; }</code> </pre> <br>  La funci√≥n sum (), con suerte, es bastante sencilla.  Una pregunta m√°s interesante es c√≥mo pasar una matriz de JavaScript a WebAssembly; despu√©s de todo, WebAssembly solo comprende los n√∫meros.  La idea general es usar <code>malloc()</code> <i>de JavaScript</i> para asignar un trozo de memoria, copiar los valores all√≠ y pasar la direcci√≥n (¬°n√∫mero!) <i>Donde</i> se encuentra <i>la</i> matriz: <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"module"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">async</span></span></span><span class="javascript"> </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="javascript"><span class="hljs-function"><span class="hljs-title">init</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">const</span></span></span><span class="javascript"> { instance } = </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">await</span></span></span><span class="javascript"> WebAssembly.instantiateStreaming( fetch(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"./add.wasm"</span></span></span><span class="javascript">) ); </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">const</span></span></span><span class="javascript"> jsArray = [</span><span class="hljs-number"><span class="javascript"><span class="hljs-number">1</span></span></span><span class="javascript">, </span><span class="hljs-number"><span class="javascript"><span class="hljs-number">2</span></span></span><span class="javascript">, </span><span class="hljs-number"><span class="javascript"><span class="hljs-number">3</span></span></span><span class="javascript">, </span><span class="hljs-number"><span class="javascript"><span class="hljs-number">4</span></span></span><span class="javascript">, </span><span class="hljs-number"><span class="javascript"><span class="hljs-number">5</span></span></span><span class="javascript">]; </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">// Allocate memory for 5 32-bit integers // and return get starting address. const cArrayPointer = instance.exports.malloc(jsArray.length * 4); // Turn that sequence of 32-bit integers // into a Uint32Array, starting at that address. const cArray = new Uint32Array( instance.exports.memory.buffer, cArrayPointer, jsArray.length ); // Copy the values from JS to C. cArray.set(jsArray); // Run the function, passing the starting address and length. console.log(instance.exports.sum(cArrayPointer, cArray.length)); } init(); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Despu√©s de comenzar, deber√≠a ver la respuesta 15 en la consola de DevTools, que es realmente la suma de todos los n√∫meros del 1 al 5. <br><br><h1>  Conclusi√≥n </h1><br>  Entonces, lees hasta el final.  Felicidades  Nuevamente, si te sientes un poco sobrecargado, todo est√° en orden.  <b>No es necesario leer todos los detalles.</b>  <b>Comprenderlos es completamente opcional para un buen desarrollador web y ni siquiera es necesario para el excelente uso de WebAssembly</b> .  Pero quer√≠a compartir esta informaci√≥n, porque te permite apreciar realmente todo el trabajo que un proyecto como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Emscripten</a> hace por ti.  Al mismo tiempo, esto permite comprender cu√°n peque√±os pueden ser los m√≥dulos puramente computacionales de WebAssembly.  El m√≥dulo Wasm para sumar la matriz tiene solo 230 bytes de tama√±o, <i>incluido un asignador de memoria din√°mica</i> .  Compilar el mismo c√≥digo con Emscripten producir√° 100 bytes de c√≥digo de WebAssembly y c√≥digo de enlace de 11K JavaScript.  Debe intentar por el resultado, pero hay situaciones en las que vale la pena. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/454868/">https://habr.com/ru/post/454868/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../454844/index.html">Odigest: interesante para los dise√±adores de la semana.</a></li>
<li><a href="../454850/index.html">La evoluci√≥n de un algoritmo √∫nico.</a></li>
<li><a href="../454856/index.html">Analizamos vulnerabilidades de validaci√≥n de certificados SSL / TLS en software que no es de navegador</a></li>
<li><a href="../454860/index.html">Ayudemos a QueryProvider a lidiar con cadenas interpoladas</a></li>
<li><a href="../454864/index.html">¬øC√≥mo son los procesos de desarrollo en diversas empresas?</a></li>
<li><a href="../454872/index.html">Space Invaders: ahora en 512 bytes (ensamblador x86)</a></li>
<li><a href="../454874/index.html">Un poco sobre la multitarea en microcontroladores</a></li>
<li><a href="../454876/index.html">Sobre el dise√±o de un sistema flexible de habilidades de personajes en juegos</a></li>
<li><a href="../454878/index.html">Estudiamos MITRE ATT & CK. Matrices m√≥viles: acceso a dispositivos. Parte 3</a></li>
<li><a href="../454880/index.html">"Fuera de temporada" en la vida de un profesional independiente: ¬øc√≥mo sobrevivir y sobrevivir?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>