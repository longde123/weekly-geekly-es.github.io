<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçü§ù‚Äçüë©üèæ üî¥ üë≤ Voc√™ e Brad Pitt s√£o 99% üíè üë∏üèª üòè</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="N√≥s, no departamento de an√°lise do cinema online Okko, adoramos automatizar o c√°lculo das taxas de filmes de Alexander Nevsky, tanto quanto poss√≠vel, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Voc√™ e Brad Pitt s√£o 99%</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/okko/blog/417329/"><p><img src="https://habrastorage.org/webt/bg/8z/-p/bg8z-pmvxneor2kulnu9tmg3qoy.jpeg" alt="Amanh√£ de f√©rias"></p><br><p>  N√≥s, no departamento de an√°lise do cinema online <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Okko,</a> adoramos automatizar o c√°lculo das taxas de filmes de Alexander Nevsky, tanto quanto poss√≠vel, e no tempo livre para aprender coisas novas e implementar coisas legais que, por algum motivo, geralmente se traduzem em bots para o telegrama.  Por exemplo, antes do in√≠cio da Copa do Mundo da FIFA 2018, lan√ßamos um bot para o bate-papo de trabalho, que coletava apostas na distribui√ß√£o dos lugares finais e, ap√≥s o final, calcul√°vamos os resultados de acordo com uma m√©trica pr√©-inventada e determin√°vamos os vencedores.  A Cro√°cia n√£o colocou quatro entre os quatro primeiros. </p><br><p>  Tempo livre recente ao compilar as 10 melhores com√©dias russas que dedicamos √† cria√ß√£o de um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">bot</a> que encontra uma celebridade com a qual o usu√°rio mais se parece.  No chat de trabalho, todos gostaram tanto da ideia que decidimos disponibilizar o bot ao p√∫blico.  Neste artigo, relembramos brevemente a teoria, falamos sobre a cria√ß√£o do nosso bot e como fazer voc√™ mesmo. </p><a name="habracut"></a><br><h1 id="nemnogo-teorii-v-osnovnom-v-kartinkah">  Um pouco de teoria (principalmente em fotos) </h1><br><p> Em detalhes sobre como os sistemas de reconhecimento de face s√£o organizados, falei em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um dos meus artigos anteriores</a> .  Um leitor interessado pode seguir o link e descreverei abaixo apenas os pontos principais. </p><br><p>  Ent√£o, voc√™ tem uma fotografia na qual, talvez, at√© um rosto seja mostrado e voc√™ quer entender de quem √©.  Para fazer isso, voc√™ precisa seguir 4 etapas simples: </p><br><ol><li>  Selecione o ret√¢ngulo que faz fronteira com a face. </li><li>  Destaque os principais pontos do rosto. </li><li>  Alinhe e corte seu rosto. </li><li>  Converta uma imagem de rosto em alguma representa√ß√£o interpretada por m√°quina. </li><li>  Compare essa visualiza√ß√£o com outras que voc√™ tem dispon√≠vel. </li></ol><br><h3 id="vydelenie-lica">  Sele√ß√£o de rosto </h3><br><p>  Embora as redes neurais convolucionais tenham aprendido recentemente como encontrar rostos em uma imagem n√£o sejam piores que os m√©todos cl√°ssicos, elas ainda s√£o inferiores ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">HOG</a> cl√°ssico em velocidade e facilidade de uso. </p><br><p>  HOG - Histogramas de gradientes orientados.  Esse cara associa cada pixel da imagem de origem ao seu gradiente - um vetor na dire√ß√£o em que o brilho dos pixels muda mais.  A vantagem dessa abordagem √© que ela n√£o se importa com os valores absolutos do brilho dos pixels, apenas sua propor√ß√£o √© suficiente.  Portanto, uma face normal, escura, mal iluminada e ruidosa ser√° exibida aproximadamente no mesmo histograma de gradientes. </p><br><p><img src="https://habrastorage.org/webt/ke/_h/b_/ke_hb_cyd3odkvkwmqb0soancka.png" alt="Histograma dos gradientes direcionados √† face"></p><br><p> N√£o √© necess√°rio calcular o gradiente para cada pixel, basta calcular o gradiente m√©dio para cada quadrado pequeno <code>n</code> por <code>n</code> .  Usando o campo vetorial recebido, voc√™ pode passar por algum detector com uma janela e determinar para cada janela qual a probabilidade da face nela.  O detector pode ser SVM, uma floresta aleat√≥ria ou qualquer outra coisa. </p><br><p><img src="https://habrastorage.org/webt/mz/hk/2y/mzhk2ycaurneywpy32a0linnm3o.png" alt="Detec√ß√£o de rosto"></p><br><h3 id="vydelenie-klyuchevyh-tochek">  Destaque os principais pontos </h3><br><p><img src="https://habrastorage.org/webt/wd/bi/dc/wdbidcix45fpf74iglc7f0f1rpg.png" alt="Pontos principais do rosto"></p><br><p>  Pontos-chave s√£o pontos que ajudam a identificar uma pessoa no espa√ßo.  Os cientistas fracos e inseguros geralmente precisam de 68 pontos-chave e, em casos especialmente negligenciados, ainda mais.  Garotos normais e autoconfiantes, ganhando 300k por segundo, sempre tiveram o suficiente de cinco: os cantos interno e externo dos olhos e nariz. </p><br><p><img src="https://habrastorage.org/webt/6t/tb/-8/6ttb-8bq0ugffanbs0qcrihy2a4.jpeg" alt="Meme antigo"></p><br><p>  Tais pontos podem ser extra√≠dos, por exemplo, por uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">cascata de regressores</a> . </p><br><h3 id="vyravnivanie-lica">  Alinhamento da face </h3><br><p>  Aplica√ß√µes coladas na inf√¢ncia?  Aqui tudo √© exatamente o mesmo: voc√™ constr√≥i uma transforma√ß√£o afim que traduz tr√™s pontos arbitr√°rios em suas posi√ß√µes padr√£o.  O nariz pode ser deixado como est√°, mas para os olhos contarem seus centros - esses s√£o os tr√™s pontos prontos. </p><br><p><img src="https://habrastorage.org/webt/ms/3q/s7/ms3qs7hagupsaooas-eqrjjmqpy.png" alt="Girar rosto"></p><br><h3 id="preobrazovanie-izobrazheniya-lica-v-vektor">  Converter imagens de rosto em vetor </h3><br><p><img src="https://habrastorage.org/webt/ab/8w/jo/ab8wjody73ybfs_opnftpipbcz0.png" alt="Meme menos antigo"></p><br><p>  Tr√™s anos se passaram desde a publica√ß√£o do artigo sobre o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">FaceNet</a> . Nesse per√≠odo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">surgiram</a> muitos esquemas interessantes de treinamento e fun√ß√µes de perda, mas √© ela quem domina as solu√ß√µes OpenSource dispon√≠veis.  Aparentemente, a coisa toda √© uma combina√ß√£o de facilidade de entendimento, implementa√ß√£o e resultados decentes.  Agradecemos pelo menos pelo fato de nos √∫ltimos tr√™s anos a arquitetura ter sido alterada para ResNet. </p><br><p><img src="https://habrastorage.org/webt/af/pt/cx/afptcx5ixcu2r0_mjkckckpt2zo.jpeg" alt="Novo meme"></p><br><p>  O FaceNet aprende com tr√™s exemplos: (√¢ncora, positivo, negativo).  Exemplos √¢ncora e positivos pertencem a uma pessoa, enquanto negativo √© escolhido como o rosto de outra pessoa, o que, por algum motivo, a rede est√° muito pr√≥xima da primeira.  A fun√ß√£o de perda √© projetada de maneira a corrigir esse mal-entendido, reunir os exemplos necess√°rios e mover o desnecess√°rio deles. </p><br><p><img src="https://habrastorage.org/webt/tp/yf/sw/tpyfswhgnyco4w_0ap3zy8i5zhs.png" alt="Guccinet"></p><br><p><img src="https://habrastorage.org/webt/gj/fi/zq/gjfizqzcwjybnypbv-ugovr5hl0.png" alt="Rostos faciais e Dmitry Malikov"></p><br><p>  A sa√≠da da √∫ltima camada da rede √© chamada de incorpora√ß√£o - uma representa√ß√£o representativa de uma pessoa em um determinado espa√ßo de pequena dimens√£o (geralmente 128-dimensional). </p><br><h3 id="sravnenie-lic">  Compara√ß√£o de rostos </h3><br><p>  A beleza de casamentos bem treinados √© que os rostos de uma pessoa s√£o exibidos em algum pequeno bairro do espa√ßo, distante das incorpora√ß√µes dos rostos de outras pessoas.  Assim, para esse espa√ßo, √© poss√≠vel inserir uma medida de similaridade, a rec√≠proca da dist√¢ncia: euclidiana ou cosseno, dependendo da dist√¢ncia que a rede foi treinada. </p><br><p><img src="https://habrastorage.org/webt/pn/u8/ba/pnu8barwdzvdryma24yezil7kvo.jpeg" alt="Um exemplo de casamentos completamente artificial"></p><br><p>  Portanto, com anteced√™ncia, precisamos criar incorpora√ß√µes para todas as pessoas entre as quais a pesquisa ser√° realizada e, em cada solicita√ß√£o, encontrar o vetor mais pr√≥ximo entre elas.  Ou, de outra maneira, resolva o problema de encontrar <code>k</code> vizinhos mais pr√≥ximos, onde <code>k</code> pode ser igual a um, ou talvez n√£o, se quisermos usar alguma l√≥gica de neg√≥cios mais avan√ßada.  A pessoa que possui o vetor de resultado ser√° a mais semelhante √† pessoa solicitada. </p><br><p><img src="https://habrastorage.org/webt/6f/uz/nx/6fuznxdig3uiw1mjuv1eezx5h3u.jpeg" alt="Semelhan√ßa de cara a cara, n√£o de cara"></p><br><h3 id="kakuyu-biblioteku-ispolzovat">  Qual biblioteca usar? </h3><br><p>  A escolha de bibliotecas abertas que implementam v√°rias partes do pipeline √© √≥tima.  <code>dlib</code> e o <code>OpenCV</code> podem encontrar faces e pontos-chave, e vers√µes pr√©-treinadas de redes podem ser encontradas para qualquer grande estrutura de rede neural.  Existe um projeto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">OpenFace em</a> que voc√™ pode escolher a arquitetura para seus requisitos de velocidade e qualidade.  Mas apenas uma biblioteca permite implementar todos os 5 pontos de reconhecimento de face nas chamadas para tr√™s fun√ß√µes de alto n√≠vel: <code>dlib</code> .  Ao mesmo tempo, √© escrito em C ++ moderno, usa BLAS, possui um wrapper para Python, n√£o requer uma GPU e funciona muito rapidamente em uma CPU.  Nossa escolha caiu sobre ela. </p><br><h1 id="delaem-sobstvennogo-bota">  Fazendo seu pr√≥prio bot </h1><br><p>  Esta se√ß√£o j√° foi descrita em literalmente todos os guias para cria√ß√£o de bots, mas depois que escrevermos o mesmo, teremos que repeti-lo.  Escrevemos para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">@BotFather</a> e pedimos um token para o nosso novo bot. </p><br><p><img src="https://habrastorage.org/webt/um/qe/ew/umqeewdk64wtealh1ldudqsv0m8.png" alt="Desfocar o token xs por que"></p><br><p>  O token √© mais ou menos assim: <code>643075690:AAFC8ola8WRdhGbJtzjmkOhne1FGfu1BFg</code> .  √â necess√°rio obter autoriza√ß√£o em cada solicita√ß√£o para a API bot do Telegram. </p><br><p>  Espero que ningu√©m nesta fase tenha d√∫vidas ao escolher uma linguagem de programa√ß√£o.  Claro, voc√™ tem que escrever em Haskell.  Vamos come√ßar com o m√≥dulo principal. </p><br><pre> <code class="haskell hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> System.Process main :: IO () main = do (<span class="hljs-title"><span class="hljs-title">_</span></span>, <span class="hljs-title"><span class="hljs-title">_</span></span>, <span class="hljs-title"><span class="hljs-title">_</span></span>, <span class="hljs-title"><span class="hljs-title">handle</span></span>) &lt;- createProcess (<span class="hljs-title"><span class="hljs-title">shell</span></span> "<span class="hljs-title"><span class="hljs-title">python</span></span> <span class="hljs-title"><span class="hljs-title">bot</span></span>.<span class="hljs-title"><span class="hljs-title">py</span></span>") _ &lt;- waitForProcess handle putStrLn "Done!"</code> </pre> <br><p>  Como voc√™ pode ver no c√≥digo, no futuro usaremos uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DSL</a> especial para gravar bots de telegrama.  O c√≥digo neste DSL √© gravado em arquivos separados.  Instale o idioma do dom√≠nio e tudo o que for necess√°rio. </p><br><pre> <code class="bash hljs">python -m venv .env <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> .env/bin/activate pip install python-telegram-bot</code> </pre> <br><p>  Atualmente, o <code>python-telegram-bot</code> √© a estrutura mais conveniente para a cria√ß√£o de bots.  √â f√°cil de aprender, flex√≠vel, escal√°vel, suporta multithreading.  Infelizmente, no momento n√£o existe uma √∫nica estrutura ass√≠ncrona normal e os fios antigos precisam ser usados ‚Äã‚Äãem vez das corotinas divinas. </p><br><p><img src="https://habrastorage.org/webt/t2/8b/qv/t28bqvhxxznqmzsobr4hjmuxlta.jpeg" alt="assino √© meu √∫nico deus"></p><br><p>  Iniciar um bot com <code>python-telegram-bot</code> √© f√°cil.  Adicione o seguinte c√≥digo ao <code>bot.py</code> </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> telegram.ext <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Updater <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> telegram.ext <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> MessageHandler, Filters <span class="hljs-comment"><span class="hljs-comment">#      TOKEN = '&lt;TOKEN&gt;' def echo(bot, update): bot.send_message(chat_id=update.message.chat_id, text=update.message.text) updater = Updater(token=TOKEN) dispatcher = updater.dispatcher echo_handler = MessageHandler(Filters.text, echo) dispatcher.add_handler(echo_handler)</span></span></code> </pre> <br><p>  Execute o bot.  Para fins de depura√ß√£o, isso pode ser feito com o <code>python bot.py</code> sem executar o c√≥digo Haskell. </p><br><p>  Um bot t√£o simples √© capaz de manter uma conversa m√≠nima e, portanto, pode ser facilmente organizado para funcionar como desenvolvedor front-end. </p><br><p><img src="https://habrastorage.org/webt/xs/pk/sm/xspksm1d8ehnslmqjsj33dzyekm.png" alt="Di√°logo t√≠pico com desenvolvedor front-end"></p><br><p>  Mas o frontend dos desenvolvedores j√° √© demais, ent√£o o mataremos o mais r√°pido poss√≠vel e continuaremos implementando a funcionalidade principal.  Por uma quest√£o de simplicidade, nosso bot responder√° apenas a mensagens contendo fotos e ignorar√° outras.  Mude o c√≥digo para o seguinte. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> telegram.ext <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Updater <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> telegram.ext <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> MessageHandler, Filters <span class="hljs-comment"><span class="hljs-comment">#      TOKEN = '&lt;TOKEN&gt;' def handle_photo(bot, update): bot.send_message(chat_id=update.message.chat_id, text='nice') updater = Updater(token=TOKEN) dispatcher = updater.dispatcher photo_handler = MessageHandler(Filters.photo, handle_photo) dispatcher.add_handler(photo_handler) updater.start_polling() updater.idle()</span></span></code> </pre> <br><p><img src="https://habrastorage.org/webt/-8/1k/hq/-81khq5z9redcz29_ut7sunfrpg.png" alt="J√° n√£o √© desenvolvedor de front-end"></p><br><p>  Quando a imagem entra no servidor Telegram, ela √© ajustada automaticamente para v√°rios tamanhos predeterminados.  O bot, por sua vez, pode baixar uma imagem de qualquer tamanho daquelas contidas na lista <code>message.photo</code> classificada em ordem crescente.  A op√ß√£o mais f√°cil: tire a maior imagem.  Obviamente, em um ambiente de supermercado, voc√™ precisa pensar na carga e no tempo de carregamento da rede e escolher uma imagem do tamanho m√≠nimo adequado.  Adicione o c√≥digo de download da imagem na parte superior da fun√ß√£o <code>handle_photo</code> . </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io</code> </pre> <br><pre> <code class="python hljs">message = update.message photo = message.photo[~<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> io.BytesIO() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> fd: file_id = bot.get_file(photo.file_id) file_id.download(out=fd) fd.seek(<span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre> <br><p>  A imagem foi baixada e est√° na mem√≥ria.  Para interpret√°-lo e apresent√°-lo na forma de uma matriz de intensidade de pixel, usamos as bibliotecas <code>Pillow</code> e <code>numpy</code> . </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> PIL <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Image <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np</code> </pre> <br><p>  O c√≥digo a seguir precisa ser adicionado ao bloco <code>with</code> . </p><br><pre> <code class="python hljs">image = Image.open(fd) image.load() image = np.asarray(image)</code> </pre> <br><p>  Chegou a hora dlib.  Fora da fun√ß√£o, crie um detector de rosto. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> dlib</code> </pre> <br><pre> <code class="python hljs">face_detector = dlib.get_frontal_face_detector()</code> </pre> <br><p>  E dentro da fun√ß√£o n√≥s a usamos. </p><br><pre> <code class="python hljs">face_detects = face_detector(image, <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br><p>  O segundo par√¢metro da fun√ß√£o significa a amplia√ß√£o que deve ser aplicada antes de tentar detectar faces.  Quanto maior, menores e mais complexas as faces que o detector poder√° detectar, mas mais tempo funcionar√°.  <code>face_detects</code> - uma lista de faces classificadas em ordem decrescente de confian√ßa do detector de que a face est√° na frente dele.  Em uma aplica√ß√£o real, voc√™ provavelmente desejar√° aplicar alguma l√≥gica de escolha da pessoa principal e, no estudo de caso, nos limitaremos a escolher a primeira. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> face_detects: bot.send_message(chat_id=update.message.chat_id, text=<span class="hljs-string"><span class="hljs-string">'no faces'</span></span>) face = face_detects[<span class="hljs-number"><span class="hljs-number">0</span></span>]</code> </pre> <br><p>  Prosseguimos para a pr√≥xima etapa - a busca por pontos-chave.  Fa√ßa o download do <a href="">modelo treinado</a> e mova sua carga para fora da fun√ß√£o. </p><br><pre> <code class="python hljs">shape_predictor = dlib.shape_predictor(<span class="hljs-string"><span class="hljs-string">'path/to/shape_predictor_5_face_landmarks.dat'</span></span>)</code> </pre> <br><p>  Encontre os pontos principais. </p><br><pre> <code class="python hljs">landmarks = shape_predictor(image, face)</code> </pre> <br><p>  A √∫nica coisa que resta √© pequena: para endireitar o rosto, passe-o pelo ResNet e obtenha uma incorpora√ß√£o de 128 dimens√µes.  Felizmente, o dlib permite que voc√™ fa√ßa tudo isso com uma chamada.  Voc√™ s√≥ precisa fazer o download do <a href="">modelo pr√©-treinado</a> . </p><br><pre> <code class="python hljs">face_recognition_model = dlib.face_recognition_model_v1(<span class="hljs-string"><span class="hljs-string">'path/to/dlib_face_recognition_resnet_model_v1.dat'</span></span>)</code> </pre> <br><pre> <code class="python hljs">embedding = face_recognition_model.compute_face_descriptor(image, landmarks) embedding = np.asarray(embedding)</code> </pre> <br><p>  Basta olhar para o momento maravilhoso em que vivemos.  Toda a complexidade das redes neurais convolucionais, o m√©todo do vetor de suporte e as transforma√ß√µes afins aplicadas ao reconhecimento de face s√£o encapsuladas em tr√™s chamadas de biblioteca. </p><br><p>  Como ainda n√£o sabemos como fazer algo significativo, vamos retornar ao usu√°rio o valor m√©dio de sua incorpora√ß√£o, multiplicado por mil. </p><br><pre> <code class="python hljs">bot.send_message( chat_id=update.message.chat_id, text=<span class="hljs-string"><span class="hljs-string">f'yours embedding mean: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{embedding.mean() * </span></span><span class="hljs-number"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-number">1e3</span></span></span></span><span class="hljs-string"><span class="hljs-subst">:</span></span><span class="hljs-number"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-number">.2</span></span></span></span><span class="hljs-string"><span class="hljs-subst">f}</span></span></span><span class="hljs-string">'</span></span> )</code> </pre> <br><p><img src="https://habrastorage.org/webt/ud/av/o6/udavo6i5srwrl93jbopenn84tae.png" alt="N√£o sei o que estou fazendo"></p><br><p>  Para que nosso bot possa determinar com quais celebridades os usu√°rios s√£o, agora precisamos encontrar pelo menos uma foto de cada celebridade, criar uma incorpora√ß√£o e salv√°-la em algum lugar.  Adicionaremos apenas 10 celebridades ao nosso rob√¥ de treinamento, localizando suas fotos manualmente e colocando-as no diret√≥rio de <code>photos</code> .  √â assim que deve ser: </p><br><p><img src="https://habrastorage.org/webt/yz/rd/1o/yzrd1ockvqezvybwzo-yulsivqq.png" alt="Olha, eu n√£o tinha dinheiro suficiente para um MacBook."></p><br><p>  Se voc√™ deseja ter um milh√£o de celebridades no banco de dados, tudo ficar√° exatamente igual, apenas h√° mais arquivos e √© improv√°vel que voc√™ possa procur√°-los com as m√£os.  Agora vamos criar o utilit√°rio <code>build_embeddings.py</code> usando as chamadas <code>dlib</code> que j√° conhecemos e salvar as incorpora√ß√µes de celebridades junto com seus nomes em formato bin√°rio. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> dlib <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pickle <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> PIL <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Image face_detector = dlib.get_frontal_face_detector() shape_predictor = dlib.shape_predictor(<span class="hljs-string"><span class="hljs-string">'assets/shape_predictor_5_face_landmarks.dat'</span></span>) face_recognition_model = dlib.face_recognition_model_v1(<span class="hljs-string"><span class="hljs-string">'assets/dlib_face_recognition_resnet_model_v1.dat'</span></span>) fs = os.listdir(<span class="hljs-string"><span class="hljs-string">'photos'</span></span>) es = [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> f <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> fs: print(f) image = np.asarray(Image.open(os.path.join(<span class="hljs-string"><span class="hljs-string">'photos'</span></span>, f))) face_detects = face_detector(image, <span class="hljs-number"><span class="hljs-number">1</span></span>) face = face_detects[<span class="hljs-number"><span class="hljs-number">0</span></span>] landmarks = shape_predictor(image, face) embedding = face_recognition_model.compute_face_descriptor(image, landmarks, num_jitters=<span class="hljs-number"><span class="hljs-number">10</span></span>) embedding = np.asarray(embedding) name, _ = os.path.splitext(f) es.append((name, embedding)) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'assets/embeddings.pickle'</span></span>, <span class="hljs-string"><span class="hljs-string">'wb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: pickle.dump(es, f)</code> </pre> <br><p>  Adicione o carregamento incorporado ao nosso c√≥digo bot. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pickle</code> </pre> <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'assets/embeddings.pickle'</span></span>, <span class="hljs-string"><span class="hljs-string">'rb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: star_embeddings = pickle.load(f)</code> </pre> <br><p>  E, por uma pesquisa exaustiva, descobriremos quem √© o nosso usu√°rio. </p><br><pre> <code class="python hljs">ds = [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> name, emb <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> star_embeddings: distance = np.linalg.norm(embedding - emb) ds.append((name, distance)) best_match, best_distance = min(ds, key=itemgetter(<span class="hljs-number"><span class="hljs-number">1</span></span>)) bot.send_message( chat_id=update.message.chat_id, text=<span class="hljs-string"><span class="hljs-string">f'your look exactly like *</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{best_match}</span></span></span><span class="hljs-string">*'</span></span>, parse_mode=<span class="hljs-string"><span class="hljs-string">'Markdown'</span></span> )</code> </pre> <br><p>  Observe que usamos a dist√¢ncia euclidiana como dist√¢ncia, porque  a rede em dlib foi treinada precisamente com a ajuda dela. </p><br><p><img src="https://habrastorage.org/webt/yd/fl/wi/ydflwigundswx6_qbctjir_itge.png" alt="Fiquei decepcionado com o artigo"></p><br><p>  √â tudo, parab√©ns!  Criamos um bot simples que pode determinar qual celebridade o usu√°rio √©.  Resta encontrar mais fotos, adicionar marcas, escalabilidade, uma pitada de registro e tudo pode ser lan√ßado na produ√ß√£o.  Todos esses t√≥picos s√£o volumosos demais para falar detalhadamente com imensas listagens de c√≥digo. Por isso, descreverei os principais pontos no formato de perguntas e respostas na pr√≥xima se√ß√£o. </p><br><p>  O c√≥digo bot completo de treinamento est√° dispon√≠vel no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GitHub</a> . </p><br><h1 id="rasskazyvaem-pro-nashego-bota">  Falamos sobre o nosso bot </h1><br><h3 id="skolko-u-vas-v-baze-znamenitostey-gde-vy-ih-nashli">  Quantas celebridades voc√™ tem no seu banco de dados?  Onde voc√™ os encontrou? </h3><br><p>  A decis√£o mais l√≥gica ao criar o bot pareceu extrair dados de celebridades de nossa base de conte√∫do interna.  Ela no formato do gr√°fico armazena filmes e todas as entidades associadas a filmes, incluindo atores e diretores.  Para cada pessoa, sabemos o nome dela, o login e a senha do iCloud, filmes e apelidos relacionados, que podem ser usados ‚Äã‚Äãpara gerar links para o site.  Ap√≥s limpar e extrair apenas as informa√ß√µes necess√°rias, o arquivo <code>json</code> permanece da seguinte maneira: </p><br><pre> <code class="json hljs">[ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"alias"</span></span>: <span class="hljs-string"><span class="hljs-string">"tilda-swinton"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"role"</span></span>: <span class="hljs-string"><span class="hljs-string">"actor"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"n_movies"</span></span>: <span class="hljs-number"><span class="hljs-number">14</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"alias"</span></span>: <span class="hljs-string"><span class="hljs-string">"michael-shannon"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"role"</span></span>: <span class="hljs-string"><span class="hljs-string">"actor"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"n_movies"</span></span>: <span class="hljs-number"><span class="hljs-number">22</span></span> }, ... ]</code> </pre> <br><p>  Havia <strong>22.000</strong> dessas entradas no cat√°logo.  A prop√≥sito, n√£o um cat√°logo, mas um cat√°logo. </p><br><h3 id="gde-nayti-fotografii-dlya-vseh-etih-lyudey">  Onde encontrar fotos para todas essas pessoas? </h3><br><p><img src="https://habrastorage.org/webt/_n/5i/pl/_n5iplsi4yqnrm2lpvzyjwhjigm.jpeg" alt="Em tempos perigosos, vivemos"></p><br><p>  Bem, voc√™ sabe, <em>aqui e ali</em> .  H√°, por exemplo, uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">biblioteca maravilhosa</a> que permite o upload de resultados da consulta de imagens do Google.  22 mil pessoas - n√£o tantas, usando 56 fluxos que conseguimos baixar fotos em menos de uma hora. </p><br><p>  Entre as fotos baixadas, voc√™ precisa descartar fotos quebradas e barulhentas no formato errado.  Em seguida, deixe apenas aqueles onde h√° rostos e onde esses rostos satisfazem certas condi√ß√µes: a dist√¢ncia m√≠nima entre os olhos, a inclina√ß√£o da cabe√ßa.  Tudo isso nos deixa com <strong>12.000</strong> fotos. </p><br><p>  Das 12 mil celebridades, os usu√°rios encontraram apenas 2. No momento, existem aproximadamente 8 mil celebridades que ainda n√£o s√£o como as outras pessoas.  N√£o deixe assim!  Abra telegramas e encontre todos eles. </p><br><h3 id="kak-opredelit-procent-shozhesti-dlya-evklidovoy-distancii">  Como determinar a porcentagem de similaridade para a dist√¢ncia euclidiana? </h3><br><p>  √ìtima pergunta!  De fato, a dist√¢ncia euclidiana, em contraste com o cosseno, n√£o √© delimitada acima.  Portanto, surge uma pergunta razo√°vel: como mostrar ao usu√°rio algo mais significativo do que "Parab√©ns, a dist√¢ncia entre a incorpora√ß√£o e a incorpora√ß√£o de Angelina Jolie √© 0,227635462738"?  Um dos membros da nossa equipe prop√¥s a seguinte solu√ß√£o simples e engenhosa.  Se voc√™ construir a distribui√ß√£o de dist√¢ncias entre as incorpora√ß√µes, ser√° normal.  Portanto, para ele, voc√™ pode calcular a m√©dia e o desvio padr√£o e, para cada usu√°rio, de acordo com esses par√¢metros, considerar <em>quantos por cento das pessoas s√£o menos parecidas com as celebridades do que ele</em> .  Isso √© equivalente √† integra√ß√£o de uma fun√ß√£o de densidade de probabilidade de <code>d</code> ao infinito, onde <code>d</code> √© a dist√¢ncia entre o usu√°rio e os com√≠cios de celebridades. </p><br><p><img src="https://habrastorage.org/webt/fh/yc/4r/fhyc4r87otryweg9v-xznackhfq.png" alt="Isso n√£o √© do mar"></p><br><p>  Aqui est√° a fun√ß√£o exata que usamos: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_transform_dist_to_sim</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, dist)</span></span></span><span class="hljs-function">:</span></span> p = <span class="hljs-number"><span class="hljs-number">0.5</span></span> * (<span class="hljs-number"><span class="hljs-number">1</span></span> + erf((dist - self._dist_mean) / (self._dist_std * <span class="hljs-number"><span class="hljs-number">1.4142135623730951</span></span>))) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> max(min(<span class="hljs-number"><span class="hljs-number">1</span></span> - p, <span class="hljs-number"><span class="hljs-number">1.0</span></span>), self._min_similarity)</code> </pre> <br><h3 id="neuzheli-nuzhno-perebirat-spisok-vseh-embedingov-chtoby-nayti-sovpadenie">  √â realmente necess√°rio percorrer a lista de todos os sindicatos para encontrar uma correspond√™ncia? </h3><br><p>  Claro que n√£o, isso n√£o √© o ideal e leva muito tempo.  A maneira mais f√°cil de otimizar c√°lculos √© usar opera√ß√µes de matriz.  Em vez de subtrair vetores um do outro, voc√™ pode compor uma matriz deles e subtrair um vetor da matriz e, em seguida, calcular a norma L2 em linhas. </p><br><pre> <code class="python hljs">scores = np.linalg.norm(emb - embeddings, axis=<span class="hljs-number"><span class="hljs-number">1</span></span>) best_idx = scores.argmax()</code> </pre> <br><p>  Isso j√° d√° um enorme aumento de produtividade, mas, ao que parece, voc√™ pode ainda mais r√°pido.  A pesquisa pode ser significativamente acelerada, perdendo um pouco de precis√£o usando a biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">nmslib</a> .  Ele usa o m√©todo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">HNSW</a> para aproximar a busca por <code>k</code> vizinhos mais pr√≥ximos.  Para todos os vetores dispon√≠veis, um √≠ndice chamado deve ser constru√≠do, no qual uma pesquisa ser√° realizada.  Voc√™ pode criar e salvar o √≠ndice para a dist√¢ncia euclidiana da seguinte maneira: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> nmslib index = nmslib.init(method=<span class="hljs-string"><span class="hljs-string">'hnsw'</span></span>, space=<span class="hljs-string"><span class="hljs-string">'l2'</span></span>, data_type=nmslib.DataType.DENSE_VECTOR) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> idx, emb <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> enumerate(embeddings): index.addDataPoint(idx, emb) index_time_params = { <span class="hljs-string"><span class="hljs-string">'indexThreadQty'</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">'skip_optimized_index'</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'post'</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">'delaunay_type'</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'M'</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-string"><span class="hljs-string">'efConstruction'</span></span>: <span class="hljs-number"><span class="hljs-number">2000</span></span> } index.createIndex(index_time_params, print_progress=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) index.saveIndex(<span class="hljs-string"><span class="hljs-string">'./assets/embeddings.bin'</span></span>)</code> </pre> <br><p>  Os par√¢metros <code>M</code> e <code>efConstruction</code> s√£o descritos em detalhes na <a href="">documenta√ß√£o</a> e s√£o selecionados experimentalmente com base na precis√£o necess√°ria, tempo de constru√ß√£o do √≠ndice e velocidade de pesquisa.  Antes de usar o √≠ndice, voc√™ deve fazer o download: </p><br><pre> <code class="python hljs">index = nmslib.init(method=<span class="hljs-string"><span class="hljs-string">'hnsw'</span></span>, space=<span class="hljs-string"><span class="hljs-string">'l2'</span></span>, data_type=nmslib.DataType.DENSE_VECTOR) index.loadIndex(<span class="hljs-string"><span class="hljs-string">'./assets/embeddings.bin'</span></span>) query_time_params = {<span class="hljs-string"><span class="hljs-string">'efSearch'</span></span>: <span class="hljs-number"><span class="hljs-number">400</span></span>} index.setQueryTimeParams(query_time_params)</code> </pre> <br><p>  O par√¢metro <code>efSearch</code> afeta a precis√£o e a velocidade das consultas e pode n√£o corresponder ao <code>efConstruction</code> .  Agora voc√™ pode fazer pedidos. </p><br><pre> <code class="python hljs">ids, dists = index.knnQuery(embedding, k=<span class="hljs-number"><span class="hljs-number">1</span></span>) best_dx = ids[<span class="hljs-number"><span class="hljs-number">0</span></span>] best_dist = dists[<span class="hljs-number"><span class="hljs-number">0</span></span>]</code> </pre> <br><p>  No nosso caso, o <code>nmslib</code> √© 20 vezes mais r√°pido que a vers√£o linear vetorizada e uma solicita√ß√£o √© processada em m√©dia <code>0.005</code> segundos. </p><br><h3 id="kak-sdelat-moego-bota-gotovym-k-prodakshenu">  Como preparar meu bot para produ√ß√£o? </h3><br><h5 id="1-asinhronnost">  1. Assincronia </h5><br><p>  Primeiro, voc√™ precisa tornar a fun√ß√£o <code>handle_photo</code> ass√≠ncrona.  Como eu j√° disse, o <code>python-telegram-bot</code> oferece multithreading para isso e implementa um decorador conveniente. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> telegram.ext.dispatcher <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> run_async @run_async <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle_photo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bot, update)</span></span></span><span class="hljs-function">:</span></span> ...</code> </pre> <br><p>  Agora, a pr√≥pria estrutura iniciar√° seu manipulador em um thread separado em seu pool.  O tamanho do pool √© definido ao criar o <code>Updater</code> .  "Mas em python n√£o h√° multithreading!"  o mais impaciente de voc√™s j√° exclamou.  E isso n√£o √© inteiramente verdade.  Por causa do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GIL,</a> o c√≥digo Python comum realmente n√£o pode ser executado em paralelo, mas o GIL √© liberado para aguardar todas as opera√ß√µes de E / S e tamb√©m pode ser liberado pelas bibliotecas que usam extens√µes C. </p><br><p>  Agora analise nossa fun√ß√£o <code>handle_photo</code> : consiste apenas em aguardar opera√ß√µes de E / S (carregar uma foto, enviar uma resposta, ler uma foto do disco etc.) e chamar fun√ß√µes das bibliotecas <code>numpy</code> , <code>nmslib</code> e <code>Pillow</code> . </p><br><p>  Eu n√£o mencionei <code>dlib</code> por um motivo.  A biblioteca que chama o c√≥digo nativo n√£o √© necess√°ria para liberar o GIL e o <code>dlib</code> isso.  Ela n√£o precisa dessa trava, ela simplesmente n√£o a deixa ir.  O autor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">diz</a> que aceitar√° com prazer a solicita√ß√£o de solicita√ß√£o apropriada, mas sou muito pregui√ßoso. </p><br><h5 id="2-mnogoprocessnost">  2. Multiprocessamento </h5><br><p>  A maneira mais f√°cil de lidar com o <code>dlib</code> √© encapsular o modelo em uma entidade separada e execut√°-lo em um processo separado.  E melhor no pool de processos. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_worker_initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(config)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> model model = Model(config) model.load_state() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_worker_do</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(image)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> model.process_image(image) pool = multiprocessing.Pool(<span class="hljs-number"><span class="hljs-number">8</span></span>, initializer=_worker_initialize, initargs=(config,))</code> </pre> <br><pre> <code class="python hljs">result = pool.apply(_worker_do, (image,))</code> </pre> <br><h5 id="3-zhelezo">  3. Ferro </h5><br><p>  Se o seu bot precisar ler constantemente fotos de um disco, verifique se o disco √© um SSD.  Ou at√© mont√°-los na RAM.  Ping para servidores de telegrama e qualidade do canal tamb√©m √© importante. </p><br><h5 id="4-flood-control">  4. Controle de inunda√ß√£o </h5><br><p>  Os telegramas n√£o permitem que os bots enviem mais de 30 mensagens por segundo.  Se o seu bot √© popular e muitas pessoas o usam ao mesmo tempo, √© muito f√°cil banir por alguns segundos, o que ser√° uma decep√ß√£o para a expectativa de muitos usu√°rios.  Para resolver esse problema, o <code>python-telegram-bot</code> nos oferece uma fila que n√£o pode enviar mais do que o limite de mensagens especificado por segundo, mantendo intervalos iguais entre o envio. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> telegram.ext.messagequeue <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> MessageQueue</code> </pre> <br><p>  Para us√°-lo, voc√™ precisa definir seu pr√≥prio bot e substitu√≠-lo ao criar o <code>Updater</code> . </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> telegram.utils.promise <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Promise <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MQBot</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Bot)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, *args, **kwargs)</span></span></span><span class="hljs-function">:</span></span> super().__init__(*args, **kwargs) self._message_queue = MessageQueue( all_burst_limit=<span class="hljs-number"><span class="hljs-number">30</span></span>, all_time_limit_ms=<span class="hljs-number"><span class="hljs-number">1000</span></span> ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__del__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: self._message_queue.stop() <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>: super().__del__() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, *args, **kwargs)</span></span></span><span class="hljs-function">:</span></span> is_group = kwargs.get(<span class="hljs-string"><span class="hljs-string">'chat_id'</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self._message_queue(Promise(super().send_message, args, kwargs), is_group)</code> </pre> <br><pre> <code class="python hljs">bot = MQBot(token=TOKEN) updater = Updater(bot=bot)</code> </pre> <br><h5 id="5-web-hooks">  5. Ganchos da Web </h5><br><p>  Em um ambiente de produto, os Web Hooks sempre devem ser usados ‚Äã‚Äãem vez de Long Polling como forma de receber atualiza√ß√µes dos servidores de Telegram.  Sobre o que √© e como us√°-lo pode ser lido <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . </p><br><h5 id="6-melochi">  6. Curiosidades </h5><br><p>              <code>json</code> .    ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ultrajson</a> . </p><br><p>          IO-:    ,  ,  .      ,         . </p><br><h5 id="6-analitika"> 6.  </h5><br><p>   ,   .        ,   ,  ,       .        ,        . </p><br><p> , ,      BI-tool <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Splunk</a>     . </p><br><p><img src="https://habrastorage.org/webt/oh/8e/ve/oh8eve_hczr4pahrzum56fonxxg.jpeg" alt="Advertising Plank (estenda-nos uma licen√ßa)"></p><br><p>   ,         .     ,                       . </p><br><p>    ,         .      ,    : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">@OkkoFaceBot</a> . </p><br><p><del>        </del> ,     . ,      . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt417329/">https://habr.com/ru/post/pt417329/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt417319/index.html">Sistemas no caso ou O que realmente est√° sob a cobertura do microprocessador</a></li>
<li><a href="../pt417321/index.html">Como procuramos professores de cursos on-line entre desenvolvedores?</a></li>
<li><a href="../pt417323/index.html">Problemas para garantir 100% de acessibilidade ao projeto</a></li>
<li><a href="../pt417325/index.html">Dia Aberto da Netrologia, Tema de Ci√™ncia de Dados</a></li>
<li><a href="../pt417327/index.html">Monitoramento de or√ßamento da temperatura na sala do servidor (MP707 + nettop com Linux + PRTG)</a></li>
<li><a href="../pt417331/index.html">Semana 26 de Seguran√ßa: Spectre atualizado, agora com grava√ß√£o de bom gosto</a></li>
<li><a href="../pt417333/index.html">Classifica√ß√£o social</a></li>
<li><a href="../pt417337/index.html">Princ√≠pios de opera√ß√£o e aplica√ß√£o de troca at√¥mica</a></li>
<li><a href="../pt417339/index.html">3DTouch - Escalas no iPhone: Conclus√£o</a></li>
<li><a href="../pt417345/index.html">Ca√ßa a amea√ßas com visibilidade da Cisco</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>