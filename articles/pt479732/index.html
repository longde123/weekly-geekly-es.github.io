<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåõ ‚õπüèæ ‚ùóÔ∏è Pare de emitir outra coisa como um vazamento de mem√≥ria üßëüèº üßîüèº üìà</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At√© a presente data, muitos artigos foram escritos e voc√™ precisa cancelar a assinatura das assinaturas do Observable RxJS; caso contr√°rio, ocorrer√° u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pare de emitir outra coisa como um vazamento de mem√≥ria</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479732/"><p>  At√© a presente data, <a href="https://medium.com/alexonozor/angular-rxjs-please-always-unsubscribe-86ca55ba7f12" rel="nofollow">muitos</a> <a href="https://habr.com/ru/post/351338/">artigos</a> foram escritos e <a href="https://medium.com/ngx/why-do-you-need-unsubscribe-ee0c62b5d21f" rel="nofollow">voc√™ precisa cancelar a assinatura</a> das <a href="https://medium.com/ngx/why-do-you-need-unsubscribe-ee0c62b5d21f" rel="nofollow">assinaturas</a> do Observable RxJS; caso contr√°rio, ocorrer√° <strong>um vazamento de mem√≥ria</strong> .  A maioria dos leitores desses artigos tinha a firme regra de "se inscrever? - assinar!"  Infelizmente, por√©m, frequentemente nesses artigos as informa√ß√µes s√£o distorcidas ou algo n√£o √© negociado, e ainda pior quando os conceitos s√£o substitu√≠dos.  N√≥s vamos falar sobre isso. </p><br><p><img src="https://habrastorage.org/webt/oa/f5/pf/oaf5pfujlesdzjavtjopl6z4_gi.jpeg"></p><a name="habracut"></a><br><p>  Tomemos, por exemplo, este artigo: <a href="https://medium.com/ngx/why-do-you-need-unsubscribe-ee0c62b5d21f" rel="nofollow">https://medium.com/ngx/why-do-you-need-unsubscribe-ee0c62b5d21f</a> </p><br><p><img src="https://habrastorage.org/webt/n2/av/hm/n2avhmxwuemrtc0tvv7noyhl2za.png"></p><br><p>  Quando me dizem sobre a "oportunidade <strong>potencial</strong> de obter uma regress√£o da produtividade", penso imediatamente na <a href="http://optimization.guide/" rel="nofollow">otimiza√ß√£o prematura</a> . </p><br><p><img src="https://habrastorage.org/webt/on/__/rg/on__rgsm7admmp7p1u9t2gok4mu.png"></p><br><p><img src="https://habrastorage.org/webt/hw/rz/rw/hwrzrwkwlzlxmdhi3d2uusuj7sa.png"></p><br><p>  Continuamos a ler o artigo do homem sob o apelido de <strong>Raposa Reativa</strong> : <br><img src="https://habrastorage.org/webt/fn/6j/qn/fn6jqnrypjv7e1zo_v9kg43jkv4.png"></p><br><p><img src="https://habrastorage.org/webt/ue/w2/mg/uew2mga3qjig9rint74jn7i0q0q.png"></p><br><p>  Al√©m disso, h√° informa√ß√µes e dicas √∫teis.  Concordo que voc√™ sempre deve cancelar a inscri√ß√£o de <strong>fluxos intermin√°veis ‚Äã‚Äãno RxJS</strong> .  Mas eu me concentro apenas em informa√ß√µes prejudiciais (na minha opini√£o). <br><img src="https://habrastorage.org/webt/e1/ep/rz/e1eprzkk7depkecysfapwnlmhkc.png"></p><br><p>  Uau ... apanhados com o horror.  Tal intimida√ß√£o sem fundamento (sem m√©tricas, n√∫meros ...) no momento atual levou ao fato de que, para um n√∫mero muito grande de participantes, a falta de cancelamento de inscri√ß√£o √© como um pano vermelho para um touro.  Quando trope√ßam nisso, n√£o v√™em mais nada a n√£o ser esse trapo. <br><img src="https://habrastorage.org/webt/1i/-o/c_/1i-oc_a48-jwxjp7xyfgofkajpe.jpeg"></p><br><p>  O autor do artigo at√© fez um aplicativo de demonstra√ß√£o, onde tentou provar seus pensamentos: <br>  <a href="https://stackblitz.com/edit/why-you-have-to-unsubscribe-from-observable-material" rel="nofollow">https://stackblitz.com/edit/why-you-have-to-unsubscribe-from-observable-material</a> </p><br><p>  De fato, por seu lado, voc√™ pode ver como o processador funciona desnecessariamente (quando n√£o clico em nada) e como o consumo de mem√≥ria aumenta (pequenas altera√ß√µes): </p><br><p> <a href="" rel="nofollow"><img src="https://habrastorage.org/webt/lm/4r/p_/lm4rp_3sl0zqb11rf5dsufwdole.png"></a> </p><br><p>  Como confirma√ß√£o do fato de que voc√™ <strong>sempre</strong> precisa cancelar <strong>a</strong> inscri√ß√£o nas solicita√ß√µes do Observable <strong>HttpClient</strong> , ele adicionou um interceptador de solicita√ß√£o que exibe "ainda vivo ... ainda vivo ... ainda vivo ..." no console: <br><img src="https://habrastorage.org/webt/cs/m-/tz/csm-tzst2fx6prkarqwx_dfc_k4.png"><br>  I.e.  a pessoa interceptou o fluxo final, o tornou <strong>infinito</strong> (no caso de um erro, a solicita√ß√£o √© repetida, mas o erro sempre ocorre) e fornece isso como evid√™ncia de que voc√™ precisa cancelar a inscri√ß√£o dos finais. </p><br><p>  <strong>O StackBlitz</strong> n√£o <strong>√©</strong> muito adequado para medir o desempenho de aplicativos, pois  h√° sincroniza√ß√£o autom√°tica durante a atualiza√ß√£o e consome recursos.  Ent√£o, eu fiz meu aplicativo de teste: <a href="https://github.com/andchir/test-angular-app" rel="nofollow">https://github.com/andchir/test-angular-app</a> </p><br><p>  Existem duas janelas l√°.  Quando voc√™ abre cada um, uma solicita√ß√£o √© enviada para <strong>action.php</strong> , na qual h√° um atraso de 3 segundos como uma imita√ß√£o de uma opera√ß√£o que <strong>consome</strong> muitos recursos.  O <strong>action.php</strong> tamb√©m registra todas as solicita√ß√µes no arquivo <strong>log.txt</strong> . </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo Action.php</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> header(<span class="hljs-string"><span class="hljs-string">'Content-Type: application/json'</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">logging</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($str, $fileName = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'log.txt'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_array($str)) { $str = json_encode($str); } $rootPath = <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span>; $logFilePath = $rootPath . DIRECTORY_SEPARATOR . $fileName; $options = [ <span class="hljs-string"><span class="hljs-string">'max_log_size'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">200</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!is_dir(dirname($logFilePath))) { mkdir(dirname($logFilePath)); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (file_exists($logFilePath) &amp;&amp; filesize($logFilePath) &gt;= $options[<span class="hljs-string"><span class="hljs-string">'max_log_size'</span></span>]) { unlink($logFilePath); } $fp = fopen( $logFilePath, <span class="hljs-string"><span class="hljs-string">'a'</span></span> ); $dateFormat = <span class="hljs-string"><span class="hljs-string">'d/m/YH:i:s'</span></span>; $str = PHP_EOL . PHP_EOL . date($dateFormat) . PHP_EOL . $str; fwrite( $fp, $str ); fclose( $fp ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } $actionName = <span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_GET[<span class="hljs-string"><span class="hljs-string">'a'</span></span>]) &amp;&amp; !is_array($_GET[<span class="hljs-string"><span class="hljs-string">'a'</span></span>]) ? $_GET[<span class="hljs-string"><span class="hljs-string">'a'</span></span>] : <span class="hljs-string"><span class="hljs-string">'1'</span></span>; logging(<span class="hljs-string"><span class="hljs-string">"STARTED-{$actionName}"</span></span>); sleep(<span class="hljs-number"><span class="hljs-number">3</span></span>);<span class="hljs-comment"><span class="hljs-comment">// Very resource-intensive operation that takes 3 seconds logging("COMPLETED-{$actionName}"); echo json_encode([ 'success' =&gt; true, 'data' =&gt; ['name' =&gt; 'test', 'title' =&gt; 'This is a test'] ]);</span></span></code> </pre> </div></div><br><p>  Mas primeiro, uma pequena digress√£o.  Na imagem abaixo (clic√°vel), voc√™ pode ver um exemplo simples de como o coletor de lixo JavaScript funciona no navegador Chrome.  PUSH ocorreu, mas setTimeout n√£o impediu o coletor de lixo de limpar a mem√≥ria. <br> <a href="" rel="nofollow"><img src="https://habrastorage.org/webt/ly/r0/1w/lyr01wmysa9pphmphoj8aa39aaq.png"></a> </p><br><p>  N√£o se esque√ßa de ligar para o coletor de lixo com o toque de um bot√£o ao experimentar. <br><img src="https://habrastorage.org/webt/ir/k4/j4/irk4j4izd09-npb06n2zysccpum.png"></p><br><p>  Vamos voltar ao meu aplicativo de teste.  Aqui est√° o c√≥digo para ambas as janelas: </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo BadModalComponent</b> <div class="spoiler_text"><pre> <code class="javascript hljs">@Component({ <span class="hljs-attr"><span class="hljs-attr">selector</span></span>: <span class="hljs-string"><span class="hljs-string">'app-bad-modal'</span></span>, <span class="hljs-attr"><span class="hljs-attr">templateUrl</span></span>: <span class="hljs-string"><span class="hljs-string">'./bad-modal.component.html'</span></span>, <span class="hljs-attr"><span class="hljs-attr">styleUrls</span></span>: [<span class="hljs-string"><span class="hljs-string">'./bad-modal.component.css'</span></span>], <span class="hljs-attr"><span class="hljs-attr">providers</span></span>: [HttpClient] }) <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BadModalComponent</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnInit</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnDestroy</span></span></span><span class="hljs-class"> </span></span>{ loading = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; largeData: number[] = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">new</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">Array</span></span></span></span><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1000000</span></span></span></span></span><span class="hljs-function">)).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fill</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span></span><span class="hljs-function">); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">destroyed$</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">new</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Subject</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">void</span></span></span><span class="hljs-function">&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">: </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DataInterface</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">constructor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> private http: HttpClient, private bsModalRef: BsModalRef </span></span></span><span class="hljs-function">) { } </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ngOnInit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">this</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">loadData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; } </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">loadData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">void</span></span></span><span class="hljs-function"> { // </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">For</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">example</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">only</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">not</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">for</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">production</span></span></span><span class="hljs-function">. </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">this</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">loading</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">true</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">const</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">subscription</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">this</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">http</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">get</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DataInterface</span></span></span><span class="hljs-function">&gt;(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'/action.php?a=2'</span></span></span></span></span><span class="hljs-function">).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">pipe</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> takeUntil(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params">.destroyed$</span></span></span><span class="hljs-function">), </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">catchError</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(err</span></span></span><span class="hljs-function">) =&gt;</span></span> throwError(err.message)), finalize(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'FINALIZE'</span></span>)) ) .subscribe({ <span class="hljs-attr"><span class="hljs-attr">next</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">res</span></span></span><span class="hljs-function">) =&gt;</span></span> { setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(subscription.closed ? <span class="hljs-string"><span class="hljs-string">'SUBSCRIPTION IS CLOSED'</span></span> : <span class="hljs-string"><span class="hljs-string">'SUBSCRIPTION IS NOT CLOSED!'</span></span>); }, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'LOADED'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.data = res; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.loading = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }, <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">) =&gt;</span></span> { setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(subscription.closed ? <span class="hljs-string"><span class="hljs-string">'ERROR - SUBSCRIPTION IS CLOSED'</span></span> : <span class="hljs-string"><span class="hljs-string">'ERROR - SUBSCRIPTION IS NOT CLOSED!'</span></span>); }, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'ERROR'</span></span>, error); }, <span class="hljs-attr"><span class="hljs-attr">complete</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(subscription.closed ? <span class="hljs-string"><span class="hljs-string">'COMPLETED - SUBSCRIPTION IS CLOSED'</span></span> : <span class="hljs-string"><span class="hljs-string">'COMPLETED - SUBSCRIPTION IS NOT CLOSED!'</span></span>); }, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'COMPLETED'</span></span>); } }); } close(event?: MouseEvent): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (event) { event.preventDefault(); } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bsModalRef.hide(); } ngOnDestroy() { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'DESTROY'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.destroyed$.next(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.destroyed$.complete(); } }</code> </pre> </div></div><br><p>  Como voc√™ pode ver, h√° um cancelamento de assinatura (takeUntil).  Tudo como o "professor" nos aconselhou.  H√° tamb√©m uma grande variedade. </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo GoodModalComponent</b> <div class="spoiler_text"><pre> <code class="javascript hljs">@Component({ <span class="hljs-attr"><span class="hljs-attr">selector</span></span>: <span class="hljs-string"><span class="hljs-string">'app-good-modal'</span></span>, <span class="hljs-attr"><span class="hljs-attr">templateUrl</span></span>: <span class="hljs-string"><span class="hljs-string">'./good-modal.component.html'</span></span>, <span class="hljs-attr"><span class="hljs-attr">styleUrls</span></span>: [<span class="hljs-string"><span class="hljs-string">'./good-modal.component.css'</span></span>] }) <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GoodModalComponent</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnInit</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnDestroy</span></span></span><span class="hljs-class"> </span></span>{ loading = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; largeData: number[] = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">new</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">Array</span></span></span></span><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1000000</span></span></span></span></span><span class="hljs-function">)).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fill</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span></span><span class="hljs-function">); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">: </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DataInterface</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">constructor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> private http: HttpClient, private bsModalRef: BsModalRef </span></span></span><span class="hljs-function">) { } </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ngOnInit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">this</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">loadData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; } </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">loadData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">void</span></span></span><span class="hljs-function"> { // </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">For</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">example</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">only</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">not</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">for</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">production</span></span></span><span class="hljs-function">. </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">this</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">loading</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">true</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">const</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">subscription</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">this</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">http</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">get</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DataInterface</span></span></span><span class="hljs-function">&gt;(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'/action.php?a=1'</span></span></span></span></span><span class="hljs-function">).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">pipe</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> catchError((err</span></span></span><span class="hljs-function">) =&gt;</span></span> throwError(err.message)), finalize(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'FINALIZE'</span></span>)) ) .subscribe({ <span class="hljs-attr"><span class="hljs-attr">next</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">res</span></span></span><span class="hljs-function">) =&gt;</span></span> { setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(subscription.closed ? <span class="hljs-string"><span class="hljs-string">'SUBSCRIPTION IS CLOSED'</span></span> : <span class="hljs-string"><span class="hljs-string">'SUBSCRIPTION IS NOT CLOSED!'</span></span>); }, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'LOADED'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.data = res; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.loading = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }, <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">) =&gt;</span></span> { setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(subscription.closed ? <span class="hljs-string"><span class="hljs-string">'ERROR - SUBSCRIPTION IS CLOSED'</span></span> : <span class="hljs-string"><span class="hljs-string">'ERROR - SUBSCRIPTION IS NOT CLOSED!'</span></span>); }, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'ERROR'</span></span>, error); }, <span class="hljs-attr"><span class="hljs-attr">complete</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(subscription.closed ? <span class="hljs-string"><span class="hljs-string">'COMPLETED - SUBSCRIPTION IS CLOSED'</span></span> : <span class="hljs-string"><span class="hljs-string">'COMPLETED - SUBSCRIPTION IS NOT CLOSED!'</span></span>); }, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'COMPLETED'</span></span>); } }); } close(event?: MouseEvent): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (event) { event.preventDefault(); } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bsModalRef.hide(); } ngOnDestroy() { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'DESTROY'</span></span>); } }</code> </pre> </div></div><br><p>  Existe exatamente a mesma propriedade com uma matriz grande, mas n√£o h√° cancelamento de inscri√ß√£o.  E isso n√£o me impede de chamar essa janela de boa.  Por que - depois. </p><br><p>  Assista ao v√≠deo: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/jQ5qLosbnOY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Como voc√™ pode ver, em ambos os casos, ap√≥s alternar para o segundo componente, o coletor de lixo retornou com √™xito a mem√≥ria aos valores normais.  Sim, seria poss√≠vel limpar a mem√≥ria tamb√©m ap√≥s o fechamento das janelas, mas em nosso experimento isso n√£o √© importante.  Acontece que o "professor" estava errado quando ele disse: </p><br><blockquote>  Por exemplo, voc√™ fez uma solicita√ß√£o, mas quando a resposta ainda n√£o chegou do back-end, voc√™ destr√≥i o componente como desnecess√°rio; <strong>sua assinatura manter√° o link para o componente</strong> , criando um poss√≠vel vazamento de mem√≥ria. </blockquote><p>  Sim, ele est√° falando sobre um vazamento <strong>"potencial"</strong> .  Mas, se o fluxo for finito, n√£o haver√° vazamento de mem√≥ria. </p><br><p>  Prevejo as exclama√ß√µes indignadas de tais "professores".  Definitivamente, eles nos dizem algo como: <em>"ok, n√£o h√° vazamento de mem√≥ria, mas, ao <strong>cancelar a inscri√ß√£o</strong> , tamb√©m <strong>cancelamos a solicita√ß√£o</strong> , o que significa que teremos certeza de que nenhum c√≥digo ser√° mais executado ap√≥s receber uma resposta do servidor"</em> .  Em primeiro lugar, n√£o estou dizendo que cancelar a inscri√ß√£o √© <strong>sempre</strong> ruim, apenas estou dizendo que voc√™ est√° <strong>substituindo conceitos</strong> .  Sim, o fato de que, depois que a resposta chegar, alguma opera√ß√£o mais in√∫til ser√° executada √© ruim, mas <strong>voc√™ s√≥ pode se proteger de um vazamento de mem√≥ria real cancelando a inscri√ß√£o</strong> (nesse caso) e pode se proteger de <strong>outros efeitos indesej√°veis ‚Äã‚Äãde</strong> <strong>outras maneiras</strong> .  N√£o h√° necessidade de intimidar os leitores e impor seu pr√≥prio estilo de escrever c√≥digo neles. </p><br><p>  Sempre precisamos cancelar a solicita√ß√£o se o usu√°rio mudar de id√©ia?  Nem sempre!  N√£o esque√ßa que voc√™ cancelou a solicita√ß√£o, <strong>mas n√£o cancelou a opera√ß√£o no servidor</strong> .  Imagine que um usu√°rio abriu um componente, algo carregou por um longo tempo e ele alternou para outro componente.  √â poss√≠vel que o <strong>servidor esteja carregado e n√£o lide</strong> com todas as solicita√ß√µes e opera√ß√µes.  Nesse caso, o usu√°rio pode puxar freneticamente todos os links na navega√ß√£o e criar uma <strong>carga</strong> ainda <strong>maior no servidor</strong> , porque <strong>a solicita√ß√£o n√£o para no lado do servidor</strong> (na maioria dos casos). </p><br><p>  Assista ao v√≠deo a seguir: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/uAEka7a5_eA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Eu fiz o usu√°rio esperar por uma resposta.  Na maioria dos casos, a resposta vir√° rapidamente e o usu√°rio n√£o experimentar√° nenhum inconveniente.  <strong>Mas, dessa forma, evitaremos que o servidor execute opera√ß√µes pesadas repetidas, se houver.</strong> </p><br><p>  Resumo: </p><br><ul><li>  N√£o estou dizendo que <strong>voc√™</strong> n√£o precisa cancelar a inscri√ß√£o nas assinaturas RxJS de solicita√ß√µes HttpClient.  Eu apenas digo que h√° momentos em que isso n√£o √© necess√°rio.  N√£o h√° necessidade de substituir conceitos.  Se voc√™ est√° falando sobre um vazamento de mem√≥ria, mostre esse vazamento.  N√£o √© o seu <strong>console.log</strong> intermin√°vel, ou seja, um vazamento.  Em que a mem√≥ria √© medida?  Em que tempo √© medido o tempo de opera√ß√£o?  √â isso que precisa ser mostrado. </li><li>  N√£o chamo minha solu√ß√£o, que apliquei no aplicativo de teste, de ‚Äúbala de prata‚Äù.  <strong>Pelo contr√°rio, exorto o candidato a ter mais liberdade.</strong>  Deixe-o decidir como escrever seu c√≥digo.  N√£o h√° necessidade de intimid√°-lo e impor seu pr√≥prio estilo de desenvolvimento. </li><li>  Sou contra o fanatismo e a otimiza√ß√£o prematura.  Eu tenho visto muito disso ultimamente. </li><li>  O navegador possui m√©todos mais avan√ßados para encontrar vazamentos de mem√≥ria do que o que eu mostrei.  Penso que, no meu caso, a aplica√ß√£o deste m√©todo simples √© suficiente.  Mas eu recomendo que voc√™ se familiarize com o t√≥pico com mais detalhes, por exemplo, neste artigo: <a href="https://habr.com/ru/post/309318/">https://habr.com/en/post/309318/</a> . </li></ul><br><p>  <strong>UPD # 1</strong> <br>  No momento, o post cedeu por quase um dia.  No come√ßo, ele foi aos pr√≥s e contras, depois a avalia√ß√£o parou em zero.  Isso significa que o p√∫blico foi dividido exatamente em dois campos.  N√£o sei se isso √© bom ou ruim. </p><br><p>  <strong>UPD # 2</strong> <br>  Nos coment√°rios, Jet Fox apareceu (o autor do artigo sendo analisado).  No come√ßo, ele me agradeceu, ele foi muito educado.  Mas, vendo a passividade do p√∫blico, ele come√ßou a pressionar.  Chegou ao ponto em que ele <a href="https://habr.com/ru/post/479732/">escreveu</a> que eu deveria me desculpar.  I.e.  ele mentiu (encontra-se delineado com uma moldura amarela acima), e eu deveria me desculpar. <br>  No come√ßo, pensei que o interceptador de fluxos com repeti√ß√µes sem fim (bem, 2-3 repeti√ß√µes), que ele escreveu em seu aplicativo de demonstra√ß√£o, √© apenas para testes e informa√ß√µes.  Mas acabou que ele o <a href="https://habr.com/ru/post/479732/">considerou</a> um exemplo da vida.  I.e.  bloquear o bot√£o de uma janela - √© <a href="https://habr.com/ru/post/479732/">imposs√≠vel</a> .  E para criar esses interceptores, violando os princ√≠pios do SOLID, violando a modularidade do aplicativo (m√≥dulos e componentes devem ser independentes um do outro), permitindo que os testes de unidade de suas unidades (componentes, servi√ßos) sejam realizados na floresta - voc√™ pode.  Imagine a situa√ß√£o: voc√™ escreveu um componente, escreveu testes de unidade para ele.  E ent√£o esse Fox aparece, adiciona um interceptador semelhante ao seu aplicativo e seus testes se tornam in√∫teis.  Depois, ele ainda diz: "Por que voc√™ n√£o previu que eu gostaria de adicionar um interceptador desse tipo? Bem, corrija seu c√≥digo".  Talvez isso possa ser uma realidade em sua equipe, mas n√£o acho que isso deva ser incentivado ou fazer vista grossa para ele. </p><br><p>  <strong>UPD # 3</strong> <br>  Os coment√°rios discutem principalmente assinaturas e cancelamentos de inscri√ß√£o.  √â um post chamado "Cancelar a inscri√ß√£o no mal"?  N√£o.  N√£o pe√ßo que voc√™ n√£o cancele sua inscri√ß√£o.  Fa√ßa como voc√™ fez antes.  Mas voc√™ deve entender por que est√° fazendo isso.  Cancelar a inscri√ß√£o n√£o √© uma otimiza√ß√£o prematura.  Mas, entrando no caminho da prote√ß√£o contra amea√ßas em potencial (como o autor do artigo em an√°lise nos chama), voc√™ pode cruzar a linha.  Ent√£o, seu c√≥digo pode ficar sobrecarregado e dif√≠cil de manter. <br>  Este artigo √© sobre fanatismo, o que leva √† distribui√ß√£o de informa√ß√µes n√£o verificadas.  Em alguns casos, √© necess√°rio relacionar-se com a aus√™ncia de cancelamento de inscri√ß√£o com mais calma (voc√™ precisa entender claramente se existe um problema em um caso espec√≠fico). </p><br><p>  <strong>UPD # 4</strong> </p><br><blockquote>  Pelo contr√°rio, exorto o candidato a ter mais liberdade.  Deixe-o decidir como escrever seu c√≥digo. </blockquote><p>  Aqui voc√™ precisa esclarecer.  Eu sou a favor dos padr√µes.  Mas o padr√£o pode ser definido pelo autor da biblioteca ou por sua equipe, enquanto isso n√£o √© (na documenta√ß√£o e oficialmente).  Por exemplo, a documenta√ß√£o da estrutura do Symfony possui uma se√ß√£o <a href="https://symfony.com/doc/current/best_practices.html" rel="nofollow">Melhores pr√°ticas</a> .  Se fosse o mesmo na documenta√ß√£o do RxJS e dissesse "assinatura cancelada", eu n√£o teria o desejo de discutir com ele. </p><br><p>  <strong>UPD # 5</strong> <br>  Coment√°rio importante com respostas de pessoas respeit√°veis: <br>  <a href="https://habr.com/ru/post/479732/">https://habr.com/en/post/479732/#comment_21012620</a> <br>  A recomenda√ß√£o para cumprir o <strong>contrato de "assinatura com cancelamento de assinatura"</strong> do desenvolvedor do RxJS <strong>existe</strong> , mas n√£o oficialmente. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt479732/">https://habr.com/ru/post/pt479732/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt479716/index.html">Outro SuperApp "primeiro do mundo"</a></li>
<li><a href="../pt479718/index.html">Construindo um aplicativo de ambiente arduino usando o CI github</a></li>
<li><a href="../pt479724/index.html">Verdadeiros hackers acabaram</a></li>
<li><a href="../pt479726/index.html">Vladimir aka wowik: ‚ÄúO OpenStreetMap precisa de id√©ias que n√£o s√£o realiz√°veis ‚Äã‚Äãem outros sistemas‚Äù</a></li>
<li><a href="../pt479728/index.html">Como organizar uma inicializa√ß√£o bem-sucedida?</a></li>
<li><a href="../pt479736/index.html">C√¢meras ou lasers</a></li>
<li><a href="../pt479738/index.html">Como o Youtube e o Instagram: internacionalizando e localizando um aplicativo Python</a></li>
<li><a href="../pt479742/index.html">Quintal - uma malha de servi√ßo automatizada sobre uma infraestrutura h√≠brida e em v√°rias nuvens</a></li>
<li><a href="../pt479744/index.html">Gerenciamento de mem√≥ria Python: um pouco sobre a fragmenta√ß√£o de mem√≥ria</a></li>
<li><a href="../pt479746/index.html">O software corporativo torna seus funcion√°rios mais legais. Voc√™ precisa disso?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>