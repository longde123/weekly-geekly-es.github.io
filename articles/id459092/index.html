<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï° üèÇ üë®üèΩ‚Äçüî¨ X.Spectator - pemantauan negara dalam .NET üò´ üëâüèº üç∫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Saat ini, sebagian besar sistem informasi adalah solusi kompleks dengan arsitektur yang agak kompleks dan banyak saling ketergantungan. Selama pengope...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>X.Spectator - pemantauan negara dalam .NET</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459092/"><img src="https://habrastorage.org/webt/7o/ze/ym/7ozeymv3v4yjpenayz7cwhfjavi.png"><br><br>  Saat ini, sebagian besar sistem informasi adalah solusi kompleks dengan arsitektur yang agak kompleks dan banyak saling ketergantungan.  Selama pengoperasian sistem tersebut, pada saat beban puncak, beberapa modul mungkin gagal, atau mungkin tidak berfungsi dengan benar.  Dalam hal ini, sistem berhenti menjadi stabil dan mungkin berhenti memproses semua permintaan yang masuk dengan benar.  Untuk memastikan operasi sistem yang stabil, berbagai strategi dapat diimplementasikan. <br><a name="habracut"></a><br>  Dalam beberapa kasus (jika ini diizinkan), terjemahan sistem menjadi apa yang disebut.  "Mode aman".  Dalam mode ini, sistem dapat memproses lebih banyak panggilan dengan sedikit penurunan keakuratan hasil pemrosesan kueri.  Dalam kasus lain, penskalaan sumber daya komputasi dan meningkatkan jumlah modul sistem individual yang bertanggung jawab untuk memproses permintaan yang masuk dapat membantu.  Dalam hal ini, tugas yang paling penting adalah <b>menentukan keadaan sistem</b> , tergantung pada yang mana, satu atau tindakan lain harus sudah diambil untuk menstabilkan pekerjaannya. <br><br>  Dalam proyek-proyek saya, saya telah memecahkan masalah serupa dengan berbagai cara selama beberapa waktu.  Sejak saya masih di universitas, saya memiliki proyek kecil yang ditulis dalam. NET 4.0, dari mana dari waktu ke waktu saya mengambil potongan kecil kode untuk proyek nyata.  Saya telah lama merencanakan untuk memperbaiki proyek ini, membersihkannya dan mengaturnya dalam bentuk kerangka kerja terpisah yang memungkinkan kita untuk dengan indah dan minimalis menyelesaikan masalah pemantauan keadaan sistem.  Setelah menghabiskan beberapa malam dan beberapa hari libur, saya menata kode ini dan mempostingnya di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">GitHub</a> .  Selanjutnya, saya mengusulkan untuk mempertimbangkan secara lebih rinci apa dan bagaimana diimplementasikan dalam proyek ini. <br><br>  Untuk menentukan perlunya mengubah mode operasi sistem, diusulkan untuk menggunakan pendekatan menggunakan "sensor" dan "pengamat" virtual. <br><br><img src="https://habrastorage.org/webt/ro/x1/zt/rox1ztsyy4gvvg85e-hkxdja9uy.png"><br><br><h2>  <font color="#ff9c00">‚ñå</font> Entitas dan definisi </h2><br>  Entitas dasar yang akan digunakan: <br><br><ul><li>  <b>Sensor</b> - bertanggung jawab untuk memeriksa status salah satu indikator sistem; </li><li>  <b>Pengamat</b> - menginterogasi satu, atau beberapa sensor.  Mengubah kondisinya tergantung pada pembacaan sensor saat ini; </li><li>  <b>Kalkulator</b> status - menghitung kondisi saat ini berdasarkan log metrik. </li><li>  <b>Status log</b> - satu set indikator untuk masing-masing sensor yang menunjukkan waktu pemungutan suara. </li></ul><br>  Untuk setiap abstraksi, ada implementasi dasar, serta mekanisme untuk ekspansi sederhana dan nyaman.  Mari kita pertimbangkan secara lebih rinci. <br><br><h3>  Sensor </h3><br>  Antarmuka <i>IProbe</i> dasar.  Kelas yang menerapkan IProbe memberikan, berdasarkan permintaan, nilai parameter sistem yang mereka amati, atau modul / layanan tertentu. <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IProbe</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-function">Task&lt;ProbeResult&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Check</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre> <br>  Sebagai hasil dari metode <i>Periksa</i> , instance IProbe mengembalikan struktur ProbeResult <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> ProbeResult { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ProbeName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime Time { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Success { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Data { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Exception Exception { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Time}</span></span></span><span class="hljs-string">: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Success}</span></span></span><span class="hljs-string">"</span></span>; }</code> </pre><br>  di mana bidang Sukses menentukan apakah parameter diuji dengan sukses dari sudut pandang sensor, dan bidang Data dan Pengecualian dapat menyimpan informasi tambahan jika perlu untuk debugging, atau logging. <br><br><h3>  Pengamat </h3><br>  Antarmuka dasar <i>ISpectator</i> .  Ini memonitor sistem, menghasilkan peristiwa pada saat mengubah keadaan sistem untuk memberi tahu semua modul yang berlangganan acara ini.  Ia menggunakan instance kelas yang mengimplementasikan antarmuka IStateEvaluator untuk menghitung keadaan saat ini. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ISpectator</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TState</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TState</span></span> : <span class="hljs-title"><span class="hljs-title">struct</span></span>, <span class="hljs-title"><span class="hljs-title">IConvertible</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> EventHandler&lt;StateEventArgs&lt;TState&gt;&gt; StateChanged; <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> EventHandler&lt;HealthCheckEventArgs&gt; HealthChecked; TState State { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } TimeSpan Uptime { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddProbe</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IProbe probe</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckHealth</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre><br>  Selama setiap jajak pendapat sensor, pengamat meningkatkan acara StateChanged, dan objek tipe <a href="">StateEventArgs</a> diteruskan ke pelanggan acara ini, yang berisi informasi tentang kondisi sistem saat ini. <br><br><h3>  Kalkulator negara </h3><br>  Antarmuka <i>IEvaluator</i> dasar.  Menghitung kondisi sistem saat ini berdasarkan log status sensor. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IStateEvaluator</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TState</span></span>&gt; { <span class="hljs-function"><span class="hljs-function">TState </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Evaluate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> TState currentState, DateTime stateChangedLastTime, IReadOnlyCollection&lt;JournalRecord&gt; journal</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre><br><h3>  Log negara </h3><br>  Kumpulan contoh struktur JournalRecord.  Contoh JournalRecord menyimpan informasi tentang semua sensor yang disurvei pada saat polling diprakarsai oleh pengamat. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> JournalRecord { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">JournalRecord</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DateTime time, IEnumerable&lt;ProbeResult&gt; values</span></span></span><span class="hljs-function">)</span></span> { Time = time; Values = values.ToImmutableList(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime Time { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IReadOnlyCollection&lt;ProbeResult&gt; Values { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Time}</span></span></span><span class="hljs-string">: [</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.Join(</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">","</span></span></span></span><span class="hljs-string"><span class="hljs-subst">, Values)}</span></span></span><span class="hljs-string">]"</span></span>; }</code> </pre><br><h2>  <font color="#ff9c00">‚ñå</font> Cara kerjanya </h2><br>  Proses perhitungan keadaan sistem dapat digambarkan sebagai berikut: masing-masing sensor yang tertanam dalam sistem dapat menentukan salah satu parameter dari sistem / modul / layanan yang diamati.  Misalnya, dapat memperbaiki jumlah permintaan aktif eksternal ke API, jumlah RAM yang digunakan, jumlah entri dalam cache, dll. <br><br>  Setiap sensor dapat ditugaskan untuk satu atau beberapa pengamat.  Setiap pengamat dapat bekerja dengan satu atau beberapa sensor.  Pengamat harus mengimplementasikan antarmuka ISpectator dan menghasilkan peristiwa jika terjadi perubahan status, atau pemungutan suara sensor. <br><br>  Selama pemeriksaan selanjutnya dari keadaan sistem, pengamat mengumpulkan semua "sensor" -nya, membentuk sebuah array untuk menulis ke log negara.  Jika keadaan sistem telah berubah, pengamat menghasilkan peristiwa yang sesuai.  Pelanggan acara yang menerima informasi tentang perubahan dapat mengubah parameter operasi sistem.  Pada saat yang sama, "komputer" dari berbagai jenis dapat digunakan untuk menentukan keadaan sistem. <br><br><h3>  Mode operasi sinkron dan asinkron </h3><br>  Pertimbangkan dua skenario utama di mana pengamat memulai survei "sensor". <br><br><h4>  Mode sinkron </h4><br>  Sebuah survei sensor diikuti oleh perhitungan ulang keadaan sistem disebabkan oleh daya tarik langsung dari salah satu modul sistem kepada pengamat. <br>  Dalam hal ini, pengamat dan sensor bekerja di utas yang sama.  Kesalahan perhitungan kondisi sistem dilakukan sebagai bagian dari operasi di dalam sistem. <br><br>  Proyek ini sudah memiliki implementasi dasar dari pengamat tersebut - <b>SpectatorBase</b> . <br><br><div class="spoiler">  <b class="spoiler_title">Lihat kode</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SpectatorBase</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TState</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">ISpectator</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TState</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TState</span></span> : <span class="hljs-title"><span class="hljs-title">struct</span></span>, <span class="hljs-title"><span class="hljs-title">IConvertible</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> TState _state; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IList&lt;IProbe&gt; _probes; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IStateEvaluator&lt;TState&gt; _stateEvaluator; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> List&lt;JournalRecord&gt; _journal; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ReaderWriterLockSlim _journalLock; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ReaderWriterLockSlim _stateLock; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Stopwatch _stopwatch; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> EventHandler&lt;StateEventArgs&lt;TState&gt;&gt; StateChanged; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> EventHandler&lt;HealthCheckEventArgs&gt; HealthChecked; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> TState State { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { _stateLock.EnterReadLock(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _state; } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { _stateLock.ExitReadLock(); } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TimeSpan Uptime =&gt; _stopwatch.Elapsed; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IReadOnlyCollection&lt;JournalRecord&gt; Journal { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { _journalLock.EnterReadLock(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _journal; } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { _journalLock.ExitReadLock(); } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime StateChangedDate { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TimeSpan RetentionPeriod { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SpectatorBase</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IStateEvaluator&lt;TState&gt; stateEvaluator, TimeSpan retentionPeriod, TState initialState</span></span></span><span class="hljs-function">)</span></span> { RetentionPeriod = retentionPeriod; _state = initialState; StateChangedDate = DateTime.UtcNow; _stateEvaluator = stateEvaluator; _stopwatch = Stopwatch.StartNew(); _probes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;IProbe&gt;(); _journal = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;JournalRecord&gt;(); _journalLock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReaderWriterLockSlim(); _stateLock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReaderWriterLockSlim(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddProbe</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IProbe probe</span></span></span><span class="hljs-function">)</span></span> =&gt; _probes.Add(probe); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ChangeState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TState state, IEnumerable&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; failedProbes</span></span></span><span class="hljs-function">)</span></span> { _stateLock.EnterWriteLock(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { _state = state; } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { _stateLock.ExitWriteLock(); } StateChangedDate = DateTime.UtcNow; StateChanged?.Invoke(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StateEventArgs&lt;TState&gt;(state, StateChangedDate, failedProbes)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckHealth</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> results = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Stack&lt;ProbeResult&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tasks = _probes .Select(<span class="hljs-keyword"><span class="hljs-keyword">async</span></span> o =&gt; { results.Push(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> o.Check().ConfigureAwait(<span class="hljs-literal"><span class="hljs-literal">false</span></span>)); }) .ToArray(); Task.WaitAll(tasks); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> now = DateTime.UtcNow; _journalLock.EnterWriteLock(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">//cleanup state records _journal.RemoveAll(o =&gt; o.Time &lt; now.Subtract(RetentionPeriod)); _journal.Add(new JournalRecord(now, results)); } finally { _journalLock.ExitWriteLock(); } //Recalculate state var state = _stateEvaluator.Evaluate(State, StateChangedDate, _journal); if (!EqualityComparer&lt;TState&gt;.Default.Equals(State, state)) { ChangeState(state, results.Where(o =&gt; !o.Success).Select(o =&gt; o.ProbeName)); } OnHealthChecked(now, results); } protected virtual void OnHealthChecked(DateTime now, IReadOnlyCollection&lt;ProbeResult&gt; results) =&gt; HealthChecked?.Invoke(this, new HealthCheckEventArgs(now, results)); }</span></span></code> </pre><br></div></div><br><h4>  Mode asinkron </h4><br>  Dalam hal ini, interogasi sensor terjadi secara asinkron dari proses sistem dan dapat dilakukan dalam utas terpisah.  Implementasi dasar dari pengamat semacam itu juga sudah merupakan proyek - <b>AutomatedSpectator</b> . <br><br><div class="spoiler">  <b class="spoiler_title">Lihat kode</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AutomatedSpectator</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TState</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">SpectatorBase</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TState</span></span>&gt;, <span class="hljs-title"><span class="hljs-title">IAutomatedSpectator</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TState</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TState</span></span> : <span class="hljs-title"><span class="hljs-title">struct</span></span>, <span class="hljs-title"><span class="hljs-title">IConvertible</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TimeSpan CheckHealthPeriod { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> System.Timers.Timer _timer; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AutomatedSpectator</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> TimeSpan checkHealthPeriod, TimeSpan retentionPeriod, IStateEvaluator&lt;TState&gt; stateEvaluator, TState initialState</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">stateEvaluator, retentionPeriod, initialState</span></span></span><span class="hljs-function">)</span></span> { CheckHealthPeriod = checkHealthPeriod; _timer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.Timers.Timer(CheckHealthPeriod.TotalMilliseconds); _timer.Elapsed += (sender, args) =&gt; CheckHealth(); _timer.AutoReset = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Start</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; _timer.Start(); }</code> </pre><br></div></div><br><h2>  <font color="#ff9c00">‚ñå</font> Kesimpulan </h2><br>  Menggunakan X.Spectator membantu saya secara pribadi dalam beberapa proyek yang sangat dimuat untuk secara signifikan meningkatkan stabilitas sejumlah layanan.  Kerangka yang diusulkan terbaik telah membuktikan dirinya ketika diimplementasikan dalam sistem terdistribusi yang dibangun atas dasar arsitektur microservice.  Pilihan integrasi yang paling optimal adalah menggunakan prinsip inversi kontrol, yaitu, implementasi dependensi, ketika proses penerapan sensor diimplementasikan menggunakan wadah IoC, dan pengamat disajikan dalam bentuk singletones, di mana satu instance dari masing-masing pengamat dapat diakses oleh berbagai kelas modul dan layanan. <br><br><h2>  <font color="#ff9c00">‚ñå</font> Tautan dan informasi bermanfaat </h2><br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Repositori proyek</a> <br>  ‚Üí <a href="">Contoh</a> <br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Paket NuGet</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id459092/">https://habr.com/ru/post/id459092/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id459082/index.html">Siapa eidetik, bagaimana ingatan salah bekerja, dan tiga mitos populer tentang ingatan</a></li>
<li><a href="../id459084/index.html">Sedikit tentang Google Home Hub, atau bagaimana saya membeli bingkai foto seharga 130 Euro</a></li>
<li><a href="../id459086/index.html">Distribusi statis objek FreeRTOS</a></li>
<li><a href="../id459088/index.html">Metode segmentasi titik dalam Point Clouds</a></li>
<li><a href="../id459090/index.html">Bawa pengalaman pengembangan Linux Anda di Windows ke level berikutnya dengan WSL dan Visual Studio Code Remote</a></li>
<li><a href="../id459094/index.html">C # atau Java? TypeScript atau JavaScript? Pembelajaran berbasis mesin klasifikasi bahasa pemrograman</a></li>
<li><a href="../id459098/index.html">Registry Paket GitHub akan mendukung paket Swift</a></li>
<li><a href="../id459100/index.html">Registry Paket GitHub akan mendukung paket Swift</a></li>
<li><a href="../id459102/index.html">Hadiah piring atau musik gratis untuk pecinta cola dan sarapan siap saji</a></li>
<li><a href="../id459104/index.html">C # atau Java? TypeScript atau JavaScript? Klasifikasi bahasa pemrograman berdasarkan pembelajaran mesin</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>