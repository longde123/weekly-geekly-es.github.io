<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨‍👩‍👧‍👦 🌅 🙈 7 étapes pour utiliser Room. Procédure pas à pas pour la migration de votre application vers Room 🤲🏾 🌾 👧🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Room est une bibliothèque qui fait partie des composants architecturaux d' Android. Il facilite l' SQLiteDatabase objets SQLiteDatabase dans l'applica...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>7 étapes pour utiliser Room. Procédure pas à pas pour la migration de votre application vers Room</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/441934/"><p><img src="https://habrastorage.org/getpro/habr/post_images/810/7f6/165/8107f6165672ecb492fe2ff90d693b05.png" alt="7 étapes pour utiliser Room. Procédure pas à pas pour la migration de votre application vers Room"></p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Room</a> est une bibliothèque qui fait partie des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">composants architecturaux d'</a> Android.  Il facilite l' <code>SQLiteDatabase</code> objets <code>SQLiteDatabase</code> dans l'application, réduisant la quantité de code standard et vérifiant les requêtes SQL au moment de la compilation. </p><br><p>  Vous avez déjà un projet Android qui utilise SQLite pour stocker des données?  Si tel est le cas, vous pouvez le migrer vers Room.  Voyons comment prendre un projet existant et le refactoriser pour utiliser Room en 7 étapes simples. </p><br><blockquote>  <em><strong>TL; DR:</strong> mettez à jour les dépendances de gradle, créez vos entités, DAO et base de données, remplacez les appels <code>SQLiteDatabase</code> appels de méthode DAO, testez tout ce que vous avez créé ou modifié et supprimez les classes inutilisées.</em>  <em>C'est tout!</em> </blockquote><a name="habracut"></a><br><p>  Dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">notre exemple d'application</a> pour la migration, nous travaillons avec des objets de type <code>User</code> .  Nous avons utilisé des versions de produit pour démontrer diverses implémentations au niveau des données: </p><br><ol><li>  <strong>sqlite</strong> - utilise <code>SQLiteOpenHelper</code> et les interfaces SQLite traditionnelles. </li><li>  <strong>room</strong> - remplace l'implémentation par Room et permet la migration. </li></ol><br><p>  Chaque option utilise la même couche d'interface utilisateur, qui fonctionne avec la classe <code>UserRepository</code> grâce au modèle MVP. </p><br><p>  Dans la variante sqlite, vous verrez beaucoup de code qui est souvent dupliqué et utilise la base de données dans les <code>LocalUserDataSource</code> <code>UsersDbHelper</code> et <code>UsersDbHelper</code> .  Les requêtes sont <code>ContentValues</code> aide de <code>ContentValues</code> et les données renvoyées par les objets <code>Cursor</code> sont lues colonne par colonne.  Tout ce code contribue à l'apparition d'erreurs implicites.  Par exemple, vous pouvez ignorer l'ajout d'une colonne à une requête ou assembler de manière incorrecte un objet à partir d'une base de données. </p><br><p>  Voyons comment Room améliore notre code.  Au départ, nous copions simplement les classes de la variante sqlite et les modifions progressivement. </p><br><h2 id="shag-1-obnovlenie-zavisimostey-gradle">  Étape 1. Mise à jour des dépendances Gradle </h2><br><p>  Les dépendances pour Room sont disponibles via le nouveau référentiel Google Maven.  Ajoutez-le simplement à la liste des référentiels dans votre fichier <code>build.gradle</code> principal: </p><br><pre> <code class="plaintext hljs">allprojects { repositories { google() jcenter() } }</code> </pre> <br><p>  Définissez la version de la bibliothèque Room dans le même fichier.  Bien qu'il soit dans la version alpha, mais restez à l'écoute pour les mises à jour de version sur les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pages de développeur</a> : </p><br><pre> <code class="plaintext hljs">ext { roomVersion = '2.1.0-alpha03' }</code> </pre> <br><p>  Dans votre <code>app/build.gradle</code> ajoutez des dépendances pour Room: </p><br><pre> <code class="plaintext hljs">dependencies { implementation “android.arch.persistence.room:runtime:$rootProject.roomVersion” annotationProcessor “android.arch.persistence.room:compiler:$rootProject.roomVersion” androidTestImplementation “android.arch.persistence.room:testing:$rootProject.roomVersion” }</code> </pre> <br><p>  Pour migrer vers Room, nous devons augmenter la version de la base de données et pour enregistrer les données utilisateur, nous devons implémenter la classe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Migration</a> .  Pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tester la migration</a> , nous devons exporter le schéma.  Pour ce faire, ajoutez le code suivant au <code>app/build.gradle</code> : </p><br><pre> <code class="plaintext hljs">android { defaultConfig { ... // used by Room, to test migrations javaCompileOptions { annotationProcessorOptions { arguments = ["room.schemaLocation": "$projectDir/schemas".toString()] } } } // used by Room, to test migrations sourceSets { androidTest.assets.srcDirs += files("$projectDir/schemas".toString()) } ...</code> </pre> <br><h2 id="shag-2-obnovlenie-klassov-modeli-do-suschnostey">  Étape 2. Mise à jour des classes de modèle en entités </h2><br><p>  Room crée une table pour chaque classe marquée <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">@Entity</a> .  Les champs de la classe correspondent aux colonnes du tableau.  Par conséquent, les classes d'entités sont, en règle générale, de petites classes de modèles qui ne contiennent aucune logique.  Notre classe <code>User</code> représente un modèle de données dans une base de données.  Donc, mettons-le à jour pour indiquer à Room qu'il doit créer une table basée sur cette classe: </p><br><ul><li>  <code>@Entity</code> la classe avec <code>@Entity</code> et utilisez la propriété <code>tableName</code> pour définir le nom de la table. </li><li>  Définissez la clé primaire en ajoutant l'annotation <code>@PrimaryKey</code> aux champs corrects - dans notre cas, il s'agit de l'ID utilisateur. </li><li>  Spécifiez le nom de colonne pour les champs de classe à l'aide de l'annotation <code>@ColumnInfo(name = "column_name")</code> .  Vous pouvez ignorer cette étape si vos champs sont déjà nommés car la colonne doit être nommée. </li><li>  S'il y a plusieurs constructeurs dans la classe, ajoutez l'annotation <code>@Ignore</code> pour indiquer à Room lequel utiliser et lequel ne pas le faire. </li></ul><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span>(tableName = <span class="hljs-string"><span class="hljs-string">"users"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@PrimaryKey</span></span> <span class="hljs-meta"><span class="hljs-meta">@ColumnInfo</span></span>(name = <span class="hljs-string"><span class="hljs-string">"userid"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String mId; <span class="hljs-meta"><span class="hljs-meta">@ColumnInfo</span></span>(name = <span class="hljs-string"><span class="hljs-string">"username"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String mUserName; <span class="hljs-meta"><span class="hljs-meta">@ColumnInfo</span></span>(name = <span class="hljs-string"><span class="hljs-string">"last_update"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Date mDate; <span class="hljs-meta"><span class="hljs-meta">@Ignore</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">User</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String userName)</span></span></span><span class="hljs-function"> </span></span>{ mId = UUID.randomUUID().toString(); mUserName = userName; mDate = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Date(System.currentTimeMillis()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">User</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String id, String userName, Date date)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mId = id; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mUserName = userName; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mDate = date; } ... }</code> </pre> <br><p>  <strong>Remarque:</strong> pour une migration en douceur, prêtez une attention particulière aux noms des tables et des colonnes dans l'implémentation d'origine et assurez-vous de les définir correctement dans les <code>@ColumnInfo</code> <code>@Entity</code> et <code>@ColumnInfo</code> . </p><br><h2 id="shag-3-sozdanie-obektov-dostupa-k-dannym-dao">  Étape 3. Création d'objets d'accès aux données (DAO) </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Les DAO</a> sont responsables de la définition des méthodes d'accès à la base de données.  Dans l'implémentation initiale de notre projet SQLite, toutes les requêtes de base de données ont été exécutées dans la classe <code>LocalUserDataSource</code> , où nous avons travaillé avec des objets <code>Cursor</code> .  Dans Room, nous n'avons pas besoin de tout le code associé au curseur, et nous pouvons simplement définir nos demandes à l'aide d'annotations dans la classe <code>UserDao</code> . </p><br><p>  Par exemple, lors de l'interrogation de tous les utilisateurs de la base de données, Room fait tout le «travail acharné», et nous avons juste besoin d'écrire: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Query</span></span>(“SELECT * FROM Users”) <span class="hljs-function"><span class="hljs-function">List&lt;User&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUsers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>;</code> </pre> <br><h2 id="shag-4-sozdanie-bazy-dannyh">  Étape 4. Création d'une base de données </h2><br><p>  Nous avons déjà défini notre table <code>Users</code> et ses requêtes correspondantes, mais nous n'avons pas encore créé de base de données qui réunira tous ces composants de Room.  Pour ce faire, nous devons définir une classe abstraite qui étend <code>RoomDatabase</code> .  Cette classe est marquée <code>@Database</code> , qui répertorie les objets contenus dans la base de données et le DAO qui y accèdent.  La version de la base de données devrait être augmentée de 1 par rapport à la valeur d'origine, donc dans notre cas, elle sera de 2. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Database</span></span>(entities = {User.class}, version = <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-meta"><span class="hljs-meta">@TypeConverters</span></span>(DateConverter.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UsersDatabase</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RoomDatabase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> UsersDatabase INSTANCE; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> UserDao </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">userDao</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>;</code> </pre> <br><p>  Puisque nous voulons enregistrer les données utilisateur, nous devons implémenter la classe <code>Migration</code> indiquant à Room ce qu'il doit faire lors du passage de la version 1 à 2. Dans notre cas, le schéma de la base de données n'ayant pas changé, nous fournissons simplement une implémentation vide: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Migration MIGRATION_1_2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Migration(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">migrate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SupportSQLiteDatabase database)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     ,      . } };</span></span></code> </pre> <br><p>  Créez un objet de base de données dans la classe <code>UsersDatabase</code> en définissant le nom de la base de données et la migration: </p><br><pre> <code class="java hljs">database = Room.databaseBuilder(context.getApplicationContext(), UsersDatabase.class, <span class="hljs-string"><span class="hljs-string">"Sample.db"</span></span>) .addMigrations(MIGRATION_1_2) .build();</code> </pre> <br><p>  Pour en savoir plus sur la façon d'implémenter la migration de base de données et leur fonctionnement sous le capot, consultez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cet article</a> . </p><br><h2 id="shag-5-obnovlenie-repozitoriya-dlya-ispolzovaniya-room">  Étape 5. Mise à jour du référentiel pour utiliser Room </h2><br><p>  Nous avons créé notre base de données, notre table d'utilisateurs et nos requêtes, il est donc temps de les utiliser.  À ce stade, nous mettrons à jour la classe <code>UserDao</code> pour utiliser les méthodes <code>UserDao</code> .  Pour ce faire, nous mettons d'abord à jour le constructeur: supprimez le <code>Context</code> et ajoutez <code>UserDao</code> .  Bien sûr, toute classe qui crée une instance de <code>LocalUserDataSource</code> doit également être mise à jour. </p><br><p>  Ensuite, nous mettrons à jour les méthodes <code>LocalUserDataSource</code> qui effectuent des requêtes en appelant les méthodes <code>UserDao</code> .  Par exemple, une méthode qui demande à tous les utilisateurs ressemble maintenant à ceci: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;User&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUsers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mUserDao.getUsers(); }</code> </pre> <br><p>  Et il est maintenant temps de lancer ce que nous avons fait. </p><br><p>  L'une des meilleures fonctionnalités de Room est que si vous effectuez des opérations de base de données sur le thread principal, votre application se bloque avec le message d'erreur suivant: </p><br><pre> <code class="xml hljs">java.lang.IllegalStateException: Cannot access database on the main thread since it may potentially lock the UI for a long period of time.</code> </pre> <br><p>  Un moyen fiable de déplacer les opérations d'E / S du thread principal consiste à créer un nouveau <code>Runnable</code> qui créera un nouveau thread pour chaque requête de base de données.  Comme nous utilisons déjà cette approche dans la variante sqlite, aucune modification n'a été requise. </p><br><h2 id="shag-6-testirovanie-na-ustroystve">  Étape 6. Test sur l'appareil </h2><br><p>  Nous avons créé de nouvelles classes - <code>UserDao</code> et <code>UsersDatabase</code> et changé notre <code>LocalUserDataSource</code> pour utiliser la base de données Room.  Maintenant, nous devons les tester. </p><br><h3 id="testirovanie-userdao">  Test de UserDao </h3><br><p>  Pour tester <code>UserDao</code> , nous devons créer une classe de test <code>AndroidJUnit4</code> .  La fonctionnalité étonnante de Room est la possibilité de créer une base de données en mémoire.  Cela élimine le besoin de nettoyage après chaque test. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initDb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ mDatabase = Room.inMemoryDatabaseBuilder( InstrumentationRegistry.getContext(), UsersDatabase.class) .build(); }</code> </pre> <br><p>  Nous devons également nous assurer que nous fermons la connexion à la base de données après chaque test. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@After</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">closeDb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ mDatabase.close(); }</code> </pre> <br><p>  Par exemple, pour tester la connexion d'un utilisateur, nous ajoutons un utilisateur, puis vérifions si nous pouvons obtenir cet utilisateur de la base de données. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">insertAndGetUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      mDatabase.userDao().insertUser(USER); //        List&lt;User&gt; users = mDatabase.userDao().getUsers(); assertThat(users.size(), is(1)); User dbUser = users.get(0); assertEquals(dbUser.getId(), USER.getId()); assertEquals(dbUser.getUserName(), USER.getUserName()); }</span></span></code> </pre> <br><h3 id="testirovanie-ispolzovaniya-userdao-v-localuserdatasource">  Test de l'utilisation de UserDao dans LocalUserDataSource </h3><br><p>  Il est facile de s'assurer que <code>LocalUserDataSource</code> fonctionne toujours correctement, car nous avons déjà des tests qui décrivent le comportement de cette classe.  Tout ce que nous devons faire est de créer une base de données en mémoire, d'en extraire un objet <code>UserDao</code> et de l'utiliser comme paramètre pour le constructeur <code>LocalUserDataSource</code> . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initDb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ mDatabase = Room.inMemoryDatabaseBuilder( InstrumentationRegistry.getContext(), UsersDatabase.class) .build(); mDataSource = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LocalUserDataSource(mDatabase.userDao()); }</code> </pre> <br><p>  Encore une fois, nous devons nous assurer que nous fermons la base de données après chaque test. </p><br><h3 id="testirovanie-migracii-bazy-dannyh">  Test de migration de base de données </h3><br><p>  Vous pouvez en savoir plus sur la façon d'implémenter des tests de migration de base de données, ainsi que sur le fonctionnement de <code>MigrationTestHelper</code> , dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cet article</a> . </p><br><p>  Vous pouvez également voir le code à partir d'un exemple d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">application de migration</a> plus détaillé. </p><br><h2 id="shag-7-udalenie-vsego-nenuzhnogo">  Étape 7. Suppression de tout ce qui n'est pas nécessaire </h2><br><p>  Supprimez toutes les classes et lignes de code inutilisées qui sont désormais remplacées par la fonctionnalité Room.  Dans notre projet, nous avons juste besoin de supprimer la classe <code>UsersDbHelper</code> , qui a étendu la classe <code>SQLiteOpenHelper</code> . </p><br><p>  Si vous avez une base de données plus grande et plus complexe et que vous souhaitez passer progressivement à la salle, nous vous recommandons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ce poste</a> . </p><br><p>  Maintenant, la quantité de code standard sujet aux erreurs a diminué, les demandes sont vérifiées au moment de la compilation et tout est testé.  En 7 étapes simples, nous avons pu migrer notre application existante vers Room.  Vous pouvez voir un exemple d'application <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr441934/">https://habr.com/ru/post/fr441934/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr441916/index.html">Une réalité qui travaille dur - Xichang Satellite Launch Center - XSLC</a></li>
<li><a href="../fr441918/index.html">Nous sommes dans UltraHD Morty! Comment regarder n'importe quel film en 4K</a></li>
<li><a href="../fr441920/index.html">Stratégie de sécurité de l'information: avez-vous décidé de la marche à suivre?</a></li>
<li><a href="../fr441928/index.html">Lancez l'application dans Openshift et comparez les outils existants</a></li>
<li><a href="../fr441932/index.html">Comment devancer ses concurrents: SIBUR développe la fabrication additive</a></li>
<li><a href="../fr441938/index.html">Formule pour le coréen, ou reconnaissez Hangul rapidement, facilement et sans erreurs.</a></li>
<li><a href="../fr441942/index.html">Casser - pas construire. Ou la dévolution</a></li>
<li><a href="../fr441944/index.html">Pourquoi nous avons choisi la Lexus RX450h</a></li>
<li><a href="../fr441946/index.html">API REST sur Laravel en 100 lignes de code</a></li>
<li><a href="../fr441950/index.html">Eclipse Che 7 est déjà là</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>