<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§ûüèø üßòüèº üêΩ ISPsystem, perdoe e adeus! Por que e como escrevemos nosso painel de controle do servidor üêâ üòå ‚ÜïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Oi Somos "Hosting Technologies" e h√° cinco anos lan√ßamos o VDSina - o primeiro host vds criado especificamente para desenvolvedores. N√≥s nos esfor√ßamo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ISPsystem, perdoe e adeus! Por que e como escrevemos nosso painel de controle do servidor</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/vdsina/blog/460107/"><img src="https://habrastorage.org/webt/af/l8/yk/afl8yk6hovufiwx1ml-8cwcgaoy.png" alt="imagem"><br><br>  Oi  Somos "Hosting Technologies" e h√° cinco anos lan√ßamos o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">VDSina</a> - o primeiro host vds criado especificamente para desenvolvedores.  N√≥s nos esfor√ßamos para torn√°-lo conveniente, como o DigitalOcean, mas com suporte russo, m√©todos de pagamento e servidores na R√∫ssia.  Mas o DigitalOcean n√£o √© apenas confiabilidade e pre√ßo, √© tamb√©m um servi√ßo. <br><br>  O software do ISPsystem acabou sendo uma corda que amarrou nossas m√£os no caminho de um servi√ßo descolado.  H√° tr√™s anos, usamos o painel de controle do Billmanager e do servidor VMmanager e rapidamente percebemos que √© quase imposs√≠vel prestar um bom servi√ßo sem o nosso pr√≥prio painel. <br><a name="habracut"></a><br><br><h2>  Como o ISPsystem eliminou a usabilidade </h2><br>  <b>Bugs</b> <br><br>  N√£o pod√≠amos consertar o bug sozinhos - cada vez que t√≠nhamos que escrever no suporte de outra pessoa e esperar.  A solu√ß√£o para qualquer problema exigia a resposta de uma empresa terceirizada. <br><br>  O suporte do ISPsystem respondeu normalmente, mas as corre√ß√µes ocorreram apenas em algumas vers√µes, e nem sempre e nem todas.  √Äs vezes, erros cr√≠ticos corrigidos por v√°rias semanas.  Tivemos que tranquilizar os clientes, pedir desculpas e aguardar que o ISPsystem corrigisse o erro. <br><br>  <b>Amea√ßa de inatividade</b> <br><br>  As atualiza√ß√µes podem gerar paradas imprevis√≠veis que provocam novos bugs. <br><br>  Cada atualiza√ß√£o era uma loteria: era necess√°rio cobrir o faturamento e fazer sacrif√≠cios aos deuses das atualiza√ß√µes - algumas vezes a atualiza√ß√£o causou um tempo de inatividade por 10 a 15 minutos.  Naquele momento, nossos administradores estavam ficando cinzentos diante de nossos olhos - nunca sab√≠amos quanto tempo duraria o tempo de inatividade e n√£o pod√≠amos prever quando o ISPsystem decidiu lan√ßar uma nova atualiza√ß√£o. <br><br>  Na quinta gera√ß√£o, o Billmanager melhorou, mas para ter acesso aos recursos necess√°rios, tive que instalar uma vers√£o beta, que j√° era atualizada toda semana.  Se algo acontecesse, voc√™ teria que dar acesso a desenvolvedores estrangeiros para que eles corrigissem alguma coisa. <br><br>  <b>Interface de painel inconveniente</b> <br><br>  Tudo foi dividido em pain√©is diferentes e controlado a partir de lugares diferentes.  Por exemplo, os clientes pagaram atrav√©s do Billmanager e tiveram que reiniciar ou reinstalar o VDS no VMManager.  Nossos funcion√°rios tamb√©m tiveram que alternar entre janelas para ajudar o cliente, verificar a carga em seu servidor ou ver qual sistema operacional ele usa. <br><br>  Essa interface leva tempo - tanto a nossa como os clientes.  Sobre qualquer conveni√™ncia, como o DigitalOcean, n√£o h√° d√∫vidas em tal situa√ß√£o. <br><br>  <b>Ciclos de vida curtos com atualiza√ß√µes frequentes da API</b> <br><br>  Criamos nossos pr√≥prios plugins - por exemplo, um plug-in com m√©todos de pagamento adicionais que n√£o est√£o no VMManager. <br><br>  Nos √∫ltimos anos, o VMManager teve um ciclo de vida relativamente curto e, em novas vers√µes, os nomes de vari√°veis ‚Äã‚Äãou fun√ß√µes na API podem mudar arbitrariamente - isso quebrou nossos plugins.  O suporte para vers√µes mais antigas foi rapidamente minimizado e precisou ser atualizado. <br><br>  <b>Voc√™ n√£o pode modificar</b> <br><br>  Mais precisamente, mas extremamente ineficiente.  As restri√ß√µes de licenciamento n√£o permitem que voc√™ fa√ßa altera√ß√µes na fonte, voc√™ pode apenas escrever plugins.  O m√°ximo de plug-ins s√£o alguns itens de menu, um assistente passo a passo.  O ISPsystem √© aprimorado para versatilidade e precis√°vamos de solu√ß√µes especializadas. <br><br>  Portanto, a decis√£o de escrever seu painel amadureceu.  Estabelecemos metas: <br><br><ul><li>  Responda rapidamente a erros, bugs e consiga corrigi-los voc√™ mesmo, sem fazer o cliente esperar. </li><li>  Modifique livremente a interface para processos de trabalho e necessidades do cliente. </li><li>  Aprimore a usabilidade com um design limpo e compreens√≠vel. </li></ul><br>  E eles come√ßaram o desenvolvimento. <br><br><h2>  Nova arquitetura de painel </h2><br>  Como temos uma equipe de desenvolvimento auto-suficiente, escrevemos o painel por conta pr√≥pria. <br>  O trabalho principal foi realizado por tr√™s engenheiros - o diretor t√©cnico Sergey criou a arquitetura e escreveu o agente do servidor, Alexey fez o faturamento e nosso front-end Artysh reuniu o front-end. <br><br><h3>  Etapa 1. Agente do Servidor </h3><br><br>  Um agente do servidor √© um servidor web python que gerencia a biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">libvirt</a> , que por sua vez gerencia o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">hypervisor Qemu-kvm</a> . <br><br>  O agente gerencia todos os servi√ßos no servidor: criando, parando, desinstalando vds, instalando sistemas operacionais, alterando configura√ß√µes e assim por diante atrav√©s da biblioteca libvirt.  No momento da publica√ß√£o, s√£o mais de quarenta fun√ß√µes diferentes, que complementamos dependendo da tarefa e das necessidades do cliente. <br><br>  Em princ√≠pio, a libvirt poderia ser gerenciada diretamente a partir do faturamento, mas exigia muito c√≥digo adicional e decidimos distribuir essas fun√ß√µes entre o agente e o faturamento - o faturamento simplesmente faz solicita√ß√µes ao agente por meio da API JSON. <br><br>  O agente √© a primeira coisa que fizemos, porque n√£o requer nenhuma interface e pode ser testado diretamente no console do servidor. <br><br>  <b>O que o agente do servidor nos deu:</b> apareceu uma camada que simplifica a vida de todos - o faturamento n√£o precisa enviar um monte de comandos, mas apenas faz uma solicita√ß√£o.  E o agente far√° tudo o que voc√™ precisa: por exemplo, aloque espa√ßo em disco e RAM. <br><br><h3>  Etapa 2. Faturamento </h3><br>  Para o nosso desenvolvedor, Alex, este n√£o foi o primeiro painel de controle - ele estava hospedando por um longo tempo, ent√£o ele geralmente entendeu o que o cliente precisava e o que o hoster precisava. <br><br>  Chamamos de faturamento entre n√≥s um "painel de controle": ele cont√©m n√£o apenas dinheiro e servi√ßos, mas tamb√©m gerenciamento, suporte ao cliente e muito mais. <br><br>  Para mudar do software ISPSystem, era necess√°rio manter completamente a funcionalidade anterior para os clientes, transferir todas as a√ß√µes do usu√°rio financeiro do faturamento antigo para o novo, bem como todos os servi√ßos e comunica√ß√µes entre eles.  Estudamos o que est√° no produto atual, depois as decis√µes dos concorrentes, principalmente DO e Vultr.  Analisamos as desvantagens e vantagens, coletamos feedback de pessoas que trabalharam com produtos antigos do ISPsystem. <br><br>  O novo faturamento usou duas pilhas: PHP cl√°ssico, MySQL (e no futuro est√° planejado mudar para o PostgreSQL), o Yii2 como uma estrutura no backend e o VueJS na frente.  As pilhas funcionam independentemente uma da outra, desenvolvidas por pessoas diferentes, e se comunicam usando a API JSON.  Para o desenvolvimento, ent√£o e agora usamos o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PHPStorm</a> e o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">WebStorm</a> do JetBrains e os amamos muito (pessoal, ol√°!) <br><br>  O painel foi projetado de acordo com o princ√≠pio modular: m√≥dulos de sistema de pagamento, m√≥dulo de registro de dom√≠nio ou, por exemplo, m√≥dulo de certificado SSL.  Voc√™ pode facilmente adicionar uma nova fun√ß√£o ou remover a antiga.  As bases para a expans√£o foram estabelecidas arquitetonicamente, inclusive na dire√ß√£o oposta, "ao ferro". <br><img src="https://habrastorage.org/webt/b-/v7/7u/b-v77ugcsfi0zhdm3bbriq2oxsu.png" alt="imagem"><br>  <b>O que temos</b> : um painel de controle sobre o qual temos controle total.  Agora, os erros s√£o corrigidos em horas, n√£o em semanas, e novas fun√ß√µes s√£o implementadas a pedido dos clientes, e n√£o a pedido do ISPSystem. <br><br><h3>  Etapa 3. Interface </h3><br><img src="https://habrastorage.org/webt/9i/n0/b2/9in0b2skk3doxpelwvckx7ebmei.png" alt="imagem"><br>  A interface √© uma ideia da nossa equipe. <br><br>  Primeiro, analisamos o que aconteceria se fiz√©ssemos um complemento sobre a API do ISPsystem sem alterar nada dramaticamente na interface.  Acabou assim e decidimos fazer tudo do zero. <br><br>  Acredit√°vamos que o principal era tornar a interface l√≥gica, com um design limpo e minimalista, e ent√£o ter√≠amos um painel bonito.  O arranjo dos elementos foi discutido no Megaplan, e a interface que os usu√°rios v√™em no painel de controle agora nascer√° gradualmente. <br><br>  O primeiro apareceu o design da p√°gina de cobran√ßa, porque j√° criamos plug-ins de pagamento para o ISPsystem. <br><br>  <b>Frontend</b> <br><br>  Eles decidiram transformar o painel em um aplicativo SPA - sem exigir recursos e com carregamento r√°pido de dados.  Nosso front-end, Artysh, decidiu escrev√™-lo no Vue - naquele momento, o Vue havia aparecido.  Assumimos que a estrutura se desenvolveria dinamicamente, como React, depois de algum tempo a comunidade Vue crescer√° e um mar de bibliotecas aparecer√°.  Instalamos no Vue e n√£o nos arrependemos - agora adicionar novos recursos que j√° foram programados no back-end leva pouco tempo.  Falaremos mais sobre os pain√©is de front-end em um artigo separado. <br><br>  <b>Comunica√ß√£o do frontend com o backend</b> <br><br>  O frontend estava vinculado ao backend por meio de pushies.  Eu tive que suar e escrever meu pr√≥prio manipulador, mas agora as informa√ß√µes na p√°gina s√£o atualizadas quase instantaneamente. <br><br>  <b>O que aconteceu:</b> a interface do painel ficou mais f√°cil.  N√≥s o adaptamos e o carregamento r√°pido permite que ele seja usado mesmo em telefones celulares nos √∫ltimos minutos antes da decolagem, sem a instala√ß√£o de um aplicativo separado para trabalhar com o painel. <br><br><h3>  Etapa 4. Esquema de Teste e Migra√ß√£o </h3><br>  Quando tudo come√ßou e os primeiros testes passaram, surgiu a quest√£o da migra√ß√£o.  Primeiro, configuramos o faturamento e come√ßamos a testar seu trabalho com o agente do servidor. <br><br>  Em seguida, eles escreveram um script simples que transfere o banco de dados do faturamento antigo para o novo. <br><br>  Eu tive que testar e verificar literalmente tudo, pois os dados foram despejados em um novo banco de dados dos tr√™s antigos: Billmanager, VMmanager e IPmanager manager.  Talvez a migra√ß√£o de teste seja a coisa mais dif√≠cil que encontramos no processo de desenvolvimento de um novo painel. <br><br>  Depois de verificar novamente, cobrimos o antigo faturamento.  A migra√ß√£o final dos dados foi um momento muito preocupante, mas, gra√ßas a Deus, foi conclu√≠da em alguns minutos e sem problemas vis√≠veis.  Corrigimos alguns bugs menores em uma semana.  O tempo principal foi gasto testando o que aconteceu. <br><br>  Em seguida, enviamos cartas aos clientes com o endere√ßo do novo painel e faturamento e fizemos um redirecionamento. <br><br>  <b>Bottom line: est√°</b> <b>vivo!</b> <br><br><h2>  Feliz </h2><br>  Desde as primeiras horas do nosso software, sentimos todas as del√≠cias da transi√ß√£o.  O c√≥digo era completamente nosso e com uma arquitetura conveniente, e a interface era limpa e l√≥gica. <br><img src="https://habrastorage.org/webt/7a/hv/is/7ahvis7zx-1m4pcouleavsqbldo.png" alt="imagem"><br>  <i>A primeira revis√£o ap√≥s o lan√ßamento de um novo painel</i> <br><br>  Iniciamos o processo de transi√ß√£o em dezembro, na v√©spera do Ano Novo de 2017, quando havia menos carga para facilitar a transi√ß√£o para os clientes - quase ningu√©m trabalha nas v√©speras das festas. <br><br>  A principal coisa que obtivemos durante a transi√ß√£o para o nosso sistema (al√©m da confiabilidade e conveni√™ncia gerais) √© a capacidade de adicionar rapidamente funcionalidades aos principais clientes - para serem o rosto e n√£o o traseiro. <br><br><h3>  O que vem a seguir? </h3><br>  Estamos crescendo, a quantidade de dados, clientes, dados de clientes est√° crescendo.  Um servidor em cache e dois gerenciadores de filas com tarefas diferentes tiveram que ser adicionados ao back-end.  H√° cache e filas no front-end. <br><br>  Obviamente, ainda t√≠nhamos aventuras ao desenvolver e complicar o produto, por exemplo, quando adicionamos o HighLoad. <br><br>  No pr√≥ximo artigo, mostraremos como a tarifa de alta CPU foi lan√ßada: sobre hardware, software, quais tarefas resolvemos e o que fizemos. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/ud/xv/wf/udxvwfcz80j3nug11rxaguqelww.png"><br></a> <br><h3>  Inscreva-se no nosso desenvolvedor do Instagram </h3><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/e5/as/-l/e5as-ltfnotkemk2dsqngygimra.png"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt460107/">https://habr.com/ru/post/pt460107/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt460091/index.html">Impress√£o direta em camisetas com Epson SureColor SC - F e sua diferen√ßa em serigrafia, decalque e sublima√ß√£o</a></li>
<li><a href="../pt460095/index.html">Peguei uma proibi√ß√£o de fork deepNude on gitlab.com</a></li>
<li><a href="../pt460097/index.html">A Matrix tem voc√™: uma vis√£o geral dos projetos usando o MITRE ATT & CK</a></li>
<li><a href="../pt460099/index.html">Aplica√ß√£o do aprendizado de m√°quina autom√°tico a redes neurais com arquitetura de transformadores</a></li>
<li><a href="../pt460101/index.html">Opera√ß√£o XSS baseada em cookie | $ 2300 Bug Bounty story</a></li>
<li><a href="../pt460109/index.html">Angular: quando voc√™ precisa ver o aplicativo, mas o back-end ainda n√£o est√° pronto</a></li>
<li><a href="../pt460111/index.html">Vers√£o atualizada do SAP Business One 9.3: o que mudou</a></li>
<li><a href="../pt460113/index.html">Algumas hist√≥rias da vida do JSOC CERT, ou forense unbanal</a></li>
<li><a href="../pt460115/index.html">Dez anos de programa√ß√£o em Erlang</a></li>
<li><a href="../pt460117/index.html">Os maiores clientes da R√∫ssia s√£o um grande jackpot ou uma dor de cabe√ßa? Experi√™ncia AGIMA</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>