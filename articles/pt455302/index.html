<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí™ ‚ùÑÔ∏è üê¨ Estrutura da API Golang ‚õ∏Ô∏è ‚õπüèø üè†</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No processo de conhecer Golang, decidi criar a estrutura do aplicativo, que seria conveniente para eu trabalhar no futuro. O resultado foi, na minha o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Estrutura da API Golang</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/455302/"><p>  No processo de conhecer Golang, decidi criar a estrutura do aplicativo, que seria conveniente para eu trabalhar no futuro.  O resultado foi, na minha opini√£o, uma boa pe√ßa de trabalho, que decidi compartilhar e, ao mesmo tempo, discutir os momentos que surgiram durante a cria√ß√£o do quadro. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/599/73a/8a9/59973a8a925f690405c0f171fdd53048.jpg" alt="imagem"></p><br><p>  Em princ√≠pio, o design da linguagem Go sugere que ele n√£o precisa criar aplicativos em larga escala (quero dizer a falta de gen√©ricos e um mecanismo de manipula√ß√£o de erros n√£o muito poderoso).  Mas ainda sabemos que o tamanho dos aplicativos geralmente n√£o diminui, mas mais frequentemente pelo contr√°rio.  Portanto, √© melhor criar imediatamente uma estrutura na qual ser√° poss√≠vel criar novas fun√ß√µes sem sacrificar o suporte ao c√≥digo. </p><a name="habracut"></a><br><p>  Tentei inserir menos c√≥digo no artigo. Em vez disso, adicionei links para linhas de c√≥digo espec√≠ficas no Github, na esperan√ßa de que fosse mais conveniente ver a imagem inteira. </p><br><p>  Primeiro, esbocei um plano para o que deveria estar no aplicativo.  Como no artigo falarei sobre cada item separadamente, primeiro darei o principal desta lista como o conte√∫do. </p><br><ul><li>  Escolha o gerenciador de pacotes </li><li>  Escolha uma estrutura para criar uma API </li><li> Selecionar ferramenta para inje√ß√£o de depend√™ncia (DI) </li><li>  Rotas de solicita√ß√£o da Web </li><li>  Respostas JSON / XML de acordo com os cabe√ßalhos da solicita√ß√£o </li><li>  ORM </li><li>  Migra√ß√µes </li><li>  Criar classes base para as camadas do modelo Servi√ßo-&gt; Reposit√≥rio-&gt; Entidade </li><li>  Reposit√≥rio b√°sico CRUD </li><li>  Servi√ßo CRUD b√°sico </li><li>  Controlador CRUD b√°sico </li><li>  Solicitar valida√ß√£o </li><li>  Configura√ß√µes e vari√°veis ‚Äã‚Äãde ambiente </li><li>  Comandos do console </li><li>  Registo </li><li>  Integra√ß√£o do criador de logs com o Sentry ou outro sistema de alerta </li><li>  Configurando alerta para erros </li><li>  Testes unit√°rios com redefini√ß√£o de servi√ßos atrav√©s do DI </li><li>  Mapa de c√≥digo de porcentagem e cobertura de teste </li><li>  Swagger </li><li>  Docker compor </li></ul><br><h2 id="menedzher-paketov">  Gerenciador de pacotes </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Depois de ler as</a> descri√ß√µes para v√°rias implementa√ß√µes, escolhi o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">govendor</a> e, no momento, fiquei satisfeito com a escolha.  O motivo √© simples - permite instalar depend√™ncias dentro do diret√≥rio com o aplicativo, armazenar informa√ß√µes sobre pacotes e suas vers√µes. </p><br><p>  Informa√ß√µes sobre pacotes e suas vers√µes s√£o armazenadas em um <a href="">arquivo</a> vendor.json.  H√° um ponto negativo nessa abordagem tamb√©m.  Se voc√™ adicionar um pacote com suas depend√™ncias, juntamente com informa√ß√µes sobre o pacote, informa√ß√µes sobre suas depend√™ncias tamb√©m ser√£o inseridas no arquivo.  O arquivo cresce rapidamente e n√£o √© mais poss√≠vel determinar claramente quais depend√™ncias s√£o as principais e quais s√£o derivadas. </p><br><p>  No compositor PHP ou no npm, as principais depend√™ncias s√£o descritas em um arquivo, e todas as depend√™ncias principais e derivadas e suas vers√µes s√£o automaticamente registradas no arquivo de bloqueio.  Essa abordagem √© mais conveniente na minha opini√£o.  Mas, por enquanto, a implementa√ß√£o do fornecedor foi suficiente para mim. </p><br><h2 id="freymvork">  Enquadramento </h2><br><p>  Na estrutura, n√£o preciso de muito, um roteador conveniente, valida√ß√£o de solicita√ß√µes.  Tudo isso foi encontrado no popular <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Gin</a> .  Ele parou nisso. </p><br><h2 id="dependency-injection">  Inje√ß√£o de depend√™ncia </h2><br><p>  Com o DI, tive que sofrer um pouco.  Primeiro, escolha Dig.  E no come√ßo tudo foi √≥timo.  Servi√ßos descritos, Dig ainda cria depend√™ncias, convenientemente.  Por√©m, os servi√ßos n√£o podem ser redefinidos, por exemplo, durante o teste.  Portanto, no final, cheguei √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">conclus√£o de</a> que peguei um cont√™iner de servi√ßo simples <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sarulabs / di</a> . </p><br><p>  Eu apenas tive que fazer uma bifurca√ß√£o, porque pronto para adicionar servi√ßos e pro√≠be redefini-los.  E, ao escrever autotestes, na minha opini√£o, √© mais conveniente inicializar o cont√™iner como no aplicativo e redefinir alguns dos servi√ßos, especificando stubs.  No fork, ele adicionou um m√©todo para substituir a descri√ß√£o do servi√ßo. </p><br><p> Mas no final, tanto no caso do Dig quanto no cont√™iner de servi√ßo, tive que colocar os testes em um pacote separado.  Caso contr√°rio, verifica-se que os testes s√£o executados separadamente em pacotes ( <code>go test model/service</code> ), mas n√£o s√£o iniciados imediatamente para todo o aplicativo ( <code>go test ./...</code> ), devido √†s depend√™ncias c√≠clicas que surgem nesse caso. </p><br><h2 id="otvety-v-formate-jsonxml-v-sootvetstvii-s-zagolovkami-zaprosa">  Respostas JSON / XML de acordo com os cabe√ßalhos da solicita√ß√£o </h2><br><p>  No Gin, eu n√£o encontrei isso, ent√£o acabei de adicionar um <a href="">m√©todo</a> ao controlador base que gera uma resposta dependendo do cabe√ßalho da solicita√ß√£o. </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(c BaseController)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">response</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(context *gin.Context, obj </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{}, code </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> context.GetHeader(<span class="hljs-string"><span class="hljs-string">"Accept"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"application/xml"</span></span>: context.XML(code, obj) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: context.JSON(code, obj) } }</code> </pre><br><h2 id="orm">  ORM </h2><br><p>  Com ORM n√£o sentiu o longo tormento de escolha.  Havia muito por onde escolher.  Mas, de acordo com a descri√ß√£o dos recursos, gostei do GORM, que √© um dos mais populares no momento da sele√ß√£o.  H√° suporte para o DBMS mais comumente usado.  Pelo menos o PostgreSQL e o MySQL est√£o definitivamente l√°.  Ele tamb√©m possui m√©todos para gerenciar o esquema base que voc√™ pode usar ao criar migra√ß√µes. </p><br><h2 id="migracii">  Migra√ß√µes </h2><br><p>  Para migra√ß√µes, decidi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pelo</a> pacote <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">gorm-ganso</a> .  Coloquei um pacote separado globalmente e inicio a migra√ß√£o para ele.  No in√≠cio, essa implementa√ß√£o era embara√ßosa, pois a conex√£o com o banco de dados precisava ser descrita em um <a href="">arquivo db / dbconf.yml</a> separado.  Mas, ent√£o, descobriu-se que a cadeia de conex√£o nela pode ser descrita de tal maneira que o valor √© obtido da vari√°vel de ambiente. </p><br><pre> <code class="plaintext hljs">development: driver: postgres open: $DB_URL</code> </pre> <br><p>  E isso √© bastante conveniente.  Pelo menos com o docker-compose, n√£o tive que duplicar a <a href="">cadeia de conex√£o</a> . </p><br><p>  O Gorm-ganso tamb√©m suporta revers√µes de migra√ß√£o, o que acho muito √∫til. </p><br><h2 id="bazovyy-crud-repozitoriy">  Reposit√≥rio b√°sico CRUD </h2><br><p>  Prefiro tudo o que se refere aos recursos a serem colocados em uma camada de reposit√≥rio separada.  Na minha opini√£o, com essa abordagem, o c√≥digo da l√≥gica de neg√≥cios √© mais limpo.  Nesse caso, o c√≥digo de l√≥gica de neg√≥cios sabe apenas que precisa trabalhar com os dados que ele obt√©m do reposit√≥rio.  E o que acontece no reposit√≥rio, a l√≥gica de neg√≥cios n√£o √© importante.  O reposit√≥rio pode trabalhar com um banco de dados relacional, com um armazenamento KV, com um disco ou talvez com a API de outro servi√ßo.  O c√≥digo da l√≥gica de neg√≥cios ser√° o mesmo em todos esses casos. </p><br><p>  O reposit√≥rio CRUD implementa a seguinte <a href="">interface</a> </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> CrudRepositoryInterface <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> { BaseRepositoryInterface GetModel() (entity.InterfaceEntity) Find(id <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>) (entity.InterfaceEntity, error) List(parameters ListParametersInterface) (entity.InterfaceEntity, error) Create(item entity.InterfaceEntity) entity.InterfaceEntity Update(item entity.InterfaceEntity) entity.InterfaceEntity Delete(id <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>) error }</code> </pre> <br><p>  Ou seja, o CRUD implementa as opera√ß√µes <code>Create()</code> , <code>Find()</code> , <code>List()</code> , <code>Update()</code> , <code>Delete()</code> e o m√©todo <code>GetModel()</code> . </p><br><p>  Sobre <a href="">GetModel ()</a> .  Existe um reposit√≥rio b√°sico do <code>CrudRepository</code> que implementa opera√ß√µes b√°sicas do CRUD.  Nos reposit√≥rios que o incorporam, basta indicar com qual modelo eles devem trabalhar.  Para fazer isso, o m√©todo <code>GetModel()</code> deve retornar um modelo GORM.  Ent√£o tivemos que usar o resultado de <code>GetModel()</code> usando reflex√£o nos m√©todos CRUD. </p><br><p>  <a href="">Por exemplo</a> </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(c CrudRepository)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Find</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(entity.InterfaceEntity, error)</span></span></span></span> { item := reflect.New(reflect.TypeOf(c.GetModel()).Elem()).Interface() err := c.db.First(item, id).Error <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> item, err }</code> </pre> <br><p>  Ou seja, nesse caso, foi necess√°rio abandonar a digita√ß√£o est√°tica em favor da digita√ß√£o din√¢mica.  Nesses momentos, a falta de gen√©ricos no idioma √© sentida especialmente. </p><br><p>  Para que os reposit√≥rios que trabalham com modelos espec√≠ficos implementem suas pr√≥prias regras de filtragem de listas no m√©todo <code>List()</code> , primeiro implementei a liga√ß√£o tardia para que o m√©todo respons√°vel pela constru√ß√£o da consulta seja chamado a partir do m√©todo <code>List()</code> .  E esse m√©todo pode ser implementado em um reposit√≥rio espec√≠fico.  √â dif√≠cil, de alguma maneira, abandonar os padr√µes de pensamento que foram formados quando se trabalha com outras l√≠nguas.  Mas, olhando para ele com uma nova apar√™ncia e apreciando a ‚Äúeleg√¢ncia‚Äù do caminho escolhido, ele o refez para uma abordagem mais pr√≥xima de Go.  Para fazer isso, simplesmente no <code>CrudRepository</code> por meio da interface, <a href="">√©</a> declarado <a href="">um construtor de consultas</a> , que j√° √© <a href=""><code>  List()</code></a> . </p><br><pre> <code class="go hljs">listQueryBuilder ListQueryBuilderInterface</code> </pre><br><p>  Acontece bem engra√ßado.  Limitar o idioma √† liga√ß√£o tardia, o que a princ√≠pio parece uma falha, incentiva uma separa√ß√£o mais clara do c√≥digo. </p><br><h2 id="bazovyy-crud-servis">  Servi√ßo CRUD b√°sico </h2><br><p>  N√£o h√° nada interessante aqui, pois n√£o h√° l√≥gica de neg√≥cios na estrutura.  Chamadas de m√©todos CRUD para o reposit√≥rio s√£o simplesmente <a href="">enviadas por proxy</a> . </p><br><p>  Na camada de servi√ßos, a l√≥gica de neg√≥cios deve ser implementada. </p><br><h2 id="bazovyy-crud-kontroller">  Controlador CRUD b√°sico </h2><br><p>  O controlador implementa <a href="">m√©todos CRUD</a> .  Eles processam os par√¢metros da solicita√ß√£o, o controle √© transferido para o m√©todo de servi√ßo correspondente e, com base na resposta do servi√ßo, uma resposta √© formada para o cliente. </p><br><p>  Com o controlador, tive a mesma hist√≥ria do reposit√≥rio sobre as listas de filtragem.  Como resultado, refiz a implementa√ß√£o com liga√ß√£o tardia caseira e adicionei um <a href="">hidratador</a> que, com base nos par√¢metros de solicita√ß√£o, forma uma estrutura com par√¢metros para filtrar a lista. </p><br><p>  No hidratador que acompanha o controlador CRUD, apenas os par√¢metros de pagina√ß√£o s√£o processados.  Nos controladores espec√≠ficos nos quais o controlador CRUD est√° integrado, o <a href="">hidratador</a> pode ser <a href="">redefinido</a> . </p><br><h2 id="validaciya-zaprosov">  Solicitar valida√ß√£o </h2><br><p>  A valida√ß√£o √© realizada por Gin.  Por exemplo, ao adicionar um registro (m√©todo <code>Create()</code> ), basta <a href="">decorar os</a> elementos da estrutura da entidade </p><br><pre> <code class="go hljs">Name <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-string"><span class="hljs-string">`binding:"required"`</span></span></code> </pre> <br><p>  O m√©todo <a href=""><code>ShouldBindJSON()</code></a> da estrutura cuida da verifica√ß√£o dos par√¢metros de solicita√ß√£o quanto √† conformidade com os requisitos descritos no decorador. </p><br><h2 id="konfigi-i-peremennye-okruzheniya">  Configura√ß√µes e vari√°veis ‚Äã‚Äãde ambiente </h2><br><p>  Gostei muito da implementa√ß√£o do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Viper</a> , especialmente em conjunto com o Cobra. </p><br><p>  Lendo a configura√ß√£o que <a href="">descrevi em main.go.</a>  Os par√¢metros b√°sicos que n√£o cont√™m segredos s√£o descritos <a href="">no arquivo base.env</a> .  Voc√™ pode substitu√≠-los no arquivo .env adicionado ao .gitignore.  Em .env, voc√™ pode descrever valores secretos para o ambiente. </p><br><p>  Vari√°veis ‚Äã‚Äãde ambiente t√™m uma prioridade mais alta. </p><br><h2 id="konsolnye-komandy">  Comandos do console </h2><br><p>  Para a descri√ß√£o dos comandos do console, eu escolhi o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Cobra</a> .  Do que √© bom usar o Cobra junto com o Viper.  Podemos <a href="">descrever o comando</a> </p><br><pre> <code class="go hljs">serverCmd.PersistentFlags().StringVar(&amp;serverPort, <span class="hljs-string"><span class="hljs-string">"port"</span></span>, defaultServerPort, <span class="hljs-string"><span class="hljs-string">"Server port"</span></span>)</code> </pre> <br><p>  E <a href="">vincule a vari√°vel de ambiente</a> ao valor do par√¢metro de comando </p><br><pre> <code class="go hljs">viper.BindPFlag(<span class="hljs-string"><span class="hljs-string">"SERVER_PORT"</span></span>, serverCmd.PersistentFlags().Lookup(<span class="hljs-string"><span class="hljs-string">"port"</span></span>))</code> </pre> <br><p>  De fato, toda a aplica√ß√£o dessa estrutura √© console.  O servidor da web √© iniciado por um dos comandos do console do servidor. </p><br><pre> <code class="bash hljs">gin -i run server</code> </pre> <br><h2 id="logirovanie">  Registo </h2><br><p>  Eu escolhi o pacote <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">logrus</a> para o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">log</a> , pois ele tem tudo o que eu normalmente preciso: definir n√≠veis de log, onde registrar, adicionar ganchos, por exemplo, para enviar logs para o sistema de alerta. </p><br><h2 id="integraciya-loggera-s-sistemoy-alertinga">  Integra√ß√£o do criador de logs com o sistema de alerta </h2><br><p>  Eu escolhi o Sentry, porque tudo ficou bastante simples gra√ßas √† pronta integra√ß√£o com logrus: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">logrus_sentry</a> .  Fiz os <a href="">par√¢metros</a> com o URL para o Sentry <code>SENTRY_DSN</code> e o tempo limite para enviar para o Sentry <code>SENTRY_TIMEOUT</code> .  Descobriu-se que, por padr√£o, o tempo limite √© pequeno, se n√£o equivocado, 300 ms e muitas mensagens n√£o foram entregues. </p><br><h2 id="nastroyka-alertinga-dlya-oshibok">  Configurando alerta para erros </h2><br><p>  Fiz o processamento de p√¢nico separadamente para o <a href="">servidor</a> da <a href="">web</a> e para os <a href="">comandos do console</a> . </p><br><h2 id="yunit-testy-s-pereopredeleniem-servisov-cherez-di">  Testes unit√°rios com redefini√ß√£o de servi√ßos atrav√©s do DI </h2><br><p>  Como observado acima, um pacote separado teve que ser alocado para testes de unidade.  Como a biblioteca selecionada para criar um cont√™iner de servi√ßo n√£o permitia a redefini√ß√£o de servi√ßos, no fork foi adicionado um m√©todo para redefinir a descri√ß√£o dos servi√ßos.  Por esse motivo, no teste de unidade, voc√™ pode <a href="">usar</a> a mesma descri√ß√£o de servi√ßos que no aplicativo </p><br><pre> <code class="go hljs">dic.InitBuilder()</code> </pre> <br><p>  E <a href="">redefina</a> apenas algumas descri√ß√µes de servi√ßo nos stubs dessa maneira </p><br><pre> <code class="go hljs">dic.Builder.Set(di.Def{ Name: dic.UserRepository, Build: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctn di.Container)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{}, error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NewUserRepositoryMock(), <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }, })</code> </pre> <br><p>  Em seguida, voc√™ pode <a href="">construir um cont√™iner</a> e usar os servi√ßos necess√°rios no teste: </p><br><pre> <code class="go hljs">dic.Container = dic.Builder.Build() userService := dic.Container.Get(dic.UserService).(service.UserServiceInterface)</code> </pre> <br><p>  Assim, testaremos o userService, que, em vez do reposit√≥rio real, usar√° o stub fornecido. </p><br><p>  Mapa de c√≥digo de porcentagem e cobertura de teste <br>  Fiquei completamente satisfeito com o utilit√°rio de teste padr√£o. </p><br><p>  Voc√™ pode executar testes individualmente </p><br><pre> <code class="bash hljs">go <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/unit/user_service_test.go -v</code> </pre> <br><p>  Voc√™ pode executar todos os testes de uma s√≥ vez </p><br><pre> <code class="bash hljs">go <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> ./... -v</code> </pre> <br><p>  Voc√™ pode criar um mapa de cobertura e calcular a porcentagem de cobertura </p><br><pre> <code class="bash hljs">go <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> ./... -v -coverpkg=./... -coverprofile=coverage.out</code> </pre> <br><p>  E veja um mapa de cobertura de c√≥digo com testes em um navegador </p><br><pre> <code class="bash hljs">go tool cover -html=coverage.out</code> </pre> <br><h2 id="swagger">  Swagger </h2><br><p>  Existe um projeto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">gin-swagger</a> para o Gin, que pode ser usado para gerar especifica√ß√µes para o Swagger e para gerar documenta√ß√£o com base nele.  Mas, como se viu, para gerar especifica√ß√µes para opera√ß√µes espec√≠ficas, √© necess√°rio indicar coment√°rios sobre fun√ß√µes espec√≠ficas do controlador.  Isso acabou n√£o sendo muito conveniente para mim, pois eu n√£o queria duplicar o c√≥digo de opera√ß√µes CRUD em cada controlador.  Em vez disso, em controladores espec√≠ficos, simplesmente incorporo um controlador CRUD conforme descrito acima.  Eu realmente n√£o queria criar fun√ß√µes de stub para isso tamb√©m. </p><br><p>  Portanto, cheguei √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">conclus√£o de</a> que a especifica√ß√£o est√° sendo gerada usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">goswagger</a> , porque neste caso as opera√ß√µes <a href="">podem ser descritas sem estarem vinculadas a fun√ß√µes espec√≠ficas</a> . </p><br><pre> <code class="bash hljs">swagger generate spec -o doc/swagger.yml</code> </pre> <br><p>  A prop√≥sito, com o goswagger voc√™ pode at√© ir pelo contr√°rio e gerar o c√≥digo do servidor da web com base na especifica√ß√£o do Swagger.  Mas com essa abordagem, houve dificuldades com o uso do ORM, e eu finalmente o abandonei. </p><br><p>  A documenta√ß√£o √© gerada usando gin-swagger, para isso √© <a href="">indicado</a> um arquivo de especifica√ß√£o pr√©-gerado. </p><br><h2 id="docker-compose">  Docker compor </h2><br><p>  Na estrutura, adicionei uma descri√ß√£o de dois cont√™ineres - <a href="">para o c√≥digo e para a base</a> .  No in√≠cio do cont√™iner com o c√≥digo, aguardamos at√© que o cont√™iner com a base seja totalmente lan√ßado.  E a cada in√≠cio, lan√ßamos migra√ß√µes, se necess√°rio.  Os par√¢metros para conectar-se ao banco de dados para migra√ß√µes s√£o descritos, como mencionado acima, no <a href="">dbconf.yml</a> , onde foi poss√≠vel usar a <a href="">vari√°vel de ambiente</a> para transferir as configura√ß√µes de conex√£o ao banco de dados. </p><br><p>  Obrigado pela aten√ß√£o.  No processo, tive que me adaptar aos recursos do idioma.  Gostaria de saber a opini√£o dos colegas que passaram mais tempo com o Go.  Certamente alguns momentos poderiam ficar mais elegantes, por isso terei prazer em receber cr√≠ticas √∫teis.  Link para o quadro: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/zubroide/go-api-boilerplate</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt455302/">https://habr.com/ru/post/pt455302/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt455286/index.html">Dentes da sabedoria: n√£o podem ser removidos</a></li>
<li><a href="../pt455288/index.html">Not√≠cias da semana: bloqueador de an√∫ncios corporativo nas chaves de criptografia Chrome, FSB e Yandex, a comunica√ß√£o est√° ficando mais cara</a></li>
<li><a href="../pt455290/index.html">O Guia Completo para Prometeu em 2019</a></li>
<li><a href="../pt455292/index.html">Como aumentar 4 vezes o tempo de execu√ß√£o de dispositivos com alimenta√ß√£o autom√°tica</a></li>
<li><a href="../pt455294/index.html">Guia: como escolher uma bicicleta el√©trica usando o Twitter como exemplo - falando sobre quadros</a></li>
<li><a href="../pt455306/index.html">Respostas √†s suas perguntas sobre por que voc√™ precisa de um editor para publicar um livro</a></li>
<li><a href="../pt455308/index.html">Lugar promissor</a></li>
<li><a href="../pt455310/index.html">Ataques em canais de desvio: agora n√£o apenas os PCs, mas tamb√©m os smartphones est√£o sob ataque (revis√£o anal√≠tica)</a></li>
<li><a href="../pt455312/index.html">Adicionador completo de um bit em chips incomuns</a></li>
<li><a href="../pt455314/index.html">O que √© uma rede de servi√ßos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>