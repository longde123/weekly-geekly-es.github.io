<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöé üë®üèª üë®üèª‚Äçüé® Les aventures des Malvari insaisissables, Partie IV: DDE et champs de document Word üßëüèº‚Äçü§ù‚Äçüßëüèº üëéüèø ü§ë</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cet article fait partie de la s√©rie Fileless Malware. Toutes les autres parties de la s√©rie: 



- Les aventures des Malvari insaisissables, partie I ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Les aventures des Malvari insaisissables, Partie IV: DDE et champs de document Word</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/varonis/blog/460521/"><img src="https://habrastorage.org/webt/zn/w7/ji/znw7ji_p5zvifvliksiuceqjll0.png"><br><br>  Cet article fait partie de la s√©rie Fileless Malware.  Toutes les autres parties de la s√©rie: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Les aventures des Malvari insaisissables, partie I</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Les Aventures des Malvari Insaisissables, Partie II: Scripts VBA Secrets</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Les aventures des Malvari insaisissables, Partie III: Scripts VBA complexes pour le rire et le profit</a> </li><li>  Les aventures des Malvari insaisissables, Partie IV: DDE et champs de document Word (nous y sommes) </li></ul><br>  Dans cet article, j'allais plonger dans un sc√©nario √† plusieurs √©tapes encore plus compliqu√© d'une attaque sans fichier avec correction dans le syst√®me.  Mais je suis tomb√© sur une attaque incroyablement simple sans code - aucune macro Word ou Excel n'est requise!  Et cela prouve beaucoup plus efficacement mon hypoth√®se initiale qui sous-tend cette s√©rie d'articles: surmonter le p√©rim√®tre externe de toute organisation est une t√¢che tr√®s simple. <br><a name="habracut"></a><br>  La premi√®re attaque que je vais d√©crire exploite la vuln√©rabilit√© de Microsoft Word, qui est bas√©e sur le <strong><a href="">protocole</a> DDE ( <a href="">Dynamic Data Exchange Protocol</a> ) h√©rit√©</strong> .  Il a d√©j√† √©t√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">corrig√©</a> .  Le second exploite une vuln√©rabilit√© plus g√©n√©rale dans Microsoft COM et les capacit√©s de transfert d'objets. <br><br><h2>  Retour vers le futur avec DDE </h2><br>  Quelqu'un d'autre se souvient-il de DDE?  Probablement peu.  Il s'agit de l'un des premiers <strong>protocoles de communication interprocessus permettant aux applications et aux appareils de transf√©rer des donn√©es</strong> . <br><br>  Je le connais moi-m√™me un peu, car j'avais l'habitude de v√©rifier et de tester des √©quipements t√©l√©coms.  √Ä ce moment-l√†, DDE a permis, par exemple, de transf√©rer l'ID de l'appelant vers l'application CRM pour les op√©rateurs de centre d'appel, qui a finalement ouvert la carte du client.  Pour ce faire, vous deviez connecter un c√¢ble RS-232 entre le t√©l√©phone et l'ordinateur.  Voil√† les jours! <br><br>  Il s'est av√©r√© que Microsoft Word <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">prend</a> toujours en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">charge</a> DDE. <br><br>  Ce qui rend cette attaque efficace sans code, c'est que vous pouvez acc√©der au protocole DDE <i>directement √†</i> partir des champs automatiques d'un document Word (j'enl√®ve mon chapeau √† SensePost pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rechercher et publier</a> √† ce sujet). <br><br>  <strong>Les codes de champ</strong> sont une autre ancienne fonctionnalit√© de MS Word qui vous permet d'ajouter du texte dynamique et un peu de programmation √† un document.  L'exemple le plus √©vident est le champ Num√©ro de page, qui peut √™tre ins√©r√© dans le pied de page en utilisant la valeur {PAGE \ * MERGEFORMAT}.  Cela vous permet de g√©n√©rer automatiquement des num√©ros de page. <br><br><img src="https://habrastorage.org/webt/wu/ov/ns/wuovnsvhhei65psga4ongzkfwuc.jpeg"><br>  <font color="#999999"><i>Astuce: vous pouvez trouver l'√©l√©ment de menu Champ dans la section Ins√©rer.</i></font> <br><br>  Je me souviens que lorsque j'ai d√©couvert cette fonctionnalit√© pour la premi√®re fois dans Word, j'ai √©t√© √©tonn√©.  Et tant que le correctif ne l'a pas d√©sactiv√©, Word a pris en charge le param√®tre de champ DDE.  L'id√©e √©tait que DDE permettrait √† Word de communiquer directement avec l'application, pour la possibilit√© de transf√©rer ensuite la sortie du programme vers un document.  Il s'agissait √† l'√©poque d'une technologie tr√®s r√©cente - prise en charge de l'√©change de donn√©es avec des applications externes.  Plus tard, il a √©t√© d√©velopp√© dans la technologie COM, que nous consid√©rerons √©galement ci-dessous. <br><br>  En cons√©quence, les pirates ont r√©alis√© que cette application DDE pourrait √™tre un shell de commande qui, bien s√ªr, lance PowerShell, et √† partir de l√†, les pirates peuvent faire ce qu'ils veulent. <br>  La capture d'√©cran ci-dessous montre comment j'ai utilis√© cette technique secr√®te: un petit script PowerShell (ci-apr√®s d√©nomm√© PS) du champ DDE charge un autre script PS qui lance la deuxi√®me phase de l'attaque. <br><br><img src="https://habrastorage.org/webt/p6/17/2j/p6172jjjmcko74uq-klljtznybs.jpeg"><br>  <font color="#999999"><i>Merci √† Windows pour l'avertissement contextuel que le champ int√©gr√© DDEAUTO essaie secr√®tement de d√©marrer le shell</i></font> <br><br>  La m√©thode pr√©f√©r√©e pour exploiter la vuln√©rabilit√© consiste √† utiliser l'option avec le champ DDEAUTO, qui ex√©cute automatiquement un script <i>lors de l'ouverture d'un</i> document Word. <br>  R√©fl√©chissons √† ce que nous pouvons y faire. <br><br>  En tant que pirate d√©butant, vous pouvez, par exemple, envoyer un e-mail de phishing, pr√©tendant appartenir au Federal Tax Service, et int√©grer le champ DDEAUTO avec un script PS pour la premi√®re √©tape (un dropper en fait).  Et vous n'avez m√™me pas besoin de faire de vrai codage de macros, etc., comme je l'ai fait dans l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article pr√©c√©dent.</a> <br>  La victime ouvre votre document, le script int√©gr√© est activ√© et le pirate est √† l'int√©rieur de l'ordinateur.  Dans mon cas, le script PS distant imprime uniquement le message, mais il peut √©galement facilement lancer le client PS Empire, qui fournira un acc√®s distant au shell. <br>  Et avant que la victime n'ait le temps de dire quoi que ce soit, les pirates seront les adolescents les plus riches du village. <br><br><img src="https://habrastorage.org/webt/s2/hr/o3/s2hro3e7lhftosp6nrtdj1cjsge.jpeg"><br>  <font color="#999999"><i>Le shell a √©t√© lanc√© sans le moindre encodage.</i></font>  <font color="#999999"><i>M√™me un enfant peut le faire!</i></font> <br><br><h2>  DDE et champs </h2><br>  Plus tard, Microsoft a toujours d√©sactiv√© DDE dans Word, mais avant cela, la soci√©t√© a d√©clar√© que cette fonctionnalit√© avait simplement √©t√© utilis√©e √† mauvais escient.  Leur r√©ticence √† changer quelque chose est compr√©hensible.  De ma propre exp√©rience, j'ai moi-m√™me observ√© un tel exemple que la mise √† jour des champs lors de l'ouverture d'un document √©tait activ√©e, mais les macros Word √©taient d√©sactiv√©es par le service informatique (mais avec une notification).  √Ä propos, vous pouvez trouver les param√®tres correspondants dans la section Param√®tres de Word. <br><br>  Cependant, m√™me si la mise √† jour des champs est activ√©e, Microsoft Word avertira en outre l'utilisateur lorsqu'un champ demande l'acc√®s aux donn√©es supprim√©es, comme c'est le cas avec le DDE ci-dessus.  Microsoft vous met vraiment en garde. <br><br>  Mais tr√®s probablement, les utilisateurs ignoreront toujours cet avertissement et activeront la mise √† jour du champ dans Word.  C'est l'une des rares occasions de remercier Microsoft d'avoir d√©sactiv√© la dangereuse fonctionnalit√© DDE. <br><br>  Est-il difficile de trouver un syst√®me Windows non corrig√© aujourd'hui? <br><br>  Pour ce test, j'ai utilis√© AWS Workspaces pour acc√©der au bureau virtuel.  Ainsi, j'ai obtenu une machine virtuelle non corrig√©e avec MS Office, ce qui m'a permis d'ins√©rer le champ DDEAUTO.  Je ne doute pas que de la m√™me mani√®re, vous pouvez trouver d'autres soci√©t√©s qui n'ont pas encore install√© les correctifs de s√©curit√© n√©cessaires. <br><br><h2>  Myst√®re des objets </h2><br>  M√™me si vous avez install√© ce correctif, il existe d'autres failles de s√©curit√© dans MS Office qui permettent aux pirates de faire quelque chose de tr√®s similaire √† ce que nous avons fait avec Word.  Dans le sc√©nario suivant, nous apprendrons √† <strong>utiliser Excel comme app√¢t pour une attaque de phishing sans √©crire de code.</strong> <br><br>  Pour comprendre ce sc√©nario, rappelons le <i>mod√®le d'objet composant</i> Microsoft, ou abr√©g√© <i>COM (mod√®le d'objet composant)</i> . <br><br>  COM existe depuis les ann√©es 90 et est d√©fini comme un "mod√®le de composant orient√© objet neutre pour le langage de programmation" bas√© sur des appels de proc√©dure RPC distants.  Pour une compr√©hension g√©n√©rale de la terminologie COM, lisez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cet article</a> sur StackOverflow. <br><br>  En gros, vous pouvez imaginer une application COM comme un ex√©cutable Excel ou Word, ou un autre fichier binaire qui peut √™tre lanc√©. <br><br>  Il s'av√®re qu'une application COM peut √©galement ex√©cuter un <i>script</i> - JavaScript ou VBScript.  Techniquement, cela s'appelle un <strong>scriptlet</strong> .  Vous avez peut-√™tre rencontr√© l'extension sct pour les fichiers sous Windows - il s'agit de l'extension officielle pour les scriptlets.  En fait, ils sont le code d'un script envelopp√© dans un wrapper XML: <br><br><pre><code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?XML version="1.0"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scriptlet</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">registration</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">description</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"test"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">progid</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"test"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1.00"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">classid</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{BBBB4444-0000-0000-0000-0000FAADACDC}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">remotable</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">registration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">language</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"JScript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="xml"><span class="xml"> &lt;![CDATA[ var r = new ActiveXObject("WScript.Shell").Run("cmd /k powershell -c Write-Host You have been scripted!"); ]]&gt; </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scriptlet</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Les pirates et les pentesters ont d√©couvert qu'il existe sur Windows des utilitaires et des applications distincts qui acceptent les objets COM et, par cons√©quent, les scriptlets √©galement. <br><br>  Je peux transmettre le scriptlet √† un utilitaire Windows √©crit en VBS, connu sous le nom de pubprn.  Il est situ√© dans les entrailles de C: \ Windows \ system32 \ Printing_Admin_Scripts.  Soit dit en passant, il existe d'autres utilitaires Windows qui prennent des objets comme param√®tres.  Pour commencer, consid√©rez cet exemple. <br><br><img src="https://habrastorage.org/webt/yk/ed/ne/ykedneaau8q1rs8n_jizxmiwzp4.jpeg"><br>  <font color="#999999"><i>Il est tout √† fait naturel que le shell puisse √™tre lanc√© m√™me √† partir d'un script d'impression.</i></font>  <font color="#999999"><i>Allez Microsoft!</i></font> <br><br>  Comme test, j'ai cr√©√© un simple scriptlet distant qui lance le shell et imprime le dr√¥le de message "Vous venez d'√™tre script√©!".  Essentiellement, pubprn instancie l'objet scriptlet, permettant √† VBScript d'ex√©cuter le shell.  Cette m√©thode offre des avantages √©vidents aux pirates qui souhaitent s'introduire et se cacher dans votre syst√®me. <br><br>  Dans le prochain article, j'expliquerai comment les scriptlets COM peuvent √™tre utilis√©s par des pirates utilisant des feuilles de calcul Excel. <br><br>  Pour vos devoirs, regardez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cette vid√©o</a> Derbycon 2016 qui explique comment les pirates ont utilis√© les scriptlets.  Et lisez √©galement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cet article</a> sur les scriptlets et une sorte de surnom. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr460521/">https://habr.com/ru/post/fr460521/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr460509/index.html">Comment les mandataires r√©sidents aident-ils dans les affaires: un cas r√©el d'utilisation d'Infatica dans l'exploration de donn√©es</a></li>
<li><a href="../fr460511/index.html">R√©glage PHP-FPM: utilisation de pm statique pour des performances maximales</a></li>
<li><a href="../fr460513/index.html">Flutter 1.7 - Quoi de neuf dans la version du 10 juillet 2019</a></li>
<li><a href="../fr460515/index.html">Sommes-nous vraiment proches de l'av√®nement des robots?</a></li>
<li><a href="../fr460517/index.html">Comment d√©tecter les attaques sur l'infrastructure Windows: explorer les outils de piratage</a></li>
<li><a href="../fr460523/index.html">Annonce d'un mitap qui se transforme en douceur en un drinkcap BeerPHP (√† Moscou et en ligne)</a></li>
<li><a href="../fr460525/index.html">Bienvenue √† DINS IT EVENING en juillet: QA et JS</a></li>
<li><a href="../fr460527/index.html">R√©solution de probl√®mes avec pwnable.kr 06 - al√©atoire et 09 - erreur</a></li>
<li><a href="../fr460531/index.html">Curieuses perversions du monde informatique - 5</a></li>
<li><a href="../fr460533/index.html">Vous avez eu l'id√©e d'un produit informatique, quelle est la prochaine</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>