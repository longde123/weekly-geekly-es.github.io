<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìø üåû üßíüèº Bases du moteur JavaScript: optimisation du prototype. Partie 1 üßëüèæ‚Äçü§ù‚Äçüßëüèª üßîüèΩ üõ£Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour √† tous. Il reste de moins en moins de temps avant le lancement du cours "S√©curit√© des syst√®mes d'information" , nous continuons donc aujourd'h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bases du moteur JavaScript: optimisation du prototype. Partie 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/447870/">  Bonjour √† tous.  Il reste de moins en moins de temps avant le lancement du cours <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"S√©curit√© des syst√®mes d'information"</a> , nous continuons donc aujourd'hui √† partager les publications d√©di√©es au lancement de ce cours.  Soit dit en passant, cette publication fait suite √† ces deux articles: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´Principes fondamentaux des moteurs JavaScript: formulaires g√©n√©raux et mise en cache en ligne.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 1 "</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">" Principes de base des moteurs JavaScript: formulaires g√©n√©raux et mise en cache en ligne.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 2 "</a> . <br><br>  L'article d√©crit les principes de base.  Ils sont communs √† tous les moteurs JavaScript, et pas seulement au <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V8 sur</a> lequel les auteurs travaillent ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Benedict</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Matthias</a> ).  En tant que d√©veloppeur JavaScript, je peux dire qu'une compr√©hension plus approfondie du fonctionnement du moteur JavaScript vous aidera √† comprendre comment √©crire du code efficace. <br><br><img src="https://habrastorage.org/webt/sn/lh/zx/snlhzxtpzzs0ynrlywt0hvbfafw.png"><a name="habracut"></a><br><br>  Dans un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article pr√©c√©dent,</a> nous avons expliqu√© comment les moteurs JavaScript optimisent l'acc√®s aux objets et aux tableaux √† l'aide de formulaires et de caches en ligne.  Dans cet article, nous examinerons l'optimisation des compromis de pipeline et l'acc√©l√©ration de l'acc√®s aux propri√©t√©s du prototype. <br><br><blockquote>  Remarque: si vous pr√©f√©rez regarder des pr√©sentations que lire des articles, regardez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cette vid√©o</a> .  Sinon, sautez-le et lisez la suite. </blockquote><br><br>  <b>Niveaux d'optimisation et de compromis</b> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">La derni√®re fois,</a> nous avons d√©couvert que tous les moteurs JavaScript modernes ont en fait le m√™me pipeline: <br><br><img src="https://habrastorage.org/webt/dv/ni/m_/dvnim_h74jp64e3w2hyxmm9h1tu.png"><br><br>  Nous avons √©galement r√©alis√© que, malgr√© le fait que les pipelines de haut niveau d'un moteur √† l'autre aient une structure similaire, il existe une diff√©rence dans le pipeline d'optimisation.  Pourquoi en est-il ainsi?  Pourquoi certains moteurs ont-ils plus de niveaux d'optimisation que d'autres?  Il s'agit de faire un compromis entre une transition rapide vers l'√©tape d'ex√©cution de code ou passer un peu plus de temps √† ex√©cuter le code avec des performances optimales. <br><br><img src="https://habrastorage.org/webt/ry/m5/cv/rym5cvxm6b5pwiaibki4jrtjqdq.png"><br><br>  L'interpr√©teur peut g√©n√©rer rapidement du bytecode, mais le bytecode seul n'est pas suffisamment efficace en termes de vitesse.  L'implication d'un compilateur d'optimisation dans ce processus passe un certain temps, mais permet un code machine plus efficace. <br>  Voyons comment le V8 g√®re cela.  Rappelons que dans la V8, l'interpr√©teur est appel√© Ignition et il est consid√©r√© comme l'interpr√®te le plus rapide parmi les moteurs existants (en mati√®re de vitesse d'ex√©cution du bytecode brut).  Le compilateur d'optimisation dans V8 s'appelle TurboFan, et c'est lui qui g√©n√®re le code machine hautement optimis√©. <br><br><img src="https://habrastorage.org/webt/tr/jx/d7/trjxd74glsh5mmj9swifxkqukfk.png"><br><br>  Le compromis entre le d√©lai de d√©marrage et la vitesse d'ex√©cution est la raison pour laquelle certains moteurs JavaScript pr√©f√®rent ajouter des niveaux d'optimisation suppl√©mentaires entre les √©tapes.  Par exemple, SpiderMonkey ajoute un niveau Baseline entre son interpr√©teur et le compilateur IonMonkey d'optimisation complet: <br><br><img src="https://habrastorage.org/webt/ey/ry/1w/eyry1w6rnodjaethbgmjhcfkjj4.png"><br><br>  L'interpr√©teur g√©n√®re rapidement du bytecode, mais le bytecode lui-m√™me est relativement lent.  Baseline g√©n√®re du code un peu plus longtemps, mais offre de meilleures performances √† l'ex√©cution.  Enfin, le compilateur d'optimisation IonMonkey passe le plus de temps √† g√©n√©rer du code machine, mais ce code est extr√™mement efficace. <br>  Regardons un exemple sp√©cifique et voyons comment les pipelines de divers moteurs g√®rent ce probl√®me.  Ici, dans la boucle chaude, le m√™me code est souvent r√©p√©t√©. <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">4242424242</span></span>; ++i) { result += i; } <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(result);</code> </pre> <br><br>  V8 commence par d√©marrer le bytecode dans l'interpr√©teur Ignition.  √Ä un moment donn√©, le moteur d√©termine que le code est chaud et lance l'interface TurboFan, qui int√®gre les donn√©es de profilage et cr√©e une repr√©sentation machine de base du code.  Il est ensuite envoy√© √† TurboFan optimizer dans un autre thread pour une am√©lioration suppl√©mentaire. <br><br><img src="https://habrastorage.org/webt/gy/zs/fb/gyzsfbelxi0ffbra0x2t-r6tm90.png"><br><br>  Pendant que l'optimisation est en cours, V8 continue d'ex√©cuter du code dans Ignition.  √Ä un moment donn√©, lorsque l'optimiseur est termin√© et que nous avons re√ßu du code machine ex√©cutable, il passe imm√©diatement √† l'√©tape d'ex√©cution. <br>  SpyderMonkey d√©marre √©galement l'ex√©cution de bytecode dans l'interpr√©teur.  Mais il a un niveau de base suppl√©mentaire, ce qui signifie que le code chaud est envoy√© en premier.  Le compilateur Baseline g√©n√®re du code Baseline dans le thread principal et continue son ex√©cution √† la fin de sa g√©n√©ration. <br><br><img src="https://habrastorage.org/webt/xe/4k/oy/xe4koybmve5b33fwgwef87b1a_u.png"><br><br>  Si le code Baseline fonctionne depuis un certain temps, SpiderMonkey lance finalement l'interface IonMonkey (frontend IonMonkey) et ex√©cute l'optimiseur, le processus est tr√®s similaire √† V8.  Tout cela continue de fonctionner en m√™me temps dans Baseline, tandis qu'IonMonkey est engag√© dans l'optimisation.  Enfin, lorsque l'optimiseur a termin√© son travail, le code optimis√© est ex√©cut√© √† la place du code de base. <br><br>  L'architecture de Chakra est tr√®s similaire √† SpiderMonkey, mais Chakra essaie d'ex√©cuter plus de processus en m√™me temps pour √©viter de bloquer le thread principal.  Au lieu d'ex√©cuter n'importe quelle partie du compilateur dans le thread principal, Chakra copie le bytecode et les donn√©es de profilage dont le compilateur a besoin et les envoie au processus de compilation d√©di√©. <br><br><img src="https://habrastorage.org/webt/3n/8x/op/3n8xopdh2_b-iobjurabjd6vj7m.png"><br><br>  Lorsque le code g√©n√©r√© est pr√™t, le moteur ex√©cute ce code SimpleJIT au lieu du bytecode.  La m√™me chose se produit avec FullJIT.  L'avantage de cette approche est que la pause qui se produit pendant la copie est g√©n√©ralement beaucoup plus courte que le d√©marrage d'un compilateur √† part enti√®re (frontal).  D'un autre c√¥t√©, cette approche pr√©sente un inconv√©nient.  Cela r√©side dans le fait que l'heuristique de copie peut ignorer certaines informations qui seront n√©cessaires √† l'optimisation, nous pouvons donc dire que dans une certaine mesure, la qualit√© du code est sacrifi√©e pour acc√©l√©rer le travail. <br><br>  Dans JavaScriptCore, tous les compilateurs d'optimisation fonctionnent compl√®tement en parall√®le avec l'ex√©cution de base de JavaScript.  Il n'y a pas de phase de copie.  Au lieu de cela, le thread principal commence simplement √† compiler dans un autre thread.  Les compilateurs utilisent ensuite un sch√©ma de verrouillage complexe pour acc√©der aux donn√©es de profilage √† partir du thread principal. <br><br><img src="https://habrastorage.org/webt/22/ih/lv/22ihlvsqxl_80pfo4qgivtksbqk.png"><br><br>  L'avantage de cette approche est qu'elle r√©duit la quantit√© de d√©chets qui appara√Æt apr√®s l'optimisation dans le thread principal.  L'inconv√©nient de cette approche est qu'elle n√©cessite la r√©solution de probl√®mes complexes de multithreading et certains co√ªts de blocage pour diverses op√©rations. <br>  Nous avons parl√© des compromis entre la g√©n√©ration de code rapide pendant l'ex√©cution de l'interpr√©teur et la g√©n√©ration de code rapide √† l'aide du compilateur d'optimisation.  Mais il y a un autre compromis, et il concerne l'utilisation de la m√©moire.  Pour l'illustrer, j'ai √©crit un programme JavaScript simple qui ajoute deux nombres. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x, y</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x + y; } add(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>);</code> </pre> <br><br>  Regardez le bytecode qui est g√©n√©r√© pour la fonction add par l'interpr√©teur Ignition dans V8. <br><br><pre> <code class="javascript hljs">StackCheck Ldar a1 Add a0, [<span class="hljs-number"><span class="hljs-number">0</span></span>] Return</code> </pre> <br><br>  Ne vous inqui√©tez pas du bytecode, vous n'avez pas besoin de pouvoir le lire.  Ici, il faut faire attention au fait qu'il ne contient <b>que 4 instructions</b> . <br>  Lorsque le code devient chaud, TurboFan g√©n√®re un code machine hautement optimis√©, qui est pr√©sent√© ci-dessous: <br><br><pre> <code class="javascript hljs">leaq rcx,[rip+<span class="hljs-number"><span class="hljs-number">0x0</span></span>] movq rcx,[rcx<span class="hljs-number"><span class="hljs-number">-0x37</span></span>] testb [rcx+<span class="hljs-number"><span class="hljs-number">0xf</span></span>],<span class="hljs-number"><span class="hljs-number">0x1</span></span> jnz CompileLazyDeoptimizedCode push rbp movq rbp,rsp push rsi push rdi cmpq rsp,[r13+<span class="hljs-number"><span class="hljs-number">0xe88</span></span>] jna StackOverflow movq rax,[rbp+<span class="hljs-number"><span class="hljs-number">0x18</span></span>] test al,<span class="hljs-number"><span class="hljs-number">0x1</span></span> jnz Deoptimize movq rbx,[rbp+<span class="hljs-number"><span class="hljs-number">0x10</span></span>] testb rbx,<span class="hljs-number"><span class="hljs-number">0x1</span></span> jnz Deoptimize movq rdx,rbx shrq rdx, <span class="hljs-number"><span class="hljs-number">32</span></span> movq rcx,rax shrq rcx, <span class="hljs-number"><span class="hljs-number">32</span></span> addl rdx,rcx jo Deoptimize shlq rdx, <span class="hljs-number"><span class="hljs-number">32</span></span> movq rax,rdx movq rsp,rbp pop rbp ret <span class="hljs-number"><span class="hljs-number">0x18</span></span></code> </pre> <br><br>  Il y a vraiment beaucoup d'√©quipes ici, surtout en comparaison avec les quatre que nous avons vues dans le bytecode.  En g√©n√©ral, le bytecode est beaucoup plus volumineux que le code machine, et en particulier le code machine optimis√©.  Le bytecode, en revanche, est ex√©cut√© par l'interpr√©teur, tandis que le code optimis√© peut √™tre ex√©cut√© directement par le processeur. <br>  C'est l'une des raisons pour lesquelles les moteurs JavaScript ne font pas que ¬´tout optimiser¬ª.  Comme nous l'avons vu pr√©c√©demment, la g√©n√©ration de code machine optimis√© prend beaucoup de temps et n√©cessite donc plus de m√©moire. <br><br><img src="https://habrastorage.org/webt/dn/h5/sm/dnh5smq1qva1g8udg583xeve85y.png"><br><br>  <b>Pour r√©sumer:</b> La raison pour laquelle les moteurs JavaScript ont diff√©rents niveaux d'optimisation est de trouver un compromis entre la g√©n√©ration de code rapide √† l'aide de l'interpr√©teur et la g√©n√©ration de code rapide √† l'aide du compilateur d'optimisation.  L'ajout de niveaux d'optimisation suppl√©mentaires vous permet de prendre des d√©cisions plus √©clair√©es, en fonction du co√ªt de la complexit√© et des frais suppl√©mentaires lors de l'ex√©cution.  De plus, il existe un compromis entre le niveau d'optimisation et l'utilisation de la m√©moire.  C'est pourquoi les moteurs JavaScript essaient d'optimiser uniquement les fonctions chaudes. <br><br>  <b>Optimiser l'acc√®s aux propri√©t√©s du prototype</b> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">La derni√®re fois,</a> nous avons expliqu√© comment les moteurs JavaScript optimisent le chargement des propri√©t√©s des objets √† l'aide de formulaires et de caches en ligne.  Rappelons que les moteurs stockent les formes des objets s√©par√©ment des valeurs de l'objet. <br><br><img src="https://habrastorage.org/webt/mu/-x/t4/mu-xt4rt-iqzzutk8zaayg33acw.png"><br><br>  Les formulaires vous permettent d'utiliser l'optimisation √† l'aide de caches en ligne ou de circuits int√©gr√©s abr√©g√©s.  Lorsque vous travaillez ensemble, les formulaires et les CI peuvent acc√©l√©rer l'acc√®s r√©p√©t√© aux propri√©t√©s au m√™me endroit dans votre code. <br><br><img src="https://habrastorage.org/webt/1i/sb/bh/1isbbh_xagsaucfsy5vjhmva1gs.png"><br><br>  La premi√®re partie de la publication a donc pris fin, et les classes et la programmation des prototypes se trouvent dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">deuxi√®me partie</a> .  Traditionnellement, nous attendons vos commentaires et discussions houleuses, ainsi que nous vous invitons √† une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">journ√©e portes ouvertes</a> sur le cours "S√©curit√© des Syst√®mes d'Information". </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr447870/">https://habr.com/ru/post/fr447870/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr447856/index.html">Comment vendre une fen√™tre sans jumelage ou l'importance du positionnement avant de d√©velopper un site</a></li>
<li><a href="../fr447860/index.html">Thermodynamique des trous noirs</a></li>
<li><a href="../fr447862/index.html">Cisco Live 2019 EMEA. S√©ances techniques: simplification externe avec complications internes</a></li>
<li><a href="../fr447864/index.html">Actualit√©s de la semaine: principaux √©v√©nements informatiques et scientifiques</a></li>
<li><a href="../fr447868/index.html">Module t√©l√©m√®tre √† ultrasons sous-marin. Deuxi√®me partie</a></li>
<li><a href="../fr447872/index.html">Alienware M15: ordinateur portable de jeu compact avec des options de mise √† niveau compl√®tes</a></li>
<li><a href="../fr447874/index.html">Entropie du Chaos</a></li>
<li><a href="../fr447876/index.html">Tout est tr√®s mauvais ou un nouveau type d'interception du trafic</a></li>
<li><a href="../fr447878/index.html">V√©rification de rdesktop et xrdp avec PVS-Studio</a></li>
<li><a href="../fr447880/index.html">Validation de rdesktop et xrdp √† l'aide de l'analyseur PVS-Studio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>