<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💃🏽 👆 🧑🏿‍🤝‍🧑🏻 我们努力做到最大：从ORM到字节码分析 👩🏽‍🏭 ⚖️ 🐺</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="如您所知，一个真正的程序员在生活中应该做三件事：创建自己的编程语言，编写自己的操作系统以及编写自己的ORM。 而且，如果我很久以前写过这种语言（也许我会再告诉你），而操作系统仍在继续，那么我现在想向您介绍ORM。 更确切地说，它甚至不关ORM本身，而是关乎一个小的，本地的以及看似完全简单的功能的实现...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>我们努力做到最大：从ORM到字节码分析</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/409043/"><p> 如您所知，一个真正的程序员在生活中应该做三件事：创建自己的编程语言，编写自己的操作系统以及编写自己的ORM。 而且，如果我很久以前写过这种语言（也许我会再告诉你），而操作系统仍在继续，那么我现在想向您介绍ORM。 更确切地说，它甚至不关ORM本身，而是关乎一个小的，本地的以及看似完全简单的功能的实现。 </p><br><p>我们将共同努力，从找到简单解决方案的喜悦，到意识到其脆弱性和不正确性的痛苦。 从使用专有的公共API到肮脏的黑客。 从“几乎没有反射”到“深入了解字节码解释器”。 </p><br><p> 谁在乎如何分析字节码，它遇到了什么困难以及最终可以得到什么惊人的结果，欢迎您的注意。 </p><a name="habracut"></a><br><h3 id="soderzhanie"> 目录内容 </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">1-</a>一切如何开始。 <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">2-4-</a>在字节码的路上。 <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">5-</a>谁是字节码。 <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">6-</a>分析本身。 出于本章的考虑，一切都被构思出来，而其中正是胆量。 <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">7-</a>还有什么可以完成的。 梦想，梦想... <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">后记</a> -后记。 </p><br><p>  <em>UPD：发布后立即丢失了第6-8部分（因此开始了所有工作）。</em>  <em>固定的。</em> </p><br><a name="1"></a><br><h3 id="chast-pervaya-problema"> 第一部分 问题 </h3><br><p> 想象我们有一个简单的方案。 有一个客户，他有几个帐户。 其中之一是默认设置。 此外，一个客户端可以具有多个SIM卡，并且可以显式设置每个SIM卡，或者可以使用默认客户端。 </p><br><p><img src="https://habrastorage.org/webt/dh/io/ag/dhioagv6hwl7cmpls9cuh2a_dyq.png"></p><br><p> 这是在我们的代码中描述此模型的方式（省略getters / setters /构造函数/ ...）。 </p><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@JdbcEntity</span></span>(table = <span class="hljs-string"><span class="hljs-string">"CLIENT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JdbcId</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@JdbcColumn</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String name; <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"DEFAULTACCOUNT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Account defaultAccount; } <span class="hljs-meta"><span class="hljs-meta">@JdbcEntity</span></span>(table = <span class="hljs-string"><span class="hljs-string">"ACCOUNT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JdbcId</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@JdbcColumn</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long balance; <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"CLIENT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; } <span class="hljs-meta"><span class="hljs-meta">@JdbcEntity</span></span>(table = <span class="hljs-string"><span class="hljs-string">"CARD"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Card</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JdbcId</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@JdbcColumn</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String msisdn; <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"ACCOUNT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Account account; <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"CLIENT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; }</code> </pre> <br><p> 在ORM本身中，我们要求不存在代理（必须创建此特定类的实例）和单个请求。 因此，这是试图获取映射时将sql发送到数据库的内容。 </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> CARD.id <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, CARD.msisdn msisdn, ACCOUNT_2.id ACCOUNT_2_id, ACCOUNT_2.balance ACCOUNT_2_balance, CLIENT_3.id CLIENT_3_id, CLIENT_3.name CLIENT_3_name, CLIENT_1.id CLIENT_1_id, CLIENT_1.name CLIENT_1_name, ACCOUNT_4.id ACCOUNT_4_id, ACCOUNT_4.balance ACCOUNT_4_balance <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> CARD <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CLIENT</span></span> CLIENT_1 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> CARD.CLIENT = CLIENT_1.id <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ACCOUNT</span></span> ACCOUNT_2 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> CARD.ACCOUNT = ACCOUNT_2.id <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CLIENT</span></span> CLIENT_3 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> ACCOUNT_2.CLIENT = CLIENT_3.id <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ACCOUNT</span></span> ACCOUNT_4 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> CLIENT_1.DEFAULTACCOUNT = ACCOUNT_4.id;</code> </pre> <br><p> 哎呀 客户和帐单重复。 没错，如果您考虑一下，这是可以理解的-毕竟，框架不知道卡客户端和卡帐户客户端是同一客户端。 而且，该请求仅需要静态生成，并且只能静态生成（请记住对请求唯一性的限制吗？）。 </p><br><p> 顺便说一句，出于完全相同的原因，这里根本没有<code>Card.account.client.defaultAccount</code>和<code>Card.client.defaultAccount.client</code>字段。 只有我们知道<code>client</code>和<code>client.defaultAccount.client</code>总是匹配。 而且框架不知道，对他来说这是一个任意链接。 在这种情况下该如何做还不清楚。 我知道3种选择： </p><br><ol><li> 在注解中明确描述不变式。 </li><li> 进行递归查询（ <code>with recursive</code> / <code>connect by</code> ）。 </li><li> 得分。 </li></ol><br><p> 猜猜我们选择了哪个选项？ 对啊 结果，所有递归字段现在都没有被填充，并且始终为空。 </p><br><p> 但是，如果仔细观察，您会发现复制背后的第二个问题，而且情况更糟。 我们想要什么？ 卡号和余额。 你得到了什么？  4个连接和10个列。 而且这件事呈指数增长！ 好吧 实际上，我们的情况是，首先，为了美观和完整性，我们在注释上充分描述了模型，然后， <strong>为了5个字段</strong> ，请求了<strong>15个连接和150列</strong>的请求。 而在这一刻，它变得非常可怕。 </p><br><a name="2"></a><br><h3 id="chast-vtoraya-rabochee-no-neudobnoe-reshenie"> 第二部分 一个可行但不方便的解决方案 </h3><br><p> 一个简单的解决方案立即产生了作用。 仅将要使用的扬声器拖动！ 说起来容易。 最明显的选择（用手写下选区）我们将立即掉落。 好吧，不是那时，我们描述了该模型以免使用它。 很久以前，就有了一种特殊的方法<code>partialGet</code> 。 与简单的<code>get</code>不同，它接受<code>List&lt;String&gt;</code> -要填充的字段的名称。 为此，您必须首先在表中注册别名 </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"ACCOUNT"</span></span>, sqlTableAlias = <span class="hljs-string"><span class="hljs-string">"a"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Account account; <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"CLIENT"</span></span>, sqlTableAlias = <span class="hljs-string"><span class="hljs-string">"c"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client;</code> </pre> <br><p> 然后享受结果。 </p><br><pre> <code class="java hljs">List&lt;String&gt; requiredColumns = asList(<span class="hljs-string"><span class="hljs-string">"msisdn"</span></span>, <span class="hljs-string"><span class="hljs-string">"c_a_balance"</span></span>, <span class="hljs-string"><span class="hljs-string">"a_balance"</span></span>); String query = cardMapper.getSelectSQL(requiredColumns, DatabaseType.ORACLE); System.out.println(query);</code> </pre> <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> CARD.msisdn msisdn, c_a.balance c_a_balance, a.balance a_balance <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> CARD <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ACCOUNT</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> CARD.ACCOUNT = a.id <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CLIENT</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> CARD.CLIENT = c.id <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ACCOUNT</span></span> c_a <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> c.DEFAULTACCOUNT = c_a.id;</code> </pre> <br><p> 一切似乎都很好，但实际上不是。 这是在实际代码中的用法。 </p><br><pre> <code class="java hljs">Card card = cardDAO.partialGet(cardId, <span class="hljs-string"><span class="hljs-string">"msisdn"</span></span>, <span class="hljs-string"><span class="hljs-string">"c_a_balance"</span></span>, <span class="hljs-string"><span class="hljs-string">"a_balance"</span></span>); ... ... ...    ... ... ... <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> clientId = card.getClient().getId();<span class="hljs-comment"><span class="hljs-comment">//, NPE.  , id    ?!</span></span></code> </pre> <br><p> 事实证明，现在只有在partialGet和使用结果之间的距离只有几行的情况下，才可以使用partialGet。 但是，如果结果走得太远，或者，上帝禁止，是通过某种方法传递的，那么已经很难理解哪些字段已填充，哪些字段未填充。 而且，如果NPE发生在某个地方，那么您仍然需要了解它是否真正从空数据库返回，或者我们是否未填写此字段。 总而言之，非常不可靠。 </p><br><p> 当然，您可以使用映射专门针对请求编写另一个对象，甚至可以用手完全选择整个对象并将其组装成一些<code>Tuple</code> 。 实际上，实际上在大多数地方，我们只是这样做。 但是我还是不想用手书写选择内容，也不要重复映射。 </p><br><a name="3"></a><br><h3 id="chast-tretya-udobnoe-no-nerabochee-reshenie"> 第三部分。 一个方便但无效的解决方案。 </h3><br><p> 如果您再想一想，那么很快就会想到答案-您需要使用接口。 然后声明 </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MsisdnAndBalance</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMsisdn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBalance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br><p> 并使用 </p><br><pre> <code class="java hljs">MsisdnAndBalance card = cardDAO.partialGet(cardId, ...);</code> </pre> <br><p> 仅此而已。 请勿多呼。 而且，随着过渡到Kotlin /十/龙，甚至可以消除这种可怕的类型。 但是这里最重要的一点仍然被省略。 什么参数应该传递给<code>partialGet</code> ？ 像以前一样，丁字裤不再有感觉，因为冒着犯错误和写错字段的风险太大。 我希望你能够以某种方式 </p><br><pre> <code class="java hljs">MsisdnAndBalance card = cardDAO.partialGet(cardId, MsisdnAndBalance.class);</code> </pre> <br><p> 甚至通过改良的泛型在Kotlin上更好 </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> card = cardDAO.paritalGet&lt;MsisdnAndBalance&gt;(cardId)</code> </pre> <br><p> 嗯，是个大错。 实际上，整个故事还只是此选项的实现。 </p><br><a name="4"></a><br><h3 id="chast-chetvertaya-na-puti-k-baytkodu"> 第四部分 在字节码的路上 </h3><br><p> 关键问题在于方法来自接口，并且注释位于字段上方。 我们需要通过方法找到这些相同的字段。 第一个也是最明显的想法是使用标准Java Bean约定。 对于微不足道的属性，这甚至可以工作。 但是事实证明非常不稳定。 例如，值得一提的是在界面中重命名方法（通过意识形态重构），因为一切都会立即崩溃。 这个想法足够聪明，可以重命名实现类中的方法，但不足以了解它是一个吸气剂，您需要重命名字段本身。 类似的解决方案导致字段重复。 例如，如果我在界面中需要<code>getClientId()</code>方法，则无法以唯一正确的方式实现它 </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasClientId</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } }</code> </pre> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Card</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasClientId</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.getId(); } }</code> </pre> <br><p> 而且我必须重复字段。 然后在<code>Client</code>拖动<code>id</code>和<code>clientId</code> ，并在客户端旁边的地图中显式包含<code>clientId</code> 。 并确保所有这些都不会消失。 而且，例如，我还希望具有非平凡逻辑的吸气剂起作用 </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Card</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasBalance</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Account account; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBalance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (account != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> account.getBalance(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.getDefaultAccount().getBalance(); } }</code> </pre> <br><p> 因此，不再需要使用按名称搜索的选项，您需要一些更棘手的事情。 </p><br><p> 下一个选择是完全疯了，并没有在我的脑海中长寿，但为了完整起见，我还将对其进行描述。 在解析阶段，我们可以创建一个空实体，然后简单地轮流在字段中写入一些值，然后我们获取吸气剂并查看其是否改变了它们返回的内容。 因此，我们将从<code>name</code>字段中的记录中看到， <code>getClientId</code>的值不会更改，但是从记录<code>id</code>更改。 而且，这里自动支持不同类型的getter和字段（例如<code>isActive() = i_active != 0</code> ）的情况。 但是至少存在三个严重的问题（也许更多，但我没有进一步考虑）。 </p><br><ol><li> 此算法本质的明显要求是，如果“相应”字段未更改，则从吸气剂返回“相同”值。  “相同” –从我们选择的比较运算符的角度来看。  <code>==</code>显然不能（否则某些<code>getAsInt() = Integer.parseInt(strField))</code>将停止工作<code>getAsInt() = Integer.parseInt(strField))</code> 。 保持相等。 因此，如果getter在每次调用时返回由字段生成的某种用户实体，则它必须具有<code>equals</code>的覆盖。 </li><li> 压缩映射。 如上面的<code>int -&gt; boolean</code>的示例。 如果我们检查值0和1，那么我们将看到一个变化。 但是，如果分别是40岁和42岁，那么我们两次都是正确的。 </li><li>  getter中可能存在复杂的转换器，这些转换器依赖于字段中的某些不变量（例如，特殊的字符串格式）。 并且在我们生成的数据上，它们将引发异常。 </li></ol><br><p> 因此，一般而言，该选项也不起作用。 </p><br><p> 在讨论整件事的过程中，我最初开玩笑地说了一个短语“好吧，nafig，更容易看到字节码，所有内容都写在这里”。 在那个时候，我什至没有意识到这个想法会吞噬我，一切都会走多远。 </p><br><a name="5"></a><br><h3 id="chast-pyataya-chto-takoe-baytkod-i-kak-on-rabotaet"> 第五部分 什么是字节码，它如何工作 </h3><br><p> <code>new #4, dup, invokespecial #5, areturn</code> <br> 如果您了解这里写的内容以及该代码的作用，那么可以跳到<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">下</a>一部分。 </p><br><p>  <em>免责声明1.</em>不幸的是，要了解进一步的情况，您至少需要对Java字节码的外观有基本的了解，因此我将写几段有关它的内容。 绝不假装是完整的。 </p><br><p>  <em>免责声明2.</em>它仅涉及方法主体。 我既不说常量池，也不涉及整个类的结构，甚至不涉及方法声明本身。 </p><br><p> 关于字节码，您需要了解的主要内容是Java堆栈虚拟机的汇编程序。 这意味着指令的参数是从堆栈中提取的，而指令的返回值则被推回堆栈中。 从这个角度来看，我们可以说字节码是用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">波兰语相反的符号表示的</a> 。 除了堆栈之外，该方法还具有一组局部变量。 进入方法后， <code>this</code>方法和该方法的所有参数将写入其中，并且在执行期间将本地变量存储在该方法中。 这是一个简单的例子。 </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bar; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateAndReturn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> baz, String str)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> result = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) baz; result += str.length(); bar = result; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } }</code> </pre> <br><p> 我将以以下格式写评论 </p><br><pre> <code class="plaintext hljs"># [(&lt;local_variable_index&gt;:&lt;actual_value&gt;)*], [(&lt;value_on_stack&gt;)*]</code> </pre> <br><p> 堆栈顶部在左侧。 </p><br><pre> <code class="plaintext hljs">public int updateAndReturn(long, java.lang.String); Code: # [0:this, 1:long baz, 3:str], () 0: lload_1 # [0:this, 1:long baz, 3:str], (long baz) 1: l2i # [0:this, 1:long baz, 3:str], (int baz) 2: istore 4 # [0:this, 1:long baz, 3:str, 4:int baz], () 4: iload 4 # [0:this, 1:long baz, 3:str, 4:int baz], (int baz) 6: aload_3 # [0:this, 1:long baz, 3:str, 4:int baz], (str, int baz) 7: invokevirtual #2 // Method java/lang/String.length:()I # [0:this, 1:long baz, 3:str, 4:int baz], (length(str), int baz) 10: iadd # [0:this, 1:long baz, 3:str, 4:int baz], (length(str) + int baz) 11: istore 4 # [0:this, 1:long baz, 3:str, 4:length(str) + int baz], () 13: aload_0 # [0:this, 1:long baz, 3:str, 4:length(str) + int baz], (this) 14: iload 4 # [0:this, 1:long baz, 3:str, 4:length(str) + int baz], (length(str) + int baz, this) 16: putfield #3 // Field bar:I # [0:this, 1:long baz, 3:str, 4:length(str) + int baz], (),     bar 19: iload 4 # [0:this, 1:long baz, 3:str, 4:length(str) + int baz], (length(str) + int baz) 21: ireturn #  int   ,      </code> </pre> <br><p> 有很多说明。 完整列表需要在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">JVMS</a>的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">第六章中找到</a> ，在Wikipedia上有一个<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">简短的复述</a> 。 大量指令针对不同类型彼此重复（例如， <code>lload</code>用于int， <code>lload</code>用于长时间）。 另外，对于使用前4个局部变量的操作，突出显示了它们的指令（例如，有<code>lload_1</code>并且它根本不接受参数，但是只有<code>lload</code> ，它将局部变量的编号作为参数。在上面的示例中，有一个类似的<code>iload</code> ）。 </p><br><p> 在全球范围内，我们将对以下说明组感兴趣： </p><br><ol><li>  <code>*load*</code> ， <code>*store*</code> -读/写局部变量 </li><li>  <code>*aload</code> ， <code>*astore</code>按索引读取/写入数组元素 </li><li>  <code>getfield</code> ， <code>putfield</code>读/写字段 </li><li>  <code>getstatic</code> ， <code>putstatic</code>读取/写入静态字段 </li><li>  <code>checkcast</code>在对象类型之间进行转换。 需要，因为 输入的值位于堆栈和局部变量中。 例如，上面的参数为l2i，用于强制转换long-&gt; int。 </li><li>  <code>invoke*</code> -方法调用 </li><li>  <code>*return</code>返回值并退出方法 </li></ol><br><a name="6"></a><br><h3 id="chast-shestaya-glavnaya"> 第六部分 首页 </h3><br><p> 对于那些错过这么长时间介绍的人，以及为了从图书馆的角度分散最初的问题和原因，我们更精确地提出了问题。 </p><br><blockquote> 必须要有一个<code>java.lang.reflect.Method</code>实例，以获取所有非静态字段（包括当前对象和所有嵌套对象）的列表，这些字段的读数（直接或传递）将位于此方法内。 </blockquote><p> 例如，对于这种方法 </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBalance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Account acc; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (account != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) acc = account; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> acc = client.getDefaultAccount(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> acc.getBalance(); }</code> </pre> <br><p> 您需要获取两个字段的列表： <code>account.balance</code>和<code>client.defaultAccount.balance</code> 。 </p><br><p> 如果可能的话，我将写一个广义的解决方案。 但是在很多地方，您将不得不使用原始问题的知识来解决通常无法解决的问题。 </p><br><p> 首先，您需要获取方法主体本身的字节码，但是您不能直接通过Java来做到这一点。 但是因为 由于该方法最初存在于某个类中，因此更容易获取该类本身。 在全球范围内，我知道两个选择：进入类加载过程并在其中拦截已读取的<code>byte[]</code> ，或者只是在磁盘上找到<code>ClassName.class</code>文件并读取它。 无法拦截常规库级别的加载。 您需要连接javaagent或使用自定义ClassLoader。 无论如何，都需要其他步骤来配置jvm /应用程序，这很不方便。 您可以轻松完成。 所有“普通”类始终与扩展名“ .class”在同一个文件中，该路径是类包。 是的，无法找到动态添加的类或由某些自定义类加载器加载的类，但是对于jdbc模型我们需要这样做，因此我们可以放心地说所有类都将以“默认方式”打包在jar中。 总计： </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> InputStream </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClassFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Class&lt;?&gt; clazz)</span></span></span><span class="hljs-function"> </span></span>{ String file = clazz.getName().replace(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-string"><span class="hljs-string">'/'</span></span>) + <span class="hljs-string"><span class="hljs-string">".class"</span></span>; ClassLoader cl = clazz.getClassLoader(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cl == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ClassLoader.getSystemResourceAsStream(file); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cl.getResourceAsStream(file); }</code> </pre> <br><p> 万岁，读取字节数组。 接下来我们将如何处理？ 原则上，Java中有几个用于读取/写入字节码的库，但是<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">ASM</a>通常用于最底层的工作。 因为 它经过改进，可实现高性能和即时操作，其中的主要访问者API是-asm顺序读取该类并提取适当的方法 </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClassVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> version, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String signature, String superName, String[] interfaces)</span></span></span><span class="hljs-function"> </span></span>{...} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> FieldVisitor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitField</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String desc, String signature, Object value)</span></span></span><span class="hljs-function"> </span></span>{...} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodVisitor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String desc, String signature, String[] exceptions)</span></span></span><span class="hljs-function"> </span></span>{...} ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> MethodVisitor mv; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MethodVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> api, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MethodVisitor mv)</span></span></span><span class="hljs-function"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mv = mv; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitJumpInsn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> opcode, Label label)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mv != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { mv.visitJumpInsn(opcode, label); } } ... }</code> </pre> <br><p> 邀请用户重新定义他感兴趣的方法，并在那里编写自己的分析/转换逻辑。 另外，在<code>MethodVisitor</code>的示例中，我想提请注意一个事实，即所有访问者都有通过委派实现的默认实现。 </p><br><p> 除了主要的api外，还有一个开箱即用的Tree API。 如果Core API是SAX解析器的类似物，则Tree API是DOM的类似物。 我们得到一个对象，该对象中存储了有关类/方法的所有信息，并可以根据需要进行分析，并跳转到任何地方。 实际上，此api是一个<code>*Visitor</code>实现，它在<code>visit*</code>方法内部仅存储信息。 几乎所有的方法如下所示： </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodNode</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitJumpInsn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> opcode, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Label label)</span></span></span><span class="hljs-function"> </span></span>{ instructions.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JumpInsnNode(opcode, getLabelNode(label))); } ... }</code> </pre> <br><p> 现在，我们终于可以加载该方法进行分析了。 </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnalyzerClassVisitor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClassVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String getterName; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String getterDesc; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MethodNode methodNode; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AnalyzerClassVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Method getter)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(ASM6); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getterName = getter.getName(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getterDesc = getMethodDescriptor(getter); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodNode </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMethodNode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (methodNode == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodNode; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodVisitor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String desc, String signature, String[] exceptions)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      if (!name.equals(getterName) || !desc.equals(getterDesc)) return null; return new AnalyzerMethodVisitor(access, name, desc, signature, exceptions); } private class AnalyzerMethodVisitor extends MethodVisitor { public AnalyzerMethodVisitor(int access, String name, String desc, String signature, String[] exceptions) { super(ASM6, new MethodNode(ASM6, access, name, desc, signature, exceptions)); } @Override public void visitEnd() { //     ,     MethodVisitor    if (methodNode != null) throw new IllegalStateException(); methodNode = (MethodNode) mv; } } }</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">完整的代码读取方法。</b> <div class="spoiler_text"><p>  <code>MethodNode</code>不是直接返回的，而是带有一对ext的包装器。 字段，因为 我们稍后也会需要它们。 入口点（也是唯一的公共方法）是<code>readMethod(Method): MethodInfo</code> 。 </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodReader</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodInfo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String internalDeclaringClassName; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> classAccess; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MethodNode methodNode; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MethodInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String internalDeclaringClassName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> classAccess, MethodNode methodNode)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.internalDeclaringClassName = internalDeclaringClassName; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.classAccess = classAccess; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.methodNode = methodNode; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInternalDeclaringClassName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> internalDeclaringClassName; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClassAccess</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> classAccess; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodNode </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMethodNode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodNode; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> MethodInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Method method)</span></span></span><span class="hljs-function"> </span></span>{ Class&lt;?&gt; clazz = method.getDeclaringClass(); String internalClassName = getInternalName(clazz); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> (InputStream is = getClassFile(clazz)) { ClassReader cr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClassReader(is); AnalyzerClassVisitor cv = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AnalyzerClassVisitor(internalClassName, method); cr.accept(cv, SKIP_DEBUG | SKIP_FRAMES); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MethodInfo(internalClassName, cv.getAccess(), cv.getMethodNode()); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(e); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> InputStream </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClassFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Class&lt;?&gt; clazz)</span></span></span><span class="hljs-function"> </span></span>{ String file = clazz.getName().replace(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-string"><span class="hljs-string">'/'</span></span>) + <span class="hljs-string"><span class="hljs-string">".class"</span></span>; ClassLoader cl = clazz.getClassLoader(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cl == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ClassLoader.getSystemResourceAsStream(file); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cl.getResourceAsStream(file); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnalyzerClassVisitor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClassVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String className; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String getterName; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String getterDesc; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MethodNode methodNode; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> access; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AnalyzerClassVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String internalClassName, Method getter)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(ASM6); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.className = internalClassName; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getterName = getter.getName(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getterDesc = getMethodDescriptor(getter); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodNode </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMethodNode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (methodNode == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodNode; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAccess</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> access; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> version, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String signature, String superName, String[] interfaces)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!name.equals(className)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.access = access; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodVisitor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String desc, String signature, String[] exceptions)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!name.equals(getterName) || !desc.equals(getterDesc)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AnalyzerMethodVisitor(access, name, desc, signature, exceptions); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnalyzerMethodVisitor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AnalyzerMethodVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String desc, String signature, String[] exceptions)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(ASM6, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MethodNode(ASM6, access, name, desc, signature, exceptions)); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitEnd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (methodNode != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(); methodNode = (MethodNode) mv; } } } }</code> </pre> </div></div><br><p> 是时候直接进行分析了。 怎么做？ 首先想到的是查看所有<code>getfield</code>指令。 每个<code>getfield</code>静态地说明它是哪个字段以及哪个类。 可以认为有必要访问我们班的所有字段。 但是，不幸的是，这不起作用。 这里的第一个问题是多余的被捕获。 </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bar; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> baz; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bar + <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Foo().baz; } }</code> </pre> <br><p> 使用这种算法，我们认为需要baz字段，尽管实际上不需要。 但是这个问题仍然可以解决。 但是该方法怎么办？ </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasClientId</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ HasClientId obj = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> obj.getClientId(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } }</code> </pre> <br><p> 如果我们以与查找字段相同的方式查找方法调用，那么将找不到<code>getClientId</code> 。 因为没有对<code>Client.getClientId</code>的调用，只有对<code>HasClientId.getClientId</code>的调用。 当然，您可以考虑当前类上的所有方法，其所有超类和要使用的所有接口，但这已经太多了。 因此，您可能会意外捕获<code>toString</code> ，并且其中通常是所有字段的列表。 </p><br><p> 而且，我们也希望嵌套对象的getter调用也能正常工作 </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.getId(); } }</code> </pre> <br><p> 在这里，对<code>Client.getId</code>方法的调用根本不适用于<code>Account</code>类。 </p><br><p> 出于强烈的愿望，您仍然可以在一段时间内考虑特殊情况下的骇客攻击，但是很快就会了解到“事情并非如此”，您需要全面监视执行和数据移动的流程。        <code>getfield</code> ,      <code>this</code> ,   -   <code>this</code> .  : </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> id; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> id; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.id + <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Account().id; } }</code> </pre> <br><pre> <code class="plaintext hljs">class Account { public Client client; public long test(); Code: 0: aload_0 1: getfield #2 // Field client:LClient; 4: getfield #3 // Field Client.id:J 7: new #4 // class Account 10: dup 11: invokespecial #5 // Method "&lt;init&gt;":()V 14: getfield #6 // Field id:J 17: ladd 18: lreturn }</code> </pre> <br><ul><li> <code>1: getfield</code>              <code>this</code> ,    <code>aload_0</code> . </li><li> <code>4: getfield</code> —       ,    <code>1: getfield</code> , , ,  <code>this</code> . </li><li> <code>14: getfield</code>   . 因为    ,       ( <code>Account</code> ),     <code>this</code> ,    ,       <code>7: new</code> . </li></ul><br><p> ,        <code>Account.client.id</code> ,  <code>Account.id</code> — .     ,    ,       . </p><br><p>      —    ,    ,   <code>aload_0</code>  <code>getfield</code>         <code>this</code>  , ,        . , .   .     —    !   -,    .     <code>MethodNode</code> ,    (  ).     , ..    (//)        . </p><br><p>     : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Analyzer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">V</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Analyzer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Interpreter&lt;V&gt; interpreter)</span></span></span><span class="hljs-function"> </span></span>{...} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Frame&lt;V&gt;[] analyze(<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String owner, <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MethodNode m) {...} }</code> </pre> <br><p> <code>Analyzer</code>      (  <code>Frame</code> ,    )   .      ,    ,   ,  ,       //etc. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Interpreter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">V</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">copyOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, V value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, V value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">binaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, V value1, V value2)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ternaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, V value1, V value2, V value3)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">naryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, List&lt;? extends V&gt; values)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returnOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, V value, V expected)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">merge</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(V v, V w)</span></span></span></span>; }</code> </pre> <br><p>  <code>V</code> —   ,      ,    . <code>Analyzer</code>          ,    ,           ,      . , <code>getfield</code>      — ,    ,     . ,   <code>unaryOperation(AbstractInsnNode insn, V value): V</code> ,                 .     <code>1: getfield</code>   <code>Value</code> ,     "  <code>client</code> ,  <code>Client</code>        ",   <code>14: getfield</code>  " —  -  ,         ". </p><br><p>       <code>merge(V v, V w): V</code> .      ,        ,    . 例如： </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBalance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Account acc; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (account != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) acc = account; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> acc = client.getDefaultAccount(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> acc.getBalance(); }</code> </pre> <br><p>    <code>Account.getBalance()</code>     .  - .       .   ?         <code>merge</code> . </p><br><p>        —  <code>SuperInterpreter extends Interpreter&lt;SuperValue&gt;</code> ? 对啊    <code>SuperValue</code> .     —       ,        .                ,           . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BasicValue</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Set&lt;Ref&gt; refs; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type, Set&lt;Ref&gt; refs)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(type); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.refs = refs; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ref</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> List&lt;Field&gt; path; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> composite; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ref</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;Field&gt; path, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> composite)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.path = path; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.composite = composite; } }</code> </pre> <br><p>     <code>composite</code> .   ,     . ,  <code>String</code>   .         <code>String.length()</code> ,   ,       <code>name</code> ,   <code>name.value.length</code> . , <code>length</code> —    ,   ,    <code>arraylength</code> .     ? 不行          —         . ,       ,     ,      . ,  <code>Date</code> , <code>String</code> , <code>Long</code> ,          . ,     ,      .     </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Persion</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JdbcColumn</span></span>(converter = CustomJsonConverter.class) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PassportInfo passportInfo; }</code> </pre> <br><p>     <code>PassportInfo</code>    .     ,  .  ,  <code>composite</code>    .       . </p><br><div class="spoiler"> <b class="spoiler_title"></b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ref</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> List&lt;Field&gt; path; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> composite; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ref</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;Field&gt; path, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> composite)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.path = path; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.composite = composite; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Field&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPath</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> path; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isComposite</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> composite; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">equals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object o)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> == o) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (o == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || getClass() != o.getClass()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; Ref ref = (Ref) o; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.equals(path, ref.path); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hashCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.hash(path); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (path.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;[this]&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;"</span></span> + path.stream().map(Field::getName).collect(joining(<span class="hljs-string"><span class="hljs-string">"."</span></span>)) + <span class="hljs-string"><span class="hljs-string">"&gt;"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Ref </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">thisRef</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Ref(emptyList(), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Optional&lt;Ref&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">childRef</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Ref parent, Field field, Configuration configuration)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!parent.isComposite()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> empty(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent.path.contains(field))<span class="hljs-comment"><span class="hljs-comment">//    ,   return empty(); List&lt;Field&gt; path = new ArrayList&lt;&gt;(parent.path); path.add(field); return of(new Ref(path, configuration.isCompositeField(field))); } public static Optional&lt;Ref&gt; childRef(Ref parent, Ref child) { if (!parent.isComposite()) return empty(); if (child.path.stream().anyMatch(parent.path::contains))// ,   return empty(); List&lt;Field&gt; path = new ArrayList&lt;&gt;(parent.path); path.addAll(child.path); return of(new Ref(path, child.composite)); } }</span></span></code> </pre> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BasicValue</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Set&lt;Ref&gt; refs; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type, Set&lt;Ref&gt; refs)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(type); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.refs = refs; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Set&lt;Ref&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRefs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> refs; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">equals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object o)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> == o) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (o == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || getClass() != o.getClass()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.equals(o)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; Value value = (Value) o; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.equals(refs, value.refs); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hashCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.hash(<span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.hashCode(), refs); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"("</span></span> + refs.stream().map(Object::toString).collect(joining(<span class="hljs-string"><span class="hljs-string">","</span></span>)) + <span class="hljs-string"><span class="hljs-string">")"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Value </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">typedValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type, Ref ref)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Value(type, singleton(ref)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Optional&lt;Value&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">childValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Value parent, Value child)</span></span></span><span class="hljs-function"> </span></span>{ Type type = child.getType(); Set&lt;Ref&gt; fields = parent.refs.stream() .flatMap(p -&gt; child.refs.stream().map(c -&gt; childRef(p, c))) .filter(Optional::isPresent) .map(Optional::get) .collect(toSet()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fields.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> empty(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> of(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Value(type, fields)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Optional&lt;Value&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">childValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Value parent, FieldInsnNode childInsn, Configuration configuration)</span></span></span><span class="hljs-function"> </span></span>{ Type type = Type.getType(childInsn.desc); Field child = resolveField(childInsn); Set&lt;Ref&gt; fields = parent.refs.stream() .map(p -&gt; childRef(p, child, configuration)) .filter(Optional::isPresent) .map(Optional::get) .collect(toSet()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fields.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> empty(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> of(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Value(type, fields)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Value </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mergeValues</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Collection&lt;Value&gt; values)</span></span></span><span class="hljs-function"> </span></span>{ List&lt;Type&gt; types = values.stream().map(BasicValue::getType).distinct().collect(toList()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (types.size() != <span class="hljs-number"><span class="hljs-number">1</span></span>) { String typesAsString = types.stream().map(Type::toString).collect(joining(<span class="hljs-string"><span class="hljs-string">", "</span></span>, <span class="hljs-string"><span class="hljs-string">"("</span></span>, <span class="hljs-string"><span class="hljs-string">")"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not merge "</span></span> + typesAsString); } Set&lt;Ref&gt; fields = values.stream().flatMap(v -&gt; v.refs.stream()).distinct().collect(toSet()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Value(types.get(<span class="hljs-number"><span class="hljs-number">0</span></span>), fields); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isComposite</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BasicValue value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value &amp;&amp; value.getType().getSort() == Type.OBJECT &amp;&amp; ((Value) value).refs.stream().anyMatch(Ref::isComposite); } }</code> </pre> </div></div><br><p>   ,    . 走吧 </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FieldsInterpreter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BasicInterpreter</span></span></span><span class="hljs-class"> </span></span>{</code> </pre> <br><p>       ,    <code>BasicInterpreter</code> .    <code>BasicValue</code> (    ,   <code>Value</code>  <code>extends BasicValue</code> )      . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BasicValue</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue UNINITIALIZED_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue INT_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.INT_TYPE); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue FLOAT_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.FLOAT_TYPE); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue LONG_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.LONG_TYPE); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue DOUBLE_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.DOUBLE_TYPE); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue REFERENCE_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.getObjectType(<span class="hljs-string"><span class="hljs-string">"java/lang/Object"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue RETURNADDRESS_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.VOID_TYPE); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Type type; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BasicValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Type type)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.type = type; } }</code> </pre> <br><p>         ( <code>(Value)basicValue</code> )  ,          ,     ( " <code>iconst</code>  ")  . </p><br><p>   <code>newValue</code> .       ,       ,  " ".   , <code>this</code>     <code>catch</code> .  ,     ,     .    <code>BasicInterpreter</code>  <code>BasicValue(actualType)</code>   <code>BasicValue.REFERENCE_VALUE</code> .       . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (type != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; type.getSort() == OBJECT) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(type); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.newValue(type); }</code> </pre> <br><p>  entry point.      <code>this</code> . ,  - ,  ,   <code>this</code> ,     <code>BasicValue(actualType)</code> ,  <code>Value.typedValue(actualType, Ref.thisRef())</code> . ,     ,   <code>this</code>    <code>newValue</code> ,     .       , ..         ,   <code>this</code> .     <code>this</code>    . ,  . ,     <code>this</code>       0.       ,      .   ,            ,  .             . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">copyOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wasUpdated || insn.getType() != VAR_INSN || ((VarInsnNode) insn).<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.copyOperation(insn, value); } <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ALOAD: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> typedValue(value.getType(), thisRef()); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ISTORE: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> LSTORE: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> FSTORE: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DSTORE: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ASTORE: wasUpdated = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.copyOperation(insn, value); }</code> </pre> <br><p>  .    .    ,   ,    ,   — ,   .   ,    . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">merge</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BasicValue v, BasicValue w)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v.equals(w)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> v; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value || w <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Objects.equals(v.getType(), w.getType())) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v == UNINITIALIZED_VALUE || w == UNINITIALIZED_VALUE) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UNINITIALIZED_VALUE; <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not merge "</span></span> + v + <span class="hljs-string"><span class="hljs-string">" and "</span></span> + w); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value != w <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> v; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> w; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mergeValues(asList((Value) v, (Value) w)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.merge(v, w); }</code> </pre> <br><p>    .      ""?         ? 不完全是          .        , ..       . ,      3 (       ): <code>putfield</code> , <code>putstatic</code> , <code>aastore</code> .    .     <code>putstatic</code> (   )    .     ,          .    <code>putfield</code>  <code>aastore</code> .   ,           ,      .   (  )              .            ,             . ,    —      . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Optional.ofNullable(client).map(Client::getId).orElse(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } }</code> </pre> <br><p>    ,        ( <code>ofNullable</code>    <code>Optional</code>  <code>client</code>      <code>value</code> ),         . .     . ,         - <code>ofNullable(client)</code> ,    - <code>map(Client::getId)</code> ,    . </p><br><p>        <code>putfield</code> , <code>putstatic</code>  <code>aastore</code> . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">binaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value1, BasicValue value2)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (insn.getOpcode() == PUTFIELD &amp;&amp; Value.isComposite(value2)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not trace "</span></span> + value2 + <span class="hljs-string"><span class="hljs-string">" over putfield"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.binaryOperation(insn, value1, value2); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ternaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value1, BasicValue value2, BasicValue value3)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (insn.getOpcode() == AASTORE &amp;&amp; Value.isComposite(value3)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not trace "</span></span> + value3 + <span class="hljs-string"><span class="hljs-string">" over aastore"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.ternaryOperation(insn, value1, value2, value3); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(value)) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> PUTSTATIC: { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not trace "</span></span> + value + <span class="hljs-string"><span class="hljs-string">" over putstatic"</span></span>); } ... } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.unaryOperation(insn, value); }</code> </pre> <br><p>   .       <code>checkcast</code> .          :      .  —    </p><br><pre> <code class="java hljs">Client client1 = ...; Object objClient = client1; Client client2 = (Client) objClient;</code> </pre> <br><p>         ,        .         ,   ,       <code>client1</code>  <code>objClient</code> ,   . ,   <code>checkcast</code>          . </p><br><p>     . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;?&gt; list; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trimToSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ((ArrayList&lt;?&gt;) list).trimToSize(); } }</code> </pre> <br><p>      .       ,      ,  ,     .  ,   ,         ,        ,    ,     .          ?  , !       .   ,          ,  ,              null/0/false.    .   —   </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"CLIENT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client;</code> </pre> <br><p>    ,       , ORM      ,    .       <code>checkcast</code> </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(value)) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { ... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CHECKCAST: { Class&lt;?&gt; original = reflectClass(value.getType()); Type targetType = getObjectType(((TypeInsnNode) insn).desc); Class&lt;?&gt; afterCast = reflectClass(targetType); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (afterCast.isAssignableFrom(original)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"type specification not supported"</span></span>); } } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.unaryOperation(insn, value); }</code> </pre> <br><p>     — <code>getfield</code> .      —   ? </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Foo child; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Foo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Foo loopedRef = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (ThreadLocalRandom.current().nextBoolean()) { loopedRef = loopedRef.child; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> loopedRef; } }</code> </pre> <br><p> ,        .     ? <code>child</code> , <code>child.child</code> , <code>child.child.child</code> ?  ? ,       .  ,        .       , </p><br><blockquote>           null. </blockquote><p>        child,       null, , ,     .        <code>Ref.childRef</code>  </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent.path.contains(field)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> empty();</code> </pre> <br><p>    .       ,    . </p><br><p>       "  ".          .   ,           . ,   ,       ( <code>@JdbcJoinedObject</code> ,  <code>@JdbcColumn</code> ),      ,    . ORM        . </p><br><p> ,   <code>getfield</code>           ,     .     ,   ,     ,      .  — . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(value)) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { ... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> GETFIELD: { Optional&lt;Value&gt; optionalFieldValue = childValue((Value) value, (FieldInsnNode) insn, configuration); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!optionalFieldValue.isPresent()) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; Value fieldValue = optionalFieldValue.get(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (configuration.isInterestingField(resolveField((FieldInsnNode) insn))) { context.addUsedField(fieldValue); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(fieldValue)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldValue; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } ... } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.unaryOperation(insn, value); }</code> </pre> <br><p>    .  ,    , .   ,    <code>invoke*</code> .         , ,   ,        .  , : </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getClient().getId(); }</code> </pre> <br><p>  ,      ,     .           ,   .    .      ,          .    ?          .    .      . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Client </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClient</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client; } }</code> </pre> <br><p>  <code>Account.client</code>          .   ,      .        .    —        ,     . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Result</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Set&lt;Value&gt; usedFields; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Value returnedCompositeValue; }</code> </pre> <br><p>    ?  ,   .          .  , ..      (  ,   —  ),   ,       <code>areturn</code> , ,   ,    <code>*return</code> .  <code>MethodNode</code> ( ,     Tree API)       .     .  —          . ,             ?      .         . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Value </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getReturnedCompositeValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Frame&lt;BasicValue&gt;[] frames, AbstractInsnNode[] insns)</span></span></span><span class="hljs-function"> </span></span>{ Set&lt;Value&gt; resultValues = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; insns.length; i++) { AbstractInsnNode insn = insns[i]; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> IRETURN: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> LRETURN: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> FRETURN: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DRETURN: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ARETURN: BasicValue value = frames[i].getStack(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(value)) { resultValues.add((Value) value); } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (resultValues.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mergeValues(resultValues); }</code> </pre> <br><p>    <code>analyzeField</code>   </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Result </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">analyzeField</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Method method, Configuration configuration)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Modifier.isNative(method.getModifiers())) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not analyze native method "</span></span> + method); MethodInfo methodInfo = readMethod(method); MethodNode mn = methodInfo.getMethodNode(); String internalClassName = methodInfo.getInternalDeclaringClassName(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> classAccess = methodInfo.getClassAccess(); Context context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Context(method, classAccess); FieldsInterpreter interpreter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FieldsInterpreter(context, configuration); Analyzer&lt;BasicValue&gt; analyzer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Analyzer&lt;&gt;(interpreter); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { analyzer.analyze(internalClassName, mn); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (AnalyzerException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(e); } Frame&lt;BasicValue&gt;[] frames = analyzer.getFrames(); AbstractInsnNode[] insns = mn.instructions.toArray(); Value returnedCompositeValue = getReturnedCompositeValue(frames, insns); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Result(context.getUsedFields(), returnedCompositeValue); }</code> </pre> <br><p>   , -,     . <code>invoke*</code> .      5 : </p><br><ol><li> <code>invokespecial</code> —      .    ,  ,   (     <code>super.call()</code> ). </li><li> <code>invokevirtual</code> —     .          . ,        . </li><li> <code>invokeinterface</code> —   ,   <code>invokevirtual</code> ,    —      . </li><li> <code>invokestatic</code> —    </li><li> <code>invokedynamic</code> —  ,   7    JSR 292.          JVM,   <code>invokedynamic</code>       (     dynamic).   ,          (+  ),        .  ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">Invokedynamic:   ?</a>  。 </li></ol><br><p>  ,      ,       ,      .  <code>invokedynamic</code>   ,   .  ,      ,       ,     (,       ),   <code>invokedynamic</code>  .   ,   ""  .  ,         <code>invokedynamic</code> ,      . </p><br><p>  . ,         .  ,        . ,      <code>this</code> ,     0? ,    - ,         <code>FieldsInterpreter</code>   <code>copyOperation</code>     .  ,    <code>MethodAnalyzer.analyzeFields</code>    "     <code>this</code> "  "      " ( <code>this</code> —  ).     ,   .   ,   ,  .          ,               - .    ,         (- <code>Optional.ofNullable(client)</code> ).             . </p><br><p> , <code>invokestatic</code>   (..   ,  <code>this</code>   ).  <code>invokespecial</code> , <code>invokevirtual</code>  <code>invokeinterface</code> .  ,         .  ,      ,     jvm.  <code>invokespecial</code>  ,               ,     .    <code>invokevirtual</code>  <code>invokeinterface</code> .   ,        . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">objectToString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object obj)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> obj.toString(); }</code> </pre> <br><pre> <code class="plaintext hljs">public static java.lang.String objectToString(java.lang.Object); Code: 0: aload_0 1: invokevirtual #104 // Method java/lang/Object.toString:()Ljava/lang/String; 4: areturn</code> </pre> <br><p> , ,    ( )  . ,       ,    .            ?        <em>  ORM</em> .  ORM   ,            ,     .      <code>invokevirtual</code>  <code>invokeinterface</code>   . </p><br><p> 万岁！   . 接下来是什么？      ,        (         ,     <code>this</code>  ),     ( ,    )       .  ! </p><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">naryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, List&lt;? extends BasicValue&gt; values)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ Method method = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; Value methodThis = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> INVOKESPECIAL: {...} <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> INVOKEVIRTUAL: {...} <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> INVOKEINTERFACE: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(values.get(<span class="hljs-number"><span class="hljs-number">0</span></span>))) { MethodInsnNode methodNode = (MethodInsnNode) insn; Class&lt;?&gt; objectClass = reflectClass(values.get(<span class="hljs-number"><span class="hljs-number">0</span></span>).getType()); Method interfaceMethod = resolveInterfaceMethod(reflectClass(methodNode.owner), methodNode.name, getMethodType(methodNode.desc)); method = lookupInterfaceMethod(objectClass, interfaceMethod); methodThis = (Value) values.get(<span class="hljs-number"><span class="hljs-number">0</span></span>); } List&lt;?&gt; badValues = values.stream().skip(<span class="hljs-number"><span class="hljs-number">1</span></span>).filter(Value::isComposite).collect(toList()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!badValues.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not pass "</span></span> + badValues + <span class="hljs-string"><span class="hljs-string">" as parameter"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> INVOKESTATIC: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> INVOKEDYNAMIC: { List&lt;?&gt; badValues = values.stream().filter(Value::isComposite).collect(toList()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!badValues.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not pass "</span></span> + badValues + <span class="hljs-string"><span class="hljs-string">" as parameter"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (method != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { MethodAnalyzer.Result methodResult = analyzeFields(method, configuration); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Value usedField : methodResult.getUsedFields()) { childValue(methodThis, usedField).ifPresent(context::addUsedField); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (methodResult.getReturnedCompositeValue() != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Optional&lt;Value&gt; returnedValue = childValue(methodThis, methodResult.getReturnedCompositeValue()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (returnedValue.isPresent()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> returnedValue.get(); } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.naryOperation(insn, values); }</code> </pre> <br><p>         .    ,      .  ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">  JVMS</a>      1  1.            .   —    .  ,   ,        .   ,     ..     ,   -    ,       2  —   .         ,   ,       .   ,   — .    ,   <a href="" rel="nofollow">ResolutionUtil</a>  <a href="" rel="nofollow">LookupUtil</a> . </p><br><p> ! </p><br><a name="7"></a><br><h3 id="chast-sedmaya-chto-esche-mozhno-dodelat">  .     </h3><br><p>  ,   80%   20%     20%   80% . ,     ,    ,   ? </p><br><ul><li><p>        .          . </p><br></li><li><p>       .    (..        ),        . ,    .        ,      . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Optional.ofNullable(client).map(Client::getId).orElse(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } }</code> </pre> <br><p>     <code>Optional</code> ,   <code>ofNullable</code>     <code>getClientId</code>  ,  ,      <code>value</code>    .  ,        <code>returnedCompositeValue</code> —  ,   ,     . , ,        (  )               ,  .        -.          ,    ,    ,  "  <code>value</code>  <code>Optional@1234</code>  <code>Client@5678</code> "   . </p><br></li><li><p>  <code>invokedynamic</code> ,     .    indy      ,      .    ,          . ,     .  ,         invokedynamic.     .    . ,           <code>java.lang.invoke.LambdaMetafactory.metafactory</code> .    ,  ,   ,      .    <code>java.lang.invoke.StringConcatFactory.makeConcat/makeConcatWithConstants</code> .     .          <code>toString()</code> . , ,  ,  ,  .    ,     ,   ,  /-     .            jvm,      .    ,  ,  .             .    .   ,  ,               .          indy .    ?     indy    ,     — <code>CallSite</code> .           . , ,    <code>LambdaMetafactory.metafactory</code>       <code>getValue</code> ,         .       <code>getValue</code> .     (  )  .  , , ,   stateless. ,    !    -    ,      .  <code>CallSite</code>   <code>ConstantCallSite</code> , <code>MutableCallSite</code>  <code>VolatileCallSite</code> .    mutable  volatile   ,       ,   <code>ConstantCallSite</code>  .         "-   ". ,  ,    .    ,         VM,       . </p><br></li></ul><br><a name="8"></a><br><h3 id="posleslovie"> 后记 </h3><br><p> - ,   .   -  <code>partialGet</code>     . ,    .   ,   ,       ,         ,   " "   . </p><br><p>  ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"></a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN409043/">https://habr.com/ru/post/zh-CN409043/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN409033/index.html">隐藏的超级集群可以解决银河系的奥秘</a></li>
<li><a href="../zh-CN409035/index.html">最后，我们处理度数：护卫舰事故的原因</a></li>
<li><a href="../zh-CN409037/index.html">新一代3D扫描仪EinScan-SE</a></li>
<li><a href="../zh-CN409039/index.html">PocketBook-2017：记住过去的一年并进行总结</a></li>
<li><a href="../zh-CN409041/index.html">不能宽恕执行：我们用英语处理标点符号</a></li>
<li><a href="../zh-CN409045/index.html">揭示了纯数学与物理学的秘密联系</a></li>
<li><a href="../zh-CN409047/index.html">将用过的第一阶段和货舱重新发射到国际空间站。 NASA不在乎</a></li>
<li><a href="../zh-CN409049/index.html">FDA批准首个直接遗传病基因治疗</a></li>
<li><a href="../zh-CN409051/index.html">Dmitry Muromtsev（ITMO）-关于本体建模和会话智能的形成</a></li>
<li><a href="../zh-CN409053/index.html">发射直升机-罚款</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>