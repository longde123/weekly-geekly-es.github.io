<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‡ğŸ¿ ğŸ‘¨ğŸ¾â€ğŸ“ ğŸ‘¨â€âš•ï¸ Docker + Laravel = â¤ ğŸŒ ğŸ““ ğŸ˜ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Neste artigo, falarei sobre minha experiÃªncia de "agrupar" um aplicativo Laravel em um contÃªiner Docker para que os desenvolvedores de front-end e bac...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Docker + Laravel = â¤</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/425101/"><p><img src="https://habrastorage.org/getpro/habr/post_images/89c/b0e/91f/89cb0e91fd1efafb24b66b7ee44dc1b0.png" alt="laravel-in-docker"></p><br><p> Neste artigo, falarei sobre minha experiÃªncia de "agrupar" um aplicativo Laravel em um contÃªiner Docker para que os desenvolvedores de front-end e back-end possam trabalhar localmente com ele, e iniciÃ¡-lo na produÃ§Ã£o foi o mais simples possÃ­vel.  AlÃ©m disso, o CI executarÃ¡ automaticamente analisadores de cÃ³digo estÃ¡tico, testes de <code>phpunit</code> e criarÃ¡ imagens. </p><br><p>  "E o que, de fato, Ã© complexidade?"  - vocÃª pode dizer e estarÃ¡ parcialmente certo.  O fato Ã© que muitas discussÃµes nas comunidades de lÃ­ngua russa e de lÃ­ngua inglesa sÃ£o dedicadas a esse tÃ³pico, e eu dividiria condicionalmente quase todos os tÃ³picos estudados nas seguintes categorias: </p><br><ul><li>  "Estou usando o docker para desenvolvimento local. Coloquei o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">laradock</a> e nÃ£o conheÃ§o os problemas".  Legal, mas e o lanÃ§amento da automaÃ§Ã£o e produÃ§Ã£o? </li><li>  "Eu coleciono um container <em>(monÃ³lito)</em> baseado no <code>fedora:latest</code> (~ 230 Mb), coloco todos os serviÃ§os (nginx, db, cache, etc) nele, executo tudo dentro do supervisor."  TambÃ©m excelente, fÃ¡cil de iniciar, mas e a ideologia de "um contÃªiner - um processo"?  E quanto ao balanceamento e gerenciamento de processos?  Qual Ã© o tamanho da imagem? </li><li>  "Aqui estÃ£o algumas configuraÃ§Ãµes, tempere com trechos de sh-scripts, adicione env-values â€‹â€‹mÃ¡gicos, use-os."  Obrigado, mas e quanto a pelo menos um exemplo vivo que eu poderia usar e tocar totalmente? </li></ul><br><p>  Tudo o que vocÃª lÃª abaixo Ã© uma experiÃªncia subjetiva que nÃ£o finge ser a verdade suprema.  Se vocÃª tiver adiÃ§Ãµes ou indicaÃ§Ãµes de imprecisÃµes - bem-vindo aos comentÃ¡rios. </p><br><blockquote>  Para os impacientes - um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">link para o repositÃ³rio</a> , clone o qual vocÃª pode iniciar o aplicativo Laravel com um comando.  TambÃ©m nÃ£o Ã© difÃ­cil executÃ¡-lo no mesmo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fazendeiro</a> , "vinculando" corretamente os contÃªineres ou usar a versÃ£o do supermercado <code>docker-compose.yml</code> como ponto de partida. </blockquote><a name="habracut"></a><br><h2 id="chast-teoreticheskaya">  Parte teÃ³rica </h2><br><p>  Quais ferramentas usaremos em nosso trabalho e em que focaremos?  Primeiro de tudo, precisamos instalar no host: </p><br><ul><li>  <code>docker</code> - no momento da redaÃ§Ã£o, usei a versÃ£o <code>18.06.1-ce</code> </li><li>  <code>docker-compose</code> - lida com a conexÃ£o de contÃªineres e o armazenamento dos valores ambientais necessÃ¡rios;  versÃ£o <code>1.22.0</code> </li><li>  <code>make</code> - vocÃª pode se surpreender, mas se encaixa perfeitamente no contexto de trabalhar com o docker </li></ul><br><blockquote>  VocÃª pode <code>curl -fsSL get.docker.com | sudo sh</code> <code>docker</code> em sistemas do tipo <code>debian</code> com o comando <code>curl -fsSL get.docker.com | sudo sh</code>  <code>curl -fsSL get.docker.com | sudo sh</code> , mas o <code>docker-compose</code> melhor para instalar usando o <code>pip</code> , pois as versÃµes mais recentes estÃ£o em seus repositÃ³rios (o <code>apt</code> muito atrasado, em regra). </blockquote><p>  Isso completa a lista de dependÃªncias.  O que vocÃª usarÃ¡ para trabalhar com o cÃ³digo-fonte - <code>phpstorm</code> , <code>netbeans</code> ou dead <code>vim</code> - depende de vocÃª. </p><br><p>  A seguir, um controle de qualidade improvisado no contexto do design da imagem <em>(nÃ£o tenho medo dessa palavra)</em> : </p><br><ul><li><p>  <strong>P: Imagem bÃ¡sica - qual Ã© a melhor escolha?</strong> </p><br></li><li><p>  <strong>A:</strong> O que Ã© "mais fino", sem frescuras.  Com base no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>alpine</code></a> <em>(~ 5 Mb),</em> vocÃª pode coletar o que seu coraÃ§Ã£o desejar, mas provavelmente terÃ¡ que jogar com a montagem de serviÃ§os da fonte.  Como alternativa - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>jessie-slim</code></a> <em>(~ 30 Mb)</em> .  Ou use o que Ã© mais usado em seus projetos. </p><br></li><li><p>  <strong>P: Por que o peso da imagem Ã© importante?</strong> </p><br></li><li><p>  <strong>R:</strong> DiminuiÃ§Ã£o do volume de trÃ¡fego, diminuiÃ§Ã£o da probabilidade de erro ao baixar (menos dados - menos probabilidade), diminuiÃ§Ã£o no local consumido.  A regra "A gravidade Ã© confiÃ¡vel" (Â© "Snatch") nÃ£o funciona muito bem aqui. </p><br></li><li><p>  <strong>P: Mas meu amigo <code>%friend_name%</code> diz que uma imagem "monolÃ­tica" com todas as dependÃªncias Ã© a melhor maneira.</strong> </p><br></li><li><p>  <strong>A:</strong> Vamos apenas contar.  O aplicativo possui 3 dependÃªncias - PG, Redis, PHP.  E vocÃª queria testar como ele se comportaria em pacotes de versÃµes diferentes dessas dependÃªncias.  PG - versÃµes 9.6 e 10, Redis - 3.2 e 4.0, PHP - 7.0 e 7.2.  Caso cada dependÃªncia seja uma imagem separada - vocÃª precisa de 6 delas, que nem precisa coletar - tudo estÃ¡ pronto e fica no <code>hub.docker.com</code> .  Se, por razÃµes ideolÃ³gicas, todas as dependÃªncias forem "empacotadas" em um contÃªiner, vocÃª precisarÃ¡ montÃ¡-lo com canetas ... 8 vezes?  Agora adicione a condiÃ§Ã£o que vocÃª ainda deseja jogar com o <code>opcache</code> .  No caso de decomposiÃ§Ã£o, isso Ã© simplesmente uma alteraÃ§Ã£o nas tags das imagens usadas.  Um monÃ³lito Ã© mais fÃ¡cil de executar e manter, mas Ã© o caminho para lugar nenhum. </p><br></li><li><p>  <strong>P: Por que o supervisor no contÃªiner Ã© mau?</strong> </p><br></li><li><p>  <strong>A:</strong> Porque o <code>PID 1</code> .  Se vocÃª nÃ£o deseja muitos problemas com os processos zumbis e tem a capacidade de "adicionar capacidade" de forma flexÃ­vel, quando necessÃ¡rio - tente executar um processo por contÃªiner.  Uma exceÃ§Ã£o peculiar Ã© o <code>nginx</code> com seus trabalhadores e o <code>php-fpm</code> , que tÃªm a capacidade de produzir processos, mas precisam tolerar isso (alÃ©m disso, eles nÃ£o sÃ£o ruins em reagir ao <code>SIGTERM</code> , "matando" corretamente seus trabalhadores).  Ao lanÃ§ar todos os demÃ´nios como supervisor, vocÃª quase certamente estÃ¡ se condenando a problemas.  Embora, em alguns casos, seja difÃ­cil ficar sem isso, mas essas jÃ¡ sÃ£o exceÃ§Ãµes. </p><br></li></ul><br><p>  Tendo decidido sobre as principais abordagens, vamos para o nosso aplicativo.  Deve ser capaz de: </p><br><ul><li>  <code>web|api</code> - dÃª estÃ¡tica com <code>nginx</code> e gere conteÃºdo dinÃ¢mico com <code>fpm</code> </li><li>  <code>scheduler</code> - execute o agendador de tarefas nativo </li><li>  <code>queue</code> - processa trabalhos de filas </li></ul><br><p>  Um conjunto bÃ¡sico que pode ser expandido, se necessÃ¡rio.  Agora, vamos Ã s imagens que precisamos coletar para que nosso aplicativo "decole" (seus nomes de cÃ³digo sÃ£o dados entre colchetes): </p><br><ul><li>  <code>PHP + PHP-FPM</code> ( <strong>app</strong> ) - o ambiente em que nosso cÃ³digo serÃ¡ executado.  Como as versÃµes do PHP e do FPM serÃ£o as mesmas para nÃ³s - nÃ³s as coletamos em uma imagem.  Portanto, Ã© mais fÃ¡cil gerenciar com as configuraÃ§Ãµes e a composiÃ§Ã£o dos pacotes serÃ¡ idÃªntica.  Obviamente - os processos de aplicaÃ§Ã£o e FPM serÃ£o executados em diferentes contÃªineres </li><li>  <code>nginx</code> ( <strong>nginx</strong> ) - que nÃ£o se incomodaria com a entrega de configuraÃ§Ãµes e mÃ³dulos opcionais para o <code>nginx</code> - coletaremos uma imagem separada com ele.  Por ser um serviÃ§o separado, ele possui seu prÃ³prio arquivo docker e seu contexto </li><li>  Fontes do aplicativo ( <strong>fontes</strong> ) - a fonte serÃ¡ entregue usando uma imagem separada, montando o <code>volume</code> com elas em um contÃªiner com o aplicativo.  A imagem base Ã© <code>alpine</code> ; no interior, existem apenas fontes com dependÃªncias instaladas e coletadas usando os recursos do webpack (criar artefatos) </li></ul><br><p>  Outros serviÃ§os de desenvolvimento sÃ£o lanÃ§ados em contÃªineres, retirando-os do <code>hub.docker.com</code> ;  na produÃ§Ã£o, por outro lado - eles estÃ£o sendo executados em servidores separados, agrupados em cluster.  Tudo o que resta para nÃ³s Ã© dizer ao aplicativo <em>(atravÃ©s do ambiente)</em> em quais endereÃ§os / portas e com quais detalhes Ã© necessÃ¡rio bater neles.  Ainda mais legal Ã© usar a descoberta de serviÃ§os para esse fim, mas nÃ£o nesse momento. </p><br><p>  Tendo decidido a parte teÃ³rica, proponho passar para a prÃ³xima parte. </p><br><h2 id="chast-prakticheskaya">  A parte prÃ¡tica </h2><br><p>  Sugiro organizar arquivos no repositÃ³rio da seguinte maneira: </p><br><pre> <code class="hljs css">. â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">docker</span></span> #    <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>   â”‚  â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">app</span></span> â”‚  â”‚  â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">Dockerfile</span></span> â”‚  â”‚  â””â”€â”€ ... â”‚  â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">nginx</span></span> â”‚  â”‚  â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">Dockerfile</span></span> â”‚  â”‚  â””â”€â”€ ... â”‚  â””â”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">sources</span></span> â”‚    â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">Dockerfile</span></span> â”‚    â””â”€â”€ ... â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">src</span></span> #   â”‚ â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">app</span></span> â”‚ â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">bootstrap</span></span> â”‚ â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">config</span></span> â”‚ â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">artisan</span></span> â”‚ â””â”€â”€ ... â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">docker-compose</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yml</span></span> # <span class="hljs-selector-tag"><span class="hljs-selector-tag">Compose-</span></span>    â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">Makefile</span></span> â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">CHANGELOG</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.md</span></span> â””â”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">README</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.md</span></span></code> </pre> <br><blockquote>  VocÃª pode se familiarizar com a estrutura e os arquivos clicando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">neste link</a> . </blockquote><p>  Para criar um serviÃ§o, vocÃª pode usar o comando: </p><br><pre> <code class="bash hljs">$ docker build \ --tag %local_image_name% \ -f ./docker/%service_directory%/Dockerfile ./docker/%service_directory%</code> </pre> <br><p>  A Ãºnica diferenÃ§a serÃ¡ a montagem da imagem com as fontes - para isso, o contexto da montagem (argumento extremo) <code>./src</code> ser definido como <code>./src</code> . </p><br><p>  As regras para nomear imagens no registro local recomendam o uso das que o <code>docker-compose</code> usa por padrÃ£o, a saber: <code>%root_directory_name%_%service_name%</code> .  Se o diretÃ³rio do projeto for chamado <code>my-awesome-project</code> e o serviÃ§o for chamado <code>redis</code> , o nome da imagem (local) serÃ¡ melhor para escolher <code>my-awesome-project_redis</code> respectivamente. </p><br><blockquote>  Para acelerar o processo de construÃ§Ã£o, vocÃª pode dizer ao docker para usar o cache da imagem montada anteriormente e, para isso, a <code>--cache-from %full_registry_name%</code> inicializaÃ§Ã£o <code>--cache-from %full_registry_name%</code> .  Portanto, o daemon do docker procurarÃ¡ antes de iniciar uma instruÃ§Ã£o especÃ­fica no Dockerfile - ele mudou?  E se nÃ£o (o hash converge) - ele pularÃ¡ a instruÃ§Ã£o, usando a camada jÃ¡ preparada da imagem, que serÃ¡ solicitada como cache.  Como isso nÃ£o Ã© ruim, ele reconstruirÃ¡ o processo, especialmente se nada mudou :) <br><br>  Preste atenÃ§Ã£o aos scripts <code>ENTRYPOINT</code> para iniciar contÃªineres de aplicativos. </blockquote><p>  A imagem do ambiente para iniciar o aplicativo (aplicativo) foi coletada levando em consideraÃ§Ã£o o fato de que ele funcionarÃ¡ nÃ£o apenas na produÃ§Ã£o, mas tambÃ©m localmente, os desenvolvedores precisam interagir efetivamente com ele.  A instalaÃ§Ã£o e remoÃ§Ã£o de dependÃªncias do <code>composer</code> , execuÃ§Ã£o de testes de <code>unit</code> , registros de <code>tail</code> e uso de aliases familiares ( <code>php /app/artisan</code> â†’ <code>art</code> , <code>composer</code> â†’ <code>c</code> ) nÃ£o devem causar nenhum desconforto.  AlÃ©m disso - tambÃ©m serÃ¡ usado para executar testes de <code>unit</code> e analisadores de cÃ³digo estÃ¡tico ( <code>phpstan</code> no nosso caso) no CI.  Ã‰ por isso que o Dockerfile, por exemplo, contÃ©m a <code>xdebug</code> instalaÃ§Ã£o do <code>xdebug</code> , mas o prÃ³prio mÃ³dulo nÃ£o estÃ¡ ativado (ele Ã© ativado apenas usando o CI). </p><br><blockquote>  TambÃ©m para o <code>composer</code> o pacote <code>hirak/prestissimo</code> Ã© <code>hirak/prestissimo</code> , o que aumenta muito a instalaÃ§Ã£o de todas as dependÃªncias. </blockquote><p>  Na produÃ§Ã£o, montamos o conteÃºdo do diretÃ³rio <code>/src</code> partir da imagem com as fontes (fontes) dentro dele no diretÃ³rio <code>/app</code> .  Para desenvolvimento, â€œrolamosâ€ o diretÃ³rio local com fontes de aplicativo ( <code>-v "$(pwd)/src:/app:rw"</code> ). </p><br><p>  E aqui estÃ¡ uma complexidade - esses sÃ£o os <strong>direitos de acesso aos arquivos</strong> criados a partir do contÃªiner.  O fato Ã© que, por padrÃ£o, os processos em execuÃ§Ã£o no contÃªiner iniciam a partir da raiz ( <code>root:root</code> ), os arquivos criados por esses processos (cache, logs, sessÃµes etc.) - tambÃ©m e, como resultado - vocÃª nÃ£o possui nada "localmente" com eles vocÃª pode fazer isso sem executar o <code>sudo chown -R $(id -u):$(id -g) /path/to/sources</code> . </p><br><p>  Como uma soluÃ§Ã£o, use <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fixuid</a> , mas essa soluÃ§Ã£o Ã© direta.  Pareceu-me a melhor maneira de <code>USER_ID</code> local e seu <code>GROUP_ID</code> dentro do contÃªiner e <a href="">iniciar processos com esses valores</a> .  Por padrÃ£o, a substituiÃ§Ã£o dos valores <code>1000:1000</code> (os valores padrÃ£o do primeiro usuÃ¡rio local) eliminou a chamada <code>$(id -u):$(id -g)</code> e, se necessÃ¡rio, vocÃª sempre pode substituÃ­-los ( <code>$ USER_ID=666 docker-compose up -d</code> ) ou coloque o arquivo de composiÃ§Ã£o de encaixe no arquivo <code>.env</code> . </p><br><p>  AlÃ©m disso, quando o <code>php-fpm</code> iniciado localmente <code>php-fpm</code> nÃ£o se esqueÃ§a de desativar o <code>opcache</code> - caso contrÃ¡rio, haverÃ¡ muito "sim, que diabos!"  vocÃª serÃ¡ fornecido. </p><br><p>  Para uma conexÃ£o "direta" com o redis e o postgres, joguei portas adicionais "fora" ( <code>15432</code> e <code>15432</code> respectivamente), para que nÃ£o haja problemas em "conectar e ver o que e como realmente Ã©" em princÃ­pio. </p><br><p>  Eu mantenho o contÃªiner com o <code>app</code> codinome em execuÃ§Ã£o ( <code>--command keep-alive.sh</code> ) com a finalidade de acesso conveniente ao aplicativo. </p><br><p>  Aqui estÃ£o alguns exemplos de soluÃ§Ã£o de problemas diÃ¡rios com o <code>docker-compose</code> : </p><br><table><thead><tr><th>  OperaÃ§Ã£o </th><th>  Comando em execuÃ§Ã£o </th></tr></thead><tbody><tr><td>  Instale o pacote do <code>composer</code> </td><td> <code>$ docker-compose exec app composer require package/name</code> </td> </tr><tr><td>  Executando phpunit </td><td> <code>$ docker-compose exec app php ./vendor/bin/phpunit --no-coverage</code> </td> </tr><tr><td>  Instale todas as dependÃªncias do nÃ³ </td><td> <code>$ docker-compose run --rm node npm install</code> </td> </tr><tr><td>  Instalar pacote de nÃ³s </td><td> <code>$ docker-compose run --rm node npm i package_name</code> </td> </tr><tr><td>  Iniciando uma reconstruÃ§Ã£o ao vivo de ativos </td><td> <code>$ docker-compose run --rm node npm run watch</code> </td> </tr></tbody></table><br><p>  VocÃª pode encontrar todos os detalhes de inicializaÃ§Ã£o no <strong><a href="">arquivo docker-compose.yml</a></strong> . </p><br><h4 id="coy-make-zhiv"><del>  Choi </del>  <code>make</code> vivo! </h4><br><p>  Digitar os mesmos comandos todas as vezes se torna entediante apÃ³s a segunda vez, e como os programadores sÃ£o criaturas preguiÃ§osas por natureza, vamos entrar em sua "automaÃ§Ã£o".  Manter um conjunto de scripts <code>sh</code> Ã© uma opÃ§Ã£o, mas nÃ£o tÃ£o atraente quanto um Ãºnico <code>Makefile</code> , especialmente porque sua aplicabilidade no desenvolvimento moderno Ã© muito subestimada. </p><br><blockquote>  O manual completo em russo pode ser encontrado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">neste link</a> . </blockquote><p>  Vamos ver como a <code>make</code> run fica na raiz do repositÃ³rio: </p><br><pre> <code class="bash hljs">[user@host ~/projects/app] $ make <span class="hljs-built_in"><span class="hljs-built_in">help</span></span> Show this <span class="hljs-built_in"><span class="hljs-built_in">help</span></span> app-pull Application - pull latest Docker image (from remote registry) app Application - build Docker image locally app-push Application - tag and push Docker image into remote registry sources-pull Sources - pull latest Docker image (from remote registry) sources Sources - build Docker image locally sources-push Sources - tag and push Docker image into remote registry nginx-pull Nginx - pull latest Docker image (from remote registry) nginx Nginx - build Docker image locally nginx-push Nginx - tag and push Docker image into remote registry pull Pull all Docker images (from remote registry) build Build all Docker images push Tag and push all Docker images into remote registry login Log <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> to a remote Docker registry clean Remove images from <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> registry --------------- --------------- up Start all containers (<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> background) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> development down Stop all started <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> development containers restart Restart all started <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> development containers shell Start shell into application container install Install application dependencies into application container watch Start watching assets <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> changes (node) init Make full application initialization (install, seed, build assets) <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> Execute application tests Allowed <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> overriding next properties: PULL_TAG - Tag <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> pulling images before building own (<span class="hljs-string"><span class="hljs-string">'latest'</span></span> by default) PUBLISH_TAGS - Tags list <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> building and pushing into remote registry (delimiter - single space, <span class="hljs-string"><span class="hljs-string">'latest'</span></span> by default) Usage example: make PULL_TAG=<span class="hljs-string"><span class="hljs-string">'v1.2.3'</span></span> PUBLISH_TAGS=<span class="hljs-string"><span class="hljs-string">'latest v1.2.3 test-tag'</span></span> app-push</code> </pre> <br><p>  Ele Ã© muito bom em objetivos viciantes.  Por exemplo, para iniciar o <code>watch</code> ( <code>docker-compose run --rm node npm run watch</code> ), vocÃª precisa que o aplicativo seja "aumentado" - vocÃª sÃ³ precisa especificar o destino <code>docker-compose run --rm node npm run watch</code> como dependente - e nÃ£o precisa se preocupar em esquecer de fazer isso antes de chamar o <code>watch</code> - <code>make</code> si mesmo farÃ¡ tudo por vocÃª.  O mesmo se aplica Ã  execuÃ§Ã£o de testes e analisadores estÃ¡ticos, por exemplo, antes de realizar alteraÃ§Ãµes - <code>make test</code> um <code>make test</code> e toda a mÃ¡gica acontecerÃ¡ com vocÃª! </p><br><p>  Escusado serÃ¡ dizer que vocÃª nÃ£o precisa se preocupar em montar imagens, fazer download delas, especificar <code>--cache-from</code> e quase tudo? </p><br><p>  VocÃª pode ver o conteÃºdo do <code>Makefile</code> <strong><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">neste link</a></strong> . </p><br><h2 id="chast-avtomaticheskaya">  PeÃ§a de automÃ³vel </h2><br><p>  Vamos para a parte final deste artigo - essa Ã© a automaÃ§Ã£o do processo de atualizaÃ§Ã£o de imagens no Docker Registry.  Embora no meu exemplo o GitLab CI seja usado - para transferir a idÃ©ia para outro serviÃ§o de integraÃ§Ã£o, acho que serÃ¡ bem possÃ­vel. </p><br><p>  Primeiro, determinaremos o nome das tags de imagem usadas: </p><br><table><thead><tr><th>  Nome da tag </th><th>  Destino </th></tr></thead><tbody><tr><td> <code>latest</code> </td> <td>  Imagens coletadas do ramo <code>master</code> . <br>  O estado do cÃ³digo Ã© o mais recente, mas ainda nÃ£o estÃ¡ pronto para entrar no lanÃ§amento </td></tr><tr><td> <code>some-branch-name</code> </td> <td>  Imagens coletadas no brunch <code>some-branch-name</code> . <br>  Assim, podemos "implantar" as alteraÃ§Ãµes em qualquer ambiente que foram implementadas somente dentro da estrutura de um brunch especÃ­fico, mesmo antes de mesclÃ¡-las com o <code>master</code> -light - basta "esticar" as imagens com essa tag. <br>  E - sim, as alteraÃ§Ãµes podem estar relacionadas ao cÃ³digo e Ã s imagens de todos os serviÃ§os em geral! </td></tr><tr><td> <code>vX.XX</code> </td> <td>  Na verdade, o lanÃ§amento do aplicativo (use para implantar uma versÃ£o especÃ­fica) </td></tr><tr><td> <code>stable</code> </td> <td>  Alias, para a tag com a versÃ£o mais recente (use para implantar a versÃ£o estÃ¡vel mais recente) </td></tr></tbody></table><br><p>  O lanÃ§amento ocorre publicando uma tag no <code>vX.XX</code> formato <code>vX.XX</code> </p><br><p>  Para acelerar a construÃ§Ã£o, o cache dos diretÃ³rios <code>./src/vendor</code> e <code>./src/node_modules</code> + <code>--cache-from</code> para <code>docker build</code> e consiste nos seguintes estÃ¡gios: </p><br><table><thead><tr><th>  Nome do estÃ¡gio </th><th>  Destino </th></tr></thead><tbody><tr><td> <code>prepare</code> </td> <td>  A fase preparatÃ³ria - a montagem de imagens de todos os serviÃ§os, <strong>exceto a</strong> imagem com a fonte </td></tr><tr><td> <code>test</code> </td> <td>  Testando o aplicativo (executando <code>phpunit</code> , analisadores de cÃ³digo estÃ¡tico) usando imagens <strong>coletadas no estÃ¡gio de preparaÃ§Ã£o</strong> </td></tr><tr><td> <code>build</code> </td> <td>  Instalando todas as dependÃªncias do <code>composer</code> ( <code>--no-dev</code> ), montando <code>assets</code> <code>webpack</code> e <code>webpack</code> imagem com o cÃ³digo-fonte, <strong>incluindo artefatos recebidos</strong> ( <code>vendor/*</code> , <code>app.js</code> , <code>app.css</code> ) </td></tr></tbody></table><br><p><img src="https://habrastorage.org/getpro/habr/post_images/8c2/873/625/8c2873625893ec1a0605e24bf85ef541.png" alt="captura de tela de tubulaÃ§Ãµes"></p><br><blockquote>  A montagem no ramo <code>master</code> produzindo <code>push</code> com as tags <code>master</code> e <code>latest</code> </blockquote><p>  Em mÃ©dia, todas as etapas da montagem levam <strong>4 minutos</strong> , o que Ã© um resultado muito bom (a execuÃ§Ã£o paralela de tarefas Ã© tudo). </p><br><p>  VocÃª pode se familiarizar com o conteÃºdo da configuraÃ§Ã£o ( <strong><code>.gitlab-ci.yml</code></strong> ) do coletor <strong><a href="">neste link</a></strong> . </p><br><h2 id="vmesto-zaklyucheniya">  Em vez de uma conclusÃ£o </h2><br><p>  Como vocÃª pode ver, organizar o trabalho com um aplicativo php (usando o <code>Laravel</code> como exemplo) usando o Docker nÃ£o Ã© tÃ£o difÃ­cil.  Como teste, vocÃª pode bifurcar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">repositÃ³rio</a> e substituir todas as ocorrÃªncias de <code>tarampampam/laravel-in-docker</code> por vocÃª - tente tudo "ao vivo" por conta prÃ³pria. </p><br><p>  Para inicializaÃ§Ã£o local - execute apenas 2 comandos: </p><br><pre> <code class="bash hljs">$ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://gitlab.com/tarampampam/laravel-in-docker.git ./laravel-in-docker &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-variable"><span class="hljs-variable">$_</span></span> $ make init</code> </pre> <br><p>  Em seguida, abra <code>http://127.0.0.1:9999</code> no seu navegador favorito. </p><br><p>  <strong><em>... aproveitando a oportunidade</em></strong> </p><br><p>  <em>No momento, estou trabalhando no projeto TL "autocode" e estamos procurando talentosos desenvolvedores de php e administradores de sistema (o escritÃ³rio de desenvolvimento estÃ¡ localizado em Yekaterinburg).</em>  <em>Se vocÃª se considera o primeiro ou o segundo - escreva nossa carta de RH com o texto "Quero ser uma equipe de desenvolvimento, retome:% link_on_summary%" para o e-mail <code>hr@avtocod.ru</code> , ajudamos na realocaÃ§Ã£o.</em> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt425101/">https://habr.com/ru/post/pt425101/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt425089/index.html">TI no mundo animal: pesquisa de formigas e TCP / IP</a></li>
<li><a href="../pt425091/index.html">O que diabos estÃ¡ acontecendo com as classificaÃ§Ãµes de popularidade das linguagens de programaÃ§Ã£o?</a></li>
<li><a href="../pt425093/index.html">SoluÃ§Ãµes de IoT para serviÃ§os habitacionais e comunitÃ¡rios: o que serÃ£o os medidores inteligentes e quem deve atendÃª-los?</a></li>
<li><a href="../pt425095/index.html">SeminÃ¡rio on-line aberto "Jogo" 2048 "</a></li>
<li><a href="../pt425099/index.html">O que eu entendi e que problemas encontrei ao criar um clone do Hacker News</a></li>
<li><a href="../pt425103/index.html">Pare o Google Predators de perseguir seus filhos</a></li>
<li><a href="../pt425105/index.html">Modo de fabricaÃ§Ã£o Intel ME - uma ameaÃ§a oculta ou o que estÃ¡ por trÃ¡s da vulnerabilidade CVE-2018-4251 no MacBook</a></li>
<li><a href="../pt425107/index.html">Fintech Digest: problemas de biometria no celular, leasing de telefones Samsung, valores mobiliÃ¡rios no blockchain</a></li>
<li><a href="../pt425109/index.html">O livro â€œJava na nuvem. Bota de Primavera, Nuvem de Primavera, FundiÃ§Ã£o em Nuvem Â»</a></li>
<li><a href="../pt425111/index.html">Truques publicitÃ¡rios que podem custar dinheiro e reputaÃ§Ã£o</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>