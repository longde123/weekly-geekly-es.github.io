<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕴🏿 💜 👧🏼 قم بتكوين النسخ الاحتياطي والاسترداد الكامل والمنفصل لـ Zimbra OSE دون استخدام Zextras 🚠 👋🏼 🤳🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="1. من أين تبدأ 
 من أين يبدأ النسخ الاحتياطي؟ التخطيط. عند عمل نسخة احتياطية من أي نظام ، تحتاج إلى وضع خطة احتياطية: ما هو بالضبط ، كم مرة ، كم من ال...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>قم بتكوين النسخ الاحتياطي والاسترداد الكامل والمنفصل لـ Zimbra OSE دون استخدام Zextras</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439728/" style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/tl/fg/oj/tlfgoj8_4wwdpcdcj5n8ndx2pu0.png" alt="الصورة"><br><br><h3 style=";text-align:right;direction:rtl">  1. من أين تبدأ </h3><br>  من أين يبدأ النسخ الاحتياطي؟  التخطيط.  عند عمل نسخة احتياطية من أي نظام ، تحتاج إلى وضع خطة احتياطية: ما هو بالضبط ، كم مرة ، كم من الوقت لتخزين ، سيكون هناك مساحة حرة كافية؟  من الإجابات على هذه الأسئلة ، إجابة السؤال الرئيسي التالي - كيفية النسخ الاحتياطي؟ <br><br>  إذا كان هناك الكثير من المساحة الحرة ، يمكنك تخزين الجهاز الظاهري بأكمله.  قم بعمل نسخ احتياطية بنفس Veeam في جدول ، ولا تفكر في الصعوبات.  لكن بالنسبة لي ، إنها مضيعة ، اعتدت على فعل كل شيء بشكل موجز واقتصادي قدر الإمكان.  بالطبع ، لقد قمت بنشر Veeam ، لكنني أقوم فقط بعمل نسخ احتياطية من تلك الأنظمة التي إما أن تكون مستحيلة أو إشكالية في النشر من النسخ الاحتياطية لفترة طويلة جدًا. <br><br>  حول البرامج النصية لأدوات إدارة البيئة الافتراضية ، سأبقى صامتًا بكل معنى الكلمة. <br><br>  زيمبرا لديه أداة zmmailbox.  وبعد فحص دقيق لوظائفها ، أدركت أن ذلك سيكون أكثر من كافٍ بالنسبة لي.  يمكنه النسخ الاحتياطي واستعادة علب البريد حتى على نظام مباشر.  وأحببت القدرة على نسخ علب البريد المهمة بشكل منفصل عن النسخة الاحتياطية للنظام بأكمله.  وبالتالي ، فإن المساحة التي تشغلها النسخ الاحتياطية سوف تكون محدودة بحجم صناديق البريد المؤرشفة مضروبة في عدد أيام "عمق النسخ الاحتياطي" ، وليس من خلال حجم النظام بأكمله مضروب في نفس عدد الأيام.  بالإضافة إلى ذلك ، من الصعب للغاية استرداد من نسخة احتياطية للنظام بأكمله ، في حالة Zimbra.  من الأسهل بكثير نسخ آلة افتراضية باستخدام Veeam أو أدوات إدارة البيئة الافتراضية (Hyper-V ، ESXI ، أدخل ما تحتاجه) مباشرةً بعد إعداد النظام ، ووضعه "على الرف" بحيث يمكنك في لحظة حرجة نشر VM بدون وزن وتحميل بسرعة في ذلك نسخ احتياطية من الصناديق.  في رأيي ، هذا هو السيناريو الأقل تكلفة من جميع النواحي. <br><a name="habracut"></a><br><h3 style=";text-align:right;direction:rtl">  2. البيانات المصدر: </h3><br>  <i>خادم نظام التشغيل</i> : CentOS 7 <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">حول نظام التشغيل</b> <div class="spoiler_text" style=";text-align:right;direction:rtl">  في الواقع ، فإن الفرق بين CentOS7 وأي نظام آخر يكمن فقط في أوامر الخادم لتثبيت الحزم ، وربما موقع بعض الملفات.  يتم تنفيذ العمل بشكل أساسي باستخدام أوامر cmdlets من طراز Zimbra ، بحيث تكون فروق التكوين ضئيلة للغاية. </div></div><br>  <i>Zimbra المجال</i> : zimbramail.home.local <br>  <i>اسم المستخدم وكلمة المرور للوصول إلى المجلد المشترك</i> : ZimbraBackUp / 123123 <br>  <i>المسار إلى المجلد المشترك</i> : \\ BackUpServer1 \ ZM \ <br>  <i>مسار تحميل الكرات على مضيف Zimbra</i> : / mnt / ZM / <br><br><h3 style=";text-align:right;direction:rtl">  3. الإعداد </h3><br>  لذلك دعونا نبدأ! <br><br>  سنكتب نسخ احتياطية إلى خادم يقوم بتشغيل Windows في مجلد مشترك.  إذا كنت ترغب في ذلك ، يمكنك دمج النسخ الاحتياطية في أي مكان ، ولكن يتم إعداد كل شيء بحيث تتم كتابة معظم النسخ الاحتياطية على BackUpServer1.home.local.  بحيث: <br><br>  1) ننشئ في مجال المستخدم للوصول إلى المجلد المشترك على هذا الخادم بحيث يمكن تثبيته على خادم Zimbramail.home.local.  اسم المستخدم ZimbraBackUp ، كلمة المرور ، مشروط ، 123123. <br><br>  2) على خادم BackUpServer1 ، قم بإنشاء الدليل \ ZM \ في المستودع ومشاركته ، مع إعطاء حقوق التغيير للمستخدم ZimbraBackUp.  سيكون المسار إلى الكرة: \\ BackUpServer1 \ ZM \ <br><br>  3) قم بتركيب الكرة على خادم Zimbramail.home.local.  لكي يتم تثبيت المجلد تلقائيًا ، تحتاج إلى إصلاح ملف / etc / fstab عن طريق إضافة السطر إليه: <br><br><pre style=";text-align:right;direction:rtl"><code class="bash hljs">//BackUpServer/ZM /mnt/ZM cifs user,uid=500,rw,suid,username=ZimbraBackUp,password=123123 0 0</code> </pre> <br>  لكن عليك أولاً التحقق مما إذا كان الحامل يعمل: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ mount -t cifs //BackUpServer/ZM /mnt/ZM -o user=ZimbraBackUp,password=123123</code> </pre> <br>  غالبًا ما يظهر خطأ مثل هذا: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">mount: wrong fs <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, bad option, bad superblock on //BackUpServer1/ZM/, missing codepage or helper program, or other error (<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> several filesystems (eg nfs, cifs) you might need a /sbin/mount.&lt;<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>&gt; helper program) In some cases useful info is found <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> syslog - try dmesg | tail or so.</code> </pre> <br>  يمكنك إصلاحه عن طريق تثبيت cifs-utils: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ yum install cifs-utils</code> </pre> <br>  بعد الإعداد ، أوصي بإعادة تشغيل الخادم. <br><br>  4) إنشاء ملفات البرنامج النصي 3: FullBackUp.sh HandBackUp.sh Restore.sh <br><br>  سيتم استخدام الملف الأول لإنشاء نسخ احتياطية مجدولة تلقائيًا ، والثاني للقدرة على إجراء نسخ احتياطي لصناديق البريد الفردية ، أو ببساطة بدء "ماذا لو" يدويًا.  والنص الثالث هو استعادة واحد أو كل الصناديق في وقت واحد.  حاولت قدر الإمكان التعليق على عمل البرامج النصية وقطع الأشجار المقررة. <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">محتويات ملف FullBackUp.sh:</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #   Path="/mnt/ZM/BackUps" #    ArchPath="/mnt/ZM/Archive" #    MPath="/mnt/ZM/Mounthly" #  Zimbra ZDomain="zimbramail.home.local" #  MBoxes="/mnt/ZM/MBoxesList" #  CDate=$(date +%d-%m-%Y) #   MDay=$(date +%d) #   log="/mnt/ZM/BackUpLog.txt" echo -en "BackUp ALL MailBoxes started in $(date +%T)\n" &gt;&gt; $log #       if [ ! -d $Path ]; then #     echo "    ..." mkdir -p $Path if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "BackUp dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "BackUp dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else echo "    ,      ..." fi #       if [ ! -d $Path/$CDate ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo #        echo "       ..." mkdir -p $Path/$CDate if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "BackUp CDate dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "BackUp CDate dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo "    ,     ..." fi #     /opt/zimbra/bin/zmprov -l gaa $ZDomain &gt; $MBoxes #    if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Boxes list created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box list is NOT created! in $(date +%T)\n" &gt;&gt; $log exit fi #       for MailBox in $( cat $MBoxes); do echo "    $MailBox..." /opt/zimbra/bin/zmmailbox -z -m $MailBox getRestUrl "//?fmt=tgz" &gt; $Path/$CDate/$MailBox if [ $? -eq 0 ]; then #        echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Box $MailBox BackUp created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box $MailBox BackUp is NOT created! in $(date +%T)\n" &gt;&gt; $log fi done #     echo "    ..." echo -n &gt; $MBoxes if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "File $MBoxes clear\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "File $MBoxes can NOT be cleared\n" &gt;&gt; $log fi #      #      if [ ! -d $ArchPath ]; then #    echo "   ..." mkdir -p $ArchPath if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else echo "   , ..." fi tar -czf $ArchPath/$CDate.tar $Path/$CDate if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive created in $(date +%T)\n" &gt;&gt; $log #         if [ "$MDay" = 1 ]; then #      if [ ! -d $MPath ]; then #     echo "    ..." mkdir -p $MPath if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Long saving dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Long saving dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else #  echo "    ,     ..." fi cp $ArchPath/$CDate.tgz $MPath/$CDate if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive is copied in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive is NOT copied in $(date +%T)\n" &gt;&gt; $log fi echo "    ( 1 )..." # ,   ,   find $Path -atime +7 | xargs rm -d if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Old BackUps files was deleted\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Old BackUps files is NOT deleted in $(date +%T)\n" &gt;&gt; $log fi #    ( 2 ) echo "     ( 2 )..." find $ArchPath -atime +61 | xargs rm -f if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Old BackUps archives was deleted\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Old BackUps archives is NOT deleted in $(date +%T)\n" &gt;&gt; $log fi fi else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive is NOT created in $(date +%T)\n" &gt;&gt; $log fi echo "BackUp job finished in $(date +%T)" #  -     echo -en "BackUp job finished in $(date +%T) $(date +%T)\n" &gt;&gt; $log echo -en "_____________________________________________\n" &gt;&gt; $log</span></span></code> </pre> </div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">محتوى ملف HandBackUp.sh:</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #   Path="/mnt/ZM/BackUps" #    ArchPath="/mnt/ZM/Archive" #  Zimbra ZDomain="zimbramail.home.local" #  MBoxes="/mnt/ZM/MBoxesList" #  CDate=$(date +%d-%m-%Y) #   log="/mnt/ZM/BackUpLog.txt" read -p "    (  ),  ALL      : " A if [[ "$A" = "ALL" || "$A" = "all" ]]; then echo -en "BackUp started in $(date +%T)\n" &gt;&gt; $log #     echo "    ..." /opt/zimbra/bin/zmprov -l gaa $ZDomain &gt; $MBoxes if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Boxes list created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box list is NOT created! in $(date +%T)\n" &gt;&gt; $log exit fi if ! [ -d $Path/$Date ]; then #    mkdir -p $Path/$CDate/ echo -en "BackUp directory created in $(date +%T)\n" &gt;&gt; $log fi #       echo "      " for MailBox in $( cat $MBoxes); do echo "    $MailBox..." /opt/zimbra/bin/zmmailbox -z -m $MailBox getRestUrl "//?fmt=tgz" &gt; $Path/$CDate/$MailBox if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Box $MailBox BackUp created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box $MailBox BackUp is NOT created! in $(date +%T)\n" &gt;&gt; $log fi done else MailBox="$A@$ZDomain" #    echo "   ..." Result=$(/opt/zimbra/bin/zmprov getMailboxInfo $MailBox) if [ $? -eq 0 ]; then #   echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo "  $MailBox ,  ..." echo -en "Required Mail Box $MailBox exist $(date +%T)\n" &gt;&gt; $log #      if ! [ -d $Path/$Date ]; then #    mkdir -p $Path/$CDate/ echo -en "BackUp directory created in $(date +%T)\n" &gt;&gt; $log fi #    $MailBox /opt/zimbra/bin/zmmailbox -z -m $MailBox getRestUrl "//?fmt=tgz" &gt; $Path/$CDate/$MailBox if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Box $MailBox BackUp created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box $MailBox BackUp is NOT created! in $(date +%T)\n" &gt;&gt; $log fi else #    -  echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo "  $MailBox  .   " echo -en "Required Mail Box $MailBox is not exist\n" &gt;&gt; $log exit fi fi read -p "      $MailBox? [N]: " F if [[ "$F" = "Y" || "$F" = "y" ]]; then #      if [ ! -d $ArchPath ]; then #     echo "   ..." mkdir -p $ArchPath if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else echo "   , ..." fi #    echo "  ..." if [[ "$A" = "ALL" || "$A" = "all" ]]; then tar -czf $ArchPath/$CDate.tar $Path/$CDate if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive is NOT created in $(date +%T)\n" &gt;&gt; $log fi else tar -czf $ArchPath/$MailBox.tar $Path/$CDate/$MailBox if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive is NOT created in $(date +%T)\n" &gt;&gt; $log fi fi else echo "   " echo -en "User decline archive creating\n" &gt;&gt; $log fi #     echo "    ..." echo -n &gt; $MBoxes if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo fi echo "BackUp job finished in $(date +%T) $(date +%T)" #  -     echo -en "BackUp job finished in $(date +%T) $(date +%T)\n" &gt;&gt; $log echo -en "_____________________________________________\n" &gt;&gt; $log</span></span></code> </pre></div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">محتويات ملف Restore.sh:</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #   Path="/mnt/ZM/BackUps" #  Zimbra ZDomain="zimbramail.home.local" #  MBoxes="/mnt/ZM/MBoxesList" #   log="/mnt/ZM/RestoreLog.txt" read -p "  ,      02-09-2001: " Date if ! [ -d $Path/$Date ]; then echo "     ." echo -en "No BackUp file at $Date $(date +%T)\n" &gt; $log exit fi read -p "    (  ),  ALL        : " A if [[ "$A" = "ALL" || "$A" = "all" ]]; then echo -en "Restore started in $(date +%T)\n" &gt;&gt; $log #     ls "$Path/$Date" &gt; $MBoxes for MailBox in $( cat $MBoxes); do #   echo "   $MailBox" Result=$(/opt/zimbra/bin/zmprov getMailboxInfo $MailBox) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [OK]" echo echo -en "Start restore job for $MailBox $(date +%T)\n" &gt;&gt; $log echo " $MailBox . ..." else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Mail Box $MailBox does not exist, creating Mail Box $MailBox $(date +%T)\n" &gt;&gt; $log echo " $MailBox  .   $MailBox..." #   Result=$(/opt/zimbra/bin/zmprov ca $MailBox 12345678 displayName "$MailBox") if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [OK]" echo echo -en "Mail Box $MailBox is created, starting restore $(date +%T)\n" &gt;&gt; $log echo " $MailBox  . ..." else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Can NOT create Mail Box $MailBox ! $(date +%T)\n" &gt;&gt; $log echo " $MailBox   ." fi fi #  Result=$(/opt/zimbra/bin/zmmailbox -z -m $MailBox postRestURL "//?fmt=tgz&amp;resolve=replace" $Path/$Date/$MailBox) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en " $MailBox   $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en " $MailBox  ! $(date +%T)\n" &gt;&gt; $log fi done else #     MailBox="$A@$ZDomain" if [ -a $Path/$Date/$MailBox ]; then #   echo "   $MailBox..." Result=$(/opt/zimbra/bin/zmprov getMailboxInfo $MailBox) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [OK]" echo echo -en "Start restore job for $MailBox $(date +%T)\n" &gt;&gt; $log echo " $MailBox . ..." else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Mail Box $MailBox does not exist $(date +%T)\n" &gt;&gt; $log echo " $MailBox  ." read -p "            ? [N]: " B if [[ "$B" = "Y" || "$B" = "y" ]]; then echo "   $MailBox..." Result=$(/opt/zimbra/bin/zmprov ca $MailBox 12345678 displayName "$MailBox") #   if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [OK]" echo echo -en "Mail Box $MailBox is created, starting restore $(date +%T)\n" &gt;&gt; $log echo " $MailBox  . ..." else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Can NOT create Mail Box $MailBox ! $(date +%T)\n" &gt;&gt; $log echo " $MailBox   .   ..." exit fi else #   ,  .  echo "   .   " exit fi fi #  Result=$(/opt/zimbra/bin/zmmailbox -z -m $MailBox postRestURL "//?fmt=tgz&amp;resolve=replace" $Path/$Date/$MailBox) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en " $MailBox   $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en " $MailBox  ! $(date +%T)\n" &gt;&gt; $log fi else #     echo "    .   " echo -en "Required BackUp file is not exist\n" &gt;&gt; $log exit fi fi #     echo "    ..." echo -n &gt; $MBoxes if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo fi echo "BackUp job finished in $(date +%T) $(date +%T)" #  -     echo -en "Restore job complete in $(date +%T)\n" &gt;&gt; $log echo -en "____________________________________\n" &gt;&gt; $log</span></span></code> </pre></div></div><br>  هناك دقة واحدة.  إذا قمت بإنشاء وتحرير ملفات البرامج النصية للباش تحت ويندوز ، فعندما تحاول تشغيل البرنامج النصي ، سيظهر خطأ: <b>/ bin / sh ^ M: مترجم سيئ: لا يوجد ملف أو دليل</b> ، وهو ما يضيفه المحررين الذين يعملون تحت ويندوز إلى نهاية السطر هي حرف الإرجاع "CR \ LF" ، الذي لا يعرضه المحررون على نظام Linux.  لكن هذا الرمز موجود ولم يختف.  للتخلص من الخطأ وإزالة الأحرف الزائدة ، نقوم بما يلي: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ cat your-script.sh | tr -d <span class="hljs-string"><span class="hljs-string">'\r'</span></span> &gt; corrected-your-script.sh</code> </pre> <br>  حسنًا ، أو يمكنك استخدام الأداة المساعدة dos2unix ، ولكن لا تزال تحتاج إلى تثبيتها: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ yum install dos2unix $ dos2unix your-script.sh</code> </pre> <br>  5) نجعل البرامج النصية قابلة للتنفيذ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ chmod 0740 /opt/zimbra/BkUpRestScripts/FullBackUp.sh $ chmod 0740 /opt/zimbra/BkUpRestScripts/HandBackUp.sh $ chmod 0740 /opt/zimbra/BkUpRestScripts/Restore.sh</code> </pre> <br>  6) أوصي بأن تقوم بتشغيل البرامج النصية بيديك ومعرفة ما إذا كانت تعمل وكيف تعمل. <br><br>  7) إنشاء مهمة في كرون للنسخ الاحتياطي اليومي لصناديق البريد: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">10 0 * * * root /opt/zimbra/ BkUpRestScripts/FullBackUp.sh</code> </pre> <br>  8) استمتع <br><br><h3 style=";text-align:right;direction:rtl">  4. البرمجة النصية </h3><br>  في حالة التعليقات في البرامج النصية نفسها لم يساعد. <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">1) البرنامج النصي FullBaclUp.sh:</b> <div class="spoiler_text" style=";text-align:right;direction:rtl">  في البداية ، يتم تحديد المتغيرات ، أي واحد مسؤول عن ماذا - يتم التعليق على كل شيء. <br><br>  التالي هو التحقق من عدم وجود دليل للنسخ الاحتياطي ؛ إذا كان غير موجود ، يتم إنشاؤه.  يتم الاستنتاج لملف السجل وللشاشة (في حالة البدء بالأيدي) حول نجاح أو فشل إنشاء دليل. <br><br>  تحقق من وجود كتالوج مفقود مع تاريخ اليوم.  إذا لم يكن هناك ، يتم إنشاؤه ، كما يتم إنشاء الإخراج إلى الشاشة وسجل نتيجة إنشاء الدليل. <br><br>  الكتابة إلى ملف جميع علب بريد Zimbra الموجودة.  هناك حاجة للحجز التسلسلي لكل مربع.  يعرض نتيجة الأمر. <br><br>  إنشاء نسخة احتياطية لكل صندوق بريد من القائمة المستلمة.  مع إخراج التنفيذ إلى الشاشة وإلى ملف السجل. <br><br>  مسح ملف مع قائمة المربعات.  نظرًا لأن جميع البرامج النصية الثلاثة تعمل مع هذا الملف ، فمن المستحسن تنظيفه بعد كل عملية تشغيل حتى لا تكون هناك مفاجآت.  يمكنك تنظيفه قبل بدء البرنامج النصي ، لكن من المألوف بالنسبة لي ألا أقوم بتخزين البيانات غير الضرورية بعد الانتهاء من العمل ، لكن القيام بنفس الشيء قبل وبعد عمل البرنامج النصي هو درجة خفيفة من الفصام. <br><br>  التالي هو كتلة لإنشاء أرشيف مضغوط. <br><br>  التحقق من عدم وجود دليل تخزين الأرشيف ، وإنشائه في غيابه ، وعرض نتيجة الإنشاء على الشاشة والسجل <br><br>  الأرشفة <br><br>  تحقق "ليس اليوم الأول اليوم؟"  أفضل تخزين النسخ الاحتياطية لليوم الأول من كل الأشهر لفترة طويلة ، وهذا يكفي بالنسبة لي للعمل.  يمكن تخزينه لعدة أسابيع ، لكن غالبًا ما يكون ذلك ضروريًا.  ولكن يتم تعيين شرط تخزين النسخ الاحتياطية لكامل فترة تشغيل خادم البريد في الأعلى ، لذلك يكون هناك دائمًا هناك.  إذا كان الرقم هو الأول ، فسيتم نسخ الأرشيف الناتج إلى دليل منفصل "Mounthly".  ولنسخه هناك ، تحتاج إلى التحقق مما إذا كان هناك مثل هذا الدليل ، وإذا لم يكن الأمر كذلك ، قم بإنشائه ، والذي يجب إبلاغه إلى الشاشة وملف السجل. <br><br>  بعد ذلك ، يتم تنظيف وحدة التخزين - يتم حذف جميع النسخ الاحتياطية التي مضى عليها أكثر من أسبوعين ، وكذلك المحفوظات التي يزيد عمرها عن 61 يومًا.  يتم عرض نتيجة الحذف على الشاشة وفي ملف السجل. <br><br>  بعد ذلك يكتب البرنامج النصي وقت الانتهاء إلى ملف السجل وعلى الشاشة ، وينهي عمله. </div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">2) البرنامج النصي HandBackUp.sh:</b> <div class="spoiler_text" style=";text-align:right;direction:rtl">  في البداية ، يتم تعريف المتغيرات أيضًا ، وعلقت أيضًا على سبب الحاجة إليها. <br><br>  بعد ذلك ، تتم مطالبة المستخدم بإدخال اسم صندوق البريد الذي يجب نسخه احتياطيًا ، دون تحديد مجال Zimbra.  (مكتوب في الدعوة للدخول) ، أو حدد نسخة احتياطية لجميع صناديق البريد عن طريق كتابة الكل أو الكل. <br><br>  إذا اخترت نسخًا احتياطيًا لجميع صناديق البريد ، فإن البرنامج النصي يعمل تقريبًا كما هو الحال مع أول واحد مدرج أعلاه ، إلا أنه بعد إنشاء نسخ احتياطية لكل صندوق بريد ، سوف يطلب ذلك - هل أحتاج إلى أرشفتها؟ <br><br>  إذا تم كتابة صندوق بريد محدد ، فسيتم التحقق من وجوده في Zimbra.  في حالة وجود مربع بالاسم المحدد ، تبدأ عملية النسخ الاحتياطي لهذا المربع ، مع عرض المعلومات المقابلة على الشاشة وفي ملف السجل.  إذا كان المربع المحدد غير موجود ، فسيتم إعلام المستخدم بهذا ، وسوف يكمل البرنامج النصي عمله. <br><br>  بعد اكتمال النسخ الاحتياطي للمربع ، ستتم مطالبتك بأرشفة النسخة.  إذا وافق المستخدم - هناك فحص لعدم وجود دليل لتخزين الأرشيف ومزيد من أسفل القائمة ، كما هو الحال في البرنامج النصي الأول. <br><br>  بعد اكتمال الأرشفة ، يتم مسح الملف مع قائمة صناديق البريد.  فقط في القضية. <br><br>  في النهاية ، يتم عرض معلومات حول وقت إكمال البرنامج النصي على الشاشة وفي ملف السجل. </div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">3) استعادة البرنامج النصي:</b> <div class="spoiler_text" style=";text-align:right;direction:rtl">  كما في الملفات السابقة ، أولاً - تعريف المتغيرات مع التعليقات. <br><br>  تتم مطالبة المستخدم بتحديد تاريخ النسخ الاحتياطي المطلوب استعادته.  إذا لم يكن التاريخ المحدد في النسخ الاحتياطية ، فسيتم إنهاء البرنامج النصي عن طريق الإبلاغ عن هذا. <br><br>  في حالة وجود نسخ احتياطية للتاريخ المحدد - اطلب من المستخدم إدخال اسم المربع الذي يجب استعادته.  لاستعادة جميع المربعات تحتاج إلى كتابة الكل أو الكل. <br><br>  في حالة تحديد الخيار ALL ، يقوم البرنامج النصي بإنشاء قائمة بالملفات الموجودة في مجلد النسخة الاحتياطية في الملف ، ويبلغ عن نتيجة الإنشاء. <br><br>  التالي هو الاسترداد خطوة بخطوة لكل مربع.  أولاً ، تحقق من وجود مربع في النظام ، إن لم يكن ، يتم إنشاؤه ، ثم استعادته.  يتم عرض المعلومات حول كل عملية في ملف السجل وعلى الشاشة. <br><br>  إذا تم تحديد مربع معين ، فسيكون متشابهًا تقريبًا.  تحقق من وجود ملف بالاسم المطلوب.  الإخراج إلى الشاشة وملف سجل النتيجة. <br><br>  التحقق من وجود مربع في النظام.  الإخراج إلى الشاشة وملف سجل النتيجة. <br>  دعوة للمستخدم للموافقة على إنشاء الصندوق في حالة عدم وجود مثل هذا في النظام.  الإخراج إلى الشاشة وملف سجل النتيجة. <br><br>  إنشاء مربع إذا وافق.  الإخراج إلى الشاشة وملف سجل النتيجة. <br>  صندوق البريد الانتعاش.  الإخراج إلى الشاشة وملف سجل النتيجة. <br><br>  مسح ملف مع قائمة صناديق الاسترداد. <br><br>  في النهاية ، يتم عرض معلومات حول وقت إكمال البرنامج النصي على الشاشة وفي ملف السجل. </div></div><br><h3 style=";text-align:right;direction:rtl">  5. فيما يتعلق الانتعاش </h3><br>  إذا قمت بتعديل هذه البرامج النصية قليلاً ، فهي مناسبة تمامًا لنقل البريد من خادم إلى خادم ، وذلك ببساطة عن طريق إنشاء صناديق بريد تحتوي على جميع المحتويات في مكان جديد.  يمكنك أيضًا استعادة النظام من نقطة الصفر ، عندما يكون من السهل إعادة رفع خادم Zimbra بدلاً من محاولة إعادة تنشيط الخادم القديم لسبب ما.  كما هو موضح أعلاه ، يمكنك حفظ صورة الجهاز الظاهري المكوّن عن طريق توسيعه إذا لزم الأمر ، وملؤه بكافة البيانات.  نفس الخوارزمية للانتقال من خادم Zimbra إلى آخر.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> وليس هناك حاجة إلى المرافق المدفوعة مثل Zextras. </font></font><br><br><h3 style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 6. الخاتمة </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">بشكل عام ، لا يوجد شيء معقد في النصوص التي كتبت. </font><font style="vertical-align: inherit;">نعم ، هناك الكثير من الشروط فيها ، لأنني حاولت التنبؤ بأكبر عدد ممكن من المشاكل والأخطاء في عملهم ، لكنني حاولت أيضًا التعليق على النص بأكبر قدر ممكن. </font><font style="vertical-align: inherit;">على الأرجح ، من خارج الصندوق ، لن يعملوا مع الجميع. </font><font style="vertical-align: inherit;">ربما لا يمتلك شخص ما طريقة النسخ الاحتياطي هذه على الإطلاق. </font><font style="vertical-align: inherit;">ولكني آمل أن يجد الكثيرون ذلك مفيدًا.</font></font><br><br><h3 style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 7. ملاحظة: </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">هذا هو المقال الثاني في سلسلة "كيف نفذت زيمبرا". </font><font style="vertical-align: inherit;">الأول يدور حول التطبيق وترخيص LDAP وإنشاء صناديق البريد تلقائيًا لمستخدمي م ، </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">هنا</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">المقالة الثالثة حول الإنشاء التلقائي وتحديث قوائم المراسلات القائمة على الإعلانات في نظام التشغيل Zimbra OSE </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">موجودة هنا</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">وأريد أيضًا أن أشير إلى أن هذه هي تجربتي الأولى في البرمجة النصية على bash ، ولهذا السبب ، تبين أن النصوص البرمجية ضخمة جدًا و "ذكية جدًا" ، كما يقولون.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar439728/">https://habr.com/ru/post/ar439728/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar439718/index.html">تطوير التطبيقات على Elixir / Phoenix مع Docker</a></li>
<li><a href="../ar439720/index.html">مقدمة في البرمجة: مطلق النار ثلاثي الأبعاد البسيط من الألف إلى الياء خلال عطلة نهاية الأسبوع ، الجزء 2</a></li>
<li><a href="../ar439722/index.html">آثار مرشحات SVG. الجزء 2. الخطوط العريضة النص مع feMorphology</a></li>
<li><a href="../ar439724/index.html">نظرة عامة على حلول AI و ML في 2018 والتوقعات لعام 2019: الجزء 2 - الأدوات والمكتبات ، AutoML ، RL ، الأخلاقيات في AI</a></li>
<li><a href="../ar439726/index.html">قفل في: صحيح أم خيال؟</a></li>
<li><a href="../ar439730/index.html">تنظيم المخفض من خلال فئة قياسية</a></li>
<li><a href="../ar439732/index.html">Lazarus - الرسوم المتحركة البسيطة باستخدام مكون TImageFragment</a></li>
<li><a href="../ar439734/index.html">نشر Kubernetes على سطح المكتب في دقائق مع MicroK8s</a></li>
<li><a href="../ar439736/index.html">اتصال VPN IPSec بين MikroTik و Kerio Control</a></li>
<li><a href="../ar439738/index.html">بحثا عن زر "افعل جيدا". ZYXEL في شبكة الشركات الصغيرة والمتوسطة</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>