<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ñ™Ô∏è üç≠ üèÇüèæ Arduino Mega Server et horloge en temps r√©el üï∫üèª ü•¢ üéë</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cet article, vous apprendrez comment fonctionne Arduino Mega Server au fil du temps et comment cr√©er des projets sur Arduino qui sont li√©s en tem...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Arduino Mega Server et horloge en temps r√©el</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/385349/"><img src="https://habrastorage.org/files/ce4/e16/81f/ce4e1681f98841af80ec3eeef2fce455.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet article, vous apprendrez comment fonctionne Arduino Mega Server au fil du temps et comment cr√©er des projets sur Arduino qui sont li√©s en temps r√©el, qu'ils aient ou non un module RTC ¬´iron¬ª install√©. </font><font style="vertical-align: inherit;">Toutes les questions de travail en temps r√©el sur Arduino seront discut√©es en d√©tail et apr√®s avoir lu cet article, vous deviendrez un v√©ritable "horloger".</font></font><br>
<a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Essence de la question</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout projet plus ou moins s√©rieux sur Arduino devrait avoir une id√©e du temps r√©el actuel. Par exemple, les lectures des capteurs doivent √™tre limit√©es dans le temps (sinon il serait impossible de g√©n√©rer des statistiques et m√™me des graphiques √©l√©mentaires), le contr√¥leur doit effectuer certaines actions en fonction de l'heure actuelle de la journ√©e, des week-ends, des vacances, etc. Si votre contr√¥leur n'a aucune id√©e en temps r√©el, il se transforme en une machine simple qui ne peut effectuer des actions de base que sur un programme d√©fini de mani√®re rigide. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depuis </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino Mega Server</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c'est un syst√®me puissant et d√©velopp√©, alors cet √©tat de fait (manque de travail en temps r√©el) ne pouvait pas me convenir, ainsi qu'√† tous les autres utilisateurs du syst√®me. </font><font style="vertical-align: inherit;">Par cons√©quent, la question de l'int√©gration dans le syst√®me RTC √©tait l'une des premi√®res √† l'ordre du jour.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Horloge virtuelle en temps r√©el</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout irait bien, mais ni moi, ni la plupart des utilisateurs d'AMS ne disposions du m√™me module RTC ¬´de fer¬ª, il a donc √©t√© d√©cid√© de faire une ¬´balade √† cheval¬ª et, √† titre temporaire, d'organiser des horloges en temps r√©el fonctionnant √† l'int√©rieur du syst√®me, sans v√©ritable module physique. </font><font style="vertical-align: inherit;">Qui a √©t√© mis en ≈ìuvre avec succ√®s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alors, comment organiser un RTC virtuel, sans v√©ritable module. </font><font style="vertical-align: inherit;">Il y a une merveilleuse </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">biblioth√®que de temps</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> qui fait la part du lion du travail de nous fournir l'heure exacte. </font><font style="vertical-align: inherit;">Pour commencer √† travailler avec lui, vous devez le t√©l√©charger, le d√©compresser et le placer sur l'emplacement standard de toutes les biblioth√®ques de l'environnement Arduino, √† savoir dans le dossier:</font></font><br>
<br>
<pre><code class="java hljs">\rduino\libraries\
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s cela, toutes les possibilit√©s de travailler avec le temps qu'il nous offre deviennent disponibles pour nous.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment √ßa fonctionne</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le principe est tr√®s simple. La biblioth√®que ¬´lance¬ª l'horloge virtuelle ¬´√† l'int√©rieur¬ª du contr√¥leur et offre la possibilit√© de les synchroniser de diff√©rentes mani√®res, au choix. Vous pouvez choisir la m√©thode qui vous convient le mieux. √âtant donn√© que l'Arduino Mega Server est un p√©riph√©rique r√©seau, l'option de synchronisation de l'horloge via le r√©seau avec l'heure exacte des serveurs a √©t√© choisie. Il peut s'agir de serveurs sur Internet ou de serveurs sur le r√©seau local sur lequel le service correspondant s'ex√©cute. Par exemple, dans la version de base d'AMS, l'horloge est synchronis√©e avec le serveur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MajorDoMo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et vous n'avez rien √† configurer pour cela, tout fonctionne par </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">d√©faut</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Donc, pour que cela fonctionne, vous devez connecter les biblioth√®ques appropri√©es au d√©but de l'esquisse.</font></font><br>
<br>
<pre><code class="java hljs">#include &lt;SPI.h&gt;<font></font>
#include &lt;Ethernet.h&gt;<font></font>
#include &lt;EthernetUdp.h&gt;<font></font>
#include &lt;Time.h&gt; <font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le fichier Time.h est en fait une biblioth√®que pour travailler avec le temps, et le reste des fichiers est n√©cessaire pour travailler avec le r√©seau et pour synchroniser l'heure en utilisant le protocole NTP (la biblioth√®que Ethernet doit √©galement √™tre install√©e sur votre ordinateur). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, vous devez sp√©cifier l'adresse IP du serveur avec lequel vous souhaitez synchroniser l'heure</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function">IPAddress <span class="hljs-title">timeServer</span><span class="hljs-params">(<span class="hljs-number">192</span>, <span class="hljs-number">168</span>, <span class="hljs-number">2</span>, <span class="hljs-number">8</span>)</span></span>; <span class="hljs-comment">//   MajorDoMo  </span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
et port correspondant</font></font><br>
<br>
<pre><code class="java hljs">unsigned <span class="hljs-keyword">int</span> localPort = <span class="hljs-number">8888</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mais il y a un point: le port 8888 convient √† la synchronisation sur un r√©seau local, et la plupart des serveurs sur Internet n'y r√©pondent pas, donc si vous pr√©voyez de synchroniser l'heure avec des serveurs de temps exacts sur Internet, il est pr√©f√©rable de d√©finir le port 123:</font></font><br>
<br>
<pre><code class="java hljs">unsigned <span class="hljs-keyword">int</span> localPort = <span class="hljs-number">123</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
il ne reste plus qu'√† indiquer le fuseau horaire</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> timeZone = <span class="hljs-number">4</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
et cr√©er un objet EthernetUDP</font></font><br>
<br>
<pre><code class="java hljs">EthernetUDP Udp;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä ce sujet, les op√©rations pr√©paratoires peuvent √™tre consid√©r√©es comme termin√©es et vous pouvez d√©crire les fonctionnalit√©s dont vous avez besoin pour travailler avec le temps. </font><font style="vertical-align: inherit;">Fonction d'initialisation:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">rtcInit</span><span class="hljs-params">()</span> </span>{<font></font>
  Udp.begin(localPort);<font></font>
  Serial.println(<span class="hljs-string">"Waiting for NTP sync..."</span>);<font></font>
  setSyncProvider(getNtpTime);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, vous devez faire attention √† la fonction</font></font><br>
<br>
<pre><code class="java hljs">setSyncProvider(getNtpTime);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette fonction d√©finit la source de synchronisation horaire (dans ce cas, la synchronisation NTP via le r√©seau). Mais il pourrait s'agir de n'importe quelle autre source, par exemple, le module RTC physique. La performance de cette fonction conduit √† l'installation d'une source de synchronisation (pour l'avenir) et, en m√™me temps, √† la synchronisation de l'heure elle-m√™me via cette source. C'est au moment de l'ex√©cution de cette fonction que l'heure exacte ¬´appara√Æt¬ª dans votre syst√®me. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La biblioth√®que elle-m√™me a une autre fonctionnalit√© int√©ressante,</font></font><br>
<br>
<pre><code class="java hljs">setSyncInterval(interval);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ce qui vous permet de d√©finir l'intervalle souhait√© entre les synchronisations (d√©fini en secondes, la synchronisation elle-m√™me se produit automatiquement, sans aucune participation de votre part). </font></font><br>
<br>
<img src="https://habrastorage.org/files/994/655/c68/994655c686114b5c897a038f300e1e61.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez maintenant utiliser l'heure exacte √† l'int√©rieur de l'esquisse d'Arduino, par exemple, afficher les √©v√©nements sur le moniteur s√©rie n'est pas facile, mais li√© √† une heure exacte pr√©cise. </font><font style="vertical-align: inherit;">Cela se fait en utilisant la fonction timeStamp ():</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">timeStamp</span><span class="hljs-params">()</span> </span>{<font></font>
  serialRTC();<font></font>
  Serial.print(<span class="hljs-string">" "</span>);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
qui est un wrapper pour la fonction serialRTC ():</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">serialRTC</span><span class="hljs-params">()</span> </span>{<font></font>
  Serial.print(year()); <font></font>
  Serial.print(<span class="hljs-string">"-"</span>);<font></font>
  printDigits(month());<font></font>
  Serial.print(<span class="hljs-string">"-"</span>);<font></font>
  printDigits(day());<font></font>
  Serial.print(<span class="hljs-string">" "</span>);<font></font>
  printDigits(hour());<font></font>
  Serial.print(<span class="hljs-string">":"</span>);<font></font>
  printDigits(minute());<font></font>
  Serial.print(<span class="hljs-string">":"</span>);<font></font>
  printDigits(second());<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'analyse du m√©canisme de transmission et d'affichage du temps dans l'interface Web AMS d√©passe le cadre de cette histoire et m√©rite un article s√©par√© et, s'il y a un int√©r√™t, nous pouvons √©crire une suite et expliquer en d√©tail comment la ¬´magie¬ª du temps s'affiche dans l'interface Web Arduino Mega. Serveur </font></font><br>
<br>
<img src="https://habrastorage.org/files/ca9/d1c/bec/ca9d1cbec3084d169566dbaa1cf2cf99.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, c'est tout. </font><font style="vertical-align: inherit;">C'est ainsi que les horloges virtuelles en temps r√©el √©taient organis√©es dans AMS jusqu'√† la version 0.12 incluse, et vous pouvez √©galement organiser le travail avec une heure pr√©cise dans vos projets, m√™me si vous n'avez pas de module physique pour les horloges en temps r√©el. </font><font style="vertical-align: inherit;">Mais ce n'est pas la fin de l'histoire, mais plut√¥t le d√©but.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code de module RTC complet d'Arduino Mega Server 0.12</font></font></b><div class="spoiler_text">/*<br>
 Modul Virtual RTC<br>
 part of Arduino Mega Server project<br>
*/<br>
<br>
// Virtual RTC<br>
<br>
IPAddress timeServer(192, 168, 2, 8);<br>
unsigned int localPort = 8888; // local port to listen for UDP packets<br>
EthernetUDP Udp;<br>
<br>
const int timeZone = 4;<br>
time_t prevDisplay = 0; // when the digital clock was displayed<br>
<br>
void rtcInit() {<br>
 Udp.begin(localPort);<br>
 Serialprint(¬´Waiting for NTP sync‚Ä¶ \n¬ª);<br>
 setSyncProvider(getNtpTime);<br>
 modulRtc = 1;<br>
}<br>
<br>
void rtcWorks() {<br>
 if (timeStatus() != timeNotSet) {<br>
 if (now() != prevDisplay) { // update the display only if time has changed<br>
 setLifer();<br>
 prevDisplay = now();<br>
 //digitalClockDisplay(); <br>
 }<br>
 }<br>
}<br>
<br>
void printDigits(int digits) {<br>
 if(digits &lt; 10) {<br>
 Serial.print('0');<br>
 }<br>
 Serial.print(digits);<br>
}<br>
<br>
void serialRTC() {<br>
 Serial.print(year()); <br>
 Serial.print("-");<br>
 printDigits(month());<br>
 Serial.print("-");<br>
 printDigits(day());<br>
 Serial.print(" ");<br>
 printDigits(hour());<br>
 Serial.print(":");<br>
 printDigits(minute());<br>
 Serial.print(":");<br>
 printDigits(second());<br>
}<br>
<br>
void timeStamp() {<br>
 serialRTC();<br>
 Serial.print(" ");<br>
}<br>
<br>
void printRTC(){<br>
 serialRTC();<br>
 Serial.println();<br>
}<br>
<br>
// NTP code<br>
<br>
const int NTP_PACKET_SIZE = 48; // NTP time is in the first 48 bytes of message<br>
byte packetBuffer[NTP_PACKET_SIZE]; //buffer to hold incoming &amp; outgoing packets<br>
<br>
#ifdef RTC_FEATURE<br>
<br>
time_t getNtpTime() {<br>
 while (Udp.parsePacket() &gt; 0); // discard any previously received packets<br>
 Serialprint(¬´Transmit NTP request\n¬ª);<br>
 sendNTPpacket(timeServer);<br>
 uint32_t beginWait = millis();<br>
 while (millis() ‚Äî beginWait &lt; 1500) {<br>
 int size = Udp.parsePacket();<br>
 if (size &gt;= NTP_PACKET_SIZE) {<br>
 Serialprint(¬´Receive NTP response\n¬ª);<br>
 Udp.read(packetBuffer, NTP_PACKET_SIZE); // read packet into the buffer<br>
 unsigned long secsSince1900;<br>
 // convert four bytes starting at location 40 to a long integer<br>
 secsSince1900 = (unsigned long)packetBuffer[40] &lt;&lt; 24;<br>
 secsSince1900 |= (unsigned long)packetBuffer[41] &lt;&lt; 16;<br>
 secsSince1900 |= (unsigned long)packetBuffer[42] &lt;&lt; 8;<br>
 secsSince1900 |= (unsigned long)packetBuffer[43];<br>
 return secsSince1900 ‚Äî 2208988800UL + timeZone * SECS_PER_HOUR;<br>
 }<br>
 }<br>
 Serialprint(¬´No NTP response\n¬ª);<br>
 return 0; // return 0 if unable to get the time<br>
}<br>
<br>
// send an NTP request to the time server at the given address<br>
void sendNTPpacket(IPAddress &amp;address) {<br>
 // set all bytes in the buffer to 0<br>
 memset(packetBuffer, 0, NTP_PACKET_SIZE);<br>
 // Initialize values needed to form NTP request<br>
 // (see URL above for details on the packets)<br>
 packetBuffer[0] = 0b11100011; // LI, Version, Mode<br>
 packetBuffer[1] = 0; // Stratum, or type of clock<br>
 packetBuffer[2] = 6; // Polling Interval<br>
 packetBuffer[3] = 0xEC; // Peer Clock Precision<br>
 // 8 bytes of zero for Root Delay &amp; Root Dispersion<br>
 packetBuffer[12] = 49;<br>
 packetBuffer[13] = 0x4E;<br>
 packetBuffer[14] = 49;<br>
 packetBuffer[15] = 52;<br>
 // all NTP fields have been given values, now<br>
 // you can send a packet requesting a timestamp: <br>
 Udp.beginPacket(address, 123); //NTP requests are to port 123<br>
 Udp.write(packetBuffer, NTP_PACKET_SIZE);<br>
 Udp.endPacket();<br>
}<br>
<br>
#endif<br>
<br>
// Duration<br>
<br>
void showDuration(time_t duration) {<br>
 // prints the duration in days, hours, minutes and seconds<br>
 Serialprint(" (duration ");<br>
 if(duration &gt;= SECS_PER_DAY){<br>
 Serial.print(duration / SECS_PER_DAY);<br>
 Serialprint(" day "); <br>
 duration = duration % SECS_PER_DAY; <br>
 }<br>
 if(duration &gt;= SECS_PER_HOUR){<br>
 Serial.print(duration / SECS_PER_HOUR);<br>
 Serialprint(" hour "); <br>
 duration = duration % SECS_PER_HOUR; <br>
 }<br>
 if(duration &gt;= SECS_PER_MIN){<br>
 Serial.print(duration / SECS_PER_MIN);<br>
 Serialprint(" min "); <br>
 duration = duration % SECS_PER_MIN; <br>
 }<br>
 Serial.print(duration);<br>
 Serialprint(" sec) \n"); <br>
}<br>
<br>
void checkEvent(time_t* prevEvent) {<br>
 time_t duration = 0;<br>
 time_t timeNow = now();<br>
 <br>
 if (*prevEvent &gt; 0) {<br>
 duration = timeNow ‚Äî *prevEvent;<br>
 } <br>
 if (duration &gt; 0) {<br>
 showDuration(duration);<br>
 } <br>
 *prevEvent = timeNow;<br>
}<br>
<br>
</div></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une agr√©able surprise</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je n'aurais pas √©t√© occup√© √† int√©grer des modules RTC dans le syst√®me depuis longtemps (il y a aussi suffisamment d'autres t√¢ches urgentes), mais ici, dans le cadre de la coop√©ration technologique avec notre projet, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CHIPSTER a</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fourni des </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">√©quipements</font></a><font style="vertical-align: inherit;"> de test et d'int√©gration dans AMS, parmi lesquels il y avait des modules Ethernet bas√©s sur la puce </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">W5500</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et ... le module d'horloge en temps r√©el sur la puce </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DS3231</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui s'est av√©r√© √™tre le plus opportun et a servi d'impulsion pour l'int√©gration des modules RTC dans le syst√®me. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'est av√©r√© que la soci√©t√© CHIPSTER vend non seulement des √©quipements √©lectroniques, mais d√©veloppe √©galement ses propres produits pour Arduino et l'automatisation sous la marque </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geegrow</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et a de grands projets pour l'avenir dans cette direction, en particulier, elle a un projet pour la sortie d'une version sp√©cialis√©e de l'Arduino Mega 2560 avec des fonctionnalit√©s avanc√©es et "aff√ªt√©es" sp√©cifiquement pour l'Arduino Mega Server. </font><font style="vertical-align: inherit;">Et, si ce forum sort, ce sera un √©v√©nement tr√®s int√©ressant. </font><font style="vertical-align: inherit;">Mais revenons √† l'horloge en temps r√©el.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Horloge temps r√©el</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√âtant donn√© que le module RTC √©tait √† port√©e de main, ce serait un p√©ch√© de ne pas l'int√©grer dans le syst√®me. Heureusement, cela s'est av√©r√© assez simple gr√¢ce √† la m√™me Time Library. Mais tout d'abord. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ceux qui ne connaissent pas, il existe deux types de modules en temps r√©el - ¬´ordinaire¬ª (g√©n√©ralement sur une puce DS1307) et ¬´avanc√©¬ª (sur une puce DS3231, que j'ai). La diff√©rence entre les deux est que les premi√®res ne sont pas tr√®s pr√©cises et peuvent ¬´s'enfuir¬ª tr√®s rapidement et tr√®s fortement, et la seconde est une montre de haute pr√©cision avec un soin normalis√© de pas plus de deux minutes par an, c'est-√†-dire, r√©ellement applicable dans la pratique. Et la pr√©cision est obtenue gr√¢ce √† une conception de circuit plus complexe et √† une compensation thermique int√©gr√©e.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais par programme, les deux versions des modules sont compatibles et les deux fonctionneront avec la biblioth√®que et le code. </font><font style="vertical-align: inherit;">La diff√©rence ne sera que dans la pr√©cision. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et bien s√ªr, l'une des principales propri√©t√©s d'une horloge en temps r√©el est la capacit√© de fonctionner lorsque l'alimentation est coup√©e, en raison de la batterie int√©gr√©e.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Connexion physique</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons maintenant comment connecter physiquement le module RTC au Arduino Mega Server ou √† votre projet Arduino. Je dois dire que c'est tr√®s simple et que vous n'aurez besoin que de deux r√©sistances et de quelques fils. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La connexion est triviale: vous devez trouver quatre contacts sur votre module - GND (masse), VCC (tension d'alimentation), SCL (signal d'horloge), SDA (donn√©es). D'autres contacts sont utilis√©s dans des cas rares et sp√©cifiques et vous pouvez les ignorer. </font></font><br>
<br>
<img src="https://habrastorage.org/files/7ec/49a/566/7ec49a56688f40f2a824adef2f625774.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, nous connectons la broche GND √† la masse, la broche VCC √† la tension d'alimentation du contr√¥leur. Ici, tout est simple et aucune question ne devrait se poser.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le reste des conclusions n'est pas beaucoup plus compliqu√©. </font><font style="vertical-align: inherit;">Le module RTC communique avec le contr√¥leur via l'interface I2C, qui n'a que deux fils: synchronisation et donn√©es, et les contr√¥leurs Arduino ont d√©j√† des contacts pour connecter cette interface. </font><font style="vertical-align: inherit;">L'Arduino Uno est A4 (SDA) et A5 (SCL), tandis que l'arduino Mega est D20 (SDA) et D21 (SCL). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La seule subtilit√© est que les broches SCL et SDA doivent √™tre ¬´tir√©es¬ª vers la source d'alimentation via des r√©sistances de 4,7 kŒ©. </font><font style="vertical-align: inherit;">Si vous n'avez pas exactement cette cote, vous pouvez utiliser des r√©sistances de la gamme 2 KOhm - 10 KOhm.</font></font><br>
<br>
<img src="https://habrastorage.org/files/490/875/26d/49087526d1544d56947ee66ed7b19150.jpg" alt="image"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Support logiciel</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il ne reste plus qu'√† ajouter la prise en charge du module dans le code AMS ou votre projet. </font><font style="vertical-align: inherit;">Comme je l'ai dit, ce sera tr√®s simple car la m√™me Time Library fonctionnera avec le module. </font><font style="vertical-align: inherit;">Certes, nous devrons ajouter une autre biblioth√®que, √† savoir la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">biblioth√®que DS1307RTC</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Nous le d√©ballons √©galement et le mettons dans le dossier de biblioth√®que standard:</font></font><br>
<br>
<pre><code class="java hljs">\rduino\libraries\
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ajoutez les lignes suivantes √† votre code d'esquisse</font></font><br>
<br>
<pre><code class="java hljs">#include &lt;Wire.h&gt;<font></font>
#include &lt;DS1307RTC.h&gt;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, nous sommes enti√®rement √©quip√©s et nous pouvons commencer √† √©crire le code du croquis lui-m√™me, en travaillant avec le module physique RTC. </font><font style="vertical-align: inherit;">En fonction</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">rtcInit</span><span class="hljs-params">()</span> </span>{<font></font>
  Udp.begin(localPort);<font></font>
  Serial.println(<span class="hljs-string">"Waiting for NTP sync..."</span>);<font></font>
  setSyncProvider(getNtpTime);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
remplacer la cha√Æne</font></font><br>
<br>
<pre><code class="java hljs">setSyncProvider(getNtpTime);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
sur le</font></font><br>
<br>
<pre><code class="java hljs">setSyncProvider(RTC.get);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
et l'heure interne de l'Arduino Mega Server (ou de votre contr√¥leur) sera synchronis√©e avec le contr√¥leur RTC "iron", et non avec les serveurs sur Internet ou le r√©seau local. </font><font style="vertical-align: inherit;">Ainsi, en appelant les fonctions setSyncProvider (getNtpTime) et setSyncProvider (RTC.get), vous pouvez manipuler les sources de synchronisation de l'heure et synchroniser l'heure comme vous le souhaitez, en fonction de diverses conditions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une autre fonction que vous devez conna√Ætre est</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">if</span> (timeStatus() != timeNotSet) {<font></font>
<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ce qui vous permet de savoir si l'heure est synchronis√©e et, selon cette condition, de prendre les mesures n√©cessaires.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Moment subtil</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devez distinguer deux choses: le temps qui passe dans le module RTC ¬´iron¬ª et le temps qui passe dans votre contr√¥leur. Ce n'est pas la m√™me chose. La chose ¬´principale¬ª pour vous est le temps dans le contr√¥leur, et le temps dans le module n'est qu'une source de synchronisation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais! √©tant donn√© que le temps dans le RTC physique s'√©puise √©galement progressivement, il doit √©galement √™tre ajust√© en se synchronisant avec des sources plus pr√©cises, par exemple, des serveurs sur Internet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par cons√©quent, l'algorithme optimal devrait √™tre le suivant: si possible, synchronisez ensuite toutes les horloges avec les serveurs sur Internet, si le r√©seau n'est pas disponible, puis nous commen√ßons √† synchroniser l'heure dans le contr√¥leur avec le module RTC, d√®s que le r√©seau appara√Æt, revenez √† la synchronisation via Internet.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous √™tes dans des conditions extr√™mes, sans acc√®s √† aucune source de synchronisation, vous pouvez ajuster manuellement le cours de l'horloge de fer de temps en temps. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consid√©rons par exemple la fonction de synchronisation de l'horloge interne du contr√¥leur et du module RTC via le r√©seau:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">rtcSync</span><span class="hljs-params">()</span> </span>{<font></font>
  setSyncProvider(getNtpTime);<font></font>
  Serial.println(<span class="hljs-string">"...getNtpTime..."</span>);
  <span class="hljs-keyword">if</span> (timeStatus() != timeNotSet) {<font></font>
    Serial.println(<span class="hljs-string">"...set!..."</span>);<font></font>
    time_t t = getNtpTime();<font></font>
    RTC.set(t);<font></font>
    setSyncProvider(RTC.get);<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, nous obtenons d'abord l'heure exacte sur le r√©seau.</font></font><br>
<br>
<pre><code class="java hljs">setSyncProvider(getNtpTime);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
puis, en cas de succ√®s, installez-le dans le module RTC</font></font><br>
<br>
<pre><code class="java hljs">RTC.set(t);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
puis √† partir de ce module, nous d√©finissons le temps du contr√¥leur</font></font><br>
<br>
<pre><code class="java hljs">setSyncProvider(RTC.get);
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lancement initial</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais ce n'est pas tout. </font><font style="vertical-align: inherit;">Il y a aussi le probl√®me du d√©marrage initial, lorsque le module RTC est uniquement connect√©, mais que l'heure n'est pas d√©finie et qu'il est donc impossible de se synchroniser avec lui. </font><font style="vertical-align: inherit;">Vous devez en quelque sorte r√©gler le bon moment. </font><font style="vertical-align: inherit;">Il y a deux fa√ßons de r√©soudre ce probl√®me dans l'Arduino Mega Server: vous pouvez synchroniser le RTC physique sur le r√©seau (si le serveur de temps est disponible) ou en utilisant l'utilitaire Arduino Serial Commander.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour r√©gler l'heure dans le module RTC, il suffit de ... cliquer sur le bouton. </font><font style="vertical-align: inherit;">Tout le reste sera fait pour vous par deux jeunes hommes nomm√©s Arduino Mega Server et Arduino Serial Commander. </font><font style="vertical-align: inherit;">Si vous n'utilisez pas AMS, mais d√©veloppez votre propre projet, vous pouvez prendre le code du kit de distribution Arduino Mega Server (le code est disponible et enti√®rement gratuit) ou chercher une solution √† ce probl√®me sur Internet (il existe plusieurs solutions).</font></font><br>
<br>
<img src="https://habrastorage.org/files/df7/2b1/c4b/df72b1c4b4594bd082d9a0b8c7cdc6c6.png" alt="image"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Version avec v√©ritable support RTC</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Arduino Mega Server, √† partir de la version 0.13, prend en charge le ¬´fer¬ª RTC. </font><font style="vertical-align: inherit;">Vous pouvez t√©l√©charger la derni√®re version actuelle sur le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">site officiel du projet</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et </font><font style="vertical-align: inherit;">vous pouvez </font><font style="vertical-align: inherit;">poser des questions sur le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">forum</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et, bien s√ªr, j'exprime ma gratitude √† </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CHIPSTER</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour la coop√©ration et l'√©quipement fourni pour les tests et l'int√©gration (je vais vous parler du module W5500 et de l'acc√©l√©ration du fonctionnement du r√©seau AMS dans l'un des articles suivants). </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Addition</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Une cha√Æne Youtube est ouverte et voici une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vid√©o promo du</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Arduino Mega Server, qui montre comment travailler avec un vrai syst√®me.</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr385349/">https://habr.com/ru/post/fr385349/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr385339/index.html">Intel a pr√©sent√© le SSD le plus rapide</a></li>
<li><a href="../fr385341/index.html">Cultiv√©e artificiellement en laboratoire, la viande sera en vente au cours des 5 prochaines ann√©es</a></li>
<li><a href="../fr385343/index.html">Un peu de magie d'Apple - nouveaux Magic Keyboard, Trackpad, Mouse et iMac</a></li>
<li><a href="../fr385345/index.html">Le marteau de Thor dans la vraie vie: aimant et scanner d'empreintes digitales</a></li>
<li><a href="../fr385347/index.html">Bitcoin computer maker 21 Bitcoin lance des cours pour d√©veloppeurs</a></li>
<li><a href="../fr385351/index.html">La NASA a rejet√© le projet de livraison de fret orbital de Lockheed Martin comme trop compliqu√© et trop cher</a></li>
<li><a href="../fr385353/index.html">Un prototype fonctionnel d'un module acc√©l√©rateur de microparticules d'une longueur de 1,5 cm a √©t√© cr√©√©</a></li>
<li><a href="../fr385355/index.html">Le piratage en ligne en Australie diminue gr√¢ce √† Netflix</a></li>
<li><a href="../fr385361/index.html">Windows 10 Mobile ‚Äî –±–∏–ª–¥ 10549 –¥–æ—Å—Ç—É–ø–µ–Ω –∏–Ω—Å–∞–π–¥–µ—Ä–∞–º</a></li>
<li><a href="../fr385363/index.html">Vid√©o du pilote automatique Tesla sur le trafic urbain</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>