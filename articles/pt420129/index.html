<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏾‍✈️ 🏌️ 🧑🏻‍🤝‍🧑🏻 Padrões assíncronos de rotina: fora aguardam ☣️ 👃🏻 💅🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prefácio do tradutor: 
 Mais uma vez pisando em um ancinho enquanto trabalhava com python assíncio, fui à Internet para encontrar algo mais agradável ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Padrões assíncronos de rotina: fora aguardam</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/420129/"><p>  <em>Prefácio do tradutor:</em> <em><br></em>  <em>Mais uma vez pisando em um ancinho enquanto trabalhava com python assíncio, fui à Internet para encontrar algo mais agradável que a documentação seca.</em>  <em>Me deparei <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">com</a> um artigo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Yeray Diaz "Padrões assíncronos de corotina: além do esperado"</a> , no qual o autor considera muito interessante o uso do assíncio e compartilha alguns truques.</em>  <em>Como não encontrei nada tão completo em russo, decidi traduzi-lo.</em> </p><br><p>  O Asyncio é o sonho competitivo de um programador em python: você escreve código parecido com o síncrono e deixa o Python fazer o resto.  Esta é outra importação da biblioteca antigravidade: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">import antigravity</a> </p><br><p>  Na verdade, isso não é verdade, a programação simultânea é um trabalho árduo e, embora as corotinas nos permitam evitar avisos de retorno de chamada, o que pode levá-lo longe o suficiente, você ainda precisa pensar em criar tarefas, obter resultados e capturar exceções com elegância.  Isso é triste </p><br><p>  A boa notícia é que tudo isso é possível em assincronismo.  A má notícia é que nem sempre é óbvio o que está errado e como corrigi-lo.  Abaixo estão alguns padrões que eu descobri enquanto trabalhava com asyncio. </p><a name="habracut"></a><br><br><p>  Antes de começarmos: </p><br><p>  Usei minha biblioteca aiohttp favorita para executar solicitações HTTP assíncronas e a API Hacker News, porque é um site simples e conhecido que segue um cenário de uso familiar.  Após a resposta ao meu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo anterior</a> , também usei a sintaxe async / waitit introduzida no Python 3.5.  Supus que o leitor estivesse familiarizado com as idéias descritas aqui.  E, finalmente, todos os exemplos estão disponíveis no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">repositório GitHub deste artigo</a> . </p><br><p>  Ok, vamos começar! </p><br><h2 id="rekursivnye-korutiny">  Corotinas recursivas </h2><br><p>  Criar e executar tarefas é trivial no assíncio.  Para essas tarefas, a API inclui vários métodos na classe AbstractEventLoop, além de funções na biblioteca.  Mas geralmente você deseja combinar os resultados dessas tarefas e processá-los de alguma forma, e a recursão é um ótimo exemplo desse esquema e também demonstra a simplicidade da corotina em comparação com outras ferramentas da concorrência. </p><br><p>  Um caso comum para o uso de assíncrono é criar algum tipo de rastreador da web.  Imagine que estamos ocupados demais para verificar o HackerNews, ou talvez você goste de um bom holivar, então você deseja implementar um sistema que recupere o número de comentários para uma postagem específica do HN e, se estiver acima do limite, notifica você.  Você pesquisou um pouco no Google e encontrou a documentação para a API HN, exatamente o que precisa, mas observou o seguinte na documentação: </p><br><blockquote>  Deseja saber o número total de comentários de artigos?  Contorne a árvore e conte-os. </blockquote><p>  Chamada aceita! </p><br><pre><code class="python hljs"><span class="hljs-string"><span class="hljs-string">"""          ,       ,      . ,         Hacker News      """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> argparse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> logging <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> urllib.parse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> urlparse, parse_qs <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> aiohttp <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> async_timeout LOGGER_FORMAT = <span class="hljs-string"><span class="hljs-string">'%(asctime)s %(message)s'</span></span> URL_TEMPLATE = <span class="hljs-string"><span class="hljs-string">"https://hacker-news.firebaseio.com/v0/item/{}.json"</span></span> FETCH_TIMEOUT = <span class="hljs-number"><span class="hljs-number">10</span></span> parser = argparse.ArgumentParser(description=<span class="hljs-string"><span class="hljs-string">'Calculate the comments of a Hacker News post.'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--id'</span></span>, type=int, default=<span class="hljs-number"><span class="hljs-number">8863</span></span>, help=<span class="hljs-string"><span class="hljs-string">'ID of the post in HN, defaults to 8863'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--url'</span></span>, type=str, help=<span class="hljs-string"><span class="hljs-string">'URL of a post in HN'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--verbose'</span></span>, action=<span class="hljs-string"><span class="hljs-string">'store_true'</span></span>, help=<span class="hljs-string"><span class="hljs-string">'Detailed output'</span></span>) logging.basicConfig(format=LOGGER_FORMAT, datefmt=<span class="hljs-string"><span class="hljs-string">'[%H:%M:%S]'</span></span>) log = logging.getLogger() log.setLevel(logging.INFO) fetch_counter = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(session, url)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  URL   aiohttp,    JSON .     aiohttp    . """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> fetch_counter <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> async_timeout.timeout(FETCH_TIMEOUT): fetch_counter += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> session.get(url) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> response: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> response.json() <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post_number_of_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, post_id)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""          . """</span></span> url = URL_TEMPLATE.format(post_id) now = datetime.now() response = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fetch(session, url) log.debug(<span class="hljs-string"><span class="hljs-string">'{:^6} &gt; Fetching of {} took {} seconds'</span></span>.format( post_id, url, (datetime.now() - now).total_seconds())) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'kids'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> response: <span class="hljs-comment"><span class="hljs-comment">#  .   return 0 #     ,    (  ) number_of_comments = len(response['kids']) #       log.debug('{:^6} &gt; Fetching {} child posts'.format( post_id, number_of_comments)) tasks = [post_number_of_comments(loop, session, kid_id) for kid_id in response['kids']] #      results = await asyncio.gather(*tasks) #            number_of_comments += sum(results) log.debug('{:^6} &gt; {} comments'.format(post_id, number_of_comments)) return number_of_comments def id_from_HN_url(url): """   `id` URL       None. """ parse_result = urlparse(url) try: return parse_qs(parse_result.query)['id'][0] except (KeyError, IndexError): return None if __name__ == '__main__': args = parser.parse_args() if args.verbose: log.setLevel(logging.DEBUG) post_id = id_from_HN_url(args.url) if args.url else args.id loop = asyncio.get_event_loop() with aiohttp.ClientSession(loop=loop) as session: now = datetime.now() comments = loop.run_until_complete( post_number_of_comments(loop, session, post_id)) log.info( '&gt; Calculating comments took {:.2f} seconds and {} fetches'.format( (datetime.now() - now).total_seconds(), fetch_counter)) log.info("-- Post {} has {} comments".format(post_id, comments)) loop.close()</span></span></code> </pre> <br><p>  <em>Sinta-se à vontade para tentar executar o script com o sinalizador "-verbose" para obter uma saída mais detalhada.</em> </p><br><pre> <code class="hljs css"> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[14:47:32]</span></span> &gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">Calculating</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">comments</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">took</span></span> 2<span class="hljs-selector-class"><span class="hljs-selector-class">.23</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">seconds</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">and</span></span> 73 <span class="hljs-selector-tag"><span class="hljs-selector-tag">fetches</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[14:47:32]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> 8863 <span class="hljs-selector-tag"><span class="hljs-selector-tag">has</span></span> 72 <span class="hljs-selector-tag"><span class="hljs-selector-tag">comments</span></span></code> </pre> <br><p>  Vamos pular o código padrão e ir direto para a rotina recursiva.  Observe que esse código é lido quase completamente como seria com o código síncrono. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post_number_of_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, post_id)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""          . """</span></span> url = URL_TEMPLATE.format(post_id) now = datetime.now() response = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fetch(session, url) log.debug(<span class="hljs-string"><span class="hljs-string">'{:^6} &gt; Fetching of {} took {} seconds'</span></span>.format( post_id, url, (datetime.now() - now).total_seconds())) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'kids'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> response: <span class="hljs-comment"><span class="hljs-comment"># base case, there are no comments return 0 #     ,    (  ) number_of_comments = len(response['kids']) #       log.debug('{:^6} &gt; Fetching {} child posts'.format( post_id, number_of_comments)) tasks = [post_number_of_comments( loop, session, kid_id) for kid_id in response['kids']] #      results = await asyncio.gather(*tasks) #          number_of_comments += sum(results) log.debug('{:^6} &gt; {} comments'.format(post_id, number_of_comments)) return number_of_comments</span></span></code> </pre> <br><ol><li>  Primeiro, obtemos JSON com os dados da postagem. </li><li>  Recursivamente, contorne cada um dos herdeiros. </li><li>  No final, alcançaremos o caso base e retornaremos zero, <br>  quando a postagem não tiver comentários. </li><li>  Ao retornar do caso base, adicione as respostas à postagem atual <br>  ao número de herdeiros e retornar </li></ol><br><p>  Este é um ótimo exemplo do que Brett Slatkin descreve como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fan-in e fan-out</a> ; somos fan-out para receber dados dos herdeiros e fan-in resume os dados para calcular o número de comentários </p><br><p>  Existem algumas maneiras na API assíncrona de executar essas operações de dispersão.  Aqui, uso a função de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">coleta</a> , que espera efetivamente todas as corotinas para concluir e retornar uma lista de seus resultados. </p><br><p>  Vamos prestar atenção em como o uso da corotina também corresponde bem à recursão em qualquer ponto em que esteja presente um número de corotinas, aguardando respostas para seus pedidos durante a chamada para a função de coleta e retomando a execução após a conclusão da operação de E / S.  Isso nos permite expressar um comportamento bastante complexo em uma corutina elegante e (facilmente) legível. </p><br><p>  "Muito simples", você diz?  Ok, vamos subir um pouco. </p><br><h2 id="vystrelil-i-zabyl">  Atirou e esqueceu </h2><br><p>  Imagine que você deseja enviar para si mesmo uma mensagem de email com postagens que tenham mais comentários que um determinado valor e faça isso da mesma maneira que percorremos a árvore de postagens.  Podemos simplesmente adicionar a instrução if no final da função recursiva para conseguir isso: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post_number_of_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, post_id)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""           . """</span></span> url = URL_TEMPLATE.format(post_id) response = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fetch(session, url) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'kids'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> response: <span class="hljs-comment"><span class="hljs-comment">#  .   return 0 #       . number_of_comments = len(response['kids']) #       tasks = [post_number_of_comments(loop, session, kid_id) for kid_id in response['kids']] #      results = await asyncio.gather(*tasks) #            number_of_comments += sum(results) log.debug('{:^6} &gt; {} comments'.format(post_id, number_of_comments)) #        if number_of_comments &gt; MIN_COMMENTS: await log_post(response) return number_of_comments async def log_post(post): """   . """ await asyncio.sleep(random() * 3) log.info("Post logged")</span></span></code> </pre><br><p>  <em>Sim, eu usei asyncio.sleep.</em>  <em>Esta é a última vez.</em>  <em>Eu prometo.</em> </p><br><pre> <code class="hljs css"><span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:41:02]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logged</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:41:04]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logged</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:41:06]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logged</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:41:06]</span></span> &gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">Calculating</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">comments</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">took</span></span> 6<span class="hljs-selector-class"><span class="hljs-selector-class">.35</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">seconds</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">and</span></span> 73 <span class="hljs-selector-tag"><span class="hljs-selector-tag">fetches</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:41:06]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> 8863 <span class="hljs-selector-tag"><span class="hljs-selector-tag">has</span></span> 72 <span class="hljs-selector-tag"><span class="hljs-selector-tag">comments</span></span></code> </pre> <br><p>  Isso é significativamente mais lento do que antes! <br>  O motivo é que, como discutimos anteriormente, aguardamos uma pausa na execução da rotina até que o futuro esteja completo, mas como não precisamos do resultado do log, não há motivo real para fazer isso. </p><br><p>  Precisamos "disparar e esquecer" com nossa corotina e, como não podemos esperar que ela termine de esperar, precisamos de outra maneira de iniciar a corotina sem esperar.  Uma rápida olhada na API assíncrona encontrará a função <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sure_future</a> que agendará a execução da corrotina, envolva-a em um objeto Tarefa e retorne-a.  Lembrando que antes que a corotina fosse planejada, um ciclo de eventos controlará o resultado de nossa corotina em algum momento no futuro, quando outra corotina estiver em um estado de expectativa. </p><br><p>  Ótimo, vamos substituir aguardar log_post da seguinte maneira: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post_number_of_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, post_id)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""           . """</span></span> url = URL_TEMPLATE.format(post_id) response = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fetch(session, url) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'kids'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> response: <span class="hljs-comment"><span class="hljs-comment"># base case, there are no comments return 0 #       . number_of_comments = len(response['kids']) #       tasks = [post_number_of_comments( loop, session, kid_id) for kid_id in response['kids']] #      results = await asyncio.gather(*tasks) #            number_of_comments += sum(results) log.debug('{:^6} &gt; {} comments'.format(post_id, number_of_comments)) #        if number_of_comments &gt; MIN_COMMENTS: asyncio.ensure_future(log_post(response)) return number_of_comments</span></span></code> </pre><br><pre> <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>] &gt; Calculating comments took <span class="hljs-number"><span class="hljs-number">1.69</span></span> seconds and <span class="hljs-number"><span class="hljs-number">73</span></span> fetches [<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>] -- Post <span class="hljs-number"><span class="hljs-number">8863</span></span> has <span class="hljs-number"><span class="hljs-number">72</span></span> comments [<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>] Task was destroyed but it is pending! task: &lt;Task pending coro=&lt;log_post() done, defined at <span class="hljs-number"><span class="hljs-number">02</span></span>_fire_and_forget.py:<span class="hljs-number"><span class="hljs-number">82</span></span>&gt; wait_for=&lt;Future pending cb=[&lt;<span class="hljs-type"><span class="hljs-type">TaskWakeupMethWrapper</span></span> <span class="hljs-type"><span class="hljs-type">object</span></span> <span class="hljs-type"><span class="hljs-type">at</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x1109197f8</span></span>&gt;()]&gt;&gt; [<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>] Task was destroyed but it is pending! task: &lt;Task pending coro=&lt;log_post() done, defined at <span class="hljs-number"><span class="hljs-number">02</span></span>_fire_and_forget.py:<span class="hljs-number"><span class="hljs-number">82</span></span>&gt; wait_for=&lt;Future pending cb=[&lt;<span class="hljs-type"><span class="hljs-type">TaskWakeupMethWrapper</span></span> <span class="hljs-type"><span class="hljs-type">object</span></span> <span class="hljs-type"><span class="hljs-type">at</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x110919948</span></span>&gt;()]&gt;&gt; [<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>] Task was destroyed but it is pending! task: &lt;Task pending coro=&lt;log_post() done, defined at <span class="hljs-number"><span class="hljs-number">02</span></span>_fire_and_forget.py:<span class="hljs-number"><span class="hljs-number">82</span></span>&gt; wait_for=&lt;Future pending cb=[&lt;<span class="hljs-type"><span class="hljs-type">TaskWakeupMethWrapper</span></span> <span class="hljs-type"><span class="hljs-type">object</span></span> <span class="hljs-type"><span class="hljs-type">at</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x110919978</span></span>&gt;()]&gt;&gt;</code> </pre> <br><p>  Ahem, a <abbr title="A tarefa foi destruída, mas está sendo concluída!">tarefa</abbr> impressionante <abbr title="A tarefa foi destruída, mas está sendo concluída!">foi destruída, mas está pendente!</abbr>  assombrando usuários assíncronos em todo o mundo.  A boa notícia é que voltamos ao tempo que recebemos anteriormente (1,69 p.). A má notícia é que o assíncio não gosta de ir além do alcance de atirar e esquecer. </p><br><p>  O problema é que fechamos com força o loop de eventos depois de obtermos o resultado da rotina <em>post_number_of_comments</em> , sem deixar tempo para concluir a tarefa <em>log_post</em> . </p><br><p>  Temos duas opções: <br>  deixamos o loop de eventos funcionar infinitamente usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">run_forever</a> e finalizamos manualmente o script, ou usamos o método <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">all_tasks</a> da classe Task para encontrar todas as tarefas de trabalho e aguardar o cálculo do número de comentários. </p><br><p>  Vamos tentar sair dessa situação fazendo alterações rapidamente após nossa chamada para <em>post_number_of_comments</em> : </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: args = <span class="hljs-keyword"><span class="hljs-keyword">parser</span></span>.parse_args() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> args.<span class="hljs-keyword"><span class="hljs-keyword">verbose</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>.setLevel(logging.<span class="hljs-keyword"><span class="hljs-keyword">DEBUG</span></span>) post_id = id_from_HN_url(args.url) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> args.url <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> args.id <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> = asyncio.get_event_loop() <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> aiohttp.ClientSession(<span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">session</span></span>: now = datetime.now() comments = <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>.run_until_complete( post_number_of_comments(<span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">session</span></span>, post_id)) <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>( <span class="hljs-string"><span class="hljs-string">'&gt; Calculating comments took {:.2f} seconds and {} fetches'</span></span>.format( (datetime.now() - now).total_seconds(), fetch_counter)) <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>("-- Post {} has {} comments".format(post_id, comments)) pending_tasks = [ task <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> asyncio.Task.all_tasks() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> task.done()] <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>.run_until_complete(asyncio.gather(*pending_tasks)) <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">close</span></span>()</code> </pre> <br><pre> <code class="hljs css"><span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:47:29]</span></span> &gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">Calculating</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">comments</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">took</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.72</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">seconds</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">and</span></span> 73 <span class="hljs-selector-tag"><span class="hljs-selector-tag">fetches</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:47:29]</span></span> — <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> 8863 <span class="hljs-selector-tag"><span class="hljs-selector-tag">has</span></span> 72 <span class="hljs-selector-tag"><span class="hljs-selector-tag">comments</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:47:30]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logged</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:47:31]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logged</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:47:32]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logged</span></span></code> </pre> <br><p>  Agora temos certeza de que as tarefas de log foram concluídas. <br>  A suposição de que o método <em>all_tasks funciona</em> bem nos casos com os quais estamos lidando é uma ótima idéia quando as tarefas são executadas adequadamente em nosso loop de eventos, mas em casos mais complexos, pode haver várias tarefas que podem ser executadas, cuja origem pode estar localizada fora do nosso código . </p><br><p>  Outra abordagem é restaurar a ordem depois de registrar independentemente absolutamente todas as corotinas que planejamos lançar e permitir que sejam executadas, que foram adiadas anteriormente, <br>  assim que a contagem dos comentários for concluída.  Como você sabe, a função <em>sure_future</em> retorna um objeto <em>Task</em> . Podemos usá-lo para registrar nossas tarefas com baixa prioridade.  Vamos apenas definir uma lista <em>task_registry</em> e armazenar futuros nela: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post_number_of_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, post_id)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Retrieve data for current post and recursively for all comments. """</span></span> url = URL_TEMPLATE.format(post_id) response = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fetch(session, url) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'kids'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> response: <span class="hljs-comment"><span class="hljs-comment"># base case, there are no comments return 0 # calculate this post's comments as number of comments number_of_comments = len(response['kids']) # create recursive tasks for all comments tasks = [post_number_of_comments( loop, session, kid_id) for kid_id in response['kids']] # schedule the tasks and retrieve results results = await asyncio.gather(*tasks) # reduce the descendents comments and add it to this post's number_of_comments += sum(results) log.debug('{:^6} &gt; {} comments'.format(post_id, number_of_comments)) # Log if number of comments is over a threshold if number_of_comments &gt; MIN_COMMENTS: # Add the future to the registry task_registry.append(asyncio.ensure_future(log_post(response))) return number_of_comments # (... ommitted code ...) # if __name__ == '__main__': args = parser.parse_args() if args.verbose: log.setLevel(logging.DEBUG) post_id = id_from_HN_url(args.url) if args.url else args.id loop = asyncio.get_event_loop() task_registry = [] # define our task registry with aiohttp.ClientSession(loop=loop) as session: now = datetime.now() comments = loop.run_until_complete( post_number_of_comments(loop, session, post_id)) log.info( '&gt; Calculating comments took {:.2f} seconds and {} fetches'.format( (datetime.now() - now).total_seconds(), fetch_counter)) log.info("-- Post {} has {} comments".format(post_id, comments)) pending_tasks = [task for task in task_registry if not task.done()] loop.run_until_complete(asyncio.gather(*pending_tasks)) loop.close()</span></span></code> </pre> <br><pre> <code class="hljs css"><span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:53:46]</span></span> &gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">Calculating</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">comments</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">took</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.68</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">seconds</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">and</span></span> 73 <span class="hljs-selector-tag"><span class="hljs-selector-tag">fetches</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:53:46]</span></span> — <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> 8863 <span class="hljs-selector-tag"><span class="hljs-selector-tag">has</span></span> 72 <span class="hljs-selector-tag"><span class="hljs-selector-tag">comments</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:53:46]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logged</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:53:48]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logged</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:53:49]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logged</span></span></code> </pre> <br><p>  Aprendemos a lição a seguir - o <em>assíncio</em> não deve ser visto como uma fila de tarefas distribuída como o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><em>Aipo</em></a> .  Todas as tarefas são iniciadas em um encadeamento e o ciclo de eventos deve ser gerenciado adequadamente, permitindo que você aloque tempo para concluir as tarefas. </p><br><p>  O que leva a outro padrão geralmente aceito: </p><br><h2 id="periodicheski-zapuskaemye-korutiny">  Corotinas acionadas periodicamente </h2><br><p>  Continuando com nosso exemplo sobre HN (e fizemos um ótimo trabalho anteriormente), decidimos <br>  o que é decisivamente importante para calcular o número de comentários na publicação HN assim que estiverem disponíveis e enquanto estiverem na lista de 5 entradas recentes. </p><br><p>  Uma rápida olhada na API do HN mostra um ponto de extremidade que retorna os últimos 500 registros.  Ótimo, então podemos simplesmente pesquisar esse endpoint para receber novas publicações e calcular o número de comentários sobre elas, digamos a cada cinco segundos. </p><br><p>  Bem, como agora estamos migrando para a pesquisa periódica, podemos simplesmente usar o loop <em>while</em> infinito, aguardar a conclusão da tarefa de pesquisa (chamada em <em>espera</em> ) e <em>adormecer</em> (chamada em <em>espera</em> ) pelo tempo necessário.  Fiz algumas pequenas alterações para obter as principais entradas em vez de usar o URL da postagem direta. </p><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">""" An example of periodically scheduling coroutines using an infinite loop of awaiting and sleeping. """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> argparse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> logging <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> aiohttp <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> async_timeout LOGGER_FORMAT = <span class="hljs-string"><span class="hljs-string">'%(asctime)s %(message)s'</span></span> URL_TEMPLATE = <span class="hljs-string"><span class="hljs-string">"https://hacker-news.firebaseio.com/v0/item/{}.json"</span></span> TOP_STORIES_URL = <span class="hljs-string"><span class="hljs-string">"https://hacker-news.firebaseio.com/v0/topstories.json"</span></span> FETCH_TIMEOUT = <span class="hljs-number"><span class="hljs-number">10</span></span> parser = argparse.ArgumentParser(description=<span class="hljs-string"><span class="hljs-string">'Calculate the number of comments of the top stories in HN.'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--period'</span></span>, type=int, default=<span class="hljs-number"><span class="hljs-number">5</span></span>, help=<span class="hljs-string"><span class="hljs-string">'Number of seconds between poll'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--limit'</span></span>, type=int, default=<span class="hljs-number"><span class="hljs-number">5</span></span>,help=<span class="hljs-string"><span class="hljs-string">'Number of new stories to calculate comments for'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--verbose'</span></span>, action=<span class="hljs-string"><span class="hljs-string">'store_true'</span></span>, help=<span class="hljs-string"><span class="hljs-string">'Detailed output'</span></span>) logging.basicConfig(format=LOGGER_FORMAT, datefmt=<span class="hljs-string"><span class="hljs-string">'[%H:%M:%S]'</span></span>) log = logging.getLogger() log.setLevel(logging.INFO) fetch_counter = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(session, url)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  URL   aiohttp,    JSON .     aiohttp    . """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> fetch_counter <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> async_timeout.timeout(FETCH_TIMEOUT): fetch_counter += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> session.get(url) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> response: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> response.json() <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post_number_of_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, post_id)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""          . """</span></span> url = URL_TEMPLATE.format(post_id) response = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fetch(session, url) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'kids'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> response: <span class="hljs-comment"><span class="hljs-comment"># base case, there are no comments return 0 #     ,    (  ) number_of_comments = len(response['kids']) #       tasks = [post_number_of_comments( loop, session, kid_id) for kid_id in response['kids']] #      results = await asyncio.gather(*tasks) #            number_of_comments += sum(results) log.debug('{:^6} &gt; {} comments'.format(post_id, number_of_comments)) return number_of_comments async def get_comments_of_top_stories(loop, session, limit, iteration): """     HN. """ response = await fetch(session, TOP_STORIES_URL) tasks = [post_number_of_comments(loop, session, post_id) for post_id in response[:limit]] results = await asyncio.gather(*tasks) for post_id, num_comments in zip(response[:limit], results): log.info("Post {} has {} comments ({})".format(post_id, num_comments, iteration)) async def poll_top_stories_for_comments(loop, session, period, limit): """         . """ global fetch_counter iteration = 1 while True: now = datetime.now() log.info("Calculating comments for top {} stories. ({})".format(limit, iteration)) await get_comments_of_top_stories(loop, session, limit, iteration) log.info('&gt; Calculating comments took {:.2f} seconds and {} fetches'.format( (datetime.now() - now).total_seconds(), fetch_counter)) log.info("Waiting for {} seconds...".format(period)) iteration += 1 fetch_counter = 0 await asyncio.sleep(period) if __name__ == '__main__': args = parser.parse_args() if args.verbose: log.setLevel(logging.DEBUG) loop = asyncio.get_event_loop() with aiohttp.ClientSession(loop=loop) as session: loop.run_until_complete( poll_top_stories_for_comments( loop, session, args.period, args.limit)) loop.close()</span></span></code> </pre> <br><pre> <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>] Calculating comments <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> top <span class="hljs-number"><span class="hljs-number">5</span></span> stories. (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>] Post <span class="hljs-number"><span class="hljs-number">13848196</span></span> has <span class="hljs-number"><span class="hljs-number">31</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849430</span></span> has <span class="hljs-number"><span class="hljs-number">37</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849037</span></span> has <span class="hljs-number"><span class="hljs-number">15</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>] Post <span class="hljs-number"><span class="hljs-number">13845337</span></span> has <span class="hljs-number"><span class="hljs-number">128</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>] Post <span class="hljs-number"><span class="hljs-number">13847465</span></span> has <span class="hljs-number"><span class="hljs-number">27</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>] &gt; Calculating comments took <span class="hljs-number"><span class="hljs-number">2.96</span></span> seconds and <span class="hljs-number"><span class="hljs-number">244</span></span> fetches [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> seconds… [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span>] Calculating comments <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> top <span class="hljs-number"><span class="hljs-number">5</span></span> stories. (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>] Post <span class="hljs-number"><span class="hljs-number">13848196</span></span> has <span class="hljs-number"><span class="hljs-number">31</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849430</span></span> has <span class="hljs-number"><span class="hljs-number">37</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849037</span></span> has <span class="hljs-number"><span class="hljs-number">15</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>] Post <span class="hljs-number"><span class="hljs-number">13845337</span></span> has <span class="hljs-number"><span class="hljs-number">128</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>] Post <span class="hljs-number"><span class="hljs-number">13847465</span></span> has <span class="hljs-number"><span class="hljs-number">27</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>] &gt; Calculating comments took <span class="hljs-number"><span class="hljs-number">3.04</span></span> seconds and <span class="hljs-number"><span class="hljs-number">244</span></span> fetches [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> seconds…</code> </pre> <br><p>  Ótimo, mas há um pequeno problema: se você prestou atenção ao carimbo de hora, <br>  a tarefa não inicia estritamente a cada 5 segundos, é iniciada 5 segundos <strong><em>após</em></strong> a <strong><em>conclusão de get_comments_of_top_stories</em></strong> .  Novamente, as conseqüências do uso <em>aguardam</em> e bloqueiam até recuperarmos nossos resultados. <br>  Esses recursos não representam um problema quando a tarefa leva mais de cinco segundos.  Além disso, parece incorreto usar _run_until <em>complete</em> quando a corotina é projetada para ser infinita. </p><br><p>  A boa notícia é que agora somos especialistas em <em>sure_future</em> , e podemos simplesmente <em>inseri-</em> lo no código em vez de <em>esperar</em> ... </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">poll_top_stories_for_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, period, limit)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""         . """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> fetch_counter iteration = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: now = datetime.now() log.info(<span class="hljs-string"><span class="hljs-string">"Calculating comments for top {} stories. ({})"</span></span>.format( limit, iteration)) asyncio.ensure_future( get_comments_of_top_stories(loop, session, limit, iteration)) log.info( <span class="hljs-string"><span class="hljs-string">'&gt; Calculating comments took {:.2f} seconds and {} fetches'</span></span>.format( (datetime.now() - now).total_seconds(), fetch_counter)) log.info(<span class="hljs-string"><span class="hljs-string">"Waiting for {} seconds..."</span></span>.format(period)) iteration += <span class="hljs-number"><span class="hljs-number">1</span></span> fetch_counter = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(period)</code> </pre><br><pre> <code class="hljs powershell"> [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">40</span></span>] Calculating comments <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> top <span class="hljs-number"><span class="hljs-number">5</span></span> stories. (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">40</span></span>] &gt; Calculating comments took <span class="hljs-number"><span class="hljs-number">0.00</span></span> seconds and <span class="hljs-number"><span class="hljs-number">0</span></span> fetches [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">40</span></span>] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> seconds… [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13848196</span></span> has <span class="hljs-number"><span class="hljs-number">32</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849430</span></span> has <span class="hljs-number"><span class="hljs-number">48</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849037</span></span> has <span class="hljs-number"><span class="hljs-number">16</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13845337</span></span> has <span class="hljs-number"><span class="hljs-number">129</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13847465</span></span> has <span class="hljs-number"><span class="hljs-number">29</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span>] Calculating comments <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> top <span class="hljs-number"><span class="hljs-number">5</span></span> stories. (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span>] &gt; Calculating comments took <span class="hljs-number"><span class="hljs-number">0.00</span></span> seconds and <span class="hljs-number"><span class="hljs-number">260</span></span> fetches [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span>] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> seconds… [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>] Post <span class="hljs-number"><span class="hljs-number">13848196</span></span> has <span class="hljs-number"><span class="hljs-number">32</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849430</span></span> has <span class="hljs-number"><span class="hljs-number">48</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849037</span></span> has <span class="hljs-number"><span class="hljs-number">16</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>] Post <span class="hljs-number"><span class="hljs-number">13845337</span></span> has <span class="hljs-number"><span class="hljs-number">129</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>] Post <span class="hljs-number"><span class="hljs-number">13847465</span></span> has <span class="hljs-number"><span class="hljs-number">29</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>)</code> </pre> <br><p>  Ahem ... Ok, a boa notícia é que o registro de data e hora está localizado exatamente cinco segundos depois, mas o que há em 0,00 segundos e nenhuma amostra? E a próxima iteração leva zero segundos e 260 amostras? </p><br><p>  Essa é uma das conseqüências de evitar a espera, agora não bloqueamos mais a rotina e simplesmente passamos para a próxima linha, que imprime zero segundos e, pela primeira vez, zero mensagens recuperadas.  Essas são tarefas muito pequenas, pois podemos viver sem mensagens, mas e se precisarmos de resultados de tarefas? </p><br><p>  Então, meu amigo, precisamos recorrer a ... retornos de chamada (encolhendo ((()) </p><br><p>  Eu sei, eu sei, o ponto principal da corotina é evitar retornos de chamada, mas isso ocorre porque o subtítulo dramático do artigo é "Fora de espera".  Não estamos mais <em>aguardando</em> território, temos aventuras com o lançamento manual de tarefas, o que leva ao nosso caso de uso.  O que isso te dá?  <abbr title="não é tão ruim">spoiler</abbr> </p><br><p>  Como discutimos anteriormente, <em>assegure_futura</em> retorna um objeto <em>Future</em> ao qual podemos adicionar um retorno de chamada usando o <em>retorno de chamada</em> _add_done. </p><br><p>  Antes de fazer isso, e para obter as buscas corretas, chegamos ao ponto em que precisamos encapsular nossa rotina de extração na classe <em>URLFetcher</em> .  Nesse caso, criamos uma instância para cada tarefa, para que tenhamos a contagem correta de amostras.  Também removemos a variável global que introduziu o bug de qualquer maneira: </p><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">"""               ensure_future   sleep.      future,    ensure_future,         ,    URLFetcher   . """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> argparse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> logging <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> aiohttp <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> async_timeout LOGGER_FORMAT = <span class="hljs-string"><span class="hljs-string">'%(asctime)s %(message)s'</span></span> URL_TEMPLATE = <span class="hljs-string"><span class="hljs-string">"https://hacker-news.firebaseio.com/v0/item/{}.json"</span></span> TOP_STORIES_URL = <span class="hljs-string"><span class="hljs-string">"https://hacker-news.firebaseio.com/v0/topstories.json"</span></span> FETCH_TIMEOUT = <span class="hljs-number"><span class="hljs-number">10</span></span> parser = argparse.ArgumentParser(description=<span class="hljs-string"><span class="hljs-string">'Calculate the number of comments of the top stories in HN.'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--period'</span></span>, type=int, default=<span class="hljs-number"><span class="hljs-number">5</span></span>, help=<span class="hljs-string"><span class="hljs-string">'Number of seconds between poll'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--limit'</span></span>, type=int, default=<span class="hljs-number"><span class="hljs-number">5</span></span>, help=<span class="hljs-string"><span class="hljs-string">'Number of new stories to calculate comments for'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--verbose'</span></span>, action=<span class="hljs-string"><span class="hljs-string">'store_true'</span></span>, help=<span class="hljs-string"><span class="hljs-string">'Detailed output'</span></span>) logging.basicConfig(format=LOGGER_FORMAT, datefmt=<span class="hljs-string"><span class="hljs-string">'[%H:%M:%S]'</span></span>) log = logging.getLogger() log.setLevel(logging.INFO) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">URLFetcher</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   URL     """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.fetch_counter = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, session, url)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  URL   aiohttp,    JSON .     aiohttp    . """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> async_timeout.timeout(FETCH_TIMEOUT): self.fetch_counter += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> session.get(url) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> response: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> response.json() <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post_number_of_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, fetcher, post_id)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""          . """</span></span> url = URL_TEMPLATE.format(post_id) response = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fetcher.fetch(session, url) <span class="hljs-comment"><span class="hljs-comment">#  .  . if response is None or 'kids' not in response: return 0 #     ,    (  ) number_of_comments = len(response['kids']) #       tasks = [post_number_of_comments( loop, session, fetcher, kid_id) for kid_id in response['kids']] # s     results = await asyncio.gather(*tasks) #            number_of_comments += sum(results) log.debug('{:^6} &gt; {} comments'.format(post_id, number_of_comments)) return number_of_comments async def get_comments_of_top_stories(loop, session, limit, iteration): """    HN. """ fetcher = URLFetcher() # create a new fetcher for this task response = await fetcher.fetch(session, TOP_STORIES_URL) tasks = [post_number_of_comments( loop, session, fetcher, post_id) for post_id in response[:limit]] results = await asyncio.gather(*tasks) for post_id, num_comments in zip(response[:limit], results): log.info("Post {} has {} comments ({})".format( post_id, num_comments, iteration)) return fetcher.fetch_counter # return the fetch count async def poll_top_stories_for_comments(loop, session, period, limit): """         . """ iteration = 1 while True: log.info("Calculating comments for top {} stories. ({})".format(limit, iteration)) future = asyncio.ensure_future(get_comments_of_top_stories(loop, session, limit, iteration)) now = datetime.now() def callback(fut): fetch_count = fut.result() log.info('&gt; Calculating comments took {:.2f} seconds and {} fetches'.format( (datetime.now() - now).total_seconds(), fetch_count)) future.add_done_callback(callback) log.info("Waiting for {} seconds...".format(period)) iteration += 1 await asyncio.sleep(period) if __name__ == '__main__': args = parser.parse_args() if args.verbose: log.setLevel(logging.DEBUG) loop = asyncio.get_event_loop() with aiohttp.ClientSession(loop=loop) as session: loop.run_until_complete( poll_top_stories_for_comments( loop, session, args.period, args.limit)) loop.close()</span></span></code> </pre> <br><pre> <code class="hljs powershell"> [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">40</span></span>] Calculating comments <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> top <span class="hljs-number"><span class="hljs-number">5</span></span> stories. (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">40</span></span>] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> seconds... [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13848196</span></span> has <span class="hljs-number"><span class="hljs-number">38</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849430</span></span> has <span class="hljs-number"><span class="hljs-number">72</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849037</span></span> has <span class="hljs-number"><span class="hljs-number">19</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13848283</span></span> has <span class="hljs-number"><span class="hljs-number">64</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13847465</span></span> has <span class="hljs-number"><span class="hljs-number">34</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] &gt; Calculating comments took <span class="hljs-number"><span class="hljs-number">3.17</span></span> seconds and <span class="hljs-number"><span class="hljs-number">233</span></span> fetches [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span>] Calculating comments <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> top <span class="hljs-number"><span class="hljs-number">5</span></span> stories. (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span>] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> seconds... [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>] Post <span class="hljs-number"><span class="hljs-number">13848196</span></span> has <span class="hljs-number"><span class="hljs-number">38</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849430</span></span> has <span class="hljs-number"><span class="hljs-number">72</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849037</span></span> has <span class="hljs-number"><span class="hljs-number">19</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>] Post <span class="hljs-number"><span class="hljs-number">13848283</span></span> has <span class="hljs-number"><span class="hljs-number">64</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>] Post <span class="hljs-number"><span class="hljs-number">13847465</span></span> has <span class="hljs-number"><span class="hljs-number">34</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>] &gt; Calculating comments took <span class="hljs-number"><span class="hljs-number">2.47</span></span> seconds and <span class="hljs-number"><span class="hljs-number">233</span></span> fetches [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span>] Calculating comments <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> top <span class="hljs-number"><span class="hljs-number">5</span></span> stories. (<span class="hljs-number"><span class="hljs-number">3</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span>] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> seconds...</code> </pre> <br><p> ,  ,      callback: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">poll_top_stories_for_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, period, limit)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""         . """</span></span> iteration = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: log.info(<span class="hljs-string"><span class="hljs-string">"Calculating comments for top {} stories. ({})"</span></span>.format( limit, iteration)) future = asyncio.ensure_future( get_comments_of_top_stories(loop, session, limit, iteration)) now = datetime.now() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(fut)</span></span></span><span class="hljs-function">:</span></span> fetch_count = fut.result() log.info( <span class="hljs-string"><span class="hljs-string">'&gt; Calculating comments took {:.2f} seconds and {} fetches'</span></span>.format( (datetime.now() - now).total_seconds(), fetch_count)) future.add_done_callback(callback) log.info(<span class="hljs-string"><span class="hljs-string">"Waiting for {} seconds..."</span></span>.format(period)) iteration += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(period)</code> </pre><br><p>    ,  <em>callback</em> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">    ,      future.</a>     (fetch)   <em>URLFetcher</em>   _get_comments_of_top <em>stories</em>       future. </p><br><p>  Está vendo?   ,    ,     <em>await</em> . </p><br><p>    callback-,      API asyncio       <em>AbstractBaseLoop</em>   _call <em>later</em>  _call <em>at</em> , <br>    -     .    ,   ,       <em>poll_top_stories_for_comments</em> : </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">poll_top_stories_for_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, period, limit, iteration=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""     get_comments_of_top_stories. """</span></span> log.info(<span class="hljs-string"><span class="hljs-string">"Calculating comments for top {} stories ({})"</span></span>.format( limit, iteration)) future = asyncio.ensure_future( get_comments_of_top_stories(loop, session, limit, iteration)) now = datetime.now() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(fut)</span></span></span><span class="hljs-function">:</span></span> fetch_count = fut.result() log.info( <span class="hljs-string"><span class="hljs-string">'&gt; Calculating comments took {:.2f} seconds and {} fetches'</span></span>.format( (datetime.now() - now).total_seconds(), fetch_count)) future.add_done_callback(callback) log.info(<span class="hljs-string"><span class="hljs-string">"Waiting for {} seconds..."</span></span>.format(period)) iteration += <span class="hljs-number"><span class="hljs-number">1</span></span> loop.call_later( period, partial( <span class="hljs-comment"><span class="hljs-comment"># or call_at(loop.time() + period) poll_top_stories_for_comments, loop, session, period, limit, iteration ) ) if __name__ == '__main__': args = parser.parse_args() if args.verbose: log.setLevel(logging.DEBUG) loop = asyncio.get_event_loop() with aiohttp.ClientSession(loop=loop) as session: poll_top_stories_for_comments( loop, session, args.period, args.limit) loop.run_forever() loop.close()</span></span></code> </pre><br><p>    .     : </p><br><ul><li>              ,     <em>ensure_future</em>     . <br> ( :   ) </li><li>  _poll_top_stories_for <em>comments</em>       ,     ,      _run <em>forever</em>  ,     . </li></ul><br><p> ,      , ,     —      ?      ?           URL: </p><br><pre> <code class="python hljs">MAXIMUM_FETCHES = <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">URLFetcher</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   URL     """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.fetch_counter = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, session, url)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  URL   aiohttp,    JSON .     aiohttp    . """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> async_timeout.timeout(FETCH_TIMEOUT): self.fetch_counter += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.fetch_counter &gt; MAXIMUM_FETCHES: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> Exception(<span class="hljs-string"><span class="hljs-string">'BOOM!'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> session.get(url) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> response: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> response.json()</code> </pre><br><pre> <code class="hljs pgsql"> [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">51</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>] Calculating comments <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> top <span class="hljs-number"><span class="hljs-number">5</span></span> stories. (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">51</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> seconds… [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">51</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> callback poll_top_stories_for_comments.&lt;locals&gt;.callback(&lt;Task finishe…ion(<span class="hljs-string"><span class="hljs-string">'BOOM!'</span></span>,)&gt;) at <span class="hljs-number"><span class="hljs-number">05</span></span>_periodic_coroutines.py:<span class="hljs-number"><span class="hljs-number">121</span></span> handle: &lt;Handle poll_top_stories_for_comments.&lt;locals&gt;.callback(&lt;Task finishe…ion(<span class="hljs-string"><span class="hljs-string">'BOOM!'</span></span>,)&gt;) at <span class="hljs-number"><span class="hljs-number">05</span></span>_periodic_coroutines.py:<span class="hljs-number"><span class="hljs-number">121</span></span>&gt; Traceback (most recent <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> last): File “/Users/yeray/.pyenv/versions/<span class="hljs-number"><span class="hljs-number">3.6</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/lib/python3<span class="hljs-number"><span class="hljs-number">.6</span></span>/asyncio/events.py”, <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">126</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _run self._callback(*self._args) File “<span class="hljs-number"><span class="hljs-number">05</span></span>_periodic_coroutines.py”, <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">122</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> callback fetch_count = fut.result() File “<span class="hljs-number"><span class="hljs-number">05</span></span>_periodic_coroutines.py”, <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> get_comments_of_top_stories results = await asyncio.gather(*tasks) File “<span class="hljs-number"><span class="hljs-number">05</span></span>_periodic_coroutines.py”, <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">69</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> post_number_of_comments response = await fetcher.<span class="hljs-keyword"><span class="hljs-keyword">fetch</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">session</span></span>, url) File “<span class="hljs-number"><span class="hljs-number">05</span></span>_periodic_coroutines.py”, <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">58</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fetch</span></span> <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'BOOM!'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>: BOOM! [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">51</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>] Calculating comments <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> top <span class="hljs-number"><span class="hljs-number">5</span></span> stories. (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">51</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> seconds…</code> </pre> <br><p>   , ? </p><br><p>  O que fazer      ,    ,          : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> asyncio :   </a> </p><cut></cut></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt420129/">https://habr.com/ru/post/pt420129/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt420117/index.html">Guia de filas simples no Mikrotik</a></li>
<li><a href="../pt420119/index.html">10 frameworks web Python com os quais vale a pena trabalhar em 2018</a></li>
<li><a href="../pt420121/index.html">Teste de força: Cupim LT450, LXI</a></li>
<li><a href="../pt420123/index.html">O que é realmente o Node.js?</a></li>
<li><a href="../pt420125/index.html">Automação em finanças: funcionários bancários podem ficar sem trabalho devido a robôs</a></li>
<li><a href="../pt420131/index.html">Método Probabilístico de Mineração de Bitcoin</a></li>
<li><a href="../pt420133/index.html">Modelagem de sistemas dinâmicos: como a lua se move?</a></li>
<li><a href="../pt420135/index.html">Isso também é Toshiba: produtos inesperados da corporação japonesa</a></li>
<li><a href="../pt420139/index.html">Livro “Site Confiabilidade Engenharia. Confiabilidade e confiabilidade como no Google »</a></li>
<li><a href="../pt420141/index.html">No MPP DBMS carregado - peppy Data Lake com ferramentas analíticas: compartilhe os detalhes da criação</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>