<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö¥üèø ‚úùÔ∏è üë©‚Äçüöí Sur la question de la vitesse et de sa mesure en Arduino üï∞Ô∏è üò≤ üöÜ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ce probl√®me est survenu dans l'√©tude des performances d'Arduino lors de l'ex√©cution de diverses commandes (plus √† ce sujet dans un article s√©par√©). Au...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sur la question de la vitesse et de sa mesure en Arduino</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/426941/"><img src="https://habrastorage.org/webt/kx/oe/cl/kxoecl7ngezzej1ftzcleeswzde.jpeg"><br><br>  Ce probl√®me est survenu dans l'√©tude des performances d'Arduino lors de l'ex√©cution de diverses commandes (plus √† ce sujet dans un article s√©par√©).  Au cours de l'√©tude, des doutes sont apparus quant √† la constance du temps de travail des commandes individuelles lorsque la valeur des op√©randes a chang√© (comme il s'est av√©r√© plus tard, pas d√©raisonnable) et il a √©t√© d√©cid√© d'essayer d'estimer le temps d'ex√©cution d'une commande distincte.  Pour cela, un petit programme a √©t√© √©crit (qui a dit que le sketch devait quitter la classe), ce qui, √† premi√®re vue, a confirm√© l'hypoth√®se.  En conclusion, vous pouvez observer les valeurs 16 et 20, mais parfois 28 et m√™me 32 microsecondes sont trouv√©es.  Si nous multiplions les donn√©es re√ßues par 16 (fr√©quence d'horloge MK), nous obtenons le temps d'ex√©cution en cycles MK (de 256 √† 512).  Malheureusement, une ex√©cution r√©p√©t√©e du cycle de programme principal (avec les m√™mes donn√©es initiales), tout en conservant l'image globale, donne d√©j√† une distribution diff√©rente du temps d'ex√©cution, de sorte que les variations de temps r√©elles ne sont pas li√©es aux donn√©es initiales.  L'hypoth√®se d'origine est r√©fut√©e, mais elle devient int√©ressante, et ce qui est exactement associ√© √† une telle dispersion significative. <br><a name="habracut"></a><br>  Remarque n√©cessaire - Je comprends tr√®s bien que des programmes plus sophistiqu√©s devraient √™tre utilis√©s pour mesurer le temps d'ex√©cution des commandes, mais pour une estimation approximative, celui qui sera d√©montr√© plus tard est tout √† fait suffisant. <br><br>  Donc, le temps change, et de mani√®re tr√®s significative, nous recherchons les causes de ce ph√©nom√®ne.  Tout d'abord, nous pr√™tons attention √† la multiplicit√© des valeurs obtenues, regardons la description de la biblioth√®que de travail au fil du temps et voyons que 4¬µsec est un quantum de mesure, il est donc pr√©f√©rable d'aller aux quanta et de comprendre que nous obtenons 4 ou 5 (tr√®s souvent) et 6 ou 7 ou 8 unit√©s (tr√®s rares).  Avec la premi√®re moiti√©, tout est facile - si la valeur mesur√©e se situe entre 4 et 5 unit√©s, alors la dispersion devient in√©vitable.  De plus, en consid√©rant les √©chantillons comme ind√©pendants, nous pouvons augmenter la pr√©cision de mesure par des m√©thodes statistiques, ce que nous faisons, en obtenant des r√©sultats acceptables. <br><br>  Mais avec la seconde moiti√© (6,7,8), les choses sont pires.  Nous avons constat√© que la dispersion n'est pas corr√©l√©e avec les donn√©es source, ce qui signifie qu'il s'agit d'une manifestation d'autres processus qui affectent le temps d'ex√©cution des commandes.  Il est √† noter que les √©missions sont plut√¥t rares et ne montrent pas d'effet significatif sur la valeur moyenne calcul√©e.  Il serait possible de les n√©gliger du tout, mais ce n'est pas notre style.  En g√©n√©ral, au cours des ann√©es de travail en ing√©nierie, j'ai r√©alis√© que vous ne pouvez pas laisser de malentendus, aussi insignifiants soient-ils, car ils ont une capacit√© d√©go√ªtante de battre dans le dos (enfin, ou o√π ils atteignent) au moment le plus inopportun. <br><br>  Nous commen√ßons √† √©mettre l' <b>hypoth√®se 1</b> - la plus pratique (en termes de commodit√© et de polyvalence, elle est juste derri√®re l'intervention directe du Cr√©ateur) - les probl√®mes logiciels, bien s√ªr, pas les miens, mes programmes ne manquent jamais, mais les biblioth√®ques connect√©es (compilateur, syst√®me d'exploitation, navigateur, etc. - remplacer le n√©cessaire).  De plus, puisque <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">j'ex√©cute</a> le programme dans l'√©mulateur sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">www.tinkercad.com</a> , vous pouvez toujours vous r√©f√©rer aux bogues de l'√©mulateur et fermer le sujet, car le code source n'est pas disponible pour nous.  Inconv√©nients de cette hypoth√®se: <br><br><ol><li>  De cycle en cycle, l'emplacement des √©carts change, ce qui laisse entendre. </li><li>  Ce site prend toujours en charge AutoDesk, bien que l'argument soit plut√¥t faible. </li><li>  "Nous avons accept√© le postulat que ce qui se passe n'est pas une hallucination, sinon ce serait tout simplement inint√©ressant." </li></ol><br>  L'hypoth√®se suivante est l'influence de certains processus d'arri√®re-plan sur le r√©sultat de la mesure.  Nous ne semblons rien faire d'autre que croire, cependant ... nous produisons les r√©sultats en s√©rie.  <b>L'hypoth√®se 2</b> se pose - le temps de sortie est parfois (aussi √©trange que √ßa ... mais √ßa arrive) est ajout√© au temps d'ex√©cution de la commande.  Bien qu'il soit douteux de savoir combien cette sortie est l√†, mais de toute fa√ßon - l'ajout de Flush n'a pas aid√©, l'ajout d'un d√©lai pour terminer la sortie et cela n'a pas aid√©, ce qui a g√©n√©ralement fait sortir la sortie de la boucle - de toute fa√ßon, le temps saute - ce n'est certainement pas Serial. <br><br>  Eh bien, ce qui reste, c'est l'organisation du cycle lui-m√™me (d'o√π l'effroi de changer sa dur√©e, ce n'est pas clair) et c'est tout ... bien que micros () soit rest√©.  Je voulais dire que le temps d'ex√©cution du premier appel de cette fonction et du second est le m√™me et lorsque je soustrais ces deux valeurs, j'obtiens z√©ro, mais si cette hypoth√®se est fausse? <br><br>  Hypoth√®se 3 - parfois le deuxi√®me appel du d√©compte du temps prend plus de temps que le premier, ou les actions associ√©es au d√©compte du temps affectent parfois le r√©sultat.  Nous regardons le code source de la fonction de travail avec le temps (arduino-1.8.4 \ hardware \ arduino \ avr \ cores \ arduino \ c√¢blage.c - j'ai exprim√© √† plusieurs reprises mon attitude envers de telles choses, je ne me r√©p√©terai pas) et nous voyons que 1 fois sur 256 les cycles d'augmentation mat√©rielle de la partie la plus jeune du compteur sont interrompus pour incr√©menter la partie la plus ancienne du compteur. <br><br>  Notre temps d'ex√©cution de cycle est de 4 √† 5, nous pouvons donc nous attendre √† 170 * (4..5) / 256 = de trois √† quatre valeurs anormales dans un segment de 170 mesures.  Nous regardons - cela ressemble beaucoup, il y en a vraiment 4.  Pour s√©parer les premi√®re et deuxi√®me raisons, nous effectuons des calculs par la section critique avec des interruptions interdites.  Le r√©sultat ne change pas grand-chose, les √©missions ont encore leur place, ce qui signifie que du temps suppl√©mentaire est apport√© par les micros ().  Ici, nous ne pouvons rien faire, bien que le code source soit disponible, nous ne pouvons pas le changer - les biblioth√®ques sont incluses dans les binaires.  Bien s√ªr, nous pouvons √©crire nos propres fonctions de travail avec le temps et surveiller leur comportement, mais il existe un moyen plus simple. <br><br>  √âtant donn√© qu'une raison possible de l'augmentation de la dur√©e est le traitement d'interruption ¬´longue¬ª, nous excluons la possibilit√© de son apparition pendant le processus de mesure.  Pour ce faire, attendez sa manifestation et ce n'est qu'ensuite que nous effectuons un cycle de mesure.  Comme l'interruption se produit beaucoup moins souvent que notre cycle de mesure ne dure, nous pouvons garantir son absence.  Nous √©crivons le fragment correspondant du programme (en utilisant <s>des hacks sales avec des</s> informations extraites du code source) et, ¬´c'est une telle magie de la rue¬ª, tout devient normal - nous mesurons le temps d'ex√©cution de 4 et 5 quanta avec une valeur moyenne du temps d'ex√©cution de l'op√©ration d'addition avec PT de 166 cycles d'horloge, qui correspond √† la valeur pr√©c√©demment mesur√©e.  L'hypoth√®se peut √™tre consid√©r√©e comme confirm√©e. <br><br>  Une derni√®re question demeure - et qu'est-ce qui prend si longtemps dans les interruptions, que faut-il <br>  (7.8) - (5) ~ 2 quanta = * 4 = 8 msec * 16 = 128 cycles de processeur?  Nous nous tournons vers le code source (c'est-√†-dire le code assembleur g√©n√©r√© par le compilateur sur godbolt.com) et nous voyons que l'interruption elle-m√™me est ex√©cut√©e environ 70 cycles, 60 d'entre eux en permanence, et lors de la lecture, il y a des co√ªts suppl√©mentaires de 10 cycles, 70 au total lorsque frapp√© interruption - moins que re√ßue, mais assez proche.  Nous attribuons la diff√©rence √† la diff√©rence entre les compilateurs ou les modes d'utilisation. <br><br>  Eh bien, nous pouvons maintenant mesurer le temps d'ex√©cution r√©el de la commande d'addition PT avec divers arguments et nous assurer qu'il change vraiment beaucoup lorsque les arguments changent: de 136 mesures pour 0,0 √† 190 pour 0,63 (nombre magique), et ce n'est que 162 pour 10,63.  Avec une probabilit√© de 99,9%, cela est d√ª au besoin d'alignement et aux caract√©ristiques de sa mise en ≈ìuvre dans cette biblioth√®que particuli√®re, mais cette √©tude d√©passe clairement la port√©e du probl√®me consid√©r√©. <br><br><div class="spoiler">  <b class="spoiler_title">Annexe - texte du programme:</b> <div class="spoiler_text"><pre><code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">void</span></span> setup() { <span class="hljs-type"><span class="hljs-type">Serial</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>(<span class="hljs-number"><span class="hljs-number">9600</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-type"><span class="hljs-type">float</span></span> t; //   <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>() { <span class="hljs-type"><span class="hljs-type">int</span></span> d[<span class="hljs-number"><span class="hljs-number">170</span></span>]; unsigned long <span class="hljs-type"><span class="hljs-type">time</span></span>,time1; <span class="hljs-type"><span class="hljs-type">float</span></span> dt=<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">170.</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;<span class="hljs-number"><span class="hljs-number">170</span></span>; ++i) { { //       time1=micros(); long time2; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { time2=micros(); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((time2 &amp; ~<span class="hljs-number"><span class="hljs-number">0xFF</span></span>) == (time1 &amp; ~<span class="hljs-number"><span class="hljs-number">0xFF</span></span>)); }; <span class="hljs-comment"><span class="hljs-comment">/**/</span></span> time1=micros(); //   <span class="hljs-comment"><span class="hljs-comment">/* cli(); //       -   */</span></span> t=<span class="hljs-number"><span class="hljs-number">10.63</span></span>; //     t=t+dt; //   <span class="hljs-comment"><span class="hljs-comment">/* sei(); //    */</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span> = micros(); //   time1=<span class="hljs-type"><span class="hljs-type">time</span></span>-time1; d[i]=time1/<span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Serial.print(time1); //      Serial.flush(); //     Delay(20); //    */</span></span> }; //   ,     <span class="hljs-type"><span class="hljs-type">float</span></span> sum=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;<span class="hljs-number"><span class="hljs-number">170</span></span>; ++i) { sum+=d[i]; <span class="hljs-type"><span class="hljs-type">Serial</span></span>.println(d[i]); }; <span class="hljs-type"><span class="hljs-type">Serial</span></span>.println((sum/<span class="hljs-number"><span class="hljs-number">170</span></span><span class="hljs-number"><span class="hljs-number">-2.11</span></span>)*<span class="hljs-number"><span class="hljs-number">4</span></span>*<span class="hljs-number"><span class="hljs-number">16</span></span>); //<span class="hljs-number"><span class="hljs-number">2.11</span></span> ‚Äì     <span class="hljs-type"><span class="hljs-type">Serial</span></span>.flush(); //    ,     }</code> </pre> <br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr426941/">https://habr.com/ru/post/fr426941/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr426931/index.html">Comment partir travailler sur la C√¥te d'Azur et obtenir un passeport fran√ßais en 3 ans</a></li>
<li><a href="../fr426933/index.html">Conception frontale</a></li>
<li><a href="../fr426935/index.html">+10 r√®gles de code propre du d√©veloppeur Angular</a></li>
<li><a href="../fr426937/index.html">Les membres bioniques apprennent √† ouvrir la bi√®re</a></li>
<li><a href="../fr426939/index.html">Un √©tudiant dipl√¥m√© a r√©solu le probl√®me de la confirmation de l'informatique quantique</a></li>
<li><a href="../fr426943/index.html">La traduction russe la plus compl√®te du cours de programmation Harvard CS50 2015 2015, gratuite sur YouTube</a></li>
<li><a href="../fr426945/index.html">Ce que j'ai aim√© chez Paul Allen</a></li>
<li><a href="../fr426947/index.html">"Le diable m'a pouss√© √† aller travailler au bureau" - 10 questions au programmeur, 9√®me √©dition</a></li>
<li><a href="../fr426949/index.html">Recr√©ation du son THX Deep Note</a></li>
<li><a href="../fr426951/index.html">Altium Designer: que faire si un projet se complique?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>