<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üò° üßú üßëüèº HighLoad ++, Andrey Gushchin (Zabbix): alto rendimiento y partici√≥n nativa ü§∂ üìÆ üëõ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Veremos c√≥mo funciona Zabbix con la base de datos TimescaleDB como back-end. Mostramos c√≥mo comenzar desde cero y c√≥mo migrar con PostgreSQL. Tambi√©n ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>HighLoad ++, Andrey Gushchin (Zabbix): alto rendimiento y partici√≥n nativa</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/485470/"> Veremos c√≥mo funciona Zabbix con la base de datos TimescaleDB como back-end.  Mostramos c√≥mo comenzar desde cero y c√≥mo migrar con PostgreSQL.  Tambi√©n ofrecemos pruebas de rendimiento comparativas de las dos configuraciones. <br><br><img src="https://habrastorage.org/webt/h4/jl/nw/h4jlnwupm_dewx7jasafurn-ibm.jpeg"><br><br>  HighLoad ++ Siberia 2019. Tomsk Hall.  24 de junio, 16:00.  Res√∫menes y <a href="https://www.highload.ru/siberia/2019/abstracts/5390">presentaci√≥n</a> .  La pr√≥xima conferencia HighLoad ++ se llevar√° a cabo los d√≠as 6 y 7 de abril de 2020 en San Petersburgo.  Detalles y entradas <a href="http://bit.ly/2sSxgBx">aqu√≠</a> . <br><br>  <b>Andrey Gushchin (en adelante</b> , <b>AG):</b> - Soy un ingeniero de soporte t√©cnico de ZABBIX (en adelante, Zabbix), un entrenador.  He trabajado en soporte t√©cnico durante m√°s de 6 a√±os y me he enfrentado directamente con el rendimiento.  Hoy hablar√© sobre el rendimiento que TimescaleDB puede ofrecer en comparaci√≥n con el PostgreSQL 10. Tambi√©n, una parte introductoria sobre c√≥mo funciona. <a name="habracut"></a><br><br><h3>  Retos clave del rendimiento: de la recopilaci√≥n a la limpieza de datos </h3><br>  Para empezar, hay ciertos desaf√≠os de rendimiento que enfrenta todo sistema de monitoreo.  El primer desaf√≠o de rendimiento es la r√°pida recopilaci√≥n y procesamiento de datos. <br><br><img src="https://habrastorage.org/webt/jl/xr/hv/jlxrhv3huan1s0w4otmxoknifzy.jpeg"><br><br>  Un buen sistema de monitoreo debe recibir de manera oportuna y oportuna todos los datos, procesarlos de acuerdo con expresiones desencadenantes, es decir, procesarlos de acuerdo con algunos criterios (en diferentes sistemas es diferente) y guardarlos en la base de datos para usar estos datos en el futuro. <br><br><img src="https://habrastorage.org/webt/d5/vq/-l/d5vq-lgcwljaq50nc-zxfeugi3k.jpeg"><br><br>  El segundo desaf√≠o de rendimiento es mantener la historia.  Almacene en la base de datos con frecuencia y tenga acceso r√°pido y conveniente a estas m√©tricas que se recopilaron durante un per√≠odo de tiempo.  Lo m√°s importante es que es conveniente obtener estos datos, usarlos en informes, gr√°ficos, disparadores, en algunos valores de umbral, para alertas, etc. <br><br><img src="https://habrastorage.org/webt/k2/1l/3g/k21l3gg3vmeayv-d8oqpatgssv8.jpeg"><br><br>  El tercer desaf√≠o de rendimiento es aclarar la historia, es decir, cuando su d√≠a es tal que no necesita almacenar ninguna m√©trica detallada que se haya recopilado durante 5 a√±os (incluso meses o dos meses).  Algunos nodos de red se han eliminado, o algunos hosts, las m√©tricas ya no son necesarias porque ya est√°n desactualizadas y ya no se recopilan.  Todo esto debe limpiarse para que su base de datos no crezca a un tama√±o grande.  En general, borrar el historial suele ser una prueba seria para el almacenamiento; muy a menudo afecta el rendimiento. <br><br><h3>  ¬øC√≥mo resolver los problemas de almacenamiento en cach√©? </h3><br>  Ahora hablar√© espec√≠ficamente sobre el Zabbix.  En Zabbix, la primera y la segunda llamada se resuelven mediante el almacenamiento en cach√©. <br><br><img src="https://habrastorage.org/webt/mg/2b/tb/mg2btblcs3cxvlnddc0yg6lwxrw.jpeg"><br><br>  Recopilaci√≥n y procesamiento de datos: utilizamos RAM para almacenar todos estos datos.  Ahora estos datos se discutir√°n con m√°s detalle. <br><br>  Tambi√©n en el lado de la base de datos hay un cierto almacenamiento en cach√© para las muestras principales: para gr√°ficos, otras cosas. <br><br>  Almacenamiento en cach√© en el lado del servidor Zabbix: tenemos ConfigurationCache, ValueCache, HistoryCache, TrendsCache.  Que es esto <br><br><img src="https://habrastorage.org/webt/6j/4e/_a/6j4e_acyhx8ldzgjfziqhuzvwz0.jpeg"><br><br>  ConfigurationCache es el cach√© principal en el que almacenamos m√©tricas, hosts, elementos de datos, disparadores;  todo lo que necesita para procesar el preprocesamiento, recopilar datos, de qu√© hosts recopilar, con qu√© frecuencia.  Todo esto se almacena en ConfigurationCache, para no ir a la base de datos, para no crear solicitudes innecesarias.  Despu√©s de que se inicia el servidor, actualizamos este cach√© (crear) y lo actualizamos peri√≥dicamente (seg√∫n la configuraci√≥n). <br><br><img src="https://habrastorage.org/webt/q1/zc/dg/q1zcdgan2c5rcep47ebef24xrn0.jpeg"><br><br><h3>  Almacenamiento en cach√© en Zabbix.  Recogida de datos </h3><br>  Aqu√≠ el esquema es bastante grande: <br><br><img src="https://habrastorage.org/webt/88/mh/gd/88mhgd974zcj8eou8kghhodhwf0.jpeg"><br><br>  Los principales en el esquema son estos coleccionistas: <br><br><img src="https://habrastorage.org/webt/2y/co/f7/2ycof750qb71iooc2qiahs-5i9y.jpeg"><br><br>  Estos son los procesos de ensamblaje en s√≠, varios "encuestadores" responsables de los diferentes tipos de ensamblajes.  Recopilan datos a trav√©s de icmp, ipmi, de acuerdo con diferentes protocolos y los transfieren al preprocesamiento. <br><br><h3>  Historial de preprocesamiento </h3><br>  Adem√°s, si hemos calculado elementos de datos (qui√©n sabe Zabbix - sabe), es decir, elementos de datos agregados calculados, los tomamos directamente de ValueCache.  Sobre c√≥mo se llena, lo contar√© m√°s tarde.  Todos estos recopiladores usan ConfigurationCache para obtener sus trabajos y luego pasarlos al preprocesamiento. <br><br><img src="https://habrastorage.org/webt/b4/qb/mh/b4qbmhsqtxvrfli40n-espjba6c.jpeg"><br><br>  El preprocesamiento tambi√©n utiliza ConfigurationCache para obtener pasos de preprocesamiento; procesa estos datos de varias maneras.  A partir de la versi√≥n 4.2, la enviamos al proxy.  Esto es muy conveniente, porque el preprocesamiento en s√≠ mismo es una operaci√≥n bastante dif√≠cil.  Y si tiene un "Zabbix" muy grande, con una gran cantidad de elementos de datos y una alta frecuencia de recolecci√≥n, esto facilita enormemente el trabajo. <br><br>  En consecuencia, despu√©s de que procesamos estos datos de alguna manera utilizando el preprocesamiento, los guardamos en HistoryCache para procesarlos m√°s.  Esto finaliza la recopilaci√≥n de datos.  Pasamos al proceso principal. <br><br><h3>  Operaci√≥n de sincronizador de historia </h3><br><img src="https://habrastorage.org/webt/40/yj/9-/40yj9-h-hgm5wcd2hu2ygt5uyp4.jpeg"><br><br>  El proceso principal en Zabbix (ya que es una arquitectura monol√≠tica) es History Syncer.  Este es el proceso principal que se ocupa espec√≠ficamente del procesamiento at√≥mico de cada elemento de datos, es decir, de cada valor: <br><br><ul><li>  viene el valor (lo toma de HistoryCache); </li><li>  verifica en Sincronizador de configuraci√≥n: ¬øhay alg√∫n desencadenante para el c√°lculo? <br>  si es as√≠, crea eventos, crea una escalada para crear una alerta, si es necesario por configuraci√≥n; </li><li>  desencadenantes de registros para procesamiento posterior, agregaci√≥n;  si agrega en la √∫ltima hora, etc., este valor recuerda ValueCache, para no ir a la tabla de historial;  Por lo tanto, ValueCache se llena con los datos necesarios que son necesarios para calcular desencadenantes, elementos calculados, etc. </li><li>  entonces History Syncer escribe todos los datos en la base de datos; </li><li>  la base de datos los escribe en el disco; aqu√≠ es donde termina el proceso de procesamiento. </li></ul><br><h3>  Bases de datos  Almacenamiento en cach√© </h3><br>  En el lado de la base de datos, cuando desea ver gr√°ficos o alg√∫n tipo de informe de eventos, hay varios cach√©s.  Pero como parte de este informe, no hablar√© sobre ellos. <br><br>  Para MySQL, hay Innodb_buffer_pool, un mont√≥n de cach√©s diferentes que tambi√©n se pueden configurar. <br>  Pero estos son los principales: <br><br><ul><li>  shared_buffers; </li><li>  eficaz_cach√©_tama√±o; </li><li>  shared_pool. </li></ul><br><img src="https://habrastorage.org/webt/fw/7n/0z/fw7n0ziowm_jbvs--peokkswjdw.jpeg"><br><br>  He citado para todas las bases de datos que hay ciertas memorias cach√© que le permiten mantener en la memoria los datos que a menudo se necesitan para las consultas.  All√≠ tienen sus propias tecnolog√≠as para esto. <br><br><h3>  Sobre el rendimiento de la base de datos </h3><br>  En consecuencia, existe un entorno competitivo, es decir, el servidor Zabbix recopila datos y los registra.  Al reiniciar, tambi√©n lee del historial para llenar ValueCache y as√≠ sucesivamente.  Aqu√≠ puede tener scripts e informes que utilizan la API de Zabbix, que se basa en la interfaz web.  "Zabbiks" -API est√° incluido en la base de datos y recibe los datos necesarios para obtener gr√°ficos, informes o alguna lista de eventos, problemas recientes. <br><br><img src="https://habrastorage.org/webt/gr/to/vp/grtovpkr0x6kkytkg5bw2zllpqw.jpeg"><br><br>  Tambi√©n una soluci√≥n de visualizaci√≥n muy popular es Grafana, que utilizan nuestros usuarios.  Capaz de ingresar directamente a trav√©s de "Zabbiks" -API, y a trav√©s de la base de datos.  Tambi√©n crea una cierta competencia para obtener datos: se necesita un ajuste m√°s fino y mejor de la base de datos para corresponder a la entrega r√°pida de resultados y pruebas. <br><br><img src="https://habrastorage.org/webt/aj/ak/l-/ajakl-q1nyal8mce-xw4snwrgye.jpeg"><br><br><h3>  Claro historial.  Zabbix tiene ama de llaves </h3><br>  El tercer desaf√≠o utilizado por Zabbix es aclarar la historia con Housekeeper.  Hauskiper cumple con todas las configuraciones, es decir, en nuestros elementos de datos se indica cu√°nto almacenar (en d√≠as), cu√°nto almacenar las tendencias, la din√°mica de los cambios. <br><br>  No habl√© de TrendCache, que calculamos sobre la marcha: los datos llegan, los agregamos en una hora (b√°sicamente estos son n√∫meros en la √∫ltima hora), la cantidad es promedio / m√≠nimo y la escribimos una vez por hora en la tabla de cambios en la din√°mica (Tendencias) .  Hauskiper se inicia y elimina datos de la base de datos utilizando selecciones regulares, lo que no siempre es efectivo. <br><br>  ¬øC√≥mo entender que es ineficiente?  Puede ver la siguiente imagen en los gr√°ficos de rendimiento de los procesos internos: <br><br><img src="https://habrastorage.org/webt/cw/au/u3/cwauu3n4dk0-u_nonnfzbf0og6g.jpeg"><br><br>  Su sincerizador de historia est√° constantemente ocupado (gr√°fico rojo).  Y la tabla "roja" que va arriba.  Este es el Hauskiper, que comienza y espera a la base de datos cuando elimina todas las l√≠neas que especific√≥. <br><br>  Tome alguna ID de art√≠culo: debe eliminar los √∫ltimos 5 mil;  Por supuesto, por √≠ndices.  Pero, por lo general, el conjunto de datos es lo suficientemente grande: la base de datos todav√≠a lee esto del disco y lo eleva a la memoria cach√©, y esta es una operaci√≥n muy costosa para la base de datos.  Dependiendo de su tama√±o, esto puede conducir a ciertos problemas de rendimiento. <br><br>  Puede deshabilitar Hauskiper de una manera simple: tenemos una interfaz web familiar para todos.  Configurando en Administraci√≥n general (configuraciones para "Ama de llaves") deshabilitamos la limpieza interna para el historial interno y las tendencias.  En consecuencia, Hauskiper ya no controla esto: <br><br><img src="https://habrastorage.org/webt/cp/si/jo/cpsijomx2kl2p1trw0it8ujvpga.jpeg"><br><br>  ¬øQu√© puedo hacer a continuaci√≥n?  Se desconect√≥, sus horarios se nivelaron ... ¬øQu√© problemas pueden ir m√°s all√° en este caso?  Que puede ayudar <br><br><h3>  Particionamiento (particionamiento) </h3><br>  Esto generalmente se configura en cada base de datos relacional que he enumerado de manera diferente.  MySQL tiene su propia tecnolog√≠a.  Pero en general son muy similares cuando se trata de PostgreSQL 10 y MySQL.  Por supuesto, hay muchas diferencias internas en c√≥mo se implementa todo y c√≥mo afecta todo el rendimiento.  Pero en general, la creaci√≥n de una nueva partici√≥n a menudo tambi√©n conduce a ciertos problemas. <br><br><img src="https://habrastorage.org/webt/g3/ru/gs/g3rugs9kazu4fcyk70inqtrnrd4.jpeg"><br><br>  Dependiendo de su configuraci√≥n (la cantidad de datos que crea en un d√≠a), generalmente establecen el m√≠nimo: 1 d√≠a / partici√≥n, y para las tendencias, la din√°mica de los cambios: 1 mes / nueva partici√≥n.  Esto puede cambiar si tiene una configuraci√≥n muy grande. <br><br>  Digamos de inmediato sobre el tama√±o de la configuraci√≥n: hasta 5 mil valores nuevos por segundo (denominados nvps); esto se considerar√° una peque√±a "configuraci√≥n".  Promedio: de 5 a 25 mil valores por segundo.  Todo lo que est√° arriba ya son instalaciones grandes y muy grandes que requieren una configuraci√≥n muy cuidadosa de la base de datos. <br><br>  En instalaciones muy grandes, 1 d√≠a, esto puede no ser √≥ptimo.  Personalmente, vi en particiones MySQL de 40 gigabytes por d√≠a (y puede haber m√°s).  Esta es una gran cantidad de datos, lo que puede generar algunos problemas.  Necesita ser reducido. <br><br><h3>  ¬øPor qu√© particionar? </h3><br>  Lo que el particionamiento ofrece, creo que todos lo saben, es el particionamiento de tablas.  A menudo, estos son archivos separados en el disco y solicitudes de extensi√≥n.  √âl selecciona de manera m√°s √≥ptima una partici√≥n, si esta es parte de la partici√≥n habitual. <br><br><img src="https://habrastorage.org/webt/nd/u2/6a/ndu26acwf_st_axq0rfws4t0yhu.jpeg"><br><br>  Para Zabbix, en particular, se usa por rango, por rango, es decir, usamos una marca de tiempo (el n√∫mero es ordinario, el tiempo desde el comienzo de la era).  Usted especifica el comienzo del d√≠a / final del d√≠a, y esta es una partici√≥n.  En consecuencia, si est√° solicitando datos hace dos d√≠as, todo esto se selecciona de la base de datos m√°s r√°pido, ya que solo necesita cargar un archivo en la cach√© y emitir (en lugar de una tabla grande). <br><br><img src="https://habrastorage.org/webt/n8/-5/h0/n8-5h0inf3gdrt6fv2jaqeguoxm.jpeg"><br><br>  Muchas bases de datos tambi√©n aceleran la inserci√≥n (inserci√≥n en una sola tabla secundaria).  Si bien hablo de manera abstracta, pero tambi√©n es posible.  Partitoning a menudo ayuda. <br><br><h3>  Elasticsearch para NoSQL </h3><br>  Recientemente, en 3.4, implementamos una soluci√≥n para NoSQL.  Se agreg√≥ la capacidad de escribir en Elasticsearch.  Puede escribir algunos tipos separados: elija, ya sea escribir n√∫meros o algunos signos;  tenemos texto de cadena, puede escribir registros en Elasticsearch ... En consecuencia, la interfaz web tambi√©n acceder√° a Elasticsearch.  Esto funciona bien en algunos casos, pero por el momento se puede usar. <br><br><img src="https://habrastorage.org/webt/xq/f_/kc/xqf_kcj7pttjfkqtvykodkhf1ne.jpeg"><br><br><h3>  TimescaleDB.  Hipertables </h3><br>  Para 4.4.2, notamos una cosa como TimescaleDB.  Que es esto  Esta es una extensi√≥n para Postgres, es decir, tiene una interfaz nativa de PostgreSQL.  Adem√°s, esta extensi√≥n le permite trabajar con datos de series de tiempo de manera mucho m√°s eficiente y tener particiones autom√°ticas.  C√≥mo se ve: <br><br><img src="https://habrastorage.org/webt/_q/nk/mz/_qnkmz4mbfzhveegk3d2hjzgafg.jpeg"><br><br>  Esto es hipertable: existe tal concepto en Timescale.  Esta es la hipertable que creas y contiene fragmentos.  Los fragmentos son particiones, estas son tablas secundarias, si no me equivoco.  Es realmente efectivo. <br><br><img src="https://habrastorage.org/webt/un/gu/pk/ungupk6uffgezcunuoaa4tjkk0g.jpeg"><br><br><h3>  TimescaleDB y PostgreSQL </h3><br>  Como aseguran los fabricantes de TimescaleDB, utilizan un algoritmo de procesamiento de solicitudes m√°s correcto, en particular insert'ov, que le permite tener un rendimiento aproximadamente constante con un tama√±o creciente de la inserci√≥n del conjunto de datos.  Es decir, despu√©s de 200 millones de l√≠neas de "Postgres", la habitual comienza a ceder mucho y pierde el rendimiento literalmente a cero, mientras que "Timescale" le permite insertar inserciones de la manera m√°s eficiente posible con cualquier cantidad de datos. <br><br><img src="https://habrastorage.org/webt/xo/zb/-o/xozb-o86ammklruo6wbmreoddga.jpeg"><br><br><h3>  ¬øC√≥mo instalar TimescaleDB?  ¬°Todo es simple! </h3><br>  Lo tiene en la documentaci√≥n, se describe: se puede entregar desde paquetes para cualquier ... Depende de los paquetes oficiales de Postgres.  Se puede compilar manualmente.  Sucedi√≥ que tuve que compilar para la base de datos. <br><br><img src="https://habrastorage.org/webt/vm/t8/ab/vmt8ab42ehsl-ne-cxb70skn9ik.jpeg"><br><br>  En Zabbix, solo activamos la extensi√≥n.  Creo que aquellos que usaron Extenci√≥n en Postgres ... Simplemente active Extenci√≥n, cr√©elo para la base de datos Zabbix que usa. <br><br>  Y el √∫ltimo paso ... <br><br><h3>  TimescaleDB.  Tablas de historial de migraci√≥n </h3><br>  Necesitas crear un hipertable.  Hay una funci√≥n especial para esto: crear hipertables.  En √©l, el primer par√°metro indica la tabla que se necesita en esta base de datos (para la cual necesita crear una hipertable). <br><br><img src="https://habrastorage.org/webt/rs/p0/ja/rsp0ja0xplwviw9abiqvsody8zw.jpeg"><br><br>  El campo por el que desea crear, y chunk_time_interval (este es el intervalo de fragmentos (particiones que se utilizar√°n). 86,400 es un d√≠a. <br><br>  Par√°metro migrate_data: si inserta en verdadero, esto transfiere todos los datos actuales a fragmentos previamente creados. <br><br>  Yo mismo utilic√© migrate_data: lleva una cantidad de tiempo decente, dependiendo del tama√±o de su base de datos.  Ten√≠a m√°s de un terabyte: la creaci√≥n tard√≥ m√°s de una hora.  En algunos casos, durante las pruebas, elimin√© los datos hist√≥ricos para el texto (history_text) y la cadena (history_str), para no transferirlos, no eran realmente interesantes para m√≠. <br><br>  Y hacemos la √∫ltima actualizaci√≥n en nuestra db_extention: establecemos timescaledb para que la base de datos y, en particular, nuestro Zabbix entiendan qu√© es db_extention.  Lo activa y utiliza la sintaxis correcta y las consultas de la base de datos, utilizando esas "caracter√≠sticas" que son necesarias para TimescaleDB. <br><br><h3>  Configuraci√≥n del servidor </h3><br>  Us√© dos servidores.  El primer servidor es una m√°quina virtual lo suficientemente peque√±a, 20 procesadores, 16 gigabytes de RAM.  Configure Postgres 10.8 en √©l: <br><br><img src="https://habrastorage.org/webt/q_/h-/fe/q_h-fey52vutiin_dcat3zezb1g.jpeg"><br><br>  El sistema operativo era Debian, el sistema de archivos era xfs.  Realic√© configuraciones m√≠nimas para usar esta base de datos en particular, menos lo que usar√° Zabbix.  En la misma m√°quina hab√≠a un servidor Zabbix, PostgreSQL y agentes de carga. <br><br><img src="https://habrastorage.org/webt/vl/jv/bu/vljvbuggjlj1vz5tvptvzsicauo.jpeg"><br><br>  Us√© 50 agentes activos que usan LoadableModule para generar r√°pidamente varios resultados.  Generaron l√≠neas, n√∫meros, etc.  Estorb√© la base de datos con muchos datos.  Inicialmente, la configuraci√≥n conten√≠a 5 mil elementos de datos por host, y aproximadamente cada elemento de datos conten√≠a un disparador, por lo que era una configuraci√≥n real.  A veces, incluso se necesita m√°s de un disparador para usar. <br><br><img src="https://habrastorage.org/webt/9e/z0/os/9ez0os1zg6wv3k3d176svhoauqe.jpeg"><br><br>  Regul√© el intervalo de actualizaci√≥n, la carga en s√≠ misma, de modo que no solo us√© 50 agentes (agregu√© m√°s), sino que tambi√©n us√© elementos de datos din√°micos y reduje el intervalo de actualizaci√≥n a 4 segundos. <br><br><h3>  Prueba de rendimiento.  PostgreSQL: 36 mil NVP </h3><br>  El primer lanzamiento, la primera configuraci√≥n que tuve en PostreSQL 10 puro en este hardware (35 mil valores por segundo).  En general, como puede ver en la pantalla, la inserci√≥n de datos toma fracciones de segundo: todo est√° bien y es r√°pido, SSD (200 gigabytes).  Lo √∫nico es que 20 GB se llenan r√°pidamente. <br><br><img src="https://habrastorage.org/webt/st/er/oh/sterohufqkrwjzwicbau9fxyeg8.jpeg"><br><br>  Habr√° muchos m√°s gr√°ficos de este tipo.  Este es el panel de rendimiento est√°ndar del servidor Zabbix. <br><br><img src="https://habrastorage.org/webt/2m/31/jy/2m31jys-j4bm3ocrwo7bqtp5ftu.jpeg"><br><br>  El primer gr√°fico es el n√∫mero de valores por segundo (azul, arriba a la izquierda), 35 mil valores en este caso.  Este (centro de carga) es la carga de los procesos de ensamblaje, y esto (arriba a la derecha) es la carga de los procesos internos: historiadores y ama de llaves, que ha estado funcionando aqu√≠ durante un tiempo suficiente. <br><br>  Este gr√°fico (centro inferior) muestra el uso de ValueCache: cu√°ntos hits de ValueCache para desencadenantes (varios miles de valores por segundo).  Otro gr√°fico importante es el cuarto (abajo a la izquierda), que muestra el uso de HistoryCache, del que habl√©, que es un b√∫fer antes de insertarlo en la base de datos. <br><br><h3>  Prueba de rendimiento.  PostgreSQL: 50 mil NVP </h3><br>  Luego, aument√© la carga a 50 mil valores por segundo en el mismo hardware.  Al cargar con Hauskiper, se registraron 10 mil valores en 2-3 segundos con el c√°lculo.  Que, de hecho, se muestra en la siguiente captura de pantalla: <br><br><img src="https://habrastorage.org/webt/z7/ml/st/z7mlstfkfw8weobkfvj83zxy4w4.jpeg"><br><br>  Hauskiper ya est√° comenzando a interferir con el trabajo, pero en general la carga de los cazadores de historiadores sigue siendo del 60% (tercer gr√°fico, arriba a la derecha).  HistoryCache ya durante el trabajo de "Hauskiper" comienza a llenar activamente (abajo a la izquierda).  Era aproximadamente medio gigabyte, lleno al 20%. <br><br><img src="https://habrastorage.org/webt/mk/-k/q4/mk-kq4jre2iwk-6fdt9xlejoaje.jpeg"><br><br><h3>  Prueba de rendimiento.  PostgreSQL: 80 mil NVP </h3><br>  Aument√≥ a√∫n m√°s a 80 mil valores por segundo: <br><br><img src="https://habrastorage.org/webt/7g/zj/jq/7gzjjqaa68jpj_9yltg7mhfvz0a.jpeg"><br><br>  Eran aproximadamente 400 mil elementos de datos, 280 mil disparadores.  El inserto, como puede ver, para la carga de hundidores hist√≥ricos (hab√≠a 30 de ellos) ya era bastante alto.  Adem√°s, aument√© varios par√°metros: hundidores de historial, cach√© ... En este hardware, la carga de hundidores de historial comenz√≥ a aumentar al m√°ximo, casi "en el estante"; en consecuencia, HistoryCache pas√≥ a una carga muy alta: <br><br><img src="https://habrastorage.org/webt/xd/3z/ky/xd3zkydh5zu-vkewwstgk12qc-s.jpeg"><br><br>  Todo este tiempo observ√© todos los par√°metros del sistema (c√≥mo se usa el procesador, RAM) y descubr√≠ que la utilizaci√≥n del disco era m√°xima: logr√© la capacidad m√°xima de este disco en este hardware, en esta m√°quina virtual.  "Postgres" comenz√≥ a tal intensidad para volcar datos de manera bastante activa, y el disco ya no ten√≠a tiempo para escribir, leer ... <br><br><img src="https://habrastorage.org/webt/d7/3l/2z/d73l2zoa7tqmhkjoji9z4hx1poy.jpeg"><br><br>  Tom√© otro servidor que ya ten√≠a 48 procesadores con 128 gigabytes de RAM: <br><br><img src="https://habrastorage.org/webt/-x/-b/9d/-x-b9dzzor5kwaba8sloo01yhk0.jpeg"><br><br>  Adem√°s, lo "empa√±√©": instal√© History Syncer (60 piezas) y logr√© un rendimiento aceptable.  De hecho, no estamos "en el estante", pero este es probablemente el l√≠mite de productividad, donde ya es necesario hacer algo al respecto. <br><br><h3>  Prueba de rendimiento.  TimescaleDB: 80 mil NVP </h3><br>  Mi tarea principal era usar TimescaleDB.  La falla es visible en cada gr√°fico: <br><br><img src="https://habrastorage.org/webt/zr/2l/hb/zr2lhbdocfwqknn3sgd_4agzsus.jpeg"><br><br>  Estas ca√≠das son solo migraci√≥n de datos.  Despu√©s de eso, en el servidor "Zabbix", el perfil de carga de los hundidores de la historia, como puede ver, ha cambiado mucho.    3         HistoryCache ‚Äì ,      .  , 80     ‚Äì    rate (,   ¬´¬ª).      setup,   . <br><br><h3>   PostgreSQL: 120  NVPs </h3><br>              125   : <br><br><img src="https://habrastorage.org/webt/cd/ay/e6/cdaye6egnxctvuobxadw6hf7bhw.jpeg"><br><br>    : <br><br><img src="https://habrastorage.org/webt/ts/di/fg/tsdifgr_chfu20nox8il6o2dtha.jpeg"><br><br>     setup,      .          1,5 ,       .  ,         TimescaleDB,       ,     MySQL. <br><br>    ,          ,     .     !    ‚Äì   TimescaleDB.   : 120    . <br><br>    ¬´¬ª : <br><br><img src="https://habrastorage.org/webt/rz/rn/m-/rzrnm-wfnbq8unwrcvozg8neccy.jpeg"><br><br>    TimescaleDB     io.weight   ;          TimescaleDB.     ,        ( SSD)! <br><br>  -  setup',     , TimescaleDB,   ,   .       ,         . <br><br>      : Conference ‚Äì  , Summit ‚Äì  .    ‚Äì ¬´¬ª, , IRC.     -  ‚Äì     ,    . <br><br><h3>   </h3><br>    ( ‚Äì ): ‚Äì  TimescaleDB    ,      , , ,        ¬´¬ª  ¬´¬ª?    -      ,  -,      ¬´¬ª,     ¬´¬ª,   ¬´¬ª ,        ? <br><br><img src="https://habrastorage.org/webt/5j/k8/og/5jk8ogejgbixfe_a0tfxzh8vbmw.jpeg"><br><br> <b>:</b> ‚Äì ,   ,    :  ¬´¬ª    TimescaleDB.    ,   ,   ,   ¬´¬ª .      ,     ( TimescaleDB),   ,    !    ,        ,  . <br><br>           ¬´¬ª:       - .        ,         .         setup'.    MySQL‚Ä¶   setup'    . <br><br> <b>:</b> ‚Äì   ,   community,    ¬´¬ª: <br><br><img src="https://habrastorage.org/webt/xh/pg/0j/xhpg0jw0a7davjqyru9gqg7xnx8.jpeg"><br><br>   .  ¬´¬ª     TimescaleDB? <br><br> <b>:</b> ‚Äì      ‚Äì      .     TimescaleDB    ,  - .         .      . <br><br> <b>:</b> ‚Äì     ‚Äì      ¬´¬ª. <br>  (  ): ‚Äì      ,      delete,       ‚Äì , ,     .  ¬´¬ª,     ,   .  ,    ,    big data: ¬´!¬ª <br><br> ¬´¬ª  ,     .        ,        select'       ,      ‚Äì ¬´    !¬ª ( ).  Eso es todo!         ,   . <br><br> <b>:</b> ‚Äì     SQL.   , ¬´¬ª     ,    ‚Äì -  .     ,      ,      , ,  ‚Äì Clickhouse, , - -?.. Kafka ‚Äì    !    - ? <br><br> <b>:</b> ‚Äì   .     ¬´¬ª   3.4:        , ,  ;   -      .           .   -     ,      ,       ¬´¬ª.     , , ,   NoSQL- (,  ¬´¬ª)  . <br><br> <b>:</b> ‚Äì , ,     ? <br><br> <b>:</b> ‚Äì ,     ¬´¬ª ‚Äì   ,     ,  .   ,               -   ,     , ,  . <br><br> <b>:</b> ‚Äì  ,     ,    ¬´¬ª, ? <br><br> <b>:</b> ‚Äì   . ,           , ,  ¬´¬ª   ,     .  .    :       .  ‚Äì  ,       ‚Äì Grafana   -. <br><br> <b>:</b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Es decir, estamos hablando de una lucha igualitaria, y no de la gran ventaja de estas bases de datos r√°pidas. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AG:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Creo que cuando integremos, habr√° pruebas m√°s precisas. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - ¬ø </font><b><font style="vertical-align: inherit;">A</font></b><font style="vertical-align: inherit;"> d√≥nde se fue el viejo RRD? </font><font style="vertical-align: inherit;">¬øQu√© te hizo cambiar a bases de datos SQL? </font><font style="vertical-align: inherit;">Inicialmente, en RRD, se recopilaron todas las m√©tricas. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AG:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - En el RRD "Zabbix", tal vez estaba en una versi√≥n muy antigua. </font><font style="vertical-align: inherit;">Siempre ha habido bases de datos SQL, un enfoque cl√°sico. </font><font style="vertical-align: inherit;">El enfoque cl√°sico es MySQL, PostgreSQL (ya existen desde hace mucho tiempo). </font><font style="vertical-align: inherit;">Tenemos una interfaz com√∫n para las bases de datos SQL y RRD, casi nunca las usamos.</font></font><br><br><img src="https://habrastorage.org/webt/a4/oi/25/a4oi25ls8s9shibkxhx1ckuxfqk.jpeg"><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/umRk94j5M8o" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h3>  Un poco de publicidad :) </h3><br>  Gracias por quedarte con nosotros.  ¬øTe gustan nuestros art√≠culos?  ¬øQuieres ver m√°s materiales interesantes?  Ap√≥yenos haciendo un pedido o recomendando a sus amigos <a href="https://ua-hosting.company/cloudvps/nl">VPS basado en la nube para desarrolladores desde $ 4.99</a> , un <b>an√°logo √∫nico de servidores de nivel b√°sico que inventamos para usted:</b> <a href="https://habr.com/company/ua-hosting/blog/347386/">toda la verdad sobre VPS (KVM) E5-2697 v3 (6 n√∫cleos) 10GB DDR4 480GB SSD 1Gbps desde $ 19 o c√≥mo dividir el servidor?</a>  (las opciones est√°n disponibles con RAID1 y RAID10, hasta 24 n√∫cleos y hasta 40GB DDR4). <br><br>  <b>Dell R730xd 2 veces m√°s barato en el centro de datos Equinix Tier IV en Amsterdam?</b>  ¬°Solo tenemos <b><a href="https://ua-hosting.company/serversnl">2 x Intel TetraDeca-Core Xeon 2x E5-2697v3 2.6GHz 14C 64GB DDR4 4x960GB SSD 1Gbps 100 TV desde $ 199</a> en los Pa√≠ses Bajos!</b>  <b><b>Dell R420 - 2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps 100TB - ¬°desde $ 99!</b></b>  Lea sobre <a href="https://habr.com/company/ua-hosting/blog/329618/">C√≥mo construir un edificio de infraestructura.</a>  <a href="https://habr.com/company/ua-hosting/blog/329618/">clase utilizando servidores Dell R730xd E5-2650 v4 que cuestan 9,000 euros por un centavo?</a> </div></div><p>Source: <a href="https://habr.com/ru/post/485470/">https://habr.com/ru/post/485470/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../485458/index.html">Silenciador ob√∫s</a></li>
<li><a href="../485460/index.html">20 bibliotecas para una espectacular aplicaci√≥n de iOS</a></li>
<li><a href="../485462/index.html">Nos ocupamos de eSIM (+ entrevista con un experto)</a></li>
<li><a href="../485464/index.html">Mi primer juego html5, desde Alice Yandex y victorias de premios hasta aplicaciones m√≥viles</a></li>
<li><a href="../485468/index.html">Variante de trabajar con sockets web en iOS en Swift / Escribi√≥ un administrador para trabajar con sockets web</a></li>
<li><a href="../485472/index.html">¬øQu√© hay de nuevo en AMD?</a></li>
<li><a href="../485476/index.html">Tendencias y negociaci√≥n en el intercambio: 4 indicadores populares de an√°lisis t√©cnico</a></li>
<li><a href="../485480/index.html">Columna port√°til Z-poject Doublebeef - doble mono en ruso. Prueba, desmontaje y actualizaci√≥n.</a></li>
<li><a href="../485482/index.html">3 problemas para transferir datos a Google Analytics a trav√©s del Protocolo de medici√≥n</a></li>
<li><a href="../485484/index.html">[Case Locomizer] Qu√© conocimiento se puede extraer realmente de un conjunto de datos an√≥nimo con coordenadas de usuario</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>