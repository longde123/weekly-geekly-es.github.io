<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚è≠Ô∏è üôãüèø üåØ WebRTC a trav√©s de Kurento: experiencia de prueba e implementaci√≥n üßùüèæ üóíÔ∏è üêü</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En este art√≠culo, compartir√© mi experiencia con la tecnolog√≠a WebRTC y el servidor de medios Kurento durante la fase de prueba e implementaci√≥n. Te di...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>WebRTC a trav√©s de Kurento: experiencia de prueba e implementaci√≥n</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/inobitec/blog/478536/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/gp/n6/4m/gpn64m3nht-yuv6pzbeye6d8zv0.png"></div><br>  En este art√≠culo, compartir√© mi experiencia con la tecnolog√≠a WebRTC y el servidor de medios Kurento durante la fase de prueba e implementaci√≥n.  Te dir√© qu√© problemas encontr√© y c√≥mo los resolv√≠.  No hablar√© sobre c√≥mo desarrollar una aplicaci√≥n desde cero, pero dar√© muchos enlaces √∫tiles.  Estoy seguro de que mi historia ser√° √∫til para aquellos que van a trabajar con WebRTC. <br><a name="habracut"></a><br><h3>  Introduccion </h3><br>  El Sistema de Informaci√≥n M√©dica (MIS), que est√° siendo desarrollado por nuestra empresa, ya se ha convertido en un gran proyecto empresarial con muchos microservicios, autobuses de mensajer√≠a, clientes m√≥viles, etc.  Algunas partes del sistema deben entregarse para el desarrollo y el apoyo a organizaciones de terceros, ya que no son nuestro perfil. <br><br>  El servicio de telemedicina es uno de esos m√≥dulos MIS.  No hab√≠a experiencia en el desarrollo de videoconferencias y el uso de WebRTC y el pedido fue delegado.  Pero despu√©s de un tiempo, debido a varias circunstancias, esta compa√±√≠a dej√≥ de admitir la videoconferencia.  Sin soporte, este servicio fue deshabilitado y "acumulando polvo" en el repositorio. <br><br>  Y ahora es el momento de revivir este micro servicio.  Se decidi√≥ intentar reiniciar Telemedicine por su cuenta.  Nuestra empresa ha crecido, han aparecido m√°s especialistas: es posible y necesario dominar nuevos temas para el desarrollo.  No hab√≠a estado involucrado en la transmisi√≥n de video antes, pero fue muy interesante entender y estudiar una tecnolog√≠a tan prometedora como WebRTC. <br><br>  Aqu√≠ hay algunos enlaces muy √∫tiles sobre la tecnolog√≠a WebRTC y el servidor Kurento que me ayudaron al principio: <br><br><ul><li>  <a href="https://habr.com/ru/post/435580/">Servicios Java, Spring, Kurento y Media</a> </li><li>  <a href="https://habr.com/ru/company/Voximplant/blog/344794/">WebRTC: c√≥mo dos navegadores acuerdan las llamadas de voz y video</a> </li><li>  <a href="https://habr.com/ru/company/flashphoner/blog/324914/">Desarrollamos un video chat entre el navegador y la aplicaci√≥n m√≥vil.</a> </li></ul><br><h3>  Empezando </h3><br>  La tarea era simple: restaurar el sistema de videoconferencia existente, hacer un inventario de lo que ya se hab√≠a hecho antes y, si es necesario, modificarlo de acuerdo con los deseos de los usuarios.  Las primeras pruebas en m√°quinas virtuales y computadoras reales tuvieron √©xito.  Pero el despliegue del sistema en el cliente trajo muchos problemas. <br><br>  Perm√≠tame recordarle que el cliente ya tiene un sistema de informaci√≥n m√©dica (MIS) que cubre una gran cantidad de tareas: desde la cola electr√≥nica, el lugar de trabajo del m√©dico, la gesti√≥n de documentos y PACS hasta el subsistema de gesti√≥n de equipos m√©dicos. <br><br>  Cuando se hizo necesario desarrollar la funcionalidad de videoconferencia para conectar al personal m√©dico de los centros de diagn√≥stico (en adelante, DC) con pacientes remotos, se establecieron dos requisitos previos: <br><br>  Todas las conferencias deben registrarse y almacenarse en el servidor. <br><br>  Los pacientes no deben instalar ning√∫n programa adicional en sus dispositivos, excepto el navegador, que en la mayor√≠a de los casos ya est√° preinstalado. <br><br>  WebRTC funciona desde un navegador sin programas o complementos adicionales.  Y Kurento puede grabar todo lo que pasa por √©l.  Y adem√°s, este servidor de medios tiene un buen conjunto de bibliotecas listas para trabajar con su API a trav√©s de Java y JavaScript, lo que simplifica enormemente el desarrollo. <br><br>  El desarrollo de la parte del servidor, o m√°s bien su base, incluso antes de comenzar la tarea, fue transferido por el cliente a una empresa de outsourcing a una empresa de terceros.  As√≠ que hab√≠a un "Servidor de gesti√≥n" (CSS), una base de servidor preparada, que obtuve para la implementaci√≥n. <br><br><h4>  La idea general de interacci√≥n inicialmente se ve√≠a as√≠: </h4><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ue/y-/qt/uey-qt4cvt81f4clyn6e0kdp4s4.png"></div><br>  Pero en el proceso de m√°s trabajo, todo el sistema ha cambiado y se ha vuelto m√°s complicado. <br><br><h3>  Primera experiencia de reanimaci√≥n </h3><br>  Despu√©s de la implementaci√≥n en una red de prueba en m√°quinas virtuales y en varias computadoras "en vivo", se llevaron a cabo muchas pruebas y experimentos, todo funcion√≥ a la perfecci√≥n.  En consecuencia, ha llegado el momento de introducirse en una red real y funcional. <br><br>  Para las pruebas, una v√≠ctima responsable en forma de m√©dico y su lugar de trabajo fueron asignados para ayudarme.  ¬°Y la segunda llamada a trav√©s del microservicio de telemedicina se estrell√≥! <br><br>  Es bueno que esto haya sucedido durante la prueba beta, y adem√°s de m√≠ y un m√©dico que estaba satisfecho con las aventuras, nadie vio esto. <br><br>  Lo que est√° sucediendo y por qu√© no se establece la conexi√≥n fue muy dif√≠cil de entender.  WebRTC no muestra fallas, solo espera a que aparezca una se√±al.  Sin saberlo, fue muy dif√≠cil depurar de alguna manera: la parte del servidor funciona bien, Kurento est√° en silencio en los registros, los clientes est√°n esperando la transmisi√≥n, pero no sucede nada. <br><br>  Habr ayud√≥ (alabado sea): <br><br><ul><li>  <a href="https://habr.com/ru/company/Voximplant/blog/417869/">C√≥mo depurar WebRTC.</a> </li><li>  <a href="https://habr.com/ru/company/Voximplant/blog/351234/">5 errores al desarrollar llamadas WebRTC desde el navegador</a> </li><li>  <a href="https://habr.com/ru/company/yandex/blog/419951/">Experiencia usando WebRTC.</a>  <a href="https://habr.com/ru/company/yandex/blog/419951/">Conferencia de Yandex</a> </li></ul><br>  Es lamentable que no conociera estas herramientas antes. <br><br>  Despu√©s de analizar los datos de registro y observar el estado de las conexiones, qued√≥ claro que tanto los scripts del lado del servidor como del cliente carecen de reacci√≥n a los eventos en el sistema WebRTC.  ¬øY d√≥nde conseguir estos eventos? <br><br>  Los desarrolladores del servidor de kurento proporcionan una biblioteca JavaScript muy conveniente para trabajar con WebRTC: kurento-utils.js. <br><br>  Para comenzar r√°pidamente, simplemente cree un objeto: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">new</span></span> kurentoUtils.WebRtcPeer.WebRtcPeerRecvonly(options, callback());</code> </pre> <br>  Y para acceder a los eventos, es necesario redefinir los m√©todos internos de la biblioteca.  Simplifiqu√© el c√≥digo lo m√°s posible para hacerlo m√°s claro: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    WebRtcPeerRecvonly var options = { //      peerConnection: getRTCPeerConnection(videoId), remoteVideo: videoElement, // //  ICE  onicecandidate: function (candidate) { onIceCandidate(candidate, videoId, true); }, onerror: onError, //   mediaConstraints: { //  video: true, audio: true} }; //  WebRTC incomeWebRtc[videoId] = new kurentoUtils.WebRtcPeer.WebRtcPeerRecvonly( options, function (error) { if (error) { return console.error(error); } this.generateOffer( function (error, sdpOffer) { //  }); }); //      function getRTCPeerConnection( videoId ){ var configuration = { "iceServers": [ {"url": "stun:" + stunServer}, {"url": "turn:" + turnServer, credential: turnCredential, username: turnUsername} ] }; var mypc = new RTCPeerConnection(configuration); //      mypc.oniceconnectionstatechange = function(){ state = this.iceConnectionState; console.info("### iceConnectionState " + videoId + " &gt; " + this.iceConnectionState); }; mypc.onsignalingstatechange = function(){ state = this.signalingState || this.readyState; console.info("### SignalingState " + videoId + " &gt; " + state); }; mypc.onconnectionstatechange = function(){ console.info("### ConnectionState " + videoId + " &gt; " + this.connectionState); }; return mypc; }</span></span></code> </pre><br><h3>  Hablando de certificados </h3><br>  Dado que el art√≠culo trata sobre mi experiencia, compartir√© informaci√≥n de que los navegadores modernos se han vuelto muy estrictos sobre la seguridad.  Si el recurso tiene un certificado autofirmado, incluso con un permiso especial, el navegador proh√≠be el acceso a los perif√©ricos de la computadora. <br><br>  Puede crear un certificado de recursos gratuitos en Internet y configurar una red local para su uso, o puede descargar Firefox versi√≥n 65 o superior. En esta versi√≥n, simplemente haga clic en el bot√≥n, que estoy de acuerdo con los riesgos de certificados autofirmados y c√°maras de acceso y micr√≥fonos. <br><br>  Este camino me pareci√≥ m√°s f√°cil. <br><br><h3>  Segunda prueba (ya cuidadosa) </h3><br>  Me pareci√≥ que el m√©dico correr√≠a por palomitas de ma√≠z cuando me viera en la pr√≥xima prueba.  Claramente disfrutaba vi√©ndome luchar con la tecnolog√≠a moderna. <br><br>  De hecho, esta actualizaci√≥n del sistema no fue una versi√≥n, porque no arregl√© nada, ni siquiera sab√≠a la causa de los problemas.  Repito que todo funcion√≥ perfectamente en la oficina.  El c√≥digo agreg√≥ reacciones a todos los eventos que generaron WebRTC y Kurento, a los que contact√©, y todo esto se escribi√≥ con gran detalle en los registros.  Incluso puse mis registros en archivos separados para que no se confundan con los principales en el IIA. <br><br>  Junto con un m√©dico entusiasta y un administrador del sistema cliente, probamos el sistema.  Ni siquiera probaron, es decir, "torturados".  Creamos videoconferencias en todos los modos posibles y desde todos los dispositivos disponibles.  Otros m√©dicos y parte del personal de la oficina remota estuvieron involucrados en este juego. <br><br>  Lo principal no era verificar el sistema (no funcionaba), sino recopilar la mayor cantidad de datos posible.  Como resultado, result√≥ que: <br><br><ol><li>  Aproximadamente el 80% de los intentos de crear una videoconferencia son exitosos. </li><li>  Algunas conexiones que utilizan candidatos ICE para IPv6 no funcionan. </li><li>  De 5 operadores m√≥viles, solo 2 funcionaron. </li></ol><br><h3>  Todo result√≥ ser simple: no puedes llegar lejos solo en Google </h3><br>  El an√°lisis de la informaci√≥n recopilada mostr√≥ que la conexi√≥n a trav√©s del servidor TURN de Google es inestable.  O la carga en ellos es grande, o es solo un servidor de demostraci√≥n para aquellos que reci√©n comienzan a aprender la tecnolog√≠a.  Pero de hecho: fallas muy frecuentes.  ¬°Necesita su propio servidor TURN / STUN! <br><br>  La segunda raz√≥n de las fallas son las direcciones locales IPv6.  El servidor de kurento no acepta candidatos de ICE con estas direcciones.  Es bueno que antes de enviar a todos los candidatos de ICE revisen el c√≥digo en mis manos y acabo de filtrar IPv6.local. <br><br>  El problema de los operadores m√≥viles se resuelve, nuevamente, con su servidor TURN / STUN. <br>  En tres de cada cinco operadores m√≥viles, NAT es sim√©trico y WebRTC no puede abrirse paso.  Se pueden encontrar m√°s detalles aqu√≠: <a href="https://habr.com/ru/post/150298/">¬øEs terrible la NAT sim√©trica?</a> <br><br>  Es una pena que mi tel√©fono m√≥vil personal funcione en una tarjeta SIM de un operador que no se molest√≥ con la protecci√≥n sim√©trica.  Por lo tanto, mi prueba inicial no revel√≥ este problema. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9b/g4/ie/9bg4ieg5oblnd8f24osrtmwetws.png"></div><br><h3>  Servidor TURN / STUN </h3><br>  El paquete resiprocate-turn-server fue elegido como su servidor. <br><br>  No eligieron durante mucho tiempo, est√° en el repositorio est√°ndar de ubuntu, f√°cil instalaci√≥n y actualizaciones autom√°ticas.  Pero no es muy conveniente trabajar con cuentas para conectarse: los inicios de sesi√≥n y las contrase√±as se toman solo del archivo, por lo que debe crear una utilidad o script adicional para exportar desde la base de datos del servidor principal. <br><br>  Por el momento, este archivo se genera a mano y las cuentas se distribuyen a trav√©s de un grupo de contrase√±as simple.  La autorizaci√≥n se implementa a trav√©s del servidor principal MIS, por lo que la seguridad no se ve comprometida.  Pero la estructura general de todo el sistema se ve fea.  Los planes para rehacer este momento. <br><br><h3>  Tercer viaje al cliente </h3><br>  Corrig√≠ el c√≥digo, instal√© y configur√© mi servidor TURN / STUN, desarroll√© un grupo de contrase√±as y las distribu√≠ a los clientes al comienzo de una videoconferencia y, despu√©s de actualizar los servidores de producci√≥n, fui a un m√©dico que ya conoc√≠a. <br><br>  Funciona!  ¬°Hurra!  Todos los inicios de la conferencia son exitosos desde todos los dispositivos y en todos los modos: el paciente desde la cuenta personal puede llamar al m√©dico, el terapeuta durante la recepci√≥n puede llamar al diagn√≥stico funcional para una consulta adicional, y los propios m√©dicos pueden organizar una videoconferencia multiusuario de diferentes sucursales de toda la ciudad. <br><br>  Ya ense√±ado por la amarga experiencia, participamos en pruebas meticulosas con la creaci√≥n artificial de situaciones de emergencia.  Del tema de este art√≠culo, destaco la necesidad de establecer un l√≠mite en el tiempo de espera de la conexi√≥n.  WebRTC, junto con Kurento, esperan que la transmisi√≥n comience infinitamente y esperan que los bytes de video est√©n a punto de desaparecer.  Tuve que configurar un temporizador para 10 segundos, lo que da un error al servidor de gesti√≥n si los bytes nunca llegaron. <br><br><h3>  Despu√©s de todas las mejoras. </h3><br>  Finalmente, el sistema funciona y funciona bien.  Las primeras revisiones fueron enviadas por los usuarios en el campo.  E inmediatamente apareci√≥ una gran cantidad de deseos y sugerencias para el dise√±o, funciones adicionales y otros planes para un mayor desarrollo.  ¬°El trabajo comenz√≥ a hervir con renovado vigor! <br><br>  Ahora la topolog√≠a del sistema completo se ve as√≠: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/mr/ev/kn/mrevknsr8bnuhpmsnaowtthxd6m.png"></div><br><h3>  RESULTADOS </h3><br>  En conclusi√≥n, quiero decir lo siguiente: <br><br>  En primer lugar, WebRTC es una tecnolog√≠a excelente con grandes perspectivas, pero es muy dif√≠cil de probar y depurar.  Antes de comenzar el desarrollo, es imprescindible implementar una red con todo tipo de conexiones que pueda tener el cliente.  Y la depuraci√≥n a trav√©s de la ventana de informaci√≥n del navegador no es una herramienta muy conveniente. <br><br>  En segundo lugar, alabado sea Habru!  Mientras trabajaba en este proyecto, encontr√© mucha informaci√≥n sobre este recurso.  Todos los enlaces en este art√≠culo conducen a √©l. <br><br>  Se decidi√≥ abandonar el proyecto de videoconferencia de telemedicina para el soporte y desarrollo de nuestra organizaci√≥n; no lo externalizaremos.  En el futuro, todav√≠a hay mucho trabajo: <br><br><ul><li>  Hay una finalizaci√≥n de pegar videos grabados.  Volver√© a Habr, ya encontr√© un art√≠culo para empezar: <a href="https://habr.com/ru/post/277179/">combinar fragmentos de video de varias c√°maras y sincronizarlos a tiempo.</a> </li><li>  Es necesario redise√±ar el sistema de registro de usuarios en el servidor de administraci√≥n, el servidor MIS principal y el servidor de turno. </li><li>  Y la pregunta est√° abierta con el rendimiento de todo el sistema en su conjunto.  A√∫n no se han realizado pruebas de estr√©s.  Prep√°rese, lea de nuevo Habr: <a href="https://habr.com/ru/company/Voximplant/blog/346924/">¬øCu√°ntos participantes pueden estar en una llamada WebRTC?</a> </li></ul><br><h3>  TODO </h3><br>  Estoy seguro de que mi experiencia ser√° √∫til no solo para desarrolladores bajo WebRTC + Kurento, sino tambi√©n para aquellos que van a comenzar a implementar proyectos igualmente complejos.  Presta m√°s atenci√≥n a las pruebas en condiciones lo m√°s cercanas posible a la realidad. <br><br>  Y tenga en cuenta los riesgos de que los equipos de soporte para sus microservicios puedan "desaparecer" repentinamente; esta es una tarea muy inesperada y desagradable. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/478536/">https://habr.com/ru/post/478536/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../478526/index.html">Un mont√≥n de OpenVPN en Windows Server y Mikrotik con la migraci√≥n de estas cosas a Linux</a></li>
<li><a href="../478528/index.html">Mascota (una historia fant√°stica)</a></li>
<li><a href="../478530/index.html">TechnoText-2019: qui√©n gan√≥ al final y para qu√© fueron</a></li>
<li><a href="../478532/index.html">C√≥mo gana Apple: las 5 √°reas comerciales m√°s rentables de la empresa y cu√°nto le aportan</a></li>
<li><a href="../478534/index.html">DevFest Siberia 2019: un vistazo a las tendencias desde el interior</a></li>
<li><a href="../478538/index.html">C√≥mo verificar la validez de su pasaporte</a></li>
<li><a href="../478542/index.html">FigmaGen: Style Automation en la aplicaci√≥n iOS</a></li>
<li><a href="../478544/index.html">Vue Storefront: Importar directorio desde Magento 2</a></li>
<li><a href="../478546/index.html">Websockets Alguna experiencia en desarrollo y operaci√≥n. Modificamos al cliente</a></li>
<li><a href="../478550/index.html">¬øC√≥mo gestionar un reloj? An√°lisis de la pista front-end del segundo campeonato de programaci√≥n.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>