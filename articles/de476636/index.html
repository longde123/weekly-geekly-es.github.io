<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤵🏽 🙉 👉🏽 Optimieren von Firebird und Linux für eine Datenbank mit einer Größe von 691 GB und mehr als 1000 Benutzern 🏴󠁧󠁢󠁷󠁬󠁳󠁿 👼🏻 😎</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Firebird ist in Russland ein sehr beliebtes offenes DBMS und wird trotz fehlender lauter Marketingkampagnen in einer Vielzahl kritischer Systeme, insb...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Optimieren von Firebird und Linux für eine Datenbank mit einer Größe von 691 GB und mehr als 1000 Benutzern</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/476636/"> Firebird ist in Russland ein sehr beliebtes offenes DBMS und wird trotz fehlender lauter Marketingkampagnen in einer Vielzahl kritischer Systeme, insbesondere in medizinischen und staatlichen Automatisierungssystemen, eingesetzt. <br><br>  Die Größe der Datenbank und die Anzahl der aktiven Benutzer in solchen Systemen sind in der Regel recht groß. In diesem Artikel werde ich daher auf die Erfahrungen mit der Optimierung von Firebird- und Linux-Einstellungen anhand spezifischer Beispiele für große Firebird-Datenbanken in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">BeZdorov</a> (Ingosstrakh), <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">AlfaZdrav</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">eingehen</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">auf die</a> Erfahrungen anderer Optimierungsunternehmen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">eingehen</a> Firebird + Linux. <br><br>  Schauen wir uns das Thema Optimierung genauer an - Firebird 3.0.5 DBMS (mit HQbird-Erweiterungen), dient (derzeit) einer 691 GB großen Datenbank mit 1000 bis 1100 täglichen Benutzern, läuft unter Linux CentOS 7, der Server verwendet ein HP DL380-Eisen.  Die Replikation auf den Sicherungsserver ist für die Datenbank konfiguriert (die Frage der Replikation liegt außerhalb des Geltungsbereichs dieses Artikels). <br><a name="habracut"></a><br>  Das DBMS bedient das medizinische Informationssystem Infoklinika (hergestellt von der russischen Firma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Smart Delta Systems</a> ), eines der beliebtesten medizinischen Informationssysteme in Russland. <br><br>  Werfen wir einen Blick auf die Details (die Screenshots stammen später von HQbird) des Betriebs dieser Datenbank: <br><br>  Die Daten werden intensiv in die Datenbank eingefügt - ein täglicher Zuwachs von ca. 0,4 - 0,5 GB <br><br><img src="https://habrastorage.org/webt/vf/v7/4k/vfv74kl3pcxkou42snnuyv98fqg.png"><br><br>  1000-1100 Verbindungen sind die übliche tägliche Belastung: <br><br><img src="https://habrastorage.org/webt/73/qj/5t/73qj5tu1spoxlkq7debfz8ifn2q.png"><br><br>  Trotz intensiven Wachstums und aktiver Arbeit enthält die Datenbank keine nennenswerte Menge an Speicherbereinigungsversionen von Datensätzen - sowohl dank Anwendungen, die mit guten Kenntnissen der Architektur mit mehreren Versionen geschrieben wurden, als auch aufgrund der ordnungsgemäß konfigurierten Speicherbereinigung: <br><br><img src="https://habrastorage.org/webt/sy/zg/rj/syzgrjtckhyhydolkmeufwwgb_q.png"><br><br>  Transaktionsmarker in der grünen Zone: <br><br><img src="https://habrastorage.org/webt/vn/1h/wu/vn1hwu2celimgvpgtioyfugumsi.png"><br><br>  Beachten Sie übrigens, dass die Daten in der Datenbank Zeichenfolgen sind, Blobs vorhanden sind, aber nur wenige - nur 10 GB von 690 GB der Gesamtgröße. <br><br>  Die Art der Datenbanklast ist gemischt, 75% der Leseoperationen und 25% der Schreiboperationen: <br><br><img src="https://habrastorage.org/webt/k2/gr/xz/k2grxztnytufblqb0y6idmfljeo.png"><br><br><h3>  Eisen </h3><br>  Der Server, der dieses System bedient, ist nicht schlecht, aber alles andere als top: <br><br><pre><code class="plaintext hljs">HP ProLiant DL380p Gen8, Gen8 2x Xeon(R) CPU E5v2 @ 2.60GHz, 24 logical cores with HT 320Gb RAM, 4 network cards</code> </pre> <br>  Das Festplattensubsystem besteht aus zwei Teilen: einer lokalen 745-GB-Festplatte und einer dualen 2-Fibre-Channel-Verbindung zum SAN mit einer 1,8-TB-Partition. <br><br><h3>  Operationssystem </h3><br>  Unter CentOS 7, Kernelversion: <br><br><pre> <code class="plaintext hljs">Linux version 3.10.0-957.21.3.el7.x86_64 (mockbuild@kbuilder.bsys.centos.org) (gcc version 4.8.5 20150623 (Red Hat 4.8.5-36) (GCC) ) #1 SMP Tue Jun 18 16:35:19 UTC 2019</code> </pre><br>  Auf die logische Frage, warum der modernste Kernel und CentOS 8 nicht verwendet werden, ist die Antwort ebenfalls logisch: Die Migration kritischer Systeme erfolgt erst nach der Veröffentlichung mehrerer Nebenversionen und strengen Tests. Dies ist einer der Fälle, in denen ein bekannter Fehler besser ist als zwei Unbekannte. <br><br>  Es sollte jedoch beachtet werden, dass das System bis 2017 auf CentOS 6.x lief und nach der Migration eine signifikante Verbesserung der Leistungsindikatoren festgestellt wurde. <br><br><h2>  Linux-Setup </h2><br><h3>  Eine unverzichtbare Linux-Anpassung für Firebird </h3><br>  Auf allen Linux-Servern, auf denen Firebird ausgeführt wird, müssen zwei Parameter erhöht werden: die Anzahl der virtuellen Speicherbereiche (VMA) und die Anzahl der geöffneten Dateien für den Firebird-Prozess. <br><br>  <b>1. VMA</b> <br><br>  Die Standard-VMA-Nummer ist 64 KB, sie muss viermal erhöht werden. Fügen Sie dazu die Zeile in sysctl.conf hinzu <br><br><pre> <code class="bash hljs">vm.max_map_count=262144</code> </pre> <br>  Verwenden Sie den Befehl, um den aktuellen Wert zu überprüfen <br><br><pre> <code class="bash hljs">sysctl vm.max_map_count</code> </pre> <br>  <b>2. Max. Offene Dateien</b> <br><br>  Firebird öffnet für jede Verbindung zur Datenbank bis zu 20 Deskriptoren (Datei-Handles) (unter Linux sehen alle Ressourcen wie Dateien aus), sodass die maximale Anzahl der standardmäßig geöffneten Dateien (normalerweise 4096) sehr schnell ausgeschöpft werden kann. <br><br>  Um die verfügbare Anzahl von Dateien für Firebird zu überprüfen, sollten Sie sich die Grenzen der ausführbaren Firebird-Datei ansehen: <br><br><pre> <code class="bash hljs">cat /proc/$(pgrep firebird)/limits</code> </pre> <br>  Hier können Sie den Wert für "Max Open Files" überprüfen und gegebenenfalls erhöhen. <br><br>  Um den Parameter Max Open Files für Firebird zu erhöhen, haben wir die Zeile zur Datei firebird-superserver.service im Abschnitt [service] hinzugefügt: <br><br><pre> <code class="bash hljs">LimitNOFILE=49999</code> </pre> <br><h3>  Optionales Linux-Setup </h3><br>  Auf diesem Server haben wir auch die folgenden Einstellungen vorgenommen <br><br>  <b>1. Reduzierte Swapiness</b> <br><br>  Da der Server ausschließlich für Firebird-DBMS reserviert ist und wir den Arbeitsspeicher im DBMS-Cache und im Dateicache des Betriebssystems effizient nutzen möchten, reduzieren wir die Auslagerungsrate von standardmäßig 60% auf 10%. Dazu haben wir sysctl.conf hinzugefügt <br><br><pre> <code class="bash hljs">vm.swappiness=10</code> </pre> <br>  <b>2. Die minimale reservierte Speichergröße für spezielle Betriebssystemprozesse wurde erhöht</b> <br><br><pre> <code class="bash hljs">vm.min_free_kbytes=1048576</code> </pre> <br>  1 GB Speicher.  Diese Einstellung wirkt sich indirekt auf die Speicherdefragmentierung aus. <br><br>  Bitte beachten Sie, dass diese Einstellung individuell ist - da 320 GB RAM zur Verfügung stehen, ist 1 GB nicht so viel, aber bei einer kleinen Speicherkapazität (z. B. 32 GB) kann 1 GB zu viel sein. <br><br>  <b>3. Reduziertes Keepalive</b> <br><br>  Firebird verwendet Keepalive-Intervalle, um den Verbindungsstatus zu überprüfen. Der Standardwert für Keepalive kann sehr groß sein.  Wenn wir es auf 300 Sekunden beschränken, werden wir hängende Verbindungen los <br><br><pre> <code class="bash hljs">net.ipv4.tcp_keepalive_time=300 net.ipv4.tcp_keepalive_probes=5 net.ipv4.tcp_keepalive_intvl=15</code> </pre> <br><h3>  Mehr Linux-Tuning </h3><br>  Warum sind wir auf so wenige Linux-Einstellungen beschränkt? <br><br>  Erstens verfolgen wir einen konservativen Ansatz bei der Optimierung von Servern mit Linux (das mit jeder neuen Version immer besser wird), und zweitens ist diese Firebird-Datenbank weder extrem groß noch die am meisten ausgelastete, und Linux bewältigt die angegebenen Einstellungen mit Ihren Aufgaben. <br><br>  Natürlich gibt es noch ein paar Einstellungen, mit denen die Arbeit von Firebird unter Linux optimiert werden kann - zum Beispiel wurden in der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Präsentation über die 3 TB Firebird-Datenbank (RedBaza)</a> im Federal Bailiff Service einige interessante Dinge vorgestellt. <br><br><h2>  Konfigurieren Sie Firebird </h2><br>  Die Konfigurationsdateien der Firebird-Community mit firebirdsql.org werden sehr konservativ konfiguriert. Auf einem mehr oder weniger leistungsstarken Server müssen Sie die Konfigurationsdateien ändern und die verwendete Architektur sorgfältig auswählen (in Firebird 3.0 gibt es zwei Arten von Verbindungen: Embedded und NetworkServer sowie drei Arten von Architekturen: SuperServer , SuperClassic, Classic). <br>  Außerdem müssen Sie die Einstellungen für jede Datenbank verwenden - d. H.  kritische Einstellungen in database.conf mit Bezug auf eine bestimmte Datenbank setzen. <br><br>  In unserem Fall haben wir die SuperServer-Architektur gewählt, die in Version 3.0 am beliebtesten ist, weil  Es verwendet effizient Multi-Core-Prozessoren und verfügt über einen Cache, der für alle Verbindungen gemeinsam genutzt wird (jedoch für jede Datenbank separat). <br><br>  Im Folgenden sind die Konfigurationsdateien aufgeführt (nur leistungsbezogene Werte): <br><br>  <b>firebird.conf - Konfigurationsdatei für alle Datenbanken auf dem Server</b> <br><br><pre> <code class="plaintext hljs">DefaultDbCachePages = 50K # pages FileSystemCacheThreshold = 300K # pages TempBlockSize = 2M # bytes TempCacheLimit = 20480M # bytes LockMemSize = 30M # bytes LockHashSlots = 30011 WireCompression = true ServerMode = Super ExtConnPoolSize = 500 # HQBird ExtConnPoolLifeTime = 14200 # HQBird SortDataStorageThreshold = 8192 #HQbird reports queries</code> </pre> <br>  In Bezug auf die Leistung sind die wichtigsten Parameter hier: <br><br>  <b>1. DefaultDbCachePages = 50 KB # wird in Seiten in einer Datenbank auf Seite 16 KB = 0,8 GB gemessen</b> <br><br>  Die Größe des Seitencaches "DefaultDbCachePages" in der Datei "firebird.conf" ist standardmäßig auf 800 MB festgelegt, damit die versehentlich überfüllte Testdatenbank auf dem Server nicht versucht, sehr viel RAM zu belegen. <br><br>  <b>2. FileSystemCacheThreshold = 300 KB # Seiten</b> <br><br>  Es ist wichtig, diesen Parameter auf einen Wert größer als DefaultDBCachePages festzulegen, um die Verwendung des OS-Dateicaches zu ermöglichen. <br><br>  <b>3. TempCacheLimit = 20480M # Bytes</b> <br><br>  Dieser Parameter legt die Speichergröße für Abfragen mit Sortierungen (und einigen anderen Vorgängen) fest und ist für jedes System individuell. <br>  Als Ergebnis der Überwachung der Sortengröße haben wir festgestellt, dass 20 GB für diese Datenbank optimal sind. <br><br>  <b>4. LockMemSize und LockHashSlots - Parameter der Sperrtabelle</b> <br><br>  Diese Parameter bestimmen die Anfangsgröße der Sperrtabelle und die Anzahl der Slots zur Berechnung der Hash-Funktion. <br><br>  <b>5. WireCompression = True</b> <br><br>  Das Konfigurieren des Datenverkehrs zwischen Clients und Servern ist besonders bei intensiven Execute Statement On External-Vorgängen hilfreich, bei denen die Clientanwendung ausgeführt wird. <br><br>  Die restlichen Parameter sind in der firebird.conf selbst und der zugehörigen Dokumentation von Firebird und HQbird beschrieben. <br><br>  Die wichtigsten Einstellungen haben wir in der <b>database.conf</b> mit der genauen Datenbank vorgenommen <br><br><pre> <code class="plaintext hljs">database1 = /data/database1.fdb { DefaultDbCachePages = 14080K # 16K pages, 220 GB FileSystemCacheThreshold = 15361K TempSpaceCacheThreshold=2G #HQbird only, track big sorts LockHashSlots = 40099 LockMemSize = 50M }</code> </pre> <br>  Wie Sie sich vorstellen können, besteht die Hauptschwierigkeit in diesem Fall darin, die von unserer großen Datenbank zugewiesene Speichergröße korrekt zu berechnen. <br><br>  Für Firebird 3.0 mit SuperServer-Architektur gibt es zwei Ansätze - konservativ. Diese Methode wird auf Servern mit einem geringen RAM-Anteil (bis zu 32 GB einschließlich) verwendet, bei denen nicht mehr als 25% RAM für den Seiten-Cache reserviert werden und ansonsten das Dateibetriebssystem verwendet wird Systeme und Feinabstimmung, wenn wir die optimale Größe für Sortierungen genau bestimmen, dem Betriebssystemkern eine bestimmte Speichergröße zuweisen, eine bestimmte Speichermenge für umfangreiche Dateivorgänge reservieren (z. B. Sicherung),  der Rest für den Seiten-Cache zugeordnet. <br><br>  Im zweiten Fall ist es nicht möglich, sofort die optimale Cachegröße zu erhalten, da die Art der Last für verschiedene Datenbanktypen sehr unterschiedlich sein kann. Nach mehreren Iterationen können Sie jedoch ein hervorragendes Ergebnis erzielen. <br><br><h3>  Häufige Fehler bei der Konfiguration von Firebird </h3><br>  Typische Fehler sind: <br><br>  1) Die Größe des Seitencaches, der explizit auf der DB-Headerseite angegeben ist und die in firebird.conf und databases.conf angegebenen Werte überschreibt. <br><br>  Besonders häufig tritt dieser Fehler auf, wenn die Architektur von Classic / SuperClassic auf SuperServer geändert wird. Wenn die Cache-Größe für die Classic / SuperClassic-Verbindung bei einer deutlich angegebenen kleinen Größe (500-2000 Seiten) einwandfrei funktioniert, wird für SuperServer ein viel größerer Cache benötigt. <br>  Führen Sie zum Überprüfen den Befehl aus <br><br><pre> <code class="plaintext hljs">gstat -h databasepathname</code> </pre> <br>  und überprüfen Sie den <code>Page Buffers</code> Wert - er sollte 0 sein, dann verwendet Firebird die Werte aus database.conf oder firebird.conf. <br><br>  Führen Sie den Befehl aus, um die Einstellung für den Seitencache auf der Headerseite zurückzusetzen <br><br><pre> <code class="plaintext hljs">gfix -buff 0 databasepathname</code> </pre> <br>  2) Wenn sie den Seiten-Cache erhöhen, vergessen sie, den FileSystemCacheThreshold zu erhöhen, was zur Trennung des Datei-Cache führt, was die Leistung verringert. <br><br>  3) Verwenden Sie die Standardseitengröße der Datenbank (4096 oder 8192), während Sie für große Datenbanken 16 KB verwenden müssen. <br><br><h2>  Fazit </h2><br>  Im Allgemeinen arbeiten mehr als 1000 Firebird-Benutzer auf Eisen, die der von Linux konfigurierten und von Firebird konfigurierten Last entsprechen, ohne Probleme.  Auf diesem Server gibt es eine Leistungsreserve, die bei Spitzenlasten für bis zu 1500-1800 Benutzer getestet wurde. <br><br>  Unter den Linux-Distributionen für die Firebird-Datenbank mit einer ähnlichen Last ist CentOS 7 am beliebtesten, die empfohlene Version ist Firebird 3.0. <br><br>  Bei Fragen stehe ich Ihnen gerne in den Kommentaren oder per E-Mail unter ak@ibase.ru zur Verfügung. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de476636/">https://habr.com/ru/post/de476636/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de476618/index.html">Wie ich das Focus Kit entworfen habe</a></li>
<li><a href="../de476620/index.html">SP701 + PCAM-5C + 15 Minuten + VITIS = Easy MIPI auf FPGA</a></li>
<li><a href="../de476624/index.html">Qualitätspipelines in der mobilen Entwicklung, Teil 1: Android</a></li>
<li><a href="../de476626/index.html">PVS-Studio in den Wolken: GitLab CI / CD</a></li>
<li><a href="../de476628/index.html">PVS-Studio geht in die Cloud: GitLab CI / CD</a></li>
<li><a href="../de476640/index.html">Schutz von Zimbra OSE vor Brute-Force- und DoS-Angriffen</a></li>
<li><a href="../de476644/index.html">Sprachschichten</a></li>
<li><a href="../de476646/index.html">3-Wege-Fusion in Werf: Einsatz in Kubernetes mit Helm "auf Steroiden"</a></li>
<li><a href="../de476648/index.html">Lenovo auf der FINOPOLIS 2019</a></li>
<li><a href="../de476650/index.html">Der Ort der Aufzählung in der sich verändernden Welt von heute</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>