<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî© üè≠ ü§∑üèª Comment organiser les DDoS √† de bonnes fins? ü§≤üèº üôÜüèø üëÉ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Avant la sortie d'un nouveau service, il serait bon de s'assurer qu'il fonctionne conform√©ment √† nos attentes et est disponible quel que soit le nombr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment organiser les DDoS √† de bonnes fins?</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ntc-vulkan/blog/481756/"><p><img src="https://habrastorage.org/webt/qa/gk/up/qagkupe_y5cx7thbrqpj4aynn1y.png" alt="image"></p><br><p>  Avant la sortie d'un nouveau service, il serait bon de s'assurer qu'il fonctionne conform√©ment √† nos attentes et est disponible quel que soit le nombre de clients l'utilisant en m√™me temps. </p><br><p>  Et comment ce service r√©agira-t-il si une attaque DoS distribu√©e est organis√©e contre lui?  La ressource est-elle prot√©g√©e des attaquants potentiels? </p><br><p>  Afin d'√©valuer les risques possibles et d'augmenter la s√©curit√©, il est logique de mener ind√©pendamment des actions qui simulent une attaque DDoS, alors que la ressource n'a pas encore √©t√© lanc√©e pour une utilisation de masse. </p><br><p>  Dans cet article, nous parlerons de l'exp√©rience de l'organisation des tests de charge pour les services DNS et HTTP. </p><a name="habracut"></a><br><h1>  La pr√©paration </h1><br><p>  Afin de provoquer la g√©n√©ration d'une √©norme quantit√© de trafic r√©seau sur la ressource surveill√©e, vous devez utiliser de nombreuses machines virtuelles, chacune envoyant le nombre maximal de demandes au service.  Si vous ne disposez pas d'un centre de donn√©es puissant, il est judicieux de louer temporairement des machines virtuelles dans un cloud.  Cette id√©e a une particularit√©: vous devez vous assurer que le cloud ne rampe pas, en prenant votre activit√© pour les actions d'un attaquant. </p><br><p>  En comparant les politiques de divers services cloud (quelqu'un bannit impitoyablement un compte avec lequel, vraisemblablement, des mesures ont √©t√© prises qui ont conduit √† une d√©faillance des ressources) concernant les tests de charge en utilisant leurs fonctionnalit√©s, nous avons d√©cid√© de nous arr√™ter √† <a href="https://aws.amazon.com/">Amazon Web Services</a> (AWS).  Leurs <a href="https://aws.amazon.com/ru/ec2/testing/">documents</a> indiquent qu'AWS autorise les tests de charge, mais demande l'approbation en envoyant un e-mail √† une adresse sp√©cifique. </p><br><h1>  Harmonisation des tests de r√©sistance </h1><br><p>  Nous envoyons un message o√π nous parlons bri√®vement de nos intentions, et nous obtenons un formulaire qui doit √™tre rempli: </p><br><pre><code class="plaintext hljs">Customer ID: Customer Name: Email Address: AWS Account ID load test will be performed from: Does the customer have an NDA? Target Data EC2 Resources: Cloudfront Distribution: API Gateway / Lambda ID: ELB Names: Non-AWS Target: Region (please list all regions in scope for testing): Source Data: IP Addresses: Source Account ID: Regions involved: Testing Parameters: How much traffic do you plan to generate by region during testing? What is your expected peak load from source by region? (ie xx Gbps) What is your expected peak load at destination? (ie xx Gbps) Are you testing traffic outbound from EC2, inbound into EC2, or both? Are you testing traffic outbound (egress) from EC2, inbound (ingress) into EC2, or both: Egress. What is your expected peak load from source by region? (ie xx Gbps) Ingress. What is your expected peak load from source by region? (ie xx Gbps) Start Date: End Date: Finite testing details including timeline of testing: Summary of Test: Testing Timelines by phase including rps, pps, and Gbps: Peak bandwidth for each source IP: Tools Used for each phase of test: Types of testing to be performed for each phase of the request: What criteria/metrics will you monitor to ensure the success of this test? Who is performing the Load Test? (Please provide contact details): Does the tester have an NDA? Testing Security Do you have a way to monitor the data traffic for the duration of the test to verify bandwidth limits do not exceed approved rates? Do you have a way to immediately stop the traffic if we/you discover any issue? 2 Emergency contact names and phone numbers:</code> </pre> <br><p>  Il existe plusieurs nuances: </p><br><ol><li><p>  Ils nous demandent qui nous "bronzerons".  Avons-nous droit √† cela?  Nous disons que c'est notre ressource (apparemment, personne ne v√©rifie si c'est le cas) et que les tests sont enti√®rement coh√©rents. </p><br></li><li><p>  Nous devons d√©signer la quantit√© de trafic que nous cr√©erons dans chacune des r√©gions.  Au cours de la correspondance, nous d√©couvrons que chaque r√©gion a sa propre limite sur la quantit√© de trafic r√©seau.  Au total, ils sont autoris√©s √† demander 645 Gb / s.  Nous consid√©rons combien est n√©cessaire pour l'attaque, et nous s√©lectionnons les r√©gions de mani√®re √† obtenir la valeur n√©cessaire. </p><br></li><li><p>  Il est n√©cessaire de d√©crire la dur√©e de l'attaque, sa dur√©e et la croissance de sa puissance.  Sous forme libre, mais avec suffisamment de d√©tails, nous parlons de nos plans.  L'attaque est effectu√©e avec une augmentation progressive de la puissance, nous peignons donc les √©tapes du test et la puissance maximale attendue pour chacune d'elles.  La date de l'attaque peut √™tre omise jusqu'√† un jour; il est tout √† fait possible d'indiquer une plage de deux √† trois semaines. </p><br></li><li><p>  Et sans faute, nous faisons de notre mieux pour nous assurer que nous nous comportons bien, surveiller attentivement la progression des tests et l'arr√™ter √† la premi√®re demande si n√©cessaire. </p><br></li></ol><br><p>  Tr√®s probablement, en r√©ponse au formulaire rempli, ils demanderont des √©claircissements, alors nous correspondons et r√©pondons aux questions jusqu'√† ce que nous obtenions la permission de tester. </p><br><p>  Il faut environ trois jours ouvrables pour terminer le processus d'approbation en cas de r√©ponse rapide. </p><br><h1>  Pr√©paration des infrastructures </h1><br><p>  Apr√®s les approbations, nous sommes confront√©s √† la n√©cessit√© de pr√©parer l'infrastructure pour les tests.  Le fait est que lors de la v√©rification, nous devrons rapidement: </p><br><p>  ‚Ä¢ inclure une instance; </p><br><p>  ‚Ä¢ lancer une attaque test; </p><br><p>  ‚Ä¢ collecter des statistiques sur les progr√®s; </p><br><p>  ‚Ä¢ arr√™ter l'attaque d'essai; </p><br><p>  ‚Ä¢ changer l'adresse IP; </p><br><p>  ‚Ä¢ d√©sactiver l'instance. </p><br><h2>  Cr√©er une image d'instance </h2><br><h3>  S√©lectionnez le type d'instance </h3><br><p>  Commen√ßons par cr√©er une image AWS qui contiendra les outils et scripts n√©cessaires √† la gestion.  La premi√®re √©tape consiste √† choisir l'instance √† louer.  Nous √©tudions les caract√©ristiques des diff√©rents types d'instances: nous regardons le prix, la quantit√© de trafic maximum, la puissance CPU (ce dernier est important, car le trafic est cr√©√© par la puissance du processeur apr√®s tout), puis nous testons les performances r√©elles et le nombre maximum de requ√™tes.  Selon nos estimations, les instances <code>t3.small</code> sont les plus pratiques pour les tests, mais ici tout le monde choisit √† son go√ªt. </p><br><p>  Les caract√©ristiques des instances peuvent √™tre trouv√©es <a href="https://aws.amazon.com/ec2/instance-types/">ici</a> .  Vous pouvez √©galement s√©lectionner et comparer des instances <a href="https://www.ec2instances.info/">ici</a> . </p><br><h3>  Demande de limite </h3><br><p>  Vous devez penser √† l'avance au nombre d'instances qui participeront au test.  Le fait est qu'Amazon pr√©voit pour chaque r√©gion ses limites sur le nombre d'instances.  Si vous avez le sentiment que vous aurez besoin de plus d'instances que ce qui est disponible par d√©faut, vous devez demander une augmentation de la limite le plus t√¥t possible.  Pour ce faire, acc√©dez √† la section <a href="https://console.aws.amazon.com/support/cases">Support</a> , cr√©ez un appel de type Augmentation de la limite de service.  Le temps de traitement d'une demande peut √™tre diff√©rent: quelqu'un r√©pond le lendemain, fournissant autant d'entit√©s que demand√©, quelqu'un dit qu'il ne laissera pas plus de N instances s'ex√©cuter.  Certaines r√©gions ont r√©pondu √† la demande pendant environ un mois. </p><br><h3>  R√©glage des performances </h3><br><p>  Ensuite, vous devez cr√©er une image d'instance qui sera lanc√©e pendant les tests.  Pour ce faire, nous activons l'instance du type s√©lectionn√©, d√©finissons tous les param√®tres dessus, puis enregistrons ce qui s'est pass√© en tant qu'image (dans le menu Actions, o√π vous pouvez activer l'instance, ainsi que la fonctionnalit√© pour cr√©er une image Cr√©er une image). </p><br><p>  Nous devons obtenir le trafic sortant maximal de chaque instance, nous optimisons donc d'abord les param√®tres r√©seau et m√©moire pour notre t√¢che sur l'instance. </p><br><p>  Pour ce faire, <code>/etc/sysctl.conf</code> les param√®tres dans le fichier <code>/etc/sysctl.conf</code> : </p><br><p>  ‚Ä¢ Augmentez la port√©e des ports locaux et r√©duisez le temps pass√© par les sockets dans l'√©tat FIN_WAIT: </p><br><pre> <code class="plaintext hljs">net.ipv4.ip_local_port_range = 1024-65535 ( : 32768-61000) net.ipv4.tcp_fin_timeout = 10 ( : 60)</code> </pre> <br><p>  La plage de ports locaux d√©termine le nombre maximal de sockets sortants qu'un h√¥te peut cr√©er √† partir d'une adresse IP sp√©cifique. </p><br><p>  Avec le param√®tre par d√©faut (61 000‚Äì32 768), 28 233 sockets sont obtenus.  Avec de nouveaux param√®tres - 64 500. </p><br><p>  Fin_timeout d√©finit la dur√©e minimale pendant laquelle les sockets sortants peuvent √™tre dans l'√©tat FIN_WAIT. </p><br><p>  Si des valeurs par d√©faut sont sp√©cifi√©es, le syst√®me ne peut pas fournir plus de (61 000‚Äì32 768) / 60 = 470 sockets par seconde. </p><br><p>  En augmentant port_range et en diminuant fin_timeout, nous pouvons affecter la capacit√© du syst√®me √† g√©n√©rer davantage de connexions sortantes. </p><br><p>  ‚Ä¢ R√©utilisons les sockets dans l'√©tat TIME_WAIT √† la fin des sockets libres: </p><br><pre> <code class="plaintext hljs">net.ipv4.tcp_tw_reuse = 1</code> </pre> <br><p>  La d√©finition de l'option ci-dessus (qui est d√©sactiv√©e par d√©faut) permet de minimiser la perte de connexions "inactives" d√©j√† remplies. </p><br><p>  Des informations tr√®s d√©taill√©es sur TIME_WAIT sont d√©crites dans cet <a href="https://vincent.bernat.ch/en/blog/2014-tcp-time-wait-state-linux">article</a> . </p><br><p>  ‚Ä¢ Activez l'option tcp_timestamps pour que l'option tcp_tw_reuse ci-dessus fonctionne: </p><br><pre> <code class="plaintext hljs">net.ipv4.tcp_timestamps = 1 ‚Äì   `tcp_timestamps`     tcp_tw_reuse</code> </pre> <br><p>  ‚Ä¢ Autres options: </p><br><pre> <code class="plaintext hljs">net.ipv4.tcp_max_tw_buckets = 720000 ‚Äì       TIME_WAIT net.ipv4.tcp_keepalive_time = 600 ‚Äì  - keepalive- net.ipv4.tcp_keepalive_probes = 3 ‚Äì   keepalive- net.ipv4.tcp_keepalive_intvl = 10 ‚Äì     keepalive- net.ipv4.tcp_window_scaling = 1 ‚Äì   TCP- net.ipv4.tcp_mem = 8192 131072 196304 ‚Äì     TCP- net.ipv4.udp_mem = 8192 131072 196304 ‚Äì     udp- net.ipv4.tcp_slow_start_after_idle=0 ‚Äì  Slow-Start Restart net.core.wmem_default = 31457280 ‚Äì         net.core.wmem_max = 33554432 ‚Äì        net.core.somaxconn = 65535 ‚Äì        net.core.netdev_max_backlog = 65535 ‚Äì          vm.swappiness = 30 ‚Äì    vm.dirty_ratio = 50 ‚Äì     50 %  vm.pagecache = 90 ‚Äì    </code> </pre> <br><h3>  Tester les scripts d'attaque </h3><br><p>  <strong>1. Attaque DNS</strong> </p><br><p>  L'une des principales t√¢ches des tests consiste √† √©valuer les performances des serveurs DNS.  √Ä savoir, les serveurs DNS peuvent devenir le goulot d'√©tranglement de la tol√©rance aux pannes d'un site, car m√™me si le service le plus stable n'est pas disponible en cas de probl√®me avec DNS.  Pour cr√©er une charge sur les serveurs DNS, nous allons g√©n√©rer de nombreuses requ√™tes DNS diff√©rentes.  Les demandes doivent √™tre valides et n√©cessitent la r√©ponse la plus large et la plus longue possible du serveur DNS. </p><br><p>  L'utilitaire <a href="https://www.dns-oarc.net/tools/dnsperf">DNSPerf</a> convient pour g√©n√©rer un tel trafic. </p><br><p>  DNSPerf est un outil de test de performances DNS simple, flexible et gratuit.  Il est principalement con√ßu pour les serveurs DNS faisant autorit√©, mais peut √©galement √™tre utilis√© pour mesurer les performances des serveurs de mise en cache. </p><br><p>  Dans notre cas, des serveurs DNS faisant autorit√© sont charg√©s et desservent une zone - example.com. </p><br><p>  Pour DNSPerf, nous pr√©parons d'abord un fichier avec les requ√™tes <code>dns_queries.txt</code> (principalement TOUT pour augmenter le temps et la taille de la r√©ponse du serveur DNS): </p><br><pre> <code class="plaintext hljs">#dns_queries.txt example.com ANY www.example.com ANY test.example.com ANY static.example.com ANY example.com  www.example.com  test.example.com MX</code> </pre> <br><p>  Exemple d'ex√©cution de l'utilitaire: </p><br><pre> <code class="plaintext hljs">dnsperf -s TARGET_IP -d dns_queries.txt -c 100 -n 100 -s =  IP- -d =      .   ‚Äì stdin -c =   .         -n =  ¬´¬ª   .</code> </pre> <br><p>  <strong>2. Attaque contre ICMP</strong> </p><br><p>  La prochaine √©tape des tests consiste √† √©valuer la r√©sistance √† un grand nombre de trafic ICMP.  √âtant donn√© que, pour des raisons techniques, les serveurs doivent souvent √™tre en mesure de r√©pondre aux requ√™tes ping, il existe une possibilit√© d'attaque DDoS utilisant des requ√™tes ping.  En plus de sp√©cifier des param√®tres qui excluent la possibilit√© de <code>ping-to-death</code> , vous devez vous assurer que les serveurs sont r√©sistants aux pics de charge ICMP.  Pour cr√©er de telles charges, il est pr√©f√©rable d'utiliser l'utilitaire <a href="https://linux.die.net/man/8/hping3">hping3</a> bien connu, qui vous permet d'ajuster le nombre de demandes, l'intervalle entre les envois, ainsi que la taille des paquets. </p><br><p>  Exemple d'ex√©cution de l'utilitaire: </p><br><pre> <code class="plaintext hljs">hping3 -i u1000 -d 1500 -c 100000 -1 TARGET_IP -i u100 =     (uX for X microseconds) -d 1500 =    -c 1000000 =     -1 =  ICMP</code> </pre> <br><p>  <strong>3. Attaque HTTP</strong> </p><br><p>  Maintenant, nous v√©rifions la r√©sistance au stress, la principale fonctionnalit√© du trafic HTTP (S) de traitement des services.  L'un des outils les plus flexibles et les plus simples pour g√©n√©rer du trafic HTTP est le <a href="https://linux.die.net/man/1/siege">si√®ge</a> .  Siege est un utilitaire multithread open source con√ßu pour tester les performances d'une ressource Web. </p><br><p>  Comme DNSPerf, siege vous permet de charger le serveur avec les demandes d'un nombre donn√© d'utilisateurs virtuels (l'√©mulation des utilisateurs est effectu√©e √† l'aide d'un port s√©par√©), ainsi que d'utiliser un ensemble pr√©d√©fini de demandes.  Ceci est tr√®s pratique, car vous pouvez inclure les requ√™tes les plus gourmandes en ressources dans le test. </p><br><p>  Exemple d'ex√©cution de l'utilitaire: </p><br><pre> <code class="plaintext hljs">siege -b -c 100 -f test_urls.txt -b =   ( benchmark) -c =   .         -f =   </code> </pre> <br><p>  Format de contenu <code>test_urls.txt</code> : </p><br><pre> <code class="plaintext hljs">http://example.com/site/login POST login=username&amp;password=test http://example.com/site/client POST useragent=Mozilla&amp;version=123&amp;date=24May http://example.com/site/order POST user=username&amp;company=ooo&amp;phone=812345678</code> </pre> <br><p>  Comme vous pouvez le voir, les tests ont √©t√© effectu√©s en utilisant principalement des requ√™tes POST qui n√©cessitent un traitement c√¥t√© serveur et occupent le plus grand nombre de ressources par rapport aux autres types de requ√™tes. </p><br><p>  Aucune des options n'utilise l'usurpation d'adresse IP, car Amazon ne le permet pas.  Quel que soit src_IP sp√©cifi√© dans le package, il sera remplac√© par le bon √† la sortie de l'instance. </p><br><p>  Toutes les demandes g√©n√©r√©es doivent √™tre l√©gitimes - aucune vague de trafic sortant sans r√©ponse - car la politique DDoS d'Amazon est assez stricte.  M√™me un test de stress coordonn√© prend un minimum de plusieurs jours pour communiquer avec le support technique, et lors des premi√®res actions "malveillantes" nous obtenons l'interdiction du port d'o√π le trafic est sorti, et l'exigence doit √™tre expliqu√©e imm√©diatement. </p><br><h3>  Scripts pour lancer des attaques </h3><br><p>  Pour la gestion des tests √† distance, nous pr√©parerons des scripts bash (dns.sh, ping.sh, http.sh) qui lancent le type d'attaque souhait√© et des fichiers de charge utile (test_urls.txt, valid_dns_queries.txt). </p><br><p>  Lorsque nous t√©l√©chargeons tout cela sur l'image AWS (√† partir de laquelle toutes les instances seront cr√©√©es), chaque test peut √™tre ex√©cut√© √† distance √† l'aide de la commande du format suivant: </p><br><pre> <code class="plaintext hljs">ssh instance-amazon 'sudo &lt;stress-script&gt;.sh start &lt;params&gt; &amp;&gt;&gt;stress.log &amp;'</code> </pre> <br><p>  Le script du type requis est sp√©cifi√© sous la forme stress-script.sh et params sont les param√®tres correspondants.  Dans le fichier stress.log, nous suivrons la sortie de l'utilitaire en cours d'ex√©cution.  Pour plus de commodit√©, nous utiliserons diff√©rents journaux pour diff√©rents utilitaires: dns.log, ping.log, http.log. </p><br><p>  Exemple de script <code>dns.sh</code> : </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash if [[ ! "$1" =~ ^(start|stop|status)$ ]]; then echo "nothing to do: need argument for stop,start or status" exit 1 fi if [[ "$1" = "start" ]]; then shift dnsperf $@ fi if [[ "$1" = "stop" ]]; then kill $(pidof dnsperf) fi if [[ "$1" = "status" ]]; then if [[ ! "$(pidof dnsperf)" = "" ]]; then echo "dnperf is running with PID $(pidof dnsperf)" ps aux | grep dnsperf else echo "dnsperf is not running" fi fi</span></span></code> </pre> <br><p>  Comme le montre le code, le script peut √™tre d√©marr√© et arr√™t√©, ainsi que v√©rifier l'√©tat (en cours / non en cours d'ex√©cution). </p><br><p>  Les scripts pour les tests ICMP et HTTP sont construits de la m√™me mani√®re, en d√©marrant hping3 et siege, respectivement, avec la cha√Æne de param√®tres pass√©e √† travers l'argument. </p><br><p>  Exemples de commandes: </p><br><pre> <code class="plaintext hljs">ssh instance-amazon 'sudo dns.sh start -s TARGET_IP -d valid_dns_queries.txt -c 1 -n 100 &amp;&gt;&gt;dns.log &amp;' ssh instance-amazon 'sudo ping.sh start -i u1000 -d 1500 -c 100000 -1 TARGET_IP &amp;&gt;&gt;ping.log &amp;' ssh instance-amazon 'sudo http.sh start -b -c 100 -f test_urls.txt &amp;&gt;&gt; http.log &amp;'</code> </pre> <br><h3>  Surveiller les scripts </h3><br><p>  Pour √©valuer le trafic sortant et l'√©tat de l'infrastructure de test, nous avons besoin d'un outil de surveillance.  Pour des raisons de simplicit√© et d'√©conomie de ressources, nous utilisons iptables.  Pour ce faire, nous allons √©crire un script qui compte le nombre de Mo envoy√©s et le placer sur l'image AWS: </p><br><pre> <code class="plaintext hljs">#iptables.sh sudo iptables -N TRAFFIC_OUT sudo iptables -A TRAFFIC_OUT -p tcp sudo iptables -A TRAFFIC_OUT -p udp sudo iptables -A TRAFFIC_OUT -p icmp sudo iptables -A OUTPUT -j TRAFFIC_OUT sudo iptables-save</code> </pre> <br><p>  Le script cr√©e une nouvelle cha√Æne TRAFFIC_OUT et y ajoute des filtres pour les protocoles n√©cessaires: tcp, udp, icmp. </p><br><p>  Le transfert de paquets vers TRAFFIC_OUT est ajout√© √† la cha√Æne OUTPUT. </p><br><p>  La quantit√© de donn√©es transf√©r√©es peut √™tre trouv√©e par la commande: </p><br><pre> <code class="plaintext hljs"># iptables -L TRAFFIC_OUT -v -n -x | tail -n 3 | awk '{print $2/1024/1024,"Mb\t\t\t",$3}' : 2.2 Mb tcp 4.4 Mb udp 3.2 Mb icmp</code> </pre> <br><p>  Installez le script en tant que service.  Pour ce faire, cr√©ez un fichier monitoring.service et d√©placez-le dans le r√©pertoire <code>/etc/systemd/system</code> de notre image: </p><br><pre> <code class="plaintext hljs"># /etc/systemd/system/monitoring.service [Unit] After=network.target [Service] ExecStart=/usr/local/bin/monitoring.sh [Install] WantedBy=default.target</code> </pre> <br><p>  Vous pouvez maintenant ajouter le service au d√©marrage: </p><br><pre> <code class="plaintext hljs">systemctl enable monitoring.service systemctl start monitoring.service</code> </pre> <br><h2>  Gestion des instances </h2><br><p>  Passons maintenant √† la gestion des instances √† distance (aussi automatis√©e que possible). </p><br><p>  √Ä ces fins, vous pouvez utiliser le m√©canisme <a href="https://aws.amazon.com/ru/cli/">AWS CLI</a> - gestion de la console. </p><br><p>  Cr√©ez une <a href="https://console.aws.amazon.com/iam/home%3Fnc2%3Dh_m_sc">cl√© secr√®te</a> (cl√©s d'acc√®s (ID de cl√© d'acc√®s et cl√© d'acc√®s secr√®te)) et configurez la console. </p><br><p>  Nous avons maintenant acc√®s √† toutes les fonctionnalit√©s du compte. </p><br><p>  La particularit√© de travailler avec AWS est que toutes les actions sont effectu√©es pour une r√©gion sp√©cifique et doivent √™tre r√©p√©t√©es si plusieurs r√©gions sont impliqu√©es. </p><br><p>  Pour cr√©er une nouvelle instance √† partir de l'image que nous avons construite ci-dessus (nous supposons qu'il existe un ami-ID public que nous utilisons dans le script), nous ferons ce qui suit: </p><br><ul><li>  cr√©ez une cl√© SSH et ajoutez-la √† AWS: </li></ul><br><pre> <code class="bash hljs">yes n |ssh-keygen -q -t rsa -f <span class="hljs-variable"><span class="hljs-variable">$KEYNAME</span></span> -m pem -N <span class="hljs-string"><span class="hljs-string">""</span></span> &gt; /dev/null chmod 400 <span class="hljs-variable"><span class="hljs-variable">$KEYNAME</span></span> aws ec2 import-key-pair --region <span class="hljs-variable"><span class="hljs-variable">$REGION</span></span> --key-name <span class="hljs-variable"><span class="hljs-variable">$KEYNAME</span></span> --public-key-material file:///$(<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span>)/<span class="hljs-variable"><span class="hljs-variable">$KEYNAME</span></span>.pub</code> </pre> <br><ul><li>  cr√©er un groupe de s√©curit√© qui permet l'acc√®s √† la machine via SSH.  Sinon, les connexions SSH entrantes seront refus√©es: </li></ul><br><pre> <code class="bash hljs">SECURITY=<span class="hljs-string"><span class="hljs-string">"ssh-group"</span></span> aws ec2 create-security-group --region <span class="hljs-variable"><span class="hljs-variable">$REGION</span></span> --group-name <span class="hljs-variable"><span class="hljs-variable">$SECURITY</span></span> --description <span class="hljs-string"><span class="hljs-string">"Just ssh. Nothing more"</span></span> IP_RANGE=<span class="hljs-string"><span class="hljs-string">"0.0.0.0/24"</span></span> aws ec2 authorize-security-group-ingress --region <span class="hljs-variable"><span class="hljs-variable">$REGION</span></span> --group-name <span class="hljs-variable"><span class="hljs-variable">$SECURITY</span></span> --protocol tcp --port 22 --cidr <span class="hljs-variable"><span class="hljs-variable">$IP_RANGE</span></span></code> </pre> <br><ul><li>  cr√©ez une instance avec la cl√© et le groupe de s√©curit√© cr√©√©s pr√©c√©demment et sp√©cifiez l'ID d'image.  Le nombre d'instances cr√©√©es simultan√©ment peut √™tre arbitraire: </li></ul><br><pre> <code class="bash hljs">IMG=<span class="hljs-string"><span class="hljs-string">'ami-0d0eaed20348a3389'</span></span> NUM=1 aws ec2 run-instances --region <span class="hljs-variable"><span class="hljs-variable">$REGION</span></span> --image-id <span class="hljs-variable"><span class="hljs-variable">$IMG</span></span> --count <span class="hljs-variable"><span class="hljs-variable">$NUM</span></span> --instance-type t2.micro --key-name <span class="hljs-variable"><span class="hljs-variable">$KEYNAME</span></span> --security-groups default <span class="hljs-variable"><span class="hljs-variable">$SECURITY</span></span> &gt; instances.json</code> </pre> <br><ul><li>  attendez que la machine soit initialis√©e.  Cela prend un certain temps: nous obtenons d'abord une r√©ponse de r√©ussite (instances.json), mais √† ce moment-l√†, la machine vient d'√™tre cr√©√©e, mais pas encore d√©marr√©e (par exemple, aucune adresse IP n'a encore √©t√© attribu√©e).  Il faut attendre la fin du lancement (g√©n√©ralement une minute suffit). </li></ul><br><p>  Ensuite, vous pouvez vous connecter via SSH si nous connaissons l'adresse IP.  Demandez simplement une liste des machines en cours d'ex√©cution.  Parmi leurs param√®tres, nous trouvons PublicDnsName ou PublicIpAddress. </p><br><pre> <code class="bash hljs">aws ec2 describe-instances --region</code> </pre> <br><p>  Ensuite, nous ex√©cutons les commandes SSH, indiquant la cl√© SSH cr√©√©e ci-dessus: </p><br><pre> <code class="plaintext hljs">ssh -I $KEYNAME -oStrictHostKeyChecking=no ubuntu''+ins_dns echo''O''</code> </pre> <br><p>  Les commandes SSH vous permettent de contr√¥ler l'attaque et d'obtenir toutes les informations sur l'√©tat de l'attaque, car nous avons fourni aux instances tous les scripts et outils n√©cessaires. </p><br><p>  Vous devez comprendre que la plupart des d√©fenses contre les attaques par d√©ni de service bloquent l'adresse IP √† partir de laquelle de nombreuses demandes sont re√ßues de mani√®re anormale.  Par cons√©quent, les adresses IP des machines virtuelles doivent constamment changer afin de maintenir la puissance d'attaque. </p><br><p>  AWS attribue une nouvelle adresse IP √† chaque d√©marrage de la machine.  Par cons√©quent, pour changer l'adresse IP, vous devez √©teindre et rallumer la machine (pas besoin de la retirer!). </p><br><p>  La diff√©rence entre l'arr√™t et la suppression est que nous envoyons des signaux diff√©rents.  Arr√™ter - pour d√©sactiver, terminer - pour d√©sactiver et supprimer imm√©diatement. </p><br><p>  Afin de surveiller le trafic entrant d'une instance, nous utilisons la commande suivante avec l'ID d'instance: quand la mesure du trafic commence, quand elle se termine, pour quelle p√©riode les valeurs sont additionn√©es: </p><br><pre> <code class="bash hljs">aws cloudwatch get-metric-statistics --region REGION --namespace AWS/EC2 \ --statistics Sum --metric-name NetworkIn --start-time <span class="hljs-variable"><span class="hljs-variable">$STARTTIME</span></span> --end-time <span class="hljs-variable"><span class="hljs-variable">$FINISHTIME</span></span> --period <span class="hljs-variable"><span class="hljs-variable">$PERIOD</span></span> --dimensions Name=InstanceId,Value=<span class="hljs-variable"><span class="hljs-variable">$INCTANCEID</span></span></code> </pre> <br><h1>  Surveillance de la disponibilit√© des services </h1><br><p>  De plus, pour mener une attaque, vous devrez observer si le service que nous testons est vivant. </p><br><p>  Nous cr√©ons et ex√©cutons le script de ¬´ping¬ª le plus simple qui surveille la disponibilit√© des ports cibles (53 et 80 dans notre cas). </p><br><p>  Exemple de code Python qui automatise la v√©rification de la disponibilit√©: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">http</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(url)</span></span></span><span class="hljs-function">:</span></span> cmd = [<span class="hljs-string"><span class="hljs-string">'curl'</span></span>, <span class="hljs-string"><span class="hljs-string">'-w'</span></span>, <span class="hljs-string"><span class="hljs-string">'"%{time_total}"'</span></span>, <span class="hljs-string"><span class="hljs-string">'-o'</span></span>, <span class="hljs-string"><span class="hljs-string">'/dev/null'</span></span>, <span class="hljs-string"><span class="hljs-string">'-s'</span></span>, url] result = check_output(cmd).decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) result = float(json.loads(result)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result * <span class="hljs-number"><span class="hljs-number">1000000</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dns</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ip, domain)</span></span></span><span class="hljs-function">:</span></span> cmd = [<span class="hljs-string"><span class="hljs-string">'dig'</span></span>, <span class="hljs-string"><span class="hljs-string">'any'</span></span>, <span class="hljs-string"><span class="hljs-string">'@'</span></span>+ip, domain ] result = check_output(cmd).decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) result = int(result.split(<span class="hljs-string"><span class="hljs-string">'Query time:'</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>].split(<span class="hljs-string"><span class="hljs-string">'msec'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result</code> </pre> <br><p>  Les informations re√ßues sont stock√©es dans un fichier journal, sur la base duquel, sur la base des r√©sultats de l'attaque, il sera possible de construire un graphique de disponibilit√© des ressources. </p><br><p>  Lors des tests, il est n√©cessaire de v√©rifier en permanence le journal ¬´ping¬ª afin de ne pas tuer compl√®tement et irr√©vocablement la ressource.  D√®s qu'une d√©gradation importante appara√Æt et que la r√©ponse √† la demande prend trop de temps, l'attaque doit √™tre arr√™t√©e. </p><br><p>  Si le ralentissement est insignifiant et que la puissance d'attaque a atteint le maximum d√©fini, il est logique d'attendre une minute ou deux et si le service continue de fonctionner sans interruption, la v√©rification est consid√©r√©e comme r√©ussie. </p><br><h1>  Probl√®me financier </h1><br><p>  Il vaut la peine de discuter d'une autre question li√©e √† l'organisation des tests - le co√ªt de l'ensemble de cet √©v√©nement. </p><br><p>  Amazon fournit des informations d√©taill√©es sur les prix, mais vous devez comprendre que vous devez payer pour presque tout.  N√©anmoins, de nombreux calculs peuvent √™tre n√©glig√©s.  Tout d'abord, il vaut la peine de calculer le co√ªt du trafic (cela d√©pend de la r√©gion et de la quantit√© totale d'informations qui seront transmises) et le co√ªt de la location des instances (paiement par minute).  Ces objets repr√©sentent environ 99% du co√ªt de toute l'attaque. </p><br><p>  Par cons√©quent, le co√ªt d'une attaque est calcul√© dans chaque cas s√©par√©ment, en fonction de la [puissance des hostilit√©s] puissance d'attaque maximale et du nombre de lancements pr√©vus. </p><br><p>  Du point de vue de la simplification des calculs, il est pr√©f√©rable d'utiliser un compte Amazon, qui a √©t√© enregistr√© il y a moins d'un an.  Une partie des op√©rations sera alors gratuite.  En savoir plus sur les limites d'utilisation gratuite <a href="https://aws.amazon.com/ru/free/%3Fall-free-tier.sort-by%3Ditem.additionalFields.SortRank%26all-free-tier.sort-order%3Dasc">ici</a> . </p><br><p>  Afin d'illustrer le calcul du co√ªt de r√©alisation des tests de charge, disons que nous voulons v√©rifier la stabilit√© du serveur DNS √† une charge de 10 Gb / s. </p><br><p>  Nous savons que les outils utilis√©s et les capacit√©s de l'instance t3.small lanc√©e √† Mumbai vous permettent d'√©mettre 500 Mb / s √† partir d'une instance en cours d'ex√©cution.  Le prix de location d'une entit√© est de 0,0224 $ l'heure, pour le trafic - 0,01093 $ pour 1 Go.  Autrement dit, le pic de l'attaque signifie le fonctionnement simultan√© de 20 entit√©s. </p><br><p>  Nous augmenterons progressivement la puissance d'attaque, pour cela nous lan√ßons d'abord une entit√©, puis nous en ajoutons une autre toutes les 60 s. </p><br><p>  La formule de calcul du co√ªt prend la forme: </p><br><pre> <code class="plaintext hljs">60  * (   ) + 60  * 0,5 /c * (  ) =       60 . 1 * (    ) + 2 * (    ) + ... + 20 * (    ) =   </code> </pre> <br><p>  Il s'av√®re que le co√ªt d'une attaque d'une capacit√© de 10 Gb / s sur un serveur DNS est d'environ 70 $.  Notez qu'il s'agit d'une estimation approximative, car le volume de trafic ne peut pas √™tre pr√©vu avec pr√©cision.      <a href="https://aws.amazon.com/ru/ec2/pricing/on-demand/"></a> .  ,   ‚Äì    ,     . </p><br><p>       .          . </p><cut></cut></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr481756/">https://habr.com/ru/post/fr481756/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr481746/index.html">Configuration de l'environnement dans la CLI. Terminal WSL / Windows</a></li>
<li><a href="../fr481748/index.html">Avantages sociaux en Arm√©nie: de l'assurance et des primes de r√©f√©rence au massage et aux pr√™ts</a></li>
<li><a href="../fr481750/index.html">Num√©ro de t√¢che 3. Conversion de donn√©es et t√©l√©chargement vers des services tiers</a></li>
<li><a href="../fr481752/index.html">R√©sultats de l'enqu√™te linguistique</a></li>
<li><a href="../fr481754/index.html">Moi bot et mon poin√ßon</a></li>
<li><a href="../fr481758/index.html">Statistiques de construction, d'approvisionnement et de visites √† l'ISS</a></li>
<li><a href="../fr481762/index.html">√âquations pour la cuisine sous le sapin de No√´l</a></li>
<li><a href="../fr481764/index.html">Pourquoi l'√©nergie verte a-t-elle un avenir difficile?</a></li>
<li><a href="../fr481768/index.html">Nous traitons WebKit dans 1C, par exemple, l'int√©gration de TinyMCE dans un formulaire g√©r√© dans UT 11.4</a></li>
<li><a href="../fr481776/index.html">Services de jeux 5G et cloud - testez comment cela fonctionne √† Moscou</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>