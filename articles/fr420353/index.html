<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïß üéê üé• Nous rendons Shrimp encore plus utile: ajoutez le transcodage d'images √† d'autres formats ü•â üë©‚Äçüíª üéπ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Depuis d√©but 2017, notre petite √©quipe d√©veloppe la biblioth√®que RESTinio OpenSource pour embarquer un serveur HTTP dans des applications C ++. √Ä notr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nous rendons Shrimp encore plus utile: ajoutez le transcodage d'images √† d'autres formats</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/420353/"><img src="https://habrastorage.org/webt/7w/iy/b5/7wiyb5u0fpwa1duglcppwofjloa.jpeg"><br><br>  Depuis d√©but 2017, notre petite √©quipe d√©veloppe la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">biblioth√®que RESTinio OpenSource</a> pour embarquer un serveur HTTP dans des applications C ++.  √Ä notre grande surprise, nous recevons de temps en temps des questions de la cat√©gorie ¬´Et pourquoi un serveur HTTP C ++ int√©gr√© pourrait-il √™tre n√©cessaire?¬ª  Malheureusement, les questions simples sont les plus difficiles √† r√©pondre.  Parfois, la meilleure r√©ponse est un exemple de code. <br><br>  Il y a quelques mois, nous avons lanc√© un petit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">projet de d√©monstration, Shrimp</a> , qui illustre clairement un sc√©nario typique, dans lequel notre biblioth√®que est ¬´aff√ªt√©e¬ª.  Le projet de d√©monstration est un simple service Web qui re√ßoit des demandes de mise √† l'√©chelle des images stock√©es sur le serveur et qui renvoie une image de la taille dont l'utilisateur a besoin. <br><br>  Ce projet de d√©monstration est bon dans la mesure o√π, premi√®rement, il n√©cessite une int√©gration avec du code √©crit et fonctionnant correctement en C ou C ++ (dans ce cas, ImageMagick).  Par cons√©quent, il devrait √™tre clair pourquoi il est judicieux d'incorporer le serveur HTTP dans une application C ++. <br><br>  Et deuxi√®mement, dans ce cas, le traitement des demandes asynchrones est n√©cessaire pour que le serveur HTTP ne se bloque pas pendant la mise √† l'√©chelle de l'image (et cela peut prendre des centaines de millisecondes ou m√™me des secondes).  Et nous avons commenc√© le d√©veloppement de RESTinio pr√©cis√©ment parce que nous ne pouvions pas trouver un serveur embarqu√© sain C ++ ax√© sp√©cifiquement sur le traitement des demandes asynchrones. <br><br>  Nous avons construit le travail sur Shrimp de mani√®re it√©rative: d'abord, la version la plus simple a √©t√© faite et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©crite</a> , qui ne faisait que redimensionner les images.  Ensuite, nous avons corrig√© un certain nombre de lacunes de la premi√®re version et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©crit cela dans le deuxi√®me article</a> .  Enfin, nous nous sommes d√©plac√©s pour √©tendre encore une fois la fonctionnalit√© de Shrimp: la conversion d'images d'un format √† un autre a √©t√© ajout√©e.  Comment cela a √©t√© fait et sera discut√© dans cet article. <br><a name="habracut"></a><br><h1>  Prise en charge du format cible </h1><br>  Ainsi, dans la prochaine version de Shrimp, nous avons ajout√© la possibilit√© de donner une image √† l'√©chelle dans un format diff√©rent.  Donc, si vous √©mettez une demande de crevettes du formulaire: <br><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">curl</span></span> <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/my_picture.jpg?op=resize&amp;max=1920"</span></span></code> </pre> <br>  puis Shrimp rendra l'image au m√™me format JPG que l'image originale. <br><br>  Mais si vous ajoutez le param√®tre de format cible √† l'URL, Shrimp convertit l'image au format cible sp√©cifi√©.  Par exemple: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">curl</span></span> <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/my_picture.jpg?op=resize&amp;max=1920&amp;target-format=webp"</span></span></code> </pre> <br>  Dans ce cas, Shrimp rendra l'image au format webp. <br><br>  Shrimp mis √† jour prend en charge cinq formats d'image: jpg, png, gif, webp et heic (√©galement connu sous le nom de HEIF).  Vous pouvez exp√©rimenter diff√©rents formats <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sur une page Web sp√©ciale</a> : <br><br><img src="https://habrastorage.org/webt/99/ab/ke/99abkec8ode-lxyxufceqjmwxt8.png"><br><br>  (sur cette page, il n'y a aucun moyen de s√©lectionner le format heic, car les navigateurs de bureau ordinaires ne prennent pas en charge ce format par d√©faut). <br><br>  Afin de prendre en charge le format cible dans Shrimp, il a √©t√© n√©cessaire de modifier l√©g√®rement le code Shrimp (ce qui nous a surpris nous-m√™mes, car il y avait vraiment peu de changements).  Mais d'un autre c√¥t√©, j'ai d√ª jouer avec l'assemblage d'ImageMagick, ce qui nous a encore plus surpris, comme  Plus t√¥t, nous avons d√ª composer avec cette cuisine, par un heureux hasard.  Mais parlons de tout dans l'ordre. <br><br><h2>  ImageMagick doit comprendre diff√©rents formats </h2><br>  ImageMagick utilise des biblioth√®ques externes pour encoder / d√©coder les images: libjpeg, libpng, libgif, etc.  Ces biblioth√®ques doivent √™tre install√©es sur le syst√®me avant que ImageMagick ne soit configur√© et construit. <br><br>  La m√™me chose devrait se produire pour qu'ImageMagick prenne en charge les formats webp et heic: vous devez d'abord construire et installer libwebp et libheif, puis configurer et installer ImageMagick.  Et si tout est simple avec libwebp, alors autour de libheif j'ai du danser avec un tambourin.  Bien qu'apr√®s un certain temps, apr√®s que tout se soit enfin r√©uni et ait fonctionn√©, ce n'√©tait d√©j√† pas clair: pourquoi avez-vous d√ª recourir √† un tambourin, tout semble √™tre trivial?  ;) <br><br>  En g√©n√©ral, si quelqu'un veut se lier d'amiti√© avec heic et ImageMagick, vous devrez installer: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">x265 de videolan.org</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">libde265</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">libheif</a> </li></ul><br>  C'est dans cet ordre (vous devrez peut-√™tre installer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nasm</a> pour que x265 fonctionne √† la vitesse maximale).  Ensuite, lors de l' <i>ex√©cution de la</i> commande <i>./configure</i> , ImageMagick pourra trouver tout ce dont il a besoin pour prendre en charge les fichiers .heic. <br><br><h2>  Prise en charge du format cible dans la cha√Æne de requ√™te des demandes entrantes </h2><br>  Apr√®s avoir fait des amis ImageMagick avec les formats webp et heic, il est temps de modifier le code Shrimp.  Tout d'abord, nous devons apprendre √† reconna√Ætre l'argument de format cible dans les requ√™tes HTTP entrantes. <br><br>  Du point de vue de RESTinio, ce n'est pas du tout un probl√®me.  Eh bien, un autre argument est apparu dans la cha√Æne de requ√™te, alors quoi?  Mais du point de vue de Shrimp, la situation s'est av√©r√©e √™tre un peu plus compliqu√©e, donc le code de la fonction qui √©tait responsable de l'analyse de la requ√™te HTTP √©tait compliqu√©. <br><br>  Le fait est qu'avant il fallait distinguer seulement deux situations: <br><br><ul><li>  est venu une demande de la forme "/filename.ext" sans aucun autre param√®tre.  Il vous suffit donc de donner le fichier "filename.ext" tel quel; </li><li>  Une demande est arriv√©e sous la forme "/filename.ext?op=resize &amp; ...".  Dans ce cas, vous devez redimensionner l'image √† partir du fichier "filename.ext". </li></ul><br>  Mais apr√®s avoir ajout√© le format cible, nous devons distinguer quatre situations: <br><br><ul><li>  est venu une demande de la forme "/filename.ext" sans aucun autre param√®tre.  Il vous suffit donc de donner le fichier "filename.ext" tel quel, sans mise √† l'√©chelle et sans transcodage vers un autre format; </li><li>  est venu une demande du formulaire "/filename.ext?target-format=fmt" sans aucun autre param√®tre.  Cela signifie prendre une image du fichier "filename.ext" et la transcoder au format "fmt" tout en conservant les tailles originales; </li><li>  une demande est venue de la forme "/filename.ext?op=resize &amp; ..." mais sans format cible.  Dans ce cas, vous devez redimensionner l'image √† partir du fichier ¬´filename.ext¬ª et la donner au format d'origine; </li><li>  Une demande est venue du formulaire "/filename.ext?op=resize&amp;...&amp;target-format=fmt".  Dans ce cas, vous devez effectuer une mise √† l'√©chelle, puis transcoder le r√©sultat au format ¬´fmt¬ª. </li></ul><br>  Par cons√©quent, la fonction de d√©termination des param√®tres de requ√™te a pris la <a href="https://bitbucket.org/sobjectizerteam/shrimp-demo/src/4049abf4ca148fb0d291239b28135315d5f4053f/dev/shrimp/">forme suivante</a> : <br><br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">void</span></span> add_transform_op_handler( const app_params_t &amp; app_params, http_req_router_t &amp; router, so_5::mbox_t req_handler_mbox ) { router.http_get( R"(/:path(.*)\.:ext(.{3,4}))", restinio::path2regex::options_t{}.<span class="hljs-keyword"><span class="hljs-keyword">strict</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> ), [req_handler_mbox, &amp;app_params]( auto req, auto params ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( has_illegal_path_components( req-&gt;<span class="hljs-keyword"><span class="hljs-keyword">header</span></span>().path() ) ) { //     . <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> do_400_response( std::<span class="hljs-keyword"><span class="hljs-keyword">move</span></span>( req ) ); } //   . const auto qp = restinio::parse_query( req-&gt;<span class="hljs-keyword"><span class="hljs-keyword">header</span></span>().query() ); const auto target_format = qp.get_param( "target-format"sv ); //        // .   target-<span class="hljs-keyword"><span class="hljs-keyword">format</span></span>,    //   .   target-<span class="hljs-keyword"><span class="hljs-keyword">format</span></span>  // ,    ,  //    . const auto image_format = try_detect_target_image_format( params[ "ext" ], target_format ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !image_format ) { //     .   . <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> do_400_response( std::<span class="hljs-keyword"><span class="hljs-keyword">move</span></span>( req ) ); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !qp.size() ) { //    ,    . <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> serve_as_regular_file( app_params.m_storage.m_root_dir, std::<span class="hljs-keyword"><span class="hljs-keyword">move</span></span>( req ), *image_format ); } const auto operation = qp.get_param( "op"sv ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( operation &amp;&amp; "resize"sv != *operation ) { //    ,     resize. <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> do_400_response( std::<span class="hljs-keyword"><span class="hljs-keyword">move</span></span>( req ) ); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !operation &amp;&amp; !target_format ) { //      op=resize, //   target-<span class="hljs-keyword"><span class="hljs-keyword">format</span></span>=something. <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> do_400_response( std::<span class="hljs-keyword"><span class="hljs-keyword">move</span></span>( req ) ); } handle_resize_op_request( req_handler_mbox, *image_format, qp, std::<span class="hljs-keyword"><span class="hljs-keyword">move</span></span>( req ) ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> restinio::request_accepted(); } ); }</code> </pre> <br>  Dans la version pr√©c√©dente de Shrimp, o√π vous n'aviez pas besoin de transcoder l'image, travailler avec les param√®tres de requ√™te <a href="https://bitbucket.org/sobjectizerteam/shrimp-demo/src/3e8beeeb8935f84e492af188dd6fc6f2ba785657/dev/shrimp/">semblait un peu plus facile</a> . <br><br><h2>  File d'attente de demande et cache d'images adapt√©s au format cible </h2><br>  Le point suivant dans l'impl√©mentation de la prise en charge du format cible a √©t√© le travail sur la file d'attente des demandes en attente et un cache d'images pr√™tes √† l'emploi dans l'agent a_transform_manager.  Nous avons parl√© de ces choses plus en d√©tail <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dans l'article pr√©c√©dent</a> , mais rappelons-nous un peu de quoi il s'agissait. <br><br>  Lorsqu'une demande de conversion d'image arrive, il peut s'av√©rer que l'image finie avec de tels param√®tres est d√©j√† dans le cache.  Dans ce cas, vous n'avez rien √† faire, envoyez simplement l'image du cache en r√©ponse.  Si l'image doit √™tre transform√©e, il peut s'av√©rer qu'il n'y a pas de travailleurs libres pour le moment et vous devez attendre qu'elle apparaisse.  Pour ce faire, les informations de demande doivent √™tre mises en file d'attente.  Mais en m√™me temps, il est n√©cessaire de v√©rifier l'unicit√© des demandes - si nous avons trois demandes identiques en attente de traitement (c'est-√†-dire que nous devons convertir la m√™me image de la m√™me mani√®re), nous ne devons traiter l'image qu'une seule fois et donner le r√©sultat du traitement en r√©ponse √† ces trois demandes.  C'est-√†-dire  Dans la file d'attente, des demandes identiques doivent √™tre regroup√©es. <br><br>  Plus t√¥t dans Shrimp, nous avons utilis√© une simple cl√© composite pour rechercher le cache d'image et la file d'attente: une <a href="">combinaison du nom de fichier d'origine + des options de redimensionnement de l'image</a> .  Maintenant, deux nouveaux facteurs devaient √™tre pris en compte: <br><br><ul><li>  premi√®rement, le format d'image cible (c'est-√†-dire que l'image originale peut √™tre en jpg, et l'image r√©sultante peut √™tre en png); </li><li>  deuxi√®mement, le fait que la mise √† l'√©chelle de l'image ne soit pas n√©cessairement n√©cessaire.  Cela se produit dans une situation o√π le client commande uniquement la conversion de l'image d'un format √† un autre, mais avec la taille d'origine de l'image pr√©serv√©e. </li></ul><br>  Je dois dire qu'ici nous avons emprunt√© le chemin le plus simple, sans chercher √† optimiser quoi que ce soit.  Par exemple, on pourrait essayer de cr√©er deux caches: l'un stockerait les images au format d'origine, mais √† l'√©chelle √† la taille souhait√©e, et dans le second, les images √† l'√©chelle seraient converties au format cible. <br><br>  Pourquoi une telle double mise en cache serait-elle n√©cessaire?  Le fait est que lors de la transformation d'images, les deux op√©rations les plus co√ªteuses en temps sont le redimensionnement et la s√©rialisation de l'image au format cible.  Par cons√©quent, si nous recevions une demande de mise √† l'√©chelle de l'image example.jpg √† une taille de 1920 en largeur et de la transformer au format webp, nous pourrions stocker deux images dans notre m√©moire: example_1920px_width.jpg et example_1920px_width.webp.  Nous donnerions une image example_1920px_width.webp lorsque nous recevions une deuxi√®me demande.  Mais l'image example_1920px_width.jpg pourrait √™tre utilis√©e lors de la r√©ception de demandes de mise √† l'√©chelle d'exemple.jpg √† une taille de 1920 en largeur et de sa transformation au format heic.  Nous pourrions ignorer l'op√©ration de redimensionnement et faire uniquement la conversion de format (c'est-√†-dire que l'image finie example_1920px_width.jpg serait transcod√©e au format heic). <br><br>  Autre opportunit√© potentielle: lorsqu'une demande vient de transcoder une image dans un autre format sans redimensionnement, vous pouvez d√©terminer la taille r√©elle de l'image et utiliser cette taille √† l'int√©rieur de la cl√© composite.  Par exemple, laissez example.jpg avoir une taille de 3000x2000 pixels.  Si nous recevons ensuite une demande de mise √† l'√©chelle d'exemple.jpg √† 2000 px de hauteur, nous pouvons imm√©diatement d√©terminer que nous avons d√©j√† une image de cette taille. <br><br>  En th√©orie, toutes ces consid√©rations m√©ritent notre attention.  Mais d'un point de vue pratique, il n'est pas clair √† quel point la probabilit√© d'une telle √©volution des √©v√©nements est √©lev√©e.  C'est-√†-dire  √† quelle fr√©quence recevrons-nous une demande de mise √† l'√©chelle d'exemple.jpg en 1920px avec conversion en webp, puis une demande de mise √† l'√©chelle de la m√™me image, mais avec conversion en png?  Il est difficile de dire qu'il n'y a pas de statistiques r√©elles.  Par cons√©quent, nous avons d√©cid√© de ne pas compliquer nos vies dans notre projet de d√©monstration, mais de suivre d'abord le chemin le plus simple.  Dans l'espoir que si quelqu'un a besoin de sch√©mas de mise en cache plus avanc√©s, cela peut √™tre ajout√© plus tard, √† partir de sc√©narios r√©els et non fictifs pour l'utilisation de Shrimp. <br><br>  En cons√©quence, dans la version mise √† jour de Shrimp, nous avons l√©g√®rement d√©velopp√© la cl√©, en y ajoutant √©galement un param√®tre tel que le format cible: <br><br><pre> <code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resize_request_key_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> m_path; <span class="hljs-keyword"><span class="hljs-keyword">image_format_t</span></span> m_format; <span class="hljs-keyword"><span class="hljs-keyword">resize_params_t</span></span> m_params; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">resize_request_key_t</span></span>( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> path, <span class="hljs-keyword"><span class="hljs-keyword">image_format_t</span></span> format, <span class="hljs-keyword"><span class="hljs-keyword">resize_params_t</span></span> params ) : m_path{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(path) } , m_format{ format } , m_params{ params } {} [[nodiscard]] <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>&lt;(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">resize_request_key_t</span></span> &amp; o ) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">noexcept</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::tie( m_path, m_format, m_params ) &lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::tie( o.m_path, o.m_format, o.m_params ); } [[nodiscard]] <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> &amp; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">path</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">noexcept</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m_path; } [[nodiscard]] <span class="hljs-keyword"><span class="hljs-keyword">image_format_t</span></span> format() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">noexcept</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m_format; } [[nodiscard]] <span class="hljs-keyword"><span class="hljs-keyword">resize_params_t</span></span> params() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">noexcept</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m_params; } };</code> </pre> <br>  C'est-√†-dire  demande de redimensionnement example.jpg jusqu'√† 1920px avec conversion en png diff√®re du m√™me redimensionnement, mais avec conversion en webp ou heic. <br><br>  Mais l'objectif principal se cache <a href="">dans la nouvelle impl√©mentation de la classe resize_params_t</a> , qui d√©termine les nouvelles tailles de l'image mise √† l'√©chelle.  <a href="">Auparavant, cette classe prend en</a> charge trois options: seule la largeur est d√©finie, seule la hauteur est d√©finie ou le c√¥t√© long est d√©fini (la hauteur ou la largeur est d√©termin√©e par la taille actuelle de l'image).  En cons√©quence, la <a href="">m√©thode resize_params_t :: value () a</a> toujours renvoy√© une valeur r√©elle (quelle valeur a √©t√© d√©termin√©e par la <a href="">m√©thode resize_params_t :: mode ()</a> ). <br><br>  Mais dans le nouveau Shrimp, un autre mode a √©t√© ajout√© - keep_original, ce qui signifie que la mise √† l'√©chelle n'est pas effectu√©e et que l'image est rendue dans sa taille d'origine.  Pour prendre en charge ce mode, resize_params_t a d√ª apporter quelques modifications.  Tout d'abord, la <a href="">m√©thode resize_params_t :: make ()</a> d√©termine maintenant si le mode keep_original est utilis√© (on consid√®re que ce mode est utilis√© si aucun des param√®tres width, height et max dans la cha√Æne de requ√™te de la requ√™te entrante n'est sp√©cifi√©).  Cela nous a permis de ne pas r√©√©crire la fonction <a href="https://bitbucket.org/sobjectizerteam/shrimp-demo/src/4049abf4ca148fb0d291239b28135315d5f4053f/dev/shrimp/">handle_resize_op_request ()</a> , qui pousse la demande de mise √† l'√©chelle de l'image √† ex√©cuter. <br><br>  Deuxi√®mement, la <a href="">m√©thode resize_params_t :: value ()</a> peut d√©sormais √™tre appel√©e pas toujours, mais uniquement lorsque le mode de mise √† l'√©chelle diff√®re de keep_original. <br><br>  Mais le plus important est que <a href="">resize_params_t :: operator &lt;() a</a> continu√© de fonctionner comme pr√©vu. <br><br>  Gr√¢ce √† toutes ces modifications dans a_transform_manager, le cache d'image mis √† l'√©chelle et la file d'attente des demandes en attente sont rest√©s les m√™mes.  Mais maintenant, des informations sur diverses requ√™tes sont stock√©es dans ces structures de donn√©es.  Ainsi, la cl√© {"example.jpg", "jpg", keep_original} diff√©rera √† la fois de la cl√© {"example.jpg", "png", keep_original} et de la cl√© {"example.jpg", "jpg", width = 1920 px}. <br><br>  Il s'est av√©r√© qu'apr√®s avoir un peu g√¢ch√© la d√©finition de structures de donn√©es simples telles que resize_params_t et resize_params_key_t, nous avons √©vit√© de modifier des structures plus complexes telles que le cache des images r√©sultantes et la file d'attente des demandes en attente. <br><br><h2>  Prise en charge du format cible dans a_transformer </h2><br>  Eh bien, la derni√®re √©tape de la prise en charge du format cible consiste √† √©tendre la logique de l'agent a_transformer afin que l'image, √©ventuellement d√©j√† mise √† l'√©chelle, soit ensuite convertie au format cible. <br><br>  Cela s'est av√©r√© √™tre le plus facile √† faire, tout ce qui √©tait n√©cessaire √©tait d'√©tendre le code de la <a href="">m√©thode a_transform_t :: handle_resize_request ()</a> : <br><br><pre> <code class="hljs pgsql">[[nodiscard]] a_transform_manager_t::resize_result_t::result_t a_transformer_t::handle_resize_request( const <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>::resize_request_key_t &amp; key ) { try { m_logger-&gt;trace( "transformation started; request_key={}", key ); auto image = load_image( key.path() ); const auto resize_duration = measure_duration( [&amp;]{ //       //    keep_original. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>::resize_params_t::mode_t::keep_original != key.params().mode() ) { <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>::resize( key.params(), total_pixel_count, image ); } } ); m_logger-&gt;<span class="hljs-keyword"><span class="hljs-keyword">debug</span></span>( "resize finished; request_key={}, time={}ms", key, std::chrono::duration_cast&lt;std::chrono::milliseconds&gt;( resize_duration).count() ); image.magick( magick_from_image_format( key.format() ) ); datasizable_blob_shared_ptr_t blob; const auto serialize_duration = measure_duration( [&amp;] { blob = make_blob( image ); } ); m_logger-&gt;<span class="hljs-keyword"><span class="hljs-keyword">debug</span></span>( "serialization finished; request_key={}, time={}ms", key, std::chrono::duration_cast&lt;std::chrono::milliseconds&gt;( serialize_duration).count() ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a_transform_manager_t::successful_resize_t{ std::<span class="hljs-keyword"><span class="hljs-keyword">move</span></span>(blob), std::chrono::duration_cast&lt;std::chrono::microseconds&gt;( resize_duration), std::chrono::duration_cast&lt;std::chrono::microseconds&gt;( serialize_duration) }; } catch( const std::<span class="hljs-keyword"><span class="hljs-keyword">exception</span></span> &amp; x ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a_transform_manager_t::failed_resize_t{ x.what() }; } }</code> </pre> <br>  Par rapport <a href="">√† la version pr√©c√©dente,</a> il existe deux ajouts fondamentaux. <br><br>  Tout d'abord, appeler la m√©thode image.magick () vraiment magique apr√®s le redimensionnement.  Cette m√©thode indique √† ImageMagick le format d'image r√©sultant.  Dans le m√™me temps, la repr√©sentation de l'image dans la m√©moire ne change pas - ImageMagick continue de la stocker √† sa guise.  Mais alors la valeur d√©finie par la m√©thode magick () sera prise en compte lors de l'appel suivant √† Image :: write (). <br><br>  Deuxi√®mement, la version mise √† jour enregistre le temps n√©cessaire pour s√©rialiser l'image au format sp√©cifi√©.  La nouvelle version de Shrimp fixe d√©sormais s√©par√©ment le temps consacr√© √† la mise √† l'√©chelle et le temps consacr√© √† la conversion au format cible. <br><br>  Le reste de l'agent a_transformer_t n'a subi aucune modification. <br><br><h1>  Parall√©lisation d'ImageMagick </h1><br>  Par d√©faut, ImageMagic est construit avec le support OpenMP.  C'est-√†-dire  il est possible de parall√©liser les op√©rations sur les images qu'ImageMagick effectue.  Vous pouvez contr√¥ler le nombre de workflows qu'ImageMagick utilise dans ce cas √† l'aide de la variable d'environnement MAGICK_THREAD_LIMIT. <br><br>  Par exemple, sur ma machine de test avec la valeur MAGICK_THREAD_LIMIT = 1 (c'est-√†-dire sans r√©elle parall√©lisation), j'obtiens les r√©sultats suivants: <br><br><pre> <code class="hljs powershell">curl <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/DSC08084.jpg?op=resize&amp;max=2400"</span></span> <span class="hljs-literal"><span class="hljs-literal">-v</span></span> &gt; /dev/null &gt; GET /DSC08084.jpg?op=resize&amp;max=<span class="hljs-number"><span class="hljs-number">2400</span></span> HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> &gt; Host: localhost:<span class="hljs-number"><span class="hljs-number">8080</span></span> &gt; User<span class="hljs-literal"><span class="hljs-literal">-Agent</span></span>: curl/<span class="hljs-number"><span class="hljs-number">7.47</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> &gt; Accept: */* &gt; &lt; HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> OK &lt; Connection: keep<span class="hljs-literal"><span class="hljs-literal">-alive</span></span> &lt; Content<span class="hljs-literal"><span class="hljs-literal">-Length</span></span>: <span class="hljs-number"><span class="hljs-number">2043917</span></span> &lt; Server: Shrimp draft server &lt; Date: Wed, <span class="hljs-number"><span class="hljs-number">15</span></span> Aug <span class="hljs-number"><span class="hljs-number">2018</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">51</span></span>:<span class="hljs-number"><span class="hljs-number">24</span></span> GMT &lt; Last<span class="hljs-literal"><span class="hljs-literal">-Modified</span></span>: Wed, <span class="hljs-number"><span class="hljs-number">15</span></span> Aug <span class="hljs-number"><span class="hljs-number">2018</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">51</span></span>:<span class="hljs-number"><span class="hljs-number">24</span></span> GMT &lt; Access<span class="hljs-literal"><span class="hljs-literal">-Control</span></span><span class="hljs-literal"><span class="hljs-literal">-Allow</span></span><span class="hljs-literal"><span class="hljs-literal">-Origin</span></span>: * &lt; Access<span class="hljs-literal"><span class="hljs-literal">-Control</span></span><span class="hljs-literal"><span class="hljs-literal">-Expose</span></span><span class="hljs-literal"><span class="hljs-literal">-Headers</span></span>: Shrimp<span class="hljs-literal"><span class="hljs-literal">-Processing</span></span><span class="hljs-literal"><span class="hljs-literal">-Time</span></span>, Shrimp<span class="hljs-literal"><span class="hljs-literal">-Resize</span></span><span class="hljs-literal"><span class="hljs-literal">-Time</span></span>, Shrimp<span class="hljs-literal"><span class="hljs-literal">-Encoding</span></span><span class="hljs-literal"><span class="hljs-literal">-Time</span></span>, Shrimp<span class="hljs-literal"><span class="hljs-literal">-Image</span></span><span class="hljs-literal"><span class="hljs-literal">-Src</span></span> &lt; Content<span class="hljs-literal"><span class="hljs-literal">-Type</span></span>: image/jpeg &lt; Shrimp<span class="hljs-literal"><span class="hljs-literal">-Image</span></span><span class="hljs-literal"><span class="hljs-literal">-Src</span></span>: transform &lt; Shrimp<span class="hljs-literal"><span class="hljs-literal">-Processing</span></span><span class="hljs-literal"><span class="hljs-literal">-Time</span></span>: <span class="hljs-number"><span class="hljs-number">1323</span></span> &lt; Shrimp<span class="hljs-literal"><span class="hljs-literal">-Resize</span></span><span class="hljs-literal"><span class="hljs-literal">-Time</span></span>: <span class="hljs-number"><span class="hljs-number">1086.72</span></span> &lt; Shrimp<span class="hljs-literal"><span class="hljs-literal">-Encoding</span></span><span class="hljs-literal"><span class="hljs-literal">-Time</span></span>: <span class="hljs-number"><span class="hljs-number">236.276</span></span></code> </pre><br>  Le temps consacr√© au redimensionnement est indiqu√© dans l'en-t√™te Shrimp-Resize-Time.  Dans ce cas, elle est de 1086,72 ms. <br><br>  Mais si vous d√©finissez MAGICK_THREAD_LIMIT = 3 sur la m√™me machine et ex√©cutez Shrimp, alors nous obtenons des valeurs diff√©rentes: <br><br><pre> <code class="hljs powershell">curl <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/DSC08084.jpg?op=resize&amp;max=2400"</span></span> <span class="hljs-literal"><span class="hljs-literal">-v</span></span> &gt; /dev/null &gt; GET /DSC08084.jpg?op=resize&amp;max=<span class="hljs-number"><span class="hljs-number">2400</span></span> HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> &gt; Host: localhost:<span class="hljs-number"><span class="hljs-number">8080</span></span> &gt; User<span class="hljs-literal"><span class="hljs-literal">-Agent</span></span>: curl/<span class="hljs-number"><span class="hljs-number">7.47</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> &gt; Accept: */* &gt; &lt; HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> OK &lt; Connection: keep<span class="hljs-literal"><span class="hljs-literal">-alive</span></span> &lt; Content<span class="hljs-literal"><span class="hljs-literal">-Length</span></span>: <span class="hljs-number"><span class="hljs-number">2043917</span></span> &lt; Server: Shrimp draft server &lt; Date: Wed, <span class="hljs-number"><span class="hljs-number">15</span></span> Aug <span class="hljs-number"><span class="hljs-number">2018</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span>:<span class="hljs-number"><span class="hljs-number">49</span></span> GMT &lt; Last<span class="hljs-literal"><span class="hljs-literal">-Modified</span></span>: Wed, <span class="hljs-number"><span class="hljs-number">15</span></span> Aug <span class="hljs-number"><span class="hljs-number">2018</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span>:<span class="hljs-number"><span class="hljs-number">49</span></span> GMT &lt; Access<span class="hljs-literal"><span class="hljs-literal">-Control</span></span><span class="hljs-literal"><span class="hljs-literal">-Allow</span></span><span class="hljs-literal"><span class="hljs-literal">-Origin</span></span>: * &lt; Access<span class="hljs-literal"><span class="hljs-literal">-Control</span></span><span class="hljs-literal"><span class="hljs-literal">-Expose</span></span><span class="hljs-literal"><span class="hljs-literal">-Headers</span></span>: Shrimp<span class="hljs-literal"><span class="hljs-literal">-Processing</span></span><span class="hljs-literal"><span class="hljs-literal">-Time</span></span>, Shrimp<span class="hljs-literal"><span class="hljs-literal">-Resize</span></span><span class="hljs-literal"><span class="hljs-literal">-Time</span></span>, Shrimp<span class="hljs-literal"><span class="hljs-literal">-Encoding</span></span><span class="hljs-literal"><span class="hljs-literal">-Time</span></span>, Shrimp<span class="hljs-literal"><span class="hljs-literal">-Image</span></span><span class="hljs-literal"><span class="hljs-literal">-Src</span></span> &lt; Content<span class="hljs-literal"><span class="hljs-literal">-Type</span></span>: image/jpeg &lt; Shrimp<span class="hljs-literal"><span class="hljs-literal">-Image</span></span><span class="hljs-literal"><span class="hljs-literal">-Src</span></span>: transform &lt; Shrimp<span class="hljs-literal"><span class="hljs-literal">-Processing</span></span><span class="hljs-literal"><span class="hljs-literal">-Time</span></span>: <span class="hljs-number"><span class="hljs-number">779.901</span></span> &lt; Shrimp<span class="hljs-literal"><span class="hljs-literal">-Resize</span></span><span class="hljs-literal"><span class="hljs-literal">-Time</span></span>: <span class="hljs-number"><span class="hljs-number">558.246</span></span> &lt; Shrimp<span class="hljs-literal"><span class="hljs-literal">-Encoding</span></span><span class="hljs-literal"><span class="hljs-literal">-Time</span></span>: <span class="hljs-number"><span class="hljs-number">221.655</span></span></code> </pre> <br>  C'est-√†-dire  le temps de redimensionnement a √©t√© r√©duit √† 558,25 ms. <br><br>  Par cons√©quent, comme ImageMagick offre la possibilit√© de parall√©liser les calculs, vous pouvez utiliser cette opportunit√©.  Mais en m√™me temps, il est souhaitable de pouvoir contr√¥ler le nombre de threads de travail que Shrimp prend pour lui-m√™me.  Dans les versions pr√©c√©dentes de Shrimp, il n'√©tait pas possible d'influencer le nombre de flux de travail cr√©√©s par Shrimp.  Et dans la version mise √† jour de Shrimp, cela peut √™tre fait.  Ou via des variables d'environnement, par exemple: <br><br><pre> <code class="hljs tex">SHRIMP_IO_THREADS=1 <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>SHRIMP_WORKER_THREADS=3 <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>MAGICK_THREAD_LIMIT=4 <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>shrimp.app -p 8080 -i ...</code> </pre> <br>  Ou via des arguments de ligne de commande, par exemple: <br><br><pre> <code class="hljs powershell">MAGICK_THREAD_LIMIT=<span class="hljs-number"><span class="hljs-number">4</span></span> \ shrimp.app <span class="hljs-literal"><span class="hljs-literal">-p</span></span> <span class="hljs-number"><span class="hljs-number">8080</span></span> <span class="hljs-literal"><span class="hljs-literal">-i</span></span> ... -<span class="hljs-literal"><span class="hljs-literal">-io</span></span><span class="hljs-literal"><span class="hljs-literal">-threads</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> -<span class="hljs-literal"><span class="hljs-literal">-worker</span></span><span class="hljs-literal"><span class="hljs-literal">-threads</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span></code> </pre> <br>  Les valeurs sp√©cifi√©es via la ligne de commande ont une priorit√© plus √©lev√©e. <br><br>  Il convient de souligner que MAGICK_THREAD_LIMIT affecte uniquement les op√©rations qu'ImageMagick effectue lui-m√™me.  Par exemple, le redimensionnement est effectu√© par ImageMagick.  Mais la conversion d'un format √† un autre ImageMagick d√©l√®gue aux biblioth√®ques externes.  Et comment les op√©rations dans ces biblioth√®ques externes sont parall√©lis√©es est un probl√®me distinct que nous n'avons pas compris. <br><br><h1>  Conclusion </h1><br>  Peut-√™tre, dans cette version de Shrimp, nous avons amen√© notre projet de d√©monstration √† un √©tat acceptable.  Ceux qui veulent voir et exp√©rimenter peuvent trouver les textes sources de Shrimp sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">BitBucket</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GitHub</a> .  Vous pouvez √©galement y trouver le Dockerfile pour construire des crevettes pour vos exp√©riences. <br><br>  En g√©n√©ral, nous avons atteint nos objectifs que nous nous sommes fix√©s en d√©marrant ce projet de d√©monstration.  Un certain nombre d'id√©es sont apparues pour le d√©veloppement ult√©rieur de RESTinio et de SObjectizer, et certaines d'entre elles ont d√©j√† trouv√© leur mode de r√©alisation.  Par cons√©quent, si les crevettes se d√©velopperont ailleurs, cela d√©pend compl√®tement des questions et des souhaits.  S'il y en a, alors les crevettes peuvent se d√©velopper.  Sinon, Shrimp restera un projet de d√©monstration et un terrain d'entra√Ænement pour exp√©rimenter de nouvelles versions de RESTinio et SObjectizer. <br><br>  En conclusion, je voudrais remercier tout particuli√®rement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">aensidhe</a> pour leur aide et leurs conseils, sans lesquels nos danses au tambourin seraient bien plus longues et tristes. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr420353/">https://habr.com/ru/post/fr420353/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr420343/index.html">Lampes LED OK</a></li>
<li><a href="../fr420345/index.html">Pr√©sentation du centre de donn√©es IXcellerate (la plus grande salle des machines de la F√©d√©ration de Russie)</a></li>
<li><a href="../fr420347/index.html">Apprenez √† cr√©er vos propres commandes bash en moins de 4 minutes</a></li>
<li><a href="../fr420349/index.html">Liste de contr√¥le pour l'externalisation informatique: travailler sans risques</a></li>
<li><a href="../fr420351/index.html">Comment faire des recherches d'utilisateurs sur GitHub en utilisant Vue</a></li>
<li><a href="../fr420355/index.html">Montre intelligente Pebble: comment devenir une raret√© du jour au lendemain</a></li>
<li><a href="../fr420357/index.html">Vuex: structurer de grands projets et travailler avec des modules</a></li>
<li><a href="../fr420359/index.html">Var, let ou const? Probl√®mes de port√©e variable et ES6</a></li>
<li><a href="../fr420361/index.html">Bogue lors de l'ex√©cution de TextBox.GetLineText dans .NET WPF</a></li>
<li><a href="../fr420363/index.html">Webinaires HPE en ao√ªt-octobre: ‚Äã‚Äãnouveaux sujets (+ SHD, pratique de l'IA, stockage cl√© en main de p√©taoctets)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>