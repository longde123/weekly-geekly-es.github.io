<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî≠ üëßüèø üïõ Recr√©er un ancien jeu DOS en C ++ 17 üë®üèæ‚Äçüé§ ‚è∏Ô∏è üôáüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En 2016, j'ai commenc√© √† travailler sur un projet de loisir pour l'ing√©nierie inverse du jeu Duke Nukem II et recr√©er son moteur √† partir de z√©ro. Le ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Recr√©er un ancien jeu DOS en C ++ 17</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454570/">  En 2016, j'ai commenc√© √† travailler sur un projet de loisir pour l'ing√©nierie inverse du jeu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">Duke Nukem II</a> et recr√©er son moteur √† partir de z√©ro.  Le projet s'appelle Rigel Engine et est disponible en open source ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">sa page sur GitHub</a> ).  Aujourd'hui, plus de deux ans et demi plus tard, sur mon moteur, vous pouvez d√©j√† parcourir tout l'√©pisode de shareware du jeu original avec un gameplay presque identique √† l'original.  Voici une vid√©o avec le passage du premier niveau: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Z3gCS5LvC2s" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Que peut-il faire?  Rigel Engine fonctionne comme un remplacement complet du binaire DOS d'origine ( <code>NUKEM2.EXE</code> ).  Vous pouvez le copier dans le r√©pertoire du jeu et il consid√®re toutes les donn√©es qu'il contient, ou sp√©cifier le chemin d'acc√®s aux donn√©es du jeu comme argument de la ligne de commande.  Le moteur est construit et ex√©cut√© sous Windows, Mac OS X et Linux.  Il est bas√© sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">SDL</a> et OpenGL 3 / OpenGL ES 2 et est √©crit en C ++ 17. <br><br>  Il impl√©mente la logique de jeu de tous les ennemis et les m√©canismes de jeu de l'√©pisode Shareware, ainsi que la plupart du syst√®me de menus.  De plus, vous pouvez y importer des jeux enregistr√©s et un tableau des meilleurs scores du jeu d'origine. <br><a name="habracut"></a><br>  De plus, le moteur pr√©sente des avantages par rapport √† l'original: <br><br><ul><li>  Aucun √©mulateur ou ancien mat√©riel requis, aucun param√®tre requis </li><li>  Aucun √©cran de chargement - s√©lectionnez "nouveau jeu" dans le menu, appuyez sur Entr√©e et d√©marrez imm√©diatement le jeu </li><li>  Plusieurs effets sonores peuvent √™tre jou√©s en m√™me temps, ce qui √©tait impossible dans l'original </li><li>  Il n'y a aucune restriction sur le nombre d'effets simultan√©s de particules, d'explosions, etc. </li><li>  Enregistrer des fichiers et des listes de meilleurs scores pour chaque joueur </li><li>  Menus beaucoup plus r√©actifs </li></ul><br>  Jusqu'√† pr√©sent, je ne consid√®re pas que le moteur Rigel soit compl√®tement ¬´pr√™t √† l'emploi¬ª.  Mais c'est une grande √©tape de d√©veloppement et une bonne occasion d'√©crire √† nouveau sur le moteur (anciens articles publi√©s <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">ici</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">ici</a> ).  Commen√ßons par jeter un ≈ìil √† l'√©tat actuel du code et d√©couvrez comment j'y suis parvenu. <br><br><h2>  Combien de code contient le moteur? </h2><br>  Au moment de la r√©daction, RigelEngine se compose de 270 fichiers source contenant plus de 25 000 lignes de code (pas de commentaires / lignes vides).  Parmi ceux-ci, 10 fichiers et 2,5 mille lignes sont des tests unitaires.  Une ventilation d√©taill√©e des lignes vides et des commentaires est disponible <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">ici</a> . <br><br>  Que contient tout ce code?  Un peu d'infrastructure commune et de fonctions de support, telles que des choses de base comme le rendu, et un tas de petits morceaux de logique.  En plus de tout cela, les plus grandes pi√®ces sont: <br><br><ul><li>  analyseurs / t√©l√©chargeurs pour 14 formats de fichiers diff√©rents utilis√©s dans le jeu original - 2 mille lignes de code (LOC) </li><li>  logique de comportement / logique de jeu pour 24 ennemis / objets hostiles - 3.8k LOC </li><li>  logique de jeu pour 14 √©l√©ments interactifs et m√©caniques de jeu - LOC 2k </li><li>  logique de contr√¥le du joueur - 1.2k LOC </li><li>  154 entr√©es de configuration (la valeur de sant√© de chaque ennemi, le nombre de points re√ßus pour les objets collect√©s, etc.) - 1k LOC </li><li>  31 sp√©cifications pour les effets de destruction (effets d√©clench√©s par la destruction d'un ennemi ou d'un autre objet destructible) - 254 LOC </li><li>  code de commande de la cam√©ra - 159 LOC </li><li>  interpr√©teur de langage de description du menu du jeu / cin√©matique - 643 LOC </li><li>  Le HUD et autre code UI est 818 LOC </li><li>  5 √©crans / modes en dehors du menu, par exemple, l'animation initiale, l'√©cran bonus, etc.  - 789 LOC </li></ul><br>  Bien s√ªr, tout ce code devait √™tre √©crit, ce qui nous am√®ne √† la question suivante. <br><br><h2>  Combien de travail at-il fallu? </h2><br>  Bien que deux ans et demi se soient √©coul√©s depuis le d√©but du projet, je n'y ai pas travaill√© tout ce temps.  Pendant quelques mois, je n'ai pas du tout fait de projet, dans certains autres, je n'y ai pass√© que quelques heures.  Mais il y a eu des moments o√π j'ai travaill√© tr√®s activement sur le moteur Rigel.  En regardant le calendrier de validation sur Github, vous pouvez avoir une id√©e approximative de la r√©partition de mon travail au fil du temps: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c55/7f6/ee0/c557f6ee023574c46aea645b0001824d.png"></div><br>  Selon le calendrier, nous constatons que 1081 commits ont √©t√© effectu√©s dans la branche principale.  Cependant, avant m√™me de cr√©er le d√©p√¥t, je travaillais sur un dossier ferm√©, dans lequel il y avait 247 commits suppl√©mentaires, ce qui nous donne au total 1328 commits.  De plus, il y avait plusieurs branches de prototype que j'ai utilis√©es pour la recherche et l'exp√©rimentation, mais jamais combin√©es avec la principale;  en outre, avant de fusionner, j'ai parfois compress√© de grandes histoires de commit en plus courtes. <br><br>  Je dois √©galement dire que l'√©criture de code n'√©tait pas la seule partie du projet - l'ing√©nierie inverse √©tait une autre partie importante.  J'ai pass√© pas mal d'heures √† √©tudier le code d√©sassembl√© du fichier ex√©cutable d'origine dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">Ida Pro</a> (dans la version gratuite), √† ‚Äã‚Äãprendre des notes, √† √©crire du pseudocode et √† planifier la mise en ≈ìuvre des √©l√©ments de ma version.  De plus, j'ai test√© activement le jeu original, en le lan√ßant dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">DOSBox</a> et sur l'√©quipement d'origine (diff√©rentes machines 386 et 486 achet√©es sur eBay).  J'ai collect√© des niveaux de test pour l'observation s√©par√©e d'ennemis sp√©cifiques et l'√©tude des m√©canismes de jeu, enregistr√© des clips vid√©o √† l'aide de DOSBox et parcouru les images image par image pour confirmer mes conclusions lors de l'√©tude du code assembleur.  Une fois l'ennemi ou la m√©canique du jeu r√©alis√©s, j'enregistrais g√©n√©ralement un clip vid√©o de ma version et le comparais image par image avec l'original pour confirmer l'exactitude de mon impl√©mentation. <br><br>  Voici quelques photos de mes notes: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/884/da3/b64/884da3b64a95ce531a3d5dbb456265bc.jpg"></div><br>  <i>Reverse engineering du code de contr√¥le de la cam√©ra.</i>  <i>Un grand rectangle indique l'√©cran.</i>  <i>Les lignes en pointill√©s indiquent les zones qu'un joueur peut d√©placer sans d√©placer la cam√©ra.</i>  <i>Si vous √™tes int√©ress√©, le code de contr√¥le de la cam√©ra lui-m√™me peut √™tre trouv√© <a href="" rel="noopener">ici</a> .</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ec4/2d3/5c6/ec42d35c6ee85e375b8ed6d94d37e24d.jpg"></div><br>  <i>Remarques g√©n√©rales pour vous aider √† comprendre le code assembleur.</i>  <i>√Ä gauche se trouve la proc√©dure de mise √† jour du jeu original √† un niveau √©lev√©.</i>  <i>√Ä droite se trouvent des notes sur les champs de bits indiquant l'√©tat de certains objets de jeu.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/839/677/f8f/839677f8f3f9854d8e8ce6d349da396c.jpg"></div><br>  <i>Transcription du code assembleur en pseudocode.</i>  <i>Habituellement, je le fais assez m√©caniquement, transcris sans penser √† ce que fait le code, puis utilise la version en pseudo-code pour comprendre la logique sous-jacente.</i>  <i>Et sur la base de cela, j'ai d√©j√† trouv√© ma mise en ≈ìuvre.</i>  <i>Voir le code fini <a href="" rel="noopener">ici</a> .</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8da/fd3/848/8dafd384867291ec44dc8bb9d9ff15b2.jpg"></div><br>  <i>Pseudo-code d'une version nettoy√©e de la logique ennemie.</i>  <i>Les en-t√™tes indiquent l'√©tat de la machine d'√©tat, le code ci-dessous explique ce qui doit se passer dans les √©tats respectifs.</i>  <i>Il a √©t√© cr√©√© sur la base d'un pseudocode brut obtenu par transcription de code assembleur.</i>  <i>Le code pr√™t peut √™tre trouv√© <a href="" rel="noopener">ici</a> .</i> <br><br>  En fin de compte, le travail sur le projet s'est av√©r√© tr√®s excitant, et j'en ai beaucoup appris: sur l'ing√©nierie inverse, l'assembleur x86 16 bits, la programmation VGA de bas niveau, les restrictions s√©v√®res auxquelles les d√©veloppeurs de jeux PC ont d√ª faire face au d√©but des ann√©es 90;  en outre, j'ai fait de nombreuses d√©couvertes sur les fonctionnalit√©s internes du jeu original et sur la fa√ßon dont certaines d'entre elles ont √©t√© mises en ≈ìuvre de mani√®re √©trange et bizarre - ce sujet en soi m√©rite une s√©rie de publications distinctes. <br><br><h2>  Et ensuite </h2><br>  En plus d'ajouter les derni√®res fonctions restantes et de finaliser le support de la version enregistr√©e, j'ai plusieurs id√©es pour am√©liorer et √©tendre les capacit√©s du moteur Rigel, sans parler du nettoyage et de la refactorisation du code - comme d'habitude, la meilleure fa√ßon de cr√©er une architecture logicielle n'appara√Æt qu'apr√®s la cr√©ation de ce logiciel. <br><br>  En ce qui concerne les am√©liorations futures, voici quelques points que j'ai pens√© √† mettre en ≈ìuvre: <br><br><ul><li>  Mouvement fluide avec interpolation.  Le jeu met √† jour sa logique environ 15 fois par seconde, et dans le jeu original, c'est aussi la fr√©quence d'images pour le rendu.  D'un autre c√¥t√©, le moteur Rigel peut facilement fonctionner avec une fr√©quence de 60 FPS et plus.  Pour le moment, ces cadres suppl√©mentaires ne donnent aucun avantage, mais je pense qu'ils peuvent √™tre utilis√©s pour des cadres interm√©diaires afin de r√©aliser un d√©filement et un mouvement des objets plus fluides.  La logique du jeu fonctionnera toujours √† la m√™me vitesse, mais les objets se d√©placeront en douceur et ne ¬´sauteront¬ª pas avec un incr√©ment de 8 pixels, comme ils le font actuellement.  Plus t√¥t, j'ai cr√©√© un prototype d'un tel syst√®me, et il a fi√®re allure, bien qu'il doive √™tre am√©lior√©. </li><li>  Prise en charge de la manette de jeu.  Dans le jeu d'origine, les joysticks sont pris en charge et DosBox peut les √©muler sur des manettes modernes, mais leur configuration peut √™tre difficile - la pr√©paration de la configuration et l'√©talonnage dans le jeu sont n√©cessaires.  Sans oublier que tous les boutons du contr√¥leur ne sont pas pris en charge, mais pour utiliser le menu, vous devez toujours prendre un clavier.  Par cons√©quent, je crois que le support du contr√¥leur natif am√©liorera consid√©rablement le gameplay. </li><li>  Am√©lioration du son.  Actuellement, tous les effets sonores ont le m√™me volume.  Les objets produisant du son, par exemple, les champs de force, deviennent nettement audibles lorsqu'ils touchent l'√©cran et se d√©tachent tout aussi fortement.  J'√©tais curieux de savoir comment ils sonneraient si le volume des effets dans la distance diminuait.  Par exemple, nous pouvions √† peine entendre le champ de force lorsqu'il n'√©tait pas encore sur l'√©cran, et √† l'approche, il devenait plus fort. </li><li>  Cam√©ra √† distance / voir la plupart du niveau.  Le jeu n'a pas √©t√© con√ßu pour cela, donc cette possibilit√© peut endommager le gameplay - le joueur commencera √† voir des ennemis qui ne sont pas actifs en dehors de l'√©cran, etc.  Mais je me demande encore √† quoi il ressemblera et jouera.  Au final, les joueurs se sont tr√®s souvent plaints de ce jeu pour leur incapacit√© √† voir une partie suffisante du niveau.  Il serait int√©ressant d'ajouter l'option d'√©teindre le HUD ou de le remplacer par un plus minimal en utilisant la transparence. </li><li>  Augmentez la r√©solution graphique.  Cette fonctionnalit√© se trouve souvent dans de nombreux ports / recr√©ation de jeux, et ce serait formidable de l'ajouter ici.  Le moteur vous permet d√©j√† de remplacer les graphiques de sprites par vos propres images, mais jusqu'√† pr√©sent, ils ne peuvent pas avoir une r√©solution plus √©lev√©e, car tout est rendu dans un petit tampon avec une augmentation d'√©chelle ult√©rieure.  Tout d'abord, vous devez remplacer cette approche afin que la mise √† l'√©chelle puisse √™tre effectu√©e pour des objets individuels. </li></ul><br>  Je n'ai pas de feuille de route pour l'avenir, je peux donc mettre en ≈ìuvre ces points dans n'importe quel ordre.  Mais avant tout cela, la prochaine √©tape sera l'int√©gration de Dear ImGui pour assembler davantage le menu d'options, qui n'est pas encore dans le jeu;  en outre, il activera ou d√©sactivera les am√©liorations ci-dessus.  En fin de compte, je dirai que je serai reconnaissant pour toute <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">aide dans le travail sur GitHub</a> ! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr454570/">https://habr.com/ru/post/fr454570/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr454552/index.html">Docker-compose Comment attendre que le conteneur soit pr√™t</a></li>
<li><a href="../fr454556/index.html">Nouvelles du monde d'OpenStreetMap n ¬∞ 462 (05.21.2019-27.05.2019)</a></li>
<li><a href="../fr454558/index.html">PHP Digest n ¬∞ 157 (20 mai - 3 juin 2019)</a></li>
<li><a href="../fr454562/index.html">Pourquoi le concept de bytecode n'est pas aussi pertinent qu'auparavant</a></li>
<li><a href="../fr454568/index.html">Mozilla a qualifi√© la ¬´mauvaise¬ª distribution de packages Web sign√©e num√©riquement par Google</a></li>
<li><a href="../fr454574/index.html">Apprentissage automatique en microfinance: construire un mod√®le de notation pour les clients avec un historique de cr√©dit vide</a></li>
<li><a href="../fr454576/index.html">Les auteurs de GandCrab cessent de travailler: ils pr√©tendent en avoir assez vol√©</a></li>
<li><a href="../fr454578/index.html">Comment connecter la galerie PhotoSwipe dans la vue Web Android</a></li>
<li><a href="../fr454582/index.html">La longueur du tableau doit-elle √™tre stock√©e dans une variable locale en C #?</a></li>
<li><a href="../fr454584/index.html">√âcole de d√©veloppement d'interface: analyse des t√¢ches pour Minsk et un nouvel ensemble √† Moscou</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>