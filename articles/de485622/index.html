<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äçüè´ üß¢ ‚è∫Ô∏è PostgreSQL-Sicherungswerkzeuge. Andrey Salnikov (Datenreiher) üëßüèº üë©üèæ‚Äçü§ù‚Äçüë®üèª ‚òÇÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ich schlage vor, dass Sie die Entschl√ºsselung des Berichts von Andrey Salnikov aus Data Egret "PostgreSQL Backup Creation Tools" lesen . Am Ende eine ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PostgreSQL-Sicherungswerkzeuge. Andrey Salnikov (Datenreiher)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485622/"><p>  <strong>Ich schlage vor, dass Sie die Entschl√ºsselung des Berichts von Andrey Salnikov aus Data Egret "PostgreSQL Backup Creation Tools" lesen</strong> <strong>.</strong>  <strong>Am Ende eine aktualisierte √úbersichtstabelle der Tools</strong> </p><br><p>  In diesem Vortrag geht es um die verf√ºgbaren PostgreSQL-Sicherungstools.  Logische Sicherungen, bin√§re Sicherungen, integrierte Sicherungstools und Tools von Drittanbietern.  Werden inkrementelle Sicherungen ben√∂tigt, wenn sie wirklich helfen k√∂nnen?  Mal sehen, wann und welches Tool besser geeignet ist.  Wie kann der Sicherungsvorgang am besten automatisiert und die Integrit√§t einer Sicherung √ºberpr√ºft werden?  Sehen Sie sich Tools wie <a href="https://www.postgresql.org/docs/10/app-pgdump.html" rel="nofollow">pg_dump</a> , <a href="https://www.postgresql.org/docs/10/app-pgbasebackup.html" rel="nofollow">pg_basebackup</a> , <a href="https://www.2ndquadrant.com/en/resources/barman/" rel="nofollow">Barmann</a> , <a href="https://www.postgresql.org/docs/10/app-pgbasebackup.html" rel="nofollow">Wal</a> <a href="https://github.com/wal-e/wal-e" rel="nofollow">-e</a> , <a href="https://pgbackrest.org/" rel="nofollow">Wal</a> <a href="https://github.com/wal-g/wal-g" rel="nofollow">-g</a> , <a href="https://pgbackrest.org/" rel="nofollow">pgbackrest</a> , <a href="https://www.enterprisedb.com/enterprise-postgres/edb-postgres-backup-and-recovery-tool" rel="nofollow">BART</a> und <a href="https://postgrespro.ru/products/extensions/pg_probackup" rel="nofollow">pg_probackup genauer an</a> . </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Us6cHVNA4vk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><a name="habracut"></a><br><p>  Mein Name ist Andrey Salnikov, ich bin ein Mitarbeiter von Data Egret und dieser Bericht widmet sich den Tools zum Erstellen von Backups in PostgreSQL. </p><br><p><img src="https://habrastorage.org/webt/qr/pa/mu/qrpamu1psbed1aonvt1shrrpedk.png"></p><br><p>  Zuerst dar√ºber, wer wir sind, meine Firma.  Unsere Hauptt√§tigkeit: Wir arbeiten als Remote-Administratoren und haben eine relativ gro√üe Anzahl von Kunden.  Es gibt riesige Basen, es gibt eine Menge kleiner Basen, es gibt alle Arten von Mischungen, wenn eine gro√üe Basis oder eine Menge kleiner ist.  Wir bieten auch Beratungs- und Pr√ºfungsdienstleistungen an - dies ist der Fall, wenn die Mitarbeiter keine st√§ndige Unterst√ºtzung ben√∂tigen, aber eine Art von Fachwissen erforderlich ist. <br>  Da es sich bei PostgreSQL um ein Open-Source-Produkt handelt, werden wir nat√ºrlich an allen Arten von Konferenzen teilnehmen, um unsere Erfahrungen auszutauschen und PostgreSQL dabei zu unterst√ºtzen, sein Bestes zu geben.  Weil die PostgreSQL-Datenbank wirklich gut ist.  Und es stellt sich heraus, dass wir ziemlich viele Lastprofile gesehen haben: DWH-Lasten und WEB-Lasten und Lastmischungen.  Und die Basen fielen auf unterschiedliche Weise.  Viel Erfahrung. </p><br><p><img src="https://habrastorage.org/webt/a0/vc/b_/a0vcb_l47qx4vvzh1hxnjcqesz4.png"></p><br><p>  Dies ist der interessanteste Teil des Berichts.  Warum werden Backups ben√∂tigt?  Tats√§chlich werden sie ben√∂tigt, damit wir uns friedlich ausruhen k√∂nnen, damit wir friedlich schlafen k√∂nnen, damit wir ruhig bei Konzerten abh√§ngen k√∂nnen.  Dies ist nun das Hauptziel aus der Sicht der Basis, warum Backups ben√∂tigt werden.  Damit in unserem Leben alles ruhig ist.  Denn wenn es √ºberpr√ºfte Backups gibt, k√∂nnen wir all dies tun.  Aber was mit der Basis passiert, ist die zehnte Sache. </p><br><p><img src="https://habrastorage.org/webt/dj/_9/aj/dj_9ajbympb3eslx0bl1phlp6te.png"></p><br><p>  Welche Tools stehen zur Erstellung von Backups in der PostgreSQL-Welt zur Verf√ºgung?  Dies ist das integrierte Wiederherstellungstool pg_dump, pg_dumpall oder pg_restore.  Dies ist das einzige Tool, mit dem Sie logische Sicherungen durchf√ºhren k√∂nnen.  Das hei√üt, Sie k√∂nnen pg_dump sowohl in SQL als auch in einem kleinen Bin√§rformat ausf√ºhren, um Daten zu sichern.  Und es ist mit PostgreSQL sofort einsatzbereit. <br>  Das n√§chste Tool (pg_basebackup) zum Erstellen von Sicherungen, das ebenfalls sofort einsatzbereit ist und mit diesem Tool beginnt, und au√üerdem alle Tools zum Erstellen von Sicherungen f√ºr bin√§re Datenbanken.  Pg_basebackup ist auch ein sofort einsatzbereites Tool, mit dem wir PostgreSQL-Replikate hochladen und eine Bin√§rkopie der Datenbank erstellen, eine persistente Datenbank erstellen und PostgreSQL so konfigurieren k√∂nnen, dass es rechtzeitig archiviert wird auf eine Art Festplatte.  Dies sind die grundlegenden Werkzeuge.  Sie sind gut, sie tun es, sie f√ºhren ihre Funktionalit√§t mit 5 aus, aber sie sind unpraktisch in Bezug auf Management und eine Art Masse.  Wenn Sie √ºber 20 Datenbanken verf√ºgen, m√ºssen Sie diese Skripterstellung selbst durchf√ºhren. <br>  Die n√§chsten beiden Tools sind spezifische reine Cloud-Tools - wal-e und wal-g.  Die gleichen Leute entwickeln sie, aber die Entwicklung von Wal-E war vorbei und sie wechselten zu Wal-G.  Diese Tools sind haupts√§chlich f√ºr AWS und f√ºr die Speicherung in S3 vorgesehen.  Wal-e ist weiterhin in der Lage, mit Google Cloud, Azure und dem Festplattensystem zu arbeiten. Sie k√∂nnen lediglich eine Art Remote-Laufwerk angeben.  Wal-g funktioniert nur mit AWS, nur mit S3.  Na ja, oder eine andere √§hnliche Schnittstelle mit S3.  Wir benutzen sie, gute Dinge.  Ich werde jedes Werkzeug im Detail weiter zerlegen. </p><br><p><img src="https://habrastorage.org/webt/h_/cs/my/h_csmywtln65xfdmoryutenb6-g.png"></p><br><p>  Und im n√§chsten Paket von Tools sind dies Tools, die auf pg_basebackup basieren oder es direkt verwenden oder seine Funktionalit√§t irgendwie implementieren.  Sie werden alle von Entwicklern geschrieben, die sich f√ºr das Haupt-PostgreSQL engagieren und √ºber einen eigenen Fork-Werbespot verf√ºgen, der in ihrem Einflussbereich Werbung macht. <br>  Das beliebteste Barman-Tool, das wir im ganzen Land ziemlich h√§ufig verwenden.  Dies ist im Wesentlichen ein Python-Wrapper um pg_basebackup.  Es kann auch mit ssh-Protokollen arbeiten.  Ein sehr interessantes und vielversprechendes Werkzeug f√ºr R√ºckenlehnen.  PostgreSQL ist an der Entwicklung beteiligt und engagiert sich aktiv daf√ºr.  Es wurde urspr√ºnglich in Python geschrieben.  Jetzt die Version, die verwendet wird - es ist in C geschrieben, um zu beschleunigen und die M√∂glichkeit des parallelen Entfernens von Backups. <br>  Pg_probackup ist ein Hilfsprogramm unserer russischen Kollegen bei PostgreSQL Professional, mit dem Sie inkrementelle Sicherungen durchf√ºhren k√∂nnen, die relativ klein sind. <br>  Das neueste Dienstprogramm ist das Sicherungs- und Wiederherstellungstool (BART) von EnterpriseDB.  Sie ist bei uns nicht sehr beliebt.  Es ist haupts√§chlich f√ºr CentOS und Red Hat.  F√ºr Ubuntu f√§llt es ihr meiner Meinung nach schwer.  Und aufgrund der geringen Popularit√§t von BART bei uns ist es (BART) fast nirgendwo in den Installationen zu finden. </p><br><p><img src="https://habrastorage.org/webt/ow/si/t8/owsit8h0n3welzlugm95_glqdds.png"></p><br><p>  Ich w√ºrde versuchen, diese Tools in einige wichtige Dinge zu zerlegen. </p><br><ul><li><p>  Zun√§chst ist es uns wichtig, wie wir es speichern, auf welchen Laufwerken und auf welchen Diensten.  Und es gibt eine Liste von Merkmalen, die wir durchgehen werden. </p><br></li><li><p>  Die folgende Datentrennung, hier ich unterteile, dass, wenn das Backup entfernt oder das Backup wiederhergestellt wird, wir einen Teil des gesamten Datenbankservers (Servers) ausschneiden und damit als integrale, integrale Datenbank arbeiten k√∂nnen. </p><br></li><li><p>  Inwieweit werden verschiedene Versionen der Datenbank unterst√ºtzt? </p><br></li><li><p>  Welche Betriebsarten haben sie in Bezug auf Parallelit√§t, in Bezug auf irgendeine Art von Automatisierung und dergleichen. </p><br></li><li><p>  Und Servicefreundlichkeit ist, wie sehr wir sie in einen separaten Service aufteilen k√∂nnen, der selbst Datenbanken durchl√§uft und Backups nach einem bestimmten Zeitplan entfernt. </p><br></li><li><p>  Validierung - Ich wollte, dass das Backup √ºberpr√ºft wird, um sicherzustellen, dass es wiederhergestellt werden kann und wir eine normale, ununterbrochene Basis haben. </p><br><p>  Und jetzt gehen wir diese sechs gro√üen Punkte genauer durch.  Und ich werde dort markieren, welches Instrument uns geben wird. </p><br></li></ul><br><p><img src="https://habrastorage.org/webt/s5/v0/h0/s5v0h0p62rsqz1r86v2upwibj5c.png"></p><br><p>  Durch die Speicherung k√∂nnen sie alles im Dateisystem speichern, das hei√üt, wir k√∂nnen unsere Festplatte erneut in das Betriebssystem einbinden und dort Backups kopieren.  Mit allen Tools k√∂nnen Sie dies tun.  Ein bereitgestelltes Netzwerklaufwerk ist im Grunde dasselbe, da es in unserem lokalen Dateisystem abgerufen wird. <br>  In AWS (S3) k√∂nnen drei Tools f√ºr uns arbeiten - wal-g, wal-e, pgbackrest.  Denn unter solchen Dienstprogrammen: Barmann usw. ist es das einzige, das mit AWS (S3) arbeiten kann. <br>  Mit Azure kann nur wal-e.  Google Cloud ist nur Wal-E. </p><br><p><img src="https://habrastorage.org/webt/gw/sc/qd/gwscqdmvmqlbe1r1e545ipkemzs.png"></p><br><ul><li>  Eine logische Kopie der Daten wird uns nur von pg_dump, pg_dumpall zur Verf√ºgung gestellt.  Der Unterschied besteht darin, dass pg_dumpall die gesamte Datenbankinstanz (Server) verarbeitet. In pg_dump k√∂nnen Sie eine bestimmte Datenbank f√ºr die Instanz angeben und damit arbeiten. </li><li>  Der Rest sind Bin√§rkopien. </li><li>  Ein wichtiger Faktor beim Speichern ist, dass, wenn wir in irgendeiner Weise durch Festplattenressourcen begrenzt sind, h√§ufig Situationen auftreten, in denen wir die Datenbank in verschiedene Tabellenbereiche aufteilen.  Dies gilt auch f√ºr Eisenserver, da Sie nicht unter RAID leiden m√∂chten.  Dies gilt f√ºr Clouds, da es eine bestimmte Einschr√§nkung gibt, insbesondere wenn Sie ein Auto mit NVME-Datentr√§gern nehmen und wie viele verbunden sind, so viele sind verbunden.  AWS-Instanzen werden erweitert, jedoch mit EBS-Laufwerken.  Und beim Wiederherstellen von Daten ist es f√ºr uns wichtig, dass wir diese Tabellenbereiche neu verteilen, sie entlang neuer Pfade und neuen Datentr√§gern zuweisen k√∂nnen.  Und jetzt ist dieses gute Objekt bei wal-e pr√§sent.  In wal-g wissen sie immer noch nicht, wie sie damit arbeiten sollen.  Pg_probackup kann damit arbeiten.  Barmann, Basebackup, R√ºckenlehne.  Diese Sache ist sehr oft wichtig, besonders wenn Sie eine 8-10 TB Datenbank haben.  Bei unseren Produktionskunden sind fast alle dieser Datenbanken in Tabellenbereichen zusammengefasst. </li></ul><br><p><img src="https://habrastorage.org/webt/qd/-v/sk/qd-vskcocq-r2tv0duopeyxtvke.png"></p><br><p>  Nun √ºber welche Gr√∂√üe k√∂nnen wir Backup haben.  Dies alles wird im Zusammenhang mit bin√§ren Sicherungen gehen.  Es ist klar, dass bin√§re Backups bedeuten, wie viel die Datenbank mit uns wiegt, so viel, dass wir kopiert haben.  Wiegt 8 TB, wir haben 8 TB kopiert.  1 MB wiegt 1 MB, kopiert.  Wie kann Platz gespart werden, wenn wir eine lange Sicherungskette ben√∂tigen?  Zu diesem Zweck wurden einige Tools entwickelt.  Das hei√üt, die Datenbank speichert Daten in ihren Dateien.  Wenn wir eine lange Archivdatenbank haben, √§ndern wir dort normalerweise einen kleinen Prozentsatz dieser Dateien.  Und daf√ºr haben sie sich ein differenzielles Backup ausgedacht. </p><br><p>  Differential Backup Was ist das?  Wir pr√ºfen, welche Dateien ge√§ndert wurden und kopieren sie nur in den Speicher, in dem die Sicherung gespeichert werden soll.  Und wir werden alle anderen Dateien mit einem Hardlink zu dieser Datenbank verkn√ºpfen.  Es stellt sich heraus, dass wir dadurch Platz sparen.  Gleichzeitig k√∂nnen alte Datenbanksicherungen sicher gel√∂scht werden, ohne dass neuere durcheinander gebracht werden. </p><br><p>  Diese Sache ist gut, aber wir haben beschlossen, fortzufahren und ein inkrementelles Backup zu erstellen.  Es gibt zwei Arten von inkrementellen Sicherungen. </p><br><p>  Der erste ist auf Dateiebene.  Sie unterscheidet sich von der differenziellen Sicherung nur dadurch, dass sich die differenzielle Sicherung auf eine vollst√§ndige Sicherung Ihrer Datenbank konzentriert und im Verh√§ltnis zu einer vollst√§ndigen Sicherung unterschiedliche Dateien und Kopien kopiert.  Inkrementelle Sicherungen k√∂nnen sich auf differenzielle Sicherungen konzentrieren. Sie kopieren nur die ge√§nderten Dateien, die sich im Vergleich zu differenziellen Sicherungen ge√§ndert haben.  F√ºr inkrementelle Sicherungen ben√∂tigen Sie die gesamte Sicherungskette.  Das hei√üt, die Hauptsicherung -&gt; 1. Teilsicherung (immer differenziell) -&gt; dann alle Teilsicherungen.  Die differenzielle Sicherung konzentriert sich immer auf eine vollst√§ndige Sicherungsdatenbank.  Incremental kann sich auf andere Sicherungsarten konzentrieren. <br>  Mit Pg_probackup und BART wurden inkrementelle Sicherungen blockweise erstellt.  Denn wir k√∂nnen nicht die ganze Datei √§ndern, sondern den Datenblock.  Und diese Dienstprogramme durchlaufen Wal-Dateien und w√§hlen genau die Bl√∂cke aus, die sich von Ihnen ge√§ndert haben.  Diese Sicherungsbl√∂cke werden in die Sicherung kopiert.  Um mit einem solchen inkrementellen Backup wiederherzustellen, ben√∂tigen Sie au√üerdem eine vollst√§ndige Kopie der Datenbank. Au√üerdem m√ºssen Sie diese inkrementellen Teile, die von wal eingegeben wurden, noch speichern.  Dies f√ºhrt zu einigen Einschr√§nkungen des Dienstprogramms, da diese √ºber Wal-Dateien ausgef√ºhrt werden m√ºssen.  PostgreSQL Professional verf√ºgt auch √ºber eine Ebene √ºber der Dateistruktur der Datenbank.  Deshalb suchen sie ziemlich schnell nach diesen Bl√∂cken.  Solche inkrementellen Backups sind sehr klein.  Wenn Sie eine kleine √Ñnderung der% -Datenbank haben und aufgrund der Tatsache, dass ziemlich viele technische Informationen in die Wal-Datei geschrieben werden, sichern diese Dienstprogramme Dutzende Kilobyte Daten f√ºr 1 Wal. </p><br><p><img src="https://habrastorage.org/webt/s3/d9/ca/s3d9ca1otjtkwql3_qakv67am7c.png"></p><br><p>  Weiterer Datenaustausch.  Dies impliziert, dass wenn wir nicht alles sichern m√ºssen.  Oder nicht alles wiederherstellen.  Dies ist nur bei logischen Sicherungen m√∂glich, und dies erm√∂glicht es uns, nur pg_dump auszuf√ºhren.  Dienstprogramme bieten eine ziemlich breite Funktionalit√§t.  Mit Pg_dump k√∂nnen Sie die Datenbankstruktur bei Bedarf sichern.  Sie k√∂nnen gezielt eine Tabelle sichern oder eine Tabelle aus dem Speicherauszug ausschlie√üen oder die Liste der Tabellen sichern und die Liste ausschlie√üen.  Die Funktionalit√§t ist in dieser Hinsicht recht breit.  Das Minus daf√ºr ist, dass Sie beim Wiederherstellen eines solchen Dumps bei einer gro√üen Datenbank viel Zeit f√ºr die Wiederherstellung aufwenden m√ºssen, da dies alles auf einer reinen PostgreSQL-Instanz ausgef√ºhrt werden muss. <br>  Diese Dienstprogramme sind sehr praktisch, wenn wir unsere St√§rken √ºbersch√§tzt und keine kleinen Datenbanken erstellt haben.  Wir k√∂nnen sie zu einer Instanz zusammenf√ºhren.  Wir k√∂nnen es so sehen, wenn wir unsere St√§rke erneut bewerten, unsere Datenbank anschwillt oder wir die Architektur dort von einem Monolithen in einen Dienst √§ndern und die Daten s√§gen.  Pg_dump ist in diesem Fall die einzige M√∂glichkeit, dies schmerzlos zu tun. </p><br><p>  Sie k√∂nnen auch eine Datenbank wiederherstellen und pgbackrest ist hier aufgelistet.  Er hat einen solchen Chip, dass wir darauf hinweisen k√∂nnen, dass wir nur eine Datenbank aus einer bin√§ren Sicherung ben√∂tigen.  Was macht er?  Die Standarddatenbank wird aus der Sicherung wiederhergestellt. Dies sind die Vorlagen und Postgres sowie die von uns angegebene Datenbank.  Bei allen anderen Datenbanken werden die Dateien zur√ºckgesetzt und auf Null gesetzt.  Das hei√üt, PostgreSQL hat eine transparente Struktur zum Speichern von Datenbanken in Dateien, da Sie auf dieser Ebene sozusagen die wiederhergestellte Datenbank verkleinern k√∂nnen.  Angenommen, wir m√ºssen herausfinden, welche dringenden Daten aus einer Bin√§rdatei stammen, wir m√∂chten keine 10-TB-Basis anheben, wir haben dort zwei Basen und wir erh√∂hen eine, wodurch insgesamt 5 TB m√∂glich sind.  In diesem Fall ist nat√ºrlich die Konsistenz verletzt, aber f√ºr einige schnelle L√∂sungen, wenn Sie dringend NoseBore-Daten aus einer gro√üen Datenbank entfernen m√ºssen, von denen es mehrere gibt, sind dies sehr gute Funktionen.  Eine vollst√§ndige Datenbanksicherung sollte jedoch bei der Wiederherstellung nicht ber√ºcksichtigt werden.  Das hei√üt, es ist f√ºr die Notarbeit. </p><br><p><img src="https://habrastorage.org/webt/bq/pf/aj/bqpfaj0wvrtn1atsq0yj1j4x7de.png"></p><br><p>  Wie ist die Arbeit mit vielen Versionen der Datenbank?  Auch hier ist alles sehr interessant.  Pg_dump ist insofern sehr gut, als wir nicht an die Version der Datenbank gebunden sind, in der wiederhergestellt werden soll.  Es gibt einen Nur-Text-Modus und nur reines SQL, das die gesamte Struktur der Datenbank und alle Daten beschreibt.  Im Prinzip k√∂nnen Sie mit ein paar √Ñnderungen an diesem Speicherauszug in MySQL, MSSQL und Oracle wiederherstellen, wo immer Sie m√∂chten.  Zwischen den Hauptversionen von PostgreSQL sind diese Speicherausz√ºge auch recht einfach zu verwenden. <br>  Multi-Versionierung, was meine ich damit?  So weit kann das Dienstprogramm verschiedene Versionen von Datenbanken verarbeiten und gleichzeitig mit PostgreSQL 9.6, 10, 11 arbeiten. Alles au√üer den integrierten Versionen von pg_dump und pg_basebackup, da sie an die jeweilige Version gebunden sind.  Der Rest konzentriert sich auf diese Dienstprogramme.  Sie k√∂nnen angegeben werden, wo sich pg_basebackup, pg_dump verschiedener Versionen befinden.  Sie w√§hlen jeweils mit der Version von PostgreSQL das neueste Hilfsprogramm zum Entfernen von Backups. <br>  Alle Dienstprogramme mit Ausnahme von pg_dump eignen sich zum Erstellen von Replikaten und Standby-Servern, da es sich um logische Sicherungen handelt.  Mit einem dieser Dienstprogramme k√∂nnen Sie die Server wiederherstellen und eine Verbindung zum Assistenten herstellen, um als Replikat dieses Servers zu fungieren. </p><br><p><img src="https://habrastorage.org/webt/rk/mr/jp/rkmrjpvyme8ifuybv7jvpkqd0r4.png"></p><br><p>  Wie Backups im Allgemeinen entfernt werden k√∂nnen, welche Modi gibt es zum Entfernen von Backups.  Sie k√∂nnen Dateien einfach mit Standard-OS-Tools kopieren: √ºber das Protokoll ssh (rsync, scp) und m√∂glicherweise einige andere Dienstprogramme.  Warum gibt es eine solche Gelegenheit, weil Sie das Kopieren parallelisieren k√∂nnen.  Pgbackrest funktioniert nur auf diese Weise, Barmann kann es auf diese Weise funktionieren, und es kann das PostgreSQL-Protokoll verwenden. <br>  PostgreSQL-Protokoll - Wenn das Sicherungsdienstprogramm eine Verbindung zu PostgreSQL herstellt und alle Dateien und Archivprotokolle, die w√§hrend des Sicherungsvorgangs auftreten, mithilfe des Replikationsprotokolls abruft.  Jeder andere und Barmann kann es tun. <br>  Grunds√§tzlich kann alles von einem Replikat gesichert werden, dies h√§ngt von der PostgreSQL-Version ab.  Mit PostgreSQL 10 und 11 k√∂nnen wir Backups von einem Replikat entfernen.  Aber ich empfehle dies nicht, im Allgemeinen wird es von keiner unserer Firmen empfohlen.  Da es Situationen gibt, in denen sie die √úberwachung verpasst haben, haben sie einen Monat lang ein Backup des Replikats erstellt, das vom Master-Server heruntergefallen ist und nicht relevant ist.  Das hei√üt, Backups sollten auf jeden Fall immer vom Master-Server entfernt werden.  Nur in diesem Fall k√∂nnen Sie sicher sein, dass Sie √ºber eine wirklich aktuelle Sicherungsdatenbank verf√ºgen. <br>  Multithreading-Backups - jeder kann dies tun, da alles aus unterschiedlichen Gr√ºnden erfolgt, jemand √ºber das ssh-Protokoll, jemand, der auf der Ebene der Datenbankkopien implementiert ist.  Mit Ausnahme von pg_basebackup und BART, da die BART-Operation nur bei pg_basebackup ausgef√ºhrt wird, wenn die Sicherung entfernt wird. Leider handelt es sich um eine Single-Thread-Sicherung, die nicht mit mehreren Threads ausgef√ºhrt wird. </p><br><p><img src="https://habrastorage.org/webt/72/4x/j0/724xj0dcehoennfciyo2uzucisq.png"></p><br><p>  Ein Beispiel f√ºr Multithreading.  Ich habe eine Datenbank mit 8 TB wiederhergestellt.  Wenn Sie sich auf die Auswahl eines Systems zum Entfernen von Backups konzentrieren, m√ºssen Sie wissen, dass wal-e in Python und wal-g in Golang geschrieben ist.  Ich musste die 8 TB Basis wiederherstellen.  Wal-e stie√ü auf Python-Einschr√§nkungen und zog mich mit AWS mit einer Geschwindigkeit von 600 Mbit / s.  Als ich zu Wal-G wechselte, hatte er die Situation, dass er nicht mit Wal-E-Backups arbeiten konnte, aber Wal-Dateien ziehen konnte.  Daher ist dieses mittlere Bild hier die Wiederherstellung der Datenbank.  Dann rollte wal, die dort in S3 lag und zu einem bestimmten Zeitpunkt restauriert wurde.  Wal-e ist in Python auf Python-Einschr√§nkungen und Parallelit√§t gesto√üen, das ist so bedingt.  Ein Wal-G lief in die S3-Schnittstelle, das hei√üt, wie schnell S3 jeden Moment geben konnte, so schnell es dauerte.  Im Durchschnitt waren es 2 Gbit / s, was gut genug ist.  Das hei√üt, mit wal-e wurden innerhalb von 45 Minuten einer fortlaufenden Sicherung eine Stunde lang √Ñnderungen an der Datenbank vorgenommen.  Bei wal-g stellte sich heraus, dass sie ungef√§hr 5 Minuten lang eine Stunde lang irgendwo in der Datenbank gew√ºrfelt haben. </p><br><p><img src="https://habrastorage.org/webt/rj/nk/fa/rjnkfaa9ld-am4dazwrasjqwfbk.png"></p><br><p>  Betriebsarten, was hier im Backup-System interessant ist. </p><br><ul><li>  Wiederherstellung zu einem bestimmten Zeitpunkt.  Wenn wir Protokolle archiviert und kopiert haben, k√∂nnen wir sie wiederherstellen.  Es erm√∂glicht Ihnen, ein Backup-System zu erstellen, es ist wie ein Standardfaktor.  Die Hauptsache ist, dass wir Wal-Dateien irgendwo speichern.  Dumps wissen nat√ºrlich nicht wie, weil sie sich ein wenig mit etwas anderem besch√§ftigen. </li><li>  Das Anpassen der Netzwerklast ist sehr wichtig, da es, wie gesagt, w√ºnschenswert ist, den Speicherauszug vom Master-Server zu entfernen. Dann k√∂nnen Sie selbst garantieren, dass Sie wirklich die tats√§chliche Sicherung erhalten.  Nun, manchmal kommt es vor, dass die Server so ausgelastet sind, dass es ziemlich schwierig ist, dorthin zu gelangen.  Wir haben einige Kunden eine separate Netzwerkschnittstelle stecken.  Manchmal wird dort eine minimale Ladezeit durchgef√ºhrt.  Es ist auch gut, wenn wir die Auslastung des Netzwerks beim Erstellen eines Backups angeben k√∂nnen.  Auf diese Weise k√∂nnen Sie pg_basebackup, Barmann und BART, wal-e, wal-g ausf√ºhren. </li><li>  Komprimierung im laufenden Betrieb.  Dies ist eine Frage, wie viel wir √ºber das Netzwerk √ºbertragen werden.  Wenn wir die Datei komprimieren k√∂nnen, bevor wir sie an das Repository senden, ist dies im Handumdrehen gut.  Und fast jeder kann es hier tun.  Die Hauptsache ist, den Grad der Komprimierung dort anzuzeigen. </li></ul><br><p><img src="https://habrastorage.org/webt/lv/pe/vd/lvpevdlrpqrg-9hypasdcs9-dse.png"></p><br><p>  Servicefreundlichkeit, was ist hier f√ºr Backup-Systeme interessant? </p><br><ul><li>   CLI ‚Äî    ,               ,     ,        ,      .    ,       CLI,     ,     ,     .       ,       ,      . </li><li>         barman, pgbackrest  BART,        .   ,        20-30  ,    ,    ,          ,           backup-           . ,  ,     . </li><li>    ‚Äì          ,     ,       backup-,   ,    backup-.           ,     -   .         .       . </li><li>   ‚Äì                 backup-,   ,  -   .     ,    ,     .  ,   , ,      ,       wal ,   ,        .   wal-e, wal-g,      ,    backup      - .  7 backup    . </li></ul><br><p><img src="https://habrastorage.org/webt/zj/r0/es/zjr0esauswimuw1itkqosshmyla.png"></p><br><p>   backup.  ,       backup,    backup  ,    ,        .  ,       .     ,   .   .    stage   .   ,       ,    backup .   CLI  ,           backup    . </p><br><p>     ,      ,  .         ,    backup .   ,     .  ,    .  ,    .   .   checksum  PostgreSQL.      ,      checksum  PostgreSQL.       checksum,   . </p><br><p>  pgbackrest  pg_probackup    backup  ,     checksum.          checksum. </p><br><p>  ,    backup,      checksum , ,   checksum   .     . </p><br><p><img src="https://habrastorage.org/webt/mj/_e/di/mj_edibaxks4v2_4-t5kanbxghe.png"></p><br><p>  N√ºtzliche Links: </p><br><ul><li> <a href="https://www.postgresql.org/docs/10/static/app-pgdump.html" rel="nofollow">https://www.postgresql.org/docs/10/static/app-pgdump.html</a> </li><li> <a href="https://www.postgresql.org/docs/10/static/app-pgbasebackup.html" rel="nofollow">https://www.postgresql.org/docs/10/static/app-pgbasebackup.html</a> </li><li> <a href="https://www.2ndquadrant.com/en/resources/barman/" rel="nofollow">https://www.2ndquadrant.com/en/resources/barman/</a> </li><li> <a href="https://github.com/wal-e/wal-e" rel="nofollow">https://github.com/wal-e/wal-e</a> </li><li> <a href="https://github.com/wal-g/wal-g" rel="nofollow">https://github.com/wal-g/wal-g</a> </li><li> <a href="https://pgbackrest.org/" rel="nofollow">https://pgbackrest.org/</a> </li><li> <a href="https://www.enterprisedb.com/products/edb-postgres-platform/edb-backup-and-recovery-tool" rel="nofollow">https://www.enterprisedb.com/products/edb-postgres-platform/edb-backup-and-recovery-tool</a> </li><li> <a href="https://postgrespro.ru/products/extensions/pg_probackup" rel="nofollow">https://postgrespro.ru/products/extensions/pg_probackup</a> </li></ul><br><p>      .   ,     .       ,     . </p><br><p><img src="https://habrastorage.org/webt/tt/qn/i7/ttqni7mc49sw-n6bww9bpi1gese.png"></p><br><p> :  ,  backup      ,     ,   ,   .       ,      ,       backup.    ,  ,  -    , ,   ,  ,    ,     ,   .    -    ? </p><br><p> :       ,        ,       .     .   .  -   , , backup   ,   ,       ,      .          ,         .    ,  , , ,  ,   ,     /     .  ,       ,       .      ,     .   ,      .       ,        . </p><br><p> :    , ,    ?       . </p><br><p> :        .         4 .       .     .      backup.       .    ,     . </p><br><p> :         ? </p><br><p> :    .       .   wal-e, wal-g, pgbackrest.    borman, pg_dump,   basebackup.    ,      ,       .   . </p><br><p> :  ,    -     PostgreSQL,   , , postgis  - -? </p><br><p> :    ,      backup   ,      .  checksum  ,  PostgreSQL   checksum,   ,       .   postgis,     -      . Pg_dump      ,    ,   , SQL .        SQL .     . , ,         .    dump,       . </p><br><p> :  ,     .   ,          -  ? </p><br><p> :     .    dump  ,         .    ,    ‚Äì    ,  ,  - ,  ,     .      ,    . ,   -  ,      . </p><br><p> :   ,     ,   ,  bloat   ? </p><br><p> : . </p><br><p> :    ‚Äî  ,     -    . , Symantec, Veritas Backup Exec  .      PostgreSQL? </p><br><p> : ,      ,      . PostgreSQL     ,    pg_start_backup.  ,  .     . </p><br><p> :  ,  -  Symantec, Veritas Backup Exec      . </p><br><p> :   . </p><br><p> : , ,      .   checksum    - ,   , - ? </p><br><p> :    ‚Äî            .        stage ,    .    stage    .       .             .    ,      -,        .     .      . </p><br><p> :   ,      WAL ,   S3.        wal-e, wal-g    - awscli  .      ? </p><br><p>  (  ):   wal-g.     wal-g.      40     wal-g .      .  ,   .   , prefetch,   wal  ,    . ,      ‚Äî  ,       wal.    wal   ,   page cache   ,  ,      wal,       ,        .     ,   . </p><br><p>  :     .   ,     PostgreSQL ‚Äî   -&gt; /dev/null,  ,      .        ,          .       smoke .   <a href="https://postgrespro.ru/docs/postgresql/10/amcheck" rel="nofollow">amcheck</a> ,      .        ,        ,     ,       . </p><br><p> :       10  .       .            .    .       wal  ‚Äî      .      ? </p><br><p> :        .      .      .         ,        . </p><br><p> :          ,       pg_dump,        .  Richtig? </p><br><p> : -     . ,   . </p><br><p> :   ,      ,    - ? </p><br><p> : pg_dump   ,    . </p><br><p> :     pg_dump,    ,   ,   ,         ,    . </p><br><p> :         ,       -,    . </p><br><p> :   ,   . </p><br><p> :        ,       -  . </p><br><p> :    .     .      .      . ,     ,    .   . Pg_dump  ,  - ,  exit_code  .   ,       , .   ,      . </p><br><p> PS ‚Ññ1        pg_dump, pg_basebackup. </p><br><div class="scrollable-table"><table><thead><tr><th></th><th> barman </th><th> wal-e </th><th> wal-g </th><th> pg_probackup </th><th> pgbackrest </th><th> BART </th></tr></thead><tbody><tr><td> ssh (rsync, scp) </td><td>  + </td><td></td><td></td><td></td><td>  + </td><td></td></tr><tr><td>     </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td> S3 </td><td></td><td>  + </td><td>  + </td><td></td><td>  + </td><td></td></tr><tr><td>  Azure </td><td></td><td>  + </td><td>  + </td><td></td><td></td><td></td></tr><tr><td> Google Cloud </td><td></td><td>  + </td><td>  + </td><td></td><td></td><td></td></tr><tr><td>    </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td></td></tr><tr><td>   </td><td></td><td></td><td>  + </td><td></td><td>  + </td><td></td></tr><tr><td>   </td><td></td><td></td><td>  + </td><td></td><td>  + </td><td></td></tr><tr><td></td><td> barman </td><td> wal-e </td><td> wal-g </td><td> pg_probackup </td><td> pgbackrest </td><td> BART </td></tr><tr><td>    </td><td></td><td></td><td>  + </td><td>  + </td><td></td><td></td></tr><tr><td>    </td><td></td><td></td><td></td><td></td><td>  + </td><td></td></tr><tr><td> - </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>   </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td></td></tr><tr><td> Point-in-Time-Wiederherstellung </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  Anpassung der Netzwerklast </td><td>  + </td><td></td><td>  + </td><td></td><td></td><td>  + </td></tr><tr><td>  Schnelle Komprimierung </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td></td></tr><tr><td>  CLI </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  Dedizierter Server </td><td>  + </td><td></td><td></td><td></td><td>  + </td><td>  + </td></tr><tr><td></td><td>  Barmann </td><td>  wal-e </td><td>  wal-g </td><td>  pg_probackup </td><td>  R√ºckenlehne </td><td>  Bart </td></tr><tr><td>  Strukturierter Backup-Speicher </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  Aufbewahrungsrichtlinien </td><td>  + </td><td>  cron </td><td>  cron </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  CLI zur √úberwachung </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  G√ºltigkeit des Sicherungsabschlusses </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  Checksum postgresql </td><td></td><td></td><td></td><td>  + </td><td>  + </td><td></td></tr></tbody></table></div><br><p>  PS Nr. 2 Fehler, Korrekturen unter dem Artikel, Erg√§nzungen der Pivot-Tabelle k√∂nnen √ºber <a href="" rel="nofollow">Pull-Request vorgenommen werden</a> </p><br><p>  PS # 3 Wal-g begr√º√üt freiwillige Helfer, die bei der Dokumentation helfen. </p><br><p>  PS Nr. 4 Um wal-g mit rpm zu installieren, k√∂nnen Sie mein Repository verwenden: <a href="https://github.com/patsevanton/wal-g-rpm" rel="nofollow">Github</a> , <a href="https://copr.fedorainfracloud.org/coprs/antonpatsev/wal-g/" rel="nofollow">Fedora COPR</a> . </p><br><p>  PS Nr. 5 Wie erstelle ich eine vollst√§ndige und inkrementelle Sicherung beim Erstellen und Speichern in S3 und speichere nur eine vollst√§ndige Sicherung auf Band?  Wenn du Ideen hast, sag es mir in den Kommentaren oder in der PN. </p><br><p><img src="https://habrastorage.org/webt/r8/hh/ks/r8hhkssl2kpkvvqvat1xgwe8eie.png"></p><br><p>  Umfrage: Welche Backup-Tools verwenden Sie? </p><br><p>  PS Nr. 6 Telegrammkanal PostgreSQL: <a href="https://t.me/pgsql" rel="nofollow">https://t.me/pgsql</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de485622/">https://habr.com/ru/post/de485622/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de485610/index.html">Erstellen Sie eine Qt-Anwendung in WebAssembly unter Windows</a></li>
<li><a href="../de485612/index.html">Was hat mir ein Weltraumunfall als Entwickler beigebracht?</a></li>
<li><a href="../de485614/index.html">Rote Unternehmenskultur ist das Hauptproblem des russischen Gesch√§fts (Teil 3)</a></li>
<li><a href="../de485618/index.html">Automatisierung f√ºr die Kleinsten. Hinweise. RESTful API</a></li>
<li><a href="../de485620/index.html">Joschkar-Ola im Allgemeinen eine IT-Stadt?</a></li>
<li><a href="../de485624/index.html">Minecraft-Server: Windows vs Linux</a></li>
<li><a href="../de485632/index.html">√úberwachen der Kreditbewertung in Power BI</a></li>
<li><a href="../de485634/index.html">Das Dungeons and Dragons-Dashboard hat mir geholfen, Englisch zu lernen</a></li>
<li><a href="../de485636/index.html">CRISPR-resistente Viren bauen Schutzr√§ume, um das Genom vor DNA-durchdringenden Enzymen zu sch√ºtzen</a></li>
<li><a href="../de485640/index.html">Methoden zum Ausblenden von Webseiten</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>