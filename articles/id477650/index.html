<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👝 🚙 🧓🏽 Enkripsi lalu lintas TLS menurut algoritma GOST-2012 dengan Stunnel 🔰 👩‍🏫 🕘</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pada artikel ini saya ingin menunjukkan cara mengkonfigurasi Stunnel untuk menggunakan algoritma kriptografi Rusia dalam protokol TLS. Sebagai bonus, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Enkripsi lalu lintas TLS menurut algoritma GOST-2012 dengan Stunnel</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/aktiv-company/blog/477650/"><img src="https://habrastorage.org/webt/zc/ye/bj/zcyebjoqvyhnnaiux68xagkfkz8.png"><br><p>  Pada artikel ini saya ingin menunjukkan cara mengkonfigurasi Stunnel untuk menggunakan algoritma kriptografi Rusia dalam protokol TLS.  Sebagai bonus, saya akan menunjukkan cara mengenkripsi saluran TLS menggunakan algoritma GOST yang diterapkan pada inti crypto Rutoken EDS 2.0. </p><br><p>  Tapi pertama-tama, mari kita cari tahu apa tujuan Stunnel.  Singkatnya - ini adalah program di mana Anda dapat menggeser seluruh logika enkripsi lalu lintas antara server dan klien.  Ini dilakukan sebagai berikut: misalkan Anda memiliki klien dan server yang berkomunikasi satu sama lain tanpa menggunakan enkripsi, otentikasi, dan pemeriksaan integritas.  Anda dapat menulis ulang klien dan server sehingga semua pesan keluar dan masuk ditransmisikan di antara mereka sendiri, dengan mempertimbangkan semua poin ini, tetapi mengapa kesulitan seperti itu, jika Anda bisa menggesernya ke bahu aplikasi lain?  Untuk mengatasi masalah ini, Stunnel tepat. </p><a name="habracut"></a><br><p>  Anda hanya perlu mengkonfigurasi klien sehingga semua lalu lintasnya ditransmisikan ke klien Stunnel, pada gilirannya, itu membangun koneksi yang aman ke server, mengirim data ke server Stunnel.  Stunnel pada server mendekripsi lalu lintas masuk dan mengalihkan data ke input server.  Di atas lebih mudah untuk diwujudkan dengan melihat diagram ini. </p><br><p><img src="https://habrastorage.org/webt/vb/vk/9u/vbvk9u4vm7rf6jxcfr3gsqrboea.png"></p><br><p>  Perlu dicatat bahwa server tidak harus persis Stunnel, untuk bekerja dengan algoritma kriptografi.  Sangat menyenangkan bahwa ada stand demo siap pakai yang mendukung kriptografi Rusia, daftar yang ada dalam <a href="https://www.xn--h1adndcbfmd.xn--p1ai/resource/archive/rc2019/files/01_Smyshlyaev.pdf">presentasi bersama RusCrypto'2019</a> . </p><br><p>  Kami membutuhkan server stabil yang menyediakan otentikasi dua arah. <br>  Kami telah memilih server CryptoPro sebagai yang paling andal dengan implementasi penuh standar GOST TLS.  Terima kasih kepada mereka untuk itu :) </p><br><p>  Kedengarannya cukup sederhana, mari kita coba mengatur proses ini. </p><br><h2 id="podgotovitelnyy-shag">  Langkah persiapan </h2><br><p>  Kami akan membutuhkan: </p><br><ol><li>  Openssl </li><li>  Stunnel </li><li>  mesin </li><li>  Akses ke server uji CryptoPro untuk memverifikasi koneksi TLS </li></ol><br><p>  OpenSSL untuk Windows dapat diambil <a href="https://slproweb.com/products/Win32OpenSSL.html">dari sini</a> , dan untuk pengguna Linux - dari repositori atau dikumpulkan dengan mengunduh versi terbaru <a href="https://www.openssl.org/source/">dari sini</a> .  Itu juga dapat diambil dari <a href="https://www.rutoken.ru/developers/sdk/">Rutoken SDK</a> , dari <strong>direktori openssl \ openssl-tool-1.1</strong> , arsip ini akan berguna bagi kita lebih jauh, karena  itu mengandung rekayasa yang menarik bagi kita.  Stunnel dapat ditemukan di <a href="https://www.stunnel.org/downloads.html">sini</a> .  Versi&gt; = 5.56 diperlukan untuk operasi. </p><br><p>  Anda dapat mengunduh rtengine dari <a href="https://www.rutoken.ru/developers/sdk/">Rutoken SDK</a> , itu terletak di <strong>direktori openssl \ rtengine \ bin</strong> .  Anda harus meletakkannya di tempat semua mesin openssl disimpan.  Anda dapat menemukan cara mereka menggunakannya </p><br><pre><code class="bash hljs">openssl.exe version -a</code> </pre> <br><p>  Tetapi hanya memindahkan mesin ke folder yang diinginkan tidak cukup, Anda masih perlu mengkonfigurasi openssl sendiri untuk bekerja dengannya.  Kami mencari tahu di mana file konfigurasi <strong>openssl.cnf terletak</strong> dengan perintah yang sama seperti di atas (di bawah stunnel Windows hadir dengan versi openssl sendiri, sehingga file konfigurasi terletak di <strong>jalur \ to \ stunnel \ config \ openssl.cnf</strong> </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   : openssl_conf = openssl_def ... #   : # OpenSSL default section [openssl_def] engines = engine_section [engine_section] rtengine = rtengine_section [rtengine_section] engine_id = rtengine dynamic_path = /path/to/rtengine.so MODULE_PATH = /usr/lib/librtpkcs11ecp.so default_algorithms = CIPHERS, DIGEST, PKEY, RAND</span></span></code> </pre><br><p>  Mari kita verifikasi bahwa rtengine terhubung, untuk ini kami menghubungkan token dan daftar semua algoritma enkripsi: </p><br><pre> <code class="bash hljs">openssl ciphers -v</code> </pre> <br><p>  Biarkan saya mengingatkan Anda bahwa pada Windows Anda perlu memeriksa openssl, yang terletak di sebelah stunnel <br>  Jika di antara mereka, GOST kami akan hadir, maka semuanya telah diatur dengan benar. </p><br><p>  Waktunya telah tiba untuk yang paling menarik: memeriksa koneksi dengan server uji GOST CryptoPro.  Daftar server ini dijelaskan di sini ( <a href="https://www.cryptopro.ru/products/csp/tc26tls">https://www.cryptopro.ru/products/csp/tc26tls</a> ).  Masing-masing server ini bekerja dengan algoritma sendiri untuk otentikasi dan enkripsi.  Selain itu, pada port 443, 1443, 2443, ... layanan diluncurkan yang hanya menerima parameter tertentu.  Jadi, misalnya, di <a href="http://tlsgost-256auth.cryptopro.ru/">http://tlsgost-256auth.cryptopro.ru</a> , enkripsi dilakukan dengan otentikasi menggunakan algoritma GOST2012-GOST8912-GOST8912-GOST8912 dan kunci 256-bit.  Juga, port 443 menggunakan XchA-ParamSet, port 1443 menggunakan XchB-ParamSet, port 2443 menggunakan A-ParamSet, dll. </p><br><p>  Sekarang kita tahu kunci mana yang kita butuhkan, mari kita dapatkan sertifikat root dari server uji, kerjakan kunci untuk bekerja, dan tandatangani permintaan untuk sertifikat kita. </p><br><h3 id="prostoy-sposob-rabotaet-pod-windows-i-linux">  Cara sederhana (bekerja di bawah Windows dan Linux) </h3><br><ol><li>  Untuk mendapatkan sertifikat root, kami akan pergi ke <a href="http://testgost2012.cryptopro.ru/certsrv/">situs tes CA LLC "CRIPTO-PRO"</a> .  Dan klik tombol untuk mendapatkan sertifikat.  Tab baru akan muncul, di mana Anda harus memilih metode enkripsi Base64 dan klik tombol <strong>"Unduh sertifikat CA"</strong> .  File <strong>certnew.cer yang</strong> dihasilkan disimpan. </li><li>  Ikuti <a href="https://ra.rutoken.ru/devices">tautannya</a> .  Instal semua plugin yang diminta dari kami.  Kami klik pada tombol <strong>"Buat kunci"</strong> , dan pilih algoritma "GOST R 34.10-2012 256-bit" untuk generasi.  Selanjutnya, buat permintaan sertifikat, di kolom <strong>"Aplikasi"</strong> Anda dapat memilih semuanya.  Di kolom Aplikasi Tambahan: Otentikasi Klien dan Pengguna Pusat Pendaftaran CryptoPro. </li><li>  Kami kembali membuka situs tes CA, tetapi kali ini kami mengklik tombol <strong>"Kirim permintaan siap PKCS # 10 atau PKCS # 7 yang dikodekan dalam Base64"</strong> .  Kami menempelkan isi permintaan kami ke dalam bidang, klik tombol "Masalah" dan muat sertifikat <em>user.crt</em> dalam format Base64.  File yang dihasilkan disimpan. </li></ol><br><h3 id="cherez-komandnuyu-stroku">  Melalui baris perintah </h3><br><ol><li><p>  Untuk mendapatkan sertifikat root, kami akan pergi ke <a href="http://testgost2012.cryptopro.ru/certsrv/">situs tes CA LLC "CRIPTO-PRO"</a> .  Dan klik tombol untuk mendapatkan sertifikat.  Tab baru akan muncul, di mana Anda harus memilih metode enkripsi Base64 dan klik tombol <strong>"Unduh sertifikat CA"</strong> .  File <strong>certnew.cer yang</strong> dihasilkan disimpan. </p><br></li><li><p>  Sekarang buat kunci. </p><br><pre> <code class="bash hljs">pkcs11-tool --module /usr/lib/librtpkcs11ecp.so --keypairgen --key-type GOSTR3410-2012-256:B -l --id 45 <span class="hljs-comment"><span class="hljs-comment"># 45 --   ASII id  (E)</span></span></code> </pre> <br><p>  Perlu dicatat bahwa kunci yang dihasilkan pada token tidak dapat disalin dari token.  Ini adalah salah satu keunggulan utama penggunaannya. </p><br></li><li><p>  Buat permintaan sertifikat: </p><br><pre> <code class="bash hljs">openssl req -engine rtengine -new -key=<span class="hljs-string"><span class="hljs-string">"pkcs11:id=E"</span></span> -keyform engine -out client.req</code> </pre> <br></li><li><p>  Kami kembali membuka situs tes CA, tetapi kali ini kami mengklik tombol <strong>"Kirim permintaan siap PKCS # 10 atau PKCS # 7 yang dikodekan dalam Base64"</strong> .  Kami menempelkan isi permintaan kami ke dalam bidang, klik tombol Masalah dan mengunggah sertifikat <em>user.crt</em> dalam format Base64.  File yang dihasilkan disimpan. </p><br></li></ol><br><p>  Ada pertanyaan terakhir: Mengapa semua ini ???  Mengapa kami mendapatkan semua sertifikat, kunci, dan permintaan ini? </p><br><p>  Faktanya adalah bahwa mereka dibutuhkan oleh protokol TLS untuk otentikasi dua arah.  Ini bekerja sangat sederhana. </p><br><p>  Kami memiliki sertifikat server, dan kami menganggapnya tepercaya. </p><br><p>  Klien kami memverifikasi bahwa server yang bekerja sama dengan kami memiliki sertifikat serupa. <br>  Server ingin memastikan bahwa ia berfungsi dengan pengguna yang diketahuinya.  Untuk ini, kami membuat permintaan sertifikat untuk bekerja melalui kunci kami. </p><br><p>  Kami mengirim permintaan ini dan server menandatanganinya dengan tanda tangan digitalnya.  Sekarang kita dapat menyajikan sertifikat ini setiap kali, ditandatangani oleh CA root, dengan demikian menegaskan bahwa kita adalah kita. </p><br><h2 id="konfigurirovanie-stunnel">  Mengkonfigurasi Stunnel </h2><br><p>  Tetap hanya mengkonfigurasi saluran kami dengan benar.  Untuk melakukan ini, buat file <strong>stunnel.conf</strong> dengan pengaturan Stunnel default dan tulis yang berikut di sini: </p><br><pre> <code class="bash hljs">;      - debug = 7 output = /path/to/stunnel.log ;    TLSv1 sslVersion=TLSv1 ;  . engine=rtengine ;     [remote system] client=yes ;  engine,     engineId=rtengine ;   2 (  ) verify = 2 ;     CAFile = /path/to/certnew.cer ;     cert=/path/to/user.crt ;     . key=pkcs11:model=Rutoken%20ECP;manufacturer=Aktiv%20Co.;id=E ;   Stunnel      accept = localhost:8080 connect = tlsgost-256auth.cryptopro.ru:2443</code> </pre><br><p>  Sekarang, jika semuanya dilakukan dengan benar, Anda dapat memulai Stunnel dengan konfigurasi kami dan terhubung ke server: </p><br><pre> <code class="bash hljs">stunnel.exe /path/to/stunnel.conf</code> </pre> <br><p>  Buka browser dan pergi ke localhost: 8080.  Jika semuanya benar, maka yang berikut akan ditampilkan: </p><br><img src="https://habrastorage.org/webt/x3/lx/ti/x3lxtimldg9tcdnyojmwfhgcpu4.png"><br><p>  Jika tidak, maka kita melihat log dan menggunakan debugger untuk memahami apa masalahnya. </p><br><p>  Jika Anda memiliki pertanyaan, maka Anda dapat mengomentari :) </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id477650/">https://habr.com/ru/post/id477650/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id477638/index.html">Dibeli! = Milik Anda: John Deere merampas hak petani untuk memperbaiki traktor mereka sendiri</a></li>
<li><a href="../id477642/index.html">Visi mesin (radio) melihat melalui dinding</a></li>
<li><a href="../id477644/index.html">Mengembalikan UNIX v0 ke PDP-7: Detail Backroom</a></li>
<li><a href="../id477646/index.html">Matematikawan memotong bentuk untuk mencari bagian persamaan</a></li>
<li><a href="../id477648/index.html">MVCC dalam PostgreSQL-3. Versi baris</a></li>
<li><a href="../id477654/index.html">Mencoba instans operator yang ditingkatkan di Jawa 14</a></li>
<li><a href="../id477656/index.html">Jadi tetap saja, mengapa Anda perlu membuatnya?</a></li>
<li><a href="../id477658/index.html">Active Restore: dapatkah pemulihan bencana lebih cepat? Jauh lebih cepat?</a></li>
<li><a href="../id477662/index.html">Akses ke Redd Ban di Jembatan FTDI</a></li>
<li><a href="../id477668/index.html">29 November, 6 malam - devleads-mitap</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>