<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî§ üè∑Ô∏è üéÜ ShIoTiny: un reloj sin resorte o tiempo real y c√≥mo trabajar con √©l ‚òÇÔ∏è ü§ôüèΩ üöñ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¬øDe qu√© trata este art√≠culo? 

 Continuamos la serie de art√≠culos sobre ShIoTiny , un controlador visualmente programable basado en el chip ESP8266 . ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ShIoTiny: un reloj sin resorte o tiempo real y c√≥mo trabajar con √©l</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467545/"><img src="https://habrastorage.org/webt/pv/8m/zb/pv8mzbyp-nmax1aoau00apxxuly.jpeg"><br><br>  <b>¬øDe qu√© trata este art√≠culo?</b> <br><br>  Continuamos la serie de art√≠culos sobre <b>ShIoTiny</b> , un controlador visualmente programable basado en el chip <b>ESP8266</b> . <br><br>  Este art√≠culo <b>habla</b> sobre el reloj en tiempo real en el controlador <b>ShIoTiny</b> , la sincronizaci√≥n horaria y el uso de nodos para trabajar con el reloj. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><b>Sitio del</b> proyecto <b>ShIoTiny</b></a> <br><br>  <b>Art√≠culos anteriores de la serie.</b> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ShIoTiny: peque√±a automatizaci√≥n, Internet de las cosas o "seis meses antes de las vacaciones"</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ShIoTiny: nodos, enlaces y eventos o caracter√≠sticas de programas de dibujo</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ShIoTiny: ventilaci√≥n de habitaci√≥n h√∫meda (proyecto de ejemplo)</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ShIoTiny y el mundo circundante: conectar sensores a entradas binarias, rebote de contactos y otros problemas</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ShIoTiny y el mundo: sensores anal√≥gicos o ADC para los m√°s peque√±os</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Firmware binario, circuitos del controlador y documentaci√≥n</a> <br><a name="habracut"></a><br><h3>  Entrada </h3><br>  Hoy hablamos de tiempo.  No se trata del tiempo, en el sentido en que los fil√≥sofos han estado discutiendo al respecto durante siglos y el borde final no es visible para este debate.  Y sobre la hora que vemos en el reloj y seg√∫n la cual vamos al trabajo, a la escuela o tenemos prisa en una cita. <br><br>  La cosa es que <b>faltan</b> el reloj en tiempo real no vol√°til en el chip <b>ESP8266</b> y el controlador <b>ShIoTiny</b> .  Esta lesi√≥n de nacimiento del controlador <b>ShIoTiny</b> es completamente mi culpa.  Pero lo hecho, hecho est√°. <br><br>  Tan pronto como el firmware vio la luz, el p√∫blico, indignado por mi actitud hacia el tiempo real, comenz√≥ a asomar mi nariz ante esta falla. <br><br>  Dado que los errores deben corregirse, y esta vez al menos no con sangre, fui a conocer al n√∫mero cada vez mayor de usuarios de mi firmware e hice lo que pude.  Es decir, agregu√© nodos al firmware del controlador <b>ShIoTiny</b> que hacen que sea m√°s o menos conveniente trabajar con esto en tiempo real. <br><br><h3>  Acerca de ShIoTiny Watch </h3><br>  Como ya se mencion√≥, no hay "horas con una bater√≠a" en <b>ShIoTiny</b> .  Pero al mismo tiempo, se implementa la cuenta regresiva de segundos a partir del 1 de enero de 1970. <br><br>  Este es el mismo tiempo llamado tiempo UNIX, almacenado en variables del tipo <b>time_t</b> en lenguajes C / C ++ y que debe finalizar el 19 de enero de 2038 en sistemas de 32 bits. <br><br>  Pero no tengas miedo.  Creo que para 2038 todos tendr√°n tiempo de hacer que <b>time_t</b> escriba 64 bits y el problema se resolver√° en los pr√≥ximos 292 mil millones de a√±os.  Bueno, hay algo m√°s que se nos ocurrir√°. <br><br>  Tenga en cuenta que la hora en el formato <b>time_t a</b> veces se llama (en mi art√≠culo tambi√©n): marca de tiempo o, en ruso, una <b>marca de tiempo</b> . <br><br>  Pero volvamos a nuestro controlador.  Por lo tanto, hay un reloj, pero este reloj se restablece a 0 despu√©s de apagar la alimentaci√≥n.  Esto <b>lleva</b> a la conclusi√≥n trivial de que el principal problema de contar el tiempo en el controlador <b>ShIoTiny</b> es la necesidad de sincronizar el reloj del controlador cuando se enciende la alimentaci√≥n.  El resto son problemas puramente t√©cnicos. <br><br><h3>  Sincronizaci√≥n de tiempo </h3><br>  Una forma establecida desde hace mucho tiempo para sincronizar la hora en Internet son los servidores <b>NTP</b> .  Y la primera idea era hacer un nodo que sincronizara la hora con un servidor <b>NTP</b> dado. <br><br>  Pero, respirando un poco de aire fresco y reflexionando sobre mi calabaza, me di cuenta de que este enfoque es ideol√≥gicamente incorrecto. <br><br>  No es un hecho que el usuario quiera extraer el controlador con el firmware <b>ShIoTiny</b> en Internet.  Y el tiempo para la sincronizaci√≥n se puede enviar no solo desde el servidor <b>NTP</b> , sino tambi√©n a trav√©s de <b>UDP-multicast,</b> o con una calidad de conexi√≥n conocida, a trav√©s de <b>MQTT</b> . <br><br>  Por lo tanto, se tom√≥ una decisi√≥n fat√≠dica: separar los nodos para recibir el tiempo del servidor <b>NTP</b> y establecer la hora del sistema. <br><br>  En total, se desarrollaron dos nodos para la sincronizaci√≥n horaria: el nodo para recibir la hora del servidor <b>NTP Hora NTP</b> <br><br><img src="https://habrastorage.org/webt/ym/27/br/ym27brh824hmp7rw33-teekhkum.png"><br><br>  y el nodo de instalaci√≥n del reloj del sistema <b>Set Time</b> <br><br><img src="https://habrastorage.org/webt/hc/ux/h9/hcuxh97i2xfof8neay76nrb9cpw.png"><br><br>  El nodo que recibe el tiempo del servidor <b>NTP</b> como par√°metros recibe el nombre o la direcci√≥n IP del servidor <b>NTP</b> y, separados por una coma, el per√≠odo de tiempo del servidor <b>NTP</b> en minutos.  Por defecto, el tiempo se solicita al servidor <b>NTP</b> cada 60 minutos o 1 hora.  En la salida, este nodo establece 0 hasta que se sincronice la hora o la marca de tiempo sea el resultado de la √∫ltima sincronizaci√≥n con el servidor. <br><br>  El nodo de instalaci√≥n del reloj del sistema recibe una marca de tiempo como entrada y establece el reloj del sistema de acuerdo con esta etiqueta. <br><br>  La figura muestra el esquema m√°s simple para sincronizar el reloj del sistema con un servidor <b>NTP</b> . <br><br><img src="https://habrastorage.org/webt/gg/jx/fd/ggjxfdr-vc1qyg49jltaywrjtli.png"><br><br>  El per√≠odo de sincronizaci√≥n no est√° configurado y es de 60 minutos de forma predeterminada.  La figura muestra la marca de tiempo. <br><br>  Observo que no puede haber m√°s de un nodo para recibir el tiempo de un servidor <b>NTP</b> y m√°s de un nodo para configurar la hora del sistema en el esquema del programa. <br><br>  Si necesita un esquema de sincronizaci√≥n ex√≥tico, puede usar <b>UDP-multicast</b> o <b>MQTT</b> .  Los esquemas son completamente similares. <br><br>  Para la sincronizaci√≥n <b>UDP-multicast</b> , aproximadamente lo mismo que en la figura. <br><br><img src="https://habrastorage.org/webt/d9/vm/mh/d9vmmhwjiouw-bim7xsk7jdwoik.png"><br><br>  Y para la sincronizaci√≥n a trav√©s de <b>MQTT</b> (no aconsejo, por supuesto, pero en casos extremos), tal. <br><br><img src="https://habrastorage.org/webt/em/yp/fq/emypfq7h46bxluup4k7zj5_rplk.png"><br><br>  Espero que ahora todo est√© claro con la sincronizaci√≥n del reloj del sistema del controlador <b>ShIoTIny</b> .  Pasemos a los nodos de tiempo de recepci√≥n y procesamiento. <br><br><h3>  Que hora es </h3><br>  La pregunta es simple, pero a veces no es f√°cil de responder.  Despu√©s de todo, el tiempo en cada punto de la Tierra es diferente.  Nuestra vasta patria incluye desde Kaliningrado hasta Kamchatka hasta 11 zonas horarias. <br><br>  <b>El</b> servidor <b>NTP</b> , dependiendo de la configuraci√≥n, puede devolver una marca de tiempo asociada con diferentes zonas horarias.  Por lo general, esta marca de tiempo est√° vinculada a <b>UTC</b> - hora universal. <br><br>  Pero generalmente necesitamos la hora local de la regi√≥n donde funciona nuestro controlador.  ¬øC√≥mo estar aqu√≠? <br><br>  Y es muy simple: para obtener la marca de <b>tiempo</b> del reloj del sistema del controlador <b>ShIoTIny</b> , se desarroll√≥ el nodo <b>Get Time</b> , en el que puede establecer la zona horaria como una compensaci√≥n horaria de -12 horas a +12 horas en relaci√≥n con el reloj del sistema del controlador. <br><br>  Supongamos que obtenemos la hora del servidor <b>pool.ntp.org</b> y sincronizamos el reloj del sistema, como en nuestro ejemplo anterior.  Este servidor devuelve la hora universal.  Necesitamos locales, como Tomsk, como el m√≠o.  S√© que Tomsk est√° en la zona horaria <b>UTC + 7</b> .  Entonces, configuremos la unidad receptora de tiempo para compensar +7 o solo 7. Como en la figura a continuaci√≥n. <br><br><img src="https://habrastorage.org/webt/sc/t0/en/sct0en2l8lmwbvucefraveh2rbw.png"><br><br>  Y si vivi√©ramos en la provincia canadiense de Alberta, el turno ser√≠a de -7 horas.  Recuerde lo principal: la <b>zona horaria se establece en el nodo para obtener el tiempo en horas</b> .  Y se configura en forma de un desplazamiento relativo a la hora del reloj del sistema.  La marca de tiempo se establece en la salida de la unidad de recepci√≥n de tiempo.  Puede haber varios nodos para obtener tiempo en un circuito. <br><br><h3>  Mira el reloj </h3><br>  Es muy conveniente que la m√°quina trabaje con el tiempo en el formato de marcas de tiempo <b>time_t</b> .  Despu√©s de todo, este es solo un n√∫mero entero que muestra la cantidad de segundos relativos al punto de partida: 1 de enero de 1970.  En este formato, puede encontrar f√°cilmente la distancia entre dos puntos de tiempo, contar per√≠odos, etc.  Esto es solo la suma y resta de enteros. <br><br>  Pero el hombre no es una m√°quina.  Se siente mucho m√°s c√≥modo con la representaci√≥n habitual del tiempo en forma de a√±o, mes, d√≠a, horas, minutos y segundos.  Entonces los humanos estamos dispuestos. <br><br>  Por lo tanto, se introdujeron los nodos de la traducci√≥n de la marca de tiempo en las unidades de cambio de tiempo familiares para la persona, y viceversa, la s√≠ntesis de la marca de tiempo de las unidades de cambio de tiempo comprensible para la persona.  Estos nodos se denominan, respectivamente, <b>Tiempo dividido</b> y <b>Tiempo de sintetizador</b> . <br><br>  C√≥mo funciona todo esto queda claro en la siguiente figura. <br><br><img src="https://habrastorage.org/webt/d_/xd/xl/d_xdxlxtdrynelvluhzdi74ratu.png"><br><br>  Observo que los nodos <b>Tiempo dividido</b> y <b>Tiempo de</b> <b>sintetizador</b> meses (mes) y d√≠as de la semana (wday) se cuentan desde cero.  Por meses: 0-enero, 11-diciembre.  Para los d√≠as de la semana 0-domingo, 6-s√°bado. <br>  Otros resultados: d√≠a del mes (d√≠a), a√±o (a√±o), hora (hora), min (minuto), seg (segundo): se cuentan en la forma habitual.  Horas, minutos, segundos - de 0 a 59. D√≠a del mes - dependiendo del mes desde el primer d√≠a hasta el 30 o 31 y, para febrero, hasta el 28 o 29. <br>  Bueno, un a√±o, √©l es el a√±o.  2019 ahora. <br>  Espero que todo est√© claro. <br><br><h3>  Ejemplo del sistema </h3><br>  Para no ser infundado, dar√© un ejemplo del uso de relojes.  Por supuesto, simplificado. <br><br>  Supongamos que tenemos una habitaci√≥n h√∫meda que queremos ventilar por la fuerza.  Pero no siempre, sino solo cuando la humedad es superior a un nivel determinado y solo de noche.  Por la noche, para no molestar a las personas durante el d√≠a con el ruido de los fan√°ticos.  Bueno, aqu√≠ estamos los estetos y nos preocupamos por las personas. <br><br>  Intentemos implementar esto. <br><br><img src="https://habrastorage.org/webt/yp/wi/_4/ypwi_4ckfmwujmthsq1e0tlfrl8.png"><br><br>  Todas las partes del circuito nos son familiares.  La hora se sincroniza desde el servidor <b>NTP</b> .  Si bien no est√° sincronizado, el nodo <b>NTP Time</b> devuelve 0 y el rel√© de habilitaci√≥n del ventilador est√° desactivado.  Para esto, el elemento superior <b>Y</b> seg√∫n el esquema es el responsable. <br><br>  Una vez que se sincroniza la hora, el encendido / apagado del ventilador est√° determinado por la hora actual y el nivel de humedad.  Tan pronto como el nivel de humedad exceda el <b>70%</b> y el tiempo sea de <b>23:00</b> a <b>06:00</b> , el ventilador se encender√° y no ventilar√° la habitaci√≥n. <br><br>  Por supuesto, es mejor reemplazar las constantes de tiempo y humedad en un proyecto real con los par√°metros almacenados en <b>FLASH</b> y configurados, por ejemplo, de acuerdo con <b>MQTT</b> .  S√≠, y el estado actual del sistema (nivel de humedad, corriente, hora, estado del ventilador) tampoco hace da√±o publicar en la red para controlar el sistema desde un tel√©fono inteligente.  Pero esto ya te dejo espacio para tu imaginaci√≥n. <br><br><h3>  Conclusi√≥n </h3><br>  As√≠ que presentamos nuestro controlador con tiempo real m√°s cerca. <br><br>  <i>Quiero agradecer a todos los que me enviaron cartas de cr√≠tica constructiva y consejos sobre actualizaciones de software.</i>  <i><b>Gracias chicos!</b></i> <br><br>  Como de costumbre, la cr√≠tica constructiva es bienvenida.  Adem√°s, los comentarios y sugerencias son bienvenidos. <br><br>  Puede enviar todas las cr√≠ticas, comentarios, sugerencias como de costumbre en un comentario o por correo electr√≥nico: <b>shiotiny@yandex.ru</b> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/467545/">https://habr.com/ru/post/467545/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../467529/index.html">CQM es una mirada diferente en el aprendizaje profundo para optimizar las b√∫squedas en lenguaje natural</a></li>
<li><a href="../467531/index.html">M√°quina de estado reactivo</a></li>
<li><a href="../467533/index.html">Escuchar ruido informativo: m√∫sica y videos que nadie deber√≠a haber encontrado</a></li>
<li><a href="../467539/index.html">Foro CA / B votado contra acortar certificados SSL a 397 d√≠as</a></li>
<li><a href="../467543/index.html">Ssh-chat, parte 2</a></li>
<li><a href="../467547/index.html">Omitir bloqueos ILV con DNSTap y BGP</a></li>
<li><a href="../467549/index.html">SpaceX planea implementar una red de Internet satelital antes de lo planeado</a></li>
<li><a href="../467551/index.html">Frontend Weekly Digest (9-15 de septiembre de 2019)</a></li>
<li><a href="../467555/index.html">¬øQu√© tan bien conoces CSS? (+ mini-prueba)</a></li>
<li><a href="../467557/index.html">El resumen de materiales frescos del mundo del front-end para la √∫ltima semana No. 380 (8 al 15 de septiembre de 2019)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>