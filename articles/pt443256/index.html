<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëèüèø üç∏ üèº PowerShell, despejo da minha experi√™ncia üë©üèº‚Äçüî¨ üö∂üèæ üè™</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="1. Introdu√ß√£o 


 Este artigo √© direcionado √†queles que j√° se familiarizaram com os conceitos b√°sicos do PowerShell, executam alguns scripts com stack...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PowerShell, despejo da minha experi√™ncia</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/443256/"><h2 id="vvedenie">  1. Introdu√ß√£o </h2><br><p>  Este artigo √© direcionado √†queles que j√° se familiarizaram com os conceitos b√°sicos do PowerShell, executam alguns scripts com stackexchange e provavelmente possuem seu pr√≥prio arquivo de texto com v√°rios trechos para facilitar o trabalho di√°rio.  O objetivo de redigir √© reduzir a entropia, aumentar a legibilidade e a capacidade de manuten√ß√£o do c√≥digo do PowerShell usado em sua empresa e, como resultado, aumentar a produtividade do administrador que trabalha com ela. </p><br><p><img src="https://habrastorage.org/webt/go/9u/yw/go9uywfoytxpgrxmggcvf2bfi8e.png" alt="kdpv"></p><br><p>  No meu local de trabalho anterior, devido √†s especificidades das tarefas e √† imperfei√ß√£o do mundo, desenvolvi bastante a habilidade de trabalhar com o PowerShell.  Ap√≥s uma mudan√ßa de trabalho, cargas desse tipo diminu√≠ram drasticamente e tudo o que estava ao redor do canto dos dedos come√ßou a afundar cada vez mais com a experi√™ncia de resolver novos problemas com as novas tecnologias.  A partir disso, este artigo afirma ser apenas o que se declara, revelando uma lista de t√≥picos que, na minha opini√£o, seriam √∫teis para mim cerca de 7 anos atr√°s, quando meu conhecimento dessa ferramenta estava apenas come√ßando. </p><a name="habracut"></a><br><p>  Se voc√™ n√£o entende por que o PowerShell √© um shell orientado a objetos, que tipo de b√¥nus vem e por que √© necess√°rio, aconselhamo-lo, apesar dos inimigos, um bom livro que introduz rapidamente a ess√™ncia desse ambiente - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Andrey Vladimirovich Popov, Introdu√ß√£o ao Windows PowerShell</a> .  Sim, √© sobre a vers√£o antiga do PS, sim, a linguagem ganhou algumas extens√µes e melhorias, mas este livro √© bom porque, ao descrever o est√°gio inicial de desenvolvimento desse ambiente, enfatiza, sem querer, apenas coisas fundamentais.  Acho que o a√ß√∫car sint√°tico com o qual o ambiente cresceu demais, voc√™ percebe rapidamente, sem entender como o conceito funciona.  A leitura deste livro levar√° apenas algumas noites e volte depois da leitura. </p><br><p><img src="https://habrastorage.org/webt/g9/ea/h9/g9eah9nfoao7gukeochjqasi2ne.jpeg" alt="popov"></p><br><p>  O livro tamb√©m est√° dispon√≠vel no site do autor, embora n√£o tenha certeza de qu√£o licenciado √© esse uso: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://andpop.ru/courses/winscript/books/posh_popov.pdf</a> </p><br><h2 id="stayl-gaydy">  Guias de estilo </h2><br><p>  Projetar scripts de acordo com os guias de estilo √© uma boa pr√°tica em todos os casos de sua aplica√ß√£o; dificilmente pode haver duas opini√µes.  Alguns ecossistemas cuidaram disso no n√≠vel do ajuste nativo, o pep8 na comunidade Python e o fmt em Golang chega ao √≥bvio.  Essas s√£o ferramentas valiosas de economia de tempo que, infelizmente, est√£o ausentes no pacote padr√£o do PowerShell e, portanto, transferem o problema para nossa cabe√ßa.  Atualmente, a √∫nica maneira de resolver o problema da formata√ß√£o uniforme de c√≥digo √© desenvolver reflexos escrevendo repetidamente o c√≥digo que satisfaz os guias de estilo (na verdade, n√£o). </p><br><p>  Os guias de estilo devido √† falta de oficialmente aprovados e descritos em detalhes pela Microsoft nasceram na comunidade durante o PowerShell v3 e, desde ent√£o, v√™m sendo desenvolvidos de forma aberta no github: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PowerShellPracticeAndStyle</a> .  Este √© um reposit√≥rio digno de nota para quem j√° usou o bot√£o "Salvar" no PowerShell ise. </p><br><p>  Se voc√™ tentar fazer um aperto, ele provavelmente se resumir√° aos seguintes pontos: </p><br><ul><li>  O PowerShell usa o PascalCase para nomear vari√°veis, cmdlets, nomes de m√≥dulos e praticamente tudo, exceto operadores; </li><li> Operadores de idioma como <code>if</code> , <code>switch</code> , <code>break</code> , <code>process</code> , <code>-match</code> s√£o escritos em letras muito pequenas; </li><li>  Os colchetes s√£o colocados da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">√∫nica maneira verdadeira</a> , tamb√©m chamada de estilo de Kernigan e Richie, levando sua hist√≥ria do livro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">The C Programming Language</a> ; </li><li>  N√£o use aliases em nenhum lugar que n√£o seja uma sess√£o do console interativo, n√£o escreva nenhum <code>ps | ? processname -eq firefox | %{$ws=0}{$ws+=$_.workingset}{$ws/1MB}</code> arquivo de script <code>ps | ? processname -eq firefox | %{$ws=0}{$ws+=$_.workingset}{$ws/1MB}</code> <code>ps | ? processname -eq firefox | %{$ws=0}{$ws+=$_.workingset}{$ws/1MB}</code>  <code>ps | ? processname -eq firefox | %{$ws=0}{$ws+=$_.workingset}{$ws/1MB}</code> ; </li><li>  Indique nomes expl√≠citos de par√¢metros, o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">comportamento dos cmdlets e suas assinaturas podem mudar</a> , al√©m de adicionar um contexto a uma pessoa n√£o familiarizada com um cmdlet espec√≠fico; </li><li>  Projete os par√¢metros para chamar scripts e n√£o escreva uma fun√ß√£o dentro do script e a √∫ltima linha chama essa fun√ß√£o com a necessidade de alterar os valores das vari√°veis ‚Äã‚Äãglobais em vez de especificar par√¢metros; </li><li>  Especifique [CmdletBinding ()] - isso dar√° ao seu cmdlet <code>-Verbose</code> e <code>-Debug</code> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">muitos outros recursos √∫teis</a> .  Apesar da posi√ß√£o firme de alguns puristas na comunidade, n√£o sou favor√°vel a indicar esse atributo em fun√ß√µes e filtros inline simples que consistem em v√°rias linhas literais; </li><li>  Escreva uma ajuda baseada em coment√°rios: uma frase, link de ticket, exemplo de chamada; </li><li>  Especifique a vers√£o necess√°ria do PowerShell na se√ß√£o <code>#requires</code> ; </li><li>  Use <code>Set-StrictMode -Version Latest</code> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">isso ajudar√° a evitar os problemas descritos abaixo</a> ; </li><li>  Lidar com erros; </li><li>  N√£o se apresse em reescrever tudo no PowerShell.  O PowerShell √© principalmente um shell e chamar bin√°rios √© sua tarefa direta.  N√£o h√° nada errado em usar robocopy em um script, √© claro que n√£o √© rsync, mas tamb√©m √© muito bom. </li></ul><br><h2 id="comment-based-help">  Ajuda baseada em coment√°rios </h2><br><p>  Abaixo est√° um exemplo de como obter o script de ajuda.  O script enquadra a imagem, trazendo-a para um quadrado e redimensionando, acho que voc√™ tem a tarefa de criar avatares para os usu√°rios (exceto, talvez, a rota√ß√£o de acordo com os dados exif).  H√° um exemplo de uso na se√ß√£o <code>.EXAMPLE</code> , tente.  Devido ao fato de o PowerShell ser executado pelo Common Language Runtime, o mesmo que outros idiomas dotnet, ele tem a capacidade de usar todo o poder das bibliotecas dotnet: </p><br><pre> <code class="plaintext hljs">&lt;# .SYNOPSIS Resize-Image resizes an image file .DESCRIPTION This function uses the native .NET API to crop a square and resize an image file .PARAMETER InputFile Specify the path to the image .PARAMETER OutputFile Specify the path to the resized image .PARAMETER SquareHeight Define the size of the side of the square of the cropped image. .PARAMETER Quality Jpeg compression ratio .EXAMPLE Resize the image to a specific size: .\Resize-Image.ps1 -InputFile "C:\userpic.jpg" -OutputFile "C:\userpic-400.jpg"-SquareHeight 400 #&gt; # requires -version 3 [CmdletBinding()] Param( [Parameter( Mandatory )] [string]$InputFile, [Parameter( Mandatory )] [string]$OutputFile, [Parameter( Mandatory )] [int32]$SquareHeight, [ValidateRange( 1, 100 )] [int]$Quality = 85 ) # Add System.Drawing assembly Add-Type -AssemblyName System.Drawing # Open image file $Image = [System.Drawing.Image]::FromFile( $InputFile ) # Calculate the offset for centering the image $SquareSide = if ( $Image.Height -lt $Image.Width ) { $Image.Height $Offset = 0 } else { $Image.Width $Offset = ( $Image.Height - $Image.Width ) / 2 } # Create empty square canvas for the new image $SquareImage = New-Object System.Drawing.Bitmap( $SquareSide, $SquareSide ) $SquareImage.SetResolution( $Image.HorizontalResolution, $Image.VerticalResolution ) # Draw new image on the empty canvas $Canvas = [System.Drawing.Graphics]::FromImage( $SquareImage ) $Canvas.DrawImage( $Image, 0, -$Offset ) # Resize image $ResultImage = New-Object System.Drawing.Bitmap( $SquareHeight, $SquareHeight ) $Canvas = [System.Drawing.Graphics]::FromImage( $ResultImage ) $Canvas.DrawImage( $SquareImage, 0, 0, $SquareHeight, $SquareHeight ) $ImageCodecInfo = [System.Drawing.Imaging.ImageCodecInfo]::GetImageEncoders() | Where-Object MimeType -eq 'image/jpeg' # https://msdn.microsoft.com/ru-ru/library/hwkztaft(v=vs.110).aspx $EncoderQuality = [System.Drawing.Imaging.Encoder]::Quality $EncoderParameters = New-Object System.Drawing.Imaging.EncoderParameters( 1 ) $EncoderParameters.Param[0] = New-Object System.Drawing.Imaging.EncoderParameter( $EncoderQuality, $Quality ) # Save the image $ResultImage.Save( $OutputFile, $ImageCodecInfo, $EncoderParameters )</code> </pre> <br><p>  O script acima come√ßa com um coment√°rio de v√°rias linhas <code>&lt;# ... #&gt;</code> ; se esse coment√°rio ocorrer primeiro e contiver determinadas palavras-chave, o PowerShell criar√° automaticamente ajuda para o script.  Esse tipo de ajuda √© literalmente chamado - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ajuda com base no coment√°rio</a> : </p><br><p><img src="https://habrastorage.org/webt/9y/tw/d3/9ytwd3hlr6yb5nsobqqor_bjshw.png" alt="ajuda"></p><br><p>  Al√©m disso, quando o script √© chamado, as dicas de ferramenta para os par√¢metros funcionar√£o, seja no console do PowerShell ou no editor de c√≥digo: </p><br><p><img src="https://habrastorage.org/webt/tr/ha/qg/trhaqga49fwvjphbl6i_cporowa.png" alt="ajuda em linha"></p><br><p>  Mais uma vez, chamo a aten√ß√£o para o fato de que ela n√£o deve ser negligenciada.  Se voc√™ n√£o sabe o que escrever l√°, escreva alguma coisa, v√° para o refrigerador e, ao retornar, voc√™ definitivamente entender√° o que precisa ser alterado na escrita.  Isso funciona.  N√£o vale a pena fanaticamente preencher todas as palavras-chave, o PowerShell foi projetado para ser auto-documentado e, se voc√™ deu nomes significativos e completos aos par√¢metros, uma breve frase na se√ß√£o <code>.SYNOPIS</code> e um exemplo s√£o suficientes. </p><br><h2 id="strict-mode">  Modo estrito </h2><br><p>  O PowerShell, como muitas outras linguagens de script, possui digita√ß√£o din√¢mica.  Esse tipo de digita√ß√£o tem muitos apoiadores: escrever uma l√≥gica de alto n√≠vel simples, por√©m poderosa, √© quest√£o de alguns minutos, mas quando sua decis√£o come√ßa a chegar a mil linhas, voc√™ certamente encontrar√° a fragilidade dessa abordagem. </p><br><p>  A sa√≠da autom√°tica de tipos invariavelmente no est√°gio de teste, que formava uma matriz no local em que voc√™ sempre recebe um conjunto de elementos, definitivamente colocar√° um porco no caso de voc√™ obter um elemento e na seguinte condi√ß√£o, em vez de verificar o n√∫mero de elementos, o n√∫mero de caracteres ou outro atributo, dependendo de tipo de item.  A l√≥gica do script ser√° interrompida e o tempo de execu√ß√£o fingir√° que est√° tudo bem. </p><br><p>  Definir o modo estrito ajuda a evitar alguns desses tipos de problemas, mas tamb√©m requer um pouco mais de seu c√≥digo, como inicializar vari√°veis ‚Äã‚Äãe converter explicitamente. </p><br><p>  Esse modo √© ativado pelo cmdlet <code>Set-StrictMode -Version Latest</code> , embora existam outras op√ß√µes para "rigor", minha escolha √© usar o √∫ltimo. </p><br><p>  No exemplo abaixo, o modo estrito captura uma chamada para uma propriedade inexistente.  Como existe apenas um elemento dentro da pasta, o tipo da vari√°vel <code>$Input</code> como resultado da execu√ß√£o ser√° <code>FileInfo</code> , e n√£o a matriz esperada dos elementos correspondentes: </p><br><p><img src="https://habrastorage.org/webt/fk/q-/jk/fkq-jkrdldogwcwyiwkwspskseq.png" alt="estrito"></p><br><p>  Para evitar esse problema, voc√™ deve converter explicitamente o resultado do cmdlet em uma matriz: </p><br><pre> <code class="plaintext hljs">$Items = @( Get-ChildItem C:\Users\snd3r\Nextcloud )</code> </pre> <br><p>  Crie uma regra para sempre definir o modo estrito, para evitar resultados inesperados ao executar seus scripts. </p><br><h2 id="obrabotka-oshibok">  Tratamento de erros </h2><br><h3 id="erroractionpreference">  ErrorActionPreference </h3><br><p>  Ao examinar os scripts de outras pessoas, por exemplo, em um github, geralmente vejo ignorar completamente o mecanismo de tratamento de erros ou ativar explicitamente o modo de sil√™ncio silencioso em caso de erro.  O problema de manipula√ß√£o de erros certamente n√£o √© o mais f√°cil de programar em geral e em scripts em particular, mas definitivamente n√£o merece ser ignorado.  Por padr√£o, o PowerShell em caso de erro o exibe e continua funcionando (simplifiquei um pouco o conceito, mas abaixo h√° um link para um livro git sobre este t√≥pico).  Isso √© conveniente se voc√™ precisar distribuir com urg√™ncia a atualiza√ß√£o de um programa amplamente usado no dom√≠nio para todas as m√°quinas, sem esperar at√© que ele se espalhe para todos os pontos da implanta√ß√£o do sccm ou se espalhe de outra maneira usada por voc√™.  √â desagrad√°vel interromper e reiniciar o processo se uma das m√°quinas estiver desligada, isso √© verdade. </p><br><p>  Por outro lado, se voc√™ fizer um backup complexo de um sistema que consiste em mais de um arquivo de dados de mais de uma parte do sistema de informa√ß√µes, voc√™ precisa ter certeza de que seu backup √© consistente e que todos os conjuntos de dados necess√°rios foram copiados sem erros. </p><br><p>  Para alterar o comportamento dos cmdlets no caso de um erro, existe uma vari√°vel global <code>$ErrorActionPreference</code> , com a seguinte lista de valores poss√≠veis: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parar, Consultar, Continuar, Suspender, Continuar silenciosamente</a> . </p><br><p>  Eu recomendo que voc√™ sempre use o valor <code>Stop</code> quando o n√∫mero de scripts ou sua complexidade deixar de ser armazenado na pilha em sua cabe√ßa, √© melhor garantir que, em qualquer situa√ß√£o imprevista, o script interrompa seu trabalho e n√£o quebre a lenha "silenciosamente", concluindo a execu√ß√£o "com √™xito". </p><br><p>  Al√©m de interromper o script, caso algo d√™ errado, h√° outro pr√©-requisito para seu uso - lidar com situa√ß√µes excepcionais.  Existe uma constru√ß√£o <code>try/catch</code> para isso, mas s√≥ funciona se o erro fizer com que a execu√ß√£o seja interrompida.  N√£o necessariamente a parada deve ser ativada no n√≠vel de todo o script, <code>ErrorAction</code> pode ser definido no n√≠vel do cmdlet pelo par√¢metro: </p><br><pre> <code class="plaintext hljs">Get-ChildItem 'C:\System Volume Information\' -ErrorAction 'Stop'</code> </pre> <br><p>  Na verdade, essa possibilidade define duas estrat√©gias l√≥gicas: resolva todos os erros "por padr√£o" e defina <code>ErrorAction</code> apenas para locais cr√≠ticos onde lidar com eles;  habilite no n√≠vel de todo o script definindo o valor da vari√°vel global e definindo <code>-ErrorAction 'Continue'</code> em opera√ß√µes n√£o cr√≠ticas.  Eu sempre escolho a segunda op√ß√£o, n√£o tenho pressa de impor a voc√™, recomendo apenas uma vez para entender esse problema e usar essa ferramenta √∫til. </p><br><h3 id="trycatch">  tentar / pegar </h3><br><p>  No manipulador de erros, voc√™ pode corresponder pelo tipo de exce√ß√£o e operar com um encadeamento de execu√ß√£o ou, por exemplo, adicionar um pouco mais de informa√ß√£o.  Apesar de usar os operadores <code>try/catch/throw/trap</code> , voc√™ pode construir todo o fluxo de execu√ß√£o de script, evite isso categoricamente, pois esse m√©todo de opera√ß√£o com execu√ß√£o n√£o √© considerado apenas um antipater extremo da categoria "goto-noodle", portanto tamb√©m drena o desempenho drasticamente. </p><br><pre> <code class="plaintext hljs">#requires -version 3 $ErrorActionPreference = 'Stop' #   ,    , #          $Logger = Get-Logger "$PSScriptRoot\Log.txt" #    trap { $Logger.AddErrorRecord( $_ ) exit 1 } #    $count = 1; while ( $true ) { try { #   $StorageServers = @( Get-ADGroupMember -Identity StorageServers | Select-Object -Expand Name ) } catch [System.Management.Automation.CommandNotFoundException] { #      ,         throw " Get-ADGroupMember ,    Active Directory module for PowerShell; $( $_.Exception.Message )" } catch [System.TimeoutException] { #             if ( $count -le 3 ) { $count++; Start-Sleep -S 10; continue } #             throw "     -   ,   $count ; $( $_.Exception.Message )" } #         break }</code> </pre> <br><p>  Vale ressaltar que o operador de <code>trap</code> √© uma intercepta√ß√£o de erro global.  Ele captura tudo o que n√£o foi processado em n√≠veis mais baixos ou √© descartado do manipulador de exce√ß√µes devido √† impossibilidade de corrigir a situa√ß√£o independentemente. </p><br><p>  Al√©m da abordagem orientada a objeto das exce√ß√µes descritas acima, o PowerShell tamb√©m fornece conceitos mais familiares compat√≠veis com outros shells "cl√°ssicos", como fluxos de erros, c√≥digos de retorno e vari√°veis ‚Äã‚Äãde acumula√ß√£o de erros.  Tudo isso √© certamente conveniente, √†s vezes sem alternativa, mas vai al√©m do escopo deste t√≥pico geral da vis√£o geral.  Felizmente, h√° um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">bom livro aberto no github</a> sobre esse assunto. </p><br><p>  O c√≥digo do criador de logs que eu uso quando n√£o h√° certeza de que o sistema ter√° o PowerShell 5 (onde voc√™ pode descrever a classe do criador de logs de maneira mais conveniente), experimente, pode ser √∫til devido √† sua simplicidade e brevidade, voc√™ certamente adicionar√° m√©todos adicionais sem dificuldade. : </p><br><pre> <code class="plaintext hljs">#   " ",   PowerShell v3 function Get-Logger { [CmdletBinding()] param ( [Parameter( Mandatory = $true )] [string] $LogPath, [string] $TimeFormat = 'yyyy-MM-dd HH:mm:ss' ) $LogsDir = [System.IO.Path]::GetDirectoryName( $LogPath ) New-Item $LogsDir -ItemType Directory -Force | Out-Null New-Item $LogPath -ItemType File -Force | Out-Null $Logger = [PSCustomObject]@{ LogPath = $LogPath TimeFormat = $TimeFormat } Add-Member -InputObject $Logger -MemberType ScriptMethod AddErrorRecord -Value { param( [Parameter( Mandatory = $true )] [string]$String ) "$( Get-Date -Format 'yyyy-MM-dd HH:mm:ss' ) [Error] $String" | Out-File $this.LogPath -Append } return $Logger }</code> </pre> <br><p>  Repito a ideia - n√£o ignore o tratamento de erros.  Isso economizar√° tempo e nervos a longo prazo. <br>  N√£o pense que a execu√ß√£o do script n√£o importa o que seja bom.  Bom - √© hora de cair sem quebrar a lenha. </p><br><h2 id="instrumenty">  As ferramentas </h2><br><p>  Vale a pena come√ßar a melhorar as ferramentas para trabalhar com o PowerShell a partir do emulador de console.  Ouvi muitas vezes de apoiadores de vespas alternativas que o console do Windows √© ruim e que esse n√£o √© um console, mas dos e assim por diante.  Poucos poderiam formular adequadamente suas reivindica√ß√µes sobre esse assunto, mas se algu√©m conseguisse, na realidade, todos os problemas poderiam ser resolvidos.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">J√°</a> havia mais informa√ß√µes sobre os terminais e o novo console no Windows no hub; <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tudo est√° mais do que ok por l√°</a> . </p><br><p>  O primeiro passo √© instalar o Conemu ou seu assembly Cmder, o que n√£o √© particularmente importante, pois, na minha opini√£o, vale a pena percorrer as configura√ß√µes de qualquer maneira.  Normalmente escolho o cmder na configura√ß√£o m√≠nima, sem um gita e outros bin√°rios, os quais me propus, embora por v√°rios anos tenha sintonizado minha configura√ß√£o para o Conemu puro.  Este √© realmente o melhor emulador de terminal para Windows, permitindo que voc√™ divida a tela (para os amantes do tmux / screen), crie abas e ative o modo de console no estilo quake: </p><br><h3 id="conemu">  Conemu </h3><br><p><img src="https://habrastorage.org/webt/ag/2w/hy/ag2whyp2okkhyroygpuzjkdamis.png" alt="cmder"></p><br><p>  A pr√≥xima etapa eu recomendo colocar os m√≥dulos: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">oh-my-posh</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">posh-git</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PSReadLine</a> .  Os dois primeiros tornar√£o o baile mais agrad√°vel, adicionando informa√ß√µes sobre a sess√£o atual, o status do √∫ltimo comando executado, o indicador de privil√©gio e o status do reposit√≥rio git no local atual.  O PSReadLine aumenta bastante o prompt, adicionando, por exemplo, uma pesquisa no hist√≥rico de comandos inseridos (CRTL + R) e dicas convenientes para cmdlets no CRTL + Space: </p><br><p><img src="https://habrastorage.org/webt/eg/w6/f2/egw6f2sa43hgi3dhwn_hhgxbesa.gif" alt="readline"></p><br><p>  E sim, agora o console pode ser limpo com CTRL + L e esquecer os <code>cls</code> . </p><br><h3 id="visual-studio-code">  C√≥digo do Visual Studio </h3><br><p>  O editor.  O pior que posso dizer sobre o PowerShell √© puramente o PowerShell ISE; √© improv√°vel que aqueles que viram a primeira vers√£o com tr√™s pain√©is esque√ßam essa experi√™ncia.  A codifica√ß√£o diferente do terminal, a falta de recursos b√°sicos do editor, como recuo autom√°tico, colchetes de fechamento autom√°tico, formata√ß√£o de c√≥digo e todo um conjunto de antipadr√µes gerados por ele sobre os quais n√£o vou contar (apenas no caso) - isso √© tudo sobre o ISE. </p><br><p>  N√£o use, use o Visual Studio Code com a extens√£o do PowerShell - h√° tudo o que voc√™ n√£o gostaria (dentro de limites razo√°veis, √© claro).  E n√£o esque√ßa que no PoweShell at√© a sexta vers√£o (PowerShell Core 6.0) a codifica√ß√£o para scripts √© UTF8 BOM, caso contr√°rio, o idioma russo ser√° interrompido. </p><br><p><img src="https://habrastorage.org/webt/dd/c0/pa/ddc0paj-xbx5tysllsrmzlxnugi.png" alt="vscode"></p><br><p>  Al√©m do realce da sintaxe, dicas de ferramentas e recursos de depura√ß√£o de scripts, o plug-in instala um linter que tamb√©m o ajudar√° a seguir as pr√°ticas estabelecidas na comunidade, por exemplo, expandindo atalhos com um clique (na l√¢mpada).  Na verdade, este √© um m√≥dulo regular que pode ser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">instalado</a> independentemente, por exemplo, adicione-o aos scripts de assinatura de pipeline: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PSScriptAnalyzer</a> </p><br><p><img src="https://habrastorage.org/webt/mj/x7/ov/mjx7ovrtephqcdctuiptdu_tff4.png" alt="PSScriptAnalyzer"></p><br><p>  Voc√™ pode definir os par√¢metros de formata√ß√£o do c√≥digo nas configura√ß√µes de extens√£o. Para todas as configura√ß√µes (tanto o editor quanto as extens√µes), h√° uma pesquisa: <code>File - Preferences - Settings</code> : </p><br><p><img src="https://habrastorage.org/webt/ia/xr/km/iaxrkmgjcpcf4wck1ocb7kfp9ym.png" alt="Otbs"></p><br><p>  Para obter um novo console conpty, voc√™ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">deve definir o sinalizador nas configura√ß√µes</a> ; mais tarde, provavelmente, este conselho ser√° irrelevante. </p><br><p>  Vale lembrar que qualquer a√ß√£o no VS Code pode ser executada no centro de controle, chamado por CTRL + Shift + P. Formate <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um</a> trecho de c√≥digo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">inserido no bate-papo</a> , classifique alfabeticamente, altere o recuo de espa√ßos para guias e assim por diante, tudo no centro de controle. </p><br><p>  Por exemplo, ative a tela cheia e centralize o editor: </p><br><p><img src="https://habrastorage.org/webt/3z/w9/-a/3zw9-avzniwjgooxfa1dvzi9kfc.png" alt="disposi√ß√£o"></p><br><h3 id="source-control-git-svn">  Controle de origem  Git, SVN </h3><br><p>  Freq√ºentemente, os administradores de sistema do Windows t√™m uma fobia de resolu√ß√£o de conflitos nos sistemas de controle de vers√£o, provavelmente porque se um representante desse conjunto usa o git, geralmente n√£o h√° problemas desse tipo.  Com o vscode, a resolu√ß√£o de conflitos √© reduzida a literalmente cliques do mouse nas partes do c√≥digo que precisam ser deixadas ou substitu√≠das. </p><br><p><img src="https://habrastorage.org/webt/ft/fd/8f/ftfd8f1ylxofsckzu6v1uujok1e.png" alt="fundir"></p><br><p>  Esses r√≥tulos entre as linhas 303 e 304 s√£o clic√°veis. Vale a pena clicar em todos os que aparecem no documento em caso de conflito, confirmar a confirma√ß√£o e enviar as altera√ß√µes ao servidor.  U - Conveni√™ncia. </p><br><p>  Sobre como trabalhar com sistemas de controle de vers√£o est√° dispon√≠vel e, com as imagens <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">gravadas na esta√ß√£o de codifica√ß√£o vscode</a> , passe por cima de seus olhos brevemente e bem. </p><br><h3 id="snippets">  Snippets </h3><br><p>  <a href="">Snippets</a> s√£o um tipo de macro / modelo que permite acelerar a escrita de c√≥digo.  Definitivamente imperd√≠vel. </p><br><p>  Cria√ß√£o r√°pida de objetos: </p><br><p><img src="https://habrastorage.org/webt/yi/wp/om/yiwpomlohxird5oovnutj4hc7ec.gif" alt="objeto personalizado"></p><br><p>  Procure ajuda com base em coment√°rios: </p><br><p><img src="https://habrastorage.org/webt/ol/jn/37/oljn37jxzabxa9h4yqquuh98s9i.gif" alt="ajuda"></p><br><p>  Se o cmdlet precisar passar um grande n√∫mero de par√¢metros, faz sentido <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">usar splatting</a> . <br>  Aqui est√° um trecho para ele: </p><br><p><img src="https://habrastorage.org/webt/lx/y_/ek/lxy_ekyxsjsuiad66yzqqfoxzta.gif" alt="splatting"></p><br><p>  Veja todos os trechos dispon√≠veis dispon√≠veis por Ctrl + Alt + J: </p><br><p><img src="https://habrastorage.org/webt/0p/jm/k_/0pjmk_nms2ejlugtcsxvp1vjhea.gif" alt="trechos"></p><br><p>  Se depois disso voc√™ desejou continuar melhorando o ambiente, mas ainda n√£o tinha ouvido falar em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">folhas de vespa, aqui est√° voc√™</a> .  Al√©m disso, se voc√™ tiver seu pr√≥prio conjunto de extens√µes √∫teis ao escrever scripts do PowerShell, ficarei feliz em ver a lista deles nos coment√°rios. </p><br><h2 id="proizvoditelnost">  Desempenho </h2><br><p>  O t√≥pico desempenho n√£o √© t√£o simples quanto parece √† primeira vista.  Por um lado, otimiza√ß√µes prematuras podem reduzir bastante a legibilidade e a manuten√ß√£o do c√≥digo, economizando 300ms de tempo de execu√ß√£o de script, cujo tempo de execu√ß√£o usual pode ser de dez minutos, e seu uso nesse caso √© definitivamente destrutivo.  Por outro lado, existem v√°rios truques bastante simples que aumentam a legibilidade do c√≥digo e sua velocidade, que s√£o bastante apropriados para uso cont√≠nuo.  A seguir, falarei sobre alguns deles, se o desempenho √© tudo para voc√™ e a legibilidade diminui devido √†s r√≠gidas limita√ß√µes de tempo de inatividade do servi√ßo durante a manuten√ß√£o, recomendo consultar a literatura <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">especializada</a> . </p><br><h3 id="pipeline-i-foreach">  Pipeline e foreach </h3><br><p>  A maneira mais f√°cil e sempre funcional de aumentar a produtividade √© evitar o uso de tubos.  Devido √† seguran√ßa e conveni√™ncia do tipo por quest√£o de energia, a passagem dos elementos do PowerShell por um tubo envolve cada um deles em um objeto.  Nas linguagens dotnet, esse comportamento <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">√© chamado de boxe</a> .  O boxe √© bom, garante seguran√ßa, mas tem seu pr√≥prio pre√ßo, que √†s vezes n√£o faz sentido pagar. </p><br><p>  A primeira etapa √© aumentar o desempenho e, na minha opini√£o, melhorar a legibilidade removendo todos os aplicativos do <code>Foreach-Object</code> e substituindo-o pela instru√ß√£o foreach.  Voc√™ pode ficar constrangido pelo fato de que na verdade s√£o duas entidades diferentes, porque <code>foreach</code> √© um alias para <code>Foreach-Object</code> - na pr√°tica, a principal diferen√ßa √© que o <code>foreach</code> n√£o aceita valores de um pipeline, mas funciona por experi√™ncia at√© tr√™s vezes mais r√°pido. </p><br><p>  :        -  , ,          : </p><br><pre> <code class="plaintext hljs">Get-Content D:\temp\SomeHeavy.log | Select-String '328117'</code> </pre> <br><p>        ‚Äî       ,      .         ‚Äî ,        ,    <code>Get-Content</code> .                  <code>string</code>  ,    ,            .    ‚Äî      ,         : </p><br><blockquote> When reading from and writing to binary files, use the AsByteStream parameter and a value of 0 for the ReadCount parameter. A ReadCount value of 0 reads the entire file in a single read operation. The default ReadCount value, 1, reads one byte in each read operation and converts each byte into a separate object, which causes errors when you use the Set-Content cmdlet to write the bytes to a file unless you use AsByteStream <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-content</a> </blockquote><br><pre> <code class="plaintext hljs">Get-Content D:\temp\SomeHeavy.log -ReadCount 0 | Select-String '328117'</code> </pre> <br><p>                : </p><br><p><img src="https://habrastorage.org/webt/t2/bg/hw/t2bghwyeop1gofgu_tapyqimp3o.png" alt="readcount"></p><br><p>        ,          .    <code>Select-String</code>          ‚Äî       .                ,          <code>Select-String</code> .      ,      <code>Select-String</code>       ,        ,             : </p><br><pre> <code class="plaintext hljs">foreach ( $line in ( Get-Content D:\temp\SomeHeavy.log -ReadCount 0 )) { if ( $line -match '328117' ) { $line } }</code> </pre> <br><p>        30 , -   30%,           ,         ,        , - ,   (     ;-).      ,     .         ,    <code>-match</code> ;   ‚Äî     .                ,      ‚Äî               ‚Äî   -   ,    . </p><br><p>   ‚Äî -   ,   " "              : </p><br><pre> <code class="plaintext hljs">foreach ( $line in ( Get-Content D:\temp\SomeHeavy.log -ReadCount 0 )) { if ( $line -match '328117' ) { "$( Get-Date -UFormat '%d.%m.%Y %H:%M:%S') $line" | Out-File D:\temp\Result.log -Append } }</code> </pre> <br><p>     <code>Measure-Command</code> : </p><br><pre> <code class="plaintext hljs">Hours : 2 Minutes : 20 Seconds : 9 Milliseconds : 101</code> </pre> <br><p>   .   ,           ,          ,      .    ,    PowerShell           ,    ,       ‚Äî        .         ,    ,            ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">StringBuilder</a> .                 ,            ,           .          ,                     . </p><br><pre> <code class="plaintext hljs">$StringBuilder = New-Object System.Text.StringBuilder foreach ( $line in ( Get-Content D:\temp\SomeHeavy.log -ReadCount 0 )) { if ( $line -match '328117' ) { $null = $StringBuilder.AppendLine( "$( Get-Date -UFormat '%d.%m.%Y %H:%M:%S') $line" ) } } Out-File -InputObject $StringBuilder.ToString() -FilePath D:\temp\Result.log -Append -Encoding UTF8</code> </pre> <br><p>      5 ,      : </p><br><pre> <code class="plaintext hljs">Hours : 0 Minutes : 5 Seconds : 37 Milliseconds : 150</code> </pre> <br><p>    <code>Out-File -InputObject</code> ,    ,       .          ‚Äî        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">   </a>    .              ‚Äî  <code>Get-Help</code>     <code>-Full</code> ,         <code>Accept pipeline input? true (ByValue)</code> : </p><br><pre> <code class="plaintext hljs">-InputObject &lt;psobject&gt; Required? false Position? Named Accept pipeline input? true (ByValue) Parameter set name (All) Aliases None Dynamic? false</code> </pre> <br><p>    PowerShell     : </p><br><p><img src="https://habrastorage.org/webt/8d/zl/r-/8dzlr-yjpt13avpi_wjibzdpnxs.png" alt="taskmgr"></p><br><p>    <code>StringBuilder</code>                           : </p><br><p><img src="https://habrastorage.org/webt/lc/4j/1c/lc4j1c3-um9jozjohlauurwzo3a.png" alt="aloca√ß√£o de construtor de string"></p><br><p>    ,    ,  3  3.        dotnet-      ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">StreamReader</a> . </p><br><pre> <code class="plaintext hljs">$StringBuilder = New-Object System.Text.StringBuilder $StreamReader = New-Object System.IO.StreamReader 'D:\temp\SomeHeavy.log' while ( $line = $StreamReader.ReadLine()) { if ( $line -match '328117' ) { $null = $StringBuilder.AppendLine( "$( Get-Date -UFormat '%d.%m.%Y %H:%M:%S') $line" ) } } $StreamReader.Dispose() Out-File -InputObject $StringBuilder.ToString() -FilePath C:\temp\Result.log -Append -Encoding UTF8</code> </pre> <br><pre> <code class="plaintext hljs">Hours : 0 Minutes : 5 Seconds : 33 Milliseconds : 657</code> </pre> <br><p>      ,       .               ,     ,       ,    ,          2.        ,          : </p><br><p><img src="https://habrastorage.org/webt/wr/ka/_w/wrka_wcvj1idodxx_37ka8wnhmm.png" alt="leitor de stream"></p><br><p>        ‚Äî      "",   ‚Äî  <code>StringBuilder</code> ‚Äî ""       .   ,      (  100)           .       ‚Äî       90%    (        ,     ): </p><br><pre> <code class="plaintext hljs">$BufferSize = 104857600 $StringBuilder = New-Object System.Text.StringBuilder $BufferSize $StreamReader = New-Object System.IO.StreamReader 'C:\temp\SomeHeavy.log' while ( $line = $StreamReader.ReadLine()) { if ( $line -match '1443' ) { #      if ( $StringBuilder.Length -gt ( $BufferSize - ( $BufferSize * 0.1 ))) { Out-File -InputObject $StringBuilder.ToString() -FilePath C:\temp\Result.log -Append -Encoding UTF8 $StringBuilder.Clear() } $null = $StringBuilder.AppendLine( "$( Get-Date -UFormat '%d.%m.%Y %H:%M:%S') $line" ) } } Out-File -InputObject $StringBuilder.ToString() -FilePath C:\temp\Result.log -Append -Encoding UTF8 $StreamReader.Dispose()</code> </pre> <br><pre> <code class="plaintext hljs">Hours : 0 Minutes : 5 Seconds : 53 Milliseconds : 417</code> </pre> <br><p>     1      : </p><br><p><img src="https://habrastorage.org/webt/rg/ro/f6/rgrof6lxdcrx96urvmxuflcbdbc.png" alt="leitor de fluxo com despejo"></p><br><p>              ,                 .     ,      ,        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">StreamWriter</a> ,   ,   ;-)      ,        ,    . </p><br><p> -     ‚Äî     ,        .    ,     ‚Äî  .  <code>Select-String</code>  <code>Out-File</code>    ,        <code>OutOfMemoryException</code> ,    ‚Äî    . </p><br><h3 id="nativnye-binarniki">   </h3><br><p> ,      PowerShell         ,         ‚Äî ,  : PowerShell ‚Äî          ,     . </p><br><p>  ,       <code>StringBuilder</code>     <code>dir</code> ‚Äî          (  ).          : </p><br><pre> <code class="plaintext hljs">$CurrentPath = ( Get-Location ).Path + '\' $StringBuilder = New-Object System.Text.StringBuilder foreach ( $Line in ( &amp;cmd /c dir /b /s /ad )) { $null = $StringBuilder.AppendLine( $Line.Replace( $CurrentPath, '.' )) } $StringBuilder.ToString()</code> </pre> <br><pre> <code class="plaintext hljs">Hours : 0 Minutes : 0 Seconds : 3 Milliseconds : 9</code> </pre> <br><pre> <code class="plaintext hljs">$StringBuilder = New-Object System.Text.StringBuilder foreach ( $Line in ( Get-ChildItem -File -Recurse | Resolve-Path -Relative )) { $null = $StringBuilder.AppendLine( $Line ) } $StringBuilder.ToString()</code> </pre> <br><pre> <code class="plaintext hljs">Hours : 0 Minutes : 0 Seconds : 16 Milliseconds : 337</code> </pre> <br><p>     $null ‚Äî     .  ,    ‚Äî    <code>Out-Null</code> ;  ,    (   <code>$null</code> )     ,   . </p><br><pre> <code class="plaintext hljs"># : $null = $StringBuilder.AppendLine( $Line ) # : $StringBuilder.AppendLine( $Line ) | Out-Null</code> </pre> <br><p>           ,          ,  .      <code>Compare-Object</code> ,      ,      ,       .            robocopy.exe,      (   PowerShell 5),      : </p><br><pre> <code class="plaintext hljs">class Robocopy { [String]$RobocopyPath Robocopy () { $this.RobocopyPath = Join-Path $env:SystemRoot 'System32\Robocopy.exe' if ( -not ( Test-Path $this.RobocopyPath -PathType Leaf )) { throw '    ' } } [void]CopyFile ( [String]$SourceFile, [String]$DestinationFolder ) { $this.CopyFile( $SourceFile, $DestinationFolder, $false ) } [void]CopyFile ( [String]$SourceFile, [String]$DestinationFolder, [bool]$Archive ) { $FileName = [IO.Path]::GetFileName( $SourceFile ) $FolderName = [IO.Path]::GetDirectoryName( $SourceFile ) $Arguments = @( '/R:0', '/NP', '/NC', '/NS', '/NJH', '/NJS', '/NDL' ) if ( $Archive ) { $Arguments += $( '/A+:a' ) } $ErrorFlag = $false &amp;$this.RobocopyPath $FolderName $DestinationFolder $FileName $Arguments | Foreach-Object { if ( $ErrorFlag ) { $ErrorFlag = $false throw "$_ $ErrorString" } else { if ( $_ -match '(?&lt;=\(0x[\da-f]{8}\))(?&lt;text&gt;(.+$))' ) { $ErrorFlag = $true $ErrorString = $matches.text } else { $Logger.AddRecord( $_.Trim()) } } } if ( $LASTEXITCODE -eq 8 ) { throw 'Some files or directories could not be copied' } if ( $LASTEXITCODE -eq 16 ) { throw 'Robocopy did not copy any files. Check the command line parameters and verify that Robocopy has enough rights to write to the destination folder.' } } [void]SyncFolders ( [String]$SourceFolder, [String]$DestinationFolder ) { $this.SyncFolders( $SourceFolder, $DestinationFolder, '*.*', '', $false ) } [void]SyncFolders ( [String]$SourceFolder, [String]$DestinationFolder, [Bool]$Archive ) { $this.SyncFolders( $SourceFolder, $DestinationFolder, '*.*', '', $Archive ) } [void]SyncFolders ( [String]$SourceFolder, [String]$DestinationFolder, [String]$Include ) { $this.SyncFolders( $SourceFolder, $DestinationFolder, $Include, '', $false ) } [void]SyncFolders ( [String]$SourceFolder, [String]$DestinationFolder, [String]$Include, [Bool]$Archive ) { $this.SyncFolders( $SourceFolder, $DestinationFolder, $Include, '', $Archive ) } [void]SyncFolders ( [String]$SourceFolder, [String]$DestinationFolder, [String]$Include, [String]$Exclude ) { $this.SyncFolders( $SourceFolder, $DestinationFolder, $Include, $Exclude, $false ) } [void]SyncFolders ( [String]$SourceFolder, [String]$DestinationFolder, [String]$Include, [String]$Exclude, [Bool]$Archive ) { $Arguments = @( '/MIR', '/R:0', '/NP', '/NC', '/NS', '/NJH', '/NJS', '/NDL' ) if ( $Exclude ) { $Arguments += $( '/XF' ) $Arguments += $Exclude.Split(' ') } if ( $Archive ) { $Arguments += $( '/A+:a' ) } $ErrorFlag = $false &amp;$this.RobocopyPath $SourceFolder $DestinationFolder $Include $Arguments | Foreach-Object { if ( $ErrorFlag ) { $ErrorFlag = $false throw "$_ $ErrorString" } else { if ( $_ -match '(?&lt;=\(0x[\da-f]{8}\))(?&lt;text&gt;(.+$))' ) { $ErrorFlag = $true $ErrorString = $matches.text } else { $Logger.AddRecord( $_.Trim()) } } } if ( $LASTEXITCODE -eq 8 ) { throw 'Some files or directories could not be copied' } if ( $LASTEXITCODE -eq 16 ) { throw 'Robocopy did not copy any files. Check the command line parameters and verify that Robocopy has enough rights to write to the destination folder.' } } }</code> </pre> <br><p>                ,             (      ),         ‚Äî    . </p><br><p>   ,   :        <code>Foreach-Object</code> !?  ,             :    <code>foreach</code> ,  <code>Foreach-Object</code>          ‚Äî   ,   , ,   ,      .       . </p><br><p>       ,     : </p><br><pre> <code class="plaintext hljs">$Robocopy = New-Object Robocopy #    $Robocopy.CopyFile( $Source, $Dest ) #   $Robocopy.SyncFolders( $SourceDir, $DestDir ) #    .xml     $Robocopy.SyncFolders( $SourceDir, $DestDir , '*.xml', $true ) #     *.zip *.tmp *.log     $Robocopy.SyncFolders( $SourceDir, $DestDir, '*.*', '*.zip *.tmp *.log', $true )</code> </pre> <br><h3 id="poslevkusie">  </h3><br><p>        ‚Äî           ,       ,            ;   ,        ,   ,     : </p><br><ul><li><p>   <code>foreach</code>   <code>Foreach-Object</code>  ; </p><br></li><li><p>   ; </p><br></li><li><p> /  ,   ; </p><br></li><li><p>  <code>StringBuilder</code>    ; </p><br></li><li><p>      ,   - ; </p><br></li><li><p>      ( ""    ); </p><br></li></ul><br><p>     :    -   ,     . </p><br><h2 id="jobs"> Jobs </h2><br><p>  ,     ,        ,    ,      ,        ,     .            .      ,      IO,               . </p><br><div class="spoiler"> <b class="spoiler_title">    ssd</b> <div class="spoiler_text"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √â assim que ocorre a primeira inicializa√ß√£o do Windows Server 2019 rec√©m-instalado no Hyper-V para ssd (foi decidido pela migra√ß√£o da m√°quina virtual para o hdd): </font></font></p><br><p><img src="https://habrastorage.org/webt/mo/eu/jf/moeujfnupkxphhi7uso_hjbzsys.jpeg" alt="2019ssd"></p></div></div><br><p>    PowerShell       ( <code>Get-Command *-Job</code> ),    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a> . </p><br><p>      ,  ,  ,     : </p><br><pre> <code class="plaintext hljs">$Job = Start-Job -ScriptBlock { Write-Output 'Good night' Start-Sleep -S 10 Write-Output 'Good morning' } $Job | Wait-Job | Receive-Job Remove-Job $Job</code> </pre> <br><p>          ,         ‚Äî       ,    .             <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">     </a> . </p><br><p>      ,      : </p><br><p><img src="https://habrastorage.org/webt/gc/um/r-/gcumr-9xsk2fh5c5m7epk1eozqg.png" alt="empregos"><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://xaegr.wordpress.com/2011/07/12/threadping/</a> </p><br><p> ,      ,   ‚Äî     ,                 .  , ,     (50  ‚Äî  50 ): </p><br><p><img src="https://habrastorage.org/webt/3f/pg/xg/3fpgxg51u9augjj9iua05wm6fgi.png" alt="trabalho morre"></p><br><p>           .    ,  ‚Äî            ,        .     ‚Äî           ,    . </p><br><p>   ,           , ,              - . </p><br><h2 id="runspaces"> Runspaces </h2><br><p>                  ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Beginning Use of PowerShell Runspaces: Part 1</a> . ,  ‚Äî    PowerShell        ,        .             (,    PowerShell ),       :      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">       (  )</a>       .        ,            . </p><br><p>          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">WPF </a> ,              PowerShell,     .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a> ‚Äî      ,   .    ‚Äî            ,         "" .     . </p><br><p>       ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">           </a> . </p><br><p><img src="https://habrastorage.org/webt/cx/pp/7v/cxpp7vozkcxdsl_ibdyva0_z3wi.gif" alt="wpf"></p><br><pre> <code class="plaintext hljs">#     $GUISyncHash = [hashtable]::Synchronized(@{}) &lt;# WPF  #&gt; $GUISyncHash.FormXAML = [xml](@" &lt;Window xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" Title="Sample WPF Form" Height="510" Width="410" ResizeMode="NoResize"&gt; &lt;Grid&gt; &lt;Label Content=" " HorizontalAlignment="Left" Margin="10,10,0,0" VerticalAlignment="Top" Height="37" Width="374" FontSize="18"/&gt; &lt;Label Content="" HorizontalAlignment="Left" Margin="16,64,0,0" VerticalAlignment="Top" Height="26" Width="48"/&gt; &lt;TextBox x:Name="BackupPath" HorizontalAlignment="Left" Height="23" Margin="69,68,0,0" TextWrapping="Wrap" Text="" VerticalAlignment="Top" Width="300"/&gt; &lt;Label Content="" HorizontalAlignment="Left" Margin="16,103,0,0" VerticalAlignment="Top" Height="26" Width="35"/&gt; &lt;TextBox x:Name="RestorePath" HorizontalAlignment="Left" Height="23" Margin="69,107,0,0" TextWrapping="Wrap" Text="" VerticalAlignment="Top" Width="300"/&gt; &lt;Button x:Name="FirstButton" Content="‚àö" HorizontalAlignment="Left" Margin="357,68,0,0" VerticalAlignment="Top" Width="23" Height="23"/&gt; &lt;Button x:Name="SecondButton" Content="‚àö" HorizontalAlignment="Left" Margin="357,107,0,0" VerticalAlignment="Top" Width="23" Height="23"/&gt; &lt;CheckBox x:Name="Check" Content="  " HorizontalAlignment="Left" Margin="16,146,0,0" VerticalAlignment="Top" RenderTransformOrigin="-0.113,-0.267" Width="172"/&gt; &lt;Button x:Name="Go" Content="Go" HorizontalAlignment="Left" Margin="298,173,0,0" VerticalAlignment="Top" Width="82" Height="26"/&gt; &lt;ComboBox x:Name="Droplist" HorizontalAlignment="Left" Margin="16,173,0,0" VerticalAlignment="Top" Width="172" Height="26"/&gt; &lt;ListBox x:Name="ListBox" HorizontalAlignment="Left" Height="250" Margin="16,210,0,0" VerticalAlignment="Top" Width="364"/&gt; &lt;/Grid&gt; &lt;/Window&gt; "@) &lt;#   #&gt; $GUISyncHash.GUIThread = { $GUISyncHash.Window = [Windows.Markup.XamlReader]::Load(( New-Object System.Xml.XmlNodeReader $GUISyncHash.FormXAML )) $GUISyncHash.Check = $GUISyncHash.Window.FindName( "Check" ) $GUISyncHash.GO = $GUISyncHash.Window.FindName( "Go" ) $GUISyncHash.ListBox = $GUISyncHash.Window.FindName( "ListBox" ) $GUISyncHash.BackupPath = $GUISyncHash.Window.FindName( "BackupPath" ) $GUISyncHash.RestorePath = $GUISyncHash.Window.FindName( "RestorePath" ) $GUISyncHash.FirstButton = $GUISyncHash.Window.FindName( "FirstButton" ) $GUISyncHash.SecondButton = $GUISyncHash.Window.FindName( "SecondButton" ) $GUISyncHash.Droplist = $GUISyncHash.Window.FindName( "Droplist" ) $GUISyncHash.Window.Add_SourceInitialized({ $GUISyncHash.GO.IsEnabled = $true }) $GUISyncHash.FirstButton.Add_Click( { $GUISyncHash.ListBox.Items.Add( 'Click FirstButton' ) }) $GUISyncHash.SecondButton.Add_Click( { $GUISyncHash.ListBox.Items.Add( 'Click SecondButton' ) }) $GUISyncHash.GO.Add_Click( { $GUISyncHash.ListBox.Items.Add( 'Click GO' ) }) $GUISyncHash.Window.Add_Closed( { Stop-Process -Id $PID -Force }) $null = $GUISyncHash.Window.ShowDialog() } $Runspace = @{} $Runspace.Runspace = [RunspaceFactory]::CreateRunspace() $Runspace.Runspace.ApartmentState = "STA" $Runspace.Runspace.ThreadOptions = "ReuseThread" $Runspace.Runspace.Open() $Runspace.psCmd = { Add-Type -AssemblyName PresentationCore, PresentationFramework, WindowsBase }.GetPowerShell() $Runspace.Runspace.SessionStateProxy.SetVariable( 'GUISyncHash', $GUISyncHash ) $Runspace.psCmd.Runspace = $Runspace.Runspace $Runspace.Handle = $Runspace.psCmd.AddScript( $GUISyncHash.GUIThread ).BeginInvoke() Start-Sleep -S 1 $GUISyncHash.ListBox.Dispatcher.Invoke( "Normal", [action] { $GUISyncHash.ListBox.Items.Add( '' ) }) $GUISyncHash.ListBox.Dispatcher.Invoke( "Normal", [action] { $GUISyncHash.ListBox.Items.Add( '  ' ) }) foreach ( $item in 1..5 ) { $GUISyncHash.Droplist.Dispatcher.Invoke( "Normal", [action] { $GUISyncHash.Droplist.Items.Add( $item ) $GUISyncHash.Droplist.SelectedIndex = 0 }) } $GUISyncHash.ListBox.Dispatcher.Invoke( "Normal", [action] { $GUISyncHash.ListBox.Items.Add( 'While ( $true ) { Start-Sleep -S 10 }' ) }) while ( $true ) { Start-Sleep -S 10 }</code> </pre> <br><p>      WPF       github,       ,       smart : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/snd3r/GetDiskSmart/</a> .          ,    MVVM: </p><br><p><img src="https://habrastorage.org/webt/ke/-1/mb/ke-1mbcf2zuyg6crqt70zx4aoqw.png" alt="binging"></p><br><p>        Visual Studio,            Community Edition                 ,          xaml-  wpf ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/punker76/kaxaml</a> </p><br><p><img src="https://habrastorage.org/webt/wf/wd/j1/wfwdj1mhk_f8bml8clv3n6sv02a.png" alt="kaxaml"></p><br><h2 id="vmesto-zaklyucheniya">  Em vez de uma conclus√£o </h2><br><p> PowerShell ‚Äî        Windows-.   ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  </a> ,           ,            . </p><br><p>      ,                ,   "PowerShell,  ",   .           ,        ‚Äî     ,      .                 .          ,  -    , -                . </p><br><p>          ‚Äî    . </p><br><p><img src="https://habrastorage.org/webt/fd/qg/_1/fdqg_1uamuh8rc66ahep2utydeo.png" alt="acalmar"></p><br><p> PS <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">Boomburum</a> ,    2019   powershell ‚Äî  . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt443256/">https://habr.com/ru/post/pt443256/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt443244/index.html">Tarefas de revis√£o. Beanpoisk_1</a></li>
<li><a href="../pt443246/index.html">Como reinventamos o Askozia IP PBX depois que o projeto foi vendido e fechado pelo desenvolvedor</a></li>
<li><a href="../pt443250/index.html">Coletor de Lixo Caseiro para OpenJDK</a></li>
<li><a href="../pt443252/index.html">Bots de formiga modulares com mem√≥ria</a></li>
<li><a href="../pt443254/index.html">Triton √© o v√≠rus mais mortal</a></li>
<li><a href="../pt443258/index.html">Gotify - um projeto de c√≥digo aberto para entrega de notifica√ß√µes e envio de mensagens ao servidor</a></li>
<li><a href="../pt443260/index.html">Migrar para Zimbra sem arriscar neg√≥cios com um dom√≠nio comum</a></li>
<li><a href="../pt443262/index.html">Mau conselho: como escrever documenta√ß√£o t√©cnica? Parte Tr√™s e √öltima</a></li>
<li><a href="../pt443264/index.html">Ele fala e mostra: a ret√≥rica dos pol√≠ticos populares da Ucr√¢nia √© diferente?</a></li>
<li><a href="../pt443266/index.html">Como ajudamos a transformar o trabalho de contabilidade em uma grande empresa de energia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>