<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ö±Ô∏è ‚òùüèª üëÆ Migra√ß√£o de RabbitMQ sem falhas para Kubernetes üôèüèº üëí üë®üèæ‚Äçüî¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O RabbitMQ √© um intermedi√°rio de mensagens escrito em Erlang que permite organizar um cluster de failover com replica√ß√£o completa de dados para v√°rios...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Migra√ß√£o de RabbitMQ sem falhas para Kubernetes</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/450662/"><img src="https://habrastorage.org/webt/9j/vy/0w/9jvy0wqwfj4agrnnjerepzcv4qw.png"><br><br>  O RabbitMQ √© um intermedi√°rio de mensagens escrito em Erlang que permite organizar um cluster de failover com replica√ß√£o completa de dados para v√°rios n√≥s, onde cada n√≥ pode atender a solicita√ß√µes de leitura e grava√ß√£o.  Com muitos clusters Kubernetes em produ√ß√£o, suportamos um grande n√∫mero de instala√ß√µes RabbitMQ e somos confrontados com a necessidade de migrar dados de um cluster para outro sem tempo de inatividade. <a name="habracut"></a><br><br>  Essa opera√ß√£o foi necess√°ria para n√≥s em pelo menos dois casos: <br><br><ol><li>  Transferindo dados de um cluster RabbitMQ, que n√£o est√° no Kubernetes, para um novo cluster que j√° est√° "desligado" (ou seja, funcionando nos pods K8s). </li><li>  Migra√ß√£o do RabbitMQ no Kubernetes de um espa√ßo para nome (por exemplo, se os caminhos forem delimitados por espa√ßos para nome, transfira a infraestrutura de um caminho para outro). </li></ol><br>  A receita proposta neste artigo √© focada em situa√ß√µes (mas n√£o limitadas a elas), nas quais existe um cluster RabbitMQ antigo (por exemplo, de 3 n√≥s), localizado nos K8s ou em alguns servidores antigos.  Um aplicativo hospedado no Kubernetes trabalha com ele (j√° existe ou no futuro): <br><br><img src="https://habrastorage.org/webt/0t/nv/vw/0tnvvwspr5t-cwbvwzae5p2h9re.png"><br><br>  ... e enfrentamos o desafio de migr√°-lo para uma nova produ√ß√£o em Kubernetes. <br><br>  Primeiro, ser√° descrita uma abordagem geral da pr√≥pria migra√ß√£o e, depois disso, detalhes t√©cnicos de sua implementa√ß√£o. <br><br><h2>  Algoritmo de migra√ß√£o </h2><br>  A primeira etapa preliminar antes de qualquer a√ß√£o √© verificar se o modo de alta disponibilidade ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">HA</a> ) est√° ativado na instala√ß√£o antiga do RabbitMQ.  O motivo √© √≥bvio - n√£o queremos perder nenhum dado.  Para executar essa verifica√ß√£o, voc√™ pode ir ao painel de administra√ß√£o do RabbitMQ e, na guia Admin ‚Üí Pol√≠ticas, verifique se o valor <code>ha-mode: all</code> : <br><br><img src="https://habrastorage.org/webt/fz/sj/cc/fzsjcc5rvcdzqvzrwklrkomoqny.png"><br><br>  O pr√≥ximo passo √© criar um novo cluster RabbitMQ nos pods do Kubernetes (no nosso caso, por exemplo, consistindo em 3 n√≥s, mas seu n√∫mero pode ser diferente). <br><br>  Depois disso, mesclamos os clusters RabbitMQ antigos e novos, obtendo um √∫nico cluster (de 6 n√≥s): <br><br><img src="https://habrastorage.org/webt/br/ds/wx/brdswxtjfd97eg1jc6yuy0m6w6c.png"><br><br>  O processo de sincroniza√ß√£o de dados entre os clusters RabbitMQ antigos e novos √© iniciado.  Depois que todos os dados s√£o sincronizados entre todos os n√≥s no cluster, podemos alternar o aplicativo para usar o novo cluster: <br><br><img src="https://habrastorage.org/webt/mh/wu/py/mhwupy0059dj_m8xn-guonlq_i0.png"><br><br>  Ap√≥s essas opera√ß√µes, √© suficiente remover os n√≥s antigos do cluster RabbitMQ e a movimenta√ß√£o pode ser considerada conclu√≠da: <br><br><img src="https://habrastorage.org/webt/_2/_q/cr/_2_qcrxnt_1j4hzazxfsagyr9i8.png"><br><br>  Usamos repetidamente esse esquema em nossa produ√ß√£o.  No entanto, para sua pr√≥pria conveni√™ncia, o implementamos no √¢mbito de um sistema especializado que distribui configura√ß√µes t√≠picas de RMQ em conjuntos de clusters Kubernetes <i>(para quem est√° curioso: estamos falando de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">addon-operator</a> , sobre o qual falamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">recentemente</a> )</i> .  A seguir, s√£o apresentadas instru√ß√µes individuais que qualquer pessoa pode aplicar em suas instala√ß√µes para experimentar a solu√ß√£o proposta em a√ß√£o. <br><br><h2>  Tentamos na pr√°tica </h2><br><h3>  Exig√™ncias </h3><br>  Os detalhes s√£o muito simples: <br><br><ol><li>  Cluster Kubernetes (o minikube tamb√©m √© adequado); </li><li>  Cluster RabbitMQ (pode ser implantado no bare metal e criado como um cluster regular no Kubernetes a partir do gr√°fico oficial do Helm). </li></ol><br>  Para o exemplo descrito abaixo, implantei o RMQ no Kubernetes e o nomeei <code>rmq-old</code> . <br><br><h3>  Prepara√ß√£o do estande </h3><br>  1. Fa√ßa o download do gr√°fico Helm e edite-o um pouco: <br><br><pre> <code class="bash hljs">helm fetch --untar stable/rabbitmq-ha</code> </pre> <br>  Por conveni√™ncia, definimos uma senha, <code>ErlangCookie</code> e definimos a pol√≠tica <code>ha-all</code> para que, por padr√£o, as filas sejam sincronizadas entre todos os n√≥s do cluster RMQ: <br><br><pre> <code class="plaintext hljs">rabbitmqPassword: guest rabbitmqErlangCookie: mae9joopaol7aiVu3eechei2waiGa2we definitions: policies: |- { "name": "ha-all", "pattern": ".*", "vhost": "/", "definition": { "ha-mode": "all", "ha-sync-mode": "automatic", "ha-sync-batch-size": 81920 } }</code> </pre> <br>  2. Defina o gr√°fico: <br><br><pre> <code class="bash hljs">helm install . --name rmq-old --namespace rmq-old</code> </pre> <br>  3. V√° para o painel de administra√ß√£o do RabbitMQ, crie uma nova fila e adicione algumas mensagens.  Eles ser√£o necess√°rios para que, ap√≥s a migra√ß√£o, possamos garantir que todos os dados foram salvos e que n√£o perdemos nada: <br><br><img src="https://habrastorage.org/webt/de/pb/_o/depb_oq1aa_rpozeaymiik6acqm.png"><br><br>  A bancada de testes est√° pronta: temos o RabbitMQ "antigo" com os dados que precisam ser transferidos. <br><br><h3>  Migra√ß√£o de Cluster RabbitMQ </h3><br>  1. Primeiro, implante o novo RabbitMQ em um espa√ßo para nome <b>diferente</b> com <b>o mesmo</b> <code>ErlangCookie</code> e senha para o usu√°rio.  Para fazer isso, executamos as opera√ß√µes descritas acima, alterando o comando de instala√ß√£o RMQ final para o seguinte: <br><br><pre> <code class="bash hljs">helm install . --name rmq-new --namespace rmq-new</code> </pre> <br>  2. Agora voc√™ precisa mesclar o novo cluster com o antigo.  Para fazer isso, v√° para cada um dos pods do <b>novo</b> RabbitMQ e execute os comandos: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> OLD_RMQ=rabbit@rmq-old-rabbitmq-ha-0.rmq-old-rabbitmq-ha-discovery.rmq-old.svc.cluster.local &amp;&amp; \ rabbitmqctl stop_app &amp;&amp; \ rabbitmqctl join_cluster <span class="hljs-variable"><span class="hljs-variable">$OLD_RMQ</span></span> &amp;&amp; \ rabbitmqctl start_app</code> </pre> <br>  A vari√°vel <code>OLD_RMQ</code> endere√ßo de um dos n√≥s do cluster RMQ <b>antigo</b> . <br><br>  Esses comandos ir√£o parar o n√≥ atual do <b>novo</b> cluster RMQ, conect√°-lo ao cluster antigo e reinici√°-lo. <br><br>  3. O cluster RMQ de 6 n√≥s est√° pronto: <br><br><img src="https://habrastorage.org/webt/1k/1z/cr/1k1zcrq3-hn-k_k6y10z-ktteqc.png"><br><br>  Voc√™ deve esperar at√© que as mensagens sejam sincronizadas entre todos os n√≥s.  √â f√°cil adivinhar que o tempo de sincroniza√ß√£o das mensagens depende da pot√™ncia do ferro no qual o cluster est√° implantado e do n√∫mero de mensagens.  No cen√°rio descrito, existem apenas 10 deles, portanto os dados foram sincronizados instantaneamente, mas com um n√∫mero suficientemente grande de mensagens, a sincroniza√ß√£o pode levar horas. <br><br>  Portanto, o status da sincroniza√ß√£o: <br><br><img src="https://habrastorage.org/webt/32/rb/gl/32rbglvg5f9vnxjaee0ewii0pmo.png"><br><br>  Aqui, <code>+5</code> significa que as mensagens <b>j√°</b> est√£o em <b>outros</b> 5 n√≥s (exceto o que √© especificado no campo <code>Node</code> ).  Assim, a sincroniza√ß√£o foi bem sucedida. <br><br>  4. Resta apenas mudar o endere√ßo RMQ no aplicativo para o novo cluster (as a√ß√µes espec√≠ficas aqui dependem da pilha de tecnologia que voc√™ est√° usando e de outros detalhes do aplicativo), ap√≥s o qual voc√™ pode se despedir do antigo. <br><br>  Para a √∫ltima opera√ß√£o (ou seja, <b>depois de</b> alternar o aplicativo para um novo cluster), vamos a cada n√≥ do cluster <b>antigo</b> e executamos os comandos: <br><br><pre> <code class="bash hljs">rabbitmqctl stop_app rabbitmqctl reset</code> </pre> <br>  O cluster "esqueceu" os n√≥s antigos: √© poss√≠vel excluir o RMQ antigo, que concluir√° a movimenta√ß√£o. <br><br>  <i><b>Nota</b> : Se voc√™ usar o RMQ com certificados, basicamente nada mudar√° - o processo de mudan√ßa ser√° realizado exatamente da mesma maneira.</i> <br><br><h2>  Conclus√µes </h2><br>  O esquema descrito √© adequado para quase todos os casos em que precisamos transferir o RabbitMQ ou simplesmente mudar para um novo cluster. <br><br>  No nosso caso, as dificuldades ocorreram apenas uma vez, quando o RMQ foi acessado de muitos lugares, e n√£o tivemos a oportunidade de alterar o endere√ßo do RMQ para um novo.  Em seguida, lan√ßamos um novo RMQ no mesmo namespace com os mesmos r√≥tulos, para que ele se enquadrasse nos servi√ßos e no ingresso existentes e, quando iniciamos o pod, manipulamos os r√≥tulos com as m√£os, excluindo-os no in√≠cio, para que as solicita√ß√µes n√£o ca√≠ssem em um RMQ vazio, e adicionando-os novamente ap√≥s a sincroniza√ß√£o da mensagem. <br><br>  Usamos a mesma estrat√©gia ao atualizar o RabbitMQ para uma nova vers√£o com uma configura√ß√£o modificada - tudo funcionava como um rel√≥gio. <br><br><h2>  PS </h2><br>  Como continua√ß√£o l√≥gica deste material, estamos preparando artigos sobre o MongoDB (migra√ß√£o de um servidor iron para o Kubernetes) e o MySQL (uma das op√ß√µes para "preparar" este DBMS no Kubernetes).  Eles ser√£o publicados nos pr√≥ximos meses. <br><br><h2>  PPS </h2><br>  Leia tamb√©m em nosso blog: <br><br><ul><li>  ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Bancos de dados e Kubernetes (revis√£o e reportagem em v√≠deo)</a> ‚Äù; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Dicas e truques do K8: acelerando a inicializa√ß√£o de grandes bancos de dados.</a> " </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt450662/">https://habr.com/ru/post/pt450662/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt450648/index.html">Emulador de PS2 / PSP + Google Drive + YouTube = "loucura" continua</a></li>
<li><a href="../pt450650/index.html">Infraestrutura centrada em aplicativos. Arquitetura de rede do futuro - do racioc√≠nio aos neg√≥cios</a></li>
<li><a href="../pt450652/index.html">Mensagem para o futuro programador</a></li>
<li><a href="../pt450658/index.html">Megazap do processador Intel - reposi√ß√£o de postos</a></li>
<li><a href="../pt450660/index.html">A introdu√ß√£o de um imposto de 15% matar√° o com√©rcio on-line estrangeiro</a></li>
<li><a href="../pt450666/index.html">React tem um efeito ruim no Angular?</a></li>
<li><a href="../pt450672/index.html">Constru√ß√£o de um local de metal em uma funda√ß√£o de estacas no SPDS</a></li>
<li><a href="../pt450674/index.html">Mudan√ßa para Arm√™nia</a></li>
<li><a href="../pt450676/index.html">Trabalho em metal 2019: solu√ß√µes 3D avan√ßadas para empresas</a></li>
<li><a href="../pt450678/index.html">Citymobil - um manual para melhorar a disponibilidade em meio ao crescimento dos neg√≥cios para startups. Parte 4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>