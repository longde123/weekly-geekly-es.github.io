<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç© üßôüèø üåé Berichte √ºber den Speicherstatus mithilfe von R. Parallel Computing, Grafiken, XLSX, E-Mail und all dies ü§πüèø üèâ üëâüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Der Artikel enth√§lt Code zum Generieren regelm√§√üiger Berichte zum Status von EMC VNX- Speicherlaufwerken mit alternativen Ans√§tzen und Erstellungsverl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Berichte √ºber den Speicherstatus mithilfe von R. Parallel Computing, Grafiken, XLSX, E-Mail und all dies</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461441/"><p>  Der Artikel enth√§lt Code zum Generieren regelm√§√üiger Berichte zum Status von <strong>EMC VNX-</strong> Speicherlaufwerken mit alternativen Ans√§tzen und Erstellungsverlauf. </p><br><p>  Ich habe versucht, Code mit den detailliertesten Kommentaren und einer Datei zu schreiben.  Ersetzen Sie nur Ihre Passw√∂rter.  Das Format der Quelldaten wird ebenfalls angegeben, daher bin ich froh, wenn jemand versucht, sie zu Hause anzuwenden. </p><br><p><img src="https://habrastorage.org/webt/um/it/no/umitnoobcf6fiyywqho_5gsbvjk.png" alt="Grafik zeigt"></p><a name="habracut"></a><br><h2 id="predystoriya">  Hintergrund </h2><br><p>  Sie k√∂nnen √ºberspringen, wenn es nicht interessant ist, woher die "Beine" wachsen. <br>  Wir haben ein Rechenzentrum.  Es gibt keine sehr frischen Speichersysteme.  Es gibt viele Speichersysteme, auch Festplattenfehler.  Mehrmals pro Woche gehen Leute zum Rechenzentrum und wechseln die Laufwerke im Speichersystem.  Die Entscheidung zum Ersetzen von Festplatten wird nach einem Alarm vom System " <strong>Empfohlener Festplattenwechsel</strong> " getroffen. </p><br><p>  <em>Nichts Au√üergew√∂hnliches.</em> </p><br><p><img src="https://habrastorage.org/webt/5l/ho/ne/5lhonedh_eha1d0gm2vnzrv2ry4.png" alt="Alles ist in Ordnung"></p><br><p>  Vor kurzem begannen sich einzelne LUNs, die auf diesen Speichersystemen gesammelt und der virtuellen Umgebung pr√§sentiert wurden, ernsthaft zu verschlechtern.  Nach einem Gespr√§ch mit dem technischen Support des Anbieters wurde klar, dass die Festplatten nicht nur gewechselt werden sollten, wenn die obige Alarmmeldung angezeigt wird, sondern auch, wenn eine gro√üe Anzahl anderer Meldungen angezeigt wird, dass das System keine kritischen Fehler ber√ºcksichtigt. </p><br><p>  Die SNMP-√úberwachung durch diese Speichersysteme wird nicht unterst√ºtzt.  Sie m√ºssen entweder teure propriet√§re Software (wir haben sie nicht) oder das <strong>NaviSECCli-</strong> Konsolendienstprogramm verwenden, das mit jedem Controller (es gibt zwei davon) jedes Speichersystems verbunden werden muss. Dies war jedoch nicht sehr w√ºnschenswert. </p><br><p>  Es wurde beschlossen, die Erfassung von Protokollen zu automatisieren und nach Fehlern zu suchen.  Die Entscheidung, die Festplatten auszutauschen, sollte den verantwortlichen Ingenieuren auf der Grundlage der Ergebnisse der Analyse des Berichts √ºberlassen werden. </p><br><h2 id="pervye-shagi">  Erste Schritte </h2><br><p>  Zun√§chst schrieb einer meiner Kollegen <strong>PowerShell-</strong> Code, der Folgendes tat: </p><br><ul><li>  Nahm eine Eingabetabelle, die die IP-Adressen der Speichercontroller enthielt; </li><li>  Der Zyklus ging zu den IP-Adressen der Controller <em>A</em> und dann zu den IP-Adressen der Controller <em>B.</em> </li><li>  Dabei wurden sie zus√§tzlich nach Seriennummern der Festplatten befragt. </li><li>  verarbeitete alle Zeilen der Protokolle und filterte nach dem Inhalt der gesuchten Nachrichten; </li><li>  ein <strong>PowerShell-</strong> Objekt erstellt und in seinen Eigenschaften die erforderlichen Daten aus den oben erhaltenen Zeilen analysiert; </li><li>  Alle resultierenden Objekte wurden in einer Tabelle zusammengef√ºhrt, die in Form von CSV ausgegeben wurde. </li></ul><br><p>  Der Code ist unten.  Machen Sie sofort eine Reservierung, dass er arbeitet, aber wir haben eine alternative L√∂sung eingef√ºhrt. </p><br><div class="spoiler">  <b class="spoiler_title">PowerShell-Quelle</b> <div class="spoiler_text"><pre><code class="perl hljs">cd <span class="hljs-string"><span class="hljs-string">'d:\Navisphere CLI\' $csv = "D:\VNX-IP.csv" $Filter1 = "name1" $Filter2 = "name2" $Filter3 = "name3" $Data = import-csv $csv -Delimiter '</span></span>;<span class="hljs-string"><span class="hljs-string">' | Where {$_.cl -EQ $Filter1 -Or $_.cl -EQ $Filter2 -Or $_.cl -EQ $Filter3} | Sort-Object -Property @{Expression={$_.cl}; Ascending=$true}, @{Expression={$_.Name} ;Ascending=$true} #$Filter1 = "nameOfcl" #$Data = import-csv $csv -Delimiter '</span></span>;<span class="hljs-string"><span class="hljs-string">' | Where {$_.Name -EQ $Filter1} $Data | select Name,IP,cl $yStart = (Get-Date).AddDays(-30).ToString('</span></span>yyyy<span class="hljs-string"><span class="hljs-string">') $yEnd = (Get-Date).ToString('</span></span>yyyy<span class="hljs-string"><span class="hljs-string">') $mStart = (Get-Date).AddDays(-30).ToString('</span></span>MM<span class="hljs-string"><span class="hljs-string">') $mEnd = (Get-Date).ToString('</span></span>MM<span class="hljs-string"><span class="hljs-string">') $dStart = (Get-Date).AddDays(-30).ToString('</span></span>dd<span class="hljs-string"><span class="hljs-string">') $dEnd = (Get-Date).ToString('</span></span>dd<span class="hljs-string"><span class="hljs-string">') #$start = (Get-Date).AddDays(-3).ToString('</span></span>MM\/dd\/yy<span class="hljs-string"><span class="hljs-string">') #$end = (Get-Date).ToString('</span></span>MM\/dd\/yy<span class="hljs-string"><span class="hljs-string">') $i = 1 $table = ForEach ($row in $Data) { Write-Host $row.Name -ForegroundColor "Yellow" Write-Host "SP A" Write-Host (Get-Date).ToString('</span></span>HH:mm:ss<span class="hljs-string"><span class="hljs-string">') $txt = .\NaviSECCli.exe -scope 0 -h $row.newA -user myusername -password mypassword getlog -date $mStart/$dStart/$yStart $mEnd/$dEnd/$yEnd | Select-String -Pattern "\(820\)","\(803\)","\(801\)","\(920\)","\(901\)" ForEach ($n in $txt) { $x = $n -Split('</span></span> <span class="hljs-string"><span class="hljs-string">') $disk = $x[3] + "_" + $x[5] + "_" + $x[7].Split("(")[0] $sn = (.\NaviSECCli.exe -scope 0 -h $row.newA -user myusername -password mypassword getdisk $disk -serial)[1] | %{$_ -replace "Serial Number: ",""} | %{$_ -replace "State: ",""} | %{$_ -replace " ",""} New-Object PSObject -Property @{ i = $i cl = $row.cl Storage = $row.Name SP = "A" Date = $x[0] Time = $x[1] Disk = $disk Error = (($n -Split('</span></span>\[<span class="hljs-string"><span class="hljs-string">'))[0] -Split('</span></span>\)<span class="hljs-string"><span class="hljs-string">'))[1].Trim() eCode = (($n -Split('</span></span>\(<span class="hljs-string"><span class="hljs-string">'))[1] -Split('</span></span>\)<span class="hljs-string"><span class="hljs-string">'))[0] SN = $sn } $i = $i + 1 } Write-Host "SP B" Write-Host (Get-Date).ToString('</span></span>HH:mm:ss<span class="hljs-string"><span class="hljs-string">') $txt = .\NaviSECCli.exe -scope 0 -h $row.newB -user myusername -password mypassword getlog -date $mStart/$dStart/$yStart $mEnd/$dEnd/$yEnd | Select-String -Pattern "\(820\)","\(803\)","\(801\)","\(920\)","\(901\)" ForEach ($n in $txt) { $x = $n -Split('</span></span> <span class="hljs-string"><span class="hljs-string">') $disk = $x[3] + "_" + $x[5] + "_" + $x[7].Split("(")[0] $sn = (.\NaviSECCli.exe -scope 0 -h $row.newA -user myusername -password mypassword getdisk $disk -serial)[1] | %{$_ -replace "Serial Number: ",""} | %{$_ -replace "State: ",""} | %{$_ -replace " ",""} New-Object PSObject -Property @{ i = $i cl = $row.cl Storage = $row.Name SP = "B" Date = $x[0] Time = $x[1] Disk = $disk Error = (($n -Split('</span></span>\[<span class="hljs-string"><span class="hljs-string">'))[0] -Split('</span></span>\)<span class="hljs-string"><span class="hljs-string">'))[1].Trim() eCode = (($n -Split('</span></span>\(<span class="hljs-string"><span class="hljs-string">'))[1] -Split('</span></span>\)<span class="hljs-string"><span class="hljs-string">'))[0] SN = $sn } $i = $i + 1 } Write-Host " " } $table | select i,cl,Storage,SP,Date,Time,Disk,Error,eCode,SN | Export-Csv -Path '</span></span>d:\VNX-Errors.csv<span class="hljs-string"><span class="hljs-string">' -NoTypeInformation -UseCulture -Encoding UTF8</span></span></code> </pre> </div></div><br><p>  Alles war in Ordnung, alles, was √ºbrig blieb, war, einen ‚ÄûGlanz‚Äú in Form eines automatischen Versands eines Briefes an interessierte Kollegen und einer minimalen Formatierung der resultierenden CSV hinzuzuf√ºgen.  Aber (!) All diese Probleme haben sehr lange geklappt.  Daten f√ºr einen Monat wurden zum Beispiel ungef√§hr <strong>45 Minuten</strong> gesammelt, was nicht sehr geeignet war, da ich zus√§tzlich zu regelm√§√üigen Berichten eine Analyse f√ºr das laufende Jahr durchf√ºhren wollte, und dies w√§re eine sehr lange Zeit.  Aber "ablehnen - Angebot."  Sie fingen an zu denken. </p><br><p><img src="https://habrastorage.org/webt/jn/85/ts/jn85tsztuso-z7ulzxh2a1jk7yq.jpeg"></p><br><p>  Nat√ºrlich m√ºssen Sie den Code optimieren und paralleles Rechnen aktivieren.  In <strong>PowerShell</strong> konnten wir nicht mehr als 5 Threads gleichzeitig mithilfe des <strong>Workflows erfolgreich ausf√ºhren</strong> , und wir haben noch keine alternativen Methoden "geraucht".  Daher wurde beschlossen, die Skriptlogik auf <strong>R zu verschieben.</strong>  Das <strong>NaviSECCli-</strong> Dienstprogramm, das unter <strong>R ausgef√ºhrt werden kann</strong> , f√ºhrt eine √úbersicht √ºber die Speicherung im Quellcode durch, sodass die L√∂sung durchaus geeignet ist. <br>  Es wird gesagt - <del>  ein paar Tage </del>  - fertig! </p><br><p>  Wir haben beschlossen, dass ich am Ausgang einen t√§glichen Newsletter erhalten m√∂chte, der die <strong>Gesamtzahl der Fehler</strong> im Text des Briefes, einen <strong>Zeitplan</strong> f√ºr die Anzahl der Unf√§lle (damit das Management etwas zu zeigen hat) und <strong>einen Anhang</strong> in Form einer XLSX-Tabelle enth√§lt.  Wir haben festgestellt, dass ich in der Tabelle 3 Registerkarten haben m√∂chte: </p><br><ul><li>  Unfalldaten f√ºr 3 Tage nach Festplatte und Unfalltyp </li><li>  Ein √§hnlicher Tab, aber f√ºr 30 Tage </li><li>  Rohdaten (wenn jemand sie selbst in Excel ausf√ºhren m√∂chte) </li></ul><br><h4 id="algoritm-skripta">  Skriptalgorithmus </h4><br><p>  <strong>1.</strong> Laden Sie die verf√ºgbaren Daten auf den Controllern von csv herunter. <br>  <strong>2.</strong> Parallele Berechnung eines Zyklus f√ºr alle Steuerungen mit Suche nach Aufzeichnungen der erforderlichen Alarmmeldungen durchf√ºhren; <br>  <strong>3.</strong> Kombinieren Sie die Ergebnisse in einem Datenrahmen. <br>  <strong>4.</strong> Datenverarbeitung und -konvertierung durchf√ºhren; <br>  <strong>5.</strong> xlsx-Dokument generieren; <br>  <strong>6. Wir</strong> bilden den Zeitplan, den wir in PNG speichern. <br>  <strong>7.</strong> einen Brief mit den gesammelten Daten bilden; <br>  <strong>8.</strong> Senden Sie einen Brief. </p><br><h2 id="proydyom-po-punktam-algoritma">  Lassen Sie uns die Punkte des Algorithmus durchgehen </h2><br><h3 id="1-zagruzhaem-iz-csv-imeyuschiesya-dannye-po-kontrolleram">  1. Laden Sie die verf√ºgbaren Daten auf den Controllern von csv herunter </h3><br><div class="spoiler">  <b class="spoiler_title">Quelltabellenformat mit VNX-Parametern</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># A tibble: 83 x 9 Name IP cl type newA newB oldA oldB cntIP &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 1 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ 2 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ 3 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ 4 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ 5 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ 6 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ 7 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ 8 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ 9 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ 10 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ # ... with 73 more rows</span></span></code> </pre> </div></div><br><p>  Um Notfallinformationen zu erfassen, m√ºssen Sie mithilfe einer speziellen <em>EMV-</em> Software - <strong>NaviCLI</strong> - mit bestimmten Schl√ºsseln eine Reihe von Verbindungen zu beiden Controllern ( <em>Spalten newA</em> und <em>newB</em> ) herstellen. <br>  Der Einfachheit halber formatieren wir die resultierende Tabelle nach dem Laden neu, sodass sich die IP-Adressen beider Controller in derselben Spalte befinden, sodass Sie einen Zyklus in der gesamten Liste und nicht zwei aufeinanderfolgende Zyklen durchf√ºhren k√∂nnen.  Wir machen das mit der <strong>Gather-</strong> Funktion.  Die Probleme beim Arbeiten mit "vertikalen" oder "horizontalen" Datenformaten sind in der offiziellen Dokumentation der <strong>Tidyverse-</strong> Bibliothek sehr gut beschrieben.  Sie k√∂nnen es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">hier</a> lesen. </p><br><p>  Wir lesen die Daten mit der Funktion <strong>read_csv2</strong> und bestimmen die <strong>Spaltentypen</strong> manuell √ºber den zus√§tzlichen Parameter <strong>col_types</strong> .  Dies ist eine gute Praxis  beschleunigt das Laden erheblich.  In unserem Fall ist das nicht so wichtig, weil  Die urspr√ºngliche CSV enth√§lt weniger als 100 Zeilen, aber wir gew√∂hnen uns daran, richtig zu schreiben. </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   IP VNX. #         , #   ip        . VNX_ip &lt;- vnxIPfilePath %&gt;% read_csv2( col_types = cols( Name = col_character(), IP = col_character(), cl = col_character(), type = col_character(), newA = col_character(), newB = col_character(), oldA = col_character(), oldB = col_character() ) ) %&gt;% filter(cl %in% productCls) %&gt;% gather(key = "cntName", value = "cntIP", 5:6)</span></span></code> </pre> <br><p>  Bei der Ausgabe erhalten wir diesen <strong>Datenrahmen</strong> (die neuen Spalten sind <strong>cntName</strong> und <strong>cntIP</strong> ): </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># A tibble: 30 x 8 Name IP cl type oldA oldB cntName cntIP &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 1 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ 2 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ 3 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ 4 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ 5 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ 6 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ 7 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ 8 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ 9 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ 10 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ # ... with 20 more rows</span></span></code> </pre> <br><h3 id="2-3-zapuskaem-cherez-parallelnye-vychisleniya-cikl-po-vsem-kontrolleram-s-poiskom-zapisey-o-trebuemyh-avariynyh-soobscheniyah-rezultaty-obedinyaem-v-data-frame">  2-3.  Wir durchlaufen parallele Berechnungen eines Zyklus f√ºr alle Steuerungen mit einer Suche nach Aufzeichnungen der erforderlichen Alarmmeldungen.  Kombinieren Sie die Ergebnisse in einem Datenrahmen </h3><br><p>  Weiter ist das interessanteste.  <em>Paralleles Rechnen</em> . </p><br><p>  In <strong>R gibt es</strong> mehrere (eher sogar viele) Optionen f√ºr paralleles Rechnen.  Der Link aus den Bibliotheken <strong>foreach</strong> und <strong>doParallel hat mir besser gefallen</strong> .  Sie k√∂nnen √ºber sie und andere parallele Rechenoptionen in <strong>R</strong> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">hier</a> lesen. </p><br><p>  Kurz gesagt, wir machen nur <strong>3 Schritte</strong> : <br>  <strong>Schritt 1</strong>  Registrieren Sie Kernel <del>  reiner Smaragd </del>  CPU f√ºr das parallele Rechnen √ºber <strong>registerDoParallel</strong> (in unserem Fall ermitteln wir zun√§chst die Anzahl der Kerne im Fall) </p><br><div class="spoiler">  <b class="spoiler_title">Registrieren Sie die CPU-Kerne</b> <div class="spoiler_text"><pre> <code class="python hljs">numCores &lt;- detectCores() registerDoParallel(numCores)</code> </pre> </div></div><br><p>  <strong>Schritt 2</strong>  Wir starten den Zyklus √ºber <strong>foreach</strong> (vergessen Sie nicht, den Operator <strong>% dopar%</strong> anzugeben, damit der Zyklus parallel <strong>abl√§uft,</strong> und geben Sie √ºber den Parameter <strong>.combine an,</strong> wie das Ergebnis <strong>erfasst</strong> wird).  In unserem Fall <strong>.combine = rbind</strong> , weil wir am Ausgang jeder Schleife einen <strong>Datenrahmen</strong> haben. </p><br><div class="spoiler">  <b class="spoiler_title">Code zum Abrufen der Fehlertabelle</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#      VNX   ip   . #      ,      #   ,      dataframe #  %dopar%   . #    ,   system.time   , #    %dopar%  %do%.      4-5. # system.time({ errors_df &lt;- foreach(i = 1:nrow(VNX_ip), .combine = rbind, .packages = "tidyverse") %dopar% { errors_raw &lt;- system( paste( "NaviSECCli.exe -scope 0 -h", VNX_ip$cntIP[i], "-user myusername -password mypassword getlog -date", bigPeriodForm, currDateForm ), intern = TRUE ) %&gt;% str_subset(pattern = regex(paste0(errorNumbers, collapse = "|"))) #      ,       if (length(errors_raw) &gt; 0) { #     #       , #     , #       . errorsDescr &lt;- errors_raw %&gt;% gsub("(.*\\) )(.*)(\\s+\\[.*)", "\\2", x = .) %&gt;% trimws() %&gt;% gsub('([[:punct:]])|\\s+', '_', .) #           errors &lt;- errors_raw %&gt;% str_split(pattern = "\\s+", simplify = T) %&gt;% as_tibble() %&gt;% mutate(Disk = paste0(V4, "_", V6, "_", V8) %&gt;% gsub( pattern = "\\([0-9]{3}\\)", replacement = "", x = .) ) #  dataframe    data_frame(cl = VNX_ip$cl[i], Storage = VNX_ip$Name[i], Date = errors$V1 %&gt;% as.Date(format = "%m/%d/%Y"), Time = errors$V2, Disk = errors$Disk, Error = errorsDescr, eCode = errors$V8 %&gt;% str_extract(paste0(errorNumbers, collapse = "|")) %&gt;% str_extract("[0-9]+")) %&gt;% mutate(DateTime = as.POSIXct(paste(Date, Time), format = "%Y-%m-%d %H:%M:%S")) } } # })</span></span></code> </pre> </div></div><br><p>  <strong>Schritt 3</strong>  Wir l√∂schen den erstellten Parallelit√§tscluster mit <strong>stopImplicitCluster ()</strong> </p><br><h4 id="chut-podrobnee-po-poluchenii-chitaemoy-tablicy-iz-raw-teksta-oshibok">  Ein wenig mehr Details zum Abrufen einer lesbaren Tabelle aus rohem Fehlertext </h4><br><p>  In Textform lauten die Fehler wie folgt: </p><br><pre> <code class="python hljs">head(errors_raw) [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"07/13/2019 00:01:46 Bus 0 Enclosure 3 Disk 9(801) Soft SCSI Bus Error [0x00] 841d1080 10006 "</span></span> [<span class="hljs-number"><span class="hljs-number">2</span></span>] <span class="hljs-string"><span class="hljs-string">"07/13/2019 00:01:46 Bus 0 Enclosure 3 Disk 9(801) Soft SCSI Bus Error [0x00] 841e1a00 10006 "</span></span> [<span class="hljs-number"><span class="hljs-number">3</span></span>] <span class="hljs-string"><span class="hljs-string">"07/13/2019 00:01:46 Bus 0 Enclosure 3 Disk 9(801) Soft SCSI Bus Error [0x00] 8420b600 10006 "</span></span> [<span class="hljs-number"><span class="hljs-number">4</span></span>] <span class="hljs-string"><span class="hljs-string">"07/13/2019 00:01:46 Bus 0 Enclosure 3 Disk 9(801) Soft SCSI Bus Error [0x00] 84206900 10006 "</span></span> [<span class="hljs-number"><span class="hljs-number">5</span></span>] <span class="hljs-string"><span class="hljs-string">"07/13/2019 00:01:46 Bus 0 Enclosure 3 Disk 9(801) Soft SCSI Bus Error [0x00] 841fc900 10006 "</span></span> [<span class="hljs-number"><span class="hljs-number">6</span></span>] <span class="hljs-string"><span class="hljs-string">"07/13/2019 00:01:46 Bus 0 Enclosure 3 Disk 9(801) Soft SCSI Bus Error [0x00] 841fc000 10006</span></span></code> </pre> <br><p>  Hier haben wir Werte, die durch ein Leerzeichen getrennt sind, das auf den ersten Blick auch in <em>csv</em> normal eingef√ºgt wird.  Aber es ist nicht so einfach.  Die Komplexit√§t des Parsens hier ist folgende: </p><br><ul><li>  Datum und Uhrzeit sind ebenfalls durch ein Leerzeichen (das kleinste √úbel) getrennt. </li><li>  der Fehlertext besteht aus "W√∂rtern", d.h.  auch durch ein Leerzeichen getrennt; </li><li>  Aus irgendeinem Grund ist zwischen der Datentr√§gernummer und dem Fehlercode (in Klammern) kein Leerzeichen. <br>  Im Allgemeinen ein Paradies f√ºr einen Liebhaber regul√§rer Ausdr√ºcke :) </li></ul><br><p><img src="https://habrastorage.org/webt/yk/rf/2i/ykrf2irog7eq_o3j3d0-ijnild0.jpeg" alt="Kranker Bastard"></p><br><p>  Ich werde mich nicht mit dem Parsen befassen, da es Geschmackssache ist, aber ich werde klarstellen, dass der Fehlertext auseinandergerissen werden musste, da sich die Werte zwischen der schlie√üenden Klammer der Fehlernummer und der √∂ffnenden eckigen Klammer eines anderen Werts befinden.  In einer Schleife ist dies die <strong>Fehlervariable</strong> . </p><br><p>  Es ist auch ein interessanter Punkt, dass wir zur Vereinfachung der Bildung des endg√ºltigen <strong>Datenrahmens</strong> , um die IP-Adressen der Controller zu durchlaufen, die Sequenz nicht durch die Spalte mit den IP-Adressen der Controller (d. H. <strong>I = VNX_ip $ cntIP</strong> ), sondern durch die Zeilennummer (d. H. <strong>i = 1: nrow (VNX_ip)</strong> ).  Auf diese Weise k√∂nnen wir die Clusternummer und den Speichernamen √ºber die Aufrufe <strong>VNX_ip $ cl [i]</strong> bzw. <strong>VNX_ip $ Name [i] hinzuf√ºgen</strong> , wenn <strong>wir einen Datenrahmen</strong> mit bereits analysierten Fehlern erstellen.  Ohne dies m√ºssten Verkn√ºpfungen hergestellt werden, die langsamer und schlechter im Code gelesen w√ºrden. </p><br><p>  Am Ende erhalten wir einen <strong>Datenrahmen</strong> (um ehrlich zu sein, dann <strong>tibble</strong> , aber der Unterschied geht √ºber den Rahmen des Artikels hinaus), der alle Daten enth√§lt, die wir ben√∂tigen.  Das hei√üt,  Auf welchem ‚Äã‚ÄãSpeichersystem, auf welcher Festplatte, wann welcher Fehler aufgetreten ist. </p><br><div class="spoiler">  <b class="spoiler_title">Endansicht Datenrahmen</b> <div class="spoiler_text"><pre> <code class="python hljs">&gt; errors_df <span class="hljs-comment"><span class="hljs-comment"># A tibble: 2,705 x 8 cl Storage Date Time Disk Error eCode DateTime &lt;chr&gt; &lt;chr&gt; &lt;date&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;dttm&gt; 1 XclNam~ XStorageN~ 2019-07-18 12:09:~ 0_1_3 Soft_SCSI_~ 801 2019-07-18 12:09:55 2 XclNam~ XStorageN~ 2019-07-18 15:09:~ 0_1_3 Soft_SCSI_~ 801 2019-07-18 15:09:56 3 XclNam~ XStorageN~ 2019-07-18 16:28:~ 0_1_3 Soft_SCSI_~ 801 2019-07-18 16:28:50 4 XclNam~ XStorageN~ 2019-07-19 06:36:~ 0_1_6 Soft_SCSI_~ 801 2019-07-19 06:36:39 5 XclNam~ XStorageN~ 2019-07-19 20:57:~ 0_1_6 Soft_Media~ 820 2019-07-19 20:57:35 6 XclNam~ XStorageN~ 2019-07-22 11:00:~ 0_2_~ Soft_SCSI_~ 801 2019-07-22 11:00:43 7 XclNam~ XStorageN~ 2019-07-22 11:00:~ 0_2_~ Soft_SCSI_~ 801 2019-07-22 11:00:44 8 XclNam~ XStorageN~ 2019-07-22 12:02:~ 0_2_~ Soft_SCSI_~ 801 2019-07-22 12:02:31 9 XclNam~ XStorageN~ 2019-07-23 23:29:~ 0_3_8 Soft_SCSI_~ 801 2019-07-23 23:29:49 10 XclNam~ XStorageN~ 2019-07-13 00:01:~ 0_3_9 Soft_SCSI_~ 801 2019-07-13 00:01:46 # ... with 2,695 more rows</span></span></code> </pre> </div></div><br><p>  Das Kl√ºgste ist, dass der gesamte Zyklus der parallelen Abfrage aller Speichersysteme <strong>nicht 30 Minuten, sondern 30 Sekunden dauert</strong> . </p><br><p>  <em>Gott sei Dank, dass dies nicht der Fall ist, wenn 30 Sekunden zu schnell sind.</em> <br><img src="https://habrastorage.org/webt/pr/nf/u9/prnfu9eet3au2ktv5-uk1vauskk.jpeg" alt="ein witz"></p><br><p>  Es sollte klargestellt werden, dass der <strong>PowerShell-</strong> Code auch die Seriennummern der Festplatten aller Speichersysteme in einem Zyklus erfasst hat. Zum Zeitpunkt des Umschreibens des Codes auf <strong>R waren</strong> diese Daten redundant.  Der Laufzeitvergleich ist also nicht ganz ehrlich, aber dennoch beeindruckend. </p><br><h3 id="4-5-obrabotka-i-preobrazovanie-dannyh-formirovanie-xlsx-dokumenta">  4-5.  Verarbeitung und Datenkonvertierung.  Generieren eines XLSX-Dokuments </h3><br><p>  Die Datenkonvertierung f√ºr xlsx-Dokumente wurde auf das Filtern der Quelltabelle in den letzten 3 Tagen sowie im letzten Monat und das Konvertieren der Spalten mit den Fehlernamen in das "horizontale" Format reduziert, sodass sich jeder Fehlertyp in einer separaten Spalte befand.  Hierf√ºr wurde eine separate Funktion geschrieben (um die gleichen Schritte nicht zweimal zu duplizieren) </p><br><div class="spoiler">  <b class="spoiler_title">Quellfilterfunktion</b> <div class="spoiler_text"><pre> <code class="python hljs">myErrorStats &lt;- function(data, period, orderColname = quo(Soft_Media_Error)) { data %&gt;% filter(Date &gt; period) %&gt;% group_by(cl, Storage, Disk, Error) %&gt;% summarise(count = n()) %&gt;% spread(Error, count, fill = <span class="hljs-number"><span class="hljs-number">0</span></span>) %&gt;% arrange(desc(!!orderColname)) }</code> </pre> </div></div><br><p>  Um die Fehlertypen in einer separaten Spalte anzuzeigen, wurde die <strong>Spread-</strong> Funktion mit der zus√§tzlichen Schl√ºsself√ºllung <strong>= 0</strong> angewendet, mit der die fehlenden Werte mit <strong>0</strong> gef√ºllt wurden.  Ohne diesen Schl√ºssel h√§tte die entsprechende Spalte <strong>NA-</strong> Werte, wenn an einem Tag kein Fehler aufgetreten w√§re. </p><br><p>  Au√üerdem wollte ich in der Funktion die M√∂glichkeit behalten, den Spaltennamen zum Sortieren als Variable zu √ºbergeben, habe aber gleichzeitig Standardwerte f√ºr diese Variable.  Hierzu wird die eigent√ºmliche Syntax <strong>dplyr verwendet</strong> , √ºber die Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">hier</a> mehr lesen k√∂nnen. </p><br><p>  In unserem Fall setzen wir beim Definieren der Parameter einer Funktion einen von ihnen auf den Standardwert und <em>zitieren</em> ihn ( <strong>orderColname = quo (Soft_Media_Error)</strong> ) und setzen dann beim Aufruf Zeichen davor <strong>!!</strong>  zu <strong>arrangieren</strong> bekommen <strong>(desc (!! orderColname))</strong> . </p><br><div class="spoiler">  <b class="spoiler_title">Das Erscheinungsbild der Tabelle mit Fehlern f√ºr den Monat</b> <div class="spoiler_text"><pre> <code class="python hljs">&gt; errorsBigPeriod <span class="hljs-comment"><span class="hljs-comment"># A tibble: 77 x 7 cl Storage Disk Hard_SCSI_Bus_E~ Recommend_Disk_~ Soft_Media_Error &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; 1 XclN~ XStora~ 1_1_~ 0 1 64 2 XclN~ XStora~ 0_2_5 0 0 29 3 XclN~ XStora~ 1_1_~ 0 1 29 4 XclN~ XStora~ 0_3_2 0 0 27 5 XclN~ XStora~ 0_3_~ 1 0 25 6 XclN~ XStora~ 1_3_5 0 1 23 7 XclN~ XStora~ 0_2_9 0 0 21 8 XclN~ XStora~ 0_3_4 0 0 14 9 XclN~ XStora~ 0_1_~ 0 0 14 10 XclN~ XStora~ 1_0_1 0 0 12 # ... with 67 more rows, and 1 more variable: Soft_SCSI_Bus_Error &lt;dbl&gt;</span></span></code> </pre> </div></div><br><p>  Ich habe die Bildung des xlsx-Dokuments in dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel √ºber Berichte √ºber den Status der VM</a> analysiert, daher werde ich nicht n√§her darauf eingehen.  Der gesamte Code ist am Ende des Artikels angegeben. </p><br><p><img src="https://habrastorage.org/webt/td/7v/vx/td7vvxmj5guiwtxhjyxif4cany8.jpeg"></p><br><p>  Hier sind wichtige Funktionen, die die Lesbarkeit des Berichts verbessern: </p><br><ul><li>  Signierte Registerkarten (standardm√§√üig ist die interessanteste ge√∂ffnet); </li><li>  Hervorgehobene Spaltennamen </li><li>  Automatische Formatierung aller Spalten, sodass der gesamte Text lesbar ist, ohne dass die Spalten erweitert werden m√ºssen. </li></ul><br><h3 id="6-formiruem-grafik-kotoryy-sohranyaem-v-png">  6. Erstellen Sie einen Zeitplan, den wir in PNG speichern </h3><br><p>  In der Grafik wollte ich die Gesamtzahl der Fehler pro Tag f√ºr alle Speichersysteme nach Typ ermitteln.  Als Zeichenwerkzeug wurde beschlossen, die Standardbibliothek <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">ggplot2 zu</a> verwenden. </p><br><p>  Die erste Version des Diagramms zeigte alle Fehler in einem Diagramm und sah folgenderma√üen aus: </p><br><p><img src="https://habrastorage.org/webt/7t/jc/aj/7tjcajacotjzcoo3y0j9oc2od80.png"></p><br><p>  Kollegen sagten, dass es sich als unlesbar herausstellte. <br><del>  Was w√ºrden sie verstehen? !!!! </del><br>  Die Anmerkungen wurden ber√ºcksichtigt und die Funktion <strong>facet_grid</strong> wurde zu den Standardspalten ( <strong>geom_bar</strong> ) <strong>hinzugef√ºgt</strong> , um das Ergebnis nach <strong>Fehlertyp</strong> in separate Diagramme zu unterteilen. <br>  Das Endergebnis war f√ºr alle geeignet. </p><br><p><img src="https://habrastorage.org/webt/l1/vc/v5/l1vcv5950ji9iymrlyrij0uds3w.png" alt="Zusammenfassender Zeitplan"></p><br><div class="spoiler">  <b class="spoiler_title">Datenaufbereitung, grafische Darstellung, Speichern in Datei</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">####   #### #       errorsTotal &lt;- errors_df %&gt;% group_by(Date, Error) %&gt;% summarise(count = n()) %&gt;% # spread(Error, count, fill = 0) %&gt;% arrange(desc(Date)) #        . #       ,   . plot &lt;- errorsTotal %&gt;% ggplot(aes(x = Date, y = count, fill = Error)) + geom_bar(stat = "identity", width = 0.5, color = "grey") + theme_minimal() + # theme(legend.position="top") + scale_color_grey() + labs(title = "  EMC VNX", subtitle = "        ", fill = " ") + xlab("") + ylab("   ") + scale_fill_brewer(palette = "Spectral") + facet_grid(rows = vars(factor( Error, levels = c( "Soft_SCSI_Bus_Error", "Soft_Media_Error", "Hard_SCSI_Bus_Error", "Recommend_Disk_Replacement" ) ))) # #   # plot #   png,     plot_filePath &lt;- file.path("results", "plot.png") #    png     ggsave(filename = plot_filePath, plot = plot)</span></span></code> </pre> </div></div><br><p>  Von den interessanten in der Bildung des Zeitplans. </p><br><p>  Ich wollte, dass die Charts in einer bestimmten Reihenfolge sind.  Dazu musste der Parameter zum Bilden von Zeilen in <strong>facet_grid</strong> als Faktor bzw. vielmehr als <strong>geordneter Faktor √ºbertragen werden</strong> .  Faktor ist ein solches gerissenes Datenformat in R, das eine Menge von Werten ist (in unserem Fall Zeichenfolgen, d. H. <strong>Zeichen</strong> ), und die Menge dieser Werte ist streng definiert (als Faktorebenen bezeichnet), und selbst diese Ebenen werden sortiert.  Es klingt kompliziert, aber alles passt zusammen, wenn Sie sagen, dass die Namen der Monate ein gutes Beispiel f√ºr einen geordneten Faktor sind.  Das hei√üt,  Wir wissen, welche Namen Monate haben k√∂nnen, und wir wissen auch (nun, ich hoffe), dass zuerst Januar, dann Februar, dann M√§rz usw. kommen.  Nach dem gleichen Prinzip schaffen wir einen Faktor. </p><br><h3 id="7-8-formiruem-pismo-soderzhaschee-sobrannye-dannye-otpravlyaem-pismo">  7-8.  Wir bilden einen Brief mit den gesammelten Daten.  Senden Sie einen Brief </h3><br><p>  Die Bildung und das Senden von Briefen sowie die Bildung von Aufgaben in <strong>Windows Scheduller wurden</strong> ebenfalls in dem Artikel √ºber <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Berichte √ºber den Status der VM</a> ber√ºcksichtigt.  Wir f√ºgen einfach ein paar Variablen in den Text ein und formatieren ihn mehr oder weniger klar.  Vergessen Sie nicht den Anhang. </p><br><div class="spoiler">  <b class="spoiler_title">Die endg√ºltige Form des Briefes</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/w6/rg/fi/w6rgfilewjuf24olnavadpu6zhm.jpeg"></p></div></div><br><h2 id="vyvody">  Schlussfolgerungen </h2><br><p>  <strong>R</strong> erwies sich erneut als universelles Werkzeug zur Ausf√ºhrung allt√§glicher Aufgaben und zur Visualisierung ihrer Ergebnisse.  Und wenn Parallel Computing aktiviert ist, wird dieses Tool auch schnell. <br>  Die Praxis hat auch gezeigt, dass <strong>PowerShell</strong> Protokolle nur sehr langsam analysiert und in ein lesbares Format √ºbersetzt. <br>  Vielen Dank an alle, die bis zum Ende so viele Briefe gelesen haben. </p><br><h4 id="polnostyu-kod-prilozheniya">  Vollst√§ndiger Anwendungscode </h4><br><div class="spoiler">  <b class="spoiler_title">Vollst√§ndiger R-Anwendungscode</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#### ENV #### #         (    system32) setwd("C:\\Scripts\\VNX_disks_check/") #   library(tidyverse) library(lubridate) library(zoo) library(stringi) library(xlsx) library(mailR) library(foreach) library(doParallel) #### CONST #### #            vnxIPfilePath &lt;- file.path("data", "VNX-IP.csv") #     bigPeriod &lt;- Sys.Date() - 30 #     smallPeriod &lt;- Sys.Date() - 3 #    productCls &lt;- c("name1", "name2", "name3") #   IP VNX. #         , #   ip        . VNX_ip &lt;- vnxIPfilePath %&gt;% read_csv2( col_types = cols( Name = col_character(), IP = col_character(), cl = col_character(), type = col_character(), newA = col_character(), newB = col_character(), oldA = col_character(), oldB = col_character() ) ) %&gt;% filter(cl %in% productCls) %&gt;% gather(key = "cntName", value = "cntIP", 5:6) ####    VNX #### #         (      ) # NaviSECCli.exe -scope 0 -h 10.201.16.15 -user root -password Secrt4yo getlog -date 07/16/2019 07/17/2019 #   ,   . #      ,       errorNumbers &lt;- c("\\(820\\)", "\\(803\\)", "\\(801\\)", "\\(920\\)", "\\(901\\)") ##   ## #         numCores &lt;- detectCores() registerDoParallel(numCores) #    ,   NaviCLI #  1    ,     "" , # ..   ,      ,     . bigPeriodForm &lt;- bigPeriod %&gt;% format(format = "%m/%d/%Y") currDateForm &lt;- (Sys.Date() + 1) %&gt;% format(format = "%m/%d/%Y") #    . #      VNX   ip   . #      ,      #   ,      dataframe #  %dopar%   . #    ,   system.time   , #    %dopar%  %do%.      4-5. # system.time({ errors_df &lt;- foreach(i = 1:nrow(VNX_ip), .combine = rbind, .packages = "tidyverse") %dopar% { errors_raw &lt;- system( paste( "NaviSECCli.exe -scope 0 -h", VNX_ip$cntIP[i], "-user myusername -password mypassword getlog -date", bigPeriodForm, currDateForm ), intern = TRUE ) %&gt;% str_subset(pattern = regex(paste0(errorNumbers, collapse = "|"))) #      ,       if (length(errors_raw) &gt; 0) { #       , #     , #       . errorsDescr &lt;- errors_raw %&gt;% gsub("(.*\\) )(.*)(\\s+\\[.*)", "\\2", x = .) %&gt;% trimws() %&gt;% gsub('([[:punct:]])|\\s+', '_', .) #           errors &lt;- errors_raw %&gt;% str_split(pattern = "\\s+", simplify = T) %&gt;% as_tibble() %&gt;% mutate(Disk = paste0(V4, "_", V6, "_", V8) %&gt;% gsub( pattern = "\\([0-9]{3}\\)", replacement = "", x = .) ) #  dataframe    data_frame(cl = VNX_ip$cl[i], Storage = VNX_ip$Name[i], Date = errors$V1 %&gt;% as.Date(format = "%m/%d/%Y"), Time = errors$V2, Disk = errors$Disk, Error = errorsDescr, eCode = errors$V8 %&gt;% str_extract(paste0(errorNumbers, collapse = "|")) %&gt;% str_extract("[0-9]+")) %&gt;% mutate(DateTime = as.POSIXct(paste(Date, Time), format = "%Y-%m-%d %H:%M:%S")) } } # }) #     .      ,    . stopImplicitCluster() ####  #### #    .    ,     .  . # https://dplyr.tidyverse.org/articles/programming.html myErrorStats &lt;- function(data, period, orderColname = quo(Soft_Media_Error)) { data %&gt;% filter(Date &gt; period) %&gt;% group_by(cl, Storage, Disk, Error) %&gt;% summarise(count = n()) %&gt;% spread(Error, count, fill = 0) %&gt;% arrange(desc(!!orderColname)) } #           .  . errorsBigPeriod &lt;- errors_df %&gt;% myErrorStats(bigPeriod) #             errorsSmallPeriod &lt;- errors_df %&gt;% myErrorStats(smallPeriod) #   ,     errors_filePath &lt;- file.path("results", "VNX_Errors.xlsx") ####  xlsx  #### #    wb&lt;-createWorkbook(type="xlsx") #         TABLE_ROWNAMES_STYLE &lt;- CellStyle(wb) + Font(wb, isBold=TRUE) TABLE_COLNAMES_STYLE &lt;- CellStyle(wb) + Font(wb, isBold=TRUE) + Alignment(wrapText=TRUE, horizontal="ALIGN_CENTER") + Border(color="black", position=c("TOP", "BOTTOM"), pen=c("BORDER_THIN", "BORDER_THICK")) #  t s sheetSmall &lt;- createSheet(wb, sheetName = " 3 ") sheetBig &lt;- createSheet(wb, sheetName = " ") sheetRaw &lt;- createSheet(wb, sheetName = " ") ##   addDataFrame( errorsSmallPeriod %&gt;% as.data.frame(), sheetSmall, startRow = 1, startColumn = 1, row.names = FALSE, byrow = FALSE, colnamesStyle = TABLE_COLNAMES_STYLE, rownamesStyle = TABLE_ROWNAMES_STYLE ) addDataFrame( errorsBigPeriod %&gt;% as.data.frame(), sheetBig, startRow = 1, startColumn = 1, row.names = FALSE, byrow = FALSE, colnamesStyle = TABLE_COLNAMES_STYLE, rownamesStyle = TABLE_ROWNAMES_STYLE ) #          DateTime     addDataFrame( errors_df %&gt;% as.data.frame() %&gt;% arrange(desc(DateTime)), sheetRaw, startRow = 1, startColumn = 1, row.names = FALSE, byrow = FALSE, colnamesStyle = TABLE_COLNAMES_STYLE, rownamesStyle = TABLE_ROWNAMES_STYLE ) #  ,     autoSizeColumn(sheet = sheetSmall, colIndex=c(1:ncol(errorsSmallPeriod))) autoSizeColumn(sheet = sheetBig, colIndex=c(1:ncol(errorsBigPeriod))) autoSizeColumn(sheet = sheetRaw, colIndex=c(1:ncol(errors_df))) #     .   - . if (file.exists(errors_filePath)) {file.remove(errors_filePath)} #  xlsx  saveWorkbook(wb, errors_filePath) ####   #### #       errorsTotal &lt;- errors_df %&gt;% group_by(Date, Error) %&gt;% summarise(count = n()) %&gt;% # spread(Error, count, fill = 0) %&gt;% arrange(desc(Date)) #         plot &lt;- errorsTotal %&gt;% ggplot(aes(x = Date, y = count, fill = Error)) + geom_bar(stat = "identity", width = 0.5, color = "grey") + theme_minimal() + # theme(legend.position="top") + scale_color_grey() + labs(title = "  EMC VNX", subtitle = "        ", fill = " ") + xlab("") + ylab("   ") + scale_fill_brewer(palette = "Spectral") + facet_grid(rows = vars(factor( Error, levels = c( "Soft_SCSI_Bus_Error", "Soft_Media_Error", "Hard_SCSI_Bus_Error", "Recommend_Disk_Replacement" ) ))) # #   # plot #   png,     plot_filePath &lt;- file.path("results", "plot.png") #    png     ggsave(filename = plot_filePath, plot = plot) ####    #### #    emailRecepientsList &lt;- c("sendall-tech@domain.ru") #      emailParams &lt;- list( from = "login@domain.ru", to = emailRecepientsList, smtpParams = list( host.name = "10.10.10.1", port = 25, user.name = "login@domain.ru", passwd = "mypassword", ssl = FALSE ) ) #     (    ). #     ,          ,     . errorsTotal &lt;- errorsSmallPeriod[-c(1,2,3)] %&gt;% sum() #    emailBody &lt;- paste0( '&lt;html&gt; &lt;h3&gt; ,  .&lt;/h3&gt; &lt;p&gt;  3    &lt;strong&gt;', errorsTotal, '&lt;/strong&gt;    EMC VNX&lt;/p&gt; &lt;p&gt;       ,      .&lt;/p&gt; &lt;p&gt;  3 : &lt;ul&gt; &lt;li&gt;   3 .   &lt;strong&gt;Soft_Media_Error&lt;/strong&gt;.&lt;/li&gt; &lt;li&gt;  30 .   &lt;strong&gt;Soft_Media_Error&lt;/strong&gt;.&lt;/li&gt; &lt;li&gt; .   &lt;strong&gt;&lt;/strong&gt;.&lt;/li&gt; &lt;/ul&gt;          .   .&lt;/p&gt; &lt;p&gt;&lt;img src="', plot_filePath, '"&gt;&lt;/p&gt; &lt;/html&gt;' ) ####      #### send.mail(from = emailParams$from, to = emailParams$to, subject = "     EMC VNX", body = emailBody, encoding = "utf-8", html = TRUE, inline = TRUE, smtp = emailParams$smtpParams, authenticate = TRUE, send = TRUE, attach.files = c(errors_filePath), debug = FALSE)</span></span></code> </pre> </div></div><br><h2 id="parametry-okruzheniya-i-versii-ispolzuemogo-po">       </h2><br><ul><li> <strong> </strong> : EMC VNX 5300 </li><li> <strong>    </strong> : NaviCLI-Win-32-x86-en_US-7.31.25.1.29-1 </li><li> <strong>  ,    </strong> : 4*2 CPU, 8 Gb RAM </li></ul><br><div class="spoiler"> <b class="spoiler_title">  R</b> <div class="spoiler_text"><pre> <code class="python hljs">&gt; sessionInfo() R version <span class="hljs-number"><span class="hljs-number">3.5</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> (<span class="hljs-number"><span class="hljs-number">2019</span></span><span class="hljs-number"><span class="hljs-number">-03</span></span><span class="hljs-number"><span class="hljs-number">-11</span></span>) Platform: x86_64-w64-mingw32/x64 (<span class="hljs-number"><span class="hljs-number">64</span></span>-bit) Running under: Windows Server <span class="hljs-number"><span class="hljs-number">2012</span></span> R2 x64 (build <span class="hljs-number"><span class="hljs-number">9600</span></span>) Matrix products: default locale: [<span class="hljs-number"><span class="hljs-number">1</span></span>] LC_COLLATE=Russian_Russia<span class="hljs-number"><span class="hljs-number">.1251</span></span> LC_CTYPE=Russian_Russia<span class="hljs-number"><span class="hljs-number">.1251</span></span> LC_MONETARY=Russian_Russia<span class="hljs-number"><span class="hljs-number">.1251</span></span> [<span class="hljs-number"><span class="hljs-number">4</span></span>] LC_NUMERIC=C LC_TIME=Russian_Russia<span class="hljs-number"><span class="hljs-number">.1251</span></span> attached base packages: [<span class="hljs-number"><span class="hljs-number">1</span></span>] parallel stats graphics grDevices utils datasets methods base other attached packages: [<span class="hljs-number"><span class="hljs-number">1</span></span>] taskscheduleR_1<span class="hljs-number"><span class="hljs-number">.4</span></span> pander_0<span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> doParallel_1<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.14</span></span> iterators_1<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> foreach_1<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> mailR_0<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> [<span class="hljs-number"><span class="hljs-number">7</span></span>] xlsx_0<span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> stringi_1<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> zoo_1<span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">-6</span></span> lubridate_1<span class="hljs-number"><span class="hljs-number">.7</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> wesanderson_0<span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span> forcats_0<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> [<span class="hljs-number"><span class="hljs-number">13</span></span>] stringr_1<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> dplyr_0<span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> purrr_0<span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> readr_1<span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> tidyr_0<span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> tibble_2<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> [<span class="hljs-number"><span class="hljs-number">19</span></span>] ggplot2_3<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> tidyverse_1<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> loaded via a namespace (<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> attached): [<span class="hljs-number"><span class="hljs-number">1</span></span>] tidyselect_0<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> reshape2_1<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> rJava_0<span class="hljs-number"><span class="hljs-number">.9</span></span><span class="hljs-number"><span class="hljs-number">-11</span></span> haven_2<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> lattice_0<span class="hljs-number"><span class="hljs-number">.20</span></span><span class="hljs-number"><span class="hljs-number">-38</span></span> colorspace_1<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span> [<span class="hljs-number"><span class="hljs-number">7</span></span>] vctrs_0<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> generics_0<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> utf8_1<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> rlang_0<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> R.oo_1<span class="hljs-number"><span class="hljs-number">.22</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> pillar_1<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> [<span class="hljs-number"><span class="hljs-number">13</span></span>] glue_1<span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> withr_2<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> R.utils_2<span class="hljs-number"><span class="hljs-number">.9</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> RColorBrewer_1<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span> modelr_0<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> readxl_1<span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> [<span class="hljs-number"><span class="hljs-number">19</span></span>] plyr_1<span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> munsell_0<span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> gtable_0<span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> cellranger_1<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> rvest_0<span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> R.methodsS3_1<span class="hljs-number"><span class="hljs-number">.7</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> [<span class="hljs-number"><span class="hljs-number">25</span></span>] codetools_0<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">-16</span></span> labeling_0<span class="hljs-number"><span class="hljs-number">.3</span></span> fansi_0<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> xlsxjars_0<span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> broom_0<span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> Rcpp_1<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> [<span class="hljs-number"><span class="hljs-number">31</span></span>] scales_1<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> backports_1<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> jsonlite_1<span class="hljs-number"><span class="hljs-number">.6</span></span> digest_0<span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.20</span></span> hms_0<span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> grid_3<span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> [<span class="hljs-number"><span class="hljs-number">37</span></span>] cli_1<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> tools_3<span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> magrittr_1<span class="hljs-number"><span class="hljs-number">.5</span></span> lazyeval_0<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> crayon_1<span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> pkgconfig_2<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> [<span class="hljs-number"><span class="hljs-number">43</span></span>] zeallot_0<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> data.table_1<span class="hljs-number"><span class="hljs-number">.12</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> xml2_1<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> assertthat_0<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> httr_1<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> rstudioapi_0<span class="hljs-number"><span class="hljs-number">.10</span></span> [<span class="hljs-number"><span class="hljs-number">49</span></span>] R6_2<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> nlme_3<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">-137</span></span> compiler_3<span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span></code> </pre> </div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de461441/">https://habr.com/ru/post/de461441/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de461431/index.html">"Liebt und mag nicht": DNS √ºber HTTPS</a></li>
<li><a href="../de461433/index.html">Verwenden von Identity Server 4 in Net Core 3.0</a></li>
<li><a href="../de461435/index.html">Emotionserkennung unter Verwendung eines Faltungs-Neuronalen Netzwerks</a></li>
<li><a href="../de461437/index.html">370 Gl√ºhbirnen</a></li>
<li><a href="../de461439/index.html">Starten der React- und TypeScript-Komponentenbibliothek</a></li>
<li><a href="../de461443/index.html">Nachanalyse: Was ist √ºber den j√ºngsten Angriff auf das SKS Keyserver-Kryptoschl√ºsselservernetzwerk bekannt?</a></li>
<li><a href="../de461447/index.html">Das Epos √ºber Systemadministratoren als gef√§hrdete Spezies</a></li>
<li><a href="../de461449/index.html">PhpStorm 2019.2: Typisierte PHP 7.4-Eigenschaften, doppelter Finder, EditorConfig, Shell-Skripte und mehr</a></li>
<li><a href="../de461451/index.html">Mein zweiter Tag mit Haiku: begeistert, aber noch nicht bereit zu gehen</a></li>
<li><a href="../de461453/index.html">Baikonur-Abenteuer: Raketen, Astronauten, Start der Union MS-13 und Weltraum-Internet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>