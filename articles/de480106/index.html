<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïå üïû ü§òüèæ So stellen Sie ein Oracle DB-Image f√ºr Testcontainer zusammen üßòüèΩ üë©üèΩ üßõüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Der Code sollte auf dem DBMS getestet werden, mit dem er funktioniert. Testcontainers ist eine Bibliothek, mit der Sie nahezu jedes DBMS in Komponente...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>So stellen Sie ein Oracle DB-Image f√ºr Testcontainer zusammen</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/480106/"><p>  Der Code sollte auf dem DBMS getestet werden, mit dem er funktioniert.  Testcontainers ist eine Bibliothek, mit der Sie nahezu jedes DBMS in Komponententests genauso einfach verwenden k√∂nnen wie eingebettete Datenbanken wie HSQLDB oder H2.  Es w√ºrde nur ein Docker-Image geben </p><br><img src="https://habrastorage.org/webt/hn/x3/ho/hnx3hojiqvya8flignz-mqkrk6s.jpeg"><br><p>  Dieser Artikel befasst sich mit der Erstellung eines Docker-Images, das f√ºr die Verwendung mit Testcontainern geeignet ist.  Als ich versuchte, es zu schaffen, hatte ich Probleme und hier teile ich meine L√∂sung. <br>  Ich werde das Image f√ºr Oracle 11 sammeln, da es klein ist und ich genug Version 11 habe.  Bei anderen Versionen ist der Ansatz ungef√§hr gleich. </p><br><p>  Um zu verdeutlichen, wie das Image verwendet wird, wird auch Java-Code bereitgestellt, der die Verwendung des Images zum Testen von Spring Boot-Anwendungen demonstriert.  Die Methode zum Verbinden mit Testcontainern, die ich angegeben habe, ist wahrscheinlich nicht die beste.  Zun√§chst zeigt er jedoch, wie die beim Erstellen des Abbilds festgelegten Einstellungen verwendet werden.  Zweitens ist es einfach.  Und drittens ist es fast nicht an Spring gebunden, es kann sogar in Java-Code stecken bleiben, in dem es nichts als √∂ffentliche statische Leerstellen gibt. </p><br><p>  Es wird davon ausgegangen, dass der Leser mit Docker und Testcontanern oberfl√§chlich vertraut ist und auch Java gut kennt.  Zum Erstellen m√ºssen Sie Linux verwenden. Wenn Sie unter Windows erstellen, m√ºssen Sie msys2 oder √§hnliches verwenden. </p><br><p>  Der Demo-Code wird hier auf den Github hochgeladen. <a href="https://github.com/poxu/testcontainers-spring-demo" rel="nofollow">Https://github.com/poxu/testcontainers-spring-demo</a> Korrigierte Skripte zum Zusammenstellen des Bildes finden Sie in meinem Fork der Oraklov-Anleitung. <a href="https://github.com/poxu/docker-images/tree/master/OracleDatabase/SingleInstance" rel="nofollow">Https://github.com/poxu/docker-images/tree/ master / OracleDatabase / SingleInstance</a> </p><a name="habracut"></a><br><h1>  Erstellen Sie ein Docker-Image </h1><br><p>  Oracle stellt keine Bilder f√ºr Docker zur Verf√ºgung, hat jedoch detaillierte Anweisungen zur Montage auf dem Github ver√∂ffentlicht. </p><br><p>  Leider ist es nicht m√∂glich, diese Images in Testcontainern als zu verwenden, da der Container, der von diesem Image gestartet wird, zwischen zwei und 20 Minuten startet. </p><br><p>  Dies ist f√ºr die Verwendung in Komponententests nicht akzeptabel. Daher m√ºssen Sie Ihre eigenen √Ñnderungen an den Skripten vornehmen. Zun√§chst ist es jedoch besser, den Container gem√§√ü den Anweisungen von Oracle zusammenzustellen.  Ich werde hier kurz nacherz√§hlen. Eine ausf√ºhrlichere Anleitung finden Sie unter folgendem Link: <a href="https://github.com/oracle/docker-images/tree/master/OracleDatabase/SingleInstance" rel="nofollow">https://github.com/oracle/docker-images/tree/master/OracleDatabase/SingleInstance</a> </p><br><h2>  Image-Zusammenstellung nach Anleitung von Oracle </h2><br><p>  Zun√§chst m√ºssen Sie das Repository mit Anweisungen zum Zusammenstellen des Images klonen. </p><br><pre><code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/oracle/docker-images.git</code> </pre> <br><p>  Dann besorgen Sie sich das RPM-Paket f√ºr die autorisierte Express-Version von Oracle 11.2.0.2. Es ist nicht sehr schwierig, Sie m√ºssen sich lediglich auf der Oracle-Website registrieren, die Oracle DBMS-Downloadseite aufrufen, dort die Version 11.2.0.2 XE ausw√§hlen und die gepackte RPM-Datei oracle-xe-11.2.0 herunterladen -1.0.x86 ~ 64 ~ .rpm.zip. </p><br><p>  Legen Sie die Datei im heruntergeladenen Git-Repository im Verzeichnis docker-images / OracleDatabase / SingleInstance / dockerfiles / 11.2.0.2 / ab. </p><br><p>  Wechseln Sie als N√§chstes in das Verzeichnis docker-images / OracleDatabase / SingleInstance / dockerfiles und f√ºhren Sie den Befehl aus </p><br><pre> <code class="bash hljs">./buildDockerImage.sh -v 11.2.0.2 -x</code> </pre> <br><p>  Der Docker stellt ein Bild mit dem Namen oracle / database: 11.2.0.2-xe zusammen, auf dessen Grundlage Sie den Container mit diesem Befehl erstellen m√ºssen </p><br><pre> <code class="bash hljs">docker run --rm --name vanilla_oracle_test_habr \ -p 1234:1521 \ -p 5678:5500 \ -e ORACLE_PWD=123 \ --shm-size=<span class="hljs-string"><span class="hljs-string">"1g"</span></span> \ oracle/database:11.2.0.2-xe</code> </pre> <br><p>  Der Container startet einige Minuten, da nach dem Start eine neue Datenbank erstellt wird und dieser Vorgang nicht schnell ist. </p><br><p>  Nach einigen Minuten erscheint ein Banner in der Konsole </p><br><blockquote>  ############################ <br>  DATENBANK IST BEREIT! <br>  ############################ </blockquote><p>  Danach k√∂nnen Sie mit dem SYSTEM-Login eine Verbindung zur Datenbank herstellen, das Passwort lautet 123, die Verbindungsadresse lautet localhost und die SID lautet XE. </p><br><p>  Wenn alles geklappt hat, k√∂nnen Sie mit dem Erstellen eines Images unter Testcontainern fortfahren.  Wenn nicht, ist es besser, zuerst das Handbuch von Oracle zu lesen und herauszufinden, was nicht stimmt. </p><br><p>  Wie wir bereits festgestellt haben, startet der Container lange, da nach dem Start eine Datenbank erstellt wird.  In einigen F√§llen mag dies wahrscheinlich praktisch sein, aber jetzt verursacht dies v√∂lligen Schaden.  Der Container muss sofort nach dem Start einsatzbereit sein. </p><br><h2>  Manuelle Bildveredelung </h2><br><p>  Eine M√∂glichkeit, das Bild aus der fertigen Datenbank abzurufen, besteht darin, zu warten, bis der Container startet und die Erstellung der Datenbank abgeschlossen ist, und dann den Container in einem neuen Bild zu speichern. </p><br><p>  Es ist nur wichtig, den Container nicht mit dem Argument --rm zu starten, da der Docker ihn sonst sofort nach dem Stoppen schl√§gt. </p><br><pre> <code class="bash hljs">docker commit --message <span class="hljs-string"><span class="hljs-string">"container for unit tests"</span></span> &lt;container id&gt; my/oracle-11.2.0.2-for-unit-tests</code> </pre> <br><p>  Dadurch wird ein neues Image aus dem Container erstellt, das nicht nur einige Minuten, sondern 20 - 30 Sekunden lang gestartet wird. </p><br><h2>  √Ñnderung des Image-Assemblierungsprozesses, um ein fertiges Image unmittelbar nach dem Zusammenbau zu erhalten </h2><br><p>  Nat√ºrlich ist es gut, Anweisungen zum Zusammenstellen des Abbilds in Form von Code zu haben, damit Sie die Zusammenstellung mit einem Befehl starten k√∂nnen und nicht warten m√ºssen, bis der Container gestartet ist und ein Abbild basierend auf diesem mit Ihren H√§nden erstellen kann. </p><br><p>  Die letzte Zeile der Andockdatei gibt den Befehl an, der nach dem Start ausgef√ºhrt wird </p><br><pre> <code class="bash hljs">CMD <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> <span class="hljs-variable"><span class="hljs-variable">$ORACLE_BASE</span></span>/<span class="hljs-variable"><span class="hljs-variable">$RUN_FILE</span></span></code> </pre> <br><p>  \ $ ORACLE ~ BASE ~ / \ $ RUN ~ FILE ~ verweist auf die Datei docker-images / OracleDatabase / SingleInstance / dockerfiles / 11.2.0.2 / runOracle.sh </p><br><p>  Wenn Sie diesen Container stoppen und dann erneut ausf√ºhren, erstellt das Skript die Datenbank zum ersten Mal und startet sie beim zweiten Mal einfach.  Es kann davon ausgegangen werden, dass das Image aus der bereits erstellten Datenbank zusammengesetzt wird, wenn Sie das Skript in der Phase der Image-Montage ausf√ºhren. </p><br><p>  Auf dem Weg zur Umsetzung dieses mutigen Plans entsteht jedoch eine Komplikation. </p><br><p>  Das Skript wird f√ºr immer ausgef√ºhrt, dh bis ein Signal im Container eintrifft, dass die Arbeit abgeschlossen werden muss.  Das ist ganz einfach gel√∂st.  Die letzte Zeile der Datei runOracle.sh enth√§lt den Befehl wait.  Wir wissen, dass Sie in der Montagephase nicht auf irgendetwas warten m√ºssen, sondern die Arbeit beenden m√ºssen, und deshalb werden wir eine bedingte Anweisung in das Skript einf√ºgen. </p><br><p>  Es wird √ºberpr√ºft, ob das Argument --running-while-building nicht an die Datei √ºbergeben wird. Wenn dieses Argument √ºbergeben wird, warten Sie nicht auf Signale, sondern unterbrechen Sie einfach die Arbeit.  Das hei√üt, mach das so: </p><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">"--running-while-building"</span></span> ] <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wait</span></span> <span class="hljs-variable"><span class="hljs-variable">$childPID</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre> <br><p>  Nun, in der Docker-Datei f√ºgen wir einen weiteren Skriptaufruf nur in der Assembler-Phase hinzu.  Es wird sich so herausstellen. </p><br><pre> <code class="bash hljs">RUN <span class="hljs-variable"><span class="hljs-variable">$ORACLE_BASE</span></span>/<span class="hljs-variable"><span class="hljs-variable">$RUN_FILE</span></span> --running-while-building CMD <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> <span class="hljs-variable"><span class="hljs-variable">$ORACLE_BASE</span></span>/<span class="hljs-variable"><span class="hljs-variable">$RUN_FILE</span></span></code> </pre> <br><h2>  √Ñnderungen, die zur Verwendung beim Testen erforderlich sind </h2><br><h3 id="ustranit-ispolzovanie-tomov">  Vermeiden Sie die Verwendung von Volumen </h3><br><p>  Muss die Linie finden </p><br><blockquote>  VOLUME ["\ $ ORACLE ~ BASE ~ / oradata"] </blockquote><p>  Und kommentiere es.  Die Verwendung von Volumes ist nicht erforderlich, da alle √Ñnderungen nach jedem Testlauf √ºbernommen werden. Beim Kopieren von Bildern k√∂nnen jedoch Probleme mit der Verwendung von Volumes auftreten. </p><br><h3 id="udalit-nenuzhnye-fayly">  L√∂schen Sie nicht ben√∂tigte Dateien </h3><br><p>  M√ºssen Zeilen hinzuf√ºgen </p><br><pre> <code class="bash hljs">rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/demo &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/jdbc &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/jlib &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/md &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/nls/demo &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/odbc &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/rdbms/jlib &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/rdbms/public &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/rdbms/demo &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/bin/rman &amp;&amp; \</code> </pre> <br><p>  Kurz vor der Linie </p><br><pre> <code class="bash hljs">chmod ug+x <span class="hljs-variable"><span class="hljs-variable">$ORACLE_BASE</span></span>/*.sh</code> </pre> <br><p>  Dadurch werden alle Dateien aus dem Image entfernt, die nicht zu Testzwecken ben√∂tigt werden.  Je kleiner das Bild, desto besser. </p><br><h3 id="ubrat-razbienie-obraza-na-sloi">  Entfernen Sie die Bildteilung </h3><br><p>  Um das Bild zu verkleinern, m√ºssen Sie es mit dem <strong>Squash-</strong> Argument erstellen.  Dadurch wird die Trennung in Ebenen aus dem Bild entfernt, wodurch das Volumen weiter verringert wird.  Das Squash-Argument ist experimentell, Sie m√ºssen es also separat aktivieren.  In verschiedenen Betriebssystemen wird dies auf unterschiedliche Weise durchgef√ºhrt. </p><br><p>  Um Argumente an den Docker weiterzuleiten, stellt docker-images / OracleDatabase / SingleInstance / dockerfiles / buildDockerImage.sh das Argument -o bereit.  Das hei√üt, um das Argument --squash an den Docker weiterzuleiten, m√ºssen Sie buildDockerImage.sh folgenderma√üen aufrufen </p><br><pre> <code class="bash hljs">./buildDockerImage.sh -o <span class="hljs-string"><span class="hljs-string">'--squash'</span></span></code> </pre> <br><h3 id="pomenyat-nazvanie-obraza">  Bildnamen √§ndern </h3><br><p>  Bisher unterscheidet sich das Image erheblich von dem, was Oracle vorschl√§gt. Daher muss es umbenannt werden.  Dazu m√ºssen Sie bereits die Datei buildDockerImage.sh selbst bearbeiten. Das Skript √ºbernimmt den Namen des Bildes aus der Variablen IMAGE ~ NAME ~, deren Wert direkt in der Datei festgelegt wird </p><br><p>  Genau hier </p><br><pre> <code class="plaintext hljs"># Oracle Database Image Name IMAGE_NAME="oracle/database:$VERSION-$EDITION"</code> </pre> <br><p>  Ich wechselte zu </p><br><pre> <code class="plaintext hljs"># Oracle Database Image Name IMAGE_NAME="my/oracle-for-habr:$VERSION-$EDITION"</code> </pre> <br><h3 id="zadat-parol-k-bd">  Legen Sie das DB-Passwort fest </h3><br><p>  Dieses Passwort wird beim ersten Start des Containers in der Umgebungsvariablen ORACLE ~ PWD ~ festgelegt.  Da die Datenbank jedoch w√§hrend der Image-Erstellung eingerichtet wird, muss die Variable zu diesem Zeitpunkt definiert werden.  Wenn die M√∂glichkeit zum Festlegen eines Kennworts f√ºr jede Assembly √ºber die Befehlszeile nicht erforderlich ist, k√∂nnen Sie es einfach in die Docker-Datei eingeben: </p><br><pre> <code class="plaintext hljs">ENV ORACLE_PWD=123</code> </pre> <br><p>  Wenn Sie in der Lage sein m√ºssen, das Kennwort bei jedem Build erneut zu ermitteln, k√∂nnen Sie -o erneut verwenden, um das Argument an den Docker weiterzuleiten </p><br><pre> <code class="bash hljs">./buildDockerImage.sh -v 11.2.0.2 -x -o <span class="hljs-string"><span class="hljs-string">'--squash --build-arg ORACLE_PWD=123'</span></span></code> </pre> <br><p>  Dadurch wird die Umgebungsvariable ORACLE ~ PWD ~ in die Docker-Datei √ºbertragen, aber die Docker-Datei √ºbergibt sie nicht an Skripten, die w√§hrend der Erstellung ausgef√ºhrt werden.  Dazu m√ºssen Sie die ARG-Anweisung zur Docking-Datei hinzuf√ºgen. </p><br><pre> <code class="plaintext hljs">ARG ORACLE_PWD=default</code> </pre> <br><p>  Das Passwort, wie es wahrscheinlich bereits klar geworden ist, lautet 123. Wenn Sie ORACLE ~ PWD ~ nicht an buildDockerImage.sh √ºbergeben, ist es das Standardkennwort. </p><br><p>  Manchmal glaubt Oracle, dass das Kennwort falsch ist und nicht funktionieren soll. Daher muss 123 m√∂glicherweise durch etwas anderes ersetzt werden </p><br><h2>  Testen Sie das resultierende Bild </h2><br><p>  Jetzt k√∂nnen Sie versuchen, den Container basierend auf dem Image auszuf√ºhren </p><br><pre> <code class="bash hljs">docker run --rm --name dockertest_habr \ -p 1234:1521 \ -p 5678:5500 \ --shm-size=<span class="hljs-string"><span class="hljs-string">"1g"</span></span> \ my/oracle-for-habr:11.2.0.2-xe</code> </pre> <br><p>  Das Argument --shm-size = "1g" ist hier wichtig, ohne das der Container startet, aber Oracle 11.2.0.2 selbst kann nicht funktionieren.  Dies bedeutet f√ºr alle F√§lle nicht, dass der Container ein Gigabyte RAM ben√∂tigt, sondern etwa 100 Megabyte. </p><br><p>  Wenn der Container normal gestiegen ist, k√∂nnen Sie versuchen, eine Verbindung mit der Datenbank herzustellen, die sich dort befindet. </p><br><p>  Basisadresse - wahrscheinlich localhost <br>  Port - 1234 <br>  Benutzer - SYSTEM <br>  Passwort - 123 </p><br><p>  Wenn es normal startet, k√∂nnen Sie mit dem n√§chsten Schritt fortfahren. </p><br><h2>  DB-Initialisierungsskript </h2><br><p>  Damit das Programm √ºber das Bild mit der Datenbank arbeiten kann, muss nach dem Start eine Schaltung vorhanden sein.  Sie k√∂nnen diese Schaltung in der Erstellungsphase erstellen, aber ich bevorzuge es, wenn der Container gestartet wird. </p><br><p>  Nach dem Start sucht der Container im Verzeichnis <em>u01 / app / oracle / scripts / startup</em> und f√ºhrt alle dort gefundenen SQL-Skripte aus, die Sie verwenden k√∂nnen, indem Sie die Datei dort ablegen, die die Schaltung erstellt.  So √§hnlich. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> TEST_USER <span class="hljs-keyword"><span class="hljs-keyword">IDENTIFIED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> passwordnoquotes; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> TEST_USER <span class="hljs-keyword"><span class="hljs-keyword">QUOTA</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unlimited</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SYSTEM</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SESSION</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONNECT</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">RESOURCE</span></span>, DBA <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> TEST_USER; <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">PRIVILEGES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> TEST_USER;</code> </pre> <br><p>  All dies muss der Datei init ~ db ~ .sql hinzugef√ºgt werden, und die Datei wird mit -v in den Container geworfen </p><br><pre> <code class="bash hljs">docker run --rm --name dockertest_habr \ -p 1234:1521 \ -p 5678:5500 \ -e ORACLE_PWD=123 \ -v <span class="hljs-variable"><span class="hljs-variable">${PWD}</span></span>/init_db.sql:/u01/app/oracle/scripts/startup/init_db.sql \ --shm-size=<span class="hljs-string"><span class="hljs-string">"1g"</span></span> \ my/oracle-for-habr:11.2.0.2-xe</code> </pre> <br><p>  \ $ {PWD} Hier wird es verwendet, weil der absolute Pfad zur Datei ben√∂tigt wird. Wenn Sie Windows verwenden, m√ºssen Sie ihn irgendwie anders angeben.  Wenn nach dem Start das Schema TEST ~ USER ~ erfolgreich erstellt wurde, k√∂nnen Sie den neu erstellten Container mit den Tests verbinden. </p><br><h1>  Verwenden eines Bildes in Java-Code </h1><br><p>  Beim Testen mit der integrierten Datenbank tritt in der Regel dasselbe Problem auf.  Wenn die Konfiguration nicht aus dem Cache √ºbernommen werden kann, sammelt Spring sie erneut.  Insbesondere wird die integrierte Datenbank neu erstellt, was die Tests nat√ºrlich erheblich verlangsamt.  Ich habe das Problem mit brachialer Gewalt gel√∂st, indem ich das Containerhebeteil einfach zu einem Singleton gemacht habe.  Wirklich, Wohnung. </p><br><p>  F√ºr Oracle XE verf√ºgt Testcontainers √ºber eine speziell vorbereitete Klasse.  Zuallererst wei√ü diese Klasse, dass es sich um einen Container mit einem DBMS handelt und dass wir versuchen m√ºssen, mit jdbc eine Verbindung zur Datenbank herzustellen, um festzustellen, ob dieser Container ausgel√∂st wird. </p><br><p>  Ein Objekt dieser Klasse wartet darauf, dass der Container von selbst gehoben wird. Sie m√ºssen ihm nur mitteilen, welche Protokolle mit dem Kennwort verwendet werden sollen. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.testcontainers.containers.BindMode; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.testcontainers.containers.OracleContainer; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StaticOracleContainer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> OracleContainer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getContainer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LazyOracleContainer.ORACLE_CONTAINER; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LazyOracleContainer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> OracleContainer ORACLE_CONTAINER = makeContainer(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> OracleContainer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeContainer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//       testcontainers.properties //  oracle.container.image final var dockerImageName = "my/oracle-for-habr"; final var container = new OracleContainer(dockerImageName) //    ,  testcontainers //  ,  ,  //   .withUsername("SYSTEM").withPassword("123") // ,  testcontainers  //     .withExposedPorts(1521, 5500) //      shared memory //    .withSharedMemorySize(2147483648L) //   ,       // -v /path/to/init_db.sql:/u01/app/oracle/scripts/startup/init_db.sql //    init_db.sql   .withClasspathResourceMapping("init_db.sql" , "/u01/app/oracle/scripts/startup/init_db.sql" , BindMode.READ_ONLY); container.start(); return container; } } }</span></span></code> </pre> <br><p>  Au√üerdem ordnen Testcontainer beim Starten die internen Ports des Containers zuf√§llig definierten nicht belegten externen Ports zu.  Daher kann man nicht bef√ºrchten, dass der Container nicht aufsteigt, da der Port bereits von jemandem benutzt wird.  Ein externer Port kann mit der Methode getOraclePort () aus dem Container abgerufen werden. </p><br><p>  Sie k√∂nnen die Containeradresse auch mit der Methode getContainerIpAddress () abrufen, aber jeder Container verf√ºgt √ºber diese Methode. </p><br><p>  Nach dem ersten Aufruf der Methode getContainer wird der Container nicht neu erstellt, sondern der vorhandene zur√ºckgegeben.  Diese Methode kann jetzt in Bare Java oder in der Spring-Konfiguration verwendet werden, um ein Objekt mit einem Container abzurufen, aus dem Sie die Ports und die Adresse f√ºr die Verbindung abrufen k√∂nnen. </p><br><p>  Sie k√∂nnen beispielsweise einen Initialisierer erstellen, der beim Erh√∂hen des Kontexts die Federattribute √ºberschreibt, die f√ºr die Verbindung mit der Datenbank verantwortlich sind. </p><br><h2>  Klasse zum Befestigen von Testcontainern an Spring </h2><br><p>  Nach dem Ausl√∂sen des Containers √ºberschreibt der Initialisierer die Eigenschaften, die f√ºr die URL f√ºr die Verbindung mit der Datenbank, die Anmeldung, das Kennwort und all das verantwortlich sind. </p><br><p>  Wenn es jedoch in application.properties keine Einstellung evilcorp.testcontainers.enabled gibt, wird der Container nicht angehoben und alles funktioniert so, als ob niemand Testcontainer angeschlossen h√§tte. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.evilcorp.demo; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.platform.commons.logging.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.platform.commons.logging.LoggerFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.test.util.TestPropertyValues; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.ApplicationContextInitializer; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.ConfigurableApplicationContext; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.testcontainers.containers.OracleContainer; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestcontainersInitializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationContextInitializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfigurableApplicationContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Logger log = LoggerFactory.getLogger(TestcontainersInitializer.class); <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableApplicationContext applicationContext)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ,   Testcontainers final String testcontainersEnabled = applicationContext.getEnvironment().getProperty("evilcorp.testcontainers.enabled"); if (!"true".equals(testcontainersEnabled)) { return; } OracleContainer oracleContainer = StaticOracleContainer.getContainer(); oracleContainer.followOutput(s -&gt; log.debug(() -&gt; s.getUtf8String())); // IP       //  ,    // (linux, MacOs, Windows  ) , //    oracleContainer.getContainerIpAddress() //    // // Testcontainers     //   ,    oracleContainer.getOraclePort() //  ,         final String jdbcUrl = "jdbc:oracle:thin:@//" + oracleContainer.getContainerIpAddress() + ":" + oracleContainer.getOraclePort() + "/XE"; //      init_db.sql //      final String user = "TEST_USER"; final String password = "passwordnoquotes"; TestPropertyValues.of( "spring.jpa.properties.hibernate.default_schema=" + user, "spring.datasource.driver-class-name=oracle.jdbc.OracleDriver", "spring.jpa.database-platform=org.hibernate.dialect.Oracle10gDialect", "spring.datasource.username=" + user, "spring.datasource.password=" + password, "spring.datasource.url=" + jdbcUrl, "spring.liquibase.url=" + jdbcUrl, "spring.liquibase.user=" + user, "spring.liquibase.password=" + password ).applyTo(applicationContext.getEnvironment(), TestPropertyValues.Type.MAP, "test"); } }</span></span></code> </pre> <br><p>  Diese Konfiguration kann im Spring-Boot-Test verwendet werden, um die Datenbankeinstellungen im laufenden Betrieb zu √ºberschreiben. </p><br><h2>  Testen Sie mit Testcontainern </h2><br><p>  Der Test schreibt einfach ein Objekt in die Datenbank und liest es dann, nichts Besonderes. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.evilcorp.demo; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.evilcorp.demo.entity.User; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.jupiter.api.BeforeEach; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.jupiter.api.Test; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.annotation.Autowired; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.test.context.SpringBootTest; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.test.context.ContextConfiguration; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Optional; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> org.junit.jupiter.api.Assertions.assertEquals; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> org.junit.jupiter.api.Assertions.assertNotNull; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> org.junit.jupiter.api.Assertions.assertNotSame; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> org.junit.jupiter.api.Assertions.assertTrue; <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-meta"><span class="hljs-meta">@ContextConfiguration</span></span>(initializers = {TestcontainersInitializer.class}) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestcontainersSpringDemoApplicationTests</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> UserRepository userRepository; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> User createdUser; <span class="hljs-meta"><span class="hljs-meta">@BeforeEach</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ createdUser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(); createdUser.setName(<span class="hljs-string"><span class="hljs-string">"Fry"</span></span>); userRepository.save(createdUser); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">userRepositoryLoaded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ assertNotNull(userRepository); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">userAdded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Optional&lt;User&gt; loadedUser = userRepository.findById(createdUser.getUserId()); assertTrue(loadedUser.isPresent()); assertEquals(<span class="hljs-string"><span class="hljs-string">"Fry"</span></span>, loadedUser.get().getName()); assertNotSame(createdUser, loadedUser.get()); } }</code> </pre> <br><p>  Und ja, f√ºgen Sie Abh√§ngigkeiten zu pom.xml hinzu </p><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.testcontainers<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>testcontainers<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.12.3<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span>test<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.testcontainers<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>oracle-xe<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.12.3<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span>test<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Auf diese Weise k√∂nnen Sie ein Oracle DBMS-Docker-Image erstellen und in Java-Code verwenden.  Es bleibt nur, das Bild in das Unternehmens-Repository f√ºr Artefakte zu stellen und den Start der Tests in einem anderen Docker-Container zu arrangieren.  Aber das ist eine ganz andere Geschichte. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de480106/">https://habr.com/ru/post/de480106/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de480096/index.html">Ende der Kindheit: Urheberrecht an Werken k√ºnstlicher Intelligenz (KI)</a></li>
<li><a href="../de480098/index.html">JH Regenwasser "Wie man Katzen weidet": auf der anderen Seite der Entwicklung</a></li>
<li><a href="../de480100/index.html">Anf√§nger √ºber SEO</a></li>
<li><a href="../de480102/index.html">November Product Management Digest</a></li>
<li><a href="../de480104/index.html">9 n√ºtzliche HTML-Tricks</a></li>
<li><a href="../de480108/index.html">Physik in einem Unity-Projekt am Beispiel des Mobile Fighting</a></li>
<li><a href="../de480110/index.html">uMCPIno: Schreiben eines einfachen Protokolls mit garantierter Zustellung f√ºr Arduino</a></li>
<li><a href="../de480112/index.html">Unterschiede zwischen C ++ / Visual Basic und Java auf allgemeiner Ebene (f√ºr Anf√§nger und Studenten)</a></li>
<li><a href="../de480114/index.html">Alles √ºber Steuern f√ºr IT-Freiberufler. IE und selbst√§ndig. Teil 1</a></li>
<li><a href="../de480116/index.html">Die Position der Mail.ru-Gruppe zur Entwicklung von Open Source in Russland</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>