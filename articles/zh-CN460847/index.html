<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ´ ğŸ¤¦ğŸ½ ğŸ’  1230ä¸‡ä¸ªå¹¶å‘WebSocket ğŸ“’ ğŸ‘ŒğŸ¾ ğŸ†</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å…³äºWebSocketsçš„ä¸€ä»¶äº‹æ˜¯ï¼Œæ‚¨éœ€è¦åœ¨å®¢æˆ·ç«¯ä¸Šæä¾›å¤§é‡èµ„æºæ¥ç”Ÿæˆè¶³å¤Ÿé«˜çš„è´Ÿè½½ï¼Œä»¥ä½¿æœåŠ¡å™¨å®é™…ä¸Šè€—å°½æ‰€æœ‰CPUèµ„æºã€‚ 


 æ‚¨å¿…é¡»å…‹æœå‡ ä¸ªæŒ‘æˆ˜ï¼Œå› ä¸ºWebSocketsåè®®åœ¨å®¢æˆ·ç«¯æ¯”åœ¨æœåŠ¡å™¨ç«¯å¯¹CPUçš„è¦æ±‚æ›´é«˜ã€‚ åŒæ—¶ï¼Œå¦‚æœæ‚¨æœ‰æ•°ç™¾ä¸‡ä¸ªæ‰“å¼€çš„è¿æ¥ï¼Œåˆ™éœ€è¦å¤§é‡RAMæ¥å­˜å‚¨æœ‰å…³æ‰“å¼€çš„è¿æ¥çš„ä¿¡æ¯ã€‚ ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>1230ä¸‡ä¸ªå¹¶å‘WebSocket</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460847/"><p> å…³äºWebSocketsçš„ä¸€ä»¶äº‹æ˜¯ï¼Œæ‚¨éœ€è¦åœ¨å®¢æˆ·ç«¯ä¸Šæä¾›å¤§é‡èµ„æºæ¥ç”Ÿæˆè¶³å¤Ÿé«˜çš„è´Ÿè½½ï¼Œä»¥ä½¿æœåŠ¡å™¨å®é™…ä¸Šè€—å°½æ‰€æœ‰CPUèµ„æºã€‚ </p><br><p> æ‚¨å¿…é¡»å…‹æœå‡ ä¸ªæŒ‘æˆ˜ï¼Œå› ä¸ºWebSocketsåè®®åœ¨å®¢æˆ·ç«¯æ¯”åœ¨æœåŠ¡å™¨ç«¯å¯¹CPUçš„è¦æ±‚æ›´é«˜ã€‚ åŒæ—¶ï¼Œå¦‚æœæ‚¨æœ‰æ•°ç™¾ä¸‡ä¸ªæ‰“å¼€çš„è¿æ¥ï¼Œåˆ™éœ€è¦å¤§é‡RAMæ¥å­˜å‚¨æœ‰å…³æ‰“å¼€çš„è¿æ¥çš„ä¿¡æ¯ã€‚ </p><br><p> æˆ‘å¾ˆå¹¸è¿èƒ½å¤Ÿåœ¨æœ‰é™çš„æ—¶é—´å†…è´­ä¹°åˆ°å‡ å°æ–°æœåŠ¡å™¨ï¼Œä»¥è¿›è¡Œç¡¬ä»¶â€œè€åŒ–â€æµ‹è¯•ã€‚ å› æ­¤ï¼Œæˆ‘å†³å®šä½¿ç”¨æˆ‘çš„Luaåº”ç”¨æœåŠ¡å™¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">-LAppS</a>æ¥å®Œæˆè¿™ä¸¤é¡¹å·¥ä½œï¼šæµ‹è¯•ç¡¬ä»¶å¹¶æ‰§è¡ŒLAppSé«˜è´Ÿè½½æµ‹è¯•ã€‚ </p><br><p><a name="habracut"></a> è®©æˆ‘ä»¬çœ‹çœ‹ç»†èŠ‚ </p><br><h1 id="challenges"> æŒ‘æˆ˜æ€§ </h1><br><p> é¦–å…ˆï¼Œå®¢æˆ·ç«¯ä¸Šçš„WebSocketéœ€è¦éå¸¸å¿«é€Ÿçš„RNGè¿›è¡Œæµé‡å±è”½ï¼Œé™¤éæ‚¨æƒ³ä¼ªé€ å®ƒã€‚ æˆ‘å¸Œæœ›æµ‹è¯•æ˜¯ç°å®çš„ï¼Œæ‰€ä»¥æˆ‘æ”¾å¼ƒäº†ç”¨å¸¸é‡æ›¿æ¢RNGçš„æƒ³æ³•ã€‚ å‰©ä¸‹çš„å”¯ä¸€é€‰æ‹©-å¤§é‡çš„CPUåŠŸèƒ½ã€‚ å°±åƒæˆ‘è¯´çš„ï¼Œæˆ‘æœ‰ä¸¤å°æœåŠ¡å™¨ï¼šä¸€å°å¸¦æœ‰åŒIntel Gold 6148 CPUï¼ˆæ€»å…±40ä¸ªå†…æ ¸ï¼‰256GB RAMï¼ˆDDR4-2666ï¼‰ï¼Œä¸€å°å¸¦æœ‰å››æ ¸Intel Platinum 8180 CPUï¼ˆæ€»å…±112ä¸ªå†…æ ¸ï¼‰384GB RAMï¼ˆDDR4-2666ï¼‰ ã€‚ æ­¤åï¼Œæˆ‘å°†å®ƒä»¬ç§°ä¸ºæœåŠ¡å™¨Aå’ŒæœåŠ¡å™¨Bã€‚ </p><br><p> ç¬¬äºŒä¸ªæŒ‘æˆ˜-æ²¡æœ‰è¶³å¤Ÿå¿«çš„WebSocketåº“æˆ–æµ‹è¯•å¥—ä»¶ã€‚ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘è¢«è¿«ä¸ºLAppSï¼ˆ <strong>cws</strong> ï¼‰å¼€å‘WebSocketså®¢æˆ·ç«¯æ¨¡å—ã€‚ </p><br><h1 id="the-tests-setup"> æµ‹è¯•è®¾ç½® </h1><br><p> ä¸¤å°æœåŠ¡å™¨å‡å…·æœ‰åŒç«¯å£10GbEå¡ã€‚ æ¯ä¸ªå¡çš„ç«¯å£1èšåˆåˆ°ç»‘å®šæ¥å£ï¼Œå¹¶ä¸”æ¯ä¸ªå¡ä¸Šçš„è¿™äº›ç«¯å£éƒ½ä»¥RRæ¨¡å¼å½¼æ­¤è¿æ¥ã€‚ æ¯ä¸ªå¡çš„ç«¯å£2ä»¥æ´»åŠ¨å¤‡ä»½æ¨¡å¼èšåˆåˆ°ç»‘å®šæ¥å£ï¼Œå¹¶é€šè¿‡ä»¥å¤ªç½‘äº¤æ¢æœºè¿æ¥ã€‚ æ¯ä¸ªç¡¬ä»¶æœåŠ¡å™¨éƒ½åœ¨è¿è¡ŒRHEL 7.6ã€‚ æˆ‘å¿…é¡»ä»æºä»£ç å®‰è£…gcc-8.3æ‰èƒ½æ‹¥æœ‰ç°ä»£çš„ç¼–è¯‘å™¨ï¼Œè€Œä¸æ˜¯é»˜è®¤çš„gcc-4.8.5ã€‚ è¿™ä¸æ˜¯æ€§èƒ½æµ‹è¯•çš„æœ€ä½³è®¾ç½®ï¼Œä½†æ˜¯ä¹gä¸èƒ½æˆä¸ºé€‰æ‹©è€…ã€‚ </p><br><p> æœåŠ¡å™¨Aï¼ˆ2xGold 6148ï¼‰ä¸Šçš„CPUçš„é¢‘ç‡é«˜äºæœåŠ¡å™¨Bï¼ˆ4xPlatinum 8180ï¼‰ä¸Šçš„CPUã€‚ åŒæ—¶ï¼ŒæœåŠ¡å™¨Bå…·æœ‰æ›´å¤šæ ¸å¿ƒï¼Œå› æ­¤æˆ‘å†³å®šåœ¨æœåŠ¡å™¨Aä¸Šè¿è¡Œå›æ˜¾æœåŠ¡å™¨ï¼Œåœ¨æœåŠ¡å™¨Bä¸Šè¿è¡Œå›æ˜¾å®¢æˆ·ç«¯ã€‚ </p><br><p> æˆ‘æƒ³äº†è§£LAppSåœ¨å…·æœ‰æ•°ç™¾ä¸‡ä¸ªè¿æ¥çš„é«˜è´Ÿè½½ä¸‹çš„è¡Œä¸ºï¼Œä»¥åŠæ¯ç§’å¯ä»¥æœåŠ¡çš„æœ€å¤§å›å£°è¯·æ±‚æ•°é‡ã€‚ å®é™…ä¸Šï¼Œè¿™æ˜¯ä¸¤ç»„ä¸åŒçš„æµ‹è¯•ï¼Œå› ä¸ºéšç€è¿æ¥æ•°é‡çš„å¢é•¿ï¼ŒæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„å·¥ä½œè¶Šæ¥è¶Šå¤æ‚ã€‚ </p><br><p> åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘å·²ç»åœ¨ç”¨äºå¼€å‘çš„å®¶ç”¨PCä¸Šè¿›è¡Œäº†æ‰€æœ‰æµ‹è¯•ã€‚ è¿™äº›æµ‹è¯•çš„ç»“æœå°†ç”¨äºæ¯”è¾ƒã€‚ æˆ‘çš„å®¶ç”¨PCå…·æœ‰Intel Core i7-7700 CPU 3.6GHzï¼ˆ4.0GHz Turboï¼‰ï¼Œ4ä¸ªå†…æ ¸å’Œ32GB DDR4-2400 RAMã€‚ è¿™å°PCè¿è¡Œå¸¦æœ‰4.14.72å†…æ ¸çš„Gentooã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">å¹½çµå’Œå´©æºƒè¡¥ä¸çº§åˆ«</b> <div class="spoiler_text"><ul><li> å®¶ç”¨ç”µè„‘ <br><pre><code class="plaintext hljs">/sys/devices/system/cpu/vulnerabilities/l1tf:Mitigation: PTE Inversion; VMX: conditional cache flushes, SMT vulnerable /sys/devices/system/cpu/vulnerabilities/meltdown:Mitigation: PTI /sys/devices/system/cpu/vulnerabilities/spec_store_bypass:Mitigation: Speculative Store Bypass disabled via prctl and seccomp /sys/devices/system/cpu/vulnerabilities/spectre_v1:Mitigation: __user pointer sanitization /sys/devices/system/cpu/vulnerabilities/spectre_v2:Vulnerable: Minimal generic ASM retpoline, IBPB, IBRS_FW</code> </pre> </li><li> æœåŠ¡å™¨Aå’ŒB <br><pre> <code class="plaintext hljs">/sys/kernel/debug/x86/ibpb_enabled : 1 /sys/kernel/debug/x86/pti_enabled : 1 /sys/kernel/debug/x86/ssbd_enabled : 1 /sys/kernel/debug/x86/ibrs_enabled : 1 /sys/kernel/debug/x86/retp_enabled : 3</code> </pre> </li></ul><br><p> æ— è®ºæ˜¯å¦å¯ç”¨äº†è¿™äº›ä¿®è¡¥ç¨‹åºï¼Œæˆ‘éƒ½ä¼šå¯¹æœåŠ¡å™¨Aå’ŒBçš„æµ‹è¯•ç»“æœåšä¸€ä¸ªé¢å¤–è¯´æ˜ã€‚ </p><br><p> åœ¨æˆ‘çš„å®¶ç”¨PCä¸Šï¼Œè¡¥ä¸çº§åˆ«ä»æœªæ›´æ”¹ã€‚ </p></div></div><br><h2 id="installing-lapps-081"> å®‰è£…LAppS 0.8.1 </h2><br><div class="spoiler">  <b class="spoiler_title">å®‰è£…å¿…å¤‡ç»„ä»¶å’ŒLAppS</b> <div class="spoiler_text"><p>  LAppSä¾èµ–äºluajit-2.0.5æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œlibcrypto ++ 8.2å’ŒwolfSSL-3.15.7åº“ï¼Œå®ƒä»¬å¿…é¡»ä»RHEL 7.6ä»¥åŠå¯èƒ½çš„ä»»ä½•å…¶ä»–Linuxå‘è¡Œç‰ˆä¸­çš„æºå®‰è£…ã€‚ </p><br><p> å®‰è£…çš„å‰ç¼€æ˜¯/ usr / localã€‚ è¿™æ˜¯WolfSSLå®‰è£…çš„å‡ ä¹ä¸è¨€è‡ªæ˜çš„Dockerfileéƒ¨åˆ† </p><br><pre> <code class="plaintext hljs">ADD https://github.com/wolfSSL/wolfssl/archive/v3.15.7-stable.tar.gz ${WORKSPACE} RUN tar xzvf v3.15.7-stable.tar.gz WORKDIR ${WORKSPACE}/wolfssl-3.15.7-stable RUN ./autogen.sh RUN ./configure CFLAGS="-pipe -O2 -march=native -mtune=native -fomit-frame-pointer -fstack-check -fstack-protector-strong -mfpmath=sse -msse2avx -mavx2 -ftree-vectorize -funroll-loops -DTFM_TIMING_RESISTANT -DECC_TIMING_RESISTANT -DWC_RSA_BLINDING" --prefix=/usr/local --enable-tls13 --enable-openssh --enable-aesni --enable-intelasm --enable-keygen --enable-certgen --enable-certreq --enable-curve25519 --enable-ed25519 --enable-intelasm --enable-harden RUN make -j40 all RUN make install</code> </pre><br><p> è¿™æ˜¯libcrypto ++å®‰è£…çš„ä¸€éƒ¨åˆ† </p><br><pre> <code class="plaintext hljs">ADD https://github.com/weidai11/cryptopp/archive/CRYPTOPP_8_2_0.tar.gz ${WORKSPACE} RUN rm -rf ${WORKSPACE}/cryptopp-CRYPTOPP_8_2_0 RUN tar xzvf ${WORKSPACE}/CRYPTOPP_8_2_0.tar.gz WORKDIR ${WORKSPACE}/cryptopp-CRYPTOPP_8_2_0 RUN make CFLAGS="-pipe -O2 -march=native -mtune=native -fPIC -fomit-frame-pointer -fstack-check -fstack-protector-strong -mfpmath=sse -msse2avx -mavx2 -ftree-vectorize -funroll-loops" CXXFLAGS="-pipe -O2 -march=native -mtune=native -fPIC -fomit-frame-pointer -fstack-check -fstack-protector-strong -mfpmath=sse -msse2avx -mavx2 -ftree-vectorize -funroll-loops" -j40 libcryptopp.a libcryptopp.so RUN make install</code> </pre><br><p> å’Œluajit </p><br><pre> <code class="plaintext hljs">ADD http://luajit.org/download/LuaJIT-2.0.5.tar.gz ${WORKSPACE} WORKDIR ${WORKSPACE} RUN tar xzvf LuaJIT-2.0.5.tar.gz WORKDIR ${WORKSPACE}/LuaJIT-2.0.5 RUN env CFLAGS="-pipe -Wall -pthread -O2 -fPIC -march=native -mtune=native -mfpmath=sse -msse2avx -mavx2 -ftree-vectorize -funroll-loops -fstack-check -fstack-protector-strong -fno-omit-frame-pointer" make -j40 all RUN make install</code> </pre> <br><p>  LAppSçš„ä¸€ä¸ªå¯é€‰ä¾èµ–é¡¹ï¼ˆå¯ä»¥å¿½ç•¥ï¼‰æ˜¯Microsoft <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">mimalloc</a>çš„æ–°åº“ã€‚ è¯¥åº“å¯æ˜¾ç€æé«˜æ€§èƒ½ï¼ˆçº¦1ï¼…ï¼‰ï¼Œä½†è¦æ±‚cmake-3.4æˆ–æ›´é«˜ã€‚ é‰´äºæµ‹è¯•æ—¶é—´æœ‰é™ï¼Œæˆ‘å†³å®šç‰ºç‰²æåˆ°çš„æ€§èƒ½æ”¹è¿›ã€‚ </p><br><p> åœ¨å®¶ç”¨PCä¸Šï¼Œæˆ‘ä¸ä¼šåœ¨æµ‹è¯•æœŸé—´ç¦ç”¨<em>mimalloc</em> ã€‚ </p><br><p> è®©æˆ‘ä»¬ä»å­˜å‚¨åº“ä¸­ç­¾å‡ºLAppSï¼š </p><br><pre> <code class="plaintext hljs">WORKDIR ${WORKSPACE} RUN rm -rf ITCLib ITCFramework lar utils LAppS RUN git clone https://github.com/ITpC/ITCLib.git RUN git clone https://github.com/ITpC/utils.git RUN git clone https://github.com/ITpC/ITCFramework.git RUN git clone https://github.com/ITpC/LAppS.git RUN git clone https://github.com/ITpC/lar.git WORKDIR ${WORKSPACE}/LAppS</code> </pre> <br><p> ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦ä»<strong>nbproject</strong>å­ç›®å½•ä¸­çš„æ‰€æœ‰Makefileä¸­åˆ é™¤â€œ -lmimallocâ€ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥æ„å»ºLAppSï¼ˆå‡è®¾å½“å‰ç›®å½•ä¸º$ {WORKSPACE} / LAppSï¼‰ </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># find ./nbproject -type f -name "*.mk" -exec sed -i.bak -e 's/-lmimalloc//g' {} \; # find ./nbproject -type f -name "*.bak" -exec rm {} \;</span></span></code> </pre> <br><p> ç°åœ¨æˆ‘ä»¬å¯ä»¥æ„å»ºLAppSã€‚  LAppSæä¾›äº†å‡ ç§æ„å»ºé…ç½®ï¼Œè¿™äº›é…ç½®å¯èƒ½ä¼šä¹Ÿå¯èƒ½ä¸ä¼šæ’é™¤æœåŠ¡å™¨ç«¯çš„æŸäº›åŠŸèƒ½ï¼š </p><br><ul><li> å…·æœ‰SSLæ”¯æŒå’Œç»Ÿè®¡ä¿¡æ¯æ”¶é›†æ”¯æŒ </li><li> ä½¿ç”¨SSLä¸”ä¸æ”¶é›†ç»Ÿè®¡ä¿¡æ¯ï¼ˆå°½ç®¡åœ¨è¿è¡Œæ—¶ç”¨äºåŠ¨æ€LAppSè°ƒæ•´çš„æƒ…å†µä¸‹ï¼Œå°†ç»§ç»­è¿›è¡Œæœ€å°‘çš„ç»Ÿè®¡æ”¶é›†ï¼‰ </li><li> æ²¡æœ‰SSLï¼Œä¹Ÿæ²¡æœ‰ç»Ÿè®¡ä¿¡æ¯æ”¶é›†ã€‚ </li></ul><br><p> åœ¨è¿›è¡Œä¸‹ä¸€æ­¥ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨æ˜¯/ opt / lappsç›®å½•çš„æ‰€æœ‰è€…ï¼ˆæˆ–ä½¿ç”¨sudoè¿è¡Œmake installsï¼‰ </p><br><p> è®©æˆ‘ä»¬åˆ›å»ºä¸¤ç§å…·æœ‰SSLæ”¯æŒå’Œç»Ÿè®¡ä¿¡æ¯æ”¶é›†åŠŸèƒ½çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆä¸åŒ…å«åœ¨$ {WORKSPACE} / LAppSç›®å½•ä¸­ï¼‰ï¼š </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># make clean # make CONF=Release.AVX2 install # make CONF=Release.AVX2.NO_STATS.NO_TLS install</span></span></code> </pre> <br><p> ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶æ˜¯ï¼š </p><br><ul><li>  dist / Release.AVX2 / GNU-Linux / lapps.avx2 </li><li>  dist / Release.AVX2.NO_STATS.NO_TLS / GNU-Linux / lapps.avx2.nostats.notls </li></ul><br><p> å®ƒä»¬å°†è¢«å®‰è£…åˆ°/ opt / lapps / binä¸­ã€‚ </p><br><p> è¯·æ³¨æ„ï¼Œç”¨äºLuaçš„WebSocketså®¢æˆ·ç«¯æ¨¡å—å§‹ç»ˆå¸¦æœ‰SSLæ”¯æŒã€‚ æ˜¯å¦å¯ç”¨å®ƒå–å†³äºæ‚¨åœ¨è¿è¡Œæ—¶ç”¨äºè¿æ¥çš„URIï¼ˆwsï¼š//æˆ–wssï¼š//ï¼‰ã€‚ </p></div></div><br><h2 id="test-1-top-performance-on-home-pc-configuration-for-baseline"> æµ‹è¯•1.å®¶ç”¨PCä¸Šçš„æœ€ä½³æ€§èƒ½ã€‚ åŸºçº¿é…ç½®ã€‚ </h2><br><p> æˆ‘å·²ç»ç¡®å®šï¼Œå½“æˆ‘é…ç½®å››ä¸ªåŸºå‡†æµ‹è¯•æœåŠ¡å®ä¾‹ï¼ˆæ¯ä¸ªå®ä¾‹å…·æœ‰100ä¸ªè¿æ¥ï¼‰æ—¶ï¼Œæˆ‘å°†è·å¾—æœ€ä½³æ€§èƒ½ã€‚ åŒæ—¶ï¼Œæˆ‘ä»…éœ€è¦ä¸‰ä¸ªIOWorkerå’Œå››ä¸ªå›æ˜¾æœåŠ¡å®ä¾‹å³å¯è¾¾åˆ°æœ€ä½³æ€§èƒ½ã€‚ è¿˜è®°å¾—å— æˆ‘è¿™é‡Œåªæœ‰4ä¸ªæ ¸å¿ƒã€‚ </p><br><p> è¯¥æµ‹è¯•çš„ç›®çš„åªæ˜¯ä¸ºè¿›ä¸€æ­¥æ¯”è¾ƒå»ºç«‹åŸºå‡†ã€‚ çœŸçš„æ²¡ä»€ä¹ˆä»¤äººå…´å¥‹çš„ã€‚ </p><br><p> ä¸‹é¢æ˜¯ä¸ºæµ‹è¯•é…ç½®LAppSæ‰€éœ€çš„æ­¥éª¤ã€‚ </p><br><h3 id="self-signed-certificates"> è‡ªç­¾åè¯ä¹¦ </h3><br><div class="spoiler">  <b class="spoiler_title">certgen.shè„šæœ¬</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash openssl genrsa -out example.org.key 2048 openssl req -new -key example.org.key -out example.org.csr openssl genrsa -out ca.key 2048 openssl req -new -x509 -key ca.key -out ca.crt openssl x509 -req -in example.org.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out example.org.crt cat example.org.crt ca.crt &gt; example.org.bundle.crt</span></span></code> </pre> </div></div><br><p> ä»/ opt / lapps / conf / sslç›®å½•ä¸­è¿è¡Œæ­¤è„šæœ¬å°†åˆ›å»ºæ‰€æœ‰å¿…éœ€çš„æ–‡ä»¶ã€‚ è¿™æ˜¯è„šæœ¬çš„è¾“å‡ºä»¥åŠæˆ‘è¾“å…¥çš„å†…å®¹ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">certgen.shè¾“å‡º</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"># certgen.sh Generating RSA private key, 2048 bit long modulus .................................................................................................................................................................+++++ .....................................+++++ e is 65537 (0x010001) You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Country Name (2 letter code) [AU]:KZ State or Province Name (full name) [Some-State]:none Locality Name (eg, city) []:Almaty Organization Name (eg, company) [Internet Widgits Pty Ltd]:NOORG.DO.NOT.FORGET.TO.REMOVE.FROM.BROWSER Organizational Unit Name (eg, section) []: Common Name (eg server FQDN or YOUR name) []: Email Address []: Please enter the following 'extra' attributes to be sent with your certificate request A challenge password []: An optional company name []: Generating RSA private key, 2048 bit long modulus ...+++++ ............................................................................+++++ e is 65537 (0x010001) You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Country Name (2 letter code) [AU]:KZ State or Province Name (full name) [Some-State]:none Locality Name (eg, city) []:Almaty Organization Name (eg, company) [Internet Widgits Pty Ltd]:none Organizational Unit Name (eg, section) []: Common Name (eg server FQDN or YOUR name) []:*.example.org Email Address []: Signature ok subject=C = KZ, ST = none, L = Almaty, O = NOORG.DO.NOT.FORGET.TO.REMOVE.FROM.BROWSER Getting CA Private Key</code> </pre> </div></div><br><h3 id="lapps-configuration">  LAppSé…ç½® </h3><br><p> è¿™æ˜¯ä¸ºTLS 1.3è®¾ç½®çš„WebSocketsé…ç½®æ–‡ä»¶ï¼ŒåŒ…æ‹¬ä¸Šé¢ç”Ÿæˆçš„è¯ä¹¦ï¼Œå¹¶é…ç½®äº†3ä¸ªIOWorkersï¼ˆè¯·å‚é˜…LAppS Wikiä¸­çš„å˜é‡è¯¦ç»†è¯´æ˜ï¼‰ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">/opt/lapps/etc/conf/ws.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"listeners"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-attr"><span class="hljs-attr">"connection_weight"</span></span>: <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ip"</span></span> : <span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span> : <span class="hljs-number"><span class="hljs-number">5083</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lapps_config_auto_save"</span></span> : <span class="hljs-literal"><span class="hljs-literal">true</span></span> , <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_connections"</span></span> : <span class="hljs-number"><span class="hljs-number">40000</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auto_fragment"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_events"</span></span> : <span class="hljs-number"><span class="hljs-number">256</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_wait_ms"</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_inbounds_skip"</span></span> : <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-attr"><span class="hljs-attr">"input_buffer_size"</span></span> : <span class="hljs-number"><span class="hljs-number">2048</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"acl"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"policy"</span></span> : <span class="hljs-string"><span class="hljs-string">"allow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span> : [] }, <span class="hljs-attr"><span class="hljs-attr">"tls"</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_server_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_client_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_certificates"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"ca"</span></span>:<span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/ca.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cert"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.bundle.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.key"</span></span> } }</code> </pre> </div></div><br><p> é…ç½®æœåŠ¡ï¼šå›æ˜¾æœåŠ¡å™¨å’Œå›æ˜¾å®¢æˆ·ç«¯ï¼ˆåŸºå‡†ï¼‰ï¼Œæ¯ä¸ªéƒ½æœ‰å››ä¸ªå®ä¾‹ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">/opt/lapps/etc/conf/lapps.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"directories"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"app_conf_dir"</span></span>: <span class="hljs-string"><span class="hljs-string">"etc"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"applications"</span></span>: <span class="hljs-string"><span class="hljs-string">"apps"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deploy"</span></span>: <span class="hljs-string"><span class="hljs-string">"deploy"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tmp"</span></span>: <span class="hljs-string"><span class="hljs-string">"tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"workdir"</span></span>: <span class="hljs-string"><span class="hljs-string">"workdir"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"services"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"echo"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"auto_start"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"instances"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"internal"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_inbound_message_size"</span></span>: <span class="hljs-number"><span class="hljs-number">16777216</span></span>, <span class="hljs-attr"><span class="hljs-attr">"protocol"</span></span>: <span class="hljs-string"><span class="hljs-string">"raw"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"request_target"</span></span>: <span class="hljs-string"><span class="hljs-string">"/echo"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"acl"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"policy"</span></span> : <span class="hljs-string"><span class="hljs-string">"allow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span> : [] } }, <span class="hljs-attr"><span class="hljs-attr">"benchmark"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"auto_start"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"instances"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"internal"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"preload"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"nap"</span></span>, <span class="hljs-string"><span class="hljs-string">"cws"</span></span>, <span class="hljs-string"><span class="hljs-string">"time"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"depends"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"echo"</span></span> ] } } }</code> </pre> </div></div><br><p>  echoæœåŠ¡éå¸¸ç®€å•ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">å›æ˜¾æœåŠ¡æºä»£ç </b> <div class="spoiler_text"><pre> <code class="lua hljs">echo = {} echo.<span class="hljs-built_in"><span class="hljs-built_in">__index</span></span> = echo; echo.onStart=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"echo::onStart"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> echo.onDisconnect=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> echo.onShutdown=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"echo::onShutdown()"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> echo.onMessage=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler,opcode, message)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> result, errmsg=ws:send(handler,opcode,message); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> result) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"echo::OnMessage(): "</span></span>..errmsg); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> echo</code> </pre> </div></div><br><p> åŸºå‡†æœåŠ¡ä¼šåˆ›å»ºå¤šè¾¾<strong>åŸºå‡†</strong> .targetçš„beta.max_connectionsï¼Œç„¶åä¸€ç›´è¿è¡Œç›´åˆ°åœæ­¢LAppSã€‚ è¿æ¥çš„å»ºç«‹æ²¡æœ‰æš‚åœï¼Œä¹Ÿæ²¡æœ‰å›åº”è¯·æ±‚çš„è½°ç‚¸ã€‚  <strong>cws</strong>æ¨¡å—APIç±»ä¼¼äºWebSocketsçš„Web APIã€‚ ä¸€æ—¦å»ºç«‹äº†æ‰€æœ‰<strong>Benchmark.max_connections</strong> ï¼ŒåŸºå‡†å°±ä¼šæ‰“å°å·²è¿æ¥çš„Socketæ•°é‡ã€‚ å»ºç«‹è¿æ¥åï¼ŒåŸºå‡†æµ‹è¯•å°†å‘æœåŠ¡å™¨å‘é€ä¸€ä¸ª<strong>åŸºå‡†æµ‹è¯•</strong>æ¶ˆæ¯ã€‚ æœåŠ¡å™¨å›å¤åï¼Œå°†è°ƒç”¨<strong>cws</strong>å¯¹è±¡çš„åŒ¿å<strong>onmessage</strong>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åªä¼šå°†ç›¸åŒçš„æ¶ˆæ¯å‘é€å›æœåŠ¡å™¨ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">åŸºå‡†æœåŠ¡æºä»£ç </b> <div class="spoiler_text"><pre> <code class="lua hljs">benchmark={} benchmark.<span class="hljs-built_in"><span class="hljs-built_in">__index</span></span>=benchmark benchmark.init=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> benchmark.messages_counter=<span class="hljs-number"><span class="hljs-number">0</span></span>; benchmark.start_time=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); benchmark.max_connections=<span class="hljs-number"><span class="hljs-number">100</span></span>; benchmark.target=<span class="hljs-string"><span class="hljs-string">"wss://127.0.0.1:5083/echo"</span></span>; benchmark.message=<span class="hljs-string"><span class="hljs-string">"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span></span>; benchmark.meter=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> benchmark.messages_counter=benchmark.messages_counter+<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> slice=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now() - benchmark.start_time; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( slice &gt;= <span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(benchmark.messages_counter..<span class="hljs-string"><span class="hljs-string">" messages received per "</span></span>..slice..<span class="hljs-string"><span class="hljs-string">"ms"</span></span>) benchmark.messages_counter=<span class="hljs-number"><span class="hljs-number">0</span></span>; benchmark.start_time=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> benchmark.run=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> n=nap:new(); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> counter=<span class="hljs-number"><span class="hljs-number">1</span></span>; n:sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> array={}; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> start=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(#array &lt; benchmark.max_connections) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> must_stop()) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> sock, err_msg=cws:new(benchmark.target, { onopen=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> result, errstr=cws:send(handler,benchmark.message,<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> result) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Error on websocket send at handler "</span></span>..handler..<span class="hljs-string"><span class="hljs-string">": "</span></span>..errstr); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onmessage=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler,message,opcode)</span></span></span></span> benchmark.meter(); cws:send(handler,message,opcode); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onerror=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler, message)</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Client WebSocket connection is failed for socketfd "</span></span>..handler..<span class="hljs-string"><span class="hljs-string">". Error: "</span></span>..message); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onclose=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler)</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Connection is closed for socketfd "</span></span>..handler); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(sock ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">insert</span></span>(array,sock); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(err_msg); err_msg=<span class="hljs-literal"><span class="hljs-literal">nil</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">collectgarbage</span></span>(<span class="hljs-string"><span class="hljs-string">"collect"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-comment"><span class="hljs-comment">-- poll events once per 10 outgoing connections -- this will improve the connection establishment speed if counter == 10 then cws:eventLoop(); counter=1 else counter = counter + 1; end end print("Sockets connected: "..#array); benchmark.start_time=time.now(); while not must_stop() do cws:eventLoop(); end for i=1,#array do array[i]:close(); cws:eventLoop(); end end return benchmark;</span></span></code> </pre> </div></div><br><h3 id="services-installation"> æœåŠ¡å®‰è£… </h3><br><p> ç°åœ¨æˆ‘ä»¬éœ€è¦å°†æœåŠ¡è„šæœ¬æ”¾å…¥/opt/lapps/apps//.luaï¼š <br></p><ul><li>  /opt/lapps/apps/benchmark/benchmark.lua </li><li>  /opt/lapps/apps/echo/echo.lua </li></ul><br><p> æˆ‘ä»¬ç°åœ¨å‡†å¤‡è¿è¡ŒåŸºå‡†ã€‚ åªéœ€è¿è¡Œï¼š <code>rm -f lapps.log; /opt/lapps/bin/lapps.avx2 &gt; log</code>  <code>rm -f lapps.log; /opt/lapps/bin/lapps.avx2 &gt; log</code>ä»LAppSç›®å½•ä¸­<code>rm -f lapps.log; /opt/lapps/bin/lapps.avx2 &gt; log</code>å¹¶ç­‰å¾…5åˆ†é’Ÿï¼Œç„¶åæŒ‰Ctrl-Cä¸€æ¬¡ï¼Œä»¥åœæ­¢LAppSï¼ˆå®ƒä¸ä¼šç«‹å³åœæ­¢ï¼Œå®ƒå°†é¦–å…ˆå…³é—­è¿æ¥ï¼‰ï¼Œæˆ–è€…ä¸¤æ¬¡ï¼ˆè¿™å°†ä¸­æ–­å…³æœºé¡ºåºï¼‰ã€‚ </p><br><p> å¥½çš„ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œé‡Œé¢æ˜¯è¿™æ ·çš„ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">åŸºå‡†è¾“å‡º</b> <div class="spoiler_text"><p> å›å£°:: onStart <br> å›å£°:: onStart <br> å›å£°:: onStart <br> å›å£°:: onStart <br> è·‘æ­¥ <br> æ¯3196æ¯«ç§’æ”¶åˆ°1æ¡æ¶ˆæ¯ <br> æ¯3299æ¯«ç§’æ”¶åˆ°1æ¡æ¶ˆæ¯ <br> æ¯3299æ¯«ç§’æ”¶åˆ°1æ¡æ¶ˆæ¯ <br> æ¯3305æ¯«ç§’æ”¶åˆ°1æ¡æ¶ˆæ¯ <br> è¿æ¥çš„æ’åº§ï¼š100 <br> è¿æ¥çš„æ’åº§ï¼š100 <br> è¿æ¥çš„æ’åº§ï¼š100 <br> è¿æ¥çš„æ’åº§ï¼š100 <br> æ¯1000msæ”¶åˆ°134597æ¡æ¶ˆæ¯ <br> æ¯1000æ¯«ç§’æ”¶åˆ°139774æ¡æ¶ˆæ¯ <br> æ¯1000msæ”¶åˆ°138521æ¡æ¶ˆæ¯ <br> æ¯1000æ¯«ç§’æ”¶åˆ°139404æ¡æ¶ˆæ¯ <br> æ¯1000msæ”¶åˆ°140162æ¡æ¶ˆæ¯ <br> æ¯1000æ¯«ç§’æ”¶åˆ°139337æ¡æ¶ˆæ¯ <br> æ¯1000msæ”¶åˆ°140088æ¡æ¶ˆæ¯ <br> æ¯1000msæ”¶åˆ°139946æ¡æ¶ˆæ¯ <br> æ¯1000msæ”¶åˆ°141204æ¡æ¶ˆæ¯ <br> æ¯1000æ¯«ç§’æ”¶åˆ°137988æ¡æ¶ˆæ¯ <br> æ¯1000msæ”¶åˆ°141805æ¡æ¶ˆæ¯ <br> æ¯1000æ¯«ç§’æ”¶åˆ°134733æ¡æ¶ˆæ¯ <br>  ... </p></div></div><br><p> è®©æˆ‘ä»¬è¿™æ ·æ¸…ç†è¯¥æ—¥å¿—æ–‡ä»¶ï¼š </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -e <span class="hljs-string"><span class="hljs-string">':%s/ms/^V^M/g\n:%g/^$/d\nGdd1G4/Sockets\n4\ndggZZ'</span></span> | vi <span class="hljs-variable"><span class="hljs-variable">$i</span></span></code> </pre> <br><p>  '^ V ^ M'æ˜¯ä»¥ä¸‹æŒ‰é”®çš„å¯è§è¡¨ç¤ºï¼šCtrl-V Ctrl-V Ctrl-V Ctrl-Mï¼Œå› æ­¤ä»…å¤åˆ¶ç²˜è´´æ­¤bashè¡Œå°†æ¯«æ— ç”¨å¤„ã€‚ ç®€çŸ­è¯´æ˜ï¼š </p><br><ul><li> æˆ‘ä»¬å¿…é¡»ç”¨è¡Œå°¾æ›¿æ¢'ms'ç¬¦å·ï¼Œå› ä¸ºæˆ‘ä»¬ä¸éœ€è¦å®ƒä»¬ï¼Œå®ƒä»¬å°†åœ¨ä»¥åä½¿è®¡ç®—æ··ä¹±ï¼Œå¹¶ä¸”å¹¶è¡Œå·¥ä½œçš„4ä¸ªåŸºå‡†å¯èƒ½ä¼šåœ¨ä¸€è¡Œä¸­æ‰“å°å‡ºå®ƒä»¬çš„ç»“æœã€‚ </li><li> ä¹‹åæˆ‘ä»¬éœ€è¦åˆ é™¤æ‰€æœ‰ç©ºè¡Œ </li><li> æˆ‘ä»¬ä¹Ÿä¼šåˆ é™¤æœ€åä¸€è¡Œï¼Œå› ä¸ºæˆ‘ä»¬åœæ­¢äº†æœåŠ¡å™¨ </li><li> åœ¨<strong>æ—¥å¿—</strong>æ–‡ä»¶ä¸­ï¼Œåªæœ‰å‰å‡ è¡ŒåŒ…å«<em>è¿æ¥çš„å¥—æ¥å­—ï¼š100</em> ï¼ˆè¿™æ˜¯å› ä¸ºæˆ‘ä»¬ä»…è¿è¡Œå››ä¸ªåŸºå‡†æœåŠ¡ï¼‰ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬è·³è¿‡äº†æœ€åä¸€è¡Œä¹‹åçš„4è¡Œï¼Œç„¶åå°†æ‰€æœ‰å†…å®¹åˆ é™¤åˆ°æ–‡ä»¶é¡¶éƒ¨ã€‚ </li><li> ä¿å­˜æ–‡ä»¶ã€‚ </li></ul><br><p> æ–‡ä»¶å·²ä¿å­˜ï¼Œæ‚¨ç°åœ¨åˆå›åˆ°Shellä¸­ï¼Œæ—¥å¿—æ–‡ä»¶å·²å‡†å¤‡å¥½è¿›è¡Œä¸‹ä¸€æ­¥ï¼š </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># awk -v avg=0 '{rps=($1/$5);avg+=rps;}END{print ((avg*1000)/NR)*4}' log</span></span></code> </pre> <br><p> è¿™ä¸ªawkå•çº¿è®¡ç®—æ¯æ¯«ç§’çš„å›å£°å“åº”é‡ï¼Œå¹¶å°†ç»“æœç´¯ç§¯åœ¨<em>avg</em>å˜é‡ä¸­ã€‚ å¤„ç†å®Œæ—¥å¿—æ–‡ä»¶ä¸­çš„æ‰€æœ‰è¡Œåï¼Œå®ƒå°†<em>avg</em>ä¹˜ä»¥1000ï¼Œä»¥å¾—åˆ°æ¯ç§’çš„å›å£°å“åº”æ€»æ•°ï¼Œé™¤ä»¥è¡Œæ•°ï¼Œå†ä¹˜ä»¥åŸºå‡†æœåŠ¡æ•°é‡ã€‚ è¿™ä¸ºæˆ‘ä»¬æä¾›äº†æ­¤æµ‹è¯•è¿è¡Œæ¯ç§’å¹³å‡å›å£°å“åº”çš„æ•°é‡ã€‚ </p><br><p> åœ¨æˆ‘çš„ç”µè„‘ä¸Šï¼Œè¿™ä¸ªæ•°å­—ï¼ˆERpsï¼‰æ˜¯ï¼š <strong>563854</strong> </p><br><p> è®©æˆ‘ä»¬åœ¨æ²¡æœ‰SSLæ”¯æŒçš„æƒ…å†µä¸‹è¿›è¡Œç›¸åŒçš„æ“ä½œï¼Œçœ‹çœ‹æœ‰ä»€ä¹ˆä¸åŒï¼š </p><br><ul><li> å°†ws.jsonä¸­çš„<strong>tls</strong>å˜é‡çš„å€¼æ›´æ”¹ä¸ºfalse </li><li> å°†<strong>Benchmark.lua</strong>ä¸­çš„Benchmark.targetä»wssï¼š//æ›´æ”¹ä¸ºwsï¼š// </li><li> è¿è¡Œ<code>rm -f lapps.log; /opt/lapps/bin/lapps.avx2.nostats.notls &gt; log</code> ä»LAppSç›®å½•ä¸­çš„<code>rm -f lapps.log; /opt/lapps/bin/lapps.avx2.nostats.notls &gt; log</code> ï¼Œç„¶åé‡å¤ä¸Šè¿°æ­¥éª¤ã€‚ </li></ul><br><p> æˆ‘å¾—åˆ°ï¼š <strong>æ¯ç§’721236ä¸ª</strong>å“åº” </p><br><p> ä½¿ç”¨SSLå’Œä¸ä½¿ç”¨SSLçš„æ€§èƒ½å·®å¼‚çº¦ä¸º22ï¼…ã€‚ è®©æˆ‘ä»¬ç‰¢è®°è¿™äº›æ•°å­—ï¼Œä»¥å¤‡å°†æ¥å‚è€ƒã€‚ </p><br><p> ä½¿ç”¨æœåŠ¡å™¨Aä¸Šçš„ç›¸åŒè®¾ç½®ï¼Œæˆ‘å¾—åˆ°ï¼š421905å¸¦æœ‰SSLçš„<strong>ERpS</strong>å’Œä¸å¸¦SSLçš„<strong>443145</strong> ERpSã€‚ å¹½çµå’Œç†”æ¯çš„è¡¥ä¸å·²ç¦ç”¨ã€‚ <br> åœ¨æœåŠ¡å™¨Bä¸Šï¼Œå¯ç”¨äº†è¡¥ä¸ç¨‹åºåï¼Œæˆ‘è·å¾—äº†å¸¦SSLçš„<strong>270996</strong> ERpSå’Œä¸å¸¦SSLçš„<strong>318522</strong> ERpSã€‚ ä¸å¸¦SSLå’Œå¸¦SSLçš„<strong>385726</strong>å’Œ<strong>372126</strong> ã€‚ å¹½çµå’Œç†”æ¯çš„è¡¥ä¸ä¹Ÿè¢«ç¦ç”¨ã€‚ </p><br><p> ä½¿ç”¨ç›¸åŒçš„è®¾ç½®ï¼Œç»“æœä¼šæ›´ç³Ÿï¼Œå› ä¸ºè¿™äº›æœåŠ¡å™¨ä¸Šçš„CPUé¢‘ç‡è¾ƒä½ã€‚ </p><br><p> è¯·æ³¨æ„ï¼Œå®¢æˆ·ç«¯éå¸¸ä¾èµ–/ dev / urandomä¸­çš„æ•°æ®å¯ç”¨æ€§ã€‚ å¦‚æœæ‚¨å·²ç»è¿è¡Œè¿‡ä¸€æ¬¡ï¼Œåˆ™å¯èƒ½éœ€è¦ä¸€æ®µæ—¶é—´æ‰èƒ½çœŸæ­£å¼€å§‹è¿è¡Œå®¢æˆ·ç«¯ã€‚ å› æ­¤ï¼Œåªè¦ç­‰ä»–ä»¬å¼€å§‹å·¥ä½œï¼Œä»–ä»¬å°±å¯ä»¥å¾ˆå¿«åœ°å®Œæˆå·¥ä½œã€‚ å¦‚æœLAppSå®ä¾‹å®é™…ä¸Šæ ¹æœ¬æ²¡æœ‰åšä»»ä½•å·¥ä½œï¼Œåˆ™ä»…ç›‘è§†<em>top</em> ã€‚ å¦‚æœ/ dev / urandomè€—å°½ï¼Œé‚£ä¹ˆLAppSä¸ä¼šè€—å°½æ‚¨çš„CPUï¼Œç›´åˆ°æœ‰ä¸€äº›å¯ç”¨æ•°æ®ä¸ºæ­¢ã€‚ </p><br><h1 id="preparing-for-big-tests"> ä¸ºå¤§å‹æµ‹è¯•åšå‡†å¤‡ </h1><br><p> é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å¯¹å†…æ ¸å‚æ•°è¿›è¡Œä¸€äº›æ›´æ”¹ï¼Œå¹¶ä¸”ä¸è¦å¿˜è®°æ‰“å¼€æ–‡ä»¶çš„nrçš„é™åˆ¶ã€‚ æˆ‘ä½¿ç”¨äº†ä¸<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æœ¬æ–‡</a>å‡ ä¹ç›¸åŒçš„è®¾ç½®ã€‚ </p><br><p> åˆ›å»ºå…·æœ‰ä»¥ä¸‹å†…å®¹çš„æ–‡ä»¶ </p><br><pre> <code class="bash hljs">: sysctl -w fs.file-max=14000000 sysctl -w fs.nr_open=14000000 <span class="hljs-built_in"><span class="hljs-built_in">ulimit</span></span> -n 14000000 sysctl -w net.ipv4.tcp_mem=<span class="hljs-string"><span class="hljs-string">"100000000 100000000 100000000"</span></span> sysctl -w net.core.somaxconn=20000 sysctl -w net.ipv4.tcp_max_syn_backlog=20000 sysctl -w net.ipv4.ip_local_port_range=<span class="hljs-string"><span class="hljs-string">"1025 65535"</span></span></code> </pre> <br><p> ç„¶ååœ¨ä¸¤ä¸ªæœåŠ¡å™¨ä¸Šä½¿ç”¨<em>source ./filename</em>æ›´æ”¹å†…æ ¸å‚æ•°å’Œulimitã€‚ </p><br><p> è¿™æ¬¡ï¼Œæˆ‘çš„ç›®çš„æ˜¯åœ¨ä¸€å°æœåŠ¡å™¨ä¸Šåˆ›å»ºæ•°ç™¾ä¸‡ä¸ªå®¢æˆ·ç«¯ï¼Œå¹¶å°†å®ƒä»¬è¿æ¥åˆ°ç¬¬äºŒå°æœåŠ¡å™¨ã€‚ </p><br><p> æœåŠ¡å™¨Aå°†å……å½“WebSocketså›æ˜¾æœåŠ¡æœåŠ¡å™¨ç«¯ã€‚ <br> æœåŠ¡å™¨Bå°†å……å½“WebSocketså›æ˜¾æœåŠ¡å®¢æˆ·ç«¯ã€‚ </p><br><p>  LuaJITå¯¹LAppSæ–½åŠ äº†é™åˆ¶ã€‚ æ¯ä¸ªLuaJIT VMåªèƒ½ä½¿ç”¨2GBçš„RAMã€‚ è¿™å°±æ˜¯æ‚¨å¯ä»¥åœ¨å•ä¸ªLAppSå®ä¾‹ä¸­ä¸ºæ‰€æœ‰æœåŠ¡ä½¿ç”¨RAMçš„é™åˆ¶ï¼Œå› ä¸ºè¿™äº›æœåŠ¡æ˜¯é’ˆå¯¹ä¸€ä¸ªlibluajitå®ä¾‹é“¾æ¥çš„çº¿ç¨‹ã€‚ å¦‚æœåœ¨å•ä¸ªLAppSå®ä¾‹ä¸‹è¿è¡Œçš„ä»»ä½•æœåŠ¡è¶…å‡ºæ­¤é™åˆ¶ï¼Œåˆ™æ‰€æœ‰æœåŠ¡éƒ½å°†å†…å­˜ä¸è¶³ã€‚ </p><br><p> æˆ‘å‘ç°ï¼Œæ¯ä¸ªLAppSå®ä¾‹æœ€å¤šåªèƒ½å»ºç«‹2 464 000ä¸ªå®¢æˆ·ç«¯WebSocketï¼Œæ¶ˆæ¯å¤§å°ä¸º64ä¸ªå­—èŠ‚ã€‚ æ¶ˆæ¯çš„å¤§å°å¯èƒ½ä¼šç¨å¾®æ›´æ”¹æ­¤é™åˆ¶ï¼Œå› ä¸ºLAppSé€šè¿‡åœ¨LuaJITå†…ä¸ºè¯¥æ¶ˆæ¯åˆ†é…ç©ºé—´å°†æ¶ˆæ¯ä¼ é€’ç»™<em>cws</em>æœåŠ¡ã€‚ </p><br><p> è¿™æ„å‘³ç€æˆ‘å¿…é¡»åœ¨æœåŠ¡å™¨Bä¸Šå¯åŠ¨å‡ ä¸ªå…·æœ‰ç›¸åŒé…ç½®çš„LAppSå®ä¾‹ï¼Œä»¥å»ºç«‹è¶…è¿‡240ä¸‡ä¸ªWebSocketã€‚ æœåŠ¡å™¨Aï¼ˆå›æ˜¾æœåŠ¡å™¨ï¼‰åœ¨LuaJITç«¯ä½¿ç”¨çš„å†…å­˜ä¸å¤šï¼Œå› æ­¤LAppSçš„ä¸€ä¸ªå®ä¾‹å°†å¤„ç†1230ä¸‡ä¸ªWebSocketï¼Œè€Œä¸ä¼šå‡ºç°ä»»ä½•é—®é¢˜ã€‚ </p><br><p> è®©æˆ‘ä»¬ä¸ºæœåŠ¡å™¨Aå’ŒBå‡†å¤‡ä¸¤ä¸ªä¸åŒçš„é…ç½®ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">æœåŠ¡å™¨A ws.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"listeners"</span></span> : <span class="hljs-number"><span class="hljs-number">224</span></span>, <span class="hljs-attr"><span class="hljs-attr">"connection_weight"</span></span>: <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ip"</span></span> : <span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span> : <span class="hljs-number"><span class="hljs-number">5084</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lapps_config_auto_save"</span></span> : <span class="hljs-literal"><span class="hljs-literal">true</span></span> , <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span>: <span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_connections"</span></span> : <span class="hljs-number"><span class="hljs-number">2000000</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auto_fragment"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_events"</span></span> : <span class="hljs-number"><span class="hljs-number">256</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_wait_ms"</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_inbounds_skip"</span></span> : <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-attr"><span class="hljs-attr">"input_buffer_size"</span></span> : <span class="hljs-number"><span class="hljs-number">2048</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"acl"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"policy"</span></span> : <span class="hljs-string"><span class="hljs-string">"allow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span> : [] }, <span class="hljs-attr"><span class="hljs-attr">"tls"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_server_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_client_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_certificates"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"ca"</span></span>:<span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/ca.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cert"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.bundle.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.key"</span></span> } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">æœåŠ¡å™¨A lapps.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"directories"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"app_conf_dir"</span></span>: <span class="hljs-string"><span class="hljs-string">"etc"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"applications"</span></span>: <span class="hljs-string"><span class="hljs-string">"apps"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deploy"</span></span>: <span class="hljs-string"><span class="hljs-string">"deploy"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tmp"</span></span>: <span class="hljs-string"><span class="hljs-string">"tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"workdir"</span></span>: <span class="hljs-string"><span class="hljs-string">"workdir"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"services"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"echo"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"auto_start"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"instances"</span></span>: <span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-attr"><span class="hljs-attr">"internal"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_inbound_message_size"</span></span>: <span class="hljs-number"><span class="hljs-number">16777216</span></span>, <span class="hljs-attr"><span class="hljs-attr">"protocol"</span></span>: <span class="hljs-string"><span class="hljs-string">"raw"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"request_target"</span></span>: <span class="hljs-string"><span class="hljs-string">"/echo"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"acl"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"policy"</span></span> : <span class="hljs-string"><span class="hljs-string">"allow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span> : [] } } } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">æœåŠ¡å™¨B ws.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"listeners"</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"connection_weight"</span></span>: <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ip"</span></span> : <span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span> : <span class="hljs-number"><span class="hljs-number">5083</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lapps_config_auto_save"</span></span> : <span class="hljs-literal"><span class="hljs-literal">true</span></span> , <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_connections"</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auto_fragment"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_events"</span></span> : <span class="hljs-number"><span class="hljs-number">2048</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_wait_ms"</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_inbounds_skip"</span></span> : <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-attr"><span class="hljs-attr">"input_buffer_size"</span></span> : <span class="hljs-number"><span class="hljs-number">2048</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"acl"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"policy"</span></span> : <span class="hljs-string"><span class="hljs-string">"deny"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span> : [] }, <span class="hljs-attr"><span class="hljs-attr">"tls"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_server_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_client_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_certificates"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"ca"</span></span>:<span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/ca.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cert"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.bundle.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.key"</span></span> } }</code> </pre> </div></div><br><p> æœåŠ¡å™¨Aå…·æœ‰ä¸¤ä¸ªæ¥å£ï¼š </p><br><ul><li>  bond0-xx203.37 </li><li>  bond1-xx23.10 </li></ul><br><p> ä¸€ä¸ªè¶Šå¿«ï¼Œå¦ä¸€ä¸ªè¶Šæ…¢ï¼Œä½†è¿™å¹¶ä¸é‡è¦ã€‚ æ— è®ºå¦‚ä½•ï¼ŒæœåŠ¡å™¨å°†æ‰¿å—æ²‰é‡çš„è´Ÿæ‹…ã€‚ </p><br><p> è®©æˆ‘ä»¬ä»/opt/lapps/benchmark/benchmark.luaå‡†å¤‡ä¸€ä¸ªæ¨¡æ¿ </p><br><div class="spoiler">  <b class="spoiler_title">åŸºå‡†æµ‹è¯•</b> <div class="spoiler_text"><pre> <code class="lua hljs">benchmark={} benchmark.<span class="hljs-built_in"><span class="hljs-built_in">__index</span></span>=benchmark benchmark.init=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> benchmark.messages_counter=<span class="hljs-number"><span class="hljs-number">0</span></span>; benchmark.start_time=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); benchmark.max_connections=<span class="hljs-number"><span class="hljs-number">10000</span></span>; benchmark.target_port=<span class="hljs-number"><span class="hljs-number">0</span></span>; benchmark.target_prefix=<span class="hljs-string"><span class="hljs-string">"wss://IPADDR:"</span></span>; benchmark.target_postfix=<span class="hljs-string"><span class="hljs-string">"/echo"</span></span>; benchmark.message=<span class="hljs-string"><span class="hljs-string">"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span></span>; benchmark.meter=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> benchmark.messages_counter=benchmark.messages_counter+<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> slice=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now() - benchmark.start_time; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( slice &gt;= <span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(benchmark.messages_counter..<span class="hljs-string"><span class="hljs-string">" messages received per "</span></span>..slice..<span class="hljs-string"><span class="hljs-string">"ms"</span></span>) benchmark.messages_counter=<span class="hljs-number"><span class="hljs-number">0</span></span>; benchmark.start_time=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> benchmark.run=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> n=nap:new(); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> counter=<span class="hljs-number"><span class="hljs-number">1</span></span>; n:sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> array={}; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> start=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(#array &lt; benchmark.max_connections) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> must_stop()) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> benchmark.target_port=<span class="hljs-built_in"><span class="hljs-built_in">math</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">random</span></span>(<span class="hljs-number"><span class="hljs-number">5084</span></span>,<span class="hljs-number"><span class="hljs-number">5307</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> sock, err_msg=cws:new(benchmark.target_prefix..benchmark.target_port..benchmark.target_postfix, { onopen=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> result, errstr=cws:send(handler,benchmark.message,<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> result) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Error on websocket send at handler "</span></span>..handler..<span class="hljs-string"><span class="hljs-string">": "</span></span>..errstr); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onmessage=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler,message,opcode)</span></span></span></span> benchmark.meter(); cws:send(handler,message,opcode); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onerror=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler, message)</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Client WebSocket connection is failed for socketfd "</span></span>..handler..<span class="hljs-string"><span class="hljs-string">". Error: "</span></span>..message); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onclose=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler)</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Connection is closed for socketfd "</span></span>..handler); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(sock ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">insert</span></span>(array,sock); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(err_msg); err_msg=<span class="hljs-literal"><span class="hljs-literal">nil</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">collectgarbage</span></span>(<span class="hljs-string"><span class="hljs-string">"collect"</span></span>); <span class="hljs-comment"><span class="hljs-comment">-- force garbage collection on connection failure. end -- poll events once per 10 outgoing connections -- this will improve the connection establishment speed if counter == 10 then cws:eventLoop(); counter=1 else counter = counter + 1; end end print("Sockets connected: "..#array); benchmark.start_time=time.now(); while not must_stop() do cws:eventLoop(); end for i=1,#array do array[i]:close(); cws:eventLoop(); end end return benchmark;</span></span></code> </pre> </div></div><br><p> è®©æˆ‘ä»¬åˆ†åˆ«å°†æœåŠ¡å™¨Açš„IPåœ°å€å­˜å‚¨åˆ°æ–‡ä»¶IP1å’ŒIP2ä¸­ï¼Œç„¶åï¼š </p><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 1 2 <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> mkdir -p /opt/lapps/apps/benchmark<span class="hljs-variable"><span class="hljs-variable">${i}</span></span> sed -e <span class="hljs-string"><span class="hljs-string">"s/IPADDR/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(cat IP1)</span></span></span><span class="hljs-string">/g"</span></span> /opt/lapps/apps/benchmark/benchmark.lua &gt; /opt/lapps/apps/benchmark<span class="hljs-variable"><span class="hljs-variable">${i}</span></span>/benchmark<span class="hljs-variable"><span class="hljs-variable">${i}</span></span>.lua <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br><p> ç°åœ¨ï¼Œæˆ‘ä»¬ä¿®æ”¹æœåŠ¡å™¨Bä¸Šçš„/opt/lapps/etc/conf/lapps.jsonä»¥ä½¿ç”¨ä»¥ä¸‹ä¸¤ä¸ªåŸºå‡†æœåŠ¡ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">æœåŠ¡å™¨B lapps.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"directories"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"app_conf_dir"</span></span>: <span class="hljs-string"><span class="hljs-string">"etc"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"applications"</span></span>: <span class="hljs-string"><span class="hljs-string">"apps"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deploy"</span></span>: <span class="hljs-string"><span class="hljs-string">"deploy"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tmp"</span></span>: <span class="hljs-string"><span class="hljs-string">"tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"workdir"</span></span>: <span class="hljs-string"><span class="hljs-string">"workdir"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"services"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"benchmark1"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"auto_start"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"instances"</span></span> : <span class="hljs-number"><span class="hljs-number">112</span></span>, <span class="hljs-attr"><span class="hljs-attr">"internal"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"preload"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"nap"</span></span>, <span class="hljs-string"><span class="hljs-string">"cws"</span></span>, <span class="hljs-string"><span class="hljs-string">"time"</span></span> ] }, <span class="hljs-attr"><span class="hljs-attr">"benchmark2"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"auto_start"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"instances"</span></span> : <span class="hljs-number"><span class="hljs-number">112</span></span>, <span class="hljs-attr"><span class="hljs-attr">"internal"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"preload"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"nap"</span></span>, <span class="hljs-string"><span class="hljs-string">"cws"</span></span>, <span class="hljs-string"><span class="hljs-string">"time"</span></span> ] } } }</code> </pre> </div></div><br><p> æˆ‘ä»¬å‡†å¤‡å¥½äº†å— ä¸ï¼Œæˆ‘ä»¬ä¸æ˜¯ã€‚ å› ä¸ºæˆ‘ä»¬æ‰“ç®—ä»…å‘ä¸¤ä¸ªåœ°å€ç”Ÿæˆ2240 000ä¸ªä¼ å‡ºå¥—æ¥å­—ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨æœåŠ¡å™¨ç«¯å¢åŠ ç«¯å£ã€‚ åˆ›å»ºåˆ°åŒä¸€ipï¼šç«¯å£å¯¹çš„è¿æ¥æ•°ä¸èƒ½è¶…è¿‡64kï¼ˆå®é™…ä¸Šæ¯”64kå°‘ä¸€ç‚¹ï¼‰ã€‚ </p><br><p> åœ¨æœåŠ¡å™¨Aä¸Šçš„æ–‡ä»¶LAppS / include / wsServer.hä¸­ï¼Œæœ‰ä¸€ä¸ªå‡½æ•°void startListenersï¼ˆï¼‰ã€‚ åœ¨æ­¤åŠŸèƒ½ä¸­ï¼Œæˆ‘ä»¬å°†æ›¿æ¢ç¬¬126è¡Œ </p><br><pre> <code class="plaintext hljs">LAppSConfig::getInstance()-&gt;getWSConfig()["port"],</code> </pre> <br><p> ä¸æ­¤ï¼š </p><br><pre> <code class="plaintext hljs">static_cast&lt;int&gt;(LAppSConfig::getInstance()-&gt;getWSConfig()["port"])+i,</code> </pre> <br><p> é‡å»ºLAppSï¼š </p><br><pre> <code class="bash hljs">make CONF=Release.AVX2 install</code> </pre> <br><h1 id="running-the-tests-for-2-240-000-client-websockets"> å¯¹2 240 000å®¢æˆ·ç«¯WebSocketè¿è¡Œæµ‹è¯•ã€‚ </h1><br><p> åœ¨æœåŠ¡å™¨Bä¸Šå¯åŠ¨LAppSï¼Œç„¶ååœ¨æœåŠ¡å™¨Bä¸Šå¯åŠ¨LAppSå¹¶å°†è¾“å‡ºé‡å®šå‘åˆ°å¦‚ä¸‹æ–‡ä»¶ï¼š </p><br><pre> <code class="bash hljs">/opt/lapps/bin/lapps.avx2 &gt; <span class="hljs-built_in"><span class="hljs-built_in">log</span></span></code> </pre> <br><p> ç¼–è¾‘ï¼Œæ³¨æ„ï¼š </p><br><pre> <code class="plaintext hljs">if you want to run several LAppS instances, then create separate directory for each instnace (like run1,run2, etc) and run each instance from within these directories. This is required for lapps.log file and of course for resulting standard output, for not to be overlapped/overwritten by concurrent LAppS instances.</code> </pre> <br><p> åœ¨å»ºç«‹æ‰€æœ‰è¿æ¥ä¹‹å‰ï¼Œå¯èƒ½éœ€è¦ä¸€æ®µæ—¶é—´ã€‚ è®©æˆ‘ä»¬ç›‘è§†è¿›åº¦ã€‚ </p><br><p> ä¸è¦ä½¿ç”¨netstatæ¥ç›‘è§†å·²å»ºç«‹çš„è¿æ¥ï¼Œè¿™æ¯«æ— æ„ä¹‰ï¼Œå°½ç®¡å®ƒä¼šåœ¨å‡ ç§’é’Ÿå†…å»ºç«‹150kä¸ªè¿æ¥åæ— é™æœŸåœ°è¿è¡Œã€‚ åœ¨å¯åŠ¨LAppSæ—¶æ‰€åœ¨çš„ç›®å½•ä¸­ï¼ŒæŸ¥çœ‹æœåŠ¡å™¨Aä¸Šçš„lapps.logã€‚ æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å•è¡Œä»£ç æ¥æŸ¥çœ‹å¦‚ä½•å»ºç«‹è¿æ¥ä»¥åŠå¦‚ä½•åœ¨IOWorkersä¹‹é—´åˆ†é…è¿æ¥ï¼š </p><br><pre> <code class="bash hljs">date;awk <span class="hljs-string"><span class="hljs-string">'/ will be added to connection pool of worker/{a[$22]++}END{for(i in a){ print i, a[i]; sum+=a[i]} print sum}'</span></span> lapps.log | sort -n;date</code> </pre> <br><p> è¿™æ˜¯å…³äºå¦‚ä½•å¿«é€Ÿå»ºç«‹è¿™äº›è¿æ¥çš„æƒ³æ³•ï¼š </p><br><pre> <code class="plaintext hljs">375874 Sun Jul 21 20:33:07 +06 2019 650874 Sun Jul 21 20:34:42 +06 2019 2894 connections per second 1001874 Sun Jul 21 20:36:45 +06 2019 2974 connections per second 1182874 Sun Jul 21 20:37:50 +06 2019 2784 connections per second 1843874 Sun Jul 21 20:41:44 +06 2019 2824 connections per second 2207874 Sun Jul 21 20:45:43 +06 2019 3058 connections per second</code> </pre><br><p> åœ¨æœåŠ¡å™¨Bä¸Šï¼Œæˆ‘ä»¬å¯ä»¥æ£€æŸ¥å®Œæˆå»ºç«‹å®ƒä»¬çš„è¿æ¥çš„åŸºå‡†æ•°é‡ï¼š </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># grep Sockets log | wc -l 224</span></span></code> </pre> <br><p> åœ¨çœ‹åˆ°æ•°å­—ä¸º224ä¹‹åï¼Œè¯·è®©æœåŠ¡å™¨å·¥ä½œä¸€ä¼šå„¿ï¼Œç„¶åä½¿ç”¨topç›‘è§†CPUå’Œå†…å­˜ä½¿ç”¨æƒ…å†µã€‚ æ‚¨å¯èƒ½ä¼šçœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹å†…å®¹ï¼ˆæœåŠ¡å™¨Båœ¨å·¦ä¾§ï¼ŒæœåŠ¡å™¨Aåœ¨å³ä¾§ï¼‰ï¼š </p><br><p><img src="https://habrastorage.org/webt/e0/vy/sv/e0vysvislttrfhwpn_vexnwseli.png" alt="å›¾ç‰‡"></p><br><p> æˆ–è¿™æ ·ï¼ˆæœåŠ¡å™¨Båœ¨å·¦ä¾§ï¼ŒæœåŠ¡å™¨Aåœ¨å³ä¾§ï¼‰ï¼š </p><br><p><img src="https://habrastorage.org/webt/p1/cj/qk/p1cjqk6fxmthbnnexc2ikco9d6a.png"></p><br><p> æ˜¾ç„¶ï¼Œè¿è¡ŒåŸºå‡†å®¢æˆ·ç«¯æœåŠ¡çš„æœåŠ¡å™¨Bè´Ÿè½½æ²‰é‡ã€‚ æœåŠ¡å™¨Aä¹Ÿæ‰¿å—ç€æ²‰é‡çš„è´Ÿæ‹…ï¼Œä½†å¹¶éæ€»æ˜¯å¦‚æ­¤ã€‚ æœ‰æ—¶ï¼ŒæœåŠ¡å™¨Båœ¨å¤„ç†å¤§é‡ä»»åŠ¡æ—¶ä¼šæ„Ÿåˆ°ä¸å¯’è€Œæ —ã€‚  TLSä¸Šçš„æµé‡åŠ å¯†éå¸¸å ç”¨CPUã€‚ </p><br><p> è®©æˆ‘ä»¬åœæ­¢æœåŠ¡å™¨ï¼ˆå‡ æ¬¡æŒ‰Ctrl-Cï¼‰å¹¶åƒä»¥å‰ä¸€æ ·ä¿®æ”¹æ—¥å¿—ï¼Œä½†è¦æ›´æ”¹åŸºå‡†æµ‹è¯•æœåŠ¡çš„æ•°é‡ï¼ˆ224ï¼‰ï¼š </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -e <span class="hljs-string"><span class="hljs-string">':%s/ms/^V^M/g\n:%g/^$/d\nGdd1G224/Sockets\n224\ndggZZ'</span></span> | vi <span class="hljs-variable"><span class="hljs-variable">$i</span></span> awk -v avg=0 <span class="hljs-string"><span class="hljs-string">'{rps=($1/$5);avg+=rps;}END{print ((avg*1000)/NR)*224}'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">log</span></span></code> </pre> <br><p> æ‚¨å¯èƒ½è¿˜å¸Œæœ›åˆ é™¤æœ€åå‡ è¡Œï¼Œä»¥è¯´æ˜åœæ­¢åŸºå‡†æµ‹è¯•æœåŠ¡åçš„æ‰“å°è¾“å‡ºã€‚ æ‚¨å·²ç»çŸ¥é“å¦‚ä½•æ‰§è¡Œæ­¤æ“ä½œã€‚ å› æ­¤ï¼Œæˆ‘å°†é’ˆå¯¹ä¸åŒçš„æµ‹è¯•åœºæ™¯å‘å¸ƒç»“æœï¼Œå¹¶å¤„ç†æˆ‘é‡åˆ°çš„é—®é¢˜ã€‚ </p><br><h1 id="results-for-all-the-other-tests-49-million-and-beyond"> æ‰€æœ‰å…¶ä»–æµ‹è¯•çš„ç»“æœï¼ˆ490ä¸‡åŠæ›´é«˜ï¼‰ </h1><br><p><img src="https://habrastorage.org/webt/az/4a/at/az4aatexickfttbrom2gg3yrymu.png"></p><br><div class="spoiler">  <b class="spoiler_title">æµ‹è¯•ï¼ƒ4è´Ÿè½½</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ra/ka/_f/raka_fia7i2vnqhwh2p-5lnulc8.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">æµ‹è¯•5å·è´Ÿè½½</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ln/z5/ml/lnz5mlaoz7aclxuyvjwjpwj25jm.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">æµ‹è¯•ï¼ƒ5å¹³è¡¡ä»¥è·å¾—ç›¸ç­‰çš„CPUå…±äº«</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/vi/cy/fe/vicyfenhzk7uvcjsiohq950c9fa.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">æµ‹è¯•ï¼ƒ6</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/7h/bg/ez/7hbgezb4zxuv3ijuemjmkilf110.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">æµ‹è¯•ï¼ƒ8</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/gq/5_/uj/gq5_uje-nnkfhlqmilb7xnbu5tc.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">æµ‹è¯•ï¼ƒ12</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/xa/tr/m9/xatrm9dbbaha13w9wjxzmecvxjm.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">æµ‹è¯•ï¼ƒ13</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/-w/9t/i8/-w9ti8atzczna-9dvepihihlyqu.png"></p></div></div><br><h1 id="problems"> é—®é¢˜ã€‚ </h1><br><p> åœ¨ä¸Šè¡¨ä¸­ç”¨çº¢è‰²æ ‡è®°ã€‚ </p><br><p> åœ¨æœåŠ¡å™¨Bä¸Šè¿è¡Œè¶…è¿‡224ä¸ªåŸºå‡†æµ‹è¯•å®ä¾‹è¢«è¯æ˜æ˜¯ä¸€ä¸ªåä¸»æ„ï¼Œå› ä¸ºå®¢æˆ·ç«¯çš„æœåŠ¡å™¨æ— æ³•åœ¨è¿›ç¨‹/çº¿ç¨‹ä¹‹é—´å¹³å‡åˆ†é…CPUæ—¶é—´ã€‚ å»ºç«‹æ‰€æœ‰è¿æ¥çš„å‰224ä¸ªåŸºå‡†å®ä¾‹å ç”¨äº†å¤§éƒ¨åˆ†CPUèµ„æºï¼Œå…¶ä½™åŸºå‡†å®ä¾‹åˆ™è½åã€‚ å³ä½¿ä½¿ç”¨renice -20ä¹Ÿæ— æµäºäº‹ï¼ˆ448ä¸ªåŸºå‡†å®ä¾‹ï¼Œ2ä¸ªLAppSå®ä¾‹ï¼‰ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">448ä¸ªåŸºå‡†å®ä¾‹</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/a2/ms/bg/a2msbgjgzuwvzzdl332linmmq98.png"><br> æœåŠ¡å™¨Bï¼ˆå·¦ä¾§ï¼‰çš„è´Ÿè½½éå¸¸é‡ï¼ŒæœåŠ¡å™¨Aä»å…·æœ‰å¯ç”¨çš„CPUèµ„æºã€‚ </p></div></div><br><p> å› æ­¤ï¼Œæˆ‘å°†<strong>benchmark.max_connections</strong>åŠ å€ï¼Œè€Œä¸æ˜¯å¯åŠ¨æ›´å¤šå•ç‹¬çš„LAppSå®ä¾‹ã€‚ </p><br><p> ä»ç„¶è¦è¿è¡Œ1,230ä¸‡ä¸ªWebSocketï¼Œæˆ‘å·²ç»å¯åŠ¨äº†ç¬¬äº”ä¸ªLAppSå®ä¾‹ï¼ˆæµ‹è¯•5å’Œ6ï¼‰ï¼Œè€Œæ²¡æœ‰åœæ­¢å››ä¸ªå·²ç»è¿è¡Œçš„å®ä¾‹ã€‚ å¹¶é€šè¿‡ä½¿ç”¨<em>kill -STOP / -CONT</em>æˆ–/æ‰‹åŠ¨æŒ‚èµ·å’Œé‡æ–°å¯åŠ¨ä¼˜å…ˆè¿›ç¨‹å¹¶é‡æ–°ç¡®å®šä¼˜å…ˆçº§æ¥å‘æŒ¥CFQçš„ä½œç”¨ã€‚ æ‚¨å¯ä»¥ä¸ºæ­¤ä½¿ç”¨ä»¥ä¸‹æ¨¡æ¿è„šæœ¬ï¼š </p><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> [ 1 ]; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> -STOP &lt;4 fast-processes pids&gt; sleep 10 <span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> -CONT &lt;4 fast-processes pids&gt; sleep 5 <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br><p> æ¬¢è¿ä½¿ç”¨2019 RHEL 7.6ï¼ è€å®è¯´ï¼Œè‡ª2009å¹´ä»¥æ¥æˆ‘ç¬¬ä¸€æ¬¡ä½¿ç”¨reniceå‘½ä»¤ã€‚æœ€ç³Ÿç³•çš„æ˜¯ï¼Œ-è¿™æ¬¡æˆ‘å‡ ä¹æ²¡æœ‰æˆåŠŸä½¿ç”¨å®ƒã€‚ </p><br><p> æˆ‘å¯¹NICçš„åˆ†æ•£æ”¶é›†å¼•æ“æœ‰é—®é¢˜ã€‚ å› æ­¤ï¼Œæˆ‘å°†å…¶ç¦ç”¨ä»¥è¿›è¡ŒæŸäº›æµ‹è¯•ï¼Œè€Œå®é™…ä¸Šå¹¶æœªå°†æ­¤äº‹ä»¶æ ‡è®°åˆ°è¡¨ä¸­ã€‚ </p><br><p> åœ¨é«˜è´Ÿè½½å’ŒNICé©±åŠ¨ç¨‹åºé”™è¯¯çš„æƒ…å†µä¸‹ï¼Œæˆ‘æœ‰éƒ¨åˆ†é“¾è·¯ä¸­æ–­ï¼Œå› æ­¤æˆ‘ä¸å¾—ä¸æ”¾å¼ƒç›¸å…³çš„æµ‹è¯•ç»“æœã€‚ </p><br><h1 id="end-of-story"> æ•…äº‹ç»“æŸ </h1><br><p> è€å®è¯´ï¼Œæµ‹è¯•æ¯”æˆ‘é¢„æœŸçš„è¦é¡ºåˆ©å¾—å¤šã€‚ </p><br><p> æˆ‘åšä¿¡æˆ‘æ²¡æœ‰è®¾æ³•å°†æœåŠ¡å™¨Aä¸Šçš„LAppSå®Œå…¨åŠ è½½ï¼ˆæ²¡æœ‰SSLï¼‰ï¼Œå› ä¸ºæˆ‘æ²¡æœ‰è¶³å¤Ÿçš„CPUèµ„æºä¾›å®¢æˆ·ç«¯ä½¿ç”¨ã€‚ å°½ç®¡å¯ç”¨äº†TLS 1.3ï¼Œä½†æœåŠ¡å™¨Aä¸Šçš„LAppSå´åˆ©ç”¨äº†å‡ ä¹æ‰€æœ‰å¯ç”¨çš„CPUèµ„æºã€‚ </p><br><p> æˆ‘ä»ç„¶åšä¿¡LAppSæ˜¯ç›®å‰æœ€å…·å¯æ‰©å±•æ€§å’Œæœ€å¿«çš„WebSocketså¼€æºæœåŠ¡å™¨ï¼Œè€Œ<strong>cws</strong> WebSocketså®¢æˆ·ç«¯æ¨¡å—æ˜¯åŒç±»äº§å“ä¸­å”¯ä¸€çš„ï¼Œä¸ºé«˜è´Ÿè½½æµ‹è¯•æä¾›äº†æ¡†æ¶ã€‚ </p><br><p> è¯·åœ¨æ‚¨è‡ªå·±çš„ç¡¬ä»¶ä¸ŠéªŒè¯ç»“æœã€‚ </p><br><p> æ„è§å»ºè®®ï¼šåˆ‡å‹¿å°†nginxæˆ–apacheç”¨ä½œè´Ÿè½½å¹³è¡¡å™¨æˆ–WebSocketsçš„ä»£ç†é€šé“ï¼Œå¦åˆ™æœ€ç»ˆå°†å¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚ å®ƒä»¬ä¸æ˜¯ä¸ºWebSocketæ„å»ºçš„ã€‚ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN460847/">https://habr.com/ru/post/zh-CN460847/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN460837/index.html">åˆå­¦è€…æ’­å®¢æ‰‹å†Œ</a></li>
<li><a href="../zh-CN460839/index.html">å¯åŠ¨Predator-é¢„ç¼–è¯‘çš„æ•°æ®å­˜å‚¨åº“</a></li>
<li><a href="../zh-CN460841/index.html">TOP-23è¯­è¨€å­¦ä¹ åº”ç”¨</a></li>
<li><a href="../zh-CN460843/index.html">å¼•å…¥æ–°çš„3CXå‘¼å«æµç¨‹è®¾è®¡å™¨å’Œ3CX CRMæ¨¡æ¿ç”Ÿæˆå™¨</a></li>
<li><a href="../zh-CN460845/index.html">è´¹å°”å—å¤šÂ·ç§‘å°”å·´æ‰˜ï¼ˆFernando Corbatoï¼‰ï¼Œæ‚¨çš„è®¡ç®—æœºä¹‹çˆ¶ï¼ˆå’Œå¯†ç ï¼‰ï¼Œäº«å¹´93å²ã€‚</a></li>
<li><a href="../zh-CN460849/index.html">ç¬¬4éƒ¨åˆ†ã€‚ç”¨äºè®¡ç®—å¼‚æ­¥å¹¶è¡Œè¿›ç¨‹çš„é€»è¾‘å‡½æ•°çš„å›¾å½¢æ¨¡å‹</a></li>
<li><a href="../zh-CN460851/index.html">SamsPcbGuideï¼Œç¬¬10éƒ¨åˆ†ï¼šæŠ€æœ¯-ç„Šæ¥æ— é“…ç»„ä»¶</a></li>
<li><a href="../zh-CN460855/index.html">å¦‚ä½•ä½¿ç”¨PHPå®ç°å¾®æœåŠ¡ï¼Ÿ</a></li>
<li><a href="../zh-CN460857/index.html">NamecoinåŒºå—é“¾ç ”ç©¶å¦‚ä½•é¢„æµ‹RTMç½‘ç»œæ”»å‡»</a></li>
<li><a href="../zh-CN460859/index.html">åœ¨å“ˆå°”ç§‘å¤«ä¸¾è¡Œçš„IThinkï¼ƒ3ä¼šè®®-åŸºäºWWDC 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>