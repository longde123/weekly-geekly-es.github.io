<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõê üë®üèæ‚ÄçüöÄ üåÉ Seccomp em Kubernetes: 7 coisas que voc√™ precisa saber desde o in√≠cio üòä üë®üèº‚Äçüíº üôáüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nota perev. : Apresentando a tradu√ß√£o de um artigo por um engenheiro de seguran√ßa de aplicativos s√™nior da empresa brit√¢nica ASOS.com. Com ela, ele in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Seccomp em Kubernetes: 7 coisas que voc√™ precisa saber desde o in√≠cio</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/481114/"> <i><b>Nota</b></i>  <i><b>perev.</b></i>  <i>: Apresentando a tradu√ß√£o de um artigo por um engenheiro de seguran√ßa de aplicativos s√™nior da empresa brit√¢nica ASOS.com.</i>  <i>Com ela, ele inicia uma s√©rie de publica√ß√µes sobre como melhorar a seguran√ßa no Kubernetes atrav√©s do uso do seccomp.</i>  <i>Se os leitores gostarem da introdu√ß√£o, seguiremos o autor e continuaremos com seus futuros materiais sobre este t√≥pico.</i> <br><br><img src="https://habrastorage.org/webt/-u/nv/vk/-unvvkiylrs9ucbym-l4bsobtr8.png"><br><br>  Este artigo √© a primeira de uma s√©rie de publica√ß√µes sobre como criar perfis seccomp no esp√≠rito do SecDevOps sem recorrer √† magia e √† bruxaria.  Na primeira parte, falarei sobre os conceitos b√°sicos e internos da implementa√ß√£o do seccomp no Kubernetes. <br><br>  O ecossistema Kubernetes oferece uma ampla variedade de maneiras para garantir a seguran√ßa e o isolamento dos cont√™ineres.  Este artigo √© sobre o Secure Computing Mode, tamb√©m conhecido como <b>seccomp</b> .  Sua ess√™ncia est√° nas chamadas do sistema de filtragem dispon√≠veis para execu√ß√£o dos cont√™ineres. <a name="habracut"></a><br><br>  Por que isso √© importante?  Um cont√™iner √© apenas um processo em execu√ß√£o em uma m√°quina espec√≠fica.  E ele usa o kernel em p√© de igualdade com outros aplicativos.  Se os cont√™ineres pudessem fazer chamadas do sistema, muito em breve o malware seria aproveitado para contornar o isolamento do cont√™iner e afetar outros aplicativos: interceptar informa√ß√µes, alterar configura√ß√µes do sistema etc. <br><br>  Os perfis seccomp determinam quais chamadas do sistema devem ser permitidas ou negadas.  O tempo de execu√ß√£o do cont√™iner os ativa durante seu lan√ßamento, para que o kernel possa controlar sua execu√ß√£o.  O uso desses perfis permite limitar o vetor de ataque e reduzir os danos se algum programa dentro do cont√™iner (ou seja, suas depend√™ncias ou suas depend√™ncias) come√ßar a fazer o que n√£o √© permitido. <br><br><h2>  Compreendendo o b√°sico </h2><br>  O perfil base seccomp inclui tr√™s elementos: <code>defaultAction</code> , <code>architectures</code> (ou <code>archMap</code> ) e <code>syscalls</code> : <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"defaultAction"</span></span>: <span class="hljs-string"><span class="hljs-string">"SCMP_ACT_ERRNO"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"architectures"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"SCMP_ARCH_X86_64"</span></span>, <span class="hljs-string"><span class="hljs-string">"SCMP_ARCH_X86"</span></span>, <span class="hljs-string"><span class="hljs-string">"SCMP_ARCH_X32"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"syscalls"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"names"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"arch_prctl"</span></span>, <span class="hljs-string"><span class="hljs-string">"sched_yield"</span></span>, <span class="hljs-string"><span class="hljs-string">"futex"</span></span>, <span class="hljs-string"><span class="hljs-string">"write"</span></span>, <span class="hljs-string"><span class="hljs-string">"mmap"</span></span>, <span class="hljs-string"><span class="hljs-string">"exit_group"</span></span>, <span class="hljs-string"><span class="hljs-string">"madvise"</span></span>, <span class="hljs-string"><span class="hljs-string">"rt_sigprocmask"</span></span>, <span class="hljs-string"><span class="hljs-string">"getpid"</span></span>, <span class="hljs-string"><span class="hljs-string">"gettid"</span></span>, <span class="hljs-string"><span class="hljs-string">"tgkill"</span></span>, <span class="hljs-string"><span class="hljs-string">"rt_sigaction"</span></span>, <span class="hljs-string"><span class="hljs-string">"read"</span></span>, <span class="hljs-string"><span class="hljs-string">"getpgrp"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"action"</span></span>: <span class="hljs-string"><span class="hljs-string">"SCMP_ACT_ALLOW"</span></span> } ] }</code> </pre> <br>  <i>( <a href="https://gist.github.com/pjbgf/ef974f57693bb193f39e8add8a7040d7">medium-basic-seccomp.json</a> )</i> <br><br>  <code>defaultAction</code> determina o destino padr√£o de qualquer chamada do sistema n√£o especificada na se√ß√£o <code>syscalls</code> .  Para simplificar a tarefa, focamos em dois valores principais que ser√£o usados: <br><br><ul><li>  <code>SCMP_ACT_ERRNO</code> - bloqueia a execu√ß√£o de uma chamada do sistema, </li><li>  <code>SCMP_ACT_ALLOW</code> - permite. </li></ul><br>  A se√ß√£o <code>architectures</code> lista as arquiteturas de destino.  Isso √© importante, pois o pr√≥prio filtro, aplicado no n√≠vel do kernel, depende dos identificadores de chamadas do sistema, e n√£o dos nomes registrados no perfil.  Antes de usar, o tempo de execu√ß√£o do cont√™iner mapeia-os para identificadores.  O ponto √© que as chamadas do sistema podem ter IDs completamente diferentes, dependendo da arquitetura do sistema.  Por exemplo, a chamada do sistema <code>recvfrom</code> (usada para obter informa√ß√µes de um soquete) possui ID = 64 em sistemas x64 e ID = 517 em x86.  <a href="">Aqui</a> voc√™ pode encontrar uma lista de todas as chamadas do sistema para arquiteturas x86-x64. <br><br>  A se√ß√£o <code>syscalls</code> lista todas as chamadas do sistema e indica o que fazer com elas.  Por exemplo, voc√™ pode criar uma lista de permiss√µes definindo <code>defaultAction</code> como <code>SCMP_ACT_ERRNO</code> e atribuir chamadas √† se√ß√£o <code>SCMP_ACT_ALLOW</code> a <code>SCMP_ACT_ALLOW</code> .  Assim, voc√™ s√≥ permite chamadas registradas na se√ß√£o <code>syscalls</code> e pro√≠be todas as outras.  Para a lista negra, voc√™ deve alterar os valores e a√ß√µes <code>defaultAction</code> para o oposto. <br><br>  Agora, algumas palavras devem ser ditas sobre as nuances que n√£o s√£o t√£o √≥bvias.  Observe que as recomenda√ß√µes abaixo v√™m do fato de voc√™ estar implantando uma linha de aplicativos de neg√≥cios no Kubernetes e √© importante que eles trabalhem com o m√≠nimo de privil√©gios. <br><br><h2>  1. AllowPrivilegeEscalation = false </h2><br>  H√° um par√¢metro <code>AllowPrivilegeEscalation</code> no <code>securityContext</code> cont√™iner.  Se estiver definido como <code>false</code> , os cont√™ineres come√ßar√£o com o bit <a href="https://www.kernel.org/doc/Documentation/prctl/no_new_privs.txt"><code>no_new_priv</code></a> definido como ( <code>on</code> ).  O significado desse par√¢metro √© √≥bvio no nome: ele n√£o permite que o cont√™iner inicie novos processos com privil√©gios maiores do que aqueles que possui. <br><br>  Um efeito colateral desse par√¢metro definido como <code>true</code> (o valor padr√£o) √© que o tempo de execu√ß√£o do cont√™iner aplica o perfil seccomp no in√≠cio do processo de inicializa√ß√£o.  Portanto, todas as chamadas do sistema necess√°rias para iniciar os processos internos do tempo de execu√ß√£o (por exemplo, configurando identificadores de usu√°rio / grupo, eliminando alguns recursos) devem ser permitidas no perfil. <br><br>  O cont√™iner que executa o <code>echo hi</code> banal <code>echo hi</code> precisar√° das seguintes permiss√µes: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"defaultAction"</span></span>: <span class="hljs-string"><span class="hljs-string">"SCMP_ACT_ERRNO"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"architectures"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"SCMP_ARCH_X86_64"</span></span>, <span class="hljs-string"><span class="hljs-string">"SCMP_ARCH_X86"</span></span>, <span class="hljs-string"><span class="hljs-string">"SCMP_ARCH_X32"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"syscalls"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"names"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"arch_prctl"</span></span>, <span class="hljs-string"><span class="hljs-string">"brk"</span></span>, <span class="hljs-string"><span class="hljs-string">"capget"</span></span>, <span class="hljs-string"><span class="hljs-string">"capset"</span></span>, <span class="hljs-string"><span class="hljs-string">"chdir"</span></span>, <span class="hljs-string"><span class="hljs-string">"close"</span></span>, <span class="hljs-string"><span class="hljs-string">"execve"</span></span>, <span class="hljs-string"><span class="hljs-string">"exit_group"</span></span>, <span class="hljs-string"><span class="hljs-string">"fstat"</span></span>, <span class="hljs-string"><span class="hljs-string">"fstatfs"</span></span>, <span class="hljs-string"><span class="hljs-string">"futex"</span></span>, <span class="hljs-string"><span class="hljs-string">"getdents64"</span></span>, <span class="hljs-string"><span class="hljs-string">"getppid"</span></span>, <span class="hljs-string"><span class="hljs-string">"lstat"</span></span>, <span class="hljs-string"><span class="hljs-string">"mprotect"</span></span>, <span class="hljs-string"><span class="hljs-string">"nanosleep"</span></span>, <span class="hljs-string"><span class="hljs-string">"newfstatat"</span></span>, <span class="hljs-string"><span class="hljs-string">"openat"</span></span>, <span class="hljs-string"><span class="hljs-string">"prctl"</span></span>, <span class="hljs-string"><span class="hljs-string">"read"</span></span>, <span class="hljs-string"><span class="hljs-string">"rt_sigaction"</span></span>, <span class="hljs-string"><span class="hljs-string">"statfs"</span></span>, <span class="hljs-string"><span class="hljs-string">"setgid"</span></span>, <span class="hljs-string"><span class="hljs-string">"setgroups"</span></span>, <span class="hljs-string"><span class="hljs-string">"setuid"</span></span>, <span class="hljs-string"><span class="hljs-string">"stat"</span></span>, <span class="hljs-string"><span class="hljs-string">"uname"</span></span>, <span class="hljs-string"><span class="hljs-string">"write"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"action"</span></span>: <span class="hljs-string"><span class="hljs-string">"SCMP_ACT_ALLOW"</span></span> } ] }</code> </pre> <br>  <i>( <a href="https://gist.github.com/pjbgf/018658f1aeea1ef696b451bde8c33a8f">hi-pod-seccomp.json</a> )</i> <br><br>  ... em vez destes: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"defaultAction"</span></span>: <span class="hljs-string"><span class="hljs-string">"SCMP_ACT_ERRNO"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"architectures"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"SCMP_ARCH_X86_64"</span></span>, <span class="hljs-string"><span class="hljs-string">"SCMP_ARCH_X86"</span></span>, <span class="hljs-string"><span class="hljs-string">"SCMP_ARCH_X32"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"syscalls"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"names"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"arch_prctl"</span></span>, <span class="hljs-string"><span class="hljs-string">"brk"</span></span>, <span class="hljs-string"><span class="hljs-string">"close"</span></span>, <span class="hljs-string"><span class="hljs-string">"execve"</span></span>, <span class="hljs-string"><span class="hljs-string">"exit_group"</span></span>, <span class="hljs-string"><span class="hljs-string">"futex"</span></span>, <span class="hljs-string"><span class="hljs-string">"mprotect"</span></span>, <span class="hljs-string"><span class="hljs-string">"nanosleep"</span></span>, <span class="hljs-string"><span class="hljs-string">"stat"</span></span>, <span class="hljs-string"><span class="hljs-string">"write"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"action"</span></span>: <span class="hljs-string"><span class="hljs-string">"SCMP_ACT_ALLOW"</span></span> } ] }</code> </pre> <br>  <i>( <a href="https://gist.github.com/pjbgf/7c860ad818e3724d65a96ffdae5da808">hi-container-seccomp.json</a> )</i> <br><br>  Mas, novamente, por que isso √© um problema?  Pessoalmente, eu evitaria colocar na lista branca as seguintes chamadas do sistema (se elas n√£o forem realmente necess√°rias): <code>capset</code> , <code>set_tid_address</code> , <code>setgid</code> , <code>setgroups</code> e <code>setuid</code> .  No entanto, a dificuldade real √© que, ao permitir processos sobre os quais voc√™ n√£o tem absolutamente nenhum controle, voc√™ vincula perfis √† implementa√ß√£o do tempo de execu√ß√£o do cont√™iner.  Em outras palavras, um dia voc√™ pode encontrar o fato de que, ap√≥s atualizar o ambiente de tempo de execu√ß√£o do cont√™iner (por voc√™ ou, mais provavelmente, pelo provedor de servi√ßos em nuvem), os cont√™ineres parar√£o repentinamente. <br><br>  <b>Dica 1</b> : execute cont√™ineres com <code>AllowPrivilegeEscaltion=false</code> .  Isso reduzir√° o tamanho dos perfis seccomp e os tornar√° menos sens√≠veis √†s altera√ß√µes no tempo de execu√ß√£o do cont√™iner. <br><br><h2>  2. Configurando perfis seccomp no n√≠vel do cont√™iner </h2><br>  O perfil seccomp pode ser definido no n√≠vel do pod: <br><br><pre> <code class="plaintext hljs">annotations: seccomp.security.alpha.kubernetes.io/pod: "localhost/profile.json"</code> </pre> <br>  ... ou no n√≠vel do cont√™iner: <br><br><pre> <code class="plaintext hljs">annotations: container.security.alpha.kubernetes.io/&lt;container-name&gt;: "localhost/profile.json"</code> </pre> <br>  <i>Observe que a sintaxe acima ser√° alterada quando o Kubernetes seccomp <a href="https://github.com/kubernetes/enhancements/pull/1148">se tornar GA</a> (este evento √© esperado na pr√≥xima vers√£o do Kubernetes - 1.18 - aprox. Transl.).</i> <br><br>  Poucas pessoas sabem que o Kubernetes sempre teve um <a href="https://github.com/kubernetes/kubernetes/issues/84623">bug</a> que fazia com que os perfis seccomp fossem aplicados ao <a href="https://www.ianlewis.org/en/almighty-pause-container">cont√™iner de pausa</a> .  O tempo de execu√ß√£o compensa parcialmente essa desvantagem, mas esse cont√™iner n√£o desaparece dos pods, pois √© usado para configurar sua infraestrutura. <br><br>  O problema √© que esse cont√™iner sempre come√ßa com <code>AllowPrivilegeEscalation=true</code> , levando aos problemas <code>AllowPrivilegeEscalation=true</code> no par√°grafo 1, e isso n√£o pode ser alterado. <br><br>  Ao aplicar perfis seccomp no n√≠vel do cont√™iner, voc√™ evita essa intercepta√ß√£o e pode criar um perfil que ser√° "agu√ßado" para um cont√™iner espec√≠fico.  Isso ter√° que ser feito at√© que os desenvolvedores consertem o bug e a nova vers√£o (talvez 1,18?) Fique dispon√≠vel para todos. <br><br>  <b>Dica 2</b> : defina perfis seccomp no n√≠vel do cont√™iner. <br><br>  Em um sentido pr√°tico, essa regra geralmente serve como uma resposta universal √† pergunta: "Por que meu perfil seccomp funciona com o <code>docker run</code> , mas n√£o funciona ap√≥s a implanta√ß√£o em um cluster Kubernetes?" <br><br><h2>  3. Use o tempo de execu√ß√£o / padr√£o como √∫ltimo recurso </h2><br>  O Kubernetes possui duas op√ß√µes para perfis internos: <code>runtime/default</code> e <code>docker/default</code> .  Ambos s√£o implementados pelo tempo de execu√ß√£o do cont√™iner, n√£o pelo Kubernetes.  Portanto, eles podem diferir dependendo do tempo de execu√ß√£o usado e de sua vers√£o. <br><br>  Em outras palavras, como resultado da altera√ß√£o do tempo de execu√ß√£o, o cont√™iner pode acessar outro conjunto de chamadas do sistema que podem ser usadas ou n√£o.  A maioria dos tempos de execu√ß√£o usa <a href="">uma implementa√ß√£o do Docker</a> .  Se voc√™ deseja usar esse perfil, verifique se ele combina com voc√™. <br><br>  O <code>docker/default</code> perfil <code>docker/default</code> est√° obsoleto desde o Kubernetes 1.11, portanto, evite us√°-lo. <br><br>  Na minha opini√£o, o perfil de <code>runtime/default</code> √© perfeito para a finalidade para a qual foi criado: proteger os usu√°rios dos riscos associados √† execu√ß√£o do <code>docker run</code> em suas m√°quinas.  No entanto, se falarmos sobre aplicativos de neg√≥cios executados em clusters do Kubernetes, ousaria afirmar que esse perfil √© muito aberto e que os desenvolvedores devem se concentrar na cria√ß√£o de perfis para seus aplicativos (ou tipos de aplicativos). <br><br>  <b>Dica # 3</b> : Crie perfis seccomp para aplicativos espec√≠ficos.  Se isso n√£o for poss√≠vel, lide com perfis para tipos de aplicativos, por exemplo, crie um perfil avan√ßado que inclua todas as APIs de aplicativos da web Golang.  Somente como √∫ltimo recurso, use o tempo de execu√ß√£o / padr√£o. <br><br>  Nas pr√≥ximas publica√ß√µes, mostrarei como criar perfis secccomp no esp√≠rito do SecDevOps, automatizar e test√°-los em pipelines.  Em outras palavras, voc√™ n√£o ter√° desculpas para n√£o mudar para perfis para aplicativos espec√≠ficos. <br><br><h2>  4. N√£o confinado N√ÉO √© uma op√ß√£o </h2><br>  Desde a <a href="https://www.cncf.io/blog/2019/08/06/open-sourcing-the-kubernetes-security-audit/">primeira auditoria de seguran√ßa do Kubernetes,</a> o <a href="https://github.com/kubernetes/kubernetes/issues/81115">seccomp foi desativado</a> por padr√£o.  Isso significa que, se voc√™ n√£o especificar um <code>PodSecurityPolicy</code> que o habilitar√° no cluster, todos os pods para os quais o perfil seccomp n√£o est√° definido funcionar√£o no modo <code>seccomp=unconfined</code> . <br><br>  Trabalhar nesse modo significa que uma camada inteira de isolamento √© perdida, o que fornece prote√ß√£o de cluster.  Essa abordagem n√£o √© recomendada pelos profissionais de seguran√ßa. <br><br>  <b>Dica # 4</b> : Nenhum cont√™iner em um cluster deve funcionar no modo <code>seccomp=unconfined</code> , especialmente em ambientes de produ√ß√£o. <br><br><h2>  5. "Modo de auditoria" </h2><br>  Este ponto n√£o √© exclusivo do Kubernetes, mas ainda se enquadra na categoria de "o que voc√™ deve saber antes de come√ßar". <br><br>  Aconteceu que a cria√ß√£o de perfis seccomp sempre foi um neg√≥cio complicado e foi amplamente baseado em tentativa e erro.  O fato √© que os usu√°rios simplesmente n√£o t√™m a oportunidade de test√°-los em ambientes de produ√ß√£o sem arriscar "abandonar" o aplicativo. <br><br>  Ap√≥s o advento do kernel Linux 4.14, tornou-se poss√≠vel executar partes do perfil no modo de auditoria, registrando informa√ß√µes sobre todas as chamadas do sistema no syslog, mas n√£o as bloqueando.  Voc√™ pode ativar este modo usando o par√¢metro <code>SCMT_ACT_LOG</code> : <br><br>  <i><b>SCMP_ACT_LOG</b> : o seccomp n√£o afetar√° a opera√ß√£o de um encadeamento que faz uma chamada do sistema se n√£o se enquadrar em nenhuma regra do filtro, mas as informa√ß√µes sobre a chamada do sistema ser√£o registradas.</i> <br><br>  Aqui est√° um exemplo de estrat√©gia para usar esse recurso: <br><br><ol><li>  Permitir chamadas do sistema que s√£o necess√°rias. </li><li>  Sistemas de chamada em bloco que se sabe n√£o serem √∫teis. </li><li>  Registre informa√ß√µes sobre todas as outras chamadas no log. </li></ol><br>  Um exemplo simplificado √© o seguinte: <br><br><pre> <code class="plaintext hljs">{ "defaultAction": "SCMP_ACT_LOG", "architectures": [ "SCMP_ARCH_X86_64", "SCMP_ARCH_X86", "SCMP_ARCH_X32" ], "syscalls": [ { "names": [ "arch_prctl", "sched_yield", "futex", "write", "mmap", "exit_group", "madvise", "rt_sigprocmask", "getpid", "gettid", "tgkill", "rt_sigaction", "read", "getpgrp" ], "action": "SCMP_ACT_ALLOW" }, { "names": [ "add_key", "keyctl", "ptrace" ], "action": "SCMP_ACT_ERRNO" } ] }</code> </pre> <br>  <i>( <a href="https://gist.github.com/pjbgf/fa4f7a89937c486d940ac8ccf48379c9">medium-mixed-seccomp.json</a> )</i> <br><br>  Mas lembre-se de que voc√™ precisa bloquear todas as chamadas que s√£o conhecidas por n√£o serem utilizadas e que podem prejudicar o cluster.  Uma boa base para a listagem √© a <a href="https://docs.docker.com/engine/security/seccomp/">documenta√ß√£o</a> oficial do <a href="https://docs.docker.com/engine/security/seccomp/">Docker</a> .  Ele explica em detalhes quais chamadas do sistema est√£o bloqueadas no perfil padr√£o e por qu√™. <br><br>  No entanto, h√° uma captura.  Embora o <code>SCMT_ACT_LOG</code> suportado pelo kernel Linux desde o final de 2017, ele entrou recentemente apenas no ecossistema Kubernetes.  Portanto, para usar esse m√©todo, voc√™ precisar√° do kernel Linux 4.14 e da vers√£o runC n√£o inferior √† <a href="https://github.com/opencontainers/runc/releases/tag/v1.0.0-rc9">v1.0.0-rc9</a> . <br><br>  <b>Dica 5</b> : voc√™ pode criar um perfil de modo de auditoria para teste em produ√ß√£o combinando listas em preto e branco e registrar todas as exce√ß√µes. <br><br><h2>  6. Use listas brancas </h2><br>  Criar listas brancas requer esfor√ßos adicionais, pois voc√™ precisa identificar todas as chamadas que o aplicativo possa precisar, mas essa abordagem melhora significativamente a seguran√ßa: <br><br><blockquote>  <i>√â altamente recomend√°vel que voc√™ use a abordagem da lista de permiss√µes, pois √© mais simples e mais confi√°vel.</i>  <i>A lista negra precisar√° ser atualizada sempre que uma chamada do sistema potencialmente perigosa (ou sinalizador / op√ß√£o perigosa, se estiverem na lista negra) for adicionada.</i>  <i>Al√©m disso, voc√™ pode alterar frequentemente a apresenta√ß√£o de um par√¢metro sem alterar sua ess√™ncia e, assim, contornar as limita√ß√µes da lista negra.</i> </blockquote><br>  Para aplicativos Go, desenvolvi uma ferramenta especial que acompanha o aplicativo e coleta todas as chamadas feitas em tempo de execu√ß√£o.  Por exemplo, para o seguinte aplicativo: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { fmt.Println(<span class="hljs-string"><span class="hljs-string">"test"</span></span>) }</code> </pre> <br>  ... execute <code>gosystract</code> assim: <br><br><pre> <code class="bash hljs">go install https://github.com/pjbgf/gosystract gosystract --template=<span class="hljs-string"><span class="hljs-string">'{{- range . }}{{printf "\"%s\",\n" .Name}}{{- end}}'</span></span> application-path</code> </pre> <br>  ... e obtenha o seguinte resultado: <br><br><pre> <code class="plaintext hljs">"sched_yield", "futex", "write", "mmap", "exit_group", "madvise", "rt_sigprocmask", "getpid", "gettid", "tgkill", "rt_sigaction", "read", "getpgrp", "arch_prctl",</code> </pre> <br>  At√© agora, este √© apenas um exemplo - detalhes sobre as ferramentas ser√£o mais detalhados. <br><br>  <b>Dica # 6</b> : permita apenas chamadas que voc√™ realmente precisa e bloqueie todos os outros. <br><br><h2>  7. Estabele√ßa as bases (ou prepare-se para comportamentos inesperados) </h2><br>  O kernel monitorar√° a conformidade com o perfil, n√£o importa o que voc√™ registrou nele.  Mesmo que isso n√£o seja exatamente o que eu queria.  Por exemplo, se voc√™ bloquear o acesso a chamadas como <code>exit</code> ou <code>exit_group</code> , o cont√™iner n√£o poder√° concluir o trabalho corretamente e mesmo um comando simples como <code>echo hi</code> <a href="https://github.com/kubernetes/kubernetes/issues/85191">suspender√°</a> por um per√≠odo indeterminado.  Como resultado, voc√™ obter√° alta utiliza√ß√£o da CPU no cluster: <br><br><img src="https://habrastorage.org/webt/32/no/rt/32nortxic_d8czgqc5jnbzrb-ps.png"><br><br>  Nesses casos, o utilit√°rio <code>strace</code> pode ser √∫til - mostrar√° qual √© o problema: <br><br><img src="https://habrastorage.org/webt/hg/l3/eh/hgl3ehuqz8a6eprrsycubq_n6hu.png"><br> <i><code>sudo strace -c -p 9331</code></i> <br> <br>  Verifique se os perfis cont√™m todas as chamadas do sistema que o aplicativo precisa enquanto est√° em execu√ß√£o. <br><br>  <b>Dica 7</b> : Preste aten√ß√£o √†s pequenas coisas e verifique se todas as chamadas necess√°rias do sistema est√£o inclu√≠das na lista branca. <br><br>  Com isso, a primeira parte de uma s√©rie de artigos sobre o uso do seccomp no Kubernetes no esp√≠rito do SecDevOps chega ao fim.  Nas partes a seguir, falaremos sobre por que isso √© importante e como automatizar o processo. <br><br><h2>  PS do tradutor </h2><br>  Leia tamb√©m em nosso blog: <br><br><ul><li>  " <a href="https://habr.com/ru/company/flant/blog/474012/">Seguran√ßa para cont√™ineres do Docker</a> "; </li><li>  ‚Äú <a href="https://habr.com/ru/company/flant/blog/465141/">33+ Ferramentas de seguran√ßa Kubernetes</a> ‚Äù; </li><li>  ‚Äú <a href="https://habr.com/ru/company/flant/blog/440504/">Docker e Kubernetes em ambientes exigentes de seguran√ßa</a> ‚Äù; </li><li>  " <a href="https://habr.com/ru/company/flant/blog/436300/">9 Pr√°ticas recomendadas de seguran√ßa do Kubernetes</a> ." </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt481114/">https://habr.com/ru/post/pt481114/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt481102/index.html">Lan√ßamento do kit de ferramentas de interface do usu√°rio .NET entre plataformas AvaloniaUI 0.9</a></li>
<li><a href="../pt481104/index.html">Misturando OpenJDK e NodeJS: intera√ß√µes entre idiomas e arquitetura vertical</a></li>
<li><a href="../pt481106/index.html">Como LANIT filmou uma com√©dia DIY em seu escrit√≥rio</a></li>
<li><a href="../pt481110/index.html">Playme VEGA review: gravador combinado com tela sens√≠vel ao toque e montagem em espelho</a></li>
<li><a href="../pt481112/index.html">O que o "chiclete" de 5700 anos vai dizer sobre a pessoa que o mastigou?</a></li>
<li><a href="../pt481116/index.html">Publique automaticamente postagens da comunidade VKontakte no Discord</a></li>
<li><a href="../pt481118/index.html">An√¥nimo Papai Noel 2019-2020: p√≥s com presentes de Ano Novo</a></li>
<li><a href="../pt481120/index.html">Onde e como os servidores de borda s√£o aplicados?</a></li>
<li><a href="../pt481122/index.html">Antipatterns PostgreSQL: passando conjuntos e sele√ß√µes para SQL</a></li>
<li><a href="../pt481124/index.html">Dicas para escrever c√≥digo de auto-documenta√ß√£o</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>