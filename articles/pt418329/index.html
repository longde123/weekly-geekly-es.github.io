<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåÜ üö≤ ‚úä Organiza√ß√£o de testes seguros na produ√ß√£o. Parte 2 üëú üîª üö∂üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nesta parte do artigo, continuaremos a considerar v√°rios tipos de testes em produ√ß√£o. Quem pulou a primeira parte pode ler aqui . Para o resto - bem-v...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Organiza√ß√£o de testes seguros na produ√ß√£o. Parte 2</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/funcorp/blog/418329/"><img src="https://habrastorage.org/webt/ht/ra/sh/htrashsucmi8c4a6nok7rihdoay.png"><br><br>  Nesta parte do artigo, continuaremos a considerar v√°rios tipos de testes em produ√ß√£o.  Quem pulou a primeira parte pode ler <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> .  Para o resto - bem-vindo ao gato. <br><a name="habracut"></a><br><h2>  Teste de produ√ß√£o: Libera√ß√£o </h2><br>  Ap√≥s testar o servi√ßo ap√≥s a <i>implanta√ß√£o</i> , ele deve estar preparado para a <i>libera√ß√£o</i> . <br>  √â importante observar que, nesta fase, a revers√£o de altera√ß√µes √© poss√≠vel apenas em situa√ß√µes de falha <i>sustent√°vel</i> , por exemplo: <br><br><ul><li>  loop de falha de servi√ßo; </li><li>  exceder o tempo de espera por um n√∫mero significativo de conex√µes a montante, causando um forte aumento na frequ√™ncia de erros; </li><li>  mudan√ßa inaceit√°vel na configura√ß√£o, por exemplo, a falta de uma chave secreta em uma vari√°vel de ambiente que causa falha no servi√ßo (geralmente √© melhor evitar vari√°veis ‚Äã‚Äãde ambiente, mas esse √© um t√≥pico para outra discuss√£o). </li></ul><br>  Testes completos no est√°gio de <i>implanta√ß√£o</i> permitem minimizar idealmente ou evitar completamente surpresas desagrad√°veis ‚Äã‚Äãno est√°gio de <i>lan√ßamento</i> .  No entanto, existem v√°rias recomenda√ß√µes para a libera√ß√£o segura de novo c√≥digo. <br><br><h3>  Implanta√ß√£o das Can√°rias </h3><br>  <i>A implanta√ß√£o do Canary</i> √© uma <i>libera√ß√£o</i> parcial <i>de um</i> servi√ßo em produ√ß√£o.  √Ä medida que a verifica√ß√£o b√°sica de integridade passa, as pequenas partes do tr√°fego atual do ambiente de produ√ß√£o s√£o enviadas para as pe√ßas liberadas.  Os resultados das partes do servi√ßo s√£o monitorados √† medida que o tr√°fego √© processado, os indicadores s√£o comparados com os de refer√™ncia (n√£o relacionados aos can√°rios) e, se estiverem fora dos valores limite aceit√°veis, ser√° executada uma revers√£o para o estado anterior.  Embora essa abordagem seja normalmente usada ao liberar software de servidor, o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">teste can√°rio de software cliente</a> tamb√©m est√° se tornando mais comum. <br><br>  V√°rios fatores influenciam o tr√°fego que ser√° usado para a implanta√ß√£o de can√°rios.  Em v√°rias empresas, as partes liberadas do servi√ßo primeiro recebem apenas o tr√°fego interno do usu√°rio (o chamado dogfooding).  Se nenhum erro for observado, uma pequena parte do tr√°fego do ambiente de produ√ß√£o ser√° adicionada, ap√≥s o qual uma implementa√ß√£o completa ser√° realizada.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Recomenda-se</a> reverter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">automaticamente</a> para o estado anterior no caso de resultados inv√°lidos de implanta√ß√£o de can√°rios, e ferramentas como o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Spinnaker</a> t√™m suporte interno para fun√ß√µes de an√°lise e revers√£o automatizadas. <br><br>  Existem alguns problemas com o teste de can√°rio, e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=http://">este artigo</a> fornece uma vis√£o geral bastante completa deles. <br><br><h3>  Monitoramento </h3><br>  O monitoramento √© um procedimento absolutamente necess√°rio em <i>todas as</i> etapas da implanta√ß√£o do produto na produ√ß√£o, mas essa fun√ß√£o ser√° especialmente importante na fase de <i>lan√ßamento</i> .  O monitoramento √© adequado para obter informa√ß√µes sobre o n√≠vel geral de desempenho do sistema.  Mas monitorar tudo no mundo pode n√£o ser a melhor solu√ß√£o.  <i>O</i> monitoramento <i>eficaz</i> √© realizado no sentido do ponto, o que permite identificar um pequeno conjunto de modos de falha sustent√°vel do sistema ou um conjunto b√°sico de indicadores.  Exemplos de tais modos de falha podem ser: <br><br><ul><li>  aumento da taxa de erro; </li><li>  uma diminui√ß√£o na velocidade geral de processamento de solicita√ß√µes em todo o servi√ßo, em um endpoint espec√≠fico ou, pior ainda, em uma interrup√ß√£o completa do trabalho; </li><li>  atraso aumentado. </li></ul><br>  A observa√ß√£o de qualquer um desses modos de falha sustent√°vel √© a base para uma revers√£o imediata para um estado anterior ou uma revers√£o de novas vers√µes <i>lan√ßadas</i> do software.  √â importante lembrar que √© improv√°vel que o monitoramento nesta fase seja completo e indicativo.  Muitos acreditam que o n√∫mero ideal de sinais monitorados durante o monitoramento √© de 3 a 5, mas <i>definitivamente</i> n√£o mais que 7-10.  O white paper do Kraken Facebook oferece a seguinte solu√ß√£o: <br><br>  <i>"O problema √© resolvido com a ajuda de um componente de monitoramento facilmente configur√°vel, que reporta dois indicadores b√°sicos (o percentil 99 do tempo de resposta do servidor da Web e a frequ√™ncia de ocorr√™ncia de erros HTTP fatais) que descrevem objetivamente a qualidade da intera√ß√£o do usu√°rio".</i> <br><br>  O conjunto de indicadores de sistema e aplicativo que s√£o monitorados durante a fase de libera√ß√£o √© melhor determinado durante o design do sistema. <br><br><h3>  Rastreamento de exce√ß√£o </h3><br>  Estamos falando sobre o rastreamento de exce√ß√µes no est√°gio de lan√ßamento, embora possa parecer que nos est√°gios de <i>implanta√ß√£o</i> e ap√≥s o lan√ßamento isso n√£o seria menos √∫til.  As ferramentas de rastreamento de exce√ß√£o geralmente n√£o garantem a mesma abrang√™ncia, precis√£o e cobertura em massa que algumas outras ferramentas de monitoramento do sistema, mas ainda podem ser muito √∫teis. <br><br>  As ferramentas de c√≥digo aberto (como o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Sentry</a> ) exibem informa√ß√µes avan√ßadas sobre solicita√ß√µes recebidas e criam pilhas de dados de rastreamento e vari√°veis ‚Äã‚Äãlocais, o que simplifica bastante o processo de depura√ß√£o, que geralmente consiste em exibir logs de eventos.  O rastreamento de exce√ß√µes tamb√©m √© √∫til ao classificar e priorizar problemas que n√£o exigem uma revers√£o completa para um estado anterior (por exemplo, um caso de fronteira que gera uma exce√ß√£o). <br><br><h3>  Modelagem de tr√°fego </h3><br>  A modelagem do tr√°fego (redistribui√ß√£o do tr√°fego) n√£o √© tanto uma forma independente de teste, mas uma ferramenta para apoiar a abordagem can√°ria e o lan√ßamento em fases do novo c√≥digo.  De fato, a modelagem de tr√°fego √© garantida com a atualiza√ß√£o da configura√ß√£o do balanceador de carga, que permite redirecionar gradualmente mais tr√°fego para a nova vers√£o <i>lan√ßada</i> . <br><br>  Esse m√©todo tamb√©m √© √∫til para a implanta√ß√£o em fases de novo software (separada da implanta√ß√£o regular).  Considere um exemplo.  A Imgix precisava implantar uma arquitetura de infraestrutura fundamentalmente nova em junho de 2016.  Ap√≥s o primeiro teste da nova infraestrutura com uma certa quantidade de tr√°fego escuro, eles come√ßaram a implantar na produ√ß√£o, redirecionando inicialmente cerca de 1% do tr√°fego do ambiente de produ√ß√£o para uma nova pilha.  Ent√£o, ao longo de v√°rias semanas, o volume de dados que chegava √† nova pilha foi aumentado (resolvendo problemas ao longo do caminho), at√© que come√ßou a processar 100% do tr√°fego. <br><br>  A popularidade da arquitetura de malha de servi√ßo provocou um novo aumento no interesse em servidores proxy.  Como resultado, os proxies antigos (nginx, HAProxy) e os novos (Envoy, Conduit) adicionaram suporte para novas fun√ß√µes na tentativa de superar os concorrentes.  Parece-me que o futuro, no qual a redistribui√ß√£o de tr√°fego de 0 a 100% no est√°gio de lan√ßamento do produto √© realizada automaticamente, est√° chegando. <br><br><h2>  Teste de produ√ß√£o: Ap√≥s a libera√ß√£o </h2><br>  O teste p√≥s-libera√ß√£o √© realizado como uma verifica√ß√£o realizada <i>ap√≥s uma</i> <i>libera√ß√£o</i> bem <i>-</i> sucedida <i>do</i> c√≥digo.  Nesse est√°gio, voc√™ pode ter certeza de que o c√≥digo como um todo est√° correto, foi <i>liberado com</i> sucesso na produ√ß√£o e processa o tr√°fego corretamente.  O c√≥digo implantado √© usado direta ou indiretamente em condi√ß√µes reais, atendendo clientes reais ou executando tarefas que t√™m um impacto significativo nos neg√≥cios. <br><br>  O objetivo de qualquer teste neste est√°gio √© principalmente verificar a operacionalidade do sistema, levando em considera√ß√£o v√°rias cargas poss√≠veis e padr√µes de tr√°fego.  A melhor maneira de fazer isso √© coletar evid√™ncias documentais de tudo o que acontece na produ√ß√£o e us√°-lo para depura√ß√£o e para obter uma imagem completa do sistema. <br><br><h3>  Sinaliza√ß√£o de recurso ou inicializa√ß√£o escura </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=http://">A publica√ß√£o mais antiga</a> sobre o uso bem-sucedido de sinalizadores de recursos que eu encontrei foi publicada h√° quase dez anos.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O Featureflags.io</a> fornece o guia mais abrangente para isso. <br><br>  <i>‚ÄúA sinaliza√ß√£o de recurso √© um m√©todo usado pelos desenvolvedores para marcar uma nova fun√ß√£o usando instru√ß√µes if-then, o que permite mais controle sobre seu lan√ßamento.</i>  <i>Ao sinalizar uma fun√ß√£o e isol√°-la dessa maneira, o desenvolvedor pode ativar e desativar essa fun√ß√£o, independentemente do status da implanta√ß√£o.</i>  <i>Isso efetivamente separa a libera√ß√£o da fun√ß√£o da implanta√ß√£o do c√≥digo ".</i> <br><br>  Ao sinalizar o novo c√≥digo, voc√™ pode testar seu desempenho e desempenho na produ√ß√£o, conforme necess√°rio.  A sinaliza√ß√£o de recurso √© um dos tipos geralmente aceitos de teste em produ√ß√£o, √© bem conhecido e geralmente √© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">descrito</a> em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">v√°rias fontes</a> .  O fato de esse m√©todo poder ser usado no processo de teste da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">transfer√™ncia de bancos de dados</a> ou software para sistemas pessoais √© muito menos conhecido. <br><br>  Os autores dos artigos raramente escrevem sobre os melhores m√©todos para desenvolver e usar sinalizadores de fun√ß√£o.  O uso descontrolado de sinalizadores pode ser um problema s√©rio.  A falta de disciplina em termos de remo√ß√£o de sinalizadores n√£o utilizados ap√≥s um per√≠odo especificado √†s vezes leva ao fato de que voc√™ deve realizar uma auditoria completa e excluir sinalizadores obsoletos acumulados ao longo de meses (se n√£o anos) de trabalho. <br><br><h3>  Teste A / B </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O teste A / B √©</a> geralmente executado como parte de uma an√°lise experimental e n√£o √© considerado como teste na produ√ß√£o.  Por esse motivo, os testes A / B n√£o s√£o apenas amplamente utilizados (√†s vezes at√© de maneira <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">d√∫bia</a> ), mas tamb√©m <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=http://">estudados</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">descritos</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ativamente</a> (incluindo artigos sobre o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">que determina um scorecard eficaz</a> para experimentos on-line).  Muito menos comumente, os testes A / B s√£o usados ‚Äã‚Äãpara testar v√°rias configura√ß√µes de hardware ou m√°quinas virtuais.  Eles s√£o freq√ºentemente chamados de "ajuste" (por exemplo, ajuste da JVM), mas n√£o s√£o classificados como testes A / B t√≠picos (embora o ajuste possa ser considerado como um tipo de teste A / B executado com o mesmo n√≠vel de rigor no que diz respeito √†s medi√ß√µes) . <br><br><h3>  Logs, eventos, indicadores e rastreamento </h3><br>  Voc√™ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pode ler</a> sobre as chamadas ‚Äútr√™s baleias da observabilidade‚Äù - registros, indicadores e rastreamento distribu√≠do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br><h3>  Cria√ß√£o de perfil </h3><br>  Em alguns casos, para diagnosticar problemas de desempenho, √© necess√°rio usar o perfil do aplicativo na produ√ß√£o.  Dependendo dos idiomas e tempos de execu√ß√£o suportados, a cria√ß√£o de perfil pode ser um procedimento bastante simples, que envolve a adi√ß√£o de apenas uma linha de c√≥digo ao aplicativo ( <code>import _ "net/http/pprof"</code> no caso do Go).  Por outro lado, pode exigir o uso de muitas ferramentas ou testar o processo pelo m√©todo da caixa preta e verificar os resultados usando ferramentas como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">gr√°ficos de flama</a> . <br><br><h3>  Teste de Tee </h3><br>  Muitas pessoas consideram que esse teste √© algo como duplica√ß√£o de dados de sombra, pois em ambos os casos o tr√°fego do ambiente de produ√ß√£o √© enviado para clusters ou processos que n√£o s√£o de produ√ß√£o.  Na minha opini√£o, a diferen√ßa √© que o uso do tr√°fego para fins de <i>teste</i> √© um pouco diferente do seu uso para fins de <i>depura√ß√£o</i> . <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=http://">A Etsy escreveu em seu blog</a> sobre o uso de tee-tests como uma ferramenta de verifica√ß√£o (este exemplo realmente se parece com a duplica√ß√£o de dados de sombra). <br>  <i>‚ÄúAqui <b>tee</b> pode ser entendido como o comando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tee</a> na linha de comando.</i>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=http://devcentral.f5.com/articles/">Escrevemos</a> uma regra da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=http://devcentral.f5.com/articles/">iRule com</a> base em um balanceador de carga F5 existente para clonar o tr√°fego HTTP direcionado a um dos conjuntos e redirecion√°-lo para outro conjunto.</i>  <i>Assim, pudemos usar o tr√°fego do ambiente de produ√ß√£o direcionado ao nosso cluster de API e enviar uma c√≥pia dele para o cluster HHVM experimental, bem como para um cluster PHP isolado para compara√ß√£o.</i> <i><br></i>  <i>Esta t√©cnica provou ser muito eficaz.</i>  <i>Ele nos permitiu comparar o desempenho das duas configura√ß√µes usando perfis de tr√°fego id√™nticos. ‚Äù</i> <br><br>  No entanto, √†s vezes √© necess√°rio um teste tee com base no tr√°fego do ambiente de produ√ß√£o em um sistema aut√¥nomo para <i>depura√ß√£o</i> .  Nesses casos, o sistema aut√¥nomo pode ser alterado para configurar a sa√≠da de informa√ß√µes adicionais de diagn√≥stico ou outro procedimento de compila√ß√£o (por exemplo, usando a ferramenta de limpeza de fluxo), o que simplifica bastante o processo de solu√ß√£o de problemas.  Nesses casos, os testes tee devem ser considerados, em vez disso, <i>ferramentas de depura√ß√£o</i> , e n√£o <i>verifica√ß√£o</i> . <br><br>  Anteriormente, esses tipos de depura√ß√£o eram relativamente raros no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">imgix</a> , mas ainda eram usados, principalmente quando se tratava de problemas com aplicativos de depura√ß√£o sens√≠veis ao atraso. <br><br>  Por exemplo, a seguir, √© apresentada uma descri√ß√£o anal√≠tica de um desses incidentes ocorridos em 2015.  O erro 400 ocorreu t√£o raramente que quase n√£o foi visto ao tentar reproduzir o problema.  Ela apareceu em apenas alguns casos em um bilh√£o.  Havia muito poucos deles durante o dia.  Como resultado, verificou-se que era simplesmente imposs√≠vel reproduzir o problema de maneira confi√°vel, por isso era necess√°rio executar a depura√ß√£o usando o tr√°fego de trabalho para ter a chance de rastrear a ocorr√™ncia desse erro.  Aqui est√° o que meu ex-colega escreveu sobre isso: <br><br>  <i>‚ÄúEu escolhi uma biblioteca que deveria ser interna, mas no final tive que criar a minha pr√≥pria com base na biblioteca fornecida pelo sistema.</i>  <i>Na vers√£o fornecida pelo sistema, ocorreu um erro periodicamente que n√£o apareceu de forma alguma enquanto a quantidade de tr√°fego era pequena.</i>  <i>No entanto, o nome truncado no t√≠tulo era o problema real.</i> <i><br><br></i>  <i>Nos dois dias seguintes, estudei em detalhes o problema associado ao aumento da frequ√™ncia de erros falsos 400. O erro foi manifestado em um n√∫mero muito pequeno de solicita√ß√µes, e problemas desse tipo s√£o dif√≠ceis de diagnosticar.</i>  <i>Tudo isso parecia a not√≥ria agulha no palheiro: o problema foi encontrado em um caso por bilh√£o.</i> <i><br><br></i>  <i>A primeira etapa para localizar a origem dos erros foi obter todos os dados brutos da solicita√ß√£o HTTP que resultaram em uma resposta incorreta.</i>  <i>Para executar um teste tee do tr√°fego de entrada quando conectado a um soquete, adicionei o ponto de extremidade do soquete do dom√≠nio Unix ao servidor de renderiza√ß√£o.</i>  <i>A id√©ia era permitir a r√°pida e f√°cil ativa√ß√£o e desativa√ß√£o do fluxo de tr√°fego escuro e a realiza√ß√£o de testes diretamente no computador do desenvolvedor.</i>  <i>Para evitar problemas na produ√ß√£o, era necess√°rio interromper a conex√£o se houvesse um problema de contrapress√£o.</i>  <i>I.e.</i>  <i>se a duplicata n√£o conseguir lidar com a tarefa, ela ser√° desconectada.</i>  <i>Esse soquete foi muito √∫til em alguns casos durante o desenvolvimento.</i>  <i>Desta vez, no entanto, n√≥s o usamos para coletar o tr√°fego recebido nos servidores selecionados, na esperan√ßa de obter solicita√ß√µes suficientes para revelar o padr√£o que levou ao aparecimento de erros falsos 400. Usando o dsh e o netcat, consegui produzir com relativa facilidade o tr√°fego recebido para um arquivo local .</i> <i><br><br></i>  <i>A maior parte do ambiente foi gasta coletando esses dados.</i>  <i>Assim que tivemos dados suficientes, pude usar o netcat para reproduzi-lo no sistema local, cuja configura√ß√£o foi alterada para exibir uma grande quantidade de informa√ß√µes de depura√ß√£o.</i>  <i>E tudo correu perfeitamente.</i>  <i>O pr√≥ximo passo √© reproduzir os dados na velocidade mais alta poss√≠vel.</i>  <i>Nesse caso, o loop com a verifica√ß√£o da condi√ß√£o enviou as solicita√ß√µes brutas uma de cada vez.</i>  <i>Ap√≥s cerca de duas horas, consegui alcan√ßar o resultado desejado.</i>  <i>Os dados nos logs mostraram a falta de um cabe√ßalho!</i> <i><br><br></i>  <i>Eu uso madeira vermelho-preta para transmitir os cabe√ßalhos.</i>  <i>Tais estruturas consideram comparabilidade como identidade, o que por si s√≥ √© muito √∫til quando h√° requisitos especiais para chaves: no nosso caso, os cabe√ßalhos HTTP n√£o diferenciavam mai√∫sculas de min√∫sculas.</i>  <i>Inicialmente, pensamos que o problema estava no n√≥ da folha da biblioteca usada.</i>  <i>A ordem de adi√ß√£o realmente afeta a ordem de constru√ß√£o da √°rvore base, e equilibrar a √°rvore vermelho-preta √© um processo bastante complicado.</i>  <i>E embora essa situa√ß√£o fosse improv√°vel, n√£o era imposs√≠vel.</i>  <i>Eu mudei para outra implementa√ß√£o de √©bano vermelho.</i>  <i>Foi consertado h√° v√°rios anos, ent√£o decidi incorpor√°-lo diretamente na fonte para obter exatamente a vers√£o necess√°ria.</i>  <i>No entanto, a montagem escolheu uma vers√£o diferente e, como eu estava contando com uma vers√£o mais nova, tive um comportamento incorreto no final.</i> <i><br><br></i>  <i>Por isso, o sistema de visualiza√ß√£o gerou 500 erros, o que levou √† interrup√ß√£o do ciclo.</i>  <i>√â por isso que o erro ocorreu apenas ao longo do tempo.</i>  <i>Ap√≥s o processamento c√≠clico de v√°rios assemblies, o tr√°fego deles foi redirecionado para uma rota diferente, o que aumentou a escala do problema nesse servidor.</i>  <i>Minha suposi√ß√£o de que o problema estava na biblioteca estava errada, e a chave reversa resolveu 500 erros.</i> <i><br><br></i>  <i>Voltei a 400 erros: ainda havia um problema com o erro, que levou cerca de duas horas para ser detectado.</i>  <i>Alterar a biblioteca, obviamente, n√£o resolveu o problema, mas eu tinha certeza de que a biblioteca selecionada era confi√°vel o suficiente.</i>  <i>N√£o percebendo a fal√°cia da escolha, n√£o mudei nada.</i>  <i>Tendo estudado a situa√ß√£o com mais detalhes, percebi que o valor correto estava armazenado em um cabe√ßalho de um caractere (por exemplo, "h: 12345").</i>  <i>Finalmente me ocorreu que h era o personagem final do cabe√ßalho Content-Length.</i>  <i>Observando os dados novamente, percebi que o cabe√ßalho Content-Length estava vazio.</i> <i><br><br></i>  <i>Como resultado, a coisa toda foi um erro de vi√©s ao ler os cabe√ßalhos.</i>  <i>O analisador HTTP nginx / joyent cria dados parciais e, cada vez que o campo do cabe√ßalho parcial era um caractere menor que o necess√°rio, enviava o cabe√ßalho sem um valor e, subsequentemente, recebia um campo de cabe√ßalho de um caractere contendo o valor correto.</i>  <i>Essa √© uma combina√ß√£o bastante rara, portanto, sua opera√ß√£o leva tanto tempo.</i>  <i>Portanto, aumentei a quantidade de coleta de dados toda vez que um cabe√ßalho de um caractere apareceu, apliquei a corre√ß√£o proposta e executei o script com √™xito por v√°rias horas.</i> <i><br></i>  <i>√â claro que algumas outras armadilhas com o mau funcionamento da biblioteca mencionado podem ser detectadas, mas os dois erros foram corrigidos. ‚Äù</i> <i><br></i> <br><br>  Os engenheiros envolvidos no desenvolvimento de aplicativos sens√≠veis ao atraso precisam da capacidade de depurar usando o tr√°fego din√¢mico capturado, porque geralmente ocorrem erros que n√£o podem ser reproduzidos durante o teste da unidade ou detectados usando uma ferramenta de monitoramento (especialmente se houver um atraso grave no registro). <br><br><h3>  Abordagem da Engenharia do Caos </h3><br>  <i>A Engenharia do Caos √© uma abordagem baseada em experimentos em um sistema distribu√≠do para confirmar sua capacidade de suportar as condi√ß√µes ca√≥ticas do ambiente de produ√ß√£o.</i> <br><br>  O m√©todo Chaos Engineering, tornado famoso pelo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Chaos Monkey</a> da Netflix, agora se tornou uma disciplina independente.  O termo Engenharia do Caos apareceu recentemente, mas o teste de falhas √© uma pr√°tica de longa data. <br><br>  O termo "teste ca√≥tico" refere-se √†s seguintes t√©cnicas: <br><br><ul><li>  desabilitar n√≥s arbitr√°rios para determinar qu√£o resistente o sistema √© √† falha; </li><li>  introdu√ß√£o de erros (por exemplo, aumento do atraso) para confirmar que o sistema os processa corretamente; </li><li>  viola√ß√£o for√ßada da rede para determinar a resposta do servi√ßo. </li></ul><br>  A maioria das empresas usa um ambiente operacional insuficientemente complexo e hier√°rquico para realizar efetivamente testes ca√≥ticos.  √â importante enfatizar que a introdu√ß√£o de falhas no sistema √© melhor feita ap√≥s definir as fun√ß√µes b√°sicas da toler√¢ncia a falhas.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Este white paper de</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Gremlin</a> fornece uma descri√ß√£o bastante abrangente dos princ√≠pios de testes ca√≥ticos, al√©m de instru√ß√µes para a prepara√ß√£o deste procedimento. <br><br>  <i>‚ÄúEspecialmente importante √© o fato de a Chaos Engineering ser considerada uma disciplina cient√≠fica.</i>  <i>Dentro desta disciplina, processos de engenharia de alta precis√£o s√£o aplicados.</i> <i><br></i>  <i>A tarefa da Chaos Engineering √© <b>informar</b> aos usu√°rios algo novo sobre as vulnerabilidades do sistema, realizando experimentos.</i>  <i>√â necess√°rio identificar todos os problemas ocultos que podem surgir na produ√ß√£o, mesmo antes que causem uma falha maci√ßa.</i>  <i>Somente depois disso voc√™ poder√° eliminar efetivamente todas as fraquezas do sistema e torn√°-lo verdadeiramente tolerante a falhas. ‚Äù</i> <br><br><h2>  Conclus√£o </h2><br>  O objetivo do teste na produ√ß√£o n√£o √© <i>eliminar</i> completamente todas as falhas poss√≠veis no sistema.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">John Allspaw</a> diz: <br>  <i>‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Vemos que os</a> sistemas est√£o se tornando mais tolerantes a falhas - e isso √© √≥timo.</i>  <i>Mas devemos admitir: "mais e mais" n√£o √© igual a "absolutamente".</i>  <i>Em qualquer sistema complexo, uma falha pode acontecer (e acontecer√°) da maneira mais imprevis√≠vel. ‚Äù</i> <i><br></i> <br>  Testar a produ√ß√£o √† primeira vista pode parecer uma tarefa bastante complicada, indo muito al√©m da compet√™ncia da maioria das empresas de engenharia.  E embora esse teste <i>n√£o</i> seja uma tarefa <i>f√°cil</i> , associada a alguns riscos, se voc√™ o seguir de acordo com todas as regras, ajudar√° a obter a confiabilidade de sistemas distribu√≠dos complexos encontrados hoje em toda parte. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt418329/">https://habr.com/ru/post/pt418329/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt418317/index.html">2048 √© proibido. N√£o RosKomNadzor</a></li>
<li><a href="../pt418319/index.html">Gauss LED Bulbs 2017-2018</a></li>
<li><a href="../pt418321/index.html">Gerador de n√∫mero aleat√≥rio de f√≥tons: a criptografia mais confi√°vel?</a></li>
<li><a href="../pt418323/index.html">Um pouco sobre os atributos dos hosts, teclado, c√≥digo e SCS da s√©rie "Mundo do Oeste Selvagem" (Westworld)</a></li>
<li><a href="../pt418327/index.html">Sapateiros com botas: quais smartphones os especialistas escolhem para si</a></li>
<li><a href="../pt418331/index.html">Mestres de servidores e redes - feliz feriado</a></li>
<li><a href="../pt418333/index.html">Rob√¥s Uber est√£o voltando para a estrada, mas as pessoas os guiar√£o</a></li>
<li><a href="../pt418335/index.html">Confronto no Positive Hack Days 8: analisando cadeias de ataques</a></li>
<li><a href="../pt418337/index.html">DataGrip quente e de ver√£o 2018.2</a></li>
<li><a href="../pt418339/index.html">Manipulador "Manual"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>