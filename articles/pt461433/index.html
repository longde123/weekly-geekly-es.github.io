<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôÜüèª üçõ üê± Usando o Identity Server 4 no Net Core 3.0 üëø üë©üèº‚Äçü§ù‚Äçüë®üèø üë©</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="1. Introdu√ß√£o 


 Um dos meus projetos suportados recentemente enfrentou a tarefa de analisar a possibilidade de migrar do .NET framework 4.5 para o ....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Usando o Identity Server 4 no Net Core 3.0</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461433/"><h2 id="vvedenie">  1. Introdu√ß√£o </h2><br><p>  Um dos meus projetos suportados recentemente enfrentou a tarefa de analisar a possibilidade de migrar do .NET framework 4.5 para o .Net Core no caso de necessidade de refatora√ß√£o e cobran√ßa de uma grande quantidade de d√≠vida t√©cnica acumulada.  A escolha recaiu sobre a plataforma de destino .NET Core 3.0, pois, de acordo com os desenvolvedores da Microsoft, com o lan√ßamento da vers√£o 3.0, as etapas necess√°rias para a migra√ß√£o do c√≥digo legado diminuir√£o v√°rias vezes.  Especialmente, fomos atra√≠dos pelos planos de sa√≠da do EntityFramework 6.3 para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">.Net Core,</a> ou seja,  a maior parte do c√≥digo baseado no EF 6.2 pode ser deixada "como est√°" em um projeto migrado no net core. </p><br><p>  Com o n√≠vel de dados, ao que parece, ficou claro, no entanto, outra grande parte da portabilidade de c√≥digo foi o n√≠vel de seguran√ßa, que, infelizmente, ap√≥s uma r√°pida auditoria, voc√™ ter√° que jog√°-lo quase completamente fora e reescrev√™-lo do zero.  Felizmente, o projeto j√° utilizava parte do ASP NET Identity, na forma de armazenamento de usu√°rios e outras ‚Äúbicicletas‚Äù presas ao lado. </p><br><p>  Isso levanta a quest√£o l√≥gica: se a parte de seguran√ßa precisa fazer muitas altera√ß√µes, por que n√£o implementar imediatamente as abordagens recomendadas na forma de padr√µes do setor, a saber: levar o aplicativo a usar Open Id connect e OAuth usando a estrutura <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">IdentityServer4</a> . </p><a name="habracut"></a><br><h2 id="problemy-i-puti-resheniya">  Problemas e solu√ß√µes </h2><br><p>  Portanto, nos foi dado: existe um aplicativo JavaScript em Angular (cliente em termos IS4), ele usa um determinado subconjunto de WebAPI (Recursos), h√° tamb√©m um banco de dados de identidade ASP NET desatualizado com logins de usu√°rio que devem ser reutilizados ap√≥s a atualiza√ß√£o (para n√£o iniciar todos os outros vezes) e, em alguns casos, √© necess√°rio dar a oportunidade de fazer login no sistema atrav√©s da autentica√ß√£o do Windows no lado do IdentityServer4.  I.e.  H√° momentos em que os usu√°rios trabalham atrav√©s de uma rede local em um dom√≠nio do ActiveDirectory. </p><br><p>  A principal solu√ß√£o para a migra√ß√£o de dados do usu√°rio √© escrever manualmente (ou usar ferramentas automatizadas) um script de migra√ß√£o entre o antigo e o novo esquema de dados de identidade.  Por sua vez, usamos o aplicativo de compara√ß√£o de esquema de dados automatizado e geramos um script SQL, dependendo da vers√£o do Identity, o script de migra√ß√£o de destino conter√° instru√ß√µes de atualiza√ß√£o diferentes.  O principal aqui √© n√£o se esque√ßa de coordenar a tabela EFMigrationsHistory se o EF tiver sido usado antes e estiver planejado no futuro, por exemplo, expandir a entidade IdentityUser para campos adicionais. </p><br><p>  Mas como configurar corretamente o IdentityServer4 agora e configur√°-lo junto com as contas do Windows ser√° descrito abaixo. </p><br><h2 id="plan-realizacii">  Plano de implementa√ß√£o </h2><br><p>  Por motivos de NDA, n√£o descreverei como conseguimos implementar o IS4 em nosso projeto. No entanto, neste artigo, mostrarei em um site simples do ASP.NET Core criado do zero as etapas necess√°rias para obter um aplicativo totalmente configurado e funcional que usa o IdentityServer4 para fins de autoriza√ß√£o e autentica√ß√£o. <br>  Para realizar o comportamento desejado, precisamos executar as seguintes etapas: </p><br><ul><li>  Crie um projeto vazio do ASP.Net Core e configure para usar o IdentityServer4. </li><li>  Adicione um cliente como um aplicativo Angular. </li><li>  Fa√ßa login atrav√©s do open-id-connect google </li><li>  Adicionar op√ß√£o de autentica√ß√£o do Windows </li></ul><br><p>  Por motivos de brevidade, todos os tr√™s componentes (IdentityServer, WebAPI, cliente Angular) estar√£o no mesmo projeto.  O tipo selecionado de intera√ß√£o entre o cliente e o IdentityServer (GrantType) √© um fluxo impl√≠cito, quando o access_token √© passado para o lado do aplicativo no navegador e, em seguida, usado ao interagir com a WebAPI.  <em>Mais perto do lan√ßamento, a julgar pelas altera√ß√µes no reposit√≥rio do ASP.NET Core, o fluxo impl√≠cito ser√° substitu√≠do pelo C√≥digo de autoriza√ß√£o + PKCE.)</em> </p><br><p>  No processo de cria√ß√£o e modifica√ß√£o do aplicativo, a interface de linha de comando do .NET Core ser√° amplamente usada. Ela deve ser instalada no sistema no local com a vers√£o mais recente da visualiza√ß√£o do Core 3.0 (no momento da reda√ß√£o do artigo 3.0.100-preview7-012821). </p><br><h2 id="sozdanie-i-konfigurirovanie-web-proekta">  Cria√ß√£o e configura√ß√£o de um projeto web </h2><br><p>  O lan√ßamento do IdentityServer vers√£o 4 foi marcado pelo corte completo da interface do usu√°rio a partir dessa estrutura.  Agora, os desenvolvedores t√™m todo o direito de determinar a interface principal do servidor de autoriza√ß√£o.  Existem v√°rias maneiras.  Um dos mais populares √© usar a interface do usu√°rio no pacote QuickStart UI, que pode ser encontrado no reposit√≥rio oficial no <a href="">github</a> . </p><br><p>  Outra maneira, n√£o menos conveniente, √© a integra√ß√£o com a UI de identidade principal do ASP NET. Nesse caso, o desenvolvedor precisa configurar corretamente o middleware correspondente no projeto.  Este m√©todo ser√° descrito mais adiante. </p><br><p>  Vamos come√ßar criando um projeto simples da Web. Para fazer isso, execute a seguinte instru√ß√£o na linha de comando: </p><br><pre><code class="plaintext hljs">dotnet new webapp -n IdentityServer4WebApp</code> </pre> <br><p>  Ap√≥s a execu√ß√£o, a sa√≠da ser√° uma estrutura de aplicativo da web, que ser√° gradualmente levada ao estado que precisamos.  Aqui voc√™ precisa fazer uma reserva de que o .Net Core 3.0 for Identity usa RazorPages mais leves, ao contr√°rio do MVC pesado. <br>  Agora voc√™ precisa adicionar o suporte ao IdentityServer ao nosso projeto.  Para fazer isso, instale os pacotes necess√°rios: </p><br><pre> <code class="plaintext hljs">dotnet add package Microsoft.AspNetCore.ApiAuthorization.IdentityServer -v 3.0.0-preview7.19365.7 dotnet add package Microsoft.AspNetCore.Identity.EntityFrameworkCore -v 3.0.0-preview7.19365.7 dotnet add package Microsoft.EntityFrameworkCore.Tools -v 3.0.0-preview7.19362.6 dotnet add package Microsoft.EntityFrameworkCore.Sqlite -v 3.0.0-preview7.19362.6</code> </pre> <br><p>  Al√©m de links para pacotes de servidores de autoriza√ß√£o, adicionamos aqui o suporte ao Entity Framework para armazenar informa√ß√µes do usu√°rio no ecossistema Identity.  Para simplificar, usaremos o banco de dados SQLite. </p><br><p>  Para inicializar o banco de dados, crie nosso modelo de usu√°rio e contexto de banco de dados. Para isso, declaramos duas classes ApplicationUser, herdadas de <em>IdentityUser</em> na pasta Models e <em>ApplicationDbContext</em> , herdadas de: <em>ApiAuthorizationDbContext na pasta Data.</em> <br></p><p>  Em seguida, voc√™ precisa configurar o uso do contexto EntityFramework e criar o banco de dados.  Para fazer isso, escrevemos o contexto no m√©todo <em>ConfigureServices</em> da classe Startup: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigureServices</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IServiceCollection services</span></span></span><span class="hljs-function">)</span></span> { services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt;options.UseSqlite(Configuration.GetConnectionString(<span class="hljs-string"><span class="hljs-string">"DefaultConnection"</span></span>))); services.AddRazorPages(); }</code> </pre> <br><p>  E adicione a cadeia de conex√£o a <em>appsettings.json</em> </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"ConnectionStrings"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"DefaultConnection"</span></span>: <span class="hljs-string"><span class="hljs-string">"Data Source=data.db"</span></span> },</code> </pre><br><p>  Agora voc√™ pode criar a migra√ß√£o inicial e inicializar o esquema do banco de dados.  √â importante notar que a ferramenta instalada para o ef core √© necess√°ria (para a visualiza√ß√£o em quest√£o, √© necess√°ria a vers√£o 3.0.0-preview7.19362.6). </p><br><pre> <code class="plaintext hljs">dotnet ef migrations add Init dotnet ef database update</code> </pre> <br><p>  Se todas as etapas anteriores foram conclu√≠das sem erros, o arquivo de dados SQLite data.db deve aparecer no seu projeto. </p><br><p>  Nesse est√°gio, podemos configurar e testar totalmente a capacidade de usar o Asp.Net Core Identity.  Para fazer isso, fa√ßa altera√ß√µes nos m√©todos de <em>inicializa√ß√£o.</em>  <em>Configure</em> e <em>Startup.ConfigureServices</em> . </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Startup.ConfigureServices: services.AddDefaultIdentity&lt;ApplicationUser&gt;() .AddEntityFrameworkStores&lt;ApplicationDbContext&gt;(); //Startup. Configure: app.UseAuthentication(); app.UseAuthorization(); app.UseEndpoints(endpoints =&gt; { endpoints.MapRazorPages(); });</span></span></code> </pre> <br><p>  Com essas linhas, incorporamos a possibilidade de autentica√ß√£o e autoriza√ß√£o no pipeline de processamento de solicita√ß√µes.  E tamb√©m adicione a interface do usu√°rio padr√£o para Identity. <br>  Resta apenas corrigir a interface do usu√°rio, adicionar √† Pages \ Shared uma nova visualiza√ß√£o do Razor com o nome <em>_LoginPartial.cshtml</em> e o seguinte conte√∫do: </p><br><pre> <code class="html hljs xml">@using IdentityServer4WebApp.Models @using Microsoft.AspNetCore.Identity @inject SignInManager<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ApplicationUser</span></span></span><span class="hljs-tag">&gt;</span></span> SignInManager @inject UserManager<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ApplicationUser</span></span></span><span class="hljs-tag">&gt;</span></span> UserManager <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-nav"</span></span></span><span class="hljs-tag">&gt;</span></span> @if (SignInManager.IsSignedIn(User)) { <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Identity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Account/Manage/Index"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Manage"</span></span></span><span class="hljs-tag">&gt;</span></span>Hello @User.Identity.Name!<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form-inline"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Identity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Account/Logout"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-route-returnUrl</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link btn btn-link text-dark"</span></span></span><span class="hljs-tag">&gt;</span></span>Logout<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> } else { <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Identity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Account/Register"</span></span></span><span class="hljs-tag">&gt;</span></span>Register<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Identity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Account/Login"</span></span></span><span class="hljs-tag">&gt;</span></span>Login<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> } <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><p>  O c√≥digo de apresenta√ß√£o acima deve adicionar links √† √°rea da interface Identity com controles de usu√°rio integrados no painel de navega√ß√£o (login e senha, registro, etc.) </p><br><p>  Para obter a renderiza√ß√£o de novos itens de menu, simplesmente <em>modificamos o</em> arquivo <em>_Layout.cshtml</em> adicionando a renderiza√ß√£o dessa exibi√ß√£o parcial. </p><br><pre> <code class="html hljs xml"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-nav flex-grow-1"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Index"</span></span></span><span class="hljs-tag">&gt;</span></span>Home<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Privacy"</span></span></span><span class="hljs-tag">&gt;</span></span>Privacy<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">partial</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_LoginPartial"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">!‚Äì‚Äì‚Äì‚Äì</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><p>  E agora vamos tentar executar nosso aplicativo e clicar nos links que aparecem na cabe√ßa <br>  No menu, o usu√°rio deve ver uma p√°gina com boas-vindas e solicita√ß√£o <br>  digite login e senha.  Nesse caso, voc√™ pode se registrar e fazer login - todos <br>  deve funcionar. </p><br><p><img src="https://habrastorage.org/webt/yl/a2/yl/yla2yln6zflkftldetnacko8trm.png"></p><br><p>  Os desenvolvedores do IdentityServer4 fizeram um excelente trabalho para melhorar a integra√ß√£o do ASP.NET Identity e a pr√≥pria estrutura do servidor.  Para adicionar a capacidade de usar tokens OAuth2, voc√™ precisa complementar nosso projeto com algumas novas instru√ß√µes no c√≥digo. </p><br><p>  Na pen√∫ltima linha do m√©todo <em>Startup.ConfigureServices,</em> adicione a configura√ß√£o das conven√ß√µes IS4 sobre a identidade principal do ASP.NET: </p><br><pre> <code class="cs hljs">services.AddIdentityServer() .AddApiAuthorization&lt;ApplicationUser, ApplicationDbContext&gt;();</code> </pre> <br><p>  O m√©todo AddApiAuthorization instrui a estrutura a usar uma configura√ß√£o espec√≠fica suportada, principalmente por meio do arquivo appsettings.json.  No momento, os recursos internos de gerenciamento do IS4 n√£o s√£o t√£o flex√≠veis e devem ser considerados como um ponto de partida para a cria√ß√£o de seus aplicativos.  De qualquer forma, voc√™ pode usar a vers√£o sobrecarregada desse m√©todo e configurar os par√¢metros com mais detalhes por meio de retorno de chamada. </p><br><p>  Em seguida, chamamos o m√©todo helper, que configura o aplicativo para verificar os tokens JWT emitidos pela estrutura. </p><br><pre> <code class="cs hljs">services.AddAuthentication() .AddIdentityServerJwt();</code> </pre> <br><p>  Por fim, no m√©todo <em>Startup.Configure,</em> adicione middleware para <br>  Fornecendo pontos de extremidade Open ID Connect </p><br><pre> <code class="cs hljs">app.UseAuthentication(); app.UseAuthorization(); app.UseIdentityServer();<span class="hljs-comment"><span class="hljs-comment">//&lt;-</span></span></code> </pre> <br><p>  Como mencionado acima, os m√©todos auxiliares usados ‚Äã‚Äãleem a configura√ß√£o em <br>  arquivo de configura√ß√µes do aplicativo <em>appsettings.json</em> , no qual devemos adicionar um novo <br>  Se√ß√£o <em>IdentityServer</em> . </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"IdentityServer"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Clients"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"TestIdentityAngular"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Profile"</span></span>: <span class="hljs-string"><span class="hljs-string">"IdentityServerSPA"</span></span> } } }</code> </pre> <br><p>  Nesta se√ß√£o, um cliente √© definido com o nome TestIdentityAngular, que atribuiremos ao futuro cliente do navegador e a um perfil de configura√ß√£o espec√≠fico. </p><br><p>  O Application Profiles √© uma nova ferramenta de configura√ß√£o do IdentityServer que fornece v√°rias configura√ß√µes predefinidas com a capacidade de refinar determinados par√¢metros.  Usaremos o perfil <em>IdentityServerSPA</em> , projetado para casos em que o cliente do navegador e a estrutura est√£o localizados no mesmo projeto e t√™m os seguintes par√¢metros: </p><br><ul><li>  O recurso redirect_uri definido como <em>/ authentication / login-callback</em> . </li><li>  Recurso post_logout_redirect_uri, definido como <em>/ authentication / logout-callback.</em> </li><li>  O conjunto de √°reas inclui openid, profile, para cada recurso da API do aplicativo. </li><li>  Conjunto de tipos de resposta OIDC permitidos - token id_token </li><li>  GrantType para o cliente - impl√≠cito </li></ul><br><p>  Outros perfis poss√≠veis s√£o <em>SPA</em> (aplicativo sem IS4), <em>IdentityServerJwt</em> (API compartilhada com IS4), <em>API</em> (API separada). </p><br><p>  Al√©m disso, a configura√ß√£o registra recursos: </p><br><ul><li>  ApiResources: um recurso da API denominado &lt;&lt; appname &gt;&gt; API com propriedades para todos os clientes (*). </li><li>  IdentityServerResources: <em>IdentityResources.OpenId ()</em> e <em>IdentityResources.Profile ()</em> </li></ul><br><p>  Como voc√™ sabe, o IdentityServer usa certificados para assinar tokens, seus par√¢metros tamb√©m podem ser definidos no arquivo de configura√ß√£o, portanto, no momento do teste, podemos usar <br>  certificado de teste x509, para isso, √© necess√°rio especific√°-lo na se√ß√£o "Chave" do arquivo <em>appsettings.Development.json</em> . </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"IdentityServer"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Key"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Type"</span></span>: <span class="hljs-string"><span class="hljs-string">"Development"</span></span> } }</code> </pre> <br><p>  Agora, podemos dizer que o back-end que permite usar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">IdentityServer est√° pronto</a> e voc√™ pode come√ßar a implementar o aplicativo do navegador. </p><br><h2 id="realizaciya-klienta-na-angular">  Implementa√ß√£o de cliente angular </h2><br><p>  Nosso SPA baseado em navegador ser√° escrito na plataforma Angular.  O aplicativo conter√° duas p√°ginas, uma para usu√°rios n√£o autorizados e outra para usu√°rios autenticados.  Os exemplos usam a vers√£o 8.1.2 </p><br><p>  Primeiro, crie a estrutura futura: </p><br><pre> <code class="plaintext hljs">ng new ClientApp</code> </pre> <br><p>  No processo de cria√ß√£o, voc√™ precisa responder "sim" √† proposta para usar o roteamento.  E estilize um pouco a p√°gina na biblioteca de inicializa√ß√£o: </p><br><pre> <code class="plaintext hljs">cd ClientApp ng add bootstrap</code> </pre> <br><p>  Em seguida, voc√™ precisa adicionar o suporte de hospedagem SPA ao nosso aplicativo principal.  Primeiro, voc√™ precisa corrigir o projeto csproj - adicione informa√ß√µes sobre nosso aplicativo de navegador. </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TargetFramework</span></span></span><span class="hljs-tag">&gt;</span></span>netcoreapp3.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TargetFramework</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TypeScriptCompileBlocked</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TypeScriptCompileBlocked</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TypeScriptToolsVersion</span></span></span><span class="hljs-tag">&gt;</span></span>Latest<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TypeScriptToolsVersion</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">IsPackable</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">IsPackable</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SpaRoot</span></span></span><span class="hljs-tag">&gt;</span></span>ClientApp\<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SpaRoot</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DefaultItemExcludes</span></span></span><span class="hljs-tag">&gt;</span></span>$(DefaultItemExcludes);$(SpaRoot)node_modules\**<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DefaultItemExcludes</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildServerSideRenderer</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildServerSideRenderer</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> ‚Ä¶ <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Content</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Remove</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(SpaRoot)**"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Remove</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(SpaRoot)**"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(SpaRoot)**"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Exclude</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(SpaRoot)node_modules\**"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DebugEnsureNodeEnv"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BeforeTargets</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Build"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" '$(Configuration)' == 'Debug' And !Exists('$(SpaRoot)node_modules') "</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Exec</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Command</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"node --version"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ContinueOnError</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Output</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">TaskParameter</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ExitCode"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">PropertyName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ErrorCode"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Exec</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Error</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'$(ErrorCode)' != '0'"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Node.js is required to build and run this project. To continue, please install Node.js from https://nodejs.org/, and then restart your command prompt or IDE."</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Message</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Importance</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"high"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Restoring dependencies using 'npm'. This may take several minutes..."</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Exec</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">WorkingDirectory</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(SpaRoot)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Command</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"npm install"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><p>  Depois disso, instale o pacote de nuget especial para dar suporte aos aplicativos do navegador. </p><br><pre> <code class="plaintext hljs">dotnet add package Microsoft.AspNetCore.SpaServices.Extensions -v 3.0.0-preview7.19365.7</code> </pre> <br><p>  E n√≥s usamos seus m√©todos auxiliares: </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Startup. ConfigureServices: services.AddSpaStaticFiles(configuration =&gt; { configuration.RootPath = "ClientApp/dist"; }); //Startup. Configure: app.UseSpa(spa =&gt; { spa.Options.SourcePath = "ClientApp"; if (env.IsDevelopment()) { spa.UseAngularCliServer(npmScript: "start"); } });</span></span></code> </pre><br><p>  Al√©m de chamar novos m√©todos, voc√™ deve excluir as <em>p√°ginas</em> Razor <em>Index.chtml</em> e <em>_ViewStart.chtml</em> para que os servi√ßos do SPA agora forne√ßam o conte√∫do. </p><br><p>  Se tudo tiver sido feito de acordo com as instru√ß√µes, quando o aplicativo iniciar, a p√°gina padr√£o ser√° exibida na tela. </p><br><p><img src="https://habrastorage.org/webt/mv/lv/j6/mvlvj6_2aqcutz9t0_9eozhoxk8.png"></p><br><p>  Agora voc√™ precisa configurar o roteamento, para isso adicionamos ao projeto 2 <br>  componente: </p><br><pre> <code class="plaintext hljs">ng generate component Home -t=true -s=true --skipTests=true ng generate component Data -t=true -s=true --skipTests=true</code> </pre> <br><p>  N√≥s os escrevemos na tabela de roteamento: </p><br><pre> <code class="plaintext hljs">const routes: Routes = [ { path: '', component: HomeComponent, pathMatch: 'full' }, { path: 'data', component: DataComponent } ];</code> </pre> <br><p>  E modificamos o arquivo app.component.html para exibir corretamente os itens de menu. </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">header</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nav</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'navbar navbar-expand-sm navbar-toggleable-sm navbar-light bg-white border-bottom box-shadow mb-3'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"container"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-brand"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLink</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["/"]'</span></span></span><span class="hljs-tag">&gt;</span></span>Client App<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-collapse collapse d-sm-inline-flex flex-sm-row-reverse"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ngClass</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'{"show": isExpanded}'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-nav flex-grow"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLinkActive</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["link-active"]'</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLinkActiveOptions</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'{ exact: true }'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLink</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["/"]'</span></span></span><span class="hljs-tag">&gt;</span></span>Home<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLinkActive</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["link-active"]'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLink</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["/data"]'</span></span></span><span class="hljs-tag">&gt;</span></span>Web api data<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nav</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">header</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text-align:center"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> Welcome to {{ title }}! <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"router-outlet"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">router-outlet</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">router-outlet</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Nesta etapa, voc√™ pode concluir a prepara√ß√£o b√°sica da estrutura do aplicativo para implementar a intera√ß√£o por meio de tokens emitidos pelo IdentityServer. </p><br><p>  O est√°gio atual de prepara√ß√£o da estrutura do nosso SPA pode ser chamado de conclu√≠do e agora devemos come√ßar a implementar o m√≥dulo respons√°vel por interagir com a parte do servidor usando os protocolos OpenID Connect e OAuth.  Felizmente, os desenvolvedores da Microsoft j√° implementaram esse c√≥digo e agora voc√™ pode simplesmente emprestar esse m√≥dulo deles.  Como meu artigo foi escrito com base no pr√©-lan√ßamento 7 do ASP.NET Core 3.0, pegaremos todo o c√≥digo usando a tag de lan√ßamento ‚Äúv3.0.0-preview7.19365.7‚Äù no <a href="">github</a> . </p><br><p>  Antes de importar o c√≥digo, voc√™ deve instalar a biblioteca <em>oidc-client</em> , que <br>  fornece muitas interfaces para aplicativos de navegador, bem como <br>  suporta o gerenciamento de sess√µes do usu√°rio e tokens de acesso.  Para <br>  Para come√ßar a trabalhar com ele, voc√™ precisa instalar o pacote apropriado. </p><br><pre> <code class="plaintext hljs">npm install oidc-client@1.8.0</code> </pre> <br><p>  Agora, em nosso SPA, √© necess√°rio implementar um m√≥dulo que encapsule a intera√ß√£o completa de acordo com os protocolos necess√°rios.  Para fazer isso, voc√™ precisa pegar o m√≥dulo ApiAuthorizationModule inteiro do r√≥tulo do reposit√≥rio ASP.NET Core acima e adicionar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">todos os seus arquivos</a> ao aplicativo. </p><br><p>  Al√©m disso, voc√™ deve import√°-lo para o m√≥dulo principal do aplicativo AppModule: </p><br><pre> <code class="plaintext hljs">@NgModule({ declarations: [ AppComponent, HomeComponent, DataComponent ], imports: [ BrowserModule, HttpClientModule, ApiAuthorizationModule,//&lt;- AppRoutingModule ], providers: [], bootstrap: [AppComponent] }) export class AppModule { }</code> </pre> <br><p>  Para exibir novos itens de menu no m√≥dulo importado, existe um componente de <em>menu de login do aplicativo</em> , <br>  pode ser completamente alterado para atender √†s suas necessidades e adicionar <br>  um link para ele na se√ß√£o de navega√ß√£o da <em>visualiza√ß√£o app.component.html</em> . </p><br><p>  O m√≥dulo de autoriza√ß√£o da API para configurar a conex√£o OpenID do cliente SPA deve usar um terminal especial no back-end do aplicativo, para sua implementa√ß√£o <br>  deve seguir estas etapas: </p><br><ol><li>  Corrija o ID do cliente de acordo com o que definimos no arquivo de configura√ß√£o appsettings.json na se√ß√£o IdentityServer: Clients, no nosso caso, √© TestIdentityAngular, est√° escrito na primeira linha do conjunto constante api-authorization.constants.ts. </li><li>  Adicione um controlador OidcConfigurationController que retornar√° diretamente a configura√ß√£o ao aplicativo do navegador </li></ol><br><p>  O c√≥digo do controlador criado √© apresentado abaixo: </p><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">ApiController</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OidcConfigurationController</span></span>: <span class="hljs-title"><span class="hljs-title">ControllerBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IClientRequestParametersProvider _clientRequestParametersProvider; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OidcConfigurationController</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IClientRequestParametersProvider clientRequestParametersProvider</span></span></span><span class="hljs-function">)</span></span> { _clientRequestParametersProvider = clientRequestParametersProvider; } [HttpGet(<span class="hljs-string"><span class="hljs-string">"_configuration/{clientId}"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetClientRequestParameters</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[FromRoute]</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> clientId</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> parameters = _clientRequestParametersProvider.GetClientParameters(HttpContext, clientId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Ok(parameters); } }</code> </pre> <br><p>  Voc√™ tamb√©m precisa configurar o suporte da API de ponto para o aplicativo de back-end. </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Startup.ConfigureServices: services.AddControllers();//&lt;-  services.AddRazorPages(); //Startup. Configure: app.UseEndpoints(endpoints =&gt; { endpoints.MapRazorPages(); endpoints.MapControllers(); });</span></span></code> </pre><br><p>  Agora √© hora de iniciar o aplicativo.  Dois itens devem aparecer na p√°gina principal no menu superior - <em>Login</em> e <em>registro</em> .  Al√©m disso, na inicializa√ß√£o, o m√≥dulo de autoriza√ß√£o importado solicitar√° do lado do servidor a configura√ß√£o do cliente, que ser√° levada em considera√ß√£o no protocolo.  Um exemplo de sa√≠da de configura√ß√£o √© mostrado abaixo: </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"authority"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://localhost:44367"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"client_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"TestIdentityAngular"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"redirect_uri"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://localhost:44367/authentication/login-callback"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"post_logout_redirect_uri"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://localhost:44367/authentication/logout-callback"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"response_type"</span></span>: <span class="hljs-string"><span class="hljs-string">"id_token token"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"scope"</span></span>: <span class="hljs-string"><span class="hljs-string">"IdentityServer4WebAppAPI openid profile"</span></span> }</code> </pre> <br><p>  Como voc√™ pode ver, o cliente durante a intera√ß√£o espera receber o token de identifica√ß√£o e o token de acesso, al√©m de estar configurado para a √°rea de acesso √† nossa API. </p><br><p>  Agora, se selecionarmos o item de menu <em>Login</em> , devemos ser redirecionados para a p√°gina do nosso IdentityServer4 e aqui podemos inserir o login e a senha e, se estiverem corretos, seremos imediatamente transferidos de volta para o aplicativo do navegador, que por sua vez receber√° <em>id_token</em> e <em>access_token</em> .  Como voc√™ pode ver abaixo, o pr√≥prio componente app-login-menu determinou que a autoriza√ß√£o foi conclu√≠da com √™xito e exibiu uma "sauda√ß√£o", al√©m de um bot√£o para <em>Logout</em> . </p><br><p><img src="https://habrastorage.org/webt/cr/l-/aa/crl-aa3ehwgdjybwkmb7nbg92pk.png"></p><br><p>  Ao abrir as "ferramentas de desenvolvedor" no navegador, √© poss√≠vel ver nos bastidores toda a intera√ß√£o usando o protocolo OIDC / OAuth.  Isso est√° obtendo informa√ß√µes do servidor de autoriza√ß√£o <br>  via atividade de sess√£o de ponto final <em>.bem conhecido / configura√ß√£o</em> aberta e pooling por meio do ponto de acesso de conex√£o / sess√£o de verifica√ß√£o.  Al√©m disso, o m√≥dulo de autoriza√ß√£o √© configurado para o mecanismo de ‚Äúatualiza√ß√£o silenciosa de tokens‚Äù, quando quando o token de acesso expira, o sistema passa independentemente as etapas de autoriza√ß√£o em um iframe oculto.  Voc√™ pode desativar as atualiza√ß√µes autom√°ticas de tokens configurando o valor do par√¢metro <em>includeIdTokenInSilentRenew</em> como "false" no arquivo <em>authorize.service.ts</em> . </p><br><p>  Agora voc√™ pode lidar com a restri√ß√£o de acesso a usu√°rios n√£o autorizados a partir dos componentes do aplicativo SPA, al√©m de alguns controladores de API na parte traseira.  Para demonstrar alguma API, criaremos uma classe <em>ExchangeRateItem</em> na pasta Models <em>,</em> bem como um controlador na pasta Controller que retornar√° alguns dados aleat√≥rios. </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Controller: [ApiController] public class ExchangeRateController { private static readonly string[] Currencies = new[] { "EUR", "USD", "BGN", "AUD", "CNY", "TWD", "NZD", "TND", "UAH", "UYU", "MAD" }; [HttpGet("api/rates")] public IEnumerable&lt;ExchangeRateItem&gt; Get() { var rng = new Random(); return Enumerable.Range(1, 5).Select(index =&gt; new ExchangeRateItem { FromCurrency = "RUR", ToCurrency = Currencies[rng.Next(Currencies.Length)], Value = Math.Round(1.0+ 1.0/rng.Next(1, 100),2) }) .ToArray(); } } //Models: public class ExchangeRateItem { public string FromCurrency { get; set; } public string ToCurrency { get; set; } public double Value { get; set; } }</span></span></code> </pre><br><p>  Em seguida, no lado frontal, crie um novo componente que receber√° <br>  e exibir dados sobre taxas de c√¢mbio do controlador rec√©m-criado. </p><br><pre> <code class="plaintext hljs">ng generate component ExchangeRate -t=true -s=true --skipTests=true</code> </pre> <br><p>  O conte√∫do do componente deve ficar assim: </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">import { Component, OnInit, Input } from '@angular/core'; import { HttpClient } from '@angular/common/http'; import { Observable, of, Subject } from 'rxjs'; import { catchError } from 'rxjs/operators'; @Component({ selector: 'app-exchange-rate', template: ` &lt;div class="alert alert-danger" *ngIf="errorMessage | async as msg"&gt; {{msg}} &lt;/div&gt; &lt;table class='table table-striped'&gt; &lt;thead&gt; &lt;tr&gt; &lt;th&gt;From currency&lt;/th&gt; &lt;th&gt;To currency&lt;/th&gt; &lt;th&gt;Rate&lt;/th&gt; &lt;/tr&gt; &lt;/thead&gt; &lt;tbody&gt; &lt;tr *ngFor="let rate of rates | async"&gt; &lt;td&gt;{{ rate.fromCurrency }} &lt;/td&gt; &lt;td&gt;{{ rate.toCurrency }}&lt;/td&gt; &lt;td&gt;{{ rate.value }}&lt;/td&gt; &lt;/tr&gt; &lt;/tbody&gt; &lt;/table&gt; `, styles: [] }) export class ExchangeRateComponent implements OnInit { public rates: Observable&lt;ExchangeRateItem[]&gt;; public errorMessage: Subject&lt;string&gt;; @Input() public apiUrl: string; constructor(private http: HttpClient) { this.errorMessage = new Subject&lt;string&gt;(); } ngOnInit() { this.rates = this.http.get&lt;ExchangeRateItem[]&gt;("/api/"+this.apiUrl).pipe(catchError(this.handleError(this.errorMessage)) ); } private handleError(subject: Subject&lt;string&gt;): (te:any) =&gt; Observable&lt;ExchangeRateItem[]&gt; { return (error) =&gt; { let message = ''; if (error.error instanceof ErrorEvent) { message = `Error: ${error.error.message}`; } else { message = `Error Code: ${error.status}\nMessage: ${error.message}`; } subject.next(message); let emptyResult: ExchangeRateItem[] = []; return of(emptyResult); } } } interface ExchangeRateItem { fromCurrency: string; toCurrency: string; value: number; }</code> </pre> </div></div><br><p>  Agora resta come√ßar a us√°-lo na p√°gina de dados do aplicativo, simplesmente no modelo, escrevendo a linha &lt;app-exchange-rate apiUrl = "rates"&gt; &lt;/app-exchange-rate&gt; e voc√™ pode iniciar o projeto novamente.  Veremos ao navegar no caminho de destino que o componente recebeu os dados e os exibiu em uma tabela. </p><br><p>  Em seguida, tentaremos adicionar uma solicita√ß√£o de autoriza√ß√£o de acesso √† API do controlador. Para fazer isso, adicione o atributo <em>[Authorize]</em> na classe <em>ExchangeRateController</em> e execute o SPA novamente, no entanto, depois de voltarmos ao componente que chama nossa API, veremos um erro indicando cabe√ßalhos de autoriza√ß√£o. </p><br><p><img src="https://habrastorage.org/webt/fo/kv/ov/fokvovvxneeouxy0k30wuvlwj4u.png"></p><br><p>  Para adicionar corretamente um token de autoriza√ß√£o √†s solicita√ß√µes de sa√≠da, voc√™ pode <br>  Engate o mecanismo interceptor angular interceptores.  Felizmente, o m√≥dulo importado j√° cont√©m o tipo necess√°rio, basta registr√°-lo no m√≥dulo base do aplicativo. </p><br><pre> <code class="plaintext hljs">providers: [ { provide: HTTP_INTERCEPTORS, useClass: AuthorizeInterceptor, multi: true } ],</code> </pre> <br><p>  Ap√≥s essas etapas, tudo deve funcionar corretamente.  Se voc√™ olhar as ferramentas do desenvolvedor novamente, o navegador ver√° o novo cabe√ßalho de autoriza√ß√£o do Bearer access_token.  No back-end, esse token ser√° validado pelo IdentityServer e tamb√©m dar√° permiss√£o para chamar um ponto de API seguro. </p><br><p>  No final do exemplo de integra√ß√£o com o servidor de autoriza√ß√£o, voc√™ pode colocar o Activation Guard na rota com os dados da taxa de c√¢mbio no SPA, impedindo que os usu√°rios alternem para a p√°gina se n√£o estiverem autorizados no momento.  Esse protetor tamb√©m √© apresentado no m√≥dulo importado anteriormente, voc√™ s√≥ precisa pendur√°-lo na rota de destino. </p><br><pre> <code class="plaintext hljs">{ path: 'data', component: DataComponent, canActivate: [AuthorizeGuard] }</code> </pre> <br><p>  Agora, no caso em que o usu√°rio n√£o efetuou login no aplicativo e selecionou um link para nosso componente protegido, ele ser√° imediatamente transferido para a p√°gina de autoriza√ß√£o com uma solicita√ß√£o para inserir um login e senha.  O c√≥digo resultante est√° dispon√≠vel no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github</a> . </p><br><h2 id="podklyuchenie-vneshnego-vhoda-v-sistemu-cherez-postavschika-google">  Conectando um login externo atrav√©s de um provedor do Google </h2><br><p>  Existe um pacote Microsoft.AspNetCore.Authentication.Google Nuget separado para conectar o logon atrav√©s de contas do Google para o ASP.NET core 1.1 / 2.0 +, no entanto, devido a altera√ß√µes na pol√≠tica da empresa, a Microsoft planeja o ASP.NET Core 3.0+ reconhec√™-lo como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">obsoleto</a> .  E agora √© recomend√°vel conectar-se por meio do m√©todo auxiliar <em>OpenIdConnectExtensions</em> e <em>AddOpenIdConnect</em> , que usaremos neste artigo. </p><br><p>  Instale a extens√£o OpenIdConnect: </p><br><pre> <code class="plaintext hljs">dotnet add package Microsoft.AspNetCore.Authentication.OpenIdConnect -v 3.0.0-preview7.19365.7</code> </pre> <br><p>  Para come√ßar, precisamos obter dois valores-chave do Google - Id Client e Client Secret, para isso, prop√µe-se executar as seguintes etapas: </p><br><ul><li>  Siga o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">link</a> e selecione o bot√£o "CONFIGURAR UM PROJETO". </li><li>  Na caixa de di√°logo exibida, especifique o servidor da Web. </li><li>     ¬´Authorized redirect URI¬ª           Google (..      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://localhost:44301/</a> ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://localhost:44301/signin-google</a> ) </li><li>      ClientID  Client Secret. </li><li>         ,   ,   URL    . </li></ul><br><p>         <a href="">Secret Manager</a> .       ,    . </p><br><pre> <code class="plaintext hljs">dotnet user-secrets init dotnet user-secrets set "Authentication:Google:ClientId" "  ClientID" dotnet user-secrets set "Authentication:Google:ClientSecret" "  ClientSecret"</code> </pre> <br><p>           Google. </p><br><pre> <code class="cs hljs">services.AddAuthentication() .AddOpenIdConnect(<span class="hljs-string"><span class="hljs-string">"Google"</span></span>, <span class="hljs-string"><span class="hljs-string">"Google"</span></span>, o =&gt; { IConfigurationSection googleAuthNSection = Configuration.GetSection(<span class="hljs-string"><span class="hljs-string">"Authentication:Google"</span></span>); o.ClientId = googleAuthNSection[<span class="hljs-string"><span class="hljs-string">"ClientId"</span></span>]; o.ClientSecret = googleAuthNSection[<span class="hljs-string"><span class="hljs-string">"ClientSecret"</span></span>]; o.Authority = <span class="hljs-string"><span class="hljs-string">"https://accounts.google.com"</span></span>; o.ResponseType = OpenIdConnectResponseType.Code; o.CallbackPath = <span class="hljs-string"><span class="hljs-string">"/signin-google"</span></span>; }) .AddIdentityServerJwt();</code> </pre> <br><p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a>     ,    <br>      Google.     ,    ,       SPA          . </p><br><p><img src="https://habrastorage.org/webt/xi/rl/5h/xirl5hobkgfaukb4wzp5sibosj4.png"></p><br><p>  ,  ,     OAuth ,       .   Nuget        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a> . </p><br><h2 id="dorabotka-vozmozhnosti-vhoda-pod-polzovatelyami-windows">      Windows </h2><br><p>   ,  SPA           Microsoft,       ActiveDirectory.  ,       Html    ASP.NET, WebForms  ..,      Windows        WindowsIdentity, ,       .     Identity Server,         Windows,              claims <em>id_token</em>  <em>access_token</em> .  ,  IS4    ,        ,    <br>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github</a> . ,             ASP.NET Core Identity 3.0. </p><br><p>          Identity,    Razor  <em>Login</em>  <em>ExternalLogin</em>    ( CLI aspnet-codegenerator    ): </p><br><pre> <code class="plaintext hljs">dotnet add package Microsoft.EntityFrameworkCore.SqlServer dotnet add package Microsoft.VisualStudio.Web.CodeGeneration.Design dotnet aspnet-codegenerator identity -dc IdentityServer4WebApp.Data.ApplicationDbContext --files "Account.Login;Account.ExternalLogin"</code> </pre> <br><p>    ,     Area   <em>Identity</em>    ,          . </p><br><p>         ,       .   ,  Identity      I <em>AuthenticationSchemeProvider. GetAllSchemesAsync()</em>   DisplayName != null,    Windows   DisplayName = null.     LoginModel    <em>OnGetAsync</em>   : </p><br><pre> <code class="cs hljs">ExternalLogins = (<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _signInManager.GetExternalAuthenticationSchemesAsync()).ToList(); <span class="hljs-comment"><span class="hljs-comment">// &lt;&lt; &gt;&gt; ExternalLogins =(await _schemeProvider.GetAllSchemesAsync()).Where(x =&gt; x.DisplayName != null ||(x.Name.Equals(IISDefaults.AuthenticationScheme,StringComparison.OrdinalIgnoreCase))).ToList();</span></span></code> </pre> <br><p>         <em>private readonly</em> <em>AuthenticationSchemeProvider _schemeProvider</em> .    View         <em>Login.cshtml</em> : </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-primary"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"provider"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@provider.Name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Log in using your @provider.DisplayName account"</span></span></span><span class="hljs-tag">&gt;</span></span>@provider.DisplayName<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;&lt; &gt;</span></span>&gt; <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-primary"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"provider"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@provider.Name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Log in using your @(provider.DisplayName ??provider.Name) account"</span></span></span><span class="hljs-tag">&gt;</span></span>@(provider.DisplayName ??provider.Name)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  ,  windows      <em>launchSettings.json</em> <br> (   IIS,       <em>web.config</em> ). </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"iisSettings"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"windowsAuthentication"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"anonymousAuthentication"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"iisExpress"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"applicationUrl"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://localhost:15479"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sslPort"</span></span>: <span class="hljs-number"><span class="hljs-number">44301</span></span> } },</code> </pre> <br><p>        ¬´Windows¬ª    . </p><br><p><img src="https://habrastorage.org/webt/e_/6s/-m/e_6s-m8ot5h52dv6dgvid8bgpky.png"></p><br><p>     SPA      IdentityServer     .    ¬´¬ª    <em>[AllowAnonymous]</em>    <em>LoginModel</em>   <em>[Authorize(AuthenticationSchemes = "Windows")]</em> ,     ,       WindowsIdentity. </p><br><p>    <em>ExternalLogin</em> ,   Identity    Windows .      <em>ProcessWindowsLoginAsync</em> . </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;IActionResult&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessWindowsLoginAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> returnUrl</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> HttpContext.AuthenticateAsync(IISDefaults.AuthenticationScheme); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result?.Principal <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> WindowsPrincipal wp) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> redirectUrl = Url.Page(<span class="hljs-string"><span class="hljs-string">"./ExternalLogin"</span></span>, pageHandler: <span class="hljs-string"><span class="hljs-string">"Callback"</span></span>, values: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { returnUrl }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> props = _signInManager.ConfigureExternalAuthenticationProperties(IISDefaults.AuthenticationScheme, redirectUrl); props.Items[<span class="hljs-string"><span class="hljs-string">"scheme"</span></span>] = IISDefaults.AuthenticationScheme; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> id = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClaimsIdentity(IISDefaults.AuthenticationScheme); id.AddClaim(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(JwtClaimTypes.Subject, wp.Identity.Name)); id.AddClaim(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(JwtClaimTypes.Name, wp.Identity.Name)); id.AddClaim(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(ClaimTypes.NameIdentifier, wp.Identity.Name)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> wi = wp.Identity <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> WindowsIdentity; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> groups = wi.Groups.Translate(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(NTAccount)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hasUsersGroup = groups.Any(i =&gt; i.Value.Contains(<span class="hljs-string"><span class="hljs-string">@"BUILTIN\Users"</span></span>, StringComparison.OrdinalIgnoreCase)); id.AddClaim(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(<span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span>, hasUsersGroup.ToString())); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> HttpContext.SignInAsync(IdentityConstants.ExternalScheme, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClaimsPrincipal(id), props); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Redirect(props.RedirectUri); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Challenge(IISDefaults.AuthenticationScheme); }</code> </pre> </div></div><br><p>       ,             . </p><br><p>    <em>ExternalLoginModel.OnPost</em>          : </p><br><pre> <code class="plaintext hljs">if (IISDefaults.AuthenticationScheme == provider) { return await ProcessWindowsLoginAsync(returnUrl); }</code> </pre> <br><p>    Claim  Windows      Claim ¬´hasUsersGroup¬ª,       ID  access,    .      ASP.NET Identity     UserClaims.        <em>ExternalLoginModel</em> . </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateClaims</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ExternalLoginInfo info, ApplicationUser user, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">params</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] claimTypes</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (claimTypes == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> claimTypesHash = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(claimTypes); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> claims = (<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.GetClaimsAsync(user)).Where(c =&gt; claimTypesHash.Contains(c.Type)).ToList(); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.RemoveClaimsAsync(user, claims); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> claimType <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> claimTypes) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info.Principal.HasClaim(c =&gt; c.Type == claimType)) { claims = info.Principal.FindAll(claimType).ToList(); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.AddClaimsAsync(user, claims); } } }</code> </pre> <br><p>       <em>OnPostConfirmationAsync</em> (    <br>     ). </p><br><pre> <code class="cs hljs">result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.AddLoginAsync(user, info); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Succeeded) { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _signInManager.SignInAsync(user, isPersistent: <span class="hljs-literal"><span class="hljs-literal">false</span></span>); _logger.LogInformation(<span class="hljs-string"><span class="hljs-string">"User created an account using {Name} provider."</span></span>, info.LoginProvider); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> UpdateClaims(info, user, <span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span>);<span class="hljs-comment"><span class="hljs-comment">// return LocalRedirect(returnUrl); }</span></span></code> </pre> <br><p>    <em>OnGetCallbackAsync</em> ,      . </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _signInManager.ExternalLoginSignInAsync(info.LoginProvider, info.ProviderKey, isPersistent: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, bypassTwoFactor : <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Succeeded) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.FindByLoginAsync(info.LoginProvider, info.ProviderKey); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> UpdateClaims(info, user, <span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span>);<span class="hljs-comment"><span class="hljs-comment">//</span></span></code> </pre> <br><p>  ,        WebAPI   <br>  ¬´hasUsersGroup¬ª.      ¬´ShouldHasUsersGroup¬ª </p><br><pre> <code class="cs hljs">services.AddAuthorization(options =&gt; { options.AddPolicy(<span class="hljs-string"><span class="hljs-string">"ShouldHasUsersGroup"</span></span>, policy =&gt; { policy.RequireClaim(<span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span>);}); });</code> </pre> <br><p>    <em>ExchangeRateController</em>       <br>     Policy. </p><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">Authorize(Policy = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ShouldHasUsersGroup"</span></span></span><span class="hljs-meta">)</span></span>] [HttpGet(<span class="hljs-string"><span class="hljs-string">"api/internalrates"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IEnumerable&lt;ExchangeRateItem&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetInternalRates</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Get().Select(i=&gt;{i.Value=Math.Round(i.Value<span class="hljs-number"><span class="hljs-number">-0.02</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>);<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> i;}); }</code> </pre> <br><p>   view    . </p><br><pre> <code class="plaintext hljs">ng generate component InternalData -t=true -s=true --skipTests=true</code> </pre> <br><p>    template          . </p><br><pre> <code class="html hljs xml">//internal-data.component.ts: template: `<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">app-exchange-rate</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">apiUrl</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"internalrates"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">app-exchange-rate</span></span></span><span class="hljs-tag">&gt;</span></span> `, //app-routing.module.ts: { path: ' internaldata', component: InternalDataComponent, canActivate: [AuthorizeGuard] } //app.component.html: <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLinkActive</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["link-active"]'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLink</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["/internaldata"]'</span></span></span><span class="hljs-tag">&gt;</span></span>Internal api data<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>             <br> , ,    .   ,  accsee_token    <br>   claim   <em>hasUsersGroup</em> ,       <br>     ApiResources  .  ,    ,        <em>appsettings.json</em> ,           <em>Startup. ConfigureServices</em> . </p><br><pre> <code class="cs hljs">services.AddIdentityServer() .AddApiAuthorization&lt;ApplicationUser, ApplicationDbContext&gt;(options =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> apiResource = options.ApiResources.First(); apiResource.UserClaims = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span> }; });</code> </pre> <br><p> ,     ,    windows      ,         . </p><br><p>       ,   ‚Äì  Guard    claim   ¬´hasUsersGroup¬ª     ¬´  ¬ª.    Guard  : </p><br><pre> <code class="plaintext hljs">ng generate guard AuthorizeWindowsGroupGuard --skipTests=true</code> </pre> <br><p>      : </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="plaintext hljs">import { Injectable } from '@angular/core'; import { Observable } from 'rxjs'; import { map,tap} from 'rxjs/operators'; import { CanActivate, ActivatedRouteSnapshot, RouterStateSnapshot, Router, UrlTree } from '@angular/router'; import { AuthorizeService } from "./authorize.service"; import { ApplicationPaths, QueryParameterNames } from './api-authorization.constants'; @Injectable({ providedIn: 'root' }) export class AuthorizeWindowsGroupGuardGuard implements CanActivate{ constructor(private authorize: AuthorizeService, private router: Router) {} canActivate(route: ActivatedRouteSnapshot, state: RouterStateSnapshot): Observable&lt;boolean | UrlTree&gt; | Promise&lt;boolean | UrlTree&gt; | boolean | UrlTree { return this.authorize.getUser().pipe(map((u: any) =&gt; !!u &amp;&amp; !!u.hasUsersGroup)).pipe(tap((isAuthorized:boolean) =&gt; this.handleAuthorization(isAuthorized, state)));; } private handleAuthorization(isAuthenticated: boolean, state: RouterStateSnapshot) { if (!isAuthenticated) { window.location.href = "/Identity/Account/Login?" + QueryParameterNames.ReturnUrl + "=/"; } } }</code> </pre> </div></div><br><p> , ,         . </p><br><pre> <code class="plaintext hljs">{ path: 'internaldata', component: InternalDataComponent, canActivate: [AuthorizeWindowsGroupGuardGuard]</code> </pre> <br><p>     IdentityServer,      claims ( <em>sub</em> , <em>profile</em> ),     ¬´hasUsersGroup¬ª.      IdentityResource, -        IdentityResources          <em>Startup.ConfigureServices</em> . </p><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> identityResource = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IdentityResource { Name = <span class="hljs-string"><span class="hljs-string">"customprofile"</span></span>, DisplayName = <span class="hljs-string"><span class="hljs-string">"Custom profile"</span></span>, UserClaims = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span> }, }; identityResource.Properties.Add(ApplicationProfilesPropertyNames.Clients, <span class="hljs-string"><span class="hljs-string">"*"</span></span>); options.IdentityResources.Add(identityResource);</code> </pre> <br><p> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a>   ,         windows    ¬´ ¬ª   SPA ‚Äì   ,     ,    Guard    . </p><br><h2 id="zaklyuchenie">  Conclus√£o </h2><br><p> ,  ASP.NET Core 3.0            IdentityServer4,         .      preview ,       .   ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github</a>   . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt461433/">https://habr.com/ru/post/pt461433/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt461417/index.html">Como recusei o db4o em um sistema industrial</a></li>
<li><a href="../pt461421/index.html">Como se proteger contra poss√≠veis perdas ao investir na bolsa: produtos estruturais</a></li>
<li><a href="../pt461423/index.html">11 dicas: como apresentar o trabalho da interface do usu√°rio / UX para "n√£o designers"</a></li>
<li><a href="../pt461425/index.html">Como se tornar gerente de produtos e crescer ainda mais</a></li>
<li><a href="../pt461431/index.html">‚ÄúAma e n√£o gosta‚Äù: DNS sobre HTTPS</a></li>
<li><a href="../pt461435/index.html">Reconhecimento de emo√ß√µes usando uma rede neural convolucional</a></li>
<li><a href="../pt461437/index.html">370 l√¢mpadas</a></li>
<li><a href="../pt461439/index.html">Iniciando a biblioteca de componentes React e TypeScript</a></li>
<li><a href="../pt461441/index.html">Relat√≥rios sobre o estado do armazenamento usando R. Computa√ß√£o paralela, gr√°ficos, xlsx, email e tudo isso</a></li>
<li><a href="../pt461443/index.html">P√≥s-an√°lise: o que se sabe sobre o √∫ltimo ataque √† rede de servidores de chaves criptogr√°ficas SKS Keyserver</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>