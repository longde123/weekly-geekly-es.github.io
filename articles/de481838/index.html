<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚¨ÖÔ∏è ‚ò£Ô∏è üâê WireGuard, Einrichtung mehrerer Clients f√ºr NAT und wohin geht STUN? ‚ôøÔ∏è üë©üèø‚Äçü§ù‚Äçüë®üèº üë©üèº‚Äçü§ù‚Äçüë®üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Momentan starten wir den Zugriff auf Server, die auf WireGuard basieren, und heute m√∂chte ich dar√ºber sprechen, wie Clients konfiguriert werden, die s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>WireGuard, Einrichtung mehrerer Clients f√ºr NAT und wohin geht STUN?</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481838/"> Momentan starten <a href="https://elastictunnel.com/">wir den</a> Zugriff auf Server, die auf <a href="https://www.wireguard.com/">WireGuard</a> basieren, und heute m√∂chte ich dar√ºber sprechen, wie Clients konfiguriert werden, die sich hinter NAT befinden, obwohl wir auch die Serverkonfiguration nicht vergessen werden. <br><a name="habracut"></a><br>  Zun√§chst zu den Vorteilen von WireGuard und der R√ºckseite der Medaille, zu den Schwierigkeiten, die mit den Vorteilen einhergehen.  WireGuard ist eine relativ junge Implementierung eines Tunnels zwischen zwei Punkten, da das √úbertragungsprotokoll von UDP verwendet wird.  Aus diesem Grund und auch, weil die Linux-Implementierung selbst als Kernel-Modul implementiert ist, zeigen die Tests einen ordentlichen Geschwindigkeitsvorteil gegen√ºber Mitbewerbern.  Dies kann nicht als Peer-to-Peer-Netzwerk betrachtet werden, obwohl die Endknoten als <i>Peer bezeichnet werden</i> .  Das Wesen eines Peer-to-Peer-Netzwerks besteht nicht nur darin, dass es m√∂glich w√§re, zwei beliebige Knoten zu verbinden.  Nat√ºrlich k√∂nnen Sie mit diesem Toolkit eine sehr komplexe Netzwerkinfrastruktur aufbauen, aber ich habe kein solches Ziel.  Wir werden √ºberlegen, eine Verbindung zu einem Serverknoten herzustellen und √ºber diesen auf das Internet zuzugreifen. <br><br>  Wenn zwei Knoten, der Server und ein Client <i>wei√üe</i> IPs haben, sollte es in diesem Fall offensichtlich keine Schwierigkeiten beim Einrichten geben.  H√§ufig befinden sich Clients jedoch hinter NAT. In diesem Fall m√ºssen Sie beim Einrichten des Servers die falsche IP-Adresse angeben, die auf dem Ger√§t ausgegeben / registriert wurde.  In dieser Hinsicht kann das STUN-Protokoll helfen.  Dieses Protokoll wird h√§ufig bei der Arbeit mit VoIP verwendet, insbesondere wenn sich beide Clients hinter NAT befinden.  In unserem Fall hilft es aber auch.  Nach den Informationen auf Wikipedia funktioniert STUN nicht mit allen NAT-Typen: In einem der vier NAT-Typen kann ein (symmetrischer) Client eine andere IP-Adresse haben als eine, die extern mit dem STUN-Client definiert werden kann. <br><br>  STUN-Clients existieren auf allen g√§ngigen Betriebssystemen au√üer iOS.  Unter diesem Betriebssystem konnte ich den STUN-Client nicht finden.  Ich werde ein Beispiel f√ºr macOS geben.  Zun√§chst m√ºssen Sie den STUN-Client selbst installieren. <br><br><pre><code class="bash hljs">$ brew install stunman</code> </pre> <br>  Es gibt Unmengen von STUN-Servern im Internet und es ist nicht schwierig, einen Server f√ºr den Test zu finden.  Ich werde <i>stun.ekiga.net</i> benutzen.  F√ºr den Test m√ºssen Sie den lokalen Port verwenden, den wir zur Konfiguration verwenden: <br><br><pre> <code class="bash hljs">$ stunclient --localport 51820 stun.ekiga.net</code> </pre> <br>  Bei einem erfolgreichen Test erhalten wir ungef√§hr die folgende Schlussfolgerung: <br><br><pre> <code class="plaintext hljs">Binding test: success Local address: 192.168.88.23:51820 Mapped address: 82.207.27.3:51820</code> </pre> <br>  <i>Die zugeordnete Adresse</i> ist genau die IP- <i>Adresse</i> , die Sie beim Einrichten des Servers verwenden m√ºssen.  In der Tat ist dies die IP-Adresse, die in meinem Fall einen Dienst zur Bestimmung der externen IP ausgibt.  Aus diesem Grund k√∂nnen Sie Ihren <a href="https://elastictunnel.com/">bevorzugten Dienst</a> zur Bestimmung der IP-Adresse verwenden. Es ist jedoch zu bedenken, dass dieser Test indirekt durchgef√ºhrt wird und es keine Garantie daf√ºr gibt, dass alles wie beabsichtigt funktioniert. <br><br>  Um auf der Clientseite eine Verbindung zum Server herzustellen, m√ºssen Sie Folgendes angeben: IP, Port und √∂ffentlicher Schl√ºssel.  F√ºr die Konfiguration auf der Clientseite ben√∂tigen Sie genau dieselbe Liste, die auf der Serverseite bereitgestellt wird.  Als n√§chstes werde ich Optionen f√ºr Configs vorschlagen. Wenn Sie diese als Beispiele verwenden, wird empfohlen, die Schl√ºssel neu zu generieren. <br><br>  Unter Linux kann dies √ºber die Befehlszeile und unter macOS √ºber die offizielle Client-Benutzeroberfl√§che erfolgen. <br><br><pre> <code class="bash hljs">$ wg genkey | tee privatekey | wg pubkey &gt; publickey</code> </pre> <br>  In diesem Fall wird am Ort des Anrufs der private Schl√ºssel in der Datei privatekey erstellt, public in in publickey. <br><br>  Betrachten Sie zun√§chst die Client-Konfiguration: <br><br><pre> <code class="plaintext hljs">#       [Interface] #       PrivateKey = YPuKo2QXndQ2Vc3S/y90oKT7AJ0Swhq/HWKiF7GwS04= #         ListenPort = 51820 #  IP   ,        #    Address = 10.8.0.2/24 # DNS   ,      DNS = 8.8.8.8 #     [Peer] #   ,     PublicKey = nFjDIkgsAh1RMZuaCJ+AKs7JmbMxxthhZ0POjUSTvkc= #     ,       # IP  ,          #     ,      #     WireGuard . IP   , #   . AllowedIPs = 0.0.0.0/0 #  IP    Endpoint = 46.101.122.130:51820 #  2 .  -    ,     , #    AllowedIPs         #   .  -     # ,    -  25 . PersistentKeepalive = 25</code> </pre> <br>  Jetzt ist es Zeit f√ºr die Serverkonfiguration: <br><br><pre> <code class="plaintext hljs">#       [Interface] # IP      Address = 10.8.0.1/24 #     ListenPort = 51820 #  ,      PrivateKey = MNnxOy79xtXtSQ3UySWtdlOMbG7ff9dXGjeSTPEByn8= #  2 ,      wg0  PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE #     [Peer] #   ,    PublicKey = TdRtYd6XXI+ynPDXU6FF5TT3L5t/YlQVZswr2xsou34= #   IP ,     , #     AllowedIPs = 10.8.0.2/32 #  IP ,   ,     STUN  EndPoint = 82.207.27.3:51820</code> </pre> <br>  <i>Wenn Sie diese Konfigurationen als Beispiel verwenden, wird empfohlen, Kommentare auf Russisch zu l√∂schen. Bei Kommentaren k√∂nnen Server und Client nicht garantiert werden.</i> <br><br>  Ich habe die folgenden Ressourcen zum Konfigurieren verwendet: die <a href="https://www.wireguard.com/install/">offizielle Website</a> , <a href="https://wiki.archlinux.org/index.php/WireGuard">ArchWiki</a> und <a href="https://www.linode.com/docs/networking/vpn/set-up-wireguard-vpn-on-ubuntu/">dieses Tutorial</a> . <br><br>  Zum Schluss m√∂chte ich noch einige m√∂gliche Fragen kl√§ren: <br><br>  1. <i>K√∂nnen</i> auf dem Server mehrere Abschnitte desselben <i>Peers erstellt</i> werden, die sich nur in <i>EndPoint unterscheiden</i> ? <br><br>  Ja, das ist m√∂glich und es kann sogar n√ºtzlich sein, wenn Sie den Dienst von verschiedenen Orten aus nutzen, z. B. bei der Arbeit und zu Hause.  Es k√∂nnen jedoch Probleme auftreten, wenn solche <i>Peers</i> gleichzeitig online gehen. In diesem Fall liegt ein Konflikt zwischen den IP-Adressen vor. <br><br>  2. Welche externe IP und welcher Port werden vom STUN-Protokoll f√ºr mehrere Clients pro NAT bestimmt? <br><br>  F√ºr alle Kunden gleich, es wird dasselbe sein.  W√§re das ein Problem?  Dies h√§ngt alles von den Einstellungen Ihres Providers / Routers ab. Grunds√§tzlich sollten jedoch keine Probleme auftreten, da der Router UDP-Pakete innerhalb des Netzwerks √ºber die lokale Netzwerkmaske senden muss bzw. die empfangenden Parteien, die die Pakete entschl√ºsseln k√∂nnen, diese erfolgreich empfangen m√ºssen.  Wir haben Tests an unseren Ger√§ten durchgef√ºhrt, die Tests waren erfolgreich. <br><br>  Der Zweck des Artikels bestand nicht darin, ein vollst√§ndiges Tutorial zur Konfiguration von WireGuard zu verfassen. Es ist nicht schwierig, die offizielle Dokumentation zu verwenden.  Wir wollten zeigen, wie WireGuard f√ºr NAT funktioniert. <br><br>  Wenn Sie WireGuard im Gesch√§ft ausprobieren m√∂chten, k√∂nnen Sie <a href="https://elastictunnel.com/">uns</a> kontaktieren, wir haben Zugriff im Testmodus. <br><br>  <b>UPD:</b> <br>  Wie der Aborouhin- <a href="https://habr.com/ru/users/aborouhin/" class="user_link">Habitor zu</a> Recht bemerkt <a href="https://habr.com/ru/users/aborouhin/" class="user_link">hat</a> , reicht nur eine wei√üe IP aus, damit der Datenkanal problemlos funktioniert.  Dementsprechend kann <i>EndPoint</i> for <i>Peer</i> in der Serverkonfiguration weggelassen werden, was die Konfiguration vereinfacht.  Das beschriebene Handbuch kann n√ºtzlich sein, wenn sich beide Knoten hinter NAT befinden. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de481838/">https://habr.com/ru/post/de481838/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de481820/index.html">PocketBook: Ergebnisse des Jahres oder Neuigkeiten und wichtige Ereignisse im Jahr 2019</a></li>
<li><a href="../de481822/index.html">Eine kurze und 146% genaue Geschichte der Programmiersprachen</a></li>
<li><a href="../de481824/index.html">Schnelle Suche nach der Quelle unerw√ºnschter Mutationen einer Objekteigenschaft</a></li>
<li><a href="../de481828/index.html">Die Geschichte der Lernsoftware: Lernmanagementsysteme und der Aufstieg der Online-Bildung</a></li>
<li><a href="../de481836/index.html">Pizza as a Service: Wie Amazon zu Redshift migrierte</a></li>
<li><a href="../de481840/index.html">Sch√ºtzen Sie Ihre GraphQL-API vor Sicherheitsl√ºcken</a></li>
<li><a href="../de481842/index.html">Umstieg auf reinen Speicher: Unser neuer Speicher</a></li>
<li><a href="../de481844/index.html">7 Jahre Hype um neuronale Netze in Grafiken und inspirierenden Perspektiven von Deep Learning 2020</a></li>
<li><a href="../de481846/index.html">Verwenden von GitHub CI f√ºr Elixir-Projekte</a></li>
<li><a href="../de481848/index.html">Erfahrene Mitarbeiterschulung</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>