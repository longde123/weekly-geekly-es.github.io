<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüë©‚Äçüë¶ üë®üèº‚Äç‚öïÔ∏è üóø Iniciar sesi√≥n en una aplicaci√≥n php distribuida ‚ô†Ô∏è üí• üÜò</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El art√≠culo discutir√° los beneficios de la tala. Dir√© sobre los registros en PSR. Agregar√© algunas recomendaciones personales sobre c√≥mo trabajar con ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Iniciar sesi√≥n en una aplicaci√≥n php distribuida</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/456676/"><p><img src="https://habrastorage.org/webt/xm/rd/rj/xmrdrjy7rtwa8f2__bcbjrdry4y.png"></p><br><p>  El art√≠culo discutir√° los beneficios de la tala.  Dir√© sobre los registros en PSR.  Agregar√© algunas recomendaciones personales sobre c√≥mo trabajar con el nivel, el mensaje y el contexto del evento registrado.  Se dar√° un ejemplo sobre c√≥mo organizar el registro y el monitoreo usando ELK en una aplicaci√≥n escrita en Laravel y lanzada a trav√©s de Docker en varias instancias.  Firmar√© una regla importante del sistema de advertencia.  Dar√© un ejemplo de un script que eleva toda la pila de monitoreo con un comando. </p><a name="habracut"></a><br><h2 id="polza-logirovaniya">  Los beneficios de la tala </h2><br><p>  El registro bien organizado permite al menos lo siguiente: </p><br><ul><li>  Saber que algo no est√° yendo seg√∫n lo previsto (hay errores) </li><li>  Conozca los detalles del error, lo que ayudar√° a decir con qui√©n y d√≥nde ocurri√≥ el error, y evitar√° que se repita </li><li>  Para saber que todo va seg√∫n lo planeado (acceso.log, depuraci√≥n, niveles de informaci√≥n) </li></ul><br><p>  El registro por s√≠ solo no le dir√° todo esto, pero con la ayuda de los registros, ser√° posible conocer de forma independiente los detalles de los eventos o configurar un sistema de monitoreo para los registros que podr√°n notificar los problemas.  Si los mensajes en los registros est√°n acompa√±ados por una cantidad suficiente de contexto, esto simplifica enormemente la depuraci√≥n, ya que tendr√° m√°s datos disponibles sobre la situaci√≥n en la que ocurri√≥ el evento. </p><br><h2 id="chem-pisat-i-chto-pisat">  Qu√© escribir y qu√© escribir </h2><br><p> Parte de la comunidad php ha desarrollado recomendaciones para algunas tareas de escritura de c√≥digo.  Una de esas recomendaciones es la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">interfaz del registrador PSR-3</a> .  Simplemente describe lo que necesita para iniciar sesi√≥n.  Para esto, se desarrolla la <code>Psr\Log\LoggerInterface</code> del paquete " <code>Psr\Log\LoggerInterface</code> / log".  Al usarlo, debe conocer los tres componentes del evento: </p><br><ol><li>  <strong>Nivel</strong> - Importancia del evento </li><li>  <strong>Mensaje</strong> : texto que describe el evento </li><li>  <strong>Contexto</strong> : una variedad de informaci√≥n adicional sobre el evento </li></ol><br><h3 id="urovni-sobytiya-po-psr-3">  Niveles de evento PSR-3 </h3><br><p>  Los niveles se toman prestados de RFC 5424 - El Protocolo Syslog, su descripci√≥n aproximada es la siguiente: </p><br><ul><li>  depuraci√≥n: detalles para la depuraci√≥n </li><li>  info - Eventos interesantes </li><li>  aviso - Eventos materiales, pero no errores </li><li>  advertencia: casos excepcionales, pero no errores </li><li>  error: errores de ejecuci√≥n que no requieren intervenci√≥n moment√°nea </li><li>  cr√≠tico: condiciones cr√≠ticas (el componente del sistema no est√° disponible, excepci√≥n inesperada) </li><li>  alerta - La acci√≥n requiere intervenci√≥n inmediata </li><li>  emergencia: el sistema no funciona </li></ul><br><p>  Hay una descripci√≥n, pero no siempre es f√°cil de seguir, debido a la dificultad para determinar la importancia de ciertos eventos.  Por ejemplo, en el contexto de una sola solicitud, no fue posible acceder al recurso conectado.  Al grabar este evento, no sabemos si una de esas solicitudes fall√≥, o tal vez solo un usuario falla.  Depende de si se requiere intervenci√≥n inmediata o si este es un caso raro, puede esperar o incluso ser ignorado.  Dichos problemas se resuelven en el marco de los registros de monitoreo.  Pero a√∫n necesita determinar el nivel.  Por lo tanto, se pueden acordar los niveles de registro en el equipo.  Un ejemplo: </p><br><ul><li>  <strong>emergencia</strong> es el nivel de los sistemas externos que pueden observar su sistema y determinar con seguridad si no funciona por completo o si su autodiagn√≥stico no funciona. </li><li>  <strong>alerta</strong> : el sistema mismo puede diagnosticar su estado, por ejemplo, con una tarea programada y, como resultado, registrar un evento con este nivel.  Pueden ser comprobaciones de recursos conectados o algo espec√≠fico, por ejemplo, un saldo en la cuenta de un recurso externo utilizado. </li><li>  <strong>cr√≠tico</strong> : un evento cuando una falla proporciona un componente del sistema que es muy importante y siempre debe funcionar.  Ya depende mucho de lo que haga el sistema.  Adecuado para eventos que es importante descubrir r√°pidamente, incluso si sucedi√≥ solo una vez. </li><li>  <strong>error</strong> : se ha producido un evento sobre el cual, cuando se repite pronto, debe informar.  No se pudo completar la acci√≥n, que debe realizarse, pero esta acci√≥n no se incluye en la descripci√≥n de cr√≠tica.  Por ejemplo, no fue posible guardar la imagen de perfil de un usuario a petici√≥n suya, pero el sistema no es un servicio de imagen de perfil, sino un sistema de chat. </li><li>  <strong>advertencia</strong> : eventos, para la notificaci√≥n inmediata de los cuales necesita marcar un n√∫mero significativo de ellos durante un per√≠odo de tiempo.  No se pudo realizar una acci√≥n, cuyo fallo no rompe nada grave.  Estos siguen siendo errores, pero la correcci√≥n de los cuales puede esperar el horario de trabajo.  Por ejemplo, no fue posible guardar el avatar del usuario, y el sistema era una tienda en l√≠nea.  La notificaci√≥n sobre ellos es necesaria (a alta frecuencia) para conocer las anomal√≠as repentinas, ya que pueden ser s√≠ntomas de problemas m√°s graves. </li><li>  <strong>aviso</strong> : estos son eventos que informan desviaciones proporcionadas por el sistema que forman parte del funcionamiento normal del sistema.  Por ejemplo, el usuario especific√≥ una contrase√±a incorrecta en la entrada, el usuario no complet√≥ el segundo nombre, pero no es necesario, el usuario compr√≥ el pedido por 0 rublos, pero esto se le proporciona en casos excepcionales.  Tambi√©n es necesaria una notificaci√≥n en una frecuencia alta, ya que un aumento brusco en el n√∫mero de desviaciones puede ser el resultado de un error que debe corregirse urgentemente. </li><li>  <strong>info</strong> - eventos, cuya ocurrencia informa el funcionamiento normal del sistema.  Por ejemplo, un usuario se ha registrado, un usuario ha comprado un producto, un usuario ha dejado comentarios.  La notificaci√≥n para tales eventos debe configurarse de la manera opuesta: si se ha producido un n√∫mero insuficiente de tales eventos durante un per√≠odo de tiempo, entonces debe notificarlo, porque su disminuci√≥n podr√≠a deberse a un error. </li><li>  <strong>depuraci√≥n</strong> : eventos para depurar un proceso en el sistema.  Cuando agrega suficientes datos al contexto del evento, puede diagnosticar el problema o concluir que el proceso funciona correctamente en el sistema.  Por ejemplo, un usuario abri√≥ una p√°gina de producto y recibi√≥ una lista de recomendaciones.  Aumenta significativamente el n√∫mero de eventos enviados, por lo que est√° permitido eliminar el registro de dichos eventos despu√©s de un tiempo.  Como resultado, el n√∫mero de tales eventos en la operaci√≥n normal ser√° variable, luego se puede omitir el monitoreo de notificaciones sobre ellos. </li></ul><br><h3 id="soobschenie-sobytiya">  Mensaje de evento </h3><br><p>  Por PSR-3, un mensaje debe ser una cadena o un objeto con el m√©todo <code>__toString()</code> .  Adem√°s, de acuerdo con PSR-3, la l√≠nea de mensaje puede contener marcadores de posici√≥n del formulario <code>‚ÄùUser {username} created‚Äù</code> , que puede reemplazarse por valores de la matriz de contexto.  Al usar Elasticsearch y Kibana para el monitoreo, recomiendo no usar marcadores de posici√≥n, sino escribir l√≠neas fijas, porque esto simplificar√° el filtrado de eventos y el contexto siempre estar√° ah√≠.  Adem√°s, propongo prestar atenci√≥n a los requisitos adicionales para el mensaje: </p><br><ol><li>  El texto debe ser breve pero significativo.  Esto es lo que vendr√° en las alertas y lo que estar√° en las listas de eventos que han ocurrido. </li><li>  Es mejor que el texto sea √∫nico para diferentes partes del programa.  Esto permitir√° desde la alerta, sin mirar el contexto, comprender en qu√© parte ocurri√≥ el evento. </li></ol><br><h3 id="kontekst-sobytiya">  Contexto del evento </h3><br><p>  El contexto del evento para PSR-3 es una matriz (posiblemente anidada) de valores variables, por ejemplo, ID de entidad.  El contexto puede dejarse en blanco si el mensaje es claro sobre el evento.  En el caso de registrar una excepci√≥n, debe pasar la excepci√≥n completa, no solo <code>getMessage()</code> .  Al usar Monolog a trav√©s de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">NormalizerFormatter, los</a> datos √∫tiles se extraer√°n autom√°ticamente de la excepci√≥n y se agregar√°n al contexto del evento, incluido el seguimiento de la pila.  Es decir, necesitas en su lugar </p><br><pre> <code class="php hljs">[ <span class="hljs-string"><span class="hljs-string">'exception'</span></span> =&gt; $exception-&gt;getMessage(), ]</code> </pre> <br><p>  para usar </p><br><pre> <code class="php hljs">[ <span class="hljs-string"><span class="hljs-string">'exception'</span></span> =&gt; $exception, ]</code> </pre> <br><p>  En Laravel, puede ingresar autom√°ticamente datos para eventos en eventos.  Esto se puede hacer a trav√©s del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">contexto de registro global</a> (solo para excepciones fallidas o mediante <code>report()</code> ), o mediante LogFormatter (para todos los eventos).  Por lo general, la informaci√≥n se agrega con la identificaci√≥n del usuario actual, solicitud de URI, IP, solicitud de UUID y similares. </p><br><p>  Cuando use Elasticsearch como repositorio de registros, recuerde que usa tipos de datos fijos.  Es decir, si pas√≥ <code>customer_id</code> en el contexto de un n√∫mero, cuando intenta guardar un evento con un tipo diferente, por ejemplo, una cadena (uuid), dicho mensaje no se escribir√°.  Los tipos en el √≠ndice son fijos cuando el valor se recibe por primera vez.  Si se crean √≠ndices todos los d√≠as, el nuevo tipo se registrar√° solo al d√≠a siguiente.  Pero incluso esto no resolver√° todos los problemas, porque para Kibana los tipos se mezclar√°n y algunas de las operaciones asociadas con el tipo no estar√°n disponibles hasta que haya √≠ndices mixtos. </p><br><p>  Para evitar este problema, le recomiendo que siga las reglas: </p><br><ul><li>  No utilice nombres de clave demasiado gen√©ricos, que pueden ser de diferentes tipos. </li><li>  Realice una conversi√≥n expl√≠cita a un tipo de valor si no est√° seguro de su tipo </li></ul><br><p>  Ejemplo: en cambio </p><br><pre> <code class="php hljs">[ <span class="hljs-string"><span class="hljs-string">'response'</span></span> =&gt; $response-&gt;all(), <span class="hljs-string"><span class="hljs-string">'customer_id'</span></span> =&gt; $id, <span class="hljs-string"><span class="hljs-string">'value'</span></span> =&gt; $someValue, ]</code> </pre> <br><p>  para usar </p><br><pre> <code class="php hljs">[ <span class="hljs-string"><span class="hljs-string">'smsc_response_data'</span></span> =&gt; json_encode($response-&gt;all()), <span class="hljs-string"><span class="hljs-string">'customer_id'</span></span> =&gt; (string) $customer_id, <span class="hljs-string"><span class="hljs-string">'smsc_request_some_value'</span></span> =&gt; (string) $someValue, ]</code> </pre> <br><h3 id="vyzov-loggera-iz-koda">  Llamar a un registrador desde el c√≥digo </h3><br><p>  Para grabar r√°pidamente un evento en el registro, puede encontrar varias opciones.  Consideremos algunos de ellos. </p><br><ol><li>  Declare la funci√≥n global <code>log()</code> y ll√°mela desde diferentes partes del programa.  Este enfoque tiene muchas desventajas.  Por ejemplo, en las clases donde accedemos a esta funci√≥n, se forma una dependencia impl√≠cita.  Esto debe ser evitado.  Adem√°s, dicho registrador es dif√≠cil de configurar cuando el sistema necesita tener varios diferentes.  Otro inconveniente, si estamos hablando de trabajar con Laravel, es que no usamos las funciones proporcionadas por el marco para resolver este problema. </li><li>  Utilice la fachada de Laravel \ Log.  Con este enfoque, las partes del sistema que acceden a esta fachada comienzan a depender del marco.  En partes del sistema que no vamos a eliminar del marco, esta soluci√≥n es bastante adecuada.  Por ejemplo, escriba desde algunas instancias de un comando de consola, tarea en segundo plano, controlador.  O cuando ya existe una estructura compleja de servicios, y lanzar una instancia de un registrador en ellos no es tan simple. </li><li>  Resuelva la dependencia del registrador a trav√©s de los ayudantes de la <code>app()</code> y el marco de trabajo <code>resolve()</code> .  El enfoque tiene las mismas desventajas que usar la fachada, pero necesita escribir un poco m√°s de c√≥digo. </li><li>  Especifique la dependencia del registrador en el constructor de la clase que utilizar√° este registrador.  Al mismo tiempo, se debe especificar el mismo <code>LoggerInterface</code> como tipo para cumplir con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">DIP</a> .  Gracias a los marcos de cableado autom√°tico, las dependencias se resolver√°n autom√°ticamente en la implementaci√≥n de sus abstracciones declaradas.  En Laravel, algunas clases de dependencia pueden especificarse en un m√©todo separado, en lugar de especificarse en el constructor de toda la clase. </li></ol><br><h3 id="gde-v-kode-vyzyvat-logger">  En qu√© parte del c√≥digo llamar al registrador </h3><br><p>  Al organizar el c√≥digo en el proyecto, puede surgir la pregunta en qu√© clase debo escribir en el registro.  ¬øDeber√≠a ser un servicio?  ¬øO deber√≠a hacerse desde donde se llama al servicio: controlador, tarea en segundo plano, comando de consola?  ¬øO deber√≠a cada excepci√≥n decidir qu√© escribir en el registro utilizando su m√©todo de <code>report</code> (Laravel)?  No hay una respuesta simple a todas las preguntas a la vez. </p><br><p>  Considere la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">oportunidad que le</a> brinda Laravel para delegar en la clase de excepci√≥n la tarea de iniciar sesi√≥n.  Una excepci√≥n no puede saber cu√°n cr√≠tico es para el sistema determinar el nivel de un evento.  Adem√°s, una excepci√≥n no tiene acceso al contexto a menos que se agregue espec√≠ficamente cuando se llama a esta excepci√≥n.  Para llamar al m√©todo de <code>render</code> en una excepci√≥n, no debe capturar la excepci√≥n (se usar√° el ErrorHandler global) o capturar y usar el ayudante global <code>report()</code> .  Este m√©todo nos permite no llamar al registrador PSR-3 cada vez que podamos detectar esta excepci√≥n.  Pero no creo que valga la pena dar a la excepci√≥n tal responsabilidad. </p><br><p>  Puede parecer que siempre podemos iniciar sesi√≥n solo en los servicios.  De hecho, en algunos servicios puedes hacer logging.  Pero considere un servicio que no depende del proyecto y, en general, planeamos ponerlo en un paquete separado.  Entonces, este servicio no conoce su importancia en el proyecto y, por lo tanto, no podr√° determinar el nivel de registro.  Por ejemplo, un servicio de integraci√≥n con una puerta de enlace SMS espec√≠fica.  Si recibimos un error de red, esto no significa que sea bastante grave.  Quiz√°s el sistema tenga un servicio de integraci√≥n con otra puerta de enlace de SMS a trav√©s de la cual habr√° un segundo intento de env√≠o, luego el error del primero se puede informar como advertencia, y el error del segundo como error.  Solo que ahora todas estas integraciones deber√≠an llamarse desde otro servicio, que iniciar√° sesi√≥n exactamente.  Resulta que el error est√° en un servicio e iniciamos sesi√≥n en otro.  Pero a veces no tenemos un contenedor de servicios sobre otro servicio, lo llamamos directamente desde el controlador.  En este caso, considero permisible escribir en el registro en el controlador en lugar de escribir un decorador de servicios para el registro. </p><br><p>  Un ejemplo que muestra el uso de la dependencia y el contexto de paso: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Console</span></span>\<span class="hljs-title"><span class="hljs-title">Commands</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Services</span></span>\<span class="hljs-title"><span class="hljs-title">ExampleService</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Console</span></span>\<span class="hljs-title"><span class="hljs-title">Command</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Psr</span></span>\<span class="hljs-title"><span class="hljs-title">Log</span></span>\<span class="hljs-title"><span class="hljs-title">LoggerInterface</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Example</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Command</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $signature = <span class="hljs-string"><span class="hljs-string">'example'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ExampleService $service, LoggerInterface $logger)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { $service-&gt;example(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (\<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> $exception) { $logger-&gt;critical(<span class="hljs-string"><span class="hljs-string">'Example error'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'exception'</span></span> =&gt; $exception, ]); } } }</code> </pre><br><h2 id="kuda-pisat">  Donde escribir </h2><br><p>  Considere las siguientes opciones. </p><br><ol><li>  De acuerdo con la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aplicaci√≥n de 12 factores</a> y algunas otras recomendaciones, debe escribir stdout, stderr del tiempo de ejecuci√≥n de la aplicaci√≥n.  Para hacer esto, puede especificar en el registrador de configuraci√≥n <code>php://stdout</code> *. </li><li>  Ignora el factor 12, la ventana acoplable y escribe en los archivos.  Laravel (Monolog) incluso le permite configurar la rotaci√≥n de registros.  Se pueden recopilar m√°s mensajes de archivos usando Filebeat y enviarlos a Logstash para su an√°lisis. </li><li>  Env√≠e registros desde la aplicaci√≥n directamente m√°s lejos, por ejemplo, a trav√©s de UDP para aumentar el rendimiento. </li><li>  Combina soluciones.  Escriba en los archivos que utilizando Filebeat se recopilar√°n y enviar√°n a Logstash.  Escriba en el contenedor stderr para poder utilizar los comandos de <code>docker logs</code> la <code>docker logs</code> y estar listo para recopilar registros del entorno de orquestaci√≥n del contenedor.  En este caso, puede escribir algunos canales solo localmente, algunos env√≠an a trav√©s de la red. </li></ol><br><p>  * <em>En php-fpm 7.2, cuando escribimos registros en stdout, obtenemos "ADVERTENCIA: [pool www] child X dijo en stdout ...", y los mensajes largos se truncan.</em>  <em>Una soluci√≥n a este problema est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> .</em>  <em>No hay tal problema en php-fpm 7.3.</em> </p><br><p>  Opciones de formato de grabaci√≥n: </p><br><ul><li>  Legible por humanos (saltos de l√≠nea, sangr√≠as, etc.) </li><li>  Legible por m√°quina (generalmente json) </li><li>  Ambos formatos a la vez: legible por m√°quina en stdout para enrutamiento adicional, legible por humanos en caso de problemas repentinos de enrutamiento y depuraci√≥n r√°pida </li></ul><br><p>  Cualquiera de las opciones supone que los registros se enrutan; al menos, se env√≠an a un √∫nico sistema de procesamiento (almacenamiento) de registros por los siguientes motivos: </p><br><ol><li>  Almacenamiento y archivo a largo plazo </li><li>  Tendencias a gran escala </li><li>  Sistema flexible de notificaci√≥n de eventos. </li></ol><br><p>  Docker tiene la capacidad de especificar un administrador de registros.  El valor predeterminado es <code>json-file</code> , es decir, la ventana acoplable agrega la salida del contenedor al archivo json en el host.  Si seleccionamos un administrador de registros que enviar√° registros a alguna parte de la red, ya no podremos usar el <code>docker logs</code> .  Si se eligi√≥ stdout / stderr del contenedor como el √∫nico lugar para grabar registros de aplicaciones, entonces, en caso de problemas de red o problemas con un √∫nico repositorio, puede que no sea posible extraer r√°pidamente las entradas para la depuraci√≥n. </p><br><p>  Podemos usar json-file docker y Filebeat.  Recibiremos registros locales y m√°s rutas.  Vale la pena se√±alar que aqu√≠ hay otra caracter√≠stica de la ventana acoplable.  Al grabar un evento de m√°s de 16 KB, la ventana acoplable rompe el registro con el s√≠mbolo <code>\n</code> , lo que confunde a muchos recolectores de registros.  Hay un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">problema al</a> respecto.  El problema por parte de la ventana acoplable no se pudo resolver, por lo que fue resuelto por los recolectores.  Con alguna versi√≥n, Filebeat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">admite</a> este comportamiento de acoplador y combina correctamente los eventos. </p><br><p>  Qu√© combinaci√≥n de todas las posibilidades de destinos y formatos de grabaci√≥n puede elegir para su proyecto usted mismo. </p><br><h2 id="ispolzovanie-filebeat--elk--elastalert">  Usando Filebeat + ELK + Elastalert </h2><br><p>  Brevemente, el papel de cada servicio se puede describir de la siguiente manera: </p><br><ul><li>  Filebeat: recopila eventos de archivos y los env√≠a </li><li>  Logstash: analiza eventos y env√≠a </li><li>  Elasticsearch - almacena eventos estructurados </li><li>  Kibana: muestra eventos (gr√°ficos, agregaciones, etc.) </li><li>  Elastalert: env√≠a alertas basadas en solicitudes </li></ul><br><p>  Adem√°s, puedes: zabbix, metricbeat, grafana y m√°s. </p><br><p>  Ahora m√°s sobre cada uno. </p><br><h3 id="filebeat">  Filebeat </h3><br><p>  Puede ejecutarse como un servicio separado en el host, puede usar un contenedor docker separado.  Para trabajar con la secuencia de eventos desde Docker, utiliza la ruta del host <code>/var/lib/docker/containers/*/*.log</code> .  Filebeat tiene una amplia <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">gama de opciones</a> con las que puede establecer el comportamiento en diversas situaciones (se cambia el nombre del archivo, se elimina el archivo y similares).  Filebeat en s√≠ puede analizar json dentro del evento, pero no json tambi√©n puede entrar en eventos, lo que provocar√° un error.  Todo el procesamiento de eventos se realiza mejor en un solo lugar. </p><br><div class="spoiler">  <b class="spoiler_title">Configuraci√≥n de fragmentos para Filebeat 6</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">filebeat.inputs: - type: docker containers: ids: - "*" processors: - add_docker_metadata: ~</code> </pre></div></div><br><h3 id="logstash">  Logstash </h3><br><p>  Capaz de aceptar eventos de muchas fuentes, pero aqu√≠ estamos considerando Filebeat. <br>  En cada evento, adem√°s del evento en s√≠ de stdout / stderr, hay metadatos (host, contenedor, etc.).  Hay muchos filtros de procesamiento integrados: analizar por intervalos regulares, analizar json, modificar, agregar, eliminar campos, etc. Adecuado para analizar tanto los registros de aplicaciones como nginx access.log en cualquier formato.  Capaz de transferir datos a diferentes repositorios, pero aqu√≠ consideramos Elasticsearch. </p><br><div class="spoiler">  <b class="spoiler_title">Fragmento de configuraci√≥n del filtro Logstash</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">if [status] { date { match =&gt; ["timestamp_nginx_access", "dd/MMM/yyyy:HH:mm:ss Z"] target =&gt; "timestamp_nginx" remove_field =&gt; ["timestamp_nginx_access"] } mutate { convert =&gt; { "bytes_sent" =&gt; "integer" "body_bytes_sent" =&gt; "integer" "request_length" =&gt; "integer" "request_time" =&gt; "float" "upstream_response_time" =&gt; "float" "upstream_connect_time" =&gt; "float" "upstream_header_time" =&gt; "float" "status" =&gt; "integer" "upstream_status" =&gt; "integer" } remove_field =&gt; [ "message" ] rename =&gt; { "@timestamp" =&gt; "event_timestamp" "timestamp_nginx" =&gt; "@timestamp" } } }</code> </pre> </div></div><br><h3 id="elasticsearch">  B√∫squeda el√°stica </h3><br><p>  Elasticsearch es una herramienta muy poderosa para una amplia gama de tareas, pero con el prop√≥sito de monitorear los registros se puede usar conociendo solo un cierto m√≠nimo. <br>  Los eventos guardados son un documento, los documentos se almacenan en √≠ndices. <br>  Cada √≠ndice es un esquema en el que se define un tipo para cada campo del documento.  No puede guardar un evento en el √≠ndice si al menos un campo tiene el tipo incorrecto. <br>  Los diferentes tipos le permiten realizar diferentes operaciones en un grupo de documentos (para n√∫meros: suma, m√≠nimo, m√°ximo, promedio, etc., para cadenas: b√∫squeda difusa, etc.). <br>  Para los registros, la administraci√≥n generalmente recomienda usar √≠ndices diarios, un nuevo √≠ndice todos los d√≠as. </p><br><p>  Asegurar el funcionamiento estable de Elasticsearch con el crecimiento del volumen de datos es una tarea que requiere un conocimiento m√°s profundo sobre esta herramienta.  Pero una soluci√≥n r√°pida al problema de estabilidad, puede optar por eliminar autom√°ticamente los datos obsoletos.  Para hacer esto, sugiero dividir los niveles de eventos en logstash en diferentes √≠ndices.  Esto permitir√° m√°s tiempo para almacenar eventos raros, pero m√°s importantes. </p><br><div class="spoiler">  <b class="spoiler_title">Fragmento de configuraci√≥n de salida de Logstash</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">output { if [fields][log_type] == "app_log" { if [level] in ["DEBUG", "INFO", "NOTICE"] { elasticsearch { hosts =&gt; "${ES_HOST}" index =&gt; "logstash-app-log-debug-%{+YYYY.MM.dd}" } } else { elasticsearch { hosts =&gt; "${ES_HOST}" index =&gt; "logstash-app-log-error-%{+YYYY.MM.dd}" } } } }</code> </pre> </div></div><br><p>  Para eliminar autom√°ticamente los √≠ndices obsoletos, sugiero usar un programa de Elastic <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Curator</a> .  El lanzamiento del programa se agrega a la programaci√≥n de Cron, la configuraci√≥n en s√≠ misma se puede almacenar en un archivo separado. </p><br><div class="spoiler">  <b class="spoiler_title">Un fragmento de la configuraci√≥n para eliminar √≠ndices obsoletos.</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">action: delete_indices description: logstash-app-log-error options: ignore_empty_list: True filters: - filtertype: pattern kind: prefix value: logstash-app-log-error- - filtertype: age source: name direction: older timestring: '%Y.%m.%d' unit: months unit_count: 6</code> </pre> </div></div><br><p>         ,         Filebeat  Logstash,   .    Elasticsearch    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">-- </a> , ,    . </p><br><h3 id="kibana"> Kibana </h3><br><p> Kibana        .  -,     Elasticsearch.       . </p><br><p>   Kibana ‚Äî         Discovery   . ,   Discovery       app   warning  ,    time, message, exception class, host, client_id. </p><br><p>  ,  Discovery       nginx,       404    time, message, request, status. <br>   Kibana   ,        :  ,  ,     . ,       (        ). </p><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/habr/post_images/c1d/feb/5a3/c1dfeb5a364508015c4787f5e457528a.jpg" alt="imagen"></p></div></div><br><h3 id="elastalert"> Elastalert </h3><br><p> Elastalert      Elasticsearch      .  , .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">  </a> ,          . <br>       ,         (),       . </p><br><p>   : </p><br><ul><li>       ALERT, EMERGENCY.  ‚Äî 10  </li><li>       CRITICAL.  ‚Äî 30  </li><li>    ,  N   X  M  </li><li>    10 INFO  3  </li><li>   nginx   200, 201, 304     75%  ,     50  </li></ul><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="plaintext hljs">name: Blacklist ALERT, EMERGENCY type: blacklist index: logstash-app-* compare_key: "level" blacklist: - "ALERT" - "EMERGENCY" realert: minutes: 5 alert: - "slack"</code> </pre></div></div><br><p>             ‚Äî <strong>  </strong> .       ,      ,   .        Kibana. </p><br><p>    , ,   http-     75%  ,     ,   ,     ,    .  -   ,     ,      ,     . </p><br><p>         , ,  ,     ,       Kibana,        . </p><br><p>    5     .    , ,     ,  ,  ,     . </p><br><p>      ,          .       . </p><br><p>            Kibana    .            . </p><br><h2 id="vsyo-vmeste">   </h2><br><p>      docker-.     ,         ,    staging-  production-,      . </p><br><p>   ,   Elastalert,      .  Elastalert  ,    <br> <code>envsubst &lt; /opt/elastalert/config.dist.yaml &gt; /opt/elastalert/config.yaml</code>  entrypoint-   ,   . </p><br><p>        ,       ,       ,     . </p><br><div class="spoiler"> <b class="spoiler_title">    Makefile       </b> <div class="spoiler_text"><pre> <code class="plaintext hljs">build: docker build -t some-registry/elasticsearch elasticsearch docker build -t some-registry/logstash logstash docker build -t some-registry/kibana kibana docker build -t some-registry/nginx nginx docker build -t some-registry/curator curator docker build -t some-registry/elastalert elastalert push: docker push some-registry/elasticsearch docker push some-registry/logstash docker push some-registry/kibana docker push some-registry/nginx docker push some-registry/curator docker push some-registry/elastalert pull: docker pull some-registry/elasticsearch docker pull some-registry/logstash docker pull some-registry/kibana docker pull some-registry/nginx docker pull some-registry/curator docker pull some-registry/elastalert prepare: docker network create -d bridge elk-network || echo "ok" stop: docker rm -f kibana || true docker rm -f logstash || true docker rm -f elasticsearch || true docker rm -f nginx || true docker rm -f elastalert || true run-logstash: docker rm -f logstash || echo "ok" docker run -d --restart=always --network=elk-network --name=logstash -p 127.0.0.1:5001:5001 -e "LS_JAVA_OPTS=-Xms256m -Xmx256m" -e "ES_HOST=elasticsearch:9200" some-registry/logstash run-kibana: docker rm -f kibana || echo "ok" docker run -d --restart=always --network=elk-network --name=kibana -p 127.0.0.1:5601:5601 --mount source=elk-kibana,target=/usr/share/kibana/optimize some-registry/kibana run-elasticsearch: docker rm -f elasticsearch || echo "ok" docker run -d --restart=always --network=elk-network --name=elasticsearch -e "ES_JAVA_OPTS=-Xms1g -Xmx1g" --mount source=elk-esdata,target=/usr/share/elasticsearch/data some-registry/elasticsearch run-nginx: docker rm -f nginx || echo "ok" docker run -d --restart=always --network=elk-network --name=nginx -p 80:80 -v /root/elk/.htpasswd:/etc/nginx/.htpasswd some-registry/nginx run-elastalert: docker rm -f elastalert || echo "ok" docker run -d --restart=always --network=elk-network --name=elastalert --env-file=./elastalert/.env some-registry/elastalert run: prepare run-elasticsearch run-kibana run-logstash run-elastalert delete-old-indices: docker run --rm --network=elk-network -e "ES_HOST=elasticsearch:9200" some-registry/curator curator --config /curator/curator.yml /curator/actions.yml</code> </pre> </div></div><br><p>      : </p><br><ul><li>    80  nginx,     basic auth  Kibana </li><li>  Logstash  .       ssh- </li><li>       nginx </li><li>    ,  docker- </li><li>           </li><li>          </li><li>       ,  .env-    nginx- </li><li>  *_JAVA_OPTS   ,          4GB RAM (        ES). </li></ul><br><p>  ,          xpack-. </p><br><p>    docker-compose. ,   ,   Dockerfile-,  Filebeat,  Logstash,  ,   ,     ,    ,        VCS. </p><br><p>       .      .     ,    ( Laravel    scheduler), ,     5   .          ALERT.     ,    .    ,     ,      . </p><br><h2 id="zaklyuchenie">  Conclusi√≥n </h2><br><p>  ,      ,    ,           .       . ,   -      .              .   ,   ,  . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/456676/">https://habr.com/ru/post/456676/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../456666/index.html">WebTotem o c√≥mo queremos que Internet sea m√°s seguro</a></li>
<li><a href="../456668/index.html">Microsoft ML Spark: una extensi√≥n de Spark que hace que SparkML sea m√°s humano y LightGBM como un bono</a></li>
<li><a href="../456670/index.html">Sobre el m√©todo de autenticaci√≥n muy esp√≠a</a></li>
<li><a href="../456672/index.html">Recetas Nginx: notificaciones as√≠ncronas de PostgreSQL a websocket</a></li>
<li><a href="../456674/index.html">Nuevas oportunidades de promoci√≥n en Facebook que no conoc√≠as</a></li>
<li><a href="../456678/index.html">El estado electr√≥nico del futuro. Parte 4</a></li>
<li><a href="../456680/index.html">Ocho leyes de nomenclatura en dise√±o UX (Parte 2)</a></li>
<li><a href="../456682/index.html">Comportamiento indefinido con declaraciones de funciones obsoletas en ANSI C</a></li>
<li><a href="../456686/index.html">Las complejidades de las entrevistas al contratar a udalenka</a></li>
<li><a href="../456690/index.html">Auriculares cotidianos de Case Guru - CGPods Sport</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>