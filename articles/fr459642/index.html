<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöÅ üßëüèΩ üë©üèæ‚Äçüè´ Acc√®s s√©curis√© aux champs d'enregistrement en C ++ sans sacrifier l'efficacit√© (en utilisant CortexM comme exemple) üíØ üêô üë®üèæ‚Äçüîß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Fig. extrait de www.extremetech.com/wp-content/uploads/2016/07/MegaProcessor-Feature.jpg 

 Bonne sant√© √† tous! 

 Dans un article pr√©c√©dent, j'ai exa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Acc√®s s√©curis√© aux champs d'enregistrement en C ++ sans sacrifier l'efficacit√© (en utilisant CortexM comme exemple)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459642/"><img src="https://habrastorage.org/webt/et/ni/fl/etnifl3hcinjjsqt8skfvv6km5q.png" alt="image"><br>  <sub>Fig.</sub>  <sub>extrait de <a href="">www.extremetech.com/wp-content/uploads/2016/07/MegaProcessor-Feature.jpg</a></sub> <br><br>  Bonne sant√© √† tous! <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Dans un article pr√©c√©dent,</a> j'ai examin√© la question de l'acc√®s aux registres d'un microcontr√¥leur avec un noyau CortexM en C ++ et j'ai montr√© des solutions simples √† certains des probl√®mes. <br><br>  Aujourd'hui, je veux montrer comment s√©curiser l'acc√®s au registre et √† ses champs sans sacrifier l'efficacit√©, en utilisant des classes C ++ g√©n√©r√©es √† partir de fichiers SVD. <br><br>  Tous ceux qui vous int√©ressent, bienvenue au chat.  Il y aura beaucoup de code. <br><a name="habracut"></a><br><h3>  Pr√©sentation </h3><br>  Dans un article <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">C ++ Hardware Register Access Redux</a> , Ken Smith a montr√© comment travailler en toute s√©curit√© et efficacement avec les registres, et l'a m√™me montr√© avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/kensmith/cppmmio</a> comme exemple. <br>  Ensuite, plusieurs personnes ont d√©velopp√© cette id√©e, par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Niklas Hauser a fait un excellent examen</a> et a sugg√©r√© plusieurs autres fa√ßons d'acc√©der en toute s√©curit√© aux registres. <br><br>  Certaines de ces id√©es ont d√©j√† √©t√© mises en ≈ìuvre dans diverses biblioth√®ques, en particulier dans <a href="">modm</a> .  Pour de bon, vous pouvez utiliser toutes ces phrases dans la vraie vie.  Mais au moment du d√©veloppement de ces biblioth√®ques, les descriptions des p√©riph√©riques et des registres venaient juste de commencer √† √™tre standardis√©es, et donc certaines choses ont √©t√© faites dans le but que le travail principal sur la description des registres soit confi√© au programmeur.  De plus, certaines solutions ne sont pas efficaces en termes de ressources de code et de microcontr√¥leur. <br><br>  Aujourd'hui, chaque fabricant d'un microcontr√¥leur ARM fournit une description de tous les registres au format SVD.  Des fichiers d'en-t√™te peuvent √™tre g√©n√©r√©s √† partir de ces descriptions; par cons√©quent, il est possible de cr√©er non pas une simple description des registres, mais une description plus complexe, mais en m√™me temps, ce qui augmentera la fiabilit√© de votre code.  Et c'est g√©nial que le fichier de sortie puisse √™tre dans n'importe quel langage, C, C ++, ou m√™me <a href="">D</a> <br><br>  Mais prenons-le dans l'ordre ce qui est g√©n√©ralement un acc√®s s√ªr aux registres, et pourquoi est-il n√©cessaire du tout.  L'explication peut √™tre montr√©e sur des exemples synth√©tiques simples, tr√®s probablement peu probables, mais tout √† fait possibles: <br><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      GPIOA //,    AHB1ENR RCC-&gt;APB1ENR |= RCC_AHB1ENR_GPIOAEN ; //    ,      RCC-&gt;AHB1ENR = RCC_AHB1ENR_GPIOAEN; //,  TIM1    APB2 RCC-&gt;APB1ENR |= RCC_APB1ENR_TIM2EN | RCC_APB2ENR_TIM1EN; // - ,        . auto result = GPIOA-&gt;BSRR ; if (result &amp; GPIO_BSRR_BS1) { //do something } //-     .   ... GPIOA-&gt;IDR = GPIO_IDR_ID5 ; }</span></span></code> </pre> <br>  Tous ces cas sont possibles dans la pratique, et j'ai certainement regard√© quelque chose comme √ßa de mes √©l√®ves.  Ce serait formidable si vous pouviez interdire de faire de telles erreurs. <br><br>  Il me semble aussi que c'est beaucoup plus agr√©able quand le code a l'air soign√© et n'a pas besoin de commentaires.  Par exemple, m√™me si vous connaissez bien le microcontr√¥leur STM32F411, il n'est pas toujours possible de comprendre ce qui se passe dans ce code: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ uint32 temp = GPIOA-&gt;OSPEEDR ; temp &amp;=~ GPIO_OSPEEDR_OSPEED0_Msk ; temp = (GPIO_OSPEEDR_OSPEED0_0 | GPIO_OSPEEDR_OSPEED0_1) ; GPIOA-&gt;OSPEEDR = temp; }</code> </pre><br>  Aucun commentaire ici ne peut faire.  Le code d√©finit la fr√©quence de fonctionnement du port GPIOA.0 au maximum (clarification de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">mctMaks</a> : en fait, ce param√®tre affecte le temps de mont√©e du front (c'est-√†-dire sa pente) et signifie que le port peut traiter un signal num√©rique normalement √† un signal donn√© (VeryLow \ Low \ Medium \ Haute) fr√©quence). <br><br>  Essayons de nous d√©barrasser de ces lacunes. <br><br><h3>  Enregistrer l'abstraction </h3><br>  Tout d'abord, vous devez comprendre ce qu'est le registre du point de vue du programmeur et du programme. <br><br>  Le registre a une adresse, une longueur ou une taille, un mode d'acc√®s: certains registres peuvent √™tre √©crits, certains ne peuvent √™tre lus et la plupart peuvent √™tre lus et √©crits. <br><br>  De plus, le registre peut √™tre repr√©sent√© comme un ensemble de champs.  Un champ peut √™tre compos√© d'un bit ou de plusieurs bits et se trouve n'importe o√π dans le registre. <br><br>  Par cons√©quent, les caract√©ristiques de champ suivantes sont importantes pour nous: longueur ou taille ( <b>largeur</b> ou <b>taille</b> ), d√©calage par rapport au d√©but du registre ( <b>d√©calage</b> ) et valeur. <br><br>  Les valeurs de champ sont l'espace de toutes les quantit√©s possibles que le champ peut prendre et cela d√©pend de la longueur du champ.  C'est-√†-dire  si le champ a une longueur de 2, alors il y a 4 valeurs de champ possibles (0,1,2,3).  Comme le registre, les champs et les valeurs de champ ont un mode d'acc√®s (lecture, √©criture, lecture et √©criture) <br><br>  Pour le rendre plus clair, prenons le registre TIM1 CR1 du microcontr√¥leur STM32F411.  Sch√©matiquement, cela ressemble √† ceci: <br><br><img src="https://habrastorage.org/webt/sr/da/i4/srdai4a4hmphkmhrulcvdcx9r3u.png" alt="image"><br><br><ul><li>  Bit 0 CEN: Activer le compteur <br>  0: compteur activ√©: <b>d√©sactiv√©</b> <br>  1: compteur d√©sactiv√©: <b>activ√©</b> <br></li><li>  Bit UDIS 1: activer / d√©sactiver l'√©v√©nement UEV <br>  0: √©v√©nement UEV activ√©: activ√© <br>  1: √©v√©nement UEV d√©sactiv√©: <b>d√©sactiv√©</b> <br></li><li>  URS Bit 2: S√©lectionner les sources de g√©n√©ration d'√©v√©nements UEV <br>  0: UEV est g√©n√©r√© lors d'un d√©bordement ou lors de la d√©finition de l'UG: <b>n'importe quel</b> bit <br>  1: UEV est g√©n√©r√© uniquement en cas de d√©bordement: <b>d√©bordement</b> <br></li><li>  Bit 3 OPM: op√©ration unique <br>  0: le temporisateur continue de compter davantage apr√®s l'√©v√©nement UEV: <b>ContinueAfterUEV</b> <br>  1: Le temporisateur s'arr√™te apr√®s l' <b>√©v√©nement</b> UEV: <b>StopAfterUEV</b> <br></li><li>  Bit 4 DIR: Direction du comptage <br>  0: Compte direct: <b>Upcounter</b> <br>  1: <b>Compte √† rebours</b> : <b>Downcounter</b> <br></li><li>  Bit 6: 5 CMS: Mode d'alignement <br>  0: Mode d'alignement 0: <b>CenterAlignedMode0</b> <br>  1: Mode d'alignement 1: <b>CenterAlignedMode1</b> <br>  2: Mode d'alignement 2: <b>CenterAlignedMode2</b> <br>  3: Mode d'alignement 3: <b>CenterAlignedMode3</b> <br></li><li>  Bit 7 APRE: mode de pr√©chargement pour le registre ARR <br>  0: le registre TIMx_ARR n'est pas mis en m√©moire tampon: <b>ARRNotBuffered</b> <br>  1: le registre TIMx_ARR n'est pas mis en m√©moire tampon: <b>ARRBuffered</b> <br></li><li>  Bit 8: 9 CKD: diviseur d'horloge <br>  0: tDTS = tCK_INT: <b>ClockDevidedBy1</b> <br>  1: tDTS = 2 * tCK_INT: <b>ClockDevidedBy2</b> <br>  2: tDTS = 4 * tCK_INT: <b>ClockDevidedBy4</b> <br>  3: R√©serv√©: <b>R√©serv√©</b> <br></li></ul><br>  Ici, par exemple, CEN est un champ de 1 bit avec un d√©calage de 0 par rapport au d√©but du registre.  Et <b>Enable</b> (1) et <b>Disable</b> (0) sont ses valeurs possibles. <br><br>  Nous ne nous concentrerons pas sur ce dont chaque champ de ce registre est sp√©cifiquement responsable, il est important pour nous que chaque champ et valeur de champ ait un nom qui ait une signification s√©mantique et √† partir duquel il peut en principe √™tre compris ce qu'il fait. <br><br>  Nous devons avoir acc√®s √† la fois au registre et au champ et √† sa valeur.  Par cons√©quent, sous une forme tr√®s approximative, l'abstraction des registres peut √™tre repr√©sent√©e par les classes suivantes: <br><br><img src="https://habrastorage.org/webt/pi/kr/-s/pikr-sq7lnpo9c6uilrmghdzd5a.png" alt="image"><br><br>  En plus des classes, il est √©galement important pour nous que les registres et les champs individuels aient certaines propri√©t√©s, le registre a une adresse, une taille, un mode d'acc√®s (lecture seule, √©criture seule ou les deux). <br>  Le champ a une taille, un d√©calage et √©galement un mode d'acc√®s.  De plus, le champ doit contenir un lien vers le registre auquel il appartient. <br><br>  La valeur du champ doit avoir un lien vers le champ et un attribut suppl√©mentaire - la valeur. <br><br>  Par cons√©quent, dans une version plus d√©taill√©e, notre abstraction ressemblera √† ceci: <br><br><img src="https://habrastorage.org/webt/m4/3u/mb/m43umbc8vceiuila8_komovib38.png"><br><br>  En plus des attributs, notre abstraction devrait avoir des m√©thodes de modification et d'acc√®s.  Par souci de simplicit√©, nous nous limitons aux m√©thodes d'installation / √©criture et de lecture. <br><br><img src="https://habrastorage.org/webt/uy/d7/sb/uyd7sb-z-tggllnj4knjf_rfhi4.png" alt="image"><br><br>  Lorsque nous avons d√©cid√© de l'abstraction des cas, nous devons v√©rifier comment cette abstraction correspond √† ce qui est d√©crit dans le fichier SVD. <br><br><h3>  Fichier SVD (System View Description) </h3><br>  Le format de description de pr√©sentation du syst√®me CMSIS (CMSIS-SVD) est une description formelle des registres de microcontr√¥leur bas√©e sur le processeur ARM Cortex-M.  Les informations contenues dans les descriptions de la repr√©sentation du syst√®me correspondent pratiquement aux donn√©es des manuels de r√©f√©rence des appareils.  La description des registres dans un tel fichier peut contenir √† la fois des informations de haut niveau et la fonction d'un seul bit du champ dans le registre. <br><br>  Sch√©matiquement, les niveaux de d√©tail des informations dans un tel fichier peuvent √™tre d√©crits par le sch√©ma suivant, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pris sur le site Web de Keil</a> : <br><br><img src="https://habrastorage.org/webt/1s/oq/6d/1soq6disxizzaj8hvyaovxs9_pm.png" alt="image"><br><br>  Description Les fichiers SVD sont fournis par les fabricants et sont utilis√©s pendant le d√©bogage pour afficher des informations sur le microcontr√¥leur et les registres.  Par exemple, l'IAR les utilise pour afficher des informations dans le panneau Affichage-&gt; Registres.  Les fichiers eux-m√™mes se trouvent dans le dossier Program Files (x86) \ IAR Systems \ Embedded Workbench 8.3 \ arm \ config \ debugger. <br><br>  Clion de JetBrains utilise √©galement des fichiers svd pour afficher les informations de registre pendant le d√©bogage. <br><br>  Vous pouvez toujours t√©l√©charger les descriptions sur les sites du fabricant.  <a href="">Ici, vous pouvez prendre le fichier SVD pour le microcontr√¥leur STM32F411</a> <br><br>  En g√©n√©ral, le format SVD est une norme prise en charge par les fabricants.  Voyons quels sont les niveaux de description dans SVD. <br><br>  Au total, 5 niveaux sont distingu√©s: niveau de l'appareil, niveau du microcontr√¥leur, niveau du registre, niveau du champ, niveau des valeurs √©num√©r√©es. <br><br><ul><li>  <b>Niveau de l'appareil</b> : la description de niveau sup√©rieur de la vue syst√®me est l'appareil.  √Ä ce niveau, les propri√©t√©s li√©es √† l'appareil dans son ensemble sont d√©crites.  Par exemple, un nom, une description ou une version de p√©riph√©rique.  L'unit√© adressable minimale, ainsi que la profondeur de bits du bus de donn√©es.  Les valeurs par d√©faut des attributs de registre, telles que la taille du registre, la valeur de r√©initialisation et les autorisations d'acc√®s, peuvent √™tre d√©finies pour l'ensemble du p√©riph√©rique √† ce niveau et sont implicitement h√©rit√©es par des niveaux de description inf√©rieurs. </li><li>  <b>Niveau du microcontr√¥leur: la</b> section CPU d√©crit le c≈ìur du microcontr√¥leur et ses fonctionnalit√©s.  Cette section est obligatoire si le fichier SVD est utilis√© pour cr√©er le fichier d'en-t√™te de p√©riph√©rique. </li><li>  <b>Couche p√©riph√©rique</b> : un p√©riph√©rique est une collection nomm√©e de registres.  Un p√©riph√©rique est mapp√© √† une adresse de base sp√©cifique dans l'espace d'adressage du p√©riph√©rique. </li><li>  <b>Niveau de registre</b> : un registre est une ressource programmable nomm√©e qui appartient √† un p√©riph√©rique.  Les registres sont mapp√©s √† une adresse sp√©cifique dans l'espace d'adressage du p√©riph√©rique.  L'adresse est relative √† l'adresse p√©riph√©rique de base.  De plus, pour le registre, le mode d'acc√®s (lecture / √©criture) est indiqu√©. </li><li>  <b>Niveau de champ</b> : comme mentionn√© ci-dessus, les registres peuvent √™tre divis√©s en morceaux de bits de diff√©rentes fonctionnalit√©s - champs.  Ce niveau contient les noms des champs uniques dans le m√™me registre, leur taille, les d√©calages par rapport au d√©but du registre, ainsi que le mode d'acc√®s. </li><li>  <b>Le niveau des valeurs de champ √©num√©r√©es</b> : en fait, ce sont des valeurs de champ nomm√©es qui peuvent √™tre utilis√©es par commodit√© en C, C ++, D, etc. </li></ul><br>  En fait, les fichiers SVD sont des fichiers xml ordinaires avec une description compl√®te du syst√®me.  Il existe des convertisseurs de fichiers svd en code C, par exemple <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> , qui g√©n√®rent des en-t√™tes et des structures compatibles C pour chaque p√©riph√©rie et registre. <br><br>  Il existe √©galement un analyseur de fichier SVD <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cmsis-svd</a> √©crit en Phyton qui fait quelque chose comme la d√©s√©rialisation des donn√©es d'un fichier en objets de classe Phython, qui sont ensuite facilement utilis√©s dans votre programme de g√©n√©ration de code. <br><br>  Un exemple de la description du registre du microcontr√¥leur STM32F411 peut √™tre visualis√© sous le spoiler: <br><br><div class="spoiler">  <b class="spoiler_title">Exemple de registre CR1 timer TIM1</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">peripheral</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>TIM1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span>Advanced-timers<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupName</span></span></span><span class="hljs-tag">&gt;</span></span>TIM<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupName</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">baseAddress</span></span></span><span class="hljs-tag">&gt;</span></span>0x40010000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">baseAddress</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">addressBlock</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">offset</span></span></span><span class="hljs-tag">&gt;</span></span>0x0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">offset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">size</span></span></span><span class="hljs-tag">&gt;</span></span>0x400<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">size</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">usage</span></span></span><span class="hljs-tag">&gt;</span></span>registers<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">usage</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">addressBlock</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">registers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">register</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>CR1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">displayName</span></span></span><span class="hljs-tag">&gt;</span></span>CR1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">displayName</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span>control register 1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">addressOffset</span></span></span><span class="hljs-tag">&gt;</span></span>0x0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">addressOffset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">size</span></span></span><span class="hljs-tag">&gt;</span></span>0x20<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">size</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">access</span></span></span><span class="hljs-tag">&gt;</span></span>read-write<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">access</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">resetValue</span></span></span><span class="hljs-tag">&gt;</span></span>0x0000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">resetValue</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fields</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>CKD<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span>Clock division<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span>8<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span>2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>ARPE<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span>Auto-reload preload enable<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span>7<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>CMS<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span>Center-aligned mode selection<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span>5<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span>2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>DIR<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span>Direction<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span>4<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>OPM<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span>One-pulse mode<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span>3<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>URS<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span>Update request source<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span>2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>UDIS<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span>Update disable<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>CEN<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span>Counter enable<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span>0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fields</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">register</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">register</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>  Comme vous pouvez le voir, il y a toutes les informations n√©cessaires √† notre abstraction, √† l'exception de la description des valeurs de bits sp√©cifiques des champs. <br><br>  Tous les fabricants ne veulent pas passer du temps sur une description compl√®te de leur syst√®me, donc comme vous pouvez le voir, ST n'a pas voulu d√©crire les valeurs des champs et a transf√©r√© cette charge aux programmeurs clients.  Mais TI prend soin de ses clients et d√©crit compl√®tement le syst√®me, y compris les descriptions des valeurs de champ. <br><br>  Ce qui pr√©c√®de montre que le format de la description SVD est tr√®s coh√©rent avec notre abstraction de cas.  Le fichier contient toutes les informations n√©cessaires pour d√©crire pleinement le registre. <br><br><h3>  Impl√©mentation </h3><br><h4>  S'inscrire </h4><br>  Maintenant que nous avons fait une abstraction du registre et que nous avons une description des registres sous forme de svd de fabricants qui convient parfaitement √† cette abstraction, nous pouvons passer directement √† l'impl√©mentation. <br><br>  Notre impl√©mentation doit √™tre aussi efficace que le code C et conviviale.  J'aimerais que l'acc√®s aux registres soit aussi clair que possible, par exemple, comme ceci: <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TIM1::CR1::CKD::DividedBy2::IsSet()) { TIM1::ARR::Set(<span class="hljs-number"><span class="hljs-number">10</span></span>_ms) ; TIM1::CR1::CEN::Enable::Set() ; }</code> </pre><br>  Rappelez-vous que pour acc√©der √† l'adresse du registre entier, vous devez utiliser reinterpret_cast: <br><br><pre> <code class="cpp hljs">*<span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> *&gt;(<span class="hljs-number"><span class="hljs-number">0x40010000</span></span>) = (<span class="hljs-number"><span class="hljs-number">1U</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">5U</span></span>) ;</code> </pre> <br>  La classe de registre a d√©j√† √©t√© d√©crite ci-dessus, elle doit avoir une adresse, une taille et un mode d'acc√®s, ainsi que deux m√©thodes <code>Get()</code> et <code>Set()</code> : <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//      template&lt;uint32_t address, size_t size, typename AccessMode&gt; struct RegisterBase { static constexpr auto Addr = address ; using Type = typename RegisterType&lt;size&gt;::Type ; // Set     , //     __forceinline template&lt;typename T = AccessMode, class = typename std::enable_if_t&lt;std::is_base_of&lt;WriteMode, T&gt;::value&gt;&gt; inline static void Set(Type value) { *reinterpret_cast&lt;volatile Type *&gt;(address) = value ; } // Get    , //    ,    __forceinline template&lt;typename T = AccessMode, class = typename std::enable_if_t&lt;std::is_base_of&lt;ReadMode, T&gt;::value&gt;&gt; inline static Type Get() { return *reinterpret_cast&lt;volatile Type *&gt;(address) ; } } ;</span></span></code> </pre> <br>  Nous passons l'adresse, la longueur du registre et le mode d'acc√®s aux param√®tres du mod√®le (c'est aussi une classe).  En utilisant le m√©canisme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SFINAE</a> , √† savoir la <code>enable_if</code> enable_if, nous allons ¬´jeter¬ª les fonctions d'acc√®s <code>Set()</code> ou <code>Get()</code> pour les registres qui ne devraient pas les prendre en charge.  Par exemple, si le registre est en lecture seule, nous <code>ReadMode</code> type <code>ReadMode</code> au param√®tre de mod√®le, <code>enable_if</code> v√©rifiera si l'acc√®s est le successeur de <code>ReadMode</code> et sinon, il cr√©era une erreur contr√¥l√©e (le type T ne peut pas √™tre affich√©), et le compilateur n'inclura pas la m√©thode <code>Set()</code> pour un tel registre.  Il en va de m√™me pour un registre destin√© √† l'√©criture uniquement. <br><br>  Pour le contr√¥le d'acc√®s, nous utiliserons les classes: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//    struct WriteMode {}; struct ReadMode {}; struct ReadWriteMode: public WriteMode, public ReadMode {};</span></span></code> </pre> <br>  Les registres sont disponibles en diff√©rentes tailles: 8, 16, 32, 64 bits. Pour chacun d'eux, nous d√©finissons notre type: <br><br><div class="spoiler">  <b class="spoiler_title">Type de registres selon la taille</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> size&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegisterType</span></span></span><span class="hljs-class"> {</span></span>} ; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegisterType</span></span></span><span class="hljs-class">&lt;8&gt; {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Type = <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> ; } ; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegisterType</span></span></span><span class="hljs-class">&lt;16&gt; {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Type = <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> ; } ; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegisterType</span></span></span><span class="hljs-class">&lt;32&gt; {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Type = <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ; } ; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegisterType</span></span></span><span class="hljs-class">&lt;64&gt; {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Type = <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> ; } ;</code> </pre> <br></div></div><br>  Apr√®s cela, pour le temporisateur TIM1, vous pouvez d√©finir le registre CR1 et, par exemple, le registre EGR de cette mani√®re: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TIM1</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CR1</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterBase&lt;<span class="hljs-number"><span class="hljs-number">0x40010000</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>, ReadWriteMode&gt; { } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EGR</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterBase&lt;<span class="hljs-number"><span class="hljs-number">0x40010014</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>, WriteMode&gt; { } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ TIM1::CR1::Set(<span class="hljs-number"><span class="hljs-number">10</span></span>) ; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> reg = TIM1::CR1::Get() ; <span class="hljs-comment"><span class="hljs-comment">// ,     reg = TIM1::EGR::Get() }</span></span></code> </pre><br>  √âtant donn√© que le compilateur affiche la m√©thode <code>Get()</code> uniquement pour les registres dans lesquels le mode d'acc√®s est h√©rit√© de <code>ReadMode</code> , et les m√©thodes <code>Set()</code> pour les registres dans lesquels le mode d'acc√®s est h√©rit√© de <code>WriteMode</code> , en cas d'utilisation incorrecte des m√©thodes d'acc√®s, vous recevrez une erreur au stade de la compilation.  Et si vous utilisez des outils de d√©veloppement modernes, tels que Clion, m√™me au stade du codage, vous verrez un avertissement de l'analyseur de code: <br><br><img src="https://habrastorage.org/webt/vc/we/gu/vcwegu6a0vulgfcvzjkaum9ac4a.png" alt="image"><br><br>  Eh bien, l'acc√®s aux registres est devenu plus s√ªr, notre code ne vous permet pas de faire des choses inacceptables pour ce registre, mais nous voulons aller plus loin et nous r√©f√©rer non pas √† l'ensemble du registre, mais √† ses champs. <br><br><h4>  Champs </h4><br>  Le champ au lieu de l'adresse a une valeur de d√©calage par rapport au d√©but du registre.  De plus, pour conna√Ætre l'adresse ou le type auquel la valeur du champ doit √™tre port√©e, il doit avoir un lien vers le registre: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//        template&lt;typename Reg, size_t offset, size_t size, typename AccessMode&gt; struct RegisterField { using RegType = typename Reg::Type ; using Register = Reg ; static constexpr RegType Offset = offset ; static constexpr RegType Size = size ; using Access = AccessMode ; template&lt;typename T = AccessMode, class = typename std::enable_if_t&lt;std::is_base_of&lt;WriteMode, T&gt;::value&gt;&gt; static void Set(RegType value) { assert(value &lt; (1U &lt;&lt; size)) ; //CriticalSection cs ; //    RegType newRegValue = *reinterpret_cast&lt;RegType *&gt;(Register::Address) ; //       newRegValue &amp;= ~ (((1U &lt;&lt; size) - 1U) &lt;&lt; offset); //    newRegValue |= (value &lt;&lt; offset) ; //      *reinterpret_cast&lt;RegType *&gt;(Reg::Address) = newRegValue ; } __forceinline template&lt;typename T = AccessMode, class = typename std::enable_if_t&lt;std::is_base_of&lt;ReadMode, T&gt;::value&gt;&gt; inline static RegType Get() { return ((*reinterpret_cast&lt;RegType *&gt;(Reg::Address)) &amp; (((1U &lt;&lt; size) - 1U) &lt;&lt; offset)) &gt;&gt; offset ; } };</span></span></code> </pre> <br>  Apr√®s cela, il est d√©j√† possible de faire les choses suivantes: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TIM1</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CR1</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterBase&lt;<span class="hljs-number"><span class="hljs-number">0x40010000</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>, ReadWriteMode&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> CKD = RegisterField&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, ReadWriteMode&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> ARPE = RegisterField&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> CMS = RegisterField&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, ReadWriteMode&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> DIR = RegisterField&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> OPM = RegisterField&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> URS = RegisterField&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UDIS = RegisterField&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> CEN = RegisterField&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode&gt; ; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   CR1  9   1,  8  0 TIM1::CR1::CKD::Set(2U) ; auto reg = TIM1::CR1::CEN::Get() ; }</span></span></code> </pre><br>  Bien que tout semble plut√¥t bien dans l‚Äôensemble, la signification de <code>TIM1::CR1::CKD::Set(2)</code> n‚Äôest toujours pas claire, que signifie la magie pass√©e √† la fonction <code>Set()</code> ?  Et que signifie le nombre renvoy√© par la <code>TIM1::CR1::CEN::Get()</code> ? <br><br>  Passez en toute transparence aux valeurs de champ. <br><br><h4>  Valeur du champ </h4><br>  L'abstraction d'une valeur de champ est essentiellement aussi un champ, mais capable d'accepter un seul √©tat.  Des attributs sont ajout√©s √† l'abstraction du champ - la valeur r√©elle et un lien vers le champ.  La m√©thode <code>Set()</code> de d√©finition de la valeur du champ est identique √† la m√©thode <code>Set()</code> de d√©finition du champ, sauf que la valeur elle-m√™me n'a pas besoin d'√™tre transmise √† la m√©thode, elle est connue √† l'avance, elle doit simplement √™tre d√©finie.  Mais la m√©thode <code>Get()</code> n'a aucun sens; √† la place, il est pr√©f√©rable de v√©rifier si cette valeur est d√©finie ou non, remplacez cette m√©thode par la m√©thode <code>IsSet()</code> . <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//        template&lt;typename Field, typename Field::Register::Type value&gt; struct FieldValueBase { using RegType = typename Field::Register::Type ; template&lt;typename T = typename Field::Access, class = typename std::enable_if_t&lt;std::is_base_of&lt;WriteMode, T&gt;::value&gt;&gt; static void Set() { RegType newRegValue = *reinterpret_cast&lt;RegType *&gt;(Field::Register::Address) ; newRegValue &amp;= ~ (((1U &lt;&lt; Field::Size) - 1U) &lt;&lt; Field::Offset); newRegValue |= (value &lt;&lt; Field::Offset) ; *reinterpret_cast&lt;RegType *&gt;(Field::Register::Address) = newRegValue ; } __forceinline template&lt;typename T = typename Field::Access, class = typename std::enable_if_t&lt;std::is_base_of&lt;ReadMode, T&gt;::value&gt;&gt; inline static bool IsSet() { return ((*reinterpret_cast&lt;RegType *&gt;(Field::Register::Address)) &amp; static_cast&lt;RegType&gt;(((1U &lt;&lt; Field::Size) - 1U) &lt;&lt; Field::Offset)) == (value &lt;&lt; Field::Offset) ; } };</span></span></code> </pre> <br>  Le champ de registre peut maintenant √™tre d√©crit par un ensemble de ses valeurs: <br><br><div class="spoiler">  <b class="spoiler_title">Valeurs des champs de registre CR1 du temporisateur TIM1</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Reg, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> offset, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> AccessMode&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TIM_CR_CKD_Values</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterField&lt;Reg, offset, size, AccessMode&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> DividedBy1 = FieldValue&lt;TIM_CR_CKD_Values, <span class="hljs-number"><span class="hljs-number">0U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> DividedBy2 = FieldValue&lt;TIM_CR_CKD_Values, <span class="hljs-number"><span class="hljs-number">1U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> DividedBy4 = FieldValue&lt;TIM_CR_CKD_Values, <span class="hljs-number"><span class="hljs-number">2U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Reserved = FieldValue&lt;TIM_CR_CKD_Values, <span class="hljs-number"><span class="hljs-number">3U</span></span>&gt; ; } ; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Reg, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> offset, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> AccessMode&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TIM_CR_ARPE_Values</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterField&lt;Reg, offset, size, AccessMode&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> ARRNotBuffered = FieldValue&lt;TIM_CR_ARPE_Values, <span class="hljs-number"><span class="hljs-number">0U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> ARRBuffered = FieldValue&lt;TIM_CR_ARPE_Values, <span class="hljs-number"><span class="hljs-number">1U</span></span>&gt; ; } ; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Reg, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> offset, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> AccessMode&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TIM_CR_CMS_Values</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterField&lt;Reg, offset, size, AccessMode&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> CenterAlignedMode0 = FieldValue&lt;TIM_CR_CMS_Values, <span class="hljs-number"><span class="hljs-number">0U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> CenterAlignedMode1 = FieldValue&lt;TIM_CR_CMS_Values, <span class="hljs-number"><span class="hljs-number">1U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> CenterAlignedMode2 = FieldValue&lt;TIM_CR_CMS_Values, <span class="hljs-number"><span class="hljs-number">2U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> CenterAlignedMode3 = FieldValue&lt;TIM_CR_CMS_Values, <span class="hljs-number"><span class="hljs-number">3U</span></span>&gt; ; } ; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Reg, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> offset, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> AccessMode&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TIM_CR_DIR_Values</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterField&lt;Reg, offset, size, AccessMode&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Upcounter = FieldValue&lt;TIM_CR_DIR_Values, <span class="hljs-number"><span class="hljs-number">0U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Downcounter = FieldValue&lt;TIM_CR_DIR_Values, <span class="hljs-number"><span class="hljs-number">1U</span></span>&gt; ; } ; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Reg, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> offset, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> AccessMode&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TIM_CR_OPM_Values</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterField&lt;Reg, offset, size, AccessMode&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> ContinueAfterUEV = FieldValue&lt;TIM_CR_OPM_Values, <span class="hljs-number"><span class="hljs-number">0U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> StopAfterUEV = FieldValue&lt;TIM_CR_OPM_Values, <span class="hljs-number"><span class="hljs-number">1U</span></span>&gt; ; } ; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Reg, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> offset, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> AccessMode&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TIM_CR_URS_Values</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterField&lt;Reg, offset, size, AccessMode&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Any = FieldValue&lt;TIM_CR_URS_Values, <span class="hljs-number"><span class="hljs-number">0U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Overflow = FieldValue&lt;TIM_CR_URS_Values, <span class="hljs-number"><span class="hljs-number">1U</span></span>&gt; ; } ; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Reg, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> offset, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> AccessMode&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TIM_CR_UDIS_Values</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterField&lt;Reg, offset, size, AccessMode&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Enable = FieldValue&lt;TIM_CR_UDIS_Values, <span class="hljs-number"><span class="hljs-number">0U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Disable = FieldValue&lt;TIM_CR_UDIS_Values, <span class="hljs-number"><span class="hljs-number">1U</span></span>&gt; ; } ; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Reg, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> offset, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> AccessMode&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TIM_CR_CEN_Values</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterField&lt;Reg, offset, size, AccessMode&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Disable = FieldValue&lt;TIM_CR_CEN_Values, <span class="hljs-number"><span class="hljs-number">0U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Enable = FieldValue&lt;TIM_CR_CEN_Values, <span class="hljs-number"><span class="hljs-number">1U</span></span>&gt; ; } ;</code> </pre><br></div></div><br>  Le registre CR1 lui-m√™me sera alors d√©j√† d√©crit comme suit: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TIM1</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CR1</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterBase&lt;<span class="hljs-number"><span class="hljs-number">0x40010000</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>, ReadWriteMode&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> CKD = TIM_CR1_CKD_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, ReadWriteMode&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> ARPE = TIM_CR1_ARPE_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> CMS = TIM_CR1_CMS_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, ReadWriteMode&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> DIR = TIM_CR1_DIR_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> OPM = TIM_CR1_OPM_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> URS = TIM_CR1_URS_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UDIS = TIM_CR1_UDIS_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> CEN = TIM_CR1_CEN_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode&gt; ; } ; }</code> </pre><br>  Vous pouvez maintenant d√©finir et lire directement la valeur du champ de registre: Par exemple, si vous souhaitez activer le temporisateur sur le compte, il suffit d'appeler la m√©thode <code>Set()</code> sur la valeur <code>Enable</code> du champ CEN du registre CR1 du timer TIM1: <code>TIM1::CR1::CEN::Enable::Set() ;</code>  .  Dans le code, cela ressemblera √† ceci: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TIM1::CR1::CKD::DividedBy2::IsSet()) { TIM1::ARR::Set(<span class="hljs-number"><span class="hljs-number">100U</span></span>) ; TIM1::CR1::CEN::Enable::Set() ; } }</code> </pre><br><div class="spoiler">  <b class="spoiler_title">√Ä titre de comparaison, la m√™me chose en utilisant l'en-t√™te C:</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((TIM1-&gt;CR1 &amp; TIM_CR1_CKD_Msk) == TIM_CR1_CKD_0) { TIM1-&gt;ARR = <span class="hljs-number"><span class="hljs-number">100U</span></span> ; regValue = TIM1-&gt;CR1 ; regValue &amp;=~(TIM_CR1_CEN_Msk) ; regValue |= TIM_CR1_CEN ; TIM1-&gt;CR1 = regValue ; } }</code> </pre><br></div></div><br>  Ainsi, les principales am√©liorations sont apport√©es, nous pouvons avoir un acc√®s simple et compr√©hensible au registre, √† ses champs et √† ses valeurs.     ,   ,        ,      ,     . <br><br>      ,        . ,    : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> regValue = TIM1-&gt;CR1 ; regValue &amp;=~(TIM_CR1_CKD_Msk | TIM_CR1_DIR) ; regValue |= (TIM_CR1_CEN | TIM_CR1_CKD_0 | TIM_CR1_CKD_0) ; TIM1-&gt;CR1 = regValue ; }</code> </pre><br>          <code>Set(...)</code>    ,     ,     .  C'est-√†-dire     : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// 1,      Set() TIM1::CR1::Set(TIM1::CR1::DIR::Upcounter, TIM1::CR1::CKD::DividedBy4, TIM1::CR1::CEN::Enable) ; // 2,     TIM1::CR1&lt;TIM1::CR1::DIR::Upcounter, TIM1::CR1::CKD::DividedBy4, TIM1::CR1::CEN::Enable&gt;::Set() ; }</span></span></code> </pre><br>                        ,        ,    ,    ,       . <br><br>      .      : <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//    ,          template&lt;uint32_t address, size_t size, typename AccessMode, typename ...Args&gt; class Register { private: ...</span></span></code> </pre><br>  ,        : <br><br><ol><li>       ,      . </li><li>           . </li></ol><br>    constexpr ,        : <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//    ,          template&lt;uint32_t address, size_t size, typename AccessMode, typename ...Args&gt; class Register { private: // ,    //     . __forceinline template&lt;typename T&gt; static constexpr auto GetIndividualMask() { Type result = T::Mask &lt;&lt; T::Offset ; return result ; } // ,    //       . static constexpr auto GetMask() { //       const auto values = {GetIndividualMask&lt;Args&gt;()...} ; Type result = 0UL; for (auto const v: values) { //       result |= v ; } return result ; } //    __forceinline template&lt;typename T&gt; static constexpr auto GetIndividualValue() { Type result = T::Value &lt;&lt; T::Offset ; return result ; } static constexpr auto GetValue() { const auto values = {GetIndividualValue&lt;Args&gt;()...}; Type result = 0UL; for (const auto v: values) { result |= v ; } return result ; } };</span></span></code> </pre><br>      <code>Set()</code>  <code>IsSet()</code> : <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//    ,          template&lt;uint32_t address, size_t size, typename AccessMode, typename ...Args&gt; class Register { public: using Type = typename RegisterType&lt;size&gt;::Type; template&lt;typename T = AccessMode, class = typename std::enable_if_t&lt;std::is_base_of&lt;WriteMode, T&gt;::value&gt;&gt; static void Set() { Type newRegValue = *reinterpret_cast&lt;Type *&gt;(address) ; //GetMask()    ,     newRegValue &amp;= ~GetMask() ; //GetValue()    ,     newRegValue |= GetValue() ; //     *reinterpret_cast&lt;Type *&gt;(address) = newRegValue ; } template&lt;typename T = AccessMode, class = typename std::enable_if_t&lt;std::is_base_of&lt;ReadMode, T&gt;::value&gt;&gt; static bool IsSet() { Type newRegValue = *reinterpret_cast&lt;Type *&gt;(address) ; return ((newRegValue &amp; GetMask()) == GetValue()) ; } private: ...</span></span></code> </pre><br>  ,         : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ,     TIM1::CR1 TIM1::CR1&lt;TIM2::CR1::Enabled, TIM1::CR2::OIS1::OC1OutputIs0&gt;::Set() ; }</span></span></code> </pre> <br> ,   - ,      ,    ,       ,   <code>FieldValueBaseType</code> .      ,          <code>FieldValueBaseType</code> : <br><br><div class="spoiler"> <b class="spoiler_title">       </b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> address, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> AccessMode, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> FieldValueBaseType, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ...Args&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Register</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-comment"><span class="hljs-comment">//     BaseType     FieldValueBaseType,    . __forceinline template&lt;typename T, class = typename std::enable_if_t&lt;std::is_same&lt;FieldValueBaseType, typename T::BaseType&gt;::value&gt;&gt; static constexpr auto GetIndividualMask() { Type result = T::Mask &lt;&lt; T::Offset ; return result ; } static constexpr auto GetMask() { const auto values = {GetIndividualMask&lt;Args&gt;()...} ; Type result = 0UL; for (auto const v: values) { result |= v ; } return result ; } //     BaseType     FieldValueBaseType,    . __forceinline template&lt;typename T, class = typename std::enable_if_t&lt;std::is_same&lt;FieldValueBaseType, typename T::BaseType&gt;::value&gt;&gt; static constexpr auto GetIndividualValue() { Type result = T::Value &lt;&lt; T::Offset ; return result ; } static constexpr auto GetValue() { const auto values = {GetIndividualValue&lt;Args&gt;()...}; Type result = 0UL; for (const auto v: values) { result |= v ; } return result ; } };</span></span></code> </pre><br></div></div><br>     ,  SFINAE         ,       ,  ,    ,  ,      . <br><br>    CR1  TIM1,   : <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TIM1</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TIM1CR1Base</span></span></span><span class="hljs-class"> {</span></span>} ; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CR1</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterBase&lt;<span class="hljs-number"><span class="hljs-number">0x40010000</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>, ReadWriteMode&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> CKD = TIM_CR_CKD_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, ReadWriteMode, TIM1CR1Base&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> ARPE = TIM_CR_ARPE_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode, TIM1CR1Base&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> CMS = TIM_CR_CMS_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, ReadWriteMode, TIM1CR1Base&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> DIR = TIM_CR_DIR_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode, TIM1CR1Base&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> OPM = TIM_CR_OPM_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode, TIM1CR1Base&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> URS = TIM_CR_URS_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode, TIM1CR1Base&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UDIS = TIM_CR_UDIS_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode, TIM1CR1Base&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> CEN = TIM_CR_CEN_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode, TIM1CR1Base&gt; ; } ; }</code> </pre> <br> ,          ,        .      ,        ,           ,        . <br><br>        ,     : <br><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     GPIOA //,    AHB1ENR RCC-&gt;APB1ENR |= RCC_AHB1ENR_GPIOAEN ; //    ,      RCC-&gt;AHB1ENR = RCC_AHB1ENR_GPIOAEN; //,  TIM1    APB2 RCC-&gt;APB1ENR |= RCC_APB1ENR_TIM2EN | RCC_APB2ENR_TIM1EN; // - ,        . auto result = GPIOA-&gt;BSRR ; if (result &amp; GPIO_BSRR_BS1) { //do something } //-     .   ... GPIOA-&gt;IDR = GPIO_IDR_ID5 ;</span></span></code> </pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Et essayez de faire de m√™me avec la nouvelle approche: </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     GPIOA // ,   APB1ENR   GPIOAEN RCC::APB1ENR::GPIOAEN::Enable::Set() ; // ,     GPIOA RCC::AHB1ENR::GPIOAEN::Enable::Set() ; // , RCC::APB2ENR::TIM1EN::Enable  //   APB1ENR RCC::APB1ENRPack&lt;RCC::APB1ENR::TIM2EN::Enable, RCC::APB2ENR::TIM1EN::Enable&gt;::Set(); // ,  BSRR    auto result = GPIOA::BSRR::Get() ; // ,  Reset    if (GPIOA::BSRR::BS1::Reset::IsSet()) { //do something } // ,       GPIOA::IDR::IDR5::On::Set() }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans chacun de ces cas, nous obtenons une erreur au stade de la compilation, ce qui est exactement ce que nous avons r√©alis√©. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eh bien, nous avons fourni un bel acc√®s s√ªr au registre et √† ses champs, mais qu'en est-il de la vitesse?</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Performances </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √Ä titre de comparaison, dans quelle mesure notre approche est optimale, nous utiliserons le code C et C ++ qui alimente l'horloge au port A, d√©finit les trois ports en mode de sortie et d√©finit les ports de sortie dans ces trois ports 1: </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code C:</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> res = RCC-&gt;AHB2ENR; res &amp;=~ RCC_AHB1ENR_GPIOAEN_Msk ; res |= RCC_AHB1ENR_GPIOAEN ; RCC-&gt;AHB2ENR = res ; res = GPIOA-&gt;MODER ; res &amp;=~ (GPIO_MODER_MODER5 | GPIO_MODER_MODER4 | GPIO_MODER_MODER1) ; res |= (GPIO_MODER_MODER5_0 | GPIO_MODER_MODER4_0 | GPIO_MODER_MODER1_0) ; GPIOA-&gt;MODER = res ; GPIOA-&gt;BSRR = (GPIO_BSRR_BS5 | GPIO_BSRR_BS4 | GPIO_BSRR_BS1) ; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ; }</code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code C ++:</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ RCC::AHB1ENR::GPIOAEN::Enable::Set() ; GPIOA::MODERPack&lt; GPIOA::MODER::MODER5::Output, GPIOA::MODER::MODER4::Output, GPIOA::MODER::MODER1::Output&gt;::Set() ; GPIOA::BSRRPack&lt; GPIOA::BSRR::BS5::Set, GPIOA::BSRR::BS4::Set, GPIOA::BSRR::BS1::Set&gt;::Write() ; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ; }</code> </pre><br></div></div><br>    IAR.    :      : <br><br>        : <br><br><img src="https://habrastorage.org/webt/w-/wu/ln/w-wulnrmu5wg5pdby7qzzkxfdl8.png" alt="image"><br><br>   C++     : <br><br><img src="https://habrastorage.org/webt/wz/da/sf/wzdasflo3-fmkqsiq4lbtsbgf6g.png" alt="image"><br><br> 18         ,     ,       . <br><br>    ,   : <br><br><img src="https://habrastorage.org/webt/xm/m2/ac/xmm2actwv_1w6m_hqnbhsccg6xe.png" alt="image"><br><br>      13  . <br><br>    ++   : <br><br><img src="https://habrastorage.org/webt/qa/ic/a-/qaica-alj0danc4ffbmhyc2livs.png" alt="image"><br><br>    :  ,      . <br><br>      ,   .      ,       ? <br><br><h3>     </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons obtenu un acc√®s fiable, pratique et rapide aux registres. </font><font style="vertical-align: inherit;">Une question demeure. </font><font style="vertical-align: inherit;">Comment d√©crire tous les registres, il y en a aussi moins d'une centaine pour le microcontr√¥leur. </font><font style="vertical-align: inherit;">C'est le temps qu'il faut pour d√©crire tous les registres, car vous pouvez faire beaucoup d'erreurs dans un tel travail de routine. </font><font style="vertical-align: inherit;">Oui, vous n'avez pas besoin de le faire manuellement. </font><font style="vertical-align: inherit;">Au lieu de cela, nous utiliserons le g√©n√©rateur de code du fichier SVD, qui, comme je l'ai indiqu√© ci-dessus au d√©but de l'article, couvre compl√®tement l'abstraction du registre que j'ai accept√©e. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'ai finalis√© le script d'un coll√®gue qui, bas√© sur cette id√©e, a fait √† peu pr√®s la m√™me chose, mais un peu plus facilement en utilisant enum au lieu de classes pour les valeurs de champ. </font><font style="vertical-align: inherit;">Le script est con√ßu uniquement pour tester et v√©rifier des id√©es, il n'est donc pas optimal, mais il vous permet de g√©n√©rer quelque chose </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comme √ßa. </font></font></a> <br><img src="https://habrastorage.org/webt/jq/0h/kj/jq0hkj-s5u4jyou1-luv7bhlasy.png" alt="image"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qui se soucie du script est </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a> <br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> R√©sum√© </font></font></h3><br>  ,      ,     .      ,   gpioa  rcc,       : <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"gpioaregisters.hpp"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//for GPIOA #include "rccregisters.hpp" //for RCC int main() { RCC::AHB1ENR::GPIOAEN::Enable::Set() ; GPIOA::MODER::MODER15::Output::Set() ; GPIOA::MODERPack&lt; GPIOA::MODER::MODER12::Output, GPIOA::MODER::MODER14::Analog &gt;::Set() ; }</span></span></span></span></code> </pre><br> , SVD      ,     ,        . <br><br> ,     ,       ,       SVD  , -   ST   ,     : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Reg, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> offset, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> AccessMode, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> BaseType&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GPIOA_MODER_MODER_Values</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterField&lt;Reg, offset, size, AccessMode&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Value0 = FieldValue&lt;GPIOA_MODER_MODER_Values, BaseType, <span class="hljs-number"><span class="hljs-number">0U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Value1 = FieldValue&lt;GPIOA_MODER_MODER_Values, BaseType, <span class="hljs-number"><span class="hljs-number">1U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Value2 = FieldValue&lt;GPIOA_MODER_MODER_Values, BaseType, <span class="hljs-number"><span class="hljs-number">2U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Value3 = FieldValue&lt;GPIOA_MODER_MODER_Values, BaseType, <span class="hljs-number"><span class="hljs-number">3U</span></span>&gt; ; } ;</code> </pre> <br>       ,        Value,  -  : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Reg, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> offset, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> AccessMode, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> BaseType&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GPIOA_MODER_MODER_Values</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterField&lt;Reg, offset, size, AccessMode&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Input = FieldValue&lt;GPIOA_MODER_MODER_Values, BaseType, <span class="hljs-number"><span class="hljs-number">0U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Output = FieldValue&lt;GPIOA_MODER_MODER_Values, BaseType, <span class="hljs-number"><span class="hljs-number">1U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Alternate = FieldValue&lt;GPIOA_MODER_MODER_Values, BaseType, <span class="hljs-number"><span class="hljs-number">2U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Analog = FieldValue&lt;GPIOA_MODER_MODER_Values, BaseType, <span class="hljs-number"><span class="hljs-number">3U</span></span>&gt; ; } ;</code> </pre> <br>           . <br><br>  ,  ST         ,      0. <br><br>  ,  ,            enum . <br><br>  ,     . <br><br>   IAR 8.40.1  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> <br>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´ Online GDB¬ª</a> <br><br> PS:  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">putyavka</a>      <code>RegisterField::Get()</code> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">Ryppka</a>     assert. <br><br><h3>       </h3><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Typesafe Register Access in C++</a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">One Approach to Using Hardware Registers in C++</a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SVD Description (*.svd) Format</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr459642/">https://habr.com/ru/post/fr459642/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr459626/index.html">Windows Notification Facility: la surface d'attaque la plus non document√©e</a></li>
<li><a href="../fr459628/index.html">L'Open Invention Network compte plus de trois mille licenci√©s - qu'est-ce que cela signifie pour les logiciels open source</a></li>
<li><a href="../fr459630/index.html">Tic Tac Toe Partie 2: Annuler / R√©tablir sans √©tat</a></li>
<li><a href="../fr459638/index.html">Cr√©ation d'une base de connaissances mondiale sur les batteries</a></li>
<li><a href="../fr459640/index.html">Documents en tant que code. Partie 1: automatiser la mise √† jour</a></li>
<li><a href="../fr459644/index.html">Gradateurs LED</a></li>
<li><a href="../fr459648/index.html">Tout devrait bien se passer dans l'analyseur: √† la fois fonctionnalit√© et interface ... Nous explorons la nouvelle interface Solar appScreener 3.1</a></li>
<li><a href="../fr459650/index.html">Comment ne pas perdre d'argent dans la bo√Æte noire: m√©thodes de test de facturation</a></li>
<li><a href="../fr459652/index.html">Approche de test de r√©gression automatis√©e</a></li>
<li><a href="../fr459656/index.html">Service OData sans √©crire de code</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>