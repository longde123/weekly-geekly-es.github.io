<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚁 🧑🏽 👩🏾‍🏫 Accès sécurisé aux champs d'enregistrement en C ++ sans sacrifier l'efficacité (en utilisant CortexM comme exemple) 💯 🐙 👨🏾‍🔧</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Fig. extrait de www.extremetech.com/wp-content/uploads/2016/07/MegaProcessor-Feature.jpg 

 Bonne santé à tous! 

 Dans un article précédent, j'ai exa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Accès sécurisé aux champs d'enregistrement en C ++ sans sacrifier l'efficacité (en utilisant CortexM comme exemple)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459642/"><img src="https://habrastorage.org/webt/et/ni/fl/etnifl3hcinjjsqt8skfvv6km5q.png" alt="image"><br>  <sub>Fig.</sub>  <sub>extrait de <a href="">www.extremetech.com/wp-content/uploads/2016/07/MegaProcessor-Feature.jpg</a></sub> <br><br>  Bonne santé à tous! <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Dans un article précédent,</a> j'ai examiné la question de l'accès aux registres d'un microcontrôleur avec un noyau CortexM en C ++ et j'ai montré des solutions simples à certains des problèmes. <br><br>  Aujourd'hui, je veux montrer comment sécuriser l'accès au registre et à ses champs sans sacrifier l'efficacité, en utilisant des classes C ++ générées à partir de fichiers SVD. <br><br>  Tous ceux qui vous intéressent, bienvenue au chat.  Il y aura beaucoup de code. <br><a name="habracut"></a><br><h3>  Présentation </h3><br>  Dans un article <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">C ++ Hardware Register Access Redux</a> , Ken Smith a montré comment travailler en toute sécurité et efficacement avec les registres, et l'a même montré avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/kensmith/cppmmio</a> comme exemple. <br>  Ensuite, plusieurs personnes ont développé cette idée, par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Niklas Hauser a fait un excellent examen</a> et a suggéré plusieurs autres façons d'accéder en toute sécurité aux registres. <br><br>  Certaines de ces idées ont déjà été mises en œuvre dans diverses bibliothèques, en particulier dans <a href="">modm</a> .  Pour de bon, vous pouvez utiliser toutes ces phrases dans la vraie vie.  Mais au moment du développement de ces bibliothèques, les descriptions des périphériques et des registres venaient juste de commencer à être standardisées, et donc certaines choses ont été faites dans le but que le travail principal sur la description des registres soit confié au programmeur.  De plus, certaines solutions ne sont pas efficaces en termes de ressources de code et de microcontrôleur. <br><br>  Aujourd'hui, chaque fabricant d'un microcontrôleur ARM fournit une description de tous les registres au format SVD.  Des fichiers d'en-tête peuvent être générés à partir de ces descriptions; par conséquent, il est possible de créer non pas une simple description des registres, mais une description plus complexe, mais en même temps, ce qui augmentera la fiabilité de votre code.  Et c'est génial que le fichier de sortie puisse être dans n'importe quel langage, C, C ++, ou même <a href="">D</a> <br><br>  Mais prenons-le dans l'ordre ce qui est généralement un accès sûr aux registres, et pourquoi est-il nécessaire du tout.  L'explication peut être montrée sur des exemples synthétiques simples, très probablement peu probables, mais tout à fait possibles: <br><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      GPIOA //,    AHB1ENR RCC-&gt;APB1ENR |= RCC_AHB1ENR_GPIOAEN ; //    ,      RCC-&gt;AHB1ENR = RCC_AHB1ENR_GPIOAEN; //,  TIM1    APB2 RCC-&gt;APB1ENR |= RCC_APB1ENR_TIM2EN | RCC_APB2ENR_TIM1EN; // - ,        . auto result = GPIOA-&gt;BSRR ; if (result &amp; GPIO_BSRR_BS1) { //do something } //-     .   ... GPIOA-&gt;IDR = GPIO_IDR_ID5 ; }</span></span></code> </pre> <br>  Tous ces cas sont possibles dans la pratique, et j'ai certainement regardé quelque chose comme ça de mes élèves.  Ce serait formidable si vous pouviez interdire de faire de telles erreurs. <br><br>  Il me semble aussi que c'est beaucoup plus agréable quand le code a l'air soigné et n'a pas besoin de commentaires.  Par exemple, même si vous connaissez bien le microcontrôleur STM32F411, il n'est pas toujours possible de comprendre ce qui se passe dans ce code: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ uint32 temp = GPIOA-&gt;OSPEEDR ; temp &amp;=~ GPIO_OSPEEDR_OSPEED0_Msk ; temp = (GPIO_OSPEEDR_OSPEED0_0 | GPIO_OSPEEDR_OSPEED0_1) ; GPIOA-&gt;OSPEEDR = temp; }</code> </pre><br>  Aucun commentaire ici ne peut faire.  Le code définit la fréquence de fonctionnement du port GPIOA.0 au maximum (clarification de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">mctMaks</a> : en fait, ce paramètre affecte le temps de montée du front (c'est-à-dire sa pente) et signifie que le port peut traiter un signal numérique normalement à un signal donné (VeryLow \ Low \ Medium \ Haute) fréquence). <br><br>  Essayons de nous débarrasser de ces lacunes. <br><br><h3>  Enregistrer l'abstraction </h3><br>  Tout d'abord, vous devez comprendre ce qu'est le registre du point de vue du programmeur et du programme. <br><br>  Le registre a une adresse, une longueur ou une taille, un mode d'accès: certains registres peuvent être écrits, certains ne peuvent être lus et la plupart peuvent être lus et écrits. <br><br>  De plus, le registre peut être représenté comme un ensemble de champs.  Un champ peut être composé d'un bit ou de plusieurs bits et se trouve n'importe où dans le registre. <br><br>  Par conséquent, les caractéristiques de champ suivantes sont importantes pour nous: longueur ou taille ( <b>largeur</b> ou <b>taille</b> ), décalage par rapport au début du registre ( <b>décalage</b> ) et valeur. <br><br>  Les valeurs de champ sont l'espace de toutes les quantités possibles que le champ peut prendre et cela dépend de la longueur du champ.  C'est-à-dire  si le champ a une longueur de 2, alors il y a 4 valeurs de champ possibles (0,1,2,3).  Comme le registre, les champs et les valeurs de champ ont un mode d'accès (lecture, écriture, lecture et écriture) <br><br>  Pour le rendre plus clair, prenons le registre TIM1 CR1 du microcontrôleur STM32F411.  Schématiquement, cela ressemble à ceci: <br><br><img src="https://habrastorage.org/webt/sr/da/i4/srdai4a4hmphkmhrulcvdcx9r3u.png" alt="image"><br><br><ul><li>  Bit 0 CEN: Activer le compteur <br>  0: compteur activé: <b>désactivé</b> <br>  1: compteur désactivé: <b>activé</b> <br></li><li>  Bit UDIS 1: activer / désactiver l'événement UEV <br>  0: événement UEV activé: activé <br>  1: événement UEV désactivé: <b>désactivé</b> <br></li><li>  URS Bit 2: Sélectionner les sources de génération d'événements UEV <br>  0: UEV est généré lors d'un débordement ou lors de la définition de l'UG: <b>n'importe quel</b> bit <br>  1: UEV est généré uniquement en cas de débordement: <b>débordement</b> <br></li><li>  Bit 3 OPM: opération unique <br>  0: le temporisateur continue de compter davantage après l'événement UEV: <b>ContinueAfterUEV</b> <br>  1: Le temporisateur s'arrête après l' <b>événement</b> UEV: <b>StopAfterUEV</b> <br></li><li>  Bit 4 DIR: Direction du comptage <br>  0: Compte direct: <b>Upcounter</b> <br>  1: <b>Compte à rebours</b> : <b>Downcounter</b> <br></li><li>  Bit 6: 5 CMS: Mode d'alignement <br>  0: Mode d'alignement 0: <b>CenterAlignedMode0</b> <br>  1: Mode d'alignement 1: <b>CenterAlignedMode1</b> <br>  2: Mode d'alignement 2: <b>CenterAlignedMode2</b> <br>  3: Mode d'alignement 3: <b>CenterAlignedMode3</b> <br></li><li>  Bit 7 APRE: mode de préchargement pour le registre ARR <br>  0: le registre TIMx_ARR n'est pas mis en mémoire tampon: <b>ARRNotBuffered</b> <br>  1: le registre TIMx_ARR n'est pas mis en mémoire tampon: <b>ARRBuffered</b> <br></li><li>  Bit 8: 9 CKD: diviseur d'horloge <br>  0: tDTS = tCK_INT: <b>ClockDevidedBy1</b> <br>  1: tDTS = 2 * tCK_INT: <b>ClockDevidedBy2</b> <br>  2: tDTS = 4 * tCK_INT: <b>ClockDevidedBy4</b> <br>  3: Réservé: <b>Réservé</b> <br></li></ul><br>  Ici, par exemple, CEN est un champ de 1 bit avec un décalage de 0 par rapport au début du registre.  Et <b>Enable</b> (1) et <b>Disable</b> (0) sont ses valeurs possibles. <br><br>  Nous ne nous concentrerons pas sur ce dont chaque champ de ce registre est spécifiquement responsable, il est important pour nous que chaque champ et valeur de champ ait un nom qui ait une signification sémantique et à partir duquel il peut en principe être compris ce qu'il fait. <br><br>  Nous devons avoir accès à la fois au registre et au champ et à sa valeur.  Par conséquent, sous une forme très approximative, l'abstraction des registres peut être représentée par les classes suivantes: <br><br><img src="https://habrastorage.org/webt/pi/kr/-s/pikr-sq7lnpo9c6uilrmghdzd5a.png" alt="image"><br><br>  En plus des classes, il est également important pour nous que les registres et les champs individuels aient certaines propriétés, le registre a une adresse, une taille, un mode d'accès (lecture seule, écriture seule ou les deux). <br>  Le champ a une taille, un décalage et également un mode d'accès.  De plus, le champ doit contenir un lien vers le registre auquel il appartient. <br><br>  La valeur du champ doit avoir un lien vers le champ et un attribut supplémentaire - la valeur. <br><br>  Par conséquent, dans une version plus détaillée, notre abstraction ressemblera à ceci: <br><br><img src="https://habrastorage.org/webt/m4/3u/mb/m43umbc8vceiuila8_komovib38.png"><br><br>  En plus des attributs, notre abstraction devrait avoir des méthodes de modification et d'accès.  Par souci de simplicité, nous nous limitons aux méthodes d'installation / écriture et de lecture. <br><br><img src="https://habrastorage.org/webt/uy/d7/sb/uyd7sb-z-tggllnj4knjf_rfhi4.png" alt="image"><br><br>  Lorsque nous avons décidé de l'abstraction des cas, nous devons vérifier comment cette abstraction correspond à ce qui est décrit dans le fichier SVD. <br><br><h3>  Fichier SVD (System View Description) </h3><br>  Le format de description de présentation du système CMSIS (CMSIS-SVD) est une description formelle des registres de microcontrôleur basée sur le processeur ARM Cortex-M.  Les informations contenues dans les descriptions de la représentation du système correspondent pratiquement aux données des manuels de référence des appareils.  La description des registres dans un tel fichier peut contenir à la fois des informations de haut niveau et la fonction d'un seul bit du champ dans le registre. <br><br>  Schématiquement, les niveaux de détail des informations dans un tel fichier peuvent être décrits par le schéma suivant, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pris sur le site Web de Keil</a> : <br><br><img src="https://habrastorage.org/webt/1s/oq/6d/1soq6disxizzaj8hvyaovxs9_pm.png" alt="image"><br><br>  Description Les fichiers SVD sont fournis par les fabricants et sont utilisés pendant le débogage pour afficher des informations sur le microcontrôleur et les registres.  Par exemple, l'IAR les utilise pour afficher des informations dans le panneau Affichage-&gt; Registres.  Les fichiers eux-mêmes se trouvent dans le dossier Program Files (x86) \ IAR Systems \ Embedded Workbench 8.3 \ arm \ config \ debugger. <br><br>  Clion de JetBrains utilise également des fichiers svd pour afficher les informations de registre pendant le débogage. <br><br>  Vous pouvez toujours télécharger les descriptions sur les sites du fabricant.  <a href="">Ici, vous pouvez prendre le fichier SVD pour le microcontrôleur STM32F411</a> <br><br>  En général, le format SVD est une norme prise en charge par les fabricants.  Voyons quels sont les niveaux de description dans SVD. <br><br>  Au total, 5 niveaux sont distingués: niveau de l'appareil, niveau du microcontrôleur, niveau du registre, niveau du champ, niveau des valeurs énumérées. <br><br><ul><li>  <b>Niveau de l'appareil</b> : la description de niveau supérieur de la vue système est l'appareil.  À ce niveau, les propriétés liées à l'appareil dans son ensemble sont décrites.  Par exemple, un nom, une description ou une version de périphérique.  L'unité adressable minimale, ainsi que la profondeur de bits du bus de données.  Les valeurs par défaut des attributs de registre, telles que la taille du registre, la valeur de réinitialisation et les autorisations d'accès, peuvent être définies pour l'ensemble du périphérique à ce niveau et sont implicitement héritées par des niveaux de description inférieurs. </li><li>  <b>Niveau du microcontrôleur: la</b> section CPU décrit le cœur du microcontrôleur et ses fonctionnalités.  Cette section est obligatoire si le fichier SVD est utilisé pour créer le fichier d'en-tête de périphérique. </li><li>  <b>Couche périphérique</b> : un périphérique est une collection nommée de registres.  Un périphérique est mappé à une adresse de base spécifique dans l'espace d'adressage du périphérique. </li><li>  <b>Niveau de registre</b> : un registre est une ressource programmable nommée qui appartient à un périphérique.  Les registres sont mappés à une adresse spécifique dans l'espace d'adressage du périphérique.  L'adresse est relative à l'adresse périphérique de base.  De plus, pour le registre, le mode d'accès (lecture / écriture) est indiqué. </li><li>  <b>Niveau de champ</b> : comme mentionné ci-dessus, les registres peuvent être divisés en morceaux de bits de différentes fonctionnalités - champs.  Ce niveau contient les noms des champs uniques dans le même registre, leur taille, les décalages par rapport au début du registre, ainsi que le mode d'accès. </li><li>  <b>Le niveau des valeurs de champ énumérées</b> : en fait, ce sont des valeurs de champ nommées qui peuvent être utilisées par commodité en C, C ++, D, etc. </li></ul><br>  En fait, les fichiers SVD sont des fichiers xml ordinaires avec une description complète du système.  Il existe des convertisseurs de fichiers svd en code C, par exemple <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> , qui génèrent des en-têtes et des structures compatibles C pour chaque périphérie et registre. <br><br>  Il existe également un analyseur de fichier SVD <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cmsis-svd</a> écrit en Phyton qui fait quelque chose comme la désérialisation des données d'un fichier en objets de classe Phython, qui sont ensuite facilement utilisés dans votre programme de génération de code. <br><br>  Un exemple de la description du registre du microcontrôleur STM32F411 peut être visualisé sous le spoiler: <br><br><div class="spoiler">  <b class="spoiler_title">Exemple de registre CR1 timer TIM1</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">peripheral</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>TIM1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span>Advanced-timers<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupName</span></span></span><span class="hljs-tag">&gt;</span></span>TIM<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupName</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">baseAddress</span></span></span><span class="hljs-tag">&gt;</span></span>0x40010000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">baseAddress</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">addressBlock</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">offset</span></span></span><span class="hljs-tag">&gt;</span></span>0x0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">offset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">size</span></span></span><span class="hljs-tag">&gt;</span></span>0x400<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">size</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">usage</span></span></span><span class="hljs-tag">&gt;</span></span>registers<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">usage</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">addressBlock</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">registers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">register</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>CR1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">displayName</span></span></span><span class="hljs-tag">&gt;</span></span>CR1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">displayName</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span>control register 1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">addressOffset</span></span></span><span class="hljs-tag">&gt;</span></span>0x0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">addressOffset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">size</span></span></span><span class="hljs-tag">&gt;</span></span>0x20<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">size</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">access</span></span></span><span class="hljs-tag">&gt;</span></span>read-write<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">access</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">resetValue</span></span></span><span class="hljs-tag">&gt;</span></span>0x0000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">resetValue</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fields</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>CKD<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span>Clock division<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span>8<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span>2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>ARPE<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span>Auto-reload preload enable<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span>7<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>CMS<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span>Center-aligned mode selection<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span>5<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span>2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>DIR<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span>Direction<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span>4<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>OPM<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span>One-pulse mode<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span>3<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>URS<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span>Update request source<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span>2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>UDIS<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span>Update disable<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>CEN<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span>Counter enable<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span>0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitOffset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bitWidth</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fields</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">register</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">register</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>  Comme vous pouvez le voir, il y a toutes les informations nécessaires à notre abstraction, à l'exception de la description des valeurs de bits spécifiques des champs. <br><br>  Tous les fabricants ne veulent pas passer du temps sur une description complète de leur système, donc comme vous pouvez le voir, ST n'a pas voulu décrire les valeurs des champs et a transféré cette charge aux programmeurs clients.  Mais TI prend soin de ses clients et décrit complètement le système, y compris les descriptions des valeurs de champ. <br><br>  Ce qui précède montre que le format de la description SVD est très cohérent avec notre abstraction de cas.  Le fichier contient toutes les informations nécessaires pour décrire pleinement le registre. <br><br><h3>  Implémentation </h3><br><h4>  S'inscrire </h4><br>  Maintenant que nous avons fait une abstraction du registre et que nous avons une description des registres sous forme de svd de fabricants qui convient parfaitement à cette abstraction, nous pouvons passer directement à l'implémentation. <br><br>  Notre implémentation doit être aussi efficace que le code C et conviviale.  J'aimerais que l'accès aux registres soit aussi clair que possible, par exemple, comme ceci: <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TIM1::CR1::CKD::DividedBy2::IsSet()) { TIM1::ARR::Set(<span class="hljs-number"><span class="hljs-number">10</span></span>_ms) ; TIM1::CR1::CEN::Enable::Set() ; }</code> </pre><br>  Rappelez-vous que pour accéder à l'adresse du registre entier, vous devez utiliser reinterpret_cast: <br><br><pre> <code class="cpp hljs">*<span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> *&gt;(<span class="hljs-number"><span class="hljs-number">0x40010000</span></span>) = (<span class="hljs-number"><span class="hljs-number">1U</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">5U</span></span>) ;</code> </pre> <br>  La classe de registre a déjà été décrite ci-dessus, elle doit avoir une adresse, une taille et un mode d'accès, ainsi que deux méthodes <code>Get()</code> et <code>Set()</code> : <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//      template&lt;uint32_t address, size_t size, typename AccessMode&gt; struct RegisterBase { static constexpr auto Addr = address ; using Type = typename RegisterType&lt;size&gt;::Type ; // Set     , //     __forceinline template&lt;typename T = AccessMode, class = typename std::enable_if_t&lt;std::is_base_of&lt;WriteMode, T&gt;::value&gt;&gt; inline static void Set(Type value) { *reinterpret_cast&lt;volatile Type *&gt;(address) = value ; } // Get    , //    ,    __forceinline template&lt;typename T = AccessMode, class = typename std::enable_if_t&lt;std::is_base_of&lt;ReadMode, T&gt;::value&gt;&gt; inline static Type Get() { return *reinterpret_cast&lt;volatile Type *&gt;(address) ; } } ;</span></span></code> </pre> <br>  Nous passons l'adresse, la longueur du registre et le mode d'accès aux paramètres du modèle (c'est aussi une classe).  En utilisant le mécanisme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SFINAE</a> , à savoir la <code>enable_if</code> enable_if, nous allons «jeter» les fonctions d'accès <code>Set()</code> ou <code>Get()</code> pour les registres qui ne devraient pas les prendre en charge.  Par exemple, si le registre est en lecture seule, nous <code>ReadMode</code> type <code>ReadMode</code> au paramètre de modèle, <code>enable_if</code> vérifiera si l'accès est le successeur de <code>ReadMode</code> et sinon, il créera une erreur contrôlée (le type T ne peut pas être affiché), et le compilateur n'inclura pas la méthode <code>Set()</code> pour un tel registre.  Il en va de même pour un registre destiné à l'écriture uniquement. <br><br>  Pour le contrôle d'accès, nous utiliserons les classes: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//    struct WriteMode {}; struct ReadMode {}; struct ReadWriteMode: public WriteMode, public ReadMode {};</span></span></code> </pre> <br>  Les registres sont disponibles en différentes tailles: 8, 16, 32, 64 bits. Pour chacun d'eux, nous définissons notre type: <br><br><div class="spoiler">  <b class="spoiler_title">Type de registres selon la taille</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> size&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegisterType</span></span></span><span class="hljs-class"> {</span></span>} ; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegisterType</span></span></span><span class="hljs-class">&lt;8&gt; {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Type = <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> ; } ; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegisterType</span></span></span><span class="hljs-class">&lt;16&gt; {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Type = <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> ; } ; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegisterType</span></span></span><span class="hljs-class">&lt;32&gt; {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Type = <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ; } ; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegisterType</span></span></span><span class="hljs-class">&lt;64&gt; {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Type = <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> ; } ;</code> </pre> <br></div></div><br>  Après cela, pour le temporisateur TIM1, vous pouvez définir le registre CR1 et, par exemple, le registre EGR de cette manière: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TIM1</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CR1</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterBase&lt;<span class="hljs-number"><span class="hljs-number">0x40010000</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>, ReadWriteMode&gt; { } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EGR</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterBase&lt;<span class="hljs-number"><span class="hljs-number">0x40010014</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>, WriteMode&gt; { } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ TIM1::CR1::Set(<span class="hljs-number"><span class="hljs-number">10</span></span>) ; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> reg = TIM1::CR1::Get() ; <span class="hljs-comment"><span class="hljs-comment">// ,     reg = TIM1::EGR::Get() }</span></span></code> </pre><br>  Étant donné que le compilateur affiche la méthode <code>Get()</code> uniquement pour les registres dans lesquels le mode d'accès est hérité de <code>ReadMode</code> , et les méthodes <code>Set()</code> pour les registres dans lesquels le mode d'accès est hérité de <code>WriteMode</code> , en cas d'utilisation incorrecte des méthodes d'accès, vous recevrez une erreur au stade de la compilation.  Et si vous utilisez des outils de développement modernes, tels que Clion, même au stade du codage, vous verrez un avertissement de l'analyseur de code: <br><br><img src="https://habrastorage.org/webt/vc/we/gu/vcwegu6a0vulgfcvzjkaum9ac4a.png" alt="image"><br><br>  Eh bien, l'accès aux registres est devenu plus sûr, notre code ne vous permet pas de faire des choses inacceptables pour ce registre, mais nous voulons aller plus loin et nous référer non pas à l'ensemble du registre, mais à ses champs. <br><br><h4>  Champs </h4><br>  Le champ au lieu de l'adresse a une valeur de décalage par rapport au début du registre.  De plus, pour connaître l'adresse ou le type auquel la valeur du champ doit être portée, il doit avoir un lien vers le registre: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//        template&lt;typename Reg, size_t offset, size_t size, typename AccessMode&gt; struct RegisterField { using RegType = typename Reg::Type ; using Register = Reg ; static constexpr RegType Offset = offset ; static constexpr RegType Size = size ; using Access = AccessMode ; template&lt;typename T = AccessMode, class = typename std::enable_if_t&lt;std::is_base_of&lt;WriteMode, T&gt;::value&gt;&gt; static void Set(RegType value) { assert(value &lt; (1U &lt;&lt; size)) ; //CriticalSection cs ; //    RegType newRegValue = *reinterpret_cast&lt;RegType *&gt;(Register::Address) ; //       newRegValue &amp;= ~ (((1U &lt;&lt; size) - 1U) &lt;&lt; offset); //    newRegValue |= (value &lt;&lt; offset) ; //      *reinterpret_cast&lt;RegType *&gt;(Reg::Address) = newRegValue ; } __forceinline template&lt;typename T = AccessMode, class = typename std::enable_if_t&lt;std::is_base_of&lt;ReadMode, T&gt;::value&gt;&gt; inline static RegType Get() { return ((*reinterpret_cast&lt;RegType *&gt;(Reg::Address)) &amp; (((1U &lt;&lt; size) - 1U) &lt;&lt; offset)) &gt;&gt; offset ; } };</span></span></code> </pre> <br>  Après cela, il est déjà possible de faire les choses suivantes: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TIM1</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CR1</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterBase&lt;<span class="hljs-number"><span class="hljs-number">0x40010000</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>, ReadWriteMode&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> CKD = RegisterField&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, ReadWriteMode&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> ARPE = RegisterField&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> CMS = RegisterField&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, ReadWriteMode&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> DIR = RegisterField&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> OPM = RegisterField&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> URS = RegisterField&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UDIS = RegisterField&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> CEN = RegisterField&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode&gt; ; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   CR1  9   1,  8  0 TIM1::CR1::CKD::Set(2U) ; auto reg = TIM1::CR1::CEN::Get() ; }</span></span></code> </pre><br>  Bien que tout semble plutôt bien dans l’ensemble, la signification de <code>TIM1::CR1::CKD::Set(2)</code> n’est toujours pas claire, que signifie la magie passée à la fonction <code>Set()</code> ?  Et que signifie le nombre renvoyé par la <code>TIM1::CR1::CEN::Get()</code> ? <br><br>  Passez en toute transparence aux valeurs de champ. <br><br><h4>  Valeur du champ </h4><br>  L'abstraction d'une valeur de champ est essentiellement aussi un champ, mais capable d'accepter un seul état.  Des attributs sont ajoutés à l'abstraction du champ - la valeur réelle et un lien vers le champ.  La méthode <code>Set()</code> de définition de la valeur du champ est identique à la méthode <code>Set()</code> de définition du champ, sauf que la valeur elle-même n'a pas besoin d'être transmise à la méthode, elle est connue à l'avance, elle doit simplement être définie.  Mais la méthode <code>Get()</code> n'a aucun sens; à la place, il est préférable de vérifier si cette valeur est définie ou non, remplacez cette méthode par la méthode <code>IsSet()</code> . <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//        template&lt;typename Field, typename Field::Register::Type value&gt; struct FieldValueBase { using RegType = typename Field::Register::Type ; template&lt;typename T = typename Field::Access, class = typename std::enable_if_t&lt;std::is_base_of&lt;WriteMode, T&gt;::value&gt;&gt; static void Set() { RegType newRegValue = *reinterpret_cast&lt;RegType *&gt;(Field::Register::Address) ; newRegValue &amp;= ~ (((1U &lt;&lt; Field::Size) - 1U) &lt;&lt; Field::Offset); newRegValue |= (value &lt;&lt; Field::Offset) ; *reinterpret_cast&lt;RegType *&gt;(Field::Register::Address) = newRegValue ; } __forceinline template&lt;typename T = typename Field::Access, class = typename std::enable_if_t&lt;std::is_base_of&lt;ReadMode, T&gt;::value&gt;&gt; inline static bool IsSet() { return ((*reinterpret_cast&lt;RegType *&gt;(Field::Register::Address)) &amp; static_cast&lt;RegType&gt;(((1U &lt;&lt; Field::Size) - 1U) &lt;&lt; Field::Offset)) == (value &lt;&lt; Field::Offset) ; } };</span></span></code> </pre> <br>  Le champ de registre peut maintenant être décrit par un ensemble de ses valeurs: <br><br><div class="spoiler">  <b class="spoiler_title">Valeurs des champs de registre CR1 du temporisateur TIM1</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Reg, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> offset, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> AccessMode&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TIM_CR_CKD_Values</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterField&lt;Reg, offset, size, AccessMode&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> DividedBy1 = FieldValue&lt;TIM_CR_CKD_Values, <span class="hljs-number"><span class="hljs-number">0U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> DividedBy2 = FieldValue&lt;TIM_CR_CKD_Values, <span class="hljs-number"><span class="hljs-number">1U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> DividedBy4 = FieldValue&lt;TIM_CR_CKD_Values, <span class="hljs-number"><span class="hljs-number">2U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Reserved = FieldValue&lt;TIM_CR_CKD_Values, <span class="hljs-number"><span class="hljs-number">3U</span></span>&gt; ; } ; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Reg, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> offset, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> AccessMode&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TIM_CR_ARPE_Values</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterField&lt;Reg, offset, size, AccessMode&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> ARRNotBuffered = FieldValue&lt;TIM_CR_ARPE_Values, <span class="hljs-number"><span class="hljs-number">0U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> ARRBuffered = FieldValue&lt;TIM_CR_ARPE_Values, <span class="hljs-number"><span class="hljs-number">1U</span></span>&gt; ; } ; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Reg, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> offset, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> AccessMode&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TIM_CR_CMS_Values</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterField&lt;Reg, offset, size, AccessMode&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> CenterAlignedMode0 = FieldValue&lt;TIM_CR_CMS_Values, <span class="hljs-number"><span class="hljs-number">0U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> CenterAlignedMode1 = FieldValue&lt;TIM_CR_CMS_Values, <span class="hljs-number"><span class="hljs-number">1U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> CenterAlignedMode2 = FieldValue&lt;TIM_CR_CMS_Values, <span class="hljs-number"><span class="hljs-number">2U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> CenterAlignedMode3 = FieldValue&lt;TIM_CR_CMS_Values, <span class="hljs-number"><span class="hljs-number">3U</span></span>&gt; ; } ; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Reg, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> offset, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> AccessMode&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TIM_CR_DIR_Values</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterField&lt;Reg, offset, size, AccessMode&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Upcounter = FieldValue&lt;TIM_CR_DIR_Values, <span class="hljs-number"><span class="hljs-number">0U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Downcounter = FieldValue&lt;TIM_CR_DIR_Values, <span class="hljs-number"><span class="hljs-number">1U</span></span>&gt; ; } ; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Reg, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> offset, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> AccessMode&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TIM_CR_OPM_Values</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterField&lt;Reg, offset, size, AccessMode&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> ContinueAfterUEV = FieldValue&lt;TIM_CR_OPM_Values, <span class="hljs-number"><span class="hljs-number">0U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> StopAfterUEV = FieldValue&lt;TIM_CR_OPM_Values, <span class="hljs-number"><span class="hljs-number">1U</span></span>&gt; ; } ; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Reg, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> offset, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> AccessMode&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TIM_CR_URS_Values</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterField&lt;Reg, offset, size, AccessMode&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Any = FieldValue&lt;TIM_CR_URS_Values, <span class="hljs-number"><span class="hljs-number">0U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Overflow = FieldValue&lt;TIM_CR_URS_Values, <span class="hljs-number"><span class="hljs-number">1U</span></span>&gt; ; } ; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Reg, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> offset, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> AccessMode&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TIM_CR_UDIS_Values</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterField&lt;Reg, offset, size, AccessMode&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Enable = FieldValue&lt;TIM_CR_UDIS_Values, <span class="hljs-number"><span class="hljs-number">0U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Disable = FieldValue&lt;TIM_CR_UDIS_Values, <span class="hljs-number"><span class="hljs-number">1U</span></span>&gt; ; } ; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Reg, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> offset, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> AccessMode&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TIM_CR_CEN_Values</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterField&lt;Reg, offset, size, AccessMode&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Disable = FieldValue&lt;TIM_CR_CEN_Values, <span class="hljs-number"><span class="hljs-number">0U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Enable = FieldValue&lt;TIM_CR_CEN_Values, <span class="hljs-number"><span class="hljs-number">1U</span></span>&gt; ; } ;</code> </pre><br></div></div><br>  Le registre CR1 lui-même sera alors déjà décrit comme suit: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TIM1</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CR1</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterBase&lt;<span class="hljs-number"><span class="hljs-number">0x40010000</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>, ReadWriteMode&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> CKD = TIM_CR1_CKD_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, ReadWriteMode&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> ARPE = TIM_CR1_ARPE_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> CMS = TIM_CR1_CMS_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, ReadWriteMode&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> DIR = TIM_CR1_DIR_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> OPM = TIM_CR1_OPM_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> URS = TIM_CR1_URS_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UDIS = TIM_CR1_UDIS_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> CEN = TIM_CR1_CEN_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode&gt; ; } ; }</code> </pre><br>  Vous pouvez maintenant définir et lire directement la valeur du champ de registre: Par exemple, si vous souhaitez activer le temporisateur sur le compte, il suffit d'appeler la méthode <code>Set()</code> sur la valeur <code>Enable</code> du champ CEN du registre CR1 du timer TIM1: <code>TIM1::CR1::CEN::Enable::Set() ;</code>  .  Dans le code, cela ressemblera à ceci: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TIM1::CR1::CKD::DividedBy2::IsSet()) { TIM1::ARR::Set(<span class="hljs-number"><span class="hljs-number">100U</span></span>) ; TIM1::CR1::CEN::Enable::Set() ; } }</code> </pre><br><div class="spoiler">  <b class="spoiler_title">À titre de comparaison, la même chose en utilisant l'en-tête C:</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((TIM1-&gt;CR1 &amp; TIM_CR1_CKD_Msk) == TIM_CR1_CKD_0) { TIM1-&gt;ARR = <span class="hljs-number"><span class="hljs-number">100U</span></span> ; regValue = TIM1-&gt;CR1 ; regValue &amp;=~(TIM_CR1_CEN_Msk) ; regValue |= TIM_CR1_CEN ; TIM1-&gt;CR1 = regValue ; } }</code> </pre><br></div></div><br>  Ainsi, les principales améliorations sont apportées, nous pouvons avoir un accès simple et compréhensible au registre, à ses champs et à ses valeurs.     ,   ,        ,      ,     . <br><br>      ,        . ,    : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> regValue = TIM1-&gt;CR1 ; regValue &amp;=~(TIM_CR1_CKD_Msk | TIM_CR1_DIR) ; regValue |= (TIM_CR1_CEN | TIM_CR1_CKD_0 | TIM_CR1_CKD_0) ; TIM1-&gt;CR1 = regValue ; }</code> </pre><br>          <code>Set(...)</code>    ,     ,     .  C'est-à-dire     : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// 1,      Set() TIM1::CR1::Set(TIM1::CR1::DIR::Upcounter, TIM1::CR1::CKD::DividedBy4, TIM1::CR1::CEN::Enable) ; // 2,     TIM1::CR1&lt;TIM1::CR1::DIR::Upcounter, TIM1::CR1::CKD::DividedBy4, TIM1::CR1::CEN::Enable&gt;::Set() ; }</span></span></code> </pre><br>                        ,        ,    ,    ,       . <br><br>      .      : <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//    ,          template&lt;uint32_t address, size_t size, typename AccessMode, typename ...Args&gt; class Register { private: ...</span></span></code> </pre><br>  ,        : <br><br><ol><li>       ,      . </li><li>           . </li></ol><br>    constexpr ,        : <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//    ,          template&lt;uint32_t address, size_t size, typename AccessMode, typename ...Args&gt; class Register { private: // ,    //     . __forceinline template&lt;typename T&gt; static constexpr auto GetIndividualMask() { Type result = T::Mask &lt;&lt; T::Offset ; return result ; } // ,    //       . static constexpr auto GetMask() { //       const auto values = {GetIndividualMask&lt;Args&gt;()...} ; Type result = 0UL; for (auto const v: values) { //       result |= v ; } return result ; } //    __forceinline template&lt;typename T&gt; static constexpr auto GetIndividualValue() { Type result = T::Value &lt;&lt; T::Offset ; return result ; } static constexpr auto GetValue() { const auto values = {GetIndividualValue&lt;Args&gt;()...}; Type result = 0UL; for (const auto v: values) { result |= v ; } return result ; } };</span></span></code> </pre><br>      <code>Set()</code>  <code>IsSet()</code> : <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//    ,          template&lt;uint32_t address, size_t size, typename AccessMode, typename ...Args&gt; class Register { public: using Type = typename RegisterType&lt;size&gt;::Type; template&lt;typename T = AccessMode, class = typename std::enable_if_t&lt;std::is_base_of&lt;WriteMode, T&gt;::value&gt;&gt; static void Set() { Type newRegValue = *reinterpret_cast&lt;Type *&gt;(address) ; //GetMask()    ,     newRegValue &amp;= ~GetMask() ; //GetValue()    ,     newRegValue |= GetValue() ; //     *reinterpret_cast&lt;Type *&gt;(address) = newRegValue ; } template&lt;typename T = AccessMode, class = typename std::enable_if_t&lt;std::is_base_of&lt;ReadMode, T&gt;::value&gt;&gt; static bool IsSet() { Type newRegValue = *reinterpret_cast&lt;Type *&gt;(address) ; return ((newRegValue &amp; GetMask()) == GetValue()) ; } private: ...</span></span></code> </pre><br>  ,         : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ,     TIM1::CR1 TIM1::CR1&lt;TIM2::CR1::Enabled, TIM1::CR2::OIS1::OC1OutputIs0&gt;::Set() ; }</span></span></code> </pre> <br> ,   - ,      ,    ,       ,   <code>FieldValueBaseType</code> .      ,          <code>FieldValueBaseType</code> : <br><br><div class="spoiler"> <b class="spoiler_title">       </b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> address, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> AccessMode, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> FieldValueBaseType, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ...Args&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Register</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-comment"><span class="hljs-comment">//     BaseType     FieldValueBaseType,    . __forceinline template&lt;typename T, class = typename std::enable_if_t&lt;std::is_same&lt;FieldValueBaseType, typename T::BaseType&gt;::value&gt;&gt; static constexpr auto GetIndividualMask() { Type result = T::Mask &lt;&lt; T::Offset ; return result ; } static constexpr auto GetMask() { const auto values = {GetIndividualMask&lt;Args&gt;()...} ; Type result = 0UL; for (auto const v: values) { result |= v ; } return result ; } //     BaseType     FieldValueBaseType,    . __forceinline template&lt;typename T, class = typename std::enable_if_t&lt;std::is_same&lt;FieldValueBaseType, typename T::BaseType&gt;::value&gt;&gt; static constexpr auto GetIndividualValue() { Type result = T::Value &lt;&lt; T::Offset ; return result ; } static constexpr auto GetValue() { const auto values = {GetIndividualValue&lt;Args&gt;()...}; Type result = 0UL; for (const auto v: values) { result |= v ; } return result ; } };</span></span></code> </pre><br></div></div><br>     ,  SFINAE         ,       ,  ,    ,  ,      . <br><br>    CR1  TIM1,   : <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TIM1</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TIM1CR1Base</span></span></span><span class="hljs-class"> {</span></span>} ; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CR1</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterBase&lt;<span class="hljs-number"><span class="hljs-number">0x40010000</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>, ReadWriteMode&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> CKD = TIM_CR_CKD_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, ReadWriteMode, TIM1CR1Base&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> ARPE = TIM_CR_ARPE_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode, TIM1CR1Base&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> CMS = TIM_CR_CMS_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, ReadWriteMode, TIM1CR1Base&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> DIR = TIM_CR_DIR_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode, TIM1CR1Base&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> OPM = TIM_CR_OPM_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode, TIM1CR1Base&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> URS = TIM_CR_URS_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode, TIM1CR1Base&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UDIS = TIM_CR_UDIS_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode, TIM1CR1Base&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> CEN = TIM_CR_CEN_Values&lt;TIM1::CR1, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, ReadWriteMode, TIM1CR1Base&gt; ; } ; }</code> </pre> <br> ,          ,        .      ,        ,           ,        . <br><br>        ,     : <br><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     GPIOA //,    AHB1ENR RCC-&gt;APB1ENR |= RCC_AHB1ENR_GPIOAEN ; //    ,      RCC-&gt;AHB1ENR = RCC_AHB1ENR_GPIOAEN; //,  TIM1    APB2 RCC-&gt;APB1ENR |= RCC_APB1ENR_TIM2EN | RCC_APB2ENR_TIM1EN; // - ,        . auto result = GPIOA-&gt;BSRR ; if (result &amp; GPIO_BSRR_BS1) { //do something } //-     .   ... GPIOA-&gt;IDR = GPIO_IDR_ID5 ;</span></span></code> </pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Et essayez de faire de même avec la nouvelle approche: </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     GPIOA // ,   APB1ENR   GPIOAEN RCC::APB1ENR::GPIOAEN::Enable::Set() ; // ,     GPIOA RCC::AHB1ENR::GPIOAEN::Enable::Set() ; // , RCC::APB2ENR::TIM1EN::Enable  //   APB1ENR RCC::APB1ENRPack&lt;RCC::APB1ENR::TIM2EN::Enable, RCC::APB2ENR::TIM1EN::Enable&gt;::Set(); // ,  BSRR    auto result = GPIOA::BSRR::Get() ; // ,  Reset    if (GPIOA::BSRR::BS1::Reset::IsSet()) { //do something } // ,       GPIOA::IDR::IDR5::On::Set() }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans chacun de ces cas, nous obtenons une erreur au stade de la compilation, ce qui est exactement ce que nous avons réalisé. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eh bien, nous avons fourni un bel accès sûr au registre et à ses champs, mais qu'en est-il de la vitesse?</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Performances </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> À titre de comparaison, dans quelle mesure notre approche est optimale, nous utiliserons le code C et C ++ qui alimente l'horloge au port A, définit les trois ports en mode de sortie et définit les ports de sortie dans ces trois ports 1: </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code C:</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> res = RCC-&gt;AHB2ENR; res &amp;=~ RCC_AHB1ENR_GPIOAEN_Msk ; res |= RCC_AHB1ENR_GPIOAEN ; RCC-&gt;AHB2ENR = res ; res = GPIOA-&gt;MODER ; res &amp;=~ (GPIO_MODER_MODER5 | GPIO_MODER_MODER4 | GPIO_MODER_MODER1) ; res |= (GPIO_MODER_MODER5_0 | GPIO_MODER_MODER4_0 | GPIO_MODER_MODER1_0) ; GPIOA-&gt;MODER = res ; GPIOA-&gt;BSRR = (GPIO_BSRR_BS5 | GPIO_BSRR_BS4 | GPIO_BSRR_BS1) ; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ; }</code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code C ++:</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ RCC::AHB1ENR::GPIOAEN::Enable::Set() ; GPIOA::MODERPack&lt; GPIOA::MODER::MODER5::Output, GPIOA::MODER::MODER4::Output, GPIOA::MODER::MODER1::Output&gt;::Set() ; GPIOA::BSRRPack&lt; GPIOA::BSRR::BS5::Set, GPIOA::BSRR::BS4::Set, GPIOA::BSRR::BS1::Set&gt;::Write() ; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ; }</code> </pre><br></div></div><br>    IAR.    :      : <br><br>        : <br><br><img src="https://habrastorage.org/webt/w-/wu/ln/w-wulnrmu5wg5pdby7qzzkxfdl8.png" alt="image"><br><br>   C++     : <br><br><img src="https://habrastorage.org/webt/wz/da/sf/wzdasflo3-fmkqsiq4lbtsbgf6g.png" alt="image"><br><br> 18         ,     ,       . <br><br>    ,   : <br><br><img src="https://habrastorage.org/webt/xm/m2/ac/xmm2actwv_1w6m_hqnbhsccg6xe.png" alt="image"><br><br>      13  . <br><br>    ++   : <br><br><img src="https://habrastorage.org/webt/qa/ic/a-/qaica-alj0danc4ffbmhyc2livs.png" alt="image"><br><br>    :  ,      . <br><br>      ,   .      ,       ? <br><br><h3>     </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons obtenu un accès fiable, pratique et rapide aux registres. </font><font style="vertical-align: inherit;">Une question demeure. </font><font style="vertical-align: inherit;">Comment décrire tous les registres, il y en a aussi moins d'une centaine pour le microcontrôleur. </font><font style="vertical-align: inherit;">C'est le temps qu'il faut pour décrire tous les registres, car vous pouvez faire beaucoup d'erreurs dans un tel travail de routine. </font><font style="vertical-align: inherit;">Oui, vous n'avez pas besoin de le faire manuellement. </font><font style="vertical-align: inherit;">Au lieu de cela, nous utiliserons le générateur de code du fichier SVD, qui, comme je l'ai indiqué ci-dessus au début de l'article, couvre complètement l'abstraction du registre que j'ai acceptée. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'ai finalisé le script d'un collègue qui, basé sur cette idée, a fait à peu près la même chose, mais un peu plus facilement en utilisant enum au lieu de classes pour les valeurs de champ. </font><font style="vertical-align: inherit;">Le script est conçu uniquement pour tester et vérifier des idées, il n'est donc pas optimal, mais il vous permet de générer quelque chose </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comme ça. </font></font></a> <br><img src="https://habrastorage.org/webt/jq/0h/kj/jq0hkj-s5u4jyou1-luv7bhlasy.png" alt="image"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qui se soucie du script est </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a> <br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Résumé </font></font></h3><br>  ,      ,     .      ,   gpioa  rcc,       : <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"gpioaregisters.hpp"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//for GPIOA #include "rccregisters.hpp" //for RCC int main() { RCC::AHB1ENR::GPIOAEN::Enable::Set() ; GPIOA::MODER::MODER15::Output::Set() ; GPIOA::MODERPack&lt; GPIOA::MODER::MODER12::Output, GPIOA::MODER::MODER14::Analog &gt;::Set() ; }</span></span></span></span></code> </pre><br> , SVD      ,     ,        . <br><br> ,     ,       ,       SVD  , -   ST   ,     : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Reg, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> offset, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> AccessMode, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> BaseType&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GPIOA_MODER_MODER_Values</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterField&lt;Reg, offset, size, AccessMode&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Value0 = FieldValue&lt;GPIOA_MODER_MODER_Values, BaseType, <span class="hljs-number"><span class="hljs-number">0U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Value1 = FieldValue&lt;GPIOA_MODER_MODER_Values, BaseType, <span class="hljs-number"><span class="hljs-number">1U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Value2 = FieldValue&lt;GPIOA_MODER_MODER_Values, BaseType, <span class="hljs-number"><span class="hljs-number">2U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Value3 = FieldValue&lt;GPIOA_MODER_MODER_Values, BaseType, <span class="hljs-number"><span class="hljs-number">3U</span></span>&gt; ; } ;</code> </pre> <br>       ,        Value,  -  : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Reg, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> offset, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> AccessMode, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> BaseType&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GPIOA_MODER_MODER_Values</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RegisterField&lt;Reg, offset, size, AccessMode&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Input = FieldValue&lt;GPIOA_MODER_MODER_Values, BaseType, <span class="hljs-number"><span class="hljs-number">0U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Output = FieldValue&lt;GPIOA_MODER_MODER_Values, BaseType, <span class="hljs-number"><span class="hljs-number">1U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Alternate = FieldValue&lt;GPIOA_MODER_MODER_Values, BaseType, <span class="hljs-number"><span class="hljs-number">2U</span></span>&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Analog = FieldValue&lt;GPIOA_MODER_MODER_Values, BaseType, <span class="hljs-number"><span class="hljs-number">3U</span></span>&gt; ; } ;</code> </pre> <br>           . <br><br>  ,  ST         ,      0. <br><br>  ,  ,            enum . <br><br>  ,     . <br><br>   IAR 8.40.1  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> <br>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">« Online GDB»</a> <br><br> PS:  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">putyavka</a>      <code>RegisterField::Get()</code> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">Ryppka</a>     assert. <br><br><h3>       </h3><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Typesafe Register Access in C++</a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">One Approach to Using Hardware Registers in C++</a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SVD Description (*.svd) Format</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr459642/">https://habr.com/ru/post/fr459642/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr459626/index.html">Windows Notification Facility: la surface d'attaque la plus non documentée</a></li>
<li><a href="../fr459628/index.html">L'Open Invention Network compte plus de trois mille licenciés - qu'est-ce que cela signifie pour les logiciels open source</a></li>
<li><a href="../fr459630/index.html">Tic Tac Toe Partie 2: Annuler / Rétablir sans état</a></li>
<li><a href="../fr459638/index.html">Création d'une base de connaissances mondiale sur les batteries</a></li>
<li><a href="../fr459640/index.html">Documents en tant que code. Partie 1: automatiser la mise à jour</a></li>
<li><a href="../fr459644/index.html">Gradateurs LED</a></li>
<li><a href="../fr459648/index.html">Tout devrait bien se passer dans l'analyseur: à la fois fonctionnalité et interface ... Nous explorons la nouvelle interface Solar appScreener 3.1</a></li>
<li><a href="../fr459650/index.html">Comment ne pas perdre d'argent dans la boîte noire: méthodes de test de facturation</a></li>
<li><a href="../fr459652/index.html">Approche de test de régression automatisée</a></li>
<li><a href="../fr459656/index.html">Service OData sans écrire de code</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>