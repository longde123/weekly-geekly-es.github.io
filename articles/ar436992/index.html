<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐ค๏ธ ๐ ๐ฉ๐ฟโ๐ค ุงูุชุฌุฑุจุฉ ูุงูุฎุทุฃ ุฃุซูุงุก ุงุฎุชูุงุฑ ูููู HTTP ุงูุนูุณู ๐ถ๐ฟ ๐๐ฟ ๐๏ธ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ูุฑุญุจุง ุจุงูุฌููุน! 

 ุงูููู ูุฑูุฏ ุฃู ูุชุญุฏุซ ุนู ููููุฉ ุญู ูุฑูู ุฎุฏูุฉ ุญุฌุฒ ุงูููุงุฏู ูู Ostrovok.ru ููุดููุฉ ููู ุงูุฎุฏูุงุช ุงููุตุบุฑุฉ ุ ูุงูุชู ุชุชูุซู ูููุชูุง ูู ุชุจุงุฏู ุงููุนูู...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ุงูุชุฌุฑุจุฉ ูุงูุฎุทุฃ ุฃุซูุงุก ุงุฎุชูุงุฑ ูููู HTTP ุงูุนูุณู</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ostrovok/blog/436992/" style=";text-align:right;direction:rtl">  ูุฑุญุจุง ุจุงูุฌููุน! <br><br>  ุงูููู ูุฑูุฏ ุฃู ูุชุญุฏุซ ุนู ููููุฉ ุญู ูุฑูู ุฎุฏูุฉ ุญุฌุฒ ุงูููุงุฏู ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Ostrovok.ru</a> ููุดููุฉ ููู ุงูุฎุฏูุงุช ุงููุตุบุฑุฉ ุ ูุงูุชู ุชุชูุซู ูููุชูุง ูู ุชุจุงุฏู ุงููุนูููุงุช ูุน ููุฑุฏููุง.  ุญูู ุชุฌุฑุจุชู ูุฑูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" class="user_link">undying</a> ุ DevOps Team Lead ูู Ostrovok.ru. <br><br><div style="text-align:center;;text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/mb/qx/eh/mbqxehqjq4oabybefapvvbpqadg.png"></div><a name="habracut"></a><br>  ูู ุงูุจุฏุงูุฉ ุ ูุงูุช ุงูุฎุฏูุฉ ุงูุตุบูุฑุฉ ุตุบูุฑุฉ ุงูุญุฌู ููุงูุช ุชุคุฏู ุงููุธุงุฆู ุงูุชุงููุฉ: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูุจูู ุทูุจ ูู ุฎุฏูุฉ ูุญููุฉ ุ </li><li style=";text-align:right;direction:rtl">  ุชูุฏูู ุทูุจ ุฅูู ุดุฑูู ุ </li><li style=";text-align:right;direction:rtl">  ุชุทุจูุน ุงูุงุณุชุฌุงุจุฉ ุ </li><li style=";text-align:right;direction:rtl">  ุฅุฑุฌุงุน ุงููุชูุฌุฉ ุฅูู ุฎุฏูุฉ ุงูุงุณุชุนูุงู. </li></ul><br>  ููุน ุฐูู ุ ุจูุฑูุฑ ุงูููุช ุ ููุช ุงูุฎุฏูุฉ ูุน ุนุฏุฏ ุงูุดุฑูุงุก ูุงูุทูุจุงุช ุงูููุฏูุฉ ููู. <br><br>  ูุน ููู ุงูุฎุฏูุฉ ุ ุจุฏุฃุช ุฃููุงุน ูุฎุชููุฉ ูู ุงููุดุงูู ูู ุงูุธููุฑ.  ุทุฑุญ ุงูููุฑุฏูู ุงููุฎุชูููู ููุงุนุฏูู ุงูุฎุงุตุฉ: ูุญุฏ ุดุฎุต ูุง ูู ุงูุญุฏ ุงูุฃูุตู ูุนุฏุฏ ุงูุงุชุตุงูุงุช ุ ููููุฏ ุดุฎุต ูุง ุงูุนููุงุก ุจุงูููุงุฆู ุงูุจูุถุงุก. <br><cut></cut><br>  ูุชูุฌุฉ ูุฐูู ุ ูุงู ุนูููุง ุญู ุงููุดุงูู ุงูุชุงููุฉ: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูู ุงููุณุชุญุณู ุฃู ูููู ูุฏูู ุนุฏุฉ ุนูุงููู IP ุฎุงุฑุฌูุฉ ุซุงุจุชุฉ ุญุชู ุชุชููู ูู ุชูููุฑูุง ููุดุฑูุงุก ูุฅุถุงูุชูุง ุฅูู ุงูููุงุฆู ุงูุจูุถุงุก ุ </li><li style=";text-align:right;direction:rtl">  ูุฏููุง ูุฌููุนุฉ ูุงุญุฏุฉ ูู ุงููุตูุงุช ูุฌููุน ุงูููุฑุฏูู ุจุญูุซ ูุธู ุนุฏุฏ ุงููุตูุงุช ุนูุฏ ุงูุญุฏ ุงูุฃุฏูู ุ </li><li style=";text-align:right;direction:rtl">  ุฅููุงุก SSL ูุงูุญูุงุธ ุนูู <code>keepalive</code> ูู ููุงู ูุงุญุฏ ุ ูุจุงูุชุงูู ุชูููู ุงูุนุจุก ุนูู ุงูุดุฑูุงุก ุฃููุณูู. </li></ul><br>  ูู ูููุฑูุง ููุชุฑุฉ ุทูููุฉ ูุชุณุงุกููุง ุนูู ุงูููุฑ ุนูุง ูุฌุจ ุงุฎุชูุงุฑู: Nginx ุฃู Haproxy. <br>  ูู ุงูุจุฏุงูุฉ ุ ุชุฃุฑุฌุญ ุงูุจูุฏูู ูุญู Nginx ุ ูุธุฑูุง ูุฃููู ุญููุช ูุนุธู ุงููุดููุงุช ุงููุฑุชุจุทุฉ ุจู HTTP / HTTPS ุจูุณุงุนุฏุชูุง ูููุช ุฑุงุถููุง ุฏุงุฆููุง ุนู ุงููุชูุฌุฉ. <br><br>  ูุงู ุงููุฎุทุท ุจุณูุทูุง: ุชู ุชูุฏูู ุทูุจ ุฅูู Proxy Server ุงูุฌุฏูุฏ ุนูู Nginx ูุน ูุฌุงู ูู ุงููููุฐุฌ <code>&lt;partner_tag&gt;.domain.local</code> ุ ูู Nginx ูุงูุช ููุงู <code>map</code> ุญูุซ <code>&lt;partner_tag&gt;</code> ุชูุงุจู ุนููุงู ุงูุดุฑูู.  ุชู ุฃุฎุฐ ุนููุงู ูู <code>map</code> ูุชู ุฅุฌุฑุงุก <code>proxy_pass</code> ุนูู ูุฐุง ุงูุนููุงู. <br><br>  ูููุง ููู ูุซุงู <code>map</code> ูููู ุจุชุญููู ุงููุทุงู ุจูุง ูุชุญุฏูุฏ ุงูููุจุน ูู ุงููุงุฆูุฉ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="nginx hljs"><span class="hljs-comment"><span class="hljs-comment">###     : &lt;tag&gt;.domain.local map $http_host $upstream_prefix { default 0; "~^([^\.]+)\." $1; } ###      map $upstream_prefix $upstream_address { include snippet.d/upstreams_map; default http://127.0.0.1:8080; } ###   upstream_host    upstream_address map $upstream_address $upstream_host { default 0; "~^https?://([^:]+)" $1; }</span></span></code> </pre><br>  ูููุง ูุจุฏู ุดูู " <code>snippet.d/upstreams_map</code> ": <br><pre style=";text-align:right;direction:rtl"> <code class="nginx hljs">โoneโ โhttp://one.domain.netโ; โtwoโ โhttps://two.domain.orgโ;</code> </pre><br>  ููุง ูุฏููุง <code>server{}</code> : <br><br><pre style=";text-align:right;direction:rtl"> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_http_version</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> <span class="hljs-variable"><span class="hljs-variable">$upstream_address</span></span><span class="hljs-variable"><span class="hljs-variable">$request_uri</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$upstream_host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-For <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-Port <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-Proto <span class="hljs-string"><span class="hljs-string">""</span></span>; } } <span class="hljs-comment"><span class="hljs-comment"># service for error handling and logging server { listen 127.0.0.1:8080; location / { return 400; } location /ngx_status/ { stub_status; } }</span></span></code> </pre><br>  ูู ุดูุก ุฑุงุฆุน ุ ูู ุดูุก ูุนูู.  ูู ุงููููู ุฅููุงุก ูุฐู ุงูููุงูุฉ ุ ุฅู ูู ููู ุจูุงุฑู ุจุณูุท. <br><br>  ุนูุฏ ุงุณุชุฎุฏุงู proxy_pass ุ ููุชูู ุงูุทูุจ ูุจุงุดุฑุฉ ุฅูู ุงูุนููุงู ุงููุฑุบูุจ ุ ููุงุนุฏุฉ ุนุงูุฉ ุ ุจุงุณุชุฎุฏุงู ุจุฑูุชูููู HTTP / 1.0 ุฏูู <code>keepalive</code> ููุบูู ููุฑูุง ุจุนุฏ ุงูุชูุงู ุงูุงุณุชุฌุงุจุฉ.  ุญุชู ูู ูููุง <code>proxy_http_version 1.1</code> ุ ููู ูุชุบูุฑ ุฃู ุดูุก ุฏูู ุชุบููุฑ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=https://nginx.org/ru/docs/http/ngx_http_proxy_module.html&amp;usg=ALkJrhgMIDJQwQfE-uZ8dtn_6B4ZbYwfZw#proxy_">ุงููุตุฏุฑ</a> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=https://nginx.org/ru/docs/http/ngx_http_proxy_module.html&amp;usg=ALkJrhgMIDJQwQfE-uZ8dtn_6B4ZbYwfZw#proxy_">proxy_http_version</a> ). <br><br>  ูุง ูุฌุจ ุงูููุงู ุจู  ุงูููุฑ ุงูุฃูู ูู ุฌุนู ุฌููุน ุงูููุฑุฏูู ูู ุงูููุจุน ุ ุญูุซ ุณูููู ุงูุฎุงุฏู ูู ุนููุงู ุงูููุฑุฏ ุงูุฐู ูุญุชุงุฌู ุ ููู <code>map</code> ุงุญุชูุธ <code>"tag" "upstream_name"</code> . <br><br>  ุฃุถู <code>map</code> ุฃุฎุฑู ูุชุญููู ุงููุฎุทุท: <br><br><pre style=";text-align:right;direction:rtl"> <code class="nginx hljs"><span class="hljs-comment"><span class="hljs-comment">###     : &lt;tag&gt;.domain.local map $http_host $upstream_prefix { default 0; "~^([^\.]+)\." $1; } ###      map $upstream_prefix $upstream_address { include snippet.d/upstreams_map; default http://127.0.0.1:8080; } ###   upstream_host    upstream_address map $upstream_address $upstream_host { default 0; "~^https?://([^:]+)" $1; } ###   ,       https,    ,    -  http map $upstream_address $upstream_scheme { default "http://"; "~(https?://)" $1; }</span></span></code> </pre><br>  ูุฅูุดุงุก <code>upstreams</code> ูุน ุฃุณูุงุก ุงูุนูุงูุงุช: <br><pre style=";text-align:right;direction:rtl"> <code class="nginx hljs"> <span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> one { <span class="hljs-attribute"><span class="hljs-attribute">keepalive</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> one.domain.com; } <span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> two { <span class="hljs-attribute"><span class="hljs-attribute">keepalive</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> two.domain.net; }</code> </pre><br>  ุชู ุชุนุฏูู ุงูุฎุงุฏู ููุณู ููููุงู ููุฃุฎุฐ ูู ุงูุงุนุชุจุงุฑ ุงููุฎุทุท ูุงุณุชุฎุฏุงู ุงุณู ุงูููุจุน ุจุฏูุงู ูู ุงูุนููุงู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_http_version</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> <span class="hljs-variable"><span class="hljs-variable">$upstream_scheme</span></span><span class="hljs-variable"><span class="hljs-variable">$upstream_prefix</span></span><span class="hljs-variable"><span class="hljs-variable">$request_uri</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$upstream_host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-For <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-Port <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-Proto <span class="hljs-string"><span class="hljs-string">""</span></span>; } } <span class="hljs-comment"><span class="hljs-comment"># service for error handling and logging server { listen 127.0.0.1:8080; location / { return 400; } location /ngx_status/ { stub_status; } }</span></span></code> </pre><br>  ุนุธูู  ูุนูู ุงูุญู ุ ูู ุจุฅุถุงูุฉ ุงูุชูุฌูู <code>keepalive</code> ูู ูู ููุจุน ุ ูู ุจุชุนููู <code>proxy_http_version 1.1</code> ุ ูุงูุขู ูุฏููุง ุชุฌูุน ุงุชุตุงู ุ ููู ุดูุก ูุนูู ููุง ูุฌุจ. <br><br>  ูุฐู ุงููุฑุฉ ุ ููููู ุจุงูุชุฃููุฏ ุงูุงูุชูุงุก ูู ุงูููุงูุฉ ูุงูุฐูุงุจ ุดุฑุจ ุงูุดุงู.  ุฃู ูุงุ <br><br>  ูู ุงููุงูุน ุ ุจูููุง ูุดุฑุจ ุงูุดุงู ุ ูุฏ ูููู ุฃุญุฏ ุงูููุฑุฏูู ุจุชุบููุฑ ุนููุงู IP ุฃู ูุฌููุนุฉ ูู ุงูุนูุงููู ุถูู ููุณ ุงููุฌุงู (ูุฑุญุจูุง ุ Amazon) ุ ูุจุงูุชุงูู ูุฏ ูุณูุท ุฃุญุฏ ุงูููุฑุฏูู ูู ุฐุฑูุฉ ุญููุฉ ุงูุดุงู ุงูุฎุงุตุฉ ุจูุง. <br><br>  ุญุณูุง ุ ูุงุฐุง ุชูุนูุ  ุชุชููุฒ Nginx ุจูุงุฑู ุจุณูุท: ุฃุซูุงุก ุฅุนุงุฏุฉ ุงูุชุญููู ุ ูููููุง ุฃู ุชููู โโุงูุฎูุงุฏู ุฏุงุฎู <code>upstream</code> ุฅูู ุนูุงููู ุฌุฏูุฏุฉ ูุชุถุน ุฒูุงุฑุงุช ุนูููุง.  ุจุดูู ุนุงู ุ ุฃูุถุง ุงูุญู.  ุฑูู ูู <code>cron reload nginx</code> ูู 5 ุฏูุงุฆู ูุงูุงุณุชูุฑุงุฑ ูู ุดุฑุจ ุงูุดุงู. <br><br>  ููู ูุง ูุฒุงู ุงูุฃูุฑ ูุจุฏู ูู ูุฑุงุฑูุง ุฌูุฏูุง ุ ูุฐูู ุจุฏุฃุช ุฃุชุทูุน ุฅูู ูุงุจุฑููุณู. <br><br>  ูุฏู Haproxy ุงููุฏุฑุฉ ุนูู ุชุญุฏูุฏ <code>dns resolvers</code> <code>dns cache</code> ูุชูููู <code>dns cache</code> ููุธุงู <code>dns resolvers</code> <code>dns cache</code> .  ูุจุงูุชุงูู ุ ุณุชููู Haproxy ุจุชุญุฏูุซ <code>dns cache</code> ููุธุงู <code>dns cache</code> ุฅุฐุง ุงูุชูุช ุตูุงุญูุฉ ุงูุฅุฏุฎุงูุงุช ุงูููุฌูุฏุฉ ุจูุง ุ ูุณุชุณุชุจุฏู ุงูุนูุงููู ุงูุฎุงุตุฉ ุจุงูุชูุงุฑ ุงูุฑุฆูุณู ุฅุฐุง ูุงูุช ูุฏ ุชุบูุฑุช. <br><br>  ุนุธูู!  ุงูุขู ุงูุฃูุฑ ูุชุฑูู ููุฅุนุฏุงุฏุงุช. <br><br>  ูููุง ููู ูุซุงู ุชูููู ูุตูุฑ ูู Haproxy: <br><br><pre style=";text-align:right;direction:rtl"> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">frontend</span></span> http bind *:<span class="hljs-number"><span class="hljs-number">80</span></span> http-request del-header X-Forwarded-For http-request del-header X-Forwarded-Port http-request del-header X-Forwarded-Proto capture request header Host len <span class="hljs-number"><span class="hljs-number">32</span></span> capture request header Referer len <span class="hljs-number"><span class="hljs-number">128</span></span> capture request header User-Agent len <span class="hljs-number"><span class="hljs-number">128</span></span> acl host_present hdr(host) -m len gt <span class="hljs-number"><span class="hljs-number">0</span></span> use_backend %[req.hdr(host),lower,field(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">'.'</span></span>)] if host_present default_backend default resolvers dns hold valid <span class="hljs-number"><span class="hljs-number">1s</span></span> timeout retry <span class="hljs-number"><span class="hljs-number">100ms</span></span> nameserver dns1 <span class="hljs-number"><span class="hljs-number">1.1.1.1:53</span></span> backend one http-request set-header Host one.domain.com server one--one.domain.com one.domain.com:<span class="hljs-number"><span class="hljs-number">80</span></span> resolvers dns check backend two http-request set-header Host two.domain.net server two--two.domain.net two.domain.net:<span class="hljs-number"><span class="hljs-number">443</span></span> resolvers dns check ssl verify <span class="hljs-literal"><span class="hljs-literal">none</span></span> check-sni two.domain.net sni str(two.domain.net)</code> </pre><br>  ูุจุฏู ุฃู ูู ุดูุก ูุนูู ููุง ูุฌุจ ูุฐู ุงููุฑุฉ.  ุงูุดูุก ุงููุญูุฏ ุงูุฐู ูุง ูุนุฌุจูู ูู Haproxy ูู ุชุนููุฏ ูุตู ุงูุชูููู.  ุชุญุชุงุฌ ุฅูู ุฅูุดุงุก ุงููุซูุฑ ูู ุงููุต ูุฅุถุงูุฉ ูุงุญุฏ ูุนูู ุงูููุจุน.  ููู ุงููุณู ูู ูุญุฑู ุงูุชูุฏู: ุฅุฐุง ููุช ูุง ุชุฑูุฏ ุฃู ุชูุชุจ ููุณ ุงูุดูุก ุ ูุงูุชุจ ูููุฏูุง. <br><br>  ูุงู ูุฏูู ุจุงููุนู ุฎุฑูุทุฉ ูู Nginx ุชุญุชูู ุนูู ุชูุณูู <code>"tag" "upstream"</code> ุ ูุฐูู ูุฑุฑุช ุฃู ุฃุนุชุจุฑูุง ุฃุณุงุณูุง ุ ููู ุจุชุญููู ูุฅูุดุงุก ุงููุงุฌูุฉ ุงูุฎูููุฉ ูู haproxy ุงุณุชูุงุฏูุง ุฅูู ูุฐู ุงูููู. <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#! /usr/bin/env bash haproxy_backend_map_file=./root/etc/haproxy/snippet.d/name_domain_map haproxy_backends_file=./root/etc/haproxy/99_backends.cfg nginx_map_file=./nginx_map while getopts 'n:b:m:' OPT;do case ${OPT} in n) nginx_map_file=${OPTARG} ;; b) haproxy_backends_file=${OPTARG} ;; m) haproxy_backend_map_file=${OPTARG} ;; *) echo 'Usage: ${0} -n [nginx_map_file] -b [haproxy_backends_file] -m [haproxy_backend_map_file]' exit esac done function write_backend(){ local tag=$1 local domain=$2 local port=$3 local server_options="resolvers dns check" [ -n "${4}" ] &amp;&amp; local ssl_options="ssl verify none check-sni ${domain} sni str(${domain})" [ -n "${4}" ] &amp;&amp; server_options+=" ${ssl_options}" cat &gt;&gt; ${haproxy_backends_file} &lt;&lt;EOF backend ${tag} http-request set-header Host ${domain} server ${tag}--${domain} ${domain}:${port} ${server_options} EOF } :&gt; ${haproxy_backends_file} :&gt; ${haproxy_backend_map_file} while read tag addr;do tag=${tag//\"/} [ -z "${tag:0}" ] &amp;&amp; continue [ "${tag:0:1}" == "#" ] &amp;&amp; continue IFS=":" read scheme domain port &lt;&lt;&lt;${addr//;} unset IFS domain=${domain//\/} case ${scheme} in http) port=${port:-80} write_backend ${tag} ${domain} ${port} ;; https) port=${port:-443} write_backend ${tag} ${domain} ${port} 1 esac done &lt; &lt;(sort -V ${nginx_map_file})</span></span></code> </pre><br>  ุงูุขู ูู ูุง ูุญุชุงุฌ ุฅููู ูู ุฅุถุงูุฉ ูุถูู ุฌุฏูุฏ ูู nginx_map ุ ูุจุฏุก ุงููููุฏ ูุงูุญุตูู ุนูู ุชููุฆุฉ haproxy ุงูุฌุงูุฒุฉ. <br><br>  ูุฐุง ุฑุจูุง ูู ุดูุก ููุฐุง ุงูููู.  ุชุดูุฑ ูุฐู ุงูููุงูุฉ ุฅูู ุงููุงุฏุฉ ุงูุชูููุฏูุฉ ูุชู ุชูุฑูุณูุง ููุดููุฉ ุงุฎุชูุงุฑ ุงูุญู ูุฅุฏูุงุฌู ูู ุงูุจูุฆุฉ ุงูุญุงููุฉ. <br><br>  ูู ุงูููุงูุฉ ุงูุชุงููุฉ ุ ุณูู ุฃุฎุจุฑูู ุฃูุซุฑ ุนู ุงููุฎุงุทุฑ ุงูุชู ูุงุฌููุงูุง ุนูุฏ ุงุณุชุฎุฏุงู Haproxy ุ ูุงูุชู ุชุจูู ุฃู ุงูููุงููุณ ูููุฏุฉ ูุฑุตุฏูุง ุ ููุง ููุจุบู ุชุญุณููู ุจุงูุถุจุท ูู ุงููุธุงู ูู ุฃุฌู ุงูุญุตูู ุนูู ุฃูุตู ุฃุฏุงุก ูู ุงูุฎูุงุฏู. <br><br>  ุดูุฑุง ููู ุฌููุนุง ุนูู ุงูุชูุงููู ุ ุฃุฑุงู! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar436992/">https://habr.com/ru/post/ar436992/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar436982/index.html">ุฃุณุจูุน ุงูุฃูู 04: ูุง ูุฌุจ ุงูููุงู ุจู ูุน ูููุงุช ุงููุฑูุฑ</a></li>
<li><a href="../ar436984/index.html">ุชููู Microsoft ุนู ุฏุนู Windows 10 Mobile</a></li>
<li><a href="../ar436986/index.html">Linux API ุฅุฏุงุฑุฉ ููู kernel I / O ุงูุชุฎุฒูู ุงููุคูุช</a></li>
<li><a href="../ar436988/index.html">ุงููุงููุฑุง ุ ุงููุญุฑู ุ ุงูุจูุงูุงุช ุงููุจูุฑุฉ: ููู ุชุจุญุซ ุงุณุชูุฏูููุงุช ุงูุฃููุงู ุนู ุฃููุงู ุฌุฏูุฏุฉ ุจุงุณุชุฎุฏุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู</a></li>
<li><a href="../ar436990/index.html">ูุชูุงูู ุจุฑูุงูุฌ Zimbra ู Zextras Suite ุชูุงููุง ูุน ุฃูุธูุฉ ุชุดุบูู NTC IT ROSA</a></li>
<li><a href="../ar436994/index.html">Liquibase ู Maven</a></li>
<li><a href="../ar436996/index.html">ุฏูุฑุฉ ุจูุซูู ุงูุชุฎุตุต ุงูููุงุฆู ูู ูุฌููุนุฉ Mail.ru</a></li>
<li><a href="../ar436998/index.html">ุญูุงูุฉ ุงูุฑูุงุฆู ูู ุงูููุฏุณุฉ ุงูุนูุณูุฉ ูุงูุฏุฎูู ุบูุฑ ุงููุตุฑุญ ุจู</a></li>
<li><a href="../ar437000/index.html">ููููุฉ ุชุนููู ุงููุงุณ ุนูู ุงุณุชุฎุฏุงู ุจูุงุจุฉ</a></li>
<li><a href="../ar437002/index.html">ุตุงูุญ ASP.NET ุงูุฃุณุงุณูุฉ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>