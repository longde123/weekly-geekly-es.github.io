<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèº üå©Ô∏è üïµüèΩ MIRO est une plate-forme de robot int√©rieure ouverte. Partie 3 - Composant logiciel: ESP8266 üë©üèø‚Äçüé® ‚ôàÔ∏è üöµüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous commen√ßons √† d√©monter le composant logiciel de la plateforme MIRO. Voyons comment ¬´cuisiner¬ª ARDUINO UNO en utilisant ESP8266 pour le firmware et...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>MIRO est une plate-forme de robot int√©rieure ouverte. Partie 3 - Composant logiciel: ESP8266</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/473368/"><img src="https://habrastorage.org/webt/l_/wq/ul/l_wquld_-utzclzu4juj12a3xf8.png" alt="image"><br><br>  Nous commen√ßons √† d√©monter le composant logiciel de la plateforme MIRO.  Voyons comment ¬´cuisiner¬ª ARDUINO UNO en utilisant ESP8266 pour le firmware et la communication sans fil. <br><a name="habracut"></a><br>  Table des mati√®res: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 1</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 2</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 3</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 4</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 5</a> . <br><br>  Je ne voulais pas que nous d√©veloppions quoi que ce soit pour l'ESP8266.  J'√©tais s√ªr qu'il y avait longtemps une solution cl√© en main avec les fonctionnalit√©s dont j'avais besoin.  Et pour MIRO, cette fonctionnalit√© √©tait assez simple: <br><br><ol><li>  Le logiciel doit avoir une interface Web pour la configuration du r√©seau; </li><li>  Le logiciel doit impl√©menter le firmware sans fil ATMEGA328; </li><li> Le logiciel doit avoir une fonctionnalit√© de pont WiFi-UART pour le d√©bogage et la gestion sans fil. </li></ol><br><img src="https://habrastorage.org/webt/w_/ul/du/w_uldu5rai6vmeqd_0nwm5hmkey.png" alt="image" align="left">  Probablement, pour la plupart de ces fonctions, il y a l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ESP-LINK</a> bien connu.  Et il est vraiment puissant.  Nous l'avons utilis√© dans plusieurs autres projets comme pont entre diff√©rentes interfaces - tr√®s pratique.  Mais il y a quelques mois, lorsque nous nous sommes assis pour traiter de pr√®s de cette question, il s'est av√©r√© qu'il ne clignotait pas ARDUINO UNO.  Partout ils √©crivent qu'ils clignotent, mais il n'a pas clignot√©.  Et √† ce moment-l√†, je ne comprenais m√™me pas profond√©ment pourquoi et quelle √©tait la proc√©dure standard.  Mes camarades et moi venons de configurer un port COM virtuel sur l'h√¥te √† une adresse IP ESP sp√©cifique, indiqu√© la ligne de r√©initialisation dans ESP-LINK lui-m√™me et essay√© de la flasher.  ATMEGA328 a √©t√© r√©initialis√© avec succ√®s, mais le micrologiciel n'a pas √©t√© inond√©.  De plus, le r√©seau a un tas de le√ßons sur l'organisation d'un tel firmware avec ESP-LINK.  Mais si vous lisez leur num√©ro, ils ont toujours l√† quelque chose que quelqu'un ne flashe pas. <br><br>  D√©√ßu, il a commenc√© √† chercher des alternatives.  Et je l'ai trouv√© comme un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fork de l'</a> Arduino WiFi original sur GitHub d'un d√©veloppeur avec le surnom jandrassy. <br>  En f√©vrier de la m√™me ann√©e, il y avait une instruction monstrueuse dans README pour tout configurer, du micrologiciel √† l'environnement de d√©veloppement, mais maintenant, cela a √©t√© grandement simplifi√©.  N√©anmoins, il faut encore un petit effort pour mettre en place l'environnement.  Cependant, le firmware ARDUINO est parfait.  Il a √©t√© test√© √† la fois sous Windows et Linux (sur MacOS, nous semblons n'avoir jamais rien test√© du tout - personne dans l'environnement imm√©diat du projet ne l'a). <br><br>  L'ordre de pr√©paration de l'environnement y est le suivant: <br><br><ol><li>  T√©l√©chargez et installez la biblioth√®que dfu √† <a href="">partir d'ici</a> ; </li><li>  Par d√©faut, dans cette biblioth√®que (dans le fichier esp8266-serial-arduinouno-hacked.cpp), il est d√©clar√© que la ligne de r√©initialisation de la puce ATMEGA328 est connect√©e √† la ligne GPIO5 ESP8266.  Pour MIRO, vous devez apporter des modifications ici - passez √† GPIO2. </li></ol><br><div class="spoiler">  <b class="spoiler_title">Que changer exactement</b> <div class="spoiler_text">  C'√©tait: <br><br><pre><code class="cpp hljs">esp8266_serial_arduinouno_hacked_target_reset(struct dfu_interface *iface) { pinMode(<span class="hljs-number"><span class="hljs-number">5</span></span>, OUTPUT); digitalWrite(<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); delay(<span class="hljs-number"><span class="hljs-number">1</span></span>); digitalWrite(<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); delay(<span class="hljs-number"><span class="hljs-number">200</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  C'est devenu: <br><br><pre> <code class="cpp hljs">esp8266_serial_arduinouno_hacked_target_reset(struct dfu_interface *iface) { pinMode(<span class="hljs-number"><span class="hljs-number">2</span></span>, OUTPUT); digitalWrite(<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); delay(<span class="hljs-number"><span class="hljs-number">1</span></span>); digitalWrite(<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); delay(<span class="hljs-number"><span class="hljs-number">200</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br></div></div><br>  L'auteur de jandrassy, ‚Äã‚Äãindique que sa mise en ≈ìuvre ne fonctionne qu'avec cette configuration de la puce cible et du chargeur de d√©marrage (ATMEGA328P avec Optiboot). <br><br>  Je suis s√ªr qu'il existe encore des solutions et peut-√™tre m√™me de meilleures.  Si quelqu'un conna√Æt avec certitude les options de travail, faites-le moi savoir.  Parce que, malgr√© la grande quantit√© de code pr√™t √† l'emploi, en plus d'ESP-LINK, nous avons √©galement test√© 2 ou 3 projets - ils n'ont pas fonctionn√©.  Dans certains cas, le micrologiciel a √©t√© ex√©cut√© une fois, dans certains cas, il n'a pas fonctionn√© du tout. <br><br>  L'un des principaux avantages de la solution trouv√©e est peut-√™tre la base de code relativement petite du projet et le fait que le firmware pour Arduino Core est d√©velopp√©. <br><br>  Ce qui n'√©tait pas dans le projet jandrassy √©tait le pont sans fil WiFi-UART.  D√©j√† dans le firmware Arduino.org WiFi Link d'origine, une page avec une fen√™tre de terminal a √©t√© coup√©e, permettant au navigateur de fonctionner avec la puce UART ATMEGA328.  Tout comme cela peut √™tre fait dans ESP-LINK.  Et si nous nous tournons vers les premi√®res publications sur Arduino UNO WiFi (par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> ), il est clair que dans les premi√®res versions du firmware, la fen√™tre et l'√©l√©ment de menu correspondant (¬´Console WiFi¬ª) le sont.  Et m√™me dans la version 1.0.0 de l'archive, le fichier console.js (il vient d'impl√©menter cette page) se trouve, mais en fait il n'est impliqu√© en aucune fa√ßon dans le serveur (nous avons v√©rifi√©).  Pourquoi et pourquoi ils l'ont sci√© n'est pas clair. <br><br>  Je devais finir quelque chose.  Maintenant, il y a un autre serveur dans le firmware - TELNET sur le port √©vident 23, avec lequel de nombreux programmes de terminaux fonctionnent sans probl√®me. <br><br>  Cependant, pour le moment, pour que tout fonctionne, j'ai d√ª supprimer du code jandrassy la partie responsable du firmware sans fil de l'ESP lui-m√™me.  Dans les exigences initiales, je n'avais pas cette fonctionnalit√©, donc d'accord.  Cependant, si les lecteurs dans les commentaires peuvent me dire de mani√®re affirmative s'il est possible dans un micrologiciel d'impl√©menter la possibilit√© d'un micrologiciel sans fil √† la fois de l'ESP8266 lui-m√™me et du MCU ¬´externe¬ª (dans ce cas, ATMEGA328), alors je penserai √† retourner cette fonctionnalit√© au micrologiciel ESP.  D√©j√† dans la pr√©paration de l'article, indirectement, j'en ai vu la confirmation dans cette <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©bauche de</a> Canadiens.  Mais n'a pas v√©rifi√©. <br><br>  En attendant, ESP est flash√© exclusivement via un fil, mais ARDUINO a la capacit√© de communiquer avec le micrologiciel sans fil et les communications TELNET via le pont WiFi-UART.  Et c'est tr√®s pratique!  Mon objectif est atteint. <br><br>  Eh bien, dans le projet, comme dans l'original, il y a une interface WEB pour les param√®tres (les images sont cliquables). <br><br> <a href=""><img src="https://habrastorage.org/webt/lt/ve/hh/ltvehh2lufla_jkyhjforot0ssi.png"></a> <br><br> <a href=""><img src="https://habrastorage.org/webt/r0/cb/mz/r0cbmzijmgrdo0t5of66jlnipik.png"></a> <br><br>  Nous avons chang√© les fichiers CSS des styles d'interface WEB pour notre projet et introduit une petite "b√©quille" - maintenant ESP est toujours en mode AP + STA.  Cette b√©quille a √©t√© con√ßue afin d'exclure la possibilit√© de basculer l'ESP en mode "uniquement STA", dans lequel lors du transfert du robot vers un autre sous-r√©seau, l'utilisateur perd la possibilit√© de configurer le robot dans un nouveau r√©seau - le robot ne peut pas se connecter au nouveau r√©seau, mais il n'y a pas d'acc√®s externe non plus - Je dois reflasher l'ESP.  En mode AP + STA, l'utilisateur peut toujours se connecter au point d'acc√®s du robot et configurer la connexion au nouveau r√©seau WiFi. <br><br>  √Ä propos de la fa√ßon de flasher ESP8266 avec ce "monstre".  En g√©n√©ral, pour un module arbitraire sur une puce ESP8266, l'ordre est le suivant: <br><br><ol><li>  Allumez la carte (connectez-vous √† USB); </li><li>  R√©glez les param√®tres de la carte comme sur la figure; <br><br><img src="https://habrastorage.org/webt/tk/q0/8b/tkq08brdmdy-gmkv8v1_stjlny0.png" alt="image"><br><br>  Il est tr√®s important de s√©lectionner ¬´v1.4 Bande passante sup√©rieure¬ª - si vous s√©lectionnez ¬´v2¬ª, apr√®s le firmware, il n'est pas possible de se connecter √† la carte via WiFi (le point d'acc√®s est visible, mais la proc√©dure de connexion ne fonctionne pas - qui sait √† quoi cela est connect√© - √©crivez dans les commentaires). </li><li>  S√©lectionnez un port (dans l'exemple de la capture d'√©cran - COM3). </li><li>  Ex√©cutez le firmware.  Pendant la proc√©dure de chargement de la carte, la m√©moire du microcontr√¥leur est d'abord effac√©e, puis le micrologiciel est effac√©. </li><li>  Une fois la proc√©dure du micrologiciel termin√©e, vous devez r√©initialiser la carte √† l'aide du bouton de r√©initialisation. </li><li>  S√©lectionnez Arduino IDE ESP8266 Sketch Data Upload dans le menu et t√©l√©chargez SPIFFS. </li><li>  R√©initialisez la carte. </li></ol><br>  Pour la configuration avec notre ¬´carte modifi√©e¬ª UNO + WiFi (voir la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">premi√®re partie</a> ), tout est un peu plus compliqu√© en raison des caract√©ristiques mat√©rielles de la carte, ce qui est difficile √† √©tudier confortablement en raison du grand nombre d'erreurs dans le document avec le sch√©ma √©lectrique.  Nous avons √©crit des instructions plus d√©taill√©es dans le fichier ¬´MIRO ESP Firmware upload manual¬ª du r√©f√©rentiel - si vous agissez strictement dessus, le firmware passe 100 sur 100. <br><br>  Nous arrivons √† une partie tr√®s int√©ressante - le composant logiciel MIRO affect√© √† ATMEGA328.  Il y a √©galement plus de travail et d'espace pour discuter de diverses solutions. <br><br>  Merci √† tous! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr473368/">https://habr.com/ru/post/fr473368/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr473354/index.html">√Ä propos des bizarreries de la habrostatistique</a></li>
<li><a href="../fr473358/index.html">Installer et configurer Nexus Sonatype en utilisant l'infrastructure comme approche de code</a></li>
<li><a href="../fr473362/index.html">Exp√©rience GSoC: Comment deux (trois) √©tudiants ont vraiment am√©lior√© le code CRIU</a></li>
<li><a href="../fr473364/index.html">Il y a un gobie qui se balance: une liste de contr√¥le pour le commerce √©lectronique pendant la saison des ventes</a></li>
<li><a href="../fr473366/index.html">Qu'y a-t-il dans ma smart tv? Ou qu'est-ce qui peut √™tre entass√© dans le t√©l√©viseur?</a></li>
<li><a href="../fr473372/index.html">Cr√©ation d'un service de suivi d'appels simple, partie 1</a></li>
<li><a href="../fr473374/index.html">Comment nous avons int√©gr√© YouTube Live avec Zoom</a></li>
<li><a href="../fr473376/index.html">Fuite de documentation sur Windows 10X sur le r√©seau - une nouvelle version du syst√®me d'exploitation pour les appareils √† deux √©crans</a></li>
<li><a href="../fr473378/index.html">Accords de licence de logiciels malveillants</a></li>
<li><a href="../fr473380/index.html">4. Test de charge Check Point Maestro</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>