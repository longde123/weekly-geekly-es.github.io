<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏼 🌩️ 🕵🏽 MIRO est une plate-forme de robot intérieure ouverte. Partie 3 - Composant logiciel: ESP8266 👩🏿‍🎨 ♈️ 🚵🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous commençons à démonter le composant logiciel de la plateforme MIRO. Voyons comment «cuisiner» ARDUINO UNO en utilisant ESP8266 pour le firmware et...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>MIRO est une plate-forme de robot intérieure ouverte. Partie 3 - Composant logiciel: ESP8266</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/473368/"><img src="https://habrastorage.org/webt/l_/wq/ul/l_wquld_-utzclzu4juj12a3xf8.png" alt="image"><br><br>  Nous commençons à démonter le composant logiciel de la plateforme MIRO.  Voyons comment «cuisiner» ARDUINO UNO en utilisant ESP8266 pour le firmware et la communication sans fil. <br><a name="habracut"></a><br>  Table des matières: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 1</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 2</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 3</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 4</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 5</a> . <br><br>  Je ne voulais pas que nous développions quoi que ce soit pour l'ESP8266.  J'étais sûr qu'il y avait longtemps une solution clé en main avec les fonctionnalités dont j'avais besoin.  Et pour MIRO, cette fonctionnalité était assez simple: <br><br><ol><li>  Le logiciel doit avoir une interface Web pour la configuration du réseau; </li><li>  Le logiciel doit implémenter le firmware sans fil ATMEGA328; </li><li> Le logiciel doit avoir une fonctionnalité de pont WiFi-UART pour le débogage et la gestion sans fil. </li></ol><br><img src="https://habrastorage.org/webt/w_/ul/du/w_uldu5rai6vmeqd_0nwm5hmkey.png" alt="image" align="left">  Probablement, pour la plupart de ces fonctions, il y a l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ESP-LINK</a> bien connu.  Et il est vraiment puissant.  Nous l'avons utilisé dans plusieurs autres projets comme pont entre différentes interfaces - très pratique.  Mais il y a quelques mois, lorsque nous nous sommes assis pour traiter de près de cette question, il s'est avéré qu'il ne clignotait pas ARDUINO UNO.  Partout ils écrivent qu'ils clignotent, mais il n'a pas clignoté.  Et à ce moment-là, je ne comprenais même pas profondément pourquoi et quelle était la procédure standard.  Mes camarades et moi venons de configurer un port COM virtuel sur l'hôte à une adresse IP ESP spécifique, indiqué la ligne de réinitialisation dans ESP-LINK lui-même et essayé de la flasher.  ATMEGA328 a été réinitialisé avec succès, mais le micrologiciel n'a pas été inondé.  De plus, le réseau a un tas de leçons sur l'organisation d'un tel firmware avec ESP-LINK.  Mais si vous lisez leur numéro, ils ont toujours là quelque chose que quelqu'un ne flashe pas. <br><br>  Déçu, il a commencé à chercher des alternatives.  Et je l'ai trouvé comme un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fork de l'</a> Arduino WiFi original sur GitHub d'un développeur avec le surnom jandrassy. <br>  En février de la même année, il y avait une instruction monstrueuse dans README pour tout configurer, du micrologiciel à l'environnement de développement, mais maintenant, cela a été grandement simplifié.  Néanmoins, il faut encore un petit effort pour mettre en place l'environnement.  Cependant, le firmware ARDUINO est parfait.  Il a été testé à la fois sous Windows et Linux (sur MacOS, nous semblons n'avoir jamais rien testé du tout - personne dans l'environnement immédiat du projet ne l'a). <br><br>  L'ordre de préparation de l'environnement y est le suivant: <br><br><ol><li>  Téléchargez et installez la bibliothèque dfu à <a href="">partir d'ici</a> ; </li><li>  Par défaut, dans cette bibliothèque (dans le fichier esp8266-serial-arduinouno-hacked.cpp), il est déclaré que la ligne de réinitialisation de la puce ATMEGA328 est connectée à la ligne GPIO5 ESP8266.  Pour MIRO, vous devez apporter des modifications ici - passez à GPIO2. </li></ol><br><div class="spoiler">  <b class="spoiler_title">Que changer exactement</b> <div class="spoiler_text">  C'était: <br><br><pre><code class="cpp hljs">esp8266_serial_arduinouno_hacked_target_reset(struct dfu_interface *iface) { pinMode(<span class="hljs-number"><span class="hljs-number">5</span></span>, OUTPUT); digitalWrite(<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); delay(<span class="hljs-number"><span class="hljs-number">1</span></span>); digitalWrite(<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); delay(<span class="hljs-number"><span class="hljs-number">200</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  C'est devenu: <br><br><pre> <code class="cpp hljs">esp8266_serial_arduinouno_hacked_target_reset(struct dfu_interface *iface) { pinMode(<span class="hljs-number"><span class="hljs-number">2</span></span>, OUTPUT); digitalWrite(<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); delay(<span class="hljs-number"><span class="hljs-number">1</span></span>); digitalWrite(<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); delay(<span class="hljs-number"><span class="hljs-number">200</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br></div></div><br>  L'auteur de jandrassy, ​​indique que sa mise en œuvre ne fonctionne qu'avec cette configuration de la puce cible et du chargeur de démarrage (ATMEGA328P avec Optiboot). <br><br>  Je suis sûr qu'il existe encore des solutions et peut-être même de meilleures.  Si quelqu'un connaît avec certitude les options de travail, faites-le moi savoir.  Parce que, malgré la grande quantité de code prêt à l'emploi, en plus d'ESP-LINK, nous avons également testé 2 ou 3 projets - ils n'ont pas fonctionné.  Dans certains cas, le micrologiciel a été exécuté une fois, dans certains cas, il n'a pas fonctionné du tout. <br><br>  L'un des principaux avantages de la solution trouvée est peut-être la base de code relativement petite du projet et le fait que le firmware pour Arduino Core est développé. <br><br>  Ce qui n'était pas dans le projet jandrassy était le pont sans fil WiFi-UART.  Déjà dans le firmware Arduino.org WiFi Link d'origine, une page avec une fenêtre de terminal a été coupée, permettant au navigateur de fonctionner avec la puce UART ATMEGA328.  Tout comme cela peut être fait dans ESP-LINK.  Et si nous nous tournons vers les premières publications sur Arduino UNO WiFi (par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> ), il est clair que dans les premières versions du firmware, la fenêtre et l'élément de menu correspondant («Console WiFi») le sont.  Et même dans la version 1.0.0 de l'archive, le fichier console.js (il vient d'implémenter cette page) se trouve, mais en fait il n'est impliqué en aucune façon dans le serveur (nous avons vérifié).  Pourquoi et pourquoi ils l'ont scié n'est pas clair. <br><br>  Je devais finir quelque chose.  Maintenant, il y a un autre serveur dans le firmware - TELNET sur le port évident 23, avec lequel de nombreux programmes de terminaux fonctionnent sans problème. <br><br>  Cependant, pour le moment, pour que tout fonctionne, j'ai dû supprimer du code jandrassy la partie responsable du firmware sans fil de l'ESP lui-même.  Dans les exigences initiales, je n'avais pas cette fonctionnalité, donc d'accord.  Cependant, si les lecteurs dans les commentaires peuvent me dire de manière affirmative s'il est possible dans un micrologiciel d'implémenter la possibilité d'un micrologiciel sans fil à la fois de l'ESP8266 lui-même et du MCU «externe» (dans ce cas, ATMEGA328), alors je penserai à retourner cette fonctionnalité au micrologiciel ESP.  Déjà dans la préparation de l'article, indirectement, j'en ai vu la confirmation dans cette <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ébauche de</a> Canadiens.  Mais n'a pas vérifié. <br><br>  En attendant, ESP est flashé exclusivement via un fil, mais ARDUINO a la capacité de communiquer avec le micrologiciel sans fil et les communications TELNET via le pont WiFi-UART.  Et c'est très pratique!  Mon objectif est atteint. <br><br>  Eh bien, dans le projet, comme dans l'original, il y a une interface WEB pour les paramètres (les images sont cliquables). <br><br> <a href=""><img src="https://habrastorage.org/webt/lt/ve/hh/ltvehh2lufla_jkyhjforot0ssi.png"></a> <br><br> <a href=""><img src="https://habrastorage.org/webt/r0/cb/mz/r0cbmzijmgrdo0t5of66jlnipik.png"></a> <br><br>  Nous avons changé les fichiers CSS des styles d'interface WEB pour notre projet et introduit une petite "béquille" - maintenant ESP est toujours en mode AP + STA.  Cette béquille a été conçue afin d'exclure la possibilité de basculer l'ESP en mode "uniquement STA", dans lequel lors du transfert du robot vers un autre sous-réseau, l'utilisateur perd la possibilité de configurer le robot dans un nouveau réseau - le robot ne peut pas se connecter au nouveau réseau, mais il n'y a pas d'accès externe non plus - Je dois reflasher l'ESP.  En mode AP + STA, l'utilisateur peut toujours se connecter au point d'accès du robot et configurer la connexion au nouveau réseau WiFi. <br><br>  À propos de la façon de flasher ESP8266 avec ce "monstre".  En général, pour un module arbitraire sur une puce ESP8266, l'ordre est le suivant: <br><br><ol><li>  Allumez la carte (connectez-vous à USB); </li><li>  Réglez les paramètres de la carte comme sur la figure; <br><br><img src="https://habrastorage.org/webt/tk/q0/8b/tkq08brdmdy-gmkv8v1_stjlny0.png" alt="image"><br><br>  Il est très important de sélectionner «v1.4 Bande passante supérieure» - si vous sélectionnez «v2», après le firmware, il n'est pas possible de se connecter à la carte via WiFi (le point d'accès est visible, mais la procédure de connexion ne fonctionne pas - qui sait à quoi cela est connecté - écrivez dans les commentaires). </li><li>  Sélectionnez un port (dans l'exemple de la capture d'écran - COM3). </li><li>  Exécutez le firmware.  Pendant la procédure de chargement de la carte, la mémoire du microcontrôleur est d'abord effacée, puis le micrologiciel est effacé. </li><li>  Une fois la procédure du micrologiciel terminée, vous devez réinitialiser la carte à l'aide du bouton de réinitialisation. </li><li>  Sélectionnez Arduino IDE ESP8266 Sketch Data Upload dans le menu et téléchargez SPIFFS. </li><li>  Réinitialisez la carte. </li></ol><br>  Pour la configuration avec notre «carte modifiée» UNO + WiFi (voir la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">première partie</a> ), tout est un peu plus compliqué en raison des caractéristiques matérielles de la carte, ce qui est difficile à étudier confortablement en raison du grand nombre d'erreurs dans le document avec le schéma électrique.  Nous avons écrit des instructions plus détaillées dans le fichier «MIRO ESP Firmware upload manual» du référentiel - si vous agissez strictement dessus, le firmware passe 100 sur 100. <br><br>  Nous arrivons à une partie très intéressante - le composant logiciel MIRO affecté à ATMEGA328.  Il y a également plus de travail et d'espace pour discuter de diverses solutions. <br><br>  Merci à tous! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr473368/">https://habr.com/ru/post/fr473368/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr473354/index.html">À propos des bizarreries de la habrostatistique</a></li>
<li><a href="../fr473358/index.html">Installer et configurer Nexus Sonatype en utilisant l'infrastructure comme approche de code</a></li>
<li><a href="../fr473362/index.html">Expérience GSoC: Comment deux (trois) étudiants ont vraiment amélioré le code CRIU</a></li>
<li><a href="../fr473364/index.html">Il y a un gobie qui se balance: une liste de contrôle pour le commerce électronique pendant la saison des ventes</a></li>
<li><a href="../fr473366/index.html">Qu'y a-t-il dans ma smart tv? Ou qu'est-ce qui peut être entassé dans le téléviseur?</a></li>
<li><a href="../fr473372/index.html">Création d'un service de suivi d'appels simple, partie 1</a></li>
<li><a href="../fr473374/index.html">Comment nous avons intégré YouTube Live avec Zoom</a></li>
<li><a href="../fr473376/index.html">Fuite de documentation sur Windows 10X sur le réseau - une nouvelle version du système d'exploitation pour les appareils à deux écrans</a></li>
<li><a href="../fr473378/index.html">Accords de licence de logiciels malveillants</a></li>
<li><a href="../fr473380/index.html">4. Test de charge Check Point Maestro</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>