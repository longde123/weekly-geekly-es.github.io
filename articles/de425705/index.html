<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏿‍🏭 🔢 📗 Replikation von Percona Server für MySQL nach PostgreSQL mit dem Tool pg_chameleon 🚇 👨🏽‍🏭 🎻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Die Replikation ist eine der bekannten Funktionen, mit denen Sie eine identische Kopie einer Datenbank erstellen können. Es wird in fast jedem relatio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Replikation von Percona Server für MySQL nach PostgreSQL mit dem Tool pg_chameleon</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/425705/"><p>  Die Replikation ist eine der bekannten Funktionen, mit denen Sie eine identische Kopie einer Datenbank erstellen können.  Es wird in fast jedem relationalen Datenbankverwaltungssystem (RDBMS) unterstützt.  Die Replikation bietet erhebliche Vorteile, insbesondere hohe Verfügbarkeit und Lastausgleich.  Was aber, wenn eine Replikation zwischen zwei Datenbanken mit unterschiedlicher Struktur wie MySQL und PostgreSQL erforderlich ist?  Ist es möglich, Änderungen von einer MySQL-Datenbank kontinuierlich in eine PostgreSQL-Datenbank zu replizieren?  Die Antwort auf diese Frage ist das Replikationstool <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">pg_chameleon</a> . </p><br><p><img src="http://telegramfor.me/ext_img/catops/757" alt="Bild"></p><a name="habracut"></a><br><p>  Für die Replikation kontinuierlicher Änderungen verwendet pg_chameleon die MySQL-Replikationsbibliothek, mit der Sie logische Kopien von Zeilen aus der MySQL-Datenbank abrufen können, die in ein jsonb-Objekt konvertiert werden.  Die Funktion pl / pgsql in Postgres dekodiert das jsonb-Objekt und reproduziert die Änderungen in der Postgres-Datenbank.  Um diesen Replikationstyp zu konfigurieren, muss die Variable binlog_format für die MySQL-Datenbank auf ROW (Zeichenfolge) festgelegt werden. </p><br><h3 id="neskolko-momentov-kotorye-sleduet-znat-do-nastroyki-etogo-instrumenta">  Einige Punkte, die Sie vor dem Einrichten dieses Tools beachten sollten: </h3><br><ol><li>  Die Tabellen, die repliziert werden müssen, müssen einen Primärschlüssel haben. </li><li>  Das Tool funktioniert in Versionen von PostgreSQL über 9.5 und dem MySQL-System über 5.5 </li><li>  Um diese Replikation zu konfigurieren, muss die Variable binlog_format auf ROW gesetzt werden. </li><li>  Die Python-Version muss höher als 3.3 sein </li></ol><br><p> Beim Starten der Replikation ruft pg_chameleon Daten aus MySQL im CSV-Format mit einer Aufteilung in Gruppen einer bestimmten Länge ab, um eine Speicherüberlastung zu vermeiden.  Diese Daten werden mit dem Befehl COPY an Postgres übertragen.  Wenn das Kopieren fehlschlägt, wird der Befehl INSERT ausgeführt, was den Prozess verlangsamen kann.  Wenn der Befehl INSERT fehlschlägt, geht die Zeile verloren. </p><br><p>  Um Änderungen von MySQL zu replizieren, emuliert pg_chameleon das Verhalten des MySQL-Replikats (Slave).  Dadurch wird ein Schema in Postgres erstellt, das anfängliche Laden der Daten durchgeführt, eine Verbindung zum MySQL-Replikationsprotokoll hergestellt und die Zeilen in die Postgres-Tabelle kopiert.  Gleichzeitig sorgen die entsprechenden Postgres-Funktionen für die Dekodierung und Änderung von Zeichenfolgen.  Dies ähnelt dem Speichern von Übertragungsprotokollen in Postgres-Tabellen und deren Anwendung auf ein Postgres-Schema.  Das Erstellen eines Postgres-Datenbankschemas mit einer beliebigen Datenbeschreibungssprache ist nicht erforderlich.  Für die Tabellen, die bei der Konfiguration der Replikation angegeben wurden, führt das Tool pg_chameleon dies automatisch aus.  Wenn Sie Typen auf eine bestimmte Weise konvertieren müssen, können Sie dies in der Konfigurationsdatei angeben. </p><br><p>  Das Folgende ist eine Übung, mit der Sie experimentieren können.  Verwenden Sie die bereitgestellten Optionen, wenn sie Ihren Anforderungen vollständig entsprechen.  Wir haben diese Tests unter CentOS Linux Version 7.4 durchgeführt. </p><br><h2 id="podgotovka-sredy">  Umweltvorbereitung </h2><br><h3 id="nastroyte-sistemu-percona-server-for-mysql">  Konfigurieren Sie Percona Server für MySQL </h3><br><p>  Installieren Sie MySQL Version 5.7 und fügen Sie die entsprechenden Optionen für die Replikation hinzu. </p><br><p>  In dieser Übung habe ich Percona Server für MySQL Version 5.7 mithilfe des YUM-Repositorys installiert. </p><br><pre><code class="hljs powershell">yum install http://www.percona.com/downloads/percona<span class="hljs-literal"><span class="hljs-literal">-release</span></span>/redhat/<span class="hljs-number"><span class="hljs-number">0.1</span></span><span class="hljs-literal"><span class="hljs-literal">-6</span></span>/percona<span class="hljs-literal"><span class="hljs-literal">-release</span></span><span class="hljs-literal"><span class="hljs-literal">-0</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-literal"><span class="hljs-literal">-6</span></span>.noarch.rpm yum install Percona<span class="hljs-literal"><span class="hljs-literal">-Server</span></span><span class="hljs-literal"><span class="hljs-literal">-server</span></span><span class="hljs-literal"><span class="hljs-literal">-57</span></span> echo <span class="hljs-string"><span class="hljs-string">"mysql ALL=(ALL) NOPASSWD: ALL"</span></span> &gt;&gt; /etc/sudoers usermod <span class="hljs-literal"><span class="hljs-literal">-s</span></span> /bin/bash mysql sudo su - mysql</code> </pre> <br><p>  Für pg_chameleon müssen die folgenden Parameter in der Datei my.cnf konfiguriert werden (Datei mit MySQL-Serverparametern).  Sie können der Datei /etc/my.cnf die folgenden Optionen hinzufügen </p><br><pre> <code class="hljs pgsql">binlog_format= <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> binlog_row_image=<span class="hljs-keyword"><span class="hljs-keyword">FULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>-bin = mysql-bin <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>-id = <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><p>  Nachdem Sie die obigen Parameter in die Datei my.cnf aufgenommen haben, starten Sie nun den MySQL-Server. </p><br><pre> <code class="hljs pgsql">$ service mysql <span class="hljs-keyword"><span class="hljs-keyword">start</span></span></code> </pre> <br><p>  Rufen Sie das temporäre Kennwort für das Root-Konto aus der Datei mysqld.log ab und setzen Sie das Root-Passwort mit dem Befehl mysqladmin zurück. </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> grep <span class="hljs-string"><span class="hljs-string">"temporary"</span></span> /var/log/mysqld.log <span class="hljs-variable"><span class="hljs-variable">$</span></span> mysqladmin <span class="hljs-literal"><span class="hljs-literal">-u</span></span> root <span class="hljs-literal"><span class="hljs-literal">-p</span></span> password <span class="hljs-string"><span class="hljs-string">'Secret123!'</span></span></code> </pre> <br><p>  Stellen Sie nun eine Verbindung zu Ihrer eigenen Instanz der MySQL-Datenbank her und erstellen Sie ein Beispielschema / Tabellen.  Ich habe auch eine Emp-Tabelle zur Überprüfung erstellt. </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> wget http://downloads.mysql.com/docs/sakila<span class="hljs-literal"><span class="hljs-literal">-db</span></span>.tar.gz <span class="hljs-variable"><span class="hljs-variable">$</span></span> tar <span class="hljs-literal"><span class="hljs-literal">-xzf</span></span> sakila<span class="hljs-literal"><span class="hljs-literal">-db</span></span>.tar.gz <span class="hljs-variable"><span class="hljs-variable">$</span></span> mysql <span class="hljs-literal"><span class="hljs-literal">-uroot</span></span> <span class="hljs-literal"><span class="hljs-literal">-pSecret123</span></span>! &lt; sakila<span class="hljs-literal"><span class="hljs-literal">-db</span></span>/sakila<span class="hljs-literal"><span class="hljs-literal">-schema</span></span>.sql <span class="hljs-variable"><span class="hljs-variable">$</span></span> mysql <span class="hljs-literal"><span class="hljs-literal">-uroot</span></span> <span class="hljs-literal"><span class="hljs-literal">-pSecret123</span></span>! &lt; sakila<span class="hljs-literal"><span class="hljs-literal">-db</span></span>/sakila<span class="hljs-literal"><span class="hljs-literal">-data</span></span>.sql <span class="hljs-variable"><span class="hljs-variable">$</span></span> mysql <span class="hljs-literal"><span class="hljs-literal">-uroot</span></span> <span class="hljs-literal"><span class="hljs-literal">-pSecret123</span></span>! sakila <span class="hljs-literal"><span class="hljs-literal">-e</span></span> <span class="hljs-string"><span class="hljs-string">"create table emp (id int PRIMARY KEY, first_name varchar(20), last_name varchar(20))"</span></span></code> </pre> <br><p>  Erstellen Sie einen Benutzer, um die Replikation mit dem Tool pg_chameleon zu konfigurieren, und gewähren Sie ihm die entsprechenden Rechte, indem Sie die folgenden Schritte ausführen. </p><br><pre> <code class="hljs sql">$ mysql -uroot -p <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-string"><span class="hljs-string">'usr_replica'</span></span>@<span class="hljs-string"><span class="hljs-string">'%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">identified</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-string"><span class="hljs-string">'Secret123!'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> sakila.* <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> <span class="hljs-string"><span class="hljs-string">'usr_replica'</span></span>@<span class="hljs-string"><span class="hljs-string">'%'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> RELOAD, <span class="hljs-keyword"><span class="hljs-keyword">REPLICATION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CLIENT</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">REPLICATION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SLAVE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> *.* <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> <span class="hljs-string"><span class="hljs-string">'usr_replica'</span></span>@<span class="hljs-string"><span class="hljs-string">'%'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">FLUSH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PRIVILEGES</span></span>;</code> </pre> <br><p>  Beim Erstellen eines Benutzers auf einem MySQL-Server ('usr_replica' @ '%') muss möglicherweise das Zeichen "%" durch die entsprechende IP-Adresse oder den Hostnamen des Servers ersetzt werden, auf dem pg_chameleon ausgeführt wird. </p><br><h3 id="nastroyte-postgresql">  Konfigurieren Sie PostgreSQL </h3><br><p>  Installieren Sie PostgreSQL und führen Sie eine Kopie der Datenbank aus. </p><br><p>  Befolgen Sie diese Schritte, um PostgreSQL Version 10.x zu installieren. </p><br><pre> <code class="hljs pgsql">yum install https://yum.postgresql.org/<span class="hljs-number"><span class="hljs-number">10</span></span>/redhat/rhel<span class="hljs-number"><span class="hljs-number">-7.4</span></span>-x86_64/pgdg-centos10<span class="hljs-number"><span class="hljs-number">-10</span></span><span class="hljs-number"><span class="hljs-number">-2.</span></span>noarch.rpm yum install postgresql10* su - postgres $/usr/pgsql<span class="hljs-number"><span class="hljs-number">-10</span></span>/bin/initdb $ /usr/pgsql<span class="hljs-number"><span class="hljs-number">-10</span></span>/bin/pg_ctl -D /var/lib/pgsql/<span class="hljs-number"><span class="hljs-number">10</span></span>/data <span class="hljs-keyword"><span class="hljs-keyword">start</span></span></code> </pre> <br><p>  Wie Sie den folgenden Protokollen entnehmen können, müssen Sie in PostgreSQL einen Benutzer erstellen, mit dem pg_chameleon geänderte Daten in PostgreSQL schreiben kann.  Erstellen Sie auch eine Zieldatenbank. </p><br><pre> <code class="hljs pgsql">postgres=# <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> usr_replica <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ENCRYPTED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PASSWORD</span></span> <span class="hljs-string"><span class="hljs-string">'secret'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROLE</span></span> postgres=# <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> db_replica <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OWNER</span></span> usr_replica; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span></code> </pre> <br><h2 id="etapy-ustanovki-i-nastroyki-replikacii-s-ispolzovaniem-pg_chameleon">  Schritte zum Installieren und Konfigurieren der Replikation mit pg_chameleon </h2><br><p>  <b>Stufe 1.</b> In dieser Übung habe ich den Python-Interpreter Version 3.6 und pg_chameleon Version 2.0.8 installiert, indem ich die folgenden Schritte ausgeführt habe.  Wenn Sie bereits die erforderliche Version des Python-Interpreters installiert haben, können Sie die Schritte zum Installieren überspringen.  Wir können eine virtuelle Umgebung erstellen, wenn das Betriebssystem standardmäßig nicht Python Version 3.x enthält. </p><br><pre> <code class="hljs powershell">yum install gcc openssl<span class="hljs-literal"><span class="hljs-literal">-devel</span></span> bzip2<span class="hljs-literal"><span class="hljs-literal">-devel</span></span> wget cd /usr/src wget https://www.python.org/ftp/python/<span class="hljs-number"><span class="hljs-number">3.6</span></span>.<span class="hljs-number"><span class="hljs-number">6</span></span>/Python<span class="hljs-literal"><span class="hljs-literal">-3</span></span>.<span class="hljs-number"><span class="hljs-number">6.6</span></span>.tgz tar xzf Python<span class="hljs-literal"><span class="hljs-literal">-3</span></span>.<span class="hljs-number"><span class="hljs-number">6.6</span></span>.tgz cd Python<span class="hljs-literal"><span class="hljs-literal">-3</span></span>.<span class="hljs-number"><span class="hljs-number">6.6</span></span> ./configure -<span class="hljs-literal"><span class="hljs-literal">-enable</span></span><span class="hljs-literal"><span class="hljs-literal">-optimizations</span></span> make altinstall python3.<span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-literal"><span class="hljs-literal">-m</span></span> venv venv source venv/bin/activate pip install pip -<span class="hljs-literal"><span class="hljs-literal">-upgrade</span></span> pip install pg_chameleon</code> </pre> <br><p>  <b>Stufe 2. Für</b> dieses Tool ist eine Konfigurationsdatei erforderlich, in der Informationen zu den Quell- und Zielservern gespeichert werden, sowie ein Ordner zum Speichern von Protokollen.  Verwenden Sie den folgenden Befehl, damit pg_chameleon eine Konfigurationsdateivorlage und entsprechende Ordner erstellt. </p><br><pre> <code class="hljs ruby">$ chameleon set_configuration_files</code> </pre> <br><p>  Wenn dieser Befehl ausgeführt wird, werden die folgenden Ergebnisse angezeigt.  Sie zeigen, dass dieser Befehl mehrere Ordner und Dateien an der Stelle erstellt hat, an der Sie ihn ausgeführt haben. </p><br><pre> <code class="hljs pgsql">creating directory /var/lib/pgsql/.pg_chameleon creating directory /var/lib/pgsql/.pg_chameleon/<span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span>/ creating directory /var/lib/pgsql/.pg_chameleon/logs/ creating directory /var/lib/pgsql/.pg_chameleon/pid/ copying <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> example <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /var/lib/pgsql/.pg_chameleon/<span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span>//config-example.yml</code> </pre> <br><p>  Kopieren Sie die Beispielkonfigurationsdatei in eine andere Datei, z. B. default.yml </p><br><pre> <code class="hljs pgsql">$ cd .pg_chameleon/<span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span>/ $ cp config-example.yml <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.yml</code> </pre> <br><p>  So sieht meine Datei default.yml aus, nachdem alle erforderlichen Parameter darin enthalten sind.  In dieser Datei können Sie optional die Konvertierung von Datentypen, Tabellen, die während der Replikation übersprungen werden sollen, und Ereignisse der Datenbearbeitungssprache angeben, die für die ausgewählte Liste von Tabellen ignoriert werden sollen. </p><br><pre> <code class="hljs kotlin">--- #global settings pid_dir: <span class="hljs-string"><span class="hljs-string">'~/.pg_chameleon/pid/'</span></span> log_dir: <span class="hljs-string"><span class="hljs-string">'~/.pg_chameleon/logs/'</span></span> log_dest: file log_level: info log_days_keep: <span class="hljs-number"><span class="hljs-number">10</span></span> rollbar_key: <span class="hljs-string"><span class="hljs-string">''</span></span> rollbar_env: <span class="hljs-string"><span class="hljs-string">''</span></span> # type_override allows the user to <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> type conversion into a different one. type_override: <span class="hljs-string"><span class="hljs-string">"tinyint(1)"</span></span>: override_to: boolean override_tables: - <span class="hljs-string"><span class="hljs-string">"*"</span></span> #postgres destination connection pg_conn: host: <span class="hljs-string"><span class="hljs-string">"localhost"</span></span> port: <span class="hljs-string"><span class="hljs-string">"5432"</span></span> user: <span class="hljs-string"><span class="hljs-string">"usr_replica"</span></span> password: <span class="hljs-string"><span class="hljs-string">"secret"</span></span> database: <span class="hljs-string"><span class="hljs-string">"db_replica"</span></span> charset: <span class="hljs-string"><span class="hljs-string">"utf8"</span></span> sources: mysql: db_conn: host: <span class="hljs-string"><span class="hljs-string">"localhost"</span></span> port: <span class="hljs-string"><span class="hljs-string">"3306"</span></span> user: <span class="hljs-string"><span class="hljs-string">"usr_replica"</span></span> password: <span class="hljs-string"><span class="hljs-string">"Secret123!"</span></span> charset: <span class="hljs-string"><span class="hljs-string">'utf8'</span></span> connect_timeout: <span class="hljs-number"><span class="hljs-number">10</span></span> schema_mappings: sakila: sch_sakila limit_tables: # - delphis_mediterranea.foo skip_tables: # - delphis_mediterranea.bar grant_select_to: - usr_readonly lock_timeout: <span class="hljs-string"><span class="hljs-string">"120s"</span></span> my_server_id: <span class="hljs-number"><span class="hljs-number">100</span></span> replica_batch_size: <span class="hljs-number"><span class="hljs-number">10000</span></span> replay_max_rows: <span class="hljs-number"><span class="hljs-number">10000</span></span> batch_retention: <span class="hljs-string"><span class="hljs-string">'1 day'</span></span> copy_max_memory: <span class="hljs-string"><span class="hljs-string">"300M"</span></span> copy_mode: <span class="hljs-string"><span class="hljs-string">'file'</span></span> out_dir: /tmp sleep_loop: <span class="hljs-number"><span class="hljs-number">1</span></span> on_error_replay: <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> on_error_read: <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> auto_maintenance: <span class="hljs-string"><span class="hljs-string">"disabled"</span></span> gtid_enable: No type: mysql skip_events: insert: # - delphis_mediterranea.foo #skips inserts on the table delphis_mediterranea.foo delete: # - delphis_mediterranea #skips deletes on schema delphis_mediterranea update:</code> </pre> <br><p>  <b>Schritt 3.</b> Erstellen Sie ein Replikat (Zieldatenbank) mit dem folgenden Befehl: </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> chameleon create_replica_schema -<span class="hljs-literal"><span class="hljs-literal">-debug</span></span></code> </pre> <br><p>  Der obige Befehl erstellt ein Schema und neun Tabellen in der PostgreSQL-Datenbank, die in der Datei .pg_chameleon / configuration / default.yml angegeben ist.  Diese Tabellen sind erforderlich, um die Replikation von der Quellendatenbank zum Ziel zu steuern.  Das gleiche ist in der nächsten Zeitschrift zu sehen. </p><br><pre> <code class="hljs pgsql">db_replica=# \dn List <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">schemas</span></span> <span class="hljs-type"><span class="hljs-type">Name</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span> <span class="hljs-comment"><span class="hljs-comment">---------------+------------- public | postgres sch_chameleon | target_user (2 rows) db_replica=# \dt sch_chameleon.t_* List of relations Schema | Name | Type | Owner ---------------+------------------+-------+------------- sch_chameleon | t_batch_events | table | target_user sch_chameleon | t_discarded_rows | table | target_user sch_chameleon | t_error_log | table | target_user sch_chameleon | t_last_received | table | target_user sch_chameleon | t_last_replayed | table | target_user sch_chameleon | t_log_replica | table | target_user sch_chameleon | t_replica_batch | table | target_user sch_chameleon | t_replica_tables | table | target_user sch_chameleon | t_sources | table | target_user (9 rows)</span></span></code> </pre> <br><p>  <b>Schritt 4.</b> Fügen Sie die Quelldatenbankdaten mit dem folgenden Befehl zu pg_chameleon hinzu.  Geben Sie den Namen der Quellendatenbank an, wie in der Konfigurationsdatei angegeben.  In diesem Beispiel lautet der Name der Quellendatenbank mysql, und das Ziel ist die Postgres-Datenbank, die als pg_conn definiert ist. </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> chameleon add_source -<span class="hljs-literal"><span class="hljs-literal">-config</span></span> default -<span class="hljs-literal"><span class="hljs-literal">-source</span></span> mysql -<span class="hljs-literal"><span class="hljs-literal">-debug</span></span></code> </pre> <br><p>  Nach dem Ausführen des angegebenen Befehls sehen Sie, dass die Daten der ursprünglichen Datenbank zur Tabelle t_sources hinzugefügt werden. </p><br><pre> <code class="hljs smalltalk">db_replica=# select * from sch_chameleon.t_sources; -[ <span class="hljs-type"><span class="hljs-type">RECORD</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> ]-------+---------------------------------------------- i_id_source | <span class="hljs-number"><span class="hljs-number">1</span></span> t_source | mysql jsb_schema_mappings | {<span class="hljs-comment"><span class="hljs-comment">"sakila"</span></span>: <span class="hljs-comment"><span class="hljs-comment">"sch_sakila"</span></span>} enm_status | ready t_binlog_name | i_binlog_position | b_consistent | t b_paused | f b_maintenance | f ts_last_maintenance | enm_source_type | mysql v_log_table | {t_log_replica_mysql_1,t_log_replica_mysql_2} <span class="hljs-string"><span class="hljs-string">$ </span></span>chameleon show_status --config default <span class="hljs-type"><span class="hljs-type">Source</span></span> id <span class="hljs-type"><span class="hljs-type">Source</span></span> name <span class="hljs-type"><span class="hljs-type">Type</span></span> <span class="hljs-type"><span class="hljs-type">Status</span></span> <span class="hljs-type"><span class="hljs-type">Consistent</span></span> <span class="hljs-type"><span class="hljs-type">Read</span></span> lag <span class="hljs-type"><span class="hljs-type">Last</span></span> read <span class="hljs-type"><span class="hljs-type">Replay</span></span> lag <span class="hljs-type"><span class="hljs-type">Last</span></span> replay ----------- ------------- ------ -------- ------------ ---------- ----------- ------------ ------------- <span class="hljs-number"><span class="hljs-number">1</span></span> mysql mysql ready <span class="hljs-type"><span class="hljs-type">Yes</span></span> <span class="hljs-type"><span class="hljs-type">N</span></span>/<span class="hljs-type"><span class="hljs-type">AN</span></span>/<span class="hljs-type"><span class="hljs-type">A</span></span></code> </pre> <br><p>  <b>Schritt 5.</b> Initialisieren Sie das Replikat (Zieldatenbank) mit dem folgenden Befehl.  Geben Sie die Quellendatenbank an, aus der die Änderungen in die PostgreSQL-Datenbank repliziert werden. </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> chameleon init_replica -<span class="hljs-literal"><span class="hljs-literal">-config</span></span> default -<span class="hljs-literal"><span class="hljs-literal">-source</span></span> mysql -<span class="hljs-literal"><span class="hljs-literal">-debug</span></span></code> </pre> <br><p>  Die Initialisierung umfasst die folgenden Aufgaben auf dem MySQL-Server (Quelle). </p><br><ol><li>  Leeren Sie den Tabellencache und setzen Sie die schreibgeschützte Sperre </li><li>  Holen Sie sich die Koordinaten der Quellendatenbank </li><li>  Daten kopieren </li><li>  Entsperren </li></ol><br><p>  Der obige Befehl erstellt automatisch das Schema der Postgres-Zieldatenbank. <br>  In der Datei default.yml haben wir die folgenden Schemazuordnungen (schema_mappings) erwähnt. </p><br><pre> <code class="hljs">schema_mappings: sakila: sch_sakila</code> </pre> <br><p>  In der Zieldatenbank db_replica wurde jetzt ein neues Scott-Schema erstellt. </p><br><pre> <code class="hljs pgsql">db_replica=# \dn List <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">schemas</span></span> <span class="hljs-type"><span class="hljs-type">Name</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span> <span class="hljs-comment"><span class="hljs-comment">---------------+------------- public | postgres sch_chameleon | usr_replica sch_sakila | usr_replica (3 rows)</span></span></code> </pre> <br><p>  <b>Schritt 6.</b> Starten Sie nun die Replikation mit dem folgenden Befehl. </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> chameleon start_replica -<span class="hljs-literal"><span class="hljs-literal">-config</span></span> default -<span class="hljs-literal"><span class="hljs-literal">-source</span></span> mysql</code> </pre> <br><p>  <b>Schritt 7.</b> Überprüfen Sie den Replikationsstatus und die Fehler mit den folgenden Befehlen. </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> chameleon show_status -<span class="hljs-literal"><span class="hljs-literal">-config</span></span> default <span class="hljs-variable"><span class="hljs-variable">$</span></span> chameleon show_errors</code> </pre> <br><p>  So sieht der Replikationsstatus aus: </p><br><pre> <code class="hljs delphi">$ chameleon show_status --source mysql Source id Source <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> Status Consistent <span class="hljs-keyword"><span class="hljs-keyword">Read</span></span> lag Last <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> Replay lag Last replay ----------- ------------- ------ -------- ------------ ---------- ----------- ------------ ------------- <span class="hljs-number"><span class="hljs-number">1</span></span> mysql mysql running No N/AN/A == Schema mappings == Origin schema Destination schema --------------- -------------------- sakila sch_sakila == Replica status == --------------------- --- Tables <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> replicated <span class="hljs-number"><span class="hljs-number">0</span></span> Tables replicated <span class="hljs-number"><span class="hljs-number">17</span></span> All tables <span class="hljs-number"><span class="hljs-number">17</span></span> Last maintenance N/A Next maintenance N/A Replayed rows Replayed DDL Skipped rows</code> </pre> <br><p>  Jetzt können Sie sehen, dass die Änderungen ständig von der MySQL-Datenbank in die PostgreSQL-Datenbank repliziert werden. </p><br><p>  <b>Schritt 8.</b> Zur Überprüfung können Sie einen Datensatz in die MySQL-Datenbanktabelle einfügen, die wir erstellt haben, um die Replikation in der Postgres-Datenbank zu überprüfen. </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> mysql <span class="hljs-literal"><span class="hljs-literal">-u</span></span> root <span class="hljs-literal"><span class="hljs-literal">-pSecret123</span></span>! <span class="hljs-literal"><span class="hljs-literal">-e</span></span> <span class="hljs-string"><span class="hljs-string">"INSERT INTO sakila.emp VALUES (1,'avinash','vallarapu')"</span></span> mysql: [<span class="hljs-type"><span class="hljs-type">Warning</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">Using</span></span> a password on the <span class="hljs-keyword"><span class="hljs-keyword">command</span></span> line interface can be insecure. $ psql -d db_replica -c <span class="hljs-string"><span class="hljs-string">"select * from sch_sakila.emp"</span></span> id | first_name | last_name ----+------------+----------- 1 | avinash | vallarapu (1 row)</code> </pre> <br><p>  Aus dem obigen Protokoll ist ersichtlich, dass der in die MySQL-Tabelle eingefügte Datensatz in die Tabelle in der Postgres-Datenbank repliziert wurde. </p><br><p>  Sie können der Postgres-Zieldatenbank auch mehrere Quellreplikationsdatenbanken hinzufügen. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><strong>Link</strong></a> </p><br><p>  In dieser Dokumentation erfahren Sie mehr über die vielen zusätzlichen Funktionen von pg_chameleon. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de425705/">https://habr.com/ru/post/de425705/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de425693/index.html">Suche VPS 5 Jahre! 70 Hoster gewähren Rabatte von 10 bis 80%</a></li>
<li><a href="../de425695/index.html">CI- und CD-Battle Talks, Orchestration und OpenStack Secrets</a></li>
<li><a href="../de425697/index.html">KotlinConf 2018 - Keynote und erste Videos</a></li>
<li><a href="../de425701/index.html">IoT Security Week 38: Schwachstellen in MikroTik-, D-Link- und TP-Link-Routern</a></li>
<li><a href="../de425703/index.html">Kafka bei Wargaming: Blitz</a></li>
<li><a href="../de425707/index.html">Benachrichtigungssystem von der Konsole zum Telegramm</a></li>
<li><a href="../de425709/index.html">Wir haben ein Memo für die Chinesen gemacht, die zu Ihnen gekommen sind</a></li>
<li><a href="../de425711/index.html">Nicht übereinstimmender Leitungsverlust</a></li>
<li><a href="../de425713/index.html">Integration der HTML-Engine in native Windows-Anwendungen - Auswahl und Architektur</a></li>
<li><a href="../de425715/index.html">Bildungsprogramm in Chemie: Säurewechselung von Mikroschaltungen (wie man einen Kristall einer Mikroschaltung für die anschließende Fotografie freilegt)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>