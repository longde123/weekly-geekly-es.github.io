<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï∫üèº üïå ‚òÇÔ∏è Desenvolvimento de dispositivos inteligentes usando o exemplo de um controlador de piso aquecido no ESP8266 üíáüèº üßòüèæ üßõüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quero compartilhar minha experi√™ncia no desenvolvimento de um dispositivo inteligente. Nesta publica√ß√£o, descreverei o hardware (brevemente) e o softw...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Desenvolvimento de dispositivos inteligentes usando o exemplo de um controlador de piso aquecido no ESP8266</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/412889/">  Quero compartilhar minha experi√™ncia no desenvolvimento de um dispositivo inteligente.  Nesta publica√ß√£o, descreverei o hardware (brevemente) e o software (em mais detalhes). <br><br>  O controlador √© projetado para analisar as leituras dos sensores (com e sem fio) e manter a temperatura definida (incluindo o cronograma, incluindo os dias da semana) em cada zona individual, ligando / desligando a caldeira e controlando os circuitos de aquecimento do piso de √°gua usando as cabe√ßas t√©rmicas no coletor. <br><a name="habracut"></a><br><h2>  Hardware </h2><br>  Como controlador, ESP8266 (WeMos D1 mini) foi selecionado, como  tem wifi a bordo.  Em vez do ESP8266, qualquer outro controlador ou microcomputador pode ser usado - as id√©ias gerais permanecer√£o inalteradas, o principal √© que um servidor WEB com suporte para soquetes WEB possa ser implantado no sistema selecionado.  Os seguintes itens tamb√©m foram utilizados no projeto: <br><br><ul><li>  RTC: DS3231 - √© necess√°rio determinar o dia da semana e a hora atual.  O projeto foi concebido como um dispositivo independente que pode funcionar sem a Internet; portanto, o NTP n√£o √© adequado. </li><li>  Sensores de temperatura sem fio: NoName, 433MHz, da esta√ß√£o meteorol√≥gica chinesa - uma solu√ß√£o pronta para usar, eles funcionam com baterias.  Do que mais voc√™ precisa?  Mas √© necess√°rio que o per√≠odo de transfer√™ncia de dados n√£o seja fixo.  O problema √© que o per√≠odo de transmiss√£o √© de 35 segundos e n√£o nada muito.  E h√° situa√ß√µes em que os sinais de dois sensores se sobrep√µem.  Nesse caso, um ou dois sensores ficam fora do sistema por um tempo.  O problema pode ser resolvido usando sensores semelhantes, nos quais a troca de canal tamb√©m altera o per√≠odo de transmiss√£o de dados. </li><li>  Receptor 433MHz: Rxb6 - Revis√µes da Internet e experi√™ncia pessoal n√£o s√£o um receptor ruim. </li><li>  Sensores de temperatura com fio: DS18B20 - muito conveniente, pois voc√™ n√£o precisa conhecer o n√∫mero de sensores com anteced√™ncia. </li><li>  Mestre do barramento 1Wire: DS2482-100 - O protocolo 1Wire √© muito sens√≠vel aos tempos, portanto, todas as implementa√ß√µes do mestre do barramento de programa usam atraso, o que n√£o √© muito bom para multitarefa.  Usando esse chip, voc√™ pode tirar proveito do barramento 1Wire e se livrar de suas defici√™ncias transmitindo 1Wire &lt;-&gt; i2c.  O protocolo i2c possui uma linha de sincroniza√ß√£o, devido √† qual n√£o √© cr√≠tico para hor√°rios e √© frequentemente implementado em hardware nos controladores. </li><li>  Temporizador de vigil√¢ncia: TPL5000DGST - o tempo de atividade cont√≠nuo n√£o √© t√£o importante para este projeto, no entanto, a acessibilidade √© muito importante.  O ESP8266 possui um timer de monitoramento interno.  Mas, como a pr√°tica demonstrou, algumas vezes ainda existem situa√ß√µes em que ela n√£o consegue lidar e o sistema congela.  Um cron√¥metro externo de vigil√¢ncia de hardware foi projetado para lidar com situa√ß√µes de emerg√™ncia.  Configurado para um atraso de 64 segundos.  Anexado √† perna TX - durante a opera√ß√£o, o sistema grava constantemente informa√ß√µes de depura√ß√£o no Serial e a falta de atividade por mais de um minuto indica um travamento do sistema. </li><li>  Expansor de porta: 74HC595 - o uso desse expansor requer quatro pernas do controlador - tr√™s para transmitir o estado e uma para que os rel√©s n√£o cliquem quando a energia √© aplicada.  Na pr√≥xima vez que usar o PCF8574 - o barramento i2c ainda ser√° usado, ou seja,  n√£o s√£o necess√°rias pernas adicionais do MCU e as sa√≠das 1 s√£o definidas quando a energia √© aplicada. </li><li>  M√≥dulo de rel√©: NoName, 8 canais, 5V - n√£o h√° nada a dizer, exceto que o rel√© √© ativado em um n√≠vel baixo nas entradas do m√≥dulo.  Rel√©s de estado s√≥lido n√£o s√£o permitidos neste projeto, pois  Os contatos da caldeira devem ser trocados por um contato seco - em geral, n√£o sei a tens√£o e a corrente direta ou alternada nos contatos. </li></ul><br><h2>  Sistema operacional </h2><br>  O sistema operacional √© todo o software que garante a operacionalidade do programa aplicativo.  O sistema operacional tamb√©m √© uma camada entre o hardware e o programa aplicativo, fornecendo uma interface de alto n√≠vel para acessar recursos de hardware.  No caso do ESP, os componentes do sistema operacional podem ser considerados: <br><br><h3>  Sistema de arquivos </h3><br>  O projeto usa SPIFFS, tudo parece ficar claro aqui, √© a maneira mais f√°cil.  Para facilitar o acesso externo aos arquivos no dispositivo, eu uso a biblioteca nailbuster / esp8266FTPServer. <br><br><h3>  Sistema de aloca√ß√£o de tempo da CPU </h3><br>  Essa √© uma das principais fun√ß√µes do sistema operacional e o ESP n√£o ser√° uma exce√ß√£o.  Para a execu√ß√£o paralela de v√°rios fluxos do algoritmo, o objeto global (singleton) Timers √© respons√°vel.  A classe √© bastante simples e fornece a seguinte funcionalidade: <br><br><ul><li>  Execu√ß√£o peri√≥dica de uma fun√ß√£o, com um determinado intervalo  Exemplo de inicializa√ß√£o do timer: <br><br><pre><code class="cpp hljs">Timers.add(doLoop, <span class="hljs-number"><span class="hljs-number">6000</span></span>, F(<span class="hljs-string"><span class="hljs-string">"OneWireSensorsClass::doLoop"</span></span>)); <span class="hljs-comment"><span class="hljs-comment">//   ‚Äì  </span></span></code> </pre> </li><li>  Uma √∫nica execu√ß√£o de uma fun√ß√£o ap√≥s um per√≠odo especificado.  Por exemplo, uma verifica√ß√£o atrasada das redes Wi-Fi √© realizada desta maneira: <br><br><pre> <code class="cpp hljs">Timers.once([]() { WiFi.scanNetworks(<span class="hljs-literal"><span class="hljs-literal">true</span></span>);}, <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> </li></ul><br>  Assim, a fun√ß√£o loop fica assim: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ ESP.wdtFeed(); Timers.doLoop(); CPULoadInfo.doLoop(); }</code> </pre><br>  Na pr√°tica, a fun√ß√£o loop cont√©m mais algumas linhas, que ser√£o descritas abaixo. <br>  Uma lista da classe Timers est√° anexada. <br><br><h3>  Contagem de tempo da CPU </h3><br>  Fun√ß√£o de servi√ßo que n√£o possui aplica√ß√£o pr√°tica.  No entanto, ela √©.  Implementado pelo CPULoadInfo singleton.  Quando o objeto √© inicializado, o n√∫mero de itera√ß√µes do loop vazio √© medido por um curto per√≠odo de tempo: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CPULoadInfoClass::init() { <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> currTime = millis(); <span class="hljs-comment"><span class="hljs-comment">//      1 while ((millis() - currTime) &lt; 10) { delay(0); MaxLoopsInSecond++; } MaxLoopsInSecond *= 100; }</span></span></code> </pre> <br>  Ent√£o, contamos o n√∫mero de chamadas de procedimento de loop por segundo, calculamos a carga do processador em porcentagem e salvamos os dados no buffer: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CPULoadInfoClass::doLoop() { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> prevTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> currTime = millis(); LoopsInSecond++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((currTime - prevTime) &gt; <span class="hljs-number"><span class="hljs-number">1000</span></span>) { memmove(CPULoadPercentHistory, &amp;CPULoadPercentHistory[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(CPULoadPercentHistory) - <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int8_t</span></span> load = ((MaxLoopsInSecond - LoopsInSecond) * <span class="hljs-number"><span class="hljs-number">100</span></span>) / MaxLoopsInSecond; CPULoadPercentHistory[<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(CPULoadPercentHistory) - <span class="hljs-number"><span class="hljs-number">1</span></span>] = load; prevTime = currTime; LoopsInSecond = <span class="hljs-number"><span class="hljs-number">0</span></span>; } }</code> </pre><br>  O uso dessa abordagem permite obter o mesmo uso do processador por cada thread individual (se voc√™ conectar esse subsistema √† classe Timers), mas como eu disse - n√£o vejo nenhuma aplica√ß√£o pr√°tica para isso. <br><br><h3>  Sistema de entrada / sa√≠da </h3><br>  Para se comunicar com o usu√°rio, as interfaces UART-USB e WEB s√£o usadas.  Penso no UART que n√£o preciso falar em detalhes.  A √∫nica coisa que vale a pena prestar aten√ß√£o √© por conveni√™ncia e compatibilidade com n√£o-ESP, a fun√ß√£o serialEvent () √© implementada: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ‚Ä¶ if (Serial.available()) serialEvent(); // ‚Ä¶ }</span></span></code> </pre><br>  Com a interface WEB, tudo √© muito mais interessante.  Dedicamos uma se√ß√£o separada a ele. <br><br><h3>  Interface WEB </h3><br>  No caso de dispositivos inteligentes, na minha opini√£o, a interface WEB √© a solu√ß√£o mais amig√°vel. <br><br>  Considero o uso de uma tela conectada ao dispositivo uma pr√°tica desatualizada - √© imposs√≠vel criar uma interface simples, conveniente e bonita ao usar uma tela pequena e um conjunto limitado de bot√µes. <br><br>  O uso de programas espec√≠ficos para controlar o dispositivo imp√µe restri√ß√µes ao usu√°rio, acrescenta a necessidade de desenvolver e dar suporte a esses programas e tamb√©m exige que o desenvolvedor cuide da entrega desses programas nos dispositivos terminais do usu√°rio.  De uma maneira boa, o aplicativo deve ser publicado nas lojas de aplicativos do Google, Apple, Windows e tamb√©m dispon√≠vel nos reposit√≥rios Linux na forma de pacotes deb e rpm - caso contr√°rio, o acesso √† interface do dispositivo pode ser dif√≠cil para alguma parte da audi√™ncia. <br><br>  O acesso √† interface WEB do dispositivo est√° dispon√≠vel em qualquer sistema operacional - Linux, Windows, Android, MacOS, na √°rea de trabalho, laptop, tablet, smartphone - apenas para ter um navegador.  Obviamente, o desenvolvedor da interface WEB precisa levar em considera√ß√£o os recursos de v√°rios dispositivos, mas isso diz respeito principalmente ao tamanho e √† resolu√ß√£o.  O acesso √† interface WEB de um dispositivo inteligente em uma casa / apartamento / chal√© √© facilmente fornecido de fora pela Internet - agora √© dif√≠cil imaginar uma casa / apartamento em que haja dispositivos inteligentes e nenhum roteador e a Internet, e no roteador esse acesso √© configurado em alguns cliques (para aqueles que completamente fora do t√≥pico, as palavras-chave ajudar√£o - ‚Äúencaminhamento de porta‚Äù e ‚ÄúDNS din√¢mico‚Äù).  No caso de uma resid√™ncia de ver√£o, o acesso pode ser fornecido usando um roteador 3G. <br><br>  Para implementar a interface WEB, √© necess√°rio um servidor WEB.  Estou usando a biblioteca me-no-dev / ESPAsyncWebServer.  Esta biblioteca fornece a seguinte funcionalidade: <br><br><ul><li>  Retorno de conte√∫do est√°tico, incluindo  com suporte √† compress√£o gzip.  Os diret√≥rios virtuais s√£o suportados, com a capacidade de especificar um arquivo principal (que geralmente √© index.htm) para cada diret√≥rio. </li><li>  Atribuindo fun√ß√µes de retorno de chamada a diferentes URLs com base no tipo de solicita√ß√£o (GET, POST, ...) </li><li>  Suporte para soquetes WEB na mesma porta (isso √© importante no encaminhamento de porta). </li><li>  Autoriza√ß√£o b√°sica.  Al√©m disso, a autoriza√ß√£o √© definida individualmente para cada URL.  Isso √© importante porque  por exemplo, o Google Chrome, ao criar um atalho de p√°gina na tela principal, solicita um √≠cone e um arquivo de manifesto e n√£o transfere dados de autoriza√ß√£o.  Portanto, alguns arquivos s√£o colocados em um diret√≥rio virtual e a autoriza√ß√£o √© desabilitada para este diret√≥rio. </li></ul><br><h3>  Sistema operacional de servi√ßos HTTP </h3><br>  No projeto atual, todas as configura√ß√µes do sistema operacional s√£o executadas usando servi√ßos HTTP.  O servi√ßo HTTP √© uma pequena funcionalidade independente de recupera√ß√£o / modifica√ß√£o de dados dispon√≠vel via HTTP.  Em seguida, considere uma lista desses servi√ßos. <br><br><h4>  Ajuda </h4><br>  A implementa√ß√£o de qualquer lista de comandos, acho certo come√ßar com a implementa√ß√£o da equipe HELP.  Abaixo est√° o bloco de inicializa√ß√£o do servidor WEB: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> HTTPserverClass::init() { <span class="hljs-comment"><span class="hljs-comment">//SERVER INIT help_info.concat(F("/'doc_hame.ext': load file from server. Allow methods: HTTP_GET\n")); AsyncStaticWebHandler&amp; handler = server.serveStatic("na/", SPIFFS, "na/"); serveStaticHandlerNA = &amp;handler; //       server.serveStatic("/", SPIFFS, "/"); //    //info //       help_info.concat(F("/info: get system info. Allow methods: HTTP_GET\n")); server.on("/info", HTTP_GET, handleInfo); ‚Ä¶ server.on("/help", HTTP_GET, [](AsyncWebServerRequest *request) { request-&gt;send(200, ContentTypesStrings[ContentTypes::text_plain], help_info.c_str()); }); //    setAuthentication(ConfigStore.getAdminName(), ConfigStore.getAdminPassword()); DefaultHeaders::Instance().addHeader("Access-Control-Allow-Origin", "*"); //  -  //   server.begin(); //       DEBUG_PRINT(F("HTTP server started")); }</span></span></code> </pre><br>  Por que preciso de um sistema de ajuda, acho que n√£o vale a pena dizer.  Alguns desenvolvedores adiam a implementa√ß√£o do sistema de ajuda para mais tarde, mas esse "mais tarde" geralmente n√£o ocorre.  √â muito mais f√°cil implement√°-lo no in√≠cio do projeto e complement√°-lo durante o desenvolvimento do projeto. <br>  No meu projeto, uma lista de servi√ßos poss√≠veis tamb√©m √© exibida com um erro 404 - a p√°gina n√£o foi encontrada.  Atualmente implementamos os seguintes servi√ßos: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://tc-demo.vehs.ru/help</a> <br><br><pre> <code class="hljs sql">/'doc_hame.ext': <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> server. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /info: <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> info. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> (eg: <span class="hljs-number"><span class="hljs-number">20140527</span></span>T123456). <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /uptime: <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> uptime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> (eg: <span class="hljs-number"><span class="hljs-number">123</span></span>D123456). <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /rtc: <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> RTC time. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET, HTTP_POST /<span class="hljs-keyword"><span class="hljs-keyword">list</span></span> ? [dir=...] &amp; [<span class="hljs-keyword"><span class="hljs-keyword">format</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-keyword"><span class="hljs-keyword">list</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> json. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /edit: edit files. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET, HTTP_PUT, HTTP_DELETE, HTTP_POST /wifi: edit wifi settings. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET, HTTP_POST /wifi-<span class="hljs-keyword"><span class="hljs-keyword">scan</span></span> ? [<span class="hljs-keyword"><span class="hljs-keyword">format</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> wifi <span class="hljs-keyword"><span class="hljs-keyword">list</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> json. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /wifi-info ? [<span class="hljs-keyword"><span class="hljs-keyword">format</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> wifi info <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> json. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /ap: edit soft ap settings. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET, HTTP_POST /<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: edit <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> settings. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET, HTTP_POST /<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>-info ? [<span class="hljs-keyword"><span class="hljs-keyword">format</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> info <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> json. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /<span class="hljs-keyword"><span class="hljs-keyword">update</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> flash. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET, HTTP_POST /restart: restart system. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET, HTTP_POST /ws: web socket url. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /<span class="hljs-keyword"><span class="hljs-keyword">help</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">list</span></span> <span class="hljs-keyword"><span class="hljs-keyword">allow</span></span> URLs. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET</code> </pre><br>  Como voc√™ pode ver, na lista de servi√ßos, n√£o h√° servi√ßos de aplicativos.  Todos os servi√ßos HTTP est√£o relacionados ao sistema operacional.  Cada servi√ßo executa uma pequena tarefa.  Al√©m disso, se o servi√ßo exigir a entrada de qualquer dado, GET, mediante solicita√ß√£o, retornar√° um formul√°rio de entrada minimalista: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> USE_RTC_CLOCK help_info.concat(F(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/rtc: set RTC time. Allow methods: HTTP_GET, HTTP_POST\n"</span></span></span><span class="hljs-meta">)); const char* urlNTP = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/rtc"</span></span></span><span class="hljs-meta">; server.on(urlNTP, HTTP_GET, [](AsyncWebServerRequest *request) { DEBUG_PRINT(F(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/rtc"</span></span></span><span class="hljs-meta">)); request-&gt;send(200, ContentTypesStrings[ContentTypes::text_html], String(F(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"&lt;head&gt;&lt;title&gt;RTC time&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;form method=\"post\" action=\"rtc\"&gt;&lt;input name=\"newtime\" length=\"15\" placeholder=\"yyyyMMddThhmmss\"&gt;&lt;button type=\"submit\"&gt;set&lt;/button&gt;&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;"</span></span></span><span class="hljs-meta">))); }); server.on(urlNTP, HTTP_POST, handleSetRTC_time); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// USE_RTC_CLOCK</span></span></span></span></code> </pre><br><img src="https://habrastorage.org/webt/cr/-6/na/cr-6napgtebfgiquecvuezhxqia.png"><br><br>  Posteriormente, este servi√ßo √© usado em uma interface mais bonita: <br><br><img src="https://habrastorage.org/webt/tt/mn/-o/ttmn-oyhy9v3lygwrk0jk2wzp2o.png"><br><br><h2>  Software de aplica√ß√£o </h2><br>  Finalmente chegamos ao ponto em que o sistema foi criado.  Ou seja - para a implementa√ß√£o da tarefa aplicada. <br><br>  Qualquer aplicativo deve receber os dados de origem, process√°-los e produzir o resultado.  Tamb√©m √© poss√≠vel que o sistema relate o estado atual. <br><br>  Os dados da fonte do controlador de piso radiante s√£o: <br><br><ul><li>  Dados do sensor - o sistema n√£o est√° vinculado a sensores espec√≠ficos.  Um identificador exclusivo √© gerado para cada sensor.  Para sensores de r√°dio, seu identificador √© preenchido com zeros a 16 bits; para sensores 1Wire, o CRC16 √© calculado com base em seu identificador interno e usado como identificador de sensor.  Assim, todos os sensores t√™m identificadores com um comprimento de 2 bytes. </li><li>  Dados sobre zonas de aquecimento - o n√∫mero de zonas n√£o √© fixo, o n√∫mero m√°ximo √© limitado pelo m√≥dulo de rel√© usado.  Dada essa limita√ß√£o, a interface WEB tamb√©m foi desenvolvida. </li><li>  Temperatura e cronograma alvo - tentei fazer as configura√ß√µes mais flex√≠veis, voc√™ pode criar v√°rios esquemas de aquecimento e at√© atribuir seu pr√≥prio esquema de configura√ß√µes a cada zona. </li></ul><br>  Portanto, h√° v√°rias configura√ß√µes que precisam ser definidas de alguma forma e h√° v√°rios par√¢metros que o sistema relata como o estado atual. <br>  Para comunica√ß√£o entre o controlador e o mundo externo, implementei um interpretador de comando que me permitiu implementar o controle do controlador e o recebimento de dados de status.  Os comandos s√£o transmitidos ao controlador em formato leg√≠vel por humanos e podem ser transmitidos por um soquete UART ou WEB (se desejar, voc√™ pode implementar suporte para outros protocolos, por exemplo, telnet). <br>  A linha de comando come√ßa com o caractere '#' e termina com um caractere nulo ou um caractere de nova linha.  Todos os comandos consistem em um nome de comando e um operando, separados por dois pontos.  Para alguns comandos, o operando √© opcional; nesse caso, os dois pontos e o operando n√£o s√£o especificados.  Os comandos em uma linha s√£o separados por v√≠rgula.  Por exemplo: <br><br><pre> <code class="hljs css"><span class="hljs-selector-id"><span class="hljs-selector-id">#ZonesInfo</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">SensorsInfo</span></span></code> </pre> <br>  E, √© claro, a lista de comandos come√ßa com o comando Ajuda, que exibe uma lista de todos os comandos v√°lidos (por conveni√™ncia, os comandos transmitidos come√ßam com '&gt;' em vez de '#'): <br><br><pre> <code class="hljs dos">&gt;<span class="hljs-built_in"><span class="hljs-built_in">help</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Help</span></span> SetZonesCount Zone SetName SetSensor ... LoadCfg SaveCfg #<span class="hljs-built_in"><span class="hljs-built_in">Cmd</span></span>:<span class="hljs-built_in"><span class="hljs-built_in">Help</span></span>,CmdRes:Ok</code> </pre> <br>  Um recurso da implementa√ß√£o do interpretador de comandos √© que as informa√ß√µes sobre o resultado da execu√ß√£o do comando tamb√©m s√£o emitidas na forma de um comando ou um conjunto de comandos: <br><br><pre> <code class="hljs css">&gt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">help</span></span> ‚Ä¶ <span class="hljs-selector-id"><span class="hljs-selector-id">#Cmd</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Help</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">CmdRes</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ok</span></span> &gt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">zone</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:123</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#Cmd</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Zone</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Value</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:123</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">CmdRes</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Error</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Error</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Zone</span></span> 123 <span class="hljs-selector-tag"><span class="hljs-selector-tag">not</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">in</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">range</span></span> 1<span class="hljs-selector-tag"><span class="hljs-selector-tag">-5</span></span> &gt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">SchemasInfo</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#SchemasCount</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:2</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#Schema</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Name</span></span>:,<span class="hljs-selector-tag"><span class="hljs-selector-tag">DOWs</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0b0000000</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#Schema</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:2</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Name</span></span>:,<span class="hljs-selector-tag"><span class="hljs-selector-tag">DOWs</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0b0000000</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#Cmd</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:SchemasInfo</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">CmdRes</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ok</span></span></code> </pre><br>  No lado do cliente WEB, tamb√©m √© implementado um shell que aceita esses comandos e os converte em uma visualiza√ß√£o gr√°fica.  Por exemplo: <br><br><pre> <code class="hljs css">&gt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">zonesInfo</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:3</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#Zone</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:3</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Name</span></span>:,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Sensor</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0x5680</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Schema</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">DeltaT</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:-20</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#Cmd</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:ZonesInfo</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">CmdRes</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ok</span></span></code> </pre> <br>  A interface WEB enviou uma solicita√ß√£o ao controlador sobre o n√∫mero de zona 3 e, em resposta, recebeu o nome da zona, o identificador do sensor associado √† zona, o identificador do circuito atribu√≠do √† zona e a corre√ß√£o de temperatura para a zona.  A concha n√£o entende n√∫meros fracion√°rios; portanto, a temperatura √© transmitida em d√©cimos de grau, ou seja,  12,3 graus √© 123 d√©cimos. <br><br>  A principal caracter√≠stica √© que o controlador responde a todos os clientes de uma s√≥ vez para qualquer comando, independentemente do m√©todo de inser√ß√£o do comando.  Isso permite exibir a altera√ß√£o de estado imediatamente em todas as sess√µes da interface WEB.  Porque  O principal transporte de troca entre o controlador e a interface WEB s√£o os soquetes WEB, ent√£o o controlador pode transmitir dados sem uma solicita√ß√£o, por exemplo, quando novos dados vierem dos sensores: <br><br><pre> <code class="hljs css"><span class="hljs-selector-id"><span class="hljs-selector-id">#sensor</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0x5A20</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">type</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:w433th</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">battery</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">button_tx</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">channel</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">temperature</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:228</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">humidity</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:34</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">uptime_label</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:130308243</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">time_label</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:20180521T235126</span></span></code> </pre> <br>  Ou, por exemplo, que essas zonas precisam ser atualizadas: <br><br><pre> <code class="hljs css"><span class="hljs-selector-id"><span class="hljs-selector-id">#Zone</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:2</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">TargetTemp</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:220</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">CurrentTemp</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:228</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Error</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ok</span></span></code> </pre><br>  A interface WEB do controlador √© baseada no uso de comandos de texto.  Em uma das guias da interface, h√° um terminal com o qual voc√™ pode inserir comandos em forma de texto.  Al√©m disso, essa guia, para fins de depura√ß√£o, permite descobrir quais comandos a interface WEB envia e recebe com v√°rias a√ß√µes do usu√°rio. <br><br>  O interpretador de comandos facilita a altera√ß√£o e o aumento da funcionalidade do dispositivo, alterando os comandos existentes e adicionando novos.  Ao mesmo tempo, a depura√ß√£o de um sistema desse tipo √© bastante simplificada, porque  a comunica√ß√£o com o controlador ocorre exclusivamente em uma linguagem leg√≠vel por humanos. <br><br><h2>  Conclus√£o </h2><br>  Usando uma abordagem semelhante, a saber: <br><br><ul><li>  Separa√ß√£o de software em sistema operacional e programa de aplica√ß√£o </li><li>  Implementando configura√ß√µes do sistema operacional na forma de servi√ßos HTTP minimalistas </li><li>  Separando a l√≥gica do sistema da apresenta√ß√£o de dados </li><li>  Usando protocolos de comunica√ß√£o leg√≠veis por humanos </li></ul><br>  permite criar solu√ß√µes compreens√≠veis para usu√°rios e desenvolvedores.  Tais solu√ß√µes s√£o f√°ceis de modificar.  Com base nessas solu√ß√µes, √© f√°cil criar novos dispositivos com uma l√≥gica completamente diferente, mas que funcionar√° com os mesmos princ√≠pios.  Voc√™ pode criar uma linha de dispositivos com o mesmo tipo de interface: <br><br><img src="https://habrastorage.org/webt/5b/mg/mh/5bmgmh1jpuzsrdjpreb6jw_yopy.png"><br><br>  Como voc√™ pode ver, neste projeto, apenas as tr√™s primeiras p√°ginas da interface est√£o diretamente relacionadas ao aplicativo, e as demais s√£o quase universais. <br><br>  Nesta publica√ß√£o, descrevo apenas minha opini√£o sobre a constru√ß√£o de dispositivos inteligentes e, em nenhum caso, afirmo ser a verdade suprema. <br><br>  Para quem esse t√≥pico √© interessante - escreva, talvez eu esteja errado sobre algo, mas talvez alguns detalhes fa√ßam sentido para descrev√™-lo em mais detalhes. <br><br>  O que aconteceu no final: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Fiasco.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">A hist√≥ria de uma IoT caseira</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt412889/">https://habr.com/ru/post/pt412889/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt412877/index.html">Rut√™nio (Ru) - o quarto elemento com propriedades ferromagn√©ticas √† temperatura ambiente</a></li>
<li><a href="../pt412879/index.html">Edi√ß√£o 24: Treinamento em TI - problemas e desafios atuais das principais empresas</a></li>
<li><a href="../pt412881/index.html">Bj√∂rn Straustrup: Problema com a programa√ß√£o</a></li>
<li><a href="../pt412885/index.html">Ci√™ncia patol√≥gica</a></li>
<li><a href="../pt412887/index.html">Resumo dos eventos de TI em junho</a></li>
<li><a href="../pt412891/index.html">E / S do Citrix XenServer 7.0 n√£o otimizada Agente de Gerenciamento n√£o instalado</a></li>
<li><a href="../pt412893/index.html">Para alcan√ßar um programador s√™nior em quatro anos: o m√©todo "Escola 21"</a></li>
<li><a href="../pt412895/index.html">Vesta Matveeva: a luta contra o cibercrime √© uma escolha moral</a></li>
<li><a href="../pt412897/index.html">Monitorando produtos Atlassian com Prometheus</a></li>
<li><a href="../pt412899/index.html">Leitura de fim de semana: 30 materiais sobre som, a hist√≥ria das marcas de √°udio e a ind√∫stria cinematogr√°fica</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>