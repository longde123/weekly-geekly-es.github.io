<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ“½ï¸ ğŸšŠ ğŸ§•ğŸ¾ ä¸ºä»€ä¹ˆLLVMå¯ä»¥è°ƒç”¨æ°¸ä¸è°ƒç”¨çš„å‡½æ•°ï¼Ÿ â—ï¸ ğŸ‘°ğŸ¾ ğŸŒ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æˆ‘ä¸åœ¨ä¹ä½ çš„é¾™è¯´ä»€ä¹ˆï¼Œè¿™æ˜¯ä¸€ä¸ªè°è¨€ã€‚ é¾™è¯´è°ã€‚ æ‚¨ä¸çŸ¥é“å¯¹æ–¹åœ¨ç­‰ä»€ä¹ˆã€‚ 

 é“é¾™ä¹‹å¥³è¿ˆå…‹å°”Â·æ–¯æ—ºå¨å…‹  æœ¬æ–‡åŸºäºKrister Walfridssonåšå®¢ä¸­çš„å¸–å­ï¼Œ â€œä¸ºä»€ä¹ˆæœªå®šä¹‰çš„è¡Œä¸ºå¯èƒ½è°ƒç”¨ä»æœªè°ƒç”¨çš„å‡½æ•°ï¼Ÿâ€ ã€‚ 

 æœ¬æ–‡å¾—å‡ºä¸€ä¸ªç®€å•çš„ç»“è®ºï¼šç¼–è¯‘å™¨ä¸­çš„æœªå®šä¹‰è¡Œä¸ºå¯ä»¥æ‰§è¡Œä»»ä½•æ“ä½œï¼Œç”šè‡³æ˜¯ç»å¯¹å‡º...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ä¸ºä»€ä¹ˆLLVMå¯ä»¥è°ƒç”¨æ°¸ä¸è°ƒç”¨çš„å‡½æ•°ï¼Ÿ</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/458442/"><blockquote>  <i>æˆ‘ä¸åœ¨ä¹ä½ çš„é¾™è¯´ä»€ä¹ˆï¼Œè¿™æ˜¯ä¸€ä¸ªè°è¨€ã€‚</i>  <i>é¾™è¯´è°ã€‚</i>  <i>æ‚¨ä¸çŸ¥é“å¯¹æ–¹åœ¨ç­‰ä»€ä¹ˆã€‚</i> <br><br> é“é¾™ä¹‹å¥³è¿ˆå…‹å°”Â·æ–¯æ—ºå¨å…‹ </blockquote> æœ¬æ–‡åŸºäºKrister Walfridssonåšå®¢ä¸­çš„å¸–å­ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">â€œä¸ºä»€ä¹ˆæœªå®šä¹‰çš„è¡Œä¸ºå¯èƒ½è°ƒç”¨ä»æœªè°ƒç”¨çš„å‡½æ•°ï¼Ÿâ€</a>  ã€‚ <br><br> æœ¬æ–‡å¾—å‡ºä¸€ä¸ªç®€å•çš„ç»“è®ºï¼šç¼–è¯‘å™¨ä¸­çš„æœªå®šä¹‰è¡Œä¸ºå¯ä»¥æ‰§è¡Œä»»ä½•æ“ä½œï¼Œç”šè‡³æ˜¯ç»å¯¹å‡ºä¹æ„æ–™çš„æ“ä½œã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ç ”ç©¶äº†æ­¤ä¼˜åŒ–å·¥ä½œçš„å†…éƒ¨æœºåˆ¶ã€‚ <br><a name="habracut"></a><br> ç®€è¦å›é¡¾ä¸€ä¸‹Waldfridssonçš„å¸–å­ï¼Œåœ¨ä¸‹é¢çš„æºä»£ç ä¸­ï¼Œä¸åº”ä»mainè°ƒç”¨EraseAllå‡½æ•°ï¼Œå¹¶ä¸”åœ¨ä½¿ç”¨-O0ç¼–è¯‘æ—¶å®é™…ä¸Šå¹¶æœªè°ƒç”¨å®ƒï¼Œä½†æ˜¯åœ¨ä¼˜åŒ–-O1åŠæ›´é«˜ç‰ˆæœ¬æ—¶çªç„¶è°ƒç”¨äº†è¯¥å‡½æ•°ã€‚ <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;cstdlib&gt; typedef int (*Function)(); static Function Do; static int EraseAll() { return system(â€œrm -rf /â€); } void NeverCalled() { Do = EraseAll; } int main() { return Do(); }</span></span></span></span></code> </pre> <br> ç¼–è¯‘å™¨å¦‚ä½•ä¼˜åŒ–å®ƒï¼Ÿ é¦–å…ˆï¼ŒDoæŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆä¸ºç©ºï¼Œå› ä¸ºæ ¹æ®Cæ ‡å‡†ï¼Œç¨‹åºå¯åŠ¨æ—¶æ‰€æœ‰å…¨å±€å˜é‡çš„å€¼å‡ä¸ºé›¶ã€‚ <br><br><img src="https://habrastorage.org/webt/5i/k5/s0/5ik5s0xohytqkbqnw2exo1on1jc.jpeg"><br><br> è¯¥ç¨‹åºå°†å°è¯•å–æ¶ˆå¼•ç”¨DoæŒ‡é’ˆå¹¶è°ƒç”¨åˆ†é…çš„å‡½æ•°ã€‚ ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬å°è¯•å–æ¶ˆå¼•ç”¨ç©ºæŒ‡é’ˆï¼Œåˆ™æ ‡å‡†ä¼šè¯´å®ƒæ˜¯UBï¼Œæœªå®šä¹‰è¡Œä¸ºã€‚ é€šå¸¸ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ä¸è¿›è¡Œä¼˜åŒ–çš„æƒ…å†µä¸‹ä½¿ç”¨-O0é€‰é¡¹è¿›è¡Œç¼–è¯‘ï¼Œåˆ™ä¼šå‡ºç°Segmentation Faultï¼ˆåœ¨Linuxä¸­ï¼‰ã€‚ ä½†æ˜¯æ ‡å‡†è¯´ï¼Œå¯¹äºUBï¼Œç¨‹åºå¯ä»¥åšä»»ä½•äº‹æƒ…ã€‚ <br><br><img src="https://habrastorage.org/webt/ez/mq/bc/ezmqbco46shm4fqad2pbjyfhygw.jpeg"><br><br> ç¼–è¯‘å™¨ä½¿ç”¨æ ‡å‡†çš„æ­¤åŠŸèƒ½æ¥åˆ é™¤ä¸å¿…è¦çš„æ“ä½œã€‚ å¦‚æœç¼–è¯‘å™¨å‘ç°åœ¨ç¨‹åºä¸­çš„ä»»ä½•ä½ç½®éƒ½åˆ†é…äº†Doï¼Œåˆ™å®ƒå¯ä»¥åœ¨åˆå§‹åŒ–æ—¶é—´å†…åˆ†é…è¯¥å€¼ï¼Œè€Œä¸åœ¨è¿è¡Œæ—¶åˆ†é…å®ƒã€‚ å®é™…ä¸Šï¼Œæœ‰ä¸¤ç§å¯èƒ½æ€§ï¼š <br><br>  1.å¦‚æœåœ¨åˆ†é…æŒ‡é’ˆåå–æ¶ˆäº†æŒ‡é’ˆçš„å¼•ç”¨ï¼Œæˆ‘ä»¬å°†è·èƒœï¼Œå› ä¸ºç¼–è¯‘å™¨å¯ä»¥åˆ é™¤ä¸å¿…è¦çš„åˆ†é…ã€‚ <br><br>  2.å¦‚æœåœ¨åˆ†é…æŒ‡é’ˆä¹‹å‰å–æ¶ˆäº†æŒ‡é’ˆçš„å¼•ç”¨ï¼Œåˆ™æ ‡å‡†ä¼šè¯´å®ƒæ˜¯UBï¼Œå¹¶ä¸”è¡Œä¸ºå¯ä»¥æ˜¯ä»»ä½•è¡Œä¸ºï¼ŒåŒ…æ‹¬è°ƒç”¨ä»»æ„å‡½æ•°ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œè°ƒç”¨å‡½æ•°PrintHelloï¼ˆï¼‰ä¸æ ‡å‡†å¹¶ä¸çŸ›ç›¾ã€‚ <br><br> ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥æ ¹æ®æ ‡å‡†å°†ä¸€äº›éç©ºå€¼åˆ†é…ç»™æœªåˆå§‹åŒ–çš„æŒ‡é’ˆå¹¶è·å–è¡Œä¸ºã€‚ <br><br><img src="https://habrastorage.org/webt/se/th/yx/sethyxxeoe2wjcy941i8nxzj4gm.jpeg"><br><br> åœ¨ä»€ä¹ˆæ¡ä»¶ä¸‹å¯ä»¥è¿›è¡Œä¼˜åŒ–ï¼Ÿ æœ€åˆï¼Œç¨‹åºåº”åŒ…å«æ²¡æœ‰ä»»ä½•åˆå§‹å€¼æˆ–å…·æœ‰ç©ºå€¼ï¼ˆç›¸åŒï¼‰çš„å…¨å±€æŒ‡é’ˆã€‚ æ¥ä¸‹æ¥ï¼Œç¨‹åºåº”åœ¨æŒ‡é’ˆè§£å¼•ç”¨ä¹‹å‰æˆ–ä¹‹åçš„ä»»ä½•ä½ç½®ï¼ˆæ— è®ºåœ¨ä»»ä½•åœ°æ–¹ï¼‰ä¸ºè¯¥æŒ‡é’ˆåˆ†é…ä¸€ä¸ªå€¼ã€‚ åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæ ¹æœ¬æ²¡æœ‰å‘ç”Ÿåˆ†é…ï¼Œä½†æ˜¯ç¼–è¯‘å™¨çœ‹åˆ°è¯¥åˆ†é…å­˜åœ¨ã€‚ <br><br> å¦‚æœæ»¡è¶³è¿™äº›æ¡ä»¶ï¼Œåˆ™ç¼–è¯‘å™¨å¯ä»¥åˆ é™¤åˆ†é…å¹¶å°†å…¶æ›´æ”¹ä¸ºæŒ‡é’ˆçš„åˆå§‹å€¼ã€‚ <br><br> åœ¨ç»™å®šçš„ä»£ç ä¸­ï¼Œå˜é‡Doæ˜¯æŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆï¼Œå¹¶ä¸”å…¶åˆå§‹å€¼ä¸ºnullã€‚ å½“æˆ‘ä»¬å°è¯•åœ¨ç©ºæŒ‡é’ˆä¸Šè°ƒç”¨å‡½æ•°æ—¶ï¼Œç¨‹åºçš„è¡Œä¸ºæ˜¯ä¸ç¡®å®šçš„ï¼ˆæœªå®šä¹‰è¡Œä¸ºï¼ŒUBï¼‰ï¼Œå¹¶ä¸”ç¼–è¯‘å™¨æœ‰æƒæ ¹æ®éœ€è¦ä¼˜åŒ–UBã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ç«‹å³æ‰§è¡ŒDo = EraseAllåˆ†é…ã€‚ <br><br> ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ åœ¨æœ¬æ–‡çš„å…¶ä½™éƒ¨åˆ†ï¼ŒLLVMå’ŒClangç‰ˆæœ¬5.0.0ç”¨ä½œç¼–è¯‘å™¨ã€‚ ä»£ç ç¤ºä¾‹å¯è¿è¡Œï¼Œä¾›æ‚¨ç»ƒä¹ ã€‚ <br><br> é¦–å…ˆï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ä½¿ç”¨-O0å’Œ-O1ä¼˜åŒ–æ—¶çš„IRä»£ç ã€‚ è®©æˆ‘ä»¬ç¨å¾®æ›´æ”¹ä¸€ä¸‹æºä»£ç ä»¥ä½¿å…¶ä¸é‚£ä¹ˆç”ŸåŠ¨ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;cstdlib&gt; typedef int (*Function)(); static Function Do; static int PrintHello() { return printf("hello world\n"); } void NeverCalled() { Do = PrintHello; } int main() { return Do(); }</span></span></span></span></code> </pre> <br> ç„¶åï¼Œæˆ‘ä»¬ç”¨-O0ç¼–è¯‘IRä»£ç ï¼ˆä¸ºæ¸…æ™°èµ·è§ï¼Œçœç•¥äº†è°ƒè¯•ä¿¡æ¯ï¼‰ï¼š <br><br><pre> <code class="cpp hljs">; ModuleID = <span class="hljs-string"><span class="hljs-string">'test.c'</span></span> source_filename = <span class="hljs-string"><span class="hljs-string">"test.c"</span></span> target datalayout = <span class="hljs-string"><span class="hljs-string">"em:e-i64:64-f80:128-n8:16:32:64-S128"</span></span> target triple = <span class="hljs-string"><span class="hljs-string">"x86_64-unknown-linux-gnu"</span></span> @Do = internal global i32 (...)* null, align <span class="hljs-number"><span class="hljs-number">8</span></span> @.str = <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> unnamed_addr constant [<span class="hljs-number"><span class="hljs-number">13</span></span> x i8] c<span class="hljs-string"><span class="hljs-string">"hello world\0A\00"</span></span>, align <span class="hljs-number"><span class="hljs-number">1</span></span> ; Function Attrs: noinline nounwind optnone uwtable define <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> @NeverCalled() #<span class="hljs-number"><span class="hljs-number">0</span></span> { entry: <span class="hljs-function"><span class="hljs-function">store </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">i32</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bitcast</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i32 ()* @PrintHello to i32 (...)*)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">i32</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span><span class="hljs-function">** @Do, align 8 ret </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> } </span></span>; Function Attrs: noinline nounwind optnone uwtable define i32 @main() #<span class="hljs-number"><span class="hljs-number">0</span></span> { entry: %retval = alloca i32, align <span class="hljs-number"><span class="hljs-number">4</span></span> store i32 <span class="hljs-number"><span class="hljs-number">0</span></span>, i32* %retval, align <span class="hljs-number"><span class="hljs-number">4</span></span> %<span class="hljs-number"><span class="hljs-number">0</span></span> = load i32 (...)*, i32 (...)** @Do, align <span class="hljs-number"><span class="hljs-number">8</span></span> %call = call i32 (...) %<span class="hljs-number"><span class="hljs-number">0</span></span>() ret i32 %call } ; Function Attrs: noinline nounwind optnone uwtable define internal i32 @PrintHello() #<span class="hljs-number"><span class="hljs-number">0</span></span> { entry: %call = call i32 (i8*, ...) @<span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(i8* getelementptr inbounds ([<span class="hljs-number"><span class="hljs-number">13</span></span> x i8], [<span class="hljs-number"><span class="hljs-number">13</span></span> x i8]* @.str, i32 <span class="hljs-number"><span class="hljs-number">0</span></span>, i32 <span class="hljs-number"><span class="hljs-number">0</span></span>)) ret i32 %call } declare i32 @<span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(i8*, ...) #<span class="hljs-number"><span class="hljs-number">1</span></span> And with -O1: ; ModuleID = <span class="hljs-string"><span class="hljs-string">'test.ll'</span></span> source_filename = <span class="hljs-string"><span class="hljs-string">"test.c"</span></span> target datalayout = <span class="hljs-string"><span class="hljs-string">"em:e-i64:64-f80:128-n8:16:32:64-S128"</span></span> target triple = <span class="hljs-string"><span class="hljs-string">"x86_64-unknown-linux-gnu"</span></span> @.str = <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> unnamed_addr constant [<span class="hljs-number"><span class="hljs-number">13</span></span> x i8] c<span class="hljs-string"><span class="hljs-string">"hello world\0A\00"</span></span>, align <span class="hljs-number"><span class="hljs-number">1</span></span> ; Function Attrs: noinline nounwind optnone uwtable define <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> @NeverCalled() local_unnamed_addr #<span class="hljs-number"><span class="hljs-number">0</span></span> { entry: ret <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> } ; Function Attrs: noinline nounwind optnone uwtable define i32 @main() local_unnamed_addr #<span class="hljs-number"><span class="hljs-number">0</span></span> { entry: %retval = alloca i32, align <span class="hljs-number"><span class="hljs-number">4</span></span> store i32 <span class="hljs-number"><span class="hljs-number">0</span></span>, i32* %retval, align <span class="hljs-number"><span class="hljs-number">4</span></span> %call = call i32 (...) bitcast (i32 ()* @PrintHello to i32 (...)*)() ret i32 %call } ; Function Attrs: noinline nounwind optnone uwtable define internal i32 @PrintHello() unnamed_addr #<span class="hljs-number"><span class="hljs-number">0</span></span> { entry: %call = call i32 (i8*, ...) @<span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(i8* getelementptr inbounds ([<span class="hljs-number"><span class="hljs-number">13</span></span> x i8], [<span class="hljs-number"><span class="hljs-number">13</span></span> x i8]* @.str, i32 <span class="hljs-number"><span class="hljs-number">0</span></span>, i32 <span class="hljs-number"><span class="hljs-number">0</span></span>)) ret i32 %call } declare i32 @<span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(i8*, ...) local_unnamed_addr #<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br> å¦‚æœç¼–è¯‘å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå°†ç¡®è®¤åœ¨ç¬¬ä¸€ç§æƒ…å†µä¸‹å‘ç”Ÿåˆ†æ®µé”™è¯¯ï¼Œåœ¨ç¬¬äºŒç§æƒ…å†µä¸‹æ˜¾ç¤ºâ€œ hello worldâ€ã€‚ ä½¿ç”¨å…¶ä»–ä¼˜åŒ–é€‰é¡¹ï¼Œç»“æœä¸-O1ç›¸åŒã€‚ <br><br> ç°åœ¨ï¼Œæ‰¾åˆ°æ‰§è¡Œæ­¤ä¼˜åŒ–çš„ç¼–è¯‘å™¨ä»£ç éƒ¨åˆ†ã€‚  LLVMå‰ç«¯çš„æ¶æ„æœ¬èº«å¹¶ä¸å¤„ç†ä¼˜åŒ–ï¼Œå³cfeï¼ˆClang Frontendï¼‰å§‹ç»ˆç”Ÿæˆæ²¡æœ‰ä¼˜åŒ–çš„ä»£ç ï¼Œæˆ‘ä»¬åœ¨-O0çš„ç‰ˆæœ¬ä¸­çœ‹åˆ°ï¼Œæ‰€æœ‰ä¼˜åŒ–å‡ç”±optå®ç”¨ç¨‹åºæ‰§è¡Œï¼š <br><br><img src="https://habrastorage.org/webt/1o/c9/vt/1oc9vtkgl4qt2yxundzkjso_u0w.jpeg"><br><br> å¯¹äº-O1ï¼Œæ‰§è¡Œ186æ¬¡ä¼˜åŒ–éã€‚ <br><br> ä¸€éåˆä¸€éåœ°å…³é—­é€šè¡Œè¯ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†æ‰€éœ€çš„ä¸œè¥¿ï¼š <i>globalopt</i>é€šè¡Œè¯ã€‚ æˆ‘ä»¬åªèƒ½ä¿ç•™è¿™ä¸€ä¼˜åŒ–è¿‡ç¨‹ï¼Œå¹¶ç¡®ä¿å®ƒï¼ˆæ²¡æœ‰å…¶ä»–è¿‡ç¨‹ï¼‰ç”Ÿæˆæˆ‘ä»¬éœ€è¦çš„ä»£ç ã€‚ æºåœ¨æ–‡ä»¶/lib/Transforms/IPO/GlobalOpt.cppä¸­ã€‚ æ‚¨å¯ä»¥åœ¨LLVMå­˜å‚¨åº“ä¸­æŸ¥çœ‹æºä»£ç ã€‚ ä¸ºç®€æ´èµ·è§ï¼Œæˆ‘ä»…æä¾›äº†å¯¹äºç†è§£å…¶å·¥ä½œåŸç†å¾ˆé‡è¦çš„åŠŸèƒ½ã€‚ <br><br><img src="https://habrastorage.org/webt/4k/-g/nl/4k-gnlzr7e6573zeobjdcp91x5q.jpeg"><br><br> è¯¥å›¾ç‰‡è¡¨ç¤ºIRè¡¨ç¤ºçš„ç»“æ„ã€‚  LLVM IRè¡¨ç¤ºä¸­çš„ä»£ç å…·æœ‰å±‚æ¬¡ç»“æ„çº§åˆ«ï¼šæ¨¡å—ä»£è¡¨å±‚æ¬¡ç»“æ„çš„æœ€é«˜çº§åˆ«ï¼Œå¹¶ä¸”åŒ…æ‹¬æ‰€æœ‰å‡½æ•°å’Œå…¨å±€å¯¹è±¡ï¼Œä¾‹å¦‚å…¨å±€å˜é‡ã€‚ åŠŸèƒ½æ˜¯IRè¡¨ç¤ºçš„æœ€é‡è¦çº§åˆ«ï¼Œå¤§å¤šæ•°è¿‡ç¨‹éƒ½åœ¨æ­¤çº§åˆ«ä¸Šè¿›è¡Œã€‚ åŸºæœ¬å—æ˜¯ç¼–è¯‘å™¨ç†è®ºä¸­æœ€é‡è¦çš„æ¦‚å¿µã€‚ åŸºæœ¬å—ç”±æŒ‡ä»¤ç»„æˆï¼Œè¿™äº›æŒ‡ä»¤ä¸èƒ½ä»åŸºæœ¬å—çš„ä¸­é—´æˆ–åŸºæœ¬å—å†…éƒ¨è¿›è¡Œè·³è½¬ã€‚ åŸºæœ¬å—ä¹‹é—´çš„æ‰€æœ‰è½¬æ¢éƒ½åªèƒ½ä»åŸºæœ¬å—çš„æœ«å°¾åˆ°åŸºæœ¬å—çš„å¼€å§‹ï¼Œå¹¶ä¸”ä»åŸºæœ¬å—åˆ°ä¸­é—´å—çš„ä»»ä½•è·³è½¬éƒ½æ˜¯ä¸å¯èƒ½çš„ã€‚ æŒ‡ä»¤çº§åˆ«ä»£è¡¨LLVM IRä»£ç æŒ‡ä»¤ã€‚ è¿™ä¸æ˜¯å¤„ç†å™¨çš„æŒ‡ä»¤ï¼Œå®ƒæ˜¯æŸäº›å…·æœ‰æ— é™æ•°é‡çš„å¯„å­˜å™¨çš„éå¸¸é€šç”¨çš„è™šæ‹Ÿæœºçš„æŒ‡ä»¤ã€‚ <br><br><img src="https://habrastorage.org/webt/6y/dt/wn/6ydtwn5hajletngggvj27uzurls.png"><br><br> æ­¤å›¾æ˜¾ç¤ºäº†LLVMä¼ é€’çš„å±‚æ¬¡ç»“æ„ã€‚ å·¦ä¾§æ˜¾ç¤ºäº†å¤„ç†LLVM IRä»£ç çš„è¿‡ç¨‹ï¼Œå³ä¾§æ˜¾ç¤ºäº†å¤„ç†ç›®æ ‡æŒ‡ä»¤çš„è¿‡ç¨‹ã€‚ <br><br> æœ€åˆï¼Œå®ƒå®ç°runOnModuleæ–¹æ³•ï¼Œå³ï¼Œåœ¨å·¥ä½œæ—¶ï¼Œå®ƒä¼šçœ‹åˆ°å¹¶ä¼˜åŒ–æ•´ä¸ªæ¨¡å—ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿™å½“ç„¶æ˜¯åˆç†çš„ï¼‰ã€‚ æ‰§è¡Œä¼˜åŒ–çš„å‡½æ•°æ˜¯optimizeGlobalsInModuleï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">optimizeGlobalsInModule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( Module &amp;M, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> DataLayout &amp;DL, TargetLibraryInfo *TLI, function_ref&lt;dominatortree&gt; LookupDomTree)</span></span></span><span class="hljs-function"> </span></span>{ SmallSet&lt;<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> comdat=<span class="hljs-string"><span class="hljs-string">"Comdat"</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>=<span class="hljs-string"><span class="hljs-string">"8"</span></span>&gt; NotDiscardableComdats; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Changed = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> LocalChange = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (LocalChange) { LocalChange = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; NotDiscardableComdats.clear(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> GlobalVariable &amp;GV : M.globals()) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Comdat *C = GV.getComdat()) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!GV.isDiscardableIfUnused() || !GV.use_empty()) NotDiscardableComdats.insert(C); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Function &amp;F : M) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Comdat *C = F.getComdat()) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!F.isDefTriviallyDead()) NotDiscardableComdats.insert(C); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (GlobalAlias &amp;GA : M.aliases()) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Comdat *C = GA.getComdat()) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!GA.isDiscardableIfUnused() || !GA.use_empty()) NotDiscardableComdats.insert(C); <span class="hljs-comment"><span class="hljs-comment">// Delete functions that are trivially dead, ccc -&gt; fastcc LocalChange |= OptimizeFunctions(M, TLI, LookupDomTree, NotDiscardableComdats); // Optimize global_ctors list. LocalChange |= optimizeGlobalCtorsList(M, [&amp;](Function *F) { return EvaluateStaticConstructor(F, DL, TLI); }); // Optimize non-address-taken globals. LocalChange |= OptimizeGlobalVars(M, TLI, LookupDomTree, NotDiscardableComdats); // Resolve aliases, when possible. LocalChange |= OptimizeGlobalAliases(M, NotDiscardableComdats); // Try to remove trivial global destructors if they are not removed // already. Function *CXAAtExitFn = FindCXAAtExit(M, TLI); if (CXAAtExitFn) LocalChange |= OptimizeEmptyGlobalCXXDtors(CXAAtExitFn); Changed |= LocalChange; } // </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> Move all global ctors functions to the end of the module for code // layout. return Changed; }</span></span></code> </pre> <br> è®©æˆ‘ä»¬å°è¯•ç”¨è¯­è¨€æ¥æè¿°æ­¤åŠŸèƒ½çš„ä½œç”¨ã€‚ å¯¹äºæ¨¡å—ä¸­çš„æ¯ä¸ªå…¨å±€å˜é‡ï¼Œå®ƒéƒ½è¯·æ±‚Comdatå¯¹è±¡ã€‚ <br><br> ä»€ä¹ˆæ˜¯Comdatå¯¹è±¡ï¼Ÿ <br><br>  Comdatéƒ¨åˆ†æ˜¯å¯¹è±¡æ–‡ä»¶ä¸­æ”¾ç½®å¯¹è±¡çš„éƒ¨åˆ†ï¼Œå¯ä»¥åœ¨å…¶ä»–å¯¹è±¡æ–‡ä»¶ä¸­å¤åˆ¶è¿™äº›å¯¹è±¡ã€‚ æ¯ä¸ªå¯¹è±¡éƒ½æœ‰é“¾æ¥å™¨çš„ä¿¡æ¯ï¼ŒæŒ‡ç¤ºæ£€æµ‹åˆ°é‡å¤é¡¹æ—¶å¿…é¡»æ‰§è¡Œçš„æ“ä½œã€‚ é€‰é¡¹å¯ä»¥æ˜¯ï¼šä»»ä½•-æ‰§è¡Œä»»ä½•æ“ä½œï¼ŒExactMatch-é‡å¤é¡¹å¿…é¡»å®Œå…¨åŒ¹é…ï¼Œå¦åˆ™ä¼šå‘ç”Ÿé”™è¯¯ï¼Œæœ€å¤§-å–å€¼æœ€å¤§çš„å¯¹è±¡ï¼ŒNoDublicates-ä¸åº”é‡å¤ï¼ŒSameSize-é‡å¤é¡¹å¿…é¡»å…·æœ‰ç›¸åŒçš„å¤§å°ï¼Œå¦åˆ™ä¼šå‘ç”Ÿé”™è¯¯ã€‚ <br><br> åœ¨LLVMä¸­ï¼ŒComdatæ•°æ®ç”±æšä¸¾è¡¨ç¤ºï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> SelectionKind { Any, <span class="hljs-comment"><span class="hljs-comment">///&lt; The linker may choose any COMDAT. ExactMatch, ///&lt; The data referenced by the COMDAT must be the same. Largest, ///&lt; The linker will choose the largest COMDAT. NoDuplicates, ///&lt; No other Module may specify this COMDAT. SameSize, ///&lt; The data referenced by the COMDAT must be the same size. };</span></span></code> </pre> <br> è€ŒComdatç±»å®é™…ä¸Šä»£è¡¨ä¸€å¯¹ï¼ˆåç§°ï¼ŒSelectionKindï¼‰ã€‚  ï¼ˆå®é™…ä¸Šï¼Œä¸€åˆ‡éƒ½æ›´åŠ å¤æ‚ã€‚ï¼‰ç”±äºæŸç§åŸå› è€Œæ— æ³•åˆ é™¤çš„æ‰€æœ‰å˜é‡éƒ½æ”¾ç½®åœ¨ä¸€ç»„NotDiscardableComdatsä¸­ã€‚ ä½¿ç”¨å‡½æ•°å’Œå…¨å±€åˆ«åï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œç›¸åŒæ“ä½œ-æ— æ³•åˆ é™¤çš„å†…å®¹æ”¾ç½®åœ¨NotDiscardableComdatsä¸­ã€‚ ç„¶åï¼Œä¸ºå…¨å±€æ„é€ å‡½æ•°ï¼Œå…¨å±€å‡½æ•°ï¼Œå…¨å±€å˜é‡ï¼Œå…¨å±€åˆ«åå’Œå…¨å±€ææ„å‡½æ•°è°ƒç”¨å•ç‹¬çš„ä¼˜åŒ–å‡½æ•°ã€‚ ä¼˜åŒ–å°†ç»§ç»­å¾ªç¯ï¼Œç›´åˆ°æ²¡æœ‰æ‰§è¡Œä¼˜åŒ–ä¸ºæ­¢ã€‚ åœ¨å¾ªç¯çš„æ¯æ¬¡è¿­ä»£ä¸­ï¼ŒNotDiscardableComdatsçš„é›†åˆéƒ½è®¾ç½®ä¸ºé›¶ã€‚ <br><br> è®©æˆ‘ä»¬çœ‹çœ‹æµ‹è¯•æºä¸­åˆ—å‡ºçš„å¯¹è±¡æ˜¯ä»€ä¹ˆã€‚ <br><br> å…¨å±€å˜é‡ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-number"><span class="hljs-number">1.</span></span> @Do = internal global i32 (...)* null, align <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">2.</span></span> @.str = <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> unnamed_addr constant [<span class="hljs-number"><span class="hljs-number">13</span></span> x i8] c<span class="hljs-string"><span class="hljs-string">"hello world\0A\00"</span></span>, align <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  ï¼ˆç¨å¾®å‘å‰çœ‹ï¼Œæˆ‘å¯ä»¥è¯´ä¼˜åŒ–å™¨å°†åœ¨ç¬¬ä¸€æ¬¡è¿­ä»£æ—¶åˆ é™¤ç¬¬ä¸€ä¸ªå˜é‡ï¼‰ã€‚ <br> åŠŸèƒ½ï¼š <br><br><pre> <code class="cpp hljs">define <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> @NeverCalled() define i32 @main() define internal i32 @PrintHello() declare i32 @<span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(i8*, ...)</code> </pre> <br> è¯·æ³¨æ„ï¼Œä»…å£°æ˜äº†printfï¼Œä½†æœªå®šä¹‰ã€‚ <br><br> æ²¡æœ‰å…¨å±€åˆ«åã€‚ <br><br> è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¼˜åŒ–è¿‡ç¨‹çš„ç¤ºä¾‹ï¼Œå¹¶è€ƒè™‘ä¸€ä¸‹ç»“æœå¦‚ä½•ã€‚ å½“ç„¶ï¼Œå³ä½¿ä¸€æ¬¡åˆ†ææ‰€æœ‰ä¼˜åŒ–é€‰é¡¹ä¹Ÿæ˜¯ä¸€é¡¹è‰°å·¨çš„ä»»åŠ¡ï¼Œå› ä¸ºå®ƒæ¶‰åŠè®¸å¤šä¸åŒçš„ä¼˜åŒ–ç‰¹æ®Šæƒ…å†µã€‚ æˆ‘ä»¬å°†é›†ä¸­åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸Šï¼Œè€ƒè™‘å¯¹ç†è§£æ­¤ä¼˜åŒ–è¿‡ç¨‹çš„å·¥ä½œå¾ˆé‡è¦çš„é‚£äº›åŠŸèƒ½å’Œæ•°æ®ç»“æ„ã€‚ <br><br> æœ€åˆï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¼˜åŒ–å™¨è¿›è¡Œå„ç§æ— ç”¨çš„æ£€æŸ¥ï¼Œå¹¶è°ƒç”¨processInternalGlobalå‡½æ•°ï¼Œè¯¥å‡½æ•°å°è¯•ä¼˜åŒ–å…¨å±€å˜é‡ã€‚ è¿™ä¸ªå‡½æ•°ä¹Ÿå¾ˆå¤æ‚ï¼Œå¯ä»¥åšå¾ˆå¤šä¸åŒçš„äº‹æƒ…ï¼Œä½†æ˜¯æˆ‘ä»¬å¯¹ä¸€ä»¶äº‹å¾ˆæ„Ÿå…´è¶£ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GS.StoredType == GlobalStatus::StoredOnce &amp;&amp; GS.StoredOnceValue) { ... <span class="hljs-comment"><span class="hljs-comment">// We are trying to optimize global variables, about which it is known that they are assigned a value only once, except the initializing value. if (optimizeOnceStoredGlobal(GV, GS.StoredOnceValue, GS.Ordering, DL, TLI)) return true; ... }</span></span></code> </pre> <br> ä»GSç»“æ„ï¼ˆGlobalStatusï¼‰ä¸­æå–äº†ä¸ºå…¨å±€å˜é‡åˆ†é…çš„å€¼ä¸€æ¬¡ä¸”ä»…ä¸€æ¬¡çš„ä¿¡æ¯ã€‚ æ­¤ç»“æ„å¡«å……åœ¨è°ƒç”¨å‡½æ•°ä¸­ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processGlobal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GlobalValue &amp;GV, TargetLibraryInfo *TLI, function_ref&lt;dominatortree&gt; LookupDomTree)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GV.getName().startswith(<span class="hljs-string"><span class="hljs-string">"llvm."</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; GlobalStatus GS; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GlobalStatus::analyzeGlobal(&amp;GV, GS)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; ...</code> </pre> <br> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°äº†å¦ä¸€ä¸ªæœ‰è¶£çš„äº‹å®ï¼šåç§°ä»¥â€œ llvmâ€å¼€å¤´çš„å¯¹è±¡ã€‚ ä¸å—ä¼˜åŒ–ï¼ˆå› ä¸ºå®ƒä»¬æ˜¯llvmè¿è¡Œæ—¶çš„ç³»ç»Ÿè°ƒç”¨ï¼‰ã€‚ è€Œä¸”ï¼Œä»¥é˜²ä¸‡ä¸€ï¼ŒLLVM IRä¸­çš„å˜é‡åç§°å¯ä»¥åŒ…å«ç‚¹ï¼ˆç”šè‡³åŒ…æ‹¬ä¸€ä¸ªå‰ç¼€ä¸º@æˆ–ï¼…çš„ç‚¹ï¼‰ã€‚ å‡½æ•°analyticGlobalæ˜¯å¯¹LLVM APIçš„è°ƒç”¨ï¼Œæˆ‘ä»¬å°†ä¸è€ƒè™‘å…¶å†…éƒ¨å·¥ä½œã€‚ åº”è¯¥è¯¦ç»†æŸ¥çœ‹GlobalStatusçš„ç»“æ„ï¼Œå› ä¸ºå®ƒåŒ…å«æœ‰å…³ä¼˜åŒ–è¿‡ç¨‹çš„éå¸¸é‡è¦çš„ä¿¡æ¯ã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/// As we analyze each global, keep track of some information about it. If we /// find out that the address of the global is taken, none of this info will be /// accurate. struct GlobalStatus { /// True if the global's address is used in a comparison. bool IsCompared = false; /// True if the global is ever loaded. If the global isn't ever loaded it /// can be deleted. bool IsLoaded = false; /// Keep track of what stores to the global look like. enum StoredType { /// There is no store to this global. It can thus be marked constant. NotStored, /// This global is stored to, but the only thing stored is the constant it /// was initialized with. This is only tracked for scalar globals. InitializerStored, /// This global is stored to, but only its initializer and one other value /// is ever stored to it. If this global isStoredOnce, we track the value /// stored to it in StoredOnceValue below. This is only tracked for scalar /// globals. StoredOnce, /// This global is stored to by multiple values or something else that we /// cannot track. Stored } StoredType = NotStored; /// If only one value (besides the initializer constant) is ever stored to /// this global, keep track of what value it is. Value *StoredOnceValue = nullptr; ... };</span></span></code> </pre> <br> å€¼å¾—è§£é‡Šä¸ºä»€ä¹ˆâ€œå¦‚æœæˆ‘ä»¬å‘ç°å…¨å±€åœ°å€å·²è¢«ä½¿ç”¨ï¼Œé‚£ä¹ˆè¿™äº›ä¿¡æ¯éƒ½å°†ä¸å‡†ç¡®ã€‚â€ å®é™…ä¸Šï¼Œå¦‚æœæˆ‘ä»¬é‡‡ç”¨å…¨å±€å˜é‡çš„åœ°å€ï¼Œç„¶ååœ¨è¯¥åœ°å€ä¸Šå†™ä¸€äº›ä¸œè¥¿ï¼Œè€Œä¸æ˜¯æŒ‰åç§°å†™ä¸œè¥¿ï¼Œé‚£ä¹ˆè·Ÿè¸ªå®ƒå°†éå¸¸å›°éš¾ï¼Œæœ€å¥½ä¸è¿›è¡Œä¼˜åŒ–å°±ç›´æ¥ä¿ç•™è¿™äº›å˜é‡ã€‚ ã€‚ <br><br> å› æ­¤ï¼Œæˆ‘ä»¬è¿›å…¥äº†å‡½æ•°optimizeOnceStoredGlobalï¼Œå˜é‡ï¼ˆGVï¼‰å’Œå­˜å‚¨å€¼ï¼ˆStoredOnceValï¼‰ä¼ é€’ç»™è¯¥å‡½æ•°ã€‚ å®ƒä»¬æ˜¯ï¼š <br><br><pre> <code class="cpp hljs">@Do = internal unnamed_addr global i32 (...)* null, align <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-comment"><span class="hljs-comment">// the variable i32 (...)* bitcast (i32 ()* @PrintHello to i32 (...)*) // the value</span></span></code> </pre> <br> æ¥ä¸‹æ¥ï¼Œå¯¹äºè¯¥å€¼ï¼Œåˆ é™¤æ— å…³ç´§è¦çš„ä½å¹¿æ’­ï¼Œå¯¹äºå˜é‡ï¼Œæ£€æŸ¥ä»¥ä¸‹æ¡ä»¶ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GV-&gt;getInitializer()-&gt;getType()-&gt;isPointerTy() &amp;&amp; GV-&gt;getInitializer()-&gt;isNullValue()) { ...</code> </pre> <br> ä¹Ÿå°±æ˜¯è¯´ï¼Œå¿…é¡»ä½¿ç”¨ç©ºæŒ‡é’ˆåˆå§‹åŒ–å˜é‡ã€‚ å¦‚æœæ˜¯è¿™ç§æƒ…å†µï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªæ–°çš„SOVCå˜é‡ï¼Œè¯¥å˜é‡å¯¹åº”äºå¼ºåˆ¶è½¬æ¢ä¸ºGVç±»å‹çš„StoredOnceValçš„å€¼ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Constant *SOVC = dyn_cast&lt;constant&gt;(StoredOnceVal)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GV-&gt;getInitializer()-&gt;getType() != SOVC-&gt;getType()) SOVC = ConstantExpr::getBitCast(SOVC, GV-&gt;getInitializer()-&gt;getType());</code> </pre> <br> åœ¨è¿™é‡Œï¼ŒgetBitCastæ˜¯è¿”å›bitcastå‘½ä»¤çš„æ–¹æ³•ï¼Œè¯¥å‘½ä»¤ä»¥LLVM IRè¯­è¨€é”®å…¥ç±»å‹ã€‚ <br><br> ä¹‹åï¼Œå°†è°ƒç”¨å‡½æ•°OptimizeAwayTrappingUsesOfLoadsã€‚ å®ƒä¼ è¾“å…¨å±€å˜é‡GVå’Œå¸¸æ•°LVã€‚ <br><br> ç›´æ¥ä¼˜åŒ–ç”±åŠŸèƒ½OptimizeAwayTrappingUsesOfValueï¼ˆå€¼* Vï¼Œå¸¸æ•°* NewVï¼‰æ‰§è¡Œã€‚ <br><br> å¯¹äºå˜é‡çš„æ¯æ¬¡ä½¿ç”¨ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> UI = V-&gt;user_begin(), E = V-&gt;user_end(); UI != E; ) { Instruction *I = cast&lt;instruction&gt;(*UI++);</code> </pre> <br> å¦‚æœè¿™æ˜¯ä¸€ä¸ªLoadå‘½ä»¤ï¼Œåˆ™å°†å…¶æ“ä½œæ•°æ›¿æ¢ä¸ºæ–°å€¼ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (LoadInst *LI = dyn_cast&lt;loadinst&gt;(I)) { LI-&gt;setOperand(<span class="hljs-number"><span class="hljs-number">0</span></span>, NewV); Changed = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre> <br> å¦‚æœåœ¨å‡½æ•°è°ƒç”¨æˆ–è°ƒç”¨ä¸­ä½¿ç”¨äº†å˜é‡ï¼ˆè¿™æ­£æ˜¯æœ¬ä¾‹ä¸­å‘ç”Ÿçš„æƒ…å†µï¼‰ï¼Œè¯·åˆ›å»ºä¸€ä¸ªæ–°å‡½æ•°ï¼Œå°†å…¶å‚æ•°æ›¿æ¢ä¸ºæ–°å€¼ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isa&lt;callinst&gt;(I) || isa&lt;invokeinst&gt;(I)) { <span class="hljs-function"><span class="hljs-function">CallSite </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CS</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(I)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (CS.getCalledValue() == V) { <span class="hljs-comment"><span class="hljs-comment">// Calling through the pointer! Turn into a direct call, but be careful // that the pointer is not also being passed as an argument. CS.setCalledFunction(NewV); Changed = true; bool PassedAsArg = false; for (unsigned i = 0, e = CS.arg_size(); i != e; ++i) if (CS.getArgument(i) == V) { PassedAsArg = true; CS.setArgument(i, NewV); }</span></span></code> </pre> <br> è¯¥å‡½æ•°çš„æ‰€æœ‰å…¶ä»–å‚æ•°éƒ½å°†è¢«ç®€å•å¤åˆ¶ã€‚ <br><br> åŒæ ·ï¼Œä¸ºCastå’ŒGEPæŒ‡ä»¤æä¾›äº†ç±»ä¼¼çš„æ›¿æ¢ç®—æ³•ï¼Œä½†åœ¨æˆ‘ä»¬è¿™ç§æƒ…å†µä¸‹ä¸ä¼šå‘ç”Ÿã€‚ <br><br> è¿›ä¸€æ­¥çš„æ“ä½œå¦‚ä¸‹ï¼šæˆ‘ä»¬éå†äº†å…¨å±€å˜é‡çš„æ‰€æœ‰ä½¿ç”¨ï¼Œè¯•å›¾åˆ é™¤é™¤èµ‹å€¼å¤–çš„æ‰€æœ‰å†…å®¹ã€‚ å¦‚æœæˆåŠŸï¼Œåˆ™å¯ä»¥åˆ é™¤Doå˜é‡ã€‚ <br><br> å› æ­¤ï¼Œæˆ‘ä»¬åœ¨ä¸€ä¸ªç‰¹å®šç¤ºä¾‹ä¸Šç®€è¦å›é¡¾äº†ä¼˜åŒ–è¿‡ç¨‹LLVMçš„å·¥ä½œã€‚ åŸåˆ™ä¸Šï¼Œè¿™é‡Œæ²¡æœ‰ä»€ä¹ˆè¶…çº§å¤æ‚çš„ï¼Œä½†æ˜¯éœ€è¦æ›´ä»”ç»†çš„ç¼–ç¨‹æ‰èƒ½æä¾›å‘½ä»¤å’Œå˜é‡ç±»å‹çš„æ‰€æœ‰å¯èƒ½ç»„åˆã€‚ å½“ç„¶ï¼Œæ‰€æœ‰è¿™äº›éƒ½å¿…é¡»åŒ…å«åœ¨æµ‹è¯•ä¸­ã€‚ å­¦ä¹ LLVMä¼˜åŒ–å™¨çš„æºä»£ç å°†å¸®åŠ©æ‚¨ç¼–å†™ä¼˜åŒ–ç¨‹åºï¼Œä»è€Œä½¿æ‚¨å¯ä»¥é’ˆå¯¹æŸäº›ç‰¹å®šæƒ…å†µæ”¹è¿›ä»£ç ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN458442/">https://habr.com/ru/post/zh-CN458442/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN458428/index.html">Googleæ‰“å¼€robots.txtè§£æå™¨æºä»£ç </a></li>
<li><a href="../zh-CN458432/index.html">å°†å¤šä¸ªè½¯ä»¶åŒ…ç»„åˆæˆä¸€ä¸ªPythonåç§°ç©ºé—´</a></li>
<li><a href="../zh-CN458434/index.html">åŸ¹è®­Cisco 200-125 CCNA v3.0ã€‚ ç¬¬11å¤©ã€‚VLANåŸºç¡€çŸ¥è¯†</a></li>
<li><a href="../zh-CN458436/index.html">å¸¸è§çš„è®°å½•é”™è¯¯</a></li>
<li><a href="../zh-CN458440/index.html">å·¥ä½œæ—¥æŠ€æœ¯æ”¯æŒï¼šæœ‰å…³æ— æ³•ä¸ç”¨æˆ·è”ç³»æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆçš„æ•…äº‹</a></li>
<li><a href="../zh-CN458444/index.html">å¤å­£å±…æ°‘çš„äº’è”ç½‘ã€‚ ç¬¬4éƒ¨åˆ†ã€‚ä¸€å¼ SIMå¡å°±è¶³å¤Ÿäº†</a></li>
<li><a href="../zh-CN458446/index.html">è¶…å¤§è§„æ¨¡æ•°æ®ä¸­å¿ƒï¼šè°æ¥å»ºé€ å®ƒä»¬ä»¥åŠå®ƒä»¬è¦èŠ±å¤šå°‘é’±</a></li>
<li><a href="../zh-CN458450/index.html">é‡å­è®¡ç®—æœºçš„ç‰¹å¾</a></li>
<li><a href="../zh-CN458452/index.html">å¦‚ä½•é€šè¿‡æ‚è´§åº—çš„æ–¹å¼åˆ¶ä½œåŠå…¬å®¤å¨æˆ¿</a></li>
<li><a href="../zh-CN458454/index.html">Alexey Savvateevï¼šäº’è”ç½‘å’Œç¤¾äº¤ç½‘ç»œçš„æ¨¡å‹</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>