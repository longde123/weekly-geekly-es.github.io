<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèΩ‚Äçüé§ üí† üé™ Vom Parser des Python-Theaterplakats bis zum Telegrammbot. Teil 1 üë©‚Äçüè≠ üôèüèº üç¢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ich liebe Oper und Ballett wirklich, aber nicht wirklich - gib viel Geld f√ºr Tickets. Das t√§gliche Betrachten der Website des Theaters mit einem Druck...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Vom Parser des Python-Theaterplakats bis zum Telegrammbot. Teil 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/444460/"><img src="https://habrastorage.org/webt/en/ph/hi/enphhiao8qi4l5r9iao0vbrskhg.jpeg"><br><br>  Ich liebe Oper und Ballett wirklich, aber nicht wirklich - gib viel Geld f√ºr Tickets.  Das t√§gliche Betrachten der Website des Theaters mit einem Druck auf jeden Knopf war furchtbar m√ºhsam, und die pl√∂tzlich erscheinenden Tickets von 170 Rubel f√ºr Superz√ºge waren herzzerrei√üend. <br>  Um dieses Gesch√§ft zu automatisieren, wurde ein Skript angezeigt, das auf einem Poster ausgef√ºhrt wird und Informationen zu den g√ºnstigsten Tickets f√ºr den ausgew√§hlten Monat sammelt.  Anfragen aus der Reihe "geben eine Liste aller Opern im M√§rz auf der alten und neuen B√ºhne bis zu 1000 Rubel heraus."  Ein Freund lie√ü fallen: "Machst du keinen Telegramm-Bot?"  Das war nicht geplant, aber warum nicht.  Der Bot wurde geboren, obwohl er sich auf einem Heim-Laptop drehte. <br>  Dann wurde das Telegramm blockiert.  Die Idee, den Bot auf den funktionierenden Server zu schieben, ist geschmolzen, und das Interesse, die Funktionalit√§t in den Sinn zu bringen, ist verblasst.  Unter dem Strich spreche ich von Anfang an √ºber das Schicksal eines billigen Ticketdetektivs und dar√ºber, was ihm nach einem Jahr Einsatz passiert ist. <br><a name="habracut"></a><br><h3>  1. Der Ursprung der Idee und die Erkl√§rung des Problems <br></h3><br>  In der ersten Produktion hatte die ganze Geschichte eine Aufgabe: eine nach Preis gefilterte Liste von Auff√ºhrungen zu erstellen, um Zeit beim manuellen Betrachten jeder Auff√ºhrung des Posters zu sparen.  Das einzige Theater, dessen Plakat von Interesse war, war und ist das Mariinsky.  Pers√∂nliche Erfahrungen haben schnell gezeigt, dass die Budget- "Galerie" an zuf√§lligen Tagen f√ºr zuf√§llige Auff√ºhrungen ge√∂ffnet ist und schnell genug aufgekauft wird (wenn das Personal steht).  Um nichts zu verpassen, wird ein automatischer Sammler ben√∂tigt. <br><div class="spoiler">  <b class="spoiler_title">Art des Posters mit Schaltfl√§chen, die Sie manuell navigieren mussten</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/4fa/35a/13e/4fa35a13ede41a01443fbc3e91450d3c.jpg" alt="Bild"><br></div></div><br>  Ich wollte eine begrenzte Anzahl von Performances von Interesse f√ºr die Ausf√ºhrung des Skripts erhalten.  Das Hauptkriterium war, wie bereits erw√§hnt, der Preis des Tickets. <br>  Die Site-API und das Ticketsystem sind nicht √∂ffentlich verf√ºgbar, daher wurde (ohne weiteres) die Entscheidung getroffen, HTML-Seiten zu analysieren und die erforderlichen Tags herauszuholen.  √ñffnen Sie die Hauptleitung, dr√ºcken Sie F12 und studieren Sie die Struktur.  Es sah angemessen aus, so dass die Dinge schnell die erste Implementierung erreichten. <br>  Es ist klar, dass dieser Ansatz nicht auf andere Websites mit Postern skaliert werden kann und zusammenbricht, wenn sie sich entscheiden, die aktuelle Struktur zu √§ndern.  Wenn Leser Ideen haben, wie sie ohne API stabiler werden k√∂nnen, schreiben Sie in die Kommentare. <br><br><h3>  2. Die erste Implementierung.  Minimale Funktionalit√§t </h3><br>  Ich habe eine Implementierung mit Erfahrung mit Python entwickelt, um nur Aufgaben im Zusammenhang mit maschinellem Lernen zu l√∂sen.  Und es gab kein tiefes Verst√§ndnis f√ºr HTML und Webarchitektur (und es erschien nicht).  Deshalb wurde alles nach dem Prinzip gemacht, "wohin ich gehe, ich wei√ü, aber jetzt werden wir finden, wie ich gehen soll". <br>  F√ºr die ersten Entw√ºrfe dauerte es 4 Abendstunden und eine Einf√ºhrung in die Anfragen und Beautiful Soup 4-Module (nicht ohne die Hilfe eines guten <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikels</a> , danke an den Autor).  Um die Skizze fertig zu stellen - ein weiterer freier Tag.  Ich bin mir nicht ganz sicher, ob die Module in ihrem Segment am optimalsten sind, aber sie haben ihre aktuellen Anforderungen erf√ºllt.  Hier ist, was in der ersten Phase passiert ist. <br>  Welche Informationen und wo sie abgerufen werden m√ºssen, kann anhand der Struktur der Website verstanden werden.  Zun√§chst sammeln wir die Adressen der Einsendungen, die f√ºr den ausgew√§hlten Monat auf dem Poster stehen. <br><div class="spoiler">  <b class="spoiler_title">Durch die Struktur der Posterseite im Browser wird alles bequem hervorgehoben</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/3f8/142/fda/3f8142fdad0789bac8558d2f0481b021.jpg" alt="Bild"><br></div></div><br>  Auf der HTML-Seite m√ºssen wir die reinen URLs lesen und sie dann durchgehen und das Preisschild sehen.  So wird die Linkliste zusammengestellt. <br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> bs4 <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> BeautifulSoup <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_text</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(url)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># URL  html r = requests.get(url) text=r.text return text def get_items(text,top_name,class_name): """   html-  "" url-, ..  - .       top_name  class_name   -  &lt;a class="c_theatre2 c_chamber_halls" href="//tickets.mariinsky.ru/ru/performance/WWpGeDRORFUwUkRjME13/"&gt; &lt;/a&gt; """ soup = BeautifulSoup(text, "lxml") film_list = soup.find('div', {'class': top_name}) items = film_list.find_all('div', {'class': [class_name]}) dirty_link=[] for item in items: dirty_link.append(str(item.find('a'))) return dirty_link def get_links(dirty_list,start,end): # ""    URL- links=[] for row in dirty_list: if row!='None': i_beg=row.find(start) i_end=row.rfind(end) if i_beg!=-1 &amp; i_end!=-1: links.append(row[i_beg:i_end]) return links # ,    ,      num=int(input('    : ')) #URL  .      ,    =) url ='https://www.mariinsky.ru/ru/playbill/playbill/?year=2019&amp;month='+str(num) #    top_name='container content gr_top' class_name='t_button' start='tickets' end='/"&gt;' #  text=get_text(url) dirty_link=get_items(text,top_name,class_name) #   URL-,     links=get_links(dirty_link,start,end)</span></span></code> </pre> <br>  Nachdem ich die Struktur der Seite mit dem Kauf von Tickets zus√§tzlich zur Preisschwelle studiert hatte, beschloss ich, dem Benutzer die M√∂glichkeit zu geben, auch Folgendes zu w√§hlen: <br><br><ul><li>  Art der Auff√ºhrung (1 Oper, 2 Ballett, 3 Konzert, 4 Vortrag) </li><li>  Veranstaltungsort (1 alte B√ºhne, 2 neue B√ºhne, 3 Konzertsaal, 4 Kammers√§le) </li></ul><br>  Informationen werden √ºber die Konsole in einem numerischen Format eingegeben, wobei mehrere Nummern ausgew√§hlt werden k√∂nnen.  Diese Variabilit√§t wird durch die unterschiedlichen Preise f√ºr Oper und Ballett (Oper ist billiger) und den Wunsch bestimmt, ihre Listen getrennt zu betrachten. <br>  Das Ergebnis sind <b>4 Fragen und 4 Datenfilter</b> - Monat, Preisschwelle, Typ, Ort. <br><br>  Als n√§chstes gehen wir alle erhaltenen Links durch.  Wir machen get_text und suchen nach dem niedrigeren Preis daf√ºr und ziehen auch die zugeh√∂rigen Informationen heraus.  Aufgrund der Tatsache, dass Sie in jede URL schauen und sie in Text konvertieren m√ºssen, ist die Laufzeit des Programms nicht sofort.  Es w√§re sch√∂n zu optimieren, aber ich habe nicht dar√ºber nachgedacht, wie. <br>  Ich werde den Code selbst nicht geben, er wird etwas lang sein, aber mit Beautiful Soup 4 stimmt dort alles angemessen und "intuitiv". <br>  Wenn der Preis niedriger ist als der vom Benutzer angegebene und der Typort dem Satz entspricht, wird in der Konsole eine Meldung √ºber die Leistung angezeigt.  Es gab eine andere Option, um all dies in .xls zu speichern, aber es hat keine Wurzeln geschlagen.  Es ist bequemer, in die Konsole zu schauen und den Links sofort zu folgen, als in eine Datei zu st√∂bern. <br><img src="https://habrastorage.org/getpro/habr/post_images/f61/dd4/a76/f61dd4a7602bc435bfe445d32aa35c51.jpg" alt="Bild"><br><br>  Es kamen ungef√§hr 150 Codezeilen heraus.  In dieser Version mit den beschriebenen Mindestfunktionen ist das Skript lebendiger als alle lebenden und wird regelm√§√üig mit einem Zeitraum von einigen Tagen ausgef√ºhrt.  Alle anderen Modifikationen wurden entweder nicht abgeschlossen (die Ahle ist abgestorben) und sind daher inaktiv oder in Funktionen nicht vorteilhafter. <br><br><h3>  3. Erweiterung der Funktionalit√§t </h3><br>  In der zweiten Phase habe ich beschlossen, Preis√§nderungen zu verfolgen und Links zu interessierenden Leistungen in einer separaten Datei (genauer gesagt der URL zu diesen) zu speichern.  Erstens ist dies f√ºr Ballette relevant - sie sind sehr selten sehr billig und fallen nicht in die allgemeine Haushaltsfrage.  Aber von f√ºnftausend auf das Zweifache ist der R√ºckgang signifikant, besonders wenn die Leistung mit einer herausragenden Besetzung ist, und ich wollte es verfolgen. <br>  Dazu m√ºssen Sie zuerst die URLs f√ºr die Nachverfolgung hinzuf√ºgen, sie dann regelm√§√üig ‚Äûsch√ºtteln‚Äú und den neuen Preis mit dem alten vergleichen. <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add_new_URL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(user_id,perf_url)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#user_id ,        - WAITING_FILE = "waiting_list.csv" with open(WAITING_FILE, "a", newline="") as file: curent_url='https://'+perf_url text=get_text(curent_url) #      - , ,,   minP, name,date,typ,place=find_lowest(text) user = [str(user_id), perf_url,str(m)] writer = csv.writer(file) writer.writerow(user) def update_prices(): #        print(' ') WAITING_FILE = "waiting_list.csv" with open(WAITING_FILE, "r", newline="") as file: reader = csv.reader(file) gen=[] for row in reader: gen.append(list(row)) L=len(gen) lowest={} with open(WAITING_FILE, "w", newline="") as fl: writer = csv.writer(fl) for i in range(L): lowest[gen[i][1]]=gen[i][2] #   URL  for k in lowest.keys(): text=get_text('https://'+k) minP, name,date,typ,place=find_lowest(text) if minP==0: #     ,      "" minP=100000 if int(minP)&lt;int(lowest[k]): #   ,    lowest[k]=minP for i in range(L): if gen[i][1]==k: #  -  URL   gen[i][2]=str(minP) print('   '+k+'    '+str(minP)) writer.writerows(gen) add_new_URL('12345','tickets.mariinsky.ru/ru/performance/ZVRGZnRNbmd3VERsNU1R/') update_prices()</span></span></code> </pre> <br>  Die Preisaktualisierung wurde zu Beginn des Hauptskripts gestartet und nicht separat durchgef√ºhrt.  Vielleicht nicht so elegant wie wir m√∂chten, aber es l√∂st das Problem.  Die zweite zus√§tzliche Funktion war die √úberwachung des Preisverfalls f√ºr interessierende Leistungen. <br><br>  Dann wurde der Telegrammbot geboren, nicht so einfach, schnell, frech, aber immer noch geboren.  Um nicht alles zusammenzuf√ºgen, wird die Geschichte √ºber ihn (sowie √ºber nicht realisierte Ideen und den Versuch, dies mit der Website des Bolschoi-Theaters zu tun) im zweiten Teil des Artikels stehen. <br><br>  <b>ERGEBNIS: Die</b> Idee war ein Erfolg, die Benutzer sind zufrieden.  Es dauerte ein paar Wochenenden, um herauszufinden, wie man mit HTML-Seiten interagiert.  Gl√ºcklicherweise ist Python eine Sprache f√ºr fast alles und vorgefertigte Module helfen dabei, einen Nagel zu schlagen, ohne an die Physik des Hammers zu denken. <br><br>  Ich hoffe, dass der Fall f√ºr die Habrachianer n√ºtzlich sein wird und vielleicht wie ein magischer Pendel funktioniert, um endlich eine Wunschliste zu erstellen, die lange in meinem Kopf sitzt. <br><br>  <b>UPD:</b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Fortsetzung der Geschichte - Teil 2</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de444460/">https://habr.com/ru/post/de444460/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de444442/index.html">Jetson Nano: Nvidia Machine Board Single Board</a></li>
<li><a href="../de444444/index.html">Die besten Fehler unserer Konferenzen (Joker, JPoint, DotNext, Mobius, TechTrain usw.)</a></li>
<li><a href="../de444446/index.html">Erstellen einer modernen Webanwendung von Grund auf neu</a></li>
<li><a href="../de444448/index.html">Mirai Clone f√ºgt Dutzende neuer Exploits f√ºr gezielte IoT-Ger√§te f√ºr Unternehmen hinzu</a></li>
<li><a href="../de444456/index.html">Atari 65XE - USB-Tastatur</a></li>
<li><a href="../de444462/index.html">Testen des Samsung Galaxy S10 - Wann holen Smartphones Kameras ein?</a></li>
<li><a href="../de444464/index.html">Eine andere M√∂glichkeit, Ihr Bein mit std :: thread zu schie√üen</a></li>
<li><a href="../de444466/index.html">Leider sind alle Ihre Datenbanken im Besitz von Google. Google-Pr√§sentation auf der Game Development Conference 2019, Stadia Project</a></li>
<li><a href="../de444468/index.html">Nvidia Neural Network verwandelt einfache Skizzen in wundersch√∂ne Landschaften</a></li>
<li><a href="../de444470/index.html">20 Gewohnheiten f√ºr die Aufmerksamkeitshygiene: Umgang mit Technologie, aber nicht zulassen, dass sie sich Zeit und Aufmerksamkeit nehmen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>