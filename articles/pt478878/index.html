<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•ö üôèüèª üë©üèΩ‚Äçüé® O trecho de c√≥digo mais popular na hist√≥ria do StackOverflow tem um bug! üëë üêò ‚è©</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Um estudo recente, ‚ÄúUsando e atribuindo trechos de c√≥digo do Stack Overflow em projetos do GitHub‚Äù, subitamente descobriu que, na maioria das vezes, e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>O trecho de c√≥digo mais popular na hist√≥ria do StackOverflow tem um bug!</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/478878/">  Um estudo recente, <a href="https://doi.org/10.1007/s10664-018-9650-5" rel="nofollow">‚ÄúUsando e atribuindo trechos de c√≥digo do Stack Overflow em projetos do GitHub‚Äù,</a> subitamente descobriu que, na maioria das vezes, em projetos de c√≥digo aberto, minha <a href="https://stackoverflow.com/a/3758880/276052" rel="nofollow">resposta</a> foi escrita h√° quase dez anos.  Ironicamente, h√° um erro. <br><br><h2>  Era uma vez ... </h2><br>  Em 2010, eu estava sentado no meu escrit√≥rio e fazendo bobagens: eu me diverti com o <a href="https://en.wikipedia.org/wiki/Code_golf" rel="nofollow">golfe de c√≥digo</a> e <a href="https://en.wikipedia.org/wiki/Code_golf" rel="nofollow">adicionei uma</a> classifica√ß√£o ao Stack Overflow. <br><br>  A seguinte pergunta chamou minha aten√ß√£o: como exibir o n√∫mero de bytes em um formato leg√≠vel?  Ou seja, como converter algo como 123456789 bytes para "123,5 MB". <br><br> <a href="https://stackoverflow.com/q/3758606/276052" rel="nofollow"><img src="https://habrastorage.org/getpro/habr/post_images/7ca/00b/1f7/7ca00b1f7d4f57f0f8afa4ed9554797a.png"></a> <br>  <i><font color="gray">Boa e velha interface de 2010, obrigado The Wayback Machine</font></i> <br><a name="habracut"></a><br>  Implicitamente, o resultado seria um n√∫mero entre 1 e 999,9 com a unidade apropriada. <br><br>  J√° havia uma resposta com um loop.  A id√©ia √© simples: verifique todos os graus, da unidade maior (EB = 10 <sup>18</sup> bytes) ao menor (B = 1 byte) e aplique o primeiro, que √© menor que o n√∫mero de bytes.  No pseudo-c√≥digo, √© algo parecido com isto: <br><br><pre><code class="plaintext hljs">suffixes = [ "EB", "PB", "TB", "GB", "MB", "kB", "B" ] magnitudes = [ 10^18, 10^15, 10^12, 10^9, 10^6, 10^3, 10^0 ] i = 0 while (i &lt; magnitudes.length &amp;&amp; magnitudes[i] &gt; byteCount) i++ printf("%.1f %s", byteCount / magnitudes[i], suffixes[i])</code> </pre> <br>  Geralmente, com a resposta correta com uma classifica√ß√£o positiva, √© dif√≠cil alcan√ß√°-la.  No jarg√£o do Stack Overflow, isso √© chamado de <a href="https://meta.stackexchange.com/questions/9731/fastest-gun-in-the-west-problem" rel="nofollow">problema do atirador mais r√°pido do Ocidente</a> .  Mas aqui a resposta tinha v√°rias falhas, ent√£o eu ainda esperava super√°-la.  Pelo menos o c√≥digo com um loop pode ser bastante reduzido. <br><br><h2>  Bem, isso √© √°lgebra, tudo √© simples! </h2><br>  Ent√£o me dei conta.  Os prefixos s√£o kilo-, mega-, giga-, ... - nada mais que o grau de 1000 (ou 1024 no padr√£o IEC); portanto, o prefixo correto pode ser determinado usando o logaritmo, e n√£o o ciclo. <br><br>  Com base nessa ideia, publiquei o seguinte: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">humanReadableByteCount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bytes, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> si)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> unit = si ? <span class="hljs-number"><span class="hljs-number">1000</span></span> : <span class="hljs-number"><span class="hljs-number">1024</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bytes &lt; unit) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bytes + <span class="hljs-string"><span class="hljs-string">" B"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> exp = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (Math.log(bytes) / Math.log(unit)); String pre = (si ? <span class="hljs-string"><span class="hljs-string">"kMGTPE"</span></span> : <span class="hljs-string"><span class="hljs-string">"KMGTPE"</span></span>).charAt(exp-<span class="hljs-number"><span class="hljs-number">1</span></span>) + (si ? <span class="hljs-string"><span class="hljs-string">""</span></span> : <span class="hljs-string"><span class="hljs-string">"i"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> String.format(<span class="hljs-string"><span class="hljs-string">"%.1f %sB"</span></span>, bytes / Math.pow(unit, exp), pre); }</code> </pre> <br>  Obviamente, isso n√£o √© muito leg√≠vel e o log / pow √© inferior em efici√™ncia a outras op√ß√µes.  Mas como n√£o h√° loop e quase nenhuma ramifica√ß√£o, o resultado √© bastante bonito, na minha opini√£o. <br><br><blockquote>  <b>A matem√°tica √© simples</b> .  O n√∫mero de bytes √© expresso como byteCount = 1000 <sup>s</sup> , onde <i>s</i> representa o grau (em nota√ß√£o bin√°ria, a base √© 1024.) A solu√ß√£o <i>s</i> fornece <i>s</i> = log <sub>1000</sub> (byteCount). <br><br>  N√£o existe um log de express√£o simples <sub>1000</sub> na API, mas podemos express√°-lo em termos do logaritmo natural da seguinte forma s = log (byteCount) / log (1000).  Em seguida, convertemos <i>s</i> em int; portanto, se, por exemplo, tivermos mais de um megabyte (mas n√£o um gigabyte completo), o MB ser√° usado como unidade de medida. <br><br>  Acontece que se <i>s</i> = 1, a dimens√£o √© kilobytes, se <i>s</i> = 2 - megabytes e assim por diante.  Divida byteCount por 1000 <sup>s</sup> e coloque a letra correspondente no prefixo. </blockquote><br>  Tudo o que restou foi esperar e ver como a comunidade percebeu a resposta.  Eu n√£o conseguia pensar que esse peda√ßo de c√≥digo se tornaria o mais amplamente divulgado na hist√≥ria do Stack Overflow. <br><br><h2>  Estudo de atribui√ß√£o </h2><br>  Avan√ßo r√°pido para 2018.  O estudante de gradua√ß√£o Sebastian Baltes publica um artigo na revista cient√≠fica <i>Empirical Software Engineering,</i> intitulado <a href="https://doi.org/10.1007/s10664-018-9650-5" rel="nofollow">"Usando e atribuindo trechos de c√≥digo de estouro de pilha em projetos do GitHub"</a> .  O t√≥pico de sua pesquisa √© o quanto a licen√ßa do Stack Overflow CC BY-SA 3.0 √© respeitada, ou seja, os autores apontam para o Stack Overflow como uma fonte de c√≥digo? <br><br>  Para an√°lise, trechos de c√≥digo foram extra√≠dos do <a href="https://archive.org/details/stackexchange" rel="nofollow">dump Stack Overflow</a> e mapeados para o c√≥digo nos reposit√≥rios p√∫blicos do GitHub.  Cita√ß√£o do resumo: <br><br><blockquote>  <i>Apresentamos os resultados de um estudo emp√≠rico em larga escala analisando o uso e a atribui√ß√£o de fragmentos n√£o triviais de c√≥digo Java a partir de respostas SO em projetos p√∫blicos do GitHub (GH).</i> </blockquote><br>  (Spoiler: n√£o, a maioria dos programadores n√£o cumpre os requisitos de licen√ßa). <br><br>  O artigo possui uma tabela como esta: <br><br><img src="https://habrastorage.org/webt/d_/jb/az/d_jbazgu5cmhwyw__yxdxkzdhwy.png"><br><br>  Essa resposta acima com o identificador <a href="https://stackoverflow.com/a/3758880/276052" rel="nofollow">3758880</a> acabou sendo a mesma resposta que eu <a href="https://stackoverflow.com/a/3758880/276052" rel="nofollow">publiquei</a> oito anos atr√°s.  No momento, ele tem mais de cem mil visualiza√ß√µes e mais de mil vantagens. <br><br>  Uma pesquisa r√°pida no GitHub realmente produz milhares de reposit√≥rios com o c√≥digo <code>humanReadableByteCount</code> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c4c/3de/bc6/c4c3debc6c290c209b90c2dca5be46ab.png"><br><br>  Procure este fragmento no seu reposit√≥rio: <br><br><pre> <code class="bash hljs">$ git grep humanReadableByteCount</code> </pre> <br><blockquote>  <b>Uma hist√≥ria engra√ßada</b> , como descobri sobre este estudo. <br><br>  Sebastian encontrou uma correspond√™ncia no reposit√≥rio do OpenJDK sem nenhuma atribui√ß√£o e a licen√ßa do OpenJDK n√£o √© compat√≠vel com o CC BY-SA 3.0.  Na <a href="http://mail.openjdk.java.net/pipermail/jdk9-dev/2016-December/005327.html" rel="nofollow">lista de discuss√£o jdk9-dev,</a> ele perguntou: o c√≥digo de estouro de pilha √© copiado do OpenJDK ou vice-versa? <br><br>  O engra√ßado √© que eu acabei de trabalhar no Oracle, no projeto OpenJDK, ent√£o meu ex-colega e amigo escreveu o seguinte: <br><br>  <i>Oi</i> <i><br><br></i>  <i>Por que n√£o perguntar ao autor deste post diretamente no SO (aioobe)?</i>  <i>Ele √© membro do OpenJDK e trabalhou na Oracle quando esse c√≥digo apareceu nos reposit√≥rios de c√≥digo-fonte do OpenJDK.</i> <br><br>  A Oracle leva esses problemas muito a s√©rio.  Sei que alguns gerentes ficaram aliviados ao lerem essa resposta e encontraram o "culpado". <br><br>  Em seguida, Sebastian me escreveu para esclarecer a situa√ß√£o, o que eu fiz: esse c√≥digo foi adicionado <i>antes de</i> eu ingressar na Oracle e n√£o tenho nada a ver com o commit.  √â melhor n√£o brincar com a Oracle.  Alguns dias ap√≥s <a href="https://bugs.openjdk.java.net/browse/JDK-8170860" rel="nofollow">a abertura do ticket,</a> esse c√≥digo <a href="http://hg.openjdk.java.net/jdk9/jdk9/hotspot/rev/b552b596203f" rel="nofollow">foi exclu√≠do</a> . </blockquote><br><h2>  Bug </h2><br>  Aposto que voc√™ j√° pensou nisso.  Que tipo de erro no c√≥digo? <br><br>  Mais uma vez: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">humanReadableByteCount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bytes, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> si)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> unit = si ? <span class="hljs-number"><span class="hljs-number">1000</span></span> : <span class="hljs-number"><span class="hljs-number">1024</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bytes &lt; unit) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bytes + <span class="hljs-string"><span class="hljs-string">" B"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> exp = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (Math.log(bytes) / Math.log(unit)); String pre = (si ? <span class="hljs-string"><span class="hljs-string">"kMGTPE"</span></span> : <span class="hljs-string"><span class="hljs-string">"KMGTPE"</span></span>).charAt(exp-<span class="hljs-number"><span class="hljs-number">1</span></span>) + (si ? <span class="hljs-string"><span class="hljs-string">""</span></span> : <span class="hljs-string"><span class="hljs-string">"i"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> String.format(<span class="hljs-string"><span class="hljs-string">"%.1f %sB"</span></span>, bytes / Math.pow(unit, exp), pre); }</code> </pre> <br>  Quais s√£o as op√ß√µes? <br><br>  Ap√≥s exabytes (10 <sup>18</sup> ) s√£o zettabytes (10 <sup>21</sup> ).  Talvez um n√∫mero realmente grande v√° al√©m do kMGTPE?  N√£o.  O valor m√°ximo √© 2 <sup>63</sup> -1 ‚âà 9,2 √ó 10 <sup>18</sup> , portanto, nenhum valor jamais exceder√° os exabytes. <br><br>  Talvez a confus√£o entre unidades SI e o sistema bin√°rio?  N√£o.  Houve confus√£o na primeira vers√£o da resposta, mas foi corrigida rapidamente. <br><br>  Talvez exp acabe zerando, causando charAt (exp-1) travar?  Tamb√©m n√£o.  A primeira declara√ß√£o if cobre esse caso.  O valor exp ser√° sempre pelo menos 1. <br><br>  Talvez algum erro de arredondamento estranho na extradi√ß√£o?  Bem, finalmente ... <br><br><h2>  Muitos noves </h2><br>  A solu√ß√£o funciona at√© se aproximar de 1 MB.  Quando <code>"1000,0 kB"</code> bytes s√£o especificados como entrada, o resultado (no modo SI) √© <code>"1000,0 kB"</code> .  Embora 999.999 esteja mais pr√≥ximo de 1000 √ó 1000 <sup>1</sup> que de 999.9 √ó 1000 <sup>1</sup> , o significante 1000 √© proibido pela especifica√ß√£o.  O resultado correto √© <code>"1.0 MB"</code> . <br><br>  Em minha defesa, posso dizer que, no momento da reda√ß√£o deste texto, havia um erro em todas as 22 respostas publicadas, incluindo as bibliotecas Apache Commons e Android. <br><br>  Como consertar isso?  Antes de tudo, observamos que o expoente (exp) deve mudar de 'k' para 'M' assim que o n√∫mero de bytes estiver mais pr√≥ximo de 1 √ó 1.000 <sup>2</sup> (1 MB) do que para 999,9 √ó 1000 <sup>1</sup> (999,9 k )  Isso acontece em 999.950. Da mesma forma, devemos mudar de 'M' para 'G' quando passarmos por 999.950.000 e assim por diante. <br><br>  Computamos esse limite e aumentamos <code>exp</code> se <code>bytes</code> maior: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bytes &gt;= Math.pow(unit, exp) * (unit - <span class="hljs-number"><span class="hljs-number">0.05</span></span>)) exp++;</code> </pre> <br>  Com essa altera√ß√£o, o c√≥digo funciona bem at√© o n√∫mero de bytes se aproximar de 1 EB. <br><br><h2>  Mais nove </h2><br>  Ao calcular 999 949 999 999 999 999 999, o c√≥digo fornece <code>1000.0 PB</code> e o resultado correto √© <code>999.9 PB</code> .  Matematicamente, o c√≥digo √© preciso, ent√£o o que acontece aqui? <br><br>  Agora estamos diante de <code>double</code> restri√ß√µes. <br><br><blockquote><h4>  Introdu√ß√£o √† aritm√©tica de ponto flutuante </h4><br>  De acordo com a especifica√ß√£o IEEE 754, valores de ponto flutuante pr√≥ximos a zero t√™m uma representa√ß√£o muito densa, enquanto valores grandes t√™m uma representa√ß√£o muito esparsa.  De fato, metade de todos os valores est√£o entre -1 e 1 e, quando se trata de n√∫meros grandes, um valor do tamanho <code>Long.MAX_VALUE</code> n√£o significa nada.  No sentido literal. <br><br><pre> <code class="plaintext hljs">double l1 = Double.MAX_VALUE; double l2 = l1 - Long.MAX_VALUE; System.err.println(l1 == l2); // prints true</code> </pre> <br>  Consulte <a href="https://programming.guide/bits-of-a-floating-point-value.html" rel="nofollow">"Bits de ponto flutuante" para</a> obter detalhes. </blockquote><br>  O problema √© representado por dois c√°lculos: <br><br><ul><li>  Divis√£o em <code>String.format</code> e <br></li><li>  Limite de expans√£o <code>exp</code> </li></ul><br>  Podemos mudar para <code>BigDecimal</code> , mas √© chato.  Al√©m disso, tamb√©m surgem problemas aqui, porque a API padr√£o n√£o possui um logaritmo para <code>BigDecimal</code> . <br><br><h4>  Reduzindo valores intermedi√°rios </h4><br>  Para resolver o primeiro problema, podemos reduzir o valor de <code>bytes</code> para o intervalo desejado, onde a precis√£o √© melhor, e ajustar <code>exp</code> acordo.  De qualquer forma, o resultado final √© arredondado, portanto, n√£o importa se jogamos fora os d√≠gitos menos significativos. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (exp &gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) { bytes /= unit; exp--; }</code> </pre> <br><h4>  Configura√ß√£o de bits menos significativos </h4><br>  Para resolver o segundo problema <i>, os</i> bits menos significativos <i>s√£o importantes para</i> n√≥s (99994999 ... 9 e 99995000 ... 0 devem ter graus diferentes), portanto, precisamos encontrar uma solu√ß√£o diferente. <br><br>  Primeiro, observe que existem 12 valores limite diferentes (6 para cada modo) e apenas um deles leva a um erro.  Um resultado incorreto pode ser identificado exclusivamente porque termina em D00 <sub>16</sub> .  Ent√£o voc√™ pode corrigi-lo diretamente. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">long</span></span> th = (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>) (Math.pow(unit, exp) * (unit - <span class="hljs-number"><span class="hljs-number">0.05</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (exp &lt; <span class="hljs-number"><span class="hljs-number">6</span></span> &amp;&amp; bytes &gt;= th - ((th &amp; <span class="hljs-number"><span class="hljs-number">0xFFF</span></span>) == <span class="hljs-number"><span class="hljs-number">0xD00</span></span> ? <span class="hljs-number"><span class="hljs-number">52</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>)) exp++;</code> </pre> <br>  Como contamos com certos padr√µes de bits nos resultados de ponto flutuante, usamos o modificador strictfp para garantir que o c√≥digo funcione independentemente do hardware. <br><br><h2>  Valores de entrada negativos </h2><br>  N√£o est√° claro em que circunst√¢ncias um n√∫mero negativo de bytes pode fazer sentido, mas como o Java n√£o possui um <code>long</code> sem sinal, √© melhor lidar com essa op√ß√£o.  No momento, entradas como <code>-10000 B</code> produz <code>-10000 B</code> <br><br>  Vamos escrever <code>absBytes</code> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">long</span></span> absBytes = bytes == Long.MIN_VALUE ? Long.MAX_VALUE : Math.abs(bytes);</code> </pre> <br>  A express√£o √© t√£o detalhada porque <code>-Long.MIN_VALUE == Long.MIN_VALUE</code> .  Agora fazemos todos os c√°lculos de <code>exp</code> usando <code>absBytes</code> vez de <code>bytes</code> . <br><br><h2>  Vers√£o final </h2><br>  Aqui est√° a vers√£o final do c√≥digo, abreviada e condensada no esp√≠rito da vers√£o original: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// From: https://programming.guide/the-worlds-most-copied-so-snippet.html public static strictfp String humanReadableByteCount(long bytes, boolean si) { int unit = si ? 1000 : 1024; long absBytes = bytes == Long.MIN_VALUE ? Long.MAX_VALUE : Math.abs(bytes); if (absBytes &lt; unit) return bytes + " B"; int exp = (int) (Math.log(absBytes) / Math.log(unit)); long th = (long) (Math.pow(unit, exp) * (unit - 0.05)); if (exp &lt; 6 &amp;&amp; absBytes &gt;= th - ((th &amp; 0xfff) == 0xd00 ? 52 : 0)) exp++; String pre = (si ? "kMGTPE" : "KMGTPE").charAt(exp - 1) + (si ? "" : "i"); if (exp &gt; 4) { bytes /= unit; exp -= 1; } return String.format("%.1f %sB", bytes / Math.pow(unit, exp), pre); }</span></span></code> </pre> <br>  Observe que isso come√ßou como uma tentativa de evitar loops e ramifica√ß√µes excessivas.  Mas, ap√≥s suavizar todas as situa√ß√µes de borda, o c√≥digo ficou ainda menos leg√≠vel que a vers√£o original.  Pessoalmente, eu n√£o copiaria esse fragmento na produ√ß√£o. <br><br>  Para uma vers√£o atualizada da qualidade da produ√ß√£o, consulte um artigo separado: <a href="https://programming.guide/java/formatting-byte-size-to-human-readable-format.html" rel="nofollow">‚ÄúFormatando o tamanho do byte em um formato leg√≠vel‚Äù</a> . <br><br><h2>  Principais conclus√µes </h2><br><ul><li>  Pode haver erros nas respostas ao estouro de pilha, mesmo que tenham milhares de vantagens. <br></li><li>  Verifique todos os casos de limite, <i>especialmente</i> no c√≥digo com Estouro de Pilha. <br></li><li>  A aritm√©tica de ponto flutuante √© complicada. <br></li><li>  Certifique-se de incluir a atribui√ß√£o correta ao copiar c√≥digo.  Algu√©m pode lev√°-lo a √°gua limpa. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt478878/">https://habr.com/ru/post/pt478878/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt478858/index.html">Comparando sess√µes de cria√ß√£o de perfil no administrador XHProf</a></li>
<li><a href="../pt478862/index.html">Como √© organizado o teste de front-end no Yandex.Market e por que recusamos lan√ßamentos semanais</a></li>
<li><a href="../pt478866/index.html">Conhe√ßa o Space - Novo produto da JetBrains</a></li>
<li><a href="../pt478872/index.html">DIY: como automatizamos o monitoramento do armaz√©m</a></li>
<li><a href="../pt478874/index.html">A Toshiba anunciou duas novas linhas de HDDs com capacidades de at√© 6 TB e anunciou seu foco no segmento corporativo desde 2020</a></li>
<li><a href="../pt478880/index.html">Quais sal√°rios os empregadores ofereceram aos especialistas em TI no segundo semestre de 2019</a></li>
<li><a href="../pt478884/index.html">Como preparar o RTSP no site em 2020 ou por que os javalis n√£o t√™m tempo para escapar</a></li>
<li><a href="../pt478886/index.html">Componentes angulares com conte√∫do embutido</a></li>
<li><a href="../pt478888/index.html">Algumas reflex√µes sobre quest√µes modulares de suporte a css e c√≥digo</a></li>
<li><a href="../pt478890/index.html">Onde est√° o meu pacote? A IA facilitar√° as tarefas de entrega</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>