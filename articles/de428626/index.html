<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëª ü•§ üò¶ Wie man die Erweiterung in PHP7 schwieriger macht als "Hallo Welt" und nicht rot√§ugig wird. Teil 1 ü§µüèª üìà üë®üèΩ‚Äç‚úàÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Warum? 
 Ich schreibe diesen Artikel, damit der Leser den Weg, den ich insgesamt mindestens ein Jahr eingeschlagen habe, in ein paar Stunden gehen kan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wie man die Erweiterung in PHP7 schwieriger macht als "Hallo Welt" und nicht rot√§ugig wird. Teil 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/428626/"><h2>  Warum? </h2><br>  Ich schreibe diesen Artikel, damit der Leser den Weg, den ich insgesamt mindestens ein Jahr eingeschlagen habe, in ein paar Stunden gehen kann.  Wie meine pers√∂nlichen Erfahrungen gezeigt haben, ist das einfache Programmieren in C etwas einfacher als eine ernsthafte Erweiterung f√ºr PHP.  Hier werde ich Ihnen so viel wie m√∂glich dar√ºber erz√§hlen, wie Sie eine Erweiterung am Beispiel der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">libtrie-</a> Bibliothek <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">erstellen</a> , die den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Pr√§fixbaum</a> implementiert, besser bekannt als trie.  Ich werde die beschriebenen Aktionen auf einem frisch installierten Lubuntu 18.04-System schreiben und gleichzeitig ausf√ºhren. <br><br>  Fangen wir an. <br><a name="habracut"></a><br><h2>  Softwareinstallation </h2><br><h4>  Php </h4><br><ol><li>  Zuerst haben wir das php7.2-dev-Paket eingef√ºgt, darin das phpize-Skript, das zum Erstellen der Erweiterung ben√∂tigt wird.  Zus√§tzlich ben√∂tigen wir eine funktionierende Version von PHP, auf der wir unsere Erweiterung √ºberpr√ºfen werden.  Durch die Installation dieses Pakets werden eine Reihe von abh√§ngigen Paketen aufgerufen. Wir stellen alles bereit, was angeboten wird. <br><br><pre><code class="bash hljs">sudo apt install php7.2-dev</code> </pre> <br></li><li>  Wir gehen auf die php.net-Website, gehen zum Download-Bereich und ziehen einen Link zum Archiv mit der neuesten stabilen Version von php, jetzt ist es Version 7.2.11. <br>  Laden Sie das PHP-Quellarchiv herunter: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /tmp &amp;&amp; wget http://it2.php.net/get/php-7.2.11.tar.gz/from/this/mirror -O php7.tar.gz</code> </pre><br></li><li>  Packen Sie nun das Archiv f√ºr uns aus: <br><br><pre> <code class="bash hljs">sudo tar -xvf php7.tar.gz -C /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/src</code> </pre><br></li></ol><br><h4>  Code-Editoren </h4><br>  Ich benutze normalerweise 2 Code-Editoren.  Einfach und schnell, ziemlich nerdig, aber sehr fortschrittlich von JetBrains.  Geany Installation von der Standard-R√ºbe Ubuntu. <br><br><pre> <code class="bash hljs">sudo apt install geany</code> </pre><br>  Laden Sie Clion von der offiziellen JetBrains-Website herunter: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/Downloads &amp;&amp; wget https://download.jetbrains.com/cpp/CLion-2018.2.5.tar.gz -O clion.tar.gz</code> </pre><br><pre> <code class="bash hljs">sudo tar -xvf clion.tar.gz -C /usr/share</code> </pre><br>  Lassen Sie uns einen Link erstellen, damit Clion bequem von der Konsole aus ausgef√ºhrt werden kann. <br><br><pre> <code class="bash hljs">sudo ln -s /usr/share/clion-2018.2.5/bin/clion.sh /usr/bin/clion</code> </pre><br>  Nach dem ersten Start erstellt clion selbst Verkn√ºpfungen aus dem LXpanel-Shell-Men√º, die Sie jedoch zum ersten Mal manuell ausf√ºhren m√ºssen. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># clion</span></span></code> </pre><br><h2>  Erweiterung erstellen </h2><br>  Hier haben wir mindestens 3 M√∂glichkeiten: <br><br><ol><li>  Nehmen Sie die rohe Standard-CD aus den von uns heruntergeladenen PHP-Quellen. </li><li>  Ich habe die Standard-CD mit einem speziellen ext_skel-Skript ein wenig gesehen </li><li>  Holen Sie sich hier eine gute minimalistische CD. </li></ol><br>  Ich mag die dritte Option am meisten, aber ich werde die zweite im Falle eines Fehlers verwenden, um die Anzahl der Stellen zu minimieren, an denen ich mich irren k√∂nnte.  Obwohl es immer noch ein Vergn√ºgen ist, einen Rohling von Entwicklern auszuw√§hlen :-) <br><br><ol><li>  Gehen wir zum Verzeichnis mit den Standard-PHP-Erweiterungen. <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/src/php-7.2.11/ext</code> </pre><br>  Zus√§tzlich zum Namen des Skripts k√∂nnen Sie einige Erweiterungsparameter √ºber die Protodatei angeben.  All dies kann nicht getan werden.  Ich werde alles von Hand machen, aber ich werde zeigen, wie Proto funktioniert.  Wir versuchen es, also nennen wir unsere Erweiterung libtrie.  Um im Verzeichnis / usr / local / src arbeiten zu k√∂nnen, ben√∂tigen Sie Administratorrechte. Um nicht sudo zu schreiben, werde ich bash mit erh√∂hten Rechten einschlie√üen. <br><br><pre> <code class="bash hljs">sudo bash</code> </pre><br></li><li>  Hier werde ich die Parameter von nur 1 Funktion einstellen, die die erstellte Erweiterung implementieren wird.  Dies ist nur eine Demofunktion, um zu zeigen, wie dies gemacht wird. <br><br>  Wir werden ein vollst√§ndiges Analogon der Standardfunktion erstellen <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">array</span></span> array_fill ( int $start_index , int $num , mixed $value )</code> </pre><br>  Die Syntax in der Protodatei ist sehr einfach, Sie m√ºssen nur den Namen der Funktion angeben.  Ich werde etwas mehr schreiben, damit es informativer aussieht. <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> my_array_fill \( int start_index , int num , mixed value \) &gt;&gt; libtrie.proto</code> </pre><br></li><li>  F√ºhren Sie nun das Skript ext_skel aus und geben Sie ihm den Namen der Erweiterung und die von uns erstellte Protodatei. <br><br><pre> <code class="bash hljs">./ext_skel --extname=libtrie --proto=./libtrie.proto</code> </pre><br></li><li>  Wir haben ein Verzeichnis mit unserer Erweiterung erstellt.  Lass uns darauf eingehen. <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> libtrie</code> </pre><br></li></ol><br><h4>  Dateistruktur und Assemblierungsprinzip </h4><br><div class="spoiler">  <b class="spoiler_title">Dateistruktur</b> <div class="spoiler_text"><pre> <code class="bash hljs">config.m4 -           phpize   ./configure,       makefile. CREDITS -  ,     ,    libtrie.c -      php_libtrie.h -     config.w32 -        windows EXPERIMENTAL -  .    ,    . libtrie.php -  php      . tests -  </code> </pre><br></div></div><br>  Um die Erweiterung erfolgreich zu erstellen, ben√∂tigen Sie nur 3 Dateien.  Auf der oben erw√§hnten minimalistischen CD der Erweiterung befinden sich nur 3 Dateien. <br><br><pre> <code class="bash hljs">config.m4 php_libtrie.h libtrie.c</code> </pre><br>  Ich mag die in PHP akzeptierte Standardbenennung nicht, ich mag es, wenn die Header-Dateien und Dateien mit dem Programmk√∂rper den gleichen Namen haben.  Deshalb umbenennen <br> <code>libtrie.c</code> <br>  in <br> <code>php_libtrie.c</code> <br> <br><pre> <code class="bash hljs">mv libtrie.c php_libtrie.c</code> </pre><br><h4>  Bearbeiten von config.m4 </h4><br>  Die Standarddatei config.m4 ist buchst√§blich mit Inhalten √ºberf√ºllt, deren F√ºlle verwirrend und verwirrend ist.  Wie gesagt, diese Datei wird ben√∂tigt, um ein Konfigurationsskript zu erstellen.  Lesen Sie hier mehr dar√ºber. <br><br><pre> <code class="bash hljs">geany config.m4 &amp;</code> </pre><br>  Wir lassen nur das: <br><br><pre> <code class="bash hljs">PHP_ARG_ENABLE(libtrie, whether to <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> libtrie support, [ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libtrie Enable libtrie support]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$PHP_LIBTRIE</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">"no"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-comment"><span class="hljs-comment">#    -    # PHP_ADD_INCLUDE() #   PHP_NEW_EXTENSION(libtrie, php_libtrie.c, $ext_shared) # PHP_NEW_EXTENSION(libtrie, php_libtrie.c, $ext_shared,, -DZEND_ENABLE_STATIC_TSRMLS_CACHE=1) fi</span></span></code> </pre><br><img src="https://habrastorage.org/webt/mb/fz/y_/mbfzy_te6ilmvy8oelvaf91_g20.png"><br><br>  Das erste Makro bietet die M√∂glichkeit, unsere Erweiterung zu aktivieren und zu deaktivieren, wenn das generierte Konfigurationsskript ausgef√ºhrt wird. <br><br>  Der zweite Block ist der wichtigste. Er bestimmt, welche Dateien als Teil unserer Erweiterung kompiliert werden, ob die Erweiterung dynamisch √ºber eine .so-Datei verbunden wird oder ob die Erweiterung statisch ist und w√§hrend der PHP-Erstellung integriert wird.  Unsere werden dynamisch sein. <br>  Speichern Sie die Datei. <br><br>  Wir kopieren die Datei in das Benutzerverzeichnis, damit sie im Root-Modus nicht funktioniert. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    exit</span></span></code> </pre><br>  Kopie: <br><br><pre> <code class="bash hljs">cp /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/src/php-7.2.11/ext/libtrie ~/Documents/ -r</code> </pre><br><h3>  Demofunktion </h3><br>  Ich m√∂chte Sie daran erinnern, dass wir das vollst√§ndige Analogon von array_fill () ausf√ºhren werden.  Ich werde Clion durcharbeiten, aber diese Anleitung kann in jedem Editor erstellt werden.  Clion ist gut, weil es Ihnen erm√∂glicht, grundlegende Syntaxpr√ºfungen automatisch durchzuf√ºhren und die schnelle Navigation durch Dateien oder Funktionen per Strg + Klick unterst√ºtzt.  Damit solche √úberg√§nge in unserer Erweiterung funktionieren, m√ºssen Sie die Datei CMakeLists.txt konfigurieren <br><br>  Damit Clion ordnungsgem√§√ü funktioniert, m√ºssen Sie das cmake-Build-System installieren, mit dem eine Reihe abh√§ngiger Pakete installiert werden.  Installieren Sie dies alles mit dem Befehl: <br><br><pre> <code class="bash hljs">sudo apt install cmake</code> </pre><br><h4>  Konfigurieren Sie cmake </h4><br>  Wir √∂ffnen unseren Katalog mit Erweiterung in Clion.  Erstellen Sie eine CMakeLists.txt-Datei mit den folgenden Inhalten √ºber das Kontextmen√º, indem Sie oben auf dem Bildschirm auf den Namen des Stammverzeichnisses klicken: <br><br><pre> <code class="bash hljs">cmake_minimum_required(VERSION 3.12) project(php-ext-libtrie C) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(CMAKE_C_STANDARD 11) <span class="hljs-comment"><span class="hljs-comment">#   phproot,       php set(phproot /usr/local/src/php-7.2.11/) #   ,      #      clion       php include_directories(${phproot}) include_directories(${phproot}TSRM/) include_directories(${phproot}main/) include_directories(${phproot}Zend/) #    clion          add_executable(php-ext-libtrie php_libtrie.c)</span></span></code> </pre><br><img src="https://habrastorage.org/webt/ag/nc/qj/agncqji78vvzfcbyevpwi-9gszy.png"><br><br>  Vielleicht wei√ü jemand, wie man diese Datei k√ºrzer macht, damit Clion mit der Indizierung von Projektdateien beginnt.  Ich habe keinen k√ºrzeren Weg gefunden.  Wenn jemand wei√ü, schreiben Sie in die Kommentare. <br><br><h4>  Demo-Funktionscode </h4><br>  √ñffnen Sie unsere Datei mit dem <code>php_libtrie.c</code> unserer Erweiterung <code>php_libtrie.c</code> und <br>  L√∂schen Sie alle Kommentare, damit sie uns nicht verwirren. <br><br><img src="https://habrastorage.org/webt/8x/sj/c2/8xsjc2q571audrqfbliblnct4-8.png"><br><br><img src="https://habrastorage.org/webt/vu/ql/mu/vuqlmu48nqu2fkkasdosjsma8zw.png"><br><br>  Clion pr√ºft, ob alle im Code verwendeten Funktionen und Makros deklariert wurden, und gibt einen Fehler aus, wenn dies nicht der Fall ist.  Offensichtlich verwenden PHP-Entwickler kein Clion, sonst w√ºrden sie wahrscheinlich etwas dagegen tun.  Um zu verhindern, dass diese Fehler in unserer Erweiterung auftreten, f√ºgen wir uns die fehlenden Header-Dateien hinzu. <br><br>  Um alles zu rationalisieren, mache ich Folgendes: <br>  Ich √ºbertrage alle Include mit Headern aus der Datei <code>php_libtrie.c</code> nach <code>php_libtrie.h</code> , es bleibt nur 1 Eintrag in der ersten Datei: <br><br><pre> <code class="hljs cpp"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"php_libtrie.h"</span></span></span></span></code> </pre><br><img src="https://habrastorage.org/webt/ft/fe/yg/ftfeygfd1fznk5jxaccj8i9mt8k.png"><br><br>  Die Datei <code>php_libtrie.h</code> enth√§lt alle anderen erforderlichen Einschl√ºsse. <br><br><img src="https://habrastorage.org/webt/_v/_4/jg/_v_4jgpsak4g3aa7clykblcuq8y.png"><br><br><div class="spoiler">  <b class="spoiler_title">Inhalt meiner Header-Datei</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#ifndef</span></span> <span class="hljs-type"><span class="hljs-type">PHP_LIBTRIE_H</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">PHP_LIBTRIE_H</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#ifdef</span></span> <span class="hljs-type"><span class="hljs-type">HAVE_CONFIG_H</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"config.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;stdarg.h&gt; //   va_start() <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;inttypes.h&gt; //    //  <span class="hljs-symbol"><span class="hljs-symbol">#if</span></span> defined(__GNUC__) &amp;&amp; __GNUC__ &gt;= <span class="hljs-number"><span class="hljs-number">4</span></span> # define <span class="hljs-type"><span class="hljs-type">ZEND_API</span></span> __attribute__ ((visibility(<span class="hljs-comment"><span class="hljs-comment">"default"</span></span>))) # define <span class="hljs-type"><span class="hljs-type">ZEND_DLEXPORT</span></span> __attribute__ ((visibility(<span class="hljs-comment"><span class="hljs-comment">"default"</span></span>))) <span class="hljs-symbol"><span class="hljs-symbol">#else</span></span> # define <span class="hljs-type"><span class="hljs-type">ZEND_API</span></span> # define <span class="hljs-type"><span class="hljs-type">ZEND_DLEXPORT</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> # define <span class="hljs-type"><span class="hljs-type">SIZEOF_SIZE_T</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> //   <span class="hljs-type"><span class="hljs-type">ZVAL_COPY_VALUE</span></span>() <span class="hljs-symbol"><span class="hljs-symbol">#ifndef</span></span> <span class="hljs-type"><span class="hljs-type">ZEND_DEBUG</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">ZEND_DEBUG</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> //  ,      <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"php.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"php_ini.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"zend.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"zend_types.h"</span></span> //<span class="hljs-type"><span class="hljs-type">ZVAL_COPY_VALUE</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"ext/standard/info.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"zend_API.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"zend_modules.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"zend_string.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"spprintf.h"</span></span> extern zend_module_entry libtrie_module_entry; ...</code> </pre><br></div></div><br>  Wenn alles richtig gemacht wurde, zeigt der Clion-Tester in der oberen rechten Ecke ein gelbes oder gr√ºnes Quadrat an, was bedeutet, dass keine kritischen Fehler vorliegen. <br><br><img src="https://habrastorage.org/webt/pt/gm/sa/ptgmsa8nlhkn1gs_ykyc8igavao.png"><br><br><h4>  Ein kleiner theoretischer Exkurs </h4><br>  Damit die Erweiterung ordnungsgem√§√ü funktioniert, sind zwei Dinge erforderlich: <br><br><ol><li>  Sie m√ºssen die spezielle Struktur zend_module_entry initialisieren, die Folgendes enth√§lt: <br><br><pre> <code class="hljs ruby">zend_module_entry libtrie_module_entry = { STANDARD_MODULE_HEADER, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  <span class="hljs-string"><span class="hljs-string">"libtrie"</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  libtrie_functions, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     PHP_MINIT(libtrie), <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>,     PHP_MSHUTDOWN(libtrie), <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   PHP_RINIT(libtrie), <span class="hljs-regexp"><span class="hljs-regexp">/* Replace with NULL if there's nothing to do at request start */</span></span> PHP_RSHUTDOWN(libtrie), <span class="hljs-regexp"><span class="hljs-regexp">/* Replace with NULL if there's nothing to do at request end */</span></span> PHP_MINFO(libtrie), <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ,    php  phpinfo() PHP_LIBTRIE_VERSION, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ,     STANDARD_MODULE_PROPERTIES /<span class="hljs-regexp"><span class="hljs-regexp">/    };</span></span></code> </pre><br></li><li>  Initialisieren Sie dasselbe Array, das alle Funktionen unserer Erweiterung enth√§lt. <br><br>  Hier werden √ºber einen speziellen Makro-Wrapper PHP_FE () die Namen aller Funktionen in unserer Erweiterung festgelegt.  Im Allgemeinen werden Makros in PHP sehr aktiv verwendet, es gibt viele Makros, die sich einfach auf andere Makros beziehen, und diese wiederum sind weiter entfernt.  Man muss sich daran gew√∂hnen.  Sie k√∂nnen herausfinden, ob Sie die Makros mit Strg + Klick durchgehen.  Hier ist Clion unverzichtbar. <br><br>  Erinnerst du dich an die Protodatei?  Wir setzen dort 1 Funktion my_array_fill ().  Jetzt haben wir hier 3 Elemente: <br><br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> zend_function_entry libtrie_functions[] = { PHP_FE(confirm_libtrie_compiled, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-comment"><span class="hljs-comment">/* For testing, remove later. */</span></span> PHP_FE(my_array_fill, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) PHP_FE_END <span class="hljs-comment"><span class="hljs-comment">/* Must be the last line in libtrie_functions[] */</span></span> };</code> </pre><br>  Die erste Zeile ist eine Testfunktion, die zeigt, dass die Erweiterung funktioniert, die zweite ist unsere Funktion, die dritte ist ein spezielles Makro, das das letzte in diesem Array sein sollte. <br></li></ol><br>  Finden Sie unsere Funktion: <br><br><pre> <code class="hljs lisp">PHP_FUNCTION(<span class="hljs-name"><span class="hljs-name">my_array_fill</span></span>)</code> </pre><br>  Wie Sie sehen k√∂nnen, wird es auch √ºber ein Makro initialisiert.  Die Sache ist, dass alle PHP-Funktionen innerhalb von C nichts zur√ºckgeben (genauer gesagt, void zur√ºckgeben) und ihre Argumente nicht ge√§ndert werden k√∂nnen.  Irgendwo ist es sogar bequem. <br><br>  Wenn Sie sich die Dateistruktur ansehen (Teil des Fensters links), werden hier alle Funktionen der Datei aufgelistet, jedoch in der Form, in der sie nach dem Vorkompilieren der Makros vorliegen.  Der Screenshot zeigt, dass unsere Funktion my_array_fill tats√§chlich zif_my_array_fill ist. <br><br><img src="https://habrastorage.org/webt/ur/cl/m4/urclm4yrxdayv7heohr0puutrm8.png"><br><br>  Argumente aus dem Darm von PHP zu unserer C-Funktion erhalten wir mit einem Makro.  Weitere Details zu diesem Makro finden Sie in der Datei: <br><br><pre> <code class="bash hljs">/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/src/php-7.2.11/README.PARAMETER_PARSING_API</code> </pre><br>  Unten finden Sie den Code unserer Analogfunktion mit detaillierten Erkl√§rungen. <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="hljs ruby">PHP_FUNCTION(my_array_fill) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   ,     /<span class="hljs-regexp"><span class="hljs-regexp">/    2 : /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ zend_execute_data *execute_data, zval *return_value /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     ,      /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/zend_long  int64_t  x64   int32_t  x86  /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      zend_long zend_long start_index; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/1  , zend_long num; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/2   zval *value; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   mixed ,   zval,      /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    ,          if (zend_parse_parameters(ZEND_NUM_ARGS(), "llz", &amp;start_index, &amp;num, &amp;value) == FAILURE) { /</span></span>*     *    RETURN<span class="hljs-number"><span class="hljs-number">_</span></span>    * return_value     *<span class="hljs-regexp"><span class="hljs-regexp">/ RETURN_FALSE; } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   ,   -    if (num &lt;= 0) { php_error_docref(NULL TSRMLS_CC, E_WARNING, "argument 2 must be &gt; 0"); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     RETURN_FALSE; } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/zval *return_value  ,        /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/       zval,     ,  -  /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   zend_long  unsigned int32. /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      + -. ..   1,    3,     4  array_init_size(return_value, (uint32_t)(start_index + num)); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  ,   ,   for(zend_long i = start_index, last = start_index + num; i &lt; last; ++i) { /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   zval       add_index_zval(return_value, i, value); } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   ,      return_value return; }</span></span></code> </pre><br></div></div><br><br><br><h2>  Erweiterungen erstellen und testen </h2><br>  F√ºhren Sie zun√§chst phpize aus, um die Datei zu konfigurieren. <br><br><pre> <code class="bash hljs">phpize</code> </pre><br>  F√ºhren Sie nun ./configure aus, um das Makefile auszuf√ºhren. <br><br><pre> <code class="bash hljs">./configure</code> </pre><br>  F√ºhren Sie abschlie√üend make aus, um unsere Erweiterung zu sammeln. <br><br><pre> <code class="bash hljs">make</code> </pre><br>  Lassen Sie uns √ºberpr√ºfen, was wir getan haben. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    php,       # modules.  -a  php      php -d extension=modules/libtrie.so -a</span></span></code> </pre><br>  Wir geben in der PHP-Konsole: <br><br><pre> <code class="php hljs">print_r(my_array_fill(<span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"hello, baby!"</span></span>));</code> </pre><br>  Genie√üe das Ergebnis. <br><br><img src="https://habrastorage.org/webt/gn/sx/cy/gnsxcy1ihjtn6tgm7mpqjsz9hl4.png"><br><br>  Jemand fragt, wo ist Trie hier?  √úber Funktionen, die die Arbeit von trie implementieren, werde ich im zweiten Teil schreiben. <br><br>  <b>Bleib dran.</b> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de428626/">https://habr.com/ru/post/de428626/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de428610/index.html">Das Paradox der Wartezeit, oder warum ist mein Bus immer zu sp√§t?</a></li>
<li><a href="../de428612/index.html">Funktionen h√∂herer Ordnung in JavaScript: Was ist das?</a></li>
<li><a href="../de428616/index.html">Konvertieren Sie XLS-Dateien mithilfe von Google Apps Script in Google Spreadsheet</a></li>
<li><a href="../de428620/index.html">Wie erstelle ich Roguelike?</a></li>
<li><a href="../de428624/index.html">Jeffrey Richter, Pavel Yosifovich, Greg Young und alles in allem. Hardcore und Architektur bei DotNext 2018 Moskau</a></li>
<li><a href="../de428628/index.html">Arbeiten Sie mit abstrakten JavaScript-Syntaxb√§umen</a></li>
<li><a href="../de428630/index.html">Nein, Bitcoin wird unser Klima bis 2033 nicht zerst√∂ren.</a></li>
<li><a href="../de428632/index.html">Umgang mit Abfangj√§gern in Reaktion</a></li>
<li><a href="../de428634/index.html">Portierung von Quake3</a></li>
<li><a href="../de428636/index.html">Roskomnadzor wird eine Geldstrafe von Google zur√ºckfordern</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>