<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚴🏾 🥓 👩🏾‍🔬 Was Sie wissen müssen, bevor Sie zum Akka Toolkit wechseln, um Event Sourcing und CQRS zu implementieren 🎣 👩‍👩‍👧‍👦 🦊</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo, liebe Leser von Habr. Mein Name ist Rustem und ich bin der Hauptentwickler des kasachischen IT-Unternehmens DAR. In diesem Artikel werde ich Ih...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Was Sie wissen müssen, bevor Sie zum Akka Toolkit wechseln, um Event Sourcing und CQRS zu implementieren</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453418/"><p>  Hallo, liebe Leser von Habr.  Mein Name ist Rustem und ich bin der Hauptentwickler des kasachischen IT-Unternehmens DAR.  In diesem Artikel werde ich Ihnen erklären, was Sie wissen müssen, bevor Sie mit dem Akka-Toolkit zu Event Sourcing- und CQRS-Vorlagen übergehen. </p><br><p>  Um 2015 haben wir begonnen, unser Ökosystem zu gestalten.  Nach der Analyse und basierend auf den Erfahrungen mit Scala und Akka haben wir uns entschlossen, beim Akka-Toolkit anzuhalten.  Wir hatten erfolgreiche Implementierungen von Event Sourcing-Vorlagen mit CQRS und nicht so.  Die Anhäufung von Fachwissen in diesem Bereich, das ich mit den Lesern teilen möchte.  Wir werden uns ansehen, wie Akka diese Muster implementiert und welche Tools verfügbar sind, und über Akka-Fallstricke sprechen.  Ich hoffe, dass Sie nach dem Lesen dieses Artikels die Risiken eines Wechsels zum Akka-Toolkit besser verstehen. </p><a name="habracut"></a><br><p>  Zu den Themen CQRS und Event Sourcing wurden viele Artikel über Habré und andere Ressourcen verfasst.  Dieser Artikel richtet sich an Leser, die bereits verstehen, was CQRS und Event Sourcing sind.  In dem Artikel möchte ich mich auf Akka konzentrieren. </p><br><h3 id="domain-driven-design">  Domänengesteuertes Design </h3><br><p>  Es wurde viel Material über Domain-Driven Design (DDD) geschrieben.  Es gibt sowohl Gegner als auch Befürworter dieses Ansatzes.  Ich möchte selbst hinzufügen, dass es nicht überflüssig ist, DDD zu studieren, wenn Sie sich für Event Sourcing und CQRS entscheiden.  Darüber hinaus ist die DDD-Philosophie in allen Akka-Tools zu spüren. </p><br><p>  Tatsächlich sind Event Sourcing und CQRS nur ein kleiner Teil des Gesamtbilds, das als domänengesteuertes Design bezeichnet wird.  Beim Entwerfen und Entwickeln haben Sie möglicherweise viele Fragen dazu, wie Sie diese Muster richtig implementieren und in das Ökosystem integrieren können. Wenn Sie wissen, dass DDD Ihr Leben einfacher macht. </p><br><blockquote>  In diesem Artikel bezeichnet der Begriff Entität (Entität von DDD) einen Persistenzakteur mit einer eindeutigen Kennung. </blockquote><br><h3 id="pochemu-scala">  Warum Scala? </h3><br><p>  Wir werden oft gefragt, warum Scala und nicht Java.  Ein Grund ist Akka.  Das Framework selbst, geschrieben in der Scala-Sprache mit Unterstützung für die Java-Sprache.  Hier muss ich sagen, dass es auch eine Implementierung in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">.NET gibt</a> , aber dies ist ein anderes Thema.  Um keine Diskussion zu verursachen, werde ich nicht schreiben, warum Scala besser oder schlechter als Java ist.  Ich möchte Ihnen nur einige Beispiele nennen, die meiner Meinung nach bei der Arbeit mit Akka einen Vorteil gegenüber Java haben: </p><br><ul><li> Unveränderliche Gegenstände.  In Java müssen Sie unveränderliche Objekte selbst schreiben.  Glauben Sie mir, es ist nicht einfach und nicht sehr bequem, ständig die endgültigen Parameter zu schreiben.  In Scala <code>case class</code> Fallklasse bereits mit der integrierten Kopierfunktion unveränderlich </li><li>  Codierungsstil.  Bei der Implementierung in Java schreiben Sie weiterhin im Scala-Stil, dh funktional. </li></ul><br><p>  Hier ist ein Beispiel für die Implementierung von Actor in Scala und Java: </p><br><p>  <strong>Scala:</strong> </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DemoActor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">props</span></span></span></span>(magicNumber: <span class="hljs-type"><span class="hljs-type">Int</span></span>): <span class="hljs-type"><span class="hljs-type">Props</span></span> = <span class="hljs-type"><span class="hljs-type">Props</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">DemoActor</span></span>(magicNumber)) } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DemoActor</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">magicNumber: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Actor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-function"> </span></span>= { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> x: <span class="hljs-type"><span class="hljs-type">Int</span></span> =&gt; sender() ! (x + magicNumber) } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeOtherActor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Actor</span></span></span><span class="hljs-class"> </span></span>{ context.actorOf(<span class="hljs-type"><span class="hljs-type">DemoActor</span></span>.props(<span class="hljs-number"><span class="hljs-number">42</span></span>), <span class="hljs-string"><span class="hljs-string">"demo"</span></span>) <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre> <br><p>  <strong>Java:</strong> </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DemoActor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractActor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Props </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">props</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Integer magicNumber)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Props.create(DemoActor.class, () -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DemoActor(magicNumber)); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Integer magicNumber; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DemoActor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Integer magicNumber)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.magicNumber = magicNumber; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Receive </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createReceive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> receiveBuilder() .match( Integer.class, i -&gt; { getSender().tell(i + magicNumber, getSelf()); }) .build(); } } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeOtherActor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractActor</span></span></span><span class="hljs-class"> </span></span>{ ActorRef demoActor = getContext().actorOf(DemoActor.props(<span class="hljs-number"><span class="hljs-number">42</span></span>), <span class="hljs-string"><span class="hljs-string">"demo"</span></span>); <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre> <br><p>  (Beispiel von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> ) </p><br><p>  <code>createReceive()</code> auf die Implementierung der Methode <code>createReceive()</code> am Beispiel der Java-Sprache.  Intern wird über die <code>ReceiveBuilder</code> Factory der Pattern-Matching implementiert.  <code>receiveBuilder()</code> ist eine Methode von Akka zur Unterstützung von Lambda-Ausdrücken, nämlich Pattern-Matching in Java.  In Scala wird dies nativ implementiert.  Stimmen Sie zu, der Code in Scala ist kürzer und leichter zu lesen. </p><br><ul><li>  Dokumentation und Beispiele.  Trotz der Tatsache, dass es in der offiziellen Dokumentation Beispiele in Java gibt, befinden sich im Internet fast alle Beispiele in Scala.  Außerdem können Sie leichter in den Quellen der Akka-Bibliothek navigieren. </li></ul><br><blockquote>  In Bezug auf die Leistung wird es keinen Unterschied zwischen Scala und Java geben, da sich alles in der JVM dreht. </blockquote><br><h3 id="hranilische">  Lagerung </h3><br><p>  Bevor Sie Event Sourcing mit Akka Persistence implementieren, empfehlen wir Ihnen, eine Datenbank für die permanente Datenspeicherung vorzuwählen.  Die Wahl der Basis hängt von den Anforderungen an das System, Ihren Wünschen und Vorlieben ab.  Daten können sowohl in NoSQL und RDBMS als auch in einem Dateisystem, beispielsweise LevelDB von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Google,</a> gespeichert werden. </p><br><p>  Es ist wichtig zu beachten, dass Akka Persistence nicht für das Schreiben und Lesen von Daten aus der Datenbank verantwortlich ist, sondern über ein Plug-In, das die Akka Persistence API implementieren sollte. </p><br><p>  Nachdem Sie ein Tool zum Speichern von Daten ausgewählt haben, müssen Sie ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Plugin</a> aus der Liste auswählen oder es selbst schreiben.  Die zweite Option, ich empfehle nicht, warum das Rad neu erfinden. </p><br><p>  Für die dauerhafte Datenspeicherung haben wir uns entschieden, bei Cassandra zu bleiben.  Tatsache ist, dass wir eine zuverlässige, schnelle und verteilte Basis brauchten.  Darüber hinaus begleitet Typesafe selbst das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Plugin</a> , das die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Akka Persistence API</a> vollständig implementiert.  Es wird ständig aktualisiert und im Vergleich zu anderen hat das Cassandra-Plugin eine vollständigere Dokumentation geschrieben. </p><br><p>  Es ist erwähnenswert, dass das Plugin auch einige Probleme hat.  Zum Beispiel gibt es noch keine stabile Version (zum Zeitpunkt dieses Schreibens ist die neueste Version 0.97).  Für uns war das größte Ärgernis bei der Verwendung dieses Plugins der Verlust von Ereignissen beim Lesen der persistenten Abfrage für einige Entitäten.  Für ein vollständiges Bild sehen Sie unten das CQRS-Diagramm: </p><br><p><img src="https://habrastorage.org/webt/xd/3o/hk/xd3ohkb_wfvtfds2qangxxoctws.png"></p><br><p>  Persistente Entität verteilt Entitätsereignisse mithilfe des konsistenten Hash-Algorithmus (z. B. 10 Shards) in Tags: </p><br><p><img src="https://habrastorage.org/webt/eb/sq/zj/ebsqzjcj_nom7zs4pyizzkq5o0q.png"></p><br><p>  Anschließend abonniert Persistent Query diese Tags und startet einen Stream, der der elastischen Suche Daten hinzufügt.  Da sich Cassandra in einem Cluster befindet, werden Ereignisse über Knoten verteilt.  Einige Knoten können durchhängen und reagieren langsamer als andere.  Es gibt keine Garantie dafür, dass Sie Veranstaltungen in strikter Reihenfolge erhalten.  Um dieses Problem zu lösen, wird das Plugin so implementiert, dass es, wenn es ein ungeordnetes Ereignis empfängt, z. B. <code>entity-A event NR 2</code> , eine bestimmte Zeit auf das erste Ereignis wartet und wenn es es nicht empfängt, einfach alle Ereignisse dieser Entität ignoriert.  Auch darüber gab es Diskussionen über Gitter.  Wenn jemand interessiert ist, können Sie die Korrespondenz zwischen @kotdv und den Entwicklern des Plugins lesen: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gitter</a> </p><br><p>  <strong>Wie kann dieses Missverständnis behoben werden:</strong> </p><br><ul><li>  Sie müssen das Plugin auf die neueste Version aktualisieren.  In neueren Versionen haben Typesafe-Entwickler viele Probleme im Zusammenhang mit der eventuellen Konsistenz gelöst.  Wir warten aber immer noch auf eine stabile Version </li><li>  Für die Komponente, die für den Empfang von Ereignissen verantwortlich ist, wurden genauere Einstellungen hinzugefügt.  Sie können versuchen, das Zeitlimit für ungeordnete Ereignisse zu erhöhen, um den Betrieb des Plugins zuverlässiger zu gestalten: c <code>assandra-query-journal.events-by-tag.eventual-consistency.delay=10s</code> </li><li>  Konfigurieren Sie Cassandra wie von DataStax empfohlen.  Setzen Sie den Garbage Collector G1 ein und weisen Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Cassandra</a> so viel Speicher wie möglich zu. </li></ul><br><p>  Am Ende haben wir das Problem mit den fehlenden Ereignissen gelöst, aber jetzt gibt es eine stabile Datenverzögerung auf der Seite der Persistenzabfrage (von fünf bis zehn Sekunden).  Es wurde beschlossen, den Ansatz für Daten, die für die Analyse verwendet werden, beizubehalten. Wenn Geschwindigkeit wichtig ist, veröffentlichen wir Ereignisse manuell im Bus.  Die Hauptsache ist, den geeigneten Mechanismus für die Verarbeitung oder Veröffentlichung von Daten zu wählen: mindestens einmal oder höchstens einmal.  Eine gute Beschreibung von Akka finden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> .  Für uns war es wichtig, die Datenkonsistenz aufrechtzuerhalten. Daher haben wir nach dem erfolgreichen Schreiben von Daten in die Datenbank einen Übergangszustand eingeführt, der die erfolgreiche Veröffentlichung von Daten auf dem Bus steuert.  Das Folgende ist ein Beispielcode: </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeEntity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Event</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uuid</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> } <span class="hljs-comment"><span class="hljs-comment">/** * ,    . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DidSomething</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">uuid: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Event</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">/**</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">*</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">*/</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LastEventPublished</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">uuid: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Event</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">/**</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">*</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">*</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">@param</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unpublishedEvents</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">–</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">*/</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">State</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">unpublishedEvents: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Seq</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Event</span></span></span></span><span class="hljs-class"><span class="hljs-params">]</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">State</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updated</span></span></span></span>(event: <span class="hljs-type"><span class="hljs-type">Event</span></span>): <span class="hljs-type"><span class="hljs-type">State</span></span> = event <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> evt: <span class="hljs-type"><span class="hljs-type">DidSomething</span></span> =&gt; copy( unpublishedEvents = unpublishedEvents :+ evt ) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> evt: <span class="hljs-type"><span class="hljs-type">LastEventPublished</span></span> =&gt; copy( unpublishedEvents = unpublishedEvents.filter(_.uuid != evt.uuid) ) } } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeEntity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PersistentActor</span></span></span><span class="hljs-class"> </span></span>{ … persist(newEvent) { evt =&gt; updateState(evt) publishToEventBus(evt) } … }</code> </pre> <br><p>  Wenn es aus irgendeinem Grund nicht möglich war, das Ereignis zu veröffentlichen, wird beim nächsten Start von <code>SomeEntity</code> , dass das <code>DidSomething</code> Ereignis den Bus nicht erreicht hat, und es wird versucht, die Daten erneut zu veröffentlichen. </p><br><h3 id="serializator">  Serializer </h3><br><p>  Die Serialisierung ist ein ebenso wichtiger Punkt bei der Verwendung von Akka.  Er hat ein internes Modul - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Akka Serialization</a> .  Dieses Modul wird verwendet, um Nachrichten beim Austausch zwischen Akteuren und beim Speichern über die Persistenz-API zu serialisieren.  Standardmäßig wird der Java-Serializer verwendet, es wird jedoch empfohlen, einen anderen zu verwenden.  Das Problem ist, dass der Java Serializer langsam ist und viel Platz beansprucht.  Es gibt zwei beliebte Lösungen: JSON und Protobuf.  JSON ist zwar langsam, aber einfacher zu implementieren und zu warten.  Wenn Sie die Kosten für Serialisierung und Datenspeicherung minimieren müssen, können Sie bei Protobuf anhalten, aber dann wird der Entwicklungsprozess langsamer.  Zusätzlich zum Domänenmodell müssen Sie ein weiteres Datenmodell schreiben.  Vergessen Sie nicht die Datenversionierung.  Seien Sie darauf vorbereitet, ständig eine Zuordnung zwischen dem Domänenmodell und dem Datenmodell zu schreiben. </p><br><p><img src="https://habrastorage.org/webt/ag/fk/h0/agfkh04g1ykq5ymlxl0ma5ciwmo.png"></p><br><p>  Neues Ereignis hinzugefügt - Zuordnung schreiben.  Datenstruktur geändert - Schreiben Sie eine neue Version des Datenmodells und ändern Sie die Zuordnungsfunktion.  Vergessen Sie nicht die Tests für Serializer.  Im Allgemeinen wird es viel Arbeit geben, aber am Ende erhalten Sie lose gekoppelte Komponenten. </p><br><h3 id="vyvody">  Schlussfolgerungen </h3><br><ul><li>  Studieren Sie sorgfältig und wählen Sie eine geeignete Basis und ein Plugin für sich.  Ich empfehle, ein Plugin zu wählen, das gut gepflegt ist und nicht aufhört, sich zu entwickeln.  Das Gebiet ist relativ neu, es gibt noch eine Reihe von Mängeln, die noch behoben werden müssen </li><li>  Wenn Sie verteilten Speicher auswählen, müssen Sie das Problem mit einer Verzögerung von bis zu 10 Sekunden selbst lösen oder in Kauf nehmen </li><li>  Die Komplexität der Serialisierung.  Sie können Geschwindigkeit opfern und auf JSON anhalten oder Protobuf wählen und viele Adapter schreiben und diese unterstützen. </li><li>  Diese Vorlage hat Vorteile: Es handelt sich um lose gekoppelte Komponenten und unabhängige Entwicklungsteams, die ein großes System bilden. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de453418/">https://habr.com/ru/post/de453418/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de453408/index.html">Toolbox für Forscher - Zweite Ausgabe: Eine Sammlung von 15 thematischen Datenbanken</a></li>
<li><a href="../de453410/index.html">Werfen Sie keine intelligenten Glühbirnen in den Müll oder in die Gefahr von IoT</a></li>
<li><a href="../de453412/index.html">Top 3D Shop wird exklusiver Distributor von UFactory</a></li>
<li><a href="../de453414/index.html">Der Aufstieg und Fall von IEO, alles, was Sie über die neue Welle des Fundraising wissen müssen</a></li>
<li><a href="../de453416/index.html">Funktionsweise der Konfiguration in .NET Core</a></li>
<li><a href="../de453422/index.html">Bekanntschaft mit ITSM: 10 Habratopiks und Expertenmaterialien zum „schnellen Eintauchen“ in das Thema</a></li>
<li><a href="../de453428/index.html">Verbesserung der Lesbarkeit von Code in der iOS-Entwicklung</a></li>
<li><a href="../de453430/index.html">Da habe ich meine Überwachung geschrieben</a></li>
<li><a href="../de453432/index.html">Von Kritikern zu Algorithmen: die verblassende Stimme der Eliten in der Welt der Musik</a></li>
<li><a href="../de453434/index.html">Vielseitigkeit der Kassetten: Sensoren in Spielen für Game Boy</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>