<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>â—€ï¸ â™’ï¸ ğŸ”ƒ ä¸–ç•Œæ‚¨å¥½ï¼ æ·±å…¥æµ¸å…¥ç»ˆç«¯ ğŸšŠ ğŸ› ï¸ ğŸ¤¾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ä¸€ç¯‡æœ‰å…³Sishny printfåˆ†æçš„æ–‡ç« å¯å‘äº†æˆ‘å†™è¿™ç¯‡æ–‡ç« ã€‚ ä½†æ˜¯ï¼Œé”™è¿‡äº†ç‰‡åˆ»ä¹‹åæ•°æ®è¿›å…¥ç»ˆç«¯è®¾å¤‡çš„æ–¹å¼ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘æƒ³çº æ­£æ­¤ç¼ºé™·å¹¶åˆ†æç»ˆç«¯ä¸­çš„æ•°æ®è·¯å¾„ã€‚ æˆ‘ä»¬è¿˜å°†å¼„æ¸…Terminalä¸Shellçš„åŒºåˆ«ï¼ŒPseudoterminalæ˜¯ä»€ä¹ˆï¼ŒTerminal Emulatorå¦‚ä½•å·¥ä½œç­‰ç­‰ã€‚ 
 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ä¸–ç•Œæ‚¨å¥½ï¼ æ·±å…¥æµ¸å…¥ç»ˆç«¯</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460257/"><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/webt/ha/5f/0v/ha5f0vjiijc9c92bnnt56z7jcpg.jpeg"></a> </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¸€ç¯‡æœ‰å…³Sishny printfåˆ†æçš„æ–‡ç« </a>å¯å‘äº†æˆ‘å†™è¿™ç¯‡æ–‡ç« ã€‚ ä½†æ˜¯ï¼Œé”™è¿‡äº†ç‰‡åˆ»ä¹‹åæ•°æ®è¿›å…¥ç»ˆç«¯è®¾å¤‡çš„æ–¹å¼ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘æƒ³çº æ­£æ­¤ç¼ºé™·å¹¶åˆ†æç»ˆç«¯ä¸­çš„æ•°æ®è·¯å¾„ã€‚ æˆ‘ä»¬è¿˜å°†å¼„æ¸…Terminalä¸Shellçš„åŒºåˆ«ï¼ŒPseudoterminalæ˜¯ä»€ä¹ˆï¼ŒTerminal Emulatorå¦‚ä½•å·¥ä½œç­‰ç­‰ã€‚ </p><a name="habracut"></a><br><h2 id="osnovy"> åŸºç¡€çŸ¥è¯† </h2><br><p> é¦–å…ˆè®©æˆ‘ä»¬äº†è§£ä¸€ä¸‹Terminalï¼ŒShellï¼ŒConsoleæ˜¯ä»€ä¹ˆï¼ŒTerminal Emulatorä¸æ™®é€šTerminalæœ‰ä½•ä¸åŒï¼Œä»¥åŠä¸ºä»€ä¹ˆå¦‚æ­¤å‘½åã€‚ å·²ç»æœ‰å¾ˆå¤šå…³äºæ­¤çš„ä¿¡æ¯ï¼Œå› æ­¤æ‚¨åœ¨è¿™é‡Œä¸ä¼šå¬åˆ°æ–°çš„æ¶ˆæ¯ã€‚ è¿™é‡Œå‡ ä¹æ‰€æœ‰ä¿¡æ¯éƒ½æ˜¯ä»Internetä¸Šè·å–çš„ï¼Œæˆ‘å°†åœ¨æ–‡ç« ç»“å°¾å¤„æä¾›é“¾æ¥ã€‚ è°å·²ç»çŸ¥é“æ‰€æœ‰è¿™äº›å†…å®¹æ„å‘³ç€ä»€ä¹ˆï¼Œå¯ä»¥å®‰å…¨åœ°è·³è¿‡æ­¤éƒ¨åˆ†ã€‚ </p><br><hr><br><h3 id="terminal"> èˆªç«™æ¥¼ </h3><br><p>  <strong>ç»ˆç«¯</strong>æ˜¯æ˜¾ç¤ºå™¨å’Œé”®ç›˜ï¼ˆå³ç‰©ç†è®¾å¤‡ï¼‰çš„ç»„åˆã€‚ åœ¨ç»ˆç«¯æˆä¸ºè¿™ç§ç‰¹å®šç»„åˆä¹‹å‰ï¼Œå®ƒä»¬æ˜¯ä¸€ç§ç§°ä¸ºç”µä¼ æ‰“å­—æœºï¼ˆç”µä¼ æ‰“å­—æœºï¼Œç”µä¼ æ‰“å­—æœºæˆ–TTYï¼‰çš„è®¾å¤‡ï¼Œå³æ‰“å°æœºå’Œé”®ç›˜çš„ç»„åˆã€‚ é€šå¸¸ï¼Œå¤šä¸ªç»ˆç«¯è¿æ¥åˆ°åŒä¸€å°è®¡ç®—æœºã€‚ å› æ­¤ï¼Œå¯ä»¥åœ¨åŒä¸€å°è®¡ç®—æœºä¸Šä¸ºå¤šä¸ªç”¨æˆ·å·¥ä½œï¼Œå¹¶ä¸”æ¯ä¸ªäººéƒ½æœ‰è‡ªå·±çš„ä¼šè¯ï¼Œå½¼æ­¤ç‹¬ç«‹ã€‚ ç»ˆç«¯ä¹‹æ‰€ä»¥è¿™æ ·å‘½åæ˜¯å› ä¸ºå®ƒä½äºç»ˆç«¯ç”µç¼†çš„æœ«ç«¯ã€‚ </p><br><p> è¿™æ˜¯<strong>ç”µä¼ æ‰“å­—æœº</strong> ï¼š </p><br><img src="https://habrastorage.org/webt/m3/_3/yt/m3_3ytmmoofzwgpr3dpu78w8m7i.jpeg" alt="Teletype" title="ç”µä¼ æ‰“å­—" width="430" height="370"><br><br><p> è¿™æ˜¯<strong>ç»ˆç«¯</strong> ï¼š </p><br><img src="https://habrastorage.org/webt/pz/lj/eu/pzljeumccjvqmrunt-pqolnyx-c.jpeg" alt="Terminal" title="èˆªç«™æ¥¼" width="430" height="370"><br><br><hr><br><h3 id="console"> ä¸»æ§å° </h3><br><p>  <strong>æ§åˆ¶å°ï¼ˆæ§åˆ¶å°ï¼‰</strong> -ç›´æ¥è¿æ¥åˆ°è®¡ç®—æœºçš„ç»ˆç«¯ã€‚ äº‹å®æ˜¯ï¼Œå¤§å¤šæ•°ç»ˆç«¯éƒ½æ˜¯éšå¼è¿æ¥çš„ï¼Œä½†è‡³å°‘æœ‰ä¸€ä¸ªç›´æ¥è¿æ¥åˆ°è®¡ç®—æœºã€‚ å…è®¸æ§åˆ¶å°ä½¿ç”¨ä¸¥æ ¼å®šä¹‰çš„äººå‘˜åœˆå­ï¼Œå› ä¸ºå®ƒå…è®¸æ‚¨é…ç½®è®¡ç®—æœºã€‚ </p><br><hr><br><h3 id="shell"> å£³ç‰Œ </h3><br><p> å¦‚æœå‰ä¸¤ä¸ªæ˜¯ç‰©ç†è®¾å¤‡ï¼Œåˆ™æ­¤å®šä¹‰ä¸“é—¨æŒ‡è½¯ä»¶ã€‚ </p><br><p>  <strong>Shell</strong>æ˜¯å‘½ä»¤è¡Œè§£é‡Šå™¨ã€‚ ä¸»è¦ç›®çš„æ˜¯è¿è¡Œå…¶ä»–ç¨‹åºã€‚ æœ‰å¤§é‡ä¸åŒçš„Shellã€‚ æœ€å¸¸è§çš„æ˜¯Bashï¼ˆå¦‚<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Wikipedia</a>æ‰€è¯´ï¼Œæ¥è‡ªè‹±è¯­çš„Bourne Again SHellï¼Œæ˜¯â€œ Born Againâ€ Shellï¼ˆå³â€œå¤æ´»â€ Shellï¼‰çš„åŒå…³è¯­ï¼‰ã€‚ å…¶ä»–ç¤ºä¾‹ï¼šDashï¼ˆè½»é‡çº§Shellï¼Œå¦‚æœåœ¨/ bin / shä¸­è¿è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œåˆ™å¯ç”¨ï¼‰ï¼ŒZshã€‚ </p><br><hr><br><p> å½“ç„¶ï¼Œç»ˆç«¯å’Œæ§åˆ¶å°éƒ½ä¸å¾—ä¸åœ¨ç°ä»£ä¸­æ‰¾åˆ°è‡ªå·±çš„åæ˜ ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å°†è¿›ä¸€æ­¥è€ƒè™‘è¯¸å¦‚<em>Terminal Emulator</em>å’Œ<em>Virtual Consoleä¹‹</em>ç±»çš„ä¸œè¥¿ã€‚ </p><br><h3 id="terminal-emulator"> ç»ˆç«¯æ¨¡æ‹Ÿå™¨ </h3><br><p>  <strong>ç»ˆç«¯ä»¿çœŸå™¨</strong> -è€å¼ç»ˆç«¯çš„ä»¿çœŸå™¨ã€‚ æ— æ³•ä¸X Windowç³»ç»Ÿç›´æ¥äº¤äº’çš„ç¨‹åº-Bashï¼ŒVimç­‰éœ€è¦ç»ˆç«¯ä»¿çœŸå™¨ã€‚ </p><br><p> è®©æˆ‘ä»¬é¦–å…ˆç¡®å®šç»ˆç«¯çš„èŒè´£ï¼š </p><br><ol><li> å°†ç”¨æˆ·è¾“å…¥ä¼ è¾“åˆ°è®¡ç®—æœº </li><li> å°†è®¡ç®—æœºè¾“å‡ºä¼ é€åˆ°æ˜¾ç¤ºå™¨ </li></ol><br><p> å› æ­¤ï¼Œæˆ‘ä»¬çš„ç»ˆç«¯ä»¿çœŸå™¨æ‰§è¡Œçš„æ“ä½œå®Œå…¨ç›¸åŒï¼šå®ƒå°†ç”¨æˆ·è¾“å…¥ä¼ é€’ç»™æ­£åœ¨è¿è¡Œçš„ç¨‹åºï¼Œå¹¶åœ¨æ˜¾ç¤ºå±ä¸Šæ˜¾ç¤ºè¯¥ç¨‹åºçš„è¾“å‡ºã€‚ æ— è®ºå¦‚ä½•ï¼Œå«ä¹‰ä»ç„¶å­˜åœ¨-åœ¨ç”¨æˆ·å’Œæ­£åœ¨è¿è¡Œçš„ç¨‹åºä¹‹é—´ï¼Œå­˜åœ¨æŸç§è´Ÿè´£è¾“å…¥/è¾“å‡ºçš„å±‚ã€‚ ç»ˆç«¯ä»¿çœŸå™¨çš„ç¤ºä¾‹ï¼šgnome-terminalï¼Œxtermï¼Œkonsoleã€‚ </p><br><p>  <strong>è¯·ä¸è¦æ··æ·†å¤–å£³ç¨‹åºå’Œç»ˆç«¯ä»¿çœŸå™¨ï¼</strong> <br> ç»ˆç«¯ä»¿çœŸå™¨æ˜¯ä¸€ä¸ªGUIåº”ç”¨ç¨‹åºï¼Œå³X Windowç³»ç»Ÿä¸­çš„ä¸€ä¸ªçª—å£ã€‚  Shellæ˜¯å‘½ä»¤è¡Œè§£é‡Šå™¨ï¼Œå³åªæ˜¯å‘½ä»¤æ‰§è¡Œç¨‹åºï¼Œå®ƒæ²¡æœ‰å›¾å½¢åŒ–çš„Shellã€‚ è¯´å¾—å¾ˆå¯¹ï¼Œæ‚¨<strong>æ²¡æœ‰å¯åŠ¨Bash</strong> ï¼Œè€Œæ˜¯<strong>è¿è¡ŒTerminal Emulatorï¼Œåè€…åœ¨å†…éƒ¨å¯åŠ¨äº†Bash</strong> ã€‚ ç»ˆç«¯ä»¿çœŸå™¨å’ŒBashç»å¯¹æ˜¯2ä¸ªä¸åŒçš„ç¨‹åºã€‚ ç¬¬ä¸€ä¸ªå®Œå…¨è´Ÿè´£è¾“å…¥/è¾“å‡ºï¼Œç¬¬äºŒä¸ª-å¤„ç†å‘½ä»¤ã€‚ </p><br><p> åœ¨æœ¬æ–‡çš„è¿›ä¸€æ­¥å†…å®¹ä¸­ï¼Œå¯¹ç»ˆç«¯çš„æ‰€æœ‰å¼•ç”¨å°†å¼•ç”¨ç»ˆç«¯ä»¿çœŸå™¨ã€‚ </p><br><hr><br><h3 id="virtual-console-virtual-terminal"> è™šæ‹Ÿæ§åˆ¶å°ï¼ˆè™šæ‹Ÿç»ˆç«¯ï¼‰ </h3><br><p> æŒ‰Ctrl + Alt + FNï¼Œå…¶ä¸­Né€šå¸¸å…·æœ‰1åˆ°6çš„å€¼ã€‚æ‚¨åˆšæ‰çœ‹åˆ°çš„ç§°ä¸ºè™šæ‹Ÿæ§åˆ¶å°ï¼ˆè™šæ‹Ÿæ§åˆ¶å°ï¼‰æˆ–è™šæ‹Ÿç»ˆç«¯ï¼ˆè™šæ‹Ÿç»ˆç«¯ï¼‰ã€‚ è¿˜è®°å¾—æˆ‘ä¹‹å‰è¯´çš„å…³äºç»ˆç«¯çš„å†…å®¹å—ï¼Ÿ è®¸å¤šç»ˆç«¯è¿æ¥åˆ°ä¸€å°è®¡ç®—æœºï¼Œæ¯ä¸ªç»ˆç«¯æ˜¯ä¸€ä¸ªå•ç‹¬çš„ä¼šè¯ï¼Œå½¼æ­¤ç‹¬ç«‹ã€‚ è™šæ‹Ÿæ§åˆ¶å°é‡å¤äº†è¿™ä¸ªæƒ³æ³•ï¼šæ‚¨çš„è®¡ç®—æœºå†…éƒ¨å¯èƒ½æœ‰å‡ ä¸ªç‹¬ç«‹çš„ä¼šè¯ï¼ˆä½†æ˜¯ï¼Œè®¡ç®—æœºèµ„æºæ˜¾ç„¶ä»æ˜¯å…±äº«çš„ï¼‰ã€‚ </p><br><p> æ‚¨å¯ä»¥å°†è¿™ä¸ªå®ä½“å‘½åä¸ºVirtual Consoleå’ŒVirtual Terminalï¼Œå› ä¸ºæ ¹æ®å®šä¹‰ï¼Œæ§åˆ¶å°æ˜¯ç›´æ¥è¿æ¥åˆ°è®¡ç®—æœºçš„ç»ˆç«¯ï¼Œä½†æ˜¯ä»æŸç§æ„ä¹‰ä¸Šè¯´ï¼Œæ‰€æœ‰è™šæ‹Ÿç»ˆç«¯éƒ½ç›´æ¥è¿æ¥åˆ°è®¡ç®—æœºã€‚ </p><br><hr><br><h3 id="tty-ustroystva">  TTYè®¾å¤‡ </h3><br><p> æ¯ä¸ªç»ˆç«¯éƒ½åˆ†é…æœ‰è‡ªå·±çš„<em>TTYè®¾å¤‡</em> ï¼ˆç»ˆç«¯è®¾å¤‡ï¼‰ï¼Œè¯¥è®¾å¤‡æä¾›æ§åˆ¶å°ã€‚ è™½ç„¶æ‚¨ä¸å¤ªå¯èƒ½æ‰¾åˆ°ç”µä¼ æ‰“å­—æœºï¼Œä½†æ˜¯TTYçš„é™ä½ä¸€ç›´æŒç»­åˆ°ä»Šå¤©ã€‚ </p><br><p>  TTYè®¾å¤‡åŒ…å«ä¸¤ä¸ªåŸºæœ¬ç»„ä»¶ï¼š </p><br><ol><li>  <strong>è®¾å¤‡é©±åŠ¨</strong> ä»–è´Ÿè´£å°†é”®ç›˜è¾“å…¥ä¼ é€’ç»™ç¨‹åºï¼Œå¹¶è´Ÿè´£åœ¨å±å¹•ä¸Šæ˜¾ç¤ºç¨‹åºè¾“å‡ºã€‚ </li><li>  <strong>TTYçº¿å­¦ç§‘</strong> ï¼ˆä¿„è¯­-çº¿å­¦ç§‘ï¼‰ã€‚ çº¿è·¯è§„ç¨‹æ˜¯é©±åŠ¨ç¨‹åºè®¿é—®æ¥å£ï¼Œä½†æ˜¯ï¼Œå®ƒç»™TTYè®¾å¤‡å¸¦æ¥äº†å¾ˆå¤šé€»è¾‘ã€‚ å¯ä»¥è¯´ï¼Œçº¿è§„ä»£ç†ä¼šè‡´ç”µç»™é©¾é©¶å‘˜ã€‚ æˆ‘ä»¬å°†åœ¨æœ¬æ–‡ä¸­æ‰¾åˆ°è¯¥ç»„ä»¶çš„èŒè´£èŒƒå›´æ˜¯ä»€ä¹ˆã€‚ </li></ol><br><p> æ„å»ºTTYè®¾å¤‡ï¼š </p><br><p><img src="https://habrastorage.org/webt/zn/zw/dy/znzwdyjadyeidyogqoap8kfvgng.jpeg" title="æ„å»ºTTYè®¾å¤‡"></p><br><p>  TTYè®¾å¤‡æœ‰3ç§ç±»å‹ï¼š </p><br><ol><li>  <em>æ§åˆ¶å°è®¾å¤‡</em> -æä¾›è™šæ‹Ÿæ§åˆ¶å°æ“ä½œã€‚ è¯¥è®¾å¤‡çš„è¾“å…¥å’Œè¾“å‡ºå®Œå…¨ç”±å†…æ ¸æ§åˆ¶ã€‚ </li><li>  <em>PTYè®¾å¤‡</em> ï¼ˆä¼ªç»ˆç«¯ï¼‰-åœ¨çª—å£ç•Œé¢ä¸­æä¾›ç»ˆç«¯æ“ä½œã€‚ è¯¥è®¾å¤‡çš„è¾“å…¥å’Œè¾“å‡ºç”±åœ¨ç”¨æˆ·ç©ºé—´ä¸­è¿è¡Œçš„ç»ˆç«¯ä»¿çœŸå™¨æ§åˆ¶ã€‚ </li><li>  <em>ä¸²è¡Œè®¾å¤‡</em> -ç›´æ¥ä¸ç¡¬ä»¶é€šä¿¡ã€‚ å®ƒé€šå¸¸ä¸ç›´æ¥ä½¿ç”¨ï¼Œè€Œæ˜¯ä½œä¸ºç»ˆç«¯è®¾å¤‡ä½“ç³»ç»“æ„ç»„ç»‡ä¸­çš„æœ€ä½çº§åˆ«å­˜åœ¨ã€‚ </li></ol><br><p> åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ä¸“é—¨è®¨è®ºç¬¬äºŒç§TTYè®¾å¤‡-ä¼ªç»ˆç«¯ã€‚ </p><br><hr><br><h2 id="tty-line-discipline">  TTYçº¿å­¦ç§‘ </h2><br><p> æˆ‘ä»¬å¼€å§‹ç ”ç©¶TTYè®¾å¤‡ç³»åˆ—çš„è§„èŒƒã€‚ </p><br><p> çº¿è§„çš„ç¬¬ä¸€ä¸ªé‡è¦ç‰¹å¾æ˜¯å®ƒè´Ÿè´£å¤„ç†I / Oã€‚ ä¾‹å¦‚ï¼Œè¿™åŒ…æ‹¬å¤„ç†æ§åˆ¶å­—ç¬¦ï¼ˆè¯·å‚é˜…<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="æ§åˆ¶å­—ç¬¦">æ§åˆ¶å­—ç¬¦</a> ï¼‰å’Œæ ¼å¼åŒ–è¾“å‡ºã€‚ ä¾‹å¦‚ï¼Œæ‚¨è¾“å…¥äº†ä»»ä½•æ–‡æœ¬ï¼Œä½†æ˜¯çªç„¶æ‚¨æ„è¯†åˆ°è‡ªå·±åœ¨å†™ä¸œè¥¿æ—¶æƒ³é”™äº†å¹¶ä¸”æƒ³è¦åˆ é™¤å®ƒ-è¿™å°±æ˜¯è¡Œè§„çš„ä½œç”¨ã€‚ </p><br><p> æˆ‘ä»¬å°†è¯¦ç»†åˆ†æåœ¨ç»ˆç«¯ä¸­è¿è¡ŒBashæ—¶å‘ç”Ÿçš„ç¡®åˆ‡æƒ…å†µã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒTTYè®¾å¤‡åœ¨<em>å¯ç”¨å›æ˜¾çš„</em>æƒ…å†µä¸‹ä»¥è§„èŒƒæ¨¡å¼è¿è¡Œã€‚ å›å£°æ˜¯æ‚¨åœ¨å±å¹•ä¸Šè¾“å…¥çš„å­—ç¬¦çš„æ˜¾ç¤ºã€‚ </p><br><p>ä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬è¾“å…¥å­—ç¬¦<code>a</code> ï¼Œè¯¥å­—ç¬¦å°†å‘é€åˆ°TTYè®¾å¤‡ï¼Œä½†ä¼šè¢«è®¾å¤‡çš„TTYè¡Œçš„çºªå¾‹æ‰€æˆªè·ã€‚ å¥¹å°†ä¸€ä¸ªå­—ç¬¦è¯»å…¥å†…éƒ¨ç¼“å†²åŒºï¼Œçœ‹åˆ°<code>echo</code>æ¨¡å¼å·²æ‰“å¼€ï¼Œç„¶ååœ¨å±å¹•ä¸Šæ˜¾ç¤ºè¯¥å­—ç¬¦ã€‚ æ­¤æ—¶ï¼Œä»ç„¶æ— æ³•è¯»å–ç»ˆç«¯è®¾å¤‡æ‰€è¿æ¥çš„ç¨‹åºã€‚ è®©æˆ‘ä»¬æŒ‰é”®ç›˜ä¸Šçš„<code>backspace</code>é”®ã€‚ ç¬¦å·<code>^?</code> å†æ¬¡å—åˆ°çº¿è§„çš„æ‹¦æˆªï¼Œåè€…æ„è¯†åˆ°ç”¨æˆ·è¦åˆ é™¤æœ€åè¾“å…¥çš„å­—ç¬¦ï¼Œå› æ­¤ä»å…¶å†…éƒ¨ç¼“å†²åŒºä¸­åˆ é™¤äº†è¯¥å­—ç¬¦ï¼Œå¹¶ä»å±å¹•ä¸Šä¹Ÿåˆ é™¤äº†è¯¥å­—ç¬¦ã€‚ ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬æŒ‰Enteré”®ï¼Œåˆ™TTYçº¿è·¯çºªå¾‹æœ€ç»ˆä¼šå°†ä»¥å‰å†™å…¥å†…éƒ¨è§„èŒƒç¼“å†²åŒºï¼ˆåŒ…æ‹¬LFï¼‰çš„æ‰€æœ‰å†…å®¹å‘é€åˆ°ç»ˆç«¯è®¾å¤‡çš„è¯»å–ç¼“å†²åŒºã€‚ åŒæ—¶ï¼Œåœ¨å±å¹•ä¸Šæ˜¾ç¤ºå­—ç¬¦CRå’ŒLFï¼Œä»¥å°†å…‰æ ‡ç§»è‡³æ–°è¡Œ-è¿™æ˜¯è¾“å‡ºçš„æ ¼å¼ã€‚ </p><br><p> è¿™å°±æ˜¯è§„èŒƒæ¨¡å¼çš„å·¥ä½œæ–¹å¼-ä»…åœ¨æŒ‰<code>Enter</code> ï¼Œå°†æ§åˆ¶å­—ç¬¦å¤„ç†å¹¶æ ¼å¼åŒ–è¾“å‡ºåï¼Œæ‰å°†æ‰€æœ‰è¾“å…¥çš„å­—ç¬¦ä¼ è¾“åˆ°è®¾å¤‡ã€‚ </p><br><h3 id="tty-line-editing">  TTYè¡Œç¼–è¾‘ </h3><br><p>  <strong>TTYçº¿è·¯ç¼–è¾‘</strong>æ˜¯è´Ÿè´£å¤„ç†çº¿è·¯è§„ç¨‹ä¸­è¾“å…¥çš„ç»„ä»¶ã€‚ åº”è¯¥è¯´ï¼Œ <em>è¡Œç¼–è¾‘</em>æ˜¯ä¸€ä¸ªé€šç”¨æ¦‚å¿µï¼Œå®ƒä¸è¾“å…¥å¤„ç†æœ‰å…³ã€‚ ä¾‹å¦‚ï¼ŒBashå’ŒVimæœ‰è‡ªå·±çš„è¡Œç¼–è¾‘ã€‚ </p><br><p> æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<strong>stty</strong>ç¨‹åºæ§åˆ¶å½“å‰TTYè®¾å¤‡çš„çº¿è·¯çš„å­¦ç§‘è®¾ç½®ã€‚ è®©æˆ‘ä»¬å°è¯•ä¸€ä¸‹ã€‚ </p><br><p> æ‰“å¼€Bashæˆ–ä»»ä½•å…¶ä»–Shellï¼Œç„¶åé”®å…¥ï¼š </p><br><pre> <code class="plaintext hljs">stty icanon -echo</code> </pre> <br><p> ç°åœ¨å°è¯•è¾“å…¥å†…å®¹ï¼Œæ‚¨å°†çœ‹ä¸åˆ°è¾“å…¥å†…å®¹ï¼ˆä¸ç”¨æ‹…å¿ƒï¼Œæ‚¨ä»ç„¶å¯ä»¥å°†è¾“å…¥å†…å®¹ä¼ é€’ç»™ç¨‹åºï¼‰ã€‚ æ‚¨åˆšåˆšç¦ç”¨äº†å›æ˜¾-å³åœ¨å±å¹•ä¸Šæ˜¾ç¤ºè¾“å…¥çš„å­—ç¬¦ã€‚ ç°åœ¨è¾“å…¥ï¼š </p><br><pre> <code class="plaintext hljs">stty raw echo</code> </pre> <br><p> å°è¯•è¾“å…¥å†…å®¹ã€‚ æ‚¨å°†çœ‹åˆ°ç»“è®ºæ˜¯å¦‚ä½•è¢«æ‰“ç ´çš„ã€‚ ä½†æ˜¯ï¼Œä¸ºäº†è·å¾—æ›´å¤šæ•ˆæœï¼Œè®©æˆ‘ä»¬è¿›å…¥Dash type <code>/bin/sh</code> ã€‚ ç°åœ¨ï¼Œå°è¯•è¾“å…¥ç‰¹æ®Šå­—ç¬¦ï¼ˆ <code>Ctrl</code> +é”®ç›˜ä¸Šçš„ä»»ä½•å­—ç¬¦ï¼‰æˆ–ä»…æŒ‰<code>Enter</code> ã€‚ æ‚¨æ„Ÿåˆ°å›°æƒ‘-å±å¹•ä¸Šè¿™äº›å¥‡æ€ªçš„å­—ç¬¦æ˜¯ä»€ä¹ˆï¼Ÿ äº‹å®æ˜¯ï¼Œé™¤äº†è¿›å…¥å­¦ç§‘æœ€ç®€å•çš„å‘½ä»¤è¡Œç®¡ç†ç¨‹åºä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜ç¦ç”¨äº†Line Editing Bashï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥æœ‰åŠ›åœ°è§‚å¯Ÿåˆ°å¹¶ä¸»è¦åŒ…å«äº†è¯¥è¡Œçš„<em>åŸå§‹</em>å­¦ç§‘æ¨¡å¼ã€‚ æ­¤æ¨¡å¼æ ¹æœ¬ä¸å¤„ç†è¾“å…¥ï¼Œä¹Ÿä¸æ ¼å¼åŒ–è¾“å‡ºã€‚ ä¸ºä»€ä¹ˆéœ€è¦åŸå§‹æ¨¡å¼ï¼Ÿ ä¾‹å¦‚ï¼Œå¯¹äº<em>Vim</em> ï¼šå®ƒä¼šæ‰“å¼€æ•´ä¸ªç»ˆç«¯çª—å£å¹¶å¤„ç†è¾“å…¥æœ¬èº«ï¼Œè‡³å°‘ä½¿è¡Œè§„çš„ç‰¹æ®Šç¬¦å·ä¸ä¼šä¸Vimæœ¬èº«çš„ç‰¹æ®Šç¬¦å·ç›¸äº¤ã€‚ </p><br><p> ä¸ºäº†è·å¾—æ›´å¤šç†è§£ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å®šåˆ¶æ§åˆ¶å­—ç¬¦ã€‚  <code>stty &lt;control-character&gt; &lt;string&gt;</code>å‘½ä»¤å°†å¸®åŠ©æˆ‘ä»¬è§£å†³æ­¤é—®é¢˜ã€‚ <br> è¾“å…¥Bashï¼š </p><br><pre> <code class="bash hljs">stty erase 0</code> </pre> <br><p> ç°åœ¨ï¼Œ <code>erase</code>æ§åˆ¶å­—ç¬¦å°†åˆ†é…ç»™å­—ç¬¦<code>0</code> ã€‚  <code>backspace</code>æŒ‰é’®é€šå¸¸å¾ˆé‡è¦<code>^?</code>  ï¼Œä½†æ˜¯ç°åœ¨è¿™ä¸ªç‰¹æ®Šå­—ç¬¦å°†æŒ‰å­—é¢æ„ä¹‰å‘é€åˆ°PTSè¯»å–ç¼“å†²åŒº-è‡ªå·±å°è¯•ã€‚ ç°åœ¨ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨é”®ç›˜ä¸Šçš„<code>0</code>æŒ‰é’®æ“¦é™¤å­—ç¬¦ï¼Œå› ä¸ºæ‚¨è‡ªå·±è¦æ±‚ttyè¡Œè§„çŸ©å°†è¾“å…¥çš„å­—ç¬¦è¯†åˆ«ä¸º<code>erase</code>æ§åˆ¶å­—ç¬¦ã€‚ æ‚¨å¯ä»¥ä½¿ç”¨å‘½ä»¤<code>stty erase ^\?</code>è¿”å›è®¾ç½®<code>stty erase ^\?</code> æˆ–è€…åªæ˜¯å…³é—­ç»ˆç«¯ï¼Œå› ä¸ºæˆ‘ä»¬åªå½±å“äº†å½“å‰çš„ttyè®¾å¤‡ã€‚ </p><br><p> æ‚¨å¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="ç”·äººçš„é£æ ¼">man sttyä¸­</a>æ‰¾åˆ°æ›´å¤šä¿¡æ¯ã€‚ </p><br><hr><br><h2 id="terminal-emulator-i-pseudoterminal"> ç»ˆç«¯ä»¿çœŸå™¨å’Œä¼ªç»ˆç«¯ </h2><br><p> æ¯æ¬¡æˆ‘ä»¬åœ¨X Windowç³»ç»Ÿä¸­æ‰“å¼€ä¸€ä¸ªæ–°ç»ˆç«¯æ—¶ï¼ŒGNOMEç»ˆç«¯æœåŠ¡å™¨éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°è¿›ç¨‹å¹¶åœ¨å…¶ä¸­å¯åŠ¨é»˜è®¤ç¨‹åºã€‚ é€šå¸¸ï¼Œè¿™æ˜¯æŸç§Shellï¼ˆä¾‹å¦‚Bashï¼‰ã€‚ </p><br><p> ä¸æ­£åœ¨è¿è¡Œçš„ç¨‹åºçš„é€šä¿¡é€šè¿‡æ‰€è°“çš„ä¼ªç»ˆç«¯ï¼ˆpseudo-terminalï¼ŒPTYï¼‰è¿›è¡Œã€‚ ä¼ªç»ˆç«¯æœ¬èº«å­˜åœ¨äºå†…æ ¸ä¸­ï¼Œä½†æ˜¯å®ƒä»ç”¨æˆ·ç©ºé—´ï¼ˆä»ç»ˆç«¯ä»¿çœŸå™¨ï¼‰æ¥æ”¶è¾“å…¥ã€‚ </p><br><p> ä¼ªç»ˆç«¯ç”±ä»¥ä¸‹ä¸¤ä¸ª<em>è™šæ‹ŸTTYè®¾å¤‡ç»„æˆ</em> ï¼š <br>  1ï¼‰ <strong>PTYä¸»ç«™ï¼ˆPTMï¼‰</strong> -ä¼ªç»ˆç«¯çš„<strong>å¼€å¤´</strong>éƒ¨åˆ†ã€‚  GNOMEç»ˆç«¯æœåŠ¡å™¨ä½¿ç”¨å®ƒæ¥å°†é”®ç›˜è¾“å…¥ä¼ è¾“åˆ°ç»ˆç«¯å†…è¿è¡Œçš„ç¨‹åºï¼Œä»¥åŠè¯»å–ç¨‹åºè¾“å‡ºå’Œæ˜¾ç¤ºè¾“å‡ºã€‚  GNOMEç»ˆç«¯æœåŠ¡å™¨åˆé€šè¿‡Xåè®®ä¸X Windowç³»ç»Ÿé€šä¿¡ã€‚ <br>  2ï¼‰ <strong>PTYä»ç«™ï¼ˆPTSï¼‰</strong> -ä¼ªç»ˆç«¯çš„ä»ç«™éƒ¨åˆ†ã€‚ ç”±ç»ˆç«¯å†…è¿è¡Œçš„ç¨‹åºä½¿ç”¨ï¼Œä»¥è¯»å–é”®ç›˜è¾“å…¥å¹¶åœ¨å±å¹•ä¸Šæ˜¾ç¤ºè¾“å‡ºã€‚ è‡³å°‘ç¨‹åºæœ¬èº«æ˜¯è¿™æ ·è®¤ä¸ºçš„ï¼ˆæˆ‘å°†è¿›ä¸€æ­¥è§£é‡Šè¿™æ„å‘³ç€ä»€ä¹ˆï¼‰ã€‚ </p><br><p> è®°å½•åœ¨PTSè®¾å¤‡ä¸­çš„ä»»ä½•æ•°æ®éƒ½æ˜¯PTMè®¾å¤‡çš„è¾“å…¥ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒåœ¨PTMè®¾å¤‡ä¸Šå˜å¾—å¯è¯»ã€‚ åä¹‹äº¦ç„¶ï¼šPTMè®¾å¤‡ä¸­è®°å½•çš„ä»»ä½•æ•°æ®éƒ½æ˜¯PTSè®¾å¤‡çš„è¾“å…¥ã€‚ è¿™æ˜¯GNOMEç»ˆç«¯æœåŠ¡å™¨ä¸ç»ˆç«¯ä¸­è¿è¡Œçš„ç¨‹åºè¿›è¡Œé€šä¿¡çš„æ–¹å¼ã€‚ æ¯ä¸ªPTMè®¾å¤‡éƒ½ä¸è‡ªå·±çš„PTSè®¾å¤‡å…³è”ã€‚ </p><br><p> å¯åŠ¨æ–°ç»ˆç«¯çš„è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š <br>  1ï¼‰GNOMEç»ˆç«¯æœåŠ¡å™¨é€šè¿‡åœ¨ç‰¹æ®Šè®¾å¤‡<strong>/ dev / ptmx</strong>ä¸Šè°ƒç”¨openï¼ˆï¼‰å‡½æ•°æ¥åˆ›å»ºä¸»è®¾å¤‡å’Œä»è®¾å¤‡ã€‚  openï¼ˆï¼‰è°ƒç”¨è¿”å›å·²åˆ›å»ºçš„PTMè®¾å¤‡<em>master_fdçš„</em>æ–‡ä»¶æè¿°ç¬¦ã€‚ <br>  2ï¼‰GNOMEç»ˆç«¯æœåŠ¡å™¨é€šè¿‡è°ƒç”¨<code>fork()</code>åˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹ã€‚ æ­¤è¿‡ç¨‹å°†æˆä¸ºæ–°çš„ç»ˆç«¯ã€‚ <br>  3ï¼‰åœ¨PTSç»ˆç«¯ä¸­ï¼Œè®¾å¤‡æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦0ã€1ã€2ï¼ˆåˆ†åˆ«ä¸ºstdinï¼Œstdoutå’Œstderrï¼‰ã€‚ ç°åœ¨ï¼Œæ ‡å‡†ç»ˆç«¯I / Oæµåˆ°è¯¥è®¾å¤‡ã€‚ <br>  4ï¼‰é€šè¿‡è°ƒç”¨<code>exec()</code>å‡½æ•°åœ¨ç»ˆç«¯ä¸­å¯åŠ¨æ‰€éœ€çš„ç¨‹åºã€‚ é€šå¸¸ä¼šå¯åŠ¨ä¸€äº›Shellï¼ˆä¾‹å¦‚Bashï¼‰ã€‚ éšåä»Bashå¯åŠ¨çš„ä»»ä½•ç¨‹åºéƒ½å°†å…·æœ‰ä¸Bashæœ¬èº«ç›¸åŒçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç¨‹åºæµå°†å®šå‘åˆ°PTSè®¾å¤‡ã€‚ </p><br><p> æ‚¨å¯ä»¥ä½¿ç”¨<code>ls -la /proc/self/fd</code>äº²è‡ªæŸ¥çœ‹æ ‡å‡†ç»ˆç«¯è¾“å‡ºæµçš„æ–¹å‘ï¼š <br><img src="https://habrastorage.org/webt/nr/dx/97/nrdx97wllflvapnt76p3qqki3fw.jpeg"></p><br><p>  PTSè®¾å¤‡ä½äº<strong>/ dev / pts / N</strong>è·¯å¾„ä¸Šï¼Œè€Œåˆ°PTMè®¾å¤‡çš„è·¯å¾„æ ¹æœ¬ä½¿æˆ‘ä»¬ä¸æ„Ÿå…´è¶£ã€‚ äº‹å®æ˜¯GNOMEç»ˆç«¯æœåŠ¡å™¨å·²ç»å…·æœ‰ç”¨äºæ‰“å¼€çš„PTMè®¾å¤‡çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶ä¸”ä¸éœ€è¦å®ƒçš„è·¯å¾„ï¼Œä½†æ˜¯ï¼Œåœ¨å­è¿›ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»é€šè¿‡è°ƒç”¨<code>open()</code>å‡½æ•°åœ¨æ ‡å‡†è¾“å‡ºæµä¸Šæ‰“å¼€PTSè®¾å¤‡ï¼Œè¿™éœ€è¦æ–‡ä»¶çš„è·¯å¾„ã€‚ </p><br><p> è¿˜è®°å¾—æˆ‘è¯´è¿‡ä½¿ç”¨PTSè®¾å¤‡çš„ç¨‹åºåªè®¤ä¸ºå®ƒç›´æ¥ä¸ç»ˆç«¯é€šä¿¡å—ï¼Ÿ äº‹å®æ˜¯PTSä¹Ÿæ˜¯<em>ç»ˆç«¯è®¾å¤‡</em> ï¼ˆTTYè®¾å¤‡ï¼‰ï¼Œä½†æ˜¯PTSè®¾å¤‡ä¸å®é™…TTYè®¾å¤‡ä¹‹é—´çš„åŒºåˆ«åœ¨äºPTSè®¾å¤‡ä¸æ˜¯ä»é”®ç›˜æ¥æ”¶è¾“å…¥ï¼Œè€Œæ˜¯ä»ä¸»è®¾å¤‡æ¥æ”¶è¾“å…¥ï¼Œå¹¶ä¸”è¾“å‡ºä¸è¿›å…¥æ˜¾ç¤ºå™¨ï¼Œè€Œæ˜¯è¿›å…¥æ˜¾ç¤ºå™¨ã€‚ä¸»è®¾å¤‡ã€‚ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¼ªç»ˆç«¯å¦‚æ­¤å‘½åçš„åŸå› -ä¼ªç»ˆç«¯ä»…æ¨¡ä»¿ï¼ˆè¿˜æ˜¯??ï¼‰ç»ˆç«¯ã€‚ ç»ˆç«¯ä»¿çœŸå™¨å’Œä¼ªç»ˆç«¯ä¹‹é—´çš„åŒºåˆ«åœ¨äºï¼Œç»ˆç«¯ä»¿çœŸå™¨åªæ˜¯ä¸€ä¸ªå›¾å½¢ç¨‹åºï¼Œå…è®¸æ‚¨ç›´æ¥åœ¨çª—å£ç•Œé¢å†…è¿è¡Œç»ˆç«¯ï¼Œä½†æ˜¯æ­¤åŠŸèƒ½æ˜¯ä½¿ç”¨ä¼ªç»ˆç«¯å®ç°çš„ã€‚ </p><br><p>  <em>PTSè®¾å¤‡æ˜¯TTYè®¾å¤‡</em>è¿™ä¸€äº‹å®éå¸¸é‡è¦ã€‚ åŸå› å¦‚ä¸‹ï¼š </p><br><ol><li> ç»ˆç«¯è®¾å¤‡æ‰€è¿æ¥çš„ç¨‹åºå…·æœ‰å¸¸è§„ç»ˆç«¯çš„æ‰€æœ‰åŠŸèƒ½ã€‚ ä¾‹å¦‚ï¼šç¦ç”¨å›æ˜¾ï¼Œç¦ç”¨/å¯ç”¨è§„èŒƒè§†å›¾ã€‚ </li><li> è¯¥ç¨‹åºåœ¨çŸ¥é“å·²è¿æ¥ç»ˆç«¯è®¾å¤‡çš„æƒ…å†µä¸‹ï¼ˆæ®è¯´è¯¥ç¨‹åºå…·æœ‰æ§åˆ¶ç»ˆç«¯ï¼‰ï¼Œå¯ä»¥äº¤äº’å·¥ä½œå¹¶è¦æ±‚ç”¨æˆ·è¾“å…¥ã€‚ ä¾‹å¦‚ï¼Œè¦æ±‚è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ã€‚ </li><li> è¿˜æœ‰ä¸€ä¸ªTTYçº¿è·¯çºªå¾‹ï¼Œå› æ­¤æˆ‘ä»¬èƒ½å¤Ÿåœ¨æ§åˆ¶å­—ç¬¦åˆ°è¾¾ç¨‹åºä¹‹å‰å¯¹å…¶è¿›è¡Œå¤„ç†ï¼Œä»¥åŠæ ¼å¼åŒ–ç¨‹åºçš„è¾“å‡ºã€‚ </li></ol><br><p>  PTMè®¾å¤‡ä¹Ÿæ˜¯TTYè®¾å¤‡ï¼Œä½†æ˜¯ç”±äºå®ƒä¸ç”¨ä½œæ§åˆ¶ç»ˆç«¯ï¼Œå› æ­¤å®ƒæ²¡æœ‰ä»»ä½•ä½œç”¨ã€‚ æ­¤å¤–ï¼Œç”±äºPTMè®¾å¤‡çš„çº¿è·¯è§„åˆ™è®¾ç½®ä¸ºåŸå§‹æ¨¡å¼ï¼Œå› æ­¤ï¼Œåœ¨å°†æ•°æ®ä»PTSä¼ è¾“åˆ°PTMè®¾å¤‡æ—¶ä¸æ‰§è¡Œå¤„ç†ã€‚ ä½†æ˜¯ï¼Œä»ç”¨æˆ·ç©ºé—´è¿›è¡Œçš„<code>read()</code>å’Œ<code>write()</code>è°ƒç”¨ä»ç„¶é¦–å…ˆç”±è¿™ä¸¤ç§è®¾å¤‡ä¸Šçš„çº¿è·¯è§„ç¨‹æœåŠ¡ã€‚ æ­£å¦‚æˆ‘ä»¬ç¨åå°†çœ‹åˆ°çš„é‚£æ ·ï¼Œè¿™ä¸€åˆ»å°†å‘æŒ¥æ›´å¤§çš„ä½œç”¨ã€‚ </p><br><p>  GNOMEç»ˆç«¯æœåŠ¡å™¨ä¸ç»ˆç«¯ä¸­è¿è¡Œçš„ç¨‹åºä¹‹é—´çš„é€šä¿¡è¿‡ç¨‹å¦‚ä¸‹ï¼š </p><br><p><img src="https://habrastorage.org/webt/jz/y0/sg/jzy0sg0zjcceaflg6wyg7d5lkti.jpeg" title="é€šä¿¡GNOMEç»ˆç«¯æœåŠ¡å™¨å’Œç»ˆç«¯ä¸­è¿è¡Œçš„ç¨‹åºçš„è¿‡ç¨‹"></p><br><p> å€¼å¾—æ›´è¯¦ç»†åœ°ç ”ç©¶çº¿è·¯è§„åˆ™åœ¨ä¼ªç»ˆç«¯çš„ä¸¤ä¸ªéƒ¨åˆ†ä¹‹é—´è¿›è¡Œé€šä¿¡æ—¶æ‰€æ‰®æ¼”çš„è§’è‰²ã€‚ åœ¨æ­¤ï¼Œçº¿è·¯è§„åˆ™è´Ÿè´£å¤„ç†<em>ä»PTMä¼ é€’åˆ°PTSè®¾å¤‡çš„æ•°æ®</em> ï¼Œå¹¶è´Ÿè´£å°†æ•°æ®ä»ä¼ªç»ˆç«¯çš„ä¸€éƒ¨åˆ†ä¼ é€’åˆ°å¦ä¸€éƒ¨åˆ†ã€‚ å½“æˆ‘ä»¬è¿›å…¥PTSè®¾å¤‡é©±åŠ¨ç¨‹åºæ—¶ï¼Œæˆ‘ä»¬ä¼šå‚ä¸PTMè®¾å¤‡çš„çº¿è·¯è§„ç¨‹ï¼Œåä¹‹äº¦ç„¶ã€‚ </p><br><hr><br><h2 id="virtualnye-ustroystva"> è™šæ‹Ÿè®¾å¤‡ </h2><br><p> æ‚¨å¯èƒ½ä¼šæƒ³åˆ°ï¼Œæ‚¨å¯ä»¥æ²¿ç€<em>/ dev / pts / N</em>è·¯å¾„æ‰“å¼€æ–‡ä»¶ï¼Œå¹¶ä»æ–‡ä»¶ä¸­å†™å…¥æˆ–è¯»å–æ•°æ®ï¼Œå°±åƒä»å¸¸è§„æ–‡æœ¬æ–‡ä»¶ä¸­è¯»å–æ•°æ®ä¸€æ ·ï¼Ÿ æ˜¯çš„ï¼Œç”±äºUnixçš„åŸºæœ¬åŸç†ï¼ˆæ‰€æœ‰å†…å®¹éƒ½æ˜¯æ–‡ä»¶ï¼‰ï¼Œå› æ­¤ç±»Unixç³»ç»Ÿä¸Šçš„æ‰€æœ‰è®¾å¤‡éƒ½æ˜¯æ–‡ä»¶ã€‚ ä½†æ˜¯ï¼Œæ²¡æœ‰ç‰¹æ®Šçš„è®¾å¤‡æ–‡ä»¶ï¼ˆè‹±è¯­-è®¾å¤‡æ–‡ä»¶ï¼‰æ˜¯æ–‡æœ¬æ–‡ä»¶ã€‚ æ­¤ç±»è®¾å¤‡ç§°ä¸º<strong>è™šæ‹Ÿè®¾å¤‡</strong> -å³å®ƒä»¬ä»…å­˜åœ¨äºå†…å­˜ä¸­ï¼Œè€Œä¸å­˜åœ¨äºç£ç›˜ä¸Šã€‚ </p><br><p> ä¸è¦å°è¯•å°†è¿™äº›æ–‡ä»¶ä½œä¸ºå¸¸è§„æ–‡æœ¬æ–‡ä»¶æ‰“å¼€ã€‚ ä½†æ˜¯ï¼Œæ‚¨å¯ä»¥é€šè¿‡<code>write()</code>å’Œ<code>read()</code>æ“ä½œä½¿ç”¨è¿™äº›è®¾å¤‡ï¼Œå…¶è°ƒç”¨å°†ç”±è®¾å¤‡é©±åŠ¨ç¨‹åºæä¾›ã€‚ è®©æˆ‘ä»¬å°è¯•å»åšã€‚ </p><br><p> æ‰“å¼€ä¸¤ä¸ªç»ˆç«¯çª—å£ï¼Œç„¶ååœ¨æ¯ä¸ªå‘½ä»¤ä¸­è¾“å…¥<code>tty</code> ã€‚ è¯¥å‘½ä»¤å°†æ˜¾ç¤ºå“ªä¸ªTTYè®¾å¤‡æ­£åœ¨ä¸ºå½“å‰æ´»åŠ¨çš„ç»ˆç«¯æœåŠ¡ã€‚ ç°åœ¨è¾“å…¥<code>echo "Hello, World!" &gt; /dev/pts/N</code>  <code>echo "Hello, World!" &gt; /dev/pts/N</code> ï¼Œåœ¨ç¬¬ä¸€ä¸ªç»ˆç«¯çª—å£ä¸­ï¼Œå…¶ä¸­Næ˜¯ç¬¬äºŒä¸ªçª—å£è®¾å¤‡çš„PTSç´¢å¼•ï¼Œåˆ‡æ¢åˆ°ç¬¬äºŒä¸ªçª—å£ï¼Œæ‚¨å°†åœ¨ç¬¬ä¸€ä¸ªçª—å£ä¸­çœ‹åˆ°è¾“å…¥ã€‚ ç°åœ¨ï¼Œæ‚¨å·²å°†æ•°æ®å†™å…¥ç¬¬äºŒä¸ªçª—å£çš„PTSè®¾å¤‡ï¼Œ <em>å°±å¥½åƒæ˜¯ç”±è¯¥ç»ˆç«¯ä¸­è¿è¡Œçš„ç¨‹åºå®Œæˆçš„ä¸€æ ·</em> ã€‚ </p><br><p><img src="https://habrastorage.org/webt/nj/3s/rp/nj3srpuzyahyvukzicfr0b5wnja.png"></p><br><hr><br><h2 id="ustroystvo-psevdoterminala"> ä¼ªç»ˆç«¯è®¾å¤‡ </h2><br><p> æˆ‘ä»¬è¶Šæ¥è¶Šæ¥è¿‘æœ¬æ–‡çš„æœ€åä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹Linuxçš„â€œå¹•åâ€-åœ¨å†…æ ¸çº§åˆ«è€ƒè™‘ä¼ªç»ˆç«¯çš„è®¾å¤‡ã€‚ ä¼šæœ‰å¾ˆå¤šä»£ç ï¼Œä½†æ˜¯æˆ‘å°†å°è¯•å°½å¯èƒ½è¯¦ç»†åœ°è§£é‡Šæ¯ä¸ªç»™å®šçš„ä»£ç å—ï¼Œå‡å°‘ä¸é‡è¦çš„ç»†èŠ‚å¹¶æŒ‰é¡ºåºè¿›è¡Œã€‚ </p><br><p> åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å°†ä»‹ç»æ‰€è°“çš„â€œç»„ä»¶ç¯®â€ã€‚ å½“æˆ‘ä»¬æ²¿ç€æ ¸å¿ƒå‰è¿›æ—¶ï¼Œæˆ‘ä»¬å°†å‘å®ƒæ·»åŠ è¶Šæ¥è¶Šå¤šçš„ç»„ä»¶ï¼Œå¹¶åœ¨å®ƒä»¬ä¹‹é—´æ‰¾åˆ°è”ç³»ã€‚ å¸Œæœ›è¿™å¯ä»¥å¸®åŠ©æ‚¨æ›´å¥½åœ°äº†è§£ä¼ªç»ˆç«¯è®¾å¤‡ã€‚ è®©æˆ‘ä»¬å¼€å§‹å§ã€‚ </p><br><p>  Linuxå¯åŠ¨æ—¶ï¼Œå®ƒå°†åŠ è½½å¿…è¦çš„è®¾å¤‡é©±åŠ¨ç¨‹åºã€‚ æˆ‘ä»¬çš„ä¼ªç»ˆç«¯ä¹Ÿæœ‰è¿™æ ·çš„é©±åŠ¨ç¨‹åºã€‚ å…¶æ³¨å†Œä»è°ƒç”¨æ­¤å‡½æ•°å¼€å§‹ï¼š </p><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __init pty_init(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { legacy_pty_init(); unix98_pty_init(); <span class="hljs-comment"><span class="hljs-comment">// &lt;- ,    return 0; } device_initcall(pty_init); // ,      </span></span></code> </pre> <br><p> å¯¹äºæ‰€æœ‰ç°ä»£ç³»ç»Ÿï¼Œå°†<code>unix98_pty_init()</code>å‡½æ•°ï¼š </p><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __init unix98_pty_init(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { ptm_driver = tty_alloc_driver(NR_UNIX98_PTY_MAX, TTY_DRIVER_RESET_TERMIOS | TTY_DRIVER_REAL_RAW | TTY_DRIVER_DYNAMIC_DEV | TTY_DRIVER_DEVPTS_MEM | TTY_DRIVER_DYNAMIC_ALLOC); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IS_ERR(ptm_driver)) panic(<span class="hljs-string"><span class="hljs-string">"Couldn't allocate Unix98 ptm driver"</span></span>); pts_driver = tty_alloc_driver(NR_UNIX98_PTY_MAX, TTY_DRIVER_RESET_TERMIOS | TTY_DRIVER_REAL_RAW | TTY_DRIVER_DYNAMIC_DEV | TTY_DRIVER_DEVPTS_MEM | TTY_DRIVER_DYNAMIC_ALLOC); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IS_ERR(pts_driver)) panic(<span class="hljs-string"><span class="hljs-string">"Couldn't allocate Unix98 pts driver"</span></span>); ptm_driver-&gt;driver_name = <span class="hljs-string"><span class="hljs-string">"pty_master"</span></span>; ptm_driver-&gt;name = <span class="hljs-string"><span class="hljs-string">"ptm"</span></span>; ptm_driver-&gt;major = UNIX98_PTY_MASTER_MAJOR; ptm_driver-&gt;minor_start = <span class="hljs-number"><span class="hljs-number">0</span></span>; ptm_driver-&gt;type = TTY_DRIVER_TYPE_PTY; ptm_driver-&gt;subtype = PTY_TYPE_MASTER; ptm_driver-&gt;init_termios = tty_std_termios; ptm_driver-&gt;init_termios.c_iflag = <span class="hljs-number"><span class="hljs-number">0</span></span>; ptm_driver-&gt;init_termios.c_oflag = <span class="hljs-number"><span class="hljs-number">0</span></span>; ptm_driver-&gt;init_termios.c_cflag = B38400 | CS8 | CREAD; ptm_driver-&gt;init_termios.c_lflag = <span class="hljs-number"><span class="hljs-number">0</span></span>; ptm_driver-&gt;init_termios.c_ispeed = <span class="hljs-number"><span class="hljs-number">38400</span></span>; ptm_driver-&gt;init_termios.c_ospeed = <span class="hljs-number"><span class="hljs-number">38400</span></span>; ptm_driver-&gt;other = pts_driver; tty_set_operations(ptm_driver, &amp;ptm_unix98_ops); pts_driver-&gt;driver_name = <span class="hljs-string"><span class="hljs-string">"pty_slave"</span></span>; pts_driver-&gt;name = <span class="hljs-string"><span class="hljs-string">"pts"</span></span>; pts_driver-&gt;major = UNIX98_PTY_SLAVE_MAJOR; pts_driver-&gt;minor_start = <span class="hljs-number"><span class="hljs-number">0</span></span>; pts_driver-&gt;type = TTY_DRIVER_TYPE_PTY; pts_driver-&gt;subtype = PTY_TYPE_SLAVE; pts_driver-&gt;init_termios = tty_std_termios; pts_driver-&gt;init_termios.c_cflag = B38400 | CS8 | CREAD; pts_driver-&gt;init_termios.c_ispeed = <span class="hljs-number"><span class="hljs-number">38400</span></span>; pts_driver-&gt;init_termios.c_ospeed = <span class="hljs-number"><span class="hljs-number">38400</span></span>; pts_driver-&gt;other = ptm_driver; tty_set_operations(pts_driver, &amp;pty_unix98_ops); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tty_register_driver(ptm_driver)) panic(<span class="hljs-string"><span class="hljs-string">"Couldn't register Unix98 ptm driver"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tty_register_driver(pts_driver)) panic(<span class="hljs-string"><span class="hljs-string">"Couldn't register Unix98 pts driver"</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* Now create the /dev/ptmx special device */</span></span> tty_default_fops(&amp;ptmx_fops); ptmx_fops.open = ptmx_open; cdev_init(&amp;ptmx_cdev, &amp;ptmx_fops); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cdev_add(&amp;ptmx_cdev, <span class="hljs-built_in"><span class="hljs-built_in">MKDEV</span></span>(TTYAUX_MAJOR, <span class="hljs-number"><span class="hljs-number">2</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span>) || register_chrdev_region(<span class="hljs-built_in"><span class="hljs-built_in">MKDEV</span></span>(TTYAUX_MAJOR, <span class="hljs-number"><span class="hljs-number">2</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"/dev/ptmx"</span></span>) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) panic(<span class="hljs-string"><span class="hljs-string">"Couldn't register /dev/ptmx driver"</span></span>); device_create(tty_class, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">MKDEV</span></span>(TTYAUX_MAJOR, <span class="hljs-number"><span class="hljs-number">2</span></span>), <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"ptmx"</span></span>);</code> </pre> <br><p> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯¹ä¸‰ä»¶äº‹æ„Ÿå…´è¶£ï¼š </p><br><ol><li> ä¸ºptyä¸»é©±åŠ¨ç¨‹åºå’Œptyä»è®¾å¤‡è°ƒç”¨<code>tty_set_operatons</code> ã€‚ </li><li>  <code>ptmx_open</code>å‡½æ•°ï¼Œç”¨äºåœ¨æ‰“å¼€ç‰¹æ®Šè®¾å¤‡<em>/ dev / ptmx</em>æ—¶åˆ›å»ºä¼ªç»ˆç«¯çš„ä¸¤ä¸ªéƒ¨åˆ†ã€‚ é‡è¦è¯´æ˜ï¼š/ dev / ptmxä¸æ˜¯PTMè®¾å¤‡ï¼Œè€Œåªæ˜¯ç”¨äºåˆ›å»ºæ–°çš„ä¼ªç»ˆç«¯çš„æ¥å£ã€‚ </li><li> æ³¨å†ŒPTMå’ŒPTSè®¾å¤‡é©±åŠ¨ç¨‹åºã€‚ </li></ol><br><p> è®©æˆ‘ä»¬æŒ‰é¡ºåºè¿›è¡Œï¼š </p><br><h4 id="1-tty_set_operations">  1. tty_set_operations </h4><br><p>  <strong>tty_set_operationsï¼ˆï¼‰</strong>å‡½æ•°åªæ˜¯ä¸ºå½“å‰é©±åŠ¨ç¨‹åºè®¾ç½®ä¸€ä¸ªå‡½æ•°è¡¨ï¼š </p><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> tty_set_operations(<span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_driver *driver, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_operations *op) { driver-&gt;ops = op; };</code> </pre> <br><p>  <strong>tty_operations</strong>ç»“æ„æ˜¯ä¸€ä¸ªåŠŸèƒ½è¡¨ï¼Œç”¨äºè®¿é—®è®¾å¤‡TTYé©±åŠ¨ç¨‹åºåŠŸèƒ½ã€‚ </p><br><p> æˆ‘å°†åœ¨ç»“æ„<code>pty_unix98_ops</code>å’Œ<code>ptm_unix98_ops</code>æœ€é‡è¦çš„ä¸œè¥¿ï¼Œå®ƒä»¬æ˜¯ä¼ªç»ˆç«¯ç›¸åº”éƒ¨åˆ†çš„åŠŸèƒ½è¡¨ï¼š </p><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_operations ptm_unix98_ops = { .install = pty_unix98_install, .remove = pty_unix98_remove, .open = pty_open, .close = pty_close, .write = pty_write, <span class="hljs-comment"><span class="hljs-comment">// ... }; static const struct tty_operations pty_unix98_ops = { .install = pty_unix98_install, .remove = pty_unix98_remove, .open = pty_open, .close = pty_close, .write = pty_write, // ... };</span></span></code> </pre> <br><p> åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥è§‚å¯Ÿåˆ°pty_writeå‡½æ•°ï¼Œ <code>pty_write</code>å‡½æ•°å·²ç»åœ¨Sishny printfä¸Šçš„æ–‡ç« ä¸­å¾ˆç†Ÿæ‚‰äº†-æˆ‘ä»¬ç¨åå†è¿”å›ã€‚ </p><br><p> è®©æˆ‘ä»¬å°†æ­¤ç»“æ„æ·»åŠ åˆ°ç»„ä»¶ç¯®ä¸­ï¼š <br><img src="https://habrastorage.org/webt/o8/e-/kc/o8e-kcpqestn7f481gcx38qmzuo.jpeg"></p><br><p> å¦‚æ‚¨æ‰€è§ï¼Œä¸¤ä¸ªé©±åŠ¨ç¨‹åºçš„ä¸»è¦æ–¹æ³•å®Œå…¨æ²¡æœ‰åŒºåˆ«ã€‚ é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œè¯·æ³¨æ„ï¼Œæ²¡æœ‰ç”¨äºreadï¼ˆï¼‰æ“ä½œçš„åŠŸèƒ½-æ²¡æœ‰åƒ<code>pty_read()</code> ã€‚ äº‹å®æ˜¯ï¼Œé˜…è¯»å°†å®Œå…¨ç”±å­¦ç§‘æ¥æœåŠ¡ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬äº†è§£äº†ç”Ÿäº§çº¿è§„ç¨‹çš„ç¬¬äºŒä¸ªé‡è¦ç‰¹å¾-ä»TTYè®¾å¤‡è¯»å–æ•°æ®ã€‚ </p><br><hr><br><h4 id="2-ptmx_open">  2. ptmx_open </h4><br><p> ç°åœ¨è®©æˆ‘ä»¬ç»§ç»­åˆ°<strong>ptmx_openï¼ˆï¼‰</strong> ï¼š </p><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ptmx_open(<span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> inode *inode, <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> file *filp) { <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_struct *tty; <span class="hljs-comment"><span class="hljs-comment">//    -   ! fsi = devpts_acquire(filp); //     devpts index = devpts_new_index(fsi); //       /dev/pts // ... tty = tty_init_dev(ptm_driver, index); // ... devpts_pty_new(fsi, index, tty-&gt;link); //     /dev/pts retval = ptm_driver-&gt;ops-&gt;open(tty, filp); //  PTM ,   }</span></span></code> </pre> <br><p> æˆ‘ä»¬å¯¹<code>tty_init_dev()</code>å‡½æ•°æ„Ÿå…´è¶£ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯PTMè®¾å¤‡é©±åŠ¨ç¨‹åºï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è®¾å¤‡ç´¢å¼•ã€‚ åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ç¦»å¼€äº†PTYé©±åŠ¨ç¨‹åºçš„è´£ä»»èŒƒå›´ï¼Œå¹¶è½¬åˆ°è¯¥æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä»…å¯¹å¸¸è§„TTYè®¾å¤‡è´Ÿè´£ï¼Œè€Œå¯¹ä¼ªç»ˆç«¯ä¸€æ— æ‰€çŸ¥ã€‚ </p><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_struct *tty_init_dev(<span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_driver *driver, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> idx) { <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_struct *tty; tty = alloc_tty_struct(driver, idx); retval = tty_driver_install_tty(driver, tty); <span class="hljs-comment"><span class="hljs-comment">/* * Structures all installed ... call the ldisc open routines. */</span></span> retval = tty_ldisc_setup(tty, tty-&gt;link); <span class="hljs-comment"><span class="hljs-comment">//  ,       return tty; }</span></span></code> </pre> <br><p> é¦–å…ˆï¼Œæˆ‘ä»¬å°†<code>alloc_tty_struct()</code>å‡½æ•°ï¼š </p><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_struct *alloc_tty_struct(<span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_driver *driver, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> idx) { <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_struct *tty; tty = kzalloc(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(*tty), GFP_KERNEL); <span class="hljs-comment"><span class="hljs-comment">//  tty_struct tty_ldisc_init(tty) //      tty_struct tty-&gt;driver = driver; //       tty_struct tty-&gt;ops = driver-&gt;ops; //        tty_struct.     tty-&gt;index = idx; //   tty  return tty; }</span></span></code> </pre> <br><p> æˆ‘ä»¬å”¯ä¸€æ„Ÿå…´è¶£çš„æ˜¯<code>tty_ldisc_init()</code>å‡½æ•°ï¼š </p><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> tty_ldisc_init(<span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_struct *tty) { <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_ldisc *ld = tty_ldisc_get(tty, N_TTY); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IS_ERR(ld)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> PTR_ERR(ld); tty-&gt;ldisc = ld; <span class="hljs-comment"><span class="hljs-comment">//        tty_struct return 0; }</span></span></code> </pre> <br><p> å“ªä¸ªè°ƒç”¨<code>tty_ldisc_get()</code> ï¼š </p><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_ldisc *tty_ldisc_get(<span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_struct *tty, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> disc) { <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_ldisc *ld; <span class="hljs-comment"><span class="hljs-comment">//    struct tty_ldisc_ops *ldops; //     ldops = get_ldops(disc); //      .   ,       .   - N_TTY ld = kmalloc(sizeof(struct tty_ldisc), GFP_KERNEL | __GFP_NOFAIL); ld-&gt;ops = ldops; //       ld-&gt;tty = tty; //    tty_struct   .          return ld; }</span></span></code> </pre> <br><p> å› æ­¤ï¼Œæˆ‘ä»¬æ£€æŸ¥äº†å¯¹<code>alloc_tty_struct()</code>å‡½æ•°çš„è°ƒç”¨ï¼Œè¯¥å‡½æ•°åˆ›å»ºäº†<em>tty_struct</em>ç»“æ„ä»¥åŠè¡Œè§„<em>-tty_ldisc</em>ç»“æ„ã€‚ ä¸¤ç§ç»“æ„ç›¸äº’ä¹‹é—´éƒ½æœ‰é“¾æ¥ã€‚ è®©æˆ‘ä»¬ä»”ç»†çœ‹çœ‹è¿™äº›ç»“æ„ã€‚ </p><br><ul><li>  <strong>tty_struct</strong>æ˜¯ç”¨äºè®¿é—®TTYè®¾å¤‡é©±åŠ¨ç¨‹åºå’Œå…¶ä»–ä¸€äº›å­—æ®µçš„ç»“æ„ã€‚ çœ‹èµ·æ¥åƒè¿™æ ·ï¼š </li></ul><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_struct { <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_driver *driver; <span class="hljs-comment"><span class="hljs-comment">//  TTY  const struct tty_operations *ops; //  .    ,   driver-&gt;ops,       int index; //   struct tty_ldisc *ldisc; //     struct tty_struct *link; //     PTY // ... }</span></span></code> </pre> <br><ul><li>  <strong>tty_ldisc</strong>æ˜¯è¯¥è®¾å¤‡çš„TTYè¡Œçš„è§„åˆ™ç»“æ„ã€‚ å®ƒä»…åŒ…å«ä¸¤ä¸ªå­—æ®µï¼Œå¤–è§‚å¦‚ä¸‹ï¼š </li></ul><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_ldisc { <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_ldisc_ops *ops; <span class="hljs-comment"><span class="hljs-comment">//    struct tty_struct *tty; //   tty_struct  .       };</span></span></code> </pre> <br><p> ä¼¼ä¹æ²¡ä»€ä¹ˆå¤æ‚çš„ï¼Ÿ è®©æˆ‘ä»¬å°†åˆ°ç›®å‰ä¸ºæ­¢è€ƒè™‘çš„æ‰€æœ‰ç»“æ„æ·»åŠ åˆ°æˆ‘ä»¬çš„ç¯®ä¸­ï¼Œå¹¶æŒ‰ç…§ä¸ä»£ç ä¸­è¿æ¥å®ƒä»¬ç›¸åŒçš„æ–¹å¼é“¾æ¥å®ƒä»¬ï¼š <br><img src="https://habrastorage.org/webt/1d/bt/n4/1dbtn4m_6c6i4n7oaohoguci2m0.jpeg" alt=" tty_struct" title="ç¼–è¯‘tty_struct"></p><br><p> ä½†æ˜¯æˆ‘ä»¬åªä¸ºPTMè®¾å¤‡åˆ›å»ºäº†tty_structã€‚  PTSè®¾å¤‡å‘¢ï¼Ÿ ä¸ºæ­¤ï¼Œæˆ‘ä»¬è¿”å›<code>tty_init_dev()</code>å‡½æ•°ï¼Œå¹¶å›æƒ³ä¸€ä¸‹æˆ‘ä»¬åº”è¯¥è°ƒç”¨<code>tty_driver_install_tty()</code>å‡½æ•°ï¼š </p><br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">/** * This method is responsible * for ensuring any need additional structures are allocated and configured. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> tty_driver_install_tty(<span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_driver *driver, <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_struct *tty) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> driver-&gt;ops-&gt;install ? driver-&gt;ops-&gt;install(driver, tty) : tty_standard_install(driver, tty); }</code> </pre> <br><p> æ³¨é‡Šå‘Šè¯‰æˆ‘ä»¬ï¼Œæ­¤æ–¹æ³•è´Ÿè´£åˆ›å»ºå„ç§å…¶ä»–ç»“æ„ã€‚  PTSè®¾å¤‡å°†æˆä¸ºæˆ‘ä»¬çš„é™„åŠ ç»“æ„ã€‚ æˆ‘æ‰¿è®¤ï¼Œè¿™å¯¹æˆ‘æ¥è¯´éå¸¸ä»¤äººæƒŠè®¶ï¼Œå› ä¸ºå®ƒæ˜¯è¯¥æ­»çš„æ•´ä¸ªè®¾å¤‡ï¼Œè€Œä¸ä»…ä»…æ˜¯ä¸€äº›é¢å¤–çš„ç»“æ„ï¼ ä½†æ˜¯æˆ‘ä»¬éƒ½çŸ¥é“æ‰€æœ‰è®¾å¤‡éƒ½åªæ˜¯æŸç§ç»“æ„ï¼Œæ‰€ä»¥ç»§ç»­å‰è¿›ã€‚ å¥½çš„ï¼Œä»€ä¹ˆæ˜¯<em>driver-&gt; ops-&gt;åœ¨è¿™é‡Œå®‰è£…</em> ï¼Ÿ ä¸ºæ­¤ï¼Œè¯·å†æ¬¡æŸ¥çœ‹PTMé©±åŠ¨ç¨‹åºçš„åŠŸèƒ½è¡¨ï¼š </p><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_operations ptm_unix98_ops = { .install = pty_unix98_install, <span class="hljs-comment"><span class="hljs-comment">// ...</span></span></code> </pre> <br><p> å¹¶ä¸”æˆ‘ä»¬äº†è§£åˆ°æˆ‘ä»¬å¯¹<code>pty_unix98_install()</code>å‡½æ•°æ„Ÿå…´è¶£ï¼š </p><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pty_unix98_install(<span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_driver *driver, <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_struct *tty) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pty_common_install(driver, tty, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); }</code> </pre> <br><p> å…¶ä¸­è°ƒç”¨<code>pty_common_install()</code>å‡½æ•°ï¼š </p><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pty_common_install(<span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_driver *driver, <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_struct *tty, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> legacy) { <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_struct *o_tty; <span class="hljs-comment"><span class="hljs-comment">// tty_struct    PTY -    PTS  //    ,       install.   ,   PTM     tty_struct,        if (driver-&gt;subtype != PTY_TYPE_MASTER) return -EIO; o_tty = alloc_tty_struct(driver-&gt;other, idx); tty-&gt;link = o_tty; o_tty-&gt;link = tty; }</span></span></code> </pre> <br><p>  ,   PTS       <em>tty_struct</em>   ,       PTS .           .  tty_struct  PTS    . </p><br><hr><br><h4 id="registraciya-drayvera">   </h4><br><p>        ,           TTY  (   -         ?). <br>  â€”  ,       PTM,   PTS : </p><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> file_operations tty_fops = { .llseek = no_llseek, .read = tty_read, .write = tty_write, .poll = tty_poll, .unlocked_ioctl = tty_ioctl, .compat_ioctl = tty_compat_ioctl, .open = tty_open, .release = tty_release, .fasync = tty_fasync, .show_fdinfo = tty_show_fdinfo, };</code> </pre> <br><p>         ,                  TTY . </p><br><hr><br><p> .      ,       <em>/dev/ptmx</em> .  ,   PTS ,      ,   PTM ,      : </p><br><p><img src="https://habrastorage.org/webt/5w/aw/rg/5wawrgbqqw1_llmi1r8g2kbwrzc.jpeg" title=" PTY"></p><br><hr><br><h2 id="hello-world"> ä¸–ç•Œæ‚¨å¥½ï¼ </h2><br><p>        .          "Hello, World!",        . </p><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#include </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt;</span></span></span><span class="hljs-meta"> void main() { printf(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Hello, World!\n"</span></span></span><span class="hljs-meta">); }</span></span></code> </pre> <br><p> ,   "Hello, World!"    .   ,    ,  ,       .    ,    .  stdout  <em>/dev/null</em> â€”       .          ,       Linux. </p><br><p>      Unix        <em>write()</em> , <em>read()</em> , <em>close()</em>  ,    write()  /dev/pts/0         <code>__vfs_write()</code> : </p><br><pre> <code class="objectivec hljs">ssize_t __vfs_write(<span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> file *file, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> __user *buf, size_t count, loff_t *pos) { ssize_t ret; <span class="hljs-comment"><span class="hljs-comment">//... ret = file-&gt;f_op-&gt;write(file, buf, count, pos); //... return ret; }</span></span></code> </pre> <br><p>     write()      .   ,            : </p><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> file_operations tty_fops = { <span class="hljs-comment"><span class="hljs-comment">// ... .write = tty_write, // ...</span></span></code> </pre> <br><p>  <code>tty_write()</code> : </p><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> ssize_t tty_write(<span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> file *file, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> __user *buf, size_t count, loff_t *ppos) { <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_struct *tty = file_tty(file); <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_ldisc *ld; ssize_t ret; ld = tty_ldisc_ref_wait(tty); ret = do_tty_write(ld-&gt;ops-&gt;write, tty, file, buf, count); tty_ldisc_deref(ld); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; }</code> </pre> <br><p>     <em>tty_struct</em>    TTY ,           write()  .       : </p><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_ldisc_ops n_tty_ops = { .write = n_tty_write, <span class="hljs-comment"><span class="hljs-comment">// ... };</span></span></code> </pre> <br><p>    <code>n_tty_write()</code> : </p><br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">/** * n_tty_write - write function for tty * @tty: tty device * @file: file object * @buf: userspace buffer pointer * @nr: size of I/O */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> ssize_t n_tty_write(<span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_struct *tty, <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> file *file, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *buf, size_t nr) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *b = buf; <span class="hljs-comment"><span class="hljs-comment">// b - ,       "Hello, World!".          int c; //    //     PTS ,  write()    0,  ,     while (nr &gt; 0) { c = tty-&gt;ops-&gt;write(tty, b, nr); //  write()       TTY  if (!c) break; b += c; //     nr -= c; //      :  -  -  -  } }</span></span></code> </pre> <br><p> ,  "Hello, World!"    write()   PTS .       : </p><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_operations pty_unix98_ops = { .write = pty_write, <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre> <br><p>  <code>pty_write()</code> : </p><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pty_write(<span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_struct *tty, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *buf, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c) { <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_struct *to = tty-&gt;link; <span class="hljs-comment"><span class="hljs-comment">//      PTY.    -  PTM  if (c &gt; 0) { //    PTM  c = tty_insert_flip_string(to-&gt;port, buf, c); //     ,       if (c) { tty_flip_buffer_push(to-&gt;port); tty_wakeup(tty); } } return c; }</span></span></code> </pre> <br><p>          : </p><br><pre> <code class="objectivec hljs"> __vfs_write() -&gt; <span class="hljs-comment"><span class="hljs-comment">// 1- :   tty_write() -&gt; do_tty_write() -&gt; n_tty_write() -&gt; // 2- :   pty_write() // 3- : </span></span></code> </pre> <br><p>     . ,       PTM . ,    . </p><br><p>  ,          <em>flip buffer</em> . <strong>Flip buffer</strong> â€”   ,    .  tty driver   ,      .   ,              .      ,        ,       .     ,      ,            .  -        flip buffer â€”       (,    -  ,         flip). </p><br><p>          ,       .  <code>tty_insert_flip_string()</code>         <code>tty_insert_flip_string_fixed_flag()</code> ,           PTM : </p><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> tty_insert_flip_string_fixed_flag(<span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_port *port, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *chars, <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> flag, size_t size) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> copied = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> goal = min_t(size_t, size - copied, TTY_BUFFER_PAGE); <span class="hljs-comment"><span class="hljs-comment">//      int space = __tty_buffer_request_room(port, goal, flags); //     struct tty_buffer *tb = port-&gt;buf.tail; //       if (unlikely(space == 0)) break; memcpy(char_buf_ptr(tb, tb-&gt;used), chars, space); //      tb-&gt;used += space; copied += space; chars += space; /* There is a small chance that we need to split the data over several buffers. If this is the case we must loop */ } while (unlikely(size &gt; copied)); return copied; }</span></span></code> </pre> <br><p>   , flip buffer        ,       ,         .        ,   â€”        PTM ,             . </p><br><p> ,   "Hello, World!"   PTM .    GNOME Terminal Server    <em>poll()</em> (  I/O)        master .  ,         ? ä¸ç®¡å¦‚ä½•      ,     ,      â€”        . </p><br><p>            <code>tty_flip_buffer_push()</code> (   pty_write): </p><br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">/** * tty_flip_buffer_push - terminal * @port: tty port to push * * Queue a push of the terminal flip buffers to the line discipline. * Can be called from IRQ/atomic context. * * In the event of the queue being busy for flipping the work will be * held off and retried later. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> tty_flip_buffer_push(<span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_port *port) { tty_schedule_flip(port); }</code> </pre> <br><p>  <code>tty_schedule_flip()</code> ,   ,        : </p><br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">/** * tty_schedule_flip - push characters to ldisc * @port: tty port to push from * * Takes any pending buffers and transfers their ownership to the * ldisc side of the queue. It then schedules those characters for * processing by the line discipline. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> tty_schedule_flip(<span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_port *port) { <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_bufhead *buf = &amp;port-&gt;buf; <span class="hljs-comment"><span class="hljs-comment">/* paired w/ acquire in flush_to_ldisc(); ensures * flush_to_ldisc() sees buffer data. */</span></span> smp_store_release(&amp;buf-&gt;tail-&gt;commit, buf-&gt;tail-&gt;used); queue_work(system_unbound_wq, &amp;buf-&gt;work); }</code> </pre> <br><p>   ,     <em>work</em> (,   -       )       ,      â€”    ,    <code>flush_to_ldisc()</code> : </p><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> flush_to_ldisc(<span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> work_struct *work) { <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_port *port = container_of(work, <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_port, buf.work); <span class="hljs-comment"><span class="hljs-comment">//   tty_port PTM . tty_port -       TTY  struct tty_bufhead *buf = &amp;port-&gt;buf; struct tty_buffer *head = buf-&gt;head; // ... receive_buf(port, head); // ... }</span></span></code> </pre> <br><p>  <code>receive_buf()</code>          <code>__receive_buf()</code> ,      : </p><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __receive_buf(<span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> tty_struct *tty, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *cp, <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *fp, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count) { <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> n_tty_data *ldata = tty-&gt;disc_data; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> preops = I_ISTRIP(tty) || (I_IUCLC(tty) &amp;&amp; L_IEXTEN(tty)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ldata-&gt;real_raw) n_tty_receive_buf_real_raw(tty, cp, fp, count); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ldata-&gt;raw || (L_EXTPROC(tty) &amp;&amp; !preops)) n_tty_receive_buf_raw(tty, cp, fp, count); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tty-&gt;closing &amp;&amp; !L_EXTPROC(tty)) n_tty_receive_buf_closing(tty, cp, fp, count); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ldata-&gt;lnext) { <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> flag = TTY_NORMAL; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fp) flag = *fp++; n_tty_receive_char_lnext(tty, *cp++, flag); count--; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!preops &amp;&amp; !I_PARMRK(tty)) n_tty_receive_buf_fast(tty, cp, fp, count); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> n_tty_receive_buf_standard(tty, cp, fp, count); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (read_cnt(ldata)) { kill_fasync(&amp;tty-&gt;fasync, SIGIO, POLL_IN); wake_up_interruptible_poll(&amp;tty-&gt;read_wait, EPOLLIN); } }</code> </pre> <br><p>  ,   <em>n_tty_receive_buf</em> ( ,    _raw)           <strong>read_buf</strong> ,         TTY .      PTM    raw ,           read_buf. ,        PTM  PTS ,     . </p><br><p>       ,   : </p><br><pre> <code class="objectivec hljs"> ... pty_write() -&gt; <span class="hljs-comment"><span class="hljs-comment">// 3- :  PTS  tty_insert_flip_string + tty_flip_buffer_push() -&gt; tty_schedule_flip() -&gt; --- //    PTM  flush_to_ldisc() -&gt; // 2- :   PTM  receive_buf() -&gt; n_tty_receive_buf -&gt; n_tty_receive_buf_common -&gt; __receive_buf()</span></span></code> </pre> <br><p> ,   PTM        â€”         PTS . </p><br><p>  :       PTM .  GNOME Terminal Server      "Hello, World!",  read()  PTM .  read()    write()    â€”  <code>n_tty_read()</code> .      ,  ,          â€” <em>read_buf</em> â€”   .  GNOME Terminal Server    X Server,     . </p><br><p>  ,   "Hello, World!"   : </p><br><pre> <code class="plaintext hljs"> -&gt; PTY slave -&gt; PTY master -&gt; GNOME-TERMINAl-SERVER -&gt; X Server -&gt; -&gt; </code> </pre> <br><hr><br><h2 id="zaklyuchenie"> ç»“è®º </h2><br><p>  .     : </p><br><ol><li>     </li><li>     </li><li>   TTY  </li><li>    </li><li>    ,         </li></ol><br><p>   ,   !     -  â€”     ,   ! </p><br><h3 id="istochniki"> èµ„æ–™æ¥æº </h3><br><ul><li> Linux man pages </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://unix.stackexchange.com/q/96694/346664</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://unix.stackexchange.com/q/93531/346664</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://unix.stackexchange.com/q/117981/346664</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://askubuntu.com/q/506510</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">www.linusakesson.net/programming/tty/</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://spin0r.wordpress.com/2012/12/28/terminally-confused-part-seven/</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://habr.com/ru/company/neobit/blog/330764/</a> </li><li>  Advanced Programming in the UNIX Environment, 3rd Edition </li></ul><cut></cut></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN460257/">https://habr.com/ru/post/zh-CN460257/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN460247/index.html">ELFsçš„é£Ÿè°±</a></li>
<li><a href="../zh-CN460249/index.html">ç”¨pwnable.kr 07è§£å†³ä»»åŠ¡-è¾“å…¥ã€‚ äº†è§£pwntools</a></li>
<li><a href="../zh-CN460251/index.html">äººä¸ºçš„æ„šè ¢ï¼šå¯¹æˆ‘æ²¡æœ‰å¸®åŠ©çš„æœºå™¨äºº</a></li>
<li><a href="../zh-CN460253/index.html">æé«˜è¯­éŸ³åŠ©æ‰‹æŠ€èƒ½çš„10ä¸ªç†ç”±</a></li>
<li><a href="../zh-CN460255/index.html">Node.jsä¸Šçš„åé—¨ç¨‹åºï¼šä¸ºä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆä»¥åŠå¦‚ä½•å·¥ä½œ</a></li>
<li><a href="../zh-CN460259/index.html">ä»€ä¹ˆæ˜¯UIå’ŒUXè®¾è®¡ï¼Ÿ æœ‰ä»€ä¹ˆå…±åŒç‚¹å’Œä¸åŒç‚¹ï¼Ÿ</a></li>
<li><a href="../zh-CN460261/index.html">äºšé©¬é€Šï¼šç”µå­å•†åŠ¡æˆåŠŸ25å¹´</a></li>
<li><a href="../zh-CN460263/index.html">è¿›è¡ŒçœŸæ­£çš„æ™ºèƒ½æœç´¢ï¼šåˆ†æ­¥æŒ‡å—</a></li>
<li><a href="../zh-CN460265/index.html">åˆ›å»ºä¸€ä¸ªXcodeé¡¹ç›®æ¨¡æ¿</a></li>
<li><a href="../zh-CN460273/index.html">Apple Payä¸­æœ€å°çš„æˆæƒ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>