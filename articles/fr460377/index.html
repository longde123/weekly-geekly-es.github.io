<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🖕🏻 👩🏻‍🤝‍👨🏾 ⚓️ Utilisation de Liquibase pour gérer la structure de la base de données dans une application Spring Boot. Partie 1 👨‍👨‍👦‍👦 🎥 🙏🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cet article, je vais discuter de l'utilisation de l'utilitaire Liquibase dans les applications Spring Boot pour versionner la structure d'une bas...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Utilisation de Liquibase pour gérer la structure de la base de données dans une application Spring Boot. Partie 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460377/"> Dans cet article, je vais discuter de l'utilisation de l'utilitaire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Liquibase</a> dans les applications Spring Boot pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">versionner</a> la structure d'une base de données relationnelle et migrer cette structure d'une version à une autre.  Dans la première partie, nous analyserons l'exemple de base, et dans la seconde, nous parlerons de l'utilisation de <i>liquibase-mave-plugin</i> pour <i>annuler les</i> modifications et générer automatiquement des scripts en comparant les structures de base de données. <br><br>  Commençons par créer l'application la plus simple sur Spring Boot + JPA (Hibernate).  Le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Spring Initializr</a> nous y aidera.  Dans les dépendances, sélectionnez JPA, MySQL et Web.  Liquibase peut également être connecté à cette étape, mais pour une meilleure compréhension, nous le ferons plus tard manuellement. <br><a name="habracut"></a><br><h4>  Créer la base de l'application </h4><br>  Nous ajoutons une classe d'entité à notre application, ainsi qu'un référentiel et un contrôleur REST pour travailler avec.  Pour être concret, nous allons stocker des informations sur les utilisateurs dans l'entité créée. <br><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(name = <span class="hljs-string"><span class="hljs-string">"users"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-meta"><span class="hljs-meta">@GeneratedValue</span></span>(strategy = GenerationType.IDENTITY) <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"id"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"username"</span></span>, unique = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String userName; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"password"</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String password; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"first_name"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String firstName; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"last_name"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String lastName; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"email"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String email; <span class="hljs-comment"><span class="hljs-comment">//    ,    //    Lombok }</span></span></code> </pre> <br>  Spring Data rend le code du référentiel extrêmement concis <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserRepository</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JpaRepository</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Long</span></span></span><span class="hljs-class">&gt; </span></span>{ }</code> </pre> <br>  Contrôleur REST qui affichera tout le contenu de la table utilisateur <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RestController</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> UserRepository userRepository; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UserController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UserRepository userRepository)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.userRepository = userRepository; } <span class="hljs-meta"><span class="hljs-meta">@GetMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/user/all"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;User&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">allUsers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> userRepository.findAll(); } }</code> </pre> <br>  Paramètres dans le fichier <i>application.properties</i> <br><br><pre> <code class="plaintext hljs">spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver spring.datasource.url=jdbc:mysql://localhost:3306/geek_db?createDatabaseIfNotExist=true&amp;allowPublicKeyRetrieval=true&amp;useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC spring.datasource.username=dbuser spring.datasource.password=dbpassword spring.jpa.show-sql=true spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL5Dialect</code> </pre><br>  Il est supposé que votre ordinateur exécute un serveur MySQL sur un port standard.  Si nécessaire, ajustez l'URL du serveur dans la chaîne de connexion, ainsi que le nom d'utilisateur et le mot de passe.  Il convient également de prêter attention au paramètre <i>createDatabaseIfNotExist</i> .  Grâce à lui, lors de la connexion, nous créerons une base de données appelée <i>geek_db</i> si elle n'est pas sur le serveur. <br><br><h4>  Ajouter Liquibase </h4><br>  Vous avez sûrement remarqué qu'il <i>manque</i> un paramètre pour Hibernate, à savoir <i>spring.jpa.hibernate.ddl-auto</i> .  Dans la plupart des manuels pour débutants, la valeur de <i>mise à jour</i> est indiquée pour cela, en raison de laquelle Hibernate créera et ajustera la structure de la table sur le serveur lui-même, en fonction des classes d'entités présentes dans le projet.  Cette approche peut très bien être utilisée si le schéma de données est très simple ou si le projet est en cours de formation, mais avec un schéma quelque peu compliqué, des problèmes vont très probablement commencer, ne serait-ce que parce que nous ne pouvons pas contrôler le processus de génération des scripts DDL Hibernate.  Un autre problème est qu'avec cette approche, il n'y a pas de moyen facile d'annuler les modifications apportées à Hibernate dans la structure de la base de données. <br><br>  C'est pour résoudre les problèmes ci-dessus que nous utiliserons l'utilitaire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Liquibase</a> .  Heureusement pour nous, elle est parfaitement capable de s'intégrer aux applications Spring Boot!  Pour commencer à l'utiliser, vous devez effectuer les étapes suivantes <br><br>  Ajoutez le paramètre au fichier <i>application.properties</i> <br><br><pre> <code class="plaintext hljs">spring.jpa.hibernate.ddl-auto=none</code> </pre> <br>  Il s'agit de s'assurer qu'Hibernate ne prend aucune mesure pour modifier le circuit, comme  Liquibase les fera maintenant.  Théoriquement, vous pouvez également utiliser ici la valeur de <i>validation</i> pour un contrôle supplémentaire sur l'exactitude de la structure de la table. <br><br>  Ajouter une dépendance à <i>pom.xml</i> <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.liquibase<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>liquibase-core<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Après l'avoir ajouté, Spring Boot créera automatiquement un bean spécial nommé liquibase, qui effectuera toutes les actions pour configurer le schéma de base de données basé sur les scripts Liquibase à chaque démarrage de l'application. <br><br>  Vous devez maintenant ajouter le script Liquibase lui-même, ce qui créera la table dont nous avons besoin.  Dans le dossier / src / main / resources / db / changelog, créez un fichier appelé db.changelog-master.yaml et ajoutez-y le contenu suivant <br><br><pre> <code class="plaintext hljs">databaseChangeLog: - logicalFilePath: db/changelog/db.changelog-lesson1.yaml - changeSet: id: 1 author: your_liquibase_username changes: - createTable: tableName: users columns: - column: name: id type: BIGINT autoIncrement: true constraints: primaryKey: true nullable: false - column: name: username type: varchar(50) constraints: unique: true nullable: false - column: name: password type: varchar(512) constraints: nullable: false - column: name: first_name type: varchar(50) - column: name: last_name type: varchar(50) - column: name: email type: varchar(50)</code> </pre> <br>  Analysons le contenu de ce script.  Tout d'abord, il contient un changeSet.  ChangeSet est un analogue d'une validation dans les systèmes de contrôle de version tels que Git ou SVN.  Par analogie avec une validation, les modifications apportées dans le cadre d'un changeSet peuvent être annulées ou restaurées sur le serveur de base de données.  Chaque changeSet doit avoir un identifiant unique avec lequel Liquibase détermine si un changeSet donné a été pompé vers cette base de données ou non. <br><br>  ChangeSet contient une commande pour créer une table, et la structure de la table est décrite par Liquibase, et non un script SQL.  Grâce à cela, ce fichier devient multiplateforme.  Liquibase générera un script SQL en fonction du serveur de base de données utilisé.  De plus, si nous devons annuler le changeSet donné, Liquibase pourra créer automatiquement un script pour supprimer la table donnée.  Si nous utilisions des scripts SQL, nous devions alors écrire manuellement un script pour annuler les modifications.  Dans la section des <i>suspensions</i> , nous n'avons qu'une seule équipe, ce qui est considéré comme une bonne pratique, malgré le fait <i>qu'il</i> peut <i>y</i> avoir n'importe quel nombre d'équipes dans un même <i>changeSet</i> . <br><br>  Le code écrit suffit pour exécuter le programme, mais pour voir plus clairement les résultats de son travail, ajoutons un autre <i>changeSet</i> , qui remplira le tableau de données. <br><br><pre> <code class="plaintext hljs"> - changeSet: id: 2 author: your_liquibase_username comment: "Create admin user" changes: - insert: tableName: users columns: - column: name: username value: "admin" - column: name: password value: "admin" - column: name: email value: "admin@server.com" - insert: tableName: users columns: - column: name: username value: "guest" - column: name: password value: "guest" - column: name: email value: "guest@server.com" rollback: - delete: tableName: users where: username in ('admin', 'guest')</code> </pre> <br>  Dans ce cas, nous devions déjà écrire manuellement un bloc pour les opérations de restauration, comme  Liquibase ne peut pas créer automatiquement de restauration SQL lors de l'utilisation de données.  En général, l'utilisation des données dans la base de données ne fait pas partie des principales fonctionnalités de Liquibase et se limite uniquement aux opérations les plus simples d'insertion, de suppression ou de modification.  Au fait, si vous en avez besoin de plus, vous pouvez utiliser ici les outils de la société <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Red Gate</a> . <br><br>  Et donc, exécutons notre application et essayons de suivre le lien <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http: // localhost: 8080 / user / all</a> .  Si l'application a démarré, vous verrez une réponse JSON avec des informations sur les deux utilisateurs qui ont été ajoutés à la table.  Il convient également de jeter un œil aux journaux de lancement des applications, dans lesquels vous pouvez voir les scripts exécutés par Liquibase pour initialiser la base de données.  Une attention particulière doit être accordée à la table <i>DATABASECHANGELOG</i> .  C'est en elle que Liquibase stocke le journal des modifications apportées à la base de données. <br><br>  C'est tout pour l'instant.  Après un certain temps, je prévois de publier une suite sur l'utilisation du <i>plugin liquibase-maven</i> pour générer automatiquement des scripts en comparant les structures de base de données et en annulant les modifications apportées. <br><br>  Je serais reconnaissant pour tout ajout et commentaire! <br><br>  Code complet PS écrit sur la base de cet article <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/usharik/spring-liquibase-demo/tree/part-1</a> <br><br>  Suite à <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">habr.com/en/post/460907</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr460377/">https://habr.com/ru/post/fr460377/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr460363/index.html">7 facteurs manquants dans l'approche 12 Factor App</a></li>
<li><a href="../fr460365/index.html">Trace distribuée: nous avons tout mal fait</a></li>
<li><a href="../fr460367/index.html">Chaos Engineering: l'art de la destruction intentionnelle. Partie 1</a></li>
<li><a href="../fr460373/index.html">Under the Hood Turbo Pages: Architecture de la technologie de téléchargement rapide des pages Web</a></li>
<li><a href="../fr460375/index.html">Livre "Machine Learning for Business and Marketing"</a></li>
<li><a href="../fr460381/index.html">Qu'est-ce que l'assertivité et pourquoi est-elle nécessaire</a></li>
<li><a href="../fr460383/index.html">Les transitions d'écran dans Legend of Zelda utilisent les fonctionnalités non documentées de NES</a></li>
<li><a href="../fr460387/index.html">Guide du débutant SELinux</a></li>
<li><a href="../fr460393/index.html">Contexte: à quoi s'attendre de Fedora Silverblue</a></li>
<li><a href="../fr460395/index.html">Analytics en tant que fonctionnalité: le processus d'utilisation des données dans Plesk</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>