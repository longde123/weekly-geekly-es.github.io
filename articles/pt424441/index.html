<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèæ‚Äç‚öïÔ∏è üíë üôåüèø Novidades no primeiro CTP do SQL Server 2019 üò° üöñ üë©üèª‚Äç‚öïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A primeira edi√ß√£o do CTP do SQL Server 2019 foi apresentada em 24 de setembro, e devo dizer que est√° cheia de todos os tipos de melhorias e novos recu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Novidades no primeiro CTP do SQL Server 2019</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/424441/">  A primeira edi√ß√£o do CTP do SQL Server 2019 foi apresentada em 24 de setembro, e devo dizer que est√° cheia de todos os tipos de melhorias e novos recursos (muitos dos quais podem ser encontrados no formul√°rio de visualiza√ß√£o no banco de dados SQL do Azure).  Tive uma oportunidade excepcional de conhecer isso um pouco antes, o que me permitiu expandir meu entendimento das mudan√ßas, mesmo que superficialmente.  Voc√™ tamb√©m pode ler as <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">publica√ß√µes mais recentes da equipe do SQL Server</a> e a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o atualizada</a> . <br><br>  Sem entrar em detalhes, discutirei os seguintes novos recursos do kernel: desempenho, solu√ß√£o de problemas, seguran√ßa, disponibilidade e desenvolvimento.  No momento, tenho um pouco mais de detalhes do que outros, e alguns deles j√° est√£o preparados para publica√ß√£o.  Voltarei a esta se√ß√£o, bem como a muitos outros artigos e documenta√ß√£o, e os publicarei.  Apresso-me a inform√°-lo de que esta n√£o √© uma revis√£o abrangente, mas apenas uma parte da funcionalidade que eu consegui "tocar", at√© o CTP 2.0.  Ainda h√° muito o que conversar. <br><a name="habracut"></a><br><h2>  Desempenho </h2><br><h4>  Vari√°veis ‚Äã‚Äãde tabela: constru√ß√£o do plano atrasado </h4><br>  As vari√°veis ‚Äã‚Äãda tabela t√™m uma reputa√ß√£o n√£o muito boa, principalmente no campo da estimativa de custos.  Por padr√£o, o SQL Server sup√µe que uma vari√°vel de tabela possa conter apenas uma linha, o que √†s vezes leva a uma escolha inadequada de plano quando a vari√°vel cont√©m muitas vezes mais linhas.  OPTION (RECOMPILE) geralmente √© usado como uma solu√ß√£o alternativa, mas isso requer altera√ß√µes de c√≥digo e √© um desperd√≠cio, em rela√ß√£o aos recursos, executar a reconstru√ß√£o sempre, enquanto o n√∫mero de linhas geralmente √© o mesmo.  Para emular a reconstru√ß√£o, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">o sinalizador de rastreamento 2453</a> foi introduzido, mas tamb√©m requer um lan√ßamento com o sinalizador e s√≥ funciona quando ocorre uma altera√ß√£o significativa nas linhas. <br><br>  No n√≠vel de compatibilidade 150, a constru√ß√£o adiada √© executada se houver vari√°veis ‚Äã‚Äãda tabela e o plano de consulta n√£o for constru√≠do at√© que a vari√°vel da tabela seja preenchida uma vez.  O custo ser√° estimado com base nos resultados do primeiro uso da vari√°vel de tabela, sem reconstru√ß√£o adicional.  Esse √© um compromisso entre a reconstru√ß√£o constante para obter o custo exato e a aus√™ncia completa de reconstru√ß√£o com custo constante 1. Se o n√∫mero de linhas permanecer relativamente constante, esse √© um bom indicador (e melhor ainda se o n√∫mero exceder 1), mas pode ser menos lucrativo se h√° uma grande varia√ß√£o no n√∫mero de linhas. <br><br>  Apresentei uma an√°lise mais profunda em um artigo recente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Vari√°veis ‚Äã‚ÄãTabulares: Compila√ß√£o Atrasada no SQL Server</a> , e Brent Ozar tamb√©m falou sobre isso no artigo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Vari√°veis ‚Äã‚ÄãTabulares R√°pidas (E Novos Problemas de An√°lise de Par√¢metros)</a> . <br><br><h4>  Feedback de aloca√ß√£o de mem√≥ria no modo String </h4><br>  O SQL Server 2017 possui um feedback de aloca√ß√£o de mem√≥ria em lote, descrito em detalhes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> .  Essencialmente, para qualquer aloca√ß√£o de mem√≥ria associada a um plano de consulta que inclua instru√ß√µes em modo de lote, o SQL Server avaliar√° a mem√≥ria usada pela consulta e a comparar√° com a mem√≥ria solicitada.  Se a mem√≥ria solicitada for muito pequena ou muito, o que levar√° a drenos no tempdb ou a um desperd√≠cio de mem√≥ria, na pr√≥xima inicializa√ß√£o a mem√≥ria alocada para o plano de consulta correspondente ser√° ajustada.  Esse comportamento reduzir√° o volume alocado e expandir√° a simultaneidade, ou aumentar√°, para melhorar o desempenho. <br><br>  Agora, obtemos o mesmo comportamento para consultas no modo de string, no n√≠vel de compatibilidade 150. Se a consulta foi for√ßada a mesclar dados para o disco, para as partidas subsequentes, a mem√≥ria alocada ser√° aumentada.  Se, ap√≥s a conclus√£o da solicita√ß√£o, metade da mem√≥ria foi necess√°ria e foi alocada, as solicita√ß√µes subsequentes ser√£o ajustadas.  Bretn Ozar descreve isso com mais detalhes em seu artigo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Aloca√ß√£o condicional de mem√≥ria</a> . <br><br><h4>  Modo de lote para armazenamento linha por linha </h4><br>  A partir do SQL Server 2012, a consulta de tabelas com √≠ndices de coluna se beneficiou do desempenho aprimorado do modo em lote.  As melhorias de desempenho s√£o devidas a um processador de consultas que executa o processamento em lote e n√£o em linhas.  As linhas tamb√©m s√£o processadas pelo n√∫cleo de armazenamento em pacotes, o que evita declara√ß√µes de troca de simultaneidade.  Paul White ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">@SQL_Kiwi</a> ) me lembrou que, se voc√™ usar uma tabela vazia com armazenamento de colunas para possibilitar opera√ß√µes em lote, as linhas processadas ser√£o coletadas em pacotes por uma declara√ß√£o invis√≠vel.  No entanto, essa muleta pode negar qualquer melhoria recebida no processamento em lote.  Algumas informa√ß√µes sobre isso est√£o na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">resposta ao Stack Exchange</a> . <br><br>  No n√≠vel de compatibilidade 150, o SQL Server 2019 selecionar√° automaticamente o modo de lote como meio intermedi√°rio em certos casos, mesmo quando n√£o houver √≠ndices de coluna.  Voc√™ pode pensar que por que n√£o criar um √≠ndice de coluna e um chap√©u?  Ou continua usando a muleta mencionada acima?  Essa abordagem foi estendida aos objetos tradicionais com armazenamento baseado em linhas, porque nem sempre s√£o poss√≠veis √≠ndices de coluna, incluindo limita√ß√µes funcionais (por exemplo, gatilhos), sobrecarga durante opera√ß√µes de atualiza√ß√£o ou exclus√£o altamente carregadas e tamb√©m a falta de suporte de fabricantes de terceiros.  E nada de bom pode ser esperado dessa muleta. <br>  Criei uma tabela muito simples com 10 milh√µes de linhas e um √≠ndice clusterizado em uma coluna inteira e executei esta consulta: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> sa5, sa2, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(i1), <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(i2), <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.FactTable <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> i1 &gt; <span class="hljs-number"><span class="hljs-number">100000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> sa5, sa2 <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> sa5, sa2;</code> </pre> <br>  O plano mostra claramente pesquisas de concorr√™ncia em cluster e simultaneidade, mas nenhuma palavra sobre o √≠ndice da coluna (como mostra o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SentryOne Plan Explorer</a> ): <br><br><img src="https://habrastorage.org/webt/se/cp/6u/secp6uhnmrnslv_estaiqavexbm.png"><br><br>  Por√©m, se voc√™ se aprofundar um pouco mais, poder√° ver que quase todos os operadores foram executados no modo em lote, at√© mesmo c√°lculos de classifica√ß√£o e escalar: <br><br><img src="https://habrastorage.org/webt/0t/uu/lf/0tuulfjwod55k5fufwksdyvauae.png"><br><br>  Voc√™ pode desativar esse recurso mantendo um n√≠vel de compatibilidade mais baixo alterando a configura√ß√£o do banco de dados ou usando o prompt DISALLOW_BATCH_MODE na consulta: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">OPTION</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> HINT (<span class="hljs-string"><span class="hljs-string">'DISALLOW_BATCH_MODE'</span></span>));</code> </pre> <br>  Nesse caso, um operador de troca adicional aparece, todos os operadores s√£o executados no modo linha por linha e o tempo de execu√ß√£o da consulta √© quase triplicado. <br><br><img src="https://habrastorage.org/webt/0n/v9/k9/0nv9k9ihqq1_jprzfth_o3wwrqs.png"><br><br>  At√© um certo n√≠vel, voc√™ pode ver isso no diagrama, mas na √°rvore de detalhes do plano tamb√©m pode ver a influ√™ncia de uma condi√ß√£o de sele√ß√£o que n√£o pode excluir linhas at√© que a classifica√ß√£o ocorra: <br><br><img src="https://habrastorage.org/webt/ek/p6/6c/ekp66cg3v8b1nfezgsyspmxgkbc.png"><br><br>  A escolha do modo de lote nem sempre √© uma boa etapa - a heur√≠stica inclu√≠da no algoritmo de tomada de decis√£o leva em considera√ß√£o o n√∫mero de linhas, os tipos de operadores propostos e os benef√≠cios esperados do modo de lote. <br><br><h4>  <font color="#004d71">APPROX_COUNT_DISTINCT</font> </h4><br>  Essa nova fun√ß√£o agregada destina-se a cen√°rios de data warehousing e √© equivalente a COUNT (DISTINCT ()).  No entanto, em vez de executar classifica√ß√µes dispendiosas para determinar a quantidade real, a nova fun√ß√£o depende de estat√≠sticas para obter dados relativamente precisos.  Voc√™ precisa entender que o erro est√° dentro de 2% da quantidade exata e, em 97% dos casos que s√£o a norma para an√°lises de alto n√≠vel, esses s√£o os valores exibidos nos indicadores ou usados ‚Äã‚Äãpara estimativas r√°pidas. <br><br>  No meu sistema, criei uma tabela com colunas inteiras que inclu√≠am valores exclusivos no intervalo de 100 a 1.000.000 e colunas de linha, com valores exclusivos no intervalo de 100 a 100.000.Ele n√£o tinha √≠ndices, exceto a chave prim√°ria em cluster na primeira coluna inteira.  Aqui est√£o os resultados da execu√ß√£o de COUNT (DISTINCT ()) e APPROX_COUNT_DISTINCT () nessas colunas, nas quais voc√™ pode ver pequenas discrep√¢ncias (mas sempre dentro de 2%): <br><br><img src="https://habrastorage.org/webt/ou/a5/1x/oua51xwiabvnyltf75s-pjtqdn0.png"><br><br>  O ganho √© enorme se houver limita√ß√µes de mem√≥ria, o que se aplica √† maioria de n√≥s.  Se voc√™ observar os planos de consulta, nesse caso espec√≠fico, poder√° ver uma enorme diferen√ßa no consumo de mem√≥ria pelo operador de correspond√™ncia de hash: <br><br><img src="https://habrastorage.org/webt/xk/tl/sn/xktlsnekpwpu--xaebgb_ndkcn8.png"><br><br>  Observe que voc√™ geralmente notar√° melhorias significativas no desempenho se j√° estiver ligado √† mem√≥ria.  No meu sistema, a execu√ß√£o durou um pouco mais devido √† alta utiliza√ß√£o da CPU do novo recurso: <br><br><img src="https://habrastorage.org/webt/d9/nl/n8/d9nln84mrqh-kfmumdca_u8tt8u.png"><br><br>  Talvez a diferen√ßa fosse mais significativa se eu tivesse tabelas maiores, menos mem√≥ria dispon√≠vel para o SQL Server, simultaneidade mais alta ou alguma combina√ß√£o dos itens acima. <br><br><h4>  <font color="#004d71">Dicas para usar o n√≠vel de compatibilidade em uma consulta</font> </h4><br>  Voc√™ tem uma consulta especial que funciona melhor sob um certo n√≠vel de compatibilidade, diferente do banco de dados atual?  Agora isso √© poss√≠vel gra√ßas √†s novas dicas de consulta que suportam seis n√≠veis diferentes de compatibilidade e cinco modelos diferentes para estimar o n√∫mero de elementos.  A seguir est√£o os n√≠veis de compatibilidade dispon√≠veis, uma sintaxe de exemplo e um modelo de n√≠vel de compatibilidade usado em cada caso.  Veja como isso afeta as classifica√ß√µes, mesmo para visualiza√ß√µes do sistema: <br><br><img src="https://habrastorage.org/webt/gn/0n/g1/gn0ng1ar9z_cxpi7mt8_kaiqkmu.png"><br><br>  Resumindo: n√£o h√° mais necessidade de lembrar os sinalizadores de rastreamento, ou se voc√™ precisa se preocupar se o patch TF 4199 para o otimizador de consultas √© distribu√≠do ou se foi cancelado por algum outro service pack.  Observe que essas dicas adicionais tamb√©m foram adicionadas recentemente ao SQL Server 2017 na atualiza√ß√£o cumulativa n¬∫ 10 (consulte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">o blog de Pedro Lopez para</a> obter detalhes).  Voc√™ pode ver todas as dicas dispon√≠veis com o seguinte comando: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.dm_exec_valid_use_hints;</code> </pre> <br>  Mas n√£o esque√ßa que as dicas s√£o uma medida excepcional, geralmente s√£o adequadas para sair de uma situa√ß√£o dif√≠cil, mas n√£o devem ser planejadas para uso a longo prazo, pois seu comportamento pode mudar com as atualiza√ß√µes subseq√ºentes. <br><br><h2>  <font color="#c30">Solu√ß√£o de problemas</font> </h2><br><h4>  <font color="#004d71">Perfil padr√£o simplificado</font> </h4><br>  Compreender essa melhoria requer alguns pontos para lembrar.  O SQL Server 2014 introduziu a exibi√ß√£o DMV sys.dm_exec_query_profiles, que permite ao usu√°rio que est√° executando a consulta coletar informa√ß√µes de diagn√≥stico sobre todas as instru√ß√µes em todas as partes da consulta.  As informa√ß√µes coletadas ficam dispon√≠veis ap√≥s a conclus√£o da consulta e permitem determinar quais operadores realmente gastaram os principais recursos e por qu√™.  Qualquer usu√°rio que n√£o atender a uma solicita√ß√£o espec√≠fica poder√° receber esses dados para qualquer sess√£o na qual a instru√ß√£o STATISTICS XML ou STATISTICS PROFILE foi inclu√≠da ou para todas as sess√µes, usando o evento query_post_execution_showplan estendido, embora esse evento, em particular, possa afetar o desempenho geral. <br><br>  No Management Studio 2016, foi adicionada uma funcionalidade que permite exibir fluxos de dados que passam pelo plano de consulta em tempo real com base nas informa√ß√µes coletadas do DMV, o que o torna ainda mais poderoso para a solu√ß√£o de problemas.  O Plan Explorer tamb√©m oferece a capacidade de visualizar dados passando pela consulta, em tempo real e no modo de reprodu√ß√£o. <br><br>  A partir do SQL Server 2016 Service Pack 1 (SP1), voc√™ tamb√©m pode habilitar uma vers√£o leve da coleta desses dados para todas as sess√µes usando o sinalizador de rastreamento 7412 ou a propriedade query_thread_profile avan√ßada, que permite obter informa√ß√µes atualizadas imediatamente sobre qualquer sess√£o, sem a necessidade de nada incluir explicitamente (em particular, coisas que afetam negativamente o desempenho).  Isso √© descrito <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">em</a> mais detalhes no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">blog de Pedro Lopez</a> . <br><br>  No SQL Server 2019, esse recurso √© ativado por padr√£o, portanto, voc√™ n√£o precisa executar nenhuma sess√£o com eventos estendidos ou usar sinalizadores de rastreamento e instru√ß√µes STATISTICS em qualquer consulta.  Basta olhar para os dados da DMV a qualquer momento para todas as sess√µes simult√¢neas.  Mas √© poss√≠vel desativar esse modo usando LIGHTWEIGHT_QUERY_PROFILING; no entanto, essa sintaxe n√£o funciona no CTP 2.0 e ser√° corrigida em edi√ß√µes futuras. <br><br><h4>  <font color="#004d71">Estat√≠sticas de √≠ndice de coluna em cluster agora est√£o dispon√≠veis em bancos de dados clonados</font> </h4><br>  Nas vers√µes atuais do SQL Server, ao clonar um banco de dados, apenas as estat√≠sticas do objeto original dos √≠ndices da coluna em cluster s√£o usadas, excluindo as atualiza√ß√µes feitas na tabela ap√≥s sua cria√ß√£o.  Se voc√™ usar um clone para configurar consultas e outros testes de desempenho, com base nas classifica√ß√µes de energia, esses exemplos poder√£o n√£o funcionar.  Parikshit Savyani descreveu as limita√ß√µes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">nesta publica√ß√£o</a> e forneceu uma solu√ß√£o tempor√°ria - antes de criar o clone, voc√™ precisa criar um script que execute DBCC SHOW_STATISTICS ... WITH STATS_STREAM para cada objeto.  √â caro e, √© claro, f√°cil de esquecer. <br><br>  No SQL Server 2019, essas estat√≠sticas atualizadas estar√£o automaticamente dispon√≠veis no clone, para que voc√™ possa testar v√°rios cen√°rios de consulta e obter planos objetivos com base em estat√≠sticas reais, sem executar manualmente STATS_STREAM para todas as tabelas. <br><br><h4>  <font color="#004d71">Previs√£o de compacta√ß√£o para armazenamento de colunas</font> </h4><br>  Nas vers√µes atuais, o procedimento sys.sp_estimate_data_compression_savings possui a seguinte verifica√ß√£o: <br><br><pre> <code class="sql hljs">if (@data_compression not in ('NONE', 'ROW', 'PAGE'))</code> </pre> <br>  Isso significa que permite verificar a compacta√ß√£o de uma linha ou p√°gina (ou ver o resultado da exclus√£o da compacta√ß√£o atual).  No SQL Server 2019, essa verifica√ß√£o agora fica assim: <br><br><pre> <code class="sql hljs">if (@data_compression not in ('NONE', 'ROW', 'PAGE', 'COLUMNSTORE', 'COLUMNSTORE_ARCHIVE'))</code> </pre> <br>  Essa √© uma √≥tima not√≠cia, pois permite prever aproximadamente o efeito de adicionar um √≠ndice de coluna a uma tabela que n√£o a possui, ou converter tabelas ou parti√ß√µes em um formato de armazenamento de coluna ainda mais compactado, sem precisar restaurar a tabela para outro sistema.  Eu tinha uma tabela com 10 milh√µes de linhas, para a qual realizei um procedimento armazenado com cada um dos cinco par√¢metros: <br><br><pre> <code class="sql hljs">EXEC sys.sp_estimate_data_compression_savings @schema_name = N'dbo', @object_name = N'FactTable', @index_id = NULL, @partition_number = NULL, @data_compression = N'NONE'; <span class="hljs-comment"><span class="hljs-comment">-- repeat for ROW, PAGE, COLUMNSTORE, COLUMNSTORE_ARCHIVE</span></span></code> </pre> <br>  Resultados: <br><br><img src="https://habrastorage.org/webt/d6/xu/uy/d6xuuythndwrwogn22ljt83w8y4.png"><br><br>  Como em outros tipos de compacta√ß√£o, a precis√£o depende inteiramente das linhas dispon√≠veis e da representatividade do restante dos dados.  No entanto, esta √© uma maneira bastante poderosa de obter resultados previs√≠veis sem muita dificuldade. <br><br><h4>  <font color="#004d71">Novo recurso para obter informa√ß√µes da p√°gina</font> </h4><br>  Por um longo tempo, DBCC PAGE e DBCC IND foram usados ‚Äã‚Äãpara coletar informa√ß√µes sobre p√°ginas que continham uma se√ß√£o, √≠ndice ou tabela.  Mas eles n√£o s√£o documentados e n√£o s√£o suportados, e pode ser entediante automatizar a solu√ß√£o de tarefas associadas a v√°rios √≠ndices ou p√°ginas. <br><br>  Posteriormente, uma fun√ß√£o administrativa din√¢mica (DMF) sys.dm_db_database_page_allocations apareceu, retornando um conjunto que representa todas as p√°ginas no objeto especificado.  Ainda sem documentos e com falhas que podem se tornar um problema real em grandes tabelas: mesmo para obter informa√ß√µes sobre uma p√°gina, ele deve ler toda a estrutura, o que pode ser bastante caro. <br><br>  No SQL Server 2019, outro DMF apareceu - sys.dm_db_page_info.  Ele basicamente retorna todas as informa√ß√µes da p√°gina, sem a sobrecarga da distribui√ß√£o do DMF.  No entanto, para usar a fun√ß√£o nas compila√ß√µes atuais, voc√™ precisa saber o n√∫mero da p√°gina que est√° procurando com anteced√™ncia.  Talvez este passo tenha sido dado intencionalmente, porque  essa √© a √∫nica maneira de garantir o desempenho.  Portanto, se voc√™ estiver tentando identificar todas as p√°ginas em um √≠ndice ou tabela, ainda precisar√° usar a distribui√ß√£o DMF.  No pr√≥ximo artigo, descreverei essa quest√£o com mais detalhes. <br><br><h2>  <font color="#c30">Seguran√ßa</font> </h2><br><h4>  <font color="#004d71">Criptografia permanente usando um ambiente seguro (enclave)</font> </h4><br>  No momento, a criptografia permanente protege dados confidenciais durante a transmiss√£o e na mem√≥ria por criptografia / descriptografia em cada final do processo.  Infelizmente, isso muitas vezes leva a s√©rias limita√ß√µes ao trabalhar com dados, como a incapacidade de executar c√°lculos e filtragem, portanto, voc√™ deve transferir todo o conjunto de dados para o lado do cliente para realizar, por exemplo, uma pesquisa por intervalo. <br><br>  Um ambiente seguro (enclave) √© uma √°rea protegida da mem√≥ria na qual esses c√°lculos e filtros podem ser delegados (o Windows usa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">seguran√ßa baseada em virtualiza√ß√£o</a> ) - os dados permanecem criptografados no kernel, mas podem ser descriptografados ou criptografados com seguran√ßa em um ambiente seguro.  Voc√™ s√≥ precisa adicionar o par√¢metro ENCLAVE_COMPUTATIONS √† chave prim√°ria usando o SSMS, por exemplo, marcando a caixa "Permitir c√°lculos em um ambiente seguro": <br><br><img src="https://habrastorage.org/webt/do/ia/tp/doiatpb0ne_kpxgb5pbdep8ua5m.png"><br><br>  Agora voc√™ pode criptografar dados quase instantaneamente, em compara√ß√£o com o m√©todo antigo (no qual o assistente, o cmdlet Set-SqlColumnEncyption ou seu aplicativo, precisaria obter completamente o conjunto inteiro do banco de dados, criptograf√°-lo e envi√°-lo de volta): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> dbo.Patients <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> SSN <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">9</span></span>) <span class="hljs-comment"><span class="hljs-comment">-- currently not encrypted! ENCRYPTED WITH ( COLUMN_ENCRYPTION_KEY = ColumnEncryptionKeyName, ENCRYPTION_TYPE = Randomized, ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256' ) NOT NULL;</span></span></code> </pre> <br>  Penso que, para muitas organiza√ß√µes, essa melhoria ser√° a principal not√≠cia, mas no CTP atual, alguns desses subsistemas ainda est√£o sendo aprimorados; portanto, eles est√£o desativados por padr√£o, mas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> voc√™ pode ver como ativ√°-los. <br><br><h4>  <font color="#004d71">Gerenciamento de certificados no Configuration Manager</font> </h4><br>  O gerenciamento de certificados SSL e TLS sempre foi trabalhoso e muitas pessoas foram for√ßadas a fazer o trabalho tedioso de criar seus pr√≥prios scripts para implantar e manter seus certificados corporativos.  O Gerenciador de Configura√ß√µes atualizado para SQL Server 2019 ajuda a exibir e verificar rapidamente certificados de qualquer inst√¢ncia, encontrar certificados que est√£o prestes a expirar no futuro pr√≥ximo e sincronizar implanta√ß√µes de certificados em todas as replica√ß√µes em um grupo de disponibilidade ou em todos os n√≥s em uma inst√¢ncia de cluster de failover. <br><br>  N√£o tentei todas essas opera√ß√µes, mas elas devem funcionar para vers√µes anteriores do SQL Server se o gerenciamento vier do SQL Server 2019 Configuration Manager. <br><br><h4>  <font color="#004d71">Classifica√ß√£o e auditoria de dados incorporadas</font> </h4><br>  A equipe de desenvolvimento do SQL Server adicionou a capacidade de classificar dados no SSMS 17.5, permitindo identificar qualquer coluna que possa conter informa√ß√µes confidenciais ou contradizer v√°rios padr√µes (HIPAA, SOX, PCI e GDPR, √© claro).  O assistente usa um algoritmo que oferece colunas que supostamente causam problemas, mas voc√™ pode ajustar sua senten√ßa removendo essas colunas da lista ou adicionar suas pr√≥prias.  Para armazenar a classifica√ß√£o, s√£o usadas propriedades avan√ßadas;  O relat√≥rio interno do SSMS usa as mesmas informa√ß√µes para exibir seus dados.  Fora do relat√≥rio, essas propriedades n√£o s√£o t√£o √≥bvias. <br><br>  O SQL Server 2019 introduziu uma nova instru√ß√£o para esses metadados, j√° dispon√≠vel no Banco de Dados SQL do Azure, e denominada ADD SENSITIVITY CLASSIFICATION.  Ele permite que voc√™ fa√ßa o mesmo que o assistente no SSMS, mas as informa√ß√µes n√£o s√£o mais armazenadas na propriedade estendida e qualquer acesso a esses dados √© exibido automaticamente na auditoria como uma nova coluna XML data_sensitivity_information.  Ele cont√©m todos os tipos de informa√ß√µes que foram afetadas durante a auditoria. <br><br>  Como um exemplo r√°pido, suponha que eu tenha uma tabela para contratados externos: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> dbo.Contractors ( FirstName sysname, LastName sysname, SSN <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">9</span></span>), HourlyRate <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) );</code> </pre> <br>  Observando essa estrutura, fica claro que todas as quatro colunas s√£o potencialmente vulner√°veis ‚Äã‚Äãa vazamentos ou devem estar acess√≠veis apenas a um c√≠rculo limitado de pessoas.  Aqui voc√™ pode obter permiss√µes, mas pelo menos precisa se concentrar nelas.  Assim, podemos classificar essas colunas de diferentes maneiras: <br><br><pre> <code class="sql hljs">ADD SENSITIVITY CLASSIFICATION TO dbo.Contractors.FirstName, dbo.Contractors.LastName <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (LABEL = <span class="hljs-string"><span class="hljs-string">'Confidential √¢‚Ç¨‚Äú GDPR'</span></span>, INFORMATION_TYPE = <span class="hljs-string"><span class="hljs-string">'Personal Info'</span></span>); ADD SENSITIVITY CLASSIFICATION TO dbo.Contractors.SSN <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (LABEL = <span class="hljs-string"><span class="hljs-string">'Highly Confidential'</span></span>, INFORMATION_TYPE = <span class="hljs-string"><span class="hljs-string">'National ID'</span></span>); ADD SENSITIVITY CLASSIFICATION TO dbo.Contractors.HourlyRate <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (LABEL = <span class="hljs-string"><span class="hljs-string">'Highly Confidential'</span></span>, INFORMATION_TYPE = <span class="hljs-string"><span class="hljs-string">'Financial'</span></span>);</code> </pre> <br>  Agora, em vez de olhar para sys.extended_properties, voc√™ pode v√™-los em sys.sensitivity_classifications: <br><br><img src="https://habrastorage.org/webt/xs/4u/bx/xs4ubxognfau0yxlbl_g8caqujm.png"><br><br>  E se realizarmos amostragem de auditoria (ou DML) para esta tabela, n√£o precisaremos alterar nada especificamente;  Ap√≥s criar a classifica√ß√£o, <code>SELECT *</code> registrar√° no log de auditoria um registro desse tipo de informa√ß√£o em uma nova coluna data_sensitivity_information: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sensitivity_attributes</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sensitivity_attribute</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">label</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Confidential - GDPR"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">information_type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Personal Info"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sensitivity_attribute</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">label</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Highly Confidential"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">information_type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"National ID"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sensitivity_attribute</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">label</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Highly Confidential"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">information_type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Financial"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sensitivity_attributes</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Obviamente, isso n√£o resolve todos os problemas de conformidade com os padr√µes, mas pode dar uma vantagem real.  O uso do assistente para identificar automaticamente colunas e converter chamadas sp_addextendedproperty em comandos ADD SENSITIVITY CLASSIFICATION pode simplificar bastante a tarefa de conformidade com os padr√µes.  Mais tarde, escreverei um artigo separado sobre isso. <br><br>  Voc√™ tamb√©m pode automatizar a cria√ß√£o (ou atualiza√ß√£o) de permiss√µes com base no r√≥tulo nos metadados - a cria√ß√£o de um script SQL din√¢mico que pro√≠be o acesso a todas as colunas confidenciais (GDPR), o que permitir√° gerenciar usu√°rios, grupos ou fun√ß√µesb.  Eu trabalharei sobre esta quest√£o no futuro. <br><br><h2>  <font color="#c30">Disponibilidade</font> </h2><br><h4>  <font color="#004d71">Cria√ß√£o de √≠ndice renov√°vel em tempo real</font> </h4><br>  No SQL Server 2017, tornou-se poss√≠vel suspender e retomar a reconstru√ß√£o do √≠ndice em tempo real, o que pode ser muito √∫til se voc√™ precisar alterar o n√∫mero de processadores usados, continuar a partir do momento da suspens√£o ap√≥s uma falha ou simplesmente preencher a lacuna entre as janelas de servi√ßo.  Eu falei sobre esse recurso em um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo anterior</a> . <br><br>  No SQL Server 2019, voc√™ pode usar a mesma sintaxe para criar √≠ndices em tempo real, pausar e continuar, al√©m de limitar o tempo de execu√ß√£o (definindo o tempo de pausa): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> foo <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> dbo.bar(blat) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ONLINE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">RESUMABLE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>, MAX_DURATION = <span class="hljs-number"><span class="hljs-number">10</span></span> MINUTES);</code> </pre> <br>  Se essa consulta funcionar por muito tempo, para pausar, voc√™ poder√° executar o ALTER INDEX em outra sess√£o (mesmo que o √≠ndice ainda n√£o exista fisicamente): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> foo <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> dbo.bar PAUSE;</code> </pre> <br>  Nas vers√µes atuais, o grau de paralelismo durante a renova√ß√£o n√£o pode ser reduzido, como √© o caso da reconstru√ß√£o.  Ao tentar reduzir o DOP: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> foo <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> dbo.bar <span class="hljs-keyword"><span class="hljs-keyword">RESUME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (MAXDOP = <span class="hljs-number"><span class="hljs-number">2</span></span>);</code> </pre> <br>  Temos o seguinte: <br><br><pre> <code class="hljs pgsql">Msg <span class="hljs-number"><span class="hljs-number">10666</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>, State <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-type"><span class="hljs-type">Line</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> Cannot resume <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> build <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> required DOP <span class="hljs-number"><span class="hljs-number">4</span></span> (DOP operation was started <span class="hljs-keyword"><span class="hljs-keyword">with</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> available. Please ensure sufficient DOP <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> available <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abort</span></span> existing <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> operation <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> try again. The <span class="hljs-keyword"><span class="hljs-keyword">statement</span></span> has been terminated.</code> </pre> <br>  De fato, se voc√™ tentar fazer isso e executar o comando sem par√¢metros adicionais, receber√° o mesmo erro, pelo menos nas compila√ß√µes atuais.  Eu acho que a tentativa de renova√ß√£o foi registrada em algum lugar e o sistema queria us√°-la novamente.  Para continuar, voc√™ deve especificar o valor DOP correto (ou superior): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> foo <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> dbo.bar <span class="hljs-keyword"><span class="hljs-keyword">RESUME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (MAXDOP = <span class="hljs-number"><span class="hljs-number">4</span></span>);</code> </pre> <br>  Para deixar claro: voc√™ pode aumentar o DOP ao retomar a cria√ß√£o de um √≠ndice em pausa, mas n√£o reduzi-lo. <br><br>  Um benef√≠cio adicional de tudo isso √© que voc√™ pode configurar a cria√ß√£o e / ou renova√ß√£o de √≠ndices em tempo real como o modo padr√£o usando as cl√°usulas ELEVATE_ONLINE e ELEVATE_RESUMABLE para o novo banco de dados. <br><br><h4>  <font color="#004d71">Cria√ß√£o / reconstru√ß√£o em tempo real de √≠ndices de colunas em cluster</font> </h4><br>  Al√©m da cria√ß√£o de √≠ndice renov√°vel, tamb√©m temos a oportunidade de criar ou reconstruir √≠ndices de colunas clusterizadas em tempo real.  Essa √© uma altera√ß√£o significativa, que permite que voc√™ n√£o gaste mais o tempo das janelas de servi√ßo na manuten√ß√£o desses √≠ndices ou (para maior certeza) converter os √≠ndices de linha para coluna: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> dbo.splunge ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ); GO <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> CLUSTERED <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> PK_Splunge <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> dbo.splunge(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>); GO <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> CLUSTERED COLUMNSTORE <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> PK_Splunge <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> dbo.splunge <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (DROP_EXISTING = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ONLINE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um aviso: se um √≠ndice em cluster tradicional existente foi criado em tempo real, sua convers√£o em um √≠ndice de coluna em cluster tamb√©m √© poss√≠vel apenas nesse modo. </font><font style="vertical-align: inherit;">Se fizer parte da chave prim√°ria, embutida ou n√£o ...</font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> dbo.splunge ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_Splunge PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ); GO <span class="hljs-comment"><span class="hljs-comment">-- or after the fact -- ALTER TABLE dbo.splunge ADD CONSTRAINT PK_Splunge PRIMARY KEY CLUSTERED(id);</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Temos o seguinte erro: </font></font><br><br><pre> <code class="hljs pgsql">Msg <span class="hljs-number"><span class="hljs-number">1907</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> Cannot recreate <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-string"><span class="hljs-string">'PK_Splunge'</span></span>. The <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> definition does <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> match the <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> being enforced <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> the existing <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Voc√™ deve primeiro remover a restri√ß√£o para convert√™-la em um √≠ndice de coluna em cluster, mas ambas as opera√ß√µes podem ser executadas em tempo real: </font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> dbo.splunge <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_Splunge <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ONLINE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>); GO <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> CLUSTERED COLUMNSTORE <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> PK_Splunge <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> dbo.splunge <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ONLINE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso funciona, mas provavelmente levar√° mais tempo em tabelas grandes do que se a chave prim√°ria fosse implementada como um √≠ndice clusterizado exclusivo. </font><font style="vertical-align: inherit;">N√£o posso ter certeza se isso √© uma restri√ß√£o intencional ou apenas uma limita√ß√£o do CTP atual.</font></font><br><br><h4> <font color="#004d71"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redirecionando uma conex√£o de replica√ß√£o de um servidor secund√°rio para um prim√°rio </font></font><br></font> </h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Essa fun√ß√£o permite configurar o redirecionamento sem escutar, para que voc√™ possa alternar a conex√£o com o servidor principal, mesmo se o secund√°rio for especificado diretamente na cadeia de conex√£o. </font><font style="vertical-align: inherit;">Essa fun√ß√£o pode ser usada quando a tecnologia de cluster n√£o oferece suporte √† escuta, ao usar AGs sem um cluster ou quando existe um esquema de redirecionamento complexo em um cen√°rio com v√°rias sub-redes. </font><font style="vertical-align: inherit;">Isso impedir√° que a conex√£o tente, por exemplo, gravar opera√ß√µes para replica√ß√£o no modo somente leitura (e falhas, respectivamente).</font></font><br><br><h2>  <font color="#c30">Desenvolvimento</font> </h2><br><h4> <font color="#004d71"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recursos adicionais do gr√°fico</font></font></font> </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os relacionamentos de gr√°fico agora suportam a instru√ß√£o MERGE para um n√≥ ou tabelas de limites usando predicados MERGE; </font><font style="vertical-align: inherit;">Agora, um operador pode atualizar uma aresta existente ou inserir uma nova. </font><font style="vertical-align: inherit;">A nova restri√ß√£o de borda permite determinar quais n√≥s a borda pode se conectar.</font></font><br><br><h4> <font color="#004d71"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utf-8</font></font></font> </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O SQL Server 2012 adicionou suporte para UTF-16 e caracteres adicionais, definindo a classifica√ß√£o especificando um nome com o sufixo _SC, como Latin1_General_100_CI_AI_SC, para usar colunas Unicode (nchar / nvarchar). No SQL Server 2017, voc√™ pode importar e exportar dados UTF-8 de e para essas colunas usando ferramentas como </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BCP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BULK INSERT</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No SQL Server 2019, h√° novas op√ß√µes de agrupamento para oferecer suporte √† reten√ß√£o for√ßada de dados UTF-8 em sua forma original. </font><font style="vertical-align: inherit;">Portanto, voc√™ pode criar facilmente colunas char ou varchar e armazenar dados UTF-8 corretamente usando o novo agrupamento com o sufixo _SC_UTF8, como Latin1_General_100_CI_AI_SC_UTF8. </font><font style="vertical-align: inherit;">Isso pode ajudar a melhorar a compatibilidade com aplicativos externos e DBMS, sem o custo de processamento e armazenamento do nvarchar.</font></font><br><br><h4> <font color="#004d71"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ovo de p√°scoa que encontrei</font></font></font> </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tanto quanto me lembro, os usu√°rios do SQL Server reclamam dessa vaga mensagem de erro: </font></font><br><br><pre> <code class="hljs vbscript">Msg <span class="hljs-number"><span class="hljs-number">8152</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> binary data would be truncated.</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nas vers√µes do CTP com as quais experimentei, foi notada uma mensagem de erro interessante que n√£o existia antes: </font></font><br><br><pre> <code class="hljs pgsql">Msg <span class="hljs-number"><span class="hljs-number">2628</span></span> String <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> binary data would be truncated <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-string"><span class="hljs-string">'%.*ls'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">column</span></span> <span class="hljs-string"><span class="hljs-string">'%.*ls'</span></span>. Truncated <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'%.*ls'</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o acho que seja necess√°rio mais nada aqui; esta √© uma grande melhoria (embora muito tarde) e promete fazer muitos felizes. No entanto, essa funcionalidade n√£o estar√° dispon√≠vel no CTP 2.0; S√≥ lhe dou a oportunidade de olhar um pouco √† frente. Brent Ozar listou todas as novas mensagens que encontrou no CTP atual e as temperou com alguns coment√°rios √∫teis em seu artigo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sys.messages: descobrindo recursos adicionais</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h2>  <font color="#c30">Conclus√£o</font> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O SQL Server 2019 oferece bons recursos adicionais que ajudar√£o a melhorar o trabalho com sua plataforma de banco de dados relacional favorita, e h√° v√°rias mudan√ßas sobre as quais eu n√£o falei. Mem√≥ria com uso eficiente de energia, clustering para servi√ßos de aprendizado de m√°quina, replica√ß√£o e transa√ß√µes distribu√≠das no Linux, Kubernetes, conectores para Oracle / Teradata / MongoDB, replica√ß√µes s√≠ncronas de AG aumentaram para oferecer suporte ao Java (uma implementa√ß√£o semelhante ao Python / R) e, igualmente importante, um novo salto, intitulado Big Data Cluster. Para usar alguns desses recursos, voc√™ deve se registrar usando </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">este formul√°rio EAP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O pr√≥ximo livro de Bob Ward, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pro SQL Server no Linux - incluindo a implanta√ß√£o baseada em cont√™iner com Docker e Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, pode fornecer algumas dicas sobre outras coisas que est√£o por vir em breve. </font><font style="vertical-align: inherit;">E </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esta publica√ß√£o de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Brent Ozar fala sobre uma poss√≠vel corre√ß√£o futura para uma fun√ß√£o escalar definida pelo usu√°rio. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mas, mesmo neste primeiro CTP p√∫blico, h√° algo significativo para quase todo mundo, e pe√ßo que tente voc√™ mesmo!</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt424441/">https://habr.com/ru/post/pt424441/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt424429/index.html">Science Art and Sound: 4 projetos impressionantes</a></li>
<li><a href="../pt424431/index.html">Valve divulga ranking de controladores de jogos a vapor</a></li>
<li><a href="../pt424433/index.html">Por que os hackers Mikrotik e como eu escondi 100 mil.RotterOS de uma botnet</a></li>
<li><a href="../pt424435/index.html">Zool√≥gico de perfura√ß√£o de petr√≥leo: colocando as coisas em ordem</a></li>
<li><a href="../pt424437/index.html">Elm. Confort√°vel e estranho. Json.Encoder e Json.Decoder</a></li>
<li><a href="../pt424443/index.html">Vivaldi 2.0 a nosso favor</a></li>
<li><a href="../pt424445/index.html">Tradu√ß√£o de Neil Ford de microsservi√ßos como uma arquitetura evolutiva</a></li>
<li><a href="../pt424447/index.html">Lisp com sabor Pascal ou a linguagem de programa√ß√£o 8501st</a></li>
<li><a href="../pt424453/index.html">Aprenda o OpenGL. Li√ß√£o 6.2 - Renderiza√ß√£o com base f√≠sica. Fontes de luz anal√≠tica</a></li>
<li><a href="../pt424455/index.html">Intel Optane - agora 1,5 Terabytes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>