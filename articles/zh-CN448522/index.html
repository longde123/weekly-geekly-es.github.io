<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💐 👨🏾‍🍳 🤴🏼 nginx的配置生成，一个拉取请求的历史记录 👨🏻‍✈️ 🧓🏽 🍃</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="亲爱的问候。 自2006年以来，在我的战斗服务器上，漂亮的nginx一直在旋转，并且在其管理的这些年中，我积累了很多配置和模板。 我对Nginx表示了很多赞扬，并且以某种方式证明，即使是Habr上的Nginx集线器也使我起步，炫耀\ m / 

 朋友要我为他们建立一个开发服务器场，而不是用我的特定...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>nginx的配置生成，一个拉取请求的历史记录</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/448522/">亲爱的问候。 自2006年以来，在我的战斗服务器上，漂亮的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">nginx一直在</a>旋转，并且在其管理的这些年中，我积累了很多配置和模板。 我对Nginx表示了很多赞扬，并且以某种方式证明，即使是Habr上的Nginx集线器也使我起步，炫耀\ m / <br><br> 朋友要我为他们建立一个开发服务器场，而不是用我的特定模板拖动它们，我记得一个有趣的项目<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">nginxconfig.io</a> ，该项目分散了配置并准备了进行加密的所有内容，等等。 我想，为什么不呢？ 但是，nginxconfig允许我将zip存档下载到浏览器，而不是使用wget / fetch / curl将其直接合并到服务器上，这让我很生气。 什么样的废话，为什么我需要在浏览器中使用，而我需要从控制台在服务器上使用。 生气，我爬到github上查看该项目的胆量，这导致了它的分叉，并因此产生了pull请求。 如果不有趣的话我不会写;） <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cf1/0c3/6c3/cf10c36c3b10ad401a5a0f94f4074384.svg" alt="图片"><a name="habracut"></a><br><br> 当然，在选择源代码之前，我从chrome中提取了带有配置文件的生成的zip归档文件，然后在那儿等待以“ blob：”开头的地址，oppa。 已经很清楚，在此过程中，服务不会生成任何东西，实际上js完成了所有这些工作。 实际上，zip存档是由客户端本身，浏览器，javascript生成的。 即 魅力在于， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">nginxconfig.io</a>项目可以简单地另存为html页面，并上传到<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">narod.ru上</a> ，并且可以正常工作。）这是一个非常有趣且有趣的解决方案，但是，对于设置服务器而言，这非常不便，实际上，对于该项目的目的是什么。 通过浏览器下载生成的存档，然后在2019年使用nc ...将其传输到服务器？ 我为自己设定了寻找一种方法来将生成的配置直接下载到服务器的任务。 <br><br> 分叉了项目之后，我开始思考我有什么选择。 我不想离开该项目应保持干净的前端而没有任何后端的条件，这使任务变得复杂。 当然，最简单的解决方案是提取nodejs，并使其通过直接链接使用配置生成存档。 <br><br> 实际上，没有太多选择。 更准确地说，只有一个想到。 我们需要配置配置并获得一个链接，该链接可以复制到服务器控制台以获取zip存档。 <br><br> 最终的zip归档文件中的几个文本文件的重量相当大，实际上只有几千字节。 显而易见的解决方案是从生成的zip归档文件中获取base64字符串，并将其扔到缓冲区中，而在服务器上使用控制台中的命令 <br><pre><code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'base64string'</span></span> | base64 --decode &gt; config.zip</code> </pre> 我们可以创建这个非常zip的文件。 <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">nginxconfig.io</a>是用AngularJS编写的，我什至无法想象如果作者不选择反应式js框架将需要多少公里的代码。 但是我完全可以想象，尽管这已经是一个完全不同的话题，但在VueJS上实现所有这些功能将有多么容易和美丽。 <br><br> 在项目资源中，我们看到了一种生成zip归档文件的方法： <br><br><pre> <code class="javascript hljs">$scope.downloadZip = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> zip = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JSZip(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sourceCodes = $<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.document.querySelectorAll(<span class="hljs-string"><span class="hljs-string">'main .file .code.source'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; sourceCodes.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sourceCode = sourceCodes[i]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> name = sourceCode.dataset.filename; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> content = sourceCode.children[<span class="hljs-number"><span class="hljs-number">0</span></span>].children[<span class="hljs-number"><span class="hljs-number">0</span></span>].innerText; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$scope.isSymlink() &amp;&amp; name.match(<span class="hljs-regexp"><span class="hljs-regexp">/^sites-available\//</span></span>)) { name = name.replace(<span class="hljs-regexp"><span class="hljs-regexp">/^sites-available\//</span></span>, <span class="hljs-string"><span class="hljs-string">'sites-enabled/'</span></span>); } zip.file(name, content); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (name.match(<span class="hljs-regexp"><span class="hljs-regexp">/^sites-available\//</span></span>)) { zip.file(name.replace(<span class="hljs-regexp"><span class="hljs-regexp">/^sites-available\//</span></span>, <span class="hljs-string"><span class="hljs-string">'sites-enabled/'</span></span>), <span class="hljs-string"><span class="hljs-string">'../'</span></span> + name, { <span class="hljs-attr"><span class="hljs-attr">unixPermissions</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">parseInt</span></span>(<span class="hljs-string"><span class="hljs-string">'120755'</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>), }); } } zip.generateAsync({ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'blob'</span></span>, <span class="hljs-attr"><span class="hljs-attr">platform</span></span>: <span class="hljs-string"><span class="hljs-string">'UNIX'</span></span>, }).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">content</span></span></span><span class="hljs-function">) </span></span>{ saveAs(content, <span class="hljs-string"><span class="hljs-string">'nginxconfig.io-'</span></span> + $scope.getDomains().join(<span class="hljs-string"><span class="hljs-string">','</span></span>) + <span class="hljs-string"><span class="hljs-string">'.zip'</span></span>); }); gtag(<span class="hljs-string"><span class="hljs-string">'event'</span></span>, $scope.getDomains().join(<span class="hljs-string"><span class="hljs-string">','</span></span>), { <span class="hljs-attr"><span class="hljs-attr">event_category</span></span>: <span class="hljs-string"><span class="hljs-string">'download_zip'</span></span>, }); };</code> </pre><br> 一切都非常简单，使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">jszip</a>库，将在其中放置配置文件的地方创建一个zip。 创建zip归档文件后，js使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">FileSaver.js</a>库将其提供给浏览器： <br><br><pre> <code class="javascript hljs">saveAs(content, <span class="hljs-string"><span class="hljs-string">'nginxconfig.io-'</span></span> + $scope.getDomains().join(<span class="hljs-string"><span class="hljs-string">','</span></span>) + <span class="hljs-string"><span class="hljs-string">'.zip'</span></span>);</code> </pre><br> 内容是生成的Blob zip存档对象。 <br><br> 好的，我要做的就是在它旁边添加另一个按钮，当我单击它时，不要将生成的zip存档保存到浏览器中，而是从中获取base64代码。 经过一些萨满教义之后，我得到了2种方法，而不是一种downloadZip： <br><br><pre> <code class="javascript hljs">$scope.downloadZip = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ generateZip(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">content</span></span></span><span class="hljs-function">) </span></span>{ saveAs(content, <span class="hljs-string"><span class="hljs-string">'nginxconfig.io-'</span></span> + $scope.getDomains().join(<span class="hljs-string"><span class="hljs-string">','</span></span>) + <span class="hljs-string"><span class="hljs-string">'.zip'</span></span>); }); gtag(<span class="hljs-string"><span class="hljs-string">'event'</span></span>, $scope.getDomains().join(<span class="hljs-string"><span class="hljs-string">','</span></span>), { <span class="hljs-attr"><span class="hljs-attr">event_category</span></span>: <span class="hljs-string"><span class="hljs-string">'download_zip'</span></span>, }); }; $scope.downloadBase64 = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ generateZip(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">content</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> reader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileReader(); reader.readAsDataURL(content); reader.onloadend = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> base64 = reader.result.replace(<span class="hljs-regexp"><span class="hljs-regexp">/^data:.+;base64,/</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   base64     zip    base64  } }); gtag('event', $scope.getDomains().join(','), { event_category: 'download_base64', }); };</span></span></code> </pre><br> 如您所见，我将zip归档文件的生成放入私有的generateZip方法中，因为 这是AngularJS，作者本人坚持回调，但并未通过promises实现它。  downloadZip仍在输出中执行saveAs，而downloadBase64则有所不同。 我们创建了一个HTML5中<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">提供</a>的FileReader对象，该对象已经<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">可以</a>使用。 在适当的时候，它知道如何从blob中创建base64字符串，更确切地说，它是如何创建DataURL字符串，但这对我们而言并不重要，因为  DataURL包含我们所需要的。 宾果，当我试图将所有这些放入缓冲区时，有一点收获在等着我。 作者在项目中使用了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">剪贴板js</a>库，该库允许根据所选文本使用没有Flash对象的剪贴板。 最初，我决定将base64放在带有display：none的元素中，但是在那种情况下，我无法将其放在剪贴板上，因为 没有选择发生。 因此，代替显示：none; 我做到了 <br><br><pre> <code class="css hljs"><span class="hljs-selector-tag"><span class="hljs-selector-tag">position</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">absolute</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">z-index</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-1</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">opacity</span></span>: 0;</code> </pre><br> 这样我就可以将元素隐藏在自己的视线之外，而实际上却将其留在了页面上。 瞧，任务完成了，当我点击我的按钮时，在缓冲区中放了一行表格： <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'base64string'</span></span> | base64 --decode &gt; config.zip</code> </pre> <br> 我只是将其插入服务器上的控制台，并立即收到包含所有配置的zip存档。 <br><br> 好吧，当然，我向作者提出了拉取请求，因为 该项目活跃且活跃，我想查看作者的更新并有自己的按钮）谁在乎，这是<a href="">我的</a>项目<a href="">分支，也是</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">pull request本身</a> ，您可以在其中查看我修复/更新的内容。 <br><br> 强力的发展:-) <br><br><img src="https://habrastorage.org/webt/et/op/sv/etopsv7os4ew9wv8kkccgvvbw78.gif"></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN448522/">https://habr.com/ru/post/zh-CN448522/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN448504/index.html">他们为每个人“ Habrom”收集了护照的参考书“由谁发行……”。 下载到健康</a></li>
<li><a href="../zh-CN448506/index.html">黑客帝国已有20年历史：沃卓斯基如何制作朋克，这决定了整个一代人的议程</a></li>
<li><a href="../zh-CN448510/index.html">宏cer（Acer）2019年：如果从游戏笔记本电脑中清除所有苍蝇该怎么办</a></li>
<li><a href="../zh-CN448516/index.html">在ARDUINO平台上进化或为机器人奠定基础，我们通过智能手机将传感器和视频驱动到计算机</a></li>
<li><a href="../zh-CN448518/index.html">如何看到黑洞？</a></li>
<li><a href="../zh-CN448524/index.html">以色列科学家首次在世界上印出一颗活泼的心</a></li>
<li><a href="../zh-CN448528/index.html">AWS上的免费Wireguard VPN服务</a></li>
<li><a href="../zh-CN448530/index.html">扩音器如何在移动订户上睡觉</a></li>
<li><a href="../zh-CN448532/index.html">空间数据中心。 总结实验</a></li>
<li><a href="../zh-CN448534/index.html">为什么我们需要具有增强的EMC的工业交换机？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>