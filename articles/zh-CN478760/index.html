<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✨ 🙋 🕺🏼 “零”地狱以及如何摆脱它 💾 🍔 👎🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="空值使用时若不慎，会使您的生活难以忍受，您甚至可能不了解到底是什么导致它们如此痛苦。 让我解释一下。 


 预设值 
 我们都看到了一个采用许多参数的方法，但是其中有一半以上是可选的。 结果是这样的： 



public function insertDiscount( string $name...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>“零”地狱以及如何摆脱它</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/funcorp/blog/478760/"> 空值使用时若不慎，会使您的生活难以忍受，您甚至可能不了解到底是什么导致它们如此痛苦。 让我解释一下。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/lz/mj/th/lzmjthqvjmhbaes0-t4bfffusg0.png"></div><a name="habracut"></a><br><h2> 预设值 </h2><br> 我们都看到了一个采用许多参数的方法，但是其中有一半以上是可选的。 结果是这样的： <br><br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">insertDiscount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(   string $name,   int $amountInCents,   bool $isActive = true,   string $description = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">,   int $productIdConstraint = null,   DateTimeImmutable $startDateConstraint = null,   DateTimeImmutable $endDateConstraint = null,   int $paymentMethodConstraint = null )</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span></span></code> </pre> <br> 在上面的示例中，我们想创建一个默认情况下适用于所有地方的折扣，但是在创建时它可能是无效的，仅适用于特定产品，仅在特定时间起作用，或者在用户选择特定付款方式时适用。 <br><br> 如果要为某种付款方式创建折扣，则需要按以下方式调用该方式： <br><br><pre> <code class="php hljs">insertDiscount(<span class="hljs-string"><span class="hljs-string">'Discount name'</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>);</code> </pre> <br> 这段代码可以使用，但是对于阅读它的人来说是完全无法理解的。 对其进行分析变得极为困难，因此我们无法轻松支持该应用程序。 <br><br> 让我们逐个示例地讨论这个示例。 <br><br><h3> 什么是有效折扣？ </h3><br> 我们已经发现无限折扣适用于所有地方。 因此，有效折扣包含除我们以后可以添加的限制以外的所有内容。 参数isActive的默认值为true。 因此，该方法可以如下调用： <br><br><pre> <code class="php hljs">insertDiscount(<span class="hljs-string"><span class="hljs-string">'Discount name'</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>);</code> </pre> <br> 仅通过阅读代码，我不知道折扣会立即生效。 为了找出答案，我必须检查方法签名是否具有默认值。 <br><br> 现在，假设您需要阅读200行代码。 您确定要检查所调用方法的每个签名以获取隐藏信息吗？ 我宁愿只是阅读代码而不必寻找任何东西。 <br><br> 负责描述的参数也是如此。 默认情况下，它是一个空字符串-这可能会在您希望看到描述的地方引起很多问题。 例如，它可以打印在支票上，但是由于它是空的，因此用户仅会看到带有金额的行旁边的空行。 系统不应允许这种情况发生。 <br><br> 我将这样重写此方法： <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">insertDiscount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(  string $name,  string $description,  int $amountInCents,  bool $isActive )</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span></span></code> </pre> <br> 由于我们决定稍后使用单独的方法添加这些限制，因此我完全删除了这些限制。 由于现在需要所有参数，因此可以按任何顺序排列它们。 我将描述放在名称之后，因为当它们靠近时，代码阅读起来会更好。 <br><br><pre> <code class="php hljs">insertDiscount(  <span class="hljs-string"><span class="hljs-string">'Discount name'</span></span>,  <span class="hljs-string"><span class="hljs-string">'Discount description'</span></span>,  <span class="hljs-number"><span class="hljs-number">100</span></span>,  Discount::STATUS_ACTIVE );</code> </pre> <br> 我还将常量用于折扣活动状态。 现在，您无需查看方法的签名即可了解此参数的真实含义：很明显，我们正在创建主动折扣。 将来，我们可以进一步改进此方法（破坏者：使用值对象）。 <br><br><h3> 添加约束 </h3><br> 现在您可以添加各种限制。 为了避免零，零，零地狱，我们将创建单独的方法。 <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addProductConstraint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(  Discount $discount,  int $productId )</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Discount</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addDateConstraint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(  Discount $discount,  DateTimeImmutable $startDate,  DateTimeImmutable $endDate )</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Discount</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addPaymentMethodConstraint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(  Discount $discount,  int $paymentMethod )</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Discount</span></span></span></span>;</code> </pre> <br> 因此，如果我们要创建一个具有一定限制的新折扣，我们将这样做： <br><br><pre> <code class="php hljs">$discountId = insertDiscount(  <span class="hljs-string"><span class="hljs-string">'Discount name'</span></span>,  <span class="hljs-string"><span class="hljs-string">'Discount description'</span></span>,  <span class="hljs-number"><span class="hljs-number">100</span></span>,  Discount::STATUS_ACTIVE ); addPaymentMethodConstraint(  $discountId,  PaymentMethod::CREDIT_CARD );</code> </pre> <br> 现在将其与原始通话进行比较。 您将看到它变得更加方便阅读。 <br><br><h2> 对象属性为空 </h2><br> 解决对象属性中的零也会引起问题。 我无法传达我经常看到这样的事情： <br><br><pre> <code class="php hljs">$currencyCode = strtolower(  $record-&gt;currencyCode );</code> </pre> <br>  um！  “不能将null传递给strtolower。” 发生这种情况是因为开发人员忘记了currencyCode可能为null。 由于许多开发人员仍然不使用IDE或抑制其中的警告，因此很多年以来人们可能不会注意到这一点。 该错误将继续出现在一些未读日志中，并且客户端将报告显然与此无关的周期性问题，因此没有人会去看这行代码。 <br><br> 我们当然可以在访问currencyCode的任何地方添加空检查。 但是随后我们将陷入另一种地狱： <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($record-&gt;currencyCode === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {  <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \RuntimeException(<span class="hljs-string"><span class="hljs-string">'Currency code cannot be null'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($record-&gt;amount === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {  <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \RuntimeException(<span class="hljs-string"><span class="hljs-string">'Amount cannot be null'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($record-&gt;amount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) {  <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \RuntimeException(<span class="hljs-string"><span class="hljs-string">'Amount must be a positive value'</span></span>); }</code> </pre> <br> 但是，正如您已经了解的那样，这不是最佳解决方案。 除了使您的方法混乱之外，您现在应该在所有地方重复该测试。 而且，每次添加另一个null属性时，请不要忘记再进行一次此类检查！ 幸运的是，有一个简单的解决方案：值对象。 <br><br><h2> 价值对象 </h2><br> 值对象是功能强大但简单的事物。 我们试图解决的问题是有必要不断验证我们的所有属性。 但是我们这样做是因为我们不知道是否可以信任对象的属性，以及它们是否有效。 如果可以的话该怎么办？ <br><br> 要信任值，它们需要两个属性：它们必须经过验证，并且自验证以来不得更改。 看一看这个课程： <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Amount</span></span></span><span class="hljs-class"> </span></span>{  <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $amountInCents;  <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $currencyCode;  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $amountInCents, string $currencyCode)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">self</span></span></span><span class="hljs-function">  </span></span>{    Assert::that($amountInCents)-&gt;greaterThan(<span class="hljs-number"><span class="hljs-number">0</span></span>);    <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;amountInCents = $amountInCents;    <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;currencyCode = $currencyCode;  }  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAmountInCents</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">  </span></span>{    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;amountInCents;  }  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCurrencyCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function">  </span></span>{    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;currencyCode;  } }</code> </pre> <br> 我正在使用beberlei / assert包。 每当检查失败时，它将引发异常。 这与源代码中null的例外相同，除非我们将检查移至此构造函数。 <br><br> 由于我们使用类型声明，因此我们保证类型也是正确的。 因此，我们不能将int传递给strtolower。 如果使用的是不支持类型声明的旧版PHP，则可以使用此包通过-&gt;整数（）和-&gt;字符串（）检查类型。 <br><br> 创建对象后，无法更改值，因为我们只有getter，而没有setter。 这称为免疫。 添加final不允许扩展此类以添加setter或magic方法。 如果在方法参数中看到Amount $ amount，则可以100％确保其所有属性均已通过验证并且该对象可以安全使用。 如果这些值无效，则将无法创建对象。 <br><br> 现在，借助值对象，我们可以进一步改进示例： <br><br><pre> <code class="php hljs">$discount = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Discount(  <span class="hljs-string"><span class="hljs-string">'Discount name'</span></span>,  <span class="hljs-string"><span class="hljs-string">'Discount description'</span></span>,  <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Amount(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-string"><span class="hljs-string">'CAD'</span></span>),  Discount::STATUS_ACTIVE ) insertDiscount($discount);</code> </pre> <br> 请注意，我们首先创建一个Discount，然后在内部使用Amount作为参数。 这样可以确保insertDiscount方法接收有效的折扣对象，并使整个代码块更易于理解。 <br><br><h2> 零恐怖故事 </h2><br> 让我们看一个有趣的情况，其中null对应用程序可能有害。 这个想法是从数据库中提取集合并对其进行过滤。 <br><br><pre> <code class="php hljs">$collection = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;findBy([<span class="hljs-string"><span class="hljs-string">'key'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'value'</span></span>]); $result = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;filter($collection, $someFilterMethod); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($result === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {   $result = $collection; }</code> </pre> <br> 如果结果为null，则使用原始集合作为结果？ 这是有问题的，因为如果过滤方法找不到合适的值，则返回null。 因此，如果所有内容都被过滤掉，我们将忽略过滤器并返回所有值。 这完全破坏了逻辑。 <br><br> 为什么要使用原始集合？ 我们永远不会知道。 我怀疑开发人员对null在这种情况下意味着什么有一定的假设，但事实证明这是错误的。 <br><br> 这是空值的问题。 在大多数情况下，不清楚它们的含义，因此我们只能猜测如何应对它们。 犯错很容易。 另一方面，例外非常清楚： <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {  $result = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;filter($collection, $someFilterMethod); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (CollectionCannotBeEmpty $e) {  <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre> <br> 此代码是唯一的。 开发人员不太可能会误解它。 <br><br><h2> 值得付出努力吗？ </h2><br> 所有这些似乎都需要额外的精力来编写执行相同操作的代码。 是的，是的。 但是与此同时，您将花费更少的时间阅读和理解代码，因此付出的努力将得到丰厚的回报。 如果我不必花费任何时间更改代码或添加新功能，那么花适当的时间编写代码可以节省几天的时间。 将其视为有保证的高收益投资。 <br><br> 因此，我的空想成为了终结。 我希望这可以帮助您编写更易于理解和维护的代码。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN478760/">https://habr.com/ru/post/zh-CN478760/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN478740/index.html">去吧！ PHP团队如何着手编写微服务</a></li>
<li><a href="../zh-CN478748/index.html">可靠性测试SSD：3dnews，JEDEC和常识。 真相在哪里，兄弟？</a></li>
<li><a href="../zh-CN478750/index.html">面向开发人员的实际数据可视化库</a></li>
<li><a href="../zh-CN478752/index.html">版本控制系统的历史</a></li>
<li><a href="../zh-CN478758/index.html">出色的UTM标签指南：如何确定用户来自何处</a></li>
<li><a href="../zh-CN478764/index.html">JavaScript错误：修复，处理，修复</a></li>
<li><a href="../zh-CN478766/index.html">自定义Spring MVC控制器的映射</a></li>
<li><a href="../zh-CN478772/index.html">卷积纹理</a></li>
<li><a href="../zh-CN478774/index.html">Arduino和Sticks的新年心情</a></li>
<li><a href="../zh-CN478778/index.html">哈布拉侦探和节日气氛</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>