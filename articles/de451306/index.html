<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äçüîß üçΩÔ∏è üë©üèæ‚Äçüé§ QEMU.js: jetzt ernst und mit WASM üéç üêß üê±</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Aus Lachen habe ich mich einmal entschlossen , die Reversibilit√§t des Prozesses zu beweisen und zu lernen, wie man JavaScript (oder besser Asm.js) aus...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>QEMU.js: jetzt ernst und mit WASM</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451306/"><p>  Aus Lachen habe ich mich einmal entschlossen <em>, die Reversibilit√§t des Prozesses</em> zu <em>beweisen</em> und zu lernen, wie man JavaScript (oder besser Asm.js) aus Maschinencode generiert.  QEMU wurde f√ºr das Experiment ausgew√§hlt, einige Zeit sp√§ter wurde ein Artikel √ºber Habr geschrieben.  In den Kommentaren wurde mir geraten, das Projekt auf WebAssembly neu zu erstellen, und ich selbst hatte keine Lust, das <em>fast fertige</em> Projekt selbst zu verlassen ... Die Arbeit ging weiter, aber sehr langsam, und jetzt erschien in diesem Artikel ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Kommentar</a> zum Thema "Wie endete es?".  Auf meine ausf√ºhrliche Antwort h√∂rte ich "Es zieht an einem Artikel."  Nun, wenn es zieht, wird es einen Artikel geben.  Vielleicht wird jemand n√ºtzlich sein.  Daraus lernt der Leser einige Fakten √ºber die QEMU-Codegenerierung des Backends des Ger√§ts sowie das Schreiben eines Just-in-Time-Compilers f√ºr eine Webanwendung. </p><a name="habracut"></a><br><h2 id="zadachi">  Die Aufgaben </h2><br><p>  Da ich bereits gelernt habe, wie man QEMU auf JavaScript "portiert", wurde diesmal beschlossen, dies mit Bedacht zu tun und alte Fehler nicht zu wiederholen. </p><br><h3 id="oshibka-nomer-raz-otvetvitsya-ot-point-release">  Fehleranzahl: Verzweigung von Punktfreigabe </h3><br><p> Mein erster Fehler war, meine Version von der Upstream-Version 2.4.1 zu verzweigen.  Dann schien es mir eine gute Idee zu sein: Wenn es eine Punktfreigabe gibt, ist sie wahrscheinlich stabiler als eine einfache 2.4- und noch mehr <code>master</code> Verzweigung.  Und da ich vorhatte, eine ganze Menge meiner Bugs hinzuzuf√ºgen, brauchte ich √ºberhaupt keine Fremden.  Also ist es wahrscheinlich passiert.  Aber hier ist das Pech: QEMU steht nicht still und irgendwann haben sie sogar die Optimierung des generierten Prozentcodes um 10 angek√ºndigt. ‚ÄûJa, jetzt friere ich ein‚Äú, dachte ich <del>  und brach ab </del>  .  Hier m√ºssen wir einen Exkurs machen: Aufgrund der Single-Threaded-Natur von QEMU.js und der Tatsache, dass die urspr√ºngliche QEMU nicht das Fehlen von Multithreading impliziert (das hei√üt, es ist entscheidend, dass mehrere nicht verwandte Codepfade gleichzeitig betrieben werden k√∂nnen und nicht nur alle Kernel "stecken"), die Hauptfunktionen von Threads musste sich f√ºr die M√∂glichkeit eines Anrufs von au√üen "herausstellen".  Dies f√ºhrte zu einigen nat√ºrlichen Verschmelzungsproblemen.  Die Tatsache, dass einige der √Ñnderungen aus dem Hauptzweig, mit denen ich versucht habe, meinen Code zusammenzuf√ºhren, auch in der Punktfreigabe (und daher in meinem Zweig) ausgew√§hlt wurden, w√ºrde wahrscheinlich auch keinen Komfort hinzuf√ºgen. </p><br><p>  Generell habe ich beschlossen, dass der Prototyp trotzdem Sinn macht <del>  rausschmei√üen </del>  Zerlegen Sie die Teile und erstellen Sie eine neue Version von Grund auf neu, basierend auf etwas Frischerem und jetzt vom <code>master</code> . </p><br><h3 id="oshibka-nomer-dva-tlp-metodologiya">  Fehler Nummer zwei: TLP-Methodik </h3><br><p>  Tats√§chlich ist dies im Allgemeinen kein Fehler - es ist nur ein Merkmal der Erstellung eines Projekts unter den Bedingungen eines v√∂lligen Missverst√§ndnisses von ‚ÄûWo und wie soll man sich bewegen?‚Äú Und im Allgemeinen ‚ÄûWerden wir dorthin gelangen?‚Äú.  Unter diesen Umst√§nden war die <em>Programmierung</em> eine vertretbare Option, aber ich wollte sie nat√ºrlich nicht unn√∂tig wiederholen.  Diesmal wollte ich es mit Bedacht tun: Atomic Commits, absichtliche Code√§nderungen (und nicht "Zufallszeichen aneinanderreihen, bis es kompiliert wird (mit Warnungen)", wie Linus Torvalds einmal √ºber jemanden sagte, wenn Sie Wikitatnik glauben) usw. </p><br><h3 id="oshibka-nomer-tri-ne-znaya-brodu-lezt-v-vodu">  Fehler Nummer drei: Ich wei√ü nicht, dass die Furt ins Wasser klettern soll </h3><br><p>  Ich habe dies noch nicht vollst√§ndig beseitigt, aber jetzt habe ich beschlossen, nicht den Weg des absolut geringsten Widerstands zu beschreiten und dies "auf erwachsene Weise" zu tun, n√§mlich mein TCG-Backend von Grund auf neu zu schreiben, damit ich sp√§ter nicht sage: "Ja, das ist es." Nat√ºrlich langsam, aber ich kann nicht alles kontrollieren - TCI ist so geschrieben ... "  Au√üerdem schien dies zun√§chst eine offensichtliche L√∂sung zu sein, da <em>ich Bin√§rcode generierte</em> .  Wie das Sprichwort sagt: "Ich habe Gent gesammelt, aber nicht diesen": Der Code ist nat√ºrlich bin√§r, aber das Steuerelement kann nicht einfach so auf ihn √ºbertragen werden - er muss zur Kompilierung explizit in den Browser verschoben werden, was zu einem bestimmten Objekt aus der JS-Welt f√ºhrt m√ºssen noch irgendwo sparen.  Jedoch auf <del>  normal </del>  F√ºr RISC-Architekturen ist meines Wissens eine typische Situation die Notwendigkeit, den Anweisungscache f√ºr den neu generierten Code explizit zu leeren. Wenn dies nicht das ist, was wir brauchen, ist es zumindest eng.  Au√üerdem habe ich bei meinem letzten Versuch erfahren, dass das Steuerelement nicht in die Mitte des √úbersetzungsblocks √ºbertragen zu werden scheint. Daher ben√∂tigen wir den Bytecode, der aus einem Offset interpretiert wird, nicht wirklich und k√∂nnen einfach durch Funktion auf TB generieren. </p><br><h2 id="prishli-i-pnuli">  Kam und trat </h2><br><p>  Obwohl ich bereits im Juli damit begonnen habe, den Code neu zu schreiben, kroch das magische Pendell unbemerkt: Normalerweise werden Briefe von GitHub als Benachrichtigungen √ºber Antworten auf Issues- und Pull-Anfragen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">angezeigt</a> , und dann <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">sagt</a> der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Binaryen</a> <em>pl√∂tzlich</em> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">als Qemu-Backend</a> im Kontext <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">:</a> ‚ÄûHier ist es - er hat so etwas getan, vielleicht sagt er etwas. ‚Äú  Es ging darum, mithilfe der Emscripten-bezogenen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Binaryen-</a> Bibliothek eine WASM-JIT zu erstellen.  Nun, ich sagte, dass Sie dort eine Apache 2.0-Lizenz haben und QEMU als Ganzes unter GPLv2 vertrieben wird und sie nicht sehr kompatibel sind.  Es stellte sich pl√∂tzlich heraus, dass die Lizenz <em>irgendwie korrigiert werden konnte</em> (ich wei√ü nicht: vielleicht √§ndern, vielleicht doppelte Lizenzierung, vielleicht etwas anderes ...).  Das hat mich nat√ºrlich gl√ºcklich gemacht, denn ich hatte mir zu diesem Zeitpunkt bereits mehrmals das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Bin√§rformat</a> WebAssembly angesehen und war irgendwie traurig und f√ºr mich unverst√§ndlich.  Hier gab es eine Bibliothek, die die Basisbl√∂cke mit dem √úbergangsgraphen verschlingt, den Bytecode ausgibt und ihn bei Bedarf sogar im Interpreter startet. </p><br><p>  Dann gab es auch einen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Brief</a> auf der QEMU-Mailingliste, aber dies ist wahrscheinlicher f√ºr die Frage: "Wer braucht ihn √ºberhaupt?"  Und es war <strong>pl√∂tzlich</strong> notwendig.  Zumindest k√∂nnen Sie solche Anwendungsf√§lle zusammenkratzen, wenn sie mehr oder weniger intelligent funktionieren: </p><br><ul><li>  Starten von Unterricht ohne Installation </li><li>  Virtualisierung unter iOS, wo Ger√ºchten zufolge die einzige Anwendung, die das Recht hat, Code im laufenden Betrieb zu generieren, die JS-Engine ist (stimmt das?) </li><li>  Mini-OS-Demonstration - Single-Disk, eingebaute, alle Arten von Firmware, etc ... </li></ul><br><h2 id="osobennosti-brauzernoy-sredy-vypolneniya">  Funktionen der Browser-Laufzeit </h2><br><p>  Wie gesagt, QEMU ist an Multithreading gebunden, aber nicht im Browser.  Nun, das hei√üt, wie nicht ... Zuerst war es √ºberhaupt nicht da, dann erschienen WebWorkers - so wie ich es verstehe, ist dies Multithreading basierend auf der Nachrichten√ºbermittlung <strong>ohne</strong> gegenseitig <strong>variable Variablen</strong> .  Dies f√ºhrt nat√ºrlich zu erheblichen Problemen beim Portieren von vorhandenem Code basierend auf einem Shared-Memory-Modell.  Dann wurde es unter dem Druck der √ñffentlichkeit unter dem Namen <code>SharedArrayBuffers</code> .  Sie f√ºhrten es nach und nach ein, feierten seinen Start in verschiedenen Browsern, feierten dann das neue Jahr und dann Meltdown ... Danach kamen sie zu dem Schluss, dass unh√∂flich, keine unh√∂fliche Zeitmessung, aber mit Hilfe des gemeinsamen Speichers und eines Flusses, der den Z√§hler erh√∂ht, immer noch <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ziemlich genau ist</a> .  Also haben sie Multithreading mit gemeinsamem Speicher deaktiviert.  Es scheint, dass sie es sp√§ter wieder eingeschaltet haben, aber wie aus dem ersten Experiment hervorgeht, gibt es ein Leben ohne es, und wenn ja, werden wir versuchen, es zu tun, ohne uns auf Multithreading zu verlassen. </p><br><p>  Das zweite Merkmal ist die Unm√∂glichkeit von Manipulationen auf niedriger Ebene mit dem Stapel: Sie k√∂nnen nicht einfach den aktuellen Kontext speichern, speichern und zu einem neuen mit einem neuen Stapel wechseln.  Der Aufrufstapel wird von der virtuellen JS-Maschine verwaltet.  Es scheint, was ist das Problem, da wir uns immer noch entschlossen haben, die fr√ºheren Flows vollst√§ndig manuell zu verwalten?  Tatsache ist, dass die Blockeingabe / -ausgabe in QEMU √ºber Coroutinen implementiert wird, und hier w√§ren Stapelmanipulationen auf niedriger Ebene f√ºr uns n√ºtzlich.  Gl√ºcklicherweise enth√§lt Emscipten bereits einen Mechanismus f√ºr asynchrone Operationen, sogar zwei: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Asyncify</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Emterpreter</a> .  Das erste funktioniert durch ein deutliches Aufbl√§hen des generierten JavaScript-Codes und wird nicht mehr unterst√ºtzt.  Der zweite ist der aktuelle "richtige Weg" und arbeitet durch die Erzeugung von Bytecode f√ºr seinen eigenen Interpreter.  Es funktioniert nat√ºrlich langsam, aber es bl√§st den Code nicht auf.  Die Coroutine-Unterst√ºtzung f√ºr diesen Mechanismus musste zwar selbst zugeordnet werden (es gab bereits Coroutinen, die unter Asyncify geschrieben wurden, und es gab eine Implementierung ungef√§hr derselben API f√ºr Emterpreter, Sie mussten sie nur verbinden). </p><br><p>  Im Moment habe ich es noch nicht geschafft, den Code in WASM zu kompilieren und mit Emterpreter zu interpretieren, sodass Blockger√§te noch nicht funktionieren (siehe n√§chste Serie, wie sie sagen ...).  Das hei√üt, am Ende solltest du so eine lustige Schicht bekommen: </p><br><ul><li>  interpretierter Block I / O.  Was haben Sie wirklich von einem emulierten NVMe mit nativer Leistung erwartet?  :) :) </li><li>  statisch kompilierter QEMU-Hauptcode (√úbersetzer, andere emulierte Ger√§te usw.) </li><li>  WASM dynamisch kompilierter Gastcode </li></ul><br><h2 id="osobennosti-ishodnikov-qemu">  Funktionen von QEMU-Quellen </h2><br><p>  Wie Sie wahrscheinlich bereits vermutet haben, sind der Emulationscode f√ºr Gastarchitekturen und der Code zum Generieren von Hostcomputeranweisungen aus QEMU getrennt.  In der Tat gibt es noch ein wenig kniffliger: </p><br><ul><li>  Es gibt Gastarchitekturen </li><li>  Es gibt <em>Beschleuniger</em> , n√§mlich KVM f√ºr die Hardwarevirtualisierung unter Linux (f√ºr kompatible Gast- und Hostsysteme), TCG f√ºr die JIT-Codegenerierung √ºberall.  Ab QEMU 2.9 wurde die Unterst√ºtzung f√ºr den HAXM-Hardwarevirtualisierungsstandard unter Windows angezeigt ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Details</a> ). </li><li>  Wenn TCG verwendet wird und keine Hardwarevirtualisierung, wird die Codegenerierung f√ºr jede Hostarchitektur sowie f√ºr einen universellen Interpreter separat unterst√ºtzt </li><li>  ... und alles - emulierte Peripherieger√§te, Benutzeroberfl√§che, Migration, Wiedergabe von Datens√§tzen usw. </li></ul><br><p>  <em>Wussten Sie √ºbrigens:</em> QEMU kann nicht nur den gesamten Computer emulieren, sondern auch den Prozessor f√ºr einen separaten Benutzerprozess im Host-Kernel, der beispielsweise vom AFL-Fuzzer zur Instrumentierung von Bin√§rdateien verwendet wird.  Vielleicht m√∂chte jemand diesen QEMU-Betriebsmodus auf JS portieren?  ;) </p><br><p>  Wie die meisten langj√§hrigen kostenlosen Programme wird QEMU durch einen Aufruf zum <code>configure</code> und <code>make</code> .  Angenommen, Sie m√∂chten etwas hinzuf√ºgen: ein TCG-Backend, eine Thread-Implementierung, etwas anderes.  Beeilen Sie sich nicht, sich √ºber die Aussicht auf Kommunikation mit Autoconf zu freuen / entsetzt zu sein (unterstreichen Sie sie gegebenenfalls) - tats√§chlich scheint die <code>configure</code> bei QEMU selbst geschrieben zu sein und es gibt nichts, woraus Sie etwas generieren k√∂nnen. </p><br><h2 id="webassembly">  Webassembly </h2><br><p>  Was ist das f√ºr eine Sache - WebAssembly (auch bekannt als WASM)?  Dies ist ein Ersatz f√ºr Asm.js, der jetzt nicht mehr vorgibt, g√ºltiger JavaScript-Code zu sein.  Im Gegenteil, es ist rein bin√§r und optimiert, und selbst das Schreiben einer Ganzzahl ist nicht sehr einfach: Es wird aus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gr√ºnden der Kompaktheit</a> im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">LEB128-</a> Format gespeichert. </p><br><p>  M√∂glicherweise haben Sie von dem Relooping-Algorithmus f√ºr Asm.js geh√∂rt, bei dem die Anweisungen zur Steuerung des Ausf√ºhrungsflusses auf hoher Ebene (dh wenn-dann-sonst-Schleifen usw.) wiederhergestellt werden, unter denen JS-Engines vom LLVM-IR auf niedriger Ebene abgestimmt werden. n√§her an dem vom Prozessor ausgef√ºhrten Maschinencode.  Nat√ºrlich ist die Zwischendarstellung von QEMU n√§her an der zweiten.  Es scheint, dass hier, Bytecode, das Ende der Qual ist ... Und dann die Bl√∂cke, wenn-dann-sonst und Schleifen! .. </p><br><p>  Und dies ist ein weiterer Grund, warum Binaryen n√ºtzlich ist: Es kann nat√ºrlich Bl√∂cke auf hoher Ebene akzeptieren, die nahe an dem liegen, was in WASM gespeichert wird.  Es kann aber auch Code aus dem Diagramm der Basisbl√∂cke und √úberg√§nge zwischen diesen erzeugen.  Nun, ich habe bereits gesagt, dass es das WebAssembly-Speicherformat hinter der praktischen C / C ++ - API verbirgt. </p><br><h2 id="tcg-tiny-code-generator">  TCG (Tiny Code Generator) </h2><br><p>  TCG <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">war urspr√ºnglich ein</a> Backend f√ºr den C-Compiler. Dann konnte es anscheinend die Konkurrenz mit GCC nicht aushalten, fand aber am Ende seinen Platz in QEMU als Code-Generierungsmechanismus f√ºr die Host-Plattform.  Es gibt auch ein TCG-Backend, das einen abstrakten Bytecode generiert, der sofort vom Interpreter ausgef√ºhrt wird, aber ich habe mich entschlossen, diesmal zu gehen.  Die Tatsache, dass QEMU bereits die M√∂glichkeit hat, den √úbergang zur generierten TB √ºber die Funktion <code>tcg_qemu_tb_exec</code> , war f√ºr mich sehr hilfreich. </p><br><p>  Um ein neues TCG-Backend zu QEMU hinzuzuf√ºgen, m√ºssen Sie ein Unterverzeichnis <code>tcg/&lt; &gt;</code> (in diesem Fall <code>tcg/binaryen</code> ) <code>tcg/binaryen</code> befinden sich zwei Dateien: <code>tcg-target.h</code> und <code>tcg-target.inc.c</code> und alles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">registrieren</a> Dies ist <code>configure</code> .  Sie k√∂nnen dort andere Dateien ablegen, aber wie Sie anhand der Namen dieser beiden Dateien erraten k√∂nnen, werden beide irgendwo enthalten sein: eine als regul√§re Header-Datei (sie wird in <code>tcg/tcg.h</code> , und diese befindet sich bereits in anderen Dateien in <code>tcg</code> Verzeichnissen). <code>accel</code> und nicht nur), das andere nur als Code-Snippet in <code>tcg/tcg.c</code> , aber es hat Zugriff auf seine statischen Funktionen. </p><br><p>  Nachdem ich beschlossen hatte, zu viel Zeit mit dem detaillierten Ablauf und der Funktionsweise zu verbringen, kopierte ich einfach die "Skelette" dieser beiden Dateien aus einer anderen Backend-Implementierung und gab dies im Lizenzheader ehrlich an. </p><br><p>  Die <code>tcg-target.h</code> enth√§lt haupts√§chlich Einstellungen in Form von <code>#define</code> s: </p><br><ul><li>  Wie viele Register und wie breit sind auf der Zielarchitektur (wir haben - so viel wir wollen, es gibt so viele - die Frage ist mehr als das, was der Browser in einem effizienteren Code auf einer "vollst√§ndig Ziel" -Architektur generiert ...) </li><li>  Ausrichtung der Host-Anweisungen: Auf x86 und in TCI werden die Anweisungen √ºberhaupt nicht ausgerichtet, aber ich werde √ºberhaupt keine Anweisungen in den Codepuffer einf√ºgen, sondern Zeiger auf die Strukturen der Binaryen-Bibliothek, also sage ich: 4 Bytes </li><li>  Welche optionalen Anweisungen kann das Backend generieren? Schalten Sie alles ein, was wir in Binaryen finden, und lassen Sie den Beschleuniger den Rest in einfachere aufteilen </li><li>  Welche ungef√§hre Gr√∂√üe des TLB-Cache vom Backend angefordert wird.  Tatsache ist, dass in QEMU alles ernst ist: Obwohl es Hilfsfunktionen gibt, die unter Ber√ºcksichtigung der Gast-MMU laden / speichern (und wo jetzt ohne?), Speichern sie ihren √úbersetzungscache in Form einer Struktur, deren Verarbeitung bequem einzubetten ist direkt zu den √úbersetzungsbl√∂cken.  Die Frage ist, welcher Offset in dieser Struktur von einer kleinen und schnellen Folge von Befehlen am effizientesten gehandhabt wird </li><li>  Hier k√∂nnen Sie den Zweck von einem oder zwei reservierten Registern verdrehen, den TB-Aufruf √ºber eine Funktion aktivieren und optional einige kleine <code>inline</code> Funktionen wie <code>flush_icache_range</code> (dies ist jedoch nicht unser Fall). </li></ul><br><p>  Die <code>tcg-target.inc.c</code> ist nat√ºrlich normalerweise viel gr√∂√üer und enth√§lt mehrere erforderliche Funktionen: </p><br><ul><li>  Initialisierung, die unter anderem Einschr√§nkungen angibt, mit welcher Anweisung welche Operanden arbeiten k√∂nnen.  Unversch√§mt von mir aus einem anderen Backend kopiert </li><li>  Funktion, die eine Anweisung des internen Bytecodes akzeptiert </li><li>  Hier k√∂nnen Sie <code>tcg/tcg.c</code> , und auch hier k√∂nnen Sie statische Funktionen aus <code>tcg/tcg.c</code> </li></ul><br><p>  F√ºr mich selbst habe ich die folgende Strategie gew√§hlt: In den ersten W√∂rtern des n√§chsten √úbersetzungsblocks habe ich vier Zeiger aufgeschrieben: die <code>0xFFFFFFFF</code> (ein bestimmter Wert in der N√§he von <code>0xFFFFFFFF</code> , der den aktuellen Status von TB bestimmt), den Kontext, das generierte Modul und die magische Zahl f√ºr das Debuggen.  Zuerst wurde das Label auf <code>0xFFFFFFFF - n</code> , wobei <code>n</code> eine kleine positive Zahl ist, und jedes Mal durch den Interpreter um 1 erh√∂ht. Als es <code>0xFFFFFFFE</code> erreichte, wurde das Modul <code>0xFFFFFFFE</code> und in der Funktionstabelle gespeichert, die in einen kleinen ‚ÄûLauncher‚Äú importiert wurde Die Ausf√ºhrung verlie√ü <code>tcg_qemu_tb_exec</code> und das Modul wurde aus dem QEMU-Speicher gel√∂scht. </p><br><p>  Um die Klassiker zu paraphrasieren: "Crutch, wie viel Proger hat sich in diesem Sound f√ºr das Herz verflochten ...".  Die Erinnerung leckte jedoch irgendwo.  Und es war eine von QEMU verwaltete Erinnerung!  Ich hatte einen Code, der beim Aufschreiben der n√§chsten Anweisung (also eines Zeigers) den l√∂schte, zu dem sich der Link an dieser Stelle zuvor befand, aber das half nicht.  Im einfachsten Fall weist QEMU beim Start Speicher zu und schreibt dort den generierten Code.  Wenn der Puffer endet, wird der Code verworfen und der n√§chste beginnt an seiner Stelle geschrieben zu werden. </p><br><p>  Nachdem ich den Code studiert hatte, stellte ich fest, dass die Kr√ºcke mit der magischen Zahl es uns erlaubte, nicht auf die Zerst√∂rung des Haufens zu fallen und beim ersten Durchgang etwas Falsches auf dem nicht initialisierten Puffer freizugeben.  Aber wer √ºberschreibt den Puffer, der meine Funktion sp√§ter umgeht?  Wie die Emscripten-Entwickler geraten hatten, habe ich nach einem Problem den resultierenden Code zur√ºck in die native Anwendung portiert und Mozilla Record-Replay darauf gesetzt ... Im Allgemeinen wurde mir eine einfache Sache klar: Jedem Block wird ein <code>struct TranslationBlock</code> mit seiner Beschreibung zugewiesen.  Ratet mal, wo ... Das stimmt, direkt vor dem Block, direkt im Puffer.  Nachdem ich dies erkannt hatte, beschloss ich, es mit Kr√ºcken (zumindest einigen) zu verkn√ºpfen, warf einfach die magische Zahl heraus und √ºbertrug die verbleibenden W√∂rter in die <code>struct TranslationBlock</code> wurde eine einfach verkn√ºpfte Liste erstellt, die Sie beim Zur√ºcksetzen des √úbersetzungscaches schnell durchlaufen und Speicher freigeben k√∂nnen. </p><br><p>  Einige Kr√ºcken blieben erhalten: Zum Beispiel markierte Zeiger im <code>BinaryenExpressionRef</code> - einige von ihnen sind einfach <code>BinaryenExpressionRef</code> , <code>BinaryenExpressionRef</code> sie betrachten Ausdr√ºcke, die linear in die generierte Basiseinheit eingef√ºgt werden m√ºssen, Teil - die √úbergangsbedingung zwischen den WBs, Teil - wohin.  Nun, es gibt bereits vorbereitete Bl√∂cke f√ºr Relooper, die entsprechend den Bedingungen angeschlossen werden m√ºssen.  Um zwischen ihnen zu unterscheiden, wird die Annahme verwendet, dass sie alle mindestens vier Bytes ausgerichtet sind, sodass Sie die unteren beiden Bits des Etiketts sicher verwenden k√∂nnen. Sie m√ºssen nur daran denken, es bei Bedarf zu entfernen.  √úbrigens werden solche Bezeichnungen bereits in QEMU verwendet, um den Grund f√ºr das Verlassen des TCG-Zyklus anzugeben. </p><br><h2 id="ispolzovanie-binaryen">  Verwenden von Binaryen </h2><br><p>  Module in WebAssembly enthalten Funktionen, von denen jede einen K√∂rper enth√§lt, der einen Ausdruck darstellt.  Ausdr√ºcke sind un√§re und bin√§re Operationen, Bl√∂cke, die aus Listen anderer Ausdr√ºcke, Kontrollfluss usw. bestehen.  Wie ich bereits sagte, ist der Kontrollfluss hier genau als √ºbergeordnete Verzweigungen, Schleifen, Funktionsaufrufe usw. organisiert.  Argumente an Funktionen werden nicht auf dem Stapel √ºbergeben, sondern explizit wie in JS.  Es gibt globale Variablen, aber ich habe sie nicht verwendet, daher werde ich nicht dar√ºber sprechen. </p><br><p>  Funktionen haben auch lokale Variablen, die von Grund auf neu nummeriert sind, vom Typ: int32 / int64 / float / double.  Die ersten n lokalen Variablen sind die Argumente, die an die Funktion √ºbergeben werden.  Bitte beachten Sie, dass hier zwar nicht alles in Bezug auf den Kontrollfluss ganz niedrig ist, aber ganzzahlige Zahlen immer noch nicht das Vorzeichen / vorzeichenlose Vorzeichen tragen: Wie sich die Zahl verh√§lt, h√§ngt vom Operationscode ab. </p><br><p>  Im Allgemeinen bietet Binaryen eine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">einfache C-API</a> : Sie erstellen ein Modul, <strong>in dem Sie</strong> Ausdr√ºcke erstellen - un√§r, bin√§r, Bl√∂cke aus anderen Ausdr√ºcken, Kontrollfluss usw.  Anschlie√üend erstellen Sie eine Funktion, deren K√∂rper Sie einen Ausdruck angeben m√ºssen.  Wenn Sie wie ich ein √úbergangsdiagramm auf niedriger Ebene haben, hilft Ihnen die Relooper-Komponente.  Soweit ich wei√ü, ist es m√∂glich, den Ausf√ºhrungsfluss im Block auf hoher Ebene zu steuern, solange er nicht √ºber die Grenzen des Blocks hinausgeht. Das hei√üt, es ist m√∂glich, einen internen Zweig f√ºr schnelle und langsame Pfade innerhalb des integrierten TLB-Cache-Verarbeitungscodes zu erstellen, aber es gibt keine Interferenzen .  Wenn Sie relooper freigeben, werden seine Bl√∂cke freigegeben, wenn Sie ein Modul freigeben, verschwinden Ausdr√ºcke, Funktionen usw., die in seiner <em>Arena</em> zugewiesen sind. </p><br><p>  Wenn Sie den Code jedoch unterwegs interpretieren m√∂chten, ohne die Interpreterinstanz unn√∂tig zu erstellen und zu l√∂schen, ist es m√∂glicherweise sinnvoll, diese Logik in eine C ++ - Datei zu √ºbertragen und von dort aus die gesamte C ++ - API-Bibliothek direkt zu steuern und dabei die fertigen Wrapper zu umgehen. </p><br><p>  Um den Code zu generieren, ben√∂tigen Sie also </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//    (  ) BinaryenSetAPITracing(0); BinaryenSetOptimizeLevel(3); BinaryenSetShrinkLevel(2); //   BinaryenModuleRef MODULE = BinaryenModuleCreate(); //    ( ,   ) helper_type BinaryenAddFunctionType(MODULE, "helper-func", BinaryenTypeInt32(), int32_helper_args, ARRAY_SIZE(int32_helper_args)); // (int23_helper_args ^W ) //  -  // ...     -  :) //    BinaryenAddFunction(MODULE, "tb_fun", tb_func_type, func_locals, FUNC_LOCALS_COUNT, expr); BinaryenAddFunctionExport(MODULE, "tb_fun", "tb_fun"); ... BinaryenSetMemory(MODULE, (1 &lt;&lt; 15) - 1, -1, NULL, NULL, NULL, NULL, NULL, 0, 0); BinaryenAddMemoryImport(MODULE, NULL, "env", "memory", 0); BinaryenAddTableImport(MODULE, NULL, "env", "tb_funcs"); //       assert (BinaryenModuleValidate(MODULE)); BinaryenModuleOptimize(MODULE);</span></span></code> </pre> <br><p> ‚Ä¶    ‚Äî ,     ,   ‚Äî   . </p><br><p>    --,  : </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf[<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">20</span></span>]; BinaryenModuleOptimize(MODULE); BinaryenSetMemory(MODULE, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> sz = BinaryenModuleWrite(MODULE, buf, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(buf)); BinaryenModuleDispose(MODULE); EM_ASM({ var <span class="hljs-keyword"><span class="hljs-keyword">module</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebAssembly.Module(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uint8Array(wasmMemory.buffer, $<span class="hljs-number"><span class="hljs-number">0</span></span>, $<span class="hljs-number"><span class="hljs-number">1</span></span>)); var fptr = $<span class="hljs-number"><span class="hljs-number">2</span></span>; var instance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebAssembly.Instance(<span class="hljs-keyword"><span class="hljs-keyword">module</span></span>, { <span class="hljs-string"><span class="hljs-string">'env'</span></span>: { <span class="hljs-string"><span class="hljs-string">'memory'</span></span>: wasmMemory, <span class="hljs-comment"><span class="hljs-comment">// ... } ); //       instance! }, buf, sz);</span></span></code> </pre> <br><p>  -     QEMU  JS        ,    (     ),     .    ,         translation block,   ,           <code>struct TranslationBlock</code> . </p><br><p> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a> <em>(    )</em>     Firefox.  Chrome  <em>-  </em>  ,  -       WebAssembly,          ... </p><br><p>     . ,    ,   - .  ,    <em> </em>    . ,      WebAssembly  ,       JS,      ,     ,     . </p><br><p> <strong><strong> :</strong></strong>     32- ,         Binaryen, -     -   2  32-  .   ,     Binaryen       .   ? </p><br><div class="spoiler"> <b class="spoiler_title">-</b> <div class="spoiler_text"><p>      ,     ¬´ ,   32- Linux?¬ª        .    ,   : 1  2 Gb. </p></div></div><br><div class="spoiler"> <b class="spoiler_title">- (  )</b> <div class="spoiler_text"><p>       .    ,    ‚Äî   <strong></strong>   .  ¬´ :    ,     ...¬ª. </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// 2gbubble.c // Usage: LD_PRELOAD=2gbubble.so &lt;program&gt; #include &lt;sys/mman.h&gt; #include &lt;assert.h&gt; void __attribute__((constructor)) constr(void) { assert(MAP_FAILED != mmap(1u &gt;&gt; 31, (1u &gt;&gt; 31) - (1u &gt;&gt; 20), PROT_NONE, MAP_ANONYMOUS | MAP_PRIVATE, -1, 0)); }</span></span></code> </pre> <br><p> ‚Ä¶  Valgrind-, ,  , ,  , Valgrind       :) </p><br><p> <em>, -   ,     ...</em> </p></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de451306/">https://habr.com/ru/post/de451306/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de451294/index.html">Da ich dem Auto Funktionen √ºber CAN hinzugef√ºgt habe, konnte ich nicht programmieren</a></li>
<li><a href="../de451296/index.html">Angek√ºndigt von ML.NET 1.0</a></li>
<li><a href="../de451298/index.html">So stellen Sie eine Spielekonsole mit einem Geh√§use her, indem Sie eine Leiterplatte bestellen</a></li>
<li><a href="../de451302/index.html">Top-IT-Outsourcing-Unternehmen</a></li>
<li><a href="../de451304/index.html">Yandex-Tipp: So maximieren Sie den Gewinn eines bezahlten Abonnements</a></li>
<li><a href="../de451310/index.html">Vermissen Sie den PDA?</a></li>
<li><a href="../de451314/index.html">Herstellung von Leiterplatten LUT'om von A bis Z.</a></li>
<li><a href="../de451316/index.html">√úber eine Fakult√§t f√ºr Physik</a></li>
<li><a href="../de451318/index.html">Dart 2.3 angek√ºndigt: Optimiert f√ºr die Entwicklung der Benutzeroberfl√§che</a></li>
<li><a href="../de451320/index.html">Warum offene Firmware f√ºr die Sicherheit wichtig ist</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>