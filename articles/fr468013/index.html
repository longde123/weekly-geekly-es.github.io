<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔎 🌎 📞 Un moyen simple et sûr d'automatiser les déploiements canaris avec Helm 😺 📯 🏂🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le déploiement Canary est un moyen très efficace de tester un nouveau code sur un sous-ensemble d'utilisateurs. Il réduit considérablement la charge d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Un moyen simple et sûr d'automatiser les déploiements canaris avec Helm</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/itsumma/blog/468013/"><img src="https://habrastorage.org/webt/im/p5/dz/imp5dzjfim9tzj6fs7iafpetfl0.jpeg"><br><br>  Le déploiement Canary est un moyen très efficace de tester un nouveau code sur un sous-ensemble d'utilisateurs.  Il réduit considérablement la charge de trafic, ce qui peut provoquer des problèmes pendant le processus de déploiement, car il se produit uniquement au sein d'un certain sous-groupe.  Cet article est consacré à l'organisation d'un déploiement similaire à l'aide de Kubernetes et de l'automatisation du déploiement.  <i>On suppose que vous savez quelque chose sur les ressources de Helm et Kubernetes</i> . <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/uw/wf/lc/uwwflcg7sk94dwvjgec0ksjr8ca.png"><br><br>  Le déploiement simple de Kubernetes canary comprend deux ressources clés: le service lui-même et l'outil de déploiement.  Le déploiement canary fonctionne via un service, qui interagit avec deux ressources différentes qui servent le trafic de mise à jour.  Une de ces ressources fonctionnera avec la version "canari" et la seconde avec la version stable.  Dans cette situation, nous pouvons ajuster le nombre de versions canaris afin de réduire la quantité de trafic nécessaire à la maintenance.  Si, par exemple, vous préférez utiliser Yaml, il ressemblera à ceci dans Kubernetes: <br><br><pre><code class="xml hljs">kind: Deployment metadata: name: app-canary labels: app: app spec: replicas: 1 ... image: myapp:canary --- kind: Deployment metadata: name: app labels: app: app spec: replicas: 5 ... image: myapp:stable --- kind: Service selector: app: app # Selector will route traffic to both deployments.</code> </pre> <br>  Il est encore plus facile d'imaginer une telle option sur kubectl, et la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation de Kubernetes propose</a> même un didacticiel complet sur ce scénario.  Mais la principale question de ce post est de savoir comment nous allons automatiser ce processus en utilisant Helm. <br><br><h3>  Automatisation d'un déploiement canari </h3><br>  Tout d'abord, nous avons besoin de la carte Helm Chart, qui a déjà inclus les ressources dont nous avons discuté ci-dessus.  Cela devrait ressembler à ceci: <br><br><pre> <code class="xml hljs">~/charts/app ├── Chart.yaml ├── README.md ├── templates │ ├── NOTES.txt │ ├── _helpers.tpl │ ├── deployment.yaml │ └── service.yaml └── values.yaml</code> </pre> <br>  La base du concept Helm est la gestion des versions multi-versions.  La version stable est notre principale branche stable du code du projet.  Mais avec Helm, nous pouvons déployer une version canari avec notre code expérimental.  L'essentiel est de garder l'échange de trafic entre la version stable et la version canari.  Nous gérerons tout cela à l'aide d'un sélecteur spécial: <br><br><pre> <code class="xml hljs">selector: app.kubernetes.io/name: myapp</code> </pre> <br>  Nos ressources de déploiement «canaries» et stables indiqueront cette étiquette sur les modules.  Si tout est correctement configuré, lors du déploiement de la version canari de notre carte Helm, nous verrons que le trafic sera envoyé vers des modules fraîchement déployés.  Une version stable de cette commande ressemblera à ceci: <br><br><pre> <code class="xml hljs">helm upgrade --install myapp \ --namespace default \ --set app.name=myapp \ # Goes into app.kubernetes.io/name --set app.version=v1 \ # Goes into app.kubernetes.io/version --set image.tag=stable \ --set replicaCount=5</code> </pre> <br>  Voyons maintenant notre version canari.  Pour déployer la version canari, nous devons nous rappeler deux choses.  Le nom de la version doit être différent afin que nous ne reportions pas la mise à jour sur la version stable actuelle.  La version et la balise doivent également être différentes afin que nous puissions déployer un code différent et identifier les différences par les étiquettes de ressources. <br><br><pre> <code class="xml hljs">helm upgrade --install myapp-canary \ --namespace default \ --set app.name=myapp \ # Goes into app.kubernetes.io/name --set app.version=v2 \ # Goes into app.kubernetes.io/version --set image.tag=canary \ --set replicaCount=1</code> </pre> <br>  C'est tout, en fait!  Si vous envoyez une requête ping au service, vous pouvez voir que la mise à jour canari achemine le trafic uniquement une partie du temps. <br><br><hr><br>  Si vous recherchez des outils d'automatisation de déploiement qui incluent la logique décrite, consultez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Deliverybot</a> et les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">outils d'automatisation Helm sur GitHub</a> .  Les graphiques Helm utilisés pour implémenter la méthode décrite ci-dessus sont sur Github, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> .  En général, il s'agissait d'un aperçu théorique de la façon de mettre en œuvre le déploiement de versions canaris dans la pratique, avec des concepts et des exemples spécifiques. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr468013/">https://habr.com/ru/post/fr468013/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr468003/index.html">5 GHz Iron: une histoire sur la façon de construire un VDS ultra-rapide</a></li>
<li><a href="../fr468005/index.html">Dites un mot sur le soutien glorieux (24 septembre, Moscou)</a></li>
<li><a href="../fr468007/index.html">Mais est-ce que je ne fais plus de conneries? Comment et pourquoi mettre en œuvre des mesures de qualité</a></li>
<li><a href="../fr468009/index.html">Vulnérabilités des systèmes ERP des objets KII</a></li>
<li><a href="../fr468011/index.html">L'histoire d'un robot hypothétique</a></li>
<li><a href="../fr468015/index.html">Ce que l'on sait actuellement sur ITIL 4 et qui utilise déjà la nouvelle bibliothèque</a></li>
<li><a href="../fr468017/index.html">La monade peut-être via async / attendre en C # (sans tâche ov!)</a></li>
<li><a href="../fr468019/index.html">Développement de sites Web sur WebAssembly avec NetCore 3 et Blazor</a></li>
<li><a href="../fr468021/index.html">PHP, combien d'abstraction pour les gens?</a></li>
<li><a href="../fr468023/index.html">L'intelligence artificielle dans le jeu de combat Shadow Fight 3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>