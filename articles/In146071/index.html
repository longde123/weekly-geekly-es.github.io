<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯЩЕЁЯП╝ ЁЯЪ▒ ЁЯФЗ рд╕рдмрд╕реЗ рд╕рд░рд▓ WDM рдбреНрд░рд╛рдЗрд╡рд░ ЁЯев ЁЯСйЁЯП╛тАНЁЯдЭтАНЁЯСйЁЯП╜ ЁЯПб</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рдпрд╣ рдЖрд▓реЗрдЦ рдПрдХ рд╕рд╛рдзрд╛рд░рдг рдбреНрд░рд╛рдЗрд╡рд░ рд▓рд┐рдЦрдиреЗ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрд╛ рд╡рд░реНрдгрди рдХрд░рддрд╛ рд╣реИ рдЬреЛ рджрдмрд╛рдП рдЧрдП рдХреБрдВрдЬреА рдХреЗ рд╕реНрдХреИрди рдХреЛрдб рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд░рддрд╛ рд╣реИред 
 рдпрд╣ рд▓реЗрдЦ рдбреНрд░рд╛рдЗрд╡рд░реЛрдВ рдХреЛ рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдХ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>рд╕рдмрд╕реЗ рд╕рд░рд▓ WDM рдбреНрд░рд╛рдЗрд╡рд░</h1><div class="post__text post__text-html js-mediator-article" id="post-content-body" data-io-article-url="https://habr.com/ru/post/146071/">  рдпрд╣ рдЖрд▓реЗрдЦ рдПрдХ рд╕рд╛рдзрд╛рд░рдг рдбреНрд░рд╛рдЗрд╡рд░ рд▓рд┐рдЦрдиреЗ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрд╛ рд╡рд░реНрдгрди рдХрд░рддрд╛ рд╣реИ рдЬреЛ рджрдмрд╛рдП рдЧрдП рдХреБрдВрдЬреА рдХреЗ рд╕реНрдХреИрди рдХреЛрдб рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд░рддрд╛ рд╣реИред <br>  рдпрд╣ рд▓реЗрдЦ рдбреНрд░рд╛рдЗрд╡рд░реЛрдВ рдХреЛ рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдХрд╛рд░реНрдпрд╕реНрдерд▓ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрд╛ рднреА рд╡рд░реНрдгрди рдХрд░рддрд╛ рд╣реИред <br>  рдпрджрд┐ рдЖрдк рд░реБрдЪрд┐ рд░рдЦрддреЗ рд╣реИрдВ, рддреЛ рдХреГрдкрдпрд╛ рдмрд┐рд▓реНрд▓реА рдХреЗ рдиреАрдЪреЗред <br><a name="habracut"></a><br><br><h4>  рд╕реНрдЯреИрдВрдб рдХреА рддреИрдпрд╛рд░реА </h4><br><h5>  рдПрдХ рд╕рд╛рдзрд╛рд░рдг рдбреНрд░рд╛рдЗрд╡рд░ рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдирд╛ </h5><br>  рдЖрд╡рд╢реНрдпрдХ рд╕реЙрдлреНрдЯрд╡реЗрдпрд░: <br><ol><li>  рд╡рд┐рдВрдбреЛрдЬ рдбреАрдбреАрдХреЗ (рдЪрд╛рд▓рдХ рд╡рд┐рдХрд╛рд╕ рдХрд┐рдЯ); </li><li>  VMware рдХрд╛рд░реНрдп рдХреЗрдВрджреНрд░ рдпрд╛ рд╡рд░реНрдЪреБрдЕрд▓ рдмреЙрдХреНрд╕; </li><li>  рд╡рд┐рдВрдбреЛрдЬ рдПрдХреНрд╕рдкреА </li><li>  рд╡рд┐рдЬреБрдЕрд▓ рд╕реНрдЯреВрдбрд┐рдпреЛ 2005; </li><li>  DDKWizard; </li><li>  KmdManager </li><li>  DebugView; </li></ol><br>  рдореИрдВ рджреЛ рдЖрднрд╛рд╕реА рдорд╢реАрдиреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реВрдВ, рдПрдХ рдкрд░ рдбреНрд░рд╛рдЗрд╡рд░ рд▓рд┐рдЦрддрд╛ рд╣реВрдВ, рдФрд░ рджреВрд╕рд░реЗ рдкрд░ рдЪрд▓рддрд╛ рд╣реВрдВред  рдпрджрд┐ рдЖрдк рднреА рдРрд╕рд╛ рдХрд░рдиреЗ рдХрд╛ рдирд┐рд░реНрдгрдп рд▓реЗрддреЗ рд╣реИрдВ, рддреЛ рдЬрд┐рд╕ рдорд╢реАрди рдкрд░ рдЖрдк рдбреНрд░рд╛рдЗрд╡рд░ рдЪрд▓рд╛рдПрдВрдЧреЗ, рдЙрд╕рдХреЗ рд▓рд┐рдП 4 рдЬреАрдмреА рд╣рд╛рд░реНрдб рдбрд┐рд╕реНрдХ рдФрд░ 256 рдПрдордмреА рд░реИрдо рдкрд░реНрдпрд╛рдкреНрдд рд╣реИрдВред <br><br><h5>  рдХрд╛рд░реНрдпрд╕реНрдерд▓ рд╕реЗрдЯрдЕрдк </h5><br><h6>  DDK рд╕реНрдерд╛рдкрдирд╛ </h6><br>  рд╕реНрдерд╛рдкрдирд╛ рдЕрддреНрдпрдВрдд рд╕рд░рд▓ рд╣реИред  рдХреЗрд╡рд▓ рдПрдХ рдЪреАрдЬ рдЬрд┐рд╕ рдкрд░ рдЖрдкрдХреЛ рдзреНрдпрд╛рди рджреЗрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рд╡рд╣ рд╡рд╣ рд╕рдВрд╡рд╛рдж рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдЖрдкрдХреЛ рдЙрди рдШрдЯрдХреЛрдВ рдХрд╛ рдЪрдпрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬрд┐рдиреНрд╣реЗрдВ рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред  рдореИрдВ рджреГрдврд╝рддрд╛ рд╕реЗ рдЕрдиреБрд╢рдВрд╕рд╛ рдХрд░рддрд╛ рд╣реВрдВ рдХрд┐ рд╕рднреА рджрд╕реНрддрд╛рд╡реЗрдЬ рдФрд░ рдЙрджрд╛рд╣рд░рдг рдиреЛрдЯ рдХрд┐рдП рдЬрд╛рдПрдВред <br><br><h6>  Microsoft┬о Visual Studio 2005 рдХреЛ рд╕реНрдерд╛рдкрд┐рдд рдФрд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВ </h6><br>  Microsoft┬о Visual Studio 2005 рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдирд╛ DDK рдХреЛ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рд╕реЗ рдЕрдзрд┐рдХ рдХрдард┐рди рдирд╣реАрдВ рд╣реИред  рдпрджрд┐ рдЖрдк рдЗрд╕реЗ рдХреЗрд╡рд▓ рдбреНрд░рд╛рдЗрд╡рд░реЛрдВ рдХреЛ рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВрдЧреЗ, рддреЛ рдЬрдм рдЗрдВрд╕реНрдЯреЙрд▓рд░ рдкреВрдЫрддрд╛ рд╣реИ рдХрд┐ рдХреМрди рд╕реЗ рдШрдЯрдХреЛрдВ рдХреЛ рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП, рддреЛ рдХреЗрд╡рд▓ рджреГрд╢реНрдп C ++ рдХрд╛ рдЪрдпрди рдХрд░реЗрдВред <br>  рдЕрдЧрд▓рд╛, рдЖрдк рд╡рд┐рдЬреБрдЕрд▓ рдЕрд╕рд┐рд╕реНрдЯ рдПрдХреНрд╕ рдХреЛ рд╕реНрдерд╛рдкрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЗрд╕ рдкреНрд░реЛрдЧреНрд░рд╛рдо (рдРрдб-рдСрди) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ, рдЖрдк рдЖрд╕рд╛рдиреА рд╕реЗ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рд▓реЗрдЦрди рдбреНрд░рд╛рдЗрд╡рд░реЛрдВ рдХреЗ рд▓рд┐рдП рдпреБрдХреНрддрд┐рдпреЛрдВ рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред <br>  рд╡рд┐рдЬреБрдЕрд▓ рдЕрд╕рд┐рд╕реНрдЯреЗрдВрдЯ рдПрдХреНрд╕ рдХреЛ рд╡рд┐рдЬреБрдЕрд▓ рд╕реНрдЯреВрдбрд┐рдпреЛ 2005 рдореЗрдВ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рдирдпрд╛ VAssistX рдореЗрдиреВ рджрд┐рдЦрд╛рдИ рджреЗрддрд╛ рд╣реИред  рдЗрд╕ рдореЗрдиреВ рдореЗрдВ рдЖрдЧреЗ: <code>Visual Assist X Options -&gt; Projects -&gt; C/C++ Directories -&gt; Platform: Custom, Show Directories for: Stable include files</code> ред  <code>Ins</code> рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ рдпрд╛ рдЖрдЗрдХрди рдореЗрдВ рдПрдХ рдирдИ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдЬреЛрдбрд╝реЗрдВ рдФрд░ рджрд┐рдЦрд╛рдИ рджреЗрдиреЗ рд╡рд╛рд▓реА рдкрдВрдХреНрддрд┐ рдореЗрдВ, рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ Windows XP рдЯрд╛рдЗрдк <code>%WXPBASE%\inc\ddk\wxp</code> ред <br><br><h6>  DDKWizard рд╕реНрдерд╛рдкрд┐рдд рдХрд░реЗрдВ рдФрд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВ </h6><br>  рдбреНрд░рд╛рдЗрд╡рд░реЛрдВ рдХреЛ рд╕рдВрдХрд▓рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП Visual Studio рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ DDKWizard рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рдЗрд╕реЗ <a href="http://ddkwizard.assarbad.net/">ddkwizard.assarbad.net</a> рд╕реЗ рдбрд╛рдЙрдирд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред  рдЗрд╕ рд╕рд╛рдЗрдЯ рд╕реЗ ddkbuild.cmd рд╕реНрдХреНрд░рд┐рдкреНрдЯ рднреА рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВред <br>  рд╡рд┐рдЬрд╝рд╛рд░реНрдб рд╕реНрдерд╛рдкрд┐рдд рд╣реЛрдиреЗ рдХреЗ рдмрд╛рдж, рдЖрдкрдХреЛ рдирд┐рдореНрди рдЪрд░рдг рдХрд░рдиреЗ рдЪрд╛рд╣рд┐рдП: <br><ul><li>  рдирд┐рдореНрди рдирд╛рдореЛрдВ рдХреЗ рд╕рд╛рде рд╕рд┐рд╕реНрдЯрдо (рдЕрдиреБрд╢рдВрд╕рд┐рдд) рдпрд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЪрд░ рдмрдирд╛рдПрдВ рдФрд░ рдПрдХ рдорд╛рди рдЬреЛ DDK рдХреЗ рд▓рд┐рдП рдкрде рд╕реЗ рдореЗрд▓ рдЦрд╛рддрд╛ рд╣реИ <br><table><tbody><tr><th>  рдбреАрдбреАрдХреЗ рд╕рдВрд╕реНрдХрд░рдг <br></th><th>  рдЪрд░ рдирд╛рдо <br></th><th>  рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдкрде <br></th></tr><tr><td>  рд╡рд┐рдВрдбреЛрдЬ рдПрдХреНрд╕рдкреА рдбреАрдбреАрдХреЗ <br></td><td>  WXPBASE <br></td><td>  C: \ WINDDK \ 2600 <br></td></tr><tr><td>  рд╡рд┐рдВрдбреЛрдЬ 2003 рд╕рд░реНрд╡рд░ рдбреАрдбреАрдХреЗ <br></td><td>  WNETBASE <br></td><td>  C: \ WINDDK \ 3790.1830 <br></td></tr><tr><td>  рд╡рд┐рдВрдбреЛрдЬ рд╡рд┐рд╕реНрдЯрд╛ / рд╡рд┐рдВрдбреЛрдЬ 2008 рд╕рд░реНрд╡рд░ рдбрдмреНрд▓реНрдпреВрдбреАрдХреЗ <br></td><td>  WLHBASE <br></td><td></td></tr><tr><td>  рд╡рд┐рдВрдбреЛрдЬ 7 / рд╡рд┐рдВрдбреЛрдЬ 2008 рд╕рд░реНрд╡рд░ рдЖрд░ 2 рдбрдмреНрд▓реНрдпреВрдбреАрдХреЗ <br></td><td>  W7BASE <br></td><td></td></tr></tbody></table><br>  рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдпрджрд┐ рдореИрдВ Windows XP DDK рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реВрдВ, рддреЛ рдореБрдЭреЗ рдПрдХ WXPBASE рд╡реИрд░рд┐рдПрдмрд▓ рдмрдирд╛рдирд╛ рд╣реЛрдЧрд╛, рдЬреЛ DDK рдХреЗ рдкрде рд╕реЗ рдореЗрд▓ рдЦрд╛рддрд╛ рд╣реЛред  рдЪреВрдВрдХрд┐ рдореИрдВрдиреЗ рд╕реНрдерд╛рдкрдирд╛ рдкрде рдирд╣реАрдВ рдмрджрд▓рд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдореЗрд░реЗ рдкрд╛рд╕ рдореВрд▓реНрдп C: \ WINDDK \ 2600 рд╣реЛрдЧрд╛ред <br></li><li>  рдбрд╛рдЙрдирд▓реЛрдб рдХрд┐рдП рдЧрдП ddkbuild.cmd рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреА рдкреНрд░рддрд┐рд▓рд┐рдкрд┐ рдмрдирд╛рдПрдБ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, DDK рдХреЗ рд╕рд╛рде рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВред  рдореЗрд░реЗ рдкрд╛рд╕ рдпрд╣ C: \ WINDDK \ рд╣реИред <br></li><li>  рдкрде рд╕рд┐рд╕реНрдЯрдо рдЪрд░ рдХреЗ рдЕрдВрдд рдореЗрдВ ddkbuild.cmd рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЗрдВ рдкрде рдЬреЛрдбрд╝реЗрдВред <br></li></ul><br>  рд╕рдм рдХреБрдЫ, рдЬрд┐рд╕ рдорд╢реАрди рдкрд░ рд╣рдо рдбреНрд░рд╛рдЗрд╡рд░реЛрдВ рдХреЛ рдЪрд▓рд╛рдПрдВрдЧреЗ, рд╡рд╣ рддреИрдпрд╛рд░ рд╣реИред <br><br><h5>  рдбреНрд░рд╛рдЗрд╡рд░реЛрдВ рдХреЛ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдирд╛ </h5><br>  рдЕрдм рдЙрд╕ рдорд╢реАрди рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВ рдЬрд┐рд╕ рдкрд░ рд╣рдо рд▓рд┐рдЦрд┐рдд рдбреНрд░рд╛рдЗрд╡рд░ рдЪрд▓рд╛рдПрдВрдЧреЗред <br>  рд╣рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрд╛рд░реНрдпрдХреНрд░рдореЛрдВ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреА: <br><ul><li>  рдбреАрдмрдЧ рд╡реНрдпреВ ( <a href="">рд▓рд┐рдВрдХ</a> ) рдПрдХ рдЙрдкрдпреЛрдЧрд┐рддрд╛ рд╣реИ рдЬреЛ рдЖрдкрдХреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдореЛрдб рдФрд░ рдХрд░реНрдиреЗрд▓ рдореЛрдб рджреЛрдиреЛрдВ рдХреЗ рдбрд┐рдмрдЧ рдЖрдЙрдЯрдкреБрдЯ рдХреЛ рджреЗрдЦрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИред <br></li><li>  KmdManager ( <a href="">рд▓рд┐рдВрдХ</a> ) - рдЧрддрд┐рд╢реАрд▓ рд░реВрдк рд╕реЗ рд▓реЛрдб / рдЕрдирд▓реЛрдб рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдбреНрд░рд╛рдЗрд╡рд░реЛрдВ рдХреЗ рд▓рд┐рдП рдПрдХ рдЙрдкрдпреЛрдЧрд┐рддрд╛ <br></li></ul><br>  рд╕рдм рдХреБрдЫ, рдХрд╛рд░ рдбреНрд░рд╛рдЗрд╡рд░реЛрдВ рдХреЛ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рддреИрдпрд╛рд░ рд╣реИред <br><br><h4>  рд╕рдорд╕реНрдпрд╛ рдХрд╛ рдмрдпрд╛рди </h4><br>  рдЯрд╛рд╕реНрдХ: рдПрдХ рдбреНрд░рд╛рдЗрд╡рд░ рдХреЛ рд▓рд┐рдЦреЗрдВ рдЬреЛ рдкреНрд░реЗрд╕ рдХрд┐рдП рдЧрдП рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЗ рд╕реНрдХреИрди рдХреЛрдб рдФрд░ рдбрд┐рдмрдЧ рдХреЗ рдЙрдирдХреЗ рд╕рдВрдпреЛрдЬрди рдХреЛ рдЖрдЙрдЯрдкреБрдЯ рдХрд░реЗрдЧрд╛ред <br><br><h5>  рд╕рд┐рджреНрдзрд╛рдВрдд рдХреА рдмрд┐рдЯ </h5><br>  рдПрдХ рдбреНрд░рд╛рдЗрд╡рд░ рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдПрдХ рд╕реЗрдЯ рд╣реИ рдЬрд┐рд╕реЗ рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рджреНрд╡рд╛рд░рд╛ рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬрдм рдбрд┐рд╡рд╛рдЗрд╕ рдпрд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдореЛрдб рд╕реЗ рдХреБрдЫ рдШрдЯрдирд╛рдПрдВ рд╣реЛрддреА рд╣реИрдВред <br>  рдбреНрд░рд╛рдЗрд╡рд░реЛрдВ рдХреЗ рдХрдИ рдкреНрд░рдХрд╛рд░ рд╣реИрдВ, рдЬрд┐рдирдореЗрдВ рд╕реЗ рдХреБрдЫ рдиреАрдЪреЗ рд╕реВрдЪреАрдмрджреНрдз рд╣реИрдВ: <br><ul><li>  рдХреНрд▓рд╛рд╕ рдбреНрд░рд╛рдЗрд╡рд░ </li><li>  minidriver; </li><li>  рдХрд╛рд░реНрдпрд╛рддреНрдордХ рдЪрд╛рд▓рдХ; </li><li>  рдЫрд╛рдирдиреЗ рд╡рд╛рд▓реЗ рдбреНрд░рд╛рдЗрд╡рд░ред </li></ul><br>  рдХреНрд▓рд╛рд╕ рдбреНрд░рд╛рдЗрд╡рд░ рд╡реЗ рдбреНрд░рд╛рдЗрд╡рд░ рд╣реЛрддреЗ рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ Microsoft рд▓рд┐рдЦрддрд╛ рд╣реИред  рдпреЗ (рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ!) рдЙрдкрдХрд░рдгреЛрдВ рдХреЗ рдПрдХ рдирд┐рд╢реНрдЪрд┐рдд рд╡рд░реНрдЧ рдХреЗ рд▓рд┐рдП рд╕рд╛рдорд╛рдиреНрдп рдбреНрд░рд╛рдЗрд╡рд░ рд╣реИрдВред <br>  рдорд┐рдиреАрдбреНрд░рд╛рдЗрд╡рд░ рдРрд╕реЗ рдбреНрд░рд╛рдЗрд╡рд░ рд╣реЛрддреЗ рд╣реИрдВ рдЬреЛ рдХрд┐рд╕реА рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреНрд▓рд╛рд╕ рдбреНрд░рд╛рдЗрд╡рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВред <br>  рдХрд╛рд░реНрдпрд╛рддреНрдордХ рдЪрд╛рд▓рдХ рд╡реЗ рдбреНрд░рд╛рдЗрд╡рд░ рд╣реЛрддреЗ рд╣реИрдВ рдЬреЛ рд╕реНрд╡рддрдВрддреНрд░ рд░реВрдк рд╕реЗ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рдбрд┐рд╡рд╛рдЗрд╕ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рд╕рдм рдХреБрдЫ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рддреЗ рд╣реИрдВред <br>  рдлрд╝рд┐рд▓реНрдЯрд░рд┐рдВрдЧ рдбреНрд░рд╛рдЗрд╡рд░ рд╡реЗ рдбреНрд░рд╛рдЗрд╡рд░ рд╣реЛрддреЗ рд╣реИрдВ рдЬрд┐рдирдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рд╕реА рдЕрдиреНрдп рдбреНрд░рд╛рдЗрд╡рд░ рдХреЗ рддрд░реНрдХ рдХреЛ рдореЙрдирд┐рдЯрд░ рдХрд░рдиреЗ рдпрд╛ рдмрджрд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреЛ рдЙрд╕ рдкрд░ рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рдбреЗрдЯрд╛ рдХреЛ рдмрджрд▓рдХрд░ рдХрд░рддрд╛ рд╣реИред <br><br>  рдЕрдкрдиреЗ рдбреНрд░рд╛рдЗрд╡рд░ рдореЗрдВ рд╕рднреА рд╕рдВрднрд╛рд╡рд┐рдд рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рдирд╛ рдЖрд╡рд╢реНрдпрдХ рдирд╣реАрдВ рд╣реИ, рд▓реЗрдХрд┐рди рдЗрд╕рдореЗрдВ <code>DriverEntry</code> рдФрд░ <code>AddDevice</code> рд╣реЛрдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИред <br><br>  <code>IRP</code> рд╡рд╣ рд╕рдВрд░рдЪрдирд╛ рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдЪрд╛рд▓рдХ рдбреЗрдЯрд╛ рдХрд╛ рдЖрджрд╛рди-рдкреНрд░рджрд╛рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░рддреЗ рд╣реИрдВред <br><br>  рддреЛ, рд╕реНрдХреИрди рдХреЛрдб рдХреЛ рдЖрдЙрдЯрдкреБрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП ( <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25BA%25D0%25B0%25D0%25BD-%25D0%25BA%25D0%25BE%25D0%25B4">рдпрд╣ рдХреНрдпрд╛ рд╣реИ?</a> ) рдбрд┐рдмрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдо рдПрдХ рдлрд╝рд┐рд▓реНрдЯрд░рд┐рдВрдЧ рдбреНрд░рд╛рдЗрд╡рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВрдЧреЗред <br>  рдлрд╝рд┐рд▓реНрдЯрд░рд┐рдВрдЧ рдбреНрд░рд╛рдЗрд╡рд░ рджреЛ рдкреНрд░рдХрд╛рд░ рдХреЗ рд╣реЛрддреЗ рд╣реИрдВ: <br><ul><li>  рд╢реАрд░реНрд╖ рдлрд╝рд┐рд▓реНрдЯрд░рд┐рдВрдЧ рдбреНрд░рд╛рдЗрд╡рд░; <br></li><li>  рдиреАрдЪреЗ рдлрд┐рд▓реНрдЯрд░ рдбреНрд░рд╛рдЗрд╡рд░реЛрдВред <br></li></ul><br>  рдЖрдкрдХреЗ рдкрд╛рд╕ рдбреНрд░рд╛рдЗрд╡рд░ рдХрд╛ рдкреНрд░рдХрд╛рд░ рдЗрд╕ рдмрд╛рдд рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдбреНрд░рд╛рдЗрд╡рд░ рдбрд┐рд╡рд╛рдЗрд╕ рдбреНрд░рд╛рдЗрд╡рд░ рд╕реНрдЯреИрдХ рдореЗрдВ рдХрд╣рд╛рдБ рд╕реНрдерд┐рдд рд╣реИред  рдпрджрд┐ рдЖрдкрдХрд╛ рдбреНрд░рд╛рдЗрд╡рд░ рдХрд╛рд░реНрдпрд╛рддреНрдордХ рдЪрд╛рд▓рдХ рд╕реЗ рдКрдкрд░ рд╣реИ, рддреЛ рдЗрд╕реЗ рдКрдкрд░реА рдлрд╝рд┐рд▓реНрдЯрд░рд┐рдВрдЧ рдбреНрд░рд╛рдЗрд╡рд░ рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ, рдпрджрд┐ рдХрдо рд╣реИ, рддреЛ, рдирд┐рдореНрди рдлрд╝рд┐рд▓реНрдЯрд░рд┐рдВрдЧ рдбреНрд░рд╛рдЗрд╡рд░ред <br><br><h6>  рдКрдкрд░реА рдФрд░ рдирд┐рдЪрд▓реЗ рдлрд╝рд┐рд▓реНрдЯрд░рд┐рдВрдЧ рдбреНрд░рд╛рдЗрд╡рд░реЛрдВ рдХреЗ рдмреАрдЪ рдЕрдВрддрд░ </h6><br>  рд╕рднреА рдЕрдиреБрд░реЛрдз рдКрдкрд░реА рдлрд╝рд┐рд▓реНрдЯрд░рд┐рдВрдЧ рдбреНрд░рд╛рдЗрд╡рд░реЛрдВ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЬрд╛рддреЗ рд╣реИрдВ, рдЬрд┐рд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдХрд┐ рд╡реЗ рдХрд╛рд░реНрдпрд╛рддреНрдордХ рдбреНрд░рд╛рдЗрд╡рд░ рдХреЛ рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рдЬрд╛рдирдХрд╛рд░реА рдХреЛ рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ / рдпрд╛ рдлрд╝рд┐рд▓реНрдЯрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдФрд░ рдлрд┐рд░, рд╕рдВрднрд╡рддрдГ, рдбрд┐рд╡рд╛рдЗрд╕ рдкрд░ред <br>  рд╢реАрд░реНрд╖ рдлрд╝рд┐рд▓реНрдЯрд░рд┐рдВрдЧ рдбреНрд░рд╛рдЗрд╡рд░реЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХрд╛ рдПрдХ рдЙрджрд╛рд╣рд░рдг: <br>  рдлрд╝рд┐рд▓реНрдЯрд░ рд╣реБрдХ рдбреНрд░рд╛рдЗрд╡рд░, рдЬреЛ рдЯреНрд░реИрдлрд╝рд┐рдХ рдХреЛ рдЯреНрд░реИрдХ рдХрд░рдиреЗ рдФрд░ рдлрд╝рд┐рд▓реНрдЯрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП IpFilterDirver рд╕рд┐рд╕реНрдЯрдо рдбреНрд░рд╛рдЗрд╡рд░ рдХреЗ рд▓рд┐рдП рдЕрдкрдирд╛ рд╣реБрдХ рдлрд╝рдВрдХреНрд╢рди рд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИред  рдРрд╕реЗ рдбреНрд░рд╛рдЗрд╡рд░реЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдлрд╛рдпрд░рд╡реЙрд▓ рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред <br><br>  рдХрдо рдЕрдиреБрд░реЛрдз рдХрдо рдлрд╝рд┐рд▓реНрдЯрд░рд┐рдВрдЧ рдбреНрд░рд╛рдЗрд╡рд░реЛрдВ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЬрд╛рддреЗ рд╣реИрдВ рдХреНрдпреЛрдВрдХрд┐ рдЕрдзрд┐рдХрд╛рдВрд╢ рдЕрдиреБрд░реЛрдз рдПрдХ рдХрд╛рд░реНрдпрд╛рддреНрдордХ рдЪрд╛рд▓рдХ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдФрд░ рдкреВрд░рд╛ рдХрд░рддреЗ рд╣реИрдВред <br><br><h6>  рд╕рдордиреНтАНрд╡рдп рд╕рдорд╕реНтАНрдпрд╛рдПрдБ </h6><br>  рдбреНрд░рд╛рдЗрд╡рд░ рдореЗрдВ рдЬреЛ рд╣рдо рд▓рд┐рдЦреЗрдВрдЧреЗ, рдХрдИ "рд╕рдорд╕реНрдпрд╛" рдЕрдиреБрднрд╛рдЧ рд╣реИрдВред  рд╣рдорд╛рд░реЗ рдбреНрд░рд╛рдЗрд╡рд░ рдХреЗ рд▓рд┐рдП рд╣рдорд╛рд░реА рд╡рд┐рдзрд╛рдирд╕рднрд╛ рдЖрд╡реЗрд╖рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдкрд░реНрдпрд╛рдкреНрдд рд╣реИ: <br><br><pre> <code class="cpp hljs">__asm { lock dec ┬л,     ┬╗ }</code> </pre><br>  рдпрд╛ <br><pre> <code class="cpp hljs">__asm { lock inc ┬л,     ┬╗ }</code> </pre><br>  <code>lock</code> рдЙрдкрд╕рд░реНрдЧ рдЖрдкрдХреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЗ рдмрд╛рдж рдХрдорд╛рдВрдб рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рд░реВрдк рд╕реЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред  рдХрдорд╛рдВрдб рдЪрд▓рдиреЗ рдХреЗ рджреМрд░рд╛рди рдпрд╣ рдмрд╛рдХреА рдкреНрд░реЛрд╕реЗрд╕рд░реНрд╕ рдХреЛ рдмреНрд▓реЙрдХ рдХрд░ рджреЗрддрд╛ рд╣реИред <br><br><h4>  рд╢реВрдЯрд░ </h4><br>  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ рдЖрдкрдХреЛ рд╣реЗрдбрд░ рдлрд╛рдЗрд▓ "ntddk.h", "ntddkbd.h" рдХреЛ рд╢рд╛рдорд┐рд▓ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ntddk.h"</span></span></span><span class="hljs-meta"> } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ntddkbd.h"</span></span></span></span></code> </pre><br>  <code>DEVICE_EXTENSION</code> рдХреА рд╕рдВрд░рдЪрдирд╛ рдХрд╛ рд╡рд░реНрдгрди рдХрд░рдирд╛ рднреА рдЖрд╡рд╢реНрдпрдХ рд╣реИ <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DEVICE_EXTENSION</span></span></span><span class="hljs-class">{</span></span> PDEVICE_OBJECT pLowerDO; } DEVICE_EXTENSION, *PDEVICE_EXTENSION;</code> </pre><br>  <code>pLowerDO</code> рдСрдмреНрдЬреЗрдХреНрдЯ рдПрдХ рдбрд┐рд╡рд╛рдЗрд╕ рдСрдмреНрдЬреЗрдХреНрдЯ рд╣реИ рдЬреЛ рд╕реНрдЯреИрдХ рдкрд░ рд╣рдорд╛рд░реЗ рдиреАрдЪреЗ рд╣реИред  рд╣рдореЗрдВ рдпрд╣ рдЬрд╛рдирдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдХрд┐ IRP рдкреИрдХреЗрдЯ рдХрд┐рд╕реЗ рднреЗрдЬреЗ рдЬрд╛рдПрдБред <br>  рд╣рдорд╛рд░реЗ рдбреНрд░рд╛рдЗрд╡рд░ рдХреЗ рд╕рдВрдЪрд╛рд▓рди рдХреЗ рд▓рд┐рдП, рд╣рдореЗрдВ рдПрдХ рдЪрд░ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдЕрдкреВрд░реНрдг рдЕрдиреБрд░реЛрдзреЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рд╕рдВрдЧреНрд░рд╣реАрдд рдХреА рдЬрд╛рдПрдЧреАред <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> gnRequests;</code> </pre><br>  рдЖрдЗрдП рдлрд╝рдВрдХреНрд╢рди рд╕реЗ рд╢реБрд░реВ рдХрд░реЗрдВ, рдЬреЛ рд╣рдорд╛рд░реЗ рдбреНрд░рд╛рдЗрд╡рд░ рдХрд╛ рдореБрдЦреНрдп рдкреНрд░рд╡реЗрд╢ рдмрд┐рдВрджреБ рд╣реИред <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> <span class="hljs-function"><span class="hljs-function">NTSTATUS </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DriverEntry</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IN PDRIVER_OBJECT theDriverObject, IN PUNICODE_STRING ustrRegistryPath)</span></span></span></span></code> </pre><br>  <code>theDriverObject</code> - рдбреНрд░рд╛рдЗрд╡рд░ рдСрдмреНрдЬреЗрдХреНрдЯ, рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╕рднреА рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд▓рд┐рдП рдкреЙрдЗрдВрдЯрд░реНрд╕ рд╕рдорд╛рд╣рд┐рдд рдХрд░рддрд╛ рд╣реИ рдЬрд┐рдиреНрд╣реЗрдВ рд╣рдореЗрдВ рдЖрд░рдВрдн рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреАред <br>  <code>ustrRegistryPath</code> - рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдореЗрдВ рдЙрд╕ рдЕрдиреБрднрд╛рдЧ рдХрд╛ рдирд╛рдо рдЬрд╣рд╛рдВ рдЗрд╕ рдбреНрд░рд╛рдЗрд╡рд░ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реИред <br>  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ рдЖрдкрдХреЛ рдЪрд░ рдШреЛрд╖рд┐рдд рдХрд░рдиреЗ рдФрд░ рдЙрдиреНрд╣реЗрдВ рд░рджреНрдж рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ: <br><pre> <code class="cpp hljs">gnRequests = <span class="hljs-number"><span class="hljs-number">0</span></span>; NTSTATUS status = {<span class="hljs-number"><span class="hljs-number">0</span></span>};</code> </pre><br>  рдЕрдЧрд▓рд╛, рдЬреИрд╕рд╛ рдХрд┐ рдореИрдВрдиреЗ рдКрдкрд░ рд▓рд┐рдЦрд╛ рдерд╛, рдЖрдкрдХреЛ рдлрд╝рдВрдХреНрд╢рди рдкреЙрдЗрдВрдЯрд░реНрд╕ рдХреЛ рдЗрдирд┐рд╢рд┐рдпрд▓рд╛рдЗрдЬрд╝ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;IRP_MJ_MAXIMUM_FUNCTION; ++i) { theDriverObject-&gt;MajorFunction[i] = DispatchThru; } theDriverObject-&gt;MajorFunction[IRP_MJ_READ] = DispatchRead; theDriverObject-&gt;DriverUnload = DriverUnload;</code> </pre><br>  <code>DispatchRead</code> рдлрд╝рдВрдХреНрд╢рди рд░реАрдб рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ рдХреЛ рд╣реИрдВрдбрд▓ рдХрд░реЗрдЧрд╛ред  рдпрд╣ рддрдм рдХрд╣рд╛ рдЬрд╛рдПрдЧрд╛ рдЬрдм рдХреАрдмреЛрд░реНрдб рдХреБрдВрдЬреА рджрдмрд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдпрд╛ рдЬрд╛рд░реА рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред <br>  <code>DriverUnload</code> рдлрд╝рдВрдХреНрд╢рди рддрдм рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬрдм рдбреНрд░рд╛рдЗрд╡рд░ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реЛрддреА рд╣реИ рдФрд░ рдореЗрдореЛрд░реА рд╕реЗ рдЕрдирд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдпрд╛ рдЬрдм рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдбреНрд░рд╛рдЗрд╡рд░ рдХреЛ <code>DriverUnload</code> рдХрд░рддрд╛ <code>DriverUnload</code> ред  рдЗрд╕ рдлрд╝рдВрдХреНрд╢рди рдореЗрдВ, "рд╕реНрдЯреНрд░рд┐рдкрд┐рдВрдЧ" рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП, рдЕрд░реНрдерд╛рдд  рдбреНрд░рд╛рдЗрд╡рд░ рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЛ рдореБрдХреНрдд рдХрд░ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рд╕рднреА рдЕрдкреВрд░реНрдг рдЕрдиреБрд░реЛрдз рдкреВрд░рд╛ рд╣реЛ рдЬрд╛рддреЗ рд╣реИрдВ, рдЖрджрд┐ред <br>  <code>DispatchThru</code> рдлрд╝рдВрдХреНрд╢рди рдПрдХ рд╕реНрдЯрдм рдлрд╝рдВрдХреНрд╢рди рд╣реИред  рд╡рд╣ рдЬреЛ рдХрд░рддреА рд╣реИ рд╡рд╣ IRP рдкреИрдХреЗрдЯ рдЕрдЧрд▓реЗ рдбреНрд░рд╛рдЗрд╡рд░ рдХреЛ рджреЗрддреА рд╣реИ (рд╡рд╣ рдбреНрд░рд╛рдЗрд╡рд░ рдЬреЛ рд╕реНрдЯреИрдХ рдореЗрдВ рд╣рдорд╛рд░реЗ рдЕрдзреАрди рд╣реИ, рдпрд╛рдиреА <code>pLowerDO</code> рд╕реЗ <code>DEVICE_EXTENSION</code> )ред <br>  рдЕрдЧрд▓рд╛, рд╣рдо рдбрд┐рд╡рд╛рдЗрд╕ рд╕реНрдЯреИрдХ рдкрд░ рдЕрдкрдирд╛ рдбрд┐рд╡рд╛рдЗрд╕ рдмрдирд╛рдиреЗ рдФрд░ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдкрдиреЗ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдХреЙрд▓ рдХрд░рддреЗ рд╣реИрдВ: <br><pre> <code class="cpp hljs">status = InstallFilter(theDriverObject);</code> </pre><br>  рдореИрдВ рдиреАрдЪреЗ рдЗрд╕ рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рд╡рд░реНрдгрди рдХрд░реВрдВрдЧрд╛ред <br>  рд╣рдо <code>status</code> рд▓реМрдЯрд╛рддреЗ рд╣реИрдВ, рдЬрд┐рд╕рдореЗрдВ, рдпрджрд┐ <code>InstallFilter</code> рдлрд╝рдВрдХреНрд╢рди <code>InstallFilter</code> , рддреЛ <code>STATUS_SUCCESS</code> рдорд╛рди рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред <br>  рд╣рдо <code>InstallFilter</code> рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдкрд╛рд╕ рдХрд░рддреЗ рд╣реИрдВред  рдпрд╣рд╛рдБ рдЙрд╕рдХрд╛ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рд╣реИ: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">NTSTATUS </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InstallFilter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IN PDRIVER_OBJECT theDO)</span></span></span></span>;</code> </pre><br>  рдпрд╣ рдлрд╝рдВрдХреНрд╢рди рдПрдХ рдбрд┐рд╡рд╛рдЗрд╕ рдСрдмреНрдЬреЗрдХреНрдЯ рдмрдирд╛рддрд╛ рд╣реИ, рдЗрд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдЗрд╕реЗ <code>\\Device\\KeyboardClass0</code> рдкрд░ рдбрд┐рд╡рд╛рдЗрд╕ рд╕реНрдЯреИрдХ рдкрд░ рдзрдХреЗрд▓рддрд╛ рд╣реИ <br><br>  рдШреЛрд╖рд┐рдд рдЪрд░: <br><pre> <code class="cpp hljs">PDEVICE_OBJECT pKeyboardDevice; NTSTATUS status = {<span class="hljs-number"><span class="hljs-number">0</span></span>};</code> </pre><br>  <code>pKeyboardDevice</code> рдбрд┐рд╡рд╛рдЗрд╕ рдСрдмреНрдЬреЗрдХреНрдЯ рд╣реИ рдЬрд┐рд╕реЗ рд╣рдореЗрдВ рдмрдирд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред <br>  рдПрдХ рдирдпрд╛ рдЙрдкрдХрд░рдг рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП <code>IoCreateDevice</code> рдкрд░ рдХреЙрд▓ рдХрд░реЗрдВ <br><pre> <code class="cpp hljs">status = IoCreateDevice(theDO, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(DEVICE_EXTENSION), <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, FILE_DEVICE_KEYBOARD, <span class="hljs-number"><span class="hljs-number">0</span></span>, FALSE, &amp;pKeyboardDevice);</code> </pre><br>  рдЖрдЗрдП рдорд╛рдкрджрдВрдбреЛрдВ рдХрд╛ рдЕрдзрд┐рдХ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░реЗрдВ: <br><ul><li>  рдкрд╣рд▓рд╛ рддрд░реНрдХ рдбреНрд░рд╛рдЗрд╡рд░ рдСрдмреНрдЬреЗрдХреНрдЯ рд╣реИ рдЬрд┐рд╕реЗ рд╣рдордиреЗ рдЗрдВрд╕реНрдЯрд╛рд▓рдлрд┐рд▓реНрдЯрд░ рдлрд╝рдВрдХреНрд╢рди рдХреЗ рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд░реВрдк рдореЗрдВ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рд╣реИред  рдпрд╣ рд╣рдорд╛рд░реЗ рдбреНрд░рд╛рдЗрд╡рд░ рдФрд░ рдирдП рдбрд┐рд╡рд╛рдЗрд╕ рдХреЗ рдмреАрдЪ рд╕рдВрдмрдВрдз рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП IoCreateDevice рдХреЛ рдкрд╛рд╕ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред <br></li><li>  рддреАрд╕рд░рд╛ рдкреИрд░рд╛рдореАрдЯрд░ рдбрд┐рд╡рд╛рдЗрд╕ рдХрд╛ рдирд╛рдо рд╣реИ <br></li><li>  рдЪреМрдерд╛ рдкреИрд░рд╛рдореАрдЯрд░ рдбрд┐рд╡рд╛рдЗрд╕ рдХрд╛ рдкреНрд░рдХрд╛рд░ рд╣реИ <br></li><li>  рдкрд╛рдВрдЪрд╡рд╛рдВ рдкреИрд░рд╛рдореАрдЯрд░ рд╡рд╣ рдЭрдВрдбреЗ рд╣реИрдВ рдЬреЛ рдЖрдорддреМрд░ рдкрд░ рдмрдбрд╝реЗ рдкреИрдорд╛рдиреЗ рдкрд░ рднрдВрдбрд╛рд░рдг рдЙрдкрдХрд░рдгреЛрдВ рдХреЗ рд▓рд┐рдП рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред <br></li><li>  рдЫрдард╛ рдкреИрд░рд╛рдореАрдЯрд░ рдмрддрд╛рддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдПрдХ рд╕реЗ рдЕрдзрд┐рдХ рд░рд╛рд╢рд┐ рдореЗрдВ рдбрд┐рд╡рд╛рдЗрд╕ рдореИрдирд┐рдкреБрд▓реЗрдЯрд░реНрд╕ рдХреЛ рдЦреЛрд▓рдирд╛ рд╕рдВрднрд╡ рд╣реИред  рдпрджрд┐ FALSE рд╣реИ, рддреЛ рдЖрдк рдХреЗрд╡рд▓ рдПрдХ рдЬреЛрдбрд╝рддреЛрдбрд╝ рдЦреЛрд▓ рд╕рдХрддреЗ рд╣реИрдВред  рдЕрдиреНрдпрдерд╛, рдЖрдк рдХрд┐рд╕реА рднреА рд╕рдВрдЦреНрдпрд╛ рдореЗрдВ рдЬреЛрдбрд╝рддреЛрдбрд╝ рдЦреЛрд▓ рд╕рдХрддреЗ рд╣реИрдВред <br></li><li>  рд╕рд╛рддрд╡рд╛рдВ рдкреИрд░рд╛рдореАрдЯрд░ рд╡рд╣ рдореЗрдореЛрд░реА рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдмрдирд╛рдИ рдЧрдИ рдбрд┐рд╡рд╛рдЗрд╕ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЛ рд╕рд╣реЗрдЬрд╛ рдЬрд╛рдПрдЧрд╛ред <br></li></ul><br>  рдЕрдЧрд▓рд╛, рдбрд┐рд╡рд╛рдЗрд╕ рдХреЗ рдЭрдВрдбреЗ рд╕реЗрдЯ рдХрд░реЗрдВред <br><pre> <code class="cpp hljs">pKeyboardDevice-&gt;Flags = pKeyboardDevice-&gt;Flags | (DO_BUFFERED_IO | DO_POWER_PAGABLE); pKeyboardDevice-&gt;Flags = pKeyboardDevice-&gt;Flags &amp; ~DO_DEVICE_INITIALIZING;</code> </pre><br>  рд╣рдо рдЕрдкрдиреЗ рдбрд┐рд╡рд╛рдЗрд╕ рдХреЗ рд▓рд┐рдП рдЬреЛ рдЭрдВрдбреЗ рд╕реЗрдЯ рдХрд░рддреЗ рд╣реИрдВ, рд╡рд╣ рдЙрд╕ рдбрд┐рд╡рд╛рдЗрд╕ рдХреЗ рдЭрдВрдбреЗ рдХреЗ рдмрд░рд╛рдмрд░ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП рдЬрд┐рд╕рдХреЗ рдКрдкрд░ рд╣рдо рд╕реНрдЯреИрдХ рдкрд░ рдзрдХреЗрд▓ рджрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред <br>  рдЕрдЧрд▓рд╛, рд╣рдореЗрдВ рдЙрд╕ рдЙрдкрдХрд░рдг рдХреЗ рдирд╛рдо рдХрд╛ рд░реВрдкрд╛рдВрддрд░рдг рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдЬрд┐рд╕реЗ рд╣рдо рд╕реНрдЯреИрдХ рдкрд░ рд░рдЦ рд░рд╣реЗ рд╣реИрдВред <br><pre> <code class="cpp hljs">CCHAR cName[<span class="hljs-number"><span class="hljs-number">40</span></span>] = <span class="hljs-string"><span class="hljs-string">"\\Device\\KeyboardClass0"</span></span>; STRING strName; UNICODE_STRING ustrDeviceName; RtlInitAnsiString(&amp;strName, cName); RtlAnsiStringToUnicodeString(&amp;ustrDeviceName, &amp;strName, TRUE);</code> </pre><br>  <code>IoAttachDevice</code> рдлрд╝рдВрдХреНрд╢рди рд╕реНрдЯреИрдХ рдкрд░ рд╣рдорд╛рд░реЗ рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛ <code>IoAttachDevice</code> ред  <code>pdx-&gt;pLowerDO</code> рдЕрдЧрд▓реЗ (рдирд┐рдЪрд▓реЗ) рдбрд┐рд╡рд╛рдЗрд╕ <code>pdx-&gt;pLowerDO</code> рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЛ рд╕реНрдЯреЛрд░ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред <br><pre> <code class="cpp hljs">IoAttachDevice(pKeyboardDevice, &amp;ustrDeviceName, &amp;pdx-&gt;pLowerDO);</code> </pre><br>  рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЛ рдЦрд╛рд▓реА рдХрд░рдирд╛: <br><pre> <code class="cpp hljs">RtlFreeUnicodeString(&amp;ustrDeviceName);</code> </pre><br>  рдЕрдЧрд▓рд╛, рд╣рдо рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдХреЗ рд╕рд╛рде <code>DispatchRead</code> рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░реЗрдВрдЧреЗ: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">NTSTATUS </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DispatchRead</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IN PDEVICE_OBJECT pDeviceObject, IN PIRP pIrp)</span></span></span></span>;</code> </pre><br>  рдЬрдм рдЖрдк рдХреАрдмреЛрд░реНрдб рдХреБрдВрдЬреА рджрдмрд╛рддреЗ рдпрд╛ рдЫреЛрдбрд╝рддреЗ рд╣реИрдВ рддреЛ рдпрд╣ рдлрд╝рдВрдХреНрд╢рди рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рджреНрд╡рд╛рд░рд╛ рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ <br>  рд╣рдо рдЕрдкреВрд░реНрдг рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЗ рдХрд╛рдЙрдВрдЯрд░ рдХреЛ рдмрдврд╝рд╛рддреЗ рд╣реИрдВ <br><pre> <code class="cpp hljs">__asm { lock inc gnRequests }</code> </pre><br>  рдЕрдЧрд▓реЗ рдбреНрд░рд╛рдЗрд╡рд░ рдХреЗ рд▓рд┐рдП рдЕрдиреБрд░реЛрдз рдкрд╛рд░рд┐рдд рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ, рд╣рдореЗрдВ рдбреНрд░рд╛рдЗрд╡рд░ рдХреЗ рд▓рд┐рдП рд╕реНрдЯреИрдХ рдкреЙрдЗрдВрдЯрд░ рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред  <code>IoCopyCurrentIrpStackLocationToNext</code> рд╕реНрдореГрддрд┐ рдХреЗ рдЙрд╕ рд╣рд┐рд╕реНрд╕реЗ рдХреА рдкреНрд░рддрд┐рд▓рд┐рдкрд┐ рдмрдирд╛рддрд╛ рд╣реИ рдЬреЛ рд╡рд░реНрддрдорд╛рди рдбреНрд░рд╛рдЗрд╡рд░ рдХреЗ рдЕрдЧрд▓реЗ рдбреНрд░рд╛рдЗрд╡рд░ рдХреЗ рдореЗрдореЛрд░реА рдХреНрд╖реЗрддреНрд░ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рд╣реИред <br><pre> <code class="cpp hljs">IoCopyCurrentIrpStackLocationToNext(theIrp);</code> </pre>  рдЬрдм рдХреЛрдИ рдЕрдиреБрд░реЛрдз рд╕реНрдЯреИрдХ рд╕реЗ рдиреАрдЪреЗ рдЬрд╛рддрд╛ рд╣реИ, рддрдм рднреА рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рд╡рд╣ рдбреЗрдЯрд╛ рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ рдЬрд┐рд╕рдХреА рд╣рдореЗрдВ рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╣рдореЗрдВ рдПрдХ рдлрд╝рдВрдХреНрд╢рди рд╕реЗрдЯ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ, рдЬрд┐рд╕реЗ рддрдм рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдЬрдм рдЕрдиреБрд░реЛрдз рдбреЗрдЯрд╛ рдХреЗ рд╕рд╛рде рдвреЗрд░ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ рдЬрд┐рд╕рдХреА рд╣рдореЗрдВ рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред <br><pre> <code class="cpp hljs">IoSetCompletionRoutine(theIrp, ReadCompletionRoutine, pDeviceObject, TRUE, TRUE, TRUE)</code> </pre><br>  рдЬрд╣рд╛рдБ <code>ReadCompletionRoutine</code> рд╣рдорд╛рд░рд╛ рдХрд╛рд░реНрдп рд╣реИред <br>  рд╣рдо рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдбреНрд░рд╛рдЗрд╡рд░ <code>IRP</code> : <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IoCallDriver(((PDEVICE_EXTENSION) pDeviceObject-&gt;DeviceExtension)-&gt;pLowerDO ,theIrp);</code> </pre><br>  рдЕрдм рд╣рдо рдЙрд╕ рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░реЗрдВрдЧреЗ рдЬрд┐рд╕реЗ <code>IRP</code> рдкреВрд░рд╛ рд╣реЛрдиреЗ рдкрд░ рд╣рд░ рдмрд╛рд░ рдмреБрд▓рд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛ред  рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">NTSTATUS </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadCompletionRoutine</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IN PDEVICE_OBJECT pDeviceObject, IN PIRP theIrp, IN PVOID Context)</span></span></span></span>;</code> </pre><br>  <code>DEVICE_EXTENSION</code> : <br><pre> <code class="cpp hljs">PDEVICE_EXTENSION pdx = (PDEVICE_EXTENSION)pDeviceObject-&gt;DeviceExtension;</code> </pre><br>  <code>PKEYBOARD_INPUT_DATA</code> рд╕рдВрд░рдЪрдирд╛ <code>PKEYBOARD_INPUT_DATA</code> рдЙрдкрдпреЛрдЧ рджрдмрд╛рдП рдЧрдП рдХреБрдВрдЬреА рдХрд╛ рд╡рд░реНрдгрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред <br><pre> <code class="cpp hljs">PKEYBOARD_INPUT_DATA kidData;</code> </pre><br>  рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдЕрдиреБрд░реЛрдз рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдкреВрд░рд╛ рд╣реБрдЖ рдпрд╛ рдирд╣реАрдВ <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NT_SUCCESS(theIrp-&gt;IoStatus.Status))</code> </pre><br>  <code>KEYBOARD_INPUT_DATA</code> рд╕рдВрд░рдЪрдирд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ <code>IRP</code> рдкреИрдХреЗрдЯ рдХреЗ рд╕рд┐рд╕реНрдЯрдо рдмрдлрд░ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред <br><pre> <code class="cpp hljs">kidData = (PKEYBOARD_INPUT_DATA)theIrp-&gt;AssociatedIrp.SystemBuffer;</code> </pre><br>  рдЪрд╛рдмрд┐рдпреЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдПрдВ <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n = theIrp-&gt;IoStatus.Information / <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(KEYBOARD_INPUT_DATA);</code> </pre><br>  рдФрд░ рдкреНрд░рддреНрдпреЗрдХ рдХреБрдВрдЬреА рдкреНрд░рд┐рдВрдЯ рдХрд░реЗрдВ: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;n; ++i) DbgPrint(<span class="hljs-string"><span class="hljs-string">"Code: %x\n"</span></span>, kidData[i].MakeCode);</code> </pre><br>  рдФрд░ рд╕рдВрд╕рд╛рдзрд┐рдд рдирд╣реАрдВ рдХрд┐рдП рдЧрдП рдЕрдиреБрд░реЛрдзреЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рдХреЛ рдХрдо рдХрд░рдирд╛ рди рднреВрд▓реЗрдВ <br><pre> <code class="cpp hljs">__asm { lock dec gnRequests }</code> </pre><br>  рдЕрдиреБрд░реЛрдз рдХреА рд╕реНрдерд┐рддрд┐ рд▓реМрдЯрд╛рдПрдВ <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> theIrp-&gt;IoStatus.Status;</code> </pre><br>  рдЪрд▓реЛ рд╢рдЯрдбрд╛рдЙрди рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░рддреЗ рд╣реИрдВред  рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">VOID </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DriverUnload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IN PDRIVER_OBJECT theDO)</span></span></span></span>;</code> </pre><br>  <code>DEVICE_EXTENSION</code> : <br><pre> <code class="cpp hljs">PDEVICE_EXTENSION pdx = (PDEVICE_EXTENSION)theDO-&gt;DeviceObject-&gt;DeviceExtension;</code> </pre><br>  рд╣рдо рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛ рд╕реНрдЯреИрдХ рд╕реЗ рдирд┐рдХрд╛рд▓рддреЗ рд╣реИрдВ: <br><pre> <code class="cpp hljs">IoDetachDevice(pdx-&gt;pLowerDO);</code> </pre><br>  рд╣рдо рдбрд┐рд╡рд╛рдЗрд╕ рдирд┐рдХрд╛рд▓рддреЗ рд╣реИрдВ: <br><pre> <code class="cpp hljs">IoDeleteDevice(theDO-&gt;DeviceObject);</code> </pre><br>  рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдХреНрдпрд╛ рд▓рдВрдмрд┐рдд рдЕрдиреБрд░реЛрдз рд╣реИрдВ рдпрд╛ рдирд╣реАрдВред  рдпрджрд┐ рд╣рдо рдЗрд╕ рдЬрд╛рдВрдЪ рдХреЗ рдмрд┐рдирд╛ рдбреНрд░рд╛рдЗрд╡рд░ рдХреЛ рд▓реЛрдб рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЙрддрд╛рд░рдиреЗ рдХреЗ рдмрд╛рдж рдХреБрдВрдЬреА рдХреЗ рдкрд╣рд▓реЗ рдкреНрд░реЗрд╕ рдореЗрдВ рдПрдХ рдмреАрдПрд╕рдУрдбреА рд╣реЛрдЧрд╛ред <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gnRequests != <span class="hljs-number"><span class="hljs-number">0</span></span>) { KTIMER ktTimer; LARGE_INTEGER liTimeout; liTimeout.QuadPart = <span class="hljs-number"><span class="hljs-number">1000000</span></span>; KeInitializeTimer(&amp;ktTimer);        ,   <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(gnRequests &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { KeSetTimer(&amp;ktTimer, liTimeout, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   KeWaitForSingleObject(&amp;ktTimer, Executive, KernelMode, FALSE, NULL); //     } }</span></span></code> </pre><br>  рдбреНрд░рд╛рдЗрд╡рд░ рдХреЛрдб: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ntddk.h"</span></span></span><span class="hljs-meta"> } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ntddkbd.h"</span></span></span><span class="hljs-meta"> typedef struct _DEVICE_EXTENSION{ PDEVICE_OBJECT pLowerDO; } DEVICE_EXTENSION, *PDEVICE_EXTENSION; int gnRequests; NTSTATUS DispatchThru(PDEVICE_OBJECT theDeviceObject, PIRP theIrp) { IoSkipCurrentIrpStackLocation(theIrp); return IoCallDriver(((PDEVICE_EXTENSION) theDeviceObject-&gt;DeviceExtension)-&gt;pLowerDO ,theIrp); } NTSTATUS InstallFilter(IN PDRIVER_OBJECT theDO) { PDEVICE_OBJECT pKeyboardDevice; NTSTATUS status = {0}; status = IoCreateDevice(theDO, sizeof(DEVICE_EXTENSION), NULL, FILE_DEVICE_KEYBOARD, 0, FALSE, &amp;pKeyboardDevice); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!NT_SUCCESS(status)) { DbgPrint(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"IoCreateDevice error.."</span></span></span><span class="hljs-meta">); return status; } pKeyboardDevice-&gt;Flags = pKeyboardDevice-&gt;Flags | (DO_BUFFERED_IO | DO_POWER_PAGABLE); pKeyboardDevice-&gt;Flags = pKeyboardDevice-&gt;Flags &amp; ~DO_DEVICE_INITIALIZING; RtlZeroMemory(pKeyboardDevice-&gt;DeviceExtension, sizeof(DEVICE_EXTENSION)); PDEVICE_EXTENSION pdx = (PDEVICE_EXTENSION)pKeyboardDevice-&gt;DeviceExtension; CCHAR cName[40] = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"\\Device\\KeyboardClass0"</span></span></span><span class="hljs-meta">; STRING strName; UNICODE_STRING ustrDeviceName; RtlInitAnsiString(&amp;strName, cName); RtlAnsiStringToUnicodeString(&amp;ustrDeviceName, &amp;strName, TRUE); IoAttachDevice(pKeyboardDevice, &amp;ustrDeviceName, &amp;pdx-&gt;pLowerDO); </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//DbgPrint("After IoAttachDevice"); RtlFreeUnicodeString(&amp;ustrDeviceName); return status; } VOID DriverUnload(IN PDRIVER_OBJECT theDO) { PDEVICE_EXTENSION pdx = (PDEVICE_EXTENSION)theDO-&gt;DeviceObject-&gt;DeviceExtension; IoDetachDevice(pdx-&gt;pLowerDO); IoDeleteDevice(theDO-&gt;DeviceObject); if (gnRequests != 0) { KTIMER ktTimer; LARGE_INTEGER liTimeout; liTimeout.QuadPart = 1000000; KeInitializeTimer(&amp;ktTimer); while(gnRequests &gt; 0) { KeSetTimer(&amp;ktTimer, liTimeout, NULL); KeWaitForSingleObject(&amp;ktTimer, Executive, KernelMode, FALSE, NULL); } } } NTSTATUS ReadCompletionRoutine(IN PDEVICE_OBJECT pDeviceObject, IN PIRP theIrp, IN PVOID Context) { PDEVICE_EXTENSION pdx = (PDEVICE_EXTENSION)pDeviceObject-&gt;DeviceExtension; PKEYBOARD_INPUT_DATA kidData; if (NT_SUCCESS(theIrp-&gt;IoStatus.Status)) { kidData = (PKEYBOARD_INPUT_DATA)theIrp-&gt;AssociatedIrp.SystemBuffer; int n = theIrp-&gt;IoStatus.Information / sizeof(KEYBOARD_INPUT_DATA); for(int i = 0; i&lt;n; ++i) { DbgPrint("Code: %x\n", kidData[i].MakeCode); } } if(theIrp-&gt;PendingReturned) IoMarkIrpPending(theIrp); __asm{ lock dec gnRequests } return theIrp-&gt;IoStatus.Status; } NTSTATUS DispatchRead(IN PDEVICE_OBJECT pDeviceObject, IN PIRP theIrp) { __asm{ lock inc gnRequests } IoCopyCurrentIrpStackLocationToNext(theIrp); IoSetCompletionRoutine(theIrp, ReadCompletionRoutine, pDeviceObject, TRUE, TRUE, TRUE); return IoCallDriver(((PDEVICE_EXTENSION) pDeviceObject-&gt;DeviceExtension)-&gt;pLowerDO ,theIrp); } extern "C" NTSTATUS DriverEntry(IN PDRIVER_OBJECT theDriverObject, IN PUNICODE_STRING RegistryPath) { NTSTATUS status = {0}; gnRequests = 0; for (int i = 0; i&lt;IRP_MJ_MAXIMUM_FUNCTION; ++i) { theDriverObject-&gt;MajorFunction[i] = DispatchThru; } theDriverObject-&gt;MajorFunction[IRP_MJ_READ] = DispatchRead; status = InstallFilter(theDriverObject); theDriverObject-&gt;DriverUnload = DriverUnload; return status; }</span></span></span></span></code> </pre><br><br>  makefile: <br><pre> <code class="hljs vhdl"># # DO <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> EDIT THIS <span class="hljs-keyword"><span class="hljs-keyword">FILE</span></span>!!! Edit .\sources. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> you want <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> add a <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> source # <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> this <span class="hljs-keyword"><span class="hljs-keyword">component</span></span>. This <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> merely indirects <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the real make <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> # that <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">shared</span></span> by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> the driver components <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the Windows NT DDK # !INCLUDE $(NTMAKEENV)\makefile.def</code> </pre><br>  рд╕реНрд░реЛрдд: <br><pre> <code class="hljs">TARGETNAME=sysfile TARGETPATH=BIN TARGETTYPE=DRIVER SOURCES = DriverMain.cpp</code> </pre><br><h5>  рдбреНрд░рд╛рдЗрд╡рд░ рдХреИрд╕реЗ рд╢реБрд░реВ рдХрд░реЗрдВ рдФрд░ рдбрд┐рдмрдЧрд┐рдВрдЧ рдЬрд╛рдирдХрд╛рд░реА рджреЗрдЦреЗрдВ </h5><br>  рдбреНрд░рд╛рдЗрд╡рд░ рдХреЛ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП, рдореИрдВрдиреЗ KmdManager рдЙрдкрдпреЛрдЧрд┐рддрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ред  рдбрд┐рдмрдЧ рдЬрд╛рдирдХрд╛рд░реА рджреЗрдЦрдиреЗ рдХреЗ рд▓рд┐рдП, DbgView рдЙрдкрдпреЛрдЧрд┐рддрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред <br><br>  PS рдореИрдВрдиреЗ рдЕрдкрдиреЗ рддреАрд╕рд░реЗ рд╡рд░реНрд╖ рдореЗрдВ рдПрдХ рд▓реЗрдЦ рдмрд╣реБрдд рдкрд╣рд▓реЗ рд▓рд┐рдЦрд╛ рдерд╛, рдЕрдм рдореБрдЭреЗ рд▓рдЧрднрдЧ рдХреБрдЫ рднреА рдпрд╛рдж рдирд╣реАрдВ рд╣реИред  рд▓реЗрдХрд┐рди рдЕрдЧрд░ рдЖрдкрдХреЗ рдХреЛрдИ рд╕рд╡рд╛рд▓ рд╣реИрдВ, рддреЛ рдореИрдВ рдЬрд╡рд╛рдм рджреЗрдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░реВрдВрдЧрд╛ред <br>  рдкреАрдкреАрдПрд╕ рдХреГрдкрдпрд╛ рдЯрд┐рдкреНрдкрдгреА рдкрд░ рдзреНрдпрд╛рди рджреЗрдВ, рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ <a href="http://habrahabr.ru/post/146071/">рдЗрд╕ рдкрд░</a> <br><br>  <b>UPD:</b> GitHub рдкрд░ рдкреНрд░реЛрдЬреЗрдХреНрдЯ: <a href="https://github.com/pbespechnyi/simple-wdm-driver">https://github.com/pbespechnyi/simple-wdm-driver</a> </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/In146071/">https://habr.com/ru/post/In146071/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../In146065/index.html">рдбреЗрд╕реНрдХрдЯреЙрдк рдкрд░ рдореЗрдЯреНрд░реЛ рдкрд░ рдХреБрдЫ рд╡рд┐рдЪрд╛рд░</a></li>
<li><a href="../In146066/index.html">рдордЬрдмреВрдд рдХреГрддреНрд░рд┐рдо рдмреБрджреНрдзрд┐ рдХреА рд╕рд░рд▓ рд╡рд╛рд╕реНрддреБрдХрд▓рд╛</a></li>
<li><a href="../In146067/index.html">Pygame рдЦрд┐рд▓рд╛рдбрд╝реА</a></li>
<li><a href="../In146068/index.html">рд▓рд┐рдВрдХреНрдбрдЗрди рд╣реИрдХ рдкрд╛рд╕рд╡рд░реНрдб рдЬрдирд░реЗрдЯрд░ / рд╕рддреНрдпрд╛рдкрдирдХрд░реНрддрд╛</a></li>
<li><a href="../In146070/index.html">рдХреНрдпрд╛ рдЖрдк рд▓рдЧрд╛рддрд╛рд░ "рдкреНрд░рдХрд╛рд╢рди рддрдХ рдкрд╣реБрдБрдЪ рдмрдВрдж рд╣реИ" рд╕реЗ рдкрд░реЗрд╢рд╛рди рд╣реИрдВ?</a></li>
<li><a href="../In146074/index.html">рдЙрддреНрдкреНрд░реЗрд░рдХ MVC рдлреНрд░реЗрдорд╡рд░реНрдХ рдмреБрдирд┐рдпрд╛рджреА рдмрд╛рддреЛрдВ</a></li>
<li><a href="../In146076/index.html">рдЗрдиреНрдлрд░реНрдиреЛ рднрд╛рдЧ 0: рдирд╛рдорд╕реНрдерд╛рди</a></li>
<li><a href="../In146077/index.html">рд╢рд┐рдХреНрд╖рдХ рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдХреЗ рдмрд┐рдирд╛ рдмрдбрд╝реЗ рдкреИрдорд╛рдиреЗ рдкрд░ рдкреНрд░рдпреЛрдЧ рдХрд░рдХреЗ рдЙрдЪреНрдЪ-рд╕реНрддрд░реАрдп рд▓рдХреНрд╖рдгреЛрдВ рдХрд╛ рдЧрдарди</a></li>
<li><a href="../In146078/index.html">рд╕рдмрд╕реЗ рд╣реЛрдирд╣рд╛рд░ рдирдП gTLDs рдХреНрдпрд╛ рд╣реИрдВ?</a></li>
<li><a href="../In146079/index.html">DynDNS рд╣реА рдпрд╛ рдкреНрд░рдмрдВрдзрд┐рдд DNS рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди PowerShell рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>