<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>â™ï¸ ğŸ˜œ ğŸ‘¨ğŸ»â€ğŸ¤ SQL Serverä¸­çš„ç‰ˆæœ¬æ§åˆ¶ ğŸ˜¹ ğŸ¤³ ğŸ°</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æœ±è‰å¨… ï¼š é‚£ä¹ˆï¼Œæ˜¨å¤©è°æ”¹å˜äº†æˆ‘çš„ç¨‹åºï¼Ÿ 
 å‹’è ï¼š ä¸æ˜¯æˆ‘ 
 é©¬å…‹è¥¿å§† ï¼š ä¸æ˜¯æˆ‘ 
 - ä¼™è®¡ä»¬ï¼Œæˆ‘ä»¬å¯ä»¥æ‹¿åˆ°Gitå—ï¼Ÿ 
 Seryozha ï¼š æ˜¯æ—¶å€™äº†ï¼ 
 2ä¸ªæ˜ŸæœŸè¿‡å»äº†... 

 æœ±è‰å¨… ï¼š ä¼™è®¡ä»¬ï¼Ÿ 
 - å°¤å°”ï¼Œä½ æ²¡çŠ¯å—ï¼Ÿ 
 æœ±è‰å¨… ï¼š è¯¥æ­» ï¼ˆ... 

 è¿™å°±æ˜¯ä¸€åˆ‡çš„å¼€...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>SQL Serverä¸­çš„ç‰ˆæœ¬æ§åˆ¶</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/419919/">  <b>æœ±è‰å¨…</b> ï¼š <i>é‚£ä¹ˆï¼Œæ˜¨å¤©è°æ”¹å˜äº†æˆ‘çš„ç¨‹åºï¼Ÿ</i> <br>  <b>å‹’è</b> ï¼š <i>ä¸æ˜¯æˆ‘</i> <br>  <b>é©¬å…‹è¥¿å§†</b> ï¼š <i>ä¸æ˜¯æˆ‘</i> <br>  - <i>ä¼™è®¡ä»¬ï¼Œæˆ‘ä»¬å¯ä»¥æ‹¿åˆ°Gitå—ï¼Ÿ</i> <br>  <b>Seryozha</b> ï¼š <i>æ˜¯æ—¶å€™äº†ï¼</i> <br>  2ä¸ªæ˜ŸæœŸè¿‡å»äº†... <br><br>  <b>æœ±è‰å¨…</b> ï¼š <i>ä¼™è®¡ä»¬ï¼Ÿ</i> <br>  - <i>å°¤å°”ï¼Œä½ æ²¡çŠ¯å—ï¼Ÿ</i> <br>  <b>æœ±è‰å¨…</b> ï¼š <s><i>è¯¥æ­»</i></s> <i>ï¼ˆ...</i> <br><br> è¿™å°±æ˜¯ä¸€åˆ‡çš„å¼€å§‹ã€‚ é‚£ä¹ˆï¼Œæ¯ä¸ªå­—ç¬¦å’Œæ¯ä¸€è¡Œéƒ½ä¼šæäº¤ä»€ä¹ˆï¼Ÿ <br><br> è¿˜æ˜¯æ‰€æœ‰è¿™äº›éƒ½å°†å•ç‹¬å‘ç”Ÿï¼Ÿï¼‰åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œä»–ä»¬å¼€å§‹æµ®ç°åœ¨è„‘æµ· <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ·»åŠ äº†DDLè§¦å‘å™¨</a> ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ—¶é—´è¡¨</a>å’Œå›¾ç‰‡ã€‚ è§£å†³åï¼Œæˆ‘ä»¬å°†ç‰ˆæœ¬å­˜å‚¨åœ¨å†…éƒ¨ <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">SQL Server'a</a> ï¼ï¼‰ <br><br><img src="https://habrastorage.org/webt/dn/fe/f3/dnfef3bqd49qysawcaxvuuiasdi.jpeg"><br><br><a name="habracut"></a><br> é¦–å…ˆï¼Œåˆ›å»ºè¦åœ¨å…¶ä¸­å­˜å‚¨ç‰ˆæœ¬çš„è¡¨ <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">master</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-comment"><span class="hljs-comment">--     IF NOT EXISTS ( SELECT 1 FROM sys.objects WHERE name = 'VersionControlHistory' AND type = 'U' ) CREATE TABLE dbo.VersionControlHistory( Id INT NOT NULL, Event sysname NOT NULL, Db sysname NOT NULL, Sch sysname NOT NULL, Object sysname NOT NULL, Sql XML NOT NULL, Login sysname NOT NULL, StartDate DATETIME2(0) NOT NULL, EndDate DATETIME2(0) NOT NULL ) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY] GO --      IF NOT EXISTS ( SELECT 1 FROM sys.objects WHERE name = 'VersionControl' AND type = 'U' ) CREATE TABLE dbo.VersionControl( Id INT IDENTITY(1,1) NOT NULL CONSTRAINT PK_VersionControl PRIMARY KEY NONCLUSTERED, Event sysname NOT NULL, Db sysname NOT NULL, Sch sysname NOT NULL, Object sysname NOT NULL, Sql XML NOT NULL, Login sysname NOT NULL, StartDate DATETIME2(0) GENERATED ALWAYS AS ROW START NOT NULL, EndDate DATETIME2(0) GENERATED ALWAYS AS ROW END NOT NULL, PERIOD FOR SYSTEM_TIME (StartDate, EndDate) ) WITH ( SYSTEM_VERSIONING = ON ( HISTORY_TABLE = dbo.VersionControlHistory ) ) GO</span></span></code> </pre> <br> é‡è¦çš„æ˜¯è¦è®°ä½æ—¶é—´è¡¨çš„å±€é™æ€§<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ã€‚</a> <br><br><ol><li> åˆ›å»ºå®ƒä»¬åï¼Œæ‚¨å°†æ— æ³•å°†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">DDL</a>å‘½ä»¤åº”ç”¨äºä¸»è¡¨æˆ–å†å²è¡¨ã€‚ è€Œä¸”æ‚¨ä¸èƒ½åˆ é™¤<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ—¶é—´è¡¨</a> </li><li> æ‚¨æ— æ³•æ›´æ”¹å†å²è¡¨ä¸­çš„æ•°æ® </li></ol><br> ç¬¬äºŒä¸ªé™åˆ¶é€‚åˆæˆ‘ä»¬ï¼Œä½†æ˜¯ç¬¬ä¸€ä¸ªé™åˆ¶æ€ä¹ˆåŠï¼Ÿ <br><br> ç®—æ³•å¦‚ä¸‹ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--        ALTER TABLE dbo.VersionControl SET ( SYSTEM_VERSIONING = OFF ); /* -  */ --    : ALTER TABLE dbo.VersionControl SET ( SYSTEM_VERSIONING = ON ( HISTORY_TABLE = dbo.VersionControlHistory, DATA_CONSISTENCY_CHECK = OFF );</span></span></code> </pre><br> å°½ç®¡è¡¨ä¸Šè¿˜æ²¡æœ‰ç´¢å¼•ï¼Œä½†ç”¨æˆ‘ä»¬çš„è¿‡ç¨‹ï¼Œå‡½æ•°ç­‰å¡«å……å®ƒï¼Œå¹¶æ ‡è®°ä¸º<b>INIT</b> ï¼Œå¯¹äºæˆ‘ä»¬è€Œè¨€ï¼Œè¿™æ„å‘³ç€åˆå§‹æ”¾ç½® <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">query</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>), @<span class="hljs-keyword"><span class="hljs-keyword">template</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = N<span class="hljs-string"><span class="hljs-string">' USE [db] INSERT INTO MASTER.dbo.VersionControl WITH (TABLOCKX) ( Event, Db, Sch, Object, Sql, Login ) SELECT ''INIT'' AS Event, DB_NAME(), ss.name AS Sch, so.name AS Object, CONCAT(''&lt;query&gt;&lt;![CDATA['', sasm.definition, '']]&gt;&lt;/query&gt;'' ), SUSER_SNAME() AS Login FROM sys.objects AS so JOIN sys.schemas AS ss ON ss.schema_id = so.schema_id JOIN sys.all_sql_modules AS sasm ON sasm.object_id = so.object_id WHERE so.is_ms_shipped = 0 AND NOT EXISTS ( SELECT 1 FROM MASTER.dbo.VersionControl AS vc WHERE vc.Db = ''[db]'' AND vc.Sch = ss.name AND vc.Object = so.name ); '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (rn <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Name</span></span> sysname); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span> (rn, <span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ROW_NUMBER() <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> rn, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.databases <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> owner_sid != <span class="hljs-number"><span class="hljs-number">0x01</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @i <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">max</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(rn) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>), @<span class="hljs-keyword"><span class="hljs-keyword">error</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>), @db sysname; WHILE @i &lt; @max <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">query</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span>(@<span class="hljs-keyword"><span class="hljs-keyword">template</span></span>, <span class="hljs-string"><span class="hljs-string">'[db]'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>), @db = <span class="hljs-keyword"><span class="hljs-keyword">Name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> rn = @i; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_executesql @<span class="hljs-keyword"><span class="hljs-keyword">query</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @i += <span class="hljs-number"><span class="hljs-number">1</span></span>; CONTINUE; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">error</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>( <span class="hljs-string"><span class="hljs-string">'XML Parsing error. In this case that''s mean one of ['</span></span>, @db, <span class="hljs-string"><span class="hljs-string">'] object is invalid for convert to XML'</span></span> ); PRINT @error; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @i += <span class="hljs-number"><span class="hljs-number">1</span></span>; CONTINUE; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; GO</code> </pre><br> å› ä¸º å¯¹å¯¹è±¡çš„æ›´æ”¹å°†é€šè¿‡<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">UPDATEè¯­å¥è¿›è¡Œ</a> ï¼Œå¹¶ä¸”æˆ‘ä»¬é€šå¸¸ä¼šæŒ‰é”®æŸ¥çœ‹ç‰ˆæœ¬ï¼šæ•°æ®åº“ï¼Œæ¨¡å¼å’Œå¯¹è±¡çš„åç§°ï¼Œç´¢å¼•éƒ½æ˜¯ä¹æ±‚ï¼ <br><br><pre> <code class="sql hljs">IF NOT EXISTS ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.indexes <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = <span class="hljs-string"><span class="hljs-string">'IX_VersionControl_upd_key'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> NONCLUSTERED <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> IX_VersionControl_upd_key <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> MASTER.dbo.VersionControl (Db, Sch, <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INCLUDE</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Sql</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Event</span></span>, Login);</code> </pre><br> ä¸€åˆ‡å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¼€å§‹å­˜å‚¨ç‰ˆæœ¬ï¼Œå¹¶å°†é€šè¿‡æ­¤<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">DDL Trigger</a>å¸®åŠ©æˆ‘ä»¬ <br><br>  <b>é‡è¦ï¼</b> å› ä¸º ç‰ˆæœ¬è¡¨ä½äº<b>master</b>æ•°æ®åº“ä¸­ï¼Œåˆ›å»ºè§¦å‘å™¨åï¼Œæ¯ä¸ªå¯¹æ­¤æ•°æ®åº“æ²¡æœ‰æƒé™çš„äººéƒ½æ— æ³•ä¿®æ”¹ï¼Œåˆ›å»ºæˆ–åˆ é™¤å¯¹è±¡ <br><br><pre> <code class="sql hljs">IF EXISTS ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.server_triggers <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = <span class="hljs-string"><span class="hljs-string">'tr_VersionControl'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> tr_VersionControl <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SERVER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> tr_VersionControl <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SERVER</span></span> <span class="hljs-comment"><span class="hljs-comment">--WITH ENCRYPTION --   /*      : https://docs.microsoft.com/ru-ru/sql/relational-databases/triggers/ddl-events?view=sql-server-2017 */ FOR CREATE_TABLE, ALTER_TABLE, DROP_TABLE, CREATE_VIEW, ALTER_VIEW, DROP_VIEW, CREATE_FUNCTION, ALTER_FUNCTION, DROP_FUNCTION, CREATE_PROCEDURE, ALTER_PROCEDURE, DROP_PROCEDURE, CREATE_ASSEMBLY, ALTER_ASSEMBLY, DROP_ASSEMBLY, CREATE_INDEX, ALTER_INDEX, DROP_INDEX, CREATE_TRIGGER, ALTER_TRIGGER, DROP_TRIGGER, RENAME AS BEGIN SET NOCOUNT ON; UPDATE vs SET vs.Event = ev.EventType, vs.Sql = CONCAT('&lt;query&gt;&lt;!CDATA', ev.Sql, '&gt;&lt;/query&gt;' ), vs.Login = ev.Login FROM MASTER.dbo.VersionControl AS vs JOIN ( SELECT * FROM ( VALUES ( EVENTDATA().value( '(/EVENT_INSTANCE/EventType)[1]', 'NVARCHAR(128)' ), EVENTDATA().value( '(/EVENT_INSTANCE/SchemaName)[1]', 'NVARCHAR(128)' ), EVENTDATA().value( '(/EVENT_INSTANCE/ObjectName)[1]', 'NVARCHAR(128)' ), EVENTDATA().value( '(/EVENT_INSTANCE/TSQLCommand/CommandText)[1]', 'NVARCHAR(MAX)' ), EVENTDATA().value( '(/EVENT_INSTANCE/LoginName)[1]', 'NVARCHAR(128)' ) )) AS Event (EventType, Sch, Object, Sql, Login ) ) ev ON vs.Db = DB_NAME() AND vs.Sch = ev.Sch AND vs.Object = ev.Object ; END GO</span></span></code> </pre><br> å¹¶ä¸”ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨è¯¥ç³»ç»Ÿï¼Œæå‡ºäº†ä»¥ä¸‹æ­¥éª¤ã€‚ <br><br> æ˜“äºä½¿ç”¨ã€‚ å‰ç¼€<b>sp_</b>å°†å¸®åŠ©æˆ‘ä»¬åœ¨ä¸æŒ‡å®šæ•°æ®åº“å’Œæ¶æ„çš„æƒ…å†µä¸‹è®¿é—®è¯¥è¿‡ç¨‹ã€‚ å‚æ•°ç›´è§‚åœ°å¡«å……ã€‚ æ‚¨å¯ä»¥ä»…æŒ‡å®šæ•°æ®åº“ï¼Œå¹¶ä¸”åœ¨æ•´ä¸ªæ—¶é—´å†…æˆ‘ä»¬åªä¼šçœ‹åˆ°ä¸ä¹‹å…³è”çš„å¯¹è±¡ï¼Œä½†æ˜¯æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨æ–¹æ¡ˆï¼Œå¯¹è±¡æœ¬èº«ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨è¿›è¡Œæ›´æ”¹çš„æ—¶é—´èŒƒå›´ã€‚ <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> dbo.sp_Vc @db sysname = <span class="hljs-string"><span class="hljs-string">'%'</span></span>, @sch sysname = <span class="hljs-string"><span class="hljs-string">'%'</span></span>, @obj sysname = <span class="hljs-string"><span class="hljs-string">'%'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> DATETIME2(<span class="hljs-number"><span class="hljs-number">0</span></span>) = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">to</span></span> DATETIME2(<span class="hljs-number"><span class="hljs-number">0</span></span>) = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; IF @from IS NULL AND @to IS NULL <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> master.dbo.VersionControl <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> Db <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> @db <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> Sch <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> @sch <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> @obj <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> StartDate <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> master.dbo.VersionControl <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> SYSTEM_TIME <span class="hljs-keyword"><span class="hljs-keyword">BETWEEN</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> Db <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> @db <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> Sch <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> @sch <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> @obj <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> StartDate <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre><br> ä»¥ä¸‹æ˜¯ä½¿ç”¨è¯¥ç¨‹åºçš„ç¤ºä¾‹ <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--        sp_Vc; /*          */ sp_Vc 'dwh'; /*            */ sp_Vc 'dwh', 'dbo'; /*      ,        */ sp_Vc 'dwh', 'dbo', 'MyObject'; /*      , ,       1-  9-  */ sp_Vc 'dwh', 'dbo', 'MyObject', '20180501 00:00:00', '20180509 00:00:00';</span></span></code> </pre><br> æ‚¨å¯ä»¥ä»æˆ‘çš„<a href="">å­˜å‚¨åº“ä¸­</a>å®‰è£…æ­¤å¾®æ¡†æ¶ï¼Œå¦‚æœæ‚¨çš„SQL Severç‰ˆæœ¬ä½äº2016ï¼Œåˆ™æ‚¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨è¿™é‡Œ</a> ã€‚ é¡ºä¾¿è¯´ä¸€å¥ï¼Œæˆ‘ä»¬ç°åœ¨æ­£åœ¨ä½¿ç”¨æ­¤ç‰ˆæœ¬ï¼Œä½†æ˜¯å®ƒå¹¶ä¸é‚£ä¹ˆé…·ã€‚ <br><br><h3> æ€»ç»“ </h3><br> æˆ‘ä»æ¥æ²¡æœ‰æƒ³è¿‡å¾—å‡ºç»“è®º<b>_gt;</b> å’Œ<b>ï¼†_lt;</b> è€Œä¸æ˜¯<b>Sql</b>å­—æ®µçš„<b>master.dbo.VersionControl</b>è¡¨ä¸­çš„ç¬¦å·<b>&gt;</b>å’Œ<b>&lt;</b> ã€‚ å¦‚æœæ‚¨å¯ä»¥æä¾›å¸®åŠ©æˆ–æœ‰ä»»ä½•æƒ³æ³•ï¼Œæˆ‘æ­£åœ¨ç­‰å¾…<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¯·æ±‚è¯·æ±‚</a> ã€‚ <br><br> è°¢è°¢æ‚¨çš„æ—¶é—´ï¼Œæ”¾æ˜Ÿæ˜Ÿï¼Œå¿ƒå’Œå‘ä¸Šç®­å¤´ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN419919/">https://habr.com/ru/post/zh-CN419919/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN419907/index.html">æ‰‹æœºæ¸¸æˆå‘å¸ƒæç¤ºï¼šç¬¬2éƒ¨åˆ†ï¼Œå…¨çƒå‘å¸ƒ</a></li>
<li><a href="../zh-CN419911/index.html">ä½¿ç”¨Pythonå»ºç«‹å¤©ä½“çš„è½¨é“</a></li>
<li><a href="../zh-CN419913/index.html">å®œå®¶å’Œæ™ºèƒ½å®¶å±…ã€‚ ç¬¬äºŒéƒ¨åˆ†</a></li>
<li><a href="../zh-CN419915/index.html">initramfsä¸­çš„ç»‘å®šå’ŒSSHæœåŠ¡å™¨</a></li>
<li><a href="../zh-CN419917/index.html">ç¥ç»ç½‘ç»œï¼šåœ¨Tensor Flowå’ŒPythonä¸Šå®ç°æœ‰å…³è˜‘è‡çš„ä»»åŠ¡çš„å®ç°</a></li>
<li><a href="../zh-CN419921/index.html">å¦‚ä½•æ¯ç§’ä¸¢å¼ƒ1000ä¸‡ä¸ªæ•°æ®åŒ…</a></li>
<li><a href="../zh-CN419923/index.html">æˆ‘çš„ä¸´æ—¶å·¥ä½œï¼Œä¸»æ¿æ‰‹è¡¨</a></li>
<li><a href="../zh-CN419925/index.html">ä½¿ç”¨GitHub Gistå¯¹å•ä¸ªæ–‡ä»¶è¿›è¡Œç‰ˆæœ¬æ§åˆ¶</a></li>
<li><a href="../zh-CN419927/index.html">[DotNetBook]ä¾‹å¤–ï¼šç±»å‹ç³»ç»Ÿä½“ç³»ç»“æ„</a></li>
<li><a href="../zh-CN419929/index.html">[DotNetBook]å¼‚å¸¸äº‹ä»¶ä»¥åŠå¦‚ä½•ä»å¤´è·å–StackOverflowå’ŒExecutionEngineException</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>