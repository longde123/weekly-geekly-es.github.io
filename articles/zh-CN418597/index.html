<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎆 🚷 ☠️ 记录PostgreSQL数据库的功能。 第三部分 🚶 🦃 🚿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="这是本文的第三部分，描述了用于处理系统目录的用户定义函数：pg_class，pg_attribute，pg_constraints等。 

 本文的本节讨论返回序列特征，继承的表以及表属性的特殊特征的函数。 



 另请参阅 
 记录PostgreSQL数据库的功能。 第一部分 ; 
 记录Pos...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>记录PostgreSQL数据库的功能。 第三部分</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/418597/"> 这是本文的第三部分，描述了用于处理系统目录的用户定义函数：pg_class，pg_attribute，pg_constraints等。 <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zc/rx/ta/zcrxta08dnfat5cqpgid4lyq7by.png"></div><br> 本文的本节讨论返回<b>序列特征，继承的表</b>以及<b>表属性</b>的<b>特殊特征的</b>函数。 <br><a name="habracut"></a><br><p>  <b>另请参阅</b> <br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">记录PostgreSQL数据库的功能。</a></b>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第一部分</a> ;</b> <br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">记录PostgreSQL数据库的功能。</a></b>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第二部分</a> ;</b> <br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">记录PostgreSQL数据库的功能。</a></b>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">最后（第四部分）</a> 。</b> <br><br> 本文的前半部分提供了有关功能实现的评论。 第二个是函数的源代码。 对于只对源文本感兴趣的读者，我们建议立即继续阅读<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">附录</a> 。 <br><br></p><h3> 返回表序列特征列表的函数的结构 </h3><br><img src="https://habrastorage.org/webt/i6/dw/f_/i6dwf_jd0ofjr-vqmeide0l1vws.png"><br>  <i>图</i>  <i>2. admtf_Table_Sequences函数所依赖的函数</i> <br><br>  <strong>表11.功能用途</strong> <br><br><table width="95" border="1"><tbody><tr><th width="5"> 不行 </th><th width="10"> 职称 </th><th width="40"> 预约时间 </th></tr><tr><td width="5">  1个 </td><td width="10">  admtf_Sequence_Features </td><td width="40"> 该函数返回表序列特征的列表。 </td></tr><tr><td width="5">  2 </td><td width="10">  admtf_Table_Sequences </td><td width="40"> 该函数返回数据库表序列及其特征的列表。 </td></tr></tbody></table><br><h3>  <b>Admtf_Sequence_Features</b>函数-数据库序列特征列表 </h3><br><a name="tfSeqF_def"></a><p>  admtf_Sequence_Features函数返回数据库SEQUENCE特征的列表。  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">可以在此处查看和下载源代码</a> 。 </p><br><p>  <b>admtf_Sequence_Features</b>函数返回数据库序列特征的列表（ <b>SEQUENCE</b> ） </p>  。 <br><p> 作为参数，该函数采用序列的名称（ <b>a_SequenceName</b> ）和在其中创建序列的方案的名称（ <b>a_SchemaName</b> ）。 </p><br><p> 之所以需要<b>admtf_Sequence_Features</b>函数，是因为该序列的主要特征实际上存储在名称与序列名称匹配的表中，并且使用<b>SELECT语句</b>从中提取数据。 在这种情况下，序列的名称，方案的名称以及对该序列的注释存储在<b>pg_class</b> ， <b>pg_namespace</b>和<b>pg_description目录中</b> 。 </p><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> kr_road_network_vertices_pgr_id_seq;</code> </pre> <br><p>  <b><i>备注6</i></b> </p><br><p>  <b>PostgreSQL</b> 10分离了序列的特征及其状态的特征。 为此， <b>引入了</b>具有序列特征的<b>pg_sequence</b>目录，其中包含序列的初始值（ <b>start_value</b> ），增量（ <b>crement_by</b> ）和最大值（ <b>max_value</b> ）。 序列返回的最后一个值（ <b>last_value</b> ）保留在“表”中，并带有序列的名称。 </p><p></p><p>  <strong>备注的结尾。</strong> </p><br><p> 我认为，将每个序列表示为表的类似物是由需要存储序列的最后使用值（ <b>last_value</b> ）决定的，该值是序列状态的特征，而不是序列本身。 </p><br><p>  <b>pg_class</b>目录中的序列条目与表条目的区别在于关系类型的值（relkind = <font color="red">'S'</font> ）。 </p><br><p> 为了提取任意序列的特征，您必须使用动态SQL。 </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-string"><span class="hljs-string">'SELECT last_value,start_value,increment_by,max_value FROM '</span></span>|| <span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_SchemaName)||<span class="hljs-string"><span class="hljs-string">'.'</span></span>||<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_SequenceName) <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> v_SequenceLastValue,v_SequenceStartValue, v_SequenceIncrementBy,v_SequenceMaxValue ;</code> </pre><br><br>  <strong>表12.执行admtf_Sequence_Features函数（“ public”，“ kr_road_network_vertices_pgr_id_seq”）的结果。</strong> <br><br><table width="25"><tbody><tr><th width="5"> 职称 </th><th width="5"> 评注 </th><th width="10"> 现时 </th><th width="5"> 开始 </th><th width="5"> 增量式 </th><th width="10"> 结束 </th></tr><tr><td width="15">  kr_road_network <br>  _vertices_pgr_id <br>  _seq </td><td width="20"> 顺序 </td><td width="10">  138023 </td><td width="5">  1个 </td><td width="5">  1个 </td><td width="10">  9223372036854775807 </td></tr></tbody></table><br><h3> 数据库表序列及其特征的功能admtf_Table_Sequences列表 </h3><br><a name="tfTableS_def"></a><p>  <b>admtf_Table_Sequences</b>函数返回数据库表的序列列表（ <b>SEQUENCE</b> ），生成其字段值和这些序列的特征。  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">可以在此处查看和下载源代码</a> ， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">这是不使用游标的函数的版本</a> 。 </p><br><p> 作为参数，该函数采用源表的名称（ <b>a_TableName</b> ）和在其中创建表的方案的名称（ </p><p>  a_SchemaName </p>  ） <br><img src="https://habrastorage.org/webt/io/cc/ib/ioccibem_rgf_rjzsnmd5va1xt0.png"><br><div class="spoiler">  <b class="spoiler_title">图中操作员的源代码</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> pseq.relname <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> SequenceName,snsp.nspname <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> SequenceSchemaName, <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(dsc.description,<span class="hljs-string"><span class="hljs-string">',    '</span></span> ||da.attname) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> SequenceDescription, d.depType <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> DependcyType,da.attname <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> AttributeName <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_depend d <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_class pseq <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> d.objid = pseq.oid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_namespace snsp <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> pseq.relnamespace=snsp.oid <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_Description dsc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> pseq.oid=dsc.objoid <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> dsc.objsubid=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_class tbl <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> d.refobjid = tbl.oid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_namespace nsp <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> tbl.relnamespace=nsp.oid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_attribute da <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> da.attrelid= d.refobjid <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> da.attnum= d.refobjsubid <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(nsp.nspname)=<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_SchemaName) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(tbl.relname)=<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_TableOID) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> tbl.relkind = <span class="hljs-string"><span class="hljs-string">'r'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> pseq.relkind = <span class="hljs-string"><span class="hljs-string">'S'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> pseq.relname;</code> </pre><br></div></div><br><p> 单个序列的描述是<b>pg_class</b>中的记录的组合，该记录将其描述为物理关系，条件表的序列名称包含有关序列特定特征的数据 </p><br><p> 有关序列和源表之间关系的信息存储在<b>pg_depend</b>系统目录中。 </p><br><br>  <strong>表13.实现该功能所需的<b>pg_depend</b>目录的属性。</strong> <br><table width="25"><tbody><tr><th width="5"> 职称 </th><th width="5"> 内容描述 </th></tr><tr><td width="10"> 对象 </td><td width="20">  pg_class目录中序列的OID </td></tr><tr><td width="10">  objsubid </td><td width="20"> 该字段包含零 </td></tr><tr><td width="10">  refobjid </td><td width="20"> 使用顺序字段的表的OID </td></tr><tr><td width="10">  refobjsubid </td><td width="20"> 表属性号，其值使用序列填充 </td></tr></tbody></table><br><p> 另外，该函数访问目录数据<b>pg_namespace</b>和<b>pg_description</b>以便提取序列和源表的图表和注释。 </p><br><p> 为了确定表的属性，该表的值使用序列填充，该函数在以下条件下访问<b>pg_attribute</b>目录： <b>attrelid = refobjid和attnum = refobjsubid</b> 。  （在这种情况下， <b>pg_depend</b>目录属性的名称显示在等号的右侧）。 </p><br><p> 通过调用<b>admtf_Sequence_Features</b>在循环中检索表序列的特殊特征。 之所以使用循环，是因为可以分配多个序列来填写表格的字段。 </p><br>  <strong>表14.执行admtf_Table_Sequences函数（“ public”，“ kr_road_network_vertices_pgr”）的结果。</strong> <br><br><table width="25"><tbody><tr><th width="5"> 职称 </th><th width="5"> 评注 </th><th width="5"> 开始 </th><th width="5"> 增量式 </th><th width="10"> 结束 </th><th width="10"> 领域 </th></tr><tr><td width="15">  kr_road_network <br>  _vertices_pgr_id <br>  _seq </td><td width="20"> 序列生成ID字段值 </td><td width="5">  1个 </td><td width="5">  1个 </td><td width="10">  9223372036854775807 </td><td width="10"> 编号 </td></tr></tbody></table><br><a name="tfTableS_woc_def"></a><h4> 没有光标的版本 </h4><br><p> 在版本低于10的<b>PostgreSQL</b>环境中，最有可能在不使用游标的情况下实现<b>admtf_Table_Sequences</b>函数。 <br> 但是版本10的幸运所有者可以很好地使用游标，因为 他们可以使用<b>pg_sequence</b>目录。 在这种情况下，可以使用单个<b>SELECT语句</b>检索序列的所有特征。 </p><br><p> 在给定的函数实现中，使用窗口函数<b>RANK（）OVER（PARTITION BY pseq.relname）</b> ，计算用于填充源表的序列的序列号。 </p><br><img src="https://habrastorage.org/webt/1z/qa/r7/1zqar7uba-68o2ya1l_o37ph5jc.png"><br><div class="spoiler">  <b class="spoiler_title">图中操作员的源代码</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RANK</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> pseq.relname) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> SequenceNo, pseq.relname <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> SequenceName,snsp.nspname <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> SequenceSchemaName, <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(dsc.description,<span class="hljs-string"><span class="hljs-string">',    '</span></span> ||da.attname) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> SequenceDescription, seq.seqstart <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> SequenceStartValue,seq.seqincrement <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> SequenceIncrementBy, seq.seqmax <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> SequenceMaxValue, d.depType <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> DependcyType,da.attname <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> AttributeName <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_depend d <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_class pseq <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> d.objid = pseq.oid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_sequence seq <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> seq.seqrelid= pseq.oid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_namespace snsp <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> pseq.relnamespace=snsp.oid <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_Description dsc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> pseq.oid=dsc.objoid <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> dsc.objsubid=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_class tbl <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> d.refobjid = tbl.oid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_namespace nsp <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> tbl.relnamespace=nsp.oid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_attribute da <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> da.attrelid= d.refobjid <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> da.attnum= d.refobjsubid <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(nsp.nspname)=<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_SchemaName) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(tbl.relname)=<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_TableOID) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> tbl.relkind = <span class="hljs-string"><span class="hljs-string">'r'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> pseq.relkind = <span class="hljs-string"><span class="hljs-string">'S'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> pseq.relname;</code> </pre><br></div></div><br><p>  <strong>备注7</strong> </p>  。 <br><p> 此版本的函数不返回序列（ <b>last_value</b> ）生成的最后一个值。 </p><p></p><p>  <strong>备注的结尾。</strong> </p><br><h3>  Admtf_Table_InheritanceChildrens函数-继承表的特征列表 </h3><br><a name="tfTableIC_def"></a><p>  <b>admtf_Table_InheritanceChildrens</b>函数返回数据库表的继承表（ <b>INHERITS</b> ）的特征列表。  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">可以在此处查看和下载源代码</a> 。 </p><br><p> 该函数将源表的名称（ <b>a_TableName</b> ）和在其中创建表的方案的名称（ <b>a_SchemaName</b> ）作为参数。 </p><br><p> 单个旧表的描述在<b>pg_class</b>的条目中。 但是<b>要按</b>源表的名称搜索继承的表，必须使用<b>pg_depend</b>系统目录。 </p><br>  <strong>表15.实现该功能所需的<b>pg_depend</b>目录的属性。</strong> <br><table width="25"><tbody><tr><th width="5"> 职称 </th><th width="5"> 内容描述 </th></tr><tr><td width="10"> 对象 </td><td width="20">  pg_class目录中继承表的OID </td></tr><tr><td width="10">  refobjid </td><td width="20"> 源表的OID </td></tr></tbody></table><br><img src="https://habrastorage.org/webt/pa/ew/kl/paewklf4g7qvftdb99sss0efwqc.png"><br><div class="spoiler">  <b class="spoiler_title">图中操作员的源代码</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> rtbl.relname,rnspc.nspname,rdsc.description,rtbl.relnatts::<span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>, rtbl.relchecks::<span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>, rtbl.relhaspkey,rtbl.relhasindex,rtbl.relhassubclass, rtbl.reltuples::<span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_class tbl <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_namespace nspc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> tbl.relnamespace = nspc.oid <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_Description dsc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> tbl.oid=dsc.objoid <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> dsc.objsubid=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_depend dp <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> tbl.oid=dp.refobjid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_class rtbl <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> rtbl.OID=dp.objid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_namespace rnspc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> rtbl.relnamespace = rnspc.oid <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_Description rdsc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> rtbl.oid=rdsc.objoid <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> rdsc.objsubid=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(nspc.nspname)=<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_SchemaName) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(tbl.relname)=<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_TableOID) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> tbl.relkind = <span class="hljs-string"><span class="hljs-string">'r'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> rtbl.relkind = <span class="hljs-string"><span class="hljs-string">'r'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> rtbl.relname;</code> </pre><br></div></div><br><p> 另外，该函数访问目录数据<b>pg_namespace</b>和<b>pg_description</b>以便为继承表和源表提取模式和注释。 </p><br>  <strong>表16.执行函数admtf_Table_InheritanceChildrens（“ public”，“ np_house”）的结果。</strong> <br><br><table width="95" border="1"><tbody><tr><th width="10"> 职称 </th><th width="20"> 评注 </th><th width="5"> 属性 </th><th width="5">  ？ 主键 </th><th width="5">  ？ 指标 </th><th width="5">  ？ 后裔 </th><th width="5"> 记录数 </th></tr><tr><td width="10">  np_house 04201 000000 </td><td width="20"> 定居点的房屋（阿钦斯基区） </td><td width="5">  15 </td><td width="5">  ˚F </td><td width="5">  ˚F </td><td width="5">  ˚F </td><td width="5">  5651 </td></tr><tr><td width="10">  np_house 4208 000 000 </td><td width="20"> 定居点的房屋（波哥大斯基区） </td><td width="5">  15 </td><td width="5">  ˚F </td><td width="5">  ˚F </td><td width="5">  ˚F </td><td width="5">  4314 </td></tr></tbody></table><br><p> 从pg_class目录的reltuple属性中选择生成的表中的记录数。 尽管此值通常与表中的实际条目数完全匹配，但它仍然是估计值。 因此，您可能想要获得确切的结果。 例如，如图所示。 </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-string"><span class="hljs-string">'SELECT COUNT(*) FROM '</span></span>||<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_SchemaName)||<span class="hljs-string"><span class="hljs-string">'.'</span></span>||<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_TableName) <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> v_TableNumberOfRowCalc;</code> </pre><br><p> 但是，首先，为了在文本中实现该语句，函数<b>admtf_Table_InheritanceChildrens</b>将必须使用游标。 </p><br><p> 其次，我希望该功能同时显示表条目的估计数量和确切数量。 </p><br><p> 因此，该函数具有另一个可选参数-获取表条目数的模式（ <b>a_Mode</b> ），该模式采用值“ estimate”（ <font color="red">估计</font> ）或“ exactly”（ <font color="red">精确</font> ）。 </p><br><a name="fnTableRC_def"></a><br><p> 此外，还<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">创建</a>了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">admfn_Table_RowCount</a>函数，该函数返回表条目的准确数量，并且reltuple属性在<b>SELECT</b>返回列表中被替换为以下结构。 </p><br><img src="https://habrastorage.org/webt/3f/t_/xf/3ft_xftbnboqxguantdpivkdtva.png"><br><div class="spoiler">  <b class="spoiler_title">图中操作员的源代码</b> <div class="spoiler_text"><pre> <code class="sql hljs">CASE WHEN a_Mode = 'exactly' THEN admfn_Table_RowCount(rnspc.nspname,rtbl.relname) ELSE reltuples <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br></div></div><br><p> 结果，如果参数<b>a_Mode</b>没有<b>指定</b>返回精确值<b>的</b>要求，则该函数返回指标“表条目数”的估计值。 </p><br><h3> 返回表属性特征列表的函数的结构 </h3><br><img src="https://habrastorage.org/webt/hi/du/at/hiduatp-_vtmifufs_u53_roz2q.png"><br>  <i>图</i>  <i>3. admtf_Attribute_Features调用的函数</i> <br><img src="https://habrastorage.org/webt/ip/3e/rx/ip3erx3a2sj9_kkoeriysoppfom.png"><br><div class="spoiler">  <b class="spoiler_title">图中表格的文本版本</b> <div class="spoiler_text">  <strong>表17.功能目的。</strong> <br><br><table width="95" border="1"><tbody><tr><th width="5"> 不行 </th><th width="10"> 职称 </th><th width="40"> 预约时间 </th></tr><tr><td width="5">  1个 </td><td width="10">  admtf_Attribute_PKFeatures </td><td width="40"> 该函数返回主键（PRIMARY KEY）中的属性存在属性，以及该键的一部分特性。 </td></tr><tr><td width="5">  2 </td><td width="10">  admtf_Attribute_FKFeatures </td><td width="40"> 该函数返回外键（FOREIGN KEY）中的属性存在属性，以及该键的一部分特性。 </td></tr><tr><td width="5">  3 </td><td width="10">  admtf_Attribute_Features </td><td width="40"> 该函数返回表属性特征的列表。 </td></tr></tbody></table><br></div></div><br><h3> 函数<b>admtf_Attribute_PKFeatures--</b>属性是否存在于主键中 </h3><br><a name="tfAttPK_def"></a><br><p>  <b>admtf_Attribute_PKFeatures</b>函数返回表的主键（PRIMARY KEY）中是否存在表属性的符号，如果存在，则该键中的序列号是多少，因为 主键可以是复合键。 <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">可以在此处查看和下载源代码</a> 。 </p><br><p> 该函数将源表的OID（ <b>a_TableOID</b> ）和其中所需属性的序列号（ <b>a_AttributeNo</b> ）作为参数。 </p><br><p> 该函数从<b>pg_constraint</b>目录<b>条目</b>中提取<b>所需的</b>数据，其中包含源表的（CONSTRAINT）约束，包括主键约束。 所需表的OID存储在<b>conrelid</b>字段中，主键描述存储在一条记录中，其中contype字段包含值<font color="red">``p'</font> </p>  。 <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> v_PKAttributeList,rs_isAttributePK conkey,<span class="hljs-built_in"><span class="hljs-built_in">ARRAY</span></span>[a_AttributeNo]&lt;@conkey <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_constraint c <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> c.contype=<span class="hljs-string"><span class="hljs-string">'p'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> c.conrelid=a_TableOID;</code> </pre><br><p> 以这种方式找到的<b>conkey</b>字段包含组成主键的属性编号数组。 因此，为了检查主键中source属性的存在，足以计算逻辑表达式<b>ARRAY [a_AttributeNo] &lt;@ conkey</b> 。 </p><br><p> 如果主键中存在该属性，则在循环中计算其序列号。 </p><br><h3> 函数<b>admtf_Attribute_FKFeatures-</b>外键中是否存在该属性 </h3><br><a name="tfAttFK_def"></a><br><p>  <b>admtf_Attribute_FKFeatures</b>函数返回表的一个或多个外键（FOREIGN KEY）中是否存在表属性的符号，如果存在，则在这些键中其序号是什么，因为 外键可以是复合键。 <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">可以在此处查看和下载源代码</a> 。 </p><br><p> 该函数将源表的OID（ <b>a_TableOID</b> ）和其中所需属性的序列号（ <b>a_AttributeNo</b> ）作为参数。 </p><br><p> 该函数从包含源表CONSTRAINT的<b>pg_constraint</b>目录<b>条目</b>中检索<b>所需的</b>数据，包括但不限于外键约束。 所需表的OID存储在<b>conrelid</b>字段中，主键描述存储在一条记录中，其中contype字段包含值<font color="red">“ f”</font> </p>  。 <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_constraint c <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> c.contype=<span class="hljs-string"><span class="hljs-string">'f '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> c.conrelid=a_TableOID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-built_in"><span class="hljs-built_in">ARRAY</span></span>[a_AttributeNo]&lt;@conkey <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> c.oid;</code> </pre><br><p> 以这种方式找到的<b>conkey</b>字段包含组成外键的属性号数组。 因此，为了检查外键中源属性的存在，只需计算逻辑表达式<b>ARRAY [a_AttributeNo] &lt;@ conkey即可</b> 。 </p><br><p> 如果该属性存在于外键中，则在循环中，在包含该属性的外键中形成其序列号的数组。 此外，表名称及其属性构成了另外两个数组，这些数组由source属性在包含该表的外键中引用。 </p><br><p> 通过从外键项的confrelid字段中检索的标识符（OID）从<b>pg_class</b>目录<b>项</b>中检索表名。 </p><br><p> 要获取外部表的属性名称，请使用字段中的序列号数组 </p><p>  key </p>  （其名称与上面的数组不同，字母为“ <b>f</b> ”）。 从该数组中提取与外部属性对应的外部表的属性的序列号。 通过外部表的属性的此序列号及其OID（位于pg_attribute目录中），可以找到用于描述属性的条目，并检索其名称。 <br><h3>  <b>Admtf_Attribute_Features</b>函数-表属性特征列表 </h3><br><a name="tfAttF_def"></a><p>  <b>admtf_Attribute_Features</b>函数返回以下表属性特征的列表。  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">可以在此处查看和下载源代码</a> 。 </p><br><img src="https://habrastorage.org/webt/tu/bz/me/tubzmeucr-nzriafiuufgbv31ew.png"><br><div class="spoiler">  <b class="spoiler_title">图中表格的文本版本</b> <div class="spoiler_text"><table width="95" border="1"><tbody><tr><th width="5"> 不行 </th><th width="10"> 职称 </th><th width="10"> 型式 </th><th width="40"> 预约时间 </th></tr><tr><td width="5">  1个 </td><td width="10">  AttributeName </td><td width="10"> 名 </td><td width="40"> 源属性的名称。 </td></tr><tr><td width="5">  2 </td><td width="10">  UserTypeName </td><td width="10">  VARCHAR（256） </td><td width="40"> 自定义来源属性类型 </td></tr><tr><td width="5">  3 </td><td width="10"> 类型名 </td><td width="10">  VARCHAR（256） </td><td width="40"> 源属性的基本类型 </td></tr><tr><td width="5">  4 </td><td width="10">  isNotNULL </td><td width="10"> 布兰 </td><td width="40">  ？ 空有效性 </td></tr><tr><td width="5">  5 </td><td width="10">  isAttributePK </td><td width="10"> 布兰 </td><td width="40">  ？ 参与PK </td></tr><tr><td width="5">  6 </td><td width="10"> 列PKNo </td><td width="10"> 小灵通 </td><td width="40">  PK中的属性序列号 </td></tr><tr><td width="5">  7 </td><td width="10"> 内容描述 </td><td width="10"> 文字 </td><td width="40"> 评论来源属性 </td></tr><tr><td width="5">  8 </td><td width="10">  isAttributeFK </td><td width="10"> 布兰 </td><td width="40">  ？ 参加FK </td></tr><tr><td width="5">  9 </td><td width="10">  FKeyName </td><td width="10"> 名字[] </td><td width="40"> 约束表名称的数组，其中定义了外键 </td></tr><tr><td width="5">  10 </td><td width="10"> 列号 </td><td width="10">  SMALLINT [] </td><td width="40"> 表的外键中的属性序列号数组 </td></tr><tr><td width="5">  11 </td><td width="10">  FKTableName </td><td width="10"> 名字[] </td><td width="40"> 外键引用的表的数组 </td></tr><tr><td width="5">  12 </td><td width="10">  FKTableColumnName </td><td width="10"> 名字[] </td><td width="40"> 外部表中与源属性相对应的属性名称数组 </td></tr></tbody></table><br></div></div><br><p> 该函数将源表的OID（ <b>a_TableOID</b> ）和其中所需属性的序列号（ <b>a_AttributeNo</b> ）作为参数。 <br> 从与输入参数的值相对应的<b>pg_attribute</b>目录<b>条目</b>中检索<b>AttributeName</b>和<b>isNotNULL字段</b>的值。 </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> attr.attname, attr.attnotnull <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_attribute <span class="hljs-keyword"><span class="hljs-keyword">attr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> attr.attrelid =a_TableOID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> attr.attnum=a_AttributeNo; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> rs_isAttributePK,rs_ColumnPKNo <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> admtf_Attribute_PKFeatures (a_TableOID,a_AttributeNo); <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> rs_isAttributeFK,rs_FKeyName,rs_ColumnFKNo, rs_FKTableName,rs_FKTableColumnName <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> admtf_Attribute_FKFeatures (a_TableOID,a_AttributeNo);</code> </pre><br><p>  <b>admtf_Attribute_PKFeatures</b>函数返回<b>isAttributePK</b>和<b>ColumnPKNo字段</b>的值。 </p><br><p>  <b>isAttributeFK</b> ， <b>FKeyName</b> ， <b>ColumnFKNo</b> ， <b>FKTableName</b> ， <b>FKTableColumnName字段的值</b>由<b>admtf_Attribute_FKFeatures</b>函数返回。 </p><br><p> 调用<b>admtf_Attribute_Features（（从pg_class中的SELECT OID，其中relname ='street'），2 :: SMALLINT）</b>将产生以下结果。 </p><br>  <strong>表18.执行函数admtf_Attribute_Features的结果</strong> <br><table width="95" border="1"><tbody><tr><th width="10">  AttributeName </th><th width="10">  UserTypeName </th><th width="10"> 类型名 </th><th width="10">  isNotNULL </th><th width="10">  isAttributePK </th><th width="10"> 列PKNo </th></tr><tr><td width="10"> 地区性 </td><td width="10"> 地区性 </td><td width="10"> 整数 </td><td> 整数 </td><td> 整数 </td><td width="2"> 整数 </td></tr></tbody></table><br><br><table width="95" border="1"><tbody><tr><th width="10"> 内容描述 </th><th width="10">  isAttributeFK </th><th width="10">  FKeyName </th><th width="10"> 列号 </th><th width="10">  FKTableName </th><th width="10">  FKTableColumnName </th></tr><tr><td width="10"> 社区ID </td><td width="10">  Ť </td><td width="10">  {fk_street_locality} </td><td>  {2} </td><td>  {locality} </td><td width="2">  {localityid} </td></tr></tbody></table><br><a name="Script2"></a><h2> 附录1.脚本 </h2><br><a name="tfSeqF"></a><h3> 创建admtf_Sequence_Features函数 </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">有关功能源代码的注释，请参见此处。</a> <br><div class="spoiler">  <b class="spoiler_title">功能码</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admtf_Sequence_Features (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,a_SequenceName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>); <span class="hljs-comment"><span class="hljs-comment">/****************************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     ,   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/****************************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_Sequence_Features (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'public'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_SequenceName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (rs_SequenceName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,rs_SequenceDescription <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>,rs_NumberOfAttribute <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>,rs_SequenceLastValue <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>, rs_SequenceStartValue <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>,rs_SequenceIncrementBy <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>,rs_SequenceMaxValue <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c_SequenceKind <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CHAR</span></span>:=<span class="hljs-string"><span class="hljs-string">'S'</span></span>; v_SequenceOID OID; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_SequenceName NAME; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_SequenceDescription TEXT; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_SequenceStartValue BIGINT; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_SequenceIncrementBy BIGINT; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_SequenceMaxValue BIGINT; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_SequenceLastValue BIGINT; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_SequenceNumberOfRowCalc INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-comment"><span class="hljs-comment">--************************************************************************ BEGIN SELECT INTO rs_SequenceName,rs_SequenceDescription,rs_NumberOfAttribute tbl.relname, COALESCE(dsc.description,'') AS r_SequenceDescription, tbl.relnatts::INTEGER,tbl.relchecks::INTEGER,tbl.relhaspkey, tbl.relhasindex,tbl.relhassubclass,tbl.reltuples::INTEGER FROM pg_class tbl INNER JOIN pg_namespace nspc ON tbl.relnamespace = nspc.oid LEFT OUTER JOIN pg_Description dsc ON tbl.oid=dsc.objoid AND dsc.objsubid=0 WHERE nspc.nspname=LOWER(a_SchemaName) AND tbl.relkind=c_SequenceKind AND tbl.relname =LOWER(a_SequenceName); IF FOUND THEN EXECUTE 'SELECT last_value,start_value,increment_by,max_value FROM '||LOWER(a_SchemaName)||'.'||LOWER(a_SequenceName) INTO v_SequenceLastValue,v_SequenceStartValue, v_SequenceIncrementBy,v_SequenceMaxValue ; RETURN QUERY SELECT rs_SequenceName,rs_SequenceDescription, rs_NumberOfAttribute,v_SequenceLastValue, v_SequenceStartValue,v_SequenceIncrementBy, v_SequenceMaxValue; END IF; RETURN; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_Sequence_Features(a_SchemaName NAME,a_SequenceName NAME) IS '    ,  '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; BEGIN TRANSACTION; DROP FUNCTION IF EXISTS admtf_Sequence_Features (a_SchemaName VARCHAR(256),a_SequenceName VARCHAR(256)); /****************************************************************************/ /*     ,   */ /****************************************************************************/ CREATE OR REPLACE FUNCTION admtf_Sequence_Features (a_SchemaName VARCHAR(256) default 'public', /*     */ a_SequenceName VARCHAR(256) default NULL /*   */ ) RETURNS TABLE (rs_SequenceName VARCHAR(256),rs_SequenceDescription TEXT, rs_NumberOfAttribute INTEGER,rs_SequenceLastValue BIGINT, rs_SequenceStartValue BIGINT,rs_SequenceIncrementBy BIGINT, rs_SequenceMaxValue BIGINT) AS $BODY$ DECLARE c_SequenceKind CONSTANT CHAR:='S'; --******************************************************** BEGIN RETURN QUERY SELECT sf.rs_SequenceName::VARCHAR(256), sf.rs_SequenceDescription::TEXT, sf.rs_NumberOfAttribute::INTEGER, sf.rs_SequenceLastValue::BIGINT, sf.rs_SequenceStartValue::BIGINT, sf.rs_SequenceIncrementBy::BIGINT, sf.rs_SequenceMaxValue::BIGINT FROM admtf_Sequence_Features(a_SchemaName::NAME,a_SequenceName::NAME) sf; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_Sequence_Features(a_SchemaName VARCHAR(256),a_SequenceName VARCHAR(256)) IS '    ,  '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECT * FROM admtf_Sequence_Features('public'::VARCHAR(255),'k_dorogi_dijkstra_seq_seq'::VARCHAR(255)); SELECT * FROM admtf_Sequence_Features('public'::NAME,'kr_road_network_vertices_pgr_id_seq'::NAME);</span></span></code> </pre><br></div></div><br><a name="tfTableS"></a><br><h3> 创建admtf_Table_Sequences函数 </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">有关功能源代码的注释，请参见此处。</a> <br><div class="spoiler">  <b class="spoiler_title">功能码</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admtf_Table_Sequences (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>, a_TableName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*********************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    ,     */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*********************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_Table_Sequences (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'public'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_TableName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (r_SequenceNumber <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>,r_SequenceName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>, r_SequenceSchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,r_SequenceDescription <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>, r_SequenceStartValue <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>,r_SequenceIncrementBy <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>, r_SequenceMaxValue <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>,r_DependType <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>, r_RefTableName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,r_RefTableSchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>, r_RefAttributeName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> v_TableOID <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>;<span class="hljs-comment"><span class="hljs-comment">/* OID */</span></span> v_Sequence RECORD;<span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_SequenceOID INTEGER;<span class="hljs-comment"><span class="hljs-comment">/* OID */</span></span> v_SequenceName NAME; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_SequenceSchemaName NAME; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_SequenceDescription TEXT; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_SequenceStartValue BIGINT; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_SequenceIncrementBy BIGINT; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_SequenceMaxValue BIGINT; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_DependcyType NAME; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_AttributeName NAME; <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> v_SequenceNumber SMALLINT; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> c_Delimiter CONSTANT VARCHAR(2):=','; <span class="hljs-comment"><span class="hljs-comment">--********************************************************************* BEGIN v_SequenceNumber:=0; FOR v_Sequence IN SELECT pseq.relname AS SequenceName, snsp.nspname AS SequenceSchemaName, COALESCE(dsc.description,',    '||da.attname) AS SequenceDescription, d.depType AS DependcyType,da.attname AS AttributeName FROM pg_depend d INNER JOIN pg_class pseq ON d.objid = pseq.oid INNER JOIN pg_namespace snsp ON pseq.relnamespace=snsp.oid LEFT OUTER JOIN pg_Description dsc ON pseq.oid=dsc.objoid AND dsc.objsubid=0 INNER JOIN pg_class tbl ON d.refobjid = tbl.oid INNER JOIN pg_namespace nsp ON tbl.relnamespace=nsp.oid INNER JOIN pg_attribute da ON da.attrelid= d.refobjid AND d.refobjsubid=da.attnum WHERE tbl.relkind = 'r' AND pseq.relkind = 'S' AND LOWER(nsp.nspname)=LOWER(a_SchemaName) AND LOWER(tbl.relname)=LOWER(a_TableName) ORDER BY pseq.relname LOOP v_SequenceNumber:=v_SequenceNumber+1; v_SequenceName:=v_Sequence.SequenceName; v_SequenceSchemaName:=v_Sequence.SequenceSchemaName; v_DependcyType:=v_Sequence.DependcyType; v_AttributeName:=v_Sequence.AttributeName; v_SequenceDescription:=v_Sequence.SequenceDescription; SELECT INTO v_SequenceStartValue,v_SequenceIncrementBy, v_SequenceMaxValue rs_SequenceStartValue,rs_SequenceIncrementBy, rs_SequenceMaxValue FROM admtf_Sequence_Features(v_SequenceSchemaName,v_SequenceName); RETURN QUERY SELECT v_SequenceNumber,v_SequenceName, v_SequenceSchemaName,v_SequenceDescription, v_SequenceStartValue,v_SequenceIncrementBy, v_SequenceMaxValue,v_DependcyType, a_TableName,a_SchemaName,v_AttributeName; END LOOP; RETURN; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_Table_Sequences(a_SchemaName NAME, a_TableName NAME) IS '  ,    '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; BEGIN TRANSACTION; DROP FUNCTION IF EXISTS admtf_Table_Sequences (a_SchemaName VARCHAR(256), a_TableName VARCHAR(256)); /**********************************************************************/ /*    ,     */ /**********************************************************************/ CREATE OR REPLACE FUNCTION admtf_Table_Sequences (a_SchemaName VARCHAR(256) default 'public', /*     */ a_TableName VARCHAR(256) default NULL /*   */ ) RETURNS TABLE (r_SequenceNumber SMALLINT,r_SequenceName VARCHAR(256), r_SequenceSchemaName VARCHAR(256),r_SequenceDescription TEXT, r_SequenceStartValue BIGINT,r_SequenceIncrementBy BIGINT, r_SequenceMaxValue BIGINT,r_DependType VARCHAR(256), r_RefTableName VARCHAR(256),r_RefTableSchemaName VARCHAR(256), r_RefAttributeName VARCHAR(256)) AS $BODY$ DECLARE c_Delimiter CONSTANT VARCHAR(2):=','; --****************************************************** BEGIN RETURN QUERY SELECT ts.r_SequenceNumber::SMALLINT, ts.r_SequenceName::VARCHAR(256), ts.r_SequenceSchemaName::VARCHAR(256) , ts.r_SequenceDescription::TEXT, ts.r_SequenceStartValue::BIGINT, ts.r_SequenceIncrementBy::BIGINT, ts.r_SequenceMaxValue::BIGINT, ts.r_DependType::VARCHAR(256), ts.r_RefTableName::VARCHAR(256), ts.r_RefTableSchemaName::VARCHAR(256), ts.r_RefAttributeName::VARCHAR(256) FROM admtf_Table_Sequences(a_SchemaName::NAME,a_TableName::NAME) ts; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_Table_Sequences(a_SchemaName VARCHAR(256), a_TableName VARCHAR(256)) IS '  ,    '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECT * FROM admtf_Table_Sequences('public'::VARCHAR(255),'kr_road_network_vertices_pgr'::VARCHAR(255)); SELECT * FROM admtf_Table_Sequences('public'::NAME,'kr_road_network_vertices_pgr'::NAME);</span></span></code> </pre><br></div></div><br><a name="tfTableS_woc"></a><h3>   admtf_Table_Sequences   (PostgreSQL 10) </h3><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">       .</a> <br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admtf_Table_Sequences (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>, a_TableName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*********************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    ,     */</span></span> <span class="hljs-comment"><span class="hljs-comment">/**********************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_Table_Sequences (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'public'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_TableName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (r_SequenceNumber <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>,r_SequenceName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>, r_SequenceSchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,r_SequenceDescription <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>, r_SequenceStartValue <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>,r_SequenceIncrementBy <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>, r_SequenceMaxValue <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>,r_DependType <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>, r_RefTableName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,r_RefTableSchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>, r_RefAttributeName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> v_TableOID <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* OID */</span></span> v_Sequence RECORD; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_SequenceOID INTEGER; <span class="hljs-comment"><span class="hljs-comment">/* OID */</span></span> v_SequenceName NAME; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_SequenceSchemaName NAME; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_SequenceDescription TEXT; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_SequenceStartValue BIGINT; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_SequenceIncrementBy BIGINT; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_SequenceMaxValue BIGINT; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_DependcyType NAME; <span class="hljs-comment"><span class="hljs-comment">/*        */</span></span> v_AttributeName NAME; <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> v_SequenceNumber SMALLINT; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> c_Delimiter CONSTANT VARCHAR(2):=','; <span class="hljs-comment"><span class="hljs-comment">--****************************************************************** BEGIN v_SequenceNumber:=0; FOR v_Sequence IN SELECT pseq.relname AS SequenceName, snsp.nspname AS SequenceSchemaName, COALESCE(dsc.description,',    '||da.attname) AS SequenceDescription, d.depType AS DependcyType,da.attname AS AttributeName FROM pg_depend d INNER JOIN pg_class pseq ON d.objid = pseq.oid INNER JOIN pg_namespace snsp ON pseq.relnamespace=snsp.oid LEFT OUTER JOIN pg_Description dsc ON pseq.oid=dsc.objoid AND dsc.objsubid=0 INNER JOIN pg_class tbl ON d.refobjid = tbl.oid INNER JOIN pg_namespace nsp ON tbl.relnamespace=nsp.oid INNER JOIN pg_attribute da ON da.attrelid= d.refobjid ND d.refobjsubid=da.attnum WHERE tbl.relkind = 'r' AND pseq.relkind = 'S' AND LOWER(nsp.nspname)=LOWER(a_SchemaName) AND LOWER(tbl.relname)=LOWER(a_TableName) ORDER BY pseq.relname LOOP v_SequenceNumber:=v_SequenceNumber+1; v_SequenceName:=v_Sequence.SequenceName; v_SequenceSchemaName:=v_Sequence.SequenceSchemaName; v_DependcyType:=v_Sequence.DependcyType; v_AttributeName:=v_Sequence.AttributeName; v_SequenceDescription:=v_Sequence.SequenceDescription; SELECT INTO v_SequenceStartValue,v_SequenceIncrementBy,v_SequenceMaxValue rs_SequenceStartValue,rs_SequenceIncrementBy,rs_SequenceMaxValue FROM admtf_Sequence_Features(v_SequenceSchemaName,v_SequenceName); RETURN QUERY SELECT v_SequenceNumber,v_SequenceName, v_SequenceSchemaName,v_SequenceDescription, v_SequenceStartValue,v_SequenceIncrementBy, v_SequenceMaxValue,v_DependcyType, a_TableName,a_SchemaName,v_AttributeName; END LOOP; RETURN; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_Table_Sequences(a_SchemaName NAME, a_TableName NAME) IS '  ,    '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; BEGIN TRANSACTION; DROP FUNCTION IF EXISTS admtf_Table_Sequences (a_SchemaName VARCHAR(256), a_TableName VARCHAR(256)); /**********************************************************************/ /*    ,     */ /**********************************************************************/ CREATE OR REPLACE FUNCTION admtf_Table_Sequences (a_SchemaName VARCHAR(256) default 'public', /*     */ a_TableName VARCHAR(256) default NULL /*   */ ) RETURNS TABLE (r_SequenceNumber SMALLINT,r_SequenceName VARCHAR(256), r_SequenceSchemaName VARCHAR(256),r_SequenceDescription TEXT, r_SequenceStartValue BIGINT,r_SequenceIncrementBy BIGINT, r_SequenceMaxValue BIGINT,r_DependType VARCHAR(256), r_RefTableName VARCHAR(256),r_RefTableSchemaName VARCHAR(256), r_RefAttributeName VARCHAR(256)) AS $BODY$ DECLARE c_Delimiter CONSTANT VARCHAR(2):=','; --******************************************************* BEGIN RETURN QUERY SELECT ts.r_SequenceNumber::SMALLINT, ts.r_SequenceName::VARCHAR(256), ts.r_SequenceSchemaName::VARCHAR(256), ts.r_SequenceDescription::TEXT, ts.r_SequenceStartValue::BIGINT, ts.r_SequenceIncrementBy::BIGINT, ts.r_SequenceMaxValue::BIGINT, ts.r_DependType::VARCHAR(256), ts.r_RefTableName::VARCHAR(256), ts.r_RefTableSchemaName::VARCHAR(256), ts.r_RefAttributeName::VARCHAR(256) FROM admtf_Table_Sequences(a_SchemaName::NAME,a_TableName::NAME) ts; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_Table_Sequences(a_SchemaName VARCHAR(256), a_TableName VARCHAR(256)) IS '  ,    '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECT * FROM admtf_Table_Sequences('public'::VARCHAR(255), 'kr_road_network_vertices_pgr'::VARCHAR(255)); SELECT * FROM admtf_Table_Sequences('public'::NAME, 'kr_road_network_vertices_pgr'::NAME);</span></span></code> </pre><br></div></div><br><a name="fnTableRC"></a><br><h3>   admfn_Table_RowCount </h3><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">       .</a> <br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admfn_Table_RowCount (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,a_TableName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>); <span class="hljs-comment"><span class="hljs-comment">/******************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> <span class="hljs-comment"><span class="hljs-comment">/******************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admfn_Table_RowCount (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'public'</span></span>,<span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_TableName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> v_TableNumberOfRowCalc <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> v_Found BOOLEAN; <span class="hljs-comment"><span class="hljs-comment">--*********************************************************** BEGIN IF a_SchemaName ~ E'^[a-z_0-9]+$' AND a_TableName ~ E'^[a-z_0-9]+$' THEN EXECUTE 'SELECT count(*) FROM ' ||a_SchemaName ||'.'|| a_TableName INTO v_TableNumberOfRowCalc; ELSE SELECT INTO v_Found true FROM pg_class tbl INNER JOIN pg_namespace nspc ON tbl.relnamespace = nspc.oid WHERE tbl.relkind='r' AND tbl.relname=a_TableName AND nspc.nspname=a_SchemaName; IF FOUND THEN EXECUTE 'SELECT count(*) FROM ' || CASE WHEN a_SchemaName ~ E'^[a-z_0-9]+$' THEN a_SchemaName ELSE quote_ident(a_SchemaName) END ||'.'|| CASE WHEN a_TableName ~ E'^[a-z_0-9]+$' THEN a_TableName ELSE quote_ident(a_TableName) END INTO v_TableNumberOfRowCalc; ELSE SELECT INTO v_Found true FROM pg_class tbl INNER JOIN pg_namespace nspc ON tbl.relnamespace = nspc.oid WHERE tbl.relkind='r' AND LOWER(tbl.relname)= LOWER(a_TableName) AND nspc.nspname=LOWER(a_SchemaName); IF FOUND THEN EXECUTE 'SELECT count(*) FROM ' || a_SchemaName ||'.'||a_TableName INTO v_TableNumberOfRowCalc; END IF; END IF; END IF; RETURN v_TableNumberOfRowCalc; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admfn_Table_RowCount(a_SchemaName NAME,a_TableName NAME) IS '    '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION;BEGIN TRANSACTION; DROP FUNCTION IF EXISTS admfn_Table_RowCount (a_SchemaName VARCHAR(256),a_TableName VARCHAR(256)); /********************************************************************/ /*       */ /********************************************************************/ CREATE OR REPLACE FUNCTION admfn_Table_RowCount (a_SchemaName VARCHAR(256) default 'public',/*     */ a_TableName VARCHAR(256) default NULL /*   */ ) RETURNS BIGINT AS $BODY$ DECLARE v_TableNumberOfRowCalc BIGINT; /*  */ --********************************************************* BEGIN RETURN admfn_Table_RowCount(a_SchemaName::NAME,a_TableName::NAME); END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admfn_Table_RowCount(a_SchemaName VARCHAR(256),a_TableName VARCHAR(256)) IS '    '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECt admfn_Table_RowCount('public'::NAME,'Street'::NAME); SELECt admfn_Table_RowCount('public'::VARCHAR(256),'Street'::VARCHAR(256));</span></span></code> </pre><br></div></div><br><a name="tfTableIC"></a><h3>   admtf_Table_InheritanceChildrens </h3><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">       .</a> <br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admtf_Table_InheritanceChildrens (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,a_TableName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,a_Mode <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>)); <span class="hljs-comment"><span class="hljs-comment">/************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> <span class="hljs-comment"><span class="hljs-comment">/************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_Table_InheritanceChildrens (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'public'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_TableName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> a_Mode <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'estimate'</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (rs_TableName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,rs_TableDescription <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>, rs_NumberOfAttribute <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>,rs_NumberOfChecks <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>, rs_hasPKey <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span>,rs_hasIndex <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span>, rs_hasSubClass <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span>,rs_NumberOfRow <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c_TableKind <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CHAR</span></span>:=<span class="hljs-string"><span class="hljs-string">'r'</span></span>; c_ExactlyMode CONSTANT VARCHAR(10):='exactly'; c_EstimateMode CONSTANT VARCHAR(10):='estimate'; v_TableOID OID; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_SchemaName NAME; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_TableName NAME; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_TableDescription TEXT; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_TableNumberOfRowCalc INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_InheritanceRECORD RECORD; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_InheritanceOID OID; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">QUERY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> rtbl.relname,rdsc.description,rtbl.relnatts::<span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>, rtbl.relchecks::<span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>,rtbl.relhaspkey,rtbl.relhasindex, rtbl.relhassubclass, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> a_Mode=c_ExactlyMode <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> admfn_Table_RowCount(rnspc.nspname,rtbl.relname)::<span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> rtbl.reltuples::<span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_class tbl <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_namespace nspc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> tbl.relnamespace = nspc.oid <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_Description dsc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> tbl.oid=dsc.objoid <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> dsc.objsubid=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_depend dp <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> tbl.oid=dp.refobjid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_class rtbl <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> rtbl.OID=dp.objid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_namespace rnspc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> rtbl.relnamespace = rnspc.oid <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_Description rdsc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> rtbl.oid=rdsc.objoid <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> rdsc.objsubid=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> nspc.nspname=<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_SchemaName) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> tbl.relkind=c_TableKind <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> rtbl.relkind=c_TableKind <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> tbl.relname =<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_TableName) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> rtbl.relname; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> plpgsql; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_Table_InheritanceChildrens(a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,a_TableName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,a_Mode <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'    '</span></span>; <span class="hljs-comment"><span class="hljs-comment">--ROLLBACK TRANSACTION; COMMIT TRANSACTION; BEGIN TRANSACTION; DROP FUNCTION IF EXISTS admtf_Table_InheritanceChildrens (a_SchemaName VARCHAR(256),a_TableName VARCHAR(256),a_TableName NAME,a_Mode VARCHAR(10)); /************************************************************************/ /*       */ /************************************************************************/ CREATE OR REPLACE FUNCTION admtf_Table_InheritanceChildrens (a_SchemaName VARCHAR(256) default 'public',/*     */ a_TableName VARCHAR(256) default NULL,/*   */ a_Mode VARCHAR(10) default 'estimate' /*     */ ) RETURNS TABLE (rs_TableName VARCHAR(256),rs_TableDescription TEXT, rs_NumberOfAttribute INTEGER,rs_NumberOfChecks INTEGER, rs_hasPKey BOOLEAN,rs_hasIndex BOOLEAN, rs_hasSubClass BOOLEAN,rs_NumberOfRow INTEGER) AS $BODY$ DECLARE c_TableKind CONSTANT CHAR:='r'; BEGIN RETURN QUERY SELECT tic.rs_TableName::VARCHAR(256),tic.rs_TableDescription::TEXT, tic.rs_NumberOfAttribute::INTEGER,tic.rs_NumberOfChecks::INTEGER, tic.rs_hasPKey::BOOLEAN,tic.rs_hasIndex::BOOLEAN, tic.rs_hasSubClass::BOOLEAN,tic.rs_NumberOfRow::INTEGER FROM admtf_Table_InheritanceChildrens(a_SchemaName::NAME, a_TableName::NAME,a_Mode::VARCHAR(10)) tic; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_Table_InheritanceChildrens(a_SchemaName VARCHAR(256),a_TableName VARCHAR(256),a_Mode VARCHAR(10)) IS '    '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECT * FROM admtf_Table_InheritanceChildrens('public'::NAME,'np_house'::NAME); SELECT * FROM admtf_Table_InheritanceChildrens('public'::VARCHAR(256),'np_house'::VARCHAR(256));</span></span></code> </pre><br></div></div><br><a name="tfAttPK"></a><h3>   admtf_Attribute_PKFeatures </h3><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">       .</a> <br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admtf_Attribute_PKFeatures (a_TableOID <span class="hljs-keyword"><span class="hljs-keyword">OID</span></span>,a_AttributeNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>); <span class="hljs-comment"><span class="hljs-comment">/***************************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*        . */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   ,          */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/***************************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_Attribute_PKFeatures (a_TableOID <span class="hljs-keyword"><span class="hljs-keyword">OID</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> a_AttributeNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (rs_isAttributePK <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span>,rs_PKeyName <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>,rs_ColumnPKNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> C_PKAttributeList_NDims <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>:=<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_PKAttributeList SMALLINT[]; <span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> v_PKAttributeIndx INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> v_PKAttributeLBound INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> v_PKAttributeUBound INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> <span class="hljs-comment"><span class="hljs-comment">--********************************************************************** BEGIN rs_isAttributePK:=false; rs_ColumnPKNo:=NULL; SELECT INTO rs_PKeyName,v_PKAttributeList,rs_isAttributePK conname,conkey,ARRAY[a_AttributeNo]&lt;@conkey FROM pg_constraint c WHERE c.contype='p' and c.conrelid=a_TableOID; IF FOUND AND rs_isAttributePK THEN --      v_PKAttributeLBound:=array_lower(v_PKAttributeList,C_PKAttributeList_NDims); v_PKAttributeUBound:=array_upper(v_PKAttributeList,C_PKAttributeList_NDims); v_PKAttributeIndx:=v_PKAttributeLBound; WHILE v_PKAttributeIndx &lt;= v_PKAttributeUBound AND a_AttributeNo&lt;&gt;v_PKAttributeList[v_PKAttributeIndx] LOOP v_PKAttributeIndx:=v_PKAttributeIndx+1; END LOOP; IF v_PKAttributeIndx&lt;=v_PKAttributeUBound THEN rs_ColumnPKNo:=v_PKAttributeIndx; END IF; END IF; RETURN QUERY SELECT rs_isAttributePK,rs_PKeyName,rs_ColumnPKNo; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_Attribute_PKFeatures(a_TableOID OID,a_AttributeNo SMALLINT) IS '              '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECT * FROM admtf_Attribute_PKFeatures((SELECT OID FROM pg_class WHERE relname='street'),3::SMALLINT);</span></span></code> </pre><br></div></div><br><a name="tfAttFK"></a><h3>   admtf_Attribute_FKFeatures </h3><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">       .</a> <br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admtf_Attribute_FKFeatures (a_TableOID <span class="hljs-keyword"><span class="hljs-keyword">OID</span></span>,a_AttributeNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>); <span class="hljs-comment"><span class="hljs-comment">/****************************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*        . */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   ,         */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   . */</span></span> <span class="hljs-comment"><span class="hljs-comment">/****************************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/****************************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_Attribute_FKFeatures (a_TableOID <span class="hljs-keyword"><span class="hljs-keyword">OID</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> a_AttributeNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (rs_isAttributeFK <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span>,rs_FKeyName <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>[],rs_ColumnFKNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>[],rs_FKTableName <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>[],rs_FKTableColumnName <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>[]) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> C_FKAttributeList_NDims <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>:=<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_FKAttributeList SMALLINT[]; <span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> v_RefAttributeList SMALLINT[]; <span class="hljs-comment"><span class="hljs-comment">/*     , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_FKAttributeIndx INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> v_RefAttributeListIndx INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*     , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_FKAttributeLBound INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> v_FKAttributeUBound INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> v_FKConstraintIndx INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_FKeyName name; <span class="hljs-comment"><span class="hljs-comment">/*   , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_FKTableName name; <span class="hljs-comment"><span class="hljs-comment">/*  ,     */</span></span> v_FKTableColumnName name; <span class="hljs-comment"><span class="hljs-comment">/*    , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_RefAttributeNo SMALLINT; <span class="hljs-comment"><span class="hljs-comment">/*     , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_Constraint pg_constraint%ROWTYPE; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  (CONSTRANT) */</span></span> <span class="hljs-comment"><span class="hljs-comment">--****************************************************************************************************** BEGIN rs_isAttributeFK:=false; rs_ColumnFKNo:=NULL; v_FKConstraintIndx:=0; FOR v_Constraint IN SELECT * FROM pg_constraint c WHERE c.contype='f' and c.conrelid=a_TableOID AND ARRAY[a_AttributeNo]&lt;@conkey ORDER BY c.oid LOOP v_FKConstraintIndx:=v_FKConstraintIndx+1; rs_isAttributeFK:=true; v_FKeyName:=v_Constraint.conname; v_FKAttributeList:=v_Constraint.conkey; v_RefAttributeList:=v_Constraint.confkey; v_FKAttributeLBound:=array_lower(v_FKAttributeList,C_FKAttributeList_NDims); v_FKAttributeUBound:=array_upper(v_FKAttributeList,C_FKAttributeList_NDims); v_FKAttributeIndx:=v_FKAttributeLBound; WHILE v_FKAttributeIndx &lt;= v_FKAttributeUBound AND a_AttributeNo&lt;&gt;v_FKAttributeList[v_FKAttributeIndx] LOOP v_FKAttributeIndx:=v_FKAttributeIndx+1; END LOOP; rs_FKeyName[v_FKConstraintIndx]:=v_FKeyName; rs_ColumnFKNo[v_FKConstraintIndx]:=v_FKAttributeIndx; SELECT INTO v_FKTableName ftbl.relname FROM pg_class ftbl WHERE ftbl.oid=v_Constraint.confrelid; rs_FKTableName[v_FKConstraintIndx]:=v_FKTableName; v_RefAttributeNo:=v_RefAttributeList[v_FKAttributeIndx]; v_FKTableColumnName:=NULL; SELECT INTO v_FKTableColumnName attname FROM pg_attribute a WHERE a.attrelid=v_Constraint.confrelid AND a.attnum=v_RefAttributeNo; rs_FKTableColumnName[v_FKConstraintIndx]:=v_FKTableColumnName; END LOOP; RETURN QUERY SELECT rs_isAttributeFK,rs_FKeyName,rs_ColumnFKNo, rs_FKTableName,rs_FKTableColumnName; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_Attribute_FKFeatures(a_TableOID OID,a_AttributeNo SMALLINT) IS '              '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECT * FROM admtf_Attribute_FKFeatures((SELECT OID FROM pg_class WHERE relname='street'),4::SMALLINT);</span></span></code> </pre><br></div></div><br><a name="tfAttF"></a><br><h3>   admtf_Attribute_Features </h3><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">       .</a> <br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admtf_Attribute_Features (a_TableOID <span class="hljs-keyword"><span class="hljs-keyword">OID</span></span>,a_AttributeNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>); <span class="hljs-comment"><span class="hljs-comment">/****************************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> <span class="hljs-comment"><span class="hljs-comment">/****************************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_Attribute_Features (a_TableOID <span class="hljs-keyword"><span class="hljs-keyword">OID</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> a_AttributeNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span><span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (rsa_AttributeName <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>,rsa_UserTypeName <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>),rsa_TypeName <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>),rsa_isNotNULL <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span>,rsa_isAttributePK <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span>, rsa_ColumnPKNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>,rsa_Description <span class="hljs-built_in"><span class="hljs-built_in">Text</span></span>,rsa_isAttributeFK <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span>,rsa_FKeyName <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>[],rsa_ColumnFKNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>[],rsa_FKTableName <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>[],rsa_FKTableColumnName <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>[]) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> v_Return_Error <span class="hljs-built_in"><span class="hljs-built_in">Integer</span></span> := <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">--********************************************************************* BEGIN SELECT INTO rsa_AttributeName,rsa_UserTypeName,rsa_TypeName, rsa_isNotNULL,rsa_Description attr.attname, CASE WHEN COALESCE(typ.typbasetype,0)&gt;0 THEN typ.typname::VARCHAR(100) ELSE ''END AS r_UserTypeName, FORMAT_TYPE(COALESCE(NULLIF(typ.typbasetype,0),typ.oid), COALESCE(NULLIF(typ.typtypmod,-1),attr.atttypmod))::VARCHAR(256) AS r_TypeName, attr.attnotnull AS r_isNotNULL, dsc.description AS r_Description FROM pg_attribute attr LEFT OUTER JOIN pg_type typ ON attr.atttypid=typ.oid LEFT OUTER JOIN pg_type btyp ON typ.typbasetype=btyp.oid LEFT OUTER JOIN pg_description dsc ON dsc.objoid=attr.attrelid AND dsc.objsubid=attr.attnum WHERE attr.attrelid =a_TableOID AND attr.attnum=a_AttributeNo; SELECT INTO rsa_isAttributePK,rsa_ColumnPKNo rs_isAttributePK,rs_ColumnPKNo FROM admtf_Attribute_PKFeatures(a_TableOID,a_AttributeNo); SELECT INTO rsa_isAttributeFK,rsa_FKeyName,rsa_ColumnFKNo,rsa_FKTableName, rsa_FKTableColumnName rs_isAttributeFK,rs_FKeyName, rs_ColumnFKNo,rs_FKTableName,rs_FKTableColumnName FROM admtf_Attribute_FKFeatures(a_TableOID,a_AttributeNo); RETURN QUERY SELECT rsa_AttributeName,rsa_UserTypeName,rsa_TypeName,rsa_isNotNULL, rsa_isAttributePK,rsa_ColumnPKNo,rsa_Description,rsa_isAttributeFK, rsa_FKeyName,rsa_ColumnFKNo,rsa_FKTableName,rsa_FKTableColumnName; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_Attribute_Features(a_TableOID OID,a_AttributeNo SMALLINT) IS '   '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECT * FROM admtf_Attribute_Features ((SELECT OID FROM pg_class WHERE relname='street'),2::SMALLINT);</span></span></code> </pre><br></div></div><br><h3> 另请参阅 </h3><br> <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">     PostgreSQL.  </a> ;</b> <br> <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">     PostgreSQL.  </a> .</b> <br> <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">     PostgreSQL. ( )</a> .</b> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN418597/">https://habr.com/ru/post/zh-CN418597/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN418585/index.html">制作机器人的本地越野地图</a></li>
<li><a href="../zh-CN418587/index.html">适用于Android和iOS的新3CX客户端，具有适用于多种设备的OPUS和PUSH编解码器</a></li>
<li><a href="../zh-CN418589/index.html">上周第324天来自前端世界的新鲜材料摘要（2018年7月23日至29日）</a></li>
<li><a href="../zh-CN418591/index.html">Bug Bounty Kyivstar：奖励对Jira，AWS，Apple，Google Developer，Bitbucket服务的管理员访问权限-$ 50</a></li>
<li><a href="../zh-CN418593/index.html">并非所有的无线耳机都同样有用，或者不是关于编解码器问题的几句话</a></li>
<li><a href="../zh-CN418599/index.html">5个将APM数据转换为应用程序性能分析的数据源</a></li>
<li><a href="../zh-CN418601/index.html">关于RTOS的全部真相。 第7条 Nucleus SE：简介</a></li>
<li><a href="../zh-CN418603/index.html">无需充电的Matrix PowerWatch智能手表</a></li>
<li><a href="../zh-CN418605/index.html">分析师：微软市值可能达到1万亿美元</a></li>
<li><a href="../zh-CN418607/index.html">选择企业Wi-Fi的供应商</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>