<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘©ğŸ½â€âš•ï¸ ğŸ…ğŸ¼ ğŸ‘µğŸ¿ è™¾ï¼šä½¿ç”¨ImageMagic ++ï¼ŒSObjectizerå’ŒRESTinioåœ¨ç°ä»£C ++ä¸­ç¼©æ”¾å’Œå…±äº«HTTPå›¾åƒ ğŸš´ğŸ¾ ğŸ–¤ ğŸ§•ğŸ¿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å‰è¨€ 
 æˆ‘ä»¬çš„å°å‹å›¢é˜Ÿæ­£åœ¨ä¸ºC ++å¼€å‘äººå‘˜å¼€å‘ä¸¤ä¸ªå¼€æºå·¥å…·-SObjectizer actoræ¡†æ¶å’ŒRESTinioåµŒå…¥å¼HTTPæœåŠ¡å™¨ã€‚ ä½†æ˜¯ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°ä¸€äº›éåŒå¯»å¸¸çš„é—®é¢˜ï¼š 



- å“ªäº›åŠŸèƒ½è¦æ·»åŠ åˆ°åº“ä¸­ï¼Œå“ªäº›è¦ä¿ç•™åœ¨â€œå¤–éƒ¨â€ï¼Ÿ 
- å¦‚ä½•æ¸…æ¥šåœ°è¯´æ˜ä½¿ç”¨å›¾ä¹¦é¦†çš„â€œæ€æƒ³ä¸Šæ­£ç¡®çš„â€æ–¹æ³•ï¼Ÿ ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>è™¾ï¼šä½¿ç”¨ImageMagic ++ï¼ŒSObjectizerå’ŒRESTinioåœ¨ç°ä»£C ++ä¸­ç¼©æ”¾å’Œå…±äº«HTTPå›¾åƒ</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/416387/"><img src="https://habrastorage.org/webt/c8/es/x7/c8esx7a-blzv0brvoyng2drgdeq.jpeg"><br><br><h1> å‰è¨€ </h1><br> æˆ‘ä»¬çš„å°å‹å›¢é˜Ÿæ­£åœ¨ä¸ºC ++å¼€å‘äººå‘˜å¼€å‘ä¸¤ä¸ªå¼€æºå·¥å…·<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">-SObjectizer</a> actoræ¡†æ¶å’ŒRESTinioåµŒå…¥å¼HTTPæœåŠ¡å™¨ã€‚ ä½†æ˜¯ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°ä¸€äº›éåŒå¯»å¸¸çš„é—®é¢˜ï¼š <br><br><ul><li> å“ªäº›åŠŸèƒ½è¦æ·»åŠ åˆ°åº“ä¸­ï¼Œå“ªäº›è¦ä¿ç•™åœ¨â€œå¤–éƒ¨â€ï¼Ÿ </li><li> å¦‚ä½•æ¸…æ¥šåœ°è¯´æ˜ä½¿ç”¨å›¾ä¹¦é¦†çš„â€œæ€æƒ³ä¸Šæ­£ç¡®çš„â€æ–¹æ³•ï¼Ÿ </li></ul><br> å½“åœ¨å®é™…é¡¹ç›®ä¸­ä½¿ç”¨æˆ‘ä»¬çš„å¼€å‘è¿‡ç¨‹ä¸­å‡ºç°æ­¤ç±»é—®é¢˜çš„ç­”æ¡ˆæ—¶ï¼Œå½“å¼€å‘äººå‘˜å‘æˆ‘ä»¬æå‡ºæŠ•è¯‰æˆ–æ„¿æœ›æ¸…å•æ—¶ï¼Œè¿™æ˜¯å¾ˆå¥½çš„ã€‚ ç”±äºæ»¡è¶³äº†ç”¨æˆ·çš„æ„¿æœ›ï¼Œæˆ‘ä»¬ä¸ºå·¥å…·æä¾›äº†åŠŸèƒ½ï¼Œè¿™äº›åŠŸèƒ½ç”±ç”Ÿæ´»æœ¬èº«å†³å®šï¼Œè€Œä¸æ˜¯â€œä»æ‰‹æŒ‡ä¸­æŠ½å‡ºâ€ã€‚ <br><br> ä½†æ˜¯ï¼Œä¿¡æ¯åˆ°è¾¾æˆ‘ä»¬çš„åœ°æ–¹è¿œéç”¨æˆ·é¢ä¸´çš„æ‰€æœ‰é—®é¢˜å’Œå›°éš¾ã€‚ è€Œä¸”ï¼Œæˆ‘ä»¬ä¸èƒ½æ€»æ˜¯åœ¨å…¬å…±èµ„æ–™ä¸­ä½¿ç”¨æ”¶åˆ°çš„ä¿¡æ¯ï¼Œå°¤å…¶æ˜¯ä»£ç ç¤ºä¾‹ã€‚ <br><br> å› æ­¤ï¼Œæœ‰æ—¶æˆ‘ä»¬ä¼šä¸ºè‡ªå·±æ€è€ƒä¸€äº›å°é—®é¢˜ï¼Œè§£å†³è¿™äº›é—®é¢˜æ—¶æˆ‘ä»¬ä¸å¾—ä¸å°†å…¶ä»å·¥å…·å¼€å‘äººå‘˜è½¬å˜ä¸ºç”¨æˆ·ã€‚ è¿™ä½¿æˆ‘ä»¬å¯ä»¥ç”¨ä¸åŒçš„çœ¼å…‰çœ‹å¾…è‡ªå·±çš„å·¥å…·ï¼Œå¹¶è‡ªå·±äº†è§£ä»€ä¹ˆæ˜¯å¥½ï¼Œä»€ä¹ˆä¸å¥½ï¼Œä»€ä¹ˆç¼ºå¤±ï¼Œä»€ä¹ˆå¤ªå¤šã€‚ <br><br> ä»Šå¤©ï¼Œæˆ‘ä»¬åªæƒ³è®²è¿°ä¸€ä¸ªè¿™æ ·çš„â€œå°â€ä»»åŠ¡ï¼Œå…¶ä¸­SObjectizerå’ŒRESTinioè‡ªç„¶åœ°èåˆåœ¨ä¸€èµ·ã€‚ <br><br><h1> å›¾ç‰‡çš„ç¼©æ”¾å’Œåˆ†å‘ã€‚ ä¸ºä»€ä¹ˆè¦è¿™æ ·å‘¢ï¼Ÿ </h1><br> ä½œä¸ºæˆ‘ä»¬è‡ªå·±çš„ä¸€ä¸ªå°å‹æ¼”ç¤ºä»»åŠ¡ï¼Œæˆ‘ä»¬é€‰æ‹©äº†ä¸€ä¸ªHTTPæœåŠ¡å™¨ï¼Œè¯¥æœåŠ¡å™¨æ ¹æ®è¯·æ±‚åˆ†å‘ç¼©æ”¾çš„å›¾åƒã€‚ æ‚¨å°†å›¾åƒæ”¾åœ¨æŸä¸ªç›®å½•ä¸­ï¼Œå¯åŠ¨HTTPæœåŠ¡å™¨ï¼Œä»¥ä»¥ä¸‹å½¢å¼å‘å…¶å‘å‡ºè¯·æ±‚ï¼š <br><a name="habracut"></a><br><pre><code class="bash hljs">curl <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/my_picture.jpg?op=resize&amp;max=1920"</span></span></code> </pre> <br> ä½œä¸ºå›æŠ¥ï¼Œæ‚¨ä¼šå¾—åˆ°ä¸€å¼ é•¿è¾¹ç¼©æ”¾ä¸º1920åƒç´ çš„å›¾ç‰‡ã€‚ <br><br> ä¹‹æ‰€ä»¥é€‰æ‹©è¿™ä¸ªä»»åŠ¡ï¼Œæ˜¯å› ä¸ºå®ƒå®Œç¾åœ°å±•ç¤ºäº†æˆ‘ä»¬ä¸€æ¬¡å¼€å§‹å¼€å‘RESTinioçš„åœºæ™¯ï¼šåœ¨Cæˆ–C ++ä¸­ï¼Œæœ‰ä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œå’Œè°ƒè¯•çš„ä»£ç ï¼Œæ‚¨éœ€è¦åœ¨è¯¥ä»£ç ä¸Šé™„åŠ HTTPè¾“å…¥å¹¶å¼€å§‹å“åº”ä¼ å…¥çš„è¯·æ±‚ã€‚ åŒæ—¶ï¼Œè¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œè¯·æ±‚çš„åº”ç”¨ç¨‹åºå¤„ç†å¯èƒ½ä¼šèŠ±è´¹å¤§é‡æ—¶é—´ï¼Œå› æ­¤ç›´æ¥åœ¨IOä¸Šä¸‹æ–‡ä¸­æå–åº”ç”¨ç¨‹åºä»£ç æ˜¯æ— åˆ©å¯å›¾çš„ã€‚  HTTPæœåŠ¡å™¨åº”è¯¥æ˜¯å¼‚æ­¥çš„ï¼šæ¥å—å¹¶è§£æHTTPè¯·æ±‚ï¼Œå°†è§£æåçš„è¯·æ±‚æä¾›ç»™æŸä¸ªåœ°æ–¹ä»¥è¿›è¡Œè¿›ä¸€æ­¥çš„åº”ç”¨ç¨‹åºå¤„ç†ï¼Œç»§ç»­ä¸ºä¸‹ä¸€ä¸ªHTTPè¯·æ±‚æä¾›æœåŠ¡ï¼Œå¹¶åœ¨æŸäººå‡†å¤‡å¥½æ­¤å“åº”åè¿”å›å°†å“åº”è¿”å›ç»™HTTPè¯·æ±‚ã€‚ <br><br> è¿™æ­£æ˜¯åœ¨å¤„ç†ç¼©æ”¾å›¾åƒè¯·æ±‚æ—¶å‘ç”Ÿçš„æƒ…å†µã€‚  HTTPæœåŠ¡å™¨èƒ½å¤Ÿåœ¨ä¸åˆ°ä¸€æ¯«ç§’çš„æ—¶é—´å†…å®Œæˆå…¶ç›´æ¥å·¥ä½œï¼ˆå³è¯»å–æ•°æ®ï¼Œè§£æHTTPè¯·æ±‚ï¼‰ã€‚ ä½†æ˜¯ç¼©æ”¾å›¾ç‰‡å¯èƒ½è¦èŠ±è´¹æ•°åï¼Œæ•°ç™¾ç”šè‡³æ•°åƒæ¯«ç§’ã€‚ <br><br> è€Œä¸”ï¼Œç”±äºç¼©æ”¾ä¸€å¼ å›¾ç‰‡éœ€è¦èŠ±è´¹å¤§é‡æ—¶é—´ï¼Œå› æ­¤æ‚¨éœ€è¦ç¡®ä¿åœ¨ç¼©æ”¾å›¾ç‰‡æ—¶HTTPæœåŠ¡å™¨å¯ä»¥ç»§ç»­å·¥ä½œã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦åˆ†æ•£HTTPæœåŠ¡å™¨çš„å·¥ä½œå¹¶å°†å›¾åƒç¼©æ”¾åˆ°ä¸åŒçš„å·¥ä½œä¸Šä¸‹æ–‡ã€‚ åœ¨ç®€å•çš„æƒ…å†µä¸‹ï¼Œè¿™äº›å°†æ˜¯ä¸åŒçš„å·¥ä½œçº¿ç¨‹ã€‚ å¥½å§ï¼Œç”±äºæˆ‘ä»¬ç”Ÿæ´»åœ¨å¤šæ ¸å¤„ç†å™¨ä¸­ï¼Œå› æ­¤æˆ‘ä»¬å°†æœ‰å‡ ä¸ªå·¥ä½œçº¿ç¨‹ã€‚ å…¶ä¸­ä¸€äº›å°†å¤„ç†HTTPè¯·æ±‚ï¼Œä¸€äº›å°†ä¸å›¾åƒä¸€èµ·ä½¿ç”¨ã€‚ <br><br> äº‹å®è¯æ˜ï¼Œè¦é€šè¿‡HTTPåˆ†å‘å¯ä¼¸ç¼©å›¾åƒï¼Œæˆ‘ä»¬éœ€è¦é‡ç”¨é•¿æœŸç¼–å†™çš„æœ‰æ•ˆC / C ++ä»£ç ï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸ºImageMagic ++ï¼‰ï¼Œå¹¶å¼‚æ­¥å¤„ç†HTTPè¯·æ±‚ï¼Œå¹¶åœ¨å¤šä¸ªå·¥ä½œæµç¨‹ä¸­æ‰§è¡Œè¯·æ±‚çš„åº”ç”¨ç¨‹åºå¤„ç†ã€‚ åœ¨æˆ‘ä»¬çœ‹æ¥ï¼Œå¯¹äºRESTinioå’ŒSObjectizeræ¥è¯´ï¼Œè¿™æ˜¯ä¸€é¡¹å‡ºè‰²çš„ä»»åŠ¡ã€‚ <br><br> æˆ‘ä»¬å†³å®šå°†æ¼”ç¤ºé¡¹ç›®å‘½åä¸ºè™¾ã€‚ <br><br><h1> è™¾åŸæ · </h1><br><h2> è™¾åšä»€ä¹ˆï¼Ÿ </h2><br> è™¾ä½œä¸ºæ§åˆ¶å°åº”ç”¨ç¨‹åºè¿è¡Œï¼Œæ‰“å¼€å¹¶ä¾¦å¬æŒ‡å®šçš„ç«¯å£ï¼Œæ¥æ”¶å¹¶å¤„ç†ä»¥ä¸‹å½¢å¼çš„HTTP GETè¯·æ±‚ï¼š <br><br><pre> <code class="hljs xml">/<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">image</span></span></span><span class="hljs-tag">&gt;</span></span>.<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ext</span></span></span><span class="hljs-tag">&gt;</span></span> /<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">image</span></span></span><span class="hljs-tag">&gt;</span></span>.<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ext</span></span></span><span class="hljs-tag">&gt;</span></span>?op=resize&amp;<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">side</span></span></span><span class="hljs-tag">&gt;</span></span>=<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br> å…¶ä¸­ï¼š <br><br><ul><li>  imageæ˜¯è¦ç¼©æ”¾çš„å›¾åƒæ–‡ä»¶çš„åç§°ã€‚ ä¾‹å¦‚ï¼Œmy_pictureæˆ–DSCF0069; </li><li>  extæ˜¯è™¾æ”¯æŒçš„æ‰©å±•ä¹‹ä¸€ï¼ˆjpgï¼Œjpegï¼Œpngæˆ–gifï¼‰ï¼› </li><li> ä¸€ä¾§è¡¨ç¤ºå·²è®¾ç½®å°ºå¯¸çš„ä¸€ä¾§ã€‚ å®ƒå¯ä»¥å…·æœ‰widthçš„å€¼ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†å¯¹å›¾ç‰‡è¿›è¡Œç¼©æ”¾ä»¥ä½¿æ‰€å¾—çš„å®½åº¦ç­‰äºæŒ‡å®šçš„å€¼ï¼Œå¹¶åœ¨ä¿æŒå®½é«˜æ¯”çš„åŒæ—¶è‡ªåŠ¨é€‰æ‹©å›¾ç‰‡çš„é«˜åº¦ã€‚ æˆ–heightçš„å€¼ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé«˜åº¦ä¼šå‘ç”Ÿç¼©æ”¾ã€‚ æœ€å¤§å€¼ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé•¿è¾¹æ˜¯æœ‰é™çš„ï¼‰ç”±è™¾æœ¬èº«ç¡®å®šé•¿è¾¹æ˜¯é«˜è¿˜æ˜¯å®½ã€‚ </li><li>  valueæ˜¯å‘ç”Ÿç¼©æ”¾çš„å¤§å°ã€‚ </li></ul><br> å¦‚æœåœ¨URLä¸­ä»…æŒ‡å®šæ–‡ä»¶åï¼Œè€Œæ²¡æœ‰è¿›è¡Œå¤§å°è°ƒæ•´æ“ä½œï¼Œåˆ™è™¾åªåœ¨å“åº”ä¸­è¿”å›åŸå§‹å›¾åƒã€‚ å¦‚æœæŒ‡å®šäº†è°ƒæ•´å¤§å°æ“ä½œï¼Œåˆ™è™¾å°†æ›´æ”¹è¯·æ±‚å›¾åƒçš„å¤§å°å¹¶ç»™å‡ºç¼©æ”¾çš„ç‰ˆæœ¬ã€‚ <br><br> åŒæ—¶ï¼Œè™¾åœ¨å†…å­˜ä¸­ä¿å­˜ç¼©æ”¾å›¾åƒçš„ç¼“å­˜ã€‚ å¦‚æœé‡å¤è¯·æ±‚å…·æœ‰ç›¸åŒè°ƒæ•´å¤§å°å‚æ•°çš„å›¾ç‰‡ï¼ˆè¯¥å›¾ç‰‡å·²åœ¨ç¼“å­˜ä¸­ï¼‰ï¼Œåˆ™è¿”å›æ¥è‡ªç¼“å­˜çš„å€¼ã€‚ å¦‚æœé«˜é€Ÿç¼“å­˜ä¸­æ²¡æœ‰å›¾ç‰‡ï¼Œåˆ™ä»ç£ç›˜è¯»å–å›¾ç‰‡ï¼Œå°†å…¶ç¼©æ”¾ï¼Œå­˜å‚¨åœ¨ç¼“å­˜ä¸­å¹¶ä½œä¸ºå“åº”è¿”å›ã€‚ <br><br> ç¼“å­˜ä¼šå®šæœŸæ¸…é™¤ã€‚ è‡ªä¸Šæ¬¡è®¿é—®ä»¥æ¥ï¼Œå·²åœ¨ç¼“å­˜ä¸­é©»ç•™äº†ä¸€ä¸ªå¤šå°æ—¶çš„å›¾ç‰‡è¢«æ¨å‡ºã€‚ å¦å¤–ï¼Œå¦‚æœç¼“å­˜è¶…è¿‡å…¶æœ€å¤§å¤§å°ï¼ˆåœ¨æ¼”ç¤ºé¡¹ç›®ä¸­ä¸º100Mbï¼‰ï¼Œåˆ™æœ€æ—©çš„å›¾ç‰‡ä¹Ÿä¼šä»ç¼“å­˜ä¸­æŠ›å‡ºã€‚ <br><br> æˆ‘ä»¬å‡†å¤‡å¥½äº†ä¸€ä¸ª<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é¡µé¢</a> ï¼Œä»»ä½•äººéƒ½å¯ä»¥å°è¯•å¯¹è™¾è¿›è¡Œæ“ä½œï¼š <br><br><img src="https://habrastorage.org/webt/uv/vr/-q/uvvr-qtt1xovbi_k-ieoyrpvq-y.jpeg"><br><br> åœ¨æ­¤é¡µé¢ä¸Šï¼Œæ‚¨å¯ä»¥è®¾ç½®å›¾åƒå¤§å°ï¼Œç„¶åå•å‡»â€œè°ƒæ•´å¤§å°â€ã€‚ å°†ä½¿ç”¨ç›¸åŒçš„å‚æ•°å‘è™¾æœåŠ¡å™¨å‘å‡ºä¸¤ä¸ªè¯·æ±‚ã€‚ æœ€æœ‰å¯èƒ½çš„æ˜¯ï¼Œç¬¬ä¸€ä¸ªè¯·æ±‚å°†æ˜¯å”¯ä¸€çš„ï¼ˆå³ï¼Œåœ¨ç¼“å­˜ä¸­å°šæ— å…·æœ‰æ­¤ç±»è°ƒæ•´å¤§å°å‚æ•°çš„ç¼“å­˜ï¼‰ï¼Œå› æ­¤ç¬¬ä¸€ä¸ªè¯·æ±‚å°†èŠ±è´¹ä¸€äº›æ—¶é—´æ¥å®é™…ç¼©æ”¾å›¾åƒã€‚ ç¬¬äºŒä¸ªè¯·æ±‚å¾ˆå¯èƒ½ä¼šåœ¨ç¼“å­˜ä¸­æ‰¾åˆ°å·²ç»ç¼©æ”¾çš„å›¾ç‰‡ï¼Œå¹¶ç«‹å³å°†å…¶æä¾›ã€‚ <br><br> å¯ä»¥åˆ¤æ–­æ˜¯å¦ä»ç¼“å­˜ä¸­ç»™å‡ºäº†å›¾ç‰‡ï¼Œæˆ–è€…æ˜¯å¦ç¡®å®é€šè¿‡å›¾ç‰‡ä¸‹æ–¹çš„æ–‡å­—ç¼©æ”¾äº†å›¾ç‰‡ã€‚ ä¾‹å¦‚ï¼Œæ–‡æœ¬â€œå·²è½¬æ¢ï¼ˆ114.0msï¼‰â€è¡¨ç¤ºå›¾ç‰‡å·²ç¼©æ”¾ï¼Œç¼©æ”¾æ“ä½œèŠ±è´¹äº†114æ¯«ç§’ã€‚ <br><br><h2> è™¾æ˜¯æ€ä¹ˆåšçš„ï¼Ÿ </h2><br>  Shrimpæ˜¯è¿è¡Œä¸‰ç»„å·¥ä½œçº¿ç¨‹çš„å¤šçº¿ç¨‹åº”ç”¨ç¨‹åºï¼š <br><br><ol><li> è¿è¡ŒHTTPæœåŠ¡å™¨çš„å·¥ä½œçº¿ç¨‹æ± ã€‚ åœ¨è¯¥æ± ä¸Šï¼Œå°†æä¾›æ–°çš„è¿æ¥ï¼Œæ¥æ”¶å¹¶è§£æä¼ å…¥çš„è¯·æ±‚ï¼Œç”Ÿæˆå¹¶å‘é€å“åº”ã€‚  HTTPæœåŠ¡å™¨é€šè¿‡RESTinioåº“å®ç°ã€‚ </li><li> ä¸€ä¸ªå•ç‹¬çš„å·¥ä½œçº¿ç¨‹ï¼Œåœ¨è¯¥çº¿ç¨‹ä¸Šè¿è¡Œtransform_manager SObjectizerä»£ç†ã€‚ è¯¥ä»£ç†å¤„ç†ä»HTTPæœåŠ¡å™¨æ”¶åˆ°çš„è¯·æ±‚ï¼Œå¹¶ç»´æŠ¤ç¼©æ”¾å›¾åƒçš„ç¼“å­˜ã€‚ </li><li>  SObjectizerä»£ç†åœ¨å…¶ä¸Šå·¥ä½œçš„è½¬æ¢å™¨çš„çº¿ç¨‹æ± ã€‚ ä»–ä»¬ä½¿ç”¨ImageMagic ++æ‰§è¡Œå›¾åƒçš„å®é™…ç¼©æ”¾ã€‚ </li></ol><br> äº‹å®è¯æ˜ä»¥ä¸‹å·¥ä½œæ–¹æ¡ˆï¼š <br><br><img src="https://habrastorage.org/webt/ns/ov/sj/nsovsjushv0zxasu_cq3ur0dy6m.png"><br><br>  HTTPæœåŠ¡å™¨æ¥å—ä¼ å…¥çš„è¯·æ±‚ï¼Œå¯¹å…¶è¿›è¡Œè§£æï¼Œç„¶åæ£€æŸ¥å…¶æ­£ç¡®æ€§ã€‚ å¦‚æœæ­¤è¯·æ±‚ä¸éœ€è¦è°ƒæ•´å¤§å°æ“ä½œï¼Œåˆ™HTTPæœåŠ¡å™¨æœ¬èº«å°†é€šè¿‡<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">sendfile</a>æ“ä½œå¤„ç†è¯¥è¯·æ±‚ã€‚ å¦‚æœè¯·æ±‚éœ€è¦è°ƒæ•´å¤§å°æ“ä½œï¼Œåˆ™å°†è¯·æ±‚å¼‚æ­¥å‘é€åˆ°transform_managerä»£ç†ã€‚ <br><br>  transform_managerä»£ç†ä»HTTPæœåŠ¡å™¨æ¥æ”¶è¯·æ±‚ï¼Œæ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦å·²ç¼©æ”¾å›¾ç‰‡ã€‚ å¦‚æœç¼“å­˜ä¸­æœ‰å›¾ç‰‡ï¼Œåˆ™transform_managerç«‹å³ä¸ºHTTPæœåŠ¡å™¨ç”Ÿæˆå“åº”ã€‚ å¦‚æœæ²¡æœ‰å›¾ç‰‡ï¼Œåˆ™transform_managerå‘é€ä¸€ä¸ªè¯·æ±‚ä»¥å°†å›¾ç‰‡ç¼©æ”¾åˆ°å…¶ä¸­ä¸€ä¸ªè½¬æ¢å™¨ä»£ç†ã€‚ å½“ç¼©æ”¾ç»“æœæ¥è‡ªè½¬æ¢å™¨æ—¶ï¼Œç»“æœå­˜å‚¨åœ¨ç¼“å­˜ä¸­ï¼Œå¹¶ä¸ºHTTPæœåŠ¡å™¨ç”Ÿæˆç­”æ¡ˆã€‚ <br><br> è½¬æ¢å™¨ä»£ç†æ¥æ”¶æ¥è‡ªtransform_managerçš„è¯·æ±‚ï¼Œå¯¹å…¶è¿›è¡Œå¤„ç†ï¼Œç„¶åå°†è½¬æ¢ç»“æœè¿”å›ç»™transform_managerä»£ç†ã€‚ <br><br><h2> è™¾åœ¨å¼•æ“ç›–ä¸‹æœ‰ä»€ä¹ˆï¼Ÿ </h2><br> å¯ä»¥åœ¨ä»¥ä¸‹å­˜å‚¨åº“ä¸­æ‰¾åˆ°æœ¬æ–‡æè¿°çš„è™¾çš„æœ€ä½ç‰ˆæœ¬çš„æºä»£ç ï¼š <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">BitBucket</a>æˆ–<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitHub</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¸Šçš„è™¾æ ·æœ¬</a> ã€‚ <br><br> æœ‰å¾ˆå¤šä»£ç ï¼Œå°½ç®¡åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåœ¨æ­¤ç‰ˆæœ¬çš„è™¾ä¸­ï¼Œè¯¥ä»£ç éå¸¸ç®€å•ã€‚ ä½†æ˜¯ï¼Œå°†ç²¾åŠ›é›†ä¸­åœ¨å®ç°çš„æŸäº›æ–¹é¢æ˜¯æœ‰æ„ä¹‰çš„ã€‚ <br><br><h3> ä½¿ç”¨C ++ 17å’Œæœ€æ–°çš„ç¼–è¯‘å™¨ç‰ˆæœ¬ </h3><br> åœ¨å®ç°è™¾çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å†³å®šä½¿ç”¨C ++ 17å’Œæœ€æ–°ç‰ˆæœ¬çš„ç¼–è¯‘å™¨ï¼Œå°¤å…¶æ˜¯GCC 7.3å’Œ8.1ã€‚ è¯¥é¡¹ç›®æ˜¯å¤§é‡ç ”ç©¶ã€‚ å› æ­¤ï¼Œåœ¨è¿™æ ·ä¸€ä¸ªé¡¹ç›®çš„æ¡†æ¶ä¸­å¯¹C ++ 17çš„å®é™…è®¤è¯†æ˜¯è‡ªç„¶çš„å¹¶ä¸”æ˜¯å…è®¸çš„ã€‚ é‰´äºç°åœ¨å’Œç°åœ¨çš„æ›´å¹¿æ³›çš„å¼€å‘éƒ½é›†ä¸­åœ¨å®é™…çš„å·¥ä¸šåº”ç”¨ä¸Šï¼Œæˆ‘ä»¬è¢«è¿«å›é¡¾ç›¸å½“å¤è€çš„ç¼–è¯‘å™¨ï¼Œå¹¶å¯èƒ½ä½¿ç”¨C ++ 14ï¼Œç”šè‡³åªæ˜¯C ++ 11çš„ä¸€éƒ¨åˆ†ã€‚ <br><br> æˆ‘å¿…é¡»è¯´C ++ 17ç»™äººç•™ä¸‹äº†æ·±åˆ»çš„å°è±¡ã€‚ ä¼¼ä¹æˆ‘ä»¬æ²¡æœ‰åœ¨è™¾ä»£ç ä¸­ä½¿ç”¨å¤ªå¤šæ¥è‡ªç¬¬17ä¸ªæ ‡å‡†çš„åˆ›æ–°ï¼Œä½†æ˜¯å®ƒä»¬äº§ç”Ÿäº†ç§¯æçš„æ•ˆæœï¼š[[nodiscard]]å±æ€§ï¼Œstd ::å¯é€‰/ std :: variant / std ::æ–‡ä»¶ç³»ç»Ÿç›´æ¥â€œå¼€ç®±å³ç”¨ï¼Œè€Œä¸æ˜¯æ¥è‡ªå¤–éƒ¨ä¾èµ–é¡¹ï¼Œç»“æ„åŒ–ç»‘å®šï¼ˆå¦‚æœæ˜¯constexprï¼‰ï¼Œä¸ºstd :: visitç»„è£…lambdaçš„visitorçš„åŠŸèƒ½â€¦â€¦å•ç‹¬åœ°ï¼Œè¿™äº›éƒ½æ˜¯çäº‹ï¼Œä½†å®ƒä»¬å…±åŒäº§ç”Ÿäº†å¼ºå¤§çš„ç´¯ç§¯æ•ˆåº”ã€‚ <br><br> å› æ­¤ï¼Œæˆ‘ä»¬åœ¨å¼€å‘è™¾æ—¶è·å¾—çš„ç¬¬ä¸€ä¸ªæœ‰ç”¨ç»“æœæ˜¯ï¼šC ++ 17å€¼å¾—åˆ‡æ¢åˆ°å®ƒã€‚ <br><br><h3> ä½¿ç”¨RESTinioå·¥å…·çš„HTTPæœåŠ¡å™¨ </h3><br> å¯èƒ½è™¾çš„æœ€ç®€å•éƒ¨åˆ†æ˜¯HTTPæœåŠ¡å™¨å’ŒHTTP GETè¯·æ±‚å¤„ç†ç¨‹åºï¼ˆ <a href="https://bitbucket.org/sobjectizerteam/shrimp-demo/src/v0.2/dev/shrimp/">http_server.hpp</a>å’Œ<a href="https://bitbucket.org/sobjectizerteam/shrimp-demo/src/v0.2/dev/shrimp/">http_server.cpp</a> ï¼‰ã€‚ <br><br><h4> æ¥æ”¶å’Œè°ƒåº¦ä¼ å…¥çš„è¯·æ±‚ </h4><br> æœ¬è´¨ä¸Šï¼Œè™¾HTTPæœåŠ¡å™¨çš„æ‰€æœ‰åŸºæœ¬é€»è¾‘éƒ½é›†ä¸­åœ¨æ­¤åŠŸèƒ½ä¸­ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add_transform_op_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">app_params_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp; app_params, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">http_req_router_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp; router, so_5::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">mbox_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> req_handler_mbox )</span></span></span><span class="hljs-function"> </span></span>{ router.http_get( <span class="hljs-string"><span class="hljs-string">R"(/:path(.*)\.:ext(.{3,4}))"</span></span>, restinio::path2regex::<span class="hljs-keyword"><span class="hljs-keyword">options_t</span></span>{}.strict( <span class="hljs-literal"><span class="hljs-literal">true</span></span> ), [req_handler_mbox, &amp;app_params]( <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> req, <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> params ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( has_illegal_path_components( req-&gt;header().path() ) ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> do_400_response( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move( req ) ); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> opt_image_format = image_format_from_extension( params[ <span class="hljs-string"><span class="hljs-string">"ext"</span></span> ] ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !opt_image_format ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> do_400_response( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move( req ) ); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( req-&gt;header().query().empty() ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> serve_as_regular_file( app_params.m_storage.m_root_dir, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move( req ), *opt_image_format ); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> qp = restinio::parse_query( req-&gt;header().query() ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-string"><span class="hljs-string">"resize"</span></span> != restinio::value_or( qp, <span class="hljs-string"><span class="hljs-string">"op"</span></span>sv, <span class="hljs-string"><span class="hljs-string">""</span></span>sv ) ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> do_400_response( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move( req ) ); } handle_resize_op_request( req_handler_mbox, *opt_image_format, qp, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move( req ) ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> restinio::request_accepted(); } ); }</code> </pre> <br> æ­¤å‡½æ•°ä½¿ç”¨RESTinio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ExpressJSè·¯ç”±å™¨</a>å‡†å¤‡HTTP GETè¯·æ±‚å¤„ç†ç¨‹åºã€‚ å½“HTTPæœåŠ¡å™¨æ”¶åˆ°GETè¯·æ±‚ï¼ˆå…¶URLå±äºç»™å®šçš„æ­£åˆ™è¡¨è¾¾å¼ï¼‰æ—¶ï¼Œå°†è°ƒç”¨æŒ‡å®šçš„lambdaå‡½æ•°ã€‚ <br><br> è¿™ä¸ªlambdaå‡½æ•°å¯¹è¯·æ±‚çš„æ­£ç¡®æ€§è¿›è¡Œäº†ä¸€äº›ç®€å•çš„æ£€æŸ¥ï¼Œä½†æ˜¯ï¼Œå…¶å·¥ä½œä¸»è¦å–å†³äºä¸€ä¸ªç®€å•çš„é€‰æ‹©ï¼šå¦‚æœæœªè®¾ç½®resizeï¼Œåˆ™å°†ä½¿ç”¨æœ‰æ•ˆçš„ç³»ç»Ÿsendfileä»¥åŸå§‹å½¢å¼è¿”å›è¯·æ±‚çš„å›¾ç‰‡ã€‚ å¦‚æœè®¾ç½®äº†è°ƒæ•´å¤§å°æ¨¡å¼ï¼Œé‚£ä¹ˆå°†ç”Ÿæˆä¸€æ¡æ¶ˆæ¯å¹¶å°†å…¶å‘é€åˆ°transform_managerä»£ç†ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle_resize_op_request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> so_5::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">mbox_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp; req_handler_mbox, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">image_format_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> image_format, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> restinio::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">query_string_params_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp; qp, restinio::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">request_handle_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> req )</span></span></span><span class="hljs-function"> </span></span>{ try_to_handle_request( [&amp;]{ <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> op_params = transform::<span class="hljs-keyword"><span class="hljs-keyword">resize_params_t</span></span>::make( restinio::opt_value&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> &gt;( qp, <span class="hljs-string"><span class="hljs-string">"width"</span></span> ), restinio::opt_value&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> &gt;( qp, <span class="hljs-string"><span class="hljs-string">"height"</span></span> ), restinio::opt_value&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> &gt;( qp, <span class="hljs-string"><span class="hljs-string">"max"</span></span> ) ); transform::<span class="hljs-keyword"><span class="hljs-keyword">resize_params_constraints_t</span></span>{}.check( op_params ); <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> image_path{ req-&gt;header().path() }; so_5::send&lt; so_5::mutable_msg&lt;<span class="hljs-keyword"><span class="hljs-keyword">a_transform_manager_t</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">resize_request_t</span></span>&gt;&gt;( req_handler_mbox, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(req), <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(image_path), image_format, op_params ); }, req ); }</code> </pre> <br> äº‹å®è¯æ˜ï¼ŒHTTPæœåŠ¡å™¨å·²ç»æ¥å—äº†resize-requestï¼Œå¹¶é€šè¿‡å¼‚æ­¥æ¶ˆæ¯å°†å…¶æä¾›ç»™transform_managerä»£ç†ï¼Œå¹¶ç»§ç»­å¤„ç†å…¶ä»–è¯·æ±‚ã€‚ <br><br><h4> ä¸sendfileå…±äº«æ–‡ä»¶ </h4><br> å¦‚æœHTTPæœåŠ¡å™¨æ£€æµ‹åˆ°å¯¹åŸå§‹å›¾ç‰‡çš„è¯·æ±‚ï¼Œè€Œæ²¡æœ‰è¿›è¡Œå¤§å°è°ƒæ•´æ“ä½œï¼Œåˆ™æœåŠ¡å™¨ä¼šç«‹å³é€šè¿‡sendfileæ“ä½œå‘é€è¯¥å›¾ç‰‡ã€‚ ä¸ä¹‹ç›¸å…³çš„ä¸»è¦ä»£ç å¦‚ä¸‹ï¼ˆè¯¥åŠŸèƒ½çš„å®Œæ•´ä»£ç å¯ä»¥<a href="">åœ¨å­˜å‚¨åº“ä¸­</a>æ‰¾åˆ°ï¼‰ï¼š <br><br><pre> <code class="cpp hljs">[[nodiscard]] restinio::<span class="hljs-keyword"><span class="hljs-keyword">request_handling_status_t</span></span> serve_as_regular_file( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> &amp; root_dir, restinio::<span class="hljs-keyword"><span class="hljs-keyword">request_handle_t</span></span> req, <span class="hljs-keyword"><span class="hljs-keyword">image_format_t</span></span> image_format ) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> full_path = make_full_path( root_dir, req-&gt;header().path() ); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> sf = restinio::sendfile( full_path ); ... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> set_common_header_fields_for_image_resp( file_stat.st_mtim.tv_sec, resp ) .append_header( restinio::http_field::content_type, image_content_type_from_img_format( image_format ) ) .append_header( http_header::shrimp_image_src, image_src_to_str( http_header::<span class="hljs-keyword"><span class="hljs-keyword">image_src_t</span></span>::sendfile ) ) .set_body( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move( sf ) ) .done(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(...) {} <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> do_404_response( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move( req ) ); }</code> </pre> <br> æ­¤å¤„çš„å…³é”®ç‚¹æ˜¯è°ƒç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">restinio :: sendfileï¼ˆï¼‰</a> ï¼Œç„¶åå°†æ­¤å‡½æ•°è¿”å›çš„å€¼ä¼ é€’ç»™set_bodyï¼ˆï¼‰ã€‚ <br><br>  restinio :: sendfileï¼ˆï¼‰å‡½æ•°ä½¿ç”¨ç³»ç»ŸAPIåˆ›å»ºæ–‡ä»¶ä¸Šä¼ æ“ä½œã€‚ å½“æ­¤æ“ä½œä¼ é€’ç»™set_bodyï¼ˆï¼‰æ—¶ï¼ŒRESTinioç†è§£åˆ°restinio :: sendfileï¼ˆï¼‰ä¸­æŒ‡å®šçš„æ–‡ä»¶å†…å®¹å°†ç”¨äºHTTPå“åº”çš„æ­£æ–‡ã€‚ ç„¶åï¼Œå®ƒä½¿ç”¨ç³»ç»ŸAPIå°†æ­¤æ–‡ä»¶çš„å†…å®¹å†™å…¥TCPå¥—æ¥å­—ã€‚ <br><br><h3> å®ç°å›¾åƒç¼“å­˜ </h3><br>  transform_managerä»£ç†å­˜å‚¨å·²è½¬æ¢å›¾åƒçš„ç¼“å­˜ï¼Œåœ¨ç¼©æ”¾åå°†å›¾åƒæ”¾ç½®åœ¨è¯¥ç¼“å­˜ä¸­ã€‚ æ­¤ç¼“å­˜æ˜¯ä¸€ä¸ªç®€å•çš„è‡ªåˆ¶å®¹å™¨ï¼Œå¯é€šè¿‡ä¸¤ç§æ–¹å¼è®¿é—®â€‹â€‹å…¶å†…å®¹ï¼š <br><br><ol><li> é€šè¿‡é”®æœç´¢å…ƒç´ ï¼ˆç±»ä¼¼äºåœ¨æ ‡å‡†å®¹å™¨std :: mapå’Œstd :: unordered_mapä¸­çš„æ“ä½œï¼‰ã€‚ </li><li> é€šè¿‡è®¿é—®æœ€æ—©çš„ç¼“å­˜é¡¹ã€‚ </li></ol><br> å½“æˆ‘ä»¬éœ€è¦æ£€æŸ¥ç¼“å­˜ä¸­å›¾åƒçš„å¯ç”¨æ€§æ—¶ï¼Œä½¿ç”¨ç¬¬ä¸€ç§è®¿é—®æ–¹æ³•ã€‚ ç¬¬äºŒä¸ªæ˜¯å½“æˆ‘ä»¬ä»ç¼“å­˜ä¸­åˆ é™¤æœ€æ—§çš„å›¾ç‰‡æ—¶ã€‚ <br><br> æˆ‘ä»¬æ²¡æœ‰å¼€å§‹åœ¨Internetä¸Šæœç´¢å¯ç”¨äºè¿™äº›ç›®çš„çš„ä¸œè¥¿ã€‚  Boost.MultiIndexå¯èƒ½åœ¨è¿™é‡Œéå¸¸åˆé€‚ã€‚ ä½†æ˜¯æˆ‘ä¸æƒ³ä»…ä»…ä¸ºäº†MultiIndexè€Œæ‹–åŠ¨Boostï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨æˆ‘çš„è†ç›–ä¸Šè¿›è¡Œ<a href="">äº†çç¢çš„å®ç°</a> ã€‚ ä¼¼ä¹æœ‰æ•ˆï¼›ï¼‰ <br><br><h3>  transform_managerä¸­çš„å¾…å¤„ç†è¯·æ±‚é˜Ÿåˆ— </h3><br> åœ¨æˆ‘ä»¬æœ€ç®€å•çš„å¯¹è™¾å®ç°ä¸­ï¼Œå°½ç®¡transform_managerä»£ç†çš„å¤§å°ç›¸å½“ä¸é”™ï¼ˆä¸€ä¸ª<a href="">hppæ–‡ä»¶</a>å¤§çº¦ä¸º250è¡Œï¼Œä¸€ä¸ª<a href="">cppæ–‡ä»¶</a>å¤§çº¦ä¸º270è¡Œï¼‰ï¼Œä½†åœ¨æˆ‘ä»¬çœ‹æ¥ï¼Œå®ƒå´æ˜¾å¾—å¾®ä¸è¶³é“ã€‚ <br><br> å¯¹ä»£ç†ç¨‹åºä»£ç çš„å¤æ‚æ€§å’Œæ•°é‡ä½œå‡ºé‡å¤§è´¡çŒ®çš„è¦ç‚¹ä¹‹ä¸€æ˜¯ï¼Œtransform_managerä¸­ä¸ä»…å­˜åœ¨å·²è½¬æ¢å›¾åƒçš„ç¼“å­˜ï¼Œè€Œä¸”è¿˜å­˜åœ¨æœªå†³è¯·æ±‚é˜Ÿåˆ—ã€‚ <br><br> æˆ‘ä»¬çš„å˜å‹å™¨ä»£ç†æ•°é‡æœ‰é™ï¼ˆåŸåˆ™ä¸Šï¼Œå®ƒä»¬çš„æ•°é‡åº”å¤§è‡´å¯¹åº”äºå¯ç”¨å¤„ç†æ ¸å¿ƒçš„æ•°é‡ï¼‰ã€‚ å¦‚æœåŒæ—¶å‘å‡ºçš„è¯·æ±‚å¤šäºå…è´¹å˜æ¢å™¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç«‹å³å¯¹è¯·æ±‚åšå‡ºå¦å®šå“åº”ï¼Œä¹Ÿå¯ä»¥å°†è¯·æ±‚æ’é˜Ÿã€‚ ç„¶åï¼Œå½“å‡ºç°å¯ç”¨çš„è½¬æ¢å™¨æ—¶ï¼Œå°†å…¶ä»é˜Ÿåˆ—ä¸­å–å‡ºã€‚ <br><br> åœ¨è™¾ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ç­‰å¾…è¯·æ±‚çš„é˜Ÿåˆ—ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pending_request_t</span></span></span><span class="hljs-class"> {</span></span> transform::<span class="hljs-keyword"><span class="hljs-keyword">resize_request_key_t</span></span> m_key; <span class="hljs-keyword"><span class="hljs-keyword">sobj_shptr_t</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">resize_request_t</span></span>&gt; m_cmd; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::chrono::steady_clock::time_point m_stored_at; <span class="hljs-keyword"><span class="hljs-keyword">pending_request_t</span></span>( transform::<span class="hljs-keyword"><span class="hljs-keyword">resize_request_key_t</span></span> key, <span class="hljs-keyword"><span class="hljs-keyword">sobj_shptr_t</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">resize_request_t</span></span>&gt; cmd, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::chrono::steady_clock::time_point stored_at ) : m_key{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(key) } , m_cmd{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(cmd) } , m_stored_at{ stored_at } {} }; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pending_request_queue_t</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">queue</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">pending_request_t</span></span>&gt;; <span class="hljs-keyword"><span class="hljs-keyword">pending_request_queue_t</span></span> m_pending_requests; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> max_pending_requests{ <span class="hljs-number"><span class="hljs-number">64u</span></span> };</code> </pre> <br> æ”¶åˆ°è¯·æ±‚åï¼Œæˆ‘ä»¬ä¼šå°†å…¶æ”¾å…¥é˜Ÿåˆ—ä¸­ï¼Œå¹¶ç¡®å®šæ¥æ”¶è¯·æ±‚çš„æ—¶é—´ã€‚ ç„¶åï¼Œæˆ‘ä»¬ä¼šå®šæœŸæ£€æŸ¥æ­¤è¯·æ±‚çš„è¶…æ—¶æ˜¯å¦å·²åˆ°æœŸã€‚ ç¡®å®ï¼ŒåŸåˆ™ä¸Šï¼Œå¯èƒ½ä¼šå‘ç”Ÿä¸€å †â€œæ²‰é‡â€è¯·æ±‚è¾ƒæ—©åˆ°è¾¾ï¼Œå¤„ç†æ—¶é—´è¿‡é•¿çš„æƒ…å†µã€‚ æ— ä¼‘æ­¢åœ°ç­‰å¾…å…è´¹çš„è½¬æ¢å™¨å‡ºç°æ˜¯é”™è¯¯çš„ï¼Œæœ€å¥½åœ¨ä¸€æ®µæ—¶é—´åå‘å®¢æˆ·ç«¯å‘é€å¦å®šå“åº”ï¼Œè¿™æ„å‘³ç€æœåŠ¡ç°åœ¨è¿‡è½½ã€‚ <br><br> æœªå†³è¯·æ±‚é˜Ÿåˆ—ä¹Ÿæœ‰å¤§å°é™åˆ¶ã€‚ å¦‚æœé˜Ÿåˆ—å·²ç»è¾¾åˆ°æœ€å¤§å¤§å°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†ç«‹å³æ‹’ç»å¤„ç†è¯¥è¯·æ±‚ï¼Œå¹¶å‘Šè¯‰å®¢æˆ·ç«¯æˆ‘ä»¬è¶…è½½ã€‚ <br><br> æœ‰ä¸€ä¸ªä¸å¾…å¤„ç†è¯·æ±‚é˜Ÿåˆ—æœ‰å…³çš„é‡è¦ç‚¹ï¼Œæˆ‘ä»¬å°†åœ¨æœ¬æ–‡çš„ç»“è®ºä¸­é‡ç‚¹ä»‹ç»è¿™ä¸€ç‚¹ã€‚ <br><br><h4> é”®å…¥sobj_shptr_tå¹¶é‡ç”¨æ¶ˆæ¯å®ä¾‹ </h4><br> åœ¨ç¡®å®šç­‰å¾…è¯·æ±‚é˜Ÿåˆ—çš„ç±»å‹ä»¥åŠtransform_manageræŸäº›æ–¹æ³•çš„ç­¾åæ—¶ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°sobj_shptr_tç±»å‹çš„ä½¿ç”¨ã€‚ æœ‰å¿…è¦è¯¦ç»†è¯´æ˜å®ƒæ˜¯ä»€ä¹ˆç±»å‹ä»¥åŠä¸ºä»€ä¹ˆä½¿ç”¨å®ƒã€‚ <br><br> æœ€é‡è¦çš„æ˜¯ï¼Œtransform_managerä»HTTPæœåŠ¡å™¨æ¥æ”¶ä¸€ä¸ªè¯·æ±‚ï¼Œä½œä¸ºresize_request_tæ¶ˆæ¯ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resize_request_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> so_5::<span class="hljs-keyword"><span class="hljs-keyword">message_t</span></span> { restinio::<span class="hljs-keyword"><span class="hljs-keyword">request_handle_t</span></span> m_http_req; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> m_image; <span class="hljs-keyword"><span class="hljs-keyword">image_format_t</span></span> m_image_format; transform::<span class="hljs-keyword"><span class="hljs-keyword">resize_params_t</span></span> m_params; <span class="hljs-keyword"><span class="hljs-keyword">resize_request_t</span></span>( restinio::<span class="hljs-keyword"><span class="hljs-keyword">request_handle_t</span></span> http_req, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> image, <span class="hljs-keyword"><span class="hljs-keyword">image_format_t</span></span> image_format, transform::<span class="hljs-keyword"><span class="hljs-keyword">resize_params_t</span></span> params ) : m_http_req{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(http_req) } , m_image{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(image) } , m_image_format{ image_format } , m_params{ params } {} };</code> </pre> <br> å¹¶ä¸”æˆ‘ä»¬å¿…é¡»åšä¸€äº›äº‹æƒ…æ¥å°†è¯¥ä¿¡æ¯å­˜å‚¨åœ¨ç­‰å¾…è¯·æ±‚çš„é˜Ÿåˆ—ä¸­ã€‚ ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„resize_request_tå®ä¾‹ï¼Œå¹¶å°†æ¥æ”¶åˆ°çš„æ¶ˆæ¯ä¸­çš„å€¼ç§»å…¥å…¶ä¸­ã€‚ <br><br> æ‚¨å¯ä»¥å›æƒ³èµ·SObjectizerä¸­çš„æ¶ˆæ¯æœ¬èº«æ˜¯åŠ¨æ€åˆ›å»ºçš„å¯¹è±¡ã€‚ è¿™ä¸æ˜¯ä¸€ä¸ªç®€å•çš„å¯¹è±¡ï¼Œè€Œæ˜¯åœ¨å…¶ä¸­åŒ…å«ä¸€ä¸ªé“¾æ¥è®¡æ•°å™¨ã€‚ åœ¨SObjectizerä¸­ï¼Œæœ‰ä¸€ç§é’ˆå¯¹æ­¤ç±»å¯¹è±¡çš„ç‰¹æ®Šç±»å‹çš„æ™ºèƒ½æŒ‡é’ˆ-intrusive_ptr_tã€‚ <br><br> å³ æˆ‘ä»¬æ— æ³•ä¸ºç­‰å¾…çš„è¯·æ±‚é˜Ÿåˆ—åˆ¶ä½œä¸€ä»½resize_request_tçš„å‰¯æœ¬ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ç®€å•åœ°å°†æŒ‡å‘ç°æœ‰resize_request_tå®ä¾‹çš„æ™ºèƒ½æŒ‡é’ˆæ”¾å…¥æ­¤é˜Ÿåˆ—ä¸­ã€‚ æˆ‘ä»¬åšä»€ä¹ˆã€‚ ä¸ºäº†ä¸è‡³äºåœ¨å„å¤„éƒ½å†™ä¸Šç›¸å½“å¤–æ¥çš„åç§°so_5 :: intrusive_ptr_tï¼Œæˆ‘ä»¬è¾“å…¥åˆ«åï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sobj_shptr_t</span></span> = so_5::<span class="hljs-keyword"><span class="hljs-keyword">intrusive_ptr_t</span></span>&lt;T&gt;;</code> </pre><br><h3> å¯¹å®¢æˆ·ç«¯çš„å¼‚æ­¥å“åº” </h3><br> æˆ‘ä»¬è¯´è¿‡HTTPè¯·æ±‚æ˜¯å¼‚æ­¥å¤„ç†çš„ã€‚ å¹¶ä¸”æˆ‘ä»¬åœ¨ä¸Šé¢å±•ç¤ºäº†HTTPæœåŠ¡å™¨å¦‚ä½•é€šè¿‡å¼‚æ­¥æ¶ˆæ¯å°†æŸ¥è¯¢å‘é€åˆ°transform_managerä»£ç†ã€‚ ä½†æ˜¯ï¼Œå¯¹HTTPè¯·æ±‚çš„å“åº”ä¼šå¦‚ä½•ï¼Ÿ <br><br> å“åº”ä¹Ÿå¼‚æ­¥æä¾›ã€‚ ä¾‹å¦‚ï¼Œåœ¨transform_managerä»£ç ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°ä»¥ä¸‹å†…å®¹ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">a_transform_manager_t</span></span>::on_failed_resize( <span class="hljs-keyword"><span class="hljs-keyword">failed_resize_t</span></span> &amp; <span class="hljs-comment"><span class="hljs-comment">/*result*/</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sobj_shptr_t</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">resize_request_t</span></span>&gt; cmd ) { do_404_response( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(cmd-&gt;m_http_req) ); }</code> </pre> <br> å¦‚æœç”±äºæŸç§åŸå› æ— æ³•ç¼©æ”¾å›¾åƒï¼Œåˆ™æ­¤ä»£ç ä¼šå¯¹HTTPè¯·æ±‚äº§ç”Ÿå¦å®šå“åº”ã€‚ å“åº”æ˜¯åœ¨do_404_responseå¸®åŠ©å‡½æ•°ä¸­ç”Ÿæˆçš„ï¼Œå…¶ä»£ç å¯ä»¥è¡¨ç¤ºå¦‚ä¸‹ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">auto</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">do_404_response</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( restinio::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">request_handle_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> req )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> resp = req-&gt;create_response( <span class="hljs-number"><span class="hljs-number">404</span></span>, <span class="hljs-string"><span class="hljs-string">"Not Found"</span></span> ); resp.append_header( restinio::<span class="hljs-keyword"><span class="hljs-keyword">http_field_t</span></span>::server, <span class="hljs-string"><span class="hljs-string">"Shrimp draft server"</span></span> ); resp.append_header_date_field(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( req-&gt;header().should_keep_alive() ) resp.connection_keep_alive(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> resp.connection_close(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resp.done(); }</code> </pre> <br>  do_404_responseï¼ˆï¼‰çš„ç¬¬ä¸€ä¸ªå…³é”®ç‚¹æ˜¯ï¼Œæ­¤å‡½æ•°æ˜¯åœ¨transform_managerä»£ç†çš„å·¥ä½œä¸Šä¸‹æ–‡ä¸Šè€Œä¸æ˜¯åœ¨HTTPæœåŠ¡å™¨çš„å·¥ä½œä¸Šä¸‹æ–‡ä¸Šè°ƒç”¨çš„ã€‚ <br><br> ç¬¬äºŒä¸ªå…³é”®ç‚¹æ˜¯åœ¨å®Œå…¨å½¢æˆçš„respå¯¹è±¡ä¸Šå¯¹doneï¼ˆï¼‰æ–¹æ³•çš„è°ƒç”¨ã€‚ å…·æœ‰HTTPå“åº”çš„æ‰€æœ‰å¼‚æ­¥é­”æœ¯éƒ½åœ¨è¿™é‡Œå‘ç”Ÿã€‚  doneï¼ˆï¼‰æ–¹æ³•è·å–åœ¨respä¸­å‡†å¤‡çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¹¶å°†å…¶å¼‚æ­¥å‘é€åˆ°HTTPæœåŠ¡å™¨ã€‚ å³  HTTPæœåŠ¡å™¨å°†respå¯¹è±¡çš„å†…å®¹æ’é˜Ÿåï¼Œå°†ç«‹å³å‘ç”Ÿdo_404_responseï¼ˆï¼‰çš„è¿”å›ã€‚ <br><br>  HTTPæœåŠ¡å™¨åœ¨å…¶å·¥ä½œä¸Šä¸‹æ–‡ä¸­å°†æ£€æµ‹åˆ°æ–°HTTPå“åº”çš„å­˜åœ¨ï¼Œå¹¶å°†å¼€å§‹æ‰§è¡Œå¿…è¦çš„æ“ä½œä»¥å°†å“åº”å‘é€åˆ°é€‚å½“çš„å®¢æˆ·ç«¯ã€‚ <br><br><h3> ç±»å‹datasizable_blob_t </h3><br> éœ€è¦æ¾„æ¸…çš„å¦ä¸€ç‚¹å¾ˆé‡è¦ï¼Œå› ä¸ºå¦‚æœä¸äº†è§£RESTinioçš„å¤æ‚æ€§ï¼Œè¿™å¯èƒ½æ˜¯éš¾ä»¥ç†è§£çš„ã€‚ ä¹ä¸€çœ‹ï¼Œæˆ‘ä»¬è°ˆè®ºçš„æ˜¯å¥‡æ€ªç±»å‹çš„datasizeable_blob_tçš„å­˜åœ¨ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">datasizable_blob_t</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::enable_shared_from_this&lt; <span class="hljs-keyword"><span class="hljs-keyword">datasizable_blob_t</span></span> &gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">noexcept</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m_blob.data(); } <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">noexcept</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m_blob.length(); } Magick::Blob m_blob; <span class="hljs-comment"><span class="hljs-comment">//! Value for `Last-Modified` http header field. const std::time_t m_last_modified_at{ std::time( nullptr ) }; };</span></span></code> </pre> <br> ä¸ºäº†è§£é‡Šä¸ºä»€ä¹ˆéœ€è¦è¿™ç§ç±»å‹ï¼Œæ‚¨éœ€è¦æ˜¾ç¤ºå¦‚ä½•é€šè¿‡è½¬æ¢åçš„å›¾ç‰‡å½¢æˆHTTPå“åº”ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">serve_transformed_image</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( restinio::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">request_handle_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> req, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">datasizable_blob_shared_ptr_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> blob, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">image_format_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> img_format, http_header::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">image_src_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> image_src, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">header_fields_list_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> header_fields )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> resp = req-&gt;create_response(); set_common_header_fields_for_image_resp( blob-&gt;m_last_modified_at, resp ) .append_header( restinio::http_field::content_type, image_content_type_from_img_format( img_format ) ) .append_header( http_header::shrimp_image_src, image_src_to_str( image_src ) ) .set_body( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move( blob ) ); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> &amp; hf : header_fields ) { resp.append_header( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move( hf.m_name ), <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move( hf.m_value ) ); } resp.done(); }</code> </pre> <br> æˆ‘ä»¬æ³¨æ„å¯¹set_bodyï¼ˆï¼‰çš„è°ƒç”¨ï¼šæŒ‡å‘datasizable_blob_tå®ä¾‹çš„æ™ºèƒ½æŒ‡é’ˆç›´æ¥å‘é€åˆ°é‚£é‡Œã€‚ æ€ä¹ˆäº† <br><br> äº‹å®æ˜¯ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">RESTinioæ”¯æŒå‡ ç§ç”¨äºå½¢æˆHTTPå“åº”æ­£æ–‡çš„é€‰é¡¹</a> ã€‚ æœ€ç®€å•çš„æ–¹æ³•æ˜¯å°†std :: stringç±»å‹çš„å®ä¾‹ä¼ é€’ç»™set_bodyï¼ˆï¼‰ï¼ŒRESTinioä¼šå°†è¯¥å­—ç¬¦ä¸²çš„å€¼ä¿å­˜åœ¨respå¯¹è±¡ä¸­ã€‚ <br><br> ä½†æ˜¯æœ‰æ—¶å€™ï¼Œset_bodyï¼ˆï¼‰çš„å€¼åº”ä¸€æ¬¡åœ¨å¤šä¸ªç­”æ¡ˆä¸­é‡ç”¨ã€‚ ä¾‹å¦‚ï¼Œåœ¨è™¾ä¸­ï¼Œå½“è™¾æ”¶åˆ°å‡ ä¸ªç›¸åŒå›¾åƒè½¬æ¢è¯·æ±‚æ—¶ï¼Œå°±ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚             .   RESTinio   set_body() : <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">auto</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_body</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">shared_ptr</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;T&gt; body)</span></span></span></span>;</code> </pre> <br>       T   :       data()  size(),  ,  RESTinio      . <br><br>    shrimp-     Magick::Blob.   Magic::Blob   data,    size(),    length().     - datasizable_blob_t,   RESTinio       Magick::Blob. <br><br><h3>    transform_manager </h3><br>  transform_manager       : <br><br><ul><li>    ,      ; </li><li>         transformer-. </li></ul><br>  transform_manager      .    . <br><br>    ,       : <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">clear_cache_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> so_5::<span class="hljs-keyword"><span class="hljs-keyword">signal_t</span></span> {}; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">check_pending_requests_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> so_5::<span class="hljs-keyword"><span class="hljs-keyword">signal_t</span></span> {};</code> </pre> <br>    ,       : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">a_transform_manager_t</span></span>::so_define_agent() { so_subscribe_self() .event( &amp;<span class="hljs-keyword"><span class="hljs-keyword">a_transform_manager_t</span></span>::on_resize_request ) .event( &amp;<span class="hljs-keyword"><span class="hljs-keyword">a_transform_manager_t</span></span>::on_resize_result ) .event( &amp;<span class="hljs-keyword"><span class="hljs-keyword">a_transform_manager_t</span></span>::on_clear_cache ) .event( &amp;<span class="hljs-keyword"><span class="hljs-keyword">a_transform_manager_t</span></span>::on_check_pending_requests ); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">a_transform_manager_t</span></span>::on_clear_cache( <span class="hljs-keyword"><span class="hljs-keyword">mhood_t</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">clear_cache_t</span></span>&gt; ) {...} <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">a_transform_manager_t</span></span>::on_check_pending_requests( <span class="hljs-keyword"><span class="hljs-keyword">mhood_t</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">check_pending_requests_t</span></span>&gt; ) {...}</code> </pre> <br>   SObjectizer         . <br><br>         : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">a_transform_manager_t</span></span>::so_evt_start() { m_clear_cache_timer = so_5::send_periodic&lt;<span class="hljs-keyword"><span class="hljs-keyword">clear_cache_t</span></span>&gt;( *<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, clear_cache_period, clear_cache_period ); m_check_pending_timer = so_5::send_periodic&lt;<span class="hljs-keyword"><span class="hljs-keyword">check_pending_requests_t</span></span>&gt;( *<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, check_pending_period, check_pending_period ); }</code> </pre> <br>    â€”   timer_id,    send_periodic().         ,    timer_id. ,   send_periodic()   ,        .    a_transform_manager_t   : <br><br><pre> <code class="cpp hljs">so_5::<span class="hljs-keyword"><span class="hljs-keyword">timer_id_t</span></span> m_clear_cache_timer; so_5::<span class="hljs-keyword"><span class="hljs-keyword">timer_id_t</span></span> m_check_pending_timer;</code> </pre> <br><h1>    </h1><br>           shrimp-.   ,  ,  RESTinio  SObjectizer     - -    ,     HelloWorld.       . <br><br> ,   transform_manager     .      ,       .                   ,        .    .        ,      ,     . <br><br>                 transform_manager.       ,      â€”    . <br><br>     shrimp-    Â« Â»,       .       ,    . ,  ,  shrimp     . <br><br>         shrimp-           .   stay tuned. <br><br>   -      shrimp-, RESTinio  SObjectizer-,       .  ,    shrimp â€”   ,   -         shrimp- - ,   resize,    ,        . <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¾…ç»­...</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN416387/">https://habr.com/ru/post/zh-CN416387/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN416375/index.html">åˆå­¦è€…çš„JavaScriptåŸºç¡€</a></li>
<li><a href="../zh-CN416377/index.html">æˆ‘ä»¬æˆä¸ºç¼–ç¨‹å‘å¯¼ã€‚ ç¬¬ä¸€éƒ¨åˆ†</a></li>
<li><a href="../zh-CN416379/index.html">ç¥ç»è™«ã€‚ æˆ‘ä»¬å¦‚ä½•æ¯”æ–¯å¦ç¦å¤§å­¦æ—©ä¸€å¹´æ•™ç¥ç»ç½‘ç»œå‘æ˜æ¨¡å› </a></li>
<li><a href="../zh-CN416381/index.html">2018å¹´ç½—é©¬ä¿±ä¹éƒ¨æŠ¥å‘Šï¼Œç¬¬3.13ç« ï¼šæ…ˆå–„äº‹ä¸šï¼ŒæŠ•èµ„ï¼Œä¼—åŒ…å’ŒåŒºå—é“¾</a></li>
<li><a href="../zh-CN416385/index.html">å¦‚æœç›¸å…³æ€§è¾¾åˆ°100ï¼…ï¼Œé‚£ä¹ˆæŸä¸ªåœ°æ–¹çš„é”™è¯¯å°±ä¼šè”“å»¶ï¼šRambler Groupçš„å®ä¹ ç»å†</a></li>
<li><a href="../zh-CN416391/index.html">ä¼˜åŒ–æœåŠ¡å™¨ä¸Šâ€‹â€‹è™šæ‹Ÿæœºçš„æ”¾ç½®</a></li>
<li><a href="../zh-CN416393/index.html">IIDFä¼šè®®ï¼šå…¬å¸ä¸æ˜¯åˆåˆ›å…¬å¸</a></li>
<li><a href="../zh-CN416397/index.html">æˆ‘ä»¬ä½¿ç”¨Page Objectæ¨¡å¼è‡ªåŠ¨æ‰§è¡ŒAndroidåº”ç”¨ç¨‹åºçš„UIæµ‹è¯•</a></li>
<li><a href="../zh-CN416399/index.html">æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨æœºå™¨å­¦ä¹ åˆ†æç§»åŠ¨åº”ç”¨è¯„è®º</a></li>
<li><a href="../zh-CN416401/index.html">Blenderï¼šç”¨äºè¿æ¥åˆ°KiCadåº“çš„èŠ¯ç‰‡çš„3Dæ¨¡å‹</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>