<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍨 🛕 👩‍❤️‍👨 Funktionen zum Herstellen einer Verbindung zwischen Teilnehmern in einem Peer-to-Peer-Netzwerkspiel 👩🏾‍🚒 🉑 🔸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dies ist eine Sammlung von Informationen, die ich zum Herstellen einer Verbindung zwischen Teilnehmern in einem Peer-to-Peer-Netzwerkspiel mithilfe de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Funktionen zum Herstellen einer Verbindung zwischen Teilnehmern in einem Peer-to-Peer-Netzwerkspiel</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485576/"> Dies ist eine Sammlung von Informationen, die ich zum Herstellen einer Verbindung zwischen Teilnehmern in einem Peer-to-Peer-Netzwerkspiel mithilfe des UDP-Protokolls benötigte. <br><br>  Der Artikel richtet sich an Entwickler von Einsteigerspielen.  Ich habe versucht, einen Artikel zu schreiben, den ich selbst gerne zu einem Zeitpunkt gelesen hätte, als ich gerade anfing, dieses Thema zu verstehen: Damit alle notwendigen Nuancen an einem Ort gesammelt werden und gleichzeitig nichts überflüssig ist, in einfacher Sprache und mit visuellen Bildern.  Vielleicht wird jemand nützlich sein. <br><br>  Erfahrene Spieleentwickler werden hier wohl kaum etwas Neues für sich finden.  Aber ich werde für die Kommentare und Kommentare dankbar sein. <br><br><div style="text-align:center;"> <a href="https://habr.com/ru/post/485576/"><img src="https://habrastorage.org/webt/pg/wy/7h/pgwy7h2hgc0rws8_5-btx0brno8.png"></a> </div><br><a name="habracut"></a><br><h2>  Netzwerkspiel mit Peer-to-Peer-Architektur </h2><br><ul><li>  Jeder Spieler speichert den gesamten Status der Spielwelt und verarbeitet ihn synchron mit anderen Spielern.  Jeder Spieler gibt die Aktionen des Benutzers an alle anderen Spieler weiter.  Der Hauptspieler, der die anderen Spieler einsammelt, heißt Server und der Rest sind Clients.  Der Server ist der wichtigste nur in der Phase des Sammelns von Spielern.  Und während des Spiels gibt es keinen Hauptcomputer. <br></li><li>  Dieser Ansatz weist die folgenden Merkmale auf: <br><ul><li>  Der Verkehr hängt nicht von der Komplexität der Spielwelt ab, sondern nur von der Anzahl der Spieler.  In diesem Modus funktionieren normalerweise <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D1%2582%25D1%2580%25D0%25B0%25D1%2582%25D0%25B5%25D0%25B3%25D0%25B8%25D1%258F_%25D0%25B2_%25D1%2580%25D0%25B5%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D0%25BE%25D0%25BC_%25D0%25B2%25D1%2580%25D0%25B5%25D0%25BC%25D0%25B5%25D0%25BD%25D0%25B8" rel="nofollow">Echtzeitstrategien</a> , bei denen Sie Tausende von Einheiten verarbeiten müssen. <br></li><li>  Das Verkehrsaufkommen liegt in der Größenordnung von N², wobei N die Anzahl der Spieler ist.  Daher ist dieser Ansatz nur für Spiele mit einer kleinen Anzahl von Spielern anwendbar. <br></li><li>  Da die Daten ohne Zwischenserver direkt zwischen den Spielern übertragen werden, sind die Übertragungsverzögerungen minimal.  Wenn jedoch mindestens einer der Spieler Kommunikationsprobleme hat, sind alle Spieler davon betroffen. <br></li><li>  Es ist notwendig, Kommunikationskanäle zwischen allen Spielern herzustellen.  Wenn sich die Spieler jedoch in verschiedenen lokalen Netzwerken befinden, ist dies nicht immer möglich. <br></li></ul></li><li>  Sie können TCP oder UDP verwenden, um Daten im Spiel zu übertragen. <br><ul><li>  <a href="https://ru.wikipedia.org/wiki/Transmission_Control_Protocol" rel="nofollow">TCP (Transmission Control Protocol)</a> bietet eine zuverlässige Byte-Stream-Übermittlung.  Dies vereinfacht die Implementierung des Spiels, es gibt jedoch keine Kontrolle über Datenübertragungsverzögerungen. <br></li><li>  <a href="https://ru.wikipedia.org/wiki/UDP" rel="nofollow">UDP (User Datagram Protocol)</a> ist ein einfaches Paketübertragungsprotokoll ohne Gewähr für deren Zustellung.  Aufgrund seiner Einfachheit wird UDP jedoch in Echtzeitsystemen verwendet, wenn es nicht akzeptabel ist, auf verzögerte oder verlorene Pakete zu warten.  Die Verwendung von UDP kann Verzögerungen im Spiel verringern, erschwert jedoch die Implementierung des Spiels. <br></li></ul>  Dieser Artikel beschreibt die Verwendung von UDP. <br></li></ul><br><h2>  Herstellen einer Verbindung im lokalen Netzwerk </h2><br><ul><li>  Um eine Verbindung zwischen Spielern herzustellen, muss der Client die IP-Adresse des Servers und den Port kennen, den das Spielprogramm abhört. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/n3/di/2u/n3di2usgoz4bj4cyqcmbk3txocy.png"></div><br><ul><li>  Beispielsweise hat der Computer von Spieler A eine IP-Adresse von 192.168.1.2 im lokalen Netzwerk.  Spieler A startet das Spielprogramm auf seinem Computer im Servermodus und das Programm lauscht auf Port 50120. Spieler A kommuniziert diese Informationen irgendwie mit Spieler B. <br></li><li>  Der Computer von Spieler B hat eine IP-Adresse von 192.168.1.5 im lokalen Netzwerk.  Spieler B startet das Spielprogramm auf seinem Computer im Client-Modus und das Programm belegt Port 50150. Spieler B gibt die Serveradresse 192.168.1.2►0120 in das Spielprogramm ein und das Programm sendet eine Anfrage an den Server an die angegebene Adresse. <br></li><li>  Der Server befindet sich im Standby-Modus. Nachdem er eine Anfrage von Spieler B erhalten hat, ermittelt er seine Adresse 192.168.1.5►0150.  Somit haben der Client und der Server eine Verbindung hergestellt und können das Spiel starten. <br></li></ul></li><li>  Wenn mehrere Clients mit dem Server verbunden sind, muss der Server jedem die Adressen anderer Clients senden. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/f9/zu/zg/f9zuzgexmd5bqe8fxgypsynspyu.png"></div><br>  In dem Beispiel in der Abbildung sendet Server A die Adresse von Client C (192.168.1.6►0160) an Client B und sendet die Adresse von Client B (192.168.1.5►0150) an Client C.  Auf diese Weise können alle Spieler Verbindungen "mit jedem" herstellen. <br></li><li>  Bei jedem Spielstart kann der Server einen beliebigen freien Port vom Betriebssystem anfordern.  Es ist jedoch praktischer, immer denselben Port zu verwenden, damit der Client nicht jedes Mal einen neuen Port eingeben muss. <br><br>  Alle Ports sind in drei Bereiche unterteilt: <br><ul><li>  [0, 1023] - bekannt (systemisch). <br></li><li>  [1024, 49151] - registriert (Benutzer).  Der Port für den Server muss in diesem Bereich ausgewählt werden. <br></li><li>  [49152, 65535] - dynamisch (privat).  Hier weist das Betriebssystem temporäre Ports für Programme zu. <br></li></ul><br>  Auf Wikipedia sehen Sie eine Liste der <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25BF%25D0%25B8%25D1%2581%25D0%25BE%25D0%25BA_%25D0%25BF%25D0%25BE%25D1%2580%25D1%2582%25D0%25BE%25D0%25B2_TCP_%25D0%25B8_UDP" rel="nofollow">reservierten Ports</a> .  Als nächstes wird beispielsweise Port 49094 für den Spieleserver ausgewählt. <br></li><li>  Ein Computer kann über mehrere Netzwerkschnittstellen verfügen, sowohl echte (Ethernet, WiFi) als auch virtuelle (VPN).  Jede Netzwerkschnittstelle hat eine eigene IP-Adresse.  Das Programm kann dem Serverbenutzer die Möglichkeit geben, die Netzwerkschnittstelle auszuwählen, über die er auf Clientanforderungen wartet.  Es ist jedoch praktisch, eine spezielle Wildcard-IP-Adresse <a href="https://en.wikipedia.org/wiki/0.0.0.0" rel="nofollow">0.0.0.0 zu verwenden</a> .  Wenn das Programm einen Socket mit dieser IP-Adresse öffnet, überwacht es den angegebenen Port für alle Netzwerkschnittstellen dieses Computers.  Somit muss der Player nicht überlegen, welche Netzwerkschnittstelle er auswählen soll. <br></li><li>  Sie können dem Client auch helfen und die IP-Adresse des Servers automatisch ermitteln.  Wenn der Client eine Anfrage an eine spezielle <a href="https://ru.wikipedia.org/wiki/%25D0%25A8%25D0%25B8%25D1%2580%25D0%25BE%25D0%25BA%25D0%25BE%25D0%25B2%25D0%25B5%25D1%2589%25D0%25B0%25D1%2582%25D0%25B5%25D0%25BB%25D1%258C%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25B0%25D0%25B4%25D1%2580%25D0%25B5%25D1%2581" rel="nofollow">Broadcast-IP-Adresse (Broadcast) sendet</a> , werden diese von allen Computern im lokalen Netzwerk empfangen. <br><br>  Wenn die Netzwerkadresse beispielsweise 192.168.1.0 lautet, die Subnetzmaske 255.255.255.0 lautet, lautet die Broadcast-IP-Adresse 192.168.1.255. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/4y/yj/ot/4yyjotxuzbtirqk2pewwm_npmd8.png"></div><br>  Wenn alle Spieleserver den Port 49094 abhören, wird das an die Adresse 192.168.1.255-00-009094 gesendete Paket von allen Spieleservern in diesem Netzwerk empfangen.  Jeder Server sendet eine Bestätigung an den Absender.  Auf diese Weise erhält der Client eine Liste aller Spieleserver in seinem Netzwerk und kann den Server auswählen, den er benötigt. <br></li><li>  Wenn sich alle Spieler im selben lokalen Netzwerk befinden, ist es ganz einfach, Verbindungen "mit jedem" herzustellen.  Aufgrund der Firewall können Probleme mit dem Clientzugriff auf den Serverport auftreten.  Dies hängt jedoch vom Betriebssystem und den Sicherheitseinstellungen ab. <br></li></ul><br><h2>  Herstellen einer Verbindung von einem lokalen Netzwerk zu einem Server im Internet </h2><br><ul><li>  Computer sind in der Regel nicht direkt, sondern über einen Router mit dem Internet verbunden.  In der Regel führt der Router eine <a href="https://ru.wikipedia.org/wiki/NAT" rel="nofollow">Netzwerkadressübersetzung (NAT, Network Address Translation) durch</a> . <br><br>  Beispielsweise befindet sich Client C im lokalen Netzwerk und hat über Router B Zugriff auf das Internet, während Server A über eine öffentliche IP-Adresse im Internet verfügt.  Lassen Sie sie die folgenden Adressen haben: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gq/cf/qt/gqcfqtu-vneghva8qq7v2do7lxo.png"></div><br><ul><li>  Die Internetadresse von Server A lautet 203.0.113.2.  Das Serverprogramm überwacht Port 49094. <br></li><li>  Die Adresse von Router B im Internet lautet 203.0.113.5.  Die Adresse von Router B im lokalen Netzwerk lautet 192.168.1.1. <br></li><li>  Die Client-C-Adresse im lokalen Netzwerk lautet 192.168.1.5.  Das Client-Programm belegt Port 50150 und sendet unter 203.0.113.2-00-009094 ein Paket an den Server. <br></li><li>  Router B ist das <a href="https://ru.wikipedia.org/wiki/%25D0%25A8%25D0%25BB%25D1%258E%25D0%25B7_%25D0%25BF%25D0%25BE_%25D1%2583%25D0%25BC%25D0%25BE%25D0%25BB%25D1%2587%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258E" rel="nofollow">Standard-Gateway</a> in seinem lokalen Netzwerk.  Das heißt, alle Pakete mit Adressen, die nicht aus dem aktuellen lokalen Netzwerk stammen, werden an dieses gesendet. <br></li><li>  Der Router verfügt über eine Adressübersetzungstabelle: (interne Adresse: interner Port) - (externe Adresse: externer Port).  Nachdem der Router ein Paket vom Client an den Server 203.0.113.2-00-009094 empfangen hat, wählt er einen freien externen Port aus, z. B. 52050, und erstellt einen Eintrag in der Adressübersetzungstabelle: 192.168.1.5►0150 - 203.0.113.5►2050. <br></li><li>  Der Router ersetzt die interne Adresse des Absenders 192.168.1.5/100150 im Paket durch die externe Adresse 203.0.113.5/102050 und überträgt das geänderte Paket an den Server. <br></li><li>  Der Server empfängt ein Paket mit der Absenderadresse 203.0.113.5► 2020 und sendet eine Antwort an diese Adresse, dh an den Router. <br></li><li>  Nachdem der Router das Paket vom Server empfangen hat, sucht er in seiner Adressübersetzungstabelle nach der Empfängeradresse, ersetzt die externe Adresse 203.0.113.5►2050 des Empfängers in umgekehrter Reihenfolge durch die interne Adresse 192.168.1.5►0150 und sendet das Paket an diese Adresse, dh den Client. <br></li><li>  Wenn der Client nachfolgende Pakete an den Server sendet, überprüft der Router anhand der Absenderadresse, ob ein solcher Datensatz bereits in der Tabelle vorhanden ist, und verwendet in diesem Fall den zuvor zugewiesenen externen Port, in diesem Fall 52050. <br></li><li>  Somit haben der Client und der Server eine Verbindung über NAT hergestellt und können das Spiel starten.  Der Server kennt jedoch nicht die interne Adresse des Clients in seinem lokalen Netzwerk und geht davon aus, dass der Client ein Router ist. <br></li><li>  Der Eintrag in der Adressübersetzungstabelle ist für einen bestimmten Zeitraum gültig, normalerweise 1-3 Minuten.  Daher müssen Client und Server regelmäßig Pakete austauschen, damit der Datensatz, der sie verbindet, nicht gelöscht wird.  Wenn der Client nach dem Löschen des Datensatzes ein neues Paket an den Server sendet, kann dem neuen Datensatz auf dem Router ein anderer externer Port zugewiesen werden. Für den Server ist dies ein anderer Client mit einer anderen Adresse. <br></li></ul></li><li>  Der Router des Benutzers ist in der Regel nicht direkt mit dem Internet verbunden, sondern befindet sich im internen Netzwerk des Internetproviders.  Das heißt, der Client befindet sich hinter zwei NATs. <br><br>  Zum Beispiel so: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/7u/ht/cw/7uhtcwvuy-lojgg6_sxifcd_ucc.png"></div><br>  Das heißt, eine doppelte Übersetzung von Netzwerkadressen wird durchgeführt. <br></li><li>  Es gibt verschiedene Arten von NAT: <br><ul><li>  Vollkegel NAT <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gn/ar/8u/gnar8u7m0xlyigrhgihadyqe0d0.png"></div><br><ul><li>  Nachdem ein Eintrag in der Adressübersetzungstabelle (interne Adresse: interner Port) - (externe Adresse: externer Port) erstellt wurde, werden alle Pakete vom Absender (interne Adresse: interner Port) über (externe Adresse: externer Port) an eine beliebige Empfängeradresse übertragen. <br></li><li>  Jeder externe Server kann Pakete senden an (interne Adresse: interner Port), Pakete senden an (externe Adresse: externer Port). <br></li></ul>  Beispielsweise sendet Client C Pakete an Server A und D mit derselben externen Adresse 203.0.113.5► 202050.  Wenn Server E ein Paket an diese Adresse 203.0.113.5► 202050 sendet, leitet der Router es an Client C weiter. <br></li><li>  Adressbeschränkter Kegel NAT. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/i6/on/ao/i6onaojluqotmemktgufswzg-ia.png"></div><br><ul><li>  Nachdem ein Eintrag in der Adressübersetzungstabelle (interne Adresse: interner Port) - (externe Adresse: externer Port) erstellt wurde, werden alle Pakete vom Absender (interne Adresse: interner Port) über (externe Adresse: externer Port) an eine beliebige Empfängeradresse übertragen. <br></li><li>  Ein externer Server (Serveradresse: Server-Port) kann Pakete nur dann an (interne Adresse: interner Port) und an (externe Adresse: externer Port) senden, wenn zuvor (interne Adresse: interner Port) Pakete an (Serveradresse: beliebig) gesendet wurden Hafen). <br></li></ul>  Beispielsweise sendet Client C Pakete an Server A und D mit derselben externen Adresse 203.0.113.5► 202050.  Server D kann über die Router-Adresse 203.0.113.5► 202050 von jedem seiner Ports ein Paket an Client C senden.  Der Router leitet jedoch keine Pakete vom Server E weiter. <br></li><li>  Portbeschränkter Kegel NAT. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/kr/6v/di/kr6vdi2regppcywwajtz-1basdy.png"></div><br><ul><li>  Nachdem ein Eintrag in der Adressübersetzungstabelle (interne Adresse: interner Port) - (externe Adresse: externer Port) erstellt wurde, werden alle Pakete vom Absender (interne Adresse: interner Port) über (externe Adresse: externer Port) an eine beliebige Empfängeradresse übertragen. <br></li><li>  Ein externer Server (Serveradresse: Serverport) kann Pakete an (interne Adresse: interner Port) und Pakete an (externe Adresse: externer Port) nur dann senden, wenn (interne Adresse: interner Port) zuvor Pakete an (Serveradresse: Port) gesendet haben Server). <br></li></ul>  Beispielsweise sendet Client C Pakete an Server A und D mit derselben externen Adresse 203.0.113.5► 202050.  Der Router leitet keine Pakete von Server E oder einem anderen Server-Port D weiter. <br></li><li>  Symmetrisches NAT (Symmetric NAT). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/98/ha/lr/98halr7veiq_ibj_irj2lxixcec.png"></div><br><ul><li>  Wenn derselbe interne Absender (interne Adresse: interner Port) Pakete an verschiedene Empfänger sendet (Serveradresse: Serverport), wird für jede Empfängeradresse ein separater externer Port zugewiesen und ein separater Eintrag in der Adressübersetzungstabelle verwendet. <br></li><li>  Nur der externe Server (Serveradresse: Serverport), der das Paket vom internen Absender empfangen hat (interne Adresse: interner Port), kann das Paket zurücksenden. <br></li></ul>  Beispielsweise sendet Client C Pakete an Server A unter Verwendung einer externen Adresse 203.0.113.5► 202050 und an Server D unter Verwendung einer anderen externen Adresse 203.0.113.5. 20201.  Der Router leitet keine Pakete von Server E oder einem anderen Server-Port D weiter. <br></li></ul></li><li>  Wenn mehrere Clients mit dem Spielserver verbunden sind, müssen Sie für ein Peer-to-Peer-Spiel eine direkte Verbindung zwischen jedem Clientpaar herstellen, das den Server umgeht. <br><br>  Zum Beispiel zwei Clients C und E, die mit Server A verbunden sind: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ai/if/ym/aiifymcc-epffu0da8rkksj_4es.png"></div><br><ul><li>  Client C hat eine interne Adresse von 192.168.1.5/100150 und eine externe Adresse von 203.0.113.5/102050. <br></li><li>  Client E hat eine interne Adresse von 192.168.2.5:50250 und eine externe Adresse von 203.0.113.6-062060. <br></li><li>  Der Server muss jedem Client die externe Adresse des anderen Clients mitteilen. <br></li><li>  In der Regel verwenden Router einen NAT-Konus mit eingeschränkten Ports.  Der Router leitet Pakete nur von dem Absender (IP-Adresse und Port) an den Client weiter, an den der Client früher Pakete gesendet hat.  Und wenn Client C ein Paket an Client E sendet, wird Router D dieses Paket nicht verpassen. <br></li><li>  In diesem Fall wird die <a href="https://en.wikipedia.org/wiki/UDP_hole_punching" rel="nofollow">UDP-Lochmethode</a> verwendet.  Beide Clients müssen sich gegenseitig UDP-Pakete senden.  Sobald Client C ein Paket an Client E sendet, ist Router B bereit, Pakete von Client E zu empfangen. Sobald Client E ein Paket an Client C sendet, ist Router D ebenfalls bereit, Pakete von Client C zu empfangen. Die ersten Pakete des Clients, der gestartet wurde Die erste Übertragung geht verloren.  Sobald jedoch der zweite Client beginnt, Pakete zu senden, können beide Clients Pakete austauschen. <br></li><li>  Wenn der Router jedoch symmetrisches NAT verwendet, wird jedem Empfänger ein neuer externer Port zugewiesen.  In der Regel lässt sich nicht herausfinden, welchen Port der Router zugewiesen hat.  Wenn mindestens einer der Router Symmetric NAT verwendet, ist es daher nicht möglich, eine Verbindung zwischen Clients herzustellen. <br></li></ul></li><li>  Befinden sich zwei Clients im selben lokalen Netzwerk, kennen sie nur die externen Adressen des jeweils anderen. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/jj/si/a4/jjsia4y7k50gk3esxa_5hvzx3ks.png"></div><br>  Beispielsweise sendet Client C ein Paket an Client D an seiner externen Adresse 203.0.113.5Point2051.  Router B muss dieses Paket so verarbeiten, als ob es von einem externen Netzwerk empfangen wurde, die Empfängeradresse 203.0.113.5► 20205 durch die interne Adresse von Client D 192.168.1.6►0060 ersetzen und das Paket an Client D zurück an das lokale Netzwerk senden.  Diese Router-Funktion wird als <a href="https://ru.wikipedia.org/wiki/NAT" rel="nofollow">NAT-Loopback</a> ( <a href="https://en.wikipedia.org/wiki/Hairpinning" rel="nofollow">NAT-Hairpinning</a> ) bezeichnet.  Wenn NAT-Loopback auf dem Router deaktiviert ist, kann keine Verbindung zwischen Clients hergestellt werden. <br></li><li>  Clients können sich in verschiedenen lokalen Netzwerken befinden, haben jedoch über einen gemeinsamen Internetanbieter Zugriff auf das Internet. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/q8/dj/yo/q8djyoaqbhaq6z3_wxc7_afbphk.png"></div><br>  Wenn der NAT-Loopback auf dem Gerät des Internetdienstanbieters deaktiviert ist, kann keine Verbindung zwischen Clients hergestellt werden. <br></li><li>  Was kann ich tun, wenn auf dem Router symmetrisches NAT verwendet wird oder der NAT-Loopback deaktiviert ist? <br><br>  Soweit ich weiß, besteht die einzige zuverlässige Möglichkeit, diese Probleme zu lösen, darin, Pakete nicht direkt zwischen Clients, sondern über einen Server zu übertragen.  Es ist entweder erforderlich, diese Funktion im Rahmen der Peer-to-Peer-Architektur im Spielprogramm zu implementieren oder die Client-Server-Architektur zu implementieren. <br><br>  Sie können auch Drittanbieterprogramme verwenden, um ein VPN zu erstellen, z. B. <a href="https://ru.wikipedia.org/wiki/LogMeIn_Hamachi" rel="nofollow">LogMeIn Hamachi</a> . <br></li></ul><br><h2>  Herstellen einer Verbindung zwischen LANs im Internet </h2><br><ul><li>  In der Regel hat keiner der Spieler eine öffentliche IP-Adresse und die Spieler befinden sich in verschiedenen lokalen Netzwerken hinter NAT. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/56/cr/up/56crup-geun05fnbtaokha2vqia.png"></div><br>  In diesem Schema sendet Client C beispielsweise Pakete an Server A unter seiner externen Adresse 203.0.113.2-022020, in der der Port von Router B ausgewählt wird. Daher spielt die Auswahl des internen Ports von Server A keine Rolle, und Sie können einen beliebigen Port auswählen.  In diesem Fall kann Server A anstelle von Port 49094 einen beliebigen freien Port vom Betriebssystem anfordern, z. B. 50120. <br></li><li>  Damit Server A und Client C eine Verbindung herstellen können, muss jeder von ihnen zunächst seine externe Adresse herausfinden. <br><br>  Hierfür können Sie das <a href="https://ru.wikipedia.org/wiki/STUN" rel="nofollow">STUN-</a> Protokoll <a href="https://ru.wikipedia.org/wiki/STUN" rel="nofollow">(Session Traversal Utilities for NAT) verwenden</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sk/lj/cm/skljcmi1c5ztbt6law8nf_ylsy0.png"></div><br>  Das STUN-Protokoll ermöglicht es dem Client, der sich hinter NAT befindet, seine externe IP-Adresse und seinen Port zu bestimmen. <br><br>  STUN-Nachrichten werden in UDP-Paketen gesendet. <br><br>  Der Client kann auf jeden öffentlichen STUN-Server zugreifen.  Eine Liste der öffentlichen STUN-Server finden Sie auf <a href="https://ru.wikipedia.org/wiki/STUN" rel="nofollow">Wikipedia</a> .  Oder suchen Sie nach der <a href="https://www.google.com/search%3Fq%3Dpublic%2BSTUN%2Bservers%2Blist" rel="nofollow">Liste der öffentlichen STUN-Server</a> . <br><br>  Diese Methode ist nicht anwendbar, wenn mindestens einer der Player am Router „Symmetric NAT“ verwendet. <br></li><li>  Nachdem jeder der Spieler seine externe Adresse erfahren hat, muss er irgendwie allen anderen Spielern seine Adresse mitteilen. <br><br>  Damit die Spieler ihre Adressen austauschen können, kannst du deinen öffentlichen Server benutzen.  Im Diagramm wird es als Adressserver bezeichnet. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ev/e_/fi/eve_fiqezp76wwmjfexsb0vlzka.png"></div><br>  Dies erfordert nicht unbedingt einen dedizierten Server.  Sie können jedes Hosting mit einem <a href="https://ru.wikipedia.org/wiki/%25D0%2592%25D0%25B5%25D0%25B1-%25D1%2581%25D0%25B5%25D1%2580%25D0%25B2%25D0%25B5%25D1%2580" rel="nofollow">Webserver</a> und mit der Unterstützung einer beliebigen Skriptsprache wie PHP verwenden.  Unter Verwendung des <a href="https://ru.wikipedia.org/wiki/HTTP" rel="nofollow">HTTP-Protokolls muss</a> jeder Spieler seine externe Adresse an den Adressenserver senden.  Und dann fordern Sie die Adressen aller anderen Spieler an. <br></li><li>  Beispielsweise kann jeder Spieleserver seine eindeutige Kennung (Spiel-ID) auf dem Adressenserver registrieren.  Sie können eine beliebige Zeichenfolge als Spiel-ID verwenden, z. B. den Kurznamen (Alias) des Serverbenutzers.  Der Serverbenutzer teilt die Spiel-ID irgendwie den Spielern mit, die er zu seinem Spiel einladen möchte.  Und diese Spieler können dem Spiel beitreten, indem sie über die Spiel-ID vom Adressenserver die externen Adressen aller Teilnehmer an diesem Spiel anfordern. <br></li><li>  Nachdem jeder Spieler die externen Adressen aller anderen Spieler erhalten hat, kann er mithilfe der <a href="https://en.wikipedia.org/wiki/UDP_hole_punching" rel="nofollow">UDP-Hole-Punch-Methode</a> Verbindungen zwischen den einzelnen Spielern herstellen. <br></li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de485576/">https://habr.com/ru/post/de485576/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de485556/index.html">Es dauerte 12 Jahre, um einen Abschnitt der Drosophila-Hirnkarte zu erstellen, die Bemühungen von 250 Menschen und 40 Millionen US-Dollar</a></li>
<li><a href="../de485558/index.html">Keine Mücken! Übersicht der Mücke "Phyto-Munition"</a></li>
<li><a href="../de485562/index.html">Surfen im Internet mit einem Gamepad (Javascript)</a></li>
<li><a href="../de485564/index.html">Reverse Engineering des Ngrok v2-Protokolls</a></li>
<li><a href="../de485570/index.html">Zusammenstellung von Routen für ILV-Listen und Bedrohung seriöser Dienste</a></li>
<li><a href="../de485578/index.html">Mahjong mit Kindern: für was, wann und wie</a></li>
<li><a href="../de485582/index.html">Paul Graham: „Ein Investor als Tierherde“ (2013)</a></li>
<li><a href="../de485584/index.html">Die Verdauung von frischen Materialien aus der Welt des Frontends für die letzte Woche Nr. 399 (20. - 26. Januar 2020)</a></li>
<li><a href="../de485586/index.html">Paul Graham: Ideen für Startups (Ideas for Startups, 2005)</a></li>
<li><a href="../de485592/index.html">PHP Digest Nr. 172 (14.-27. Januar 2020)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>