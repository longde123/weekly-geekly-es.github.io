<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçüíº üëÇüèª üà∑Ô∏è 1,1 Milliarden Taxifahrten: 108-Kern-ClickHouse-Cluster üòú ‚õìÔ∏è ‚ÜóÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Eine √úbersetzung des Artikels wurde speziell f√ºr Studenten des Data Engineer- Kurses erstellt. 




 ClickHouse ist eine Open Source- Spaltendatenbank...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>1,1 Milliarden Taxifahrten: 108-Kern-ClickHouse-Cluster</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/463665/">  <i>Eine √úbersetzung des Artikels wurde speziell f√ºr Studenten des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Data Engineer-</a> Kurses erstellt.</i> <br><br><img src="https://habrastorage.org/webt/tn/35/7p/tn357puvfbdxdyajjdoxagm47ju.png"><br><br><hr><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ClickHouse</a> ist eine Open Source- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Spaltendatenbank</a> .  Dies ist eine gro√üartige Umgebung, in der Hunderte von Analysten schnell detaillierte Daten anfordern k√∂nnen, selbst wenn pro Tag zig Milliarden neuer Eintr√§ge eingef√ºhrt werden.  Die Infrastrukturkosten f√ºr die Unterst√ºtzung eines solchen Systems k√∂nnen 100.000 US-Dollar pro Jahr erreichen und je nach Nutzung m√∂glicherweise halb so hoch sein.  Irgendwann enthielt die Installation von Yandex.Metrica ClickHouse 10 Billionen Eintr√§ge.  Neben Yandex war ClickHouse auch mit Bloomberg und Cloudflare erfolgreich. <a name="habracut"></a><br><br>  Vor zwei Jahren habe ich eine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">vergleichende Analyse</a> von Datenbanken mit einem einzigen Computer durchgef√ºhrt und es wurde <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">die schnellste</a> kostenlose Datenbanksoftware, die ich je gesehen habe.  Seitdem haben Entwickler nicht aufgeh√∂rt, Funktionen hinzuzuf√ºgen, einschlie√ülich der Unterst√ºtzung f√ºr Kafka-, HDFS- und ZStandard-Komprimierung.  Letztes Jahr haben sie Unterst√ºtzung f√ºr kaskadierende Komprimierungsmethoden hinzugef√ºgt, und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Delta-Delta-</a> Codierung wurde m√∂glich.  Beim Komprimieren von Zeitreihendaten k√∂nnen Messwerte mithilfe der Delta-Codierung gut komprimiert werden. Es ist jedoch besser, die Delta-Delta-Codierung f√ºr Z√§hler zu verwenden.  Eine gute Komprimierung ist zum Schl√ºssel f√ºr die Leistung von ClickHouse geworden. <br><br>  ClickHouse besteht mit Ausnahme von Bibliotheken von Drittanbietern aus 170.000 Zeilen C ++ - Code und ist eine der kleinsten Codedatenbanken f√ºr verteilte Datenbanken.  Zum Vergleich: SQLite unterst√ºtzt keine Verteilung und besteht aus 235.000 Codezeilen in der Sprache C. Zum Zeitpunkt dieses Schreibens haben 207 Ingenieure zu ClickHouse beigetragen, und die Intensit√§t der Festschreibungen hat in letzter Zeit zugenommen. <br><br>  Im M√§rz 2017 startete ClickHouse ein <a href="">√Ñnderungsprotokoll</a> , um die Entwicklung auf einfache Weise zu verfolgen.  Sie teilen auch die monolithische Dokumentationsdatei in eine Markdown-basierte Dateihierarchie auf.  Probleme und Funktionen werden √ºber GitHub verfolgt, und insgesamt ist diese Software in den letzten Jahren viel zug√§nglicher geworden. <br><br>  In diesem Artikel werde ich einen Blick auf die Leistung von ClickHouse-Clustern unter AWS EC2 mit 36-Kern-Prozessoren und einem NVMe-Laufwerk werfen. <br><blockquote>  UPDATE: Eine Woche nach der ersten Ver√∂ffentlichung dieses Beitrags habe ich den Test mit einer verbesserten Konfiguration erneut ausgef√ºhrt und viel bessere Ergebnisse erzielt.  Dieser Beitrag wurde aktualisiert, um diese √Ñnderungen widerzuspiegeln. </blockquote><h3>  Starten eines AWS EC2-Clusters </h3><br>  Ich werde drei Instanzen von c5d.9xlarge EC2 f√ºr diesen Beitrag verwenden.  Jede von ihnen enth√§lt 36 virtuelle CPUs, 72 GB RAM, 900 GB NVMe-SSD und unterst√ºtzt ein 10-Gigabit-Netzwerk.  Sie kosten in der Region eu-west-1 jeweils 1.962 USD / Stunde, wenn sie auf Anfrage eingef√ºhrt werden.  Ich werde Ubuntu Server 16.04 LTS als Betriebssystem verwenden. <br><br>  Die Firewall ist so konfiguriert, dass jeder Computer ohne Einschr√§nkungen miteinander kommunizieren kann und nur meine IPv4-Adresse im SSH-Cluster auf die Whitelist gesetzt wird. <br><br>
<h3>  Gebrauchsfertiges NVMe </h3><br>  Damit ClickHouse funktioniert, erstelle ich auf jedem Server im NVMe-Laufwerk ein EXT4-Dateisystem. <br><br><pre><code class="sql hljs">$ sudo mkfs -t ext4 /dev/nvme1n1 $ sudo mkdir /ch $ sudo mount /dev/nvme1n1 /ch</code> </pre> <br>  Nachdem alles konfiguriert wurde, k√∂nnen Sie den Einh√§ngepunkt und 783 GB verf√ºgbaren Speicherplatz in jedem der Systeme anzeigen. <br><br><pre> <code class="sql hljs">$ lsblk</code> </pre> <br><pre> <code class="sql hljs">NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT loop0 7:0 0 87.9M 1 loop /snap/core/5742 loop1 7:1 0 16.5M 1 loop /snap/amazon-ssm-agent/784 nvme0n1 259:1 0 8G 0 disk ‚îî‚îÄnvme0n1p1 259:2 0 8G 0 part / nvme1n1 259:0 0 838.2G 0 disk /ch</code> </pre> <br><pre> <code class="sql hljs">$ df -h</code> </pre> <br><pre> <code class="sql hljs">Filesystem Size Used Avail <span class="hljs-keyword"><span class="hljs-keyword">Use</span></span>% Mounted <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> udev <span class="hljs-number"><span class="hljs-number">35</span></span>G <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">35</span></span>G <span class="hljs-number"><span class="hljs-number">0</span></span>% /dev tmpfs <span class="hljs-number"><span class="hljs-number">6.9</span></span>G <span class="hljs-number"><span class="hljs-number">8.8</span></span>M <span class="hljs-number"><span class="hljs-number">6.9</span></span>G <span class="hljs-number"><span class="hljs-number">1</span></span>% /run /dev/nvme0n1p1 <span class="hljs-number"><span class="hljs-number">7.7</span></span>G <span class="hljs-number"><span class="hljs-number">967</span></span>M <span class="hljs-number"><span class="hljs-number">6.8</span></span>G <span class="hljs-number"><span class="hljs-number">13</span></span>% / tmpfs <span class="hljs-number"><span class="hljs-number">35</span></span>G <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">35</span></span>G <span class="hljs-number"><span class="hljs-number">0</span></span>% /dev/shm tmpfs <span class="hljs-number"><span class="hljs-number">5.0</span></span>M <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">5.0</span></span>M <span class="hljs-number"><span class="hljs-number">0</span></span>% /run/<span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> tmpfs <span class="hljs-number"><span class="hljs-number">35</span></span>G <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">35</span></span>G <span class="hljs-number"><span class="hljs-number">0</span></span>% /<span class="hljs-keyword"><span class="hljs-keyword">sys</span></span>/fs/cgroup /dev/loop0 <span class="hljs-number"><span class="hljs-number">88</span></span>M <span class="hljs-number"><span class="hljs-number">88</span></span>M <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>% /snap/core/<span class="hljs-number"><span class="hljs-number">5742</span></span> /dev/loop1 <span class="hljs-number"><span class="hljs-number">17</span></span>M <span class="hljs-number"><span class="hljs-number">17</span></span>M <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>% /snap/amazon-ssm-<span class="hljs-keyword"><span class="hljs-keyword">agent</span></span>/<span class="hljs-number"><span class="hljs-number">784</span></span> tmpfs <span class="hljs-number"><span class="hljs-number">6.9</span></span>G <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">6.9</span></span>G <span class="hljs-number"><span class="hljs-number">0</span></span>% /run/<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>/<span class="hljs-number"><span class="hljs-number">1000</span></span> /dev/nvme1n1 <span class="hljs-number"><span class="hljs-number">825</span></span>G <span class="hljs-number"><span class="hljs-number">73</span></span>M <span class="hljs-number"><span class="hljs-number">783</span></span>G <span class="hljs-number"><span class="hljs-number">1</span></span>% /ch</code> </pre> <br>  Der Datensatz, den ich in diesem Test verwenden werde, ist ein Datendump, den ich aus 1,1 Milliarden Taxifahrten in New York in sechs Jahren erstellt habe.  Der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Billion Taxi-</a> Blog <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">auf Redshift</a> beschreibt, wie ich diesen Datensatz gesammelt habe.  Sie werden in AWS S3 gespeichert, daher konfiguriere ich die AWS-Befehlszeilenschnittstelle mithilfe meines Zugriffs und meiner privaten Schl√ºssel. <br><br><pre> <code class="sql hljs">$ sudo apt <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> $ sudo apt <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> awscli $ aws configure</code> </pre> <br>  Ich werde das Limit f√ºr die Anzahl gleichzeitiger Client-Anforderungen auf 100 setzen, damit Dateien schneller als mit Standardeinstellungen geladen werden. <br><br><pre> <code class="sql hljs">$ aws configure <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> \ default.s3.max_concurrent_requests \ <span class="hljs-number"><span class="hljs-number">100</span></span></code> </pre> <br>  Ich werde den Datensatz f√ºr Taxifahrten von AWS S3 herunterladen und auf dem NVMe-Laufwerk auf dem ersten Server speichern.  Dieser Datensatz hat eine Gr√∂√üe von ~ 104 GB im GZIP-komprimierten CSV-Format. <br><br><pre> <code class="sql hljs">$ sudo mkdir -p /ch/csv $ sudo chown -R ubuntu /ch/csv $ aws s3 sync s3://&lt;bucket&gt;/csv /ch/csv</code> </pre> <br><h3>  Installieren Sie ClickHouse </h3><br>  Ich werde die OpenJDK-Distribution f√ºr Java 8 installieren, da Apache ZooKeeper ausgef√ºhrt werden muss, was f√ºr die verteilte Installation von ClickHouse auf allen drei Computern erforderlich ist. <br><br><pre> <code class="sql hljs">$ sudo apt <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> $ sudo apt <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> \ openjdk<span class="hljs-number"><span class="hljs-number">-8</span></span>-jre \ openjdk<span class="hljs-number"><span class="hljs-number">-8</span></span>-jdk-headless</code> </pre> <br>  Dann habe ich die Umgebungsvariable <code>JAVA_HOME</code> . <br><br><pre> <code class="sql hljs">$ sudo vi /etc/profile export JAVA_HOME=/usr $ source /etc/profile</code> </pre> <br>  Dann werde ich das Paketverwaltungssystem in Ubuntu verwenden, um ClickHouse 18.16.1, blances und ZooKeeper auf allen drei Computern zu installieren. <br><br><pre> <code class="sql hljs">$ sudo apt-key adv \ <span class="hljs-comment"><span class="hljs-comment">--keyserver hkp://keyserver.ubuntu.com:80 \ --recv E0C56BD4 $ echo "deb http://repo.yandex.ru/clickhouse/deb/stable/ main/" | \ sudo tee /etc/apt/sources.list.d/clickhouse.list $ sudo apt-get update</span></span></code> </pre> <br><pre> <code class="sql hljs">$ sudo apt <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> \ clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">client</span></span> \ clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> \ glances \ zookeeperd</code> </pre> <br>  Ich werde ein Verzeichnis f√ºr ClickHouse erstellen und auch einige Konfigurations√ºberschreibungen auf allen drei Servern vornehmen. <br><br><pre> <code class="sql hljs">$ sudo mkdir /ch/clickhouse $ sudo chown -R clickhouse /ch/clickhouse $ sudo mkdir -p /etc/clickhouse-server/conf.d $ sudo vi /etc/clickhouse-server/conf.d/taxis.conf</code> </pre> <br>  Dies sind die Konfigurations√ºberschreibungen, die ich verwenden werde. <br><br><pre> <code class="sql hljs">&lt;?xml version="1.0"?&gt; &lt;yandex&gt; &lt;listen_host&gt;0.0.0.0&lt;/listen_host&gt; &lt;path&gt;/ch/clickhouse/&lt;/path&gt;</code> </pre><br><pre> <code class="sql hljs"> &lt;remote_servers&gt; &lt;perftest_3shards&gt; &lt;shard&gt; &lt;replica&gt; &lt;host&gt;172.30.2.192&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;/replica&gt; &lt;/shard&gt; &lt;shard&gt; &lt;replica&gt; &lt;host&gt;172.30.2.162&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;/replica&gt; &lt;/shard&gt; &lt;shard&gt; &lt;replica&gt; &lt;host&gt;172.30.2.36&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;/replica&gt; &lt;/shard&gt; &lt;/perftest_3shards&gt; &lt;/remote_servers&gt;</code> </pre> <br><pre> <code class="sql hljs"> &lt;zookeeper-servers&gt; &lt;node&gt; &lt;host&gt;172.30.2.192&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;node&gt; &lt;host&gt;172.30.2.162&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;node&gt; &lt;host&gt;172.30.2.36&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;/zookeeper-servers&gt;</code> </pre> <br><pre> <code class="sql hljs"> &lt;macros&gt; &lt;shard&gt;03&lt;/shard&gt; &lt;replica&gt;01&lt;/replica&gt; &lt;/macros&gt; &lt;/yandex&gt;</code> </pre> <br>  Dann werde ich ZooKeeper und den ClickHouse-Server auf allen drei Computern ausf√ºhren. <br><br><pre> <code class="sql hljs">$ sudo /etc/init.d/zookeeper <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> $ sudo service clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">start</span></span></code> </pre> <br><h3>  Laden von Daten in ClickHouse </h3><br>  Auf dem ersten Server werde ich eine Fahrten-Tabelle erstellen, in der ein Datensatz von Taxifahrten mit der Log-Engine gespeichert wird. <br><br><pre> <code class="sql hljs">$ clickhouse-client <span class="hljs-comment"><span class="hljs-comment">--host=0.0.0.0 CREATE TABLE trips ( trip_id UInt32, vendor_id String, pickup_datetime DateTime, dropoff_datetime Nullable(DateTime), store_and_fwd_flag Nullable(FixedString(1)), rate_code_id Nullable(UInt8), pickup_longitude Nullable(Float64), pickup_latitude Nullable(Float64), dropoff_longitude Nullable(Float64), dropoff_latitude Nullable(Float64), passenger_count Nullable(UInt8), trip_distance Nullable(Float64), fare_amount Nullable(Float32), extra Nullable(Float32), mta_tax Nullable(Float32), tip_amount Nullable(Float32), tolls_amount Nullable(Float32), ehail_fee Nullable(Float32), improvement_surcharge Nullable(Float32), total_amount Nullable(Float32), payment_type Nullable(String), trip_type Nullable(UInt8), pickup Nullable(String), dropoff Nullable(String), cab_type Nullable(String), precipitation Nullable(Int8), snow_depth Nullable(Int8), snowfall Nullable(Int8), max_temperature Nullable(Int8), min_temperature Nullable(Int8), average_wind_speed Nullable(Int8), pickup_nyct2010_gid Nullable(Int8), pickup_ctlabel Nullable(String), pickup_borocode Nullable(Int8), pickup_boroname Nullable(String), pickup_ct2010 Nullable(String), pickup_boroct2010 Nullable(String), pickup_cdeligibil Nullable(FixedString(1)), pickup_ntacode Nullable(String), pickup_ntaname Nullable(String), pickup_puma Nullable(String), dropoff_nyct2010_gid Nullable(UInt8), dropoff_ctlabel Nullable(String), dropoff_borocode Nullable(UInt8), dropoff_boroname Nullable(String), dropoff_ct2010 Nullable(String), dropoff_boroct2010 Nullable(String), dropoff_cdeligibil Nullable(String), dropoff_ntacode Nullable(String), dropoff_ntaname Nullable(String), dropoff_puma Nullable(String) ) ENGINE = Log;</span></span></code> </pre> <br>  Dann entpacke ich jede der CSV-Dateien und lade sie in eine Ausl√∂setabelle.  Das Folgende ist in 55 Minuten und 10 Sekunden erledigt.  Nach diesem Vorgang betrug die Datenverzeichnisgr√∂√üe 134 GB. <br><br><pre> <code class="sql hljs">$ time (for FILENAME in /ch/csv/trips_x*.csv.gz; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> echo $FILENAME gunzip -c $FILENAME | \ clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">client</span></span> \ <span class="hljs-comment"><span class="hljs-comment">--host=0.0.0.0 \ --query="INSERT INTO trips FORMAT CSV" done)</span></span></code> </pre> <br>  Die Importgeschwindigkeit betrug 155 MB unkomprimierten CSV-Inhalt pro Sekunde.  Ich vermute, dass dies auf einen Engpass bei der GZIP-Dekompression zur√ºckzuf√ºhren ist.  Es war m√∂glicherweise schneller, alle gzip-Dateien parallel mit xargs zu entpacken und dann die entpackten Daten zu laden.  Im Folgenden wird beschrieben, was w√§hrend des CSV-Importvorgangs gemeldet wurde. <br><br><pre> <code class="sql hljs">$ sudo glances</code> </pre> <br><pre> <code class="sql hljs">ip-172-30-2-200 (Ubuntu 16.04 64bit / Linux 4.4.0-1072-aws) Uptime: 0:11:42 CPU 8.2% nice: 0.0% <span class="hljs-keyword"><span class="hljs-keyword">LOAD</span></span> <span class="hljs-number"><span class="hljs-number">36</span></span>-core MEM <span class="hljs-number"><span class="hljs-number">9.8</span></span>% active: <span class="hljs-number"><span class="hljs-number">5.20</span></span>G SWAP <span class="hljs-number"><span class="hljs-number">0.0</span></span>% <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-number"><span class="hljs-number">6.0</span></span>% irq: <span class="hljs-number"><span class="hljs-number">0.0</span></span>% <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>: <span class="hljs-number"><span class="hljs-number">2.24</span></span> total: <span class="hljs-number"><span class="hljs-number">68.7</span></span>G inactive: <span class="hljs-number"><span class="hljs-number">61.0</span></span>G total: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>: <span class="hljs-number"><span class="hljs-number">0.9</span></span>% iowait: <span class="hljs-number"><span class="hljs-number">1.3</span></span>% <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>: <span class="hljs-number"><span class="hljs-number">1.83</span></span> used: <span class="hljs-number"><span class="hljs-number">6.71</span></span>G buffers: <span class="hljs-number"><span class="hljs-number">66.4</span></span>M used: <span class="hljs-number"><span class="hljs-number">0</span></span> idle: <span class="hljs-number"><span class="hljs-number">91.8</span></span>% steal: <span class="hljs-number"><span class="hljs-number">0.0</span></span>% <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>: <span class="hljs-number"><span class="hljs-number">1.01</span></span> free: <span class="hljs-number"><span class="hljs-number">62.0</span></span>G cached: <span class="hljs-number"><span class="hljs-number">61.6</span></span>G free: <span class="hljs-number"><span class="hljs-number">0</span></span> NETWORK Rx/s Tx/s TASKS <span class="hljs-number"><span class="hljs-number">370</span></span> (<span class="hljs-number"><span class="hljs-number">507</span></span> thr), <span class="hljs-number"><span class="hljs-number">2</span></span> run, <span class="hljs-number"><span class="hljs-number">368</span></span> slp, <span class="hljs-number"><span class="hljs-number">0</span></span> oth sorted automatically <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> cpu_percent, flat <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> ens5 <span class="hljs-number"><span class="hljs-number">136</span></span>b <span class="hljs-number"><span class="hljs-number">2</span></span>Kb lo <span class="hljs-number"><span class="hljs-number">343</span></span>Mb <span class="hljs-number"><span class="hljs-number">343</span></span>Mb CPU% MEM% VIRT RES PID <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> NI S <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>+ IOR/s IOW/s Command <span class="hljs-number"><span class="hljs-number">100.4</span></span> <span class="hljs-number"><span class="hljs-number">1.5</span></span> <span class="hljs-number"><span class="hljs-number">1.65</span></span>G <span class="hljs-number"><span class="hljs-number">1.06</span></span>G <span class="hljs-number"><span class="hljs-number">9909</span></span> ubuntu <span class="hljs-number"><span class="hljs-number">0</span></span> S <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">01.33</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">client</span></span> <span class="hljs-comment"><span class="hljs-comment">--host=0.0.0.0 --query=INSERT INTO trips FORMAT CSV DISK I/OR/s W/s 85.1 0.0 4.65M 708K 9908 ubuntu 0 R 0:50.60 32M 0 gzip -d -c /ch/csv/trips_xac.csv.gz loop0 0 0 54.9 5.1 8.14G 3.49G 8091 clickhous 0 S 1:44.23 0 45M /usr/bin/clickhouse-server --config=/etc/clickhouse-server/config.xml loop1 0 0 4.5 0.0 0 0 319 root 0 S 0:07.50 1K 0 kworker/u72:2 nvme0n1 0 3K 2.3 0.0 91.1M 28.9M 9912 root 0 R 0:01.56 0 0 /usr/bin/python3 /usr/bin/glances nvme0n1p1 0 3K 0.3 0.0 0 0 960 root -20 S 0:00.10 0 0 kworker/28:1H nvme1n1 32.1M 495M 0.3 0.0 0 0 1058 root -20 S 0:00.90 0 0 kworker/23:1H</span></span></code> </pre> <br>  Ich werde Speicherplatz auf dem NVMe-Laufwerk freigeben, indem ich die CSV-Quelldateien l√∂sche, bevor ich fortfahre. <br><br><pre> <code class="sql hljs">$ sudo rm -fr /ch/csv</code> </pre> <br><h3>  In Spaltenform konvertieren </h3><br>  Die Log ClickHouse-Engine speichert Daten in einem zeilenorientierten Format.  Um Daten schneller anzufordern, konvertiere ich sie mithilfe der MergeTree-Engine in das Spaltenformat. <br><br><pre> <code class="sql hljs">$ clickhouse-client <span class="hljs-comment"><span class="hljs-comment">--host=0.0.0.0</span></span></code> </pre> <br>  Das Folgende ist in 34 Minuten und 50 Sekunden erledigt.  Nach diesem Vorgang betrug die Datenverzeichnisgr√∂√üe 237 GB. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> trips_mergetree <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span> = MergeTree(pickup_date, pickup_datetime, <span class="hljs-number"><span class="hljs-number">8192</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> trip_id, <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(vendor_id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> Enum8(<span class="hljs-string"><span class="hljs-string">'1'</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'2'</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">'CMT'</span></span> = <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">'VTS'</span></span> = <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">'DDS'</span></span> = <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">'B02512'</span></span> = <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">'B02598'</span></span> = <span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-string"><span class="hljs-string">'B02617'</span></span> = <span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-string"><span class="hljs-string">'B02682'</span></span> = <span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-string"><span class="hljs-string">'B02764'</span></span> = <span class="hljs-number"><span class="hljs-number">14</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> vendor_id, toDate(pickup_datetime) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> pickup_date, <span class="hljs-keyword"><span class="hljs-keyword">ifNull</span></span>(pickup_datetime, toDateTime(<span class="hljs-number"><span class="hljs-number">0</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> pickup_datetime, toDate(dropoff_datetime) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> dropoff_date, <span class="hljs-keyword"><span class="hljs-keyword">ifNull</span></span>(dropoff_datetime, toDateTime(<span class="hljs-number"><span class="hljs-number">0</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> dropoff_datetime, assumeNotNull(store_and_fwd_flag) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> store_and_fwd_flag, assumeNotNull(rate_code_id) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> rate_code_id, assumeNotNull(pickup_longitude) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> pickup_longitude, assumeNotNull(pickup_latitude) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> pickup_latitude, assumeNotNull(dropoff_longitude) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> dropoff_longitude, assumeNotNull(dropoff_latitude) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> dropoff_latitude, assumeNotNull(passenger_count) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> passenger_count, assumeNotNull(trip_distance) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> trip_distance, assumeNotNull(fare_amount) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> fare_amount, assumeNotNull(extra) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> extra, assumeNotNull(mta_tax) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> mta_tax, assumeNotNull(tip_amount) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> tip_amount, assumeNotNull(tolls_amount) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> tolls_amount, assumeNotNull(ehail_fee) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ehail_fee, assumeNotNull(improvement_surcharge) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> improvement_surcharge, assumeNotNull(total_amount) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> total_amount, assumeNotNull(payment_type) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> payment_type_, assumeNotNull(trip_type) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> trip_type, pickup <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> pickup, pickup <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> dropoff, <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(assumeNotNull(cab_type) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> Enum8(<span class="hljs-string"><span class="hljs-string">'yellow'</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'green'</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> cab_type, precipitation <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> precipitation, snow_depth <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> snow_depth, snowfall <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> snowfall, max_temperature <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> max_temperature, min_temperature <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> min_temperature, average_wind_speed <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> average_wind_speed, pickup_nyct2010_gid <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> pickup_nyct2010_gid, pickup_ctlabel <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> pickup_ctlabel, pickup_borocode <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> pickup_borocode, pickup_boroname <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> pickup_boroname, pickup_ct2010 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> pickup_ct2010, pickup_boroct2010 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> pickup_boroct2010, pickup_cdeligibil <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> pickup_cdeligibil, pickup_ntacode <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> pickup_ntacode, pickup_ntaname <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> pickup_ntaname, pickup_puma <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> pickup_puma, dropoff_nyct2010_gid <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> dropoff_nyct2010_gid, dropoff_ctlabel <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> dropoff_ctlabel, dropoff_borocode <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> dropoff_borocode, dropoff_boroname <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> dropoff_boroname, dropoff_ct2010 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> dropoff_ct2010, dropoff_boroct2010 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> dropoff_boroct2010, dropoff_cdeligibil <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> dropoff_cdeligibil, dropoff_ntacode <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> dropoff_ntacode, dropoff_ntaname <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> dropoff_ntaname, dropoff_puma <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> dropoff_puma <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> trips;</code> </pre> <br>  So sah die Blickausgabe w√§hrend der Operation aus: <br><br><pre> <code class="sql hljs">ip-172-30-2-200 (Ubuntu 16.04 64bit / Linux 4.4.0-1072-aws) Uptime: 1:06:09 CPU 10.3% nice: 0.0% <span class="hljs-keyword"><span class="hljs-keyword">LOAD</span></span> <span class="hljs-number"><span class="hljs-number">36</span></span>-core MEM <span class="hljs-number"><span class="hljs-number">16.1</span></span>% active: <span class="hljs-number"><span class="hljs-number">13.3</span></span>G SWAP <span class="hljs-number"><span class="hljs-number">0.0</span></span>% <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-number"><span class="hljs-number">7.9</span></span>% irq: <span class="hljs-number"><span class="hljs-number">0.0</span></span>% <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>: <span class="hljs-number"><span class="hljs-number">1.87</span></span> total: <span class="hljs-number"><span class="hljs-number">68.7</span></span>G inactive: <span class="hljs-number"><span class="hljs-number">52.8</span></span>G total: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>: <span class="hljs-number"><span class="hljs-number">1.6</span></span>% iowait: <span class="hljs-number"><span class="hljs-number">0.8</span></span>% <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>: <span class="hljs-number"><span class="hljs-number">1.76</span></span> used: <span class="hljs-number"><span class="hljs-number">11.1</span></span>G buffers: <span class="hljs-number"><span class="hljs-number">71.8</span></span>M used: <span class="hljs-number"><span class="hljs-number">0</span></span> idle: <span class="hljs-number"><span class="hljs-number">89.7</span></span>% steal: <span class="hljs-number"><span class="hljs-number">0.0</span></span>% <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>: <span class="hljs-number"><span class="hljs-number">1.95</span></span> free: <span class="hljs-number"><span class="hljs-number">57.6</span></span>G cached: <span class="hljs-number"><span class="hljs-number">57.2</span></span>G free: <span class="hljs-number"><span class="hljs-number">0</span></span> NETWORK Rx/s Tx/s TASKS <span class="hljs-number"><span class="hljs-number">367</span></span> (<span class="hljs-number"><span class="hljs-number">523</span></span> thr), <span class="hljs-number"><span class="hljs-number">1</span></span> run, <span class="hljs-number"><span class="hljs-number">366</span></span> slp, <span class="hljs-number"><span class="hljs-number">0</span></span> oth sorted automatically <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> cpu_percent, flat <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> ens5 <span class="hljs-number"><span class="hljs-number">1</span></span>Kb <span class="hljs-number"><span class="hljs-number">8</span></span>Kb lo <span class="hljs-number"><span class="hljs-number">2</span></span>Kb <span class="hljs-number"><span class="hljs-number">2</span></span>Kb CPU% MEM% VIRT RES PID <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> NI S <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>+ IOR/s IOW/s Command <span class="hljs-number"><span class="hljs-number">241.9</span></span> <span class="hljs-number"><span class="hljs-number">12.8</span></span> <span class="hljs-number"><span class="hljs-number">20.7</span></span>G <span class="hljs-number"><span class="hljs-number">8.78</span></span>G <span class="hljs-number"><span class="hljs-number">8091</span></span> clickhous <span class="hljs-number"><span class="hljs-number">0</span></span> S <span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">36.73</span></span> <span class="hljs-number"><span class="hljs-number">34</span></span>M <span class="hljs-number"><span class="hljs-number">125</span></span>M /usr/<span class="hljs-keyword"><span class="hljs-keyword">bin</span></span>/clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-comment"><span class="hljs-comment">--config=/etc/clickhouse-server/config.xml DISK I/OR/s W/s 2.6 0.0 90.4M 28.3M 9948 root 0 R 1:18.53 0 0 /usr/bin/python3 /usr/bin/glances loop0 0 0 1.3 0.0 0 0 203 root 0 S 0:09.82 0 0 kswapd0 loop1 0 0 0.3 0.1 315M 61.3M 15701 ubuntu 0 S 0:00.40 0 0 clickhouse-client --host=0.0.0.0 nvme0n1 0 3K 0.3 0.0 0 0 7 root 0 S 0:00.83 0 0 rcu_sched nvme0n1p1 0 3K 0.0 0.0 0 0 142 root 0 S 0:00.22 0 0 migration/27 nvme1n1 25.8M 330M 0.0 0.0 59.7M 1.79M 2764 ubuntu 0 S 0:00.00 0 0 (sd-pam)</span></span></code> </pre> <br>  Im letzten Test wurden mehrere Spalten konvertiert und neu gez√§hlt.  Ich habe festgestellt, dass einige dieser Funktionen in diesem Datensatz nicht mehr ordnungsgem√§√ü funktionieren.  Um dieses Problem zu l√∂sen, habe ich die unangemessenen Funktionen entfernt und die Daten ohne Konvertierung in detailliertere Typen heruntergeladen. <br><br><h3>  Cluster-Datenverteilung </h3><br>  Ich werde Daten auf alle drei Knoten des Clusters verteilen.  Zun√§chst werde ich auf allen drei Maschinen eine Tabelle erstellen. <br><br><pre> <code class="sql hljs">$ clickhouse-client <span class="hljs-comment"><span class="hljs-comment">--host=0.0.0.0</span></span></code> </pre> <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> trips_mergetree_third ( trip_id UInt32, vendor_id <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, pickup_date <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>, pickup_datetime DateTime, dropoff_date <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>, dropoff_datetime Nullable(DateTime), store_and_fwd_flag Nullable(FixedString(<span class="hljs-number"><span class="hljs-number">1</span></span>)), rate_code_id Nullable(UInt8), pickup_longitude Nullable(Float64), pickup_latitude Nullable(Float64), dropoff_longitude Nullable(Float64), dropoff_latitude Nullable(Float64), passenger_count Nullable(UInt8), trip_distance Nullable(Float64), fare_amount Nullable(Float32), extra Nullable(Float32), mta_tax Nullable(Float32), tip_amount Nullable(Float32), tolls_amount Nullable(Float32), ehail_fee Nullable(Float32), improvement_surcharge Nullable(Float32), total_amount Nullable(Float32), payment_type Nullable(<span class="hljs-keyword"><span class="hljs-keyword">String</span></span>), trip_type Nullable(UInt8), pickup Nullable(<span class="hljs-keyword"><span class="hljs-keyword">String</span></span>), dropoff Nullable(<span class="hljs-keyword"><span class="hljs-keyword">String</span></span>), cab_type Nullable(<span class="hljs-keyword"><span class="hljs-keyword">String</span></span>), precipitation Nullable(<span class="hljs-built_in"><span class="hljs-built_in">Int8</span></span>), snow_depth Nullable(<span class="hljs-built_in"><span class="hljs-built_in">Int8</span></span>), snowfall Nullable(<span class="hljs-built_in"><span class="hljs-built_in">Int8</span></span>), max_temperature Nullable(<span class="hljs-built_in"><span class="hljs-built_in">Int8</span></span>), min_temperature Nullable(<span class="hljs-built_in"><span class="hljs-built_in">Int8</span></span>), average_wind_speed Nullable(<span class="hljs-built_in"><span class="hljs-built_in">Int8</span></span>), pickup_nyct2010_gid Nullable(<span class="hljs-built_in"><span class="hljs-built_in">Int8</span></span>), pickup_ctlabel Nullable(<span class="hljs-keyword"><span class="hljs-keyword">String</span></span>), pickup_borocode Nullable(<span class="hljs-built_in"><span class="hljs-built_in">Int8</span></span>), pickup_boroname Nullable(<span class="hljs-keyword"><span class="hljs-keyword">String</span></span>), pickup_ct2010 Nullable(<span class="hljs-keyword"><span class="hljs-keyword">String</span></span>), pickup_boroct2010 Nullable(<span class="hljs-keyword"><span class="hljs-keyword">String</span></span>), pickup_cdeligibil Nullable(FixedString(<span class="hljs-number"><span class="hljs-number">1</span></span>)), pickup_ntacode Nullable(<span class="hljs-keyword"><span class="hljs-keyword">String</span></span>), pickup_ntaname Nullable(<span class="hljs-keyword"><span class="hljs-keyword">String</span></span>), pickup_puma Nullable(<span class="hljs-keyword"><span class="hljs-keyword">String</span></span>), dropoff_nyct2010_gid Nullable(UInt8), dropoff_ctlabel Nullable(<span class="hljs-keyword"><span class="hljs-keyword">String</span></span>), dropoff_borocode Nullable(UInt8), dropoff_boroname Nullable(<span class="hljs-keyword"><span class="hljs-keyword">String</span></span>), dropoff_ct2010 Nullable(<span class="hljs-keyword"><span class="hljs-keyword">String</span></span>), dropoff_boroct2010 Nullable(<span class="hljs-keyword"><span class="hljs-keyword">String</span></span>), dropoff_cdeligibil Nullable(<span class="hljs-keyword"><span class="hljs-keyword">String</span></span>), dropoff_ntacode Nullable(<span class="hljs-keyword"><span class="hljs-keyword">String</span></span>), dropoff_ntaname Nullable(<span class="hljs-keyword"><span class="hljs-keyword">String</span></span>), dropoff_puma Nullable(<span class="hljs-keyword"><span class="hljs-keyword">String</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span> = MergeTree(pickup_date, pickup_datetime, <span class="hljs-number"><span class="hljs-number">8192</span></span>);</code> </pre> <br>  Dann werde ich sicherstellen, dass der erste Server alle drei Knoten im Cluster sehen kann. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> system.clusters <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> cluster = <span class="hljs-string"><span class="hljs-string">'perftest_3shards'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FORMAT</span></span> Vertical;</code> </pre> <br><br><pre> <code class="sql hljs">Row 1: ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ cluster: perftest_3shards shard_num: 1 shard_weight: 1 replica_num: 1 host_name: 172.30.2.192 host_address: 172.30.2.192 port: 9000 is_local: 1 user: default default_database:</code> </pre> <br><br><pre> <code class="sql hljs">Row 2: ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ cluster: perftest_3shards shard_num: 2 shard_weight: 1 replica_num: 1 host_name: 172.30.2.162 host_address: 172.30.2.162 port: 9000 is_local: 0 user: default default_database:</code> </pre> <br><pre> <code class="sql hljs">Row 3: ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ cluster: perftest_3shards shard_num: 3 shard_weight: 1 replica_num: 1 host_name: 172.30.2.36 host_address: 172.30.2.36 port: 9000 is_local: 0 user: default default_database:</code> </pre> <br>  Dann werde ich auf dem ersten Server eine neue Tabelle definieren, die auf dem <code>trips_mergetree_third</code> basiert und die verteilte Engine verwendet. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> trips_mergetree_x3 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> trips_mergetree_third <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">Distributed</span></span>(perftest_3shards, <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>, trips_mergetree_third, <span class="hljs-keyword"><span class="hljs-keyword">rand</span></span>());</code> </pre> <br>  Dann kopiere ich die Daten aus der Tabelle basierend auf MergeTree auf alle drei Server.  Das Folgende ist in 34 Minuten und 44 Sekunden erledigt. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> trips_mergetree_x3 <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> trips_mergetree;</code> </pre> <br>  Nach dem obigen Vorgang gab ich ClickHouse 15 Minuten Zeit, um mich von der maximalen Speicherebene zu entfernen.  Die Datenverzeichnisse waren auf jedem der drei Server 264 GB, 34 GB bzw. 33 GB gro√ü. <br><br><h3>  ClickHouse Cluster Performance Assessment </h3><br>  Was ich als n√§chstes sah, war die schnellste Zeit, die ich sah, als ich jede Abfrage mehrmals in der Tabelle <code>trips_mergetree_x3</code> . <br><br><pre> <code class="sql hljs">$ clickhouse-client <span class="hljs-comment"><span class="hljs-comment">--host=0.0.0.0</span></span></code> </pre> <br>  Das Folgende wurde in 2,449 Sekunden abgeschlossen. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> cab_type, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> trips_mergetree_x3 <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> cab_type;</code> </pre> <br>  Das Folgende wurde in 0,691 Sekunden abgeschlossen. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> passenger_count, <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span>(total_amount) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> trips_mergetree_x3 <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> passenger_count;</code> </pre> <br>  Das Folgende wurde in 0. 582 Sekunden abgeschlossen. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> passenger_count, toYear(pickup_date) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">year</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> trips_mergetree_x3 <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> passenger_count, <span class="hljs-keyword"><span class="hljs-keyword">year</span></span>;</code> </pre> <br>  Das Folgende ist in 0,983 Sekunden abgeschlossen. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> passenger_count, toYear(pickup_date) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">year</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">round</span></span>(trip_distance) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> distance, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> trips_mergetree_x3 <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> passenger_count, <span class="hljs-keyword"><span class="hljs-keyword">year</span></span>, distance <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">year</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>;</code> </pre> <br>  Zum Vergleich habe ich dieselben Abfragen in einer Tabelle durchgef√ºhrt, die auf MergeTree basiert und sich ausschlie√ülich auf dem ersten Server befindet. <br><br><h3>  Leistungsbewertung eines ClickHouse-Knotens </h3><br>  Was ich als n√§chstes sah, war die schnellste Zeit, die ich sah, als ich jede Abfrage mehrmals in der Tabelle <code>trips_mergetree_x3</code> . <br><br>  Das Folgende ist in 0,241 Sekunden abgeschlossen. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> cab_type, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> trips_mergetree <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> cab_type;</code> </pre> <br>  Das Folgende ist in 0,826 Sekunden abgeschlossen. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> passenger_count, <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span>(total_amount) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> trips_mergetree <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> passenger_count;</code> </pre> <br>  Das Folgende ist in 1,209 Sekunden abgeschlossen. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> passenger_count, toYear(pickup_date) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">year</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> trips_mergetree <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> passenger_count, <span class="hljs-keyword"><span class="hljs-keyword">year</span></span>;</code> </pre> <br>  Folgendes wurde in 1,781 Sekunden abgeschlossen. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> passenger_count, toYear(pickup_date) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">year</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">round</span></span>(trip_distance) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> distance, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> trips_mergetree <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> passenger_count, <span class="hljs-keyword"><span class="hljs-keyword">year</span></span>, distance <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">year</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>;</code> </pre> <br><h3>  Reflexionen √ºber die Ergebnisse </h3><br>  Dies ist das erste Mal, dass eine freie prozessorbasierte Datenbank in meinen Tests die GPU-Datenbank √ºbertreffen konnte.  Diese GPU-basierte Datenbank wurde seitdem zwei Mal √ºberarbeitet, aber die Leistung, die ClickHouse auf einem Knoten zeigte, ist dennoch sehr beeindruckend. <br><br>  Wenn Sie Abfrage 1 auf einer verteilten Engine ausf√ºhren, ist der Overhead gleichzeitig um eine Gr√∂√üenordnung h√∂her.  Ich hoffe, dass ich bei meinen Recherchen f√ºr diesen Beitrag etwas verpasst habe, da es sch√∂n w√§re zu sehen, wie sich die Abfragezeit verringert, wenn ich dem Cluster weitere Knoten hinzuf√ºge.  Es ist jedoch bemerkenswert, dass bei anderen Abfragen die Produktivit√§t um das Zweifache gesteigert wurde. <br><br>  Es w√§re sch√∂n, wenn ClickHouse so weiterentwickelt w√ºrde, dass Speicher und Computer getrennt werden k√∂nnten, damit sie unabh√§ngig voneinander skalieren k√∂nnen.  Die HDFS-Unterst√ºtzung, die letztes Jahr hinzugef√ºgt wurde, k√∂nnte ein Schritt in diese Richtung sein.  Wenn eine einzelne Anforderung durch Hinzuf√ºgen weiterer Knoten zum Cluster beschleunigt werden kann, ist die Zukunft dieser Software sehr vielversprechend. <br><br>  Vielen Dank, dass Sie sich die Zeit genommen haben, diesen Beitrag zu lesen.  Ich biete Beratung, Architektur und praktische Entwicklungsdienstleistungen f√ºr Kunden in Nordamerika und Europa.  Wenn Sie besprechen m√∂chten, wie meine Vorschl√§ge Ihrem Unternehmen helfen k√∂nnen, kontaktieren Sie mich √ºber <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">LinkedIn</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de463665/">https://habr.com/ru/post/de463665/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de463651/index.html">Diskrete Mathematik f√ºr WMS: Algorithmus zum Komprimieren von Waren in Zellen (Teil 2)</a></li>
<li><a href="../de463653/index.html">Einschr√§nkungen von 16-Bit-Spielen und deren Wiederherstellung in Unity</a></li>
<li><a href="../de463655/index.html">Die Geburt eines Projekts oder wie man ein eigenes CMS schreibt</a></li>
<li><a href="../de463657/index.html">Chatbots sind schei√üe</a></li>
<li><a href="../de463663/index.html">10 B√ºcher, um die Struktur der B√∂rse, Investitionen an der B√∂rse und automatisierten Handel zu verstehen</a></li>
<li><a href="../de463667/index.html">Forest gibt sich nicht der Suchtechnologie hin, aber Ingenieure schlagen zur√ºck</a></li>
<li><a href="../de463669/index.html">MQTT-Protokoll: Konzeptionelles Eintauchen</a></li>
<li><a href="../de463673/index.html">6 Gr√ºnde, ein IT-Startup in Kanada zu er√∂ffnen</a></li>
<li><a href="../de463675/index.html">Personalalchemie: Wie setzt sich das Team des Zentrums GosSOPKA optimal zusammen?</a></li>
<li><a href="../de463677/index.html">Teamleiter auf einer Fernbedienung: Wie ich mit meiner Familie gereist bin und von Griechenland und Vietnam aus gearbeitet habe</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>