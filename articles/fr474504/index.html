<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë∑ üíë ü§Ωüèº Backend orthodoxe ‚≠ïÔ∏è ü•ñ ‚õìÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le backend moderne est diversifi√©, mais ob√©it toujours √† des r√®gles tacites. Beaucoup d'entre nous qui d√©veloppons des applications serveur sont confr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Backend orthodoxe</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/474504/"><img src="https://habrastorage.org/webt/dj/q5/y-/djq5y-xjov_bqvrrnb08bfyqn4i.jpeg"><br><br>  Le backend moderne est diversifi√©, mais ob√©it toujours √† des r√®gles tacites.  Beaucoup d'entre nous qui d√©veloppons des applications serveur sont confront√©s √† des approches g√©n√©ralement accept√©es, telles que l'architecture propre, SOLID, l'ignorance de la persistance, l'injection de d√©pendances et autres.  Beaucoup d'attributs du d√©veloppement de serveurs sont tellement galvaud√©s qu'ils ne posent aucune question et sont utilis√©s sans r√©fl√©chir.  Ils en parlent beaucoup, mais ne l'utilisent jamais.  Le sens du reste est soit mal interpr√©t√©, soit d√©form√©.  L'article explique comment construire une architecture backend simple et compl√®tement typique, qui non seulement peut suivre les pr√©ceptes des th√©oriciens de la programmation c√©l√®bres sans aucun dommage, mais peut √©galement les am√©liorer dans une certaine mesure. <br><a name="habracut"></a><br>  <i>D√©di√© √† tous ceux qui ne pensent pas √† la programmation sans beaut√© et n'acceptent pas la beaut√© au milieu de l'absurdit√©.</i> <br><br><h2>  Mod√®le de domaine </h2><br>  La mod√©lisation est le point de d√©part du d√©veloppement logiciel dans un monde id√©al.  Mais nous ne sommes pas tous parfaits, nous en parlons beaucoup, mais nous faisons tout comme d'habitude.  La raison en est souvent l'imperfection des outils existants.  Et pour √™tre honn√™te, notre paresse et notre peur de prendre la responsabilit√© de s'√©loigner des "meilleures pratiques".  Dans un monde imparfait, le d√©veloppement de logiciels commence, au mieux, par l'√©chafaudage, et au pire, rien n'est fait avec l'optimisation des performances.  N√©anmoins, je voudrais √©carter les exemples concrets d'architectes ¬´exceptionnels¬ª et sp√©culer sur des choses plus ordinaires. <br><br>  Nous avons donc une t√¢che technique, et m√™me une conception d'interface utilisateur (ou non, si l'interface utilisateur n'est pas fournie).  L'√©tape suivante consiste √† refl√©ter les exigences du mod√®le de domaine.  Pour commencer, vous pouvez esquisser un diagramme des objets du mod√®le pour plus de clart√©: <br><br><img src="https://habrastorage.org/webt/4n/hp/m5/4nhpm5kbhwvomryj9xhyww1eep0.png"><br><br>  Ensuite, en r√®gle g√©n√©rale, nous commen√ßons √† projeter le mod√®le sur les moyens de sa mise en ≈ìuvre - un langage de programmation, un convertisseur objet-relationnel (Object-Relational Mapper, ORM), ou sur une sorte de cadre complexe comme ASP.NET MVC ou Ruby on Rails, en d'autres termes - commencez √† √©crire du code.  Dans ce cas, nous suivons le chemin du cadre, qui je pense n'est pas correct dans le cadre d'un d√©veloppement bas√© sur le mod√®le, aussi pratique que cela puisse para√Ætre au d√©part.  Ici, vous faites une hypoth√®se √©norme, qui annule par la suite les avantages du d√©veloppement bas√© sur un domaine.  En tant qu'option plus libre, non limit√©e par la port√©e de n'importe quel outil, je sugg√©rerais de m'attarder sur l'utilisation des seuls outils syntaxiques d'un langage de programmation pour construire un mod√®le objet d'un domaine.  Dans mon travail, j'utilise plusieurs langages de programmation - C #, JavaScript, Ruby.  Le destin a d√©cr√©t√© que les √©cosyst√®mes Java et C # sont mon inspiration, JS est mon principal revenu et Ruby est le langage que j'aime.  Par cons√©quent, je continuerai √† montrer des exemples simples en Ruby: je suis convaincu que cela ne causera pas de probl√®mes aux d√©veloppeurs dans d'autres langues.  Donc, portez le mod√®le sur la classe Invoice dans Ruby: <br><br><pre><code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Invoice</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr_reader</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">date</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">created_at</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">paid_at</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attrs</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payment_service</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">created_at</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DateTime</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">now</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">paid_at</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nil</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attrs</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class">] @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">date</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attrs</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">date</span></span></span><span class="hljs-class">] @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscription</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attrs</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscription</span></span></span><span class="hljs-class">] @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payment_service</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payment_service</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pay</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">credit_card</span></span></span><span class="hljs-class"> = @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscription</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customer</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">credit_card</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class"> = @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscription</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">price</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payment_service</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">charge</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">credit_card</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">paid_at</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DateTime</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">now</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br>  C'est-√†-dire  nous avons une classe dont le constructeur accepte un hachage d'attributs, des d√©pendances d'objet et initialise ses champs, et une m√©thode de paiement qui peut changer l'√©tat de l'objet.  Tout est tr√®s simple.  Maintenant, nous ne pensons pas √† comment et o√π nous allons afficher et stocker cet objet.  Il existe simplement, nous pouvons le cr√©er, changer son √©tat, interagir avec d'autres objets.  Veuillez noter que le code ne contient aucun artefact √©tranger comme BaseEntity et autres d√©chets qui ne sont pas li√©s au mod√®le.  C'est tr√®s important.  Soit dit en passant, √† ce stade, nous pouvons d√©j√† commencer le d√©veloppement par le biais de tests (TDD), en utilisant des objets de remplacement au lieu de d√©pendances comme payment_service: <br><br><pre> <code class="ruby hljs">RSpec.describe Invoice <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> before <span class="hljs-symbol"><span class="hljs-symbol">:each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> @payment_service = double(<span class="hljs-symbol"><span class="hljs-symbol">:payment_service</span></span>) allow(@payment_service).to receive(<span class="hljs-symbol"><span class="hljs-symbol">:charge</span></span>) @amount = <span class="hljs-number"><span class="hljs-number">100</span></span> @credit_card = CreditCard.new({...}) @customer = Customer.new({<span class="hljs-symbol"><span class="hljs-symbol">credit_card:</span></span> @credit_card, ...}) @subscription = Subscription.new({<span class="hljs-symbol"><span class="hljs-symbol">customer:</span></span> customer, ...}) @invoice = Invoice.new({<span class="hljs-symbol"><span class="hljs-symbol">amount:</span></span> @amount, <span class="hljs-symbol"><span class="hljs-symbol">date:</span></span> DateTime.now, @subscription: subscription}, payment_service) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> describe <span class="hljs-string"><span class="hljs-string">'pay'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> it <span class="hljs-string"><span class="hljs-string">"charges customer's credit card"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> expect(@payment_service).to receive(<span class="hljs-symbol"><span class="hljs-symbol">:charge</span></span>).with(@credit_card, @amount) @invoice.pay <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> it <span class="hljs-string"><span class="hljs-string">'makes the invoice paid'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> expect(@invoice.paid_at).not_to be_nil @invoice.pay <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  ou m√™me jouer avec le mod√®le dans l'interpr√©teur (irb pour Ruby), qui peut bien √™tre, bien que pas tr√®s convivial, l'interface utilisateur: <br><br><pre> <code class="bash hljs">irb &gt; invoice = Invoice.new({amount: @amount, date: DateTime.now, @subscription: subscription}, payment_service) irb &gt; invoice.pay</code> </pre><br>  Pourquoi est-il si important d'√©viter les ¬´artefacts √©trangers¬ª √† ce stade?  Le fait est que le mod√®le ne devrait pas avoir la moindre id√©e de la fa√ßon dont il sera enregistr√© ou s'il sera enregistr√© du tout.  Au final, pour certains syst√®mes, le stockage d'objets directement en m√©moire peut √™tre tout √† fait appropri√©.  Au moment de la mod√©lisation, il faut compl√®tement abstraire de ce d√©tail.  Cette approche est appel√©e Ignorance de la persistance.  Il convient de souligner que nous n'ignorons pas les probl√®mes de travail avec le r√©f√©rentiel, qu'il s'agisse d'une base de donn√©es relationnelle ou de toute autre base de donn√©es, nous n√©gligeons uniquement les d√©tails de l'interaction avec lui au stade de la mod√©lisation.  L'ignorance de la persistance signifie l'√©limination intentionnelle des m√©canismes pour travailler avec l'√©tat du mod√®le, ainsi que toutes sortes de m√©tadonn√©es li√©es √† ce processus, du mod√®le lui-m√™me.  Exemples: <br><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#  class User &lt; Entity #     table :users #     # mapping  field :name, type: 'String' #   def save ... end end user = User.load(id) #     user.save #    </span></span></code> </pre><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#  class User #   ,      attr_accessor :name, :lastname end user = repo.load(id) #     repo.save(user) #    </span></span></code> </pre><br>  Cette approche est √©galement due √† des raisons fondamentales - respect du principe de la responsabilit√© unique (principe de responsabilit√© unique, S dans SOLID).  Si le mod√®le, en plus de sa composante fonctionnelle, d√©crit les param√®tres de conservation de l'√©tat et traite √©galement de sa conservation et de son chargement, alors il a √©videmment trop de responsabilit√©s.  Le r√©sultat et non le dernier avantage de Persistence Ignorance est la possibilit√© de remplacer l'outil de stockage et m√™me le type de stockage lui-m√™me au cours du processus de d√©veloppement. <br><br><h2>  Model-View-Controller </h2><br>  Le concept MVC est si populaire dans l'environnement de d√©veloppement de diverses applications, pas seulement de serveur, dans diff√©rentes langues et plates-formes que nous ne pensons plus √† ce qu'il est et pourquoi il est n√©cessaire du tout.  J'ai le plus de questions de cette abr√©viation est appel√©e ¬´contr√¥leur¬ª.  Du point de vue de l'organisation de la structure du code, il est bon de regrouper les actions sur le mod√®le.  Mais le contr√¥leur ne doit pas du tout √™tre une classe, il doit plut√¥t √™tre un module qui inclut des m√©thodes pour acc√©der au mod√®le.  Non seulement cela, devrait-il avoir un endroit o√π √™tre?  En tant que d√©veloppeur qui a suivi le chemin de .NET -&gt; Ruby -&gt; Node.js, j'ai simplement √©t√© touch√© par les contr√¥leurs JS (ES5) qui impl√©mentent dans le cadre d'express.js.  Ayant la capacit√© de r√©soudre la t√¢che assign√©e aux contr√¥leurs dans un style plus fonctionnel, les d√©veloppeurs, comme ensorcel√©s, √©crivent encore et encore le ¬´contr√¥leur¬ª magique.  Pourquoi un contr√¥leur typique est-il mauvais? <br><br>  Un contr√¥leur typique est un ensemble de m√©thodes qui ne sont pas √©troitement li√©es les unes aux autres, unies par une seule - une certaine essence du mod√®le;  et parfois pas un seul, pire.  Chaque m√©thode individuelle peut n√©cessiter des d√©pendances diff√©rentes.  Pour l'avenir, je note que je suis partisan de la pratique de l'inversion de d√©pendance (Dependency Inversion, D in SOLID).  Par cons√©quent, j'ai besoin d'initialiser ces d√©pendances quelque part √† l'ext√©rieur et de les transmettre au constructeur du contr√¥leur.  Par exemple, lors de la cr√©ation d'un nouveau compte, je dois envoyer des notifications au comptable, pour lequel j'ai besoin d'un service de notification, et dans d'autres m√©thodes, je n'en ai pas besoin: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InvoiceController</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_repository</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_repository</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">index</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get_all</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">show</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get_by_id</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notify_accountant</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Ici, l'id√©e demande √† √™tre divis√©e en m√©thodes pour travailler avec le mod√®le en classes distinctes, et pourquoi pas? <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ListInvoices</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_repository</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_repository</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get_all</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CreateInvoice</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_repository</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_repository</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notify_accountant</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Eh bien, au lieu du contr√¥leur, il existe maintenant un ensemble de ¬´fonctions¬ª pour acc√©der au mod√®le, qui, soit dit en passant, peut √©galement √™tre structur√© √† l'aide de r√©pertoires de syst√®me de fichiers, par exemple.  Maintenant, vous devez "ouvrir" ces m√©thodes √† l'ext√©rieur, c'est-√†-dire  organiser quelque chose comme un routeur.  En tant que personne tent√©e par toutes sortes de DSL (Domain-Specific Language), je pr√©f√©rerais avoir une description plus visuelle des instructions pour une application Web que des astuces en Ruby ou un autre langage √† usage g√©n√©ral pour sp√©cifier des itin√©raires: <br><br><pre> <code class="plaintext hljs">`HTTP GET /invoices -&gt; return all invoices` `HTTP POST /invoices -&gt; create new invoice`</code> </pre><br>  ou au moins <br><br><pre> <code class="plaintext hljs">`HTTP GET /invoices -&gt; ./invoices/list_invoices` `HTTP POST /invoices -&gt; ./invoices/create`</code> </pre><br>  Ceci est tr√®s similaire √† un routeur typique, √† la seule diff√©rence qu'il n'interagit pas avec les contr√¥leurs, mais directement avec les actions sur le mod√®le.  Il est clair que si nous voulons envoyer et recevoir du JSON, nous devons nous occuper de la s√©rialisation et de la d√©s√©rialisation des objets et bien plus encore.  D'une mani√®re ou d'une autre, nous pouvons nous d√©barrasser des contr√¥leurs, transf√©rer une partie de leur responsabilit√© √† la structure de r√©pertoires et au routeur plus avanc√©. <br><br><h2>  Injection de d√©pendance </h2><br>  J'ai d√©lib√©r√©ment √©crit un ¬´routeur plus avanc√©¬ª.  Pour que le routeur puisse vraiment permettre le flux d'actions sur le mod√®le en utilisant le m√©canisme d'injection de d√©pendance au niveau d√©claratif, cela devrait probablement √™tre assez complexe √† l'int√©rieur.  Le sch√©ma g√©n√©ral de son travail devrait ressembler √† ceci: <br><br><img src="https://habrastorage.org/webt/62/v1/ts/62v1tsjynvq067lnqxmpqefw0lg.png"><br><br>  Comme vous pouvez le voir, tout mon routeur est cribl√© d'injection de d√©pendance √† l'aide d'un conteneur IoC.  Pourquoi est-ce m√™me n√©cessaire?  Le concept d '¬´injection de d√©pendance¬ª remonte √† la technique de l'inversion de d√©pendance, qui est con√ßue pour r√©duire la connectivit√© des objets en d√©pla√ßant l'initialisation des d√©pendances hors du champ de leur utilisation.  Un exemple: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Repository</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-comment"><span class="hljs-comment">#  (   ) class A def initialize </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@repo</span></span></span><span class="hljs-comment"> = Repository.new end end #  (   ) class A def initialize(repo) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@repo</span></span></span><span class="hljs-comment"> = repo end end</span></span></code> </pre><br>  Cette approche aide grandement ceux qui utilisent le d√©veloppement pilot√© par les tests.  Dans l'exemple ci-dessus, nous pouvons facilement mettre un stub dans le constructeur au lieu de l'objet de r√©f√©rentiel r√©el correspondant √† son interface, sans ¬´pirater¬ª le mod√®le d'objet.  Ce n'est pas le seul bonus DI: lorsqu'elle est appliqu√©e correctement, cette approche apportera beaucoup de magie agr√©able √† votre application, mais d'abord.  L'injection de d√©pendance est une approche qui vous permet d'int√©grer la technique d'inversion de d√©pendance dans une solution architecturale compl√®te.  L'outil d'impl√©mentation est g√©n√©ralement un conteneur IoC- (Inversion of Control).  Il y a des tonnes de conteneurs IoC vraiment cool dans le monde Java et .NET, il y en a des dizaines.  Dans JS et Ruby, malheureusement, il n'y a pas d'options appropri√©es pour moi.  En particulier, j'ai examin√© le conteneur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">sec</a> (conteneur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">sec</a> ).  Voici √† quoi ressemblerait ma classe en l'utilisant: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Invoice</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Import</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payment_service</span></span></span><span class="hljs-class">'] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pay</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">credit_card</span></span></span><span class="hljs-class"> = @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscription</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customer</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">credit_card</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class"> = @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscription</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">price</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payment_service</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">charge</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">credit_card</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Au lieu de l'utilisation mince du constructeur, nous chargeons la classe en introduisant nos propres d√©pendances, ce qui au d√©part nous √©loigne d'un mod√®le propre et ind√©pendant.  Eh bien, quelque chose, et le mod√®le ne devrait pas du tout conna√Ætre l'IoC!  Cela est vrai pour des actions comme CreateInvoice.  Pour le cas donn√©, dans mes tests, je suis d√©j√† oblig√© d'utiliser l'IoC comme quelque chose d'inali√©nable.  C'est totalement faux.  La plupart des objets d'application ne devraient pas conna√Ætre l'existence d'IoC.  Apr√®s avoir beaucoup cherch√© et r√©fl√©chi, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">j'ai esquiss√© mon IoC</a> , ce qui ne serait pas si intrusif. <br><br><h2>  Enregistrement et chargement d'un mod√®le </h2><br>  L'ignorance de persistance n√©cessite un transformateur d'objet discret.  Dans cet article, je veux dire travailler avec une base de donn√©es relationnelle, les points principaux seront vrais pour les autres types de stockages.  Un convertisseur objet-relationnel - ORM (Object Relational Mapper) est utilis√© comme un convertisseur similaire pour les bases de donn√©es relationnelles.  Dans le monde de .NET et Java, il existe une abondance d'outils ORM vraiment puissants.  Tous ont certains ou d'autres d√©fauts mineurs auxquels vous pouvez fermer les yeux.  Il n'y a pas de bonnes solutions dans JS et Ruby.  Tous, d'une mani√®re ou d'une autre, lient rigidement le mod√®le au cadre et forcent la d√©claration d'√©l√©ments √©trangers, sans parler de l'inapplicabilit√© de l'ignorance de la persistance.  Comme dans le cas de l'IoC, j'ai pens√© √† impl√©menter ORM par moi-m√™me, c'est la situation √† Ruby.  Je n'ai pas tout fait √† partir de z√©ro, mais j'ai pris comme base une simple suite ORM, qui fournit des outils discrets pour travailler avec diff√©rents SGBD relationnels.  Tout d'abord, je m'int√©ressais √† la possibilit√© d'ex√©cuter des requ√™tes sous forme de SQL standard, en recevant un tableau de cha√Ænes (objets de hachage) en sortie.  Il ne restait plus qu'√† impl√©menter votre mappeur et √† fournir une ignorance de la persistance.  Comme je l'ai d√©j√† mentionn√©, je ne voudrais pas m√©langer les champs de mappage dans le mod√®le de domaine, donc j'impl√©mente Mapper pour qu'il utilise un fichier de configuration distinct au format type: <br><br><pre> <code class="ruby hljs">entity Invoice <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> field <span class="hljs-symbol"><span class="hljs-symbol">:amount</span></span> field <span class="hljs-symbol"><span class="hljs-symbol">:date</span></span> field <span class="hljs-symbol"><span class="hljs-symbol">:start_date</span></span> field <span class="hljs-symbol"><span class="hljs-symbol">:end_date</span></span> field <span class="hljs-symbol"><span class="hljs-symbol">:created_at</span></span> field <span class="hljs-symbol"><span class="hljs-symbol">:updated_at</span></span> reference <span class="hljs-symbol"><span class="hljs-symbol">:user</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> User reference <span class="hljs-symbol"><span class="hljs-symbol">:subscription</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> Subscription <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  L'ignorance de la persistance est assez simple √† impl√©menter en utilisant un objet externe du type Repository: <br><br><pre> <code class="ruby hljs">repository.save(user)</code> </pre> <br>  Mais nous irons plus loin et appliquerons le mod√®le d'unit√© de travail.  Pour ce faire, vous devez mettre en √©vidence le concept d'une session.  Une session est un objet qui existe dans le temps, au cours duquel un ensemble d'actions est effectu√© sur le mod√®le, qui sont une seule op√©ration logique.  Au cours d'une session, le chargement et la modification des objets du mod√®le peuvent se produire.  √Ä la fin de la session, l'√©tat transactionnel du mod√®le est enregistr√©. <br>  Exemple d'unit√© de travail: <br><br><pre> <code class="ruby hljs">user = session.load(User, <span class="hljs-symbol"><span class="hljs-symbol">id:</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) plan = session.load(Plan, <span class="hljs-symbol"><span class="hljs-symbol">id:</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) subscription = Subscription.new(user, plan) session.attach(subscription) invoice = Invoice.new(subscription) session.attach(invoice) <span class="hljs-comment"><span class="hljs-comment"># ... # -       if Date.today.yday == 1 subscription.comment = 'New year offer' invoice.amount /= 2 end session.flush</span></span></code> </pre><br>  En cons√©quence, 2 instructions seront ex√©cut√©es dans la base de donn√©es au lieu de 4, et les deux seront ex√©cut√©es dans la m√™me transaction. <br><br>  Et puis souvenez-vous soudain des r√©f√©rentiels!  Ici, il y a un sentiment de d√©j√†-vu, comme avec les contr√¥leurs: le r√©f√©rentiel n'est-il pas la m√™me entit√© rudimentaire?  Pour l'avenir, je r√©pondrai - oui, √ßa l'est.  Le principal objectif du r√©f√©rentiel est d'emp√™cher la couche de logique m√©tier d'interagir avec le stockage r√©el.  Par exemple, dans le contexte des bases de donn√©es relationnelles, cela signifie √©crire des requ√™tes SQL directement dans le code logique m√©tier.  Sans aucun doute, c'est une d√©cision tr√®s raisonnable.  Mais revenons au moment o√π nous nous sommes d√©barrass√©s du contr√¥leur.  Du point de vue de la POO, le r√©f√©rentiel est essentiellement le m√™me contr√¥leur - le m√™me ensemble de m√©thodes, non seulement pour le traitement des demandes, mais pour travailler avec le r√©f√©rentiel.  Le r√©f√©rentiel peut √©galement √™tre divis√© en actions.  Selon toutes les indications, ces actions ne diff√©reront en aucune fa√ßon de ce que nous avons propos√© √† la place du contr√¥leur.  Autrement dit, nous pouvons refuser le r√©f√©rentiel et le contr√¥leur en faveur d'une seule action unifi√©e! <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoadPlan</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sql</span></span></span><span class="hljs-class"> = &lt;&lt;~</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQL</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SELECT</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class">.* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AS</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ENTITY</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FROM</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plans</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WHERE</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> = 1 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQL</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fetch</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Plan</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sql</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Vous avez probablement remarqu√© que j'utilise SQL au lieu d'une sorte de syntaxe d'objet.  C'est une question de go√ªt.  Je pr√©f√®re SQL car c'est un langage de requ√™te, une sorte de DSL pour travailler avec des donn√©es.  Il est clair qu'il est toujours plus facile d'√©crire Plan.load (id) que le SQL correspondant, mais c'est pour les cas triviaux.  Lorsqu'il s'agit de choses l√©g√®rement plus complexes, SQL devient un outil tr√®s appr√©ci√©.  Parfois, vous maudissez un autre ORM en essayant de le faire fonctionner comme du SQL pur, que ¬´j'√©crirais en quelques minutes¬ª.  Pour ceux qui sont dans le doute, je sugg√®re de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">consulter la documentation MongoDB</a> , o√π les explications sont donn√©es sous une forme similaire √† SQL, ce qui est tr√®s dr√¥le!  Par cons√©quent, l'interface pour les requ√™tes dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">ORM JetSet</a> , que j'ai √©crite pour mes besoins, est SQL avec des impr√©gnations minimales telles que ¬´AS ENTITY¬ª.  Soit dit en passant, dans la plupart des cas, je n'utilise pas d'objets de mod√®le, de divers DTO, etc. pour afficher des donn√©es tabulaires - j'√©cris simplement une requ√™te SQL, j'obtiens un tableau d'objets de hachage et je l'affiche en vue.  D'une mani√®re ou d'une autre, peu de personnes parviennent √† ¬´faire d√©filer¬ª les donn√©es volumineuses en projetant des tables associ√©es sur un mod√®le.  En pratique, la projection plate (vue) est plus susceptible d'√™tre utilis√©e, et les produits tr√®s matures arrivent √† l'√©tape d'optimisation lorsque des solutions plus complexes comme CQRS (Command and Query Responsibility Segregation) commencent √† √™tre utilis√©es. <br><br><h2>  Tout mettre ensemble </h2><br>  Donc ce que nous avons: <br><br><ul><li>  nous avons compris comment charger et enregistrer le mod√®le, nous avons √©galement con√ßu une architecture approximative de l'outil de livraison Web du mod√®le, un certain routeur; </li><li>  nous sommes arriv√©s √† la conclusion que toute logique qui ne fait pas partie du domaine peut √™tre extraite en actions (actions) au lieu de contr√¥leurs et de r√©f√©rentiels; </li><li>  Les actions doivent prendre en charge l'injection de d√©pendance </li><li>  outil d√©cent d'injection de d√©pendance mis en ≈ìuvre; </li><li>  L'ORM n√©cessaire est impl√©ment√©. </li></ul><br>  Il ne reste plus qu'√† impl√©menter le m√™me ¬´routeur¬ª.  Puisque nous nous sommes d√©barrass√©s des r√©f√©rentiels et des contr√¥leurs au profit des actions, il est √©vident que pour une demande, nous devrons effectuer plusieurs actions.  Les actions sont autonomes et nous ne pouvons pas investir les uns dans les autres.  Par cons√©quent, dans le cadre du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">framework Dandy,</a> j'ai impl√©ment√© un routeur qui vous permet de cr√©er des cha√Ænes d'actions.  Exemple de configuration (attention / plans): <br><br><pre> <code class="plaintext hljs">:receive .-&gt; :before -&gt; common/open_db_session GET -&gt; welcome -&gt; :respond &lt;- show_welcome /auth -&gt; :before -&gt; current_user@users/load_current_user /profile -&gt; GET -&gt; plan@plans/load_plan \ -&gt; :respond &lt;- users/show_user_profile PATCH -&gt; users/update_profile /plans -&gt; GET -&gt; current_plan@plans/load_current_plan \ -&gt; plans@plans/load_plans \ -&gt; :respond &lt;- plans/list :catch -&gt; common/handle_errors</code> </pre><br>  ¬´GET / auth / plans¬ª affiche tous les plans d'abonnement disponibles et ¬´met en √©vidence¬ª l'actuel.  Les √©v√©nements suivants se produisent: <br><br><ol><li>  ": avant -&gt; common / open_db_session" - ouverture d'une session JetSet </li><li>  / auth ": before -&gt; current_user @ users / load_current_user" - charge l'utilisateur actuel (par jetons).  Le r√©sultat est enregistr√© dans le conteneur IoC en tant que current_user (current_user @ instruction). </li><li>  / auth / plans "current_plan @ plans / load_current_plan" - charge le plan actuel.  Pour cela, la valeur @current_user est extraite du conteneur.  Le r√©sultat est enregistr√© dans le conteneur IoC en tant que current_plan (current_plan @ instruction): <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoadCurrentPlan</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">current_user</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">current_user</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">current_user</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sql</span></span></span><span class="hljs-class"> = &lt;&lt;~</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQL</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SELECT</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class">.* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AS</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ENTITY</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FROM</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plans</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">INNER</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JOIN</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscriptions</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ON</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user_id</span></span></span><span class="hljs-class"> = :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user_id</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AND</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">current</span></span></span><span class="hljs-class"> = '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WHERE</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> = :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user_id</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LIMIT</span></span></span><span class="hljs-class"> 1 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQL</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">execute</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sql</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user_id</span></span></span><span class="hljs-class">: @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">current_user</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">row</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">map</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Plan</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">row</span></span></span><span class="hljs-class">, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">') </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br></li><li>  "Plans @ plans / load_plans" - chargement d'une liste de tous les plans disponibles.  Le r√©sultat est enregistr√© dans le conteneur IoC en tant que plans (l'instruction plans @). </li><li>  ": respond &lt;- plans / list" - ViewBuilder enregistr√©, par exemple JBuilder, dessine la vue 'plans / list' de type: <br><br><pre> <code class="ruby hljs">json.plans @plans <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|plan|</span></span> json.id plan.id json.name plan.name json.price plan.price json.active plan.id == @current_plan.id <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br></li></ol><br>  En tant que @plans et @current_plan, les valeurs enregistr√©es dans les √©tapes pr√©c√©dentes sont extraites du conteneur.  Dans le constructeur Action, en g√©n√©ral, vous pouvez ¬´commander¬ª tout ce dont vous avez besoin, ou plut√¥t tout ce qui est enregistr√© dans le conteneur.  Un lecteur attentif aura tr√®s probablement une question, mais existe-t-il une isolation de ces variables en mode ¬´multi-utilisateurs¬ª?  Oui.  Le fait est que le conteneur Hypo IoC a la capacit√© de d√©finir la dur√©e de vie des objets et, en outre, de le lier √† la dur√©e de vie des autres objets.  Dans Dandy, des variables telles que @plans, @current_plan, @current_user sont li√©es √† l'objet de demande et seront d√©truites au moment o√π la demande est termin√©e.  Soit dit en passant, la session JetSet est √©galement li√©e √† la demande - une r√©initialisation de son √©tat sera √©galement effectu√©e lorsque la demande Dandy sera termin√©e.  C'est-√†-dire  Chaque demande a son propre contexte isol√©.  Hypo gouverne tout le cycle de vie de Dandy, peu importe √† quel point ce jeu de mots est amusant dans la traduction litt√©rale des noms. <br><br><h2>  Conclusions </h2><br>  Dans le cadre de l'architecture donn√©e, j'utilise le mod√®le objet pour d√©crire le sujet;  J'utilise des pratiques appropri√©es comme l'injection de d√©pendance;  Je peux m√™me utiliser l'h√©ritage.  Mais, en m√™me temps, toutes ces Actions sont essentiellement des fonctions ordinaires qui peuvent √™tre encha√Æn√©es ensemble √† un niveau d√©claratif.  Nous avons obtenu le backend souhait√© dans un style fonctionnel, mais avec tous les avantages de l'approche objet, lorsque vous ne rencontrez pas de probl√®mes avec les abstractions et testez votre code.  En utilisant le routeur DSL Dandy comme exemple, nous sommes libres de cr√©er les langues n√©cessaires pour d√©crire les itin√©raires et plus encore. <br><br><h2>  Conclusion </h2><br>  Dans le cadre de cet article, j'ai men√© une sorte d'excursion sur les aspects fondamentaux de la cr√©ation d'un backend tel que je le vois.  Je le r√©p√®te, l'article est superficiel, il n'a pas abord√© de nombreux sujets importants, comme par exemple l'optimisation des performances.  J'ai essay√© de me concentrer uniquement sur les choses qui peuvent vraiment √™tre utiles √† la communaut√© en tant que mati√®re √† r√©flexion, et non de verser de nouveau de vide en vide, qu'est-ce que SOLID, TDD, √† quoi ressemble le sch√©ma MVC, etc.  Des d√©finitions strictes de ces termes et d'autres termes utilis√©s par un lecteur curieux peuvent √™tre facilement trouv√©es dans le vaste r√©seau, sans parler des coll√®gues de la boutique, pour qui ces abr√©viations font partie du discours de tous les jours.  Et enfin, j'insiste, essayez de ne pas vous concentrer sur les outils dont j'avais besoin pour mettre en ≈ìuvre les probl√®mes pos√©s.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ce n'est qu'une d√©monstration de la validit√© des pens√©es, pas de leur essence. </font><font style="vertical-align: inherit;">Si cet article vous int√©resse, j'√©crirai un document s√©par√© sur ces biblioth√®ques.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr474504/">https://habr.com/ru/post/fr474504/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr474494/index.html">Comment s'est pass√© le Zabbix Summit 2019</a></li>
<li><a href="../fr474496/index.html">Bases de donn√©es sur HighLoad ++ 2019</a></li>
<li><a href="../fr474498/index.html">Tutoriel JavaFX: Hello World</a></li>
<li><a href="../fr474500/index.html">D√©veloppement de plugins pour Grafana: l'histoire des c√¥nes pleins</a></li>
<li><a href="../fr474502/index.html">Analyse d'Odnoklassniki au Joker 2019</a></li>
<li><a href="../fr474508/index.html">R√©alisations de la bio-impression 3D des greffes de peau</a></li>
<li><a href="../fr474514/index.html">Comment survivent les magnats chinois de l'exploitation mini√®re du Bitcoin</a></li>
<li><a href="../fr474516/index.html">Applications vocales: le milliardi√®me march√© que la Russie ne remarque pas</a></li>
<li><a href="../fr474518/index.html">FP vs OOP</a></li>
<li><a href="../fr474522/index.html">Histoire de Mutt</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>