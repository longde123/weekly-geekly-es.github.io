<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üÄÑÔ∏è ü§õ üõåüèΩ Rediriger printf () de STM32 vers Qt Creator Console üëºüèæ ‚õ±Ô∏è ü§¶üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Souvent, lors du d√©bogage d'un logiciel de microcontr√¥leur, il devient n√©cessaire d'afficher des messages de d√©bogage, des journaux, des donn√©es captu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Rediriger printf () de STM32 vers Qt Creator Console</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/440024/"><p><img src="https://habrastorage.org/webt/gg/yw/ol/ggywoln37vevtn3jnep_hcahfhu.png" alt="kdpv.svg"></p><br><p>  Souvent, lors du d√©bogage d'un logiciel de microcontr√¥leur, il devient n√©cessaire d'afficher des messages de d√©bogage, des journaux, des donn√©es captur√©es et d'autres choses sur l'√©cran du PC.  En m√™me temps, je veux que la sortie soit plus rapide et que les lignes ne soient affich√©es nulle part, mais directement dans l'IDE - sans s'√©carter du code, pour ainsi dire.  En fait, il s'agit de l'article - comment j'ai essay√© printf () pour sortir et afficher dans mon environnement Qt Creator pr√©f√©r√©, mais pas tr√®s microcontr√¥leur. </p><a name="habracut"></a><br><p>  En g√©n√©ral, vous pouvez trouver un grand nombre de fa√ßons de sortir des informations textuelles √† partir du microcontr√¥leur.  Cependant, les techniques les plus utilis√©es ne sont pas si nombreuses: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Semihosting</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Segger rtt</a> </li><li>  CDC USB </li><li>  UART </li><li>  ITM </li></ul><br><p>  Le semi-h√©bergement est plut√¥t lent, RTT est li√© aux solutions mat√©rielles et logicielles Segger *, l'USB n'est pas dans tous les microcontr√¥leurs.  Par cons√©quent, g√©n√©ralement, je pr√©f√®re les deux derniers - l'utilisation de l'UART et de l'ITM.  √Ä leur sujet et seront discut√©s ci-dessous. </p><br><p>  * <em>Upd.</em>  <em>- en fait, comme sugg√©r√© dans les commentaires, il n'en est pas ainsi.</em>  <em>Il existe des options tant sur le plan logiciel que mat√©riel.</em>  <em>Par cons√©quent, parmi les m√©thodes ci-dessus, RTT sera peut-√™tre la plus universelle.</em> </p><br><p>  Et tout de suite quelques explications sur le logiciel qui sera utilis√© ensuite.  J'ai maintenant Fedora 28 comme syst√®me d'exploitation, et l'ensemble de logiciels actuel pour travailler avec des microcontr√¥leurs est le suivant: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Qt Creator 4.8.1</a> (lien direct vers les versions, plut√¥t soigneusement cach√© sur le site) </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Cha√Æne d'outils int√©gr√©e GNU Arm 7</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">OpenOCD 0.10.0 + dev</a> </li></ul><br><h3 id="perenapravlenie-printf-v-gcc">  Rediriger printf () dans GCC </h3><br><p>  Donc, pour rediriger la sortie de printf () dans GCC, vous devez ajouter des cl√©s de l'√©diteur de liens </p><br><pre><code class="plaintext hljs">-specs=nosys.specs -specs=nano.specs</code> </pre> <br><p>  Si vous devez afficher des nombres √† virgule flottante, vous devez vous rappeler la cl√© </p><br><pre> <code class="plaintext hljs">-u_printf_float</code> </pre> <br><p>  Et impl√©mentez la fonction _write ().  Par exemple, quelque chose comme √ßa </p><br><pre> <code class="plaintext hljs">int _write(int fd, char* ptr, int len) { (void)fd; int i = 0; while (ptr[i] &amp;&amp; (i &lt; len)) { retarget_put_char((int)ptr[i]); if (ptr[i] == '\n') { retarget_put_char((int)'\r'); } i++; } return len; }</code> </pre> <br><p>  o√π retarget_put_char () est une fonction qui chargera le caract√®re directement dans l'interface souhait√©e. </p><br><h3 id="printf---itm---qt-creator">  printf () -&gt; ITM -&gt; Qt Creator </h3><br><p>  Instrumentation Trace Macrocell (ITM) est un bloc √† l'int√©rieur du noyau Cortex-M3 / M4 / M7 utilis√© pour la sortie (tra√ßage) non invasive de divers types d'informations de diagnostic.  Pour impl√©menter printf () sur ITM, vous devez conna√Ætre les √©l√©ments suivants: </p><br><ul><li>  Utilise l'horloge TRACECLKIN, dont la fr√©quence est g√©n√©ralement √©gale √† la fr√©quence centrale </li><li>  Dispose de 32 ports dits de stimulus pour la sortie de donn√©es </li><li>  CMSIS incorpore la fonction ITM_SendChar (), qui charge un symbole dans le port de stimulation 0 </li><li>  Les donn√©es sont sorties soit via un bus synchrone (TRACEDATA, TRACECLK), soit via une ligne SWO monofilaire asynchrone (TRACESWO) </li><li>  La ligne SWO est g√©n√©ralement multiplex√©e avec JTDO, ce qui signifie qu'elle ne fonctionne qu'en mode d√©bogage par SWD </li><li>  Le retrait par SWO s'effectue soit en utilisant le code Manchester, soit en NRZ (UART 8N1) </li><li>  Les donn√©es sont transmises dans des trames d'un certain format - vous avez besoin d'un analyseur c√¥t√© r√©ception </li><li>  ITM est g√©n√©ralement configur√© √† partir de l'EDI ou de l'utilitaire correspondant (cependant, personne n'interdit de le configurer dans le code du programme - alors la sortie vers SWO fonctionnera sans une session de d√©bogage √©lev√©e) </li></ul><br><p>  La fa√ßon la plus pratique d'utiliser ITM est de sortir via SWO en utilisant l'encodage NRZ - ainsi, vous n'avez besoin que d'une seule ligne, et il sera possible de recevoir des donn√©es non seulement en utilisant un d√©bogueur avec une entr√©e sp√©ciale, mais aussi un adaptateur USB-UART ordinaire, bien qu'√† une vitesse inf√©rieure. </p><br><p>  J'ai suivi le chemin √† l'aide d'un d√©bogueur et j'ai √©t√© forc√© de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">modifier</a> mon STLink-V2 chinois pour prendre en charge SWO.  Ensuite, tout est simple - nous connectons le microcontr√¥leur JTDO / TRACESWO √† la broche de d√©bogage correspondante, et allons configurer le logiciel. </p><br><p>  Openocd a la commande "tpiu config" - avec elle, vous pouvez configurer la m√©thode d'affichage des informations de trace (plus en d√©tail dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Guide d'utilisation d'OpenOCD</a> ).  Ainsi, par exemple, en utilisant des arguments </p><br><pre> <code class="plaintext hljs">tpiu config internal /home/esynr3z/itm.fifo uart off 168000000</code> </pre> <br><p>  configurez la sortie dans le fichier /home/esynr3z/itm.fifo, utilisez l'encodage NRZ et calculez la vitesse de transfert maximale en fonction de la fr√©quence TRACECLKIN de 168 MHz - pour STLink, elle est de 2 MHz.  Et une autre √©quipe </p><br><pre> <code class="plaintext hljs">itm port 0 1</code> </pre> <br><p>  activera le port z√©ro pour le transfert de donn√©es. </p><br><p>  Le code source d'OpenOCD inclut l'utilitaire itmdump (contrib / itmdump.c) - avec lui, vous pouvez analyser des cha√Ænes √† partir des donn√©es re√ßues. </p><br><p>  Pour compiler on entre </p><br><pre> <code class="plaintext hljs">gcc itmdump.c -o itmdump</code> </pre> <br><p>  Au d√©marrage, sp√©cifiez le fichier / pipe / ttyUSB * et le commutateur -d1 n√©cessaires pour afficher les octets de donn√©es re√ßus sous forme de cha√Ænes </p><br><pre> <code class="plaintext hljs">./itmdump -f /home/esynr3z/itm.fifo -d1</code> </pre> <br><p>  Et le dernier.  Pour envoyer un caract√®re via SWO, nous compl√©tons _write (), d√©crit ci-dessus, avec une fonction </p><br><pre> <code class="plaintext hljs">int retarget_put_char(int ch) { ITM_SendChar((uint32_t)ch); return 0; }</code> </pre> <br><p>  Donc, le plan g√©n√©ral est le suivant: dans Qt Creator, nous configurons openocd pour enregistrer toutes les informations re√ßues sur SWO dans un canal nomm√© pr√©c√©demment cr√©√©, et nous pouvons lire le tube, analyser les cha√Ænes et l'afficher √† l'aide d'itmdump, qui s'ex√©cute comme un outil externe.  Bien s√ªr, il existe un moyen plus √©l√©gant de r√©soudre le probl√®me: √©crire le plug-in appropri√© pour Qt Creator.  Cependant, j'esp√®re que l'approche d√©crite ci-dessous s'av√©rera utile √† quelqu'un. </p><br><p>  Acc√©dez aux param√®tres du plugin Bare Metal (Outils-&gt; Options-&gt; P√©riph√©riques-&gt; Bare Metal). </p><br><p><img src="https://habrastorage.org/webt/_t/0e/vz/_t0evzgzyymortwmhhwnvumadrq.png" alt="config_baremetal.png"></p><br><p>  S√©lectionnez le serveur GDB utilis√© et ajoutez les commandes d'initialisation de ligne √† la fin de la liste </p><br><pre> <code class="plaintext hljs">monitor tpiu config internal /home/esynr3z/itm.fifo uart off 168000000 monitor itm port 0 1</code> </pre> <br><p>  Maintenant, juste avant que le d√©bogueur place le curseur au tout d√©but de main (), ITM sera configur√©. </p><br><p>  Ajoutez itmdump en tant qu'outil externe (Outils-&gt; Externe-&gt; Configurer ...). </p><br><p><img src="https://habrastorage.org/webt/tx/18/mk/tx18mk_cx8zdqhxajwxsoh2ivlk.png" alt="external_itmdump.png"></p><br><p>  N'oubliez pas de r√©gler la variable </p><br><pre> <code class="plaintext hljs">QT_LOGGING_TO_CONSOLE=1</code> </pre> <br><p>  pour afficher la sortie de l'utilitaire sur la console Qt Creator (panneau 7 Messages g√©n√©raux). </p><br><p>  Maintenant, activez itmdump, activez le mode d√©bogage, lancez l'ex√©cution du code et ... rien ne se passe.  Cependant, si vous interrompez le d√©bogage, l'ex√©cution d'itmdump se terminera et toutes les lignes imprim√©es via printf () appara√Ætront dans l'onglet Messages g√©n√©raux. </p><br><p>  Apr√®s une courte recherche, il a √©t√© constat√© que les lignes de itmdump devraient √™tre mises en m√©moire tampon et affich√©es dans stderr - puis elles apparaissent de mani√®re interactive dans la console, lors du d√©bogage du programme.  J'ai t√©l√©charg√© une version modifi√©e d'itmdump sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GitHub</a> . </p><br><p>  Il y a une autre mise en garde.  Le d√©bogage au d√©marrage suspendra l'ex√©cution de la commande "monitor tpiu config ..." si itmdump n'est pas ex√©cut√© auparavant.  Cela se produit en raison du fait que l'ouverture du canal (/home/esynr3z/itm.fifo) dans openocd pour l'√©criture est bloquante, et le d√©bogueur se bloque jusqu'√† ce que le canal s'ouvre pour la lecture de l'autre extr√©mit√©. </p><br><p>  C'est quelque peu d√©sagr√©able, surtout si √† un moment donn√©, ITM n'est pas n√©cessaire, mais vous devez ex√©cuter itmdump de fa√ßon inactive, soit constamment changer de serveur GDB, soit supprimer / ajouter des lignes dans ses param√®tres.  Par cons√©quent, j'ai d√ª creuser un peu de sources openocd et trouver l'endroit o√π vous devez remplacer une petite b√©quille. </p><br><p>  Dans le fichier src / target / armv7m_trace.c, il y a une ligne avec la proc√©dure d'ouverture souhait√©e </p><br><pre> <code class="plaintext hljs">armv7m-&gt;trace_config.trace_file = fopen(CMD_ARGV[cmd_idx], "ab");</code> </pre> <br><p>  il doit √™tre remplac√© par </p><br><pre> <code class="plaintext hljs">int fd = open(CMD_ARGV[cmd_idx], O_CREAT | O_RDWR, 0664); armv7m-&gt;trace_config.trace_file = fdopen(fd, "ab");</code> </pre> <br><p>  Maintenant, notre pipe s'ouvrira imm√©diatement et ne brillera pas.  Vous pouvez donc laisser les param√®tres Bare Metal seuls, et itmdump ne s'ex√©cute que lorsque cela est n√©cessaire. </p><br><p>  Par cons√©quent, la sortie des messages pendant le d√©bogage ressemble √† ceci </p><br><p><img src="https://habrastorage.org/webt/lz/-x/po/lz-xpo5ujcbkrga3al-pnsectme.png" alt="debug.png"></p><br><h2 id="printf---uart---qt-creator">  printf () -&gt; UART -&gt; Qt Creator </h2><br><p>  Dans ce cas, tout est √† peu pr√®s le m√™me: </p><br><ul><li>  Ajouter une fonction avec initialisation UART au code </li><li>  Nous impl√©mentons retarget_put_char (), o√π le caract√®re sera envoy√© au tampon de l'√©metteur-r√©cepteur </li><li>  Nous connectons l'adaptateur USB-UART </li><li>  Ajoutez un utilitaire aux outils externes qui lira les lignes du port COM virtuel et les affichera √† l'√©cran. </li></ul><br><p>  J'ai esquiss√© un tel utilitaire dans C - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">uartdump</a> .  L'utilisation est assez simple - il vous suffit de sp√©cifier le nom du port et la vitesse de transmission. </p><br><p><img src="https://habrastorage.org/webt/wm/ov/mf/wmovmfhdw33hahv1mdaubq0432u.png" alt="external_uartdump.png"></p><br><p>  Cependant, il convient de noter une caract√©ristique.  Cet utilitaire ne d√©pend pas du d√©bogage et Qt Creator ne propose aucune option pour fermer les outils externes en cours d'ex√©cution.  Par cons√©quent, pour arr√™ter la lecture du port COM, j'ai ajout√© un autre outil externe. </p><br><p><img src="https://habrastorage.org/webt/k8/ee/1p/k8ee1pim_owcrvyuvz3jrsezta8.png" alt="external_uartdump_close.png"></p><br><p>  Eh bien, juste au cas o√π, je vais attacher un lien vers le mod√®le CMake pour le projet qui est apparu sur les captures d'√©cran - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GitHub</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr440024/">https://habr.com/ru/post/fr440024/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr440014/index.html">Comp√©tences, auto-√©ducation et langages de programmation pour les d√©veloppeurs d√©butants: recherche HackerRank</a></li>
<li><a href="../fr440016/index.html">Quand on peut toucher la lecture: ONYX BOOX Monte Cristo 4 avis</a></li>
<li><a href="../fr440018/index.html">Exposition locale dynamique</a></li>
<li><a href="../fr440020/index.html">R√©gression ou r√©gression dans les tests</a></li>
<li><a href="../fr440022/index.html">Une petite Ferrari: la start-up Fintech Rally Rd vous permettra d'acheter des "parts" de voitures rares</a></li>
<li><a href="../fr440026/index.html">Kaggle: ne peut pas marcher - courons</a></li>
<li><a href="../fr440030/index.html">Identifiez le blocage PKH sur un routeur OpenWrt avec WireGuard et DNSCrypt</a></li>
<li><a href="../fr440032/index.html">Intelligence artificielle Horizon Zero Dawn</a></li>
<li><a href="../fr440034/index.html">KISS Architecture. Du microservice au monolithe</a></li>
<li><a href="../fr440036/index.html">Saisie tactile</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>