<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ§ğŸ¾ ğŸ‘‹ğŸ» ğŸ‘¨ğŸ½â€ğŸ¤â€ğŸ‘¨ğŸ¼ Spring Data JPAï¼šå¸¦æ–‡ä»¶ ğŸš¸ ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦â€ğŸ‘¦ ğŸ¤šğŸ½</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="é—®å€™ï¼Œè¿™æ˜¯æœ‰å…³Spring Data JPAçš„ç¬¬äºŒç¯‡æ–‡ç« ã€‚ ç¬¬ä¸€éƒ¨åˆ†å®Œå…¨ä¸“æ³¨äºæ°´ä¸‹è€™ï¼Œä»¥åŠç»éªŒä¸°å¯Œçš„è€™çš„æŠ€å·§ã€‚ åœ¨è¿™ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºå¦‚ä½•æ ¹æ®æ‚¨çš„éœ€æ±‚ä¼˜åŒ–æ¡†æ¶ã€‚ æ­¤å¤„æè¿°çš„æ‰€æœ‰ç¤ºä¾‹å‡å¯ç”¨ã€‚ 
 è®¡æ•° 


 è®©æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•è€ŒåŒæ—¶åˆå¸¸è§çš„ä»»åŠ¡å¼€å§‹ï¼šåŠ è½½å®ä½“æ—¶ï¼Œæœ‰å¿…è¦æœ‰é€‰æ‹©åœ°ä¸‹è½½å…¶â€œå¥³å„¿â€ã€‚ è€ƒè™‘ä¸€...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Spring Data JPAï¼šå¸¦æ–‡ä»¶</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/444240/"><p>é—®å€™ï¼Œè¿™æ˜¯æœ‰å…³Spring Data JPAçš„ç¬¬äºŒç¯‡æ–‡ç« ã€‚  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç¬¬ä¸€éƒ¨åˆ†</a>å®Œå…¨ä¸“æ³¨äºæ°´ä¸‹è€™ï¼Œä»¥åŠç»éªŒä¸°å¯Œçš„è€™çš„æŠ€å·§ã€‚ åœ¨è¿™ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºå¦‚ä½•æ ¹æ®æ‚¨çš„éœ€æ±‚ä¼˜åŒ–æ¡†æ¶ã€‚  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ­¤å¤„</a>æè¿°çš„æ‰€æœ‰ç¤ºä¾‹å‡å¯ç”¨ã€‚ </p><a name="habracut"></a><br><h4 id="grafy"> è®¡æ•° </h4><br><p> è®©æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•è€ŒåŒæ—¶åˆå¸¸è§çš„ä»»åŠ¡å¼€å§‹ï¼šåŠ è½½å®ä½“æ—¶ï¼Œæœ‰å¿…è¦æœ‰é€‰æ‹©åœ°ä¸‹è½½å…¶â€œå¥³å„¿â€ã€‚ è€ƒè™‘ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š </p><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Child</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@JoinColumn</span></span>(name = <span class="hljs-string"><span class="hljs-string">"parent_id"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ManyToOne</span></span>(fetch = FetchType.LAZY, cascade = CascadeType.ALL) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Parent parent; } <span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; }</code> </pre> <br><p> åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œå­å®ä½“æ˜¯æ‡’æƒ°çš„ï¼šæˆ‘ä»¬ä¸æƒ³åœ¨æ¥æ”¶<code>Child</code>æ—¶åŠ è½½ä¸å¿…è¦çš„æ•°æ®ï¼ˆå¹¶åœ¨SQLæŸ¥è¯¢ä¸­è”æ¥å¦ä¸€ä¸ªè¡¨ï¼‰ã€‚ ä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œåœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­æˆ‘ä»¬è‚¯å®šçŸ¥é“æˆ‘ä»¬å°†åŒæ—¶éœ€è¦å­©å­å’Œä»–çš„çˆ¶æ¯ã€‚ å¦‚æœæ‚¨è®©å®ä½“æ‡’æƒ°ï¼Œæˆ‘ä»¬å°†æ”¶åˆ°2ä¸ªå•ç‹¬çš„è¯·æ±‚ã€‚ å¦‚æœæ‚¨é€šè¿‡åˆ é™¤<code>FetchType.LAZY</code>åº”ç”¨å¿«é€ŸåŠ è½½ï¼Œåˆ™ä¸¤ä¸ªå®ä½“å°†å§‹ç»ˆåœ¨ç¬¬ä¸€ä¸ªè¯·æ±‚æ—¶åŠ è½½ï¼ˆæˆ‘ä»¬ä¸å¸Œæœ›è¿™æ ·åšï¼‰ã€‚ </p><br><p>  JPQLæä¾›äº†ä¸€ä¸ªå¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆ-è¿™æ˜¯<code>fetch</code>å…³é”®å­—ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChildRepository</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JpaRepository</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Child</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Long</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Query</span></span>(<span class="hljs-string"><span class="hljs-string">"select c from Child c join fetch c.parent where c.id = :id"</span></span>) <span class="hljs-function"><span class="hljs-function">Child </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findByIdFetchParent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Param(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"id"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> Long id)</span></span>; }</code> </pre> <br><p> è¯¥è¯·æ±‚ç®€å•æ˜äº†ï¼Œä½†æœ‰ç¼ºç‚¹ï¼š </p><br><ul><li>  <code>JpaRepository::findById</code>æ·»åŠ æ˜¾å¼åŠ è½½ï¼Œæˆ‘ä»¬å®é™…ä¸Šå¤åˆ¶äº†<code>JpaRepository::findById</code>çš„é€»è¾‘ </li><li> åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶<code>@Query</code>æ£€æŸ¥ä½¿ç”¨<code>@Query</code>æè¿°çš„æ¯ä¸ªæŸ¥è¯¢ï¼Œè¿™éœ€è¦è§£ææŸ¥è¯¢ï¼Œæ£€æŸ¥å‚æ•°ç­‰ã€‚ï¼ˆè¯·å‚é˜…<a href="">org.springframework.data.jpa.repository.query.SimpleJpaQuery :: validateQuery</a> ï¼‰ã€‚ æ‰€æœ‰è¿™äº›éƒ½æ˜¯éœ€è¦æ—¶é—´å’Œè®°å¿†çš„å·¥ä½œã€‚ </li><li> åœ¨å…·æœ‰æ•°åä¸ªå­˜å‚¨åº“å’Œäº¤ç»‡çš„å®ä½“ï¼ˆæœ‰æ—¶æœ‰åäºŒä¸ªâ€œå¥³å„¿â€ï¼‰çš„å¤§å‹é¡¹ç›®ä¸­ä½¿ç”¨è¿™ç§æ–¹æ³•å°†å¯¼è‡´ç»„åˆçˆ†ç‚¸ã€‚ </li></ul><br><p> å…³é”®åœ¨äºæˆ‘ä»¬çš„æ´åŠ©ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-meta"><span class="hljs-meta">@NamedEntityGraphs</span></span>(value = { <span class="hljs-meta"><span class="hljs-meta">@NamedEntityGraph</span></span>( name = Child.PARENT, attributeNodes = <span class="hljs-meta"><span class="hljs-meta">@NamedAttributeNode</span></span>(<span class="hljs-string"><span class="hljs-string">"parent"</span></span>) ) }) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Child</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String PARENT = <span class="hljs-string"><span class="hljs-string">"Child[parent]"</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@JoinColumn</span></span>(name = <span class="hljs-string"><span class="hljs-string">"parent_id"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ManyToOne</span></span>(fetch = FetchType.LAZY, cascade = CascadeType.ALL) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Parent parent; }</code> </pre> <br><p> è¯¥å›¾æœ¬èº«å¾ˆå®¹æ˜“æè¿°ï¼›ä½¿ç”¨æ—¶ä¼šé‡åˆ°å›°éš¾ã€‚  Spring Data JPAåœ¨å…¶é¡µé¢ä¸Šå»ºè®®è¿™æ ·åšï¼ˆé€‚ç”¨äºæˆ‘ä»¬çš„æ¡ˆä¾‹ï¼‰ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GroupRepository</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JpaRepository</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GroupInfo</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@EntityGraph</span></span>(value = Child.PARENT) <span class="hljs-meta"><span class="hljs-meta">@Query</span></span>(<span class="hljs-string"><span class="hljs-string">"select c from Child c where c.id = :id"</span></span>) <span class="hljs-function"><span class="hljs-function">Child </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findByIdFetchParent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Param(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"id"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> Long id)</span></span>; }</code> </pre> <br><p> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°äº†æ‰€æœ‰ç›¸åŒçš„é—®é¢˜ï¼ˆé™¤äº†ä¹¦é¢è¯·æ±‚å˜å¾—æ›´åŠ ç®€å•ï¼‰ã€‚ æ‚¨å¯ä»¥åœ¨å¾®è°ƒçš„å¸®åŠ©ä¸‹ä¸€å£æ°”ç»“æŸå®ƒä»¬ã€‚ åˆ›å»ºæ‚¨è‡ªå·±çš„æ¥å£ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒæ¥æ„å»ºå­˜å‚¨åº“ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ç›’è£…çš„<code>JpaRepository</code> ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@NoRepositoryBean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseJpaRepository</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ID</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializable</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JpaRepository</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ID</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ID id, String graphName)</span></span></span></span>; }</code> </pre> <br><p> ç°åœ¨æ‰§è¡Œï¼š </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseJpaRepositoryImpl</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ID</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializable</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleJpaRepository</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ID</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseJpaRepository</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ID</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> JpaEntityInformation&lt;T, ?&gt; entityInfo; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> EntityManager entityManager; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BaseJpaRepositoryImpl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JpaEntityInformation&lt;T, ?&gt; ei, EntityManager em)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(ei, em); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.entityInfo = ei; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.entityManager = em; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ID id, String graphName)</span></span></span><span class="hljs-function"> </span></span>{ Assert.notNull(id, <span class="hljs-string"><span class="hljs-string">"The given id must not be null!"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  EntityGraph&lt;?&gt; graph = entityManager.getEntityGraph(graphName); Map&lt;String, Object&gt; hints = singletonMap(QueryHints.HINT_LOADGRAPH, graph); return entityManager.find(getDomainClass(), id, hints); }</span></span></code> </pre> <br><p> ç°åœ¨ï¼ŒSpringä¸å¾—ä¸ä½¿ç”¨<code>BaseJpaRepositoryImpl</code>ä½œä¸ºåº”ç”¨ç¨‹åºæ‰€æœ‰å­˜å‚¨åº“çš„åŸºç¡€ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@EnableJpaRepositories</span></span>(repositoryBaseClass = BaseJpaRepositoryImpl.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppConfig</span></span></span><span class="hljs-class"> </span></span>{ }</code> </pre> <br><p> ç°åœ¨ï¼Œä»<code>BaseJpaRepository</code>ç»§æ‰¿çš„æ‰€æœ‰å­˜å‚¨åº“ä¸­éƒ½å¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„æ–¹æ³•ã€‚ </p><br><p> è¿™ç§æ–¹æ³•æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œé‚£å°±æ˜¯å¯ä»¥æ”¾ä¸€ä¸ªéå¸¸è‚¥çš„çŒªã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">è¯•ç€ä¸ºè‡ªå·±æ€è€ƒ</b> <div class="spoiler_text"><p> é—®é¢˜åœ¨äºï¼ŒHibernateï¼ˆè‡³å°‘åœ¨ç¼–å†™æœ¬æ–‡æ—¶ï¼‰ä¸å›¾çš„åç§°å’Œå›¾æœ¬èº«ä¸åŒ¹é…ã€‚ å› æ­¤ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œç±»ä¼¼çš„æ“ä½œæ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°è¿è¡Œæ—¶é”™è¯¯ </p><br><pre> <code class="java hljs">Optional&lt;MyEntity&gt; entity = repository.findById(id, NON_EXISTING_GRAPH);</code> </pre> </div></div><br><p> æ‚¨å¯ä»¥ä½¿ç”¨æµ‹è¯•æ¥æ£€æŸ¥è§£å†³æ–¹æ¡ˆçš„è¿è¡ŒçŠ¶å†µï¼š </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Sql</span></span>(<span class="hljs-string"><span class="hljs-string">"/ChildRepositoryGraphTest.sql"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChildRepositoryGraphTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestBase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Long childId = <span class="hljs-number"><span class="hljs-number">1L</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testGraph_expectFieldInitialized</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Child child1 = childRepository.findOne(childId, Child.PARENT); <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> initialized = Hibernate.isInitialized(child1.getParent()); assertTrue(initialized); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testGraph_expectFieldNotInitialized</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Child child1 = childRepository .findById(childId) .orElseThrow(NullPointerException::<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> initialized = Hibernate.isInitialized(child1.getParent()); assertFalse(initialized); } }</code> </pre> <br><h4 id="kogda-derevya-byli-bolshimi"> æ ‘æœ¨å¤§çš„æ—¶å€™ </h4><br><p> è€Œä¸”æˆ‘ä»¬å¾ˆå°ï¼Œæ²¡æœ‰ç»éªŒï¼Œæˆ‘ä»¬ç»å¸¸ä¸å¾—ä¸çœ‹ä¸‹é¢çš„ä»£ç ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;DailyRecord&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findBetweenDates</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Date from, Date to)</span></span></span><span class="hljs-function"> </span></span>{ StringBuilder query = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"from Record "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (from != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { query.append(<span class="hljs-string"><span class="hljs-string">" where date &gt;="</span></span>).append(format(from)).append(<span class="hljs-string"><span class="hljs-string">" "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (to != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (from == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { query.append(<span class="hljs-string"><span class="hljs-string">" where date &lt;= "</span></span> + format(to) + <span class="hljs-string"><span class="hljs-string">" "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { query.append(<span class="hljs-string"><span class="hljs-string">" and date &lt;= "</span></span> + format(to) + <span class="hljs-string"><span class="hljs-string">" "</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> em.createQuery(query.toString(), DailyRecord.class).getResultList(); }</code> </pre> <br><p> æ­¤ä»£ç é€æ®µæ”¶é›†è¯·æ±‚ã€‚ è¿™ç§æ–¹æ³•çš„ç¼ºç‚¹å¾ˆæ˜æ˜¾ï¼š </p><br><ul><li> ä¸ä½ çš„æ‰‹æœ‰å¾ˆå¤§å…³ç³» </li><li> æœ‰æ‰‹å·¥å·¥ä½œçš„åœ°æ–¹-æœ‰é”™è¯¯ </li><li> ä¸çªå‡ºæ˜¾ç¤ºè¯­æ³•ï¼ˆè¿è¡Œæ—¶ä¼šå¼¹å‡ºæ‰“å­—é”™è¯¯ï¼‰ </li><li> æ‰©å±•å’Œç»´æŠ¤ä»£ç éå¸¸å›°éš¾ </li></ul><br><p> ä¸ä¹…ä¹‹åï¼Œå‡ºç°äº†Criteria APIï¼Œè¿™ä½¿æˆ‘ä»¬å¯ä»¥å°†ä¸Šé¢çš„ä»£ç å‹ç¼©ä¸€ç‚¹ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;DailyRecord&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findBetweenDates</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Date from, Date to)</span></span></span><span class="hljs-function"> </span></span>{ Criteria criteria = em .unwrap(Session.class) .createCriteria(DailyRecord.class); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (from != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { criteria.add(Expression.ge(<span class="hljs-string"><span class="hljs-string">"date"</span></span>, from)); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (to != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { criteria.add(Expression.le(<span class="hljs-string"><span class="hljs-string">"date"</span></span>, to)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> criteria.list(); }</code> </pre> <br><p> ä½¿ç”¨æ¡ä»¶æœ‰å‡ ä¸ªä¼˜ç‚¹ï¼š </p><br><ul><li> ä½¿ç”¨å…ƒæ¨¡å‹ä»£æ›¿â€œæ—¥æœŸâ€ç­‰â€œæœ‰çº¿â€å€¼çš„èƒ½åŠ› </li><li> æ„é€ è¯·æ±‚æ—¶å‡ºç°çš„ä¸€äº›é”™è¯¯æ˜¯ç¼–è¯‘é”™è¯¯ï¼Œå³åœ¨ç¼–å†™æ—¶å·²ç»æ£€æµ‹åˆ°å®ƒä»¬ </li><li> ä¸æ„šè ¢çš„ç²˜è´´å­—ç¬¦ä¸²ç›¸æ¯”ï¼Œè¯¥ä»£ç æ›´çŸ­ï¼Œæ›´æ˜“äºç†è§£ </li></ul><br><p> ä¹Ÿæœ‰ç¼ºç‚¹ï¼š </p><br><ul><li> ä»£ç å¾ˆå¤æ‚ï¼Œè¶³ä»¥ç†è§£ </li><li> è¦å­¦ä¹ å¦‚ä½•ç¼–å†™æ­¤ç±»æŸ¥è¯¢ï¼Œæ‚¨éœ€è¦ä»˜å‡ºå¾ˆå¤šåŠªåŠ›ï¼ˆæˆ‘è®°å¾—æˆ‘ç¬¬ä¸€æ¬¡ä¸å¾—ä¸åœ¨æ­¤ç±»æŸ¥è¯¢ä¸­è¿›è¡Œçº é”™æ—¶é‡åˆ°çš„æœ€å¤§ç—›è‹¦ï¼Œæœ‰æ—¶åŒ…æ‹¬100-150è¡Œï¼Œå¸¦æœ‰åˆ†æ”¯ç­‰ï¼‰ </li><li> å¤æ‚çš„æŸ¥è¯¢ç›¸å½“éº»çƒ¦ï¼ˆè·ç¦»é™åˆ¶ä¸è¶…è¿‡50è¡Œï¼‰ </li></ul><br><p> æˆ‘æƒ³è½»æ¾æ„‰å¿«åœ°å¼€å‘å®ƒï¼Œæ‰€ä»¥æˆ‘ä¸å–œæ¬¢è¿™ä¸¤ç§æ–¹æ³•ã€‚ </p><br><p> è®©æˆ‘ä»¬è½¬åˆ°æˆ‘ä»¬å·²ç»æ£€æŸ¥è¿‡çš„å®ä½“ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Child</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@JoinColumn</span></span>(name = <span class="hljs-string"><span class="hljs-string">"parent_id"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ManyToOne</span></span>(fetch = FetchType.LAZY, cascade = CascadeType.ALL) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Parent parent; <span class="hljs-comment"><span class="hljs-comment">//... @OneToMany(mappedBy = "owner", cascade = CascadeType.ALL) @LazyCollection(value = LazyCollectionOption.EXTRA) private List&lt;Toy&gt; toys = new ArrayList&lt;&gt;(); }</span></span></code> </pre> <br><p> æˆ‘å¸Œæœ›èƒ½å¤Ÿä»¥ä¸åŒçš„æ¨¡å¼ï¼ˆåŠå…¶ç»„åˆï¼‰åŠ è½½å®ä½“ï¼š </p><br><ul><li> åŠ è½½ï¼ˆæˆ–ä¸åŠ è½½ï¼‰çˆ¶çº§ </li><li> åŠ è½½ï¼ˆæˆ–ä¸åŠ è½½ï¼‰ç©å…· </li><li> æŒ‰å¹´é¾„åˆ†ç±»å„¿ç«¥ </li></ul><br><p> å¦‚æœæ‚¨ç›´æ¥è§£å†³æ­¤é—®é¢˜ï¼Œå³é€šè¿‡ç¼–å†™è®¸å¤šä¸æ‰€é€‰åŠ è½½æ¨¡å¼ç›¸å¯¹åº”çš„æŸ¥è¯¢ï¼Œé‚£ä¹ˆå¾ˆå¿«å°±ä¼šå¯¼è‡´ç»„åˆçˆ†ç‚¸ï¼š </p><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Query</span></span>(<span class="hljs-string"><span class="hljs-string">"select c from Child c join fetch c.parent order by c.age"</span></span>) <span class="hljs-function"><span class="hljs-function">List&lt;Child&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findWithParentOrderByAge</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-meta"><span class="hljs-meta">@Query</span></span>(<span class="hljs-string"><span class="hljs-string">"select c from Child c join fetch c.toys order by c.age"</span></span>) <span class="hljs-function"><span class="hljs-function">List&lt;Child&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findWithToysOrderByAge</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-meta"><span class="hljs-meta">@Query</span></span>(<span class="hljs-string"><span class="hljs-string">"select c from Child c join fetch c.parent join fetch c.toys"</span></span>) <span class="hljs-function"><span class="hljs-function">List&lt;Child&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findWithParentAndToys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">//...</span></span></code> </pre> <br><p> æœ‰ä¸€ä¸ªç®€å•è€Œä¼˜é›…çš„æ–¹æ³•å¯ä»¥è§£å†³æ­¤é—®é¢˜ï¼šSQL / HQLå’Œæ¨¡æ¿å¼•æ“çš„ç»„åˆã€‚ æˆ‘çš„é¡¹ç›®ä¸­ä½¿ç”¨äº†â€œ Freemarkerâ€ï¼Œå°½ç®¡å¯ä»¥ä½¿ç”¨å…¶ä»–è§£å†³æ–¹æ¡ˆï¼ˆâ€œ Timlifâ€ï¼Œâ€œ Mustashâ€ç­‰ï¼‰ã€‚ </p><br><p> è®©æˆ‘ä»¬å¼€å§‹åˆ›å»ºã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¸€ä¸ªæ¥æ”¶æ‰©å±•å<code>*.hql.ftl</code>æˆ–<code>*.sql.ftl</code> ï¼ˆå¦‚æœä½¿ç”¨â€œçº¯â€ SQLï¼‰çš„æ–‡ä»¶ä¸­æè¿°æŸ¥è¯¢ï¼š </p><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">#* @vtlvariable name="fetchParent" type="java.lang.Boolean" *# #* @vtlvariable name="fetchToys" type="java.lang.Boolean" *# #* @vtlvariable name="orderByAge" type="java.lang.Boolean" *# select child from Child child #if($fetchParent) left join fetch child.parent #end #if($fetchToys) left join fetch child.toys #end #if($orderByAge) order by child.age #end</span></span></code> </pre> <br><p> ç°åœ¨æ‚¨éœ€è¦ä¸€ä¸ªå¤„ç†ç¨‹åºï¼š </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TemplateParser</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Configuration configuration; <span class="hljs-meta"><span class="hljs-meta">@SneakyThrows</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareQuery</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String templateName, Map&lt;String, Object&gt; params)</span></span></span></span>{ Template template = configuration.getTemplate(templateName); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FreeMarkerTemplateUtils.processTemplateIntoString(template, params); } }</code> </pre> <br><p> æ²¡ä»€ä¹ˆå¤æ‚çš„ã€‚ è¿›å…¥å­˜å‚¨åº“ã€‚ æ˜¾ç„¶ï¼Œç»§æ‰¿<code>JpaRepository</code>çš„æ¥å£ä¸é€‚åˆæˆ‘ä»¬ã€‚ è€Œæ˜¯åˆ©ç”¨è¿™ä¸ªæœºä¼šæ¥åˆ›å»ºè‡ªå·±çš„å­˜å‚¨åº“ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChildRepositoryCustom</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">List&lt;Child&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fetchParent, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fetchToys, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> order)</span></span></span></span>; } <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChildRepositoryImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseDao</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChildRepositoryCustom</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> TemplateParser templateParser; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Child&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fetchParent, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fetchToys, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> order)</span></span></span><span class="hljs-function"> </span></span>{ Map&lt;String, Object&gt; params = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); params.put(<span class="hljs-string"><span class="hljs-string">"fetchParent"</span></span>, fetchParent); params.put(<span class="hljs-string"><span class="hljs-string">"fetchToys"</span></span>, fetchToys); params.put(<span class="hljs-string"><span class="hljs-string">"orderByAge"</span></span>, orderByAge); String query = templateParser.prepareQuery(BASE_CHILD_TEMPLATE.name, params); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> em.createQuery(query, Child.class).getResultList(); } <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> RepositoryTemplates { BASE_CHILD_TEMPLATE(<span class="hljs-string"><span class="hljs-string">"BaseChildTemplate.hql.ftl"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String name; } }</code> </pre> <br><p> ä¸ºäº†ä½¿<code>findUsingTemplate</code>æ–¹æ³•å¯ä»<code>ChildRepository</code>è®¿é—®<code>ChildRepository</code>æ‚¨éœ€è¦æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChildRepository</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseJpaRepository</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Child</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Long</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChildRepositoryCustom</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... }</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">ä¸åç§°ç›¸å…³çš„é‡è¦åŠŸèƒ½</b> <div class="spoiler_text"><p>  Springå°†ä»…ä½¿ç”¨æ­£ç¡®çš„åç§°å°†æˆ‘ä»¬çš„ç±»å’Œæ¥å£ç»‘å®šåœ¨ä¸€èµ·ï¼š </p><br><ul><li> å­å­˜å‚¨åº“ </li><li>  ChildRepository <strong>è‡ªå®šä¹‰</strong> </li><li>  ChildRepository <strong>Impl</strong> </li></ul><br><p> è¯·è®°ä½è¿™ä¸€ç‚¹ï¼Œå› ä¸ºå¦‚æœåç§°ä¸­æœ‰é”™è¯¯ï¼Œå°†å¼•å‘éš¾ä»¥ç†è§£çš„å¼‚å¸¸ï¼Œæ— æ³•ä»ä¸­ç†è§£é”™è¯¯åŸå› ã€‚ </p></div></div><br><p> ç°åœ¨ï¼Œä½¿ç”¨è¿™ç§æ–¹æ³•å¯ä»¥è§£å†³æ›´å¤æ‚çš„é—®é¢˜ã€‚ å‡è®¾æˆ‘ä»¬éœ€è¦æ ¹æ®ç”¨æˆ·é€‰æ‹©çš„ç‰¹å¾è¿›è¡Œé€‰æ‹©ã€‚ æ¢å¥è¯è¯´ï¼Œå¦‚æœç”¨æˆ·æœªæŒ‡å®šæ—¥æœŸâ€œä»â€å’Œâ€œåˆ°â€ï¼Œé‚£ä¹ˆå°†æ²¡æœ‰æ—¶é—´è¿‡æ»¤ã€‚ å¦‚æœä»…æŒ‡å®šæ—¥æœŸâ€œ fromâ€æˆ–ä»…æ—¥æœŸâ€œ toâ€ï¼Œåˆ™è¿‡æ»¤å°†æ˜¯å•å‘çš„ã€‚ å¦‚æœåŒæ—¶æŒ‡å®šäº†ä¸¤ä¸ªæ—¥æœŸï¼Œåˆ™åªæœ‰æŒ‡å®šæ—¥æœŸä¹‹é—´çš„è®°å½•æ‰å±äºé€‰æ‹©èŒƒå›´ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Getter</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RequestDto</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> LocalDate from; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> LocalDate to; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hasDateFrom</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> from != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hasDateTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> to != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Child&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChildRequest request)</span></span></span><span class="hljs-function"> </span></span>{ Map&lt;String, Object&gt; params = singletonMap(<span class="hljs-string"><span class="hljs-string">"request"</span></span>, request); String query = templateParser.prepareQuery(TEMPLATE.name, params); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> em.createQuery(query, Child.class).getResultList(); }</code> </pre> <br><p> ç°åœ¨æ˜¯æ¨¡æ¿ï¼š </p><br><pre> <code class="sql hljs">&lt;<span class="hljs-comment"><span class="hljs-comment">#-- @ftlvariable name="request" type="...RequestDto" --&gt; select child from Child child &lt;#if request.hasDateFrom() &amp;&amp; request.hasDateTo()&gt; where child.birthDate &gt;= :dateFrom and child.birthDate &lt;= :dateTo &lt;#elseif request.hasDateFrom()&gt; where child.birthDate &gt;= :dateFrom &lt;#elseif request.hasDateTo()&gt; where child.birthDate &lt;= :dateTo &lt;/#if&gt;</span></span></code> </pre> <br><h4 id="orakl-i-nvl">  Oracleå’ŒNVL </h4><br><p> è€ƒè™‘æœ¬è´¨ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DailyRecord</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String currency; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"record_rate"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BigDecimal rate; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"fixed_rate"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BigDecimal fxRate; <span class="hljs-meta"><span class="hljs-meta">@Setter</span></span>(value = AccessLevel.PRIVATE) <span class="hljs-meta"><span class="hljs-meta">@Formula</span></span>(<span class="hljs-string"><span class="hljs-string">"select avg(r.record_rate) from daily_record r where r.currency = currency"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BigDecimal avgRate; }</code> </pre> <br><p> è¯¥å®ä½“ç”¨äºæŸ¥è¯¢ï¼ˆDBMSï¼Œæˆ‘ä»¬è®°å¾—æœ‰Oracleï¼‰ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Query</span></span>(<span class="hljs-string"><span class="hljs-string">"select nvl(record.fxRate, record.avgRate) "</span></span> + <span class="hljs-string"><span class="hljs-string">" from DailyRecord record "</span></span> + <span class="hljs-string"><span class="hljs-string">"where record.currency = :currency"</span></span>) <span class="hljs-function"><span class="hljs-function">BigDecimal </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findRateByCurrency</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Param(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"currency"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String currency)</span></span>;</code> </pre> <br><p> è¿™æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„è¯·æ±‚ã€‚ ä½†æ˜¯å®ƒæœ‰ä¸€ä¸ªå°é—®é¢˜ï¼ŒSQLä¸“å®¶å¯èƒ½ä¼šæŒ‡å‡ºã€‚ äº‹å®æ˜¯Oracleä¸­çš„<code>nvl</code>å¹¶ä¸æ‡’æƒ°ã€‚ æ¢å¥è¯è¯´ï¼Œå½“æˆ‘ä»¬è°ƒç”¨<code>findRateByCurrency</code>æ–¹æ³•æ—¶ï¼Œ <code>findRateByCurrency</code>æ—¥å¿—å°†<code>findRateByCurrency</code> </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> nvl( dr.fixed_rate, <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span>(r.record_rate) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> daily_record r <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> r.currency = dr.currency ) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> daily_record dr <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> dr.currency = ?</code> </pre> <br><p> å³ä½¿å­˜åœ¨<code>dr.fixed_rate</code>å€¼ï¼ŒDBMSä»ä¼šè®¡ç®—<code>nvl</code>ç¬¬äºŒä¸ªè¡¨è¾¾å¼è¿”å›çš„å€¼ã€‚ </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span>(r.record_rate) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> daily_record r <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> r.currency = dr.currency)</code> </pre> <br><p> è¯»è€…å¯èƒ½å·²ç»çŸ¥é“å¦‚ä½•é¿å…ä¸å¿…è¦çš„è¯·æ±‚æƒé‡ï¼šå½“ç„¶ï¼Œè¿™æ˜¯å…³é”®å­—<code>coalesce</code> ï¼Œå®ƒä¸<code>nvl</code>æ‡’æƒ°æ€§ï¼Œå¹¶ä¸”å¯ä»¥æ¥å—ä¸¤ä¸ªä»¥ä¸Šçš„è¡¨è¾¾å¼ï¼Œå› æ­¤å…·æœ‰ä¼˜åŠ¿ã€‚ è®©æˆ‘ä»¬æ›´æ­£æˆ‘ä»¬çš„è¯·æ±‚ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Query</span></span>(<span class="hljs-string"><span class="hljs-string">"select coalesce(record.fxRate, record.avgRate) "</span></span> + <span class="hljs-string"><span class="hljs-string">" from DailyRecord record "</span></span> + <span class="hljs-string"><span class="hljs-string">"where record.currency = :currency"</span></span>) <span class="hljs-function"><span class="hljs-function">BigDecimal </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findRateByCurrency</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Param(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"currency"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String currency)</span></span>;</code> </pre> <br><p> ç„¶åï¼Œæ­£å¦‚ä»–ä»¬æ‰€è¯´ï¼Œçªç„¶ä¹‹é—´ï¼š </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> nvl(dr.fixed_rate, <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span>(r.record_rate) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> daily_record r <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> r.currency = dr.currency) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> daily_record dr <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> dr.currency = ?</code> </pre> <br><p> è¦æ±‚ä¿æŒä¸å˜ã€‚ é‚£æ˜¯å› ä¸ºç›’å­é‡Œçš„ç”²éª¨æ–‡æ–¹è¨€å˜æˆäº†<code>nvl</code>é“¾ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">å¤‡æ³¨</b> <div class="spoiler_text"><p> å¦‚æœè¦é‡ç°æ­¤è¡Œä¸ºï¼Œè¯·åˆ é™¤<a href="">CustomOracleDialect</a>ç±»çš„æ„é€ å‡½æ•°ä¸­çš„ç¬¬äºŒè¡Œï¼Œç„¶åè¿è¡Œ<code>DailyRecordRepositoryTest::findRateByCurrency</code> </p></div></div><br><p> è¦é¿å…è¿™ç§æƒ…å†µï¼Œæ‚¨éœ€è¦åˆ›å»ºè‡ªå·±çš„æ–¹è¨€å¹¶åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨å®ƒï¼š </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomOracleDialect</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Oracle12cDialect</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomOracleDialect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); registerFunction(<span class="hljs-string"><span class="hljs-string">"coalesce"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StandardSQLFunction(<span class="hljs-string"><span class="hljs-string">"coalesce"</span></span>)); } }</code> </pre> <br><p> æ˜¯çš„ï¼Œå°±æ˜¯è¿™ä¹ˆç®€å•ã€‚ ç°åœ¨ï¼Œå°†åˆ›å»ºçš„æ–¹è¨€ç»‘å®šåˆ°åº”ç”¨ç¨‹åºï¼š </p><br><pre> <code class="plaintext hljs">spring: jpa: database-platform: com.luxoft.logeek.config.CustomOracleDialect</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">å¦ä¸€ç§ï¼ˆä¸å»ºè®®ä½¿ç”¨çš„ï¼‰æ–¹å¼ï¼š</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">spring: jpa: properties: hibernate.dialect: com.luxoft.logeek.config.CustomOracleDialect</code> </pre> </div></div><br><p> é‡å¤æ‰§è¡Œè¯¥è¯·æ±‚å°†ä½¿æ¢¦koä»¥æ±‚çš„koaleskï¼š </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(dr.fixed_rate, <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span>(r.record_rate) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> daily_record r <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> r.currency = dr.currency) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> daily_record dr <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> dr.currency = ?</code> </pre> <br><h4 id="orakl-i-postranichnye-zaprosy">  Oracleå’Œé¡µé¢è¯·æ±‚ </h4><br><p> é€šå¸¸ï¼Œæ–¹è¨€çš„å®Œæˆä¸ºæŸ¥è¯¢æ“ä½œæä¾›äº†ä¸°å¯Œçš„æœºä¼šã€‚ é€šå¸¸ï¼Œåœ¨å¼€å‘åº”ç”¨ç¨‹åºå’Œç½‘ç»œç•Œé¢æ—¶ï¼Œä¼šé‡åˆ°åˆ†é¡µä¸Šä¼ æ•°æ®çš„ä»»åŠ¡ã€‚ æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬åœ¨æ•°æ®åº“ä¸­æœ‰æ•°åä¸‡æ¡è®°å½•ï¼Œä½†æ˜¯å®ƒä»¬ä»¥æ¯é¡µ10/50/100æ¡è®°å½•çš„åŒ…çš„å½¢å¼æ˜¾ç¤ºã€‚ å¼€ç®±å³ç”¨çš„Spring Dateä¸ºå¼€å‘äººå‘˜æä¾›äº†ç±»ä¼¼çš„åŠŸèƒ½ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Query</span></span>(<span class="hljs-string"><span class="hljs-string">"select new com.luxoft.logeek.data.BriefChildData("</span></span> + <span class="hljs-string"><span class="hljs-string">"c.id, "</span></span> + <span class="hljs-string"><span class="hljs-string">"c.age "</span></span> + <span class="hljs-string"><span class="hljs-string">") from Child c "</span></span> + <span class="hljs-string"><span class="hljs-string">" join c.parent p "</span></span> + <span class="hljs-string"><span class="hljs-string">"where p.name = ''"</span></span>) <span class="hljs-function"><span class="hljs-function">Page&lt;BriefChildData&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">browse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Pageable pageable)</span></span></span></span>;</code> </pre> <br><p> è¿™ç§æ–¹æ³•æœ‰ä¸€ä¸ªå¾ˆå¤§çš„ç¼ºç‚¹ï¼Œå³æ‰§è¡Œä¸¤ä¸ªæŸ¥è¯¢ï¼Œç¬¬ä¸€ä¸ªæŸ¥è¯¢è·å–æ•°æ®ï¼Œç¬¬äºŒä¸ªæŸ¥è¯¢ç¡®å®šæ•°æ®åº“ä¸­å®ƒä»¬çš„æ€»æ•°ï¼ˆè¿™å¯¹äºæ˜¾ç¤º<code>Page</code>å¯¹è±¡ä¸­çš„æ•°æ®æ€»é‡æ˜¯å¿…éœ€çš„ï¼‰ã€‚ åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå¯¹æ­¤æ–¹æ³•çš„è°ƒç”¨ç»™å‡ºäº†ä»¥ä¸‹è¯·æ±‚ï¼ˆä½¿ç”¨p6spyè¿›è¡Œè®°å½•ï¼‰ï¼š </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c.id, c.age <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> c.parent_id = p.id <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> p.name = <span class="hljs-string"><span class="hljs-string">''</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rownum</span></span> &lt;= <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(c.id) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> c.parent_id = p.id <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> p.name = <span class="hljs-string"><span class="hljs-string">''</span></span></code> </pre> <br><p> å¦‚æœæŸ¥è¯¢å¾ˆç¹çï¼ˆè®¸å¤šè¡¨ç”±ä¸å¯ç´¢å¼•çš„åˆ—è¿æ¥ï¼Œåªæœ‰å¾ˆå¤šè¿æ¥ï¼Œå›°éš¾çš„é€‰æ‹©æ¡ä»¶ç­‰ï¼‰ï¼Œé‚£ä¹ˆè¿™å¯èƒ½ä¼šæˆä¸ºé—®é¢˜ã€‚ ä½†æ˜¯ç”±äºæˆ‘ä»¬æ‹¥æœ‰Oracleï¼Œå› æ­¤ä½¿ç”¨rownumä¼ªåˆ—å¯ä»¥é€šè¿‡ä¸€ä¸ªè¯·æ±‚è·å¾—è¯·æ±‚ã€‚ </p><br><p> ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦å®Œæˆæ–¹è¨€ï¼Œå¹¶æè¿°ç”¨äºè®¡æ•°æ‰€æœ‰è®°å½•çš„å‡½æ•°ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomOracleDialect</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Oracle12cDialect</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomOracleDialect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); registerFunction(<span class="hljs-string"><span class="hljs-string">"coalesce"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StandardSQLFunction(<span class="hljs-string"><span class="hljs-string">"coalesce"</span></span>)); registerFunction(<span class="hljs-string"><span class="hljs-string">"total_count"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TotalCountFunc()); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TotalCountFunc</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQLFunction</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hasArguments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hasParenthesesIfNoArguments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Type </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getReturnType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type, Mapping mapping)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> StandardBasicTypes.LONG; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type, List arguments, SessionFactoryImplementor factory)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (arguments.size() != <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgumentException(<span class="hljs-string"><span class="hljs-string">"Only 1 argument acceptable"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">" count("</span></span> + arguments.get(<span class="hljs-number"><span class="hljs-number">0</span></span>) + <span class="hljs-string"><span class="hljs-string">") over () "</span></span>; } }</code> </pre> <br><p> ç°åœ¨ç¼–å†™ä¸€ä¸ªæ–°æŸ¥è¯¢ï¼ˆåœ¨<code>ChildRepositoryImpl</code>ç±»ä¸­ï¼‰ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Page&lt;BriefChildData&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">browseWithTotalCount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Pageable pageable)</span></span></span><span class="hljs-function"> </span></span>{ String query = <span class="hljs-string"><span class="hljs-string">"select "</span></span> + <span class="hljs-string"><span class="hljs-string">" c.id as id,"</span></span> + <span class="hljs-string"><span class="hljs-string">" c.age as age, "</span></span> + <span class="hljs-string"><span class="hljs-string">" total_count(c.id) as totalCount"</span></span> + <span class="hljs-string"><span class="hljs-string">" from Child c "</span></span> + <span class="hljs-string"><span class="hljs-string">"join c.parent p "</span></span> + <span class="hljs-string"><span class="hljs-string">"where p.name = ''"</span></span>; List&lt;BriefChildData&gt; list = em.unwrap(Session.class) .createQuery(query) .setFirstResult((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) pageable.getOffset()) .setMaxResults(pageable.getPageSize()) .setResultTransformer(Transformers.aliasToBean(BriefChildData.class)) .getResultList(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (list.isEmpty()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PageImpl(Collections.emptyList()); } <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> totalCount = list.get(<span class="hljs-number"><span class="hljs-number">0</span></span>).getTotalCount(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PageImpl&lt;&gt;(list, pageable, totalCount); }</code> </pre> <br><p> è°ƒç”¨æ­¤ä»£ç æ—¶ï¼Œå°†æ‰§è¡Œä¸€ä¸ªè¯·æ±‚ </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c.id, c.age, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(c.id) <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> () <span class="hljs-comment"><span class="hljs-comment">-- &lt;----- from child c inner join parent p on c.parent_id = p.id where p.name = '') where rownum &lt;= 3</span></span></code> </pre> <br><p> åœ¨<code>count(c.id) over ()</code>ä½¿ç”¨è¡¨è¾¾å¼<code>count(c.id) over ()</code>æ‚¨å¯ä»¥è·å–æ•°æ®æ€»é‡ï¼Œå¹¶ä»æ•°æ®ç±»ä¸­è·å–æ•°æ®ï¼Œä»¥ä¼ é€’ç»™<code>PageImpl</code>æ„é€ å‡½æ•°ã€‚ æœ‰ä¸€ç§æ–¹æ³•å¯ä»¥æ›´ä¼˜é›…åœ°å®Œæˆå®ƒï¼Œè€Œæ— éœ€åœ¨æ•°æ®ç±»ä¸­æ·»åŠ å¦ä¸€ä¸ªå­—æ®µï¼Œè€Œè¦è€ƒè™‘å®ƒæ˜¯ä¸€é¡¹åŠŸè¯¾ï¼š)æ‚¨å¯ä»¥ä½¿ç”¨<a href="">ProjectionVsDataTest</a>æµ‹è¯•æ¥æµ‹è¯•è§£å†³æ–¹æ¡ˆã€‚ </p><br><h4 id="podvodnye-kamni-kastomizacii"> å®šåˆ¶çš„é™·é˜± </h4><br><p> æˆ‘ä»¬åœ¨Oracleå’ŒSpring Dateä¸Šæœ‰ä¸€ä¸ªå¾ˆæ£’çš„é¡¹ç›®ã€‚ æˆ‘ä»¬çš„ä»»åŠ¡æ˜¯æé«˜æ­¤ç±»ä»£ç çš„æ€§èƒ½ï¼š </p><br><pre> <code class="java hljs">List&lt;Long&gt; ids = getIds(); ids.stream() .map(repository::findById) .filter(Optional::isPresent) .map(Optional::get) .forEach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::sendToSchool);</code> </pre> <br><p> ç¼ºç‚¹åœ¨äºè¡¨é¢ä¸Šï¼šæ•°æ®åº“æŸ¥è¯¢çš„æ•°é‡ç­‰äºå”¯ä¸€é”®çš„æ•°é‡ã€‚ æœ‰ä¸€ç§å…‹æœæ­¤å›°éš¾çš„å·²çŸ¥æ–¹æ³•ï¼š </p><br><pre> <code class="java hljs">List&lt;Long&gt; ids = getIds(); repository .findAllById(ids) .forEach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::sendToSchool);</code> </pre> <br><p> å¤šæ¬¡é‡‡æ ·çš„ä¼˜åŠ¿æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼šå¦‚æœæ—©äº›æ—¶å€™ï¼Œæˆ‘ä»¬æœ‰è®¸å¤šç±»ä¼¼å½¢å¼çš„æŸ¥è¯¢ </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> p.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Pupil p <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> p.id = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> p.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Pupil p <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> p.id = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> p.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Pupil p <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> p.id = <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre> <br><p> é‚£ä¹ˆç°åœ¨ä»–ä»¬å·²ç»å´©æºƒäº† </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> p.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Pupil p <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> p.id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, ... )</code> </pre> <br><p> å®ƒä¼¼ä¹æ›´å®¹æ˜“å˜å¾—æ›´å¥½ã€‚ è¯¥é¡¹ç›®ä¸æ–­å‘å±•ï¼Œå‘å±•ï¼Œæ•°æ®æˆå€å¢é•¿ï¼Œä¸€æ—¦ä¸å¯é¿å…ï¼Œè¯¥é¡¹ç›®å°±å°†å‡ºç°ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">æ™´é—´çš„Akié›·å£°</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">ERROR - ORA-01795: maximum number of expressions in a list is 1000</code> </pre> </div></div><br><p> æˆ‘ä»¬éœ€è¦å†æ¬¡å¯»æ‰¾å‡ºè·¯ï¼ˆä¸è¦è¿”å›åˆ°æ—§ç‰ˆæœ¬ï¼‰ã€‚ ç”±äºOracleä¸å…è®¸ä»–æä¾›è¶…è¿‡1000ä¸ªé”®ï¼Œå› æ­¤æ‚¨å¯ä»¥å°†æ•´ä¸ªæ•°æ®é›†åˆ’åˆ†ä¸ºä¸è¶…è¿‡1000ä¸ªç›¸ç­‰çš„ä»½é¢ï¼Œå¹¶æ‰§è¡Œå¤šä¸ªæŸ¥è¯¢ï¼š </p><br><pre> <code class="java hljs">List&lt;List&lt;Long&gt;&gt; idChunks = cgccLists.partition(ids, <span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-comment"><span class="hljs-comment">//* idChunks.forEach(idChunk -&gt; repository.findAllById(idChunk).forEach(this::sendToSchool) ); //* cgccLists = com.google.common.collect.Lists</span></span></code> </pre> <br><p> æ­¤æ–¹æ³•æœ‰æ•ˆï¼Œä½†é—»èµ·æ¥æœ‰ç‚¹ï¼ˆæ˜¯å—ï¼Ÿï¼‰ï¼šå¦‚æœæ‚¨åœ¨å…¶ä»–åœ°æ–¹é‡åˆ°æ­¤ç±»å›°éš¾ï¼Œåˆ™å¿…é¡»å›´æŠ¤åŒä¸€èŠ±å›­ã€‚ è®©æˆ‘ä»¬å°è¯•æ›´ä¼˜é›…åœ°è§£å†³é—®é¢˜ï¼Œå³<code>BaseJpaRepositoryImpl</code> ã€‚ æœ€ç®€å•çš„æ–¹æ³•æ˜¯å°†ä¸Šè¿°é€»è¾‘å‘å†…ä¼ é€’ï¼Œå¯¹ç”¨æˆ·éšè—ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findAllById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Iterable&lt;ID&gt; ids)</span></span></span><span class="hljs-function"> </span></span>{ Assert.notNull(ids, <span class="hljs-string"><span class="hljs-string">"The given Iterable of Id's must not be null!"</span></span>); Set&lt;ID&gt; idsCopy = Sets.newHashSet(ids); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (idsCopy.size() &lt;= OracleConstants.MAX_IN_COUNT) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.findAllById(ids); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> findAll(idsCopy); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> List&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Collection&lt;ID&gt; ids)</span></span></span><span class="hljs-function"> </span></span>{ List&lt;List&lt;ID&gt;&gt; idChunks = Lists.partition(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(ids), <span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> idChunks .stream() .map(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::findAllById) .flatMap(List::stream) .collect(Collectors.toList()); }</code> </pre> <br><p> æƒ…å†µå˜å¾—è¶Šæ¥è¶Šå¥½ï¼šé¦–å…ˆï¼Œæˆ‘ä»¬ä»åŸºç¡€ç»“æ„å±‚æ¸…é™¤äº†å·¥ä½œä»£ç ï¼Œå…¶æ¬¡ï¼Œæˆ‘ä»¬å°†è§£å†³æ–¹æ¡ˆçš„èŒƒå›´æ‰©å±•åˆ°äº†æ‰€æœ‰æ‰©å±•<code>BaseJpaRepository</code>é¡¹ç›®å­˜å‚¨åº“ã€‚ ä¹Ÿæœ‰ç¼ºç‚¹ã€‚ ä¸»è¦çš„æ˜¯å‡ ä¸ªè¯·æ±‚è€Œä¸æ˜¯ä¸€ä¸ªè¯·æ±‚ï¼Œè¿˜æœ‰ï¼ˆæ¥è‡ªä¸»è¦è¯·æ±‚çš„è¯å¹²ï¼‰-éœ€è¦è¿‡æ»¤é”®ï¼Œå› ä¸ºå¦‚æœä¸è¿™æ ·åšï¼Œé‚£ä¹ˆç›¸åŒçš„é”®å¯èƒ½ä¼šå‡ºç°åœ¨ä¸åŒçš„<code>idChunks</code> ã€‚ åè¿‡æ¥ï¼Œè¿™æ„å‘³ç€åŒä¸€å®ä½“å°†è¢«ä¸¤æ¬¡åŒ…å«åœ¨åˆ—è¡¨ä¸­ï¼Œå› æ­¤å°†è¢«å¤„ç†ä¸¤æ¬¡ã€‚ æˆ‘ä»¬ä¸éœ€è¦è¿™ä¸ªï¼Œå› æ­¤è¿™æ˜¯å¦ä¸€ä¸ªæ›´å¤æ‚çš„è§£å†³æ–¹æ¡ˆï¼š </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findAllById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Iterable&lt;ID&gt; ids)</span></span></span><span class="hljs-function"> </span></span>{ Assert.notNull(ids, <span class="hljs-string"><span class="hljs-string">"The given Iterable of Id's must not be null!"</span></span>); ArrayList&lt;ID&gt; idsCopy = Lists.newArrayList(ids); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (idsCopy.size() &lt;= OracleConstants.MAX_IN_COUNT) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.findAllById(ids); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> findAll(idsCopy); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> List&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ArrayList&lt;ID&gt; ids)</span></span></span><span class="hljs-function"> </span></span>{ CriteriaBuilder cb = entityManager.getCriteriaBuilder(); CriteriaQuery&lt;T&gt; query = cb.createQuery(getDomainClass()); Root&lt;T&gt; from = query.from(getDomainClass()); Predicate predicate = toPredicate(cb, ids, from); query = query.select(from).where(predicate); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> entityManager.createQuery(query).getResultList(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Predicate </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toPredicate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CriteriaBuilder cb, ArrayList&lt;ID&gt; ids, Root&lt;T&gt; root)</span></span></span><span class="hljs-function"> </span></span>{ List&lt;List&lt;ID&gt;&gt; chunks = Lists.partition(ids, OracleConstants.MAX_IN_COUNT); SingularAttribute&lt;? <span class="hljs-keyword"><span class="hljs-keyword">super</span></span> T, ?&gt; id = entityInfo.getIdAttribute(); Predicate[] predicates = chunks.stream() .map(chunk -&gt; root.get(id).in(chunk)) .toArray(Predicate[]::<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cb.or(predicates); }</code> </pre> <br><p> å®ƒä½¿ç”¨Criteria APIï¼Œè¿™ä½¿å¾—æ„å»ºä¸€ä¸ªæœ€ç»ˆæŸ¥è¯¢å½¢å¼æˆä¸ºå¯èƒ½ã€‚ </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> p.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Pupil p <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> p.id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, ... , <span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> p.id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-number"><span class="hljs-number">1001</span></span>, ... , <span class="hljs-number"><span class="hljs-number">2000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> p.id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-number"><span class="hljs-number">2001</span></span>, ... , <span class="hljs-number"><span class="hljs-number">3000</span></span>)</code> </pre> <br><p> æœ‰ä¸€ä¸ªå¾®å¦™ä¹‹å¤„ï¼šç”±äºæ¡ä»¶ç¹çï¼Œç±»ä¼¼çš„è¯·æ±‚å¯ä»¥æ¯”å¹³å¸¸æ‰§è¡Œæ›´é•¿çš„æ—¶é—´ï¼Œå› æ­¤ç¬¬ä¸€ç§æ–¹æ³•å¯èƒ½ï¼ˆæœ‰æ—¶ï¼‰æ˜¯æ›´å¯å–çš„ã€‚ </p><br><p> å°±è¿™æ ·ï¼Œæˆ‘å¸Œæœ›è¿™äº›ç¤ºä¾‹å¯¹æ‚¨æœ‰ç”¨ï¼Œå¹¶ä¸”å¯¹æ—¥å¸¸å¼€å‘æœ‰ç”¨ã€‚ æ¬¢è¿è¯„è®ºå’Œæ·»åŠ ã€‚ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN444240/">https://habr.com/ru/post/zh-CN444240/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN444226/index.html">@Pythonetcç¼–è¯‘2019å¹´2æœˆ</a></li>
<li><a href="../zh-CN444228/index.html">æˆ‘çš„ç”µæŠ¥é¢‘é“@pythonetcçš„æç¤ºå’ŒæŠ€å·§ï¼Œ2019å¹´2æœˆ</a></li>
<li><a href="../zh-CN444230/index.html">å›½å®¶äº’è”ç½‘ï¼šä¸­å›½è¿œç¨‹VPNçš„æ•…äº‹</a></li>
<li><a href="../zh-CN444234/index.html">DeepMindå’ŒGoogleï¼šæ§åˆ¶å¼ºå¤§AIçš„æˆ˜æ–—</a></li>
<li><a href="../zh-CN444238/index.html">ä¸€é”®æ‹’ç»ï¼Œæˆ–è€…è®¾è®¡å¸ˆå¦‚ä½•è·å¾—ç†æƒ³çš„å·¥ä½œ</a></li>
<li><a href="../zh-CN444242/index.html">ä½¿ç”¨PVS-Studioåˆ†æä»ªæ£€æŸ¥FreeRDP</a></li>
<li><a href="../zh-CN444244/index.html">ç©¿è¶Šæ—¶ç©º</a></li>
<li><a href="../zh-CN444246/index.html">ä½¿ç”¨PVS-Studioæ£€æŸ¥FreeRDP</a></li>
<li><a href="../zh-CN444248/index.html">æµè§ˆå™¨ä¸­çš„æ— å¤´æµ‹è¯•ã€‚ åˆ©å¼Š</a></li>
<li><a href="../zh-CN444250/index.html">äººä»¬æ˜¯å¦ä¸å‡†å¤‡æ¥å—æ¯”ç‰¹å¸æˆ–å¤§è§„æ¨¡é‡‡ç”¨æ¯”ç‰¹å¸ï¼Ÿ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>