<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩‍❤️‍💋‍👩 👌🏼 🛌🏼 Yandex: une maison intelligente pour adultes ⏮️ 👇🏽 🚶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Récemment, Yandex a lancé son système de maison intelligente. On nous propose d'acheter des appareils Wi-Fi bon marché: un adaptateur dans une prise d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Yandex: une maison intelligente pour adultes</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/465537/"><img src="https://habrastorage.org/webt/rs/l_/lm/rsl_lmpzna0pj3o9ahxzsawpsn0.png"><br><br>  Récemment, Yandex a lancé son système de maison intelligente.  On nous propose d'acheter des appareils Wi-Fi bon marché: un adaptateur dans une prise de courant, une ampoule et une télécommande IR.  Il est intéressant que les développeurs d'appareils «intelligents» aient la possibilité de créer leurs compétences «maison intelligente», cela vous permettra de connecter des appareils au système Yandex et de gérer leur voix via Alice.  De plus en plus de nouvelles marques apparaissent sur les listes de compétences.  Alice comprend parfaitement le discours russe, ce qui fait d'elle la leader incontestée des assistants vocaux sur le marché russe. <br>  Cependant, tout n'est pas si fluide ... <br><a name="habracut"></a><br>  Premier inconvénient: fondamentalement, tous les systèmes proposés sont «nuageux».  Leur fiabilité est parfois mise en doute, car leurs performances dépendent directement de la qualité de la connexion avec les serveurs du constructeur.  Et lorsque vous désactivez Internet, les appareils se transforment complètement en «citrouille». <br><br>  Deuxième inconvénient: système de script.  Les scripts sont une partie importante d'une maison intelligente.  Et ici, ils sont très primitifs: si «la phrase est telle ou telle», alors activez «l'appareil est tel ou tel».  Pour ma maison intelligente, c'était trop peu. <br><br>  Les inconvénients ne s'arrêtent pas là, mais le reste est plus probablement lié à l'immaturité du système.  L'équipe de développement Yandex continue d'ajouter activement diverses fonctionnalités et bogues à modifier, dont beaucoup grâce à eux! <br><br>  Après avoir étudié la documentation, j'ai décidé de créer la compétence Yandex UD et d'y connecter le contrôleur de maison intelligente.  Cela vous permettra de ne pas dépendre des serveurs cloud, de mettre en œuvre des scripts localement sur le contrôleur et en même temps de contrôler le système par la voix via Alice.  Pour cela, j'ai écrit le plugin "yandex2mqtt" sur Node.js. <br><br><h4>  Un peu de théorie </h4><br>  - Alice, allume la lumière. <br>  Après cette phrase, la magie opère et la lumière s'allume.  Mais qu'est-ce qui se cache dans les coulisses?  Voyons comment tout cela fonctionne. <br><br>  La station Yandex, après avoir entendu une commande familière, envoie des données au serveur Yandex, auquel nous avons spécifié à l'avance l'adresse de notre contrôleur.  Le serveur traite les informations et les redirige vers le contrôleur sous la forme d'une post-demande.  Sur le contrôleur, l'API intermédiaire (dans notre cas, c'est le plugin yandex2mqtt) traite la demande et la redirige vers la rubrique MQTT.  Ensuite, le script est traité dans le programme Node-Red. <br><br>  Node-Red décide quoi faire ensuite.  S'il est prévu par le script, il envoie une commande pour allumer la lumière dans le sujet MQTT correspondant.  Le pilote wb-mqtt-serial répond en envoyant une commande Modbus au module relais, qui commute le relais.  Et enfin, la lumière s'allume!  Oui, le chemin n'est pas proche, mais quelques fractions de seconde pour l'utilisateur. <br><br>  Examinons de plus près le plugin yandex2mqtt.  La première chose dont Yandex a besoin pour que la compétence fonctionne est le service oAuth pour regrouper les comptes dans l'application Yandex.  Une fois que Yandex a reçu le jeton d'autorisation du service oAuth, il demande une liste de périphériques.  Le plugin yandex2mqtt répond avec une liste de périphériques avec toutes les propriétés au format json.  Ils apparaissent ensuite dans la liste des appareils disponibles pour le contrôle (dans le soi-disant quasar).  Maintenant, si vous dites à Alice d'allumer un appareil de la liste, Yandex enverra une demande de publication avec les données de l'appareil qu'il veut allumer au contrôleur.  En réponse, le plugin confirme l'inclusion et écrit le nouvel état dans la rubrique mqtt spécifiée dans les paramètres du même plugin.  Si le périphérique a changé son statut sans la participation de Yandex, le plug-in, en voyant les nouvelles données dans la rubrique mqtt, les enverra à Yandex lors de la demande du statut, ce qui ne se produit désormais que si vous accédez au périphérique lui-même dans quasar.  Dans d'autres cas, Yandex n'interroge pas les statuts. <br>  Je vais maintenant parler de certaines des propriétés des appareils Yandex UD. <br><br><h4>  Type d'appareil </h4><br>  Pour un affichage correct dans le «quasar» et une définition plus précise des commandes par Alice, Yandex suggère d'affecter différents types d'appareils aux appareils.  Total types 10: <br><br><ul><li>  <b>devices.types.light</b> - Toute lampe, lustre, ampoule, etc. </li><li>  <b>devices.types.socket</b> - Prise </li><li>  <b>devices.types.switch</b> - Commutateur </li><li>  <b>devices.types.thermostat</b> - Thermostat </li><li>  <b>devices.types.thermostat.ac</b> - Climatisation </li><li>  <b>devices.types.media_device</b> - Périphérique multimédia </li><li>  <b>devices.types.media_device.tv</b> - TV </li><li>  <b>devices.types.cooking</b> - Appareils de cuisine </li><li>  <b>devices.types.cooking.kettle</b> - Créateur </li><li>  <b>devices.types.other</b> - Tout ce qui ne correspondait pas aux paragraphes précédents. </li></ul><br><h5>  Capacité </h5><br>  De plus, chaque appareil doit avoir au moins une <b>capacité</b> . <br><br>  Au total, Yandex UD dispose de 5 types de compétences.  Chaque compétence a une fonction <b>(instance) différente</b> , et certaines compétences ont plusieurs de ces fonctions, ce qui ajoute de la flexibilité lors de la configuration des appareils. <br><br>  <b>Capacités:</b> <br><br>  1. <b>devices.capabilities.on_off</b> - Activez et désactivez. <br><br>  exemple: <br><br><ul><li>  sur </li></ul><br>  2. <b>devices.capabilities.color_setting</b> - Gestion des couleurs. <br><br>  exemple: <br><br><ul><li>  rgb </li><li>  hsv </li><li>  temperature_k </li></ul><br>  3. <b>devices.capabilities.mode - Changer de mode.</b> <br><br>  exemple: <br><br><ul><li>  thermostat </li><li>  fan_speed </li></ul><br>  4. <b>devices.capabilities.range - Contrôle de plage.</b> <br><br>  exemple: <br><br><ul><li>  luminosité </li><li>  température </li><li>  volume </li><li>  canal </li></ul><br>  5. <b>devices.capabilities.toggle - Muet.</b> <br><br>  exemple: <br><br><ul><li>  muet </li></ul><br><br>  Avec la bonne combinaison de toutes les propriétés de l'appareil, Alice comprend sans aucun problème toutes les commandes de gestion du Smart Home qui lui sont données.  Ici, bien sûr, il y a quelques difficultés à combiner les compétences.  La documentation n'indique clairement pas quelles compétences peuvent être combinées et lesquelles ne le peuvent pas.  Mais la «méthode scientifique du poke» nous y aidera. <br><br>  Ainsi, par exemple, j'ai découvert que la climatisation contient quatre compétences: <br><br>  Type d'appareil: <br><br>  <b>devices.types.thermostat.ac</b> <br><br>  Type de compétence: <br><br>  <b>devices.capabilities.on_off</b> <br><br>  exemple: <br><br><ul><li>  sur </li></ul><br>  <b>devices.capabilities.range</b> <br>  exemple: <br><br><ul><li>  température </li></ul><br>  <b>devices.capabilities.mode</b> <br>  exemple: <br><br><ul><li>  thermostat </li></ul><br>  <b>devices.capabilities.mode</b> <br>  exemple: <br><br><ul><li>  fan_speed </li></ul><br>  Je ne décrirai pas les propriétés restantes, tout y est assez simple. <br><br>  Pour le faire fonctionner, vous avez besoin de: <br><br><ul><li>  <b>Contrôleur</b> </li><li>  <b>Tout domaine</b> </li><li>  <b>Certificat SSL</b> </li><li>  <b>Node.js</b> </li><li>  <b>Plugin Yandex2mqtt</b> </li><li>  <b>Courtier MQTT</b> </li><li>  <b>Rouge-noeud</b> </li></ul><br><h3>  Contrôleur </h3><br>  Mon appartement «intelligent» est contrôlé par le Wiren Board 6. Mais vous pouvez utiliser n'importe quel autre contrôleur Linux qui tirera Node.js et Node-Red.  Par exemple, Raspberry pi ou PC. <br><br><h4>  Domaine </h4><br>  Bien sûr, il est souhaitable d'avoir une adresse IP blanche et d'acheter un domaine, mais ce n'est pas nécessaire.  Vous pouvez utiliser DDNS - par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">www.noip.com</a> . <br><br>  Ici, tout est simple: inscrivez-vous, créez un nom d'hôte gratuit, entrez votre adresse IP.  Certains routeurs ont un paramètre DDNS spécial où vous pouvez entrer des données noip.com.  Le routeur enverra automatiquement une adresse IP lorsqu'elle sera modifiée.  S'il n'y a pas un tel paramètre dans le routeur, vous pouvez installer le programme noip sur le contrôleur et l'ajouter à l'exécution automatique.  Le programme fera exactement la même chose qu'un routeur avec des paramètres DDNS spéciaux - mettez à jour votre adresse IP dans la base de données noip.com <br><br>  Ainsi, nous avons une adresse statique qui redirige toutes les demandes vers notre contrôleur. <br><br><h4>  Ports 443 et 80 </h4><br>  Maintenant, presque tout le monde à la maison a un routeur.  En plus de ses fonctions évidentes, il constitue également une barrière au réseau local pour les invités indésirables de l'extérieur.  Mais dans certains cas, nous avons besoin d'accéder au réseau interne de l'extérieur.  Les fabricants de routeurs l'ont envisagé et ont ajouté la fonction NAT (traduction d'adresse réseau). <br><br>  Je ne décrirai pas le moment de la configuration du routeur, car il est différent pour chaque fabricant.  Pour ce faire, lisez les instructions de votre routeur.  Mots-clés Google: Port Forwarding, Port Mapping, NAT. <br><br>  Il est nécessaire de rediriger le port pour accéder à yandex2mqtt (il peut être n'importe lequel, j'ai choisi 443) et au port 80 (il est seulement nécessaire de recevoir un certificat SSL. Après avoir reçu le certificat, le port 80 peut être fermé). <br><br><h4>  Certificat SSL </h4><br>  Mettez immédiatement tous les points sur le «et»: les certificats auto-signés ne fonctionneront pas. <br>  La plupart des bureaux d'enregistrement de domaine (par exemple, reg.ru) offrent à leurs clients des certificats SSL gratuits pour le domaine principal (www.votredomaine.ru).  Si vous avez acheté un domaine spécifiquement pour Alice, vous pouvez utiliser le certificat SSL fourni. <br><br>  Si vous n'avez pas votre propre domaine, ou si vous avez un autre sous-domaine alloué pour Alice (par exemple, alice.votredomaine.ru), vous devez obtenir un certificat pour ce sous-domaine ou pour l'adresse fournie par le service DDNS. <br><br>  Pour ce faire, je propose d'utiliser le service gratuit pour obtenir un certificat SSL auprès de letsencrypt.org. <br><br>  Pour obtenir un certificat, vous devez installer le programme certbot, exécuter et spécifier toutes les données qu'il demande.  Dans le même temps, le port 80 doit être libre et accessible de l'extérieur, je vous conseille d'étudier attentivement les instructions de letsencrypt. <br><br><div class="spoiler">  <b class="spoiler_title">Installer et configurer certbot</b> <div class="spoiler_text"><pre><code class="bash hljs">apt-get update apt-get install certbot</code> </pre> <br><br>  Arrêtez les services de surveillance et nginx. <br><br><pre> <code class="bash hljs">service watchdog stop service nginx stop</code> </pre> <br>  Nous transmettons le 80e port du routeur. <br><br>  Exécutez le programme certbot: <br><br><pre> <code class="bash hljs">certbot certonly --standalone</code> </pre> <br>  Après le démarrage, le programme posera quelques questions simples. <br><br>  1. Votre e-mail.  Entrez simplement l'adresse et appuyez sur Entrée <br><br><img src="https://habrastorage.org/webt/mn/gf/si/mngfsiaatuo6txsrtc6wyyz4v_o.png"><br><br>  2. Vous êtes invité à lire les accords d'utilisation.  Si vous êtes d'accord avec tout, entrez simplement «A», ce qui signifie Accepter, c'est-à-dire que je suis d'accord. <br><br><img src="https://habrastorage.org/webt/y8/zz/to/y8zztosybjouwmncxuawmbq-55c.png"><br><br>  3. Le programme demande la permission d'envoyer votre adresse e-mail aux développeurs.  Entrez N. <br><br><img src="https://habrastorage.org/webt/pn/y_/yw/pny_ywp5pjfj7gupd09m3hnbmg4.png"><br><br>  4. Entrez votre domaine pour lequel vous souhaitez recevoir un certificat (vous pouvez entrer celui que nous avons reçu dans noip plus tôt).  Ici, je donne un exemple de saisie erronée.  Le préfixe http: // n'est pas requis. <br><br><img src="https://habrastorage.org/webt/mt/bj/py/mtbjpyenb63jqv3gvtd_oyh9qze.png"><br><br>  Si vous avez tout fait correctement, vous verrez ce qui suit: <br><br><img src="https://habrastorage.org/webt/ug/7c/kf/ug7ckfuvos8bkgfgzvaepqvu48s.png"><br><br>  Cela signifie que le certificat a été reçu avec succès.  N'oubliez pas le chemin d'accès au certificat et à la clé, il sera requis lors de la configuration du plugin yandex2mqtt.  Pour des raisons de sécurité, fermez le port 80 dans les paramètres du routeur, il ne sera plus utile. <br><br>  Nous activons les services de surveillance et nginx. <br><br><pre> <code class="bash hljs">service nginx start service watchdog start</code> </pre> <br>  Le certificat de letsencrypt est délivré pour <b>3</b> mois.  <b>N'oubliez pas de mettre à jour.</b> <br><br></div></div><br><h4>  Node.js et le plugin yandex2mqtt </h4><br><div class="spoiler">  <b class="spoiler_title">L'installation</b> <div class="spoiler_text">  Configuration du référentiel node.js <br><br><pre> <code class="bash hljs">curl -sL https://deb.nodesource.com/setup_10.x | bash -</code> </pre> <br>  Ensuite, installez ou mettez à jour tous les composants nécessaires <br><br><pre> <code class="bash hljs">apt-get install -y nodejs git make g++ gcc build-essential</code> </pre> <br>  Une fois l'installation réussie, copiez le référentiel yandex2mqtt sur le contrôleur. <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/munrexio/yandex2mqtt.git /mnt/data/root/yandex2mqtt</code> </pre> <br>  Nous fixons les droits. <br><br><pre> <code class="bash hljs">chown -R root:root /mnt/data/root/yandex2mqtt</code> </pre> <br>  Nous allons dans le dossier. <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /mnt/data/root/yandex2mqtt</code> </pre> <br>  Nous commençons l'installation. <br><br><pre> <code class="bash hljs">npm install</code> </pre> <br>  Installation terminée. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Démarrage automatique</b> <div class="spoiler_text">  <b>Créez une unité systemd:</b> <br><br>  Accédez au dossier <b>/ etc / systemd / system /</b> sur le contrôleur et créez un fichier appelé <b>yandex2mqtt.service</b> .  Copiez-y les éléments suivants: <br><br><pre> <code class="bash hljs">[Unit] Description=yandex2mqtt After=network.target [Service] ExecStart=/usr/bin/npm start WorkingDirectory=/mnt/data/root/yandex2mqtt StandardOutput=inherit StandardError=inherit Restart=always User=root [Install] WantedBy=multi-user.target</code> </pre> <br>  Après cela, enregistrez les modifications et fermez le fichier. <br><br>  Pour activer l'unité, entrez la commande dans la console: <br><br><pre> <code class="bash hljs">systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> yandex2mqtt.service</code> </pre> <br><br>  Vous pouvez maintenant démarrer et arrêter le plugin avec des commandes <br><br><pre> <code class="bash hljs">service yandex2mqtt start service yandex2mqtt stop service yandex2mqtt restart</code> </pre> <br></div></div><br>  <b>Configuration:</b> <br><br>  Tous les paramètres de plug-in nécessaires se trouvent dans le fichier <b>/mnt/data/root/yandex2mqtt/config.js</b> <br>  Modifiez ce fichier en fonction de vos paramètres. <br>  Le certificat SSL doit être <b>fullchain</b> . <br><br>  Après la configuration, exécutez yandex2mqtt avec la commande: <br><br><pre> <code class="bash hljs">service yandex2mqtt start</code> </pre> <br>  Après avoir mis en place et démarré le pont, je vous conseille de vérifier le certificat sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ce site</a> . <br><br>  Entrez simplement votre domaine que vous allez utiliser pour accéder à Alice.  Pour un bon fonctionnement, le certificat doit réussir tous les contrôles.  Sinon, rien ne fonctionnera. <br><br><h4>  Skill Yandex UD </h4><br><div class="spoiler">  <b class="spoiler_title">Création de compétences</b> <div class="spoiler_text">  1. Accédez à la page <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dialogs.yandex.ru/developer</a> <br>  2. Connectez-vous avec votre compte. <br>  3. Cliquez sur «créer un dialogue» <br>  4. Sélectionnez «Smart Home» <br>  5. Saisissez les paramètres requis: <br><br><ul><li>  <b>Nom</b> - N'importe quel nom. </li><li>  <b>URL du point de terminaison</b> - une adresse du type <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">votredomaine / fournisseur</a></b> , où au lieu de <b>«votredomaine</b> » est l'adresse de noip ou de votre domaine pour laquelle un certificat ssl est reçu. </li></ul><br><img src="https://habrastorage.org/webt/6w/sn/oc/6wsnoczljzsap2fdrldsgi47qr8.png" width="400"><br><br><ul><li>  <b>Confidentialité</b> - sélectionnez <b>"Ne pas afficher dans le catalogue" (Obligatoire! Sinon, la compétence ne passera pas la modération instantanée)</b> </li><li>  <b>Nom et email du développeur</b> - indiquez vos coordonnées. </li><li>  <b>Description</b> - n'importe quel texte </li><li>  <b>Icône</b> - n'importe quelle icône. </li></ul><br><img src="https://habrastorage.org/webt/70/7q/pv/707qpvhwz4bp8-g7anzd6yocavw.png" width="400"><br><br>  6. Ensemble de comptes: <br><br><img src="https://habrastorage.org/webt/z4/vg/ep/z4vgep4de2sngw6byx34eo5s5te.png" width="400"><br><br>  Cliquez sur "ajouter un nouveau" <br><ul><li>  Les deux premiers points - <b>spécifiez les données de config.js / clients</b> : </li></ul><br>  1. <b>L'identifiant d'application</b> est clientId <br><br>  2. <b>Secret d'application</b> - clientSecret <br><br><ul><li>  <b>URL d'autorisation</b> - votre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">domaine / boîte de dialogue / autoriser</a> </li><li>  <b>URL du jeton</b> - votre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">domaine / oauth / token</a> </li><li>  <b>URL de mise à jour du jeton</b> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">votredomaine / oauth / token</a> </li></ul><br><img src="https://habrastorage.org/webt/im/pg/zi/impgzifephas4rycqhvyll0_7uq.png" width="400"><br><br>  7. Enregistrez la compétence <br><br><img src="https://habrastorage.org/webt/fj/ud/xy/fjudxydpqb3mwv5ksihpr277j2u.png" width="400"><br><br>  8. Cliquez sur "Modération" <br><br><img src="https://habrastorage.org/webt/a2/ah/ji/a2ahjiezupvml9wo3a1pboif3pc.png"><br><br>  9. Cliquez sur «Publier» <br><br><img src="https://habrastorage.org/webt/7a/jv/83/7ajv8394tns4icumhxj1qqp-eea.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Ajout d'appareils à Yandex UD.</b> <div class="spoiler_text">  1. Accédez à l'application Yandex sur le téléphone <br><br><img src="https://habrastorage.org/webt/ki/fk/t6/kifkt6ims4epu1zm2hsa2z3bef0.jpeg" width="230"><br><br>  2. Dans le menu, sélectionnez Appareils / Smart Home <br><br><img src="https://habrastorage.org/webt/up/ec/ee/upeceeae_jjtrocticjinlinxmq.jpeg" width="230"><br><br>  3. Cliquez sur "Ajouter un appareil" <br><br><img src="https://habrastorage.org/webt/-c/yn/k3/-cynk3sjwga2frnsung0wp8mtre.jpeg" width="230"><br><br>  4. Choisissez votre compétence <br><br><img src="https://habrastorage.org/webt/ew/4h/jd/ew4hjdahl4eunc4kvygka1eftrs.jpeg" width="230"><br><br>  5. Cliquez sur "Fusionner les comptes" <br><br><img src="https://habrastorage.org/webt/ov/k7/hk/ovk7hkqe6oe0j7jvkw6eghcnycy.jpeg" width="230"><br><br>  6. La page d'autorisation s'ouvre <br><br>  <i>Entrez l'identifiant et le mot de passe (définis dans le fichier config.js dans le bloc utilisateurs)</i> <br><br><img src="https://habrastorage.org/webt/ly/lr/gw/lylrgwlzw5wcuy1c4wov6ez-2fm.jpeg" width="230"><br><br>  7. Cliquez sur "Autoriser". <br><br><img src="https://habrastorage.org/webt/y2/pu/tn/y2putnokvnlac9h4tuypa1sny9y.jpeg" width="230"><br><br>  8. Cliquez sur «Mettre à jour la liste des appareils» <br><br><img src="https://habrastorage.org/webt/cq/qd/gw/cqqdgwhp-zhmq5_ax3zbgohgrt4.jpeg" width="230"><br></div></div><br>  Désormais, Alice peut recevoir des commandes pour gérer les appareils ajoutés.  Les équipes correspondantes viendront sur les sujets indiqués par mqtt. <br><br>  Il reste à lier certaines actions à ces sujets. <br><br><h4>  Rouge-noeud </h4><br>  Node-Red a été choisi pour le système d'automatisation.  Il s'agit d'un excellent outil de programmation visuelle.  La procédure d'installation et de configuration peut être consultée <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  Le processus de configuration et d'automatisation d'une maison intelligente nécessitera un article entier, voire deux.  Et il existe déjà de nombreux articles de ce type.  Au lieu de cela - un petit exemple d'utilisation du plugin, comment activer la voix de l'ampoule. <br><br>  Pour plus de commodité, nous créons un périphérique virtuel sur le contrôleur Wiren Board 6 dans l'interface Web. <br>  Dans le moteur de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">règles wb-rules</a> , vous devez entrer <br><br><pre> <b><code class="javascript hljs">defineVirtualDevice(<span class="hljs-string"><span class="hljs-string">"yandex"</span></span>, { <span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-string"><span class="hljs-string">"yandex controls"</span></span>, <span class="hljs-attr"><span class="hljs-attr">cells</span></span>: { <span class="hljs-attr"><span class="hljs-attr">light1</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"switch"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> }, } });</code></b> </pre> <b><br></b> <br><img src="https://habrastorage.org/webt/3t/mn/qh/3tmnqhsdi1vnkdd_wr4ucnsvusc.jpeg"><br><br>  <b>Nous écrirons les</b> rubriques MQTT de cet appareil virtuel dans <b>config.js</b> pour le type de compétence "on" de l'appareil "Light": <br><br><pre> <code class="json hljs"> devices: [ //_______________   ______________// { name: '', room: '', type: 'devices.types.light', mqtt: [ { type: 'on', set: '/devices/yandex/controls/light1/on', //   stat: '/devices/yandex/controls/light1' //   }, ], capabilities: [ { type: 'devices.capabilities.on_off', retrievable: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, state: { instance: 'on', value: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } }, ] }, //_______________   _______________// ]</code> </pre><br>  Maintenant, avec la phrase «Alice, allume / éteins la lumière», l'appareil virtuel bascule. <br><br>  Passons à Node-Red, qui a été installé conformément aux instructions. <br><br>  Pour un travail pratique avec Wiren Board 6, vous pouvez également utiliser le «node» supplémentaire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">node-red-contrib-wirenboard</a> . <br><br>  Le module d'extension <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">WBE2R-R-ZIGBEE</a> est installé dans le contrôleur, ce qui a permis de se connecter à la lampe intelligente IKeevskaya de la série TRODFRY en utilisant le protocole ZigBee. <br><br>  Maintenant, c'est aux petits.  Jetez quelques blocs dans l'espace de travail Node-Red, connectez-les avec des «chaînes» et cliquez sur Déployer. <br><br><img src="https://habrastorage.org/webt/ev/p8/zn/evp8zn84umdssgxcecq9rmosgm8.jpeg"><br><br>  L'ampoule ikeevsky est connectée via le plugin zigbee2mqtt, donc dans mqtt le sujet de l'ampoule doit être envoyé json pour contrôle.  Pour ce faire, nous allons insérer une fonction simple entre le périphérique virtuel WB et la rubrique bulbe mqtt. <br><br><img src="https://habrastorage.org/webt/y1/e6/9h/y1e69hfghaemcayotpvugppiqz8.jpeg"><br><br>  Cliquez sur Déployer.  Nous vérifions. <br><br>  Alice, allume la lumière! <br><br>  Aujourd'hui, nous avons donc appris à connecter Alice à un système d'automatisation.  Dans certains cas, c'est peut-être trop compliqué, il est plus facile d'acheter une ampoule wi-fi ordinaire, et c'est suffisant.  Mais si vous envisagez de construire une maison vraiment intelligente pour vous-même, des moyens simples ne peuvent pas être utilisés ici.  Mais cela en vaut-il la peine ou non, chacun décidera pour lui-même.  Merci de votre attention! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr465537/">https://habr.com/ru/post/fr465537/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr465525/index.html">Rapports mobiles sur Oracle BI EE 12c - un, deux, trois. Méthodologie du cours de CAO Oracle BI EE 12c</a></li>
<li><a href="../fr465527/index.html">Le long voyage de la RFC 4357 à la RFC 8645 ou comment gérer les clés de chiffrement</a></li>
<li><a href="../fr465529/index.html">Suspension sur blocage</a></li>
<li><a href="../fr465531/index.html">Déballage des listes imbriquées de profondeur indéfinie</a></li>
<li><a href="../fr465535/index.html">Qui implémente IPv6 et ce qui entrave son développement</a></li>
<li><a href="../fr465539/index.html">766 km - un nouveau record d'autonomie pour LoRaWAN</a></li>
<li><a href="../fr465541/index.html">De l'entreprise à la PME: nous partageons notre expérience dans l'adaptation de solutions d'entreprise pour les petites et moyennes entreprises avec la monétisation en utilisant le modèle SaaS</a></li>
<li><a href="../fr465545/index.html">De différents côtés de l'État: comment Facebook a été frit au Congrès américain, tandis que Telegram se battait avec le FSB</a></li>
<li><a href="../fr465547/index.html">Guide SQL: comment mieux écrire des requêtes (partie 1)</a></li>
<li><a href="../fr465551/index.html">Résumé des événements informatiques de septembre (première partie)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>