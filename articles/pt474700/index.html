<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßö üõèÔ∏è üë®‚Äçüë©‚Äçüë¶ Nuvem Smart Home. Parte 2: Servi√ßo em nuvem üë©üèø üòú üçà</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Eu continuo a s√©rie de tr√™s artigos sobre a nuvem casa inteligente. 

 Em um artigo anterior , foram considerados equipamentos para detectar uma casa ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nuvem Smart Home. Parte 2: Servi√ßo em nuvem</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/474700/"><img src="https://habrastorage.org/webt/iq/e3/kt/iqe3kte_k_di5dqmevpvprwojee.jpeg" alt="imagem"><br><br>  Eu continuo a s√©rie de tr√™s artigos sobre a nuvem casa inteligente. <br><br>  Em um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo anterior</a> , foram considerados equipamentos para detectar uma casa inteligente, bem como algoritmos para converter dados sensoriais em comandos de controle para dispositivos executivos.  O principal componente de uma casa inteligente √© um controlador, que na maioria das vezes funciona de forma aut√¥noma, de acordo com a l√≥gica estabelecida na fase de configura√ß√£o.  V√°rios dispositivos (c√¢meras IP, sensores, atuadores) est√£o conectados ao controlador, que envia os dados recebidos desses dispositivos para a nuvem. <br><br>  Agora, vamos falar sobre a arquitetura de um servi√ßo de nuvem para armazenar e processar informa√ß√µes de sensores e c√¢meras. <br><a name="habracut"></a><br><h2>  Benef√≠cios do servi√ßo em nuvem </h2><br>  Um servi√ßo de nuvem dom√©stica inteligente oferece uma maneira simples, flex√≠vel e barata de armazenar e acessar dados recebidos de dispositivos dom√©sticos inteligentes.  O usu√°rio do servi√ßo em nuvem n√£o precisa se preocupar com a seguran√ßa de seus dados.  Os recursos de um servidor de m√≠dia multiprocessador, equipado com uma cesta de discos com uma matriz RAID de v√°rias unidades de 10 a 12 TB, excedem em muito a capacidade de um cart√£o SD ou Flash dentro de um controlador dom√©stico inteligente.  Al√©m disso, os cart√µes de mem√≥ria n√£o s√£o confi√°veis ‚Äã‚Äãporque possuem um n√∫mero limitado de ciclos de reescrita e geralmente falham.  A profundidade do armazenamento de dados na nuvem √© determinada pela tarifa do usu√°rio e √© facilmente configurada em sua conta pessoal. <br><br>  Al√©m disso, para acessar os dados, n√£o h√° necessidade de "encaminhamento de porta" no roteador do usu√°rio quando dispositivos dom√©sticos inteligentes est√£o ocultos das redes externas pelo protocolo NAT.  Na sua conta pessoal, acess√≠vel a partir de dispositivos m√≥veis, voc√™ pode configurar facilmente a configura√ß√£o e a l√≥gica da casa inteligente. <br><br>  √â conveniente n√£o apenas armazenar dados na nuvem, mas tamb√©m process√°-los, fornecendo ao usu√°rio estat√≠sticas por v√°rios per√≠odos de tempo.  Abaixo, consideraremos um exemplo de c√°lculo da temperatura ambiente m√©dia por semana com base em medi√ß√µes multisensores. <br><br><h2>  Arquitetura de servi√ßo em nuvem </h2><br>  Em um artigo anterior, falamos sobre um controlador dom√©stico inteligente instalado no lado do usu√°rio e interage com um servi√ßo de nuvem usando v√°rios protocolos: <br><br><ul><li>  MQTT √© usado para trocar mensagens JSON entre o controlador e o servidor de l√≥gica de neg√≥cios; </li><li>  HTTP para obter o endere√ßo IP do servidor de m√≠dia menos carregado do balanceador de carga do cluster de servidores de m√≠dia; </li><li>  RTMP para transferir o fluxo H.264 + AAC para o servidor de m√≠dia. </li></ul><br>  Agora, consideraremos o servi√ßo de nuvem de uma casa inteligente - os principais componentes dos quais consiste e como ocorre a intera√ß√£o com o controlador de casa inteligente. <br><br> <a href=""><img src="https://habrastorage.org/webt/os/bd/xi/osbdxiktvu-cla3sizuxjoaxbfu.png"></a> <br>  <font color="grey">(clique na imagem para abrir em resolu√ß√£o maior)</font> <br><br>  <b>O servidor de l√≥gica de neg√≥cios</b> √© um elemento-chave em todo o esquema de troca de informa√ß√µes no servi√ßo em nuvem.  Seu principal objetivo √© gerenciar v√°rios subsistemas de servidores por meio das interfaces da API RESTful.  Ele implementa a l√≥gica do servi√ßo em nuvem com base no <b>modelo do usu√°rio</b> : gravando um arquivo de v√≠deo e medi√ß√µes de sensor, dependendo da tarifa selecionada, intera√ß√£o entre o usu√°rio e o controlador dom√©stico inteligente, etc. <br><br>  <b>O broker MQTT √©</b> necess√°rio para a troca de mensagens JSON entre controladores dom√©sticos inteligentes instalados no lado do cliente e o servidor de l√≥gica de neg√≥cios.  Os clientes assinam t√≥picos no broker que servem como canais de mensagens.  Como um broker do MQTT, o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Eclipse Mosquitto √© usado</a> . <br><br>  <b>Um cluster de servidor de m√≠dia</b> √© um sistema distribu√≠do para armazenar, processar, pesquisar e reproduzir informa√ß√µes de v√≠deo para c√¢meras IP de uma casa inteligente nublada.  Um balanceador de carga especial coleta informa√ß√µes sobre o desempenho atual de cada servidor no cluster, calcula o menos carregado e relata seu endere√ßo IP para o controlador dom√©stico inteligente, que transfere o v√≠deo das c√¢meras para ele. <br><br>  <b>√â</b> necess√°rio <b>um banco de dados em nuvem</b> para armazenar o modelo de usu√°rio do servi√ßo em nuvem, a configura√ß√£o e o status atual de seus equipamentos, al√©m de meta-informa√ß√µes sobre as entradas do arquivo de v√≠deo.  Como uma implementa√ß√£o do banco de dados em nuvem, o MySQL DBMS √© usado. <br><br>  <b>O Touch Database</b> √© um banco de dados NoSQL n√£o relacional.  Ele armazena eventos e medi√ß√µes de sensores residenciais inteligentes, ordenados por tempo.  O uso do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">InfluxDB</a> DBMS, otimizado para trabalhar com esse tipo de dados, melhora significativamente o desempenho do servi√ßo em nuvem. <br><br>  <b>O back</b> - <b>end do aplicativo cliente</b> √© um aplicativo de servidor cuja fun√ß√£o principal √© fornecer dados recebidos da nuvem e tocar em bancos de dados em um formato conveniente para exibi√ß√£o subsequente pelo aplicativo cliente no dispositivo do usu√°rio.  O back-end tamb√©m gera comandos de controle no formato JSON para o controlador dom√©stico inteligente.  O back-end √© baseado na estrutura PHP do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Laravel</a> .  Ser√° discutido em mais detalhes no pr√≥ximo artigo sobre um aplicativo cliente para interagir com uma casa inteligente na nuvem. <br><br>  <b>O provedor de notifica√ß√£o por push</b> entrega mensagens sobre os eventos da casa inteligente ao dispositivo m√≥vel do usu√°rio para que ele possa intervir rapidamente na situa√ß√£o (por exemplo, quando um vazamento ou fuma√ßa de √°gua aparecer, ligue para os servi√ßos de resposta apropriados).  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O</a> servi√ßo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">OneSignal</a> foi escolhido como o provedor de notifica√ß√µes push, que possui uma interface API RESTful conveniente e a fun√ß√£o de identifica√ß√£o de dispositivos m√≥veis, necess√°ria para a opera√ß√£o correta das notifica√ß√µes na conta pessoal do usu√°rio. <br><br><h2>  Servidor de l√≥gica de neg√≥cios </h2><br>  Como mencionado anteriormente, o servidor de l√≥gica de neg√≥cios √© um componente essencial da nuvem em casa inteligente.  Com base no <b>modelo do usu√°rio</b> (descri√ß√£o informativa do usu√°rio do sistema, que inclui recursos do sistema, pessoais, financeiros e l√≥gicos), ele gerencia uma variedade de servi√ßos na nuvem que possuem implementa√ß√µes e funcionalidades diferentes e se comunicam por meio de interfaces de API RESTful. <br><br><img src="https://habrastorage.org/webt/m0/vl/vj/m0vlvjztjnmvtrckqgvefi2ht80.png"><br><br>  O m√≥dulo de l√≥gica de neg√≥cios dentro do servidor √© respons√°vel pelas seguintes opera√ß√µes: <br><br><ol><li>  gerenciamento de armazenamento de medi√ß√µes de sensores e eventos de detectores de movimento de c√¢meras IP de uma casa inteligente dentro de um banco de dados de toque; </li><li>  gerenciar a grava√ß√£o do fluxo de m√≠dia da c√¢mera IP transmitida pelo controlador de casa inteligente no arquivo do servidor de m√≠dia (constante / por detector de movimento); </li><li>  tradu√ß√£o de comandos do aplicativo cliente para o controlador dom√©stico inteligente; </li><li>  transmitir a configura√ß√£o do controlador dom√©stico inteligente (dispositivos conectados, regras de l√≥gica de produ√ß√£o definidas pelo usu√°rio); </li><li>  enviando notifica√ß√µes push sobre o status do controlador dom√©stico inteligente e dos dispositivos conectados ao aplicativo cliente. </li></ol><br>  Um recurso do servidor de l√≥gica de neg√≥cios √© a comunica√ß√£o entre processos entre aplicativos remotos em execu√ß√£o em v√°rios servidores na Internet.  Na maioria das vezes, o aplicativo do servidor de l√≥gica de neg√≥cios fica ocioso nos bloqueios de E / S; portanto, ele √© projetado com base em uma arquitetura multithread e consiste em um conjunto de subtarefas finitas. <br><br>  Para garantir a m√°xima efici√™ncia, a implementa√ß√£o interna do servidor de l√≥gica de neg√≥cios deve ser a mais simples ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">princ√≠pio do KISS</a> ).  Como o modelo do usu√°rio √© completamente determin√≠stico e n√£o cont√©m relacionamentos alterados entre os recursos, n√£o h√° necessidade de um mecanismo de infer√™ncia flex√≠vel (como em um controlador dom√©stico inteligente, onde a l√≥gica do usu√°rio √© configurada pelo usu√°rio).  Portanto, a opera√ß√£o do m√≥dulo de l√≥gica de neg√≥cios dentro do servidor pode ser descrita por um diagrama de blocos algor√≠tmico convencional com transi√ß√µes condicionais. <br><br> <a href=""><img src="https://habrastorage.org/webt/fh/xf/70/fhxf703hqjqjjhzg9i_uuxv2qqo.png"></a> <br>  <font color="grey">(clique na imagem para abrir em resolu√ß√£o maior)</font> <br><br>  Imediatamente ap√≥s a inicializa√ß√£o, o servidor de l√≥gica de neg√≥cios entra no estado de espera por mensagens usando os protocolos MQTT (dos controladores dom√©sticos inteligentes) e HTTP (do back-end do aplicativo cliente).  Caso a mensagem chegue via HTTP, isso significa que o usu√°rio interage com o aplicativo cliente e envia comandos para o controlador dom√©stico inteligente ou atualiza sua configura√ß√£o.  Para que a mensagem do cliente caia no controlador de casa inteligente, ela √© transmitida pelo servidor de l√≥gica de neg√≥cios para o t√≥pico correspondente do broker MQTT, no qual o controlador est√° inscrito ( <b>subtarefa SendGatewayMessage</b> ). <br><br>  No est√°gio de inicializa√ß√£o, o controlador dom√©stico inteligente aguarda o usu√°rio registr√°-lo em sua conta pessoal.  Portanto, <b>√© executada</b> a subtarefa <b>CheckGatewayExistance</b> , que verifica o status correspondente no banco de dados em nuvem MySQL.  Para registrar-se em sua conta pessoal, o controlador envia sua configura√ß√£o completa ao servidor de l√≥gica de neg√≥cios e, por sua vez, transmite seu back-end para o aplicativo cliente ( <b>subtarefa SendBackend</b> ), que cria e atualiza registros de configura√ß√£o nos bancos de dados em nuvem e touch. <br><br>  Quando o controlador dom√©stico inteligente √© registrado com √™xito na conta pessoal do usu√°rio, o servidor de l√≥gica de neg√≥cios carrega o modelo do usu√°rio do banco de dados na nuvem em sua RAM e come√ßa a processar mensagens de c√¢meras IP e sensores Z-Wave de acordo com o seguinte algoritmo de l√≥gica de neg√≥cios. <br><br>  Mensagem JSON do sensor Z-Wave com campos de informa√ß√£o: <br><br><pre><code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"vendor"</span></span>: <span class="hljs-string"><span class="hljs-string">"*****"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"3.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"timestampMs"</span></span>: <span class="hljs-string"><span class="hljs-string">"1571754749561"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"clientType"</span></span>: <span class="hljs-string"><span class="hljs-string">"gateway"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deviceId"</span></span>: <span class="hljs-string"><span class="hljs-string">"c8e8de37-d301-45f4-ba01-************"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deviceType"</span></span>: <span class="hljs-string"><span class="hljs-string">"sensor"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"protocol"</span></span>: <span class="hljs-string"><span class="hljs-string">"zwave"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"messageType"</span></span>: <span class="hljs-string"><span class="hljs-string">"sensorData"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"homeId"</span></span>: <span class="hljs-string"><span class="hljs-string">"0xefa0cfa7"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"nodeId"</span></span>: <span class="hljs-string"><span class="hljs-string">"19"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sensorType"</span></span>: <span class="hljs-string"><span class="hljs-string">"SENSOR MULTILEVEL"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"label"</span></span>: <span class="hljs-string"><span class="hljs-string">"Temperature"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sensorData"</span></span>: <span class="hljs-string"><span class="hljs-string">"26.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"units"</span></span>: <span class="hljs-string"><span class="hljs-string">"C"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"gatewayId"</span></span>: <span class="hljs-string"><span class="hljs-string">"6774f85a-0a5b-4059-9b68-************"</span></span> }</code> </pre> <br>  Quando uma mensagem do sensor Z-Wave chega via protocolo MQTT, as seguintes subtarefas s√£o executadas: <br><br><ul><li>  <b>StoreSensorDataMySQL</b> atualiza (UPDATE) um registro existente no banco de dados em nuvem MySQL, onde s√£o armazenadas informa√ß√µes sobre o estado atual e as medidas do sensor.  Isso √© necess√°rio para um aplicativo cliente que exibe o estado atual da casa inteligente para o usu√°rio; </li><li>  <b>O StoreSensorDataInfluxDB</b> adiciona (INSERT) um novo registro ao banco de dados de toque do InfluxDB, onde o hist√≥rico de medi√ß√µes do sensor √© armazenado.  Essas informa√ß√µes s√£o usadas no c√°lculo de dados estat√≠sticos para v√°rios per√≠odos de tempo (por exemplo, consumo de energia por dia, m√™s ou ano) e exibidas no aplicativo cliente na forma de gr√°ficos e tabelas; </li><li>  <b>SendPushNotification</b> gera uma mensagem JSON contendo um <b>registro de</b> data e hora, um nome de sensor, uma descri√ß√£o em texto do evento, o identificador do smartphone do usu√°rio com quem ele entrou em sua conta pessoal, o identificador interno do aplicativo no sistema de provedor OneSignal.  Al√©m disso, essa mensagem √© enviada ao provedor de notifica√ß√£o por push por meio da API RESTful <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://onesignal.com/api/v1/notifications</a> , que a entrega ao smartphone do usu√°rio. </li></ul><br>  Um exemplo de uma mensagem JSON de uma c√¢mera IP com campos de informa√ß√µes: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"vendor"</span></span>: <span class="hljs-string"><span class="hljs-string">"*****"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"3.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"timestampMs"</span></span>: <span class="hljs-string"><span class="hljs-string">"1571753150317"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"clientType"</span></span>: <span class="hljs-string"><span class="hljs-string">"gateway"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deviceId"</span></span>: <span class="hljs-string"><span class="hljs-string">"1616453d-30cd-44b7-9bf0-************"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deviceType"</span></span>: <span class="hljs-string"><span class="hljs-string">"camera"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"protocol"</span></span>: <span class="hljs-string"><span class="hljs-string">"onvif"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"messageType"</span></span>: <span class="hljs-string"><span class="hljs-string">"deviceState"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deviceState"</span></span>: <span class="hljs-string"><span class="hljs-string">"streamingOn"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"mediaserverIp"</span></span>: <span class="hljs-string"><span class="hljs-string">"***.***.***.***"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"applicationName"</span></span>: <span class="hljs-string"><span class="hljs-string">"rtp-live-iot"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"gatewayId"</span></span>: <span class="hljs-string"><span class="hljs-string">"6774f85a-0a5b-4059-9b68-************"</span></span> }</code> </pre><br>  Quando uma mensagem chega da c√¢mera IP usando o protocolo MQTT, o servidor de l√≥gica de neg√≥cios extrai seu tipo do campo <b>messageType</b> .  Dependendo do valor desse campo, as seguintes a√ß√µes s√£o executadas: <br><br><ul><li>  <b>"MessageType": "deviceState"</b> - a mensagem cont√©m informa√ß√µes sobre a altera√ß√£o de status da c√¢mera IP.  A subtarefa <b>UpdateCameraState √© executada</b> , atualizando as informa√ß√µes no banco de dados em nuvem.  Se o campo <b>deviceState</b> for <b>streamingOn</b> ou <b>streamingOff</b> (a c√¢mera IP envia / interrompe o fluxo de dados para o servidor de m√≠dia), a <b>subtarefa RecordMediaStream</b> √© <b>executada</b> , o que gera um comando para ativar / desativar o modo de grava√ß√£o de arquivo <b>morto</b> e o envia ao servidor de m√≠dia, levando em considera√ß√£o o modelo do usu√°rio; </li><li>  <b>"MessageType": "sensorData"</b> - informa√ß√µes sobre a opera√ß√£o do detector de movimento na c√¢mera IP.  Se no modelo do usu√°rio o modo de grava√ß√£o de arquivo estiver definido como "por detector de movimento", a subtarefa <b>RecordMediaStream</b> ser√° <b>executada</b> .  Em seguida, s√£o <b>executadas</b> as subtarefas <b>StoreSensorDataInfluxDB</b> (salvando o hist√≥rico do detector no banco de dados de toque) e <b>SendPushNotification</b> (enviando notifica√ß√µes push atrav√©s do provedor); </li><li>  <b>"MessageType": "preview"</b> - a mensagem cont√©m um quadro de uma imagem em miniatura da c√¢mera IP, que √© enviada periodicamente para a nuvem.  A subtarefa <b>StorePreview o</b> salva em um banco de dados em nuvem.  Em seguida, √© usado no aplicativo cliente ao exibir uma lista de c√¢meras; </li><li>  <b>"MessageType": "command"</b> - um comando enviado pelo controlador dom√©stico inteligente quando o usu√°rio altera suas configura√ß√µes pela interface da Web.  A subtarefa <b>RecordMediaStream √© executada</b> , que, dependendo do modelo do usu√°rio, liga / desliga o modo de grava√ß√£o no servidor de m√≠dia. </li></ul><br> <a href=""><img src="https://habrastorage.org/webt/8o/_u/gy/8o_ugygyf5hm0nlyd6aw8zwge8s.png"></a> <br>  <font color="grey">(clique na imagem para abrir em resolu√ß√£o maior)</font> <br><br>  Como resultado do trabalho do m√≥dulo de l√≥gica de neg√≥cios, uma <b>fila de tarefas</b> √© formada - uma sequ√™ncia de se√ß√µes m√≠nimas de c√≥digo que s√£o executadas independentemente uma da outra.  A fila de tarefas √© transferida para o <b>conjunto de encadeamentos</b> , que distribui tarefas entre os n√∫cleos livres do processador central.  Quando um bloqueio de E / S ocorre durante a execu√ß√£o, o encadeamento pausa e entra no estado inativo e libera o n√∫cleo do processador central, o que permite ao conjunto de encadeamentos iniciar a execu√ß√£o imediata da pr√≥xima tarefa da fila.  No momento em que o bloqueio de E / S √© liberado, o encadeamento bloqueado muda seu estado para trabalho e continua a execu√ß√£o assim que um dos n√∫cleos do processador central √© liberado. <br><br>  Assim, decompondo a tarefa de l√≥gica de neg√≥cios em v√°rias subtarefas separadas que s√£o executadas simultaneamente, o desempenho do servidor de l√≥gica de neg√≥cios aumenta.  O dimensionamento do sistema √© obtido aumentando o n√∫mero de n√∫cleos do processador central e o n√∫mero de servidores de l√≥gica de neg√≥cios no sistema. <br><br>  O aplicativo do servidor de l√≥gica de neg√≥cios √© desenvolvido em C ++ e √© executado como o servi√ßo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">systemd</a> do sistema operacional Linux Debian Sarge.  Para monitoramento de desempenho adicional, √© usado o sistema de monitoramento de recursos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">monit</a> , que reinicia o servi√ßo em caso de problemas de desempenho. <br><br>  Atualmente, o servi√ßo de nuvem executa um servidor de l√≥gica de neg√≥cios em execu√ß√£o na m√°quina virtual Yandex.  Par√¢metros da m√°quina virtual - 4 n√∫cleos de vCPU com participa√ß√£o garantida de 20%, 2 GB de RAM e 100 GB de HDD.  De acordo com os c√°lculos, esse desempenho √© suficiente para processar mensagens de ~ 1000 controladores dom√©sticos inteligentes com 3 c√¢meras IP e 5 sensores Z-Wave cada (os c√°lculos ser√£o esclarecidos durante a opera√ß√£o do sistema). <br><br><h2>  Servidor de m√≠dia </h2><br>  Um servidor de m√≠dia √© um servidor dedicado no qual um software especial est√° instalado para: <br><br><ul><li>  receber fluxos de dados de v√≠deo e √°udio de dispositivos codificadores usando protocolos de rede especializados; </li><li>  armazenar dados na forma de arquivos compactados em seu sistema de arquivos; </li><li>  Transmita informa√ß√µes de arquivos compactados em um formato de streaming padr√£o para reprodu√ß√£o em dispositivos clientes. </li></ul><br>  O <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Wowza Streaming Engine 4.7.2</a> com m√≥dulos adicionais desenvolvidos na linguagem Java √© usado como servidor de m√≠dia no sistema inteligente em nuvem para gravar dados de streaming em um arquivo morto e para trabalhar com um banco de dados em nuvem. <br><br> <a href=""><img src="https://habrastorage.org/webt/va/du/c-/vaduc-wwi67k2367aoez0bnqx_s.png"></a> <br>  <font color="grey">(clique na imagem para abrir em resolu√ß√£o maior)</font> <br><br>  O fluxo de m√≠dia do controlador dom√©stico inteligente no formato RTMP entra no servidor de m√≠dia e √© alinhado com carimbos de data e hora no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">buffer de tremula√ß√£o</a> .  Isso √© necess√°rio para compensar o efeito dos atrasos dos pacotes de rede ao transmitir o fluxo de dados pela Internet. <br><br>  Para gravar o fluxo de v√≠deo no sistema de arquivos do servidor de m√≠dia como um arquivo MP4, o servidor de l√≥gica de neg√≥cios envia o seguinte comando ao servidor de m√≠dia por meio da API HTTP RESTful: <br><br><pre> <code class="json hljs">http://&lt;mediaserverIp&gt;:&lt;port&gt;/v<span class="hljs-number"><span class="hljs-number">2</span></span>/servers/_defaultServer_/vhosts/_defaultVHost_/applications/rtp-live-iot/instances/_definst_/streamrecorders/<span class="hljs-number"><span class="hljs-number">1616453</span></span>d<span class="hljs-number"><span class="hljs-number">-30</span></span>cd<span class="hljs-number"><span class="hljs-number">-44</span></span>b<span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-number"><span class="hljs-number">-9</span></span>bf<span class="hljs-number"><span class="hljs-number">0</span></span>-************ { <span class="hljs-attr"><span class="hljs-attr">"instanceName"</span></span>: <span class="hljs-string"><span class="hljs-string">"_definst_"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"fileVersionDelegateName"</span></span>: <span class="hljs-string"><span class="hljs-string">"CustomFileVersionDelegate"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"serverName"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"recorderName"</span></span>: <span class="hljs-string"><span class="hljs-string">"1616453d-30cd-44b7-9bf0-************"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"segmentSchedule"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"outputPath"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"currentFile"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"applicationName"</span></span>: <span class="hljs-string"><span class="hljs-string">"rtp-live-iot"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"fileTemplate"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"segmentationType"</span></span>: <span class="hljs-string"><span class="hljs-string">"SegmentByDuration"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"fileFormat"</span></span>: <span class="hljs-string"><span class="hljs-string">"MP4"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"recorderState"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"option"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"currentSize"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"segmentSize"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"segmentDuration"</span></span>: <span class="hljs-string"><span class="hljs-string">"1800000"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"backBufferTime"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"currentDuration"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"startOnKeyFrame"</span></span>: <span class="hljs-string"><span class="hljs-string">"true"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"recordData"</span></span>: <span class="hljs-string"><span class="hljs-string">"false"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"moveFirstVideoFrameToZero"</span></span>: <span class="hljs-string"><span class="hljs-string">"true"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"defaultRecorder"</span></span>: <span class="hljs-string"><span class="hljs-string">"false"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"splitOnTcDiscontinuity"</span></span>: <span class="hljs-string"><span class="hljs-string">"false"</span></span> }</code> </pre><br>  No campo <b>recorderName</b> , o nome do fluxo de v√≠deo (identificador da c√¢mera IP no controlador dom√©stico inteligente) √© <b>indicado</b> , no campo <b>fileVersionDelegateName</b> , o nome da classe herdada para determinar o caminho da pasta e o nome do arquivo.  O c√≥digo da classe Java √© mostrado na seguinte listagem: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.File; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Calendar; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.TimeZone; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.wowza.wms.livestreamrecord.manager.IStreamRecorder; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.wowza.wms.livestreamrecord.manager.IStreamRecorderFileVersionDelegate; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.wowza.wms.logging.WMSLoggerFactory; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomFileVersionDelegate</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IStreamRecorderFileVersionDelegate</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFilename</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IStreamRecorder recorder)</span></span></span><span class="hljs-function"> </span></span>{ String sDisk = GetDisk(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(sDisk == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { WMSLoggerFactory.getLogger(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>).error(<span class="hljs-string"><span class="hljs-string">"CustomFileVersionDelegate::getFilename(): No drive chosen"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } String sStreamName = recorder.getStreamName(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nCameraId = Integer.parseUnsignedInt(ServiceQueries.GetCameraId(sStreamName)); TimeZone tz = TimeZone.getTimeZone(<span class="hljs-string"><span class="hljs-string">"Europe/Moscow"</span></span>); Calendar now = Calendar.getInstance(tz); String sDirPath = ServerParams.m_sServerContentPath + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + sDisk + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + Integer.toString(nCameraId / <span class="hljs-number"><span class="hljs-number">200</span></span>) + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + sStreamName + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + String.format(<span class="hljs-string"><span class="hljs-string">"%1$tY/%1$tm/%1$td"</span></span>, now); String sFullFilePath = sDirPath + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + sStreamName + <span class="hljs-string"><span class="hljs-string">"_"</span></span> + String.format(<span class="hljs-string"><span class="hljs-string">"%1$tH_%1$tM_%1$tS"</span></span>, now) + <span class="hljs-string"><span class="hljs-string">".mp4"</span></span>; File dirs = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(sDirPath); dirs.setExecutable(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); dirs.setWritable(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); dirs.mkdirs(); WMSLoggerFactory.getLogger(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>).info( <span class="hljs-string"><span class="hljs-string">"CustomFileVersionDelegate::getFilename(): Filename created: "</span></span> + sFullFilePath); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sFullFilePath; } }</code> </pre><br>  Na classe <b>CustomFileVersionDelegate</b> , a fun√ß√£o virtual <b>getFilename</b> da classe base <b>IStreamRecorderFileVersionDelegate</b> est√° <b>sobrecarregada</b> , que √© chamada pelo servidor de m√≠dia antes que o fluxo comece a gravar no arquivo.  A fun√ß√£o cria uma pasta no disco com o caminho <b>sDirPath</b> e retorna o caminho completo para o arquivo <b>sFullFilePath</b> . <br><br>  Como o volume de dados de m√≠dia √© muito grande, o sistema de arquivos inclui v√°rios discos f√≠sicos de grande volume (8 - 12 TB) montados como subdiret√≥rios.  O disco com a maior quantidade de espa√ßo livre √© selecionado como o disco de destino durante a grava√ß√£o.  Para uma opera√ß√£o ideal do sistema de arquivos ao acessar o arquivo, o caminho para a pasta de destino √© formado da seguinte maneira: <br><br><pre> <code class="plaintext hljs">/content/&lt;diskId&gt;/&lt;cameraIdDivideBy200&gt;/&lt;streamUuid&gt;/&lt;year&gt;/&lt;month&gt;/&lt;day&gt;/</code> </pre><br>  onde <b>diskId</b> √© o identificador do disco (pasta montada), <br>  <b>cameraIdDivideBy200</b> - o resultado de uma divis√£o inteira do identificador da c√¢mera em 200, <br>  <b>streamUuid</b> - identificador de fluxo de m√≠dia, <br>  <b>ano, m√™s, dia</b> - ano, m√™s e dia da grava√ß√£o, respectivamente. <br><br>  Isso evita um grande n√∫mero de subpastas em uma pasta e, consequentemente, uma queda dr√°stica no desempenho de todo o sistema de arquivos, com um aumento no n√∫mero de c√¢meras IP em casas inteligentes nubladas. <br><br>  As informa√ß√µes sobre o endere√ßo IP do servidor de m√≠dia, o caminho para o arquivo com dados de m√≠dia, o hor√°rio de in√≠cio e t√©rmino da grava√ß√£o no arquivo s√£o armazenadas no banco de dados em nuvem e, em seguida, usadas pelo aplicativo cliente para exibir a linha do tempo do arquivo na qual o v√≠deo pode ser selecionado e reproduzido. <br><br>  Para obter o fluxo de v√≠deo, o front-end do aplicativo cliente acessa o servidor de m√≠dia, enviando os seguintes comandos por meio do protocolo HTTP.  Para uma transmiss√£o de v√≠deo "ao vivo": <br><br><pre> <code class="plaintext hljs">https://&lt;mediaserverIp&gt;:&lt;port&gt;/rtp-live-iot/&lt;streamUuid&gt;/playlist.m3u8</code> </pre><br>  Para fluxo de v√≠deo arquivado: <br><br><pre> <code class="plaintext hljs">https://&lt;mediaserverIp&gt;:&lt;port&gt;/vod/_definst_/mp4:&lt;diskId&gt;/&lt;cameraIdDivideBy200&gt;/&lt;streamUuid&gt;/&lt;year&gt;/&lt;month&gt;/&lt;day&gt;/&lt;fileName&gt;/playlist.m3u8?wowzaplaystart=&lt;offsetMs&gt;&amp;wowzaplayduration=&lt;durationMs&gt;</code> </pre><br>  onde <b>fileName</b> √© o nome do arquivo no disco, <br>  <b>offsetMs</b> - deslocamento da reprodu√ß√£o em rela√ß√£o ao in√≠cio do arquivo em milissegundos, <br>  <b>durationMs</b> - dura√ß√£o da reprodu√ß√£o em milissegundos. <br><br>  O servidor de m√≠dia envia um fluxo no formato <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">HLS</a> , que permite exibir o v√≠deo H.264 + AAC em todos os navegadores e dispositivos m√≥veis modernos com os sistemas operacionais iOS e Android.  O empacotador HLS codifica o fluxo na forma de blocos separados e o envia por HTTP como resposta a uma solicita√ß√£o de um aplicativo m√≥vel. <br><br>  Para otimizar os custos de armazenamento e o acesso a arquivos compactados, o servidor de m√≠dia dom√©stica inteligente na nuvem foi desenvolvido na plataforma de hardware Supermicro CSE-825TQ, placa-m√£e X8DT6, 2xCPU Intel Xeon E5645 de 2,4 GHz, 32 GB de RAM, 32 GB de RAM, HDD Adaptec AAC-RAID de 44 TB.  O servidor de m√≠dia √© instalado como um servidor dedicado no site de hospedagem e se conecta ao canal da Internet com uma largura garantida de 400 Mbps.  O desempenho de um servidor de m√≠dia √© suficiente para processar fluxos de m√≠dia de ~ 400 c√¢meras IP com o codec H.264, resolu√ß√£o de quadro de 720p e taxa de bits de 1 Mbps. <br><br><img src="https://habrastorage.org/webt/zr/-n/sy/zr-nsyuedb8wtbakou5rzfnsyo8.png"><br><br>  Portanto, para poder processar fluxos de 1000 c√¢meras IP, √© necess√°rio instalar tr√™s servidores de m√≠dia e distribuir uniformemente a carga entre eles.  Para isso, √© usado um balanceador de carga, conectado ao servidor de m√≠dia Wowza Streaming Engine como um plug-in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">AddOn de balanceamento din√¢mico de carga</a> separado.  Na verdade, isso distingue o balanceador de carga (ou <b>servidor de origem</b> ), que recebe periodicamente as m√©tricas de desempenho dos servidores de m√≠dia finais (ou <b>servidores de borda</b> ) e, com base nessas informa√ß√µes, encontra o servidor menos carregado no cluster. <br><br>  O controlador dom√©stico inteligente acessa o balanceador via HTTP e, em resposta, recebe o endere√ßo IP deste servidor, para o qual o controlador transmite o fluxo de m√≠dia da c√¢mera IP via RTMP.  A m√©trica de desempenho inclui o n√∫mero de conex√µes estabelecidas com fontes e consumidores de fluxos de m√≠dia e a largura de banda atual do canal da Internet no servidor.  Nas configura√ß√µes do balanceador, voc√™ tamb√©m pode especificar a escolha do servidor de borda, levando em considera√ß√£o sua posi√ß√£o geoespacial, que permite hospedar servidores em diferentes cidades e pa√≠ses para criar uma rede distribu√≠da para entrega de conte√∫do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CDN</a> . <br><br><h2>  Touch database </h2><br>  Como mencionado anteriormente no artigo anterior, as leituras dos sensores Z-Wave, bem como o status e os eventos atuais das c√¢meras IP s√£o enviados no formato JSON pelo controlador dom√©stico inteligente para a nuvem usando o protocolo MQTT.  O servidor de l√≥gica de neg√≥cios decodifica essas mensagens e executa a subtarefa <b>StoreSensorDataInfluxDB</b> , que transmite dados para o banco de dados touch via HTTP. <br><br> <a href=""><img src="https://habrastorage.org/webt/14/lv/rv/14lvrvrra0js_mzifmrwszu9c68.png"></a> <br>  <font color="grey">(clique na imagem para abrir em resolu√ß√£o maior)</font> <br><br>  O banco de dados em nuvem da casa inteligente √© desenvolvido com base no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">InfluxDB 1.7.x</a> - um sistema de gerenciamento de banco de dados de c√≥digo aberto para trabalhar com seq√º√™ncias de tempo, usado em muitos projetos da Internet das Coisas para armazenar dados de sensores e an√°lises.  As consultas ao banco de dados de toque s√£o geradas na linguagem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">InfluxQL</a> semelhante ao SQL tradicional. <br><br>  O tempo de armazenamento de dados na nuvem smart home √© determinado pela tarifa selecionada de acordo com o modelo do usu√°rio.  Devido √† diferen√ßa significativa na quantidade de dados de v√≠deo e dados do sensor, o tempo de armazenamento ser√° diferente.  O tamanho do arquivo de v√≠deo √© medido em dias (7, 14, 30 dias a taxas diferentes) e o tamanho do arquivo de sensores √© medido em anos (3, 5, 7 anos, respectivamente).  Portanto, para cada controlador dom√©stico inteligente, quando √© registrado na conta pessoal do usu√°rio, dois bancos de dados separados com diferentes pol√≠ticas de reten√ß√£o s√£o criados dentro do banco de dados de toque: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> <span class="hljs-string"><span class="hljs-string">"gateway_6774f85a_0a5b_4059_9b68_************_cameras"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DURATION</span></span> <span class="hljs-number"><span class="hljs-number">720</span></span>h SHARD <span class="hljs-keyword"><span class="hljs-keyword">DURATION</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>h; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> <span class="hljs-string"><span class="hljs-string">"gateway_6774f85a_0a5b_4059_9b68_************_sensors"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DURATION</span></span> <span class="hljs-number"><span class="hljs-number">61320</span></span>h SHARD <span class="hljs-keyword"><span class="hljs-keyword">DURATION</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span>h;</code> </pre><br>  O back-end do aplicativo cliente √© respons√°vel por criar, editar e excluir o banco de dados dentro do banco de dados de toque.  Por exemplo, se um usu√°rio dom√©stico inteligente na nuvem alterar a tarifa, o back-end envia os seguintes comandos para fazer altera√ß√µes na pol√≠tica de armazenamento: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RETENTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">POLICY</span></span> <span class="hljs-string"><span class="hljs-string">"autogen"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-string"><span class="hljs-string">"gateway_6774f85a_0a5b_4059_9b68_************_cameras"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DURATION</span></span> <span class="hljs-number"><span class="hljs-number">168</span></span>h SHARD <span class="hljs-keyword"><span class="hljs-keyword">DURATION</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>h;</code> </pre><br>  Ao remover o controlador dom√©stico inteligente da conta pessoal do usu√°rio, o back-end exclui os bancos de dados correspondentes: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> <span class="hljs-string"><span class="hljs-string">"gateway_6774f85a_0a5b_4059_9b68_************_cameras"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> <span class="hljs-string"><span class="hljs-string">"gateway_6774f85a_0a5b_4059_9b68_************_sensors"</span></span>;</code> </pre><br>  Ap√≥s o recebimento de uma mensagem informativa do controlador dom√©stico inteligente, o servidor de l√≥gica de neg√≥cios executa uma solicita√ß√£o para inserir dados no banco de dados de toque: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> device_20873eb0_dd5e_4213_a175_************,<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>=METER,label=Energy,units=kWh value_float=<span class="hljs-number"><span class="hljs-number">0.05</span></span> <span class="hljs-number"><span class="hljs-number">1572194550125</span></span>;</code> </pre><br>  Um exemplo de uma tabela com dados dos sensores Z-Wave para um controlador dom√©stico inteligente: <br><br><img src="https://habrastorage.org/webt/bc/ic/ht/bcicht3izpojrvpo2bsp2347p5w.png"><br><br>  Um dos recursos mais √∫teis de uma casa na nuvem √© o c√°lculo das estat√≠sticas com base nos dados recebidos.  O usu√°rio precisa saber a temperatura m√©dia na sala ou quanta eletricidade ele gasta por m√™s. <br><br>  A linguagem InfluxQL permite realizar consultas usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fun√ß√µes anal√≠ticas</a> .  Por exemplo, para calcular a temperatura m√©dia de uma semana, voc√™ precisa executar a seguinte consulta: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> MEAN(<span class="hljs-string"><span class="hljs-string">"value_float"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> device_63c660da_f0e8_4eca_8d5f_************ <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> label = <span class="hljs-string"><span class="hljs-string">'Temperature'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> &gt;= <span class="hljs-string"><span class="hljs-string">'2019-10-21T00:00:00.000Z'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> &lt;= <span class="hljs-string"><span class="hljs-string">'2019-10-27T23:59:59.999Z'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>d) fill(<span class="hljs-literal"><span class="hljs-literal">null</span></span>);</code> </pre><br>  Os resultados desta consulta s√£o mostrados na tabela: <br><br><img src="https://habrastorage.org/webt/ze/ac/wb/zeacwb7cqvnei_raajemgoebauq.png"><br><br>  No pr√≥ximo artigo, inteiramente dedicado ao aplicativo cliente, o c√°lculo das estat√≠sticas para v√°rios par√¢metros e a constru√ß√£o de tabelas e gr√°ficos baseados nele ser√£o examinados em detalhes. <br><br>  No sistema dom√©stico inteligente em nuvem, o InfluxDB DBMS √© implantado em uma m√°quina virtual em Yandex: Cloud com os seguintes par√¢metros: 4 n√∫cleos de vCPU com uma parcela garantida de 20%, 2 GB de RAM e 100 GB de disco r√≠gido.  De acordo com os c√°lculos dessa configura√ß√£o, √© suficiente armazenar dados de sensores de 3.000 c√¢meras IP e 5.000 sensores Z-Wave por 7 anos. <br><br><h2>  Conclus√£o </h2><br>  O artigo examinou a arquitetura de um servi√ßo de nuvem para uma casa inteligente, o algoritmo de um servidor de l√≥gica de neg√≥cios, a arquitetura de um servidor de m√≠dia para grava√ß√£o, armazenamento e reprodu√ß√£o de fluxos de m√≠dia de c√¢meras IP, bem como a arquitetura de um banco de dados de toque para armazenar e analisar dados de sensores dom√©sticos inteligentes.  O sistema de servi√ßo em nuvem funciona em servidores dedicados e virtuais, para maior estabilidade localizada em diferentes sites de hospedagem.  O sistema est√° atualmente em opera√ß√£o experimental. <br><br>  Quanto mais antigos os dados armazenados na nuvem, menos frequentemente o usu√°rio os acessa.  Na pr√≥xima vers√£o do servi√ßo de nuvem, prop√µe-se usar o mecanismo de redu√ß√£o de dados (ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">superamostragem</a> ) usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">as Consultas Cont√≠nuas do InfluxDB</a> para reduzir a quantidade de dados armazenados usando fun√ß√µes de agrega√ß√£o e, assim, aumentar a capacidade do banco de dados de toque. <br><br><img src="https://habrastorage.org/webt/4x/s-/jl/4xs-jlindsjesrddtgfb8nbstxu.png"><br><br>  Al√©m disso, na pr√≥xima vers√£o do servi√ßo em nuvem, um cluster de servidores de l√≥gica de neg√≥cios ser√° implementado de acordo com o princ√≠pio de um cluster de servidores de m√≠dia, discutido neste artigo.  A figura mostra a arquitetura desse cluster, em que v√°rios servidores de borda (cada um com um broker MQTT e um software de servidor de l√≥gica de neg√≥cios separados) enviam m√©tricas de desempenho ao servidor de origem, que calcula o endere√ßo IP do servidor menos carregado.  Isso permitir√° que voc√™ dimensione o sistema em maior medida e supere o limite existente de 1.000 resid√™ncias inteligentes. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt474700/">https://habr.com/ru/post/pt474700/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt474690/index.html">Criando um console com altura vari√°vel para um trabalho mais conveniente em um computador</a></li>
<li><a href="../pt474692/index.html">Revis√£o Skaffold para Kubernetes Development</a></li>
<li><a href="../pt474694/index.html">Como selecionamos e distorcemos a estrutura para teste de desempenho</a></li>
<li><a href="../pt474696/index.html">Bilhete de petr√≥leo ou Rosneft para o Desafio S√≠smico</a></li>
<li><a href="../pt474698/index.html">Usando janelas modais em interfaces com o usu√°rio</a></li>
<li><a href="../pt474702/index.html">Programa√ß√£o funcional do ponto de vista do EcmaScript. Fun√ß√µes puras, lambdas, imunidade</a></li>
<li><a href="../pt474704/index.html">Entrevista Playboy: Steve Jobs, Parte 2</a></li>
<li><a href="../pt474706/index.html">Algoritmo de Pesquisa Difusa do TextRadar - Abordagens b√°sicas</a></li>
<li><a href="../pt474708/index.html">A Internet est√° mais fragmentada do que nunca: de onde v√™m mais de um milh√£o de novos usu√°rios diariamente? Parte 1</a></li>
<li><a href="../pt474710/index.html">c.tech: Frontend Meetup # 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>