<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔤 👩🏿‍🤝‍👨🏻 ⚒️ 我们将事件处理速度提高到每秒160万个 🧕 ⚰️ 👬</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="当HighLoad ++参与者来到Alexander Krasheninnikov的报告时，他们希望听到每秒处理1,600,000个事件的信息。 期望没有实现。因为在准备性能期间，这个数字飞涨到了180万 -因此，在HighLoad ++上，现实超出了期望。 

 3年前，亚历山大（Alexande...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>我们将事件处理速度提高到每秒160万个</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/442616/"> 当<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">HighLoad ++</a>参与者来到<b>Alexander Krasheninnikov</b>的报告时，他们希望听到每秒处理1,600,000个事件的信息。 期望没有实现。因为在准备性能期间，这个数字飞涨到了<b>180万</b> -因此，在HighLoad ++上，现实超出了期望。 <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">3年前，亚历山大（Alexander）告诉</a>他们如何在Badoo建立可扩展的近实时事件处理系统。 从那时起，它不断发展，过程中数量不断增长，有必要解决缩放和容错问题，并且在某些时候需要采取根本措施- <b>技术堆栈</b>的<b>变化</b> 。 <br><br><img src="https://habrastorage.org/webt/q8/s-/cq/q8s-cqlxfrv8abkdotnudzeq1u8.jpeg"><br><br> 从解密中，您将学习在Badoo中如何用ClickHouse替换Spark + Hadoop捆绑软件，如何<b>节省3倍的硬件并增加6倍的负载</b> ，为什么以及通过什么方式收集项目中的统计信息以及如何处理这些数据。 <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/5KQsNmRTQmg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  <b>关于演讲者：</b> Alexander Krasheninnikov（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link">alexkrash</a> ） <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link">-Badoo</a>数据工程主管。 他从事BI基础架构，扩展工作负载，并管理构建数据处理基础架构的团队。 他喜欢分布式的所有内容：Hadoop，Spark，ClickHouse。 我确信可以从OpenSource准备出色的分布式系统。 <a name="habracut"></a><br><br><h2> 统计资料收集 </h2><br> 如果我们没有数据，那么我们将是盲目的，无法管理我们的项目。 这就是为什么我们需要统计信息- <strong>监视项目的可行性。</strong> 作为工程师，我们应该努力改进我们的产品，如果<strong>您要改进，请对其进行评估。</strong> 这是我工作的座右铭。 首先，我们的目标是业务收益。 统计数据<strong>提供业务问题的答案</strong> 。 技术指标是技术指标，但是企业也对指标感兴趣，因此也需要考虑它们。 <br><br><h2> 统计生命周期 </h2><br> 我将统计数据的生命周期定义为4点，我们将分别讨论每点。 <br><br><img src="https://habrastorage.org/webt/pp/kb/p5/ppkbp5uw_stwtzdgmakh9z_ffbw.jpeg"><br><br><h2> 定义阶段-形式化 </h2><br> 在应用程序中，我们收集了几个指标。 首先，这些是<strong>业务指标</strong> 。 例如，如果您有照片服务，您想知道每天，每小时，每秒上传多少张照片。 以下指标是<strong>“半技术性的”</strong> ：移动应用程序或站点的响应速度，API操作，用户与站点交互的速度，应用程序安装，UX。  <strong>跟踪用户行为</strong>是第三个重要指标。 这些系统类似于Google Analytics（分析）和Yandex.Metrics。 我们有自己的很酷的跟踪系统，我们在其中进行了大量投资。 <br><br> 在处理统计信息的过程中，涉及到许多用户-这些是开发人员和业务分析人员。 每个人都说相同的语言很重要，因此您需要同意。 <br><br><blockquote> 可以进行口头谈判，但是正式进行时（在清晰的事件结构中）会更好。 </blockquote><br>  <strong>正式的商业事件结构</strong>是当开发人员说出我们拥有多少注册时，分析师了解到，不仅为他提供了有关注册总数的信息，而且还提供了有关国家，性别和其他参数的信息。 所有这些信息都是正式的<strong>，对公司的所有用户都是公开的</strong> 。 该事件具有类型化的结构和形式描述。 例如，我们以<strong>协议缓冲区</strong>格式存储此信息。 <br><br> 事件“注册”的描述： <br><br><pre><code class="plaintext hljs">enum Gender { FEMALE = 1; MALE = 2; } message Registration { required int32 userid =1; required Gender usergender = 2; required int32 time =3; required int32 countryid =4; }</code> </pre> <br> 注册事件包含有关<strong>用户，字段，</strong>事件<strong>时间</strong>和用户注册<strong>国家/地区的信息</strong> 。 这些信息可供分析人员使用，并且将来，企业将了解我们收集的信息。 <br><br><h3> 为什么需要正式说明？ </h3><br>  <strong>对开发人员，分析师和产品部门而言，</strong>正式的描述是<strong>统一的。</strong> 然后，此信息会渗透到应用程序业务逻辑的描述中。 例如，我们有一个用于描述业务流程的内部系统，并且在其中有一个新功能的屏幕。 <br><br><img src="https://habrastorage.org/webt/qf/cv/hg/qfcvhgvo39rtidli5fxdq65hx2q.jpeg"><br><br> 在<strong>产品需求文档中，</strong>有一节包含说明，当用户以这种方式与应用程序交互时，我们必须发送具有完全相同参数的事件。 随后，我们将能够验证我们的功能运行状况以及对它们的正确测量。 正式的描述使我们可以进一步了解如何将这些数据保存在数据库中：NoSQL，SQL或其他。 我们有<strong>一个数据模式</strong> ，这很酷。 <br><br> 在某些作为服务提供的分析系统中，秘密存储中只有10-15个事件。 在我们国家，这个数字已经增长到1000多个，而且不会停止- <strong>没有一个登记册就无法生存</strong> 。 <br><br><h3> 定义阶段摘要 </h3><br> 我们认为<strong>统计-这很重要，</strong>并<strong>描述了某个主题领域</strong> -很好，您可以继续。 <br><br><h2> 收集阶段-数据收集 </h2><br> 我们决定构建该系统，以便在发生业务事件（例如注册，发送消息）时，在保存此信息的同时，我们分别发送特定的统计事件。 <br><br><blockquote> 在代码中，统计信息与业务事件同时发送。 </blockquote><br> 由于<strong>数据流通过单独的处理管道</strong> ，因此完全独立于应用程序在其中运行的数据存储进行<strong>处理。</strong> <br><br> 通过EDL描述： <br><br><pre> <code class="plaintext hljs">enum Gender { FEMALE = 1; MALE = 2; } message Registration { required int32 user_id =1; required Gender user_gender = 2; required int32 time =3; required int32 country_id =4; }</code> </pre> <br> 我们对注册事件进行了描述。  API是自动生成的，开发人员可以从代码中访问它，该代码只需4行即可发送统计信息。 <br><br> 基于EDL的API： <br><br><pre> <code class="plaintext hljs">\EDL\Event\Regist ration::create() -&gt;setUserId(100500) -&gt;setGender(Gender: :MALE) -&gt;setTime(time()) -&gt;send();</code> </pre> <br><h3> 活动交付 </h3><br> 这是我们的外部系统。 我们之所以这样做，是因为我们拥有令人难以置信的服务，它们提供了用于处理照片数据以及其他内容的API。 它们都将数据存储在很棒的新型数据库中，例如Aerospike和CockroachDB。 <br><br> 当您需要建立某种类型的报告时，您不必战斗：“伙计，您有多少，有多少？”  -所有数据以单独的流发送。 加工输送机-外部系统。 从应用程序上下文中，我们从业务逻辑存储库中解开所有数据，并将其进一步发送到单独的管道。 <br><br> 收集阶段假定应用程序服务器可用。 我们有这个PHP。 <br><br><img src="https://habrastorage.org/webt/az/vo/va/azvova-esx681etff8drvvkigeq.gif"><br><br><h3> 交通运输 </h3><br> 这是一个子系统，它使我们可以将在应用程序上下文中执行的操作发送到另一个管道。 仅根据您的需求选择运输，具体取决于项目的情况。 <br><br> 运输具有特点，首先是<strong>交货保证。</strong> 传输的特征：至少一次，完全一次，您可以根据这些数据的重要性来选择任务的统计信息。 例如，对于计费系统，统计信息显示的交易数量超过了实际数量，这是不可接受的-这就是金钱，这是不可能的。 <br><br> 第二个参数是<strong>编程语言的绑定。</strong> 我们必须以某种方式与运输交互，因此要根据编写项目的语言选择运输。 <br><br> 第三个参数是<strong>可伸缩性。</strong> 由于我们正在谈论每秒数百万个事件，因此牢记未来的可伸缩性将是一件很不错的事情。 <br><br> 有许多传输选项：RDBMS应用程序，Flume，Kafka或LSD。 我们使用<strong>LSD-</strong>这是我们的特殊方式。 <br><br><h3> 直播流守护程序 </h3><br>  LSD与禁用物质无关。 这是一个<strong>活泼，非常快速的流式守护进程</strong> ，它不提供任何代理来写入该<strong>守护进程</strong> 。 我们可以调整它，并<strong>与其他系统集成</strong> ：HDFS，Kafka-我们可以重新排列发送的数据。  LSD在INSERT上没有网络调用，您可以在其中控制网络拓扑。 <br><br> 最重要的是，这是<strong>Badoo的OpenSource-</strong>没有理由不信任该软件。 <br><br> 如果这是一个完美的恶魔，那么我们将在每次会议上讨论LSD，而不是Kafka，但是每一个LSD都有美中不足。 我们有适合自己的局限性：我们<strong>在LSD中没有复制支持，</strong>并且<strong>至少有一次</strong>交付保证。 另外，对于货币交易而言，这不是最合适的传输方式，但是您通常需要专门通过支持<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ACID的</a> “酸性”数据库与货币进行通信。 <br><br><h3> 收集阶段摘要 </h3><br> 基于上一个系列的结果，我们收到了<strong>对</strong>数据的<strong>正式描述</strong> ，并从中<strong>为事件调度程序</strong>生成了一个出色，便捷的<strong>API</strong> ，并弄清楚了如何<strong>将</strong>这些数据<strong>从应用程序上下文</strong> <strong>传输</strong> <strong>到单独的管道</strong> 。 已经不错，我们正在进入下一阶段。 <br><br><h2> 阶段处理-数据处理 </h2><br> 我们从注册，上传的照片，民意调查中收集数据-怎么做？ 从这些数据中，我们希望获得具有悠久历史和<strong>原始数据的</strong> <strong>图表</strong> 。 图表可以理解所有内容-您无需成为开发人员即可从曲线上了解公司的收入正在增长。 我们将原始数据用于在线报告和临时。 对于更复杂的情况，我们的分析师希望对此数据执行分析查询。 该功能和该功能对于我们都是必需的。 <br><br><h3> 图表 </h3><br> 图表有多种形式。 <br><br><img src="https://habrastorage.org/webt/hu/c7/ap/huc7apcxpcajxhc5k3an8ken4wk.jpeg"><br><br> 或者，例如，具有历史记录的图表显示10年的数据。 <br><br><img src="https://habrastorage.org/webt/cq/_z/pc/cq_zpcmcbe2b_nipvwhbtnkme94.jpeg"><br><br> 图表甚至是这样。 <br><br><img src="https://habrastorage.org/webt/rs/76/eg/rs76eg23gglv8m1xlaby2gr8vzg.jpeg"><br><br> 这是一些AB测试的结果，令人惊讶地类似于纽约的克莱斯勒大楼。 <br><br> 绘制图形有两种方法： <strong>查询原始数据</strong>和<strong>时间序列</strong> 。 两种方法都有缺点和优点，我们将不对其进行详细介绍。 我们使用一种<strong>混合方法</strong> ：从原始数据中获取简短信息用于运营报告，从时间序列中获取长期存储信息。 第二个是从第一个开始计算的。 <br><br><h3> 我们如何发展到每秒180万个事件 </h3><br> 这是一个漫长的故事-一天不会发生数百万个RPS。  Badoo是一家拥有十年历史的公司，可以说数据处理系统随着公司的发展而发展。 <br><br><img src="https://habrastorage.org/webt/av/o3/04/avo304ko07jkl4szc5dnz2x7zc8.jpeg"><br><br> 起初我们什么都没有。 我们开始收集数据- <strong>每秒</strong>发现<strong>5,000个事件。</strong> 一台MySQL主机，别无其他！ 任何关系型DBMS都可以完成此任务，并且对它很满意：您将具有事务性-放置数据，接收来自它的请求-一切工作都很好。 所以我们住了一段时间。 <br><br> 在某个时候，功能分片发生了：注册数据-在这里，关于照片-在那儿。 因此，我们<strong>每秒</strong>最多可以处理<strong>200,000个事件，</strong>并开始使用各种组合方法：不存储原始数据，而是存储<strong>聚合</strong>数据，但到目前为止存储在关系数据库中。 我们存储计数器，但是大多数关系数据库的本质是无法对数据执行<strong>DISTINCT查询</strong> -计数器的代数模型不允许计算DISTINCT。 <br><br> 在Badoo，我们的座右铭是<strong>“不可阻挡的力量”</strong> 。 我们不会停下来并进一步发展。 当我们超过<strong>每秒200,000个事件</strong>的阈值时，我们决定创建一个正式的描述，我在上面已经谈到过。 在此之前，这里有些混乱，现在我们有了一个结构化的事件记录器：我们开始扩展系统， <strong>连接Hadoop</strong> ，所有数据都放入<strong>Hive表中。</strong> <br><br>  Hadoop是一个巨大的软件包，文件系统。 对于分布式计算，Hadoop说：“将数据放在此处，我将让您对它们执行分析查询。” 因此，我们做到了- <strong>为所有图表</strong>编写了<strong>常规计算</strong> -结果很好。 但是，图表在快速更新时很有价值-每天一次，观看图表更新并不是那么有趣。 如果我们推出的产品导致生产中出现致命错误，我们希望图表立即下降，而不是隔天下降。 因此，一段时间后，整个系统开始降级。 但是，我们意识到，在此阶段，您可以坚持使用选定的技术堆栈。 <br><br><blockquote> 对我们来说，Java是新的，我们喜欢它，并且我们理解可以采取不同的方法。 </blockquote><br> 在<strong>每秒</strong> 400,000到<strong>800,000个事件</strong>的阶段，我们以最纯粹的形式替换了Hadoop，而Hive作为<strong>Spark</strong>查询上的分析查询的执行者，编写了<strong>通用的map / reduce</strong>和增量计算指标。  3年前，我<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">告诉</a>我们如何做到的。 然后在我们看来，Spark将会永远存在，但是生命却以其他方式降低-我们遇到了Hadoop的局限性。 也许如果我们有其他条件，我们将继续使用Hadoop。 <br><br> 除了在Hadoop上计算图形外，另一个问题是由分析人员驱动的令人难以置信的四层SQL查询，并且图形没有快速更新。 事实是，操作数据处理工作相当棘手，因此它是实时，快速和酷炫的。 <br><br>  Badoo由位于大西洋两侧的两个数据中心提供服务，分别位于欧洲和北美。 要建立统一的报告，您需要将数据从美国发送到欧洲。 我们保留所有统计数据统计信息在欧洲数据中心中，因为它具有更大的计算能力。 数据中心之间<strong>的往返</strong>时间约为<strong>200毫秒</strong> -网络非常精密-向另一个DC发出请求与前往下一个机架并不相同。 <br><br> 当我们开始正式化事件并开发人员，并且产品经理参与其中时，每个人都喜欢一切- <strong>事件爆炸性增长</strong> 。 现在是时候在集群中购买铁了，但是我们并不是真的想要这样做。 <br><br> 当我们超过了<strong>每秒800,000个事件</strong>的峰值时，我们发现了Yandex上传到OpenSource <strong>ClickHouse的内容</strong> ，并决定尝试一下。 当他们尝试做某事时， <strong>他们装满了圆锥形的火车，</strong>结果，当一切正常的时候，他们举办了一次小型自助招待会，招待了前100万场活动。  ClickHouse可能已经完成了报告。 <br><br><blockquote> 只需使用ClickHouse并与其一起生活。 </blockquote><br> 但这并不有趣，因此我们将继续谈论数据处理。 <br><br><h3>  Clickhouse </h3><br>  ClickHouse是最近两年的一次大肆宣传，无需介绍：仅在2018年的HighLoad ++上，我记得<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">有关该报告的五份报告</a>以及研讨会和会议。 <br><br> 该工具旨在准确解决我们为自己设置的那些任务。 我们一次从Hadoop接收<strong>实时更新</strong>和芯片：复制，分片。 没有理由不尝试ClickHouse，因为他们知道通过Hadoop实施，我们已经触底。 该工具很棒，文档通常都很火爆-我自己写在那里，我真的很喜欢一切，而且一切都很棒。 但是我们必须解决许多问题。 <br><br>  <strong>如何在ClickHouse中转移事件的整个流程？</strong>  <strong>如何合并来自两个数据中心的数据？</strong> 从我们来到管理员那里说：“伙计们，让我们安装ClickHouse”的事实来看，他们不会使网络厚两倍，而延迟却是原来的一半。 不，网络仍然像第一笔薪金一样薄。 <br><br>  <strong>如何存储结果</strong> ？ 在Hadoop，我们了解如何绘制图形-但是如何在神奇的ClickHouse上进行绘制？ 不包括魔术棒。  <strong>如何将结果传递</strong>到时间序列存储？ <br><br> 正如我在该研究所的讲师所说的那样，请考虑3种数据方案：战略，逻辑和物理方案。 <br><br><h4> 战略存储方案 </h4><br> 我们有<strong>2个数据中心</strong> 。 我们了解到ClickHouse对DC一无所知，我们只是在每个DC中弹出集群。 现在， <strong>数据不再通过跨大西洋电缆移动</strong> -DC中发生的所有数据都本地存储在其群集中。 例如，当我们要请求合并的数据时，要找出两个DC中有多少注册，ClickHouse会给我们这个机会。 低延迟和低可用性的请求-只是一个杰作！ <br><br><img src="https://habrastorage.org/webt/mr/dc/-2/mrdc-205rzloz1c2oemavnikcxu.jpeg"><br><br><h4> 物理存储方案 </h4><br> 再次提出问题：我们的数据将如何落入ClickHouse关系模型中，应如何做才能避免丢失复制和分片？  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ClickHouse文档中对</a>所有内容进行了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">详尽的描述</a> ，如果您拥有多个服务器，则会遇到本文。 因此，我们将不深入研究手册中的内容：对分片上所有数据的复制，分片和查询。 <br><br><h4> 储存逻辑 </h4><br> 逻辑图是最有趣的。 在一个管道中，我们处理异构事件。 这意味着我们有<strong>各种各样的事件</strong> ：注册，语音，照片上传，技术指标，跟踪用户行为-所有这些事件具有完全<strong>不同的属性</strong> 。 例如，我看着手机上的屏幕-我需要一个屏幕ID，我为某人投票-您需要了解该投票是赞成还是反对。 所有这些事件都具有不同的属性，在它们上绘制了不同的图形，但是所有这些事件必须在单个管道中进行处理。 如何将其放入ClickHouse模型中？ <br><br>  <strong>方法1-每个事件表。</strong> 我们从MySQL的经验中推断出第一种方法-我们<strong>为</strong> ClickHouse中的<strong>每个事件</strong>创建了一个<strong>平板电脑</strong> 。 听起来很合逻辑，但是我们遇到了许多困难。 <br><br> 我们没有限制，当今天的版本发布时，事件将改变其结构。 任何开发人员都可以完成此补丁。 该方案通常在各个方向上都是可变的。 唯一<strong>必需的字段</strong>是<strong>时间戳记事件</strong>和事件的名称。 其他所有内容都会随时更改，因此，需要修改这些标牌。  ClickHouse可以<strong>在群集上</strong>执行<strong>ALTER的功能</strong> ，但这是一个微妙的微妙过程，很难使其自动化以使其平稳运行。 因此，这是一个负号。 <br><br> 我们有超过一千个不同的事件，这使我们<strong>每台机器的插入率很高</strong> -我们将所有数据不断记录在一千个表中。 对于ClickHouse，这是一种反模式。 如果百事可乐的口号是“大口活”，那么ClickHouse- <strong>“大口活”。</strong> 如果不这样做，那么复制将被阻塞，ClickHouse拒绝接受新的插入-令人不快的方案。 <br><br>  <strong>方法2-宽桌</strong> 。 西伯利亚人试图将电锯滑到轨道上，并应用其他数据模型。 我们创建一个包含<strong>一千列的表</strong> ，其中每个事件都有为其数据保留的列。 我们得到了一个庞大的<strong>稀疏表</strong> -幸运的是，这并没有超出开发环境，因为从最初的插入开始就可以清楚地看出该方案绝对是不好的，我们不会这样做。 <br><br> 但是我仍然想使用这样一个很酷的软件产品，还有一点要完成-这将是您所需要的。 <br><br>  <strong>方法3-通用表。</strong> 我们有一个巨大的表，其中将数据存储在数组中，因为ClickHouse支持<strong>非标量数据类型</strong> 。 也就是说，我们从存储属性名称的列开始，到具有存储属性值的数组的单独列开始。 <br><br><img src="https://habrastorage.org/webt/ot/s3/ro/ots3ronbcjh69ssxujqvbuxeghc.jpeg"><br><br>  ClickHouse在这里可以很好地执行任务。 如果只需要插入数据，则在当前安装中可能会再挤出10次。 <br><br> 然而，美中不足的是，它也是ClickHouse的反模式- <strong>存储字符串数组</strong> 。 这是不好的，因为行阵列<strong>占用更多的磁盘空间</strong> -它们的收缩比简单的列更糟，并且<strong>更难处理</strong> 。 但是对于我们的任务，由于优势胜过，我们对此视而不见。 <br><br> 如何从这样的表进行SELECT？ 我们的任务是对按性别分组的注册进行计数。 首先，您需要在一个数组中找到对应于性别列的位置，然后使用该索引爬到另一列中并获取数据。 <br><br><img src="https://habrastorage.org/webt/gh/pw/ek/ghpwekgjjrr0eisi8_zjmoi48tk.jpeg"><br><br><h4> 如何在此数据上绘制图形 </h4><br> 由于描述了所有事件，因此它们具有严格的结构，我们针对每种事件类型形成一个四层的SQL查询，执行该查询并将结果保存到另一个表中。 <br><br> 问题是要在图形上绘制两个相邻的点，您需要<strong>扫描整个表格</strong> 。 示例：我们每天查看一次注册。 此事件是从顶线到倒数第二个。 扫描一次-非常好。  5分钟后，我们想在图表上绘制一个新点-再次，我们扫描与上一次扫描相交的数据范围，依此类推，针对每个事件。 听起来合乎逻辑，但看起来并不好。 <br><br> 另外，当我们走几行时，我们还需要<strong>读取aggregation下的结果</strong> 。 例如，有一个事实，就是上帝的仆人在斯堪的那维亚注册并且是一个男人，我们需要计算摘要统计数据：多少个注册，多少个男人，其中有多少人是多少，以及有多少来自挪威。 用分析数据库<strong>ROLLUP，CUBE</strong>和<strong>GROUPING SETS</strong>来称呼-将一行变成几行。 <br><br><h4> 怎么治疗 </h4><br> 幸运的是，ClickHouse有一个工具可以解决此问题，即<strong>聚合函数</strong>的<strong>序列化状态</strong> 。 这意味着您可以一次扫描一条数据并保存这些结果。 这是一个<strong>杀手级功能</strong> 。  3年前，我们正是在Spark和Hadoop上做到了这一点，很酷的是，与我们并行的是，Yandex最好的头脑在ClickHouse中实现了一个模拟。 <br><br><h4> 要求缓慢 </h4><br> 我们的要求很慢-要计算今天和昨天的唯一身份用户。 <br><br><pre> <code class="plaintext hljs">SELECT uniq(user_id) FROM table WHERE dt IN (today(), yesterday())</code> </pre> <br> 在物理平面中，我们可以对昨天的状态进行SELECT，获取其二进制表示形式，并将其保存在某个位置。 <br><br><pre> <code class="plaintext hljs">SELECT uniq(user_id), 'xxx' AS ts, uniqState(user id) AS state FROM table WHERE dt IN (today(), yesterday())</code> </pre> <br> 对于今天，我们只是更改今天的条件： <code>'yyy' AS ts</code>而<code>WHERE dt = today()</code>和时间戳，我们将其称为“ xxx”和“ yyy”。            ,        ,    2 . <br><br><pre> <code class="plaintext hljs">SELECT uniqMerge(state) FROM ageagate_table WHERE ts IN ('xxx', 'yyy')</code> </pre> <br><h4>   </h4><br>  : <br><br><ul><li>    ,       ; </li><li>       ; </li><li>  . </li></ul><br>         ,   -      .     <strong>    </strong> .    ,     ,  ,   ,       ClickHouse,  : «,      ! ,    !» <br><br><h4>     </h4><br>   ,      ,    .      <strong>  ,</strong>          .    .    —     SQL-,       . ,        ,      . <br><br><img src="https://habrastorage.org/webt/df/0b/o6/df0bo6pb7l6t94sxnrwtpctfcxk.jpeg"><br><br>     ,   -  time series.      :      ,  ,      ,    time series. <br><br>   time series    :   ,    ,    timestamp       .        ,    ,    .              .   ,        ,       ,      —  ,    . ,     ,   ClickHouse  -,     ,     . <br><br>      ,       ,      ClickHouse: <br><br><blockquote> —    « »,    —      . </blockquote><br>     time series  2 ,     20   20-80 .   .  ClickHouse   <strong>GraphiteMergeTree</strong> ,    time series,      . <br><br><h4>    </h4><br> <strong>8  ClickHouse</strong> ,   6  -  ,  2  :    2 —     ,    . <strong>  1.8 .   </strong>  ,     <strong>500</strong> <strong>   </strong> . ,   1,8 ,       500 !       . <br><br><h3>    Hadoop </h3><br> <strong>   2 </strong> .          .     <strong>3 </strong> ,   CPU —  <strong>4</strong> .  ,        . <br><br><h3>   Process </h3><br>     <strong>   </strong> , ,   ,        .   ,    ,    ClickHouse    3 000   . ,  ,   ,      overkill. <br><br>   ,   ,     .   ClickHouse,   <strong>   </strong> . ,  ,   ,    .   ,  8      3–4     .  —     . <br><br><h2>  Present —    </h2><br>      ,     ?   time series,     <strong>  time series</strong> ,           ,   ,   . <br><br><img src="https://habrastorage.org/webt/82/uo/qq/82uoqq4jw6amtxph_jgcjpjnwkm.jpeg"><br><br> <strong>Drop Detect —    SQL</strong> :  SQL-    ,     ,      . <br><br><img src="https://habrastorage.org/webt/ru/1v/up/ru1vuporiqj-suncjyc-sh06xrk.jpeg"><br><br>     <strong>Anomaly Detection</strong> —      .    ,  ,       2%   ,    —   40,    ,     ,        ,    . <br><br>    —   ,  ,   - ,    Anomaly Detection. <br><br><h3> Anomaly Detection </h3><br>  ,   time series .    : ,  ,    .   time series     <strong></strong> .  ,       ,  .    ,   <strong>drop detection</strong> —       ,  . <br><br>     UI. <br><br><img src="https://habrastorage.org/webt/sk/mg/hn/skmghn7mirsubwu-vpm2dq5tols.jpeg"><br><br>    .  -  ,       —  .    -,  . <br><br><h3>   Present </h3><br>    ,      ,     <strong> </strong> .     <strong> </strong>    ,   :     1000 — alarm,     0 — alarm.    . <br><br>   <strong>Anomaly Detection</strong>    ,    .    Anomaly Detection     <strong>Exasol</strong> ,        ClickHouse.        Anomaly Detection  2 ,   . <br><br><h2>   </h2><br>  ,  ,  4    . <br><br>  , <strong>  </strong>  ,     ,     .  , <strong>    </strong> ,      . ,  <strong>    </strong> <strong> </strong> . <br><br><blockquote>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">HighLoad++</a>  ,    HighLoad++    -       .        ,        , <strong>    </strong> :) <br><br>  ,    <u><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">PHP Russia</a></u> ,  ,       .  , ,   ,      1,8 /,     ,      1 . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN442616/">https://habr.com/ru/post/zh-CN442616/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN442606/index.html">龙目岛域对象：战斗经典</a></li>
<li><a href="../zh-CN442608/index.html">QuadrigaCX加密货币交易所的创建者去世的钱包被证明是空的</a></li>
<li><a href="../zh-CN442610/index.html">电报机器人+ Google Analytics</a></li>
<li><a href="../zh-CN442612/index.html">电子棋盘游戏的纸板引擎。 我们如何使其更接近现实</a></li>
<li><a href="../zh-CN442614/index.html">在Kubernetes上使用Jenkins的CI / CD</a></li>
<li><a href="../zh-CN442618/index.html">不用于自拍：使用嵌入在智能手机中的新芯片进行数字酶联免疫吸附测定</a></li>
<li><a href="../zh-CN442620/index.html">IT监控中的机器学习</a></li>
<li><a href="../zh-CN442622/index.html">如何在Unity中使协程更加方便</a></li>
<li><a href="../zh-CN442624/index.html">《完美算法》一书。 基础知识</a></li>
<li><a href="../zh-CN442626/index.html">Habraiting：在Habra标头示例上构建俄语单词云</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>