<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçá üç† üôãüèª D√©velopper un utilitaire sur GraalVM üà∫ üíú ü¶Ä</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="√ânonc√© du probl√®me 


 P√©riodiquement, j'ai pour t√¢che de partager des fichiers sur un r√©seau local, par exemple, avec un coll√®gue de projet. 


 Il p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>D√©velopper un utilitaire sur GraalVM</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451574/"><h2 id="postanovka-zadachi">  √ânonc√© du probl√®me </h2><br><p> P√©riodiquement, j'ai pour t√¢che de partager des fichiers sur un r√©seau local, par exemple, avec un coll√®gue de projet. </p><br><p>  Il peut y avoir de nombreuses solutions pour cela - Samba / FTP / scp.  Vous pouvez simplement t√©l√©charger le fichier dans un lieu public comme Google Drive, le joindre √† une t√¢che dans Jira ou m√™me l'envoyer par e-mail. </p><br><p>  Mais tout cela, √† un degr√© ou √† un autre, est inflexible, quelque part il n√©cessite un ajustement pr√©liminaire et a ses propres limites (par exemple, la taille maximale de l'investissement). </p><br><p>  Et vous voulez quelque chose de plus l√©ger et flexible. </p><br><p>  J'ai toujours √©t√© agr√©ablement surpris par l'opportunit√© sous Linux, en utilisant les moyens disponibles, de construire rapidement une solution pratique. </p><br><p>  Disons, j'ai souvent r√©solu la t√¢che susmentionn√©e en utilisant le syst√®me python avec la ligne unique suivante </p><br><pre><code class="bash hljs">$ python3 -mhttp.server Serving HTTP on 0.0.0.0 port 8000 ...</code> </pre> <br><p>  Cette commande d√©marre le serveur Web dans le dossier actuel et vous permet d'obtenir une liste de fichiers et de les t√©l√©charger via l'interface Web.  Plus de ces choses peuvent √™tre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vid√©es ici</a> . </p><a name="habracut"></a><br><p>  Il y a plusieurs inconv√©nients.  Maintenant, afin de transf√©rer le lien de t√©l√©chargement √† un coll√®gue, vous devez conna√Ætre votre adresse IP sur le r√©seau. </p><br><p>  Il est pratique d'utiliser la commande </p><br><pre> <code class="bash hljs">$ ifconfig -a</code> </pre> <br><p>  Et puis dans la liste r√©sultante des interfaces r√©seau, s√©lectionnez celle qui convient et composez manuellement un lien de la forme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http: // IP: 8000</a> , que vous pouvez envoyer. </p><br><p>  Deuxi√®me inconv√©nient: ce serveur est mono-thread.  Cela signifie que si l'un de vos coll√®gues t√©l√©charge le fichier, le second ne pourra m√™me pas t√©l√©charger la liste des fichiers. </p><br><p>  Troisi√®mement, c'est inflexible.  Si vous devez transf√©rer un seul fichier, il ouvrira le dossier entier, c'est-√†-dire  vous devrez effectuer de tels gestes (puis nettoyer la corbeille): </p><br><pre> <code class="bash hljs">$ mkdir tmp1 $ cp file.zip tmp1 $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> tmp1 $ python3 -mhttp.server</code> </pre> <br><p>  Le quatri√®me inconv√©nient - il n'y a pas de moyen <em>facile</em> de t√©l√©charger l'int√©gralit√© du contenu d'un dossier. </p><br><p>  Pour transf√©rer le contenu d'un dossier, ils utilisent g√©n√©ralement une technique appel√©e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tar pipe</a> . </p><br><p>  Ils font quelque chose comme √ßa: </p><br><pre> <code class="bash hljs">$ ssh user@host <span class="hljs-string"><span class="hljs-string">'cd /path/to/source &amp;&amp; tar cf - .'</span></span> | <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /path/to/destination &amp;&amp; tar xvf -</code> </pre> <br><p>  Si du coup ce n'est pas clair, je vais vous expliquer comment √ßa marche.  La premi√®re partie de la commande <code>tar cf - .</code>  cr√©e une archive du contenu du dossier actuel et √©crit sur la sortie standard.  En outre, cette sortie est transmise via un tuyau via un canal ssh s√©curis√© √† l'entr√©e d'une <code>tar xvf -</code> similaire <code>tar xvf -</code> qui effectue la proc√©dure inverse, c'est-√†-dire  lit l'entr√©e standard et d√©compresse le dossier actuel.  En fait, l'archive de fichiers est transf√©r√©e, mais sans cr√©er de fichier interm√©diaire! </p><br><p>  L'inconv√©nient de cette approche est √©galement √©vident.  Nous avons besoin d'un acc√®s ssh d'une machine √† l'autre, et cela n'est presque jamais fait dans le cas g√©n√©ral. </p><br><p>  Est-il possible de r√©aliser tout ce qui pr√©c√®de, mais sans ces probl√®mes d√©crits? </p><br><p>  Il est donc temps de formaliser ce que nous allons construire: </p><br><ol><li>  Programme facile √† installer (binaire statique) </li><li>  Ce qui vous permettra de transf√©rer √† la fois un fichier et un dossier avec tout le contenu </li><li>  Avec compression en option </li><li>  Ce qui permet √† l'h√¥te de t√©l√©charger le (s) fichier (s) en utilisant uniquement les outils * nix standard (wget / curl / tar) </li><li>  Le programme √©mettra imm√©diatement apr√®s le lancement les commandes exactes √† t√©l√©charger </li></ol><br><h2 id="reshenie">  Solution </h2><br><p>  Lors de la conf√©rence <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">JEEConf</a> , √† laquelle j'ai assist√© il n'y a pas si longtemps, le sujet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Graal a</a> √©t√© soulev√© √† plusieurs reprises.  Le sujet est loin d'√™tre nouveau, mais pour moi c'√©tait un d√©clencheur pour enfin sentir cette b√™te de ma propre main. </p><br><p>  Pour ceux qui ne sont pas encore dans le sujet (y a-t-il vraiment une telle chose encore? OO), permettez-moi de vous rappeler que GraalVM est une telle machine virtuelle Java d'Oracle avec des fonctionnalit√©s suppl√©mentaires, dont les plus notables sont: </p><br><ol><li>  Polyglot JVM - la possibilit√© d'ex√©cuter de mani√®re transparente Java, Javascript, Python, Ruby, R, etc.  code </li><li>  Prise en charge de la compilation AOT - compilation de Java directement dans le binaire natif </li><li>  Une caract√©ristique moins visible, mais tr√®s cool - le compilateur C2 a √©t√© r√©√©crit de C ++ √† Java afin de faciliter son d√©veloppement ult√©rieur.  Cela a d√©j√† produit des r√©sultats notables.  Ce compilateur fait beaucoup plus d'optimisations au stade de la conversion du bytecode Java en code natif.  Par exemple, il est capable d'√©liminer plus efficacement les allocations.  Twitter a pu r√©duire la consommation de CPU de 11% simplement en activant ce param√®tre, ce qui, √† leur √©chelle, a permis une √©conomie notable de ressources (et d'argent). </li></ol><br><p>  Vous pouvez rafra√Æchir l'id√©e de Graal, par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dans cet article habr</a> . </p><br><p>  Nous allons √©crire en Java, donc pour nous la fonctionnalit√© la plus pertinente sera la compilation AOT. </p><br><p>  En fait, le r√©sultat du d√©veloppement est pr√©sent√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dans ce r√©f√©rentiel Github</a> . </p><br><p>  Exemple d'utilisation pour transf√©rer un seul fichier: </p><br><pre> <code class="bash hljs">$ serv <span class="hljs-string"><span class="hljs-string">'/path/to/report.pdf'</span></span> To download the file please use one of the commands below: curl http://192.168.0.179:17777/dl &gt; <span class="hljs-string"><span class="hljs-string">'report.pdf'</span></span> wget -O- http://192.168.0.179:17777/dl &gt; <span class="hljs-string"><span class="hljs-string">'report.pdf'</span></span> curl http://192.168.0.179:17777/dl?z --compressed &gt; <span class="hljs-string"><span class="hljs-string">'report.pdf'</span></span> wget -O- http://192.168.0.179:17777/dl?z | gunzip &gt; <span class="hljs-string"><span class="hljs-string">'report.pdf'</span></span></code> </pre> <br><p>  Un exemple d'utilisation lors du transfert du contenu d'un dossier (tous les fichiers, y compris les fichiers joints!): </p><br><pre> <code class="bash hljs">$ serv <span class="hljs-string"><span class="hljs-string">'/path/to/folder'</span></span> To download the files please use one of the commands below. NB! All files will be placed into current folder! curl http://192.168.0.179:17777/dl | tar -xvf - wget -O- http://192.168.0.179:17777/dl | tar -xvf - curl http://192.168.0.179:17777/dl?z | tar -xzvf - wget -O- http://192.168.0.179:17777/dl?z | tar -xzvf -</code> </pre> <br><p>  Oui, si simple! </p><br><p>  Veuillez noter - le programme lui-m√™me d√©termine l'adresse IP correcte √† laquelle les fichiers seront disponibles pour t√©l√©chargement. </p><br><h2 id="nablyudeniya--razmyshleniya">  Observations / R√©flexions </h2><br><p>  Il est clair que l'un des objectifs de la cr√©ation du programme √©tait sa compacit√©.  Et voici le r√©sultat obtenu: </p><br><pre> <code class="bash hljs">$ du -hs `<span class="hljs-built_in"><span class="hljs-built_in">which</span></span> serv` 2.4M /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/serv</code> </pre> <br><p>  Incroyablement, l'ensemble de la JVM, avec le code de l'application, tient dans quelques mis√©rables m√©gaoctets!  Bien s√ªr, tout est quelque peu faux, mais nous en reparlerons plus tard. </p><br><p>  En fait, le compilateur Graal produit un binaire l√©g√®rement sup√©rieur √† 7 m√©gaoctets.  J'ai d√©cid√© de le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">compresser</a> davantage <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">avec l'UPX</a> . </p><br><p>  Cela s'est av√©r√© √™tre une bonne id√©e, car le temps de lancement a augment√© alors qu'il √©tait tr√®s insignifiant: </p><br><p>  Option non compress√©e: </p><br><pre> <code class="bash hljs">$ time ./build/com.cmlteam.serv.serv -v 0.1 real 0m0.001s user 0m0.001s sys 0m0.000s</code> </pre> <br><p>  Compress√©: </p><br><pre> <code class="bash hljs">$ time ./build/serv -v 0.1 real 0m0.021s user 0m0.021s sys 0m0.000s</code> </pre> <br><p>  A titre de comparaison, l'heure de lancement de la "mani√®re traditionnelle": </p><br><pre> <code class="bash hljs">$ time java -cp <span class="hljs-string"><span class="hljs-string">"/home/xonix/proj/serv/target/classes:/home/xonix/.m2/repository/commons-cli/commons-cli/1.4/commons-cli-1.4.jar:/home/xonix/.m2/repository/org/apache/commons/commons-compress/1.18/commons-compress-1.18.jar"</span></span> com.cmlteam.serv.Serv -v 0.1 real 0m0.040s user 0m0.030s sys 0m0.019s</code> </pre> <br><p>  Comme vous pouvez le voir, deux fois plus lent que la version UPX. </p><br><p>  En g√©n√©ral, un temps de d√©marrage court est l'un des points forts de GraalVM.  Ceci, ainsi que la faible consommation de m√©moire, conduisent √† un enthousiasme significatif autour de l'utilisation de cette technologie pour les microservices et sans serveur. </p><br><p>  J'ai essay√© de rendre la logique du programme aussi minimale que possible et d'utiliser un minimum de biblioth√®ques.  En principe, cette approche est g√©n√©ralement justifi√©e, et dans ce cas, je craignais que l'ajout de d√©pendances Maven tierces ¬´alourdit¬ª consid√©rablement le fichier de programme r√©sultant. </p><br><p>  Par exemple, c'est pourquoi je n'ai pas utilis√© de d√©pendance tierce pour le serveur Web Java (et il y en a beaucoup pour tous les go√ªts et toutes les couleurs), mais j'ai utilis√© l'impl√©mentation JDK du serveur Web √† partir du package <code>com.sun.net.httpserver.*</code> .  En fait, l'utilisation du package <code>com.sun.*</code> Est consid√©r√©e comme une <code>com.sun.*</code> , mais j'ai consid√©r√© cela comme autoris√© dans ce cas, car je compile en code natif, et donc, il n'est pas question de compatibilit√© entre la JVM. </p><br><p>  Cependant, mes craintes √©taient compl√®tement vaines.  Dans le programme, j'ai utilis√© deux d√©pendances pour plus de commodit√© </p><br><ol><li>  <code>commons-cli</code> - pour analyser les arguments de la ligne de commande </li><li>  <code>commons-compress</code> - pour g√©n√©rer une archive tar de dossier et une compression gzip facultative </li></ol><br><p>  Dans le m√™me temps, la taille du fichier a tr√®s l√©g√®rement augment√©.  Je vais oser sugg√©rer que le compilateur Graal est tr√®s intelligent de ne pas mettre tous les jar-nicks de plug-in dans le fichier ex√©cutable, mais uniquement le code d'eux qui est r√©ellement utilis√© par le code de l'application. </p><br><p>  La compilation en code Graal natif est effectu√©e par l'utilitaire d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">image native</a> .  Il convient de mentionner que ce processus est gourmand en ressources.  Disons que sur ma configuration pas si lente avec un processeur Intel 7700K √† bord, ce processus prend 19 secondes.  Par cons√©quent, je recommande que lors du d√©veloppement, ex√©cutez le programme comme d'habitude (via java) et r√©cup√©rez le binaire au stade final. </p><br><h2 id="vyvody">  Conclusions </h2><br><p>  L'exp√©rience, il me semble, a √©t√© tr√®s r√©ussie.  Lors du d√©veloppement √† l'aide de la bo√Æte √† outils Graal, je n'ai rencontr√© aucun probl√®me insurmontable ni m√™me significatif.  Tout fonctionnait de mani√®re pr√©visible et stable.  Bien que, presque certainement, tout ne sera pas si fluide si vous essayez de construire quelque chose de plus complexe de cette fa√ßon, par exemple, une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">application sur Spring Boot</a> .  N√©anmoins, un certain nombre de plates-formes ont d√©j√† √©t√© pr√©sent√©es dans lesquelles le support natif de Graal est d√©clar√©.  Parmi eux, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Micronaut</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Microprofile</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Quarkus</a> . </p><br><p>  Quant √† la poursuite du d√©veloppement du projet, une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">liste d'am√©liorations</a> pr√©vues pour la version 0.2 est d√©j√† pr√™te.  De plus, pour le moment, l'assemblage du binaire final n'est impl√©ment√© que pour Linux x64.  J'esp√®re que cette omission sera corrig√©e √† l'avenir, d'autant plus que le compilateur d' <code>native-image</code> de Graal prend en charge MacOS et Windows.  Malheureusement, il ne prend pas encore en charge la compilation crois√©e, ce qui pourrait faciliter les choses. </p><br><p>  J'esp√®re que l'utilitaire pr√©sent√© sera utile √† au moins quelqu'un de la communaut√© habr r√©put√©e.  Je serai doublement heureux s'il y a ceux qui veulent contribuer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">au projet</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr451574/">https://habr.com/ru/post/fr451574/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr451560/index.html">Cher client, c'est pourquoi ce changement a pris autant de temps.</a></li>
<li><a href="../fr451562/index.html">Comment √©chapper √† une secte?</a></li>
<li><a href="../fr451566/index.html">Op√©ration TaskMasters: Comment nous avons expos√© les organisations d'attaque du cyber groupe en Russie et dans la CEI</a></li>
<li><a href="../fr451570/index.html">S'installer en France pour travailler: salaires, visas et curriculum vitae</a></li>
<li><a href="../fr451572/index.html">Tendances des technologies de d√©veloppement Web 2019</a></li>
<li><a href="../fr451576/index.html">Le livre "Notre code. Artisanat, profession, art "</a></li>
<li><a href="../fr451580/index.html">MODX Digest # 5 (22 avril - 13 mai 2019)</a></li>
<li><a href="../fr451582/index.html">Content Marketing en anglais: 5 chiffres importants pour aider les startups</a></li>
<li><a href="../fr451586/index.html">Bienvenue √† la diffusion UPD de BD & DWH Raiffeisen MeetUp</a></li>
<li><a href="../fr451588/index.html">Note sur les tests d'int√©gration √† l'aide de Jenkins sur Kubernetes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>