<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘©ğŸ½â€ğŸ¤ â˜”ï¸ ğŸŠ æµ‹é‡Cï¼ƒä»£ç çš„ä¾¿æ·å·¥å…· ğŸ‘©ğŸ¼â€ğŸ¤â€ğŸ‘¨ğŸ¿ ğŸ¸ ğŸ§šğŸ½</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="åœ¨å¿«èŠ‚å¥ï¼Œå¤§å‹è€Œå¤æ‚çš„äº§å“ä¸­ï¼Œå‘ç°æ€§èƒ½ç“¶é¢ˆå¹¶ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹ã€‚ å½“ç„¶ï¼Œæœ‰è§£å†³æ­¤ç±»é—®é¢˜çš„å·¥å…·ï¼Œä¾‹å¦‚BenchmarkDotNet ã€‚ æ— ç–‘ï¼Œè¿™æ˜¯ä¸€ä¸ªæœ‰ç”¨ä¸”å¿…è¦çš„å·¥å…·ï¼Œä½†å¹¶ä¸æ€»æ˜¯å¾ˆæ–¹ä¾¿ã€‚ ä¾‹å¦‚ï¼Œå½“éœ€è¦é€šè¿‡è®¾ç½®ç›¸åº”çš„å±æ€§è€Œä¸æ˜¯å®Œå…¨æµ‹é‡å…¬å…±æ–¹æ³•ï¼Œè€Œæ˜¯ç§æœ‰æ–¹æ³•å†…éƒ¨çš„æŸäº›ä»£ç æ—¶ï¼Œå¯ä»¥æ£€æµ‹åˆ°è¿™ä¸€ç‚¹ã€‚ åœ¨è¿™é‡Œï¼Œæˆ‘ç»...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>æµ‹é‡Cï¼ƒä»£ç çš„ä¾¿æ·å·¥å…·</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tinkoff/blog/454058/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/mg/wk/br/mgwkbr8kjbcbpm-eyyyo4izz74s.png"></div><br> åœ¨å¿«èŠ‚å¥ï¼Œå¤§å‹è€Œå¤æ‚çš„äº§å“ä¸­ï¼Œå‘ç°æ€§èƒ½ç“¶é¢ˆå¹¶ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹ã€‚ å½“ç„¶ï¼Œæœ‰è§£å†³æ­¤ç±»é—®é¢˜çš„å·¥å…·ï¼Œä¾‹å¦‚<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">BenchmarkDotNet</a> ã€‚ æ— ç–‘ï¼Œè¿™æ˜¯ä¸€ä¸ªæœ‰ç”¨ä¸”å¿…è¦çš„å·¥å…·ï¼Œä½†å¹¶ä¸æ€»æ˜¯å¾ˆæ–¹ä¾¿ã€‚ ä¾‹å¦‚ï¼Œå½“éœ€è¦é€šè¿‡è®¾ç½®ç›¸åº”çš„å±æ€§è€Œä¸æ˜¯å®Œå…¨æµ‹é‡å…¬å…±æ–¹æ³•ï¼Œè€Œæ˜¯ç§æœ‰æ–¹æ³•å†…éƒ¨çš„æŸäº›ä»£ç æ—¶ï¼Œå¯ä»¥æ£€æµ‹åˆ°è¿™ä¸€ç‚¹ã€‚ åœ¨è¿™é‡Œï¼Œæˆ‘ç»ä¸ä¼šæ‰¹è¯„æŒ‡å®šçš„å·¥å…·ï¼Œè€Œåªæ˜¯æƒ³æŒ‡å‡ºéœ€è¦ä¸€ç§ç¨å¾®ä¸åŒçš„æ–¹å¼æ¥æ”¶é›†ä»£ç ç‰‡æ®µåº¦é‡çš„éœ€æ±‚ã€‚ æœ‰éå¸¸å¤æ‚ï¼Œä»¤äººå›°æƒ‘çš„æ–¹æ³•ï¼Œå¸¦æœ‰åˆ†æ”¯ï¼Œå¸¦æœ‰å¾ªç¯ï¼Œå¤„ç†ç‰¹æ®Šæƒ…å†µï¼Œå¹¶ä¸”é—®é¢˜æ‰€åœ¨å¯èƒ½åœ¨å†…éƒ¨ã€‚ è¦æ‰¾åˆ°å®ƒï¼Œæ‚¨éœ€è¦ç”¨ä»ªè¡¨å¤§é‡åœ°è¦†ç›–ä»£ç ï¼ŒåŒæ—¶æ˜¾ç„¶å¸Œæœ›ä¸è¦è§¦æ‘¸æˆ–ä¿®æ”¹ç°æœ‰é€»è¾‘ã€‚ <br><a name="habracut"></a><br> æ‚¨å¯ä»¥ä½¿ç”¨StopWatchç±»æ¥æµ‹é‡ä»£ç æ®µçš„æ‰§è¡Œæ—¶é—´ã€‚ <br><br> åƒè¿™æ ·ï¼š <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sw = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Stopwatch(); sw.Start(); <span class="hljs-comment"><span class="hljs-comment">//   sw.Stop(); Console.WriteLine(sw.Elapsed); //  </span></span></code> </pre> <br> ä¸ºäº†é¿å…æ¯æ¬¡éƒ½æŒ‰ä»£ç æ”¾ç½®ç§’è¡¨ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä¸€ä¸ªé«˜é˜¶å‡½æ•°æ¥ç»Ÿä¸€æµ‹é‡è¿‡ç¨‹ï¼Œä¾‹å¦‚ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LambdaMeter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> label, Action act</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sw = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Stopwatch(); sw.Start(); act(); sw.Stop(); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{label}</span></span></span><span class="hljs-string"> : </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{sw.Elapsed}</span></span></span><span class="hljs-string">"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   }</span></span></code> </pre><br> å¹¶ä½¿ç”¨è¿™ç§æ–¹å¼ï¼š <br><br><pre> <code class="cs hljs">LambdaMeter(<span class="hljs-string"><span class="hljs-string">"foo"</span></span>, () =&gt; { <span class="hljs-comment"><span class="hljs-comment">// TODO something });</span></span></code> </pre><br> æ‚¨å¯ä»¥é€šè¿‡è¯¥åˆ†æœºå°†å‘¼å«å†…å‘å¤–è½¬ï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TimeInspector</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Meter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Action act, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> label</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sw = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Stopwatch(); sw.Start(); act(); sw.Stop(); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{label}</span></span></span><span class="hljs-string"> : </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{sw.Elapsed}</span></span></span><span class="hljs-string">"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   } }</span></span></code> </pre><br> åƒè¿™æ ·ä½¿ç”¨ï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Action(() =&gt; { <span class="hljs-comment"><span class="hljs-comment">// TODO something }).Meter("foo");</span></span></code> </pre><br> çœ‹æ¥é—®é¢˜ä¼¼ä¹å·²è§£å†³ï¼Œä½†è¯¥æŠ€æœ¯ä»ç„¶æä¸ºæœ‰é™ã€‚ äº‹å®æ˜¯ï¼Œè¢«æµ‹ä»£ç ä¸­å¯èƒ½æœ‰è¿”å›è¾“å‡ºï¼Œå› æ­¤æ‚¨ä¸èƒ½å°†å…¶åŒ…è£…åœ¨Actionä¸­ã€‚ å³ä½¿ä½¿ç”¨Funcä¹Ÿæ— æ³•è§£å†³é—®é¢˜ã€‚ ä¸‹é¢ï¼Œæˆ‘è¦æè¿°ä¸€ç§ä¸æ­¢ä¸€æ¬¡ä½¿ç”¨çš„æŠ€æœ¯ï¼Œå®ƒåœ¨ä»£ç ä¸­çš„æ›´æ”¹æœ€å°‘ï¼Œå¯ä»¥è§£å†³æµ‹é‡ä»»æ„ä»£ç æ®µçš„é—®é¢˜ã€‚ æˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªç®€å•è€Œç´§å‡‘çš„è®°å½•å™¨æ¥æµ‹é‡æ‰§è¡Œé€Ÿåº¦ï¼›å¦‚æœéœ€è¦ï¼Œä¿®æ”¹å®ƒä»¥æ»¡è¶³å…¶ä»–éœ€æ±‚ï¼ˆä¾‹å¦‚æœç´¢å†…å­˜æ³„æ¼ï¼‰ä¹Ÿéå¸¸ç®€å•ã€‚ ä¸‹é¢çš„ä»£ç å¹¶ä¸å£°ç§°æ˜¯å®Œæ•´çš„å’Œå¯è¿è¡Œçš„ï¼Œè€Œæ˜¯å¯¹åŸç†çš„æ¼”ç¤ºï¼Œæ‚¨å¯ä»¥åœ¨æ­¤åŸºç¡€ä¸Šæ„å»ºä¸€ä¸ªçœŸæ­£æœ‰ç”¨ä¸”ç®€å•çš„å·¥å…·ã€‚ ä½†æ˜¯ï¼Œè¯¥ä»£ç æ­£åœ¨è¿è¡Œï¼Œå¹¶ä¸”å¯ä»¥ç”¨äºæŒ‰åŸæ ·æ”¶é›†åº¦é‡æ ‡å‡†æˆ–å°†å…¶ç”¨äºæ›´å…·ä½“çš„ä»»åŠ¡ã€‚ æˆ‘è¿˜æƒ³æŒ‡å‡ºï¼Œä¸‹é¢çš„ä»£ç æ”¶é›†äº†å…¶ä»–ä¿¡æ¯ï¼Œä¾‹å¦‚è¿›ç¨‹IDæˆ–ä¸»æœºåã€‚ è¿™äº›å‚æ•°åœ¨æŸäº›æƒ…å†µä¸‹å¯¹æˆ‘å¾ˆæœ‰ç”¨ï¼Œä»…ä½œä¸ºç¤ºä¾‹ã€‚ ä»»ä½•å†³å®šä½¿ä»£ç é€‚åº”å…¶ä»»åŠ¡çš„äººéƒ½å¯èƒ½éœ€è¦æ”¶é›†å®Œå…¨ä¸åŒçš„å‚æ•°ï¼Œéƒ¨åˆ†åŸå› æ˜¯æŒ‡å®šçš„ä»£ç æœªä½œä¸ºæœ€ç»ˆäº§å“å‘å¸ƒåœ¨å…¬å…±GitHubä¸Šã€‚ <br><br>  Cï¼ƒæœ‰ä¸€ä¸ªä¼—æ‰€å‘¨çŸ¥çš„æœ‰ç”¨çš„usingè¯­å¥ï¼Œå®ƒé€‚ç”¨äºæ”¯æŒIDisposableæ¥å£çš„ç±»å‹ã€‚ å…³é”®æ˜¯ï¼Œå½“é€€å‡ºæ“ä½œå‘˜å—æ—¶ï¼Œè¯·è°ƒç”¨Disposeæ–¹æ³•ï¼Œå…¶ä¸­é€šå¸¸é‡Šæ”¾èµ„æºã€‚ ä½†æ˜¯ï¼Œè¯¥æœºåˆ¶å¯ä»¥ç”¨äºå¤šç§ç›®çš„ã€‚ åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œè¿™å°†æ˜¯å¯¹å—æ‰§è¡Œæ—¶é—´çš„åº¦é‡ï¼Œç„¶åä¿å­˜ç»“æœä»¥ä¾›åˆ†æã€‚ è¿™ä¸ªæƒ³æ³•æ˜¯åœ¨usingå—ä¸­åˆ›å»ºè¯¥ç±»çš„å®ä¾‹ï¼Œåœ¨åˆ›å»ºæ—¶ï¼Œå°†æ”¶é›†å„ç§æœ‰ç”¨çš„ä¿¡æ¯å¹¶å¯åŠ¨StopWatchã€‚ å½“é€€å‡ºè¯¥å—æ—¶æ‰§è¡ŒDisposeæ—¶ï¼Œç»“æœæ˜¯å›ºå®šçš„ï¼Œå¹¶å‘é€å¯¹è±¡ä»¥ä¿å­˜æ—¥å¿—ã€‚ <br><br>  usingè¯­å¥æ˜¯è¯­æ³•ç³–ï¼›ç¼–è¯‘åå°†å…¶è½¬æ¢ä¸ºtry-finalyå—ã€‚ <br><br> ä¾‹å¦‚ï¼Œä»£ç ï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> obj = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SomeDisposableClass()) { <span class="hljs-comment"><span class="hljs-comment">// TODO something }</span></span></code> </pre><br> è½¬æ¢ä¸ºè§†å›¾è®¾è®¡ï¼š <br><br><pre> <code class="cs hljs">IDisposable obj = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SomeDisposableClass(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// TODO something } finally { if (obj != null) { obj.Dispose(); } }</span></span></code> </pre><br> å› æ­¤ï¼Œåœ¨tryå—çš„ä»»ä½•é€€å‡ºå¤„ï¼Œå°†ä¿è¯å¹¶ç«‹å³è°ƒç”¨Disposeæ–¹æ³•ï¼Œè€Œä½¿ç”¨ä¸­æ”¾ç½®çš„ä»£ç çš„é€»è¾‘å°†ä¸ä¼šä»¥ä»»ä½•æ–¹å¼æ”¹å˜ã€‚ æˆ‘ä»¬æ›´æ”¹çš„åªæ˜¯æ·»åŠ ä¸€ä¸ªDisposeè°ƒç”¨ã€‚ ä»¥æ­¤æ€æƒ³ä¸ºæŒ‡å¯¼ï¼Œæˆ‘ä»¬å°†æˆä¸ºæœ€ç®€å•çš„è¿è¡Œæ—¶æµ‹é‡å™¨ã€‚ <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Meter</span></span> :<span class="hljs-title"><span class="hljs-title">IDisposable</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Stopwatch _sw; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _label; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Meter </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Job</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> lable</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Meter(lable); } Meter(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> label) { _label = label; _sw = Stopwatch.StartNew(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Dispose</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _sw.Stop(); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{_label}</span></span></span><span class="hljs-string"> : </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{_sw.Elapsed}</span></span></span><span class="hljs-string">"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   } }</span></span></code> </pre><br> å› æ­¤ï¼Œè¿™ç»™äº†æˆ‘ä»¬ä»€ä¹ˆï¼Ÿ <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//       return static int Case0() { using (Meter.Job("case-0")) { return 1; } return 2; } //     yield return static IEnumerable&lt;string&gt; Case1() { yield return "one"; using (Meter.Job("case-1")) { yield return "two"; yield return "three"; } yield return "four"; } //     break static void Case2() { while (true) { using (Meter.Job("case-2")) { // todo something break; } } } //    switch    static int Case3(int @case) { using (Meter.Job("case-3")) { switch (@case) { case 1: using (Meter.Job($"case-3-{@case}")) { // todo something break; } case 2: using (Meter.Job($"case-3-{@case}")) { // todo something return @case; } } return @case; } } //       static void Case4() { try { using (Meter.Job($"case-4")) { // todo something throw new Exception(); } } catch (Exception e) { Console.WriteLine(e); } }</span></span></code> </pre><br> æ‰€æè¿°çš„æŠ€æœ¯ç¼ºå°‘ä»€ä¹ˆï¼Ÿ å¦‚ä½•ä¿æŠ¤ç»“æœçš„ä¸»é¢˜å°šæœªå®Œå…¨å…¬å¼€ï¼Œå¾ˆæ˜æ˜¾ï¼Œåœ¨æ§åˆ¶å°ä¸­è®°å½•ç»“æœæ²¡æœ‰å¤ªå¤§æ„ä¹‰ã€‚ åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¾ˆæœ‰å¯èƒ½å°†æµè¡Œçš„æµè¡Œå·¥å…·NLogï¼ŒLog4Netï¼ŒSerilogä¸å¯è§†åŒ–<s>åŒ…</s>å’Œæœ€å°‘çš„åˆ†æä¸€èµ·ä½¿ç”¨ã€‚ åœ¨ç‰¹åˆ«ä¸¥é‡çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½éœ€è¦æ›´å¤æ‚çš„åˆ†ææ‰èƒ½ç¡®å®šä¼šå‘ç”Ÿä»€ä¹ˆã€‚ <br><br> æ‚¨å¯ä»¥å°†ç»“æœå­˜å‚¨åœ¨ä¸€ä¸ªç®€å•çš„æ–‡æœ¬æ–‡ä»¶ä¸­ï¼Œä½†æ˜¯å¯¹äºæ­¤ä»»åŠ¡ï¼Œæˆ‘è®¤ä¸ºè¿™ä¸æ˜¯ä¸€ä¸ªéå¸¸æ–¹ä¾¿çš„è§£å†³æ–¹æ¡ˆï¼Œå› ä¸ºå¯ä»¥æœ‰å¾ˆå¤šä»£ç æ®µï¼Œå¹¶ä¸”å®ƒä»¬å¯èƒ½è¿˜åµŒå¥—äº†å‡ ä¸ªå¹¶è¡Œçº¿ç¨‹ã€‚ å› æ­¤ï¼Œä»…å‡ºäºæµè§ˆæ—¥å¿—çš„æ–¹ä¾¿ï¼Œæˆ‘ä»¬ä½¿ç”¨SQLiteæ•°æ®åº“ã€‚ <br><br> æˆ‘ä»¬é¦–å…ˆå®šä¹‰ä¸€ä¸ªç±»ï¼Œè¯¥ç±»è´Ÿè´£åº¦é‡æ—¶é—´å¹¶æ•è·å…¶ä»–æœ‰ç”¨ä¿¡æ¯ä»¥ä¾›ä»¥ååˆ†æã€‚ <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LogItem</span></span> : <span class="hljs-title"><span class="hljs-title">IDisposable</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Id; <span class="hljs-comment"><span class="hljs-comment">// Log item unique id public string Label; // User text labl public string Lid; // Log Id public string Method; // Method name public int Tid; // Thread Id public DateTime CallTime; // Start time public TimeSpan Elapsed; // Metering public long ElapsedMs; // Metering miliseconds public long ElapsedTicks; // Metering ticks private Stopwatch _sw; private Logger _cl; public LogItem(Logger cl, string method, string label) { Id = Guid.NewGuid().ToString("N"); _cl = cl; Lid = _cl.LId; Label = label; Method = method; Tid = Thread.CurrentThread.ManagedThreadId; CallTime = DateTime.Now; _sw = new Stopwatch(); _sw.Start(); } public void Dispose() { _sw.Stop(); Elapsed = _sw.Elapsed; ElapsedMs = _sw.ElapsedMilliseconds; ElapsedTicks = _sw.ElapsedTicks; _cl.WriteLog(this); } }</span></span></code> </pre><br> æŒ‡å‘è®°å½•å™¨å¯¹è±¡å’Œå…¶ä»–ä¿¡æ¯çš„é“¾æ¥å°†ä¼ é€’åˆ°LogItemç±»çš„æ„é€ å‡½æ•°ï¼Œè¿›è¡Œæµ‹é‡çš„æ–¹æ³•çš„å…¨åä»¥åŠå¸¦æœ‰ä»»æ„æ¶ˆæ¯çš„æ ‡ç­¾ã€‚ è¦äº†è§£æ‰§è¡Œå¼‚æ­¥ä»£ç çš„æ—¥å¿—ï¼Œå°†ä½¿ç”¨Tidï¼ˆçº¿ç¨‹IDï¼‰å­—æ®µï¼Œæ‚¨å¯ä»¥é€šè¿‡è¯¥å­—æ®µå°†ä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ•°æ®åˆ†ç»„ã€‚ åŒæ ·ï¼Œåœ¨åˆ›å»ºLogItemå¯¹è±¡æ—¶ï¼Œæµ‹é‡çš„å¼€å§‹æ—¶é—´æ˜¯å›ºå®šçš„ï¼Œå¹¶ä¸”StopWatchå°†å¼€å§‹ã€‚ åœ¨Disposeæ–¹æ³•ä¸­ï¼Œåœæ­¢StopWatchå¹¶è°ƒç”¨WriteLogè®°å½•å™¨æ–¹æ³•ï¼Œå°†å½“å‰å°„å‡»è€…çš„å¯¹è±¡ä¼ é€’ç»™å®ƒï¼Œå¹¶ä¿®å¤æ‰€æœ‰å¿…éœ€çš„LogItemä¿¡æ¯ã€‚ <br><br> è®°å½•å™¨æœ¬è´¨ä¸Šæœ‰ä¸¤ä¸ªä¸»è¦ä»»åŠ¡ï¼šå¯åŠ¨LogItemå¯¹è±¡å¹¶åœ¨æµ‹é‡å®Œæˆåè®°å½•ç»“æœã€‚ ç”±äºæˆ‘ä»ç„¶ä¸ä»…éœ€è¦åœ¨SQLiteä¸­è®°å½•ç»“æœï¼Œè€Œä¸”è¿˜éœ€è¦åœ¨SQLiteä»¥å¤–çš„å„ç§æ ¼å¼çš„æ–‡æœ¬æ–‡ä»¶æˆ–æ•°æ®åº“ä¸­è®°å½•ç»“æœï¼Œå› æ­¤äº¤äº’é€»è¾‘æ”¾åœ¨å•ç‹¬çš„ç±»ä¸­ã€‚ åœ¨Loggerç±»ä¸­ï¼Œä»…ä¿ç•™å¸¸è§„éƒ¨åˆ†ã€‚ <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Logger</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> LId; <span class="hljs-comment"><span class="hljs-comment">// Log id public string Login; // User login public int Pid; // Process Id public string App; // Application name public string Host; // Host name public string Ip; // Ip address private ConcurrentQueue&lt;dynamic&gt; queue; // Queue log items to save public Dictionary&lt;Type, Action&lt;dynamic&gt;&gt; LogDispatcher; // Different log objects handlers dispatcher public bool IsEnabled = true; public Logger(Dictionary&lt;Type, Action&lt;dynamic&gt;&gt; logDispatcher) { queue = new ConcurrentQueue&lt;dynamic&gt;(); LogDispatcher = logDispatcher; LId = Guid.NewGuid().ToString("N"); Login = WindowsIdentity.GetCurrent().Name; Host = Dns.GetHostName(); Ip = Dns.GetHostEntry(Host).AddressList.FirstOrDefault(f =&gt; f.AddressFamily == System.Net.Sockets.AddressFamily.InterNetwork)?.ToString(); var proc = Process.GetCurrentProcess(); Pid = proc.Id; App = proc.ProcessName; queue.Enqueue(this); // Save the starting of a new measurement new Thread(() =&gt; { // Dequeue and save loop dynamic logItem; while (true) { if (queue.TryDequeue(out logItem)) { var logT = logItem.GetType(); if (LogDispatcher.ContainsKey(logT)) { LogDispatcher[logT](logItem); } } else { Thread.Sleep(500); } }}) { IsBackground = true}.Start(); } public LogItem Watch(int level, string label = null) { return new LogItem(this, GetMethodFullName(level), label); } private static string GetMethodFullName(int level) { var t = new StackTrace().GetFrames()?[level].GetMethod(); if (t == null) return ""; var path = t.ReflectedType != null ? t.ReflectedType.FullName : "_"; return $"{path}.{t.Name}"; } public void WriteLog(LogItem li) { if (IsEnabled) { queue.Enqueue(li); } } }</span></span></code> </pre><br> å› æ­¤ï¼ŒLoggerç±»æ˜¯ä¸­é—´ç±»ï¼Œå®ƒçš„ä»»åŠ¡æ˜¯æ”¶é›†æœ‰å…³å¯åŠ¨æ—¥å¿—è®°å½•çš„ç¯å¢ƒçš„ä¿¡æ¯ã€‚ åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œè¿™æ˜¯ç”¨æˆ·ç™»å½•åï¼Œè®¡ç®—æœºåç§°ï¼Œç½‘ç»œåœ°å€IDå’Œè¿›ç¨‹åç§°ã€‚ å½“æˆ‘ä»¬è¦æµ‹é‡ç”¨æˆ·æœºå™¨ä¸Šçš„ä»£ç æ®µçš„æ‰§è¡Œæ—¶é—´æ—¶ï¼Œæ‰€æœ‰è¿™äº›ä¿¡æ¯éƒ½æ˜¯æœ‰ç”¨çš„ã€‚ ä¸»è¦ç”¨äºè¯†åˆ«å¼‚å¸¸æƒ…å†µä¸‹çš„è¯†åˆ«ã€‚ æˆ‘è®¤ä¸ºè¯»è€…ä¼šåŒæ„ï¼Œåœ¨æµ‹é‡æœŸé—´è®°å½•å™¨å¯¹è¢«æµ‹ä»£ç çš„æ‰§è¡Œæ—¶é—´å½±å“æœ€å°æ˜¯å¾ˆé‡è¦çš„ã€‚ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆé€šè¿‡å°†ç»“æœæ·»åŠ åˆ°é˜Ÿåˆ—ï¼ˆåå°è¿›ç¨‹æ—‹è½¬ï¼‰ï¼Œå°†ç»“æœä¿å­˜åˆ°æ•°æ®åº“ï¼Œæ–‡ä»¶æˆ–é€šè¿‡ç½‘ç»œä¼ è¾“æ¥æ‰§è¡Œä¿å­˜ç»“æœçš„åŸå› ã€‚ è¿™ç§æ–¹æ³•æœ‰ä¸€ä¸ªä¸¥é‡çš„ç¼ºç‚¹ï¼Œå¦‚æœæ—¥å¿—äº‹ä»¶å¤ªå¤šï¼Œåˆ™é˜Ÿåˆ—å°†æ¯”å¼€å§‹å¡«å……æ›´å¿«ï¼Œç›´åˆ°å®ƒå ç”¨äº†åº”ç”¨ç¨‹åºå¯ç”¨çš„æ‰€æœ‰å†…å­˜ã€‚ ä½†æ˜¯è¦å¼•èµ·è¿™ç§æƒ…å†µï¼Œæ‚¨ä»ç„¶éœ€è¦å°è¯•ã€‚ ç”¨äºä¿å­˜ä¸åŒç±»çš„å¤„ç†ç¨‹åºçš„åˆ†å‘æ˜¯é€šè¿‡å­—å…¸æ‰§è¡Œçš„ï¼Œå…¶ä¸­å­—å…¸æ˜¯ä¸€ç§ç±»å‹ï¼Œå€¼æ˜¯ç”¨äºä¿å­˜æ­¤ç±»å‹çš„å¯¹è±¡çš„è¿‡ç¨‹ã€‚ <br><br> å¯¹äºä¸‹é¢å°†ç»™å‡ºçš„æ—¥å¿—è®°å½•ç±»ï¼Œæœ‰å¿…è¦é€šè¿‡å®‰è£…nugetåŒ…System.Data&gt; SQLiteæ¥æ»¡è¶³ä¾èµ–å…³ç³»ã€‚ <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SqliteLogger</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> HLTimeCall.Logger _iternalLogger; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _connectionString; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> dbLocker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SqliteLogger</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { InitDb(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dispatcher = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;Type, Action&lt;<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span>&gt;&gt;(); dispatcher[<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(HLTimeCall.Logger)] = o =&gt; LogMainRecord(o); dispatcher[<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(HLTimeCall.LogItem)] = o =&gt; LogCall(o); _iternalLogger = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HLTimeCall.Logger(dispatcher); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitDb</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> databaseFile = <span class="hljs-string"><span class="hljs-string">"TimeCallLogs.db"</span></span>; _connectionString = <span class="hljs-string"><span class="hljs-string">$"Data Source = </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Path.GetFullPath(databaseFile)}</span></span></span><span class="hljs-string">;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbFileName = Path.GetFullPath(databaseFile); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!File.Exists(dbFileName)) { SQLiteConnection.CreateFile(dbFileName); Bootstrap(); } } <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> DbNames { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> TMainRecord = <span class="hljs-string"><span class="hljs-string">"T_MAINRECORD"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> TCalllog = <span class="hljs-string"><span class="hljs-string">"T_CALLLOG"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FLid = <span class="hljs-string"><span class="hljs-string">"LID"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FLogin = <span class="hljs-string"><span class="hljs-string">"LOGIN"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FPid = <span class="hljs-string"><span class="hljs-string">"PID"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FApp = <span class="hljs-string"><span class="hljs-string">"APP"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FHost = <span class="hljs-string"><span class="hljs-string">"HOST"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FIp = <span class="hljs-string"><span class="hljs-string">"IP"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FId = <span class="hljs-string"><span class="hljs-string">"ID"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FLabel = <span class="hljs-string"><span class="hljs-string">"LABEL"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FMethod = <span class="hljs-string"><span class="hljs-string">"METHOD"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FTid = <span class="hljs-string"><span class="hljs-string">"TID"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FCallTime = <span class="hljs-string"><span class="hljs-string">"CALL_TIME"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FElapsed = <span class="hljs-string"><span class="hljs-string">"ELAPSED"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FElapsedMs = <span class="hljs-string"><span class="hljs-string">"ELAPSED_MS"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FElapsedTicks = <span class="hljs-string"><span class="hljs-string">"ELAPSED_TICKS"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Bootstrap</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (dbLocker) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> conn = Connect()) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cmd = conn.CreateCommand()) { cmd.Transaction = conn.BeginTransaction(); cmd.CommandType = System.Data.CommandType.Text; cmd.CommandText = <span class="hljs-string"><span class="hljs-string">$"CREATE TABLE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.TMainRecord}</span></span></span><span class="hljs-string"> (</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FLid}</span></span></span><span class="hljs-string"> VARCHAR(45) PRIMARY KEY UNIQUE NOT NULL, </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FLogin}</span></span></span><span class="hljs-string"> VARCHAR(45), </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FPid}</span></span></span><span class="hljs-string"> INTEGER, </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FApp}</span></span></span><span class="hljs-string"> VARCHAR(45), </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FHost}</span></span></span><span class="hljs-string"> VARCHAR(45), </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FIp}</span></span></span><span class="hljs-string"> VARCHAR(45))"</span></span>; cmd.ExecuteNonQuery(); cmd.CommandText = <span class="hljs-string"><span class="hljs-string">$"CREATE TABLE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.TCalllog}</span></span></span><span class="hljs-string"> (</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FId}</span></span></span><span class="hljs-string"> VARCHAR(45) PRIMARY KEY UNIQUE NOT NULL, </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FLabel}</span></span></span><span class="hljs-string"> VARCHAR(45), </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FLid}</span></span></span><span class="hljs-string"> VARCHAR(45) NOT NULL, </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FMethod}</span></span></span><span class="hljs-string"> VARCHAR(150), </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FTid}</span></span></span><span class="hljs-string"> VARCHAR(45), </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FCallTime}</span></span></span><span class="hljs-string"> DATETIME, </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FElapsed}</span></span></span><span class="hljs-string"> TIME, </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FElapsedMs}</span></span></span><span class="hljs-string"> INTEGER, </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FElapsedTicks}</span></span></span><span class="hljs-string"> INTEGER)"</span></span>; cmd.ExecuteNonQuery(); cmd.Transaction.Commit(); } } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> DbConnection </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Connect</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> conn = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SQLiteConnection(_connectionString); conn.Open(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> conn; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> HLTimeCall.<span class="hljs-function"><span class="hljs-function">LogItem </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Watch</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> label = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _iternalLogger.Watch(<span class="hljs-number"><span class="hljs-number">3</span></span>, label); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateParameter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> key, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SQLiteParameter(key, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> ?? DBNull.Value); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LogMainRecord</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HLTimeCall.Logger logItem</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (dbLocker) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> conn = Connect()) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cmd = conn.CreateCommand()) { cmd.Transaction = conn.BeginTransaction(); cmd.CommandType = System.Data.CommandType.Text; cmd.Parameters.Add(CreateParameter(DbNames.FLid, logItem.LId)); cmd.Parameters.Add(CreateParameter(DbNames.FLogin, logItem.Login)); cmd.Parameters.Add(CreateParameter(DbNames.FPid, logItem.Pid)); cmd.Parameters.Add(CreateParameter(DbNames.FApp, logItem.App)); cmd.Parameters.Add(CreateParameter(DbNames.FHost, logItem.Host)); cmd.Parameters.Add(CreateParameter(DbNames.FIp, logItem.Ip)); cmd.CommandText = <span class="hljs-string"><span class="hljs-string">$"INSERT INTO </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.TMainRecord}</span></span></span><span class="hljs-string">(</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FLid}</span></span></span><span class="hljs-string">,</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FLogin}</span></span></span><span class="hljs-string">,</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FPid}</span></span></span><span class="hljs-string">,</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FApp}</span></span></span><span class="hljs-string">,</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FHost}</span></span></span><span class="hljs-string">,</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FIp}</span></span></span><span class="hljs-string">)VALUES(:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FLid}</span></span></span><span class="hljs-string">,:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FLogin}</span></span></span><span class="hljs-string">,:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FPid}</span></span></span><span class="hljs-string">,:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FApp}</span></span></span><span class="hljs-string">,:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FHost}</span></span></span><span class="hljs-string">,:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FIp}</span></span></span><span class="hljs-string">)"</span></span>; cmd.ExecuteNonQuery(); cmd.Transaction.Commit(); } } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LogCall</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HLTimeCall.LogItem logItem</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (dbLocker) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> conn = Connect()) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cmd = conn.CreateCommand()) { cmd.Transaction = conn.BeginTransaction(); cmd.CommandType = System.Data.CommandType.Text; cmd.Parameters.Add(CreateParameter(DbNames.FId, logItem.Id)); cmd.Parameters.Add(CreateParameter(DbNames.FLabel, logItem.Label)); cmd.Parameters.Add(CreateParameter(DbNames.FLid, logItem.Lid)); cmd.Parameters.Add(CreateParameter(DbNames.FMethod, logItem.Method)); cmd.Parameters.Add(CreateParameter(DbNames.FTid, logItem.Tid)); cmd.Parameters.Add(CreateParameter(DbNames.FCallTime, logItem.CallTime)); cmd.Parameters.Add(CreateParameter(DbNames.FElapsed, logItem.Elapsed)); cmd.Parameters.Add(CreateParameter(DbNames.FElapsedMs, logItem.ElapsedMs)); cmd.Parameters.Add(CreateParameter(DbNames.FElapsedTicks, logItem.ElapsedTicks)); cmd.CommandText = <span class="hljs-string"><span class="hljs-string">$"INSERT INTO </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.TCalllog}</span></span></span><span class="hljs-string">(</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FId}</span></span></span><span class="hljs-string">,</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FLabel}</span></span></span><span class="hljs-string">,</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FLid}</span></span></span><span class="hljs-string">,</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FMethod}</span></span></span><span class="hljs-string">,</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FTid}</span></span></span><span class="hljs-string">,</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FCallTime}</span></span></span><span class="hljs-string">,</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FElapsed}</span></span></span><span class="hljs-string">,</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FElapsedMs}</span></span></span><span class="hljs-string">,</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FElapsedTicks}</span></span></span><span class="hljs-string">)VALUES(:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FId}</span></span></span><span class="hljs-string">,:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FLabel}</span></span></span><span class="hljs-string">,:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FLid}</span></span></span><span class="hljs-string">,:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FMethod}</span></span></span><span class="hljs-string">,:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FTid}</span></span></span><span class="hljs-string">,:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FCallTime}</span></span></span><span class="hljs-string">,:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FElapsed}</span></span></span><span class="hljs-string">,:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FElapsedMs}</span></span></span><span class="hljs-string">,:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DbNames.FElapsedTicks}</span></span></span><span class="hljs-string">)"</span></span>; cmd.ExecuteNonQuery(); cmd.Transaction.Commit(); } } } } }</code> </pre><br> å¦‚å‰æ‰€è¿°ï¼ŒSqliteLoggerç±»è´Ÿè´£å°†æµ‹é‡ç»“æœå­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚ åœ¨å¼€å§‹ä½¿ç”¨æ•°æ®åº“ä¹‹å‰ï¼Œæ‚¨éœ€è¦åˆ›å»ºå®ƒï¼›æ›´å¤šçš„ä»£ç è¡Œæ¶‰åŠåˆ°è¿™ä¸€ç‚¹ã€‚ åœ¨è¿™é‡Œï¼Œè¯¥ç±»å°†è®°å½•åˆ›å»ºè®°å½•å™¨çš„äº‹å®ï¼ˆæ®äº†è§£ï¼Œè¿™ä¸åº”ç”¨ç¨‹åºå¯åŠ¨åŒæ—¶å‘ç”Ÿï¼‰ï¼Œç»“æœå°†ä¿å­˜åœ¨T_MAINRECORDè¡¨ä¸­ã€‚ æˆ‘ä»¬è¿˜å°†æµ‹é‡ç»“æœä¿å­˜åœ¨è¡¨T_CALLLOGä¸­ã€‚  LogMainRecordå’ŒLogCallæ–¹æ³•è´Ÿè´£å­˜å‚¨è¿™ä¸¤ä¸ªäº‹ä»¶ï¼›å¯¹å®ƒä»¬çš„å¼•ç”¨å­˜å‚¨åœ¨è°ƒåº¦ç¨‹åºå­—å…¸ä¸­ã€‚ è¦æ­£ç¡®åˆ›å»ºLogItemå¯¹è±¡ï¼Œéœ€è¦åœ¨usingè¯­å¥çš„åˆå§‹åŒ–å—ä¸­ä½¿ç”¨Watchå‡½æ•°ã€‚ <br><br> ä¾‹å¦‚ï¼Œåƒè¿™æ ·ï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cMeter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqliteLogger(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (cMeter.Watch(<span class="hljs-string"><span class="hljs-string">"   "</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">// TODO }</span></span></code> </pre><br> ç°åœ¨ï¼Œè¦ä½¿ç”¨æ­¤å·¥å…·ï¼Œæ‚¨éœ€è¦åœ¨æœ‰é—®é¢˜çš„åœ°æ–¹å®‰æ’ä½¿ç”¨å—ï¼Œç„¶åè®©åº”ç”¨ç¨‹åºæ­£å¸¸å·¥ä½œã€‚ ä¹‹åï¼Œä»ç„¶éœ€è¦åˆ†ææ”¶é›†åˆ°çš„ä¿¡æ¯ï¼Œæˆ‘å¸Œæœ›è¿™è¶³ä»¥ç¡®å®šé—®é¢˜æ‰€åœ¨ã€‚ æˆ‘å»ºè®®è€ƒè™‘ä½¿ç”¨æ­¤æŠ€æœ¯è¿˜å¯ä»¥æ”¶é›†å“ªäº›å…¶ä»–æŒ‡æ ‡ï¼Ÿ <br><br> æ„Ÿè°¢æ‚¨çš„å…³æ³¨ï¼Œç¥æ‚¨å¥½è¿å’Œå¿«é€Ÿçš„ä»£ç :-) </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN454058/">https://habr.com/ru/post/zh-CN454058/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN454044/index.html">iPadå’ŒiPhoneä¸Šçš„åˆ›æ„</a></li>
<li><a href="../zh-CN454046/index.html">åŠ¨æœºã€‚ è‡ªå·±åŠ¨æ‰‹</a></li>
<li><a href="../zh-CN454048/index.html">åŒæ ·ï¼Œå…¬æ°‘å‘STSIå’ŒFSSPè¿›è¡Œçš„æ•°åä¸‡ç¬”ä»˜æ¬¾å±äºå…¬æœ‰é¢†åŸŸ</a></li>
<li><a href="../zh-CN454052/index.html">â€œå•Šï¼Œè€æ¿ï¼Œè¯´è¯çš„å¸½å­ï¼â€ -ç”¨äºç”Ÿäº§çš„æ™ºèƒ½å¤´ç›”</a></li>
<li><a href="../zh-CN454056/index.html">å¦‚ä½•åœ¨ä¸åŒæ•°æ®ä¸­å¿ƒè¿æ¥Kubernetesé›†ç¾¤</a></li>
<li><a href="../zh-CN454060/index.html">æ„å¤–åœ°çœ‹åˆ°ä¸é€Ÿåº¦æ— å…³çš„å¼‚æ­¥ç”µè·¯</a></li>
<li><a href="../zh-CN454062/index.html">å…¬å¸ç”µè¯-å°±åƒä¸€æŠŠç‘å£«åˆ€ï¼šç”¨äºåº“å­˜ï¼ŒèŠå¤©ï¼Œæ”¯æŒç”µè¯å’ŒæŸ¥è¯¢</a></li>
<li><a href="../zh-CN454064/index.html">AIçš„æ•…äº‹</a></li>
<li><a href="../zh-CN454066/index.html">å¦‚ä½•åœæ­¢å¿˜è®°ç´¢å¼•å¹¶å¼€å§‹æ£€æŸ¥æµ‹è¯•ä¸­çš„æ‰§è¡Œè®¡åˆ’</a></li>
<li><a href="../zh-CN454070/index.html">é€‰æ‹©å•è½®é€šå‹¤</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>