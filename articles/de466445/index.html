<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👇🏾 👨🏿‍🎤 🈯️ Angriffe zwischen Vertrauensstellungen zwischen Domänen 📝 🕧 🏊</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Früher oder später, während des Pentests, besteht die Aufgabe darin, den gesamten Wald zu gefährden - vorausgesetzt, es gibt Rechte in einer der Domän...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Angriffe zwischen Vertrauensstellungen zwischen Domänen</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jetinfosystems/blog/466445/"><img src="https://habrastorage.org/webt/ki/6u/o8/ki6uo88vz8xcqbapiyvfwn4sc-s.jpeg"><br><br>  Früher oder später, während des Pentests, besteht die Aufgabe darin, den gesamten Wald zu gefährden - vorausgesetzt, es gibt Rechte in einer der Domänen.  In solchen Momenten stellen sich viele Fragen zu Trusts, ihren Eigenschaften und den Angriffen selbst.  Lassen Sie uns versuchen, alles herauszufinden. <br><a name="habracut"></a><br>  Vertrauen zwischen Domänen wird verwendet, um Benutzer einer Domäne auf dem Controller einer anderen Domäne zu authentifizieren.  Mit anderen Worten, damit Benutzer aus Domäne A Zugriff auf die Ressourcen von Domäne B haben können. Es gibt zwei Arten von Domänenstrukturen: <br><br><ul><li>  Domänenbäume </li><li>  Domänenwälder. </li></ul><br><img src="https://habrastorage.org/webt/5w/zx/4c/5wzx4cfoai1nwiwk6rissbhy4cu.png"><br><br>  Beim Erstellen eines Domänenbaums zwischen Domänen werden standardmäßig transitive Vertrauensstellungen eingerichtet.  Alle Computer haben gemeinsame: <br><br><ul><li>  globaler Katalog </li><li>  Namespace </li><li>  Schema. </li></ul><br>  Domänenbäume können zu Wäldern zusammengefasst werden.  Beim Erstellen einer Domänengesamtstruktur werden transitive Vertrauensstellungen eingerichtet, und alle Computer in der Gesamtstruktur haben Folgendes gemeinsam: <br><br><ul><li>  globaler Katalog </li><li>  Schema. </li></ul><br>  Die folgende Tabelle zeigt die Vertrauensarten zwischen Domänen und ihre Eigenschaften. <br><br><div class="scrollable-table"><table><tbody><tr><td>  Nein, nein. </td><td>  Vertrauensstellungstyp </td><td>  Transitivität </td><td>  Richtung </td><td>  Authentifizierungsmechanismus </td><td>  Beschreibung </td></tr><tr><td>  1 </td><td>  Extern </td><td>  Nicht transitiv </td><td>  Einweg oder Zweiweg </td><td>  Nur NTLM </td><td>  Sie werden zwischen Domänen installiert, die zu verschiedenen Gesamtstrukturen gehören, oder mit einer Windows NT 4.0-Domäne. </td></tr><tr><td>  2 </td><td>  Reich </td><td>  Transitiv oder nicht transitiv </td><td>  Einweg oder Zweiweg </td><td>  Nur Kerberos </td><td>  Wird zwischen Windows- und Nicht-Windows-Domänen mithilfe des Kerberos-Protokolls installiert.  Diese Art der Vertrauenswürdigkeit kann verwendet werden, um eine End-to-End-Authentifizierung auf Windows- und UNIX-Systemen bereitzustellen. </td></tr><tr><td>  3 </td><td>  Wald </td><td>  Transitiv </td><td>  Einweg oder Zweiweg </td><td>  Kerberos oder NTLM </td><td>  Set zwischen Wäldern.  Gleichzeitig entscheiden die Administratoren selbst, ob die Beziehung bilateral oder unilateral sein wird. </td></tr><tr><td> 4 </td><td>  Verknüpfung </td><td>  Transitiv </td><td>  Einweg oder Zweiweg </td><td>  Kerberos oder NTLM </td><td>  Stellen Sie zwischen den Domänen verschiedener Bäume ein, die zum selben Wald gehören.  Wird verwendet, um den Vertrauensweg zu verringern und dadurch die Effizienz der Interaktion zwischen den beiden Domänen zu erhöhen. </td></tr><tr><td>  5 </td><td>  Eltern-Kind </td><td>  Transitiv </td><td>  Zweiwege </td><td>  Kerberos oder NTLM </td><td>  Sie werden automatisch installiert, wenn eine neue Domäne in der Baumstruktur erstellt wird.  Innerhalb eines Domänenbaums werden Beziehungen durch das Eltern-Kind-Schema beschrieben. </td></tr><tr><td>  6 </td><td>  Baumwurzelvertrauen </td><td>  Transitiv </td><td>  Zweiwege </td><td>  Kerberos oder NTLM </td><td>  Wird automatisch installiert, wenn in einer vorhandenen Gesamtstruktur ein neuer Domänenbaum erstellt wird.  Tatsächlich wird Vertrauen zwischen der Stammdomäne der Gesamtstruktur und der erstellten Domäne hergestellt, die die Wurzel für den neuen Baum sein wird. </td></tr></tbody></table></div><br>  In der folgenden Abbildung sind die Arten von Vertrauensstellungen zwischen Domänen deutlicher dargestellt. <br><br><img src="https://habrastorage.org/webt/jp/mc/eo/jpmceokjm7kwra_mhgfrw3n8tc0.png"><br><br><h4>  Transitivität </h4><br>  Transitivität ist erforderlich, um das Vertrauen außerhalb der beiden Domänen zu definieren, zwischen denen es gebildet wurde, und wird verwendet, um Vertrauensbeziehungen mit anderen Domänen zu erweitern.  Wenn wir der Domäne eine untergeordnete Domäne hinzufügen, wird eine wechselseitige Vertrauensbeziehung zwischen der übergeordneten und der untergeordneten Domäne hergestellt.  Diese Beziehungen sind transitiv, d.h.  Wenn Domäne A Domäne D und Domäne D Domäne E vertraut, vertraut Domäne A auch Domäne E. <br><br><img src="https://habrastorage.org/webt/xv/wb/wf/xvwbwfp8-uopt2k_bmlk5y0onci.png"><br><br>  Nichttransitives Vertrauen kann verwendet werden, um das Vertrauen in andere Domänen zu verweigern. <br><br><h4>  Richtung </h4><br>  Ein Vertrauensstellungspfad ist eine Reihe von Vertrauensbeziehungen zwischen Domänen, an die Authentifizierungsanforderungen empfangen werden müssen.  Mit anderen Worten, vor der Authentifizierung eines Benutzers wird das Vertrauen zwischen Domänen bestimmt.  Damit Benutzer von Domäne A auf die Ressourcen von Domäne D zugreifen können, muss Domäne D Domäne A vertrauen. <br><br>  Es gibt zwei Arten von Vertrauensrichtungen: <br><br><ul><li>  einseitig; </li><li>  bilateral. </li></ul><br>  One-Way-Trust ist ein One-Way-Authentifizierungspfad, der zwischen zwei Domänen erstellt wird.  Bei einer unidirektionalen Vertrauensstellung zwischen Domäne A und Domäne B haben Benutzer in Domäne B Zugriff auf Ressourcen in Domäne A. Benutzer in Domäne A haben jedoch keinen Zugriff auf Ressourcen in Domäne B. Diese Art der Vertrauensstellung ist nicht transitiv. <br><br>  Bilaterales Vertrauen ist eine Kombination aus zwei unidirektionalen Vertrauensbeziehungen.  Bei bidirektionaler Vertrauenswürdigkeit zwischen den Domänen A und B haben ihre Benutzer Zugriff auf die Ressourcen beider Domänen.  Diese Art von Vertrauen ist transitiv. <br><br>  Die Richtung des Vertrauens ist immer entgegengesetzt zur Richtung des Zugriffs.  Das repräsentative Diagramm von Microsoft unten: <br><img src="https://habrastorage.org/webt/r2/d6/jo/r2d6jope8ji-ivoblptob-s5y94.png"><br>  Links für detailliertere Vertrauensarten: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Externes Vertrauen</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Reich</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Wald</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Verknüpfung</a> </li></ul><br><h4>  Kerberos zwischen vertrauenswürdigen Domänen </h4><br>  Betrachten Sie ein Beispiel.  Der Client versucht, auf den Server zuzugreifen. <br><br><div class="spoiler">  <b class="spoiler_title">Von Punkt 1 bis 3 werden Standardaktionen ausgeführt, wenn das Kerberos-Protokoll verwendet wird.</b> <div class="spoiler_text"><ul><li>  Das Passwort wird in einen NTLM-Hash konvertiert, der Zeitstempel wird mit einem Hash verschlüsselt und als Authentifikator in der TGT-Ticketanforderung (AS-REQ) an KDC gesendet.  Der Domänencontroller (KDC) überprüft die Benutzerinformationen und erstellt ein TGT-Ticket. </li><li>  Das TGT-Ticket wird verschlüsselt, signiert und an den Benutzer gesendet (AS-REP).  Nur der Kerberos-Dienst (KRBTGT) kann Daten aus einem TGT-Ticket öffnen und lesen. </li><li>  Ein Benutzer sendet ein TGT-Ticket an einen Domänencontroller, wenn er ein TGS-Ticket (TGS-REQ) anfordert.  Der Domänencontroller öffnet ein TGT-Ticket und überprüft die PAC-Prüfsumme. </li></ul><br></div></div><br>  Änderungen beginnen ab Punkt 4: Ein Inter-Realm-TGT-Ticket wird angezeigt, das sogenannte Empfehlungs-Ticket, das mit einem Inter-Realm-Schlüssel verschlüsselt / signiert wird, der aus einem vertrauenswürdigen Kennwort erstellt wurde.  Ein vertrauenswürdiges Kennwort wird festgelegt, wenn eine Vertrauensstellung hergestellt wird, und ist beiden Domänencontrollern bekannt.  Mithilfe des Inter-Realm-TGT-Tickets kann ein Benutzer der Domäne 1 ein TGS-Ticket anfordern, um auf Ressourcen der Domäne 2 zuzugreifen. <br><br><img src="https://habrastorage.org/webt/s4/3v/hj/s43vhjcgbdqvzebpjmra7d2cr_g.png"><br><br><h4>  NTLM zwischen vertrauenswürdigen Domänen </h4><br><img src="https://habrastorage.org/webt/v2/2c/x4/v22cx4pt6iw7mlgxrlus2t3xdqs.png"><br><br><ol><li>  Der Client sendet eine Authentifizierungsanforderung direkt an die Ressource selbst in einer anderen Domäne, auf die er zugreifen möchte. </li><li>  Der Server empfängt eine Anfrage vom Client und sendet ihm eine Antwort CHALLENGE_MESSAGE, die eine zufällige Folge von 8 Bytes enthält.  Es heißt Server Challenge. </li><li>  Der Client, der die Server Challenge-Sequenz vom Server erhalten hat, verschlüsselt diese Sequenz mit seinem Kennwort und sendet dem Server eine Antwort, die 24 Bytes enthält. </li><li>  Der Server sendet eine Anfrage und Antwort an den Controller seiner Domäne B. </li><li>  Bei der Authentifizierung zwischen Vertrauensstellungen wird die folgende Logik ausgeführt: <br><br><ul><li>  Überprüfte Richtungsvertrauensbeziehungen. <br><ul><li>  Client-Anmeldeinformationen werden zur Authentifizierung an Domäne A gesendet. </li><li>  Wenn keine Vertrauensbeziehung besteht, wird die Transitivität mit Domäne A überprüft. </li></ul><br></li><li>  Transitivitätsüberprüfung zwischen Domänen <br><ul><li>  Wenn zwischen Domänen Transitivität besteht, wird eine Authentifizierungsanforderung an die nächste Domäne im Vertrauenspfad gesendet.  Dieser Domänencontroller wiederholt den Vorgang und vergleicht die Benutzeranmeldeinformationen mit seiner Datenbank mit Sicherheitskonten. </li><li>  Wenn keine Transitivität vorliegt, wird eine Nachricht mit verweigertem Zugriff an den Client zurückgegeben. </li></ul><br></li></ul><br>  6-8.  Die Antwort mit der Entscheidung, den Client zu authentifizieren. <br><br><h1>  Angriffe zwischen Vertrauensstellungen zwischen Domänen </h1><br>  Um einen Angriff durchführen zu können, benötigen wir Informationen über vertrauenswürdige Beziehungen in unserer Domäne. <br><br><h4>  Auflisten von Trusts </h4><br>  Es gibt drei Hauptmethoden zum Auflisten von Vertrauensstellungen in einer Domäne: <br><br><ol><li>  über die Win32-API; </li><li>  über .NET-Methoden; </li><li>  über LDAP. </li></ol><br>  <b><i>Win32 API</i></b> <br><br>  Die Aufzählung erfolgt durch Aufrufen der Funktion <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">DsEnumerateDomainTrusts</a> , die die Struktur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">DS_DOMAIN_TRUSTSA zurückgibt</a> .  Bei dieser Methode werden die SID und GUID der Zieldomäne sowie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Flags</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Attribute zurückgegeben,</a> die das aktuelle Vertrauen in die Domäne kennzeichnen. <br><br><div class="spoiler">  <b class="spoiler_title">Flaggen</b> <div class="spoiler_text"><div class="scrollable-table"><table><tbody><tr><td>  DS_DOMAIN_DIRECT_INBOUND </td><td>  Listen Sie Domänen auf, die der Domäne mit Servername als Mitglied direkt vertrauen. </td></tr><tr><td>  DS_DOMAIN_DIRECT_OUTBOUND </td><td>  Listen Sie Domänen auf, denen die Domäne mit ServerName als Mitglied direkt vertraut. </td></tr><tr><td>  DS_DOMAIN_IN_FOREST </td><td>  Listen Sie Domänen auf, die Mitglied derselben Gesamtstruktur sind, deren Mitglied Servername ist. </td></tr><tr><td>  DS_DOMAIN_NATIVE_MODE </td><td>  Zählen Sie Domänen auf, in denen die primäre Domäne im nativen Windows 2000-Modus ausgeführt wird. </td></tr><tr><td>  DS_DOMAIN_PRIMARY </td><td>  Listen Sie Domänen auf, die die primäre Domäne der Domäne sind, deren Mitglied Servername ist. </td></tr><tr><td>  DS_DOMAIN_TREE_ROOT </td><td>  Listen Sie Domänen auf, die sich im Stammverzeichnis der Gesamtstruktur befinden, deren Mitglied Servername ist. </td></tr></tbody></table></div><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Attribute</b> <div class="spoiler_text"><br><br><div class="scrollable-table"><table><tbody><tr><td>  TRUST_ATTRIBUTE_NON_TRANSITIVE </td><td>  Transitivität nicht zulassen. </td></tr><tr><td>  TRUST_ATTRIBUTE_UPLEVEL_ONLY </td><td>  Der Vertrauenslink ist für Client-Betriebssysteme vor Windows 2000 nicht gültig. </td></tr><tr><td>  TRUST_ATTRIBUTE_FILTER_SIDS </td><td>  Domänen unter Quarantäne stellen. </td></tr><tr><td>  TRUST_ATTRIBUTE_FOREST_TRANSITIVE </td><td>  Der Vertrauenslink kann Gesamtstruktur-Vertrauensinformationen enthalten. </td></tr><tr><td>  TRUST_ATTRIBUTE_CROSS_ORGANIZATION </td><td>  Diese Vertrauensstellung gilt für eine Domäne / Gesamtstruktur, die nicht Teil dieses Unternehmens ist. </td></tr><tr><td>  TRUST_ATTRIBUTE_TREAT_AS_EXTERNAL </td><td>  Vertrauen wird für Vertrauensgrenzenzwecke als extern behandelt. </td></tr><tr><td>  TRUST_ATTRIBUTE_WITHIN_FOREST </td><td>  Vertrauen ist in diesem Wald verankert. </td></tr></tbody></table></div><br></div></div><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">BloodHound</a> sammelt Informationen mithilfe der Win32-API-Methode. <br><br><img src="https://habrastorage.org/webt/d4/hq/df/d4hqdf50vvyi6k4b2bv6dbcnekw.png"><br><br>  <b><i>.Net</i></b> <br><br>  Die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">GetCurrentDomain-</a> Methode aus dem Namespace [System.DirectoryServices.ActiveDirectory.Domain] wird verwendet, die eine Instanz der Klasse <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">System.DirectoryServices.ActiveDirectory.Domain</a> zurückgibt.  Diese Klasse implementiert die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">GetAllTrustRelationships-</a> Methode, die alle Vertrauensstellungen für die aktuelle Domäne zurückgibt. <br><br><pre><code class="bash hljs">([System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()).GetAllTrustRelationships()</code> </pre> <br>  Die Verwendung dieser Methode ist im Modul Get-DomainTrust in <a href="">PowerView implementiert</a> . <br><br><img src="https://habrastorage.org/webt/bv/px/vf/bvpxvf6de-v4o3f04sp5mtrgdd0.png"><br><br>  Einer der Vorteile dieser Methode ist ihre Einfachheit.  Informationen sind leicht zu lesen und zu verstehen, aber ihr Volumen ist viel kleiner als bei der Aufzählung mit anderen Methoden. <br><br>  <b><i>LDAP</i></b> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Domänenvertrauensinformationen</a> werden in Active Directory als <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">objectClass</a> der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">trustDomain-</a> Klasse <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">gespeichert</a> . <br><br>  Anwendungsbeispiel: <br><br><pre> <code class="bash hljs">dsquery * -filter <span class="hljs-string"><span class="hljs-string">"(objectClass=trustedDomain)"</span></span> -attr *</code> </pre> <br><img src="https://habrastorage.org/webt/oa/xc/2x/oaxc2xunppmfjl7vpjztuudgm5e.png"><br><br>  <a href="">PowerView</a> verwendet diese Methode standardmäßig. <br><br><img src="https://habrastorage.org/webt/cx/p1/_w/cxp1_w24rxlh7-naqk5swez6vc4.png"><br><br>  Mit Informationen zu Domänen und Vertrauensarten können Sie direkt zum Angriff selbst wechseln.  Betrachten Sie 2 Optionen: <br><br><ol><li>  Wir haben es geschafft, die Domain zu gefährden, und wir haben Domain-Administratorrechte. </li><li>  Wir haben keine Domain-Administratorrechte. </li></ol><br><h2>  Mit Administratorrechten für eine der Domänen </h2><br>  Abhängig von der Domäne, die kompromittiert wurde, können mehrere Angriffsvektoren unterschieden werden: <br><br><br><div class="scrollable-table"><table><tbody><tr><td>  Nein, nein. </td><td>  Domain starten  Angreiferposition </td><td>  Angegriffene Domain </td><td>  Angriffstechnik </td><td>  Vertrauensbeziehung </td></tr><tr><td>  1 </td><td>  Wurzel </td><td>  Kind </td><td>  Golden Ticket + Enterprise Admin Group </td><td>  Inter-Realm (2-Wege) </td></tr><tr><td>  2 </td><td>  Kind </td><td>  Kind </td><td>  SID-Verlaufsoperation </td><td>  Inter-Realm Eltern-Kind (2-Wege) </td></tr><tr><td>  3 </td><td>  Kind </td><td>  Wurzel </td><td>  SID-Verlaufsoperation <br>  Ticketverkauf vertrauen </td><td>  Inter-Realm-Baumwurzel (2-Wege) </td></tr><tr><td>  4 </td><td>  Wald 1 </td><td>  Wald 2 </td><td>  Druckerfehler </td><td>  Inter-Realm Forest oder externes Vertrauen (2-Wege) </td></tr></tbody></table></div><br>  Es ist erwähnenswert, dass für die erfolgreiche Implementierung aller Vektoren bilaterales Vertrauen zwischen Domänen erforderlich ist. <br><br><h4>  <i>1. Betriebs-SID-Verlauf</i> </h4><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Der SID-Verlauf</a> wurde eingeführt, um die Migration von Benutzern von einer Domäne zu einer anderen zu erleichtern.  Das Attribut enthält die vorherigen SID-Objekte.  Jedes Mal, wenn ein Objekt von einer Domäne in eine andere verschoben wird, wird eine neue SID erstellt, die zu einer objectSID wird.  Die vorherige SID wird der Eigenschaft sIDHistory hinzugefügt. <br><br>  Jede Gesamtstruktur verfügt über eine Benutzergruppe für Unternehmensadministratoren, die nur in der Stammdomäne vorhanden ist und über lokale Administratorrechte auf den Domänencontrollern aller untergeordneten Domänen in der Gesamtstruktur verfügt.  Dieser Angriff wurde erstmals von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Sean Metcalf</a> auf der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">BlackHat USA 2015</a> demonstriert.  Das Wesentliche des Angriffs ist, dass wir ein Goldenes Ticket mit einer zusätzlichen SID der Enterprise Admins-Gruppe ausstellen.  Dies erfolgt durch Hinzufügen von ExtraSids in der Struktur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">KERB_SID_AND_ATTRIBUTES</a> , die in der Struktur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">KERB_VALIDATION_INFO gesendet wird</a> . <br><br><img src="https://habrastorage.org/webt/kl/hy/fj/klhyfjzath65qptysuylgzft-fk.png"><br><br>  Angriffsdemo: <br><br><img src="https://habrastorage.org/webt/v6/ia/1g/v6ia1gvjk-sxs7x8plq6uvwojjk.gif"><br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Impacket</a> hat ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Skript</a> , das all dies automatisiert. <br><br><h4>  <i>2. Golden Ticket + Enterprise Admin Group</i> </h4><br>  Mit Administratorrechten in der Stammdomäne können wir ein Goldenes Ticket erstellen, indem wir einen Benutzer zur Gruppe der Unternehmensadministratoren hinzufügen (519). <br><br><pre> <code class="bash hljs">Kerberos::golden /domain:&lt;domain&gt; /sid:&lt;domain_SID&gt; /krbtgt:&lt;ntlm_hash_krbtgt_user&gt; /user:&lt;user&gt; /groups:500,501,513,512,520,518,519 /ptt</code> </pre> <br>  Wie oben beschrieben, verfügt Enterprise Admin über lokale Administratorrechte für untergeordnete DC-Domänen.  Auf diese Weise können wir alle untergeordneten Domänen in der Gesamtstruktur gefährden. <br><br><h4>  <i>3. Betrieb von Trust Tickets</i> </h4><br>  Für den Zugriff auf eine Ressource mithilfe des Kerberos-Protokolls benötigen Sie ein TGS-Ticket, das mit dem NTLM-Hash des Dienstkontokennworts verschlüsselt ist.  Ein Domänencontroller speichert nur Hashes von Benutzerkennwörtern für seine Domäne. Wenn also ein Benutzer aus Domäne A Zugriff auf eine Ressource in Domäne B benötigt, wird ein Inter-Realm-Schlüssel verwendet.  Dieser Schlüssel wird auf der Grundlage eines vertrauenswürdigen Kennworts erstellt, das beim Erstellen von Vertrauensstellungen zwischen Domänen in derselben Gesamtstruktur festgelegt wird.  In der Kennwortdatenbank (NTDS.dit) auf dem Domänencontroller finden Sie Benutzer mit dem $ -Zeichen am Ende.  Ihr Passwort wird auch zum Erstellen von Inter-Realm-Schlüsseln verwendet.  Um ein Inter-Realm-TGT-Ticket zu erstellen, benötigen wir einen Passwort-Hash dieses Kontos. <br><br><pre> <code class="bash hljs">Kerberos::golden /user:&lt;user&gt; /domain:&lt;domain&gt; /sid:&lt;sid_domain&gt; /sids:&lt;extra_sid_entrprice_admin_group_from _another_domain&gt; /aes256:&lt;aes256_trust_user_password&gt; /service:krbtgt /target:&lt;target_domain&gt; /ptt</code> </pre> <br>  Angriffsdemo: <br><br><img src="https://habrastorage.org/webt/fk/cv/ji/fkcvjizxaup946gngi9zsk6xqm8.gif"><br><br>  Der Angriff ist besonders relevant, wenn der IS-Dienst eine Bedrohung festgestellt und das Kennwort krbtgt zweimal geändert hat.  In diesem Fall können wir goldene Tickets mit einem vertrauenswürdigen Kennwort zwischen Domänen erstellen. <br><br><h4>  <i>4. Druckerfehler</i> </h4><br>  Für das Windows Print System-Remoteprotokoll (MS-RPRN) ist standardmäßig die Methode RpcRemoteFindFirstPrinterChangeNotification (Ex) aktiviert, mit der Sie die Authentifizierung auf jedem Computer erzwingen können, auf dem der Spooler-Dienst auf dem angegebenen Host mithilfe des Kerberos- oder NTLM-Protokolls ausgeführt wird.  Im Fall von c NTLM können wir NTLM-Relay ausführen oder das Computerkennwort knacken (niemals deaktivieren).  Bei Kerberos ist ein kompromittierter Computer mit unbegrenzter Delegierung erforderlich.  Dann können wir ein TGT-Ticket abholen und einen Angriff entwickeln. <br><br>  Angriffsdemo: <br><br><img src="https://habrastorage.org/webt/3g/h9/gf/3gh9gfnx0b6k8hucav8zy964ap0.gif"><br><br>  Die folgende Abbildung zeigt die im Video gezeigten Schritte. <br><br><img src="https://habrastorage.org/webt/cu/e0/0l/cue00l2_x_fdpsxj0vyalrvjscs.png"><br><br><h2>  Wir haben keine Domain-Administratorrechte </h2><br>  Ein bisschen Theorie.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Carlos Garsia gab</a> in seinem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Bericht</a> eine ausgezeichnete Tabelle, die die Eigenschaften verschiedener Arten von Gruppen veranschaulicht. <br><br><img src="https://habrastorage.org/webt/jz/5x/jc/jz5xjcruevdpcv_jnz1knoyh1oi.png"><br><br>  Bei den Funktionen ist zu berücksichtigen, <a href="">dass lokale AD-Domänen- und globale AD-Gruppen ohne Gruppenmitglieder in den globalen Katalog repliziert werden und AD Universal-Gruppen mit Benutzern repliziert werden.</a> <br><blockquote>  Aufgrund der Art und Weise, wie Gruppen im globalen Katalog aufgelistet werden, können die Ergebnisse einer Backlink-Suche (dh der Memb-Suche) variieren, je nachdem, ob Sie den globalen Katalog (Port 3268) oder die Domäne (Port 389) durchsuchen Gruppen, zu denen der Benutzer gehört (globale Gruppen vs. lokale Domänengruppen). </blockquote>  Für den Fall, dass wir keine Domänenadministratorrechte haben, listen wir die Objekte auf.  Wir interessieren uns für: <br><ol><li>  Benutzer einer anderen Domäne mit lokalen Administratorrechten auf Computern in unserer Domäne. </li><li>  Benutzer aus anderen Domänen, die Mitglieder von Benutzerdomänengruppen sind.  Gruppen mit Benutzern aus einer anderen Domäne. </li><li>  Ausländische ACL-Principals. </li></ol><br><h4>  <i>1. Benutzer einer anderen Domäne mit lokalen Administratorrechten auf Computern in unserer Domäne</i> </h4><br>  Suchen Sie in BloodHound nach Benutzern aus einer anderen Domain, die lokale Administratoren auf Hosts in unserer Domain sind: <br><br><pre> <code class="bash hljs">MATCH (c:Computer) OPTIONAL MATCH p1 = (u1)-[:AdminTo]-&gt;(c) WHERE NOT u1.domain = c.domain WITH p1,c OPTIONAL MATCH p2 = (u2)-[:MemberOf*1..]-&gt;(:Group)-[:AdminTo]-&gt;(c) WHERE NOT u2.domain = c.domain RETURN p1,p2</code> </pre><br><img src="https://habrastorage.org/webt/07/2y/92/072y92dgtftil5yz9uvrgv8ui3a.png"><br><br>  Befehl in <a href="">PowerView</a> : <br><br><pre> <code class="bash hljs">Get-NetLocalGroupMember &lt;server&gt;</code> </pre> <br><h4>  <i>2. Benutzer aus anderen Domänen, bestehend aus Benutzerdomänengruppen.</i>  <i>Gruppen mit Benutzern aus einer anderen Domäne</i> </h4><br>  Wie oben erwähnt, werden Benutzer, die nur Mitglieder von Universal-Gruppen sind, in den globalen Katalog repliziert.  Um diese Funktion zu demonstrieren, werden Gruppen im globalen Katalog abgefragt, die mindestens einen Benutzer und eine direkte LDAP-Anforderung an den Domänencontroller enthalten. <br><br><pre> <code class="bash hljs">Get-DomainGroup -Properties name, grouptype, member, DistinguishedName -LDAPFilter <span class="hljs-string"><span class="hljs-string">'(member=*)'</span></span> -SearchBase <span class="hljs-string"><span class="hljs-string">"GC://jet.lab"</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/vr/zv/sd/vrzvsdj1pez6rn-ndb4_zcklpdu.png"><br><br>  Beim Ausführen einer Abfrage an den globalen Katalog wird nur eine Universalgruppengruppe mit dem Typ AD Universal aus der Domäne one.jet.lab angezeigt. <br><br>  Wenn wir eine direkte LDAP-Abfrage an one.jet.lab ausführen, werden andere Gruppen vom Typ AD Domain local und AD Global angezeigt. <br><br><img src="https://habrastorage.org/webt/jf/3n/ku/jf3nkumv72dhsoyhb8kpqntq9ba.png"><br><br>  Dies ist wichtig, wenn Benutzer und Gruppen aufgelistet werden. <br><br>  Befehle in <a href="">PowerView</a> : <br><br><pre> <code class="bash hljs">Get-DomainForeignUser -Domain &lt;Domain&gt; Get-DomainForeignGroupMember -Domain &lt;Domain&gt;</code> </pre> <br><img src="https://habrastorage.org/webt/ia/no/24/iano24rfj4ldithcbqhapwts4uk.png"><br><br><img src="https://habrastorage.org/webt/zf/2n/f-/zf2nf-tutgsxrzz99pdp6199fw0.png"><br><br><h4>  <i>3. Ausländische ACL-Prinzipien</i> </h4><br>  Der Sicherheitsdeskriptor ntSecurityDescriptor (https://docs.microsoft.com/en-us/windows/win32/adschema/a-ntsecuritydescriptor) ist für alle Benutzer aus vertrauenswürdigen Domänen zugänglich und wird in den globalen Katalog repliziert.  Auf diese Weise können wir alle DACLs für alle Objekte in vertrauenswürdigen Domänen abfragen und Benutzer aus anderen Domänen filtern. <br><br><pre> <code class="bash hljs">Get-DomainObjectAcl -Domain jet.lab -ResolveGuids | ?{<span class="hljs-variable"><span class="hljs-variable">$_</span></span>.SecurityIdentifier -like <span class="hljs-string"><span class="hljs-string">'SID_Domain*'</span></span>}</code> </pre> <br><img src="https://habrastorage.org/webt/fw/kn/si/fwknsimcsrubz0tputfddzosgr0.png"><br><br>  Daher konnten wir den Benutzer Mike aus der Domäne "c.c.lab "identifizieren, der Rechte an der globalen Gruppe in der Domäne" jet.lab "hatte. <br><br>  PS SID-Filterung und selektive Authentifizierung werden zum Schutz zwischen Gesamtstrukturen verwendet.  Ein Angriff zwischen Wäldern mit SID-Filterung <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ermöglichte Dirkjan</a> in seinem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Blog</a> .  Ebenfalls am 9. Juli veröffentlichte Microsoft ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Update</a> , das die TGT-Delegierung zwischen Gesamtstrukturen standardmäßig deaktiviert.  Jetzt funktioniert die Story mit unbegrenzter Delegierung und Kompromittierung einer Gesamtstruktur von einer anderen mithilfe des Kerberos-Protokolls nicht mehr. </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de466445/">https://habr.com/ru/post/de466445/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de466435/index.html">Schulung Cisco 200-125 CCNA v3.0. Tag 42. Inter-VLAN-Routing und SVI</a></li>
<li><a href="../de466437/index.html">Schulung Cisco 200-125 CCNA v3.0. Tag 43. Routing-Protokolle Distanzvektor und Verbindungsstatus</a></li>
<li><a href="../de466439/index.html">Überprüfen Sie selbst: Wie viele Fragen können Sie ChGK beantworten?</a></li>
<li><a href="../de466441/index.html">Python-Buggy-Code: 10 häufigste Fehler, die Entwickler machen</a></li>
<li><a href="../de466443/index.html">ShIoTiny und die Welt: Analoge Sensoren oder ADCs für die Kleinsten</a></li>
<li><a href="../de466447/index.html">Wofür sollen wir ein CDN bauen?</a></li>
<li><a href="../de466449/index.html">Schulung Cisco 200-125 CCNA v3.0. Tag 44. Einführung in OSPF</a></li>
<li><a href="../de466451/index.html">Read_You kann nicht werfen</a></li>
<li><a href="../de466453/index.html">Schulung Cisco 200-125 CCNA v3.0. Tag 45. Konfigurieren von OSPF</a></li>
<li><a href="../de466455/index.html">Services, Microservices und Batch-orientierte Programmierung</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>