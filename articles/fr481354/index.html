<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§® üõÄüèæ üéà TelegramBot. La fonctionnalit√© de base. Mouches s√©par√©ment, c√¥telettes s√©par√©ment. (2e partie) üéûÔ∏è üíÜüèº üÜî</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous continuons √† d√©velopper les fonctionnalit√©s de base du bot dans les t√©l√©grammes. Dans les parties pr√©c√©dentes, nous avons discut√© du fait que le ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>TelegramBot. La fonctionnalit√© de base. Mouches s√©par√©ment, c√¥telettes s√©par√©ment. (2e partie)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481354/">  Nous continuons √† d√©velopper les fonctionnalit√©s de base du bot dans les t√©l√©grammes.  Dans les parties pr√©c√©dentes, nous avons discut√© du fait que le travail du bot sur la r√©ception des messages, le traitement et l'envoi devrait √™tre divis√©.  Essayons d'utiliser les outils de base de Java Core pour rendre notre bot multithread et asynchrone.  Nous allons proposer une t√¢che qui prend beaucoup de temps √† traiter.  Voyons comment fonctionnent les commandes du t√©l√©gramme et comment elles doivent √™tre trait√©es. <br><br>  Ceci est une continuation de la premi√®re partie de l'article sur la programmation des bots pour les t√©l√©grammes en Java <br>  <a href="https://habr.com/ru/post/476306/">Instructions TelegramBot pour cr√©er des fonctionnalit√©s de base pour le bot.</a>  <a href="https://habr.com/ru/post/476306/">(Partie 1)</a> <br>  Pour qui c'est encore int√©ressant, vous √™tes les bienvenus‚Ä¶ <br><a name="habracut"></a><br>  Je dois dire tout de suite que dans cette partie, beaucoup de tout a √©t√© ajout√© en m√™me temps et nous analyserons tranquillement toutes les fonctionnalit√©s qui ont permis au bot de pouvoir multithread et pourquoi elles sont n√©cessaires. <br><br>  Comme d'habitude du principal: <br>  Vous pouvez trouver tout le code pr√™t √† l'emploi pour cet article dans la branche <a href="https://github.com/dp-ua/TelegramBotBase/tree/Part2-Handlers" rel="nofollow">Part2-Handlers</a> du r√©f√©rentiel git. <br>  Le code fonctionne pleinement, il suffit d'incliner, de modifier les donn√©es pour l'autorisation du bot (nom et token) et d'ex√©cuter la m√©thode principale dans la classe App.class. <br><br>  <i>Veuillez noter que cette classe envoie une notification √† l'administrateur du bot lorsque le bot d√©marre que le bot a d√©marr√©.</i>  <i>L'ID administrateur du bot est √©galement sp√©cifi√© dans la classe App.class et si vous ne le changez pas, votre bot essaiera de m'envoyer des messages :)</i> <br><br>  Et plus loin sur les points, nous analyserons les changements qui sont apparus apr√®s la sortie de la premi√®re partie. <br><br><h3>  Traitement des commandes </h3><br>  Pour commencer, examinons ce concept de ce qu'est une √©quipe en g√©n√©ral dans un syst√®me de communication avec un bot de t√©l√©gramme.  Selon les param√®tres du bot, il peut voir tous les messages de n'importe quel format ou uniquement des commandes sp√©cialement con√ßues.  Quelle est la diff√©rence et <br>  o√π vous pouvez rencontrer ces options de message. <br><br><ol><li>  <b>Texte brut, messages r√©guliers.</b> <br>  Sous cette forme, le bot re√ßoit des messages lorsqu'ils lui √©crivent en PM.  Et pourtant, si dans les param√®tres du bot <a href="https://core.telegram.org/bots" rel="nofollow">le mode de confidentialit√© dans les groupes est</a> d√©sactiv√©, le bot commence √† voir tous les messages compl√®tement.  Si ce param√®tre est activ√©, lorsqu'il est ajout√© au groupe, le bot ne voit que les commandes qui lui sont adress√©es.  √Ä quoi ils ressemblent - voir le deuxi√®me paragraphe </li><li>  <b>Des √©quipes sp√©cialement con√ßues</b> <br>  Ces commandes commencent toujours par une barre oblique: <b>/</b> <br>  Apr√®s cela vient l'√©quipe elle-m√™me.  Le texte de la commande doit √™tre sans espaces.  Un exemple: <br>  <b>/ start</b> <br>  Avec cette commande, tout utilisateur commence toujours la communication avec votre bot.  Par cons√©quent, selon les r√®gles de bonne forme, la r√©ponse √† cette commande doit √™tre prescrite. <br><img src="https://habrastorage.org/webt/ol/pi/ud/olpiudptbqgig5zhoqzpnpjquyq.png"><br>  Toutes les commandes avec lesquelles votre bot sait travailler, il est conseill√© d'ajouter √† la liste des comp√©tences dans les param√®tres de votre bot.  Tout cela se fait dans un t√©l√©gramme avec @BotFather. <br><br>  <b>En</b> appelant la <b>commande / myBots,</b> s√©lectionnez votre bot puis le bouton "Edit Bot" <br>  Vous obtiendrez une fen√™tre o√π tous les param√®tres du bot seront affich√©s, puis vous pourrez configurer toute son interface et indiquer avec quelles commandes votre bot peut fonctionner. <br><br><img src="https://habrastorage.org/webt/u6/7o/cl/u67oclalxrv7v3v83h1wzp91gr4.png"><br><br>  Ils sont d√©finis dans ce format: <br><br><img src="https://habrastorage.org/webt/-a/4x/i-/-a4xi-kqpuxjoielhmog7oh1tom.png"><br><br>  Et apr√®s cela, lorsque vous commencez √† entrer une commande dans votre bot, il affichera de l'aide avec une liste des commandes r√©pertori√©es: <br><br><img src="https://habrastorage.org/webt/hn/yi/wa/hnyiwabkhmbrc7zn0rbuzkfvook.png"><br><br>  Et il y a encore une nuance.  Un groupe peut contenir plusieurs bots, et s'ils ont des commandes communes (et des commandes communes seront obligatoires, le m√™me d√©marrage et l'aide sont impl√©ment√©s dans la plupart des bots), alors une partie sera ajout√©e √† la commande elle-m√™me, indiquant √† quel bot cette commande appartient.  Et la commande ressemblera compl√®tement √† ceci: <br>  <b>/ start @ test_habr_bot</b> <br></li></ol><br>  Et maintenant, connaissant toutes ces nuances, cr√©ons avec vous une telle option de traitement qui devrait comprendre les commandes commen√ßant par une barre oblique et sachant comment distinguer si la commande est adress√©e sp√©cifiquement √† votre bot ou √† une autre. <br><br>  Cr√©ez un package qui contiendra les classes responsables du traitement des commandes. <br>  <a href="https://github.com/dp-ua/TelegramBotBase/tree/Part2-Handlers/src/main/java/com/example/telegrambot/command" rel="nofollow">package com.example.telegrambot.command</a> <br><br>  Dans la classe Command, nous listons toutes les commandes que notre bot devrait √™tre capable de comprendre. <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> Command { NONE, NOTFORME, NOTIFY, START, HELP, ID }</code> </pre> <br>  Comme vous l'avez vu plus t√¥t, j'ai indiqu√© √† @BotFather que le bot je devrais √™tre capable de comprendre 4 √©quipes.  Ce sera un d√©marrage et une aide standard.  Nous en ajoutons un utile - id.  Et un de plus, notifiez, dont je parlerai un peu plus tard.  Et deux √©quipes NONE et NOTFORME, qui nous diront que le message texte n'est pas du tout une commande, ou que cette commande n'est pas pour notre bot. <br><br>  <a href="" rel="nofollow">Ajouter</a> une autre classe d'assistance <a href="" rel="nofollow">ParsedCommand</a> <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> lombok.AllArgsConstructor; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> lombok.Getter; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> lombok.NoArgsConstructor; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> lombok.Setter; <span class="hljs-meta"><span class="hljs-meta">@Getter</span></span> <span class="hljs-meta"><span class="hljs-meta">@Setter</span></span> <span class="hljs-meta"><span class="hljs-meta">@NoArgsConstructor</span></span> <span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ParsedCommand</span></span></span><span class="hljs-class"> </span></span>{ Command command = Command.NONE; String text=<span class="hljs-string"><span class="hljs-string">""</span></span>; }</code> </pre> <br>  Son objectif principal est de stocker le r√©sultat de l'analyse du texte dans les objets de cette classe.  Il ne contiendra que l'√©quipe elle-m√™me et tout le texte qui suit l'√©quipe. <br><br>  Et nous √©crirons une classe s√©par√©e qui analysera les √©quipes pour nous.  Classe d' <a href="" rel="nofollow">analyseur</a> <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javafx.util.Pair; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.log4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parser</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger log = Logger.getLogger(Parser.class); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String PREFIX_FOR_COMMAND = <span class="hljs-string"><span class="hljs-string">"/"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String DELIMITER_COMMAND_BOTNAME = <span class="hljs-string"><span class="hljs-string">"@"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String botName; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Parser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String botName)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.botName = botName; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ParsedCommand </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getParsedCommand</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String text)</span></span></span><span class="hljs-function"> </span></span>{ String trimText = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (text != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) trimText = text.trim(); ParsedCommand result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ParsedCommand(Command.NONE, trimText); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">""</span></span>.equals(trimText)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; Pair&lt;String, String&gt; commandAndText = getDelimitedCommandFromText(trimText); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isCommand(commandAndText.getKey())) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isCommandForMe(commandAndText.getKey())) { String commandForParse = cutCommandFromFullText(commandAndText.getKey()); Command commandFromText = getCommandFromText(commandForParse); result.setText(commandAndText.getValue()); result.setCommand(commandFromText); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { result.setCommand(Command.NOTFORME); result.setText(commandAndText.getValue()); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cutCommandFromFullText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String text)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text.contains(DELIMITER_COMMAND_BOTNAME) ? text.substring(<span class="hljs-number"><span class="hljs-number">1</span></span>, text.indexOf(DELIMITER_COMMAND_BOTNAME)) : text.substring(<span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Command </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCommandFromText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String text)</span></span></span><span class="hljs-function"> </span></span>{ String upperCaseText = text.toUpperCase().trim(); Command command = Command.NONE; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { command = Command.valueOf(upperCaseText); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IllegalArgumentException e) { log.debug(<span class="hljs-string"><span class="hljs-string">"Can't parse command: "</span></span> + text); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> command; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Pair&lt;String, String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDelimitedCommandFromText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String trimText)</span></span></span><span class="hljs-function"> </span></span>{ Pair&lt;String, String&gt; commandText; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (trimText.contains(<span class="hljs-string"><span class="hljs-string">" "</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> indexOfSpace = trimText.indexOf(<span class="hljs-string"><span class="hljs-string">" "</span></span>); commandText = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Pair&lt;&gt;(trimText.substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, indexOfSpace), trimText.substring(indexOfSpace + <span class="hljs-number"><span class="hljs-number">1</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> commandText = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Pair&lt;&gt;(trimText, <span class="hljs-string"><span class="hljs-string">""</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> commandText; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isCommandForMe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String command)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command.contains(DELIMITER_COMMAND_BOTNAME)) { String botNameForEqual = command.substring(command.indexOf(DELIMITER_COMMAND_BOTNAME) + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> botName.equals(botNameForEqual); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isCommand</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String text)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text.startsWith(PREFIX_FOR_COMMAND); } }</code> </pre> <br>  Bref.  Lors de l'initialisation de l'analyseur, nous devons passer le nom de notre bot dans le constructeur afin que l'analyseur puisse distinguer ses commandes des √©trangers. <br><br>  Eh bien, nous appelons simplement la m√©thode publique <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ParsedCommand </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getParsedCommand</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String text)</span></span></span></span></code> </pre> <br>  √Ä qui nous passons le texte du message dans les arguments, et il doit nous renvoyer une commande et le texte du message venant apr√®s la commande. <br><br>  Vous pouvez voir comment l'analyseur fonctionne dans la <a href="" rel="nofollow">classe de test</a> . <br><br><h3>  Mouches s√©par√©ment, escalopes s√©par√©ment </h3><br>  Maintenant, nous devons apprendre √† notre robot √† recevoir s√©par√©ment des messages, √† traiter et √† envoyer des r√©ponses.  Apr√®s une s√©rie d'essais et d'erreurs, j'en suis venu √† cette logique de l'application. <br>  La classe principale <a href="" rel="nofollow">Bot</a> fonctionnera dans le thread principal de l'application et ne sera occup√©e que par le fait que tous les messages re√ßus seront plac√©s dans une file d'attente sp√©ciale et sera √©galement un conteneur pour les messages que nous pr√©voyons d'envoyer √† l'utilisateur en r√©ponse. <br><br>  Les changements dans cette classe sont tr√®s mineurs.  Nous avons ajout√© deux files d'attente: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Queue&lt;Object&gt; sendQueue = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentLinkedQueue&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Queue&lt;Object&gt; receiveQueue = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentLinkedQueue&lt;&gt;();</code> </pre><br>  et l√©g√®rement r√©√©crit le code de fonction <b>public void onUpdateReceived (Update update)</b> <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUpdateReceived</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Update update)</span></span></span><span class="hljs-function"> </span></span>{ log.debug(<span class="hljs-string"><span class="hljs-string">"Receive new Update. updateID: "</span></span> + update.getUpdateId()); receiveQueue.add(update); }</code> </pre> <br>  Pourquoi  Encore une fois, j'ai essay√© diff√©rentes options.  Et le principal probl√®me du multithreading est de travailler avec des donn√©es partag√©es.  Et surtout, j'ai aim√© la fa√ßon dont l'impl√©mentation des files d'attente multithread <b>ConcurrentLinkedQueue &lt;&gt; ()</b> g√®re cela. <br>  Et comme vous pouvez le voir, dans les deux files d'attente, nous stockons les types de donn√©es d'objet.  Ceci est un autre signet pour l'avenir.  Ainsi, nous ne sommes pas attach√©s aux types de messages re√ßus.  Dans la file d'attente entrante, nous pouvons ajouter non seulement des objets du type Mise √† jour, mais aussi certains autres objets dont nous avons besoin. <br><br>  La m√™me chose avec la file d'attente d'envoi.  Comme nous pouvons envoyer diff√©rents types de messages et qu'ils n'ont pas de parent commun - nous utilisons √©galement un type de donn√©es commun - Object. <br>  Si vous ex√©cutez le bot sous cette forme, cela fonctionnera, mais ne fera rien.  Il enregistrera tous les messages re√ßus dans le journal et les mettra dans la file d'attente. <br>  Par cons√©quent, nous avons besoin d'une sorte de thread qui s'occupe de prendre les messages re√ßus de la file d'attente et d'effectuer certaines actions sur eux et de mettre les r√©sultats de son travail dans la file d'attente <b>sendQueue</b> . <br><br>  Cr√©ons un package s√©par√©: <a href="https://github.com/dp-ua/TelegramBotBase/tree/Part2-Handlers/src/main/java/com/example/telegrambot/service" rel="nofollow">service</a> et nous n'y aurons que 2 classes: <br><br>  <b>MessageReciever</b> - gestionnaire de messages re√ßus <br>  <b>MessageSender</b> est le gestionnaire de file d'attente de messages √† envoyer √† l'utilisateur. <br><br>  Nous consid√©rerons leur travail un peu plus bas, mais pour l'instant, nous d√©crirons leur utilisation dans notre classe de d√©part <a href="" rel="nofollow">App</a> <br><br>  Une fois notre bot connect√©, nous d√©marrons nos gestionnaires dans des threads s√©par√©s: <br><br><pre> <code class="java hljs">MessageReciever messageReciever = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MessageReciever(test_habr_bot); MessageSender messageSender = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MessageSender(test_habr_bot); test_habr_bot.botConnect(); Thread receiver = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(messageReciever); receiver.setDaemon(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); receiver.setName(<span class="hljs-string"><span class="hljs-string">"MsgReciever"</span></span>); receiver.setPriority(PRIORITY_FOR_RECEIVER); receiver.start(); Thread sender = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(messageSender); sender.setDaemon(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); sender.setName(<span class="hljs-string"><span class="hljs-string">"MsgSender"</span></span>); sender.setPriority(PRIORITY_FOR_SENDER); sender.start();</code> </pre><br>  Pour les deux threads, nous sp√©cifions le mode d√©mon.  Cela est n√©cessaire pour que les threads fonctionnent tant que le thread principal est en cours d'ex√©cution et pour se terminer d√®s qu'il arr√™te son travail. <br><br>  Nous ne voudrions pas d'abord traiter le gestionnaire de messages entrants - examinons le fonctionnement de la classe <a href="" rel="nofollow">MessageSender</a> . <br><br>  Voyons ce qu'il peut faire et ce qu'il fait: <br><br><ul><li>  Naturellement, il s'agit d'un h√©ritage de l'interface pour le multithreading: <br>  <b>impl√©mente runnable</b> <br>  et impl√©mentation de la fonction <b>run</b> <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span></code> </pre> <br>  Ici, nous commen√ßons la boucle infinie, qui est uniquement occup√©e par le fait qu'elle v√©rifie la file d'attente d'envoi et appelle la commande d'envoi <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object object)</span></span></span></span></code> </pre> <br>  si quelque chose appara√Æt dans la file d'attente. <br></li><li>  Dans le constructeur de classe, nous passons l'objet de la classe Bot, car  nous en prendrons des objets pour envoyer des messages et avec lui nous les enverrons. </li><li>  La m√©thode d'envoi d√©termine le type de message √† envoyer et lui applique la commande appropri√©e. </li></ul><br>  Eh bien, regardons maintenant <a href="" rel="nofollow">le</a> travail de la classe <a href="" rel="nofollow">MessageReciever</a> <br><br>  Il doit, comme MessageSender, √™tre multithread, dans le constructeur recevoir un objet de classe Bot, dans lequel il va prendre les messages re√ßus dans une boucle infinie, les traiter et le mettre dans la file d'attente pour envoyer les r√©sultats de son travail. <br><br>  Ici, nous utilisons l'analyseur de commandes cr√©√© pr√©c√©demment.  Et puis nous ajoutons la possibilit√© d'utiliser diff√©rents types de gestionnaires pour nos √©quipes et certains d'entre eux nous rendrons multi-thread. <br><br>  Le cycle de travail est tr√®s simple: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"[STARTED] MsgReciever. Bot class: "</span></span> + bot); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Object object = bot.receiveQueue.poll(); object != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; object = bot.receiveQueue.poll()) { log.debug(<span class="hljs-string"><span class="hljs-string">"New object for analyze in queue "</span></span> + object.toString()); analyze(object); } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Thread.sleep(WAIT_FOR_NEW_MESSAGE_DELAY); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (InterruptedException e) { log.error(<span class="hljs-string"><span class="hljs-string">"Catch interrupt. Exit"</span></span>, e); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } } }</code> </pre> <br>  V√©rifiez la file d'attente.  S'il y a quelque chose, lancez l'analyseur: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">analyze</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object object)</span></span></span></span></code> </pre> <br>  S'il n'y a rien, nous attendons. <br><br>  L'analyseur v√©rifie le type d'objet.  S'il sait comment travailler avec lui, il d√©marre le prochain analyseur.  Si vous ne pouvez pas - jure :) <br><br>  Pourquoi  Encore une fois, il s'agit d'un signet pour l'avenir et, je l'esp√®re, je le divulguerai dans les prochaines parties de cette s√©rie d'articles.  Une telle impl√©mentation nous permettra ensuite de former nos propres t√¢ches pour le bot, de faire des listes de diffusion, des t√¢ches quotidiennes.  Pour cela, le r√©cepteur doit √™tre capable de traiter non seulement des objets de type Update, mais aussi quelque chose √† nous.  Mais plus √† ce sujet plus tard :) <br><br>  Consid√©rez l'analyseur pour le type de mise √† jour plus en d√©tail: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">analyzeForUpdateType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Update update)</span></span></span><span class="hljs-function"> </span></span>{ Long chatId = update.getMessage().getChatId(); String inputText = update.getMessage().getText(); ParsedCommand parsedCommand = parser.getParsedCommand(inputText); AbstractHandler handlerForCommand = getHandlerForCommand(parsedCommand.getCommand()); String operationResult = handlerForCommand.operate(chatId.toString(), parsedCommand, update); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-string"><span class="hljs-string">""</span></span>.equals(operationResult)) { SendMessage message = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SendMessage(); message.setChatId(chatId); message.setText(operationResult); bot.sendQueue.add(message); } }</code> </pre> <br>  Il d√©finit l'ID de chat.  Obtient le texte du message.  √Ä l'aide de l'analyseur, il d√©termine si le message est une commande et d√©termine quel gestionnaire cette commande doit √™tre trait√©e.  Il commence √† traiter la commande et si le traitement de la commande renvoie du texte non vide - il forme un message √† envoyer √† l'utilisateur et le place dans la file d'attente. <br><br>  Et puis vous devriez avoir une question: "Quel type de gestionnaire?".  Il n'avait pas √©t√© question de lui auparavant et il n'√©tait pas mentionn√© dans le code.  D'accord.  Nous allons maintenant analyser cette fonctionnalit√©. <br><br>  Pour ce faire, cr√©ez un package s√©par√©, qui stockera tous nos gestionnaires.  Appelez-le <a href="https://github.com/dp-ua/TelegramBotBase/tree/Part2-Handlers/src/main/java/com/example/telegrambot/handler" rel="nofollow">gestionnaire</a> <br>  Cr√©ons une classe abstraite <a href="" rel="nofollow">AbstractHandler</a> <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.example.telegrambot.bot.Bot; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.example.telegrambot.command.ParsedCommand; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.telegram.telegrambots.api.objects.Update; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractHandler</span></span></span><span class="hljs-class"> </span></span>{ Bot bot; AbstractHandler(Bot bot) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot = bot; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">operate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String chatId, ParsedCommand parsedCommand, Update update)</span></span></span></span>; }</code> </pre> <br>  Il aura un constructeur de base dans lequel nous passerons avec quel objet Bot il devra interagir.  Et une fonction abstraite √† <b>op√©rer est</b> d√©clar√©e, dont la mise en ≈ìuvre devra s'inscrire dans les h√©ritiers de notre classe. <br><br>  Et imm√©diatement, nous impl√©menterons le gestionnaire le plus simple qui ne fera rien et nous l‚Äôutiliserons lorsque nous ne pourrons pas comprendre le type de commande qui nous a √©t√© donn√© et qu‚Äôaucune r√©ponse n‚Äôest requise du bot. <br><br>  <a href="" rel="nofollow">DefaultHandler.java</a> <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.example.telegrambot.bot.Bot; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.example.telegrambot.command.ParsedCommand; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.log4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.telegram.telegrambots.api.objects.Update; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DefaultHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractHandler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger log = Logger.getLogger(DefaultHandler.class); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DefaultHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bot bot)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(bot); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">operate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String chatId, ParsedCommand parsedCommand, Update update)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>; } }</code> </pre> <br>  Comment nous l'appliquerons et o√π nous obtiendrons les r√©sultats de son travail - nous analyserons un peu plus tard. <br><br>  Le suivant est <a href="" rel="nofollow">SystemHandler</a> <br>  Il traitera des commandes de base, telles que start, help, et nous lui demanderons √©galement d'ex√©cuter la commande id <br><br>  La base de celui-ci ressemble √† ceci: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.example.telegrambot.bot.Bot; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.example.telegrambot.command.Command; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.example.telegrambot.command.ParsedCommand; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.log4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.telegram.telegrambots.api.methods.send.SendMessage; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.telegram.telegrambots.api.objects.Update; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SystemHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractHandler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger log = Logger.getLogger(SystemHandler.class); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String END_LINE = <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SystemHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bot bot)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(bot); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">operate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String chatId, ParsedCommand parsedCommand, Update update)</span></span></span><span class="hljs-function"> </span></span>{ Command command = parsedCommand.getCommand(); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (command) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> START: bot.sendQueue.add(getMessageStart(chatId)); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HELP: bot.sendQueue.add(getMessageHelp(chatId)); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ID: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Your telegramID: "</span></span> + update.getMessage().getFrom().getId(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>; }</code> </pre> <br>  Vous pouvez voir comment la r√©ponse √† la commande start and help est form√©e dans le code :) <br>  Nous formons des messages texte et les mettons dans une file d'attente pour l'envoi.  Sur ce, le travail du gestionnaire s'arr√™te.  Qui et comment enverra ces messages - il s'en fiche du tout. <br>  Et rappelez-vous, j'ai mentionn√© un peu plus haut qu'√† la suite du gestionnaire, il renvoie des donn√©es de texte.  Et si cette ligne n'est pas vide, il faut envoyer ce texte √† l'utilisateur.  C'est exactement la fonctionnalit√© que nous avons utilis√©e lors de l'√©laboration de la commande ID: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ID: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Your telegramID: "</span></span> + update.getMessage().getFrom().getId();</code> </pre> <br>  Le gestionnaire retournera le texte avec l'ID utilisateur √† la personne qui l'a appel√© et d√©j√† l√† un message sera g√©n√©r√© pour l'envoi, qui ira ensuite dans la file d'attente. <br><br>  Et au d√©but de l'article, j'ai mentionn√© que nous mettons en ≈ìuvre cette option pour traiter un message d'un utilisateur qui a besoin de temps pour travailler.  Et pour qu'il n'interf√®re pas avec nos gestionnaires, nous allons l'affecter dans un flux s√©par√© et le laisser vaquer √† ses occupations sans distraire le reste. <br>  En tant que fil "lourd", j'ai trouv√© la commande notify.  Le principe de son travail est le suivant. <br><br>  En envoyant au bot une commande du formulaire: <br>  <b>/ notifier 300</b> <br><br>  Le bot devrait vous informer que l'√©quipe a compris et apr√®s 300 secondes, il vous enverra une notification indiquant que 300 secondes se sont √©coul√©es.  Cette √©quipe peut m√™me avoir une utilit√© pratique :) <br><br>  Par exemple, vous mettez le feu aux boulettes et vous devez les retirer apr√®s 5 minutes.  Le bot le fera parfaitement et vous enverra une notification dans le chat que le temps est √©coul√©. <br><br>  Ou prenez une t√¢che plus s√©rieuse.  Vous allez √† une r√©union importante et vous savez que lorsque vous communiquez avec quelqu'un, vous devrez interrompre la conversation.  Pour cela, ils demandent g√©n√©ralement √† des amis d'appeler ou d'√©crire un message, ce qui sera un motif pour ne pas distraire de la conversation pendant longtemps et prendre des mesures.  Mais pourquoi d√©ranger des amis quand on a un bot?  Apr√®s lui avoir demand√© une t√¢che √† l'avance et indiqu√© l'heure, vous recevrez la notification n√©cessaire par t√©l√©grammes.  Mais ce sont toutes les paroles.  La t√¢che et cette commande ont √©t√© invent√©es uniquement pour vous montrer comment allouer dans un flux s√©par√© quelque chose dont le travail peut prendre tr√®s longtemps. <br><br>  Donc, <a href="" rel="nofollow">NotifyHandler</a> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.example.telegrambot.ability.Notify; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.example.telegrambot.bot.Bot; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.example.telegrambot.command.ParsedCommand; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.log4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.telegram.telegrambots.api.objects.Update; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NotifyHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractHandler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger log = Logger.getLogger(NotifyHandler.class); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MILLISEC_IN_SEC = <span class="hljs-number"><span class="hljs-number">1000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String WRONG_INPUT_MESSAGE = <span class="hljs-string"><span class="hljs-string">"Wrong input. Time must be specified as an integer greater than 0"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NotifyHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bot bot)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(bot); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">operate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String chatId, ParsedCommand parsedCommand, Update update)</span></span></span><span class="hljs-function"> </span></span>{ String text = parsedCommand.getText(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">""</span></span>.equals(text)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"You must specify the delay time. Like this:\n"</span></span> + <span class="hljs-string"><span class="hljs-string">"/notify 30"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> timeInSec; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { timeInSec = Long.parseLong(text.trim()); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (NumberFormatException e) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WRONG_INPUT_MESSAGE; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (timeInSec &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { Thread thread = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Notify(bot, chatId, timeInSec * MILLISEC_IN_SEC)); thread.start(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WRONG_INPUT_MESSAGE; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>; } }</code> </pre> <br>  Nous v√©rifions si le d√©lai nous a √©t√© indiqu√© dans le texte.  Sinon, nous le jurons.  Si c'est le cas, nous commen√ßons un nouveau fil, o√π nous passons l'introduction sur nos instructions.  Cette t√¢che sera g√©r√©e par une classe <a href="" rel="nofollow">Notify</a> distincte. <br>  La fonctionnalit√© est extr√™mement simple.  Il dort le nombre de secondes indiqu√©.  Mais au cours de son sommeil, votre bot est capable de recevoir d'autres messages, de communiquer avec vous et de lancer des notifications suppl√©mentaires suppl√©mentaires.  Et tout cela fonctionne s√©par√©ment les uns des autres. <br><br>  Et afin de compl√©ter logiquement tout ce groupe avec des gestionnaires d'appel, revenons √† notre classe <a href="" rel="nofollow">MessageReciever</a> et voyons comment nous comprenons de quel gestionnaire nous avons besoin et comment nous les <a href="" rel="nofollow">ex√©cutons</a> . <br>  Le gestionnaire n√©cessaire nous est retourn√© par la commande <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> AbstractHandler </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getHandlerForCommand</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Command command)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { log.warn(<span class="hljs-string"><span class="hljs-string">"Null command accepted. This is not good scenario."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultHandler(bot); } <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (command) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> START: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HELP: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ID: SystemHandler systemHandler = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SystemHandler(bot); log.info(<span class="hljs-string"><span class="hljs-string">"Handler for command["</span></span> + command.toString() + <span class="hljs-string"><span class="hljs-string">"] is: "</span></span> + systemHandler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> systemHandler; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> NOTIFY: NotifyHandler notifyHandler = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NotifyHandler(bot); log.info(<span class="hljs-string"><span class="hljs-string">"Handler for command["</span></span> + command.toString() + <span class="hljs-string"><span class="hljs-string">"] is: "</span></span> + notifyHandler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> notifyHandler; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: log.info(<span class="hljs-string"><span class="hljs-string">"Handler for command["</span></span> + command.toString() + <span class="hljs-string"><span class="hljs-string">"] not Set. Return DefaultHandler"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultHandler(bot); } }</code> </pre> <br>  Maintenant, si vous souhaitez ajouter quelques commandes suppl√©mentaires, vous devrez effectuer les op√©rations suivantes: <br><br><ol><li>  Dans la classe <a href="" rel="nofollow">Command</a> , ajoutez la syntaxe de commande. </li><li>  Dans le <a href="" rel="nofollow">r√©cepteur,</a> dans la fonction <b>getHandlerForCommand,</b> sp√©cifiez qui sera responsable du traitement de cette commande. </li><li>  Et en fait, √©crivez ce gestionnaire. </li></ol><br>  Je dirai √† l'avance que le processus d'ajout de nouvelles √©quipes peut √™tre simplifi√©.  Les gestionnaires responsables peuvent √™tre enregistr√©s imm√©diatement dans la classe avec une liste de commandes.  Mais je crains que le code ne soit pas facile √† comprendre.  Le texte est tr√®s long.  Mais je ne peux pas le battre en morceaux.  Trois fonctions de base du bot sont d√©crites ici, qui ne fonctionnent qu'ensemble et il n'est pas juste d'en parler individuellement. <br><br>  De quoi parlerons-nous dans les parties suivantes? <br><br>  Nous devons comprendre comment former diff√©rents types de messages.  Comment travailler avec le clavier et les boutons.  Comment modifier vos anciens messages.  Comment travailler avec les rappels.  Comment confier des t√¢ches au bot pour effectuer certaines actions.  Comment cr√©er un message interactif avec un bot et bien plus encore.  Toutes les autres parties d√©pendent de vous et de votre activit√©. <br>  Dans les commentaires, je me r√©jouis de vos commentaires et directions, que nous consid√©rerons comme une priorit√©. <br><br>  N'h√©sitez pas √† poser des questions.  Si quelque chose n'est pas indiqu√© dans l'article ou √† un moment donn√©, ce n'est pas clair - √©crivez-moi √† ce sujet.  Je corrigerai, √©diterai ou clarifierai certainement les questions controvers√©es. <br><br>  Programmez avec plaisir et que la force et le beau code vous accompagnent :) <br><br>  py.s. <br><br>  Le bot √©crit dans cette partie de l'article fonctionne.  Vous pouvez le tourmenter ici: <a href="http://t.me/test_habr_bot" rel="nofollow">@test_habr_bot</a> <br>  Vous pouvez √©galement tourmenter mon agenda: <a href="http://t.me/EventCheckPlanner_Bot" rel="nofollow">@EventCheckPlanner_Bot</a> <br>  Et le <a href="http://t.me/FilmFanAmateurBot" rel="nofollow">fan du film Cheeky</a> : <a href="http://t.me/FilmFanAmateurBot" rel="nofollow">@FilmFanAmateurBot</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr481354/">https://habr.com/ru/post/fr481354/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr481344/index.html">Plans de l'√©quipe de la plateforme IntelliJ pour 2020</a></li>
<li><a href="../fr481346/index.html">5 changements majeurs dans l'industrie automobile</a></li>
<li><a href="../fr481348/index.html">Pentest Active Directory. Partie 1</a></li>
<li><a href="../fr481350/index.html">Qui travaille au cosmodrome de Plesetsk</a></li>
<li><a href="../fr481352/index.html">DBA: effacement des enregistrements de clone d'une table sans PK</a></li>
<li><a href="../fr481356/index.html">Merci, 2019</a></li>
<li><a href="../fr481358/index.html">C ++ Russie: comment c'√©tait</a></li>
<li><a href="../fr481360/index.html">Les r√©sultats de la semaine: Rambler et Twitch ont convenu, le travail √©lectronique sera introduit en F√©d√©ration de Russie et Facebook cr√©era son propre syst√®me d'exploitation</a></li>
<li><a href="../fr481362/index.html">Certificat SSL pour l'application web Docker</a></li>
<li><a href="../fr481364/index.html">La maison sensible remplace les maisons intelligentes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>