<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👦🏽 🙎🏼 🌶️ Terminal pour serveur domestique Linux basé sur ESP8266 💂🏼 🚾 💔</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="introduction
 Cet appareil sert à l'accès à distance au serveur Linux via le port série et vous permet d'abandonner le moniteur et le clavier locaux. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Terminal pour serveur domestique Linux basé sur ESP8266</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/387033/"><img align="left" src="https://habrastorage.org/files/c78/55f/858/c7855f85896b49fca445ce4347fa9d73.png"><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">introduction</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cet appareil sert à l'accès à distance au serveur Linux via le port série et vous permet d'abandonner le moniteur et le clavier locaux. </font><font style="vertical-align: inherit;">Pourquoi est-il nécessaire s'il y a SSH et VNC? </font><font style="vertical-align: inherit;">Vous devez garder à l'esprit un certain nombre de problèmes liés à la gestion au stade du démarrage du système et à la gestion de l'alimentation:</font></font><br>
<ul>
<li>  ,   recovery mode, memtest.  S          ,  fsck   .<br>
</li>
<li>        .   initramfs  dropbear    .    SSH.  ,         ,           ,       .<br>
</li>
<li>   .      ,        Wake-on-LAN (WOL),        ,   ,           «»   ,      .<br>
</li>
<li>       UPS,        .<br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Malheureusement, l'équipement de mon serveur domestique n'est pas industriel et n'a pas un haut degré de fiabilité. </font><font style="vertical-align: inherit;">Il en va de même pour les logiciels, souvent les modules du noyau "bruts" fonctionnent. </font><font style="vertical-align: inherit;">À la suite de quoi, plus d'une fois, le serveur s'est «bloqué» sans répondre ni sur le réseau ni en appuyant sur les touches du clavier. </font><font style="vertical-align: inherit;">J'ai dû utiliser une réinitialisation matérielle en maintenant le bouton d'alimentation enfoncé pendant plus de 3 secondes.</font></font><br>
</li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il n'y a pas de tels problèmes sur les équipements industriels, par exemple, la solution HP iLO vous permet d'installer à distance au moins un système, sans parler de la gestion de l'alimentation et des diagnostics du système. </font><font style="vertical-align: inherit;">Soit dit en passant, ils ont des produits pour la maison / petite entreprise avec cette solution. </font><font style="vertical-align: inherit;">Mais il se trouve que le système a été construit sur la base d'une carte mère conventionnelle miniITX sans de telles capacités.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y avait un besoin pour un appareil qui permettrait:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Être disponible sur le réseau</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interagissez avec le chargeur de démarrage et le système d'exploitation du serveur, au moins en mode texte</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Ironiquement" interagit avec le bouton d'alimentation et peut fermer les contacts de ce bouton pendant plus de 3 secondes pour forcer l'arrêt</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modifier les paramètres du BIOS (EFI) (pas encore décidé, disponible uniquement pour certaines cartes mères)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est un fait bien connu que des terminaux de texte précédemment utilisés étaient connectés au port série de la machine. </font><font style="vertical-align: inherit;">Historiquement, il y a eu la prise en charge des terminaux Linux et le chargeur d'amorçage grub. </font><font style="vertical-align: inherit;">Sur les cartes mères modernes, ce port n'a pas la forme habituelle du connecteur DB-9 externe, mais il est presque toujours acheminé vers le connecteur 10 broches interne. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec l'avènement du penny ESP8266, essentiellement un pont entre le Wi-Fi et l'UART, l'idée de mettre en œuvre un terminal réseau basé sur celui-ci, avec une fonctionnalité de gestion de l'alimentation, est apparue.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En plus de l'ESP8266, il existe différentes options</font></font></b><div class="spoiler_text">   OpenWRT   .  UART'a      MAX232 (  USB — RS232 ),   GPIO,   ,   .  ,  ,        .<br>
<br>
               ,    ./.,  .         .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>.<br>
</div></div><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schéma</font></font></h4><br>
<img src="https://habrastorage.org/files/cc5/d51/e73/cc5d51e735d34dba97b6e58db1485885.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'élément principal - ESP8266 (ESP-03), dispose du Wi-Fi pour la communication avec le monde extérieur, de l'UART pour la communication avec le serveur et de deux GPIO, sur lesquels l'indicateur d'état et les LED de relais sont suspendus pour fermer le bouton d'alimentation. </font><font style="vertical-align: inherit;">Il existe quelques GPIO gratuits qui peuvent être utilisés pour connecter I2C, 1-Wire et d'autres capteurs et appareils.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La puce populaire MAX232 est utilisée pour convertir l'UART de ESP8266 en RS-232. Le MAX232 est alimenté par 5 V, tandis que l'ESP8266 via le convertisseur LM1117 5-3,3 V, juste au cas où, un diviseur de tension menant 5 V de la sortie du MAX232 à 3,3 V est utilisé sur la ligne RSP de l'ESP8266. La sortie du MAX232 est divisée en deux prises, une pour la connexion à DB-9 et la seconde IDC-10 pour une connexion directe directement aux contacts de la carte mère. Le relais est utilisé pour fermer les contacts du bouton d'alimentation du PC et est connecté en parallèle avec le bouton sur le boîtier. À propos, pour connecter le bouton d'alimentation du boîtier de l'unité centrale, vous pouvez fournir un connecteur sur la carte, je l'ai implémenté via un double pour 2,54 broches sur le connecteur de la carte mère. En général, la décision d'utiliser des relais est controversée. Assez d'un transistor. Dans la mise en page, j'ai mis l'optocoupleur 817, ça n'a pas marché,des mesures radicales ont été prises et le relais activé ... ça a marché. Qu'il en soit ainsi, il peut alors être utile de fermer / ouvrir les circuits 220V, en plus, des clics sont entendus - utiles pour les diagnostics. P6 - connecteur pour une programmation facile via des adaptateurs chinois pour Arduino FTDI. En mode programmation, le cavalier est activé par JP1. L'appareil est alimenté via le connecteur P4 directement à partir de la tension de veille de l'alimentation ou du port USB. Le connecteur P1 est utilisé pour connecter une antenne externe.L'appareil est alimenté via le connecteur P4 directement à partir de la tension de veille de l'alimentation ou du port USB. Le connecteur P1 est utilisé pour connecter une antenne externe.L'appareil est alimenté via le connecteur P4 directement à partir de la tension de veille de l'alimentation ou du port USB. Le connecteur P1 est utilisé pour connecter une antenne externe.</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voies de développement possibles</font></font></b><div class="spoiler_text"><ul>
<li>   CMOS</li>
<li>  ,      </li>
<li>   </li>
</ul><br>
</div></div><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Circuit imprimé</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Couche unique, mais 5 cavaliers entiers sont sortis.</font></font><br>
<img src="https://habrastorage.org/files/ee5/c2c/5e6/ee5c2c5e68de483ba7f53a535b744ed1.png"><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maladroit fait à la maison</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/files/806/937/b10/806937b100874fd1994fd4f5b3804bce.jpg"><br>
    P6.<br>
</div></div><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firmware</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le plus simple consiste en un serveur TELNET - en fait pour l'échange. </font><font style="vertical-align: inherit;">Tout ce qui apparaît dans UART est jeté à tous les clients TELNET, tout ce qui vient des clients est jeté à UART. </font><font style="vertical-align: inherit;">Les commandes AT sont également vissées pour contrôler le bouton d'alimentation et configurer les paramètres du port et du Wi-Fi. </font><font style="vertical-align: inherit;">Bien que pour être honnête, cela soit loin d'un serveur RFC 854, les commandes ne sont pas prises en charge, j'appelle TELNET car le port 23, l'échange de texte direct et les clients TELNET sont parfaits pour l'interaction (testé sur le client Android de ConnectBot et Linux, l'utilitaire telnet fonctionnait correctement pour moi avec la variable d'environnement export TERM = VT100, le paramètre -8 et la transition suivante en mode caractère ^] mode caractère).</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une caractéristique remarquable, l'ESP8266 peut fonctionner à la fois comme point d'accès et comme client de réseau sans fil en même temps. Ceci est très important pour la tolérance aux pannes - il vous permet de vous connecter au terminal en cas de panne de l'équipement réseau. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le firmware a été initialement écrit en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sming</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Le principal avantage de Sming est que vous n'avez pas besoin de comprendre le SDK chinois ESP8266, pour tous les besoins, il existe déjà un emballage digestible, qu'il s'agisse d'un serveur WEB, de la mise à jour du micrologiciel par liaison radio ou de l'utilisation de GPIO. Mais lors de l'utilisation de l'encapsuleur du serveur TCP pour implémenter TELNET lors du transfert de gros volumes, la connexion a été rompue et ESP8266 s'est bloqué. Il y a eu des tentatives pour opérer directement avec l'API lwip ... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais à ce stade, je suis tombé sur le projet </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESP8266-transparent-bridge</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il a été décidé simplement de le bifurquer pour l'implémentation des commandes de contrôle du bouton d'alimentation, tout le reste a déjà été fait par son auteur. </font><font style="vertical-align: inherit;">Bala a ajouté la commande AT</font></font><pre><code class="bash hljs">+++AT PWBTN &lt;duration: SHORT | LONG | HARDRESET&gt; <span class="hljs-comment"><span class="hljs-comment">#       |   | ,        </span></span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a une faille dans le firmware. </font><font style="vertical-align: inherit;">Si une grande quantité d'informations est envoyée au terminal à la fois, certaines données peuvent être perdues. </font><font style="vertical-align: inherit;">Cependant, l'ESP8266 n'est pas un Moxa NPort et ses capacités sont limitées. </font><font style="vertical-align: inherit;">Par exemple, si nous faisons du dmesg, nous ne verrons qu'une partie des données, nous devons donc utiliser grep de plus en moins souvent et éviter les longs affichages à l'écran. </font><font style="vertical-align: inherit;">D'une manière générale, il vaut la peine d'essayer d'augmenter le tampon de transfert dans le micrologiciel, maintenant il ne fait que 1024 octets, jusqu'à ce que vos mains atteignent 32768 et il peut devenir confortable de travailler avec des utilitaires comme htop.</font></font><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration de la machine Linux</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans / etc / default / grub devrait être quelque chose comme:</font></font><br>
<pre><code class="bash hljs">GRUB_CMDLINE_LINUX=<span class="hljs-string"><span class="hljs-string">"console=ttyS0,115200n8"</span></span><font></font>
GRUB_TERMINAL=serial<font></font>
GRUB_SERIAL_COMMAND=<span class="hljs-string"><span class="hljs-string">"serial --speed=115200 --unit=0 --word=8 --parity=no --stop=1"</span></span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour afficher le menu du chargeur de démarrage et les messages de démarrage sur le port série. Dans ce cas, le premier avec un débit binaire de 115200. Après la modification, exécutez la commande update-grub. En principe, cela peut être limité, mais juste au cas où, vous pouvez toujours ouvrir le terminal sur le port série, pour ce créer /etc/init/ttyS0.conf avec le contenu suivant:</font></font><br>
<pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ttyS0 - getty</span></span>
<span class="hljs-comment"><span class="hljs-comment">#</span></span>
<span class="hljs-comment"><span class="hljs-comment"># This service maintains a getty on ttyS0 from the point the system is</span></span>
<span class="hljs-comment"><span class="hljs-comment"># started until it is shut down again.</span></span><font></font>
<font></font>
start on stopped rc or RUNLEVEL=[2345]<font></font>
stop on runlevel [!2345]<font></font>
<span class="hljs-comment"><span class="hljs-comment">#</span></span><font></font>
respawn<font></font>
<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> /sbin/getty -L 115200 ttyS0 vt102
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Connexion au serveur </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme déjà mentionné, l'alimentation provient directement de la tension de veille de l'alimentation ou du port USB, les sorties de relais sont connectées en parallèle avec le bouton d'alimentation, le pad RS-232 est connecté par un câble direct au connecteur IDC-10. </font><font style="vertical-align: inherit;">Il y a une nuance à placer l'appareil à l'intérieur du boîtier du serveur; vous devez retirer l'antenne connectée au connecteur u.fl de l'appareil à l'extérieur du boîtier Wi-Fi. </font><font style="vertical-align: inherit;">Bien sûr, cela ne peut pas être fait si le boîtier est relativement radio-transparent, par exemple en bois.</font></font><br>
<br>
<img src="https://habrastorage.org/files/cc1/676/47b/cc167647b315495eafaf671f7b37b084.jpg"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calcul des coûts</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3 $ pour ESP8266, 1 $ pour 10 pièces de MAX232, le reste est généralement à la ferme.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Démonstration vidéo</font></font></h4><br>
<br>
<iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://www.youtube.com/embed/xk7YPsDRASc&amp;usg=ALkJrhgGDpTSeA8UpQL67ULzW06eatQEJw" frameborder="0" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sources de fer et de logiciels </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr387033/">https://habr.com/ru/post/fr387033/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr387017/index.html">Système de contrôle automatique d'aquarium sur Arduino</a></li>
<li><a href="../fr387021/index.html">Modification du routeur Hame R-1 dans Zyxel Keenetic</a></li>
<li><a href="../fr387025/index.html">Yahoo Mail a interdit certains utilisateurs AdBlock</a></li>
<li><a href="../fr387027/index.html">Les responsables américains sont sans défense contre le piratage des pirates iraniens sur les réseaux sociaux</a></li>
<li><a href="../fr387029/index.html">La course aux armes électromagnétiques. Qu'ont les Chinois là-bas?</a></li>
<li><a href="../fr387035/index.html">Aperçu de l'exposition de technologie 3D Formnext 2015</a></li>
<li><a href="../fr387037/index.html">Rosetta et Fila</a></li>
<li><a href="../fr387041/index.html">Ne pas ouvrir avant 2957: une capsule temporelle a été trouvée au MIT</a></li>
<li><a href="../fr387043/index.html">NASA: l'étoile KIC 8462852 n'a pas de sphère Dyson, c'est tout un essaim de comètes</a></li>
<li><a href="../fr387047/index.html">Des scientifiques américains ont créé des moustiques génétiquement modifiés qui bloquent la propagation du paludisme</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>