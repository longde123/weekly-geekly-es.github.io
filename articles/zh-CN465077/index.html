<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¤›ğŸ» ğŸ‚ ğŸ·ï¸ Unsafe.AsSpanï¼šSpan <T>å¦‚ä½•æ›¿æ¢æŒ‡é’ˆï¼Ÿ ğŸ¦„ ğŸ™ğŸ» ğŸ••</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="C#æ˜¯ä¸€ç§éå¸¸çµæ´»çš„è¯­è¨€ã€‚ åœ¨å®ƒä¸Šé¢ï¼Œæ‚¨ä¸ä»…å¯ä»¥ç¼–å†™åç«¯æˆ–æ¡Œé¢åº”ç”¨ç¨‹åºã€‚ æˆ‘ä½¿ç”¨C#å¤„ç†ç§‘å­¦æ•°æ®ï¼Œè¿™å¯¹ä½¿ç”¨è¯¥è¯­è¨€çš„å·¥å…·æå‡ºäº†æŸäº›è¦æ±‚ã€‚ å°½ç®¡netcoreæŠ“ä½äº†è®®ç¨‹ï¼ˆè€ƒè™‘åˆ°åœ¨netstandard2.0ä¹‹åï¼Œè¯­è¨€å’Œè¿è¡Œæ—¶çš„å¤§å¤šæ•°åŠŸèƒ½éƒ½ä¸ä¼šnetframeworkåˆ°netframework ï¼‰ï¼Œä½†æˆ‘è¿˜...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Unsafe.AsSpanï¼šSpan <T>å¦‚ä½•æ›¿æ¢æŒ‡é’ˆï¼Ÿ</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/465077/"><p><img src="https://habrastorage.org/webt/3f/dh/ia/3fdhia5h25mpjbabeocnlygdd1c.png"></p><br><p> <code>C#</code>æ˜¯ä¸€ç§éå¸¸çµæ´»çš„è¯­è¨€ã€‚ åœ¨å®ƒä¸Šé¢ï¼Œæ‚¨ä¸ä»…å¯ä»¥ç¼–å†™åç«¯æˆ–æ¡Œé¢åº”ç”¨ç¨‹åºã€‚ æˆ‘ä½¿ç”¨<code>C#</code>å¤„ç†ç§‘å­¦æ•°æ®ï¼Œè¿™å¯¹ä½¿ç”¨è¯¥è¯­è¨€çš„å·¥å…·æå‡ºäº†æŸäº›è¦æ±‚ã€‚ å°½ç®¡<code>netcore</code>æŠ“ä½äº†è®®ç¨‹ï¼ˆè€ƒè™‘åˆ°åœ¨<code>netstandard2.0</code>ä¹‹åï¼Œè¯­è¨€å’Œè¿è¡Œæ—¶çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¤§å¤šæ•°</a>åŠŸèƒ½éƒ½ä¸ä¼š<code>netframework</code>åˆ°<code>netframework</code> ï¼‰ï¼Œä½†æˆ‘è¿˜æ˜¯ç»§ç»­å¤„ç†æ—§é¡¹ç›®ã€‚ </p><br><p> åœ¨æœ¬æ–‡ä¸­ï¼Œç”±äº<code>clr</code>çš„ç‰¹æ®Šæ€§ï¼Œæˆ‘è€ƒè™‘äº†<code>Span&lt;T&gt;</code>ä¸€ç§éæ˜¾è€Œæ˜“è§ï¼ˆä½†å¯èƒ½æ˜¯æœŸæœ›çš„ï¼‰åº”ç”¨ï¼Œä»¥åŠ<code>netframework</code>å’Œ<code>netcore</code>ä¸­<code>Span&lt;T&gt;</code>çš„å®ç°ä¹‹é—´çš„å·®å¼‚ã€‚ </p><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">å…è´£å£°æ˜1</b> <div class="spoiler_text"><p> æœ¬æ–‡ä¸­çš„ä»£ç æ®µå†³ä¸æ‰“ç®—ç”¨äºå®é™…é¡¹ç›®ä¸­ã€‚ </p><br><p> æå‡ºçš„ï¼ˆç‰µå¼ºï¼Ÿï¼‰é—®é¢˜çš„è§£å†³æ–¹æ¡ˆæ˜¯ä¸€ç§æ¦‚å¿µè¯æ˜ã€‚ <br> æ— è®ºå¦‚ä½•ï¼Œé€šè¿‡åœ¨é¡¹ç›®ä¸­å®æ–½æ­¤æ“ä½œï¼Œæ‚¨å°†è‡ªæ‹…é£é™©å¹¶æ‰¿æ‹…é£é™©ã€‚ </p></div></div><br><div class="spoiler">  <b class="spoiler_title">å…è´£å£°æ˜2</b> <div class="spoiler_text"><p> æˆ‘ç»å¯¹ç¡®å®šï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè¿™<strong>è‚¯å®šä¼š</strong>åœ¨è†ç›–å¤„å°„æ€æŸäººã€‚ </p><br><p>  <code>C#</code>ç±»å‹å®‰å…¨æ—è·¯ä¸å¤ªå¯èƒ½å¯¼è‡´ä»»ä½•é—®é¢˜ã€‚ </p><br><p> å‡ºäºæ˜æ˜¾çš„åŸå› ï¼Œæˆ‘å¹¶æœªåœ¨æ‰€æœ‰å¯èƒ½çš„æƒ…å†µä¸‹æµ‹è¯•æ­¤ä»£ç ï¼Œä½†æ˜¯ï¼Œåˆæ­¥ç»“æœçœ‹èµ·æ¥å¾ˆæœ‰å¸Œæœ›ã€‚ </p></div></div><br><h1 id="a-zachem-mne-voobsche-spant"> ä¸ºä»€ä¹ˆæˆ‘å®Œå…¨éœ€è¦<code>Span&lt;T&gt;</code> ï¼Ÿ </h1><br><p>  Spenå…è®¸æ‚¨ä»¥æ›´æ–¹ä¾¿çš„å½¢å¼ä½¿ç”¨<code>unmanaged</code>ç±»å‹çš„æ•°ç»„ï¼Œä»è€Œå‡å°‘äº†å¿…è¦çš„åˆ†é…æ•°é‡ã€‚ å°½ç®¡å‡ ä¹å®Œå…¨æ²¡æœ‰<code>BCL</code> <code>netframework</code>ä¸­çš„è·¨åº¦æ”¯æŒï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨<code>System.Memory</code> ï¼Œ <code>System.Buffers</code>å’Œ<code>System.Runtime.CompilerServices.Unsafe</code>è·å¾—å¤šç§å·¥å…·ã€‚ <br> åœ¨æˆ‘çš„é—ç•™é¡¹ç›®ä¸­ï¼Œè·¨åº¦çš„ä½¿ç”¨æ˜¯æœ‰é™çš„ï¼Œä½†æ˜¯ï¼Œæˆ‘å‘ç°å®ƒä»¬æ˜¯ä¸€ä¸ªä¸æ˜æ˜¾çš„ç”¨æ³•ï¼ŒåŒæ—¶ä¼šå¢åŠ ç±»å‹å®‰å…¨æ€§ã€‚ <br> è¿™æ˜¯ä»€ä¹ˆåº”ç”¨ç¨‹åºï¼Ÿ åœ¨æˆ‘çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä½¿ç”¨ä»ç§‘å­¦å·¥å…·è·å¾—çš„æ•°æ®ã€‚ è¿™äº›æ˜¯å›¾åƒï¼Œé€šå¸¸æ˜¯<code>T[]</code>çš„æ•°ç»„ï¼Œå…¶ä¸­<code>T</code>æ˜¯é<code>unmanaged</code>åŸºæœ¬ç±»å‹ä¹‹ä¸€ï¼Œä¾‹å¦‚<code>Int32</code> ï¼ˆaka <code>int</code> ï¼‰ã€‚ ä¸ºäº†æ­£ç¡®åœ°å°†è¿™äº›æ˜ åƒåºåˆ—åŒ–åˆ°ç£ç›˜ï¼Œæˆ‘éœ€è¦æ”¯æŒ<a href="">1981</a>å¹´æå‡ºçš„æä¸ºä¸ä¾¿çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ—§æ ¼å¼</a> ï¼Œæ­¤åå‡ ä¹æ²¡æœ‰ä»»ä½•å˜åŒ–ã€‚ è¿™ç§æ ¼å¼çš„ä¸»è¦é—®é¢˜æ˜¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">BigEndian</a> ã€‚ å› æ­¤ï¼Œä¸ºäº†å†™å…¥ï¼ˆæˆ–è¯»å–ï¼‰ <code>T[]</code>çš„æœªå‹ç¼©æ•°ç»„ï¼Œæ‚¨éœ€è¦æ›´æ”¹æ¯ä¸ªå…ƒç´ çš„å­—èŠ‚åºã€‚ çç¢çš„ä»»åŠ¡ã€‚ <br> æœ‰å“ªäº›æ˜æ˜¾çš„è§£å†³æ–¹æ¡ˆï¼Ÿ </p><br><ol><li> æˆ‘ä»¬éå†æ•°ç»„<code>T[]</code> ï¼Œè°ƒç”¨<code>BitConverter.GetBytes(T)</code> ï¼Œæ‰©å±•è¿™å‡ ä¸ªå­—èŠ‚ï¼Œå¤åˆ¶åˆ°ç›®æ ‡æ•°ç»„ã€‚ </li><li> æˆ‘ä»¬éå†æ•°ç»„<code>T[]</code> ï¼Œä»¥<code>new byte[] {(byte)((x &amp; 0xFF00) &gt;&gt; 8), (byte)(x &amp; 0x00FF)};</code>çš„å½¢å¼æ‰§è¡Œæ¬ºè¯ˆè¡Œä¸º<code>new byte[] {(byte)((x &amp; 0xFF00) &gt;&gt; 8), (byte)(x &amp; 0x00FF)};</code>  ï¼ˆåº”åœ¨åŒå­—èŠ‚ç±»å‹ä¸Šå·¥ä½œï¼‰ï¼Œå†™å…¥ç›®æ ‡æ•°ç»„ã€‚ </li><li>  <sup>*</sup>ä½†æ˜¯<code>T[]</code>æ˜¯æ•°ç»„å—ï¼Ÿ å…ƒç´ æ˜¯è¿ç»­çš„ï¼Œå¯¹ä¸å¯¹ï¼Ÿ å› æ­¤ï¼Œæ‚¨å¯ä»¥è¿›è¡Œæ‰€æœ‰æ“ä½œï¼Œä¾‹å¦‚<code>Buffer.BlockCopy(intArray, 0, byteArray, 0, intArray.Length * sizeof(int));</code>  ã€‚ è¯¥æ–¹æ³•å°†æ•°ç»„å¤åˆ¶åˆ°è¯¥æ•°ç»„ï¼Œè€Œå¿½ç•¥ç±»å‹æ£€æŸ¥ã€‚ åªéœ€è¦ä¸è¦é”™è¿‡ç•Œé™å’Œåˆ†é…ã€‚ ç»“æœï¼Œæˆ‘ä»¬æ··åˆäº†å­—èŠ‚ã€‚ </li><li>  <sup>*</sup>ä»–ä»¬è¯´<code>C#</code>æ˜¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>(C++)++</code></a> ã€‚ å› æ­¤ï¼Œå¯ç”¨<code>/unsafe</code> ï¼Œ <code>fixed(int* p = &amp;intArr[0]) byte* bPtr = (byte*)p;</code> ç°åœ¨æ‚¨å¯ä»¥ç»•è¿‡æºæ•°ç»„çš„å­—èŠ‚è¡¨ç¤ºå½¢å¼ï¼Œå¿«é€Ÿæ›´æ”¹å­—èŠ‚åºå¹¶å°†å—å†™å…¥ç£ç›˜ï¼ˆæ·»åŠ <code>stackalloc byte[]</code>æˆ–<code>ArrayPool&lt;byte&gt;.Shared</code>ä¸ºä¸­é—´ç¼“å†²åŒº<code>ArrayPool&lt;byte&gt;.Shared</code> ï¼‰ï¼Œè€Œæ— éœ€ä¸ºæ•´ä¸ªæ–°çš„å­—èŠ‚æ•°ç»„åˆ†é…å†…å­˜ã€‚ </li></ol><br><p> ç¬¬<strong>4</strong>ç‚¹ä¼¼ä¹å¯ä»¥è§£å†³æ‰€æœ‰é—®é¢˜ï¼Œä½†æ˜¯æ˜¾å¼ä½¿ç”¨<code>unsafe</code>ä¸Šä¸‹æ–‡å’Œä½¿ç”¨æŒ‡é’ˆåœ¨æŸç§ç¨‹åº¦ä¸Šå®Œå…¨ä¸åŒã€‚ ç„¶å<code>Span&lt;T&gt;</code>åŠ©æˆ‘ä»¬ä¸€è‡‚ä¹‹åŠ›ã€‚ </p><br><h1 id="spant"> <code>Span&lt;T&gt;</code> </h1> <br><p>  <code>Span&lt;T&gt;</code>æŠ€æœ¯ä¸Šè®²ï¼Œ <code>Span&lt;T&gt;</code>åº”è¯¥æä¾›ç”¨äºå¤„ç†å†…å­˜å›¾çš„å·¥å…·ï¼Œå°±åƒé€šè¿‡æŒ‡é’ˆè¿›è¡Œæ“ä½œä¸€æ ·ï¼ŒåŒæ—¶æ— éœ€â€œå›ºå®šâ€å†…å­˜ä¸­çš„æ•°ç»„ã€‚ å…·æœ‰æ•°ç»„è¾¹ç•Œçš„æ­¤ç±»<code>GC</code>æ„ŸçŸ¥æŒ‡é’ˆã€‚ ä¸€åˆ‡éƒ½å¾ˆå¥½ï¼Œå¾ˆå®‰å…¨ã€‚ <br> ä¸€ä»¶äº‹-å°½ç®¡<code>System.Runtime.CompilerServices.Unsafe</code>ä¸°å¯Œï¼Œä½†<code>Span&lt;T&gt;</code>è¢«é’‰ä¸º<code>Span&lt;T&gt;</code>ç±»å‹<code>T</code> å‡è®¾spenæœ¬è´¨ä¸Šæ˜¯<sup>1</sup> +é•¿åº¦çš„æŒ‡é’ˆï¼Œé‚£ä¹ˆå¦‚æœæ‚¨æ‹‰å‡ºæŒ‡é’ˆï¼Œå°†å…¶è½¬æ¢ä¸ºå¦ä¸€ç§ç±»å‹ï¼Œé‡æ–°è®¡ç®—é•¿åº¦å¹¶åˆ›å»ºæ–°çš„è·¨åº¦è¯¥æ€ä¹ˆåŠï¼Ÿ å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬æœ‰<code>public Span&lt;T&gt;(void* pointer, int length)</code> ã€‚ <br> è®©æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªç®€å•çš„æµ‹è¯•ï¼š </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Test</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Flip</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Span&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; span</span></span></span><span class="hljs-function">)</span></span> {<span class="hljs-comment"><span class="hljs-comment">/*   endianess */</span></span>} Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; x = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> [] {<span class="hljs-number"><span class="hljs-number">123</span></span>}; Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt; y = DangerousCast&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt;(x); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">123</span></span>, x[<span class="hljs-number"><span class="hljs-number">0</span></span>]); Flip(y); Assert.AreNotEqual(<span class="hljs-number"><span class="hljs-number">123</span></span>, x[<span class="hljs-number"><span class="hljs-number">0</span></span>]); Flip(y); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">123</span></span>, x[<span class="hljs-number"><span class="hljs-number">0</span></span>]); }</code> </pre> <br><p> æ¯”æˆ‘åº”è¯¥ç«‹å³æ„è¯†åˆ°è¿™é‡Œæœ‰é—®é¢˜çš„é«˜çº§å¼€å‘äººå‘˜ã€‚ æµ‹è¯•ä¼šå¤±è´¥å—ï¼Ÿ é€šå¸¸æƒ…å†µä¸‹ï¼Œç­”æ¡ˆ<strong>å–å†³äº</strong> ã€‚ <br> åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒä¸»è¦å–å†³äºè¿è¡Œæ—¶ã€‚ åœ¨<code>netcore</code>æµ‹è¯•<em>åº”è¯¥</em>å¯ä»¥è¿›è¡Œï¼Œä½†æ˜¯åœ¨<code>netframework</code> ï¼Œæµ‹è¯•å¦‚ä½•<code>netframework</code> ã€‚ <br> æœ‰è¶£çš„æ˜¯ï¼Œå¦‚æœæ‚¨åˆ é™¤äº†ä¸€äº›è®ºæ–‡ï¼Œåˆ™è¯¥æµ‹è¯•å°†åœ¨100ï¼…çš„æƒ…å†µä¸‹å¼€å§‹æ­£å¸¸è¿è¡Œã€‚ <br> è®©æˆ‘ä»¬åšå¯¹ã€‚ </p><br><p>  <sup>1</sup>æˆ‘<em>é”™äº†</em> ã€‚ </p><br><h1 id="pravilnyy-otvet-zavisit"> æ­£ç¡®ç­”æ¡ˆï¼šè§†æƒ…å†µè€Œå®š </h1><br><p> ä¸ºä»€ä¹ˆç»“æœ<em>å–å†³äº</em> ï¼Ÿ <br> è®©æˆ‘ä»¬åˆ é™¤æ‰€æœ‰ä¸å¿…è¦çš„å†…å®¹å¹¶åœ¨æ­¤å¤„ç¼–å†™è¿™æ ·çš„ä»£ç ï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; Check(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Check</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; x = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] {<span class="hljs-number"><span class="hljs-number">999</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-number"><span class="hljs-number">-100</span></span>}; Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt; y = As&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt;(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> x); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">@"FRAMEWORK_NAME"</span></span>); Write(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> x); Write(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> y); Console.WriteLine(); Write&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> x, <span class="hljs-string"><span class="hljs-string">"Span&lt;int&gt; [0]"</span></span>); Write&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> y, <span class="hljs-string"><span class="hljs-string">"Span&lt;byte&gt;[0]"</span></span>); Console.WriteLine(); Write&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> Offset&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> x[<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-string"><span class="hljs-string">"Span&lt;int&gt; [0] offset by size_t"</span></span>); Write&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> Offset&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> y[<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-string"><span class="hljs-string">"Span&lt;byte&gt;[0] offset by size_t"</span></span>); Console.WriteLine(); GC.Collect(<span class="hljs-number"><span class="hljs-number">0</span></span>, GCCollectionMode.Forced, <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); Write&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> x, <span class="hljs-string"><span class="hljs-string">"Span&lt;int&gt; [0] after GC"</span></span>); Write&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> y, <span class="hljs-string"><span class="hljs-string">"Span&lt;byte&gt;[0] after GC"</span></span>); Console.WriteLine(); Write(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> x); Write(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> y); }</code> </pre> <br><p>  <code>Write&lt;T, U&gt;</code>æ–¹æ³•æ¥å—ç±»å‹<code>T</code> ï¼Œè¯»å–ç¬¬ä¸€ä¸ªå…ƒç´ çš„åœ°å€ï¼Œå¹¶é€šè¿‡æ­¤æŒ‡é’ˆè¯»å–ä¸€ä¸ªç±»å‹<code>U</code>å…ƒç´ <code>U</code> æ¢å¥è¯è¯´ï¼Œ <code>Write&lt;int, int&gt;(ref x)</code>å°†è¾“å‡ºå†…å­˜ä¸­çš„åœ°å€+æ•°å­—999ã€‚ <br> æ™®é€š<code>Write</code>æ‰“å°ä¸€ä¸ªæ•°ç»„ã€‚ <br> ç°åœ¨å…³äº<code>As&lt;,&gt;</code>æ–¹æ³•ï¼š </p><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> Span&lt;U&gt; As&lt;T, U&gt;(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> Span&lt;T&gt; span) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : unmanaged <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> U : unmanaged { <span class="hljs-keyword"><span class="hljs-keyword">fixed</span></span>(T* ptr = span) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Span&lt;U&gt;(ptr, span.Length * Unsafe.SizeOf&lt;T&gt;() / Unsafe.SizeOf&lt;U&gt;()); }</code> </pre> <br><p>  <code>C#</code>è¯­æ³•ç°åœ¨é€šè¿‡éšå¼è°ƒç”¨<code>Span&lt;T&gt;.GetPinnableReference()</code>æ–¹æ³•æ¥æ”¯æŒæ­¤<code>fixed</code>çŠ¶æ€è®°å½•ã€‚ <br> åœ¨<code>x64</code>æ¨¡å¼ä¸‹çš„<code>netframework4.8</code>ä¸Šè¿è¡Œæ­¤æ–¹æ³•ã€‚ æˆ‘ä»¬çœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆï¼š </p><br><pre> <code class="plaintext hljs">LEGACY [ 999, 123, 11, -100 ] [ 231, 3, 0, 0, 123, 0, 0, 0, 11, 0, 0, 0, 156, 255, 255, 255 ] 0x|00|00|02|8C|00|00|2F|B0 999 Span&lt;int&gt; [0] 0x|00|00|02|8C|00|00|2F|B0 999 Span&lt;byte&gt;[0] 0x|00|00|02|8C|00|00|2F|B8 11 Span&lt;int&gt; [0] offset by size_t 0x|00|00|02|8C|00|00|2F|B8 11 Span&lt;byte&gt;[0] offset by size_t 0x|00|00|02|8C|00|00|2B|18 999 Span&lt;int&gt; [0] after GC 0x|00|00|02|8C|00|00|2F|B0 6750318 Span&lt;byte&gt;[0] after GC [ 999, 123, 11, -100 ] [ 110, 0, 103, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ]</code> </pre> <br><p> æœ€åˆï¼Œä¸¤ä¸ªè·¨åº¦ï¼ˆå°½ç®¡ç±»å‹ä¸åŒï¼‰çš„è¡Œä¸ºå‡ç›¸åŒï¼Œå¹¶ä¸”<code>Span&lt;byte&gt;</code>æœ¬è´¨ä¸Šè¡¨ç¤ºåŸå§‹æ•°ç»„çš„å­—èŠ‚è§†å›¾ã€‚ æ‚¨éœ€è¦ä»€ä¹ˆã€‚ <br> å¥½çš„ï¼Œè®©æˆ‘ä»¬å°è¯•å°†è·¨åº¦çš„å¼€å§‹ä½ç½®æ›´æ”¹ä¸ºä¸€ä¸ª<code>IntPtr</code>çš„å¤§å°ï¼ˆæˆ–<code>x64</code>ä¸Šçš„<code>2 X int</code> ï¼‰å¹¶è¯»å–ã€‚ æˆ‘ä»¬å¾—åˆ°æ•°ç»„çš„ç¬¬ä¸‰ä¸ªå…ƒç´ å’Œæ­£ç¡®çš„åœ°å€ã€‚ ç„¶åæˆ‘ä»¬å°†æ”¶é›†åƒåœ¾... </p><br><pre> <code class="plaintext hljs">GC.Collect(0, GCCollectionMode.Forced, true, true);</code> </pre> <br><p> æ­¤æ–¹æ³•ä¸­çš„æœ€åä¸€ä¸ªæ ‡å¿—è¦æ±‚<code>GC</code>å‹ç¼©å †ã€‚ è°ƒç”¨<code>GC.Collect</code> <code>GC</code>å°†ç§»åŠ¨åŸå§‹æœ¬åœ°æ•°ç»„ã€‚  <code>Span&lt;int&gt;</code>åæ˜ äº†è¿™äº›æ›´æ”¹ï¼Œä½†æ˜¯æˆ‘ä»¬çš„<code>Span&lt;byte&gt;</code>ç»§ç»­æŒ‡å‘æ—§åœ°å€ï¼Œç°åœ¨å°šä¸æ¸…æ¥šè¯¥åœ°å€ã€‚ ä¸€æ¬¡æ‹æ‘„è‡ªå·±æ‰€æœ‰è†ç›–çš„å¥½æ–¹æ³•ï¼ </p><br><p> ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹åœ¨<code>netcore3.0.100-preview8</code>ä¸Šè°ƒç”¨çš„å®Œå…¨ç›¸åŒçš„ä»£ç ç‰‡æ®µçš„ç»“æœã€‚ </p><br><pre> <code class="plaintext hljs">CORE [ 999, 123, 11, -100 ] [ 231, 3, 0, 0, 123, 0, 0, 0, 11, 0, 0, 0, 156, 255, 255, 255 ] 0x|00|00|01|F2|8F|BD|C6|90 999 Span&lt;int&gt; [0] 0x|00|00|01|F2|8F|BD|C6|90 999 Span&lt;byte&gt;[0] 0x|00|00|01|F2|8F|BD|C6|98 11 Span&lt;int&gt; [0] offset by size_t 0x|00|00|01|F2|8F|BD|C6|98 11 Span&lt;byte&gt;[0] offset by size_t 0x|00|00|01|F2|8F|BD|BF|38 999 Span&lt;int&gt; [0] after GC 0x|00|00|01|F2|8F|BD|BF|38 999 Span&lt;byte&gt;[0] after GC [ 999, 123, 11, -100 ] [ 231, 3, 0, 0, 123, 0, 0, 0, 11, 0, 0, 0, 156, 255, 255, 255 ]</code> </pre> <br><p> æ®æˆ‘æ‰€çŸ¥ï¼Œä¸€åˆ‡æ­£å¸¸ï¼Œå¹¶ä¸”è¿è¡Œ<em>ç¨³å®š</em> ã€‚ å‹ç¼©åï¼Œä¸¤ä¸ªè¥¿ç­ç‰™éƒ½æ›´æ”¹å…¶æŒ‡é’ˆã€‚ å¤ªå¥½äº†ï¼ ä½†æ˜¯ï¼Œç°åœ¨å¦‚ä½•ä½¿å…¶åœ¨é—ç•™é¡¹ç›®ä¸­èµ·ä½œç”¨ï¼Ÿ </p><br><h1 id="jit-intrinsic">  Jitå†…åœ¨ </h1><br><p> æˆ‘å®Œå…¨å¿˜è®°äº†å¯¹spansçš„æ”¯æŒæ˜¯é€šè¿‡<a href="">intrinsik</a>åœ¨<code>netcore</code>å®ç°çš„ã€‚ æ¢å¥è¯è¯´ï¼Œ <code>netcore</code>ç”šè‡³å¯ä»¥åˆ›å»ºæŒ‡å‘æ•°ç»„ç‰‡æ®µçš„å†…éƒ¨æŒ‡é’ˆï¼Œå¹¶åœ¨<code>GC</code>ç§»åŠ¨å®ƒæ—¶æ­£ç¡®æ›´æ–°é“¾æ¥ã€‚ åœ¨<code>netframework</code> ï¼Œè·¨åº¦çš„<code>nuget</code>å®ç°æ˜¯æ‹æ–ã€‚ å®é™…ä¸Šï¼Œæˆ‘ä»¬æœ‰ä¸¤ç§ä¸åŒçš„ç”¨æ³•ï¼šä¸€ç§æ˜¯ä»æ•°ç»„åˆ›å»ºçš„ï¼Œå¹¶è·Ÿè¸ªå…¶é“¾æ¥ï¼Œç¬¬äºŒç§æ˜¯ä»æŒ‡é’ˆçš„ï¼Œå¹¶ä¸”ä¸çŸ¥é“å…¶æŒ‡å‘ä»€ä¹ˆã€‚ ç§»åŠ¨åŸå§‹æ•°ç»„åï¼ŒspanæŒ‡é’ˆå°†ç»§ç»­æŒ‡å‘ä¼ é€’ç»™å…¶æ„é€ å‡½æ•°çš„æŒ‡é’ˆæ‰€æŒ‡å‘çš„ä½ç½®ã€‚ ä¸ºäº†è¿›è¡Œæ¯”è¾ƒï¼Œè¿™æ˜¯<code>netcore</code>ä¸­spançš„<em>ç¤ºä¾‹</em>å®ç°ï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> Span&lt;T&gt; <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : unmanaged { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ByReference&lt;T&gt; _pointer; <span class="hljs-comment"><span class="hljs-comment">//  -   private readonly int _length; }</span></span></code> </pre> <br><p> å’Œåœ¨<code>netframework</code> ï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> Span&lt;T&gt; <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : unmanaged { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Pinnable&lt;T&gt; _pinnable; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IntPtr _byteOffset; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _length; }</code> </pre> <br><p>  <code>_pinnable</code>åŒ…å«å¯¹è¯¥æ•°ç»„çš„å¼•ç”¨ï¼Œå¦‚æœå°†ä¸€ä¸ªå¼•ç”¨ä¼ é€’ç»™æ„é€ å‡½æ•°ï¼Œåˆ™<code>_byteOffset</code>åŒ…å«ä¸€ä¸ªç§»ä½ï¼ˆç”šè‡³æ•´ä¸ªæ•°ç»„çš„è·¨åº¦ä¹Ÿ<em>å¯èƒ½</em>ä¸æ•°ç»„åœ¨å†…å­˜ä¸­çš„è¡¨ç¤ºæ–¹å¼æœ‰å…³ï¼Œå…·æœ‰ä¸€äº›éé›¶ç§»ä½ï¼‰ã€‚ å¦‚æœå°†<code>void*</code>æŒ‡é’ˆä¼ é€’ç»™æ„é€ å‡½æ•°ï¼Œåˆ™å°†å…¶ç®€å•åœ°è½¬æ¢ä¸ºç»å¯¹<code>_byteOffset</code> ã€‚  Spanå°†è¢«å›ºå®šåœ¨å†…å­˜åŒºåŸŸï¼Œå¹¶ä¸”æ‰€æœ‰å®ä¾‹æ–¹æ³•çš„æ¡ä»¶éƒ½éå¸¸ä¸°å¯Œï¼Œä¾‹å¦‚<code>if(_pinnable is null) {/*    */} else {/*    _pinnable */}</code> ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹è¯¥æ€ä¹ˆåŠï¼Ÿ </p><br><h1 id="kak-delat-ne-stoit-no-ya-vse-zhe-sdelal"> æ€ä¹ˆåšæ˜¯ä¸å€¼å¾—çš„ï¼Œä½†æˆ‘è¿˜æ˜¯åšäº† </h1><br><p> æœ¬èŠ‚ä¸“é—¨ä»‹ç»<code>netframework</code>æ”¯æŒçš„å„ç§å®ç°ï¼Œè¿™äº›å®ç°å…è®¸<code>netframework</code> <code>Span&lt;T&gt; -&gt; Span&lt;U&gt;</code> ï¼Œå¹¶ä¿ç•™æ‰€æœ‰å¿…è¦çš„é“¾æ¥ã€‚ <br>  <strong>æˆ‘è­¦å‘Šæ‚¨ï¼šè¿™æ˜¯å¼‚å¸¸ç¼–ç¨‹çš„åŒºåŸŸï¼Œå¯èƒ½å­˜åœ¨åŸºæœ¬é”™è¯¯ï¼Œå¹¶ä¸”æœ€ç»ˆå‡ºç°æœªå®šä¹‰çš„è¡Œä¸º</strong> </p><br><h2 id="metod-1-naivnyy"> æ–¹æ³•1ï¼šå¤©çœŸ </h2><br><p> å¦‚ç¤ºä¾‹æ‰€ç¤ºï¼ŒæŒ‡é’ˆçš„è½¬æ¢å°†ä¸ä¼šåœ¨<code>netframework</code>ä¸Šæä¾›æ‰€éœ€çš„ç»“æœã€‚ æˆ‘ä»¬éœ€è¦<code>_pinnable</code>å€¼ã€‚ å¥½çš„ï¼Œæˆ‘ä»¬å°†é€šè¿‡æ’¤æ¶ˆç§æœ‰å­—æ®µæ¥å‘ç°åå°„ï¼ˆéå¸¸ç³Ÿç³•ï¼Œè€Œä¸”å¹¶éæ€»æ˜¯å¯èƒ½çš„ï¼‰ï¼Œæˆ‘ä»¬å°†å…¶å†™æˆæ–°çš„æ–‡å­—ï¼Œæˆ‘ä»¬ä¼šå¾ˆé«˜å…´çš„ã€‚ åªæœ‰ä¸€ä¸ª<em>å°</em>é—®é¢˜ï¼šspenæ˜¯ä¸€ä¸ª<code>ref struct</code> ï¼Œå®ƒæ—¢ä¸èƒ½æ˜¯æ³›å‹å‚æ•°ï¼Œä¹Ÿä¸èƒ½æ‰“åŒ…åˆ°<code>object</code> ã€‚ æ ‡å‡†åå°„æ–¹æ³•å°†éœ€è¦ä¸€ç§æˆ–å¦ä¸€ç§æ–¹æ³•æ¥å°†è·¨åº¦æ¨å…¥å‚è€ƒç±»å‹ã€‚ æˆ‘æ²¡æœ‰æ‰¾åˆ°ç®€å•çš„æ–¹æ³•ï¼ˆç”šè‡³è€ƒè™‘äº†å¯¹ç§æœ‰é¢†åŸŸçš„åæ€ï¼‰ã€‚ </p><br><h2 id="metod-2-we-need-to-go-deeper"> æ–¹æ³•2ï¼šæˆ‘ä»¬éœ€è¦æ›´æ·±å…¥ </h2><br><p> æˆ‘ä¹‹å‰å·²ç»å®Œæˆäº†æ‰€æœ‰å·¥ä½œï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">[1]</a> ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">[2]</a>å’Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">[3]</a> ï¼‰ã€‚  Spenæ˜¯ä¸€ç§ç»“æ„ï¼Œæ— è®º<code>T</code>ä¸ºä½•<code>T</code>ä¸‰ä¸ªå­—æ®µå ç”¨ç›¸åŒçš„å†…å­˜é‡ï¼ˆ <em>åœ¨åŒä¸€ä½“ç³»ç»“æ„ä¸Š</em> ï¼‰ã€‚ å¦‚æœ<code>[FieldOffset(0)]</code>æ€ä¹ˆåŠï¼Ÿ è¨€å½’æ­£ä¼ ã€‚ </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">StructLayout(LayoutKind.Explicit)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> Exchange&lt;T, U&gt; <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : unmanaged <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> U : unmanaged { [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Span&lt;T&gt; Span_1; [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Span&lt;U&gt; Span_2; }</code> </pre> <br><p> ä½†æ˜¯ï¼Œå½“æ‚¨å¯åŠ¨ç¨‹åºæ—¶ï¼ˆæˆ–è€…ï¼Œå½“å°è¯•ä½¿ç”¨ç±»å‹æ—¶ï¼‰ï¼Œ <code>TypeLoadException</code>é‡åˆ°äº†<code>TypeLoadException</code> -æ³›å‹ä¸èƒ½ä¸º<code>LayoutKind.Explicit</code> ã€‚ å¥½çš„ï¼Œæ²¡å…³ç³»ï¼Œè®©æˆ‘ä»¬èµ°ä¸€æ¡è‰°éš¾çš„é“è·¯ï¼š </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">StructLayout(LayoutKind.Explicit)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> Exchange { [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt; ByteSpan; [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">sbyte</span></span>&gt; SByteSpan; [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span>&gt; UShortSpan; [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">short</span></span>&gt; ShortSpan; [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>&gt; UIntSpan; [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; IntSpan; [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span>&gt; ULongSpan; [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>&gt; LongSpan; [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>&gt; FloatSpan; [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>&gt; DoubleSpan; [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt; CharSpan; }</code> </pre> <br><p> ç°åœ¨æ‚¨å¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Span&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">byte</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">As2</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Span&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; span</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> exchange = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exchange() { IntSpan = span }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> exchange.ByteSpan; }</code> </pre> <br><p> è¯¥æ–¹æ³•ä»…è§£å†³ä¸€ä¸ªé—®é¢˜<code>_length</code>å­—æ®µæŒ‰åŸæ ·å¤åˆ¶ï¼Œå› æ­¤åœ¨è½¬æ¢<code>int</code> &gt; <code>byte</code>å­—èŠ‚è·¨åº¦æ¯”å®é™…æ•°ç»„å°4å€ã€‚ <br> æ²¡é—®é¢˜ï¼š </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">StructLayout(LayoutKind.Sequential)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> Raw { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> Pinnable; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IntPtr Pointer; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Length; } [StructLayout(LayoutKind.Explicit)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> Exchange { <span class="hljs-comment"><span class="hljs-comment">/* */</span></span> [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Raw RawView; }</code> </pre> <br><p> ç°åœ¨ï¼Œé€šè¿‡<code>RawView</code>æ‚¨å¯ä»¥è®¿é—®æ¯ä¸ªå•ç‹¬çš„è·¨åº¦å­—æ®µã€‚ </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Span&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">byte</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">As2</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Span&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; span</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> exchange = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exchange() { IntSpan = span }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> exchange2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exchange() { RawView = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Raw() { Pinnable = exchange.RawView.Pinnable, Pointer = exchange.RawView.Pointer, Length = exchange.RawView.Length * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; / <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt; } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> exchange2.ByteSpan; }</code> </pre> <br><p> å¦‚æœæ‚¨å¿½ç•¥ä½¿ç”¨è‚®è„çš„æŠŠæˆ<strong>ï¼Œå®ƒå°±ä¼š</strong>æŒ‰é¢„æœŸå·¥ä½œã€‚ å‡å·-æ— æ³•åˆ›å»ºè½¬æ¢å™¨çš„é€šç”¨ç‰ˆæœ¬ï¼Œæ‚¨å¿…é¡»å¯¹é¢„å®šä¹‰ç±»å‹æ„Ÿåˆ°æ»¡æ„ã€‚ </p><br><h2 id="metod-3-bezumnyy"> æ–¹æ³•3ï¼šç–¯ç‹‚ </h2><br><p> åƒä»»ä½•æ™®é€šçš„ç¨‹åºå‘˜ä¸€æ ·ï¼Œæˆ‘å–œæ¬¢ä½¿äº‹æƒ…è‡ªåŠ¨åŒ–ã€‚ ä¸ºä»»ä½•ä¸€å¯¹<code>unmanaged</code>ç±»å‹ç¼–å†™è½¬æ¢å™¨çš„éœ€æ±‚å¹¶æ²¡æœ‰ä½¿æˆ‘æ»¡æ„ã€‚ å¯ä»¥æä¾›ä»€ä¹ˆè§£å†³æ–¹æ¡ˆï¼Ÿ æ˜¯çš„ï¼Œè®©<code>CLR</code> <em>ä¸ºæ‚¨</em>ç¼–å†™ä»£ç ã€‚ </p><br><p> å¦‚ä½•å®ç°å‘¢ï¼Ÿ æœ‰ä¸åŒçš„æ–¹å¼ï¼Œæœ‰<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡ç« </a> ã€‚ ç®€è€Œè¨€ä¹‹ï¼Œè¯¥è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š <br> åˆ›å»ºä¸€ä¸ªæ„å»ºæ„å»ºå™¨-&gt;åˆ›å»ºä¸€ä¸ªæ¨¡å—æ„å»ºå™¨-&gt;æ„å»ºä¸€ä¸ªç±»å‹-&gt; {å­—æ®µï¼Œæ–¹æ³•ç­‰}-&gt;åœ¨è¾“å‡ºä¸­ï¼Œæˆ‘ä»¬å¾—åˆ°<code>Type</code>çš„å®ä¾‹ã€‚ <br> ä¸ºäº†ç¡®åˆ‡äº†è§£ç±»å‹åº”è¯¥æ˜¯ä»€ä¹ˆæ ·ï¼ˆè¿™æ˜¯ä¸€ä¸ª<code>ref struct</code> ï¼‰ï¼Œæˆ‘ä»¬ä½¿ç”¨ä»»ä½•<code>ildasm</code>ç±»å‹çš„å·¥å…·ã€‚ å°±æˆ‘è€Œè¨€ï¼Œå®ƒæ˜¯<strong>dotPeek</strong> ã€‚ <br> åˆ›å»ºä¸€ä¸ªç±»å‹ç”Ÿæˆå™¨çœ‹èµ·æ¥åƒè¿™æ ·ï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> typeBuilder = _mBuilder.DefineType(<span class="hljs-string"><span class="hljs-string">$"Generated_</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">typeof</span></span></span></span><span class="hljs-string"><span class="hljs-subst">(T).Name}</span></span></span><span class="hljs-string">"</span></span>, TypeAttributes.Public | TypeAttributes.Sealed | TypeAttributes.ExplicitLayout <span class="hljs-comment"><span class="hljs-comment">// &lt;-    | TypeAttributes.AnsiClass | TypeAttributes.BeforeFieldInit, typeof(ValueType));</span></span></code> </pre> <br><p> ç°åœ¨æ˜¯ç”°é‡ã€‚ ç”±äºé•¿åº¦ä¸åŒï¼Œæˆ‘ä»¬æ— æ³•å°†<code>Span&lt;T&gt;</code>ç›´æ¥å¤åˆ¶åˆ°<code>Span&lt;U&gt;</code> ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¸ºæ¯ç§ç±»å‹çš„æ¼”å‘˜åˆ›å»ºâ€‹â€‹ä¸¤ç§ç±»å‹ </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">StructLayout(LayoutKind.Explicit)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> Generated_Int32 { [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Span&lt;Int32&gt; Span; [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Raw Raw; }</code> </pre> <br><p> åœ¨è¿™é‡Œ<code>Raw</code>å¯ä»¥ç”¨æ‰‹å£°æ˜å¹¶é‡ç”¨ã€‚ ä¸è¦å¿˜è®°<code>IsByRefLikeAttribute</code> ã€‚ ä½¿ç”¨å­—æ®µï¼Œä¸€åˆ‡éƒ½å¾ˆç®€å•ï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> spanField = typeBuilder.DefineField(<span class="hljs-string"><span class="hljs-string">"Span"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Span&lt;T&gt;), FieldAttributes.Private); spanField.SetOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rawField = typeBuilder.DefineField(<span class="hljs-string"><span class="hljs-string">"Raw"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Raw), FieldAttributes.Private); rawField.SetOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre> <br><p> å°±æ˜¯è¿™æ ·ï¼Œæœ€ç®€å•çš„ç±»å‹å·²ç»å‡†å¤‡å°±ç»ªã€‚ ç°åœ¨ç¼“å­˜ç¨‹åºé›†æ¨¡å—ã€‚ è‡ªå®šä¹‰ç±»å‹è¢«ç¼“å­˜åœ¨ä¾‹å¦‚å­—å…¸ä¸­ï¼ˆ <code>T -&gt; Generated_{nameof(T)}</code> ï¼‰ã€‚ æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåŒ…è£…ç¨‹åºï¼Œæ ¹æ®ä¸¤ç§ç±»å‹çš„<code>TIn</code>å’Œ<code>TOut</code>ç”Ÿæˆä¸¤ç§ç±»å‹çš„å¸®åŠ©ç¨‹åºå¹¶åœ¨è·¨åº¦ä¸Šæ‰§è¡Œå¿…è¦çš„æ“ä½œã€‚ ä½†æ˜¯æœ‰ä¸€ä¸ªã€‚ å°±åƒåå°„çš„æƒ…å†µä¸€æ ·ï¼Œå‡ ä¹ä¸å¯èƒ½åœ¨è·¨åº¦ï¼ˆæˆ–å…¶ä»–<code>ref struct</code> ï¼‰ä¸Šä½¿ç”¨å®ƒã€‚  <em>è¿˜æ˜¯æˆ‘æ²¡æœ‰æ‰¾åˆ°ç®€å•çš„è§£å†³æ–¹æ¡ˆ</em> ã€‚ æ€ä¹ˆæ · </p><br><h2 id="delegates-to-the-rescue"> æ•‘æ´äººå‘˜ </h2><br><p> åå°„æ–¹æ³•é€šå¸¸çœ‹èµ·æ¥åƒè¿™æ ·ï¼š </p><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Invoke</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MethodInfo mi, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> @</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] otherArgs</span></span></span><span class="hljs-function">)</span></span></code> </pre> <br><p> å®ƒä»¬ä¸åŒ…å«æœ‰å…³ç±»å‹çš„ä¿¡æ¯ï¼Œå› æ­¤ï¼Œå¦‚æœæ‚¨å¯ä»¥æ¥å—è£…ç®±ï¼ˆ=åŒ…è£…ï¼‰ï¼Œåˆ™ä¸ä¼šæœ‰é—®é¢˜ã€‚ <br> åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œ <code>otherArgs</code>å’Œ<code>otherArgs</code>å¿…é¡»åŒ…å«ä¸€ä¸ª<code>ref struct</code> ï¼Œæˆ‘æ— æ³•ç»•å¼€å®ƒã€‚ <br> ä½†æ˜¯ï¼Œæœ‰ä¸€ç§æ›´ç®€å•çš„æ–¹æ³•ã€‚ å‡è®¾ä¸€ä¸ªç±»å‹å…·æœ‰getterå’Œsetteræ–¹æ³•ï¼ˆä¸æ˜¯å±æ€§ï¼Œè€Œæ˜¯æ‰‹åŠ¨åˆ›å»ºçš„ç®€å•æ–¹æ³•ï¼‰ã€‚ <br> ä¾‹å¦‚ï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Generated_Int32.SetSpan(Span&lt;Int32&gt; span) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Span = span;</code> </pre> <br><p> é™¤äº†æ–¹æ³•ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å£°æ˜ä¸€ä¸ªå§”æ‰˜ç±»å‹ï¼ˆåœ¨ä»£ç ä¸­æ˜ç¡®å£°æ˜ï¼‰ï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> SpanSetterDelegate&lt;T&gt;(Span&lt;T&gt; span) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : unmanaged;</code> </pre> <br><p> æˆ‘ä»¬å¿…é¡»è¿™æ ·åšï¼Œå› ä¸ºæ ‡å‡†åŠ¨ä½œå¿…é¡»å…·æœ‰<code>Action&lt;Span&lt;T&gt;&gt;</code>ç­¾åï¼Œä½†æ˜¯ä¸èƒ½å°†spenesç”¨ä½œé€šç”¨å‚æ•°ã€‚ ä½†æ˜¯ï¼Œ <code>SpanSetterDelegate</code>æ˜¯ç»å¯¹æœ‰æ•ˆçš„å§”æ‰˜ã€‚ <br> åˆ›å»ºå¿…è¦çš„å§”æ‰˜ã€‚ ä¸ºæ­¤ï¼Œè¯·æ‰§è¡Œæ ‡å‡†æ“ä½œï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mi = type.GetMethod(<span class="hljs-string"><span class="hljs-string">"Method_Name"</span></span>); <span class="hljs-comment"><span class="hljs-comment">// ,    public &amp; instance var spanSetter = (SpanSetterDelegate&lt;T&gt;) mi.CreateDelegate(typeof(SpanSetterDelegate&lt;T&gt;), @this);</span></span></code> </pre> <br><p> ç°åœ¨ï¼Œ <code>spanSetter</code>å¯ä»¥ç”¨ä½œ<code>spanSetter(Span&lt;T&gt;.Empty);</code>  ã€‚ è‡³äº<code>@this</code> <sup>2</sup> ï¼Œè¿™æ˜¯æˆ‘ä»¬çš„åŠ¨æ€ç±»å‹çš„å®ä¾‹ï¼Œå½“ç„¶æ˜¯é€šè¿‡<code>Activator.CreateInstance(type)</code> ï¼Œå› ä¸ºè¯¥ç»“æ„å…·æœ‰ä¸€ä¸ªæ²¡æœ‰å‚æ•°çš„é»˜è®¤æ„é€ å‡½æ•°ã€‚ </p><br><p> å› æ­¤ï¼Œæœ€åä¸€ä¸ªé¢†åŸŸ-æˆ‘ä»¬éœ€è¦åŠ¨æ€ç”Ÿæˆæ–¹æ³•ã€‚ </p><br><p>  <sup>2</sup>æ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°è¿™é‡Œå‡ºäº†ç‚¹é—®é¢˜<code>Activator.CreateInstance()</code>æ‰“åŒ…<code>ref struct</code>å®ä¾‹ã€‚ è¯·å‚é˜…ä¸‹ä¸€èŠ‚çš„ç»“å°¾ã€‚ </p><br><h2 id="znakomtes-reflectionemit"> è®¤è¯†<code>Reflection.Emit</code> </h2><br><p> æˆ‘è®¤ä¸ºæ–¹æ³•å¯ä»¥ä½¿ç”¨<code>Expression</code>ç”Ÿæˆï¼Œå› ä¸º ç®€å•çš„è·å–å™¨/è®¾ç½®å™¨çš„ä¸»ä½“å®é™…ä¸ŠåŒ…å«å‡ ä¸ªè¡¨è¾¾å¼ã€‚ æˆ‘é€‰æ‹©äº†å¦ä¸€ç§æ›´ç›´æ¥çš„æ–¹æ³•ã€‚ </p><br><p> å¦‚æœæ‚¨æŸ¥çœ‹ä¸€ä¸ªç®€å•çš„getterçš„<strong>IL</strong>ä»£ç ï¼Œåˆ™ä¼šçœ‹åˆ°ç±»ä¼¼ï¼ˆ <code>Debug</code> ï¼Œ <code>X86</code> ï¼Œ <code>netframework4.8</code> ï¼‰çš„å†…å®¹ã€‚ </p><br><pre> <code class="plaintext hljs">nop ldarg.0 ldfld /* - */ stloc.0 br.s /*  */ ldloc.0 ret</code> </pre> <br><p> æœ‰å¾ˆå¤šåœ°æ–¹å¯ä»¥åœæ­¢å’Œè°ƒè¯•ã€‚ <br> åœ¨å‘è¡Œç‰ˆæœ¬ä¸­ï¼Œåªæœ‰æœ€é‡è¦çš„éƒ¨åˆ†ä¿ç•™ï¼š </p><br><pre> <code class="plaintext hljs">ldarg.0 ldfld /* - */ ret</code> </pre> <br><p> å®ä¾‹æ–¹æ³•çš„nullå‚æ•°æ˜¯... <code>this</code> ã€‚ å› æ­¤ï¼Œä»¥ä¸‹æ˜¯ç”¨<strong>IL</strong>ç¼–å†™çš„ï¼š <br>  1ï¼‰ä¸‹è½½ <br>  2ï¼‰åŠ è½½å­—æ®µå€¼ <br>  3ï¼‰å¸¦å›æ¥ </p><br><p> åªæ˜¯å—  <code>Reflection.Emit</code>æœ‰ä¸€ä¸ªç‰¹æ®Šçš„é‡è½½ï¼Œé™¤äº†æ“ä½œç ä¹‹å¤–ï¼Œè¿˜éœ€è¦ä¸€ä¸ªå­—æ®µæè¿°ç¬¦å‚æ•°ã€‚ ä¸æˆ‘ä»¬ä¹‹å‰æ”¶åˆ°çš„ä¸€æ ·ï¼Œä¾‹å¦‚<code>spanField</code> ã€‚ </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> getSpan = type.DefineMethod(<span class="hljs-string"><span class="hljs-string">"GetSpan"</span></span>, MethodAttributes.Public | MethodAttributes.HideBySig, CallingConventions.Standard, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Span&lt;T&gt;), Array.Empty&lt;Type&gt;()); gen = getSpan.GetILGenerator(); gen.Emit(OpCodes.Ldarg_0); gen.Emit(OpCodes.Ldfld, spanField); gen.Emit(OpCodes.Ret);</code> </pre> <br><p> å¯¹äºsetteræ¥è¯´ï¼Œå®ƒæœ‰ç‚¹å¤æ‚ï¼Œæ‚¨éœ€è¦å°†å…¶åŠ è½½åˆ°å †æ ˆä¸Šï¼ŒåŠ è½½å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œç„¶ååœ¨å­—æ®µä¸­è°ƒç”¨writeæŒ‡ä»¤ï¼Œä½†ä¸è¿”å›ä»»ä½•å†…å®¹ï¼š </p><br><pre> <code class="cs hljs">ldarg<span class="hljs-number"><span class="hljs-number">.0</span></span> ldarg<span class="hljs-number"><span class="hljs-number">.1</span></span> stfld <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> ret</code> </pre> <br><p> åœ¨<code>Raw</code>å­—æ®µä¸­å®Œæˆæ­¤è¿‡ç¨‹ä¹‹åï¼Œå£°æ˜äº†å¿…è¦çš„å§”æ‰˜ï¼ˆæˆ–ä½¿ç”¨æ ‡å‡†å§”æ‰˜ï¼‰ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªåŠ¨æ€ç±»å‹å’Œå››ä¸ªè®¿é—®å™¨æ–¹æ³•ï¼Œä»ä¸­ç”Ÿæˆäº†æ­£ç¡®çš„æ³›å‹å§”æ‰˜ã€‚ </p><br><p> æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªåŒ…è£…å™¨ç±»ï¼Œè¯¥åŒ…è£…å™¨ç±»ä½¿ç”¨ä¸¤ä¸ªæ³›å‹å‚æ•°ï¼ˆ <code>TIn</code> ï¼Œ <code>TOut</code> ï¼‰æ¥æ”¶å¼•ç”¨ç›¸åº”ï¼ˆç¼“å­˜çš„ï¼‰åŠ¨æ€ç±»å‹çš„<code>Type</code>å®ä¾‹ï¼Œæ­¤åï¼Œå®ƒåˆ›å»ºæ¯ç§ç±»å‹çš„ä¸€ä¸ªå¯¹è±¡å¹¶ç”Ÿæˆå››ä¸ªæ³›å‹å§”æ‰˜ï¼Œå³ </p><br><ol><li>  <code>void SetSpan(Span&lt;TIn&gt; span)</code>ä»¥å°†æºèŒƒå›´å†™å…¥ç»“æ„ </li><li>  <code>Raw GetRaw()</code>ä»¥<code>Raw</code>ç»“æ„è¯»å–è·¨åº¦çš„å†…å®¹ </li><li>  <code>void SetRaw(Raw raw)</code>å°†ä¿®æ”¹åçš„<code>Raw</code>ç»“æ„å†™å…¥ç¬¬äºŒä¸ªå¯¹è±¡ </li><li>  <code>Span&lt;TOut&gt; GetSpan()</code>è¿”å›å…·æœ‰æ­£ç¡®è®¾ç½®å’Œé‡æ–°è®¡ç®—çš„å­—æ®µçš„æ‰€éœ€ç±»å‹çš„è·¨åº¦ã€‚ </li></ol><br><p> æœ‰è¶£çš„æ˜¯ï¼ŒåŠ¨æ€ç±»å‹å®ä¾‹éœ€è¦åˆ›å»ºä¸€æ¬¡ã€‚ åˆ›å»ºå§”æ‰˜æ—¶ï¼Œå¯¹è¿™äº›å¯¹è±¡çš„å¼•ç”¨å°†ä½œä¸º<code>@this</code>å‚æ•°ä¼ é€’ã€‚  <strong>è¿™è¿åäº†è§„åˆ™ã€‚</strong>  <strong><code>Activator.CreateInstance</code>è¿”å›<code>object</code> ã€‚</strong>  <strong>æ˜¾ç„¶ï¼Œè¿™æ˜¯ç”±äºåŠ¨æ€ç±»å‹æœ¬èº«æœª</strong> <code>type.IsByRef</code> <s>ç±»ä¼¼</s> <strong><code>ref</code>çš„äº‹å®ï¼ˆ</strong> <code>type.IsByRef</code> <s>Like</s> <code>== false</code> <strong>ï¼‰ï¼Œä½†æ˜¯å¯ä»¥åˆ›å»º</strong> <s>ç±»ä¼¼</s> <strong><code>ref</code>çš„å­—æ®µã€‚</strong>  <strong>æ˜¾ç„¶ï¼Œè¿™ç§é™åˆ¶å­˜åœ¨äºè¯­è¨€ä¸­ï¼Œä½†<code>CLR</code>æ¶ˆåŒ–ã€‚</strong>  <strong>åœ¨éæ ‡å‡†ä½¿ç”¨çš„æƒ…å†µä¸‹ï¼Œè†ç›–å¯èƒ½ä¼šåœ¨è¿™é‡Œå¼€æªã€‚</strong>  <sup>3</sup> </p><br><p> å› æ­¤ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªæ³›å‹ç±»å‹çš„å®ä¾‹ï¼Œè¯¥å®ä¾‹åŒ…å«å››ä¸ªå§”æ‰˜å’Œä¸¤ä¸ªå¯¹åŠ¨æ€ç±»å®ä¾‹çš„éšå¼å¼•ç”¨ã€‚ è¿ç»­æ‰§è¡Œç›¸åŒçš„ç§å§“æ—¶ï¼Œå¯ä»¥é‡ç”¨å§”æ‰˜å’Œç»“æ„ã€‚ ä¸ºäº†æé«˜æ€§èƒ½ï¼Œæˆ‘ä»¬å†æ¬¡ç¼“å­˜ï¼ˆå·²ç»æ˜¯ç±»å‹è½¬æ¢å™¨ï¼‰å¯¹<code>(TIn, TOut) -&gt; Generator&lt;TIn, TOut&gt;</code> ã€‚ </p><br><h2 id="shtrih-posledniy-privodim-tipy-spantin---spantout"> ç¬”è§¦æ˜¯æœ€åä¸€ä¸ªï¼šæˆ‘ä»¬ç»™å‡ºç±»å‹ï¼Œ <code>Span&lt;TIn&gt; -&gt; Span&lt;TOut&gt;</code> </h2><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Span&lt;TOut&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Cast</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Span&lt;TIn&gt; span</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//      if (span.IsEmpty) return Span&lt;TOut&gt;.Empty; // Caller   ,       if (span.Length * Unsafe.SizeOf&lt;TIn&gt;() % Unsafe.SizeOf&lt;TOut&gt;() != 0) throw new InvalidOperationException(); //      // Span&lt;TIn&gt; _input.Span = span; _spanSetter(span); //  Raw // Raw raw = _input.Raw; var raw = _rawGetter(); var newRaw = new Raw() { Pinnable = raw.Pinnable, //    Pinnable Pointer = raw.Pointer, //   Length = raw.Length * Unsafe.SizeOf&lt;TIn&gt;() / Unsafe.SizeOf&lt;TOut&gt;() //   }; //   Raw    // Raw _output.Raw = newRaw; _rawSetter(newRaw); //     // Span&lt;TOut&gt; _output.Span return _spanGetter(); }</span></span></code> </pre> <br><h1 id="vyvod"> ç»“è®º </h1><br><p> æœ‰æ—¶å‡ºäºä½“è‚²å…´è¶£çš„è€ƒè™‘ï¼Œæ‚¨å¯ä»¥ç»•è¿‡è¯­è¨€çš„æŸäº›é™åˆ¶å¹¶å®ç°éæ ‡å‡†åŠŸèƒ½ã€‚ å½“ç„¶ï¼Œåæœè‡ªè´Ÿã€‚ å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒåŠ¨æ€æ–¹æ³•å…è®¸æ‚¨å®Œå…¨æ”¾å¼ƒæŒ‡é’ˆå’Œ<code>unsafe / fixed</code>ä¸Šä¸‹æ–‡ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªå¥½å¤„ã€‚ æ˜æ˜¾çš„ç¼ºç‚¹æ˜¯éœ€è¦åå°„å’Œç±»å‹ç”Ÿæˆã€‚ </p><br><h1 id="dlya-teh-kto-dochital-do-konca"> å¯¹äºé‚£äº›è¯»åˆ°æœ€åçš„äººã€‚ </h1><br><div class="spoiler">  <b class="spoiler_title">å¤©çœŸçš„åŸºå‡†æµ‹è¯•ç»“æœ</b> <div class="spoiler_text"><p> è¿™ä¸€åˆ‡æœ‰å¤šå¿«ï¼Ÿ <br> æˆ‘åœ¨ä¸€ä¸ªæ„šè ¢çš„åœºæ™¯ä¸­æ¯”è¾ƒäº†ç§å§“çš„é€Ÿåº¦ï¼Œè¿™ç§åœºæ™¯ä¸èƒ½åæ˜ å‡ºè¿™ç§ç§å§“å’Œè·¨åº¦çš„å®é™…/æ½œåœ¨ç”¨é€”ï¼Œä½†è‡³å°‘å¯ä»¥ç»™å‡ºé€Ÿåº¦çš„æ¦‚å¿µã€‚ </p><br><ol><li> <code>Cast_Explicit</code>      ,   <em> 2</em> .           ; </li><li> <code>Cast_IL</code>  <em> 3</em> ,       <code>Generator&lt;TIn, TOut&gt;</code> ,       ,        ; </li><li> <code>Cast_IL_Cached</code>     <code>Generator&lt;TIn, TOut&gt;</code> , -     , ..       ; </li><li> <code>Buffer</code>   ,       ,     .     . </li></ol><br><p>    â€”         <code>int[N]</code>   <code>N/2</code>   . </p><br><p>   ,        ,    .              ,             .    ,          ,            .  ,  <em></em> <em></em> <em>   </em>     <code>unmanaged</code>   <em>  </em> . </p><br><pre> <code class="plaintext hljs">BenchmarkDotNet=v0.11.5, OS=Windows 10.0.18362 Intel Core i7-2700K CPU 3.50GHz (Sandy Bridge), 1 CPU, 8 logical and 4 physical cores [Host] : .NET Framework 4.7.2 (CLR 4.0.30319.42000), 32bit LegacyJIT-v4.8.3815.0 Clr : .NET Framework 4.7.2 (CLR 4.0.30319.42000), 32bit LegacyJIT-v4.8.3815.0 Job=Clr Runtime=Clr InvocationCount=1 UnrollFactor=1</code> </pre><br><div class="scrollable-table"><table><thead><tr><th> Method </th><th>  Ã± </th><th> Mean </th><th> Error </th><th> StdDev </th><th> Median </th><th> Ratio </th><th> RatioSD </th></tr></thead><tbody><tr><td> <strong>Cast_Explicit</strong> </td><td> <strong>100</strong> </td><td> <strong>362.2 ns</strong> </td><td> <strong>18.0967 ns</strong> </td><td> <strong>52.7888 ns</strong> </td><td> <strong>400.0 ns</strong> </td><td> <strong>1.00</strong> </td><td> <strong>0.00</strong> </td></tr><tr><td> Cast_IL </td><td> 100 </td><td> 1,237.9 ns </td><td> 28.5954 ns </td><td> 67.4027 ns </td><td> 1,200.0 ns </td><td> 3.47 </td><td> 0.51 </td></tr><tr><td> Cast_IL_Cached </td><td> 100 </td><td> 522.8 ns </td><td> 25.2640 ns </td><td> 71.2576 ns </td><td> 500.0 ns </td><td> 1.46 </td><td> 0.27 </td></tr><tr><td> Buffer </td><td> 100 </td><td> 300.0 ns </td><td> 0.0000 ns </td><td> 0.0000 ns </td><td> 300.0 ns </td><td> 0.78 </td><td> 0.11 </td></tr><tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td> <strong>Cast_Explicit</strong> </td><td>  <strong>1000</strong> </td><td> <strong>2,628.6 ns</strong> </td><td> <strong>54.0688 ns</strong> </td><td> <strong>64.3650 ns</strong> </td><td> <strong>2,600.0 ns</strong> </td><td> <strong>1.00</strong> </td><td> <strong>0.00</strong> </td></tr><tr><td> Cast_IL </td><td> 1000 </td><td> 3,216.7 ns </td><td> 49.8568 ns </td><td> 38.9249 ns </td><td> 3,200.0 ns </td><td> 1.21 </td><td> 0.03 </td></tr><tr><td> Cast_IL_Cached </td><td> 1000 </td><td> 2,484.6 ns </td><td> 44.9717 ns </td><td> 37.5534 ns </td><td> 2,500.0 ns </td><td> 0.94 </td><td> 0.02 </td></tr><tr><td> Buffer </td><td> 1000 </td><td> 2,055.6 ns </td><td> 43.9695 ns </td><td> 73.4631 ns </td><td> 2,000.0 ns </td><td> 0.78 </td><td> 0.03 </td></tr><tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td> <strong>Cast_Explicit</strong> </td><td> <strong>1000000</strong> </td><td> <strong>2,515,157.1 ns</strong> </td><td> <strong>11,809.8538 ns</strong> </td><td> <strong>10,469.1278 ns</strong> </td><td> <strong>2,516,050.0 ns</strong> </td><td> <strong>1.00</strong> </td><td> <strong>0.00</strong> </td></tr><tr><td> Cast_IL </td><td> 1000000 </td><td> 2,263,826.7 ns </td><td> 23,724.4930 ns </td><td> 22,191.9054 ns </td><td> 2,262,000.0 ns </td><td> 0.90 </td><td> 0.01 </td></tr><tr><td> Cast_IL_Cached </td><td> 1000000 </td><td> 2,265,186.7 ns </td><td> 19,505.5913 ns </td><td> 18,245.5422 ns </td><td> 2,266,300.0 ns </td><td> 0.90 </td><td> 0.01 </td></tr><tr><td> Buffer </td><td> 1000000 </td><td> 1,959,547.8 ns </td><td> 39,175.7435 ns </td><td> 49,544.7719 ns </td><td> 1,959,200.0 ns </td><td> 0.78 </td><td> 0.02 </td></tr><tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td> <strong>Cast_Explicit</strong> </td><td> <strong>100000000</strong> </td><td> <strong>255,751,392.9 ns</strong> </td><td> <strong>2,595,107.7066 ns</strong> </td><td> <strong>2,300,495.3873 ns</strong> </td><td> <strong>255,298,950.0 ns</strong> </td><td> <strong>1.00</strong> </td><td> <strong>0.00</strong> </td></tr><tr><td> Cast_IL </td><td> 100000000 </td><td> 228,709,457.1 ns </td><td> 527,430.9293 ns </td><td> 467,553.7809 ns </td><td> 228,864,100.0 ns </td><td> 0.89 </td><td> 0.01 </td></tr><tr><td> Cast_IL_Cached </td><td> 100000000 </td><td> 227,966,553.8 ns </td><td> 355,027.3545 ns </td><td> 296,463.9203 ns </td><td> 227,903,600.0 ns </td><td> 0.89 </td><td> 0.01 </td></tr><tr><td> Buffer </td><td> 100000000 </td><td> 213,216,776.9 ns </td><td> 1,198,565.1142 ns </td><td> 1,000,856.1536 ns </td><td> 213,517,800.0 ns </td><td> 0.83 </td><td> 0.01 </td></tr></tbody></table></div></div></div><br><div class="spoiler"> <b class="spoiler_title">Acknowledgements</b> <div class="spoiler_text"><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>JetBrains</strong></a> (      :-))   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>R#</strong></a>    <strong>VS</strong>  standalone- <strong>dotPeek</strong> ,     .  <code>BenchmarkDotNet</code>  BenchmarkDotNet, youtube- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>NDC Conferences</strong></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>DotNext</strong></a>    ,  ,         . </p></div></div><br><h1 id="ps"> èšè‹¯ä¹™çƒ¯ </h1><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><p> <sup>3</sup>         ,      <code>ref</code> ,      ,   .  <s></s>   (   )   .    <code>ref</code> structs,        </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Raw Generated_Int32.GetRaw(Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; span) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> inst = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Generated_Int32() { Span = span }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> inst.Raw; }</code> </pre> <br><p>     ,     <code>Reflection.Emit</code> .      ,   <em></em>  <code>ILGenerator.DeclareLocal</code> .     </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; Generated_Int32.GetSpan(Raw raw);</code> </pre> <br><p>    </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span> Raw GetRaw&lt;T&gt;(Span&lt;T&gt; span) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : unmanaged; <span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span> Span&lt;T&gt; GetSpan&lt;T&gt;(Raw raw) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : unmanaged;</code> </pre> <br><p> , <em> </em> ,       <code>ref</code> â€” . å› ä¸º     ,      </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> getter = type.GetMethod(<span class="hljs-string"><span class="hljs-string">@"GetRaw"</span></span>, BindingFlags.Static | BindingFlags.Public).CreateDelegate(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(GetRaw&lt;T&gt;), <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> GetRaw&lt;T&gt;;</code> </pre> <br><p>   â€”  </p><br><pre> <code class="cs hljs">Raw raw = getter(Span&lt;TIn&gt;.Empty); Raw newRaw = convert(raw); Span&lt;TOut&gt; = setter(newRaw);</code> </pre> </div></div><br><p> <em>UPD01:   </em> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN465077/">https://habr.com/ru/post/zh-CN465077/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN465063/index.html">ä½¿ç”¨Springå¹³å°æ—¶æœ€å¸¸è§çš„10ä¸ªé”™è¯¯ã€‚ ç¬¬äºŒéƒ¨åˆ†</a></li>
<li><a href="../zh-CN465069/index.html">Hadoopçš„æ–°åŠŸèƒ½ï¼šäº†è§£Hadoopä¸­çš„å„ç§æ–‡ä»¶æ ¼å¼</a></li>
<li><a href="../zh-CN465071/index.html">TechTrain 2019 ITèŠ‚ï¼šJUG.ruï¼ŒJUGNskå’ŒJUG.MSKå¦‚ä½•å‚åŠ </a></li>
<li><a href="../zh-CN465073/index.html">ä¸è¦å¼¹å‡ºï¼ iOSä¸­çš„å¯ä¸­æ–­è¿‡æ¸¡</a></li>
<li><a href="../zh-CN465075/index.html">åœ¨ç«è½¦å¸æœºå®¤</a></li>
<li><a href="../zh-CN465081/index.html">CLRiumï¼ƒ6ï¼šå¹¶å‘ä¸å¹¶è¡Œã€‚ å­¦ä¹ ä»»åŠ¡å¹¶è¡ŒåŒ–çš„é­”åŠ›</a></li>
<li><a href="../zh-CN465083/index.html">è­¦æƒ•é—¨ç›‘æ§</a></li>
<li><a href="../zh-CN465085/index.html">åç½‘ç»œé’“é±¼æ¸…å•</a></li>
<li><a href="../zh-CN465087/index.html">ç¾å›½å®‡èˆªå±€å¦‚ä½•è˜è¯·å²åŠªæ¯”å¹¶æŒ‘é€‰èŠ­æ¯”å¨ƒå¨ƒçš„è¡£æœ</a></li>
<li><a href="../zh-CN465089/index.html">æœºä¼šå¦‚ä½•å¸®åŠ©æ•°å­¦å®¶</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>