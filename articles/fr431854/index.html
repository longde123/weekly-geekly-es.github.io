<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚öíÔ∏è ü§ó üòö Coh√©rence des donn√©es dans les syst√®mes fortement charg√©s üôá üè≥Ô∏è üòè</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Probl√®me 
 Presque tous les syst√®mes d'information n√©cessitent un stockage de donn√©es sur une base continue. Dans la plupart des syst√®mes √† faible et ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Coh√©rence des donn√©es dans les syst√®mes fortement charg√©s</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/431854/"><h2>  Probl√®me </h2><br>  Presque tous les syst√®mes d'information n√©cessitent un stockage de donn√©es sur une base continue.  Dans la plupart des syst√®mes √† faible et moyenne charge, cette fonction est r√©alis√©e par des SGBD relationnels, dont l'avantage incontestable est la garantie de la coh√©rence des donn√©es. <br><br>  Un exemple classique qui explique ce qu'est la coh√©rence des donn√©es - l'op√©ration de transfert de fonds d'un compte √† un autre.  Au moment o√π l'op√©ration de modification du solde d'un compte est d√©j√† termin√©e et que l'autre n'a pas encore eu le temps, une d√©faillance peut se produire.  Les fonds seront ensuite d√©bit√©s d'un compte, mais ne seront pas cr√©dit√©s sur un autre.  Cet √©tat des donn√©es du syst√®me est appel√© incoh√©rent et, peut-√™tre, il n'est pas n√©cessaire d'expliquer les cons√©quences que cela peut entra√Æner.  Les SGBD relationnels fournissent un m√©canisme de transaction qui garantit la coh√©rence des donn√©es √† tout moment.  Une transaction est un ensemble fini d'op√©rations qui transf√®re un √©tat coh√©rent √† un autre √©tat coh√©rent. <a name="habracut"></a>  En cas d'erreur √† n'importe quelle √©tape, le SGBD annule toutes les op√©rations pr√©c√©demment effectu√©es et remet les donn√©es √† leur √©tat convenu d'origine.  En d'autres termes, soit toutes les op√©rations seront effectu√©es, soit pas une seule. <br><br>  Quant aux syst√®mes √† grande √©chelle, il est loin d'√™tre toujours possible d'y utiliser une seule base de donn√©es √† cause d'une charge trop lourde.  Dans de tels cas, chaque module syst√®me (service) est fourni avec sa propre base de donn√©es distincte.  Dans ce cas, la question se pose de savoir comment garantir la coh√©rence des donn√©es pour une telle architecture de cluster. <br><br><h2>  R√©solution de la coh√©rence des donn√©es </h2><br>  Une solution est les transactions distribu√©es.  Tout d'abord, tous les n≈ìuds du cluster doivent accepter que l'op√©ration est possible, puis les modifications sont valid√©es pour tous les n≈ìuds.  √âtant donn√© que les n≈ìuds n'ont pas de p√©riph√©rique de stockage commun, la seule fa√ßon de parvenir √† une opinion commune est de convenir en utilisant un protocole de consensus distribu√©. <br><br>  Un protocole simple pour capturer des transactions globales est la validation en deux phases (2PC).  Le n≈ìud effectuant la transaction est consid√©r√© comme le coordinateur.  Dans la phase de pr√©paration (prepare), le coordinateur informe les autres n≈ìuds de la validation de transaction et attend de leur confirmation qu'ils sont pr√™ts √† s'engager.  Si au moins un n≈ìud n'est pas pr√™t, la transaction est interrompue.  Dans la phase de validation, le coordinateur informe tous les n≈ìuds de la d√©cision de valider la transaction.  D√®s r√©ception de la confirmation de tout le monde que tout va bien, le coordinateur capture √©galement la transaction. <br><br><img src="https://access.redhat.com/webassets/avalon/d/JBoss_Enterprise_Application_Platform-5-Transactions_Development_Guide-en-US/images/721547b5fb5ee9da94ec3200cb1231fe/fig-two-phase-commit-overview.png" alt="image"><br><br><h4>  Figure 1 - Sch√©ma g√©n√©ral d'un commit en deux phases </h4><br>  Ce protocole √©vite un minimum de messages, mais n'est pas robuste.  Par exemple, si le coordinateur √©choue apr√®s la phase de pr√©paration, les n≈ìuds restants ne disposent pas d'informations sur la validation ou l'annulation de la transaction (ils devront attendre que l'√©chec soit corrig√©).  Un autre inconv√©nient s√©rieux de 2PC (et d'autres protocoles de transaction distribu√©s, par exemple 3PC) est qu'√† mesure que le nombre de n≈ìuds de cluster augmente, les performances des validations en deux phases diminuent. <br><br><img src="http://www.techort.com/wp-content/uploads/2018/10/1539271021_859_data-integrity-in-microservice-architecture-how-to-ensure-it-without-distributed-transactions-and-tight-connectivity-avito-habr-blog.png" alt="image"><br><br><h4>  Figure 2 - D√©pendance de la vitesse d'une validation √† deux bases sur le nombre de serveurs dans un cluster SGBD </h4><br>  De plus, l'approche transactionnelle distribu√©e impose une limitation: tous les modules du syst√®me doivent utiliser le m√™me SGBD, ce qui n'est pas toujours pratique. <br><br>  Une autre option consiste √† fournir un m√©canisme qui vous permet de travailler avec diff√©rentes bases de donn√©es (pour les services) en tant que base de donn√©es unique (pour r√©soudre le probl√®me d'int√©grit√© des donn√©es dans une base de donn√©es distribu√©e).  Dans le m√™me temps, un certain analogue d'une transaction pour un syst√®me distribu√© (¬´transaction commerciale¬ª) est requis. <br><br>  Dans les transactions ordinaires, ainsi que dans les validations en deux phases, toutes les op√©rations sont contr√¥l√©es par le m√©canisme de transaction (√† l'aide de verrous), et cela est fait afin de fournir la possibilit√© d'annuler toute op√©ration (approche pessimiste - nous consid√©rons que toute op√©ration est potentiellement √† l'origine d'une d√©faillance).  C'est le goulot d'√©tranglement du syst√®me.  Une alternative est l'approche dite optimiste: nous pensons que la plupart des op√©rations sont men√©es √† bien.  Nous effectuons √©galement des actions suppl√©mentaires en cas de panne.  C'est-√†-dire  r√©duire les co√ªts pour la plupart des op√©rations, ce qui conduit √† une productivit√© accrue. <br><br><h2>  Qu'est-ce qu'une saga et comment √ßa marche </h2><br>  Une alternative aux transactions pour l'architecture de microservices est Saga.  Saga (saga) est un ensemble d'√©tapes effectu√©es par divers modules du syst√®me (services);  le service saga est √©galement requis, qui est responsable de l'op√©ration (transaction commerciale) dans son ensemble.  Les √©tapes sont li√©es via un graphique d'√©v√©nement.  Une fois la saga termin√©e, le syst√®me doit passer d'un √©tat convenu √† un autre (en cas de r√©ussite), ou revenir √† l'√©tat convenu pr√©c√©demment (en cas d'annulation). <br><br>  Comment mettre en ≈ìuvre un tel retour ou rollback d'une transaction commerciale?  Pour ce faire, la saga utilise le m√©canisme d'annulation des √©tapes (actions compensatoires).  Par exemple, l'une des √©tapes a r√©ussi (par exemple, une entr√©e a √©t√© ajout√©e √† la table de base de donn√©es utilisateur), mais l'une des √©tapes suivantes a √©chou√© et la saga enti√®re doit √™tre annul√©e.  Ensuite, le m√™me service re√ßoit une commande - annulez l'action.  Mais dans le SGBD de service, la transaction locale est d√©j√† termin√©e, l'enregistrement utilisateur a √©t√© ajout√©.  Ensuite, pour revenir √† l'√©tat pr√©c√©dent, le service doit effectuer une action de compensation (dans notre exemple, supprimer l'enregistrement).  L'annulation des √©tapes permet de mettre en ≈ìuvre l'atomicit√© (¬´tout ou rien¬ª) dans le cadre de la saga - toutes les √©tapes sont r√©alis√©es ou compens√©es. <br><br><img src="https://cdn-images-1.medium.com/max/1200/1*IUfYVaCXhQHWqM13_6sLhQ.png" alt="image"><br><br><h4>  Figure 3 - Le m√©canisme de travail de Saga et la nature de l'effet compensatoire </h4><br>  Sur la figure 3, les √©tapes de la saga sont d√©sign√©es comme T1 ... T4, actions compensatoires: C1 ... C4. <br>  Les sagas soutiennent l'idempotence des √©tapes (une action dont la r√©p√©tition r√©p√©t√©e √©quivaut √† une seule).  L'approche d'affaissement offre la possibilit√© de r√©p√©ter n'importe quelle √©tape (par exemple, si vous n'avez pas re√ßu de r√©ponse √† la r√©ussite).  Idempotency vous permet √©galement de restaurer l'√©tat lorsque des donn√©es sont perdues sur n'importe quel n≈ìud (√©chec et r√©cup√©ration).  Lors de l'ex√©cution d'une √©tape, chaque service doit d√©terminer (par la cl√© idempotency) s'il a d√©j√† effectu√© cette √©tape ou non (sinon, ex√©cuter, sinon ignorer).  Pour les actions de compensation, il est √©galement possible d'ajouter des cl√©s d'idempotence et des r√©p√©titions d'op√©rations (assurant la persistance / stabilit√©). <br><br><h2>  R√©sum√© </h2><br>  Des quatre conditions requises pour le syst√®me de transaction ACID (atomicit√©, coh√©rence, isolation, stabilit√©), le m√©canisme d'affaissement permet d'en impl√©menter trois - toutes sauf l'isolement.  Le manque d'isolement peut entra√Æner des anomalies (¬´lectures sales¬ª, ¬´lectures non r√©p√©tables¬ª, r√©√©criture des changements entre les diff√©rentes transactions commerciales, etc.).  Pour surmonter de telles situations, il est n√©cessaire d'utiliser des m√©canismes suppl√©mentaires, par exemple, la version des objets mutables. <br><br>  Les sagas vous permettent de r√©soudre les t√¢ches suivantes: <br><br><ul><li>  Fournir des modifications de donn√©es d√©pendantes pour les donn√©es critiques de l'entreprise; </li><li>  √ätre capable de d√©finir un ordre d'√©tapes strict; </li><li>  Respecter 100% de coh√©rence (coordonner les donn√©es m√™me en cas d'accident); </li><li>  Fournir des contr√¥les de performance √† tous les niveaux. </li></ul><br><h2>  Champ d'application et exemples d'application </h2><br>  Les sagas sont souvent utilis√©es sur des syst√®mes avec un grand nombre de demandes.  Par exemple, les services de messagerie populaires, les r√©seaux sociaux.  Cependant, l'approche peut trouver une application dans des projets de moindre envergure. <br><br>  Notre entreprise poss√®de une exp√©rience dans le d√©veloppement d'un syst√®me comptable pour une grande entreprise qui a √©t√© con√ßu pour plusieurs dizaines d'utilisateurs et toutes les donn√©es ont √©t√© stock√©es dans un SGBD relationnel.  Le probl√®me s'est pos√© lors de la mise en ≈ìuvre du calcul automatique des travaux planifi√©s: dans certains cas, les calculs √©taient tr√®s importants et n√©cessitaient l'insertion de millions d'enregistrements dans les tables SGBD, ce qui a consid√©rablement charg√© le SGBD et ralenti le fonctionnement de l'ensemble du syst√®me. <br><br>  Une solution a √©t√© trouv√©e - pour mettre la logique de calcul du travail dans un service s√©par√© avec son propre SGBD pour stocker le travail lui-m√™me et les objets associ√©s.  La coh√©rence des donn√©es a √©t√© assur√©e par la saga.  Si le calcul a √©chou√©, le module principal de l'application a re√ßu une commande pour annuler l'op√©ration de calcul logique. <br><br><h2>  Biblioth√®ques compatibles Saga </h2><br>  L'application a √©t√© d√©velopp√©e sur .Net, et pour cette technologie, plusieurs biblioth√®ques de gestionnaires de services prennent en charge les sagas.  Nous avons examin√© les biblioth√®ques NServiceBus, MassTransit et Rebus.  En cons√©quence, nous nous sommes install√©s sur Rebus - cette biblioth√®que est plus facile √† apprendre, tout en r√©alisant pleinement le principe des sagas et est gratuite.  NServiceBus et MassTransit sont des outils plus sophistiqu√©s avec des tonnes de fonctionnalit√©s suppl√©mentaires.  Ils n'√©taient pas requis dans le cadre de notre t√¢che, mais il peut √™tre conseill√© de les utiliser dans de futurs projets avec une logique plus complexe. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr431854/">https://habr.com/ru/post/fr431854/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr431836/index.html">Le condens√© de mati√®res fra√Æches du monde du front-end de la derni√®re semaine n ¬∞ 341 (26 novembre - 2 d√©cembre 2018)</a></li>
<li><a href="../fr431842/index.html">0xc00007b ou installation de pilotes sous le programme</a></li>
<li><a href="../fr431846/index.html">GeekBrains commence √† pr√©parer des d√©veloppeurs Python √† pile compl√®te</a></li>
<li><a href="../fr431848/index.html">Comme j'ai √©crit le plus gros script pour Altium Designer</a></li>
<li><a href="../fr431850/index.html">Heisenbug 2018 Moscou: diffusion en ligne gratuite, f√™te et bien plus encore</a></li>
<li><a href="../fr431856/index.html">Extension de l'√©diteur Unity avec la fen√™tre de l'√©diteur, l'objet scriptable et l'√©diteur personnalis√©</a></li>
<li><a href="../fr431858/index.html">Mitap Sbertekh √† Rostov-sur-le-Don</a></li>
<li><a href="../fr431860/index.html">Sur les options du pilote Linux ou comment j'ai pass√© le week-end</a></li>
<li><a href="../fr431862/index.html">Mitap Sbertekh √† Iekaterinbourg</a></li>
<li><a href="../fr431864/index.html">PVS-Studio ROI: comment ne pas perdre des millions (version provisoire de l'article)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>