<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ôÇÔ∏è üïµüèΩ üåâ Hydroponik auf einer Fensterbank oder C ++ 11 in AVR-Mikrocontrollern üòø üë®üèæ‚ÄçüöÄ üÜí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Das Projekt enth√§lt kein Arduino
 
 
 Dieses Projekt musste urspr√ºnglich anders aussehen - eine monumentale Struktur bestehend aus einem Sockel mit Do...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Hydroponik auf einer Fensterbank oder C ++ 11 in AVR-Mikrocontrollern</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/385135/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Projekt enth√§lt kein Arduino</font></font></i><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/911/af2/659/911af265948b47c6933b93c9ff846e34.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieses Projekt musste urspr√ºnglich anders aussehen - eine monumentale Struktur bestehend aus einem Sockel mit Dosen und Pumpen, einem darauf montierten Aquarium und einer Tomatenoase dar√ºber. Im Paradies einer Tomatenoase war ein Wasserfall geplant, und im Aquarium bildeten sich Lebensformen der Fische. Die Hauptvoraussetzung daf√ºr war die F√§higkeit, die ungeplanten Bewohner des Aquariums zu essen und das Glas sauber zu halten. Die Hauptkandidaten sind Somiki und Gourami. Wie Sie vielleicht erraten haben, lautet mein Motto "Faulheit ist der Motor des Fortschritts" (und was k√∂nnen Sie tun, damit Sie das Aquarium nicht reinigen und die Tomaten nicht gie√üen)?</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Denkmal f√ºr dieses Motto w√§re wahrscheinlich errichtet worden, wenn es nicht bereits bei der Koordinierung der Entwurfsentw√ºrfe mit seiner Frau zusammengebrochen w√§re. Sie war nicht von der Idee inspiriert, diese Bandura zur Hauptdekoration des Wohnzimmers zu machen, und selbst der Wasserfall √ºberzeugte sie nicht davon. Aber die Idee eines autonomen Systems, einer Symbiose aus Biologie und Elektronik, wollte mir nicht aus dem Kopf gehen, und das Projekt wurde auf die Gr√∂√üe eines Blumentopfs verengt - Aquaponik wurde zu Hydrokultur, Fischleben wurden gerettet.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Hauptidee der Hydrokultur ist die Verwendung einer w√§ssrigen N√§hrstoffl√∂sung anstelle des Bodens. Dies erm√∂glicht eine Gr√∂√üenordnung, um das Pflanzenwachstum zu beschleunigen. Man kann die Wurzeln jedoch nicht einfach ins Wasser senken - sie brauchen Sauerstoff, ohne den sie zu sterben beginnen. In dieser Hinsicht gibt es Optionen - st√§ndig Wasser mit einem Kompressor blasen, wie in einem Aquarium, oder die Wurzeln regelm√§√üig mit einer N√§hrl√∂sung √ºberfluten und nach einiger Zeit abtropfen lassen. Die erste Option hat einen Nachteil - das st√§ndige Summen des Kompressors. Die zweite Option hat den Vorteil, dass die meisten Wurzeln in der Luft liegen und aktiv atmen, und der Effekt der Wachstumsbeschleunigung sollte noch gr√∂√üer sein. Dar√ºber hinaus werden sie in ein Substrat aus speziellen por√∂sen Granulaten eingetaucht, die Feuchtigkeit speichern. Die Wahl war offensichtlich, ich nahm die zweite Option als Grundlage.Bei Fischen k√∂nnte sich das System als fast vollst√§ndig geschlossen herausstellen - Fischsekrete werden von speziellen Bakterien in einem Biofilter verarbeitet, das verarbeitete Produkt wird Pflanzen zugef√ºhrt, eine Sandschicht filtert das Wasser, sauberes Wasser wird in das Aquarium zur√ºckgef√ºhrt. Im Idealfall wird das Futter gelegentlich in einen automatischen Futterautomaten gestreut, und Tomaten sammeln sich aus den B√ºschen. Aber es ist nicht zusammengewachsen, vielleicht zum Besseren - wer wei√ü, wie die Bestellung eines Stammes der notwendigen Bakterien per Post enden w√ºrde.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infolgedessen nahm das Ger√§t der Tomatenpflanze Konturen an. </font><font style="vertical-align: inherit;">Zwei Gef√§√üe - das untere mit Wasser, das obere mit einem Substrat und einer Pflanze. </font><font style="vertical-align: inherit;">Zum Fluten verwenden wir eine kleine chinesische Pumpe mit Gleichstrommotor, zur Entw√§sserung einen automatischen Siphon. </font><font style="vertical-align: inherit;">Das Funktionsprinzip des Siphons im Video:</font></font><br>
<iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://www.youtube.com/embed/5wZ9PQepQYI%3Ffeature%3Doembed&amp;usg=ALkJrhiD1wlPdNPAaR7AUIdVWXgiJFnvIw" frameborder="0" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hydroponik mit einem √§hnlichen Siphon:</font></font><br>
<iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://www.youtube.com/embed/ZHaiVhVZ3kM%3Ffeature%3Doembed&amp;usg=ALkJrhjFtkwUcg5lMO5fDymloeq7LP0_IQ" frameborder="0" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Gehirn des Ger√§ts ist der ATMEGA328P-Mikrocontroller (einfach weil der Placer zur Hand war). Zu seinen Aufgaben geh√∂ren das Management der √úberschwemmung und des Abflusses nach einem Zeitplan, die √úberwachung des Wasserstandes im Tank und das Signalisieren seines Mangels, die Steuerung der Beleuchtung der Anlage (wir m√∂chten eine bestimmte Mindestl√§nge des Tageslichts; wenn das nat√ºrliche Licht endet, wird k√ºnstliches Licht allm√§hlich eingeschaltet), eine Benutzeroberfl√§che zum Betrachten den Status, das Management und die Konfiguration dieser gesamten Wirtschaft. Dies erfordert nat√ºrlich eine L√∂sung f√ºr den Wasserstandsensor, Lichtsensoren, eine Echtzeituhr und eine Art Benutzerterminal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bevor Sie die Details beschreiben, eine Liste der Projektressourcen: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hier sehen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sie Fotos des Ergebnisses und des Herstellungsprozesses. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kurzes Video:</font></font><br>
<br>
<iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://www.youtube.com/embed/C_qit2_2rrY%3Ffeature%3Doembed&amp;usg=ALkJrhh-zFMdWlMGPkMsMfijYvHdNHpUsQ" frameborder="0" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Projekt ist auf </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> verf√ºgbar </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Dort wird in den </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Releases eine</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Datei mit dem elektronischen Teileprojekt in KiCAD und den Design-Schnickschnackprojekten in SolidWorks angelegt (STL-Dateien zum Drucken sind beigef√ºgt).</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Merkmale der Firmware-Baugruppe</font></font></b><div class="spoiler_text">      ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>    ¬´ ¬ª.    ,   , ,        USB    AVR (,   ,    ,     ,      ),               .  -    ,     ,    'ADK_ROOT'     ,        'scons'.<br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Schema des elektronischen Teils: </font></font><br>
<br>
<img src="https://habrastorage.org/files/cfc/96b/dad/cfc96bdad51648caa640d661ac6ffc40.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Weitere Details, eine Beschreibung der Fallstricke und ein bisschen Code. </font><font style="vertical-align: inherit;">Beschreibung der Softwareprobleme </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ganz am Ende</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Vielleicht interessiert sich jemand f√ºr ein neues Beispiel f√ºr die Arbeit mit I2C, einen Valcoder, ein RTC-Modul und ein Grafikdisplay. </font><font style="vertical-align: inherit;">Der gesamte Code im Projekt wurde ‚Äûvon Grund auf neu‚Äú geschrieben, ohne L√∂sungen von Drittanbietern zu verwenden (weil ich kann).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wasserstandsensor</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das heikelste Thema wurde zuerst entschieden. Es gab nat√ºrlich eine Variante einer Art Schwimmer, so dass beispielsweise die Schiene, auf die der Gray-Code angewendet wurde, bewegt und die optischen Sensoren gelesen wurden. Aber es sah wirklich unzuverl√§ssig aus. Die Suche bei eBay ergab kein Ergebnis - es gab entweder Schwimmerschalter (die das gew√ºnschte Niveau erreichten oder nicht) oder eingetauchte Elektroden und Messwerte, die auf der Leitf√§higkeit des Mediums basierten. Dies wurde jedoch sofort festgestellt, da sich die Zusammensetzung des Wassers zusammen mit der Leitf√§higkeit der zugesetzten D√ºngemittel und der Aufl√∂sung st√§ndig √§ndern w√ºrde Verunreinigungen vom Substrat. Als Ergebnis kam die Idee, einen Ultraschall-Entfernungsmesser zu verwenden, der normalerweise auf verschiedenen Robotern platziert wird. Der Sensor befindet sich wie geplant im Tankdeckel und das Signal wird direkt von der Wasseroberfl√§che reflektiert. Wurde HC-SR04 gekauft (die Wahl des kleinsten Wertes des Mindestarbeitsabstands - er hat 2cm),und das Konzept wurde an einem Eimer Wasser √ºberpr√ºft. Es stellte sich heraus, dass es f√ºr sich selbst funktionierte (es gab Bef√ºrchtungen, dass es keine normale Reflexion von der Wasseroberfl√§che geben w√ºrde oder dass es nicht gen√ºgend Strahlrichtung geben w√ºrde und es unerw√ºnschte Reflexionen von den Tankw√§nden geben w√ºrde). Der Entfernungsmesser war √ºbrigens auch eine Backup-Option, aber Infrarot. Auf die Wasseroberfl√§che sollte ein Schwimmer mit einem Reflektor geworfen werden. Das einzige Problem ist der Mindestarbeitsabstand von 10 cm (von denen, die ich gefunden habe), was f√ºr die angegebenen Abmessungen bereits ein bisschen viel ist.Auf die Wasseroberfl√§che sollte ein Schwimmer mit einem Reflektor geworfen werden. Das einzige Problem ist der Mindestarbeitsabstand von 10 cm (von denen, die ich gefunden habe), was f√ºr die angegebenen Abmessungen bereits ein bisschen viel ist.Auf die Wasseroberfl√§che sollte ein Schwimmer mit einem Reflektor geworfen werden. Das einzige Problem ist der Mindestarbeitsabstand von 10 cm (von denen, die ich gefunden habe), was f√ºr die angegebenen Abmessungen bereits ein bisschen viel ist.</font></font><br>
<br>
<img src="https://habrastorage.org/files/ee1/7ac/b85/ee17acb8500c4a94b65014c08d3df694.jpg"><br>
<img src="https://habrastorage.org/files/cd2/558/d46/cd2558d46164418f95b883a60c20c213.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach den Ergebnissen des Projekts funktioniert dieser Ansatz und kann in der Praxis angewendet werden, ohne dass Probleme festgestellt wurden. Es lohnt sich, Ma√ünahmen zu ergreifen, um die Platte vor Feuchtigkeit zu sch√ºtzen (Versiegelung im Geh√§use). Das ist nur, dass die Sensoren selbst offen bleiben, vielleicht kommt es noch herum.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Schnittstelle des Sensors ist einfach - ein Impuls wird an den Triggereingang gesendet, der ein Echosignal ausl√∂st. Am Echoausgang wird ein Impuls erzeugt, dessen L√§nge gleich der Zeit vom Beginn der Strahlung bis zur Annahme des reflektierten Echosignals ist. Durch Messen der Pulsl√§nge, Kenntnis der Schallgeschwindigkeit und der Tatsache, dass das Signal zum Objekt und zur√ºck geht, k√∂nnen Sie die Entfernung berechnen. Im Projekt wird dies in der LevelGauge-Klasse implementiert. Zur Messung der Pulsl√§nge wird die Hardwaref√§higkeit von MK AVR ‚ÄûInput Capture‚Äú verwendet. In diesem Fall wird der Hardware-Timer bei der ansteigenden Flanke des Impulses zur√ºckgesetzt, und beim Abw√§rtswert des Timers wird die Hardware im Register ICR1 gespeichert und ein Interrupt erzeugt. Somit ist es m√∂glich, die Impulsdauer mit ausreichender Genauigkeit und minimalem Prozessorverbrauch zu messen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selbst bei diesem Modell des Sensors wurde ein Fehler festgestellt - beim Anlegen der Stromversorgung blieb die Echolinie konstant aktiv. </font><font style="vertical-align: inherit;">Er umging, indem er einen Impuls an den Ausl√∂ser legte und wartete, bis der erste Echoortungszyklus vergangen war.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hintergrundbeleuchtung</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Hintergrundbeleuchtung besteht aus drei Grip-LEDs. </font><font style="vertical-align: inherit;">Ich bog den dreieckigen Rahmen aus dem Aluminiumprofil und klebte die LEDs mit Epoxidharz darauf. </font><font style="vertical-align: inherit;">Ich habe einen chinesischen Stromstabilisator mit 700 mA f√ºr die Stromversorgung bestellt. </font><font style="vertical-align: inherit;">Ungef√§hr drei Volt fallen an jeder Diode ab, der Stabilisator ben√∂tigt eine Differenz zwischen der Eingangs- und Ausgangsspannung von mindestens zwei Volt, und ich wollte den gesamten Wunderwafer √ºber eine 12-Volt-Stromversorgung mit Strom versorgen. </font><font style="vertical-align: inherit;">Von hier aus l√§sst sich leicht berechnen, warum genau drei LEDs.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dioden sind warmwei√ü. Es schien mir nat√ºrlich, das Sonnenspektrum und all das. Aber wie ich sp√§ter herausfand, verwenden Pflanzen nach meiner Bestellung normalerweise eine Kombination aus Rot und Blau. Soweit ich wei√ü, geht es nur um Effizienz. Wenn Sie einen gro√üen Bauernhof mit Beleuchtung rund um die Uhr haben, interessiert Sie, dass die gesamte aufgewendete Energie f√ºr immer ausgegeben wird. Bei wei√üer Beleuchtung reflektieren die gr√ºnen Bl√§tter die gr√ºne Komponente, ein erheblicher Teil der f√ºr die Beleuchtung aufgewendeten Energie wird verschwendet.</font></font><br>
<br>
<img src="https://habrastorage.org/files/b75/39b/561/b7539b5610cf43039f95a393567ce5ce.jpg"><br>
<img src="https://habrastorage.org/files/6e3/a21/084/6e3a2108427a44518658b276d5affe3c.JPG"><br>
<img src="https://habrastorage.org/files/1af/253/8d1/1af2538d188c4dfe962d915a09bb2fba.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein wichtiges Merkmal des Stabilisators ist das Vorhandensein eines Eingangs f√ºr die PWM-Regelung, mit dem ich die Helligkeit anpasse. Hier ist ein weiterer chinesischer Rechen. Erstens stellte sich heraus, dass es sich nur um eine Strom-Ein / Aus-Funktion handelt. Das hei√üt, ich habe erwartet, dass der Ausgangsstrom nicht moduliert wird und sein Wert vom Tastverh√§ltnis des PWM-Signals abh√§ngt, aber der Strom wiederholt einfach die Impulse am Steuereingang. Aber das ist nicht so schlimm, ein weiterer Hinterhalt war, dass der Regler mit einer ziemlich hohen Frequenz unzureichend auf PWM reagiert. Ich musste es auf 300 Hz senken, bei denen es mehr oder weniger normal funktionierte. Das PWM-Signal wird vom Mikrocontroller in Hardware unter Verwendung eines der Timer erzeugt.</font></font><br>
<br>
<img src="https://habrastorage.org/files/fde/4a1/3d6/fde4a13d69f04e909fe2fafbcb526ed4.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein weiterer wichtiger Teil der Hintergrundbeleuchtung sind die Lichtsensoren. In dieser Rolle wurden Fototransistoren ausgew√§hlt. Und ja, es gibt zwei davon - eine √ºber den LEDs zur Messung des nat√ºrlichen Lichts, die zweite unter den LEDs zur R√ºckmeldung. Die automatische Tageslichtverl√§ngerungsfunktion wurde zwar noch nicht wie im Sommer implementiert und war auch nicht erforderlich (und Motivation ist eine ernste Angelegenheit). Es wurde angenommen, dass sobald der erste Sensor eine Abnahme des Beleuchtungsniveaus feststellt (und die f√ºr Tageslichtstunden vorgesehene Zeit noch nicht abgelaufen ist), das Licht so geregelt wird, dass der zweite Sensor einen dem gew√ºnschten Beleuchtungsniveau entsprechenden Wert erzeugt. Dazu m√ºssen Sie einen einfachen PID-Regler im Code implementieren. In der Benutzeroberfl√§che k√∂nnen Sie jedoch nur die aktuellen Sensorwerte anzeigen und die gew√ºnschte Helligkeit der Hintergrundbeleuchtung manuell aufwickeln.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Achten Sie auf den Anschluss der Sensoren. </font><font style="vertical-align: inherit;">Jeder von ihnen hat zwei feste Bereiche, die durch Anschlie√üen des entsprechenden Widerstands an Null ausgew√§hlt werden. </font><font style="vertical-align: inherit;">Der Fu√ü des Mikrocontrollers, der mit dem zweiten Widerstand verbunden ist, wird zu diesem Zeitpunkt in einen Zustand mit hohem Widerstand versetzt. </font><font style="vertical-align: inherit;">Sie k√∂nnen beide Widerst√§nde gleichzeitig einschalten, dann gibt es drei feste Messbereiche. </font><font style="vertical-align: inherit;">Das Signal von den Emitterwiderst√§nden wird durch eine RC-Schaltung geleitet, um die Modulationsimpulse zu filtern - das Licht von den LEDs pulsiert zusammen mit dem PWM-Signal am Stromregler.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pumpe</font></font></h4><br>
<img src="https://habrastorage.org/files/a13/933/895/a13933895d9f4546a4ab7e54e87c056b.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das billigste chinesische Getriebe mit Gleichstrommotor. </font><font style="vertical-align: inherit;">Hinterhalte sind nat√ºrlich verf√ºgbar. </font><font style="vertical-align: inherit;">Trotz der Tatsache, dass 12 V angezeigt werden, funktioniert es bei dieser Spannung nicht lange. </font><font style="vertical-align: inherit;">Einer brannte vor dem Zusammenbau der Struktur aus. </font><font style="vertical-align: inherit;">Das Schema sieht PWM daf√ºr vor, die maximale Leistung ist in der Schnittstelle konfiguriert, in der Praxis wurde sie nicht √ºber 70% eingestellt. </font><font style="vertical-align: inherit;">Bereits auf diesem Niveau heult er wild bei der Arbeit, aber die meiste Zeit arbeitet er mit einer viel geringeren Leistung - etwa 30% und rumpelt ziemlich leise. </font><font style="vertical-align: inherit;">√úber seine Betriebsarten weiter unten in der Beschreibung der Logik der √úberschwemmung. </font><font style="vertical-align: inherit;">Der gr√∂√üere Kondensator (C8 im Diagramm) muss n√§her am Pumpenstromkreis positioniert werden, da sonst der gesamte Stromkreis stark gest√∂rt wird (in der Praxis stellte sich heraus, dass der Stromregler f√ºr LEDs am empfindlichsten f√ºr sie ist, es beginnt leichte Musik).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Echtzeituhr</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es war eine verr√ºckte Idee, die Ressourcen des Mikrocontrollers f√ºr diese Zwecke zu nutzen. Quarzuhrgenerator hat eine ziemlich gute Genauigkeit, in einem anderen Projekt hat dieser Ansatz gut funktioniert. Das Problem ist jedoch, dass absolut alle Hardware-Timer bereits f√ºr andere Zwecke verwendet wurden. Es blieb keine andere Wahl, als das externe RTC-Modul zu finden. Loben Sie die Chinesen, sie sind da und sie sind billig. </font></font><br>
<br>
<img src="https://habrastorage.org/files/16f/8e2/404/16f8e24047b9445f969a1d1e9333b4bc.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das auf dem DS3231 basierende Modul verf√ºgt √ºber eine I2C-Schnittstelle und eine eigene redundante Stromversorgung - bei einem Stromausfall wird keine Zeit schief gehen. Es gibt einen M√§anderausgang bei mehreren festen Frequenzen - 1 kHz, 4 kHz und 8 kHz. Dies war sehr n√ºtzlich f√ºr Audiosignale - auch hier m√ºssen Sie die MCU nicht laden, und es gab keine freien Timer daf√ºr. Das 32-Kbit-EEPROM ist ein Bonus, wird jedoch in diesem Projekt nicht verwendet.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√úberraschenderweise ist es sehr genau - in wenigen Monaten verlor die Zeit f√ºr einige Sekunden ihre Kraft. </font><font style="vertical-align: inherit;">Er gab an, dass er den Einfluss der Temperatur auf die Frequenz des Generators ber√ºcksichtigt, und anscheinend funktioniert dies. </font><font style="vertical-align: inherit;">Wenn dennoch die Zeit vergeht, besteht die M√∂glichkeit einer Software-Frequenzkorrektur. </font><font style="vertical-align: inherit;">Die Messwerte des Temperatursensors sind verf√ºgbar und werden in diesem Projekt in der Benutzeroberfl√§che angezeigt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Rtc-Klasse ist f√ºr die Arbeit mit diesem Modul im Code verantwortlich.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anzeige</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich wollte schon lange etwas mit einem Grafikdisplay machen. </font><font style="vertical-align: inherit;">Die Suche nach dem g√ºnstigsten mit I2C-Schnittstelle gab diese Option.</font></font><br>
<br>
<img src="https://habrastorage.org/files/629/1fb/ecc/6291fbeccac04dfe854f3a3e45b2a2a3.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Monochromes OLED-Display 128x64 Pixel basierend auf dem recht beliebten Controller SSD1306. Bei der Auswahl m√ºssen Sie die Beschreibung sorgf√§ltig pr√ºfen - derselbe Chip unterst√ºtzt andere Schnittstellen au√üer I2C, und es gibt Optionen ohne I2C. Oder sie schreiben, dass es universell ist, es unterst√ºtzt auch I2C, aber in Wirklichkeit wird es notwendig sein, das Board leicht zu modifizieren, indem die Nullen auf andere Sites umgestellt werden. Wenn Sie I2C verwenden m√∂chten, ist es daher besser, eine zu w√§hlen, bei der nur I2C auf der Karte angezeigt wird. Bei einer Karte, die fast keine Dokumentation enth√§lt (weniger Dokumentation nur f√ºr den Chip), ist der Aufwand geringer. Diese Version arbeitet mit 5 V, die Karte verf√ºgt √ºber einen 3,3 V-Regler, der f√ºr die Steuerung erforderlich ist. Ich habe Bewertungen getroffen, die in einigen Versionen m√∂glicherweise nicht vorhanden sind.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Anzeige ist in der Regel zufrieden. Mir ist nur ein unangenehmes Merkmal aufgefallen: Die Helligkeit einer Pixelzeile h√§ngt davon ab, wie viele Pixel darin beleuchtet sind. Je mehr Licht vorhanden ist, desto geringer ist die Helligkeit. Der Kontrast zwischen den Linien kann auff√§llig sein, wenn sich vollst√§ndig ausgef√ºllte Bereiche mit einigen schmalen Elementen auf dem Bildschirm abwechseln. In der Praxis ist dies jedoch in meinen Bildern nicht sichtbar und f√§llt nicht auf. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Steuerung kann so konfiguriert werden, dass sie in verschiedenen Modi zum Anzeigen des Inhalts des Bildschirmspeichers auf einer Pixelmatrix arbeitet. F√ºr mich war es bequemer, wenn jedes Byte auf eine vertikale Pixel mit einer H√∂he von acht Pixeln abgebildet wird und die Spalten horizontal von links nach rechts verlaufen und den Bildschirm mit Zeilen f√ºllen, die acht Pixel hoch sind. In diesem Modus ist es bequemer, Text zu zeichnen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oft wird ein Ansatz praktiziert, bei dem der Anzeigespeicher in der RAM-MCU dupliziert wird - zuerst werden alle Aktionen mit dem Bild im RAM ausgef√ºhrt, und dann werden alle ge√§nderten Pixel in den Anzeigespeicher kopiert. In diesem Projekt wird dieser Ansatz nicht zum Einsparen von Ressourcen verwendet. Alle ge√§nderten Stellen werden sofort im Anzeigespeicher neu gezeichnet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie in den Kommentaren vorgeschlagen, verblassen OLED-Anzeigen mit der Zeit. Ich vermutete dies auch (erinnerte mich daran, was Bildschirmschoner ist) und sorgte daf√ºr, dass sich die Anzeige nach einigen Minuten nach der letzten Aktivit√§t auf den Steuerelementen ausschaltete. Sie wird beim Drehen oder Dr√ºcken des Encoders eingeschaltet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Code ist die Arbeit mit der Anzeige in der Anzeigeklasse implementiert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Valkoder:</font></font><br>
<br>
<img src="https://habrastorage.org/files/ee6/a1e/6b5/ee6a1e6b5921493bb395675e2805f2c6.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Meiner Meinung nach ist der Valcoder die beste Steuerungsoption f√ºr solche Ger√§te, die mindestens eine Benutzeroberfl√§che haben. Es ist kompakt und sehr komfortabel. Es ist bequem f√ºr sie, durch Men√ºelemente zu bl√§ttern und diese auszuw√§hlen, die Werte von Parametern zu √§ndern, Modi zu wechseln usw. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zum Anschlie√üen sind drei Eingangszweige des Mikrocontrollers erforderlich. Eine f√ºr den Knopf (Sie k√∂nnen den Griff dr√ºcken), zwei f√ºr den Valcoder selbst. Es gibt ein </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gray-Code-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Signal vom Encoder </font><font style="vertical-align: inherit;">. Bei jedem Umdrehungsschritt √§ndert sich ein Bit auf zwei Zeilen. Die Reihenfolge bestimmt die Drehrichtung.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alles scheint einfach zu sein, aber anscheinend sind Entwickler nicht immer in der Lage, qualitativ hochwertige Unterst√ºtzung f√ºr ein solches Ger√§t zu leisten. Auf meinem 3D-Drucker befinden sich beispielsweise eine RAMPS-Karte und eine Karte mit einem Display, und genau derselbe Encoder ist angeschlossen. Die Marlin-Firmware funktioniert damit, aber die Erfahrung mit der Verwendung ist sehr schlecht - es gibt kein Gef√ºhl der Zuverl√§ssigkeit - wenn Sie beim Drehen des Knopfes auf den Knopf klicken, stoppt die Benutzeroberfl√§che h√§ufig bei dem falschen Men√ºpunkt oder Parameterwert, f√ºr den sie erwartet wurde. Bei schneller Rotation f√ºhlt es sich an, als w√ºrden Klicks √ºberspringen. Irgendwann beginnt das Umschalten nicht mehr w√§hrend eines Klicks, aber irgendwo dazwischen ist es sehr unangenehm. Ja, was ist Marlin, ich habe manchmal das gleiche Gef√ºhl beim eingebauten Multimedia-System im Auto. In diesem Zusammenhang einige Tipps (und nat√ºrlich den Code in der N√§he der RotEnc-Klasse).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erstens, ein ziemlich offensichtlicher Punkt f√ºr jeden, der irgendwelche Tasten mit dem Mikrocontroller verbindet - Sie m√ºssen sich mit Bounce befassen. Dieser mechanische Encoder und seine Signalleitungen sind in der Tat die gleichen Tasten, und sie haben auch ein Rattern. Zuerst filtern wir das Rattern, dann verarbeiten wir die Folge von Zust√§nden der Signalleitungen. Es kann Valcoder mit optischen Sensoren geben, dies h√§ngt bereits von den Signalverarbeitungsschemata ab. Wenn die Beine eines Fototransistors direkt herausgebracht werden, kann es dort mit langsamer Rotation klappern, aber wenn es ein Verarbeitungsschema gibt, das eine Hysterese einf√ºhrt, ist keine Softwareunterdr√ºckung erforderlich. Aber solche Ger√§te sind teurer und werden selten in Amateurger√§ten verwendet, die h√§ufigsten sind mechanische, ein paar Dollar pro Haufen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zweitens ein etwas weniger offensichtlicher Punkt, wahrscheinlich einer, an dem Marlin verbrannt wurde - der Griff hat w√§hrend der Drehung stabile Positionen - Klicks (Klicks). Dieses Modell besteht aus vier Schritten einer Codesequenz f√ºr jeden Klick. Sie m√ºssen also auf Klicks reagieren und nicht auf die Schritte der Sequenz. Und das Wichtigste ist, mit stabilen Positionen zu synchronisieren. Viele geben einfach die Konstante STEPS_PER_CLICK ein und reagieren beispielsweise auf jeden vierten Schritt. Das Problem ist jedoch, dass das Signal nicht perfekt ist und die Sequenzen m√∂glicherweise nicht ganz korrekt sind. Mit einer bestimmten Schreibweise kann der Code in die Irre gehen. Infolgedessen wird jeder vierte Schritt irgendwo in der Mitte des Klicks ausgef√ºhrt, was f√ºr den Benutzer unangenehm ist. Gleichzeitig entspricht die feste Position des Griffs f√ºr ein bestimmtes Modell einem festen Codewert.es muss daran befestigt sein.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Drittens wiederum ein ziemlich offensichtlicher Punkt f√ºr mehr oder weniger erfahrene Entwickler von Mikrocontrollersystemen: Verwenden Sie Hardware-Interrupts, um den Status der Eingangsleitungen zu √§ndern. </font><font style="vertical-align: inherit;">Zumindest besteht ein geringeres Risiko, dass die Schritte der Sequenz "verloren" gehen. </font><font style="vertical-align: inherit;">Aber im Allgemeinen sind, wie Sie wissen, Unterbrechungen unser Alles. </font><font style="vertical-align: inherit;">Die MCU sollte nach M√∂glichkeit schlafen und nur bei Unterbrechungen aufwachen - entweder von der Au√üenperipherie oder von einem Timer, um eine verz√∂gerte Aufgabe auszuf√ºhren. </font><font style="vertical-align: inherit;">Dies sind die Prinzipien eines guten Entwurfs der Systemarchitektur.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Design als Ganzes</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es besteht aus improvisierten Materialien und verschiedenen Teilen, die auf einem 3D-Drucker aus ABS gedruckt wurden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Funktionsprinzip des Siphons ist im obigen Video dargestellt. F√ºr mich ist es ein externes PVC-Rohr und ein internes Rohr mit einem Trichter am Ende. F√ºr den klassischen Siphon ist ein weiteres Knie erforderlich, aber es war schon schwierig, es konstruktiv f√ºr mich zu machen. Wenn Probleme mit dem Abfluss festgestellt wurden, klebte ein kleines Bad an der Wand des unteren Tanks, in das das Ende des Innenrohrs eingetaucht war, und erzeugte Widerstand gegen den Abfluss, so dass der Siphon arbeiten konnte.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es stellte sich heraus, dass ABS ein sehr hydrophobes Material ist. Wasser l√§uft buchst√§blich nicht durch, ich musste sogar den Siphontrichter erneuern. Es lohnt sich, diese Eigenschaft in Betracht zu ziehen. Es ist unm√∂glich, einige Miniaturhydrauliksysteme zu erstellen (zum Beispiel wollte ich F√ºhrungsfl√§chen am Siphontrichter herstellen, um das Wasser zu verdrehen und die Siphonreaktion zu verbessern. Bei solchen Abmessungen und der Hydrophobizit√§t von ABS ist dies jedoch nicht sinnvoll.) . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe auch zuerst versucht, alles mit einer Hei√üklebepistole zusammenzukleben. Es funktioniert nicht - zuerst schien alles festzuhalten, aber nach ein paar Tagen fiel es von selbst ab. Die beste Option ist Zentralasien. Details, auch unter Wasser, halten fest.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die gr√∂√üte Fehleinsch√§tzung im Design sind transparente Beh√§lter. Ich habe v√∂llig vergessen, dass Wasser im Licht bl√ºht. Ich musste es mit undurchsichtigem Material umwickeln. Nun, Sie k√∂nnen regelm√§√üig Kaliumpermanganat zur Desinfektion hinzuf√ºgen, dies scheint die Pflanzen nicht zu sch√§digen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Flutungsalgorithmus lautet wie folgt: Zuerst wird die Pumpe bei geringer Leistung eingeschaltet und f√ºllt leise den gesamten oberen Tank. Der Prozess wird von einem F√ºllstandsensor √ºberwacht. Wenn Wasser durch den Siphontrichter zu flie√üen beginnt, stoppt der F√ºllstandabfall im unteren Tank, der vom Sensor erfasst wird. Ein kleiner Durchfluss bei geringer Leistung reicht nicht aus, um einen Siphon auszul√∂sen. Die Pumpe stoppt, das in den oberen Tank gepumpte Volumen wird gespeichert. Die Wurzeln bleiben einige Minuten in der L√∂sung, danach schaltet sich die Pumpe wieder ein. Erstens schaltet die Pumpe bei geringer Leistung, bis das Wasser den Trichter wieder erreicht (w√§hrend der Ausfallzeit f√§llt es aufgrund der Wirkung des Siphons ab), und wenn der F√ºllstand des Trichters erreicht ist, auf erh√∂hte Leistung ein, wodurch ein ausreichender Durchfluss f√ºr den Siphon bereitgestellt wird. Der Durchfluss durch den Siphon ist garantiert h√∂her als der Pumpenfluss.Infolgedessen beginnt der F√ºllstand im unteren Tank anzusteigen, dies wird vom Sensor erfasst und die Pumpe stoppt.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Hochwasserzyklen beginnen regelm√§√üig in festgelegten, konfigurierbaren Zeitintervallen von morgens bis abends. </font><font style="vertical-align: inherit;">Nach dem Plan sollte die Morgend√§mmerung durch den Lichtsensor festgelegt und die L√§nge des Tageslichts, falls erforderlich, auf den eingestellten Wert verl√§ngert werden, aber bis dahin hatten die H√§nde ihn nicht erreicht. </font><font style="vertical-align: inherit;">Die D√§mmerungszeit wird einfach in den Einstellungen eingestellt.</font></font><br>
<br>
<a name="cpp11"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Und wo ist C ++ 11?</font></font></h4><br>
<a name="cpp11"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vielleicht wird jemand bezweifeln, dass C ++ 11 beim Programmieren von Mikrocontrollern n√ºtzlich sein kann (unter denen, die allgemein wissen, dass Mikrocontroller in C ++ programmiert werden k√∂nnen). </font><font style="vertical-align: inherit;">Ich werde versuchen, konkrete Beispiele f√ºr die Vorteile von C ++ 11 in diesem Bereich zu nennen (zus√§tzlich zu offensichtlichen angenehmen kleinen Dingen wie constexpr, override, default usw.).</font></font><br>
<br>
<h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Platzierung von String-Ressourcen</font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Viele Menschen wissen, dass RAM in Mikrocontrollern eine sehr begrenzte Ressource ist. Dies kann ein Problem sein, wenn Ihre Anwendung beispielsweise √ºber eine Benutzeroberfl√§che verf√ºgt und Ihr Programm eine relativ gro√üe Anzahl von Zeilen verwendet. Wenn im Code so etwas zu schreiben ist</font></font><br>
<pre><code class="cpp hljs">PromptUser(<span class="hljs-string">"Are you sure you want to format SD-card?"</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dann wird die in den Argumenten √ºbergebene Zeile in den initialisierten Datenabschnitt (im Folgenden das Verhalten des GCC-Compilers f√ºr die AVR-Plattform) gestellt, dh in den RAM-Bereich, der beim Start (bevor die Hauptfunktion aufgerufen wird) aus dem Programm-Flash-Speicher initialisiert wird. Der Funktion PromptUser () wird ein Zeiger auf die gew√ºnschte Stelle im RAM √ºbergeben. Wenn Sie im gesamten Programm einen √§hnlichen Ansatz verwenden, endet der RAM recht schnell (in dem in diesem Projekt verwendeten ATMEGA328P sind es nur 2 Kilobyte, und dies gilt auch f√ºr BSS, Heap und Stack). Um diese Einschr√§nkung zu umgehen, lernen Funktionen wie PromptUser (), nicht mit Zeigern auf RAM, sondern mit Zeigern auf einen Bereich im Programm-Flash-Speicher zu arbeiten. Sie k√∂nnen von dort nur mit Hilfe spezieller Anweisungen lesen, die beispielsweise in avr-libc in Funktionen der Familie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eeprom_read_ [byte | word | dword | ...] eingeschlossen sind.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Fall muss die Zeichenfolge zuerst in eine Variable eingef√ºgt werden, die mit dem PROGMEM-Attribut ausgestattet ist, das dem Compiler mitteilt, dass sie im </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programmspeicher abgelegt werden soll</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">char</span> prompt[] PROGMEM = <span class="hljs-string">"Are you sure you want to format SD-card?"</span>;<font></font>
PromptUser(prompt);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies ist unpraktisch, wenn Sie alle Zeilen zentral deklarieren m√∂chten. </font><font style="vertical-align: inherit;">Dann m√ºssen Sie zuerst ihre Deklaration in der Header-Datei deklarieren:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">char</span> prompt[] PROGMEM;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Definieren Sie in einer separaten CPP-Datei Folgendes:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">char</span> prompt[] PROGMEM = <span class="hljs-string">"Are you sure you want to format SD-card?"</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vervielf√§ltigung von Code, was nicht gut und sehr unpraktisch ist, wenn es viele solcher Zeilen gibt. </font><font style="vertical-align: inherit;">Ja, dies kann umgangen werden, indem ein kniffliges Makro erstellt und die Header-Datei in eine separate CPP-Datei aufgenommen wird, in der das Makro in die Definition erweitert wird, w√§hrend es in anderen Kontexten in die Deklaration erweitert wird. </font><font style="vertical-align: inherit;">In C ++ 11 gibt es jedoch eine sauberere Option, wenn Sie beim Deklarieren die Initialisierung von Klassenmitgliedern verwenden. </font><font style="vertical-align: inherit;">Deklarieren Sie in der Header-Datei die Klasse mit den Zeilen:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DEF_STR(__name, __text) \
    const char __name[sizeof(__text)] = __text;</span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Strings</span> {</span>
<span class="hljs-keyword">public</span>:<font></font>
    DEF_STR(Prompt, <span class="hljs-string">"Are you sure you want to format SD-card?"</span>)<font></font>
    DEF_STR(OtherString, <span class="hljs-string">"..."</span>)<font></font>
    ‚Ä¶<font></font>
} __attribute__((packed));<font></font>
<font></font>
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">const</span> Strings strings PROGMEM;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der CPP-Datei:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> Strings strings PROGMEM;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt werden alle Zeilen an einer Stelle deklariert, im Programmspeicher abgelegt, und Sie k√∂nnen wie folgt darauf zugreifen:</font></font><br>
<pre><code class="cpp hljs">PromptUser(strings.prompt);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Projekt wird ein Ansatz verwendet, der auf demselben Prinzip basiert, um Bitmaps zu bestimmen - verschiedene Bilder, die auf einer grafischen Anzeige angezeigt werden.</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-comment">/** Bitmap descriptor. */</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Bitmap</span> {</span>
    <span class="hljs-comment">/** Pointer to data array if in data memory. Offset of data array relatively
     * to Bitmaps class instance start address if in program memory.
     */</span>
    <span class="hljs-keyword">const</span> u8 *data;
    <span class="hljs-comment">/** Number of pages in the bitmap. */</span><font></font>
    u8 numPages,<font></font>
    <span class="hljs-comment">/** Number of columns in the bitmap. */</span><font></font>
       numColumns;<font></font>
} __PACKED;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">template</span>&lt;u8... data&gt;
<span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">static</span> u8
<span class="hljs-title">Bitmap_NumDataBytes</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">sizeof</span>...(data);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/** Define bitmap.
 * @param __name Name for accessing.
 * @param __numPages Number of pages in the bitmap. Number of columns defined as
 *      total number of data bytes divided by number of pages.
 * @param __VA_ARGS__ Data bytes.
 */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DEF_BITMAP(__name, __numPages, ...) \
    const u8 __CONCAT(__name, __data__) \
        [Bitmap_NumDataBytes<span class="hljs-meta-string">&lt;__VA_ARGS__&gt;()] = { __VA_ARGS__ }; \</span></span>
    <span class="hljs-keyword">const</span> Bitmap __name { \
        <span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">const</span> u8 *&gt;(OFFSETOF(Bitmaps, __CONCAT(__name, __data__))), \<font></font>
        __numPages, \<font></font>
        <span class="hljs-keyword">sizeof</span>(__CONCAT(__name, __data__)) / __numPages};<font></font>
<font></font>
<span class="hljs-comment">/** Global bitmaps repository. Stored in program memory. */</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Bitmaps</span> {</span>
<span class="hljs-keyword">public</span>:<font></font>
<font></font>
    <span class="hljs-comment">/** Thermometer icon. */</span>
    DEF_BITMAP(Thermometer, <span class="hljs-number">1</span>,
        <span class="hljs-number">0b01101010</span>,
        <span class="hljs-number">0b10011110</span>,
        <span class="hljs-number">0b10000001</span>,
        <span class="hljs-number">0b10011110</span>,
        <span class="hljs-number">0b01101010</span><font></font>
    )<font></font>
<font></font>
    <span class="hljs-comment">/** Sun icon. */</span>
    DEF_BITMAP(Sun, <span class="hljs-number">1</span>,
        <span class="hljs-number">0b00100100</span>,
        <span class="hljs-number">0b00011000</span>,
        <span class="hljs-number">0b10100101</span>,
        <span class="hljs-number">0b01000010</span>,
        <span class="hljs-number">0b01000010</span>,
        <span class="hljs-number">0b10100101</span>,
        <span class="hljs-number">0b00011000</span>,
        <span class="hljs-number">0b00100100</span><font></font>
    )<font></font>
    ...<font></font>
};<font></font>
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">const</span> Bitmaps bitmaps PROGMEM;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Unterschied besteht darin, dass zus√§tzlich zu den Bilddaten selbst auch Attribute (Bildgr√∂√üen) platziert werden m√ºssen. </font><font style="vertical-align: inherit;">Jedes Byte definiert eine Spalte mit acht Pixeln. </font><font style="vertical-align: inherit;">Spalten k√∂nnen eine oder mehrere Zeilen f√ºllen, ihre Nummer wird durch den zweiten Parameter nach dem Namen angegeben. </font><font style="vertical-align: inherit;">Es stellt sich heraus, dass die H√∂he der Bitmaps f√ºr eine beliebige Breite ein Vielfaches von acht sein sollte, was f√ºr dieses Projekt durchaus akzeptabel ist.</font></font><br>
<br>
<h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bin√§re Literale</font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
M√∂glicherweise haben Sie bereits bemerkt, dass die Bitmaps im vorherigen Beispiel Bin√§rliterale zur Bestimmung verwenden. </font><font style="vertical-align: inherit;">Dies ist sehr praktisch - Sie k√∂nnen einfache Bitmaps direkt im Code bearbeiten, insbesondere wenn der Editor das Hervorheben von Bitmaps zul√§sst. </font><font style="vertical-align: inherit;">Beispiel: Definitionen von Schriftzeichen in der Datei font.h:</font></font><br>
<br>
<img src="https://habrastorage.org/files/8f4/a54/0c9/8f4a540c9a8a42ff9315c8d4cd307d93.png"><br>
<br>
<h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Variadische Vorlagen</font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wo dann ohne sie dann. </font><font style="vertical-align: inherit;">Nun, zum Beispiel k√∂nnen Befehle f√ºr den Display-Controller eine L√§nge von einem bis mehreren Bytes haben. </font><font style="vertical-align: inherit;">Wird mit folgendem Code gesendet:</font></font><br>
<br>
<pre><code class="cpp hljs">SendCommand(Command::DISPLAY_ON);<font></font>
SendCommand(Command::SET_COM_PINS, COM_PINS | COM_PINS_ALTERNATIVE);<font></font>
SendCommand(Command::SET_COLUMN_ADDRESS, curVp.minCol, curVp.maxCol);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Praktisch, nicht wahr?</font></font><br>
<pre><code class="cpp hljs">    <span class="hljs-comment">/** Queue command sending.
     * @param bytes Up to MAX_CMD_SIZE bytes of command data.
     */</span>
    <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span>... TByte&gt;
    <span class="hljs-function"><span class="hljs-keyword">void</span>
    <span class="hljs-title">SendCommand</span><span class="hljs-params">(TByte... bytes)</span>
    </span>{<font></font>
        cmdSize = <span class="hljs-keyword">sizeof</span>...(bytes);<font></font>
        controlSent = <span class="hljs-literal">false</span>;<font></font>
        cmdInProgress = <span class="hljs-literal">true</span>;<font></font>
        SetCmdByte(<span class="hljs-keyword">sizeof</span>...(bytes) - <span class="hljs-number">1</span>, bytes...);<font></font>
        i2cBus.RequestTransfer(DISPLAY_ADDRESS, <span class="hljs-literal">true</span>,<font></font>
                               CommandTransferHandler);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span>... TByte&gt;
    <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title">SetCmdByte</span><span class="hljs-params">(<span class="hljs-keyword">int</span> idx, u8 byte, TByte... bytes)</span>
    </span>{<font></font>
        cmdBuf[idx] = byte;<font></font>
        SetCmdByte(idx - <span class="hljs-number">1</span>, bytes...);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title">SetCmdByte</span><span class="hljs-params">(<span class="hljs-keyword">int</span>, u8 byte)</span>
    </span>{<font></font>
        cmdBuf[<span class="hljs-number">0</span>] = byte;<font></font>
    }<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Datei variante.h beschreibt eine Klasse, die boost :: variante mit variablen Vorlagen vage √§hnelt. Es wird zum Organisieren von Benutzeroberfl√§chenseiten verwendet. Der Punkt ist wieder das Speichern von Speicher - wo dynamische Speicherverwaltung ein unzul√§ssiger Luxus ist, m√ºssen Sie ausweichen (obwohl 2K immer noch viel ist, konnten Sie nicht ausweichen, aber in derselben ATMEGA-Zeile erreicht seine Gr√∂√üe 512 Bytes und jedes Byte pro Konto). In meiner Benutzeroberfl√§che wird jeweils eine Seite auf dem Bildschirm angezeigt. Dementsprechend k√∂nnen Sie f√ºr alle Seiten dasselbe Speicherelement verwenden, was in C als Vereinigung bezeichnet wird. F√ºr Klassen in C ++ wird dies normalerweise als Variante bezeichnet. Im Gegensatz zu union m√ºssen wir daran denken, den Destruktor des vorherigen Inhalts aufzurufen, bevor wir den Konstruktor des neuen aufrufen.</font></font><br>
<br>
<pre><code class="cpp hljs">    Variant&lt;MainPage,<font></font>
            Menu,<font></font>
            LinearValueSelector,<font></font>
            TimeSelector&gt; curPage;<font></font>
    ...<font></font>
    <span class="hljs-comment">/** Get type code for the specified page class. */</span>
    <span class="hljs-keyword">template</span> &lt;<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TPage</span>&gt;
    <span class="hljs-title">static</span> <span class="hljs-title">constexpr</span> <span class="hljs-title">u8</span>
    <span class="hljs-title">GetPageTypeCode</span>()
    {</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">decltype</span>(curPage)::GetTypeCode&lt;TPage&gt;();<font></font>
    }<font></font>
...<font></font>
curPage.Engage(nextPageTypeCode, page);<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
F√ºr die Kompilierung werden GCC- und GNU-Binutils f√ºr die AVR-Plattform verwendet (in Ubuntu gibt es ein fertiges Paket gcc-avr). </font><font style="vertical-align: inherit;">Die Details des Montageprozesses wurden oben angegeben. </font><font style="vertical-align: inherit;">Die Parameter f√ºr den Compiler sehen ungef√§hr so ‚Äã‚Äãaus (projektspezifische Defunds und Einschl√ºsse werden weggelassen): </font><font style="vertical-align: inherit;">
Link: </font><font style="vertical-align: inherit;">
Konvertieren Sie den Codeabschnitt in das Hex-Format: </font><font style="vertical-align: inherit;">
Erstellen Sie ein EEPROM-Image: </font><font style="vertical-align: inherit;">
Firmware f√ºr den Mikrocontroller: </font><font style="vertical-align: inherit;">
PS Die ersten Tomaten waren bereits reif und schmeckten nicht sehr gut. </font><font style="vertical-align: inherit;">Anscheinend mochten sie etwas in der Di√§t nicht. </font><font style="vertical-align: inherit;">M√ºssen wahrscheinlich die Kultur √§ndern.</font></font><br>
<code>avr-g++ -o build/native-debug/src/firmware/cpu/lighting.cpp.o -c -fno-exceptions -fno-rtti -std=c++1y -Wall -Werror -Wextra -ggdb3 -Os -mcall-prologues -mmcu=atmega328p -fshort-wchar -fshort-enums src/firmware/cpu/lighting.cpp<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<code>avr-g++ -o build/native-debug/src/firmware/cpu/cpu -mmcu=atmega328p build/native-debug/src/firmware/cpu/adc.cpp.o build/native-debug/src/firmware/cpu/application.cpp.o ‚Ä¶<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<code>avr-objcopy -j .text -j .data -O ihex build/native-debug/src/firmware/cpu/cpu build/native-debug/src/firmware/cpu/cpu_rom.hex<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<code>avr-objcopy -j .eeprom --change-section-lma .eeprom=0 -O ihex build/native-debug/src/firmware/cpu/cpu build/native-debug/src/firmware/cpu/cpu_eeprom.hex<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<code>avrdude -p atmega328p -c avrisp2 -P /dev/avrisp -U flash:w:build/native-debug/src/firmware/cpu/cpu_rom.hex:i<br>
</code><br>
<br><font style="vertical-align: inherit;"></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de385135/">https://habr.com/ru/post/de385135/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de385121/index.html">Algorithmischer Surrealismus: Ein Leitfaden f√ºr den Hochfrequenzhandel f√ºr 900 Millionen Mikrosekunden. Teil 1</a></li>
<li><a href="../de385123/index.html">Station New Horizons schickte ein Bild eines kleinen Satelliten von Pluto Styx</a></li>
<li><a href="../de385125/index.html">Reddit hat ausgew√§hlt, welches Bild 2017 zum Mond geht</a></li>
<li><a href="../de385129/index.html">Drahtloser Beleuchtungssensor CR2450</a></li>
<li><a href="../de385131/index.html">Nachts ruhig, nur nicht schlafen PC: lautlos gehen</a></li>
<li><a href="../de385137/index.html">Global Urban Billboard Demontagebewegung</a></li>
<li><a href="../de385139/index.html">Tesla Motors Roboter</a></li>
<li><a href="../de385141/index.html">Cannybots: Roboter, die Kindern das Programmieren beibringen</a></li>
<li><a href="../de385143/index.html">Pulver f√ºr das Gehirn oder wie man Pulver f√ºr die Sp√ºlmaschine 9,7-mal billiger macht</a></li>
<li><a href="../de385145/index.html">Eine Auswahl von Trackern, mit denen Sie die Gurte wechseln k√∂nnen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>