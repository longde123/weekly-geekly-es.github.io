<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñêüèº üêã ü§∏üèæ √âcrire votre couche r√©seau dans Swift: approche orient√©e protocole ‚òëÔ∏è üï¢ üê∂</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="D√©sormais, pr√®s de 100% des applications utilisent la mise en r√©seau, tout le monde est donc confront√© √† l'organisation et √† l'utilisation de la couch...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>√âcrire votre couche r√©seau dans Swift: approche orient√©e protocole</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/443514/"><img src="https://habrastorage.org/webt/gg/rb/pk/ggrbpkas55pf0eigg33hin46i0g.png"><br><br>  D√©sormais, pr√®s de 100% des applications utilisent la mise en r√©seau, tout le monde est donc confront√© √† l'organisation et √† l'utilisation de la couche r√©seau.  Il existe deux approches principales pour r√©soudre ce probl√®me, soit en utilisant des biblioth√®ques tierces, soit votre propre impl√©mentation de la couche r√©seau.  Dans cet article, nous consid√©rerons la deuxi√®me option et essayerons d'impl√©menter une couche r√©seau en utilisant toutes les derni√®res fonctionnalit√©s du langage, en utilisant des protocoles et des √©num√©rations.  Cela sauvera le projet des d√©pendances inutiles sous la forme de biblioth√®ques suppl√©mentaires.  Ceux qui ont d√©j√† vu Moya reconna√Ætront imm√©diatement beaucoup de d√©tails similaires dans la mise en ≈ìuvre et l'utilisation, tels qu'ils sont, mais cette fois-ci, nous le ferons nous-m√™mes sans toucher Moya et Alamofire. <br><a name="habracut"></a><br><br>  Dans ce guide, nous verrons comment impl√©menter une couche r√©seau sur Swift pur, sans utiliser de biblioth√®ques tierces.  Une fois que vous aurez lu cet article, votre code deviendra <br><br><ul><li>  orient√© protocole </li><li>  facile √† utiliser </li><li>  facile √† utiliser </li><li>  type s√ªr </li><li>  pour les points d'extr√©mit√©, les √©num√©rations seront utilis√©es </li></ul><br><br>  Voici un exemple de la fa√ßon dont l'utilisation de notre couche r√©seau se chargera de sa mise en ≈ìuvre: <br><br><img src="https://habrastorage.org/webt/zg/f5/jy/zgf5jybl_jika5ljlt-h3pcdg1e.png"><br><br>  En √©crivant simplement <i><b>router.request (.</b></i> Et en utilisant toute la puissance des √©num√©rations, nous verrons toutes les options de requ√™te possibles et leurs param√®tres. <br><br>  <b>Tout d'abord, un peu sur la structure du projet</b> <br><br>  Chaque fois que vous cr√©ez quelque chose de nouveau et afin de pouvoir tout comprendre facilement √† l'avenir, il est tr√®s important de tout organiser et structurer correctement.  Je pense qu'une structure de dossiers correctement organis√©e est un d√©tail important lors de la construction de l'architecture de l'application.  Pour que tout soit correctement organis√© dans des dossiers, cr√©ons-les √† l'avance.  Cela ressemblera √† la structure g√©n√©rale des dossiers dans le projet: <br><br><img src="https://habrastorage.org/webt/vw/fz/y0/vwfzy0nlpqmg6mccy85s2q6iqrg.png"><br><br>  <b>Protocole Endpointtype</b> <br><br>  Tout d'abord, nous devons d√©finir notre protocole <i><b>EndPointType</b></i> .  Ce protocole contiendra toutes les informations n√©cessaires pour configurer la demande.  Qu'est-ce qu'une demande (endpoint)?  En substance, il s'agit d'une URLRequest avec tous les composants associ√©s, tels que les en-t√™tes, les param√®tres de demande et le corps de la demande.  Le protocole <i><b>EndPointType</b></i> est la partie la plus importante de notre impl√©mentation de la couche r√©seau.  Cr√©ons un fichier et nommez-le <i><b>EndPointType</b></i> .  Mettez ce fichier dans le dossier Service (pas dans le dossier EndPoint, pourquoi - il sera clair un peu plus tard) <br><br><img src="https://habrastorage.org/webt/-9/j0/ul/-9j0ulvgk-w_hftxxyqwolmbujy.png"><br><br>  <b>Protocoles HTTP</b> <br><br>  Notre <i><b>EndPointType</b></i> contient plusieurs protocoles dont nous avons besoin pour cr√©er une demande.  Voyons quels sont ces protocoles. <br><br>  <b>HTTPMethod</b> <br><br>  Cr√©ez un fichier, nommez-le <i><b>HTTPMethod</b></i> et placez-le dans le dossier Service.  Cette liste sera utilis√©e pour d√©finir la m√©thode HTTP de notre demande. <br><br><img src="https://habrastorage.org/webt/j2/3x/nr/j23xnrcovqknw9dzxhf-xva898q.png"><br><br>  <b>HTTPTask</b> <br>  Cr√©ez un fichier, nommez-le <i><b>HTTPTask</b></i> et placez-le dans le dossier Service.  HTTPTask est responsable de la configuration des param√®tres d'une demande sp√©cifique.  Vous pouvez y ajouter autant d'options de requ√™te que vous le souhaitez, mais je vais √† mon tour effectuer des requ√™tes r√©guli√®res, des requ√™tes avec des param√®tres, des requ√™tes avec des param√®tres et des en-t√™tes, donc je ne ferai que ces trois types de requ√™tes. <br><br><img src="https://habrastorage.org/webt/v5/4m/j6/v54mj6yxsvdwuiossyq3em2biia.png"><br><br>  Dans la section suivante, nous discuterons des <i><b>param√®tres</b></i> et de la fa√ßon dont nous travaillerons avec eux <br><br>  <b>HTTPHeaders</b> <br><br>  <i><b>Les HTTPHeaders ne</b></i> sont que des typealias pour un dictionnaire.  Vous pouvez le cr√©er en haut de votre fichier <i><b>HTTPTask</b></i> . <br><br><pre><code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">HTTPHeaders</span></span> = [<span class="hljs-type"><span class="hljs-type">String</span></span>:<span class="hljs-type"><span class="hljs-type">String</span></span>]</code> </pre> <br><br>  <b>Param√®tres et encodage</b> <br><br>  Cr√©ez un fichier, nommez-le <i><b>ParameterEncoding</b></i> et placez-le dans le dossier Encoding.  Cr√©ez des typealias pour les <i><b>param√®tres</b></i> , ce sera √† nouveau un dictionnaire normal.  Nous faisons cela pour rendre le code plus compr√©hensible et lisible. <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Parameters</span></span> = [<span class="hljs-type"><span class="hljs-type">String</span></span>:<span class="hljs-type"><span class="hljs-type">Any</span></span>]</code> </pre> <br><br>  Ensuite, d√©finissez un protocole <i><b>ParameterEncoder</b></i> avec une seule fonction de codage.  La m√©thode d'encodage a deux param√®tres: <i><b>inout URLRequest</b></i> et <i><b>Parameters</b></i> .  <b>INOUT</b> est un mot cl√© Swift qui d√©finit un param√®tre de fonction comme r√©f√©rence.  En r√®gle g√©n√©rale, les param√®tres sont transmis √† la fonction sous forme de valeurs.  Lorsque vous √©crivez <i><b>inout</b></i> avant un param√®tre de fonction dans un appel, vous d√©finissez ce param√®tre comme type de r√©f√©rence.  Pour en savoir plus sur les arguments inout, vous pouvez suivre ce lien.  En bref, <i><b>inout</b></i> vous permet de modifier la valeur de la variable elle-m√™me, qui a √©t√© transmise √† la fonction, et pas seulement d'obtenir sa valeur dans le param√®tre et de travailler avec elle √† l'int√©rieur de la fonction.  Le protocole <i><b>ParameterEncoder</b></i> sera impl√©ment√© dans <i><b>JSONParameterEncoder</b></i> et dans <i><b>URLPameterEncoder</b></i> . <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ParameterEncoder</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">encode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(urlRequest: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">inout</span></span></span></span><span class="hljs-function"><span class="hljs-params"> URLRequest, with parameters: Parameters)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> }</code> </pre> <br><br>  <i><b>ParameterEncoder</b></i> contient une seule fonction dont la t√¢che est de coder les param√®tres.  Cette m√©thode peut renvoyer une erreur qui doit √™tre g√©r√©e, nous utilisons donc throw. <br><br>  Il peut √©galement √™tre utile de produire non pas des erreurs standard, mais des erreurs personnalis√©es.  Il est toujours assez difficile de d√©crypter ce que Xcode vous donne.  Lorsque vous avez personnalis√© et d√©crit toutes les erreurs, vous savez toujours exactement ce qui s'est pass√©.  Pour ce faire, d√©finissons une √©num√©ration qui h√©rite de <i><b>Error</b></i> . <br><br><img src="https://habrastorage.org/webt/tl/bj/dd/tlbjddm7l48ho1alexej8rrj15q.png"><br><br>  Cr√©ez un fichier, nommez-le <i><b>URLParameterEncoder</b></i> et placez-le dans le dossier <i><b>Encoding</b></i> . <br><br><img src="https://habrastorage.org/webt/s-/eh/tg/s-ehtgdznm1pcdjyrhn3r4fibjs.png"><br><br>  Ce code prend une liste de param√®tres, les convertit et les met en forme pour les utiliser comme param√®tres d'URL.  Comme vous le savez, certains caract√®res ne sont pas autoris√©s dans l'URL.  Les param√®tres sont √©galement s√©par√©s par le symbole "&amp;", nous devons donc prendre soin de cela.  Nous devons √©galement d√©finir la valeur par d√©faut pour les en-t√™tes s'ils ne sont pas d√©finis dans la demande. <br><br>  C'est la partie du code qui est cens√©e √™tre couverte par les tests unitaires.  La construction d'une demande d'URL est la cl√©, sinon nous pouvons provoquer de nombreuses erreurs inutiles.  Si vous utilisez l'API ouverte, vous ne voudrez √©videmment pas utiliser tout le volume possible de demandes d'√©checs de tests.  Si vous voulez en savoir plus sur les tests unitaires, vous pouvez commencer par cet article. <br><br>  <b>JSONParameterEncoder</b> <br><br>  Cr√©ez un fichier, nommez-le <i><b>JSONParameterEncoder</b></i> et placez-le dans le dossier Encoding. <br><br><img src="https://habrastorage.org/webt/qf/nc/gp/qfncgpv0juhwx6xnvn4llxqv0eu.png"><br><br>  Tout est le m√™me que dans le cas de <i><b>URLParameter</b></i> , juste ici nous allons convertir les param√®tres pour JSON et ajouter √† nouveau les param√®tres d√©finissant le codage "application / json" √† l'en-t√™te. <br><br>  <b>Routeur r√©seau</b> <br><br>  Cr√©ez un fichier, nommez-le <i><b>NetworkRouter</b></i> et placez-le dans le dossier Service.  Commen√ßons par d√©finir les typealias pour la fermeture. <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">NetworkRouterCompletion</span></span> = (<span class="hljs-number"><span class="hljs-number">_</span></span> data: <span class="hljs-type"><span class="hljs-type">Data?</span></span>,<span class="hljs-number"><span class="hljs-number">_</span></span> response: <span class="hljs-type"><span class="hljs-type">URLResponse?</span></span>,<span class="hljs-number"><span class="hljs-number">_</span></span> error: <span class="hljs-type"><span class="hljs-type">Error?</span></span>)-&gt;()</code> </pre><br><br>  Ensuite, nous d√©finissons le protocole <i><b>NetworkRouter</b></i> . <br><br><img src="https://habrastorage.org/webt/uf/zd/s0/ufzds0f3ci0fvx9mr0hingvxjtc.png"><br><br>  <i><b>NetworkRouter</b></i> a un <i><b>EndPoint</b></i> qu'il utilise pour les demandes et d√®s que la demande est termin√©e, le r√©sultat de cette demande est transmis √† la fermeture de <i><b>NetworkRouterCompletion</b></i> .  Le protocole a √©galement une fonction d' <i><b>annulation</b></i> , qui peut √™tre utilis√©e pour interrompre les demandes de chargement et de d√©chargement √† long terme.  Nous avons √©galement utilis√© le type <i><b>associ√©</b></i> ici parce que nous voulons que notre <i><b>routeur</b></i> <i><b>prenne</b></i> <i><b>en</b></i> charge tout type de <i><b>EndPointType</b></i> .  Sans utiliser le type associ√©, le routeur devrait avoir un type sp√©cifique qui impl√©mente <i><b>EndPointType</b></i> .  Si vous souhaitez en savoir plus sur le type associ√©, vous pouvez lire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cet article</a> . <br><br>  <b>Routeur</b> <br><br>  Cr√©ez un fichier, nommez-le <i><b>Routeur</b></i> et placez-le dans le dossier Service.  Nous d√©clarons une variable priv√©e de type <i><b>URLSessionTask</b></i> .  Tout le travail y sera.  Nous le rendons priv√© parce que nous ne voulons pas que quelqu'un √† l'ext√©rieur puisse le changer. <br><br><img src="https://habrastorage.org/webt/gb/wk/cx/gbwkcxouam1y86i-sruvzyhub_c.png"><br><br>  <b>Demande</b> <br><br>  Ici, nous cr√©ons <i><b>URLSession en</b></i> utilisant <i><b>URLSession.shared</b></i> , c'est la fa√ßon la plus simple de cr√©er.  Mais rappelez-vous que cette m√©thode n'est pas la seule.  Vous pouvez utiliser des configurations <i><b>URLSession</b></i> plus complexes qui peuvent modifier son comportement.  Plus d'informations √† ce sujet dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cet article</a> . <br><br>  La demande est cr√©√©e en appelant la fonction <i>buildRequest.</i> L'appel de fonction est encapsul√© dans do-try-catch, car les fonctions de codage √† l'int√©rieur de <i>buildRequest</i> peuvent <i>lever des</i> exceptions.  <i>La r√©ponse</i> , les <i>donn√©es</i> et l' <i>erreur</i> sont transmises √† la fin. <br><br><img src="https://habrastorage.org/webt/oi/3c/jl/oi3cjllxhvs7n_m39kmy9r7q29k.png"><br><br>  <b>Demande de build</b> <br><br>  Nous cr√©ons notre requ√™te en utilisant la fonction <i>buildRequest</i> .  Cette fonction est responsable de tout le travail essentiel dans notre couche r√©seau.  Convertit essentiellement <i><b>EndPointType</b></i> en <i><b>URLRequest</b></i> .  Et d√®s que <i><b>EndPoint se</b></i> transforme en demande, nous pouvons la transmettre √† la <i><b>session</b></i> .  Beaucoup de choses se passent ici, alors regardons les m√©thodes.  Examinons d' <i>abord la</i> m√©thode <i>buildRequest</i> : <br><br>  1. Nous initialisons la variable de demande <i><b>URLRequest</b></i> .  Nous y d√©finissons notre URL de base et y ajoutons le chemin de la requ√™te sp√©cifique qui sera utilis√©e. <br><br>  2. Attribuez √† <i>request.httpMethod la</i> m√©thode http de notre <i><b>EndPoint</b></i> . <br><br>  3. Nous cr√©ons un bloc do-try-catch, car nos encodeurs peuvent g√©n√©rer une erreur.  En cr√©ant un grand bloc do-try-catch, nous √©liminons la n√©cessit√© de cr√©er un bloc distinct pour chaque essai. <br><br>  4. Dans switch, v√©rifiez <i><b>route.task</b></i> . <br><br>  5. Selon le type de t√¢che, nous appelons l'encodeur correspondant. <br><br><img src="https://habrastorage.org/webt/pt/ij/58/ptij58jibcjvvawtyb44axo5mq4.png"><br><br>  <b>Configurer les param√®tres</b> <br><br>  Cr√©ez la fonction <i><b>configureParameters</b></i> dans le routeur. <br><br><img src="https://habrastorage.org/webt/fb/gf/fy/fbgffycewgssxqrnxglvsvftl0w.png"><br><br>  Cette fonction est responsable de la conversion de nos param√®tres de requ√™te.  √âtant donn√© que notre API suppose l'utilisation de <i><b>bodyParameters</b></i> sous la forme de JSON et d' <i><b>URLParameters</b></i> convertis au format URL, nous passons simplement les param√®tres appropri√©s aux fonctions de conversion correspondantes, que nous avons d√©crites au d√©but de l'article.  Si vous utilisez une API qui inclut diff√©rents types d'encodages, dans ce cas, je recommanderais d'ajouter <i><b>HTTPTask avec</b></i> une √©num√©ration suppl√©mentaire avec le type d'encodage.  Cette liste doit contenir tous les types d'encodages possibles.  Apr√®s cela, dans configureParameters, ajoutez un argument suppl√©mentaire avec cette √©num√©ration.  Selon sa valeur, changez en utilisant switch et faites l'encodage dont vous avez besoin. <br><br>  <b>Ajouter des en-t√™tes suppl√©mentaires</b> <br><br>  Cr√©ez la fonction <i>addAdditionalHeaders</i> dans le routeur. <br><br><img src="https://habrastorage.org/webt/ow/07/8a/ow078aeoow6qlavpxiobwl6nbh0.png"><br><br>  Ajoutez simplement tous les en-t√™tes n√©cessaires √† la demande. <br><br>  <b>Annuler</b> <br><br>  La fonction d' <i>annulation</i> sera assez simple: <br><br><img src="https://habrastorage.org/webt/v4/3t/mm/v43tmm1dlso_cwstw6sy444vyu4.png"><br><br>  <b>Exemple d'utilisation</b> <br><br>  Essayons maintenant d'utiliser notre couche r√©seau sur un exemple r√©el.  Nous nous connecterons √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">TheMovieDB</a> pour recevoir les donn√©es de notre application. <br><br>  <b>MovieEndPoint</b> <br><br>  Cr√©ez un fichier <i><b>MovieEndPoint</b></i> et placez-le dans le dossier EndPoint.  MovieEndPoint est le m√™me que <br>  et TargetType dans Moya.  Ici, nous impl√©mentons notre propre EndPointType √† la place.  Un article d√©crivant comment utiliser Moya pour un exemple similaire peut √™tre trouv√© sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ce lien</a> . <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Foundation enum NetworkEnvironment { case qa case production case staging } public enum MovieApi { case recommended(id:Int) case popular(page:Int) case newMovies(page:Int) case video(id:Int) } extension MovieApi: EndPointType { var environmentBaseURL : String { switch NetworkManager.environment { case .production: return "https:<span class="hljs-comment"><span class="hljs-comment">//api.themoviedb.org/3/movie/" case .qa: return "https://qa.themoviedb.org/3/movie/" case .staging: return "https://staging.themoviedb.org/3/movie/" } } var baseURL: URL { guard let url = URL(string: environmentBaseURL) else { fatalError("baseURL could not be configured.")} return url } var path: String { switch self { case .recommended(let id): return "\(id)/recommendations" case .popular: return "popular" case .newMovies: return "now_playing" case .video(let id): return "\(id)/videos" } } var httpMethod: HTTPMethod { return .get } var task: HTTPTask { switch self { case .newMovies(let page): return .requestParameters(bodyParameters: nil, urlParameters: ["page":page, "api_key":NetworkManager.MovieAPIKey]) default: return .request } } var headers: HTTPHeaders? { return nil } }</span></span></code> </pre><br><br>  <b>Moviemodel</b> <br><br>  Pour analyser le mod√®le de donn√©es <i><b>MovieModel</b></i> et JSON dans le mod√®le, le protocole Decodable est utilis√©.  Placez ce fichier dans le dossier <i><b>Model</b></i> . <br><br>  <i>Remarque</i> : pour une connaissance plus d√©taill√©e des protocoles codables, d√©codables et codables, vous pouvez lire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mon autre article</a> , qui d√©crit en d√©tail toutes les fonctionnalit√©s de leur utilisation. <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Foundation struct MovieApiResponse { let page: Int let numberOfResults: Int let numberOfPages: Int let movies: [Movie] } extension MovieApiResponse: Decodable { private enum MovieApiResponseCodingKeys: String, CodingKey { case page case numberOfResults = "total_results" case numberOfPages = "total_pages" case movies = "results" } init(from decoder: Decoder) throws { let container = try decoder.container(keyedBy: MovieApiResponseCodingKeys.self) page = try container.decode(Int.self, forKey: .page) numberOfResults = try container.decode(Int.self, forKey: .numberOfResults) numberOfPages = try container.decode(Int.self, forKey: .numberOfPages) movies = try container.decode([Movie].self, forKey: .movies) } } struct Movie { let id: Int let posterPath: String let backdrop: String let title: String let releaseDate: String let rating: Double let overview: String } extension Movie: Decodable { enum MovieCodingKeys: String, CodingKey { case id case posterPath = "poster_path" case backdrop = "backdrop_path" case title case releaseDate = "release_date" case rating = "vote_average" case overview } init(from decoder: Decoder) throws { let movieContainer = try decoder.container(keyedBy: MovieCodingKeys.self) id = try movieContainer.decode(Int.self, forKey: .id) posterPath = try movieContainer.decode(String.self, forKey: .posterPath) backdrop = try movieContainer.decode(String.self, forKey: .backdrop) title = try movieContainer.decode(String.self, forKey: .title) releaseDate = try movieContainer.decode(String.self, forKey: .releaseDate) rating = try movieContainer.decode(Double.self, forKey: .rating) overview = try movieContainer.decode(String.self, forKey: .overview) } }</code> </pre><br><br>  <b>Networkmanager</b> <br><br>  Cr√©ez un fichier <i><b>NetworkManager</b></i> dans le dossier Manager.  Pour le moment, NetworkManager ne contient que deux propri√©t√©s statiques: une cl√© API et une √©num√©ration qui d√©crit le type de serveur auquel se connecter.  <i><b>NetworkManager</b></i> contient √©galement un <i><b>routeur</b></i> de type <i><b>MovieApi</b></i> . <br><br><img src="https://habrastorage.org/webt/yj/it/-b/yjit-b1afnahwsvjkkjnaezgpdu.png"><br><br>  <b>R√©ponse du r√©seau</b> <br><br>  Cr√©ez l'√©num√©ration <i><b>NetworkResponse</b></i> dans NetworkManager. <br><br><img src="https://habrastorage.org/webt/vv/fv/7s/vvfv7sl-q-dmnz289jdcntmhs0k.png"><br><br>  Nous utilisons cette √©num√©ration lors du traitement des r√©ponses aux demandes et nous afficherons le message correspondant. <br><br>  <b>R√©sultat</b> <br><br>  Cr√©ez une √©num√©ration de <i><b>r√©sultats</b></i> dans NetworkManager. <br><br><img src="https://habrastorage.org/webt/en/oj/ad/enojad3e4jxk2jgkntgblqftivu.png"><br><br>  Nous utilisons <i><b>Result</b></i> pour d√©terminer si la demande a r√©ussi ou non.  Sinon, nous retournerons un message d'erreur avec la raison. <br><br>  <b>Traitement des r√©ponses aux demandes</b> <br><br>  Cr√©ez la fonction <i><b>handleNetworkResponse</b></i> .  Cette fonction prend un argument, tel qu'une <i><b>r√©ponse HTTP,</b></i> et renvoie un r√©sultat. <br><br><img src="https://habrastorage.org/webt/wt/uv/5f/wtuv5f7cptiudu69o8mn16psbsy.png"><br><br>  Dans cette fonction, en fonction du statusCode re√ßu de HTTPResponse, nous renvoyons un message d'erreur ou le signe d'une requ√™te r√©ussie.  En r√®gle g√©n√©rale, un code compris entre 200 et 299 signifie succ√®s. <br><br>  <b>Faire une demande de r√©seau</b> <br><br>  Donc, nous avons tout fait pour commencer √† utiliser notre couche r√©seau, essayons de faire une demande. <br><br>  Nous demanderons une liste de nouveaux films.  Cr√©ez une fonction et nommez-la <i><b>getNewMovies</b></i> . <br><br><img src="https://habrastorage.org/webt/ei/yn/fn/eiynfnoketqomcziq5nzv6ulaao.png"><br><br>  Prenons-le √©tape par √©tape: <br><br>  1. Nous d√©finissons la m√©thode <i><b>getNewMovies</b></i> avec deux arguments: le num√©ro de page de pagination et le gestionnaire d'ach√®vement, qui renvoie un tableau facultatif de mod√®les <i><b>Movie</b></i> , ou une erreur facultative. <br><br>  2. Appelez le <i><b>routeur</b></i> .  Nous transmettons le num√©ro de page et l' <i>ach√®vement du</i> processus √† la fermeture. <br><br>  3. <i><b>URLSession</b></i> renvoie une erreur s'il n'y a pas de r√©seau ou s'il n'a pas √©t√© possible de faire une demande pour une raison quelconque.  Veuillez noter qu'il ne s'agit pas d'une erreur d'API, de telles erreurs se produisent sur le client et se produisent g√©n√©ralement en raison de la mauvaise qualit√© de la connexion Internet. <br><br>  4. Nous devons <i><b>convertir</b></i> notre <i><b>r√©ponse</b></i> en <i><b>HTTPURLResponse</b></i> , car nous devons acc√©der √† la propri√©t√© <i>statusCode</i> . <br><br>  5. D√©clarez le <i><b>r√©sultat</b></i> et initialisez-le √† l'aide de la m√©thode <i><b>handleNetworkResponse</b></i> <br><br>  6. <i><b>Le succ√®s</b></i> signifie que la demande a √©t√© accept√©e et nous avons re√ßu la r√©ponse attendue.  Ensuite, nous v√©rifions si les donn√©es sont fournies avec la r√©ponse, et sinon, nous terminons simplement la m√©thode via return. <br><br>  7. Si la r√©ponse est accompagn√©e de donn√©es, il est n√©cessaire d'analyser les donn√©es re√ßues dans le mod√®le.  Apr√®s cela, nous passons le tableau de mod√®les r√©sultant √† son terme. <br><br>  8. En cas d'erreur, transmettez simplement l'erreur √† la <i>fin</i> . <br><br>  Voil√†, c'est ainsi que notre propre couche r√©seau fonctionne sur Swift pur, sans utiliser de d√©pendances sous forme de pods et de biblioth√®ques tiers.  Afin de faire une demande d'api de test pour obtenir une liste de films, cr√©ez un MainViewController avec la propri√©t√© <i><b>NetworkManager</b></i> et appelez la m√©thode <i><b>getNewMovies √†</b></i> travers elle. <br><br><pre> <code class="swift hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainViewController</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIViewController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> networkManager: <span class="hljs-type"><span class="hljs-type">NetworkManager!</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(networkManager: <span class="hljs-type"><span class="hljs-type">NetworkManager</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(nibName: <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, bundle: <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.networkManager = networkManager } <span class="hljs-keyword"><span class="hljs-keyword">required</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>?(coder aDecoder: <span class="hljs-type"><span class="hljs-type">NSCoder</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">fatalError</span></span>(<span class="hljs-string"><span class="hljs-string">"init(coder:) has not been implemented"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">viewDidLoad</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.viewDidLoad() view.backgroundColor = .green networkManager.getNewMovies(page: <span class="hljs-number"><span class="hljs-number">1</span></span>) { movies, error <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> error = error { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(error) } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> movies = movies { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(movies) } } } }</code> </pre> <br><br>  <b>Petit bonus</b> <br><br>  Vous avez eu des situations dans Xcode lorsque vous ne compreniez pas quel type d'espace r√©serv√© est utilis√© dans un endroit particulier?  Par exemple, regardez le code que nous venons d'√©crire pour <i><b>Router</b></i> . <br><br><img src="https://habrastorage.org/webt/sd/cb/ga/sdcbgacxit9y-j4zk8w32slxqm8.png"><br><br>  Nous avons d√©termin√© le <i><b>NetworkRouterCompletion</b></i> nous-m√™mes, mais m√™me dans ce cas, il est facile d'oublier de quel type il s'agit et comment l'utiliser.  Mais notre bien-aim√© Xcode s'est occup√© de tout, et il suffit de double-cliquer sur l'espace r√©serv√© et Xcode remplacera le type souhait√©. <br><br><img src="https://habrastorage.org/webt/la/wo/oj/lawoojq5qsvsdzzvfzarqc-wnsk.png"><br><br>  <b>Conclusion</b> <br><br>  Nous avons maintenant une impl√©mentation d'une couche r√©seau orient√©e protocole, qui est tr√®s facile √† utiliser et qui peut toujours √™tre personnalis√©e selon vos besoins.  Nous avons compris sa fonctionnalit√© et le fonctionnement de tous les m√©canismes. <br><br>  Vous pouvez trouver le code source dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ce r√©f√©rentiel</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr443514/">https://habr.com/ru/post/fr443514/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr443504/index.html">Le World Wide Web a trente ans - que va-t-il lui arriver ensuite?</a></li>
<li><a href="../fr443506/index.html">Analyseur simple pour YouTube dans Google Tables</a></li>
<li><a href="../fr443508/index.html">Jeux de soci√©t√© √©ducatifs pour les programmeurs</a></li>
<li><a href="../fr443510/index.html">Ordinateur portable Compaq Armada 7700 - en tant que d√©veloppement de la gamme Compaq LTE</a></li>
<li><a href="../fr443512/index.html">Hackathon d'analyse de donn√©es √† Nizhny Novgorod</a></li>
<li><a href="../fr443516/index.html">Hacker Geohot a d√©cid√© de lib√©rer les gens de la simulation de l'IA</a></li>
<li><a href="../fr443518/index.html">RBKmoney Payments sous le capot - microservices, protocoles et configuration de la plateforme</a></li>
<li><a href="../fr443520/index.html">Choisir une voiture pour un sp√©cialiste informatique ou des conseils pour des th√©i√®res √† partir d'une th√©i√®re</a></li>
<li><a href="../fr443522/index.html">H√©bergement: options, comparaisons, statistiques utilisateurs</a></li>
<li><a href="../fr443524/index.html">Animations Flash √† faire soi-m√™me dans Unity3D. Premi√®re partie, Lyrique</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>