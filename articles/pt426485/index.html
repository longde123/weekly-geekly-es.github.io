<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üóùÔ∏è üî° üåû Terceiro teste do Qt 5 com o PVS-Studio ‚òéÔ∏è üëãüèæ üë¶üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="De tempos em tempos, nossa equipe verifica novamente os projetos sobre os quais j√° escrevemos artigos. Outro projeto verificado novamente foi o Qt. A ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Terceiro teste do Qt 5 com o PVS-Studio</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/426485/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dd9/87d/907/dd987d90784865f850555bc198a97b81.png" alt="PVS-Studio e Qt"></div><br>  De tempos em tempos, nossa equipe verifica novamente os projetos sobre os quais j√° escrevemos artigos.  Outro projeto verificado novamente foi o Qt.  A √∫ltima vez que testamos com o PVS-Studio em 2014.  Desde 2014, o projeto come√ßou a ser verificado regularmente com a ajuda da Coverity.  Isso √© interessante.  Vamos ver se agora podemos encontrar erros interessantes usando o PVS-Studio. <br><a name="habracut"></a><br><h2>  Qt </h2><br>  Artigos anteriores: <br><br><ul><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Como reduzir a probabilidade de erros no est√°gio de escrita do c√≥digo</a> " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">,</a> julho de 2011 </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Qt 5 framework check</a> ", abril de 2014. </li></ul><br>  Desta vez, o <a href="">Qt Base</a> (Core, Gui, Widgets, Rede, ...) e o <a href="">super m√≥dulo Qt5 foram testados</a> .  Sobre o Qt Creator, planejamos escrever um artigo separado posteriormente.  Para verifica√ß√£o, usamos o analisador est√°tico PVS-Studio, cuja vers√£o de teste pode ser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">baixada</a> do site. <br><br>  Na minha opini√£o subjetiva, o c√≥digo Qt se tornou melhor.  Ao longo dos anos desde o √∫ltimo teste, muitos novos diagn√≥sticos apareceram no analisador PVS-Studio.  Apesar disso, durante o estudo de revis√£o dos avisos, n√£o encontrei muitos erros para um projeto desse tamanho.  Repito mais uma vez que esta √© minha impress√£o individual.  N√£o fiz nenhuma pesquisa especial sobre a densidade de erros naquele momento ou agora. <br><br>  Provavelmente, verifica√ß√µes regulares usando o analisador est√°tico do Coverity provavelmente afetaram a qualidade do c√≥digo.  Em 2014, com a ajuda do Coverity, o projeto Qt ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">qt-project</a> ) come√ßou a ser verificado e, em 2016, o Qt Creator ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">qt-creator</a> ).  Minha opini√£o: se voc√™ estiver desenvolvendo um projeto de c√≥digo aberto, o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Coverity Scan</a> pode ser uma boa solu√ß√£o gratuita que melhorar√° significativamente a qualidade e a confiabilidade de seus projetos. <br><br>  No entanto, como o leitor pode adivinhar, se eu n√£o tivesse notado algo interessante no relat√≥rio do PVS-Studio, n√£o haveria artigo :).  E como existe um artigo, isto √©, defeitos.  Vamos olhar para eles.  No total, escrevi 96 erros. <br><br><h2>  Copiar e colar malsucedido </h2><br>  Vamos come√ßar com os cl√°ssicos do g√™nero, quando a causa do erro √© a falta de aten√ß√£o.  Esses erros s√£o subestimados pelos programadores.  Para quem ainda n√£o leu, recomendo que voc√™ analise estes dois artigos: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Efeito da √∫ltima linha</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O mal vive em fun√ß√µes de compara√ß√£o</a> </li></ul><br>  Esses erros s√£o interl√≠ngua.  Por exemplo, o segundo artigo fornece muitos exemplos de erros nas fun√ß√µes de compara√ß√£o escritas em C, C ++ e C #.  Agora, ao implementar o suporte √† linguagem Java no PVS-Studio, encontramos os mesmos padr√µes de erro.  Aqui, por exemplo, est√° um erro que encontramos recentemente na biblioteca do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Hibernate</a> : <br><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> boolean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">equals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object other)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (other instanceof Id) { Id that = (Id) other; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> purchaseSequence.equals(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.purchaseSequence) &amp;&amp; that.purchaseNumber == <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.purchaseNumber; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }</code> </pre> <br>  Se voc√™ observar atentamente, o campo <i>purchaseSequence</i> ser√° comparado a si mesmo.  A op√ß√£o correta: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> that.purchaseSequence.equals(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.purchaseSequence) &amp;&amp; that.purchaseNumber == <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.purchaseNumber;</code> </pre> <br>  Em geral, tudo est√° como sempre, e o analisador PVS-Studio ter√° que "vasculhar os est√°bulos augianos" em projetos Java.  A prop√≥sito, convidamos todos a participar do teste da vers√£o Beta do PVS-Studio for Java, que deve aparecer em um futuro pr√≥ximo.  Para fazer isso, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">escreva-nos</a> (selecione "Quero o analisador para Java"). <br><br>  Agora, de volta aos erros no projeto Qt. <br><br>  <b>Defeito N1</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">windowDpiAwareness</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HWND hwnd)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> QWindowsContext::user32dll.getWindowDpiAwarenessContext &amp;&amp; QWindowsContext::user32dll.getWindowDpiAwarenessContext ? QWindowsContext::user32dll.getAwarenessFromDpiAwarenessContext( QWindowsContext::user32dll.getWindowDpiAwarenessContext(hwnd)) : <span class="hljs-number"><span class="hljs-number">-1</span></span>; }</code> </pre> <br>  PVS-Studio Warning: V501 CWE-571 Existem subexpress√µes id√™nticas 'QWindowsContext :: user32dll.getWindowDpiAwarenessContext' √† esquerda e √† direita do operador '&amp;&amp;'.  qwindowscontext.cpp 150 <br><br>  Nenhuma explica√ß√£o especial al√©m da mensagem do analisador n√£o √© necess√°ria aqui.  Parece-me que a express√£o deveria ter sido assim: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> QWindowsContext::user32dll.getAwarenessFromDpiAwarenessContext &amp;&amp; QWindowsContext::user32dll.getWindowDpiAwarenessContext ? QWindowsContext::user32dll.getAwarenessFromDpiAwarenessContext( QWindowsContext::user32dll.getWindowDpiAwarenessContext(hwnd)) : <span class="hljs-number"><span class="hljs-number">-1</span></span>;</code> </pre> <br>  <b>Defeito N2, N3</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> QReadWriteLockPrivate::release() { Q_ASSERT(!recursive); Q_ASSERT(!waitingReaders &amp;&amp; !waitingReaders &amp;&amp; !readerCount &amp;&amp; !writerCount); freelist-&gt;release(id); }</code> </pre> <br>  PVS-Studio Warning: V501 CWE-571 Existem subexpress√µes id√™nticas √† esquerda e √† direita do operador '&amp;&amp;' :! WaitingReaders &amp;&amp;! WaitingReaders qreadwritelock.cpp 632 <br><br>  O erro est√° dentro da <i>condi√ß√£o da</i> macro <i>Q_ASSERT</i> , portanto, n√£o √© significativo.  Mas ainda assim, isso √© um erro.  A vari√°vel <i>waitingReaders</i> √© verificada duas vezes.  E, aparentemente, eles se esqueceram de verificar alguma outra vari√°vel. <br><br>  Um erro id√™ntico foi encontrado na linha 625 do arquivo qreadwritelock.cpp.  Vida longa Copiar e colar!  :) <br><br>  <b>Defeito N4</b> <br><br><pre> <code class="cpp hljs">QString QGraphicsSceneBspTree::debug(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> index) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node-&gt;type == Node::Horizontal) { tmp += debug(firstChildIndex(index)); tmp += debug(firstChildIndex(index) + <span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { tmp += debug(firstChildIndex(index)); tmp += debug(firstChildIndex(index) + <span class="hljs-number"><span class="hljs-number">1</span></span>); } .... }</code> </pre> <br>  Aviso do PVS-Studio: V523 CWE-691 A instru√ß√£o 'then' √© equivalente √† instru√ß√£o 'else'.  qgraphicsscene_bsp.cpp 179 <br><br>  Provavelmente, o bloco de texto foi copiado, mas eles esqueceram de corrigi-lo. <br><br>  <b>Defeito N5</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> FillRule { OddEvenFill, WindingFill }; QDataStream &amp;<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>&gt;&gt;(QDataStream &amp;s, QPainterPath &amp;p) { .... <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fillRule; s &gt;&gt; fillRule; Q_ASSERT(fillRule == Qt::OddEvenFill || Qt::WindingFill); .... }</code> </pre> <br>  PVS-Studio Warning: V768 CWE-571 A constante de enumera√ß√£o 'WindingFill' √© usada como uma vari√°vel de um tipo booleano.  qpainterpath.cpp 2479 <br><br>  Concordo, este √© um belo erro de grava√ß√£o!  <i>Q_ASSERT</i> n√£o verifica nada, pois a condi√ß√£o √© sempre verdadeira.  A condi√ß√£o √© verdadeira porque a constante nomeada <i>Qt :: WindingFill</i> √© 1. <br><br>  <b>Defeito N6</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> QVariant::canConvert(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> targetTypeId) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentType == QMetaType::SChar || currentType == QMetaType::Char) currentType = QMetaType::UInt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (targetTypeId == QMetaType::SChar || currentType == QMetaType::Char) targetTypeId = QMetaType::UInt; .... }</code> </pre> <br>  Antes de ler o aviso, tente identificar um erro de digita√ß√£o.  Ao adicionar uma imagem, ajudarei voc√™ a n√£o ler a mensagem do analisador imediatamente :). <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/86f/f1d/7c5/86ff1d7c55cdc0fb71cbce45f2f84f05.png" alt="Hora de pensar"></div><br><br>  Aviso do PVS-Studio: V560 CWE-570 Uma parte da express√£o condicional √© sempre falsa: currentType == QMetaType :: Char.  qvariant.cpp 3529 <br><br>  A condi√ß√£o "currentType == QMetaType :: Char" √© verificada no primeiro <i>se</i> .  Se a condi√ß√£o for atendida, a vari√°vel <i>currentType</i> <i>receber√°</i> o valor <i>QMetaType :: UInt</i> .  Portanto, a vari√°vel <i>currentType</i> n√£o pode mais ser igual a <i>QMetaType :: Char</i> .  Portanto, o analisador relata que, no segundo <i>caso, a</i> subexpress√£o "currentType == QMetaType :: Char" √© sempre falsa. <br><br>  De fato, o segundo <i>se</i> deve ser assim: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (targetTypeId == QMetaType::SChar || targetTypeId == QMetaType::Char) targetTypeId = QMetaType::UInt;</code> </pre> <br><br>  <b>Nota de diagn√≥stico do V560</b> <br><br>  O relat√≥rio encontrou muitos avisos do V560.  No entanto, n√£o os observei mais assim que encontrei um caso interessante para o artigo, que foi considerado acima como um defeito N6. <br><br>  A grande maioria das mensagens V560 n√£o pode ser chamada de falsa, mas n√£o h√° uso delas.  Em outras palavras, descrev√™-los em um artigo n√£o √© interessante.  Para deixar claro o que exatamente eu quero dizer, considere um desses casos. <br><br><pre> <code class="cpp hljs">QString QTextHtmlExporter::findUrlForImage(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QTextDocument *doc, ....) { QString url; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!doc) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> url; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (QTextDocument *parent = qobject_cast&lt;QTextDocument *&gt;(doc-&gt;parent())) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> findUrlForImage(parent, cacheKey, isPixmap); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (doc &amp;&amp; doc-&gt;docHandle()) { <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... }</span></span></code> </pre> <br>  Aviso PVS-Stuidio: V560 CWE-571 Uma parte da express√£o condicional √© sempre verdadeira: doc.  qtextdocument.cpp 2992 <br><br>  O analisador est√° absolutamente correto que o ponteiro do <i>documento</i> nem sempre √© <i>nullptr</i> quando √© verificado novamente.  Mas isso n√£o √© um erro, apenas o programador estava seguro.  Voc√™ pode simplificar o c√≥digo escrevendo: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (doc-&gt;docHandle()) {</code> </pre> <br>  <b>Defeito N7</b> <br><br>  E o √∫ltimo caso, que pode ser classificado como erro de digita√ß√£o.  O erro ocorre devido a confus√£o nos nomes das constantes, que diferem apenas no caso da primeira letra. <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QWindowsCursor</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> QPlatformCursor { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> CursorState { CursorShowing, CursorHidden, CursorSuppressed }; .... } QWindowsCursor::CursorState QWindowsCursor::cursorState() { <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> { cursorShowing = <span class="hljs-number"><span class="hljs-number">0x1</span></span>, cursorSuppressed = <span class="hljs-number"><span class="hljs-number">0x2</span></span> }; CURSORINFO cursorInfo; cursorInfo.cbSize = <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(CURSORINFO); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GetCursorInfo(&amp;cursorInfo)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cursorInfo.flags &amp; CursorShowing) .... }</code> </pre> <br>  Aviso do PVS-Studio: V616 CWE-480 A constante nomeada 'CursorShowing' com o valor 0 √© usada na opera√ß√£o bit a bit.  qwindowscursor.cpp 669 <br><br>  Mais detalhadamente, eu j√° analisei esse erro em uma pequena nota separada: " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Mais uma vez, o analisador PVS-Studio mostrou-se mais atento</a> que uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pessoa</a> ". <br><br><h2>  Falhas de seguran√ßa </h2><br>  De fato, todos os erros discutidos neste artigo podem ser chamados de defeitos de seguran√ßa.  Todos eles s√£o classificados de acordo com a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Enumera√ß√£o de fraqueza comum</a> (consulte ID do CWE nas mensagens do analisador).  Se os erros s√£o classificados como CWEs, eles s√£o potencialmente um risco de seguran√ßa.  Isso √© explicado em mais detalhes na p√°gina <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PVS-Studio SAST</a> . <br><br>  No entanto, gostaria de destacar uma s√©rie de erros em um grupo separado.  Vamos dar uma olhada neles. <br><br>  <b>Defeito N8, N9</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> QLocalServerPrivate::addListener() { .... SetSecurityDescriptorOwner(pSD.data(), pTokenUser-&gt;User.Sid, FALSE); SetSecurityDescriptorGroup(pSD.data(), pTokenGroup-&gt;PrimaryGroup, FALSE); .... }</code> </pre> <br>  Avisos do PVS-Studio: <br><br><ul><li>  V530 CWE-252 O valor de retorno da fun√ß√£o 'SetSecurityDescriptorOwner' deve ser utilizado.  qlocalserver_win.cpp 167 </li><li>  V530 CWE-252 O valor de retorno da fun√ß√£o 'SetSecurityDescriptorGroup' deve ser utilizado.  qlocalserver_win.cpp 168 </li></ul><br>  Existem v√°rias fun√ß√µes relacionadas ao controle de acesso.  As fun√ß√µes <i>SetSecurityDescriptorOwner</i> e <i>SetSecurityDescriptorGroup</i> est√£o entre elas. <br><br>  Com essas fun√ß√µes, voc√™ precisa trabalhar com muito cuidado.  Por exemplo, voc√™ deve verificar o status que eles retornam.  O que acontece se a chamada para essas fun√ß√µes falhar?  Adivinhar n√£o √© necess√°rio, √© necess√°rio escrever c√≥digo para lidar com esse caso. <br><br>  N√£o √© necess√°rio tirar proveito da falta de verifica√ß√£o e transformar esses erros em vulnerabilidades.  No entanto, este n√£o √©, em nenhum caso, um local de risco e voc√™ precisa escrever um c√≥digo mais seguro. <br><br>  <b>Defeito N10</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> QLocalServerPrivate::addListener() { .... InitializeAcl(acl, aclSize, ACL_REVISION_DS); .... }</code> </pre> <br>  PVS-Studio Warning: V530 CWE-252 O valor de retorno da fun√ß√£o 'InitializeAcl' deve ser utilizado.  qlocalserver_win.cpp 144 <br><br>  A situa√ß√£o √© semelhante √† discutida acima. <br><br>  <b>Defeito N11, N12</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sha1ProcessChunk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... quint8 chunkBuffer[<span class="hljs-number"><span class="hljs-number">64</span></span>]; .... <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> SHA1_WIPE_VARIABLES .... memset(chunkBuffer, 0, 64); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> }</span></span></code> </pre> <br>  PVS-Studio Warning: V597 CWE-14 O compilador pode excluir a chamada de fun√ß√£o 'memset', usada para liberar o buffer 'chunkBuffer'.  A fun√ß√£o RtlSecureZeroMemory () deve ser usada para apagar os dados particulares.  sha1.cpp 189 <br><br>  O compilador remover√° a chamada de fun√ß√£o <i>memset</i> .  J√° muitas vezes em artigos analisei essa situa√ß√£o.  N√£o tenho vontade de me repetir.  Refiro-me ao artigo " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Limpeza segura de dados particulares</a> ". <br><br>  E outro erro est√° no mesmo arquivo sha1.cpp, na linha 247. <br><br><h2>  Ponteiros nulos </h2><br>  √â hora de falar sobre indicadores.  Houve muitos erros neste t√≥pico. <br><br>  <b>Defeito N13</b> <br><br><pre> <code class="cpp hljs">QByteArray &amp;QByteArray::append(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *str, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> len) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (len &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) len = qstrlen(str); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (str &amp;&amp; len) { .... }</code> </pre> <br>  Aviso do PVS-Studio: V595 CWE-476 O ponteiro 'str' foi utilizado antes de ser verificado no nullptr.  Verifique as linhas: 2118, 2119. qbytearray.cpp 2118 <br><br>  A situa√ß√£o cl√°ssica √© quando um ponteiro √© usado no in√≠cio e depois verificado quanto √† igualdade <i>nullptr</i> .  Esse √© um padr√£o de erro muito comum e o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">vemos</a> regularmente em quase todos os projetos. <br><br>  <b>Defeito N14, N15</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> QMetaObjectPrivate *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">priv</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> uint* data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QMetaObjectPrivate*&gt;(data); } <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> QMetaEnum::isFlag() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> offset = priv(mobj-&gt;d.data)-&gt;revision &gt;= <span class="hljs-number"><span class="hljs-number">8</span></span> ? <span class="hljs-number"><span class="hljs-number">2</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mobj &amp;&amp; mobj-&gt;d.data[handle + offset] &amp; EnumIsFlag; }</code> </pre> <br>  Aviso do PVS-Studio: V595 CWE-476 O ponteiro 'mobj' foi utilizado antes de ser verificado no nullptr.  Verifique as linhas: 2671, 2672. qmetaobject.cpp 2671 <br><br>  Por precau√ß√£o, trago o corpo da fun√ß√£o <i>privada</i> .  Por alguma raz√£o, √†s vezes os leitores come√ßam a apresentar situa√ß√µes nas quais o c√≥digo funcionar√°.  N√£o entendo de onde vem essa desconfian√ßa e o desejo de ver um recurso complicado por engano :).  Por exemplo, algu√©m pode sugerir nos coment√°rios que <i>priv</i> √© uma macro do formul√°rio: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> priv(A) foo(sizeof(A))</span></span></code> </pre> <br>  Ent√£o tudo vai funcionar. <br><br>  Para evitar essas discuss√µes, tento citar fragmentos de c√≥digo onde todas as informa√ß√µes que confirmam a exist√™ncia de um erro s√£o fornecidas. <br><br>  Portanto, o ponteiro <i>modj √©</i> desreferenciado e depois verificado. <br><br>  Mais adiante, aparece o Copy-Paste "poderoso e terr√≠vel".  Por causa do que exatamente o mesmo erro √© detectado na fun√ß√£o <i>isScoped</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> QMetaEnum::isScoped() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> offset = priv(mobj-&gt;d.data)-&gt;revision &gt;= <span class="hljs-number"><span class="hljs-number">8</span></span> ? <span class="hljs-number"><span class="hljs-number">2</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mobj &amp;&amp; mobj-&gt;d.data[handle + offset] &amp; EnumIsScoped; }</code> </pre> <br>  Aviso do PVS-Studio: V595 CWE-476 O ponteiro 'mobj' foi utilizado antes de ser verificado no nullptr.  Verifique as linhas: 2683, 2684. qmetaobject.cpp 2683 <br><br>  <b>Defeito N16-N21</b> <br><br>  Considere outro exemplo e, penso, suficiente. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> QTextCursor::insertFragment(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QTextDocumentFragment &amp;fragment) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!d || !d-&gt;priv || fragment.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; d-&gt;priv-&gt;beginEditBlock(); d-&gt;remove(); fragment.d-&gt;insert(*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); d-&gt;priv-&gt;endEditBlock(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fragment.d &amp;&amp; fragment.d-&gt;doc) d-&gt;priv-&gt;mergeCachedResources(fragment.d-&gt;doc-&gt;docHandle()); }</code> </pre> <br>  Aviso do PVS-Studio: V595 CWE-476 O ponteiro 'fragment.d' foi utilizado antes de ser verificado no nullptr.  Verifique as linhas: 2238, 2241. qtextcursor.cpp 2238 <br><br>  Tudo a mesma coisa.  Preste aten√ß√£o na sequ√™ncia do trabalho com o ponteiro armazenado na vari√°vel <i>fragment.d</i> . <br><br>  Outros erros deste tipo: <br><br><ul><li>  V595 CWE-476 O ponteiro da 'janela' foi utilizado antes de ser verificado no nullptr.  Verifique as linhas: 1846, 1848. qapplication.cpp 1846 </li><li>  V595 CWE-476 O ponteiro da 'janela' foi utilizado antes de ser verificado no nullptr.  Verifique as linhas: 1858, 1860. qapplication.cpp 1858 </li><li>  V595 CWE-476 O ponteiro 'reply' foi utilizado antes de ser verificado no nullptr.  Verifique as linhas: 492, 502. qhttpnetworkconnectionchannel.cpp 492 </li><li>  V595 CWE-476 O ponteiro 'newHandle' foi utilizado antes de ser verificado no nullptr.  Verifique as linhas: 877, 883. qsplitter.cpp 877 </li><li>  V595 CWE-476 O ponteiro 'widget' foi utilizado antes de ser verificado no nullptr.  Verifique as linhas: 2320, 2322. qwindowsvistastyle.cpp 2320 </li><li>  De fato, h√° mais erros.  Eu rapidamente me cansei de aprender os avisos do V595 e, para o artigo, j√° escrevi fragmentos de c√≥digo suficientes. </li></ul><br>  <b>Defeito N22-N33</b> <br><br>  H√° um c√≥digo no qual um ponteiro √© verificado e o <i>novo</i> operador retorna.  Isso √© especialmente engra√ßado, devido ao fato de que existem muitos locais onde o resultado da fun√ß√£o <i>malloc</i> n√£o √© verificado (consulte o grupo de erros a seguir). <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> QTranslatorPrivate::do_load(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString &amp;realname, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString &amp;directory) { .... d-&gt;unmapPointer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[d-&gt;unmapLength]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (d-&gt;unmapPointer) { file.seek(<span class="hljs-number"><span class="hljs-number">0</span></span>); qint64 readResult = file.read(d-&gt;unmapPointer, d-&gt;unmapLength); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (readResult == qint64(unmapLength)) ok = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } .... }</code> </pre> <br>  Aviso do PVS-Studio: V668 CWE-571 N√£o h√° sentido em testar o ponteiro 'd-&gt; unmap Pointer' contra nulo, pois a mem√≥ria foi alocada usando o operador 'new'.  A exce√ß√£o ser√° gerada no caso de erro de aloca√ß√£o de mem√≥ria.  qtranslator.cpp 596 <br><br>  A verifica√ß√£o do ponteiro n√£o faz sentido, porque, no caso de um erro de aloca√ß√£o de mem√≥ria, ser√° <i>lan√ßada</i> uma exce√ß√£o <i>std :: bad_alloc</i> .  Se voc√™ deseja que o <i>novo</i> operador retorne <i>nullptr</i> quando n√£o houver mem√≥ria suficiente, escreva: <br><br><pre> <code class="cpp hljs">d-&gt;unmapPointer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::nothrow) <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[d-&gt;unmapLength];</code> </pre> <br>  O analisador conhece esse uso do <i>novo</i> operador e n√£o emitir√° um aviso nesse caso. <br><br>  Outros erros: darei a eles o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">arquivo qt-V668.txt</a> . <br><br>  <b>Defeito N34-N70</b> <br><br>  Como prometido, agora √© a vez dos erros quando eles n√£o verificam o resultado da chamada das fun√ß√µes <i>malloc</i> , <i>calloc</i> , <i>strdup</i> , etc.  Esses erros s√£o mais graves do que parecem √† primeira vista.  Mais detalhes: " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Por que √© importante verificar o que a fun√ß√£o malloc retornou</a> ." <br><br><pre> <code class="cpp hljs">SourceFiles::SourceFiles() { nodes = (SourceFileNode**)<span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(SourceFileNode*)*(num_nodes=<span class="hljs-number"><span class="hljs-number">3037</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n = <span class="hljs-number"><span class="hljs-number">0</span></span>; n &lt; num_nodes; n++) nodes[n] = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; }</code> </pre> <br>  Aviso do PVS-Studio: V522 CWE-690 Pode haver desreferencia√ß√£o de um potencial 'nodo' de ponteiro nulo.  Verifique as linhas: 138, 136. makefiledeps.cpp 138 <br><br>  O ponteiro √© usado sem verifica√ß√£o pr√©via. <br><br>  Todos esses erros s√£o do mesmo tipo, por isso n√£o vou me aprofundar neles com mais detalhes.  Vou dar o restante da lista de aviso: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">qt-V522-V575.txt</a> . <br><br><h2>  Erros l√≥gicos nas condi√ß√µes </h2><br>  <b>Defeito N71</b> <br><br><pre> <code class="cpp hljs">QString QEdidParser::parseEdidString(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> quint8 *data) { <span class="hljs-function"><span class="hljs-function">QByteArray </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buffer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">reinterpret_cast</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *&gt;(data), </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">13</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">// Erase carriage return and line feed buffer = buffer.replace('\r', '\0').replace('\n', '\0'); // Replace non-printable characters with dash for (int i = 0; i &lt; buffer.count(); ++i) { if (buffer[i] &lt; '\040' &amp;&amp; buffer[i] &gt; '\176') buffer[i] = '-'; } return QString::fromLatin1(buffer.trimmed()); }</span></span></code> </pre> <br>  Aviso do PVS-Studio: V547 CWE-570 Express√£o 'buffer [i] &lt;' \ 040 '&amp;&amp; buffer [i]&gt;' \ 176 '' √© sempre falso.  qedidparser.cpp 169 <br><br>  A fun√ß√£o deve executar a seguinte a√ß√£o ‚ÄúSubstituir caracteres n√£o imprim√≠veis pelo tra√ßo‚Äù.  No entanto, ela n√£o faz.  Vamos dar uma olhada mais de perto nesta condi√ß√£o: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buffer[i] &lt; <span class="hljs-string"><span class="hljs-string">'\040'</span></span> &amp;&amp; buffer[i] &gt; <span class="hljs-string"><span class="hljs-string">'\176'</span></span>)</code> </pre> <br>  Isso n√£o faz sentido.  Um caractere n√£o pode ser menor que '\ 040' e maior que '\ 176' ao mesmo tempo.  Na condi√ß√£o, voc√™ deve usar o operador '||'.  O c√≥digo correto √©: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buffer[i] &lt; <span class="hljs-string"><span class="hljs-string">'\040'</span></span> || buffer[i] &gt; <span class="hljs-string"><span class="hljs-string">'\176'</span></span>)</code> </pre> <br>  <b>Defeito N72</b> <br><br>  Um erro semelhante, devido ao qual os usu√°rios do Windows n√£o t√™m sorte. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> defined(Q_OS_WIN) static QString driveSpec(const QString &amp;path) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (path.size() </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; 2) return QString(); char c = path.at(0).toLatin1(); if (c &lt; 'a' &amp;&amp; c &gt; 'z' &amp;&amp; c &lt; 'A' &amp;&amp; c &gt; 'Z') return QString(); if (path.at(1).toLatin1() != ':') return QString(); return path.mid(0, 2); } #endif</span></span></span></span></code> </pre> <br>  O analisador gera dois avisos ao mesmo tempo: <br><br><ul><li>  V590 CWE-571 Considere examinar a express√£o 'c &lt;' a '&amp;&amp; c&gt;' z '&amp;&amp; c &lt;' A '&amp;&amp; c&gt;' Z ''.  A express√£o √© excessiva ou cont√©m uma impress√£o incorreta.  qdir.cpp 77 </li><li>  V560 CWE-570 Uma parte da express√£o condicional √© sempre falsa: c&gt; 'z'.  qdir.cpp 77 </li></ul><br>  Um erro l√≥gico est√° na condi√ß√£o: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c &lt; <span class="hljs-string"><span class="hljs-string">'a'</span></span> &amp;&amp; c &gt; <span class="hljs-string"><span class="hljs-string">'z'</span></span> &amp;&amp; c &lt; <span class="hljs-string"><span class="hljs-string">'A'</span></span> &amp;&amp; c &gt; <span class="hljs-string"><span class="hljs-string">'Z'</span></span>)</code> </pre> <br>  Pelo que entendi, o programador queria encontrar um caractere que n√£o seja uma letra do alfabeto latino.  Nesse caso, a condi√ß√£o deve ser assim: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((c &lt; <span class="hljs-string"><span class="hljs-string">'a'</span></span> || c &gt; <span class="hljs-string"><span class="hljs-string">'z'</span></span>) &amp;&amp; (c &lt; <span class="hljs-string"><span class="hljs-string">'A'</span></span> || c &gt; <span class="hljs-string"><span class="hljs-string">'Z'</span></span>))</code> </pre> <br>  <b>Defeito N73</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> SelectionMode { NoSelection, SingleSelection, MultiSelection, ExtendedSelection, ContiguousSelection }; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> QAccessibleTableCell::unselectCell() { QAbstractItemView::SelectionMode selectionMode = view-&gt;selectionMode(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!m_index.isValid() || (selectionMode &amp; QAbstractItemView::NoSelection)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; .... }</code> </pre> <br>  Aviso PVS-Studio: V616 CWE-480 A constante denominada 'QAbstractItemView :: NoSelection' com o valor 0 √© usada na opera√ß√£o bit a bit.  itemviews.cpp 976 <br><br>  A constante nomeada <i>QAbstractItemView :: NoSelection</i> √© zero.  Portanto, a subexpress√£o <i>(selectionMode &amp; QAbstractItemView :: NoSelection)</i> n√£o faz sentido.  Ser√° sempre 0. <br><br>  Eu acho que deveria ser escrito aqui: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!m_index.isValid() || (selectionMode == QAbstractItemView::NoSelection))</code> </pre> <br>  <b>Defeito N74</b> <br><br>  O c√≥digo a seguir √© dif√≠cil de entender.  Ele est√° errado, mas eu n√£o sei o que ele deveria ser.  Comentar sobre uma fun√ß√£o tamb√©m n√£o me ajuda. <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Re-engineered from the inline function _com_error::ErrorMessage(). // We cannot use it directly since it uses swprintf_s(), which is not // present in the MSVCRT.DLL found on Windows XP (QTBUG-35617). static inline QString errorMessageFromComError(const _com_error &amp;comError) { TCHAR *message = nullptr; FormatMessage( FORMAT_MESSAGE_ALLOCATE_BUFFER | FORMAT_MESSAGE_FROM_SYSTEM, NULL, DWORD(comError.Error()), MAKELANGID(LANG_NEUTRAL,SUBLANG_DEFAULT), message, 0, NULL); if (message) { const QString result = QString::fromWCharArray(message).trimmed(); LocalFree(static_cast&lt;HLOCAL&gt;(message)); return result; } if (const WORD wCode = comError.WCode()) return QString::asprintf("IDispatch error #%u", uint(wCode)); return QString::asprintf("Unknown error 0x0%x", uint(comError.Error())); }</span></span></code> </pre> <br>  PVS-Studio Warning: V547 CWE-570 A express√£o 'message' √© sempre falsa.  qwindowscontext.cpp 802 <br><br>  O programador provavelmente assume que a fun√ß√£o <i>FormatMessage</i> alterar√° o valor do ponteiro da <i>mensagem</i> .  Mas isso n√£o √© verdade.  A <i>fun√ß√£o FormatMessage</i> n√£o pode alterar o valor de um ponteiro, pois √© passado para a fun√ß√£o por valor.  Aqui est√° um prot√≥tipo dessa fun√ß√£o: <br><br><pre> <code class="cpp hljs">DWORD __<span class="hljs-function"><span class="hljs-function">stdcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FormatMessageW</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( DWORD dwFlags, LPCVOID lpSource, DWORD dwMessageId, DWORD dwLanguageId, LPWSTR lpBuffer, DWORD nSize, va_list *Arguments )</span></span></span></span>;</code> </pre> <br><br><h2>  Potenciais vazamentos de mem√≥ria </h2><br>  <b>Defeito N75-N92</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SourceDependChildren</span></span></span><span class="hljs-class"> {</span></span> SourceFile **children; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> num_nodes, used_nodes; SourceDependChildren() : children(<span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>), num_nodes(<span class="hljs-number"><span class="hljs-number">0</span></span>), used_nodes(<span class="hljs-number"><span class="hljs-number">0</span></span>) { } ~SourceDependChildren() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (children) <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(children); children = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addChild</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SourceFile *s)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(num_nodes &lt;= used_nodes) { num_nodes += <span class="hljs-number"><span class="hljs-number">200</span></span>; children = (SourceFile**)<span class="hljs-built_in"><span class="hljs-built_in">realloc</span></span>(children, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(SourceFile*)*(num_nodes)); } children[used_nodes++] = s; } };</code> </pre> <br>  Aviso do PVS-Studio: V701 CWE-401 realloc () poss√≠vel vazamento: quando realloc () falha na aloca√ß√£o de mem√≥ria, o ponteiro original 'filhos' √© perdido.  Considere atribuir realloc () a um ponteiro tempor√°rio.  makefiledeps.cpp 103 <br><br>  A expans√£o do buffer √© implementada de maneira perigosa.  Se a fun√ß√£o <i>realloc</i> n√£o puder alocar mem√≥ria, ela retornar√° <i>NULL</i> .  Este <i>NULL</i> ser√° imediatamente colocado na vari√°vel <i>filhos</i> e n√£o haver√° possibilidade de alguma forma liberar o buffer alocado anteriormente.  Um vazamento de mem√≥ria ocorrer√°. <br><br>  Erros semelhantes: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">qt-701.txt</a> . <br><br><h2>  Diversos </h2><br>  <b>Defeito N93</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GradientBase</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">typename</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BlendType</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inline</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BlendType</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QT_FASTCALL</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">qt_fetch_linear_gradient_template</span></span></span><span class="hljs-class">(....) {</span></span> .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t+inc*length &lt; qreal(INT_MAX &gt;&gt; (FIXPT_BITS + <span class="hljs-number"><span class="hljs-number">1</span></span>)) &amp;&amp; t+inc*length &gt; qreal(INT_MIN &gt;&gt; (FIXPT_BITS + <span class="hljs-number"><span class="hljs-number">1</span></span>))) { .... }</code> </pre> <br>  PVS-Studio Warning: V610 CWE-758 Comportamento n√£o especificado.  Verifique o operador de turno '&gt;&gt;'.  O operando esquerdo '(- 2147483647 - 1)' √© negativo.  qdrawhelper.cpp 4015 <br><br>  O valor negativo de <i>INT_MIN</i> n√£o pode ser alterado.  Esse √© um comportamento n√£o especificado e voc√™ n√£o pode confiar no resultado dessa opera√ß√£o.  Os bits mais significativos podem ser iguais a 0 ou 1. <br><br>  <b>Defeito N94</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> QObjectPrivate::addConnection(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> signal, Connection *c) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (signal &gt;= connectionLists-&gt;count()) connectionLists-&gt;resize(signal + <span class="hljs-number"><span class="hljs-number">1</span></span>); ConnectionList &amp;connectionList = (*connectionLists)[signal]; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (signal &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { .... }</code> </pre> <br>  PVS-Studio Warning: V781 CWE-129 O valor da vari√°vel 'signal' √© verificado ap√≥s ser utilizado.  Talvez haja um erro na l√≥gica do programa.  Verifique as linhas: 397, 413. qobject.cpp 397 <br><br>  Uma verifica√ß√£o <i>(sinal &lt;0)</i> indica que o valor do argumento do <i>sinal</i> pode ser negativo.  No entanto, esse argumento foi usado anteriormente para indexar a matriz.  Acontece que a verifica√ß√£o √© realizada tarde demais.  O programa j√° ser√° interrompido. <br><br>  <b>Defeito N95</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> QXmlStreamWriterPrivate::finishStartElement(<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> contents) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inEmptyElement) { write(<span class="hljs-string"><span class="hljs-string">"/&gt;"</span></span>); QXmlStreamWriterPrivate::Tag &amp;tag = tagStack_pop(); lastNamespaceDeclaration = tag.namespaceDeclarationsSize; lastWasStartElement = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { write(<span class="hljs-string"><span class="hljs-string">"&gt;"</span></span>); } inStartElement = inEmptyElement = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; lastNamespaceDeclaration = namespaceDeclarations.size(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hadSomethingWritten; }</code> </pre> <br>  PVS-Studio Warning: V519 CWE-563 A vari√°vel 'lastNamespaceDeclaration' recebe valores duas vezes sucessivos.  Talvez isso seja um erro.  Verifique as linhas: 3188, 3194. qxmlstream.cpp 3194 <br><br>  Vou destacar a ess√™ncia do erro: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inEmptyElement) { lastNamespaceDeclaration = tag.namespaceDeclarationsSize; } lastNamespaceDeclaration = namespaceDeclarations.size();</code> </pre> <br>  <b>Defeito N96</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> QRollEffect::scroll() { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentHeight != totalHeight) { currentHeight = totalHeight * (elapsed/duration) + (<span class="hljs-number"><span class="hljs-number">2</span></span> * totalHeight * (elapsed%duration) + duration) / (<span class="hljs-number"><span class="hljs-number">2</span></span> * duration); <span class="hljs-comment"><span class="hljs-comment">// equiv. to int((totalHeight*elapsed) / duration + 0.5) done = (currentHeight &gt;= totalHeight); } done = (currentHeight &gt;= totalHeight) &amp;&amp; (currentWidth &gt;= totalWidth); .... }</span></span></code> </pre> <br>  V519 CWE-563 A vari√°vel 'done' recebe valores duas vezes sucessivamente.  Talvez isso seja um erro.  Verifique as linhas: 509, 511. qeffects.cpp 511 <br><br>  Tudo √© o mesmo que no caso anterior.  Observe a vari√°vel <i>conclu√≠da</i> . <br><br><h2>  Conclus√£o </h2><br>  Mesmo analisando superficialmente o relat√≥rio, escrevi quase 100 erros.  Estou satisfeito com os resultados do PVS-Studio. <br><br>  Obviamente, essas verifica√ß√µes raras de c√≥digo n√£o t√™m nada a ver com a melhoria da qualidade e confiabilidade do c√≥digo.  Eles demonstram apenas os recursos do analisador de c√≥digo.  As ferramentas de an√°lise est√°tica devem ser aplicadas regularmente.  Nesse caso, eles reduzem o custo de corre√ß√£o de bugs e protegem os aplicativos de muitas poss√≠veis vulnerabilidades. <br><br>  Obrigado pela aten√ß√£o.  Para acompanhar nossas novas publica√ß√µes, convido voc√™ a se inscrever em um de nossos canais: <ol><li>  VK.com: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pvsstudio_rus</a> </li><li>  RSS da ‚Äúvelha escola‚Äù: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">viva64-blog-ru</a> </li><li>  Twitter: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">@pvsstudio_rus</a> </li><li>  Instagram: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">@pvsstudio_rus</a> </li><li>  Telegrama: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">@pvsstudio_rus</a> </li></ol><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/ts/z9/km/tsz9kmyjtteajhd4x1au60rsrvq.png" align="left"></a> </p><br><br>  Se voc√™ deseja compartilhar este artigo com um p√∫blico que fala ingl√™s, use o link para a tradu√ß√£o: Andrey Karpov.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Uma terceira verifica√ß√£o do Qt 5 com o PVS-Studio</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt426485/">https://habr.com/ru/post/pt426485/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt426475/index.html">Miya - assistente do smartphone</a></li>
<li><a href="../pt426477/index.html">Toda a verdade sobre o RTOS. Artigo 15. Parti√ß√µes de mem√≥ria: servi√ßos e estruturas de dados</a></li>
<li><a href="../pt426479/index.html">Banco de teste caseiro para placas-m√£e</a></li>
<li><a href="../pt426481/index.html">Mapas hexagonais no Unity: Path Finder, esquadr√µes de jogadores, anima√ß√µes</a></li>
<li><a href="../pt426483/index.html">Aquele que ultrapassa Tesla. Para mais rent√°vel</a></li>
<li><a href="../pt426487/index.html">Teste a automa√ß√£o do zero. Parte 1</a></li>
<li><a href="../pt426489/index.html">Sobre a rela√ß√£o de n√∫meros primos e irracionais</a></li>
<li><a href="../pt426491/index.html">Semana de Seguran√ßa 39: com a morte do Google+</a></li>
<li><a href="../pt426493/index.html">Descontos constantes de hosters para VPS e VPS.today Pesquisar visitantes</a></li>
<li><a href="../pt426495/index.html">Designer Solo. Como construir uma carreira quando voc√™ trabalha sozinho</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>