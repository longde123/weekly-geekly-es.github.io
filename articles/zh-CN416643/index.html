<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘¶ ğŸ‘¨ğŸ¾â€ğŸ³ â¯ï¸ åä¸ªæ­¥éª¤åœ¨Kubernetesä¸Šåœ¨AWSä¸Šéƒ¨ç½²Elasticsearch ğŸ‘©ğŸ»â€ğŸš€ ğŸ’€ ğŸˆ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kubernetes aka k8sæ˜¯ä¸€ä¸ªå¼€æºç³»ç»Ÿï¼Œç”¨äºè‡ªåŠ¨åŒ–å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„éƒ¨ç½²ï¼Œæ‰©å±•å’Œç®¡ç†ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•è®¾ç½®Kubernetesé›†ç¾¤å¹¶å°†Elasticsearché›†ç¾¤éƒ¨ç½²åˆ°AWSä¸Šã€‚ è¿™äº›è®¾ç½®ä¹Ÿå¯ä»¥åœ¨GCEå’ŒAzureä¸Šä½¿ç”¨ ã€‚ 
 åœ¨AWSä¸Šé…ç½®Kubernetes 


 é¦–...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>åä¸ªæ­¥éª¤åœ¨Kubernetesä¸Šåœ¨AWSä¸Šéƒ¨ç½²Elasticsearch</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/416643/"><p><img src="https://habrastorage.org/webt/rt/no/ud/rtnouda08zlh-unwdbcvqlb8fts.jpeg"></p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetes</a> aka <code>k8s</code>æ˜¯ä¸€ä¸ªå¼€æºç³»ç»Ÿï¼Œç”¨äºè‡ªåŠ¨åŒ–å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„éƒ¨ç½²ï¼Œæ‰©å±•å’Œç®¡ç†ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•è®¾ç½®Kubernetesé›†ç¾¤å¹¶å°†Elasticsearché›†ç¾¤éƒ¨ç½²åˆ°AWSä¸Šã€‚ è¿™äº›è®¾ç½®ä¹Ÿå¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GCE</a>å’Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Azureä¸Šä½¿ç”¨</a> ã€‚ </p><a name="habracut"></a><br><h3 id="konfigurirovanie-kubernetes-na-aws"> åœ¨AWSä¸Šé…ç½®Kubernetes </h3><br><p> é¦–å…ˆï¼Œè·å¾—å¯¹ä»¥ä¸‹AWSæœåŠ¡çš„ç®¡ç†è®¿é—®æƒï¼š <strong>S3ï¼ŒEC2ï¼ŒRoute53ï¼ŒIAM</strong>å’Œ<strong>VPC</strong> ã€‚ </p><br><p>  <strong>1.å®‰è£…ï¼š</strong>æˆ‘å°†æ˜¾ç¤ºLinuxç‰ˆCLIçš„å®‰è£…ã€‚ å¦‚æœæ‚¨ä½¿ç”¨å…¶ä»–æ“ä½œç³»ç»Ÿï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹é“¾æ¥è·å–é€‚ç”¨äºæ‚¨çš„æ“ä½œç³»ç»Ÿçš„å®‰è£…è¯´æ˜ã€‚ </p><br><p> é¦–å…ˆï¼Œå°†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">AWS CLI</a>è®¾ç½®ä¸ºé€šè¿‡CLIè®¿é—®AWSã€‚ å¦‚æœæ‚¨å·²ç»æ‹¥æœ‰Pythonå’Œpipï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š </p><br><pre> <code class="plaintext hljs">pip install awscli --upgrade --user</code> </pre> <br><p> ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kops</a> ï¼ˆä¸€ç§å‘½ä»¤è¡Œå·¥å…·ï¼‰ï¼Œå®ƒå¼•å¯¼æˆ‘ä»¬å®ŒæˆK8Sç”Ÿäº§çº§é›†ç¾¤çš„è®¾ç½®ã€‚ <br> ç›´æ¥ä»githubå®‰è£…<strong>Kops</strong>äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ </p><br><pre> <code class="plaintext hljs">wget -O kops https://github.com/kubernetes/kops/releases/download/$(curl -s https://api.github.com/repos/kubernetes/kops/releases/latest | grep tag_name | cut -d '"' -f 4)/kops-linux-amd64 chmod +x ./kops sudo mv ./kops /usr/local/bin/</code> </pre> <br><p> æœ€åï¼Œæˆ‘ä»¬ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">kubectl</a> -CLIæ¥ç®¡ç†K8Sé›†ç¾¤ï¼ˆå¦‚æœä½¿ç”¨dockerï¼Œåˆ™ç±»ä¼¼äºdocker CLIï¼‰ã€‚ é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…æœ€æ–°ç‰ˆæœ¬ï¼š </p><br><pre> <code class="plaintext hljs">wget -O kubectl https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl chmod +x ./kubectl sudo mv ./kubectl /usr/local/bin/kubectl</code> </pre> <br><p>  <strong>æ³¨æ„ï¼š</strong>æ‚¨å¯ä»¥åœ¨minikubeå®¶ç”¨è®¡ç®—æœºä¸Šå¯åŠ¨Kubernetesé›†ç¾¤å¹¶æŒ‰ç…§æœ¬æ–‡ä¸­çš„è¯´æ˜è¿›è¡Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ“ä½œ</a> ã€‚ </p><br><p>  <strong>2.åˆ›å»ºIAMç”¨æˆ·ï¼š</strong>è¦åœ¨AWSä¸­åˆ›å»ºé›†ç¾¤ï¼Œæˆ‘ä»¬å°†ä¸º<code>kops</code>åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„IAMç”¨æˆ·ã€‚ å¯¹äº<code>kops</code>éœ€è¦ä¸€ä¸ªAPIå¸æˆ·ã€‚ é€šè¿‡<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">AWSæ§åˆ¶å°</a>ç”¨æˆ·ç•Œé¢åˆ›å»ºç”¨æˆ·å¹¶é…ç½®è´¦æˆ·ã€‚  <code>kops</code>ç”¨æˆ·å°†éœ€è¦ä»¥ä¸‹IAMæƒé™ï¼š </p><br><ul><li>  AmazonEC2å®Œå…¨è®¿é—® </li><li> äºšé©¬é€ŠRoute53FullAccess </li><li>  AmazonS3FullAccess </li><li>  IAMFå®Œå…¨è®¿é—® </li><li> äºšé©¬é€ŠVPCFullAccess </li></ul><br><p><img src="https://habrastorage.org/webt/93/ll/zh/93llzhkqarlmyjtluwo3xiqpjwa.jpeg"></p><br><p> æˆ–è€…ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤ä»CLIæ‰§è¡Œç›¸åŒæ“ä½œï¼š </p><br><pre> <code class="plaintext hljs">aws iam create-group --group-name kops aws iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/AmazonEC2FullAccess --group-name kops aws iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/AmazonRoute53FullAccess --group-name kops aws iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/AmazonS3FullAccess --group-name kops aws iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/IAMFullAccess --group-name kops aws iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/AmazonVPCFullAccess --group-name kops aws iam create-user --user-name kops aws iam add-user-to-group --user-name kops --group-name kops aws iam create-access-key --user-name kops</code> </pre> <br><p> æ³¨æ„<code>SecretAccessKey</code>å’Œ<code>AccessKeyID</code> ã€‚ </p><br><p> å°†AWS CLIé…ç½®ä¸ºé€šè¿‡<code>aws configure</code>ä½¿ç”¨æ‚¨çš„è´¦æˆ·ã€‚ </p><br><p> ç¡®ä¿æ‚¨åˆ›å»ºçš„ç”¨æˆ·åœ¨<code>aws iam list-users</code> ã€‚ </p><br><p> æˆ‘ä»¬å°†AWSè´¦æˆ·å¯¼å‡ºä¸ºä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼Œä»¥ä¾¿CLI <code>kops</code>å¯ä»¥ä½¿ç”¨å®ƒä»¬ã€‚ </p><br><pre> <code class="plaintext hljs">export AWS_ACCESS_KEY_ID=$(aws configure get aws_access_key_id) export AWS_SECRET_ACCESS_KEY=$(aws configure get aws_secret_access_key)</code> </pre> <br><blockquote>  <em>å¦‚æœä½¿ç”¨Kops 1.6.2æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œåˆ™è®¾ç½®DNSæ˜¯å¯é€‰çš„ã€‚</em>  <em>æ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªå…«å¦é›†ç¾¤ã€‚</em>  <em>å”¯ä¸€çš„è¦æ±‚ï¼šç¾¤é›†åç§°å¿…é¡»ä»¥<code>.k8s.local</code> ã€‚</em> </blockquote><br><h3 id="nastroyka-dns">  DNSè®¾ç½® </h3><br><p> å¦‚æœæ‚¨å·²ç»é€šè¿‡AWSæ‰˜ç®¡æ‚¨çš„åŸŸå¹¶è®¡åˆ’ä½¿ç”¨å®ƒï¼Œåˆ™æ— éœ€æ‰§è¡Œä»»ä½•æ“ä½œã€‚ å¦ä¸€ä¸ªé€‰æ‹©ï¼šå¦‚æœè¦ä½¿ç”¨åŸŸçš„å­åŸŸï¼Œè¯·ä¸ºæ­¤å­åŸŸåˆ›å»ºç¬¬äºŒä¸ªå…¬å…±æ‰˜ç®¡åŒºåŸŸã€‚ åœ¨æœ¬æ‰‹å†Œä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ç§æœ‰æ‰˜ç®¡åŒºåŸŸã€‚ ç”¨ä»»ä½•åç§°è®¾ç½®åŒºåŸŸã€‚ ä½¿ç”¨æ­¤åç§°åˆ›å»ºKubernetesé›†ç¾¤ã€‚  <a href="">åœ¨æ­¤å¤„é˜…è¯»</a>æœ‰å…³è®¾ç½®DNSçš„<a href="">æ›´å¤š</a>ä¿¡æ¯ã€‚ </p><br><p>  <strong>3.åˆ›å»ºä¸€ä¸ªS3å­˜å‚¨æ¡¶ï¼š</strong>è¦ä¿å­˜K8Sé›†ç¾¤çš„çŠ¶æ€å’Œå¤–è§‚ï¼Œæ‚¨éœ€è¦ä¸º<code>kops</code>åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„S3å­˜å‚¨æ¡¶ã€‚ è¯¥å­˜å‚¨æ¡¶å°†æˆä¸ºé…ç½®ç¾¤é›†å¯é æ•°æ®çš„æ¥æºã€‚ </p><br><pre> <code class="plaintext hljs">aws s3api create-bucket \ --bucket &lt;your-unique-bucket-name&gt; \ --region us-east-1</code> </pre> <br><p>  <strong>æ³¨æ„ï¼š</strong>å¦‚æœæ‚¨å°†é“²æ–—åœ¨<code>us-east-1</code>ä¹‹å¤–çš„å…¶ä»–<code>- region</code>é™¤äº†è®¾ç½®<code>- region</code>åˆ‡æ¢åˆ°æ‰€éœ€åŒºåŸŸï¼Œç„¶åå°†<code>LocationConstraint</code>æ·»åŠ åˆ°åŒä¸€åŒºåŸŸã€‚ ä»¥ä¸‹æ˜¾ç¤ºäº†<code>us-west-1</code>ä¸­çš„bucket buildå‘½ä»¤ã€‚ </p><br><pre> <code class="plaintext hljs">aws s3api create-bucket \ --bucket &lt;your-unique-bucket-name&gt; \ --region us-west-1 \ --create-bucket-configuration LocationConstraint=us-west-1</code> </pre> <br><p> è¦ä¸ºS3å­˜å‚¨æ¡¶ç‰ˆæœ¬é…ç½®å­˜å‚¨ä»¥è¿›è¡Œæ¢å¤ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š </p><br><pre> <code class="plaintext hljs">aws s3api put-bucket-versioning \ --bucket &lt;your-unique-bucket-name&gt; \ --versioning-configuration Status=Enabled</code> </pre> <br><p>  <strong>4.åˆ›å»ºç¬¬ä¸€ä¸ªKubernetesé›†ç¾¤ï¼š</strong>è¿™æ ·ï¼Œæ‚¨å°±å¯ä»¥åˆ›å»ºç¬¬ä¸€ä¸ªé›†ç¾¤äº†ï¼ é¦–å…ˆï¼Œè®¾ç½®ç¯å¢ƒå˜é‡ä»¥ç®€åŒ–è¿‡ç¨‹ã€‚ å¦‚æœè·³è¿‡äº†DNSé…ç½®ï¼ˆåœ¨ç¬¬2æ­¥ä¹‹åï¼‰ï¼Œè¯·å°†<code>.k8s.local</code>æ·»åŠ åˆ°<code>NAME</code>å€¼ã€‚ </p><br><pre> <code class="plaintext hljs">export NAME=myfirstcluster.example.com export KOPS_STATE_STORE=s3://your-bucket-name</code> </pre> <br><p> ä¸è¦å¿˜è®°è·Ÿè¸ªæ‚¨å¯ä»¥ä½¿ç”¨å“ªäº›åŒºåŸŸã€‚ åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†åœ¨<strong>us-east-2åŒºåŸŸä¸­</strong>éƒ¨ç½²ä¸€ä¸ªé›†ç¾¤ã€‚ </p><br><pre> <code class="plaintext hljs">aws ec2 describe-availability-zones --region us-east-2</code> </pre> <br><p> å¦‚æœä½¿ç”¨å…¬å…±æ‰˜ç®¡åŒºåŸŸï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºé›†ç¾¤ï¼š </p><br><pre> <code class="plaintext hljs">kops create cluster \ --zones us-east-2c \ --node-count 3 \ ${NAME}</code> </pre> <br><p> å¦‚æœæ‚¨ä½¿ç”¨ç§äººæ‰˜ç®¡åŒºåŸŸï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š </p><br><pre> <code class="plaintext hljs">kops create cluster \ --zones us-east-2c \ --node-count 3 \ --dns private ${NAME}</code> </pre> <br><p> è¯¥å‘½ä»¤å°†ä¸ºæ‚¨æä¾›K8Sé›†ç¾¤é…ç½®æ—¥å¿—ã€‚ é›†ç¾¤å¯åŠ¨éœ€è¦èŠ±è´¹æ—¶é—´ï¼Œå› ä¸ºå®ƒä¸ºminionä¸»èŠ‚ç‚¹åˆ›å»ºäº†æ–°çš„EC2è®¡ç®—æœºã€‚ </p><br><pre> <code class="plaintext hljs">[ec2-user@ip-172-31-35-145 test]$ kops create cluster \ &gt; --dns private \ &gt; --zones us-east-2c \ &gt; --node-count 3 \ &gt; ${NAME} --yes I0306 09:45:29.636834 20628 create_cluster.go:439] Inferred --cloud=aws from zone "us-east-2c" I0306 09:45:29.637030 20628 create_cluster.go:971] Using SSH public key: /home/ec2-user/.ssh/id_rsa.pub I0306 09:45:29.850021 20628 subnets.go:184] Assigned CIDR 172.20.32.0/19 to subnet us-east-2c I0306 09:45:31.118837 20628 dns.go:92] Private DNS: skipping DNS validation I0306 09:45:46.986963 20628 executor.go:91] Tasks: 73 done / 73 total; 0 can run I0306 09:45:46.987101 20628 dns.go:153] Pre-creating DNS records I0306 09:45:47.668392 20628 update_cluster.go:248] Exporting kubecfg for cluster kops has set your kubectl context to k8s.appbase Cluster is starting. It should be ready in a few minutes.</code> </pre> <br><p> ç§ï¼  K8sé›†ç¾¤åº”è¯¥å·²ç»åœ¨å·¥ä½œã€‚ </p><br><p>  <strong>5.ç¾¤é›†æ£€æŸ¥ï¼š</strong> <code>kops</code>åˆ›å»ºçš„æ‰€æœ‰å®ä¾‹éƒ½åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ASGï¼ˆAuto Scalingç»„ï¼‰ä¸­</a> ã€‚ å‘ç”Ÿæ•…éšœæ—¶ï¼Œå°†æ£€æŸ¥ASGå®ä¾‹å¹¶è‡ªåŠ¨é‡å»ºã€‚ </p><br><p> è¦æ›´æ”¹ç¾¤é›†é…ç½®ï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š </p><br><pre> <code class="plaintext hljs">kops edit cluster ${NAME}</code> </pre> <br><p> æ¯æ¬¡æ›´æ”¹é›†ç¾¤é…ç½®æ—¶ï¼Œéƒ½éœ€è¦é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥åˆ›å»ºé›†ç¾¤ï¼š </p><br><pre> <code class="plaintext hljs">kops update cluster ${NAME} --yes</code> </pre> <br><p> æ‚¨å°†çœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„å†…å®¹ã€‚ </p><br><pre> <code class="plaintext hljs">[ec2-user@ip-172-31-35-145 examples]$ kops update cluster --yes Using cluster from kubectl context: k8s.appbase I0216 05:09:06.074467 2158 dns.go:92] Private DNS: skipping DNS validation I0216 05:09:07.699380 2158 executor.go:91] Tasks: 73 done / 73 total; 0 can run I0216 05:09:07.699486 2158 dns.go:153] Pre-creating DNS records I0216 05:09:07.961703 2158 update_cluster.go:248] Exporting kubecfg for cluster kops has set your kubectl context to k8s.appbase Cluster changes have been applied to the cloud.</code> </pre> <br><p> æ£€æŸ¥é›†ç¾¤ã€‚ </p><br><pre> <code class="plaintext hljs">kops validate cluster</code> </pre> <br><p> ç¡®ä¿ç¾¤é›†å·²å¯åŠ¨å¹¶æ­£åœ¨è¿è¡Œã€‚ </p><br><pre> <code class="plaintext hljs">Using cluster from kubectl context: k8s.appbase Validating cluster k8s.appbase INSTANCE GROUPS NAME ROLE MACHINETYPE MIN MAX SUBNETS master-us-east-2c Master t2.large 1 1 us-east-2c nodes Node t2.medium 3 3 us-east-2c NODE STATUS NAME ROLE READY ip-172-20-44-33.us-east-2.compute.internal master True ip-172-20-52-48.us-east-2.compute.internal node True ip-172-20-62-30.us-east-2.compute.internal node True ip-172-20-64-53.us-east-2.compute.internal node True Your cluster k8s.appbase is ready</code> </pre> <br><p>  <strong>æŸ¥çœ‹æ‚¨çš„æ–°k8sï¼</strong> </p><br><p> é€šè¿‡ç®€å•è°ƒç”¨Kubernetes APIï¼Œæ‚¨å¯ä»¥æ£€æŸ¥APIæ˜¯å¦åœ¨çº¿å¹¶ä¸”æ­£åœ¨ç›‘å¬ã€‚ ä½¿ç”¨<code>kubectl</code>æ£€æŸ¥èŠ‚ç‚¹ã€‚ </p><br><pre> <code class="plaintext hljs">kubectl get nodes</code> </pre> <br><p> è¿™å°†æä¾›æœ‰å…³æ‚¨çš„èŠ‚ç‚¹åŠå…¶å½“å‰çŠ¶æ€çš„ä¿¡æ¯ã€‚ </p><br><pre> <code class="plaintext hljs">[ec2-user@ip-172-31-35-145 elasticsearch]$ kubectl get nodes NAME STATUS ROLES AGE VERSION ip-172-20-44-33.us-east-2.compute.internal Ready master 1m v1.8.6 ip-172-20-52-48.us-east-2.compute.internal Ready node 3m v1.8.6 ip-172-20-62-30.us-east-2.compute.internal Ready node 2m v1.8.6 ip-172-20-64-53.us-east-2.compute.internal Ready node 4m v1.8.6</code> </pre> <br><p>  Kuberneteså­æ˜¯ä¸€ç§æŠ½è±¡ï¼Œä»£è¡¨ä¸€ç»„ä¸€ä¸ªæˆ–å¤šä¸ªåº”ç”¨ç¨‹åºå®¹å™¨ï¼ˆä¾‹å¦‚Dockerï¼‰ä»¥åŠè¿™äº›å®¹å™¨çš„å‡ ä¸ªå…±äº«èµ„æºã€‚ åœ¨èŠ‚ç‚¹ä¸Šå±•å¼€ã€‚ å¦‚æœéœ€è¦æ‰©å±•åº”ç”¨ç¨‹åºï¼Œè¯·å°†èŠ‚ç‚¹æ·»åŠ åˆ°å·²éƒ¨ç½²çš„K8Sã€‚ </p><br><p> è¦äº†è§£å¯ç”¨çš„åŠèˆ±ï¼š </p><br><pre> <code class="plaintext hljs">kubectl get pods</code> </pre> <br><p> æ­¤å‘½ä»¤å°†åˆ—å‡ºç¾¤é›†ä¸­çš„å¯ç”¨ç‚‰åºŠã€‚ </p><br><pre> <code class="plaintext hljs">[ec2-user@ip-172-31-35-145 ~]$ kubectl get pods NAME READY STATUS RESTARTS AGE es-5967f5d99c-5vcpb 1/1 Running 0 3h es-5967f5d99c-cqk88 1/1 Running 0 3h es-5967f5d99c-lp789 1/1 Running 0 3h</code> </pre> <br><h3 id="razvertyvanie-elasticsearch-v-klastere-k8s">  K8Sé›†ç¾¤ä¸­çš„Elasticsearchéƒ¨ç½² </h3><br><p><img src="https://habrastorage.org/webt/ot/1m/he/ot1mhep0o9nltuo2ueq0puexg7g.png"></p><br><p> å¦‚æœæ‚¨ä¸ç†Ÿæ‚‰Kubernetesï¼Œå»ºè®®æ‚¨ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">k8såœ¨çº¿åŸ¹è®­</a> ã€‚ </p><br><p> ç›®å‰ï¼Œæˆ‘ä»¬å·²ç»åœ¨K8Sé›†ç¾¤ä¸­åˆ›å»ºäº†ï¼šä¸»èŠ‚ç‚¹å’Œä¸¤ä¸ªä»£ç†èŠ‚ç‚¹ã€‚ ä¸»èŠ‚ç‚¹çš„ä½œç”¨æ˜¯å°†éƒ¨ç½²å‘½ä»¤ä¼ è¾“åˆ°åœ¨èŠ‚ç‚¹ä»£ç†çš„podä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºã€‚ </p><br><p>  K8Såº”ç”¨ç¨‹åºéƒ¨ç½²æ˜¯å£°æ˜æ€§çš„ï¼Œå¹¶é€šè¿‡JSON / YAMLæ–‡ä»¶è¿›è¡Œé…ç½®ã€‚ æ ¹æ®è¦éƒ¨ç½²çš„åº”ç”¨ç¨‹åºæˆ–ç³»ç»Ÿçš„ç±»å‹é€‰æ‹©æ§åˆ¶å™¨ã€‚ ç”±äºElasticsearchæ˜¯æœ‰çŠ¶æ€çš„åº”ç”¨ç¨‹åºï¼Œå› æ­¤æˆ‘ä»¬å°†ä½¿ç”¨StatefulSetæ§åˆ¶å™¨ã€‚ </p><br><p>  <strong>6.é€šè¿‡StatefulSetè¿›è¡Œéƒ¨ç½²ã€‚</strong>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>StatefulSet</strong></a>æ ¹æ®ç›¸åŒå®¹å™¨çš„è§„èŒƒç®¡ç†å®¹å™¨ã€‚ å®ƒç®¡ç†ç‚‰åºŠé›†çš„éƒ¨ç½²å’Œæ‰©å±•ï¼Œå¹¶ç¡®ä¿è¿™äº›ç‚‰åºŠçš„é¡ºåºå’Œå”¯ä¸€æ€§ã€‚  <strong>StatefulSet</strong>æ§åˆ¶å™¨è¿˜ä½¿å°†åº”ç”¨ç¨‹åºä¸æŒä¹…å·å…³è”å˜å¾—å®¹æ˜“ï¼Œè¿™å¯¹äºElasticsearchéå¸¸é‡è¦ã€‚ </p><br><p> åˆ›å»ºä¸€ä¸ªåä¸º<code>es-stateful set. yaml</code>çš„æ–‡ä»¶ã€‚ å®ƒå°†åŒ…å«Elasticsearchè§„èŒƒã€‚ éšæ—¶æ›´æ”¹é…ç½®ã€‚ æœ‰å…³å¯ä»¥ä¼ é€’åˆ°æ‚¨çš„Elasticsearchå›¾åƒçš„ç¯å¢ƒå˜é‡çš„åˆ—è¡¨ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¯·å‚è§æ­¤å¤„</a> ã€‚ </p><br><p>  <strong>7.æœåŠ¡ï¼š</strong> <code>Service</code> Kubernetes-ä¸€ç§æŠ½è±¡ï¼Œå®šä¹‰äº†é€»è¾‘ä¸Šçš„<code></code>å¹¶å¯¹å…¶è¿›è¡Œè®¿é—®ã€‚ è¿™æœ‰åŠ©äºå®¹å™¨åº”ç”¨ç¨‹åºè¯†åˆ«å¦ä¸€ä¸ªç‚‰è†›ä¸­çš„å¦ä¸€ä¸ªå®¹å™¨åº”ç”¨ç¨‹åºæˆ–å®ƒè‡ªå·±çš„å®ä¾‹ã€‚ </p><br><p><img src="https://habrastorage.org/webt/di/wn/yq/diwnyqsurqxa0813hatxpfhfgco.png"></p><br><p>  <code>LoadBalancer</code>æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„æœåŠ¡ï¼Œå®ƒå‘å¤–éƒ¨ç½‘ç»œæä¾›Podå¹¶åˆ†é…è´Ÿè½½ã€‚ æˆ‘ä»¬å°†ä½¿ç”¨å®ƒæ¥åˆ›å»ºä¸€ä¸ªå¤–éƒ¨IPåœ°å€ï¼Œä»»ä½•äººéƒ½å¯ä»¥é€šè¿‡è¯¥IPåœ°å€è”ç³»Elasticsearché›†ç¾¤ã€‚ æˆ‘ä»¬å°†æ­¤æœåŠ¡ç”¨äºESèŠ‚ç‚¹ï¼Œä»¥å‘ç°å¯¹æ–¹ã€‚ </p><br><p> åˆ›å»ºä¸€ä¸ªåä¸º<code>es-svc.yaml</code>çš„æ–‡ä»¶ã€‚ ç¼–è¾‘å®ƒå¹¶æŒ‡å®šè´Ÿè½½å‡è¡¡å™¨æœåŠ¡ã€‚ </p><br><pre> <code class="plaintext hljs">apiVersion: v1 #API Version of the resource kind: Service #Type of resource metadata: #Contains metadata of this resource. name: elasticsearch #Name of this resource labels: #Additional identifier to put on pods component: elasticsearch #puts component = elasticsearch spec: #Specifications of this resource type: LoadBalancer #type of service selector: #will distribute load on pods which component: elasticsearch #have label `component = elasticsearch` ports: #Port on which LoadBalancer will listen - name: http #Name given to port port: 9200 #Port number protocol: TCP #Protocol supported - name: transport #Name given to port port: 9300 #Port number protocol: TCP #Protocol supported</code> </pre> <br><p>  <strong>8.åˆ›å»ºä¸€ä¸ªåº”ç”¨ç¨‹åºï¼š</strong>è¿™å°±æ˜¯æˆ‘ä»¬æ‰€éœ€è¦çš„ã€‚ ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åœ¨K8Sä¸Šéƒ¨ç½²æˆ‘ä»¬çš„Elasticsearché›†ç¾¤ã€‚ </p><br><pre> <code class="plaintext hljs">kubectl create -f es-statefulset.yaml kubectl create -f es-svc.yaml</code> </pre> <br><p>  â€œåˆ›å»ºâ€æ˜¯ç”¨äºåœ¨K8Sä¸­åˆ›å»ºä»»ä½•èµ„æºçš„é€šç”¨å‘½ä»¤ã€‚ </p><br><p> æˆ‘ä»¬çš„3èŠ‚ç‚¹ï¼ˆåœ¨StatefulSeté…ç½®ä¸­è¿˜è®°å¾—<code>replicas = 3</code>å—ï¼Ÿï¼‰Elasticsearché›†ç¾¤å°†ç«‹å³å¯åŠ¨ã€‚ </p><br><p> æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥Elasticsearch podï¼š </p><br><pre> <code class="plaintext hljs">kubectl get pods</code> </pre> <br><pre> <code class="plaintext hljs">[ec2-user@ip-172-31-35-145 test]$ kubectl get pods,svc,deployment NAME READY STATUS RESTARTS AGE es-0 1/1 Running 0 23m es-1 1/1 Running 0 17m es-2 1/1 Running 0 23m</code> </pre> <br><p>  <strong>9.æµ‹è¯•Elasticsearché›†ç¾¤ï¼š</strong>æ£€æŸ¥Elasticsearché…ç½®æ˜¯å¦æ­£ç¡®å¹¶ä¸”å¯ä»¥æ­£å¸¸å·¥ä½œã€‚ è·å–å¤–éƒ¨IPåœ°å€ä»¥è¿æ¥åˆ°Elasticsearchã€‚ å®ƒå°†ä½äºæˆ‘ä»¬åˆ›å»ºçš„<strong>LoadBalancer</strong>æœåŠ¡<strong>ä¸­</strong> ã€‚ ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æè¿°<strong>LoadBalancer</strong> ï¼š </p><br><pre> <code class="plaintext hljs">kubectl describe service elasticsearch</code> </pre> <br><pre> <code class="plaintext hljs">[ec2-user@ip-172-31-35-145 examples]$ kubectl describe service elasticsearch Name: elasticsearch Namespace: default Labels: component=elasticsearch Annotations: &lt;none&gt; Selector: component=elasticsearch Type: LoadBalancer IP: 100.70.114.146 LoadBalancer Ingress: http://a4d0c157d212811e898430af47d23da1-952261901.us-east-2.elb.amazonaws.com Port: http 9200/TCP TargetPort: 9200/TCP NodePort: http 31358/TCP Endpoints: 100.96.4.28:9200 Port: transport 9300/TCP TargetPort: 9300/TCP NodePort: transport 31767/TCP Endpoints: 100.96.4.28:9300 Session Affinity: None External Traffic Policy: Cluster Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal EnsuringLoadBalancer 1m service-controller Ensuring load balancer Normal EnsuredLoadBalancer 1m service-controller Ensured load balancer [ec2-user@ip-172-31-35-145 examples]$</code> </pre> <br><p> æ³¨æ„<code>LoadBalancer Ingress</code>çš„å€¼ã€‚ æ‰“å¼€å¸¦æœ‰Elasticsearchå¤–éƒ¨ç«¯å£çš„URIå’Œåç¼€å·çš„æµè§ˆå™¨ï¼š <code>9200</code> ã€‚ æ‚¨å°†çœ‹åˆ°ï¼š </p><br><p><img src="https://habrastorage.org/webt/el/b_/zl/elb_zlrvyocf5b7phv5pd9zubri.jpeg"></p><br><p> æ‚¨å¯ä»¥é€šè¿‡åœ¨å¤–éƒ¨IPåœ°å€ä¸Šæ·»åŠ ä»¥ä¸‹ä»£ç æ¥æ£€æŸ¥ElasticsearchèŠ‚ç‚¹çš„åŠŸèƒ½ï¼š <code>9200/_cluster /health?pretty</code> </p><br><p><img src="https://habrastorage.org/webt/hh/ye/aa/hhyeaabyci4yvxnwqjkxacghek4.jpeg"></p><br><p>  <strong>10. Kubernetesä¿®å¤æµ‹è¯•ï¼š</strong> StatefulSets <strong>å¯ä»¥</strong>å­˜å‚¨æŒ‡å®šæ•°é‡çš„å‰¯æœ¬ã€‚ è¿™æ ·ï¼Œå¦‚æœå­é¡¹æ‰è½ï¼ŒStatefulSetå°†å¯åŠ¨æ–°çš„å­é¡¹ã€‚ </p><br><p> æˆ‘ä»¬å°†é€šè¿‡æ¨¡æ‹Ÿæ•…éšœï¼ˆåˆ é™¤è¿è¡ŒESå®ä¾‹çš„æ‰€æœ‰Podï¼‰æ¥æµ‹è¯•å®ƒï¼Œä»¥æŸ¥çœ‹ESé›†ç¾¤æ˜¯å¦å¯ä»¥è‡ªåŠ¨å¤‡ä»½å®Œæ•´çš„æ•°æ®ã€‚ </p><br><p><img src="https://habrastorage.org/webt/l1/vh/nb/l1vhnbrmqhhumqzqi1c7uczvdaa.gif"></p><br><p> ç”±äºStatefulSetä¸€æ¬¡è¿è¡Œä¸€ä¸ªç‚‰åºŠï¼Œå› æ­¤æ¢å¤æ‰€æœ‰å®¹å™¨éœ€è¦æ—¶é—´ã€‚ </p><br><p> æˆ‘ä»¬çœ‹åˆ°ï¼Œç‚‰è†›æ¢å¤åï¼Œåœ¨ESæ•…éšœä¹‹å‰çš„çŠ¶æ€ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—ç´¢å¼•è®°å½•ã€‚ </p><br><h3 id="rekomenduem-sleduyuschie-shagi"> æ¨èçš„åç»­æ­¥éª¤ </h3><br><p> åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨è¿™äº›è®¾ç½®ä¹‹å‰ï¼Œè¯·æ³¨æ„ï¼š </p><br><ol><li> é…ç½®å¤‡ä»½ã€‚ å¸®åŠ©æ¢å¤ä¸¢å¤±çš„æ•°æ®ã€‚ æ­¤è¿‡ç¨‹æœ€å¥½è‡ªåŠ¨åŒ–ã€‚ </li><li> æˆæƒè®¾ç½®ã€‚ æˆ‘ä»¬è¦ä¿æŠ¤Elasticsearché›†ç¾¤ã€‚ åŸºäºåª’ä½“ä»¤ç‰Œè®¾ç½®åŸºæœ¬èº«ä»½éªŒè¯æˆ–æˆæƒå°†æä¾›å®‰å…¨æ€§ã€‚ </li><li>  TLSè¯ä¹¦ã€‚ ä¸ºæˆ‘ä»¬çš„ESç¾¤é›†é…ç½®LetsEncrypt /å…¶ä»–TLSä¸ªäººåŸŸæ˜ å°„è¯ä¹¦æä¾›ç¨‹åºï¼Œå¹¶ä¿æŠ¤å‘é€ç»™å®ƒçš„æ‰€æœ‰è¯·æ±‚ã€‚ </li></ol><br><p> è™½ç„¶æœ¬æ–‡ä¸æ˜¯å…³äºæ­¤çš„ï¼Œä½†çŸ¥é“ï¼šKuberneteså¯ä»¥å®Œæˆæ‰€æœ‰è¿™ä¸€åˆ‡ã€‚ </p><br><p> åŸå§‹<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡æ¡£ï¼šé€šè¿‡10ä¸ªæ­¥éª¤åœ¨Kubernetesä¸Šéƒ¨ç½²Elasticsearchå’ŒKubernetes</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN416643/">https://habr.com/ru/post/zh-CN416643/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN416633/index.html">QUICï¼ŒTLS 1.3ï¼ŒDNS-over-HTTPSï¼Œç„¶åéšå¤„å¯è§</a></li>
<li><a href="../zh-CN416635/index.html">ä»å³åˆ°å·¦ã€‚ å¦‚ä½•åœ¨RTLä¸‹æ‰“å¼€ç«™ç‚¹ç•Œé¢</a></li>
<li><a href="../zh-CN416637/index.html">çº¸å’Œç¡¬çº¸æ¿ä¸­çš„éŸ³ä¹ï¼šå˜å£°ç”µè¯å’Œâ€œç”»å‡ºçš„å£°éŸ³â€çš„ç®€å²</a></li>
<li><a href="../zh-CN416639/index.html">å¤å…´å…ˆé”‹è®¿è°ˆ</a></li>
<li><a href="../zh-CN416641/index.html">å¼€å‘ç§»åŠ¨åº”ç”¨ç¨‹åºç•Œé¢çš„è¿‡ç¨‹çš„8ä¸ªé˜¶æ®µ</a></li>
<li><a href="../zh-CN416645/index.html">MISã€‚ ç ”ç©¶æ¨¡å¼</a></li>
<li><a href="../zh-CN416647/index.html">æ”¿åºœæœºæ„æ˜¯å¦æ¢¦æƒ³ç€ç”µåŠ›é£é™©ï¼Ÿ</a></li>
<li><a href="../zh-CN416651/index.html">1ä¸ªCPUæ ¸å¿ƒä¸Šçš„1M HTTP rpsã€‚ DPDKä»£æ›¿nginx + linuxå†…æ ¸TCP / IP</a></li>
<li><a href="../zh-CN416653/index.html">å›¾ä¹¦é¦†æ’åº</a></li>
<li><a href="../zh-CN416657/index.html">ä¸‰åˆ†ä¹‹äºŒçš„å·²ç”¨å­˜å‚¨å¡åŒ…å«ä»¥å‰æ‰€æœ‰è€…çš„ä¸ªäººæ•°æ®</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>