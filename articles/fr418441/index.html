<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§ôüèΩ üë®‚Äçüë®‚Äçüëß‚Äçüëß ‚ò¢Ô∏è Bases de l'√©l√©vation de privil√®ges Windows üö† ‚úãüèæ üîà</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="J'ai d√©cid√© pour moi et pour ceux qui le trouveraient utile, de rassembler tout ce que je sais, mais je ne me souviens pas sur le sujet, dans cet arti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bases de l'√©l√©vation de privil√®ges Windows</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/418441/"> J'ai d√©cid√© pour moi et pour ceux qui le trouveraient utile, de rassembler tout ce que je sais, mais je ne me souviens pas sur le sujet, dans cet article.  Partagez des conseils.  La principale source de cet article est la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">suivante</a> . <br><br>  J'ai librement traduit et ajout√© un peu de moi-m√™me, ce que j'ai rassembl√© et appris d'autres sources. <br><br>  En g√©n√©ral, voici des moyens de nous aider √† atteindre notre objectif d'√©l√©vation de privil√®ges. <br><a name="habracut"></a><br>  Le point de d√©part de ce court article est un shell (compte) non privil√©gi√©.  Peut-√™tre que nous avons utilis√© un exploit ou effectu√© une attaque et obtenu cet obus. <br><br>  Fondamentalement, au d√©part, nous ne comprenons pas la machine: ce qu'elle fait, √† quoi elle est connect√©e, quel niveau de privil√®ges nous avons, ou m√™me quel syst√®me d'exploitation c'est. <br><br>  Tout d'abord, nous devons obtenir les informations dont nous avons besoin pour comprendre o√π nous en sommes et ce que nous avons: <br><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">systeminfo</span></span> | findstr /B /C:<span class="hljs-string"><span class="hljs-string">" "</span></span> /C:<span class="hljs-string"><span class="hljs-string">" "</span></span></code> </pre> <br>  Cette commande vous permet de d√©terminer, comme vous pouvez le voir, le nom et la version du syst√®me d'exploitation.  Vous pouvez l'ex√©cuter sans param√®tres, alors la sortie de la commande sera plus compl√®te, mais cela nous suffit. <br><br>  Ensuite, il est important de conna√Ætre le nom de la machine et le nom d'utilisateur sous lequel nous sommes connect√©s. <br><br><ul><li>  hostname est le nom d'utilisateur. </li><li>  echo% username% - nom d'utilisateur. </li></ul><br>  Ensuite, voyons quels utilisateurs sont toujours sur cet h√¥te et obtenons des informations plus d√©taill√©es sur leur utilisateur. <br><br><ul><li>  utilisateurs nets - autres utilisateurs </li><li>  net user user1 - informations d√©taill√©es sur l'utilisateur, o√π user1 est le nom de votre utilisateur. </li></ul><br>  Apr√®s avoir re√ßu des informations sur le compte, nous verrons des informations sur l'interaction r√©seau de cet h√¥te. <br><br>  Jetez d'abord un ≈ìil aux interfaces disponibles et √† la table de routage. <br><br><ul><li>  ipconfig / all - informations sur les interfaces disponibles. </li><li>  impression d'itin√©raire - table de routage </li><li>  arp -A - table des entr√©es d'arp </li></ul><br>  Ensuite, nous verrons les connexions r√©seau actives et les r√®gles de pare-feu. <br><br><ul><li>  netstat -ano - connexions r√©seau actives. </li></ul><br>  -a - le lancement avec ce param√®tre affiche toutes les connexions TCP actives, ainsi que les ports TCP et UDP √©cout√©s par le syst√®me; <br>  -n - le param√®tre vous permet d'afficher les connexions TCP actives avec des adresses et des num√©ros de port; <br>  -o - identique √† la cl√© pr√©c√©dente, affiche les connexions TCP actives, mais des codes de processus sont ajout√©s aux statistiques, il est d√©j√† possible de d√©terminer exactement quelle application utilise la connexion. <br><br><ul><li>  √©tat d'affichage du pare-feu netsh - √©tat du pare-feu </li><li>  netsh firewall show config - configuration du pare-feu </li></ul><br>  Enfin, nous examinons bri√®vement ce qui fonctionne sur un h√¥te compromis: t√¢ches planifi√©es, processus en cours d'ex√©cution, services en cours d'ex√©cution et pilotes install√©s. <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">schtasks</span></span> /query /fo LIST /v</code> </pre> <br>  o√π <br>  / query - Affiche des donn√©es sur toutes les t√¢ches planifi√©es, <br>  / fo LIST - Affiche la sortie. <br>  / v - Imprimer les d√©tails du travail. <br><br>  La commande suivante associe les processus en cours d'ex√©cution aux services en cours d'ex√©cution. <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">tasklist</span></span> /SVC</code> </pre> <br>  o√π <br>  / SVC - Services de mappage pour chaque processus. <br><br>  Consultez √©galement la liste des services Windows en cours d'ex√©cution. <br><br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">net</span></span> <span class="hljs-built_in"><span class="hljs-built_in">start</span></span></code> </pre> <br>  Il est √©galement utile de voir des informations sur les pilotes d'un syst√®me compromis. <br><br><pre> <code class="hljs">DRIVERQUERY</code> </pre> <br>  Ensuite, je veux mentionner probablement la commande Windows la plus utile - wmic.  La commande WMIC (Windows Management Instrumentation Command) est utilis√©e pour obtenir des informations sur le mat√©riel et le syst√®me, g√©rer les processus et leurs composants et modifier les param√®tres √† l'aide des capacit√©s de Windows Management Instrumentation (Windows Management Instrumentation ou WMI).  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Bonne description</a> . <br><br>  Malheureusement, certaines configurations Windows n'autorisent pas l'acc√®s √† WMIC par d√©faut si l'utilisateur n'est pas membre du groupe Administrateurs (ce qui est une tr√®s bonne id√©e).  Toute version de XP ne permettait pas d'acc√©der √† WMIC √† partir d'un compte non privil√©gi√©. <br><br>  En revanche, Windows 7 Professionnel et Windows 8 Entreprise ont permis aux utilisateurs disposant de faibles privil√®ges d'utiliser WMIC par d√©faut. <br><br>  Comme d'habitude - param√®tres du programme: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">wmic</span></span> /?</code> </pre> <br>  <a href="">Un bon script pour collecter des informations via wmic.</a> <br><br>  Avant de continuer, il vaut la peine de parcourir les informations collect√©es.  Il convient √©galement de pr√™ter attention aux correctifs install√©s dans le syst√®me, car toute information sur les trous dans le syst√®me nous donnera un support suppl√©mentaire pour augmenter nos privil√®ges.  HotFix peut rechercher des vuln√©rabilit√©s d'√©l√©vation de privil√®ges. <br><br>  Ensuite, nous consid√©rerons une installation sans assistance.  S'il est n√©cessaire d'installer et de configurer une grande flotte de machines, alors en r√®gle g√©n√©rale, le personnel technique ne se d√©placera pas de machine en machine pour configurer chaque machine personnelle.  Il existe plusieurs solutions pour une installation sans assistance.  Ce n'est pas si important pour nous quelles sont ces m√©thodes et comment elles fonctionnent, mais ce qui importe, c'est qu'elles laissent les fichiers de configuration utilis√©s pour le processus d'installation qui contiennent de nombreuses informations confidentielles, telles que la cl√© de produit du syst√®me d'exploitation et le mot de passe administrateur.  Ce qui nous int√©resse le plus, c'est le mot de passe administrateur, que nous pouvons utiliser pour augmenter nos privil√®ges. <br><br>  En r√®gle g√©n√©rale, ce sont les r√©pertoires suivants: <br><br><ul><li>  c: \ sysprep.inf </li><li>  c: \ sysprep \ sysprep.xml </li><li>  % WINDIR% \ Panther \ Unattend \ Unattended.xml </li><li>  % WINDIR% \ Panther \ Unattended.xml </li></ul><br>  Mais cela vaut la peine de v√©rifier l'ensemble du syst√®me. <br><br>  Ces fichiers contiennent des mots de passe en texte clair ou encod√©s en BASE64. <br>  Exemples: <br><br>  Sysprep.inf - mot de passe en texte clair. <br><br><img src="https://habrastorage.org/webt/fq/1t/qm/fq1tqm53bjiwjlwsbrevzdcy6qw.png">  " <br><br>  Sysprep.xml - mot de passe encod√© en base64. <br><br><img src="https://habrastorage.org/webt/rh/2r/gk/rh2rgkl3wtby-9lagcxmfrnrlgu.png">  " <br><br>  Unattended.xml - mot de passe encod√© en base64. <br><br><img src="https://habrastorage.org/webt/5e/1p/gl/5e1pglvwtogk0kd0xn4cmey_hlo.png"><br><br>  De plus, pour les h√¥tes connect√©s au domaine, vous pouvez rechercher le fichier Group.xml, qui contient le mot de passe chiffr√© AES256, mais qui peut √™tre d√©chiffr√©, car  la cl√© est publi√©e sur msdn (https://msdn.microsoft.com/en-us/library/cc422924.aspx) et d'autres sources.  Mais c'est le cas si la politique de cr√©ation d'utilisateurs locaux sur les h√¥tes ou, par exemple, la d√©finition d'un mot de passe pour un administrateur local est utilis√©e. <br><br>  Par exemple, j'ai ici: <br><br><img src="https://habrastorage.org/webt/jy/wu/4g/jywu4g6xzymrbkwwniw4m_3uckg.png"><br><br>  Apr√®s l'avoir ouvert, nous recherchons le param√®tre ¬´cpassword¬ª. <br><br><img src="https://habrastorage.org/webt/i9/ow/hk/i9owhkwprnwlpmltga00uj-awx4.png"><br><br>  Ensuite, vous devez d√©crypter cette s√©quence.  Nous utilisons, par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CrypTool</a> .  Tout d'abord, d√©codez Base64. <br>  Les fonctionnalit√©s de Base64 sont que sa longueur doit √™tre un multiple de 4. Par cons√©quent, nous consid√©rons des blocs de 4, et s'il n'y a pas assez de caract√®res dans le dernier bloc, nous ajoutons les caract√®res manquants avec ¬´=¬ª. <br>  J'ai eu 2 "=". <br><br><img src="https://habrastorage.org/webt/bm/sc/73/bmsc73fsqblniktrnrsyugqowhi.png"><br><br>  Ensuite, nous d√©cryptons.  En utilisant la cl√© ci-dessus. <br><br><img src="https://habrastorage.org/webt/-f/n0/nt/-fn0ntf9um-zfyfoqpn7uwafoay.png"><br><br>  Nous supprimons les points suppl√©mentaires s√©parant les caract√®res et obtenons le mot de passe. <br><br>  En plus de Group.xml, voici quelques autres fichiers de pr√©f√©rence de strat√©gie qui peuvent avoir un ensemble suppl√©mentaire d'attributs cPassword: <br><br><ul><li>  Services \ Services.xml </li><li>  ScheduledTasks \ ScheduledTasks.xml </li><li>  Imprimantes \ Printers.xml </li><li>  Drives \ Drives.xml </li><li>  DataSources \ DataSources.xml </li></ul><br>  Cependant, nous aimons tous les solutions automatis√©es, afin que nous puissions arriver √† la ligne d'arriv√©e le plus rapidement possible.  Il y a deux options principales ici, selon le type de shell / acc√®s que nous avons.  Il existe un module m√©tasploit qui peut √™tre ex√©cut√© via une session √©tablie (https://www.rapid7.com/db/modules/post/windows/gather/credentials/gpp) ou vous pouvez utiliser Get-GPPPassword, qui fait partie de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PowerSploit</a> . <br><br>  D'accord, ensuite.  Nous rechercherons l'√©trange param√®tre de registre ¬´AlwaysInstallElevated¬ª.  Cette option permet aux utilisateurs non privil√©gi√©s d'installer des fichiers .msi √† partir de NT AUTHORITY \ SYSTEM. <br><br>  Afin de pouvoir utiliser cela, nous devons v√©rifier que les deux cl√©s de registre sont install√©es, et si c'est le cas, nous pouvons obtenir un shell SYSTEM.  V√©rifier: <br><br><pre> <code class="hljs tex">reg query HKLM<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SOFTWARE</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Policies</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Microsoft</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Installer</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AlwaysInstallElevated</span></span></span></span></code> </pre> <br><pre> <code class="hljs tex">reg query HKCU<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SOFTWARE</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Policies</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Microsoft</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Installer</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AlwaysInstallElevated</span></span></span></span></code> </pre> <br>  Metasploit comprend un module sp√©cial exploit / windows / local / always_install_elevated, qui cr√©e un fichier MSI avec un fichier ex√©cutable sp√©cial int√©gr√©, qui est extrait et ex√©cut√© par l'installateur avec des privil√®ges syst√®me.  Apr√®s son ex√©cution, le fichier msi arr√™te l'installation afin d'emp√™cher l'enregistrement des actions dans le syst√®me.  De plus, si vous d√©marrez l'installation avec le commutateur / quiet, vous n'obtiendrez m√™me pas d'erreur. <br><br>  Eh bien, quelques commandes de recherche utiles sur le syst√®me: <br><br>  La commande ci-dessous va rechercher dans le syst√®me de fichiers les noms de fichiers contenant des mots cl√©s sp√©cifiques.  Vous pouvez sp√©cifier n'importe quel nombre de mots-cl√©s. <br><br><pre> <code class="hljs markdown">dir /s <span class="hljs-emphasis"><span class="hljs-emphasis">*pass*</span></span> == <span class="hljs-emphasis"><span class="hljs-emphasis">*cred*</span></span> == <span class="hljs-emphasis"><span class="hljs-emphasis">*vnc*</span></span> == <span class="hljs-emphasis"><span class="hljs-emphasis">*.config*</span></span></code> </pre> <br>  En recherchant des types de fichiers sp√©cifiques par mot-cl√©, cette commande peut g√©n√©rer beaucoup de sortie. <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">findstr</span></span> /si password <span class="hljs-regexp"><span class="hljs-regexp">*.xml</span></span> <span class="hljs-regexp"><span class="hljs-regexp">*.ini</span></span> <span class="hljs-regexp"><span class="hljs-regexp">*.txt</span></span></code> </pre> <br>  De m√™me, les deux commandes ci-dessous peuvent √™tre utilis√©es pour grep le registre pour les mots cl√©s, dans ce cas, "mot de passe". <br><br><pre> <code class="hljs pgsql">reg query HKLM /f <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> /t REG_SZ /s</code> </pre> <br><pre> <code class="hljs pgsql">reg query HKCU /f <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> /t REG_SZ /s</code> </pre> <br>  Pour le moment, nous en avons d√©j√† assez pour faire fonctionner le syst√®me.  Mais il y a quelques attaques plus cibl√©es pour obtenir le r√©sultat souhait√©: nous examinerons les services Windows et les autorisations pour les fichiers et les dossiers.  Notre objectif ici est d'utiliser des autorisations faibles pour am√©liorer les privil√®ges de session. <br><br>  Nous allons v√©rifier de nombreux droits d'acc√®s, accesschk.exe, qui est un outil de Microsoft Sysinternals Suite, nous y aidera.  Microsoft Sysinternals contient de nombreux excellents outils.  Le package peut √™tre t√©l√©charg√© √† partir du site Web de Microsoft Technet (https://docs.microsoft.com/ru-ru/sysinternals/downloads/sysinternals-suite). <br><br>  Nous pouvons v√©rifier le niveau de privil√®ge requis pour chaque service en utilisant accesschk. <br><br>  Nous pouvons voir les autorisations dont dispose chaque niveau d'utilisateur. <br><br><img src="https://habrastorage.org/webt/jo/pf/q2/jopfq2pwodrwtcexiainzaji4yk.png"><br><br>  Accesschk peut v√©rifier automatiquement si nous avons un acc√®s en √©criture √† un service Windows avec un niveau d'utilisateur sp√©cifique.  En r√®gle g√©n√©rale, en tant qu'utilisateur avec de faibles privil√®ges, nous voulons v√©rifier les ¬´Utilisateurs¬ª.  Assurez-vous de v√©rifier √† quels groupes d'utilisateurs vous appartenez. <br><br>  -c Le nom est un service Windows, par exemple ssdpsrv (sp√©cifiez ¬´*¬ª pour afficher tous les services) <br>  -d Uniquement traiter les r√©pertoires <br>  -e Afficher uniquement les niveaux d'int√©grit√© explicitement sp√©cifi√©s (Windows Vista uniquement) <br>  -k Le nom est une cl√© de registre, par exemple, hklm \ software <br>  -n Afficher uniquement les objets qui n'ont pas de r√®gles d'acc√®s <br>  -p Le nom ou l'identificateur de processus (PID) est sp√©cifi√© comme nom, par exemple cmd.exe (sp√©cifiez ¬´*¬ª comme nom pour afficher tous les processus) <br>  -q Omettre l'en-t√™te <br>  -r Imprime uniquement les objets ayant un acc√®s en lecture <br>  -s Traitement r√©cursif <br>  -v Imprimer des informations d√©taill√©es <br>  -w Liste uniquement les objets ayant un acc√®s en √©criture <br><br><img src="https://habrastorage.org/webt/4z/1r/u6/4z1ru6mikuprkxybtdzohmzgl5s.png"><br><br>  Il y a aussi une autre commande int√©ressante: <br><br><pre> <code class="hljs dos">autorunsc.exe -a | <span class="hljs-built_in"><span class="hljs-built_in">findstr</span></span> /n /R "File\ <span class="hljs-keyword"><span class="hljs-keyword">not</span></span>\ found"</code> </pre> <br>  Vous permet de trouver une entr√©e de registre sur un fichier qui a √©t√© lanc√© automatiquement, mais qui est d√©j√† manquant dans le syst√®me.  L'enregistrement pourrait rester si, par exemple, le service √©tait incorrectement supprim√©.  √Ä chaque d√©marrage, le syst√®me essaie sans succ√®s d'ex√©cuter ce fichier.  Vous pouvez √©galement profiter de cette situation pour √©tendre votre autorit√©.  Remplacez simplement ce fichier par le n√¥tre. <br><br>  Ensuite, nous consid√©rons deux vuln√©rabilit√©s: <br><br>  Premi√®rement: reproduire les r√©sultats d'un article √©crit par Parvez de GreyHatHacker;  ¬´√âlever les privil√®ges en exploitant des autorisations de dossier faibles¬ª (http://www.greyhathacker.net/?p=738). <br><br>  Cet exemple est un cas particulier de d√©tournement de DLL.  Les programmes ne peuvent g√©n√©ralement pas fonctionner seuls, ils ont de nombreuses ressources dont ils ont besoin pour se connecter (principalement des DLL, mais aussi leurs propres fichiers).  Si un programme ou un service t√©l√©charge un fichier √† partir d'un r√©pertoire dans lequel nous avons un acc√®s en √©criture, nous pouvons en abuser pour lancer un shell avec des privil√®ges sous lesquels le programme s'ex√©cute. <br><br>  En r√®gle g√©n√©rale, une application Windows utilise des chemins de recherche pr√©d√©finis pour trouver la DLL, et elle v√©rifie ces chemins dans un ordre sp√©cifique.  Le d√©tournement de DLL se produit g√©n√©ralement en pla√ßant des DLL malveillantes sur l'un de ces chemins.  Ce probl√®me peut √™tre r√©solu en indiquant √† l'application des chemins absolus vers la DLL requise. <br><br>  Ordre de recherche dll: <br><br><ol><li>  Le r√©pertoire √† partir duquel l'application s'ex√©cute </li><li>  R√©pertoire syst√®me 32 bits (C: \ Windows \ System32) </li><li>  R√©pertoire syst√®me 16 bits (C: \ Windows \ System) </li><li>  R√©pertoire Windows (C: \ Windows) </li><li>  R√©pertoire de travail actuel (CWD) </li><li>  R√©pertoires dans la variable d'environnement PATH (syst√®me puis utilisateur) </li></ol><br>  Parfois, les applications essaient de t√©l√©charger les fichiers dll manquants sur la machine.  Cela peut se produire pour plusieurs raisons, par exemple, si la biblioth√®que dll n'est requise que pour certains plug-ins ou composants qui ne sont pas install√©s.  Dans ce cas, Parvez a d√©couvert que certains services Windows tentaient de charger des biblioth√®ques de DLL qui n'existent pas dans les param√®tres par d√©faut. <br><br>  Puisque la DLL n'existe pas, nous finissons par parcourir tous les chemins de recherche.  En tant qu'utilisateur avec un faible niveau de privil√®ge, nous avons peu de chances de mettre une DLL malveillante dans les √©l√©ments 1-4, 5. Mais si nous avons un acc√®s en √©criture √† l'un des r√©pertoires, alors nos chances de gagner sont grandes. <br><br>  Voyons comment cela fonctionne dans la pratique, pour notre exemple, nous utiliserons le service IKEEXT (modules de cl√©s IPSec IKE et AuthIP) qui essaie de t√©l√©charger wlbsctrl.dll. <br><br>  Tout r√©pertoire dans "C: \" fournira un acc√®s en √©criture aux utilisateurs authentifi√©s, cela nous donne une chance. <br><br><pre> <code class="hljs tex">C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Users</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span></span>1<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Desktop</span></span></span></span>&gt; accesschk.exe -dqv "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Python</span></span></span></span>27"</code> </pre> <br><pre> <code class="hljs pgsql">C:\Python27 Medium Mandatory <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>) [<span class="hljs-keyword"><span class="hljs-keyword">No</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">Write</span></span>-Up] RW BUILTIN\Administrators FILE_ALL_ACCESS RW NT AUTHORITY\<span class="hljs-keyword"><span class="hljs-keyword">SYSTEM</span></span> FILE_ALL_ACCESS R BUILTIN\Users FILE_LIST_DIRECTORY FILE_READ_ATTRIBUTES FILE_READ_EA FILE_TRAVERSE SYNCHRONIZE READ_CONTROL RW NT AUTHORITY\Authenticated Users FILE_ADD_FILE FILE_ADD_SUBDIRECTORY FILE_LIST_DIRECTORY FILE_READ_ATTRIBUTES FILE_READ_EA FILE_TRAVERSE FILE_WRITE_ATTRIBUTES FILE_WRITE_EA <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> SYNCHRONIZE READ_CONTROL</code> </pre><br><pre> <code class="hljs tex">C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Users</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span></span>1<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Desktop</span></span></span></span>&gt; icacls "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Python</span></span></span></span>27"</code> </pre> <br><pre> <code class="hljs tex">C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Python</span></span></span></span>27 BUILTIN<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Administrators</span></span></span></span>:(ID)F BUILTIN<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Administrators</span></span></span></span>:(OI)(CI)(IO)(ID)F NT AUTHORITY<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SYSTEM</span></span></span></span>:(ID)F NT AUTHORITY<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SYSTEM</span></span></span></span>:(OI)(CI)(IO)(ID)F BUILTIN<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Users</span></span></span></span>:(OI)(CI)(ID)R NT AUTHORITY<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Authenticated</span></span></span></span> Users:(ID)C NT AUTHORITY<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Authenticated</span></span></span></span> Users:(OI)(CI)(IO)(ID)C</code> </pre><br>  F - acc√®s complet. <br>  (OI) - h√©ritage par les objets. <br>  (CI) - h√©ritage par conteneurs. <br>  (IO) - uniquement l'h√©ritage. <br>  (NP) - une interdiction de la distribution de l'h√©ritage. <br>  (I) - h√©rite des autorisations du conteneur parent. <br><br>  Avant de poursuivre l'action, vous devez v√©rifier l'√©tat du service IKEEXT.  Dans ce cas, nous pouvons voir qu'il est r√©gl√© sur "AUTO_START"! <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sc</span></span> qc IKEEXT</code> </pre> <br><pre> <code class="hljs tex">[SC] QueryServiceConfig SUCCESS SERVICE_NAME: IKEEXT TYPE : 20 WIN32_SHARE_PROCESS START_TYPE : 2 AUTO_START ERROR_CONTROL : 1 NORMAL BINARY_PATH_NAME : C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system</span></span></span></span>32<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">svchost</span></span></span></span>.exe -k netsvcs LOAD_ORDER_GROUP : TAG : 0 DISPLAY_NAME : IKE and AuthIP IPsec Keying Modules DEPENDENCIES : BFE SERVICE_START_NAME : LocalSystem</code> </pre> <br>  Maintenant, nous savons que nous avons les conditions n√©cessaires, et nous pouvons cr√©er une DLL malveillante et intercepter le shell! <br><br>  Nous utilisons Metasploit -&gt; msfvenom, par exemple. <br><br><img src="https://habrastorage.org/webt/ac/-m/_z/ac-m_z8lymihvi6r6g3dsxmebr8.png"><br><br>  Apr√®s avoir transf√©r√© evil.dll sur notre ordinateur cible, tout ce que nous avons √† faire est de le renommer en wlbsctrl.dll et de le d√©placer vers ¬´C: \ Python27¬ª.  Une fois cela fait, nous devons attendre patiemment le red√©marrage de la machine (ou nous pouvons essayer de forcer le red√©marrage), et nous obtiendrons le shell du syst√®me. <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">copy</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">evil</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.dll</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">C</span></span>:\<span class="hljs-selector-tag"><span class="hljs-selector-tag">Python27</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">wlbsctrl</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.dll</span></span></code> </pre> <br>  Apr√®s cela, il ne reste plus qu'√† attendre le red√©marrage du syst√®me. <br><br>  Pour notre dernier exemple, nous consid√©rerons les t√¢ches planifi√©es.  Je d√©crirai le principe, car  tous peuvent avoir des cas diff√©rents. <br><br>  On retrouve le processus, le service, l'application lanc√©e par le planificateur de t√¢ches de SYSTEM. <br>  Nous v√©rifions les droits d'acc√®s au dossier o√π se trouve notre cible. <br><br><pre> <code class="hljs powershell">accesschk.exe <span class="hljs-literal"><span class="hljs-literal">-dqv</span></span> <span class="hljs-string"><span class="hljs-string">"__"</span></span></code> </pre> <br>  Il est clair qu'il s'agit d'un grave probl√®me de configuration, mais pire encore est le fait que tout utilisateur authentifi√© (utilisateur authentifi√©) a un acc√®s en √©criture √† ce dossier.  Dans cet exemple, nous pouvons simplement remplacer l'ex√©cutable binaire par le fichier g√©n√©r√© par metasploit. <br><br>  Peut √™tre encod√© en option. <br><br><img src="https://habrastorage.org/webt/7c/p6/qv/7cp6qviajkpgxvibpruzsgqhjv4.png"><br><br>  Il ne reste plus qu'√† t√©l√©charger le fichier ex√©cutable malveillant et √† l'√©craser dans le dossier des fichiers ex√©cutables.  Une fois cela fait, nous pouvons aller au lit en toute s√©curit√© et faire une marche syst√©mique t√¥t le matin. <br><br>  Ces deux exemples devraient nous donner une id√©e des vuln√©rabilit√©s √† rechercher lors de l'examen des autorisations pour les fichiers et les dossiers.  Il faudra du temps pour apprendre tous les chemins binpath pour les services Windows, les t√¢ches planifi√©es et les t√¢ches d'ex√©cution automatique. <br><br>  Enfin, quelques conseils pour utiliser accesschk.exe. <br><br>  Trouvez toutes les autorisations faibles pour les dossiers sur le disque. <br><br><pre> <code class="hljs swift">accesschk.exe -uwdqs <span class="hljs-type"><span class="hljs-type">Users</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:\ accesschk.exe -uwdqs <span class="hljs-string"><span class="hljs-string">"Authenticated Users"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:\</code> </pre><br>  Trouvez toutes les autorisations faibles pour les fichiers sur le disque. <br><br><pre> <code class="hljs swift">accesschk.exe -uwqs <span class="hljs-type"><span class="hljs-type">Users</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:\*.* accesschk.exe -uwqs <span class="hljs-string"><span class="hljs-string">"Authenticated Users"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:\*.*</code> </pre> <br>  Comme tout. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr418441/">https://habr.com/ru/post/fr418441/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr418429/index.html">Mon exp√©rience professionnelle pour le r√¥le de coach agile en Europe, deuxi√®me partie</a></li>
<li><a href="../fr418431/index.html">Probl√®mes imaginaires - la racine des mauvais logiciels</a></li>
<li><a href="../fr418433/index.html">4 ao√ªt Peter. La premi√®re qu√™te de v√©lo pour les programmeurs</a></li>
<li><a href="../fr418437/index.html">L'√©quipe d'OC √† la rescousse</a></li>
<li><a href="../fr418439/index.html">Notions de base sur les applications Web progressives</a></li>
<li><a href="../fr418443/index.html">GObject: encapsulation, instanciation, introspection</a></li>
<li><a href="../fr418445/index.html">Django Channels - la r√©ponse au web moderne</a></li>
<li><a href="../fr418447/index.html">Pourquoi Moscow Python Conf est maintenant ++</a></li>
<li><a href="../fr418449/index.html">Modules binaires pour Python</a></li>
<li><a href="../fr418451/index.html">Cours d'impression 3D. Prise en charge efficace et changement de hauteur de couche dans la pratique de 3Dtool</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>