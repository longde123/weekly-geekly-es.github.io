<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßïüèª üçô üôçüèæ Como iniciar um projeto de estima√ß√£o e n√£o obter benef√≠cios üï∫üèΩ ü§õüèø üëçüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="TL; DR 

 O artigo descreve o uso do projeto pet como uma maneira de manter e melhorar as habilidades. O autor criou uma biblioteca PHP para instalar ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como iniciar um projeto de estima√ß√£o e n√£o obter benef√≠cios</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479122/"><p><img src="https://habrastorage.org/webt/cz/x-/ln/czx-lnrbjewed61t5fm8k_pjvei.png" alt="Como iniciar um projeto de estima√ß√£o e n√£o obter benef√≠cios"></p><br><div class="spoiler">  <b class="spoiler_title">TL; DR</b> <div class="spoiler_text"><p>  O artigo descreve o uso do projeto pet como uma maneira de manter e melhorar as habilidades.  O autor criou uma <a href="https://github.com/liquetsoft/fias-symfony" rel="nofollow">biblioteca PHP</a> para instalar o <a href="https://fias.nalog.ru/" rel="nofollow">FIAS a</a> partir de arquivos XML. </p></div></div><br><h2 id="cel">  Finalidade </h2><br><p>  Raramente troco de emprego, portanto, dado o desejo natural de cada organiza√ß√£o por processos fixos, qualquer tarefa se transforma em rotina.  Por um lado, √© ben√©fico para uma empresa manter esse estado, por outro lado, para mim isso significa perda completa ou obsolesc√™ncia de habilidades.  O PHP est√° se desenvolvendo rapidamente e, consequentemente, o atraso em potencial tamb√©m est√° crescendo rapidamente.  Por fim, todos sabemos que hoje √© dif√≠cil para um programador encontrar um bom emprego sem o conhecimento de Elasticsearch, RabbitMQ, Kafka e outras tecnologias que nem sempre aparecem no meu trabalho di√°rio. </p><a name="habracut"></a><br><p>  Depois de iniciar o pr√≥ximo site t√≠pico, decidi que era hora de mudar alguma coisa.  N√£o queria mudar meu trabalho, mas lembrei-me de como em uma das confer√™ncias o palestrante recomendou o uso de seu pr√≥prio projeto opcional, o chamado projeto de estima√ß√£o, para treinamento.  O m√©todo parecia apropriado e eu decidi experiment√°-lo. </p><br><h2 id="vybor-zadachi">  Sele√ß√£o de tarefas </h2><br><p>  A escolha da tarefa acabou sendo a parte mais dif√≠cil do empreendimento.  Nada de especial veio √† mente: alguns servi√ßos, como um analisador de tarefas que podem ser facilmente implementados em uma pilha familiar.  Abandonei a id√©ia do projeto por v√°rios meses, at√© que vi acidentalmente as not√≠cias sobre o hackathon do Minist√©rio das Finan√ßas.  Sugeriu o uso de uma das listas de fontes de dados abertas para criar um servi√ßo.  Entre outros, tamb√©m foi indicado o FIAS (Federal Information Address System).  Infelizmente, o hackathon j√° havia terminado at√© ent√£o. </p><br><p>  Eu aprendi sobre o FIAS pela primeira vez, mas a tarefa parecia interessante.  Julgue por si mesmo: cerca de 30 GB de arquivos XML, cerca de 60 milh√µes de linhas no banco de dados e, al√©m disso, a biblioteca poder√° mais tarde ser √∫til no trabalho.  Havia algumas solu√ß√µes prontas no Github, mas isso n√£o me impediu.  Pelo contr√°rio, com base em sua an√°lise, fiz requisitos adicionais que destacariam minha implementa√ß√£o. </p><br><p>  No futuro, observo que encontrei muito menos dificuldades do que esperava. </p><br><h2 id="formulirovka-zadachi">  Declara√ß√£o de tarefa </h2><br><p>  90% do sucesso √© a afirma√ß√£o correta do problema.  Ap√≥s v√°rios anos de trabalho com modelos, era bastante dif√≠cil conseguir formular claramente o problema.  Eu s√≥ queria come√ßar a trabalhar, mas j√° no processo tudo teria esclarecido por si s√≥.  Ap√≥s uma hora de luta com a procrastina√ß√£o, finalmente escrevi: crie uma biblioteca em PHP para importar dados do FIAS. </p><br><p>  Mais tarde, depois de um gosto, adicionei alguns requisitos adicionais: </p><br><ul><li>  implementa√ß√£o em PHP sem o uso de utilit√°rios de terceiros, c√≥digo exclusivo em PHP e extens√µes do PECL, </li><li>  importa√ß√£o de todos os dados do conjunto FIAS, </li><li>  ciclo completo de instala√ß√£o e atualiza√ß√£o: pesquisando a vers√£o necess√°ria, recebendo o arquivo morto, desembalando, gravando no banco de dados, </li><li>  flexibilidade m√°xima: a capacidade de alterar o local de armazenamento, modificar os dados antes da grava√ß√£o, filtrar o necess√°rio etc., </li><li>  A biblioteca deve ser facilmente integrada aos projetos existentes. </li></ul><br><h2 id="fias">  FIAS </h2><br><p>  O FIAS possui um <a href="https://fias.nalog.ru/" rel="nofollow">site oficial</a> que nos d√° a defini√ß√£o e o objetivo de criar um sistema </p><br><blockquote>  O Sistema Federal de Informa√ß√µes de Endere√ßo (FIAS) √© o sistema federal de informa√ß√µes estaduais que fornece a forma√ß√£o, manuten√ß√£o e uso do registro de endere√ßos estaduais. <br><br>  O objetivo da cria√ß√£o do FIAS √© a forma√ß√£o de um √∫nico recurso federal que cont√©m informa√ß√µes de endere√ßo confi√°veis, uniformes, dispon√≠veis ao p√∫blico e estruturadas.  Gra√ßas √† implementa√ß√£o do FIAS, essas informa√ß√µes podem ser obtidas gratuitamente atrav√©s da Internet no portal FIAS registrado oficialmente. </blockquote><p>  Os materiais com uma descri√ß√£o s√£o suficientes, tanto no <a href="https://fias.nalog.ru/Updates.aspx" rel="nofollow">site do FIAS</a> quanto no <a href="https://habr.com/ru/search/%3Fq%3D%25D0%25A4%25D0%2598%25D0%2590%25D0%25A1">Habr√©</a> , portanto, n√£o vou me concentrar nisso. </p><br><p>  Em suma.  O FIAS vem em dois formatos: FIAS e KLADR.  O segundo est√° obsoleto e n√£o est√° mais em uso.  As informa√ß√µes s√£o armazenadas no DBF ou no XML.  Cada altera√ß√£o na composi√ß√£o do FIAS √© marcada com uma nova vers√£o.  Voc√™ pode solicitar um pacote com dados completos atualizados no momento ou contendo apenas altera√ß√µes entre as duas vers√µes.  Links fornece um servi√ßo SOAP.  O pacote √© um arquivo RAR contendo arquivos com nomes especialmente formados.  Eles consistem em um prefixo, um nome de conjunto de dados e uma data de gera√ß√£o.  Existem dois tipos de prefixos: AS_ para arquivos dos quais os dados devem ser adicionados ao banco de dados e AS <em>DEL</em> para arquivos cujos dados devem ser exclu√≠dos do banco de dados. </p><br><p>  O FIAS cont√©m os seguintes dados: </p><br><ul><li>  registro de elementos formadores de endere√ßo (este √© o gr√°fico de endere√ßos: regi√µes, cidades e ruas), </li><li>  elementos de endere√ßo que identificam objetos endere√ß√°veis ‚Äã‚Äã(n√∫mero e dados da casa), </li><li>  informa√ß√µes sobre terrenos </li><li>  informa√ß√µes sobre as instala√ß√µes (apartamentos, escrit√≥rios, salas, etc.), </li><li>  informa√ß√µes no documento normativo, que √© a base para a atribui√ß√£o do nome ao elemento de endere√ßo. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Bem como v√°rios dicion√°rios</b> <div class="spoiler_text"><ul><li>  uma lista de poss√≠veis valores dos intervalos das casas (regulares, pares, √≠mpares), </li><li>  uma lista de status relevantes para uma entrada de um elemento de endere√ßo pelo classificador KLADR4.0, </li><li>  uma lista de status relevantes para uma entrada de um elemento de endere√ßo de acordo com o FIAS, </li><li>  uma lista de nomes completos e abreviados dos tipos de elementos de endere√ßo e seus n√≠veis de classifica√ß√£o, </li><li>  lista de tipos de edif√≠cios, </li><li>  lista de poss√≠veis tipos de propriedade </li><li>  lista de c√≥digos de opera√ß√µes com objetos endere√ß√°veis, </li><li>  uma lista de poss√≠veis condi√ß√µes imobili√°rias, </li><li>  lista de tipos de instala√ß√µes ou escrit√≥rios, </li><li>  lista de tipos de quartos, </li><li>  lista de poss√≠veis status (centros) de objetos de endere√ßo de unidades administrativas, </li><li>  tipos de documentos regulamentares. </li></ul></div></div><br><p>  A estrutura de dados √© descrita no documento, que pode ser encontrado <a href="https://fias.nalog.ru/Updates.aspx" rel="nofollow">na se√ß√£o de atualiza√ß√µes</a> . </p><br><p>  Por fim, temos um algoritmo de instala√ß√£o FIAS bastante simples e linear: </p><br><ul><li>  obtenha do servi√ßo SOAP um link para o archive e o n√∫mero da vers√£o atual, </li><li>  arquivo de download, </li><li>  desembalar </li><li>  escreva no banco de dados todos os dados dos arquivos com o prefixo AS_, </li><li>  exclua do banco de dados todos os dados dos arquivos com o prefixo AS <em>DEL</em> (sim, isso mesmo, durante a instala√ß√£o, voc√™ tamb√©m deve excluir alguns dados), </li><li>  anote o n√∫mero da vers√£o instalada. </li></ul><br><p>  E n√£o menos simples algoritmo de atualiza√ß√£o: </p><br><ul><li>  obtenha do servi√ßo SOAP uma lista com n√∫meros de vers√£o e links para arquivos com altera√ß√µes, </li><li>  se a vers√£o atual no banco de dados local for a mais recente, pare a execu√ß√£o, </li><li>  obtenha um link para o arquivo com as altera√ß√µes para a pr√≥xima vers√£o, </li><li>  arquivo de download, </li><li>  desembalar </li><li>  escreva no banco de dados todos os dados dos arquivos com o prefixo AS_, </li><li>  remova do banco de dados todos os dados dos arquivos com o prefixo AS <em>DEL</em> , </li><li>  anote o n√∫mero da vers√£o atualizada, </li><li>  retorne ao primeiro passo. </li></ul><br><p>  O FIAS deixa impress√µes conflitantes.  Por um lado: automa√ß√£o completa de todo o processo, formatos abertos, boa documenta√ß√£o.  Por outro lado: uma decis√£o estranha de usar o RAR propriet√°rio para dados abertos;  diferen√ßas entre documenta√ß√£o e realidade (principalmente relacionadas a atributos obrigat√≥rios), que causam muitos problemas pequenos, mas desagrad√°veis;  ocasionalmente v√™m arquivos que n√£o podem ser descompactados no Linux;  alguns deltas entre vers√µes ocupam 4-5 GB. </p><br><h2 id="arhitektura">  Arquitetura </h2><br><p>  Cada biblioteca deve se basear em uma id√©ia b√°sica, um n√∫cleo em torno do qual o restante da funcionalidade crescer√°.  O padr√£o da "cadeia de deveres" me pareceu a melhor escolha para o papel de tal id√©ia.  Primeiro, √© ideal: v√°rias opera√ß√µes seq√ºenciais que uma pessoa teria feito se quisesse instalar o FIAS manualmente s√£o √≥bvias para o desenvolvedor e se encaixam bem em pequenas classes escritas no estilo SOLID.  Em segundo lugar, essa cadeia √© facilmente expandida com novas opera√ß√µes em praticamente qualquer est√°gio, o que fornece uma boa flexibilidade.  Em terceiro lugar, h√° muito tempo eu queria escrever minha pr√≥pria implementa√ß√£o. </p><br><p>  Al√©m das opera√ß√µes, criei v√°rios servi√ßos que podem ser transferidos usando o DI.  Eles permitem que voc√™ reutilize o c√≥digo, substitua facilmente a implementa√ß√£o para tarefas de sistema de baixo n√≠vel (baixar um arquivo, descompactar um arquivo morto, gravar em um banco de dados e outros) e fornecer uma boa cobertura de teste gra√ßas a zombarias. </p><br><p>  Como resultado, a biblioteca cont√©m quatro tipos principais de objetos, para cada um dos quais a √°rea de responsabilidade est√° claramente definida: </p><br><ul><li>  servi√ßos - fornece ferramentas para executar tarefas de baixo n√≠vel do sistema, </li><li>  objeto de estado - armazena informa√ß√µes para transmiss√£o entre opera√ß√µes, </li><li>  opera√ß√µes - usando os servi√ßos e declarando que implementam a parte at√¥mica da l√≥gica de neg√≥cios, </li><li>  cadeia de opera√ß√µes - realiza opera√ß√µes e transfere o estado entre elas. </li></ul><br><p>  Usando a vincula√ß√£o de opera√ß√µes e servi√ßos fornecidos pela biblioteca, voc√™ pode facilmente obter qualquer nova cadeia ou complementar a existente usando apenas arquivos de configura√ß√£o. </p><br><h2 id="freymvorki">  Frameworks </h2><br><p>  Com longos intervalos e refatora√ß√£o constante, trabalhei na biblioteca por um ano e meio. </p><br><p>  A primeira vers√£o relativamente est√°vel ficou pronta em dois meses de trabalho √† noite.  De fato, ele poderia existir separadamente da estrutura e continha tudo o que era necess√°rio: um script de entrada para executar no console, um cont√™iner de DI, um complemento sobre o PDO, suas pr√≥prias migra√ß√µes de logger e estrutura de banco de dados - das quais eu tinha muito orgulho. </p><br><p>  √â claro que seus colegas a rejeitaram sem piedade. </p><br><p>  O principal argumento contra isso foi a falta de suporte para estruturas populares.  Ningu√©m queria escrever um inv√≥lucro separado para a biblioteca.  Por causa disso, cometi o erro mais caro a tempo: comecei a dar suporte √† vers√£o aut√¥noma e aos inv√≥lucros individuais de cada estrutura.  Arquivos FIAS reais s√£o diferentes do que est√° escrito na documenta√ß√£o.  Cada vez que era necess√°rio remover ou adicionar, por exemplo, n√£o nulo na descri√ß√£o da coluna, era necess√°rio fazer altera√ß√µes em tr√™s reposit√≥rios.  Devido ao t√©dio do processo, o trabalho parou por mais seis meses. </p><br><p>  O sentimento de incompletude me atormentou todo esse tempo e depois de uma batalha sangrenta com pregui√ßa me for√ßou a voltar a criar uma nova vers√£o.  Para come√ßar, decidi que ningu√©m precisa de uma biblioteca independente, o que significa que voc√™ deve descartar todos os servi√ßos que fornecem estruturas do pacote, substituindo-os por interfaces.  Por isso, fomos √† loucura: um script de entrada para executar no console, um cont√™iner de DI, um complemento sobre o PDO, nossas pr√≥prias migra√ß√µes de logger e estrutura de banco de dados.  Em seguida, decidi criar pacotes separados para cada estrutura, que conectariam todas as partes do principal a um script de trabalho e fornecer implementa√ß√µes espec√≠ficas de servi√ßos. </p><br><p>  O ponto chave foi o modelo.  A atualiza√ß√£o constante de conjuntos heterog√™neos de objetos em v√°rios reposit√≥rios n√£o desejava.  Ao mesmo tempo, no trabalho principal, consegui um projeto no Symfony.  Ap√≥s um r√°pido conhecimento, decidi que o recurso mais √∫til do SF √© a gera√ß√£o de c√≥digo e resolver√° todos os meus problemas.  Criei um <a href="" rel="nofollow">arquivo yaml</a> no pacote principal, que cont√©m uma descri√ß√£o declarativa dos dados do FIAS.  Em seguida, adicionei geradores de c√≥digo que criam classes espec√≠ficas para modelos com base nesta descri√ß√£o: Entidades de doutrina para objetos Symfony e Eloquent para Laravel.  Durante o desenvolvimento de geradores, percebi que os modelos de galho n√£o eram adequados para isso e decidi por uma solu√ß√£o especializada - o <a href="https://github.com/nette/php-generator" rel="nofollow">Nette PHP Generator</a> . </p><br><p>  Como prova de conceito, criei pacotes para o <a href="https://github.com/liquetsoft/fias-laravel" rel="nofollow">Laravel</a> e o <a href="https://github.com/liquetsoft/fias-symfony" rel="nofollow">Symfony</a> .  J√° que trabalhei mais com o segundo, descreverei tudo subsequente em seu contexto. </p><br><h2 id="infrastruktura">  A infraestrutura </h2><br><p>  A maioria dos meus projetos de combate foi escrita em tecnologias desatualizadas, ent√£o n√£o pude usar analisadores de c√≥digo modernos em nenhum deles.  Para me livrar da opress√£o herdada, instalei e configurei todas as ferramentas de controle de qualidade de c√≥digo que pude: </p><br><ul><li>  <a href="https://github.com/vimeo/psalm" rel="nofollow">Salmo</a> para verifica√ß√£o de tipo, </li><li>  <a href="https://scrutinizer-ci.com/" rel="nofollow">Scrutinizer</a> para avalia√ß√£o geral da qualidade (ajuda <a href="https://scrutinizer-ci.com/" rel="nofollow">muito</a> com a complexidade ciclom√°tica) </li><li>  <a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer" rel="nofollow">Fixador de padr√µes de codifica√ß√£o PHP</a> para verificar o estilo do c√≥digo, </li><li>  <a href="https://github.com/sebastianbergmann/phpcpd" rel="nofollow">Detector de Copiar / Colar PHP</a> para encontrar duplicatas, </li><li>  <a href="https://github.com/sebastianbergmann/phpunit" rel="nofollow">PHPUnit</a> para executar testes de unidade. </li></ul><br><p>  Valida√ß√£o integrada no Github usando <a href="https://travis-ci.org/" rel="nofollow">Travis</a> .  Como toque final, ele adicionou um arquivo Docker para criar um ambiente de desenvolvedor local completo com um arquivo make que cont√©m os comandos b√°sicos do cont√™iner (lan√ßamento de verifica√ß√µes, testes, cria√ß√£o de modelos e outros). </p><br><h2 id="itogi-obucheniya">  Resultados de aprendizagem </h2><br><h3 id="php-7">  PHP 7 </h3><br><p>  Antes de iniciar o trabalho na biblioteca, nunca usei realmente os <a href="https://www.php.net/manual/ru/migration70.new-features.php" rel="nofollow">novos recursos do PHP 7</a> .  Eles s√£o lindos: de tipos estritos a um aumento significativo na produtividade.  Agradecimentos especiais aos desenvolvedores pelo operador coalescente nulo.  N√£o vi uma diminui√ß√£o t√£o s√©ria na base de c√≥digo ap√≥s a introdu√ß√£o de um operador. </p><br><h3 id="rar">  Rar </h3><br><p>  Surpreendentemente, no PECL havia um <a href="https://www.php.net/manual/ru/book.rar.php" rel="nofollow">pacote para trabalhar com o RAR</a> .  Normalmente, essas extens√µes n√£o s√£o confi√°veis ‚Äã‚Äãe tento evit√°-las.  Acabou sendo suspeitamente est√°vel: foi instalado no 7.2 sem problemas, conseguiu descompactar arquivos enormes de forma relativamente r√°pida e com baixo consumo de RAM (6 GB s√£o descompactados em 10 a 20 minutos, dependendo dos recursos dispon√≠veis do sistema).  Ainda temo que isso seja alguma manifesta√ß√£o da lei de Murphy. </p><br><h3 id="xmlreader">  Xmlreader </h3><br><p>  Ler arquivos xml gigantes n√£o √© uma tarefa trivial.  E novamente a extens√£o PECL veio em socorro - <a href="https://www.php.net/manual/ru/book.xmlreader.php" rel="nofollow">XmlReader</a> .  Eu n√£o percebi imediatamente todo o seu poder, mas em v√°rias abordagens o adaptei em conjunto com o <a href="https://symfony.com/doc/current/components/serializer.html" rel="nofollow">serializador Symfony</a> para obter r√°pida e economicamente dados de arquivos FIAS.  No lado da biblioteca, o objeto leitor implementa a interface do iterador, que retorna seq√ºencialmente seq√º√™ncias xml correspondentes a um registro no arquivo.  Usando o serializador Symfony, essas seq√º√™ncias s√£o convertidas em objetos.  Um arquivo de 20 GB pode ser lido em 3-4 minutos enquanto n√£o for usado mais de 50 MB de RAM. </p><br><h3 id="zapis-v-bazu-dannyh">  Gravar no banco de dados </h3><br><p>  Obviamente, comecei com matrizes associativas com dados e descri√ß√µes de tabelas volumosas.  O c√≥digo rapidamente se transformou em um hash de configura√ß√µes e classes de conversor. </p><br><p>  A magia das entidades de Doutrina mostrou como os objetos podem ser autoexplicativos.  Decidi usar a mesma abordagem, mas, ao mesmo tempo, me livre da minha pr√≥pria implementa√ß√£o de gravar dados no banco de dados usando o PDO.  Em vez disso, criei uma interface de armazenamento que descreve m√©todos para processar objetos.  Com base na classe da entidade, uma implementa√ß√£o espec√≠fica de armazenamento decide exatamente como e onde gravar os dados.  Essa abordagem facilitou a conex√£o de uma grande variedade de armazenamentos: do MySql aos arquivos csv. </p><br><h3 id="optimizaciya-vstavki-dannyh">  Otimiza√ß√£o de inser√ß√£o de dados </h3><br><p>  Interrompi a primeira importa√ß√£o depois que ela excedeu em 48 horas.  Tornou-se √≥bvio que voc√™ precisa otimizar o processo de inser√ß√£o de dados. </p><br><p>  Primeiro, mudei para as <a href="https://www.postgresql.org/docs/12/datatype-uuid.html" rel="nofollow">colunas do tipo ugid</a> para chaves prim√°rias <a href="https://www.postgresql.org/docs/12/datatype-uuid.html" rel="nofollow">incorporadas ao PostgreSql</a> .  Gravar em uma coluna uuid com um √≠ndice √© muito mais r√°pido do que gravar em uma string. </p><br><p>  Depois disso, abandonei todos os √≠ndices n√£o cr√≠ticos e chaves estrangeiras, pois a preocupa√ß√£o com a integridade dos dados est√° completamente do lado da equipe do FIAS. </p><br><p> Depois refiz a interface de armazenamento para que o script externo pudesse inform√°-lo explicitamente sobre a conclus√£o da importa√ß√£o.  Isso permitiu o uso de inser√ß√£o em massa, o que acelerou a grava√ß√£o √†s vezes.  <a href="https://www.postgresql.org/docs/current/populate.html" rel="nofollow">Procurando informa√ß√µes,</a> tamb√©m encontrei o comando <a href="https://www.postgresql.org/docs/current/sql-copy.html" rel="nofollow"><code>copy</code></a> junto com o <a href="https://www.postgresql.org/docs/current/functions-xml.html" rel="nofollow"><code>query_to_xml</code></a> .  Ele tinha duas desvantagens principais: primeiro, o usu√°rio do PostgreSql deve ter permiss√µes de leitura para o arquivo, o que eu n√£o pude garantir e, segundo, a capacidade de modificar os dados dentro do script antes de perder a grava√ß√£o. </p><br><p>  Apesar dessas altera√ß√µes, o tempo de importa√ß√£o excedeu 30 horas.  Era necess√°ria uma mudan√ßa radical de abordagem. </p><br><h3 id="parallelnye-processy">  Processos paralelos </h3><br><p>  A Internet est√° repleta de artigos sobre assincronia no PHP.  Minha escolha caiu em <a href="https://amphp.org/" rel="nofollow">Amp</a> .  Simplesmente n√£o funcionou de forma ass√≠ncrona.  Primeiro, o c√≥digo rapidamente se transformou em uma terr√≠vel lista de retornos de chamada e chamadas n√£o √≥bvias (isso provavelmente √© culpa minha, n√£o a abordagem ass√≠ncrona).  Em segundo lugar, tive que abandonar o uso de ORMs padr√£o, porque s√£o necess√°rias chamadas sem bloqueio do banco de dados por meio de uma <a href="https://github.com/amphp/mysql" rel="nofollow">estrutura especial</a> .  Em terceiro lugar, embora existam condi√ß√µes sob as quais o PostgreSql possa inserir linhas em paralelo, elas s√£o <a href="" rel="nofollow">extremamente</a> <a href="https://wiki.postgresql.org/wiki/Parallel_Query" rel="nofollow">dif√≠ceis de</a> cumprir.  Como resultado, ap√≥s 5 horas de trabalho, observei como todas as minhas solicita√ß√µes ass√≠ncronas eram for√ßosamente "sincronizadas" no lado do banco de dados. </p><br><p>  Mas a importa√ß√£o √© bem dividida em processos paralelos: v√°rias tarefas completamente independentes que n√£o possuem recursos comuns pelos quais eles poderiam competir e dados que eles poderiam trocar.  Al√©m disso, no √¢mbito de um segmento, recebi um c√≥digo bonito e linear. </p><br><p>  O primeiro eu decidi tentar a extens√£o <a href="https://www.php.net/manual/ru/book.parallel.php" rel="nofollow">Parallel</a> .  Ele tem uma falha fatal - o int√©rprete deve ser constru√≠do com suporte para ZTS (Zend Thread Safety).  Como o ZTS n√£o funciona em scripts regulares da web, seria necess√°rio ter duas vers√µes diferentes do int√©rprete.  Um, sem ZTS, para web, o segundo, com ZTS, para instala√ß√£o do FIAS.  O potencial aumento de desempenho superou esse inconveniente, principalmente considerando a facilidade de montar um novo cont√™iner Docker e us√°-lo em conjunto com o antigo.  Infelizmente, iniciar o Symfony dentro de um novo encadeamento causou um estouro na pilha do PHP, e eu n√£o estava pronto para recusar o cont√™iner de DI e a configura√ß√£o conveniente. </p><br><p>  Finalmente, encontrei o <a href="https://symfony.com/doc/current/components/process.html" rel="nofollow">processo symfony</a> .  De fato, ele inicia um novo processo para o comando do console especificado e monitora sua conclus√£o.  Eu tive que adicionar duas correntes adicionais.  O primeiro baixa o arquivo, descompacta e inicia processos paralelos para processamento de dados.  O segundo pega uma lista de arquivos do argumento da linha de comando e grava seu conte√∫do no banco de dados. </p><br><p>  Devido √† falta de experi√™ncia com processos paralelos, parece que cometi todos os erros de novato. </p><br><p>  Por exemplo, meu processo de inicializa√ß√£o verificou a conclus√£o dos filhos usando um loop infinito e, √© claro, estava gastando indecentemente muitos recursos do processador nisso.  A chamada de sono entre itera√ß√µes ajudou. </p><br><p>  Na primeira implementa√ß√£o, os arquivos foram distribu√≠dos de maneira desigual entre os processos.  Os dois maiores ca√≠ram em um fluxo, que foi processado por mais de 20 horas.  Na segunda implementa√ß√£o, adicionei um gerenciador especial que distribui arquivos com base no tempo necess√°rio para import√°-los.  Agora os processos s√£o carregados uniformemente. </p><br><p>  Ap√≥s essas edi√ß√µes, consegui importar a vers√£o completa do FIAS em 16 a 20 horas, dependendo dos recursos do servidor.  N√£o √© t√£o bom quanto gostar√≠amos, mas continuo trabalhando na otimiza√ß√£o.  O pr√≥ximo passo √© uma rejei√ß√£o completa do PostgreSql em favor da Elasticsearch. </p><br><h2 id="vyvody">  Conclus√µes </h2><br><p>  Valeu a pena?  Dois anos de trabalho em uma biblioteca que nunca entrou em nenhum projeto de combate? </p><br><p>  Sim completamente. </p><br><p>  Eu mudei de emprego de qualquer maneira.  Durante uma turn√™ de uma d√∫zia de entrevistas, respondi a muitas perguntas complicadas apenas gra√ßas ao meu projeto de estima√ß√£o. </p><br><p>  O p√¢nico de que o PHP est√° morrendo est√° constantemente se fortalecendo.  N√£o vou esconder o fato de que eu estava pensando em migrar para outro idioma. </p><br><p>  Depois que vi o enorme trabalho que a equipe do PHP colocou na vers√£o 7;  ele foi convencido pelo exemplo pessoal de qu√£o madura a linguagem se tornou e de qu√£o rico foi o ecossistema que cresceu;  Posso dizer com seguran√ßa que os rumores sobre a morte do PHP s√£o muito exagerados.  E este √© apenas o come√ßo: no futuro, estamos aguardando JIT, assincronia fora da caixa e muito mais. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt479122/">https://habr.com/ru/post/pt479122/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt479102/index.html">Familiaridade com Yandex.Maps ou Quanto Adoro Documenta√ß√£o</a></li>
<li><a href="../pt479106/index.html">Quanto custam os truques de m√°gica</a></li>
<li><a href="../pt479108/index.html">A vida de Knight - Arena online com elementos de RPG</a></li>
<li><a href="../pt479116/index.html">Impress√µes na pesquisa Y. Direto: por que voc√™ paga 1,5 vezes mais por clique</a></li>
<li><a href="../pt479120/index.html">A participa√ß√£o falhou: levamos o AgentTesla √† √°gua limpa. Parte 2</a></li>
<li><a href="../pt479124/index.html">[Infogr√°fico] Intelig√™ncia Artificial em Fic√ß√£o Cient√≠fica</a></li>
<li><a href="../pt479126/index.html">Python no desenvolvimento m√≥vel</a></li>
<li><a href="../pt479128/index.html">Como funciona o servi√ßo m√©dico do aeroporto</a></li>
<li><a href="../pt479132/index.html">Componente externo para a plataforma m√≥vel 1C (BroadcastReceiver)</a></li>
<li><a href="../pt479136/index.html">Computa√ß√£o qu√¢ntica: o fim da blockchain?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>