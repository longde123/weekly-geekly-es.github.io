<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç∂ üë©‚Äçüè´ üßìüèª Adaptation de programmes pour ZX Spectrum √† TR-DOS par des moyens modernes. Partie 1 üêµ üë©üèº‚Äçü§ù‚Äçüë©üèª üöú</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Contrairement aux ordinateurs modernes, sur le spectre, le concept d'un syst√®me de fichiers n'√©tait pas en tant que tel. Cela signifie que le t√©l√©char...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Adaptation de programmes pour ZX Spectrum √† TR-DOS par des moyens modernes. Partie 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451174/"><p>  Contrairement aux ordinateurs modernes, sur le spectre, le concept d'un syst√®me de fichiers n'√©tait pas en tant que tel.  Cela signifie que le t√©l√©chargement √† partir de chaque type de support n√©cessitait une impl√©mentation distincte et, dans la plupart des cas, le programme ne pouvait pas simplement √™tre copi√© d'une bande sur un disque.  Dans les cas o√π le chargeur de programme a √©t√© √©crit en BASIC, il pourrait √™tre adapt√© √† TR-DOS avec une r√©vision assez simple.  Cependant, la situation √©tait compliqu√©e par le fait que dans de nombreux jeux (√† la fois de marque et pirat√©s), les chargeurs √©taient √©crits dans des codes machine et contenaient parfois une protection contre la copie. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/d31/cb0/62d/d31cb062dbd020dbb43d9379fc640042.jpg" alt="5.25 &quot;Floppy"></p><br><p> Malgr√© la pr√©sence d'un ¬´bouton magique¬ª qui faisait simplement un vidage complet de la m√©moire de l'ordinateur et permettait de sauvegarder le programme sur une disquette, les experts ont envisag√© de cr√©er des versions de disque des jeux tout en pr√©servant l'image de d√©marrage d'origine et d'autres attributs. </p><br><p>  Dans cet article, je vais vous expliquer comment effectuer une telle adaptation sur l'exemple du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">jeu Pac-Man</a> , √† savoir l'image originale <a href="">Pac-Man.tzx</a> . </p><a name="habracut"></a><br><h2 id="instrumenty">  Les outils </h2><br><p>  Malgr√© le fait qu'auparavant tout ce travail √©tait effectu√© directement sur le ZX Spectrum (en l'absence d'autres options), j'adapterai le jeu en utilisant l'√©mulateur et les utilitaires de ligne de commande.  La raison principale est que, surtout au d√©but, le processus d'adaptation consiste en un grand nombre d'essais et d'erreurs, et cela se passe beaucoup moins douloureusement s'il est automatis√©.  Tout de m√™me peut se faire directement sur le Spectrum. </p><br><p>  Dans la premi√®re partie, nous utiliserons les outils suivants: </p><br><ol><li>  √âmulateur de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fusible</a> pour le d√©bogage et les tests. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SkoolKit</a> pour le d√©montage. </li></ol><br><h2 id="otklyuchenie-avtozapuska-v-zagruzchike">  D√©sactiver le d√©marrage dans le chargeur de d√©marrage </h2><br><p>  √âtant donn√© que le fichier image et donn√©es est t√©l√©charg√© sans bloc d'en-t√™te (17 octets avec le nom et le type de fichier), cela signifie que le chargeur est √©crit en codes machine.  Vous devez trouver o√π se trouvent ces codes et √† quelle adresse ils sont lanc√©s. </p><br><p>  Il existe plusieurs fa√ßons d'examiner le code du chargeur de d√©marrage: </p><br><ol><li><p> Le moyen le plus simple consiste √† d√©marrer le t√©l√©chargement du programme, √† attendre le d√©marrage du chargeur de d√©marrage et √† l'arr√™ter en appuyant sur la touche <code>Space</code> .  Dans de nombreux cas, cela fonctionne, mais dans le cas de Pacman, comme dans de nombreux autres, cela conduit √† une r√©initialisation. </p><br></li><li><p>  La prochaine fa√ßon consiste √† charger le programme en utilisant <code>MERGE ""</code> au lieu de <code>LOAD ""</code> .  Contrairement √† <code>LOAD</code> , <code>MERGE</code> ignore l'ex√©cution automatique du programme.  Dans le cas de Pac-Man, le d√©marrage via <code>MERGE</code> provoque le gel de l'ordinateur avec un d√©calage d'√©cran gauche caract√©ristique.  Cela est d√ª au fait qu'au lieu d'ex√©cuter le programme ligne par ligne, <code>MERGE</code> essaie de l'analyser dans son int√©gralit√© et de le fusionner avec le programme d√©j√† charg√©.  Cependant, si le programme a un bloc avec des codes machine qui viole la syntaxe du programme, cela entra√Ænera un plantage. </p><br></li><li><p>  Si vous ne voulez pas vous <code>listbasic</code> la <code>listbasic</code> , vous pouvez convertir l'image de bande de TZX en TAP et utiliser l'utilitaire <code>listbasic</code> fourni avec Fuse: </p><br><pre> <code class="plaintext hljs">$ tzx2tap Pac-Man.tzx $ listbasic Pac-Man.tap 1 RANDOMIZE USR (PEEK 23635+256*PEEK 23636+91)</code> </pre> <br><p>  L'adresse <code>23635</code> ( <code>$5C53</code> ) correspond √† la variable syst√®me <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>PROG</code></a> , qui contient l'adresse de d√©part de la zone BASIC.  Ainsi, le point d'entr√©e du chargeur de d√©marrage est d√©cal√© de 91 octets par rapport √† la zone BASIC. </p><br></li><li><p>  Une autre fa√ßon de regarder le chargeur de d√©marrage est d√©crite dans l'article <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Desativando a autoexecu√ß√£o de um programa BASIC</a> .  Dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le d√©bogueur Fuse,</a> vous devez d√©finir un point d'arr√™t <code>br 2053</code> , charger le programme, et lorsque le t√©l√©chargement se termine et que l'ex√©cution du code s'arr√™te, ex√©cutez <code>set 23619 128</code> .  Cela emp√™chera le d√©marrage du programme et vous permettra de quitter BASIC. </p><br></li></ol><br><h2 id="dizassemblirovanie-zagruzchika">  D√©montage du chargeur de d√©marrage </h2><br><p>  Connaissant le d√©calage du point d'entr√©e par rapport √† la zone BASIC, vous pouvez calculer son adresse absolue.  Dans le cas du ZX Spectrum 48K sans TR-DOS charg√©, la zone BASIC commence √† <code>23755</code> ( <code>$5CCB</code> ).  Par cons√©quent, le chargeur de d√©marrage d√©marrera √† <code>23755 + 91 = 23846</code> ( <code>$5D26</code> ). </p><br><p>  Pour commencer, il suffit de mettre un point d'arr√™t √† l'adresse de d√©part et de consulter les codes machine.  Dans Fuse, vous pouvez cr√©er <code>br 23846</code> et commencer √† t√©l√©charger le programme.  D√®s que le bootloader commence √† s'ex√©cuter, l'√©mulateur s'arr√™te: </p><br><p><img src="https://habrastorage.org/webt/g7/8k/ih/g78kihkxufy7bakgg9qey9a0d7c.png" alt="D√©bogueur"></p><br><p>  Dans le cas o√π le chargeur est tr√®s simple, il suffit de regarder le code d√©mont√© dans le panneau du milieu et de comprendre ce qui est charg√©.  En r√®gle g√©n√©rale, le code de t√©l√©chargement d'un fichier sans en-t√™te ressemble √† ceci: </p><br><pre> <code class="plaintext hljs">LD IX, $8000 ;    LD DE, $4000 ;    LD A, $FF ;    CALL $0556 ;  LD-BYTES JP $8000 ;   </code> </pre> <br><p>  Dans un cas plus complexe avec l'ex√©cution de code, vous devez comprendre les √©tapes et prendre des notes.  La suite d'utilitaires <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SkoolKit</a> est bien adapt√©e √† cela.  Si vous vous fixez un objectif, avec son aide, le jeu peut √™tre analys√© jusqu'√† la derni√®re vis (message, sprite, son).  La proc√©dure √† suivre est d√©crite en d√©tail dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> . </p><br><p>  En bref, proc√©dez comme suit: </p><br><ol><li>  Faites un instantan√© de la m√©moire de l'ordinateur <code>Pac-Man.z80</code> utilisant <code>tap2sna.py</code> ou les fonctionnalit√©s de l'√©mulateur. </li><li>  Cr√©ez un fichier de contr√¥le <code>Pac-Man.ctl</code> avec un ensemble initial d'instructions pour le d√©montage: <br><pre> <code class="plaintext hljs">i 16384 Ignore for now c $5D26 Loader</code> </pre> </li><li>  Ex√©cuter le d√©montage: <code>sna2skool.py -H -c Pac-Man.ctl Pac-Man.z80 &gt; Pac-Man.skool</code> . </li><li>  Pendant que vous √©tudiez le code, ajoutez de nouvelles instructions et de nouveaux commentaires au fichier de contr√¥le. </li><li>  R√©p√©tez jusqu'√† ce que compl√®tement √©clair√©. </li></ol><br><p>  En cons√©quence, apr√®s le premier passage, nous obtenons ce qui suit (mes commentaires, les adresses sont omises): </p><br><pre> <code class="plaintext hljs">ORG $5D26 ;   23846,   ;   DI IM 1 ;   LD D, IYh ; LD E, IYl ; LD B, $25 ;    EX DE, HL ; LD DE, $0019 ; ADD HL, DE ;    HL  $5C53 (  PROG) LD E, (HL) ;   PROG  DE  IX INC HL ; LD D, (HL) ; LD IXh, D ; LD IXl, E ; LD A, (IX+$7F) ;      (  $7F-  ;  PROG) LD HL, $0035 ;    ($35   PROG) ADD HL, DE ; PUSH HL ;      XOR (HL) ;    LD (HL), A ; INC HL ; DJNZ $5D43 ;   AND (HL) ; RET NZ ;           ;    DEFB $77</code> </pre> <br><h2 id="rasshifrovka-zagruzchika">  D√©chiffrement du chargeur de d√©marrage </h2><br><p>  Tout ce qui est vraiment important, c'est que le chargeur de d√©marrage d√©chiffr√© se trouve √† <code>PROG + $35</code> .  Cela signifie que si nous mettons un point d'arr√™t sur le <code>br 23808</code> , √† ce moment le d√©cryptage sera termin√©, nous verrons le chargeur de d√©marrage d√©crypt√©: </p><br><p><img src="https://habrastorage.org/webt/to/qq/4b/toqq4bfw1kqi5vzbmbvzmlno0e8.png" alt="Chargeur"></p><br><p>  Ce programme est d√©j√† beaucoup plus similaire au cas typique mentionn√© ci-dessus.  La valeur <code>$4000</code> ( <code>16384</code> ) est charg√©e dans les registres <code>IX</code> et <code>DE</code> , quelque chose d'autre est fait et le contr√¥le est transf√©r√© √† la routine ROM √† <code>$055A</code> (c'est quelques octets de moins que le point d'entr√©e standard dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>LD-BYTES</code></a> ).  Il semble que cette approche impl√©mente une sorte de protection contre la copie, car  la proc√©dure standard ne charge pas ce fichier et certains copistes ne le comprennent pas. </p><br><h2 id="tochka-vhoda-v-programmu">  Point d'entr√©e du programme </h2><br><p>  Il reste √† comprendre comment le programme est appel√© apr√®s le chargement.  Au lieu des <code>CALL LD-BYTES</code> et <code>JP</code> habituels, <code>LD SP, XXXX</code> et <code>JP LD-BYTES</code> sont utilis√©s ici.  La premi√®re option (habituelle) fonctionne comme suit: </p><br><ol><li>  <code>CALL</code> pousse la valeur actuelle du compteur logiciel ( <code>PC</code> ) sur la pile. </li><li>  Le contr√¥le est pass√© √† la routine appel√©e. </li><li>  Lors du retour d'un sous-programme ( <code>RET</code> ), la valeur est supprim√©e de la pile et une transition vers le programme appelant se produit. </li></ol><br><p>  Pourquoi est-ce fait diff√©remment ici?  Le fait est que Pac-Man est compatible avec le ZX Spectrum 16K et occupe absolument toute la RAM (voir la taille du fichier ci-dessus).  Ainsi, lors du chargement, le programme √©crase lui-m√™me le chargeur et la pile, o√π qu'ils se trouvent.  Si nous voulions passer de la ROM au chargeur de d√©marrage √† l'aide de la pile, puis appeler le programme t√©l√©charg√© via <code>JP</code> , au moment o√π le t√©l√©chargement √©tait termin√©, il n'y aurait pas de m√©moire dans l'adresse √† laquelle se trouvait <code>JP</code> . </p><br><p>  Au lieu de cela, le pointeur de pile se d√©place vers la zone de m√©moire o√π, apr√®s le chargement, l'adresse du point d'entr√©e du programme appara√Æt et le processeur, sans remarquer l'usurpation d'identit√©, la supprime de la pile par le nouveau pointeur et va √† l'adresse sp√©cifi√©e. </p><br><p>  Le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©sultat</a> complet du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©sassemblage</a> peut √™tre consult√© dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le r√©f√©rentiel du projet</a> sur le github. </p><br><h2 id="itogo">  Total </h2><br><p>  √Ä la suite de l'√©tude du chargeur de d√©marrage, nous avons d√©couvert ce qui suit: </p><br><ol><li>  Un fichier sans en-t√™te d'une longueur de 16384 octets est t√©l√©charg√© √† 16384 (dans la zone d'√©cran, ce qui est g√©n√©ralement √©vident pendant le processus de t√©l√©chargement). </li><li>  √Ä la fin du t√©l√©chargement, le pointeur de pile est situ√© √† <code>$5D7C</code> , o√π le contr√¥le est transf√©r√©. </li></ol><br><p>  Dans les parties suivantes, je parlerai de la fa√ßon de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pr√©parer les fichiers</a> pour l'√©criture sur le disque et d'√©crire un chargeur de fichiers monobloc dans l'assembleur. </p><br><h3 id="ssylki-po-teme">  Liens connexes: </h3><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Profil "Spectateur de TRUB</a> . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">R√©tro-ing√©nierie des jeux ZX Spectrum (Z80)</a> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Adapta√ß√£o de jogos de fita para Beta 48</a> . </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr451174/">https://habr.com/ru/post/fr451174/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr451162/index.html">Correction d'erreurs - Constantes physiques dans les versions actuelles et nouvelles du syst√®me international d'unit√©s (SI)</a></li>
<li><a href="../fr451164/index.html">Vous cherchez un espace de stationnement gratuit avec Python</a></li>
<li><a href="../fr451166/index.html">Qu'offriront les nouveaux r√©f√©rentiels pour les syst√®mes AI et MO?</a></li>
<li><a href="../fr451170/index.html">Jeff Bezos a annonc√© son intention de conqu√©rir la lune</a></li>
<li><a href="../fr451172/index.html">Julia: fonctions et structures en tant que fonctions</a></li>
<li><a href="../fr451176/index.html">Nouvelles du monde d'OpenStreetMap n ¬∞ 458 (23/04/2019 - 09/09/2019)</a></li>
<li><a href="../fr451178/index.html">Essai de collision de l'atterrissage du parachute de l'√©quipage du dragon</a></li>
<li><a href="../fr451180/index.html">PCB remplace deux moteurs lin√©aires</a></li>
<li><a href="../fr451182/index.html">Comment les tailles des tableaux C sont devenues une partie de l'interface binaire de la biblioth√®que</a></li>
<li><a href="../fr451184/index.html">Blue Origin Blue Moon Project: les gens sur la Lune d'ici 2024</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>