<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÇüèº ü§∞üèº üë®‚Äçüåæ Wir √ºberwachen aktive Sitzungen von PostgreSQL 10 wie in Oracle ü¶ê üÜë üà∏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dieses Tool wurde aus sportlichen Gr√ºnden geschrieben, als ich feststellte, dass die Ansicht pg_stat_activity in PostgreSQL 10 die Felder wait_event_t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wir √ºberwachen aktive Sitzungen von PostgreSQL 10 wie in Oracle</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/413411/"><img src="https://habrastorage.org/webt/cf/oq/am/cfoqamnhzl-kk2e5sn4spofkjqg.png" alt="Bild"><br><br>  Dieses Tool wurde aus sportlichen Gr√ºnden geschrieben, als ich feststellte, dass die Ansicht pg_stat_activity in PostgreSQL 10 die Felder wait_event_type und wait_event enth√§lt, die im Wesentlichen der wait_class und dem Ereignis aus v $ session sehr √§hnlich sind. <br><br>  Ich habe gerade aktiv mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">dem</a> ASH-Viewer-Programm von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">akardapolov gearbeitet und</a> war gespannt, wie schwierig es ist, dieses Produkt unter Postgres neu zu schreiben.  Da ich kein professioneller Entwickler bin, war es nicht einfach, aber sehr interessant.  Dabei habe ich sogar einige signifikante Fehler gefunden, die sowohl im Originalprogramm f√ºr Oracle als auch f√ºr die Standard Edition auftreten. <br><br><h4>  Die Prinzipien von PASH-Viewer: </h4><br><a name="habracut"></a>  Keine Erweiterungen erforderlich.  Wir beziehen Daten ausschlie√ülich aus der integrierten Ansicht pg_stat_activity. <br><br>  Einmal pro Sekunde wird eine Anfrage f√ºr aktive Sitzungen gestellt: <br><br><div class="spoiler">  <b class="spoiler_title">pg_stat_activity Anfragetext</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current_timestamp</span></span>, datname, pid, usesysid, usename, application_name, backend_type, <span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(client_hostname, client_addr::<span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, <span class="hljs-string"><span class="hljs-string">'localhost'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> client_hostname, wait_event_type, wait_event, <span class="hljs-keyword"><span class="hljs-keyword">query</span></span>, query_start, <span class="hljs-number"><span class="hljs-number">1000</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">EXTRACT</span></span>(EPOCH <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (clock_timestamp()-query_start)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">duration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pg_stat_activity <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> state=<span class="hljs-string"><span class="hljs-string">'active'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> pid != pg_backend_pid();</code> </pre> </div></div><br>  Einmal alle 15 Sekunden werden die Daten f√ºr die letzten 15 Bilder gemittelt und in einem Diagramm angezeigt. <br><br>  Die SQL-ID, die zum Gruppieren der Abfragen im Abschnitt Top SQL ben√∂tigt wird, die ich selbst generiere, hat nichts mit der Abfrage-ID von pg_stat_statements zu tun.  Ich habe √ºberlegt, wie ich queryid verwenden soll, aber leider habe ich keine M√∂glichkeit gefunden, Abfragen aus diesen beiden Ansichten abzugleichen.  Es w√§re gro√üartig, wenn die Entwickler das Feld queryid zu pg_stat_activity hinzuf√ºgen w√ºrden. <br><br>  SQL-ID = die ersten 13 Zeichen von md5 (normalisierter Abfragetext). <br><br>  Ein normalisierter Abfragetext ist eine Abfrage, bei der Zeilenumbr√ºche und zus√§tzliche Leerzeichen entfernt und Literale durch $ 1, $ 2 usw. ersetzt werden. Es war schwierig f√ºr mich, eine gute Funktion zur Normalisierung von Abfragen zu schreiben.  Ich habe einen schlechten geschrieben.  Ich zitiere den Text, aber bitte schau ihn dir nicht an, sonst sch√§me ich mich.  Schicken Sie besser einen guten. <br><br><div class="spoiler">  <b class="spoiler_title">NormalizeSQL</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NormalizeSQL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String sql)</span></span></span><span class="hljs-function"> </span></span>{ sql = sql.replaceAll(<span class="hljs-string"><span class="hljs-string">"\\n"</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>); sql = sql.replaceAll(<span class="hljs-string"><span class="hljs-string">"\\("</span></span>, <span class="hljs-string"><span class="hljs-string">" ( "</span></span>); sql = sql.replaceAll(<span class="hljs-string"><span class="hljs-string">"\\)"</span></span>, <span class="hljs-string"><span class="hljs-string">" ) "</span></span>); sql = sql.replaceAll(<span class="hljs-string"><span class="hljs-string">","</span></span>, <span class="hljs-string"><span class="hljs-string">" , "</span></span>); sql = sql.replaceAll(<span class="hljs-string"><span class="hljs-string">"'"</span></span>, <span class="hljs-string"><span class="hljs-string">" ' "</span></span>); sql = sql.replaceAll(<span class="hljs-string"><span class="hljs-string">"="</span></span>, <span class="hljs-string"><span class="hljs-string">" = "</span></span>); sql = sql.replaceAll(<span class="hljs-string"><span class="hljs-string">"&lt;"</span></span>, <span class="hljs-string"><span class="hljs-string">" &lt; "</span></span>); sql = sql.replaceAll(<span class="hljs-string"><span class="hljs-string">"&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">" &gt; "</span></span>); sql = sql.replaceAll(<span class="hljs-string"><span class="hljs-string">";"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>); sql = sql.replaceAll(<span class="hljs-string"><span class="hljs-string">"[ ]+"</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>); sql = sql.replaceAll(<span class="hljs-string"><span class="hljs-string">"&gt; ="</span></span>, <span class="hljs-string"><span class="hljs-string">"&gt;="</span></span>); sql = sql.replaceAll(<span class="hljs-string"><span class="hljs-string">"&lt; ="</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;="</span></span>); sql = sql.toLowerCase().trim(); String[] array = sql.split(<span class="hljs-string"><span class="hljs-string">" "</span></span>, -<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> var_number = <span class="hljs-number"><span class="hljs-number">0</span></span>; String normalized_sql = <span class="hljs-string"><span class="hljs-string">""</span></span>; Boolean quote_flag = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; array.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (array[i].equals(<span class="hljs-string"><span class="hljs-string">"'"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!quote_flag) { quote_flag = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; var_number++; normalized_sql += <span class="hljs-string"><span class="hljs-string">"$"</span></span> + var_number + <span class="hljs-string"><span class="hljs-string">" "</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { quote_flag = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (quote_flag) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (array[i].matches(<span class="hljs-string"><span class="hljs-string">"-?\\d+(\\.\\d+)?"</span></span>)) { var_number++; normalized_sql += <span class="hljs-string"><span class="hljs-string">"$"</span></span> + var_number + <span class="hljs-string"><span class="hljs-string">" "</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (array[i].equals(<span class="hljs-string"><span class="hljs-string">"order"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = i; j &lt; array.length; j++) { normalized_sql += array[j] + <span class="hljs-string"><span class="hljs-string">" "</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> normalized_sql.trim(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { normalized_sql += array[i] + <span class="hljs-string"><span class="hljs-string">" "</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> normalized_sql.trim(); }</code> </pre></div></div><br>  Es war schwierig, den Abfrageausf√ºhrungsplan zu vervollst√§ndigen.  Zu Oracle kommen Sie und sagen: "Geben Sie mir einen Plan f√ºr sqlid = ...", und er antwortet Ihnen: "Haben Sie den neuesten oder den letzten oder zeigen Sie alles f√ºr den letzten Monat mit Ausf√ºhrungsstatistiken f√ºr jeden?"  Und PostgreSQL antwortet Ihnen: "Was ist sqlid?". <br><br>  Daher senden wir f√ºr Abfragen der Form SELECT / UPDATE / INSERT / DELETE den Befehl EXPLAIN an die Datenbank und speichern das Ergebnis lokal.  Wir machen das nicht mehr als 1 Mal pro Stunde.  W√§hrend des Debuggens wurde festgestellt, dass EXPLAIN auf dieselbe Weise an der Sperre h√§ngt, wie die Anforderung selbst h√§ngen w√ºrde, f√ºr die wir den Plan wissen m√∂chten.  Daher musste ich setQueryTimeout (1) hinzuf√ºgen. <br><br>  Dies funktioniert nur, wenn die Anforderung in derselben Datenbank ausgef√ºhrt wurde, mit der Sie eine Verbindung hergestellt haben (angegeben bei der Konfiguration der Verbindung).  Und nur, wenn Sie unter dem Superuser (postgres) eine Verbindung zur Datenbank hergestellt haben, vor der einige m√∂glicherweise Angst haben.  Daher k√∂nnen Sie einen speziellen Benutzer f√ºr die √úberwachung erstellen.  Alles au√üer der Anzeige von Pl√§nen wird funktionieren. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> pgmonuser <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> <span class="hljs-string"><span class="hljs-string">'pgmonuser'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> pg_monitor <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> pgmonuser;</code> </pre><br>  Download von GitHub: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://github.com/dbacvetkov/PASH-Viewer/releases</a> <br><br>  <b>UPD:</b> <br>  In Version 0.3 wurde die Unterst√ºtzung f√ºr PostgreSQL 9.6 (es gibt nur zwei wartende Klassen - Lock und LWLock, alles andere wie "CPU") und PostgreSQL 9.4 - 9.5 (es wartet entweder eine CPU oder Lock im Allgemeinen) hinzugef√ºgt. <br>  In Version 0.3.1 wurde das Feld Backend-Typ in Top-Sitzungen hinzugef√ºgt und die wei√üen Balken im Diagramm wurden entfernt. <br>  In Version 0.3.2 wurden die Arbeit mit Pl√§nen verbessert, einige Statistiken zu Anforderungen (AVG-Dauer, Anzahl der Anrufe) und die M√∂glichkeit zum Anzeigen historischer Daten hinzugef√ºgt: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">How-to-create-pg_stat_activity-history-table</a> . <br><br>  Danke und Gr√º√üe: <br>  Alexander Kardapolov f√ºr ASH-Viewer. <br>  Anton Glushakov zur Beratung und Pr√ºfung. <br>  Dmitry Rudopysov f√ºr die Erkl√§rung, wie das von github heruntergeladene Projekt kompiliert und ausgef√ºhrt wird. <br><br><h4>  Weitere Folien: </h4><br><img src="https://habrastorage.org/webt/f2/4s/yt/f24sytk_inxgiav3wuajcjjifro.png" alt="Bild"><br><br><img src="https://habrastorage.org/webt/1k/gg/d-/1kggd-5didlnncoeyuoezmuvg3i.png" alt="Bild"><br><br><img src="https://habrastorage.org/webt/lw/yp/kg/lwypkg-wu4timhbp6ge7p3nf8ok.png" alt="Bild"></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de413411/">https://habr.com/ru/post/de413411/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de413401/index.html">IOS AR Frameworks: Welches soll man w√§hlen?</a></li>
<li><a href="../de413403/index.html">Intel Core i7-8086K - 5-GHz-Jubil√§umsprozessor</a></li>
<li><a href="../de413405/index.html">Die besten B√ºcher, Artikel und Ressourcen f√ºr Anf√§ngerprodukte: Autoren von Produkttelegrammkan√§len beraten</a></li>
<li><a href="../de413407/index.html">Attributionsmethoden in g√§ngigen Trackern: Ger√§te-ID-Matching, Referrer installieren und Fingerabdruck</a></li>
<li><a href="../de413409/index.html">Amazon Kubernetes (EKS) ver√∂ffentlicht</a></li>
<li><a href="../de413413/index.html">√úbersicht √ºber die Symfony-Komponenten: Konfig</a></li>
<li><a href="../de413415/index.html">Adaptive Parallelit√§tslimits in Netflix</a></li>
<li><a href="../de413417/index.html">Energieeffizienz: Die Ans√§tze, die wir in Russland testen</a></li>
<li><a href="../de413419/index.html">PostgreSQL News Digest. Ausgabe Nr. 7</a></li>
<li><a href="../de413421/index.html">M√∂gliche Unsicherheiten in der Karriere eines Programmierers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>