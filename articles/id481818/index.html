<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚍 👏🏽 🍧 Memigrasi server yang sedang berjalan ke RAID 📅 👍🏻 🆘</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sekali waktu ada server LAMP di Ubuntu 12,04 yang bekerja pada satu drive. Karenanya, muncul masalah untuk memastikan transfer server ke konfigurasi y...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Memigrasi server yang sedang berjalan ke RAID</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481818/">  Sekali waktu ada server LAMP di Ubuntu 12,04 yang bekerja pada satu drive.  Karenanya, muncul masalah untuk memastikan transfer server ke konfigurasi yang lebih toleran terhadap kesalahan - RAID1.  Kawan-kawan yang bertanggung jawab atas server ini menginstal disk kedua, dan sisanya ditugaskan kepada saya, dan akses ke server hanya melalui ssh, yang mempersulit tugas. <br><br>  Setelah mencari, <a href="http://help.ubuntu.ru/wiki/migrate-to-raid">panduan</a> ditemukan dan pelatihan dimulai di mesin virtual.  Ketika saya mencapai hasil yang diinginkan, dengan beberapa kegembiraan, tetapi saya berhasil mentransfer server yang disebutkan sebelumnya ke RAID1 dan membuat langkah-langkah yang diperlukan sebelumnya.  Saya memutuskan untuk menempatkan artikel di mana proses transfer dijelaskan secara lebih rinci tentang "Habr". <br><a name="habracut"></a><br>  Rincian disk adalah sebagai berikut: <br><br><pre><code class="bash hljs">/dev/sda1 2048 1574911 786432 swap /dev/sda2 * 1574912 16254975 7340032 / /dev/sda3 16254976 31457279 7601152 /home</code> </pre> <br>  Karena disk kedua adalah baru, tidak ada operasi yang diperlukan untuk menghapus partisi sebelumnya. <br><br>  Hal-hal pertama diubah di <code>/etc/default/grub</code> : <br>  GRUB_TIMEOUT = 5 (memperpendek batas waktu); <br>  GRUB_RECORDFAIL_TIMEOUT = 10 (tambahkan sehingga sistem dapat melakukan boot jika terjadi kesalahan, tanpa memerlukan intervensi interaktif; batas waktu sesuai selera); <br>  GRUB_CMDLINE_LINUX_DEFAULT = "bootdegraded" (pastikan untuk menambahkan "bootdegraded" sehingga sistem dapat boot dari array yang lebih rendah); <br>  # GRUB_HIDDEN_TIMEOUT_QUIET = true (harus dikomentari agar menu GRUB selalu ditampilkan). <br><br>  Nonaktifkan swap untuk sementara, atur fdisk ke partisi / dev / sda1 menggunakan fdisk (Linux raid autodetect), lalu partisi disk kedua sama dengan yang pertama (semua operasi dilakukan dengan hak pengguna super): <br><br><pre> <code class="bash hljs">sfdisk –d /dev/sda | sfdisk –f /dev/sdb</code> </pre> <br>  Kemudian kita mulai membangun RAID kita langkah demi langkah: <br><br><pre> <code class="bash hljs">mdadm --create --verbose /dev/md0 --raid-devices=2 --level=1 --metadata=1.2 /dev/sda1 /dev/sdb1</code> </pre> <br>  Buat bagian di bawah <code>swap</code> : <pre> <code class="bash hljs">mkswap /dev/md0</code> </pre> <br>  Kami memperbaiki <code>/etc/fstab</code> , mengganti partisi disk pertama dengan partisi RAID dan mengubah angka di kolom keenam (kebutuhan untuk memeriksa fsck) menjadi nol: <br><br><pre> <code class="bash hljs">/dev/sda1 → /dev/md0 <span class="hljs-comment"><span class="hljs-comment"># SWAP /dev/sda2 → /dev/md1 # / /dev/sda3 → /dev/md2 # /home</span></span></code> </pre> <br>  Aktifkan <code>swap</code> : <pre> <code class="bash hljs">swapon -a</code> </pre> <br>  Karena server kami saat ini bekerja pada disk pertama, kami membuat RAID menggunakan sejauh ini hanya disk kedua: <br><br><pre> <code class="bash hljs">mdadm --create --verbose /dev/md1 --raid-devices=2 --level=1 --metadata=1.2 missing /dev/sdb2 mkfs.ext4 /dev/md1 mdadm --create --verbose /dev/md2 --raid-devices=2 --level=1 --metadata=1.2 missing /dev/sdb3 mkfs.ext4 /dev/md2</code> </pre> <br>  Memperbarui konfigurasi <code>mdadm.conf</code> : <br><br><pre> <code class="bash hljs">mdadm --examine --scan &gt;&gt; /etc/mdadm/mdadm.conf</code> </pre> <br>  <code>initramfs</code> sehingga <code>initramfs</code> informasi tentang RAID kami: <br><br><pre> <code class="bash hljs">update-initramfs -u</code> </pre> <br>  Selanjutnya, proses terlama dimulai - sinkronisasi data.  Karena server kami melakukan beberapa tugas, mungkin ternyata setelah sinkronisasi selesai, bagian dari informasi pada bagian array akan berbeda dari data pada bagian yang sesuai dari disk yang berfungsi.  Ada beberapa opsi: Anda dapat memilih waktu pemuatan yang paling sedikit, Anda dapat menghentikan bagian dari layanan selama sinkronisasi, atau Anda dapat mengabaikan perbedaan.  Secara umum, kami memasang dan menyinkronkan: <br><br><pre> <code class="bash hljs">mount /dev/md1 /mnt/ &amp;&amp; [tmux|screen] rsync -axu / /mnt mount /dev/md2 /mnt/home &amp;&amp; [tmux|screen] rsync -axu /home/ /mnt/home</code> </pre> <br>  Agar sinkronisasi tidak terputus karena gangguan tak terduga pada koneksi ssh, penggunaan terminal multiplexer tidak akan menghalangi. <br><br>  Setelah menunggu akhir sinkronisasi, pasang direktori sistem ke root baru: <br><br><pre> <code class="bash hljs">mount --<span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> /proc /mnt/proc mount --<span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> /dev /mnt/dev mount --<span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> /var /mnt/var mount --<span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> /run /mnt/run mount --<span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> /sys /mnt/sys</code> </pre> <br>  Kami pindah ke sistem baru <pre> <code class="bash hljs">chroot /mnt</code> </pre>  dan instal bootloader pada kedua disk <br><br><pre> <code class="bash hljs">grub-install -–recheck /dev/sda grub-install --recheck /dev/sdb</code> </pre> <br>  Kami memperbarui konfigurasi boot untuk memuat modul yang diperlukan untuk RAID ( <code>mdraid1x</code> ): <br><br><pre> <code class="bash hljs">update-grub</code> </pre> <br>  Kami kembali ke sistem asli dan, jika perlu, menyinkronkan kembali bagian-bagian: <br><br><pre> <code class="bash hljs">[tmux|screen] rsync -axu / /mnt [tmux|screen] rsync -axu /home/ /mnt/home</code> </pre> <br>  Karena kami tidak memiliki akses fisik ke konsol atau server dan kami tidak dapat memilih disk tempat RAID akan boot, kami menggunakan trik ini: kami mentransfer konfigurasi bootloader yang telah disiapkan ke disk tempat sistem memulai dan yang tidak di RAID Siapa yang tahu tentang RAID.  Salin grub.cfg dari disk yang terletak di RAID ke disk boot kami saat ini.  Ini akan memungkinkan sistem untuk memulai dengan / dev / sda, tetapi pasang array dan lanjutkan boot dari partisi yang sudah ada di RAID.  Pertama, simpan file lama, yang mungkin diperlukan ketika mengembalikan sistem jika tidak mungkin untuk boot dari RAID, dan kemudian salin file konfigurasi "tempur": <br><br><pre> <code class="bash hljs">cp -p /boot/grub/grub.cfg /boot/grub/grub.old cp -p /mnt/boot/grub/grub.cfg /boot/grub/grub.cfg</code> </pre> <br>  Selain itu, Anda dapat membandingkan file-file ini dan memastikan bahwa dalam file konfigurasi bootloader baru, partisi root terdaftar sebagai RAID. <br><br>  Sekarang kita beralih ke tahap paling penting dari pekerjaan yang dilakukan dan reboot.  Anda dapat mulai melakukan <code>ping</code> ke server di konsol sehingga menjadi jelas kapan server akan tersedia lagi.  Kami masuk dan melihat bahwa semuanya ternyata seperti yang kami inginkan: <code>lsblk</code> menunjukkan bahwa direktori <code>/</code> dan <code>/home</code> berada di partisi RAID. <br><br>  Pekerjaan yang mudah dan menyenangkan tetap untuk pembuka - tambahkan dua partisi dari disk pertama ke array, setelah mengaturnya dengan <code>fdisk</code> mengetik <b>fd</b> : <br><br><pre> <code class="bash hljs">mdadm /dev/md1 --add /dev/sda2 mdadm /dev/md2 --add /dev/sda3</code> </pre> <br>  dan kemudian secara berkala melihat bagaimana sinkronisasi mirror berlangsung: <br><br><pre> <code class="bash hljs">watch -n 5 cat /proc/mdstat</code> </pre> <br>  Biarkan saya selesai di sini, terima kasih atas perhatian Anda! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id481818/">https://habr.com/ru/post/id481818/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id481804/index.html">Meningkatkan allOf dan anyOf di CompletableFuture</a></li>
<li><a href="../id481806/index.html">Tes Unit Python: Mulai Cepat</a></li>
<li><a href="../id481808/index.html">Mengapa dukungan otomasi merugikan bisnis</a></li>
<li><a href="../id481812/index.html">Penelitian saya - yang bekerja di bidang TI - profesi, keterampilan, motivasi, pengembangan karir, teknologi (DIPERBARUI 12/26/2019)</a></li>
<li><a href="../id481814/index.html">FunCode Java / Kotlin menantang kontes backend</a></li>
<li><a href="../id481820/index.html">PocketBook: hasil tahun ini, atau Apa yang Baru dan Penting terjadi pada 2019</a></li>
<li><a href="../id481822/index.html">Sejarah singkat dan 146% akurat bahasa pemrograman</a></li>
<li><a href="../id481824/index.html">Pencarian cepat untuk sumber mutasi yang tidak diinginkan dari properti objek</a></li>
<li><a href="../id481828/index.html">Sejarah perangkat lunak pendidikan: sistem manajemen pembelajaran dan kebangkitan pendidikan online</a></li>
<li><a href="../id481836/index.html">Pizza sebagai layanan: bagaimana Amazon bermigrasi ke Redshift</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>