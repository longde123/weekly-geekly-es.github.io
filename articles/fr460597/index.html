<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï¢ ü§≥ üé§ Comment diagnostiquer les probl√®mes d'int√©gration du SDK. L'exp√©rience de l'√©quipe de d√©veloppement du SDK Yandex Mobile Ads üéß ‚ùå üå§Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour √† tous! Je m'appelle Dmitry Fisko, je d√©veloppe le SDK Yandex Mobile Ads. Notre biblioth√®que est con√ßue pour mon√©tiser les applications mobile...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment diagnostiquer les probl√®mes d'int√©gration du SDK. L'exp√©rience de l'√©quipe de d√©veloppement du SDK Yandex Mobile Ads</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/460597/"> Bonjour √† tous!  Je m'appelle Dmitry Fisko, je d√©veloppe le SDK Yandex Mobile Ads.  Notre biblioth√®que est con√ßue pour mon√©tiser les applications mobiles sur les plateformes Android et iOS.  Aujourd'hui, je veux vous expliquer comment nous avons simplifi√© l'analyse des erreurs complexes d'int√©gration du SDK dans les applications Android.  Peut-√™tre que notre exp√©rience vous sera utile. <br><br>  Nos utilisateurs - les d√©veloppeurs d'applications mobiles - ne lisent pas toujours la documentation, donc parfois ils trouvent des fa√ßons complexes d'utiliser le SDK.  Une int√©gration incorrecte peut r√©duire l'efficacit√© de la publicit√©, et donc r√©duire les revenus du d√©veloppeur.  Pour aider les d√©veloppeurs √† mieux mon√©tiser les applications, nous avons cr√©√© un syst√®me de surveillance proactif qui analyse les performances d'une application mobile.  Si nous d√©couvrons le probl√®me gr√¢ce √† la surveillance, nous contactons les d√©veloppeurs et les aidons √† trouver la source du probl√®me et √† le r√©soudre. <br><br>  Malheureusement, toutes les erreurs d'int√©gration du SDK ne peuvent pas √™tre identifi√©es par la surveillance.  Si une telle situation se pr√©sente, nous nous tournons vers le partenaire pour clarifier les d√©tails de l'int√©gration.  Ensuite, nous essayons de d√©terminer la cause des probl√®mes et d'aider √† les r√©soudre.  Si m√™me ces informations ne suffisent pas √† d√©terminer la cause des erreurs, nous demandons au partenaire l'autorisation de proc√©der √† une r√©tro-ing√©nierie de l'application.  Apr√®s autorisation, nous commen√ßons √† regarder le travail du SDK publicitaire dans l'application comme une bo√Æte noire.  Nous visualisons l'activit√© du r√©seau via un proxy, v√©rifions l'affichage des vues publicitaires via l'inspecteur de mise en page, etc. <br><a name="habracut"></a><br>  L'affichage de l'activit√© r√©seau d'une application commen√ßant par Android 7.0 est probl√©matique, car le syst√®me par d√©faut ne fait pas confiance aux certificats d√©finis par l'utilisateur.  L'installation du certificat est requise pour visualiser le trafic SSL de l'application via un proxy.  Il r√©soudra le probl√®me soit en lan√ßant l'application sur les versions Android ant√©rieures √† 7.0, soit en ajoutant network_security_config √† l'application, par exemple via Apktool.  Vous pouvez afficher l'affichage des vues publicitaires via l'utilitaire Layout Inspector en ex√©cutant l'application sur un √©mulateur ou sur un appareil.  Dans ce cas, vous devez modifier le fichier AndroidManifest.xml en ajoutant l' <i>attribut debuggable = true</i> via Apktool. <br><br>  Si la m√©thode de la bo√Æte noire n'√©tait pas suffisante et que le probl√®me ne pouvait pas √™tre reproduit, vous pouvez regarder la logique de l'application.  Pour ce faire, vous pouvez utiliser des utilitaires de d√©compilation APK, tels que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">JADX</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Bytecode Viewer</a> .  Mais souvent cette approche prend trop de temps et ne conduit pas toujours √† un r√©sultat.  Par cons√©quent, pour comprendre rapidement comment l'application utilise le SDK de l'int√©rieur, nous avons cr√©√© un script pour remplacer une nouvelle impl√©mentation du SDK par une application d√©j√† construite. <br><br><h3>  <b>Installation d'une nouvelle impl√©mentation SDK dans une application</b> </h3><br>  La modification du code du SDK vous permet d'incorporer du code arbitraire dans l'application via les classes de la version modifi√©e du SDK et, par exemple, d'activer le mode de journalisation suppl√©mentaire.  L'algorithme de fonctionnement est le suivant.  Script: <br><br><ol><li>  d√©sassemble les fichiers DEX d'application dans smali; </li><li>  convertit le fichier JAR de la nouvelle version du SDK en smali; </li><li>  remplace l'impl√©mentation des fichiers SDK smali dans les fichiers d'application smali; </li><li>  R√©assemble l'application avec la nouvelle version du SDK. </li></ol><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gw/rk/ku/gwrkku0cnnnauln9jie1wiim09s.png" width="700"></div><br><h3>  <b>Assemblage de fichiers DEX d'application en smali</b> </h3><br>  Vous devez d√©composer l'application, la diviser en unit√©s plus petites, afin de pouvoir changer le code des classes SDK sans changer le code de l'application.  Comment aborder l'application assembl√©e?  D√©montez DEX en fichiers smali. <br><br>  Sous Android, l'application stocke le code dans des fichiers DEX.  Vous pouvez les extraire de l'application via l'utilitaire de d√©compression, car l'APK est une archive r√©guli√®re avec un contenu structur√©.  Les fichiers DEX ont un format binaire pour un empaquetage de code plus dense que les fichiers JAR.  En raison de la nature binaire du DEX, il est inhumain, donc changer le DEX lui-m√™me est irrationnel.  La premi√®re chose qui me vient √† l'esprit est de d√©compiler DEX en Java.  Une telle conversion est possible, mais elle n'est pas anodine et se produit avec une perte de fonctionnalit√© du code.  Par cons√©quent, nous utiliserons la traduction en code smali.  La conversion en smali vous permet de transf√©rer avec pr√©cision les instructions de DEX sous une forme lisible par l'homme avec la possibilit√© d'une conversion ult√©rieure en code exploitable. <br><br>  L'appel de l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utilitaire smali</a> convertit DEX en un ensemble de classes en code smali.  Dans ce cas, la disposition initiale des classes par sous-packages est conserv√©e. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ur/_q/rx/ur_qrxcls0qgsqkc9uv39q_vohy.png" width="600"></div><br><h3>  <b>Conversion du nouveau SDK en smali</b> </h3><br>  Nous pr√©parerons une version de remplacement du SDK.  Pour garantir la reproductibilit√© du probl√®me, nous allons cr√©er une version du SDK avec la journalisation activ√©e bas√©e sur la m√™me version qui est d√©j√† int√©gr√©e dans l'application.  L'un des moyens les plus simples de d√©couvrir la version connect√©e du SDK Yandex Mobile Ads dans l'application consiste √† afficher le contenu de la m√©thode dans la classe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">MobileAds.getLibraryVersion</a> () via <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Apk Analizer</a> dans Android Studio.  Apr√®s avoir d√©couvert la version utilis√©e du SDK publicitaire, nous passons √† la branche de cette version et collectons la version de la biblioth√®que avec une journalisation suppl√©mentaire.  En cons√©quence, nous obtenons un fichier AAR.  Il contient des ressources et un code de biblioth√®que.  Dans le fichier AAR, nous nous int√©ressons uniquement au code dans le fichier JAR, car il n'y a pas de ressources externes dans notre SDK: toutes les ressources sont int√©gr√©es directement dans le code ou proviennent du backend.  L'absence de fichiers de ressources simplifie l'int√©gration du SDK dans l'EDI sans la prise en charge des syst√®mes de g√©n√©ration modernes. <br><br>  Pour changer la version du SDK dans l'application en une nouvelle, nous amenons l'AAR au m√™me √©tat que l'application d√©sassembl√©e, c'est-√†-dire qu'√† partir de l'AAR, nous obtenons un ensemble de fichiers smali.  La conversion a lieu le long de la cha√Æne: AAR ‚Üí JAR ‚Üí DEX ‚Üí SMALI: <br><br><ol><li>  de l'AAR en utilisant l'utilitaire de d√©compression, nous extrayons le JAR avec le code; </li><li>  Nous convertissons JAR en DEX via l'utilitaire dxdump des outils du SDK Android; </li><li>  nous obtenons les fichiers dans le code smali en utilisant l'utilitaire smali avec le fichier DEX comme param√®tre. </li></ol><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/x-/ma/il/x-mailcf2mefqvmdacff6dcha7m.png" width="630"></div><br><h3>  <b>Impl√©mentation du SDK</b> </h3><br>  Apr√®s avoir re√ßu des fichiers smali de l'application et du SDK avec des journaux, nous rempla√ßons l'impl√©mentation du SDK par une nouvelle.  Ensuite, nous reconstruisons l'application.  Lors de la diffusion vers smali, les classes r√©sultantes conservent leur emplacement par sous-packages.  Par cons√©quent, si le package o√π se trouvent les classes SDK est connu, il est facile de distinguer la classe de biblioth√®que des classes d'application.  Les classes SDK peuvent √™tre distribu√©es sur plusieurs DEX.  Ainsi, l'algorithme par lequel l'impl√©mentation SDK est substitu√©e diff√®re pour une application avec un ou plusieurs fichiers DEX. <br><br><h3>  <b><font color="#fd181d">Et l'</font> algorithme pour remplacer l'impl√©mentation du SDK dans une application par un DEX</b> </h3><br>  Dans une seule application DEX, nous copions simplement les nouvelles classes smali du SDK au-dessus de toutes les classes d'application et g√©n√©rons un DEX modifi√©.  Vous pouvez g√©n√©rer un fichier DEX √† l'aide de l'utilitaire baksmali.  Le r√©pertoire contenant les fichiers de package des classes en code smali est envoy√© √† l'entr√©e de l'utilitaire.  Apr√®s avoir travers√© baksmali les fichiers smali combin√©s de l'application et du nouveau SDK, nous obtenons un fichier DEX modifi√© avec la logique du SDK modifi√©e. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qy/5m/jk/qy5mjkuhcnfyec681wkio0w4fda.png" width="370"></div><br><h3>  <b><font color="#fd181d">Et l'</font> algorithme pour remplacer l'impl√©mentation du SDK dans une application avec MultiDex</b> </h3><br>  Pour une application avec MultiDex, ajoutez un SDK distinct au nouveau DEX et supprimez la version pr√©c√©dente du SDK du reste des fichiers DEX de l'application.  L'ajout d'une nouvelle version du SDK aux DEX individuels contournera la limitation du nombre de m√©thodes au format DEX.  MultiDex chargera automatiquement le fichier DEX ajout√© avec le code SDK s'il est correctement nomm√©.  MultiDex recherche les fichiers DEX √† son tour, en utilisant l'index √† la fin du fichier: d'abord dex1, puis dex2 - et ainsi de suite. Si vous nommez le fichier avec un index incr√©mentiel, MultiDex le chargera automatiquement dans la machine virtuelle.  Ainsi, via baksmali, nous g√©n√©rerons des fichiers DEX bas√©s sur des fichiers smali d'application re√ßus pr√©c√©demment, mais avec des classes supprim√©es de l'ancienne version du SDK.  Et collectez √©galement un fichier DEX suppl√©mentaire avec une version modifi√©e du SDK, incr√©mentant l'index au nom du fichier DEX. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/7w/if/qj/7wifqjuneamhnw7wae86arkwu7w.png" width="530"></div><br><h3>  <b>Reconstruisez l'application avec la nouvelle version du SDK</b> </h3><br>  Nous avons obtenu des fichiers d'application DEX avec une version modifi√©e du SDK.  La chose est petite: nous remplacerons les fichiers DEX dans le fichier APK initialement d√©compress√© de l'application par les fichiers DEX modifi√©s.  Et en appelant la commande zip, nous obtenons la version finale de l'APK, qui reste √† signer.  Nous signerons avec la cl√© de d√©bogage via <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">apksigner</a> afin que l'application puisse √™tre install√©e sur l'appareil.  L'application avec la logique SDK modifi√©e est pr√™te. <br><br><h3>  <b><font color="#fd181d">N</font> Saving</b> </h3><br>  L'algorithme fonctionne dans la plupart des cas, mais parfois il ne fonctionnera pas pour remplacer l'impl√©mentation du SDK dans l'application.  Les raisons de ceci: <br><br><ol><li>  Obfuscation ProGuard.  Les r√®gles du fichier consommateur de la biblioth√®que emp√™chent ProGuard de d√©placer les classes SDK.  Mais si le d√©veloppeur annule ces instructions, une partie des classes de biblioth√®que peut changer de package.  Dans ce cas, l'algorithme ne fonctionnera pas, car le script ne trouvera pas l'emplacement des classes de l'ancien SDK. </li><li>  Limitation du format DEX.  Si tout le code de l'application est stock√© dans un fichier DEX, ce qui a presque compl√®tement √©puis√© la limite des m√©thodes utilis√©es.  Lorsque vous remplacez une version du SDK dans une application par une version avec une journalisation suppl√©mentaire, le nombre de m√©thodes augmente.  La limite sera d√©pass√©e.  Au format DEX, la limite est de 2 ^ 16. </li><li>  Prot√©gez votre application du changement.  L'application dispose de m√©canismes int√©gr√©s pour lutter contre la modification.  Par exemple, via la validation de signature d'application.  En modifiant l'APK, nous modifions en cons√©quence sa signature.  Lorsque l'application d√©marre, elle v√©rifie la signature par rapport √† la r√©f√©rence et l√®ve une exception.  Il est particuli√®rement difficile de supprimer ce contr√¥le s'il est plac√© dans la partie native. </li></ol><br><h3>  <b><font color="#fd181d">Et</font> toges</b> </h3><br>  Nous avons automatis√© les √©tapes d√©crites dans l'article avec un simple script bash.  Le script pr√©sente des d√©fauts, mais il acc√©l√®re consid√©rablement l'analyse des probl√®mes complexes lors de l'int√©gration du SDK dans les applications partenaires.  Cependant, nous utilisons rarement cette approche, car nous trouvons souvent une solution √† des stades ant√©rieurs. <br><br>  De la conversion √† smali, vous pouvez obtenir des avantages suppl√©mentaires: les fichiers smali vous permettent de d√©boguer l'application sans source.  Pour commencer le d√©bogage, vous devez g√©n√©rer un projet dans Android Studio bas√© sur les fichiers smali de l'application et attacher le d√©bogueur au processus qui vous int√©resse.  Plus de d√©tails sont √©crits dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cet article</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr460597/">https://habr.com/ru/post/fr460597/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr460577/index.html">Vive le roi: monde cruel de la hi√©rarchie dans une meute de chiens errants</a></li>
<li><a href="../fr460587/index.html">Module sans fil pour capteur capacitif d'humidit√© du sol sur nRF52832</a></li>
<li><a href="../fr460589/index.html">√âcrire un r√©seau neuronal simple en utilisant les math√©matiques et Numpy</a></li>
<li><a href="../fr460591/index.html">Obtention de la racine sur un routeur Tenda Nova MW6</a></li>
<li><a href="../fr460593/index.html">"Universel" dans l'√©quipe de d√©veloppement: avantage ou inconv√©nient?</a></li>
<li><a href="../fr460599/index.html">Nouvelles du monde d'OpenStreetMap n ¬∞ 468 (07/02/2019 - 08/07/2019)</a></li>
<li><a href="../fr460603/index.html">V2G. Les voitures √©lectriques aideront √† √©quilibrer la production et la consommation d'√©lectricit√©</a></li>
<li><a href="../fr460605/index.html">Studio photo automatique, partie 1</a></li>
<li><a href="../fr460607/index.html">App Store de s√©curit√© offensive avec des outils de piratage d'Android</a></li>
<li><a href="../fr460611/index.html">Basculement: le perfectionnisme nous ruine et ... la paresse</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>