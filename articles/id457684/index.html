<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>☃️ 👨🏾‍🏭 🔤 Pengalaman dalam mengintegrasikan meja kas Atol dengan perdagangan CRM sendiri 👩🏼‍💻 👪 🃏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Di sekitar box office online baru-baru ini, kegembiraan liar, pada 1 Juli 2019, penundaan terakhir berakhir, jadi saya harus berurusan dengan masalah ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pengalaman dalam mengintegrasikan meja kas Atol dengan perdagangan CRM sendiri</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/457684/">  Di sekitar box office online baru-baru ini, kegembiraan liar, pada 1 Juli 2019, penundaan terakhir berakhir, jadi saya harus berurusan dengan masalah ini.  Mereka yang memiliki 1C atau sistem lain terutama tidak dapat memaksakan, tetapi jika Anda memiliki sistem yang Anda tulis sendiri, maka integrasi dengan register kas online juga jatuh di pundak Anda. <br><br>  Pengalaman saya berguna untuk integrasi dengan meja kas Atol dalam mode pertukaran data jaringan, program Anda dapat mengirim data ke server web Atol baik di localhost dan di jaringan lokal, Anda dapat mengirimnya bahkan dari browser AJAX, bahkan dari server melalui CURL, oleh karena itu, tidak peduli apa bahasa perangkat lunak perusahaan Anda ditulis, semuanya cross-platform. <br><a name="habracut"></a><br>  Saya telah menemukan kantor tiket Atol 30f - mesin tik sederhana dengan kotak hitam (FN), tepat ketika semua logika untuk memesan adalah pada perangkat lunak eksternal, dan bukan pada perangkat lunak yang dibangun di kasir.  Selain itu, perangkat jenis ini relatif murah, dibandingkan dengan perangkat Android. <br><br>  Saya juga ingin mencatat bahwa "spesialis" dari beberapa perusahaan yang terlibat dalam dukungan tidak tahu sama sekali bahwa Atoll dengan versi 10 memiliki server web bawaan pada driver yang menerima pekerjaan JSON, terlebih lagi, driver ini juga dapat diinstal di linux, menilai dengan jumlah solusi siap pakai pada raspberry, saya dapat berasumsi bahwa itu juga dapat diinstal di sana, dalam distribusi versi ke 10 dari driver, installer untuk arm hadir. <br><br>  Skema yang direncanakan adalah sesuatu seperti ini - ada CRM yang berjalan di server di jaringan lokal, dibuka dari browser, dari cek sisi server akan dikirim ke PHP melalui curl dan dicetak di kasir.  Dan meja kas itu sendiri terhubung ke komputer di Windows di jaringan yang sama. <br><br>  Mereka mengatakan bahwa jika Anda tidak mengaktifkan kasir, maka ia dapat bekerja dalam mode printer dan mencetak bahwa cek tidak valid, tetapi saya tidak dapat memverifikasinya, saya harus melakukan penny sales dan retur. <br><br>  Pengemudi versi kesepuluh diunduh di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> . <br><br>  Sebelum menginstal, Anda harus menginstal <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Java</a> dengan kedalaman bit yang sama dengan driver, jika tidak, server web checkbox tidak akan tersedia, jika Anda menginstal driver KKT 64-bit, maka Java x64. <br><br>  Tampaknya, secara logis, Anda perlu menginstal driver 64-bit pada sistem 64-bit, tetapi beberapa perangkat lunak 32-bit tidak akan dapat bekerja dengannya (seperti ini berlaku untuk 1C jika 32-bit). <br><br><img src="https://habrastorage.org/webt/nf/fn/uk/nffnukvhkzk3za8vpcrn567wygi.png"><br><br>  Pada akhir instalasi ada tanda centang - untuk mengkonfigurasi server web, jika tidak diinstal, maka Anda harus pergi ke browser di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">127.0.0.1</a> : 16732 / pengaturan, centang kotak "aktifkan server" dan simpan. <br><br><img src="https://habrastorage.org/webt/gv/fm/9l/gvfm9lfbrzxyntshlyhn7fmx-pc.png"><br><br><img src="https://habrastorage.org/webt/dy/so/pq/dysopqgomkepetfvn-de5vgdj3q.png"><br><br>  Setelah itu, Anda perlu me-restart server melalui START-&gt; ATOL-&gt; restart ... <br><br>  Saya juga ingin segera memperingatkan Anda bahwa jika Anda memulai server web, maka aplikasi lokal tidak akan dapat mengakses PKC, saya bekerja keras untuk waktu yang lama, menginstal driver, menjalankan tes driver Cct, dan dia memberi tahu saya bahwa port sedang sibuk dan hanya itu, saya memanggil dukungan teknis dari penjual lokal, di sana mereka bilang kita tidak tahu harus berbuat apa, lalu saya membebani komputer sepuluh kali, menginstal ulang driver, tidak ada yang membantu. <br><br>  Secara umum, setelah Anda mengaktifkan dan me-restart server, dan sebelum itu Anda mematikan server dan memeriksa pencetakan teks biasa melalui utilitas yang disediakan atau hanya memeriksa koneksi - Anda dapat melanjutkan. <br><br>  Layanan web ini tidak memiliki perlindungan kata sandi, jadi Anda harus segera mengkonfigurasi firewall Windows atau perangkat lunak lain sehingga hanya komputer yang diperlukan yang dapat mengakses port 16732, dalam situasi saya ini adalah server tempat CRM menjalankan. <br><br>  <b>Komunikasi dengan layanan web umumnya merupakan topik terpisah, sangat menarik ...</b> <br><br><ol><li>  Hasilkan uuid unik untuk pekerjaan itu </li><li>  Kami mengirim tugas menggunakan metode POST </li><li>  Kami mogok di layanan web, menunggu hasil tugas dengan UUID kami, mungkin selama beberapa detik tugas kami akan memiliki status menunggu, atau kesalahan dapat terjadi jika ada sesuatu yang salah dalam permintaan ... </li></ol><br>  Dan kemudian saya akan memberikan versi yang berfungsi, ini cocok untuk situasi di mana pembayaran hanya satu metode, dan tidak begitu banyak bagian dalam bentuk tunai dan bagian non-tunai, itu juga menggunakan sistem pajak default, PPN belum dihitung, saya ingin menambahkan kode, kemudian menyebarkannya, tetapi Saya pikir masih ada orang yang membutuhkan informasi ini sebelum 1 Juli daripada setelahnya.  Saya harus mengatakan segera bahwa kelas perlu perbaikan, banyak mentah, tidak ada penanganan kesalahan, semuanya dilakukan dalam beberapa jam tanpa memperhitungkan membaca dokumentasi, kode ini lebih sebagai contoh dan saya menyarankan Anda untuk mempelajari <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dokumentasi</a> dengan sangat rinci dan menyesuaikannya dengan proses spesifik Anda. <br><br><div class="spoiler">  <b class="spoiler_title">kode php untuk contoh bekerja dengan api (hanya digunakan untuk tujuan pendidikan)</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">Class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AtolWebDriver</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $addr=<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>,$port=<span class="hljs-string"><span class="hljs-string">"16732"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $timeout = <span class="hljs-number"><span class="hljs-number">30</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  public $operator; function __construct($addr=false,$port=false) { if ($addr!==false) $this-&gt;addr=$addr; if ($port!==false) $this-&gt;port=$port; } public function CallAPI($method, $data,$_url="/requests") { $url = "http://".$this-&gt;addr.":".$this-&gt;port.$_url; $curl = curl_init($url); curl_setopt($curl, CURLOPT_RETURNTRANSFER, true); curl_setopt($curl,CURLOPT_TIMEOUT, $this-&gt;timeout); $headers = ['Content-Type: application/json']; curl_setopt($curl,CURLOPT_HTTPHEADER, $headers); curl_setopt($curl, CURLOPT_CUSTOMREQUEST, $method); curl_setopt($curl, CURLOPT_POSTFIELDS, json_encode($data)); $resp = curl_exec($curl); $data = json_decode($resp,1); $code = curl_getinfo($curl, CURLINFO_HTTP_CODE); curl_close($curl); $res= [$data,$code,$resp]; print_r($res); return $res; } //   public function get_res($uuid) { $ready = false; $cnt=0; $res_url = '/requests/'.$uuid; while (!$ready &amp;&amp; ++$cnt&lt;60) { usleep(500000); // ,     list($res,$code,$resp) = $this-&gt;CallAPI('GET',[],$res_url); $ready = ($res['results'][0]['status'] == 'ready'); if ($ready) return $res; } return false; //    } //  public function add_req($uuid,$req) { return $this-&gt;CallAPI('POST', ['uuid'=&gt;$uuid,'request'=&gt;$req]); } //  id   public function gen_uuid() { return exec('uuidgen -r'); } //      public function atol_task($type,$req=[]) { $req['type'] = $type; $uuid = $this-&gt;gen_uuid(); $req = $this-&gt;add_req($uuid,$req); if ($req[1]!='201') return false; //  $res = $this-&gt;get_res($uuid); //  if ($res===false || !isset($res['results'][0])) return false; return $res['results'][0]; } /*    */ //  public function get_shift_status() { $res = $this-&gt;atol_task('getShiftStatus'); if ($res===false) return false; //closed / opened / expired return $res['result']['shiftStatus']['state']; } //  public function open_shift() { $status = $this-&gt;get_shift_status(); //e ,    if ($status=="expired") $this-&gt;close_shift(); if ($status=="opened") return "    "; $res = $this-&gt;atol_task('openShift',['operator'=&gt;$this-&gt;operator]); } //  public function close_shift() { $status = $this-&gt;get_shift_status(); if ($status=="closed") return "    "; $res = $this-&gt;atol_task('closeShift',['operator'=&gt;$this-&gt;operator]); } public function items_prepare($items) { $res_items = []; $summ = 0; while ($item = array_shift($items)) { $res_item = $item; if (!isset($item['type'])) $res_item['type']="position"; if (isset($item['price']) &amp;&amp; isset($item['quantity'])) { $res_item['amount'] = $item['price']*$item['quantity']; $res_item['tax'] = ['type'=&gt;'none']; $summ+=$res_item['amount']; } $res_items[] = $res_item; } return [$res_items,$summ]; } // sell,  sellReturn public function fiskal($type_op="sell",$items,$pay_type="cash") { $data = []; $data['operator'] = $this-&gt;operator; $data['payments'] = []; list($data['items'],$summ) = $this-&gt;items_prepare($items); //+++       $data['payments'][] = ['type'=&gt;$pay_type,'sum'=&gt;$summ]; $res = $this-&gt;atol_task($type_op,$data); } } //  ip   web-  ,      $atol = new AtolWebDriver('192.168.100.10'); //    $atol-&gt;operator = ['name'=&gt;'.']; //       $items = []; $items[] = ['name'=&gt;' ','price'=&gt;0.7,'quantity'=&gt;1]; $items[] = ['name'=&gt;' ','price'=&gt;0.4,'quantity'=&gt;1]; //  $atol-&gt;open_shift(); //  $atol-&gt;fiskal("sell",$items); sleep(10); // ,     //     , ..    $atol-&gt;fiskal("sellReturn",$items); //     sleep(20); // ,   $atol-&gt;close_shift();</span></span></code> </pre> <br></div></div><br>  Ada beberapa kekurangan di sini yang akan saya perbaiki <br><br><ol><li>  Membulatkan pecahan saat menghitung jumlah, Anda harus membulatkan ke sen, jika tidak, Anda bisa mendapatkan 1,000000001 atau 0,999999999 </li><li>  Dengan ejaan yang benar dari sisa logika program, ini biasanya tidak terjadi, tetapi selama tes saya menemukan diri saya pada kenyataan bahwa tugas tersebut mengembalikan hasil kesalahan, dan saya sedang menunggu siap </li></ol><br>  Ya, dalam proses implementasi, saya takut menangkap banyak kesalahan, misalnya, jika tugasnya lama menunggu dalam status menunggu, maka lebih baik untuk menghapusnya dari antrian, jika tugas berikutnya akan menggantung selama beberapa menit, saya menangkap kesalahan seperti itu sekali, saya tidak berharap bahwa itu akan dicetak dan di sini saya duduk, tetapi melompat dan dicetak segera dua cek berturut-turut dikirim sebelumnya ... <br><br>  Secara umum, adalah mungkin untuk mengumpulkan perolehan dari situs di masa depan, jika mereka tidak memiliki cek online, sampai Anda memutuskan untuk mengakuisisi mana yang harus dikacaukan.  Tetapi solusinya adalah, lebih mungkin sebagai ide untuk solusi, waktu akan memberi tahu bagaimana box office ini akan berakar. <br><br>  <b>Peringatan</b> , bagi mereka yang tidak sengaja membaca artikel dan tidak terlalu kompeten dalam masalah keamanan - <b>layanan web ini tidak memiliki enkripsi (https), tidak memiliki otorisasi</b> , bahkan jika digunakan hanya pada jaringan lokal - konfigurasikan perlindungan untuk akses ke port. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id457684/">https://habr.com/ru/post/id457684/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id457652/index.html">Bagaimana mengatur 120.000 foto sehingga tidak ada tryndets, dengan tingkat akses yang berbeda, untuk tim</a></li>
<li><a href="../id457658/index.html">Union MS-11: Kecelakaan yang tidak ada?</a></li>
<li><a href="../id457660/index.html">Bagaimana cara menghemat $ 58 dalam 5 menit: mari kita gunakan harga yang berbeda di setiap negara terhadap pemasar</a></li>
<li><a href="../id457666/index.html">Alternatif untuk Raspberry Pi</a></li>
<li><a href="../id457680/index.html">Instalasi CentOS / Fedora / RedHat minimum</a></li>
<li><a href="../id457686/index.html">Bagaimana Sberbank mengumpulkan persetujuan untuk pemrosesan biometrik</a></li>
<li><a href="../id457690/index.html">Video paranoid dari Yandex.Money metap</a></li>
<li><a href="../id457692/index.html">Refleksi Standar NB-Fi Nasional dan Sistem Penagihan</a></li>
<li><a href="../id457694/index.html">Bahaya menggunakan konstanta multi-karakter</a></li>
<li><a href="../id457696/index.html">Bahaya menggunakan konstanta multi-karakter</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>