<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèª‚Äç‚öïÔ∏è üîÄ ü§±üèª Estou cansado de aceitar pagamentos atrav√©s do WebView. O que eu fa√ßo? ‚úä üëàüèæ ‚ôìÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vou ao escrit√≥rio de trem - preciso passar por uma esta√ß√£o e estarei quase l√°. 

 Todas as manh√£s eu compro passagens de trem no aplicativo e sofro. √â...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Estou cansado de aceitar pagamentos atrav√©s do WebView. O que eu fa√ßo?</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yamoney/blog/416871/">  Vou ao escrit√≥rio de trem - preciso passar por uma esta√ß√£o e estarei quase l√°. <br><br>  Todas as manh√£s eu compro passagens de trem no aplicativo e sofro.  √â mais barato l√°, mas a diferen√ßa de pre√ßo n√£o compensa minha dor quando passo esses tr√™s minutos de estresse.  Mesmo sem mencionar o tempo de carregamento de cada uma das cinco telas do aplicativo, n√£o se pode deixar de dizer sobre o WebView banc√°rio com um mapa salvo, digitando o c√≥digo do SMS na execu√ß√£o e falhas inesperadas. <br><br>  √â quando voc√™ dirige um trem e eles dizem "Algo deu errado" e baixam o dinheiro, mas eles n√£o pagam um ingresso.  Um retorno chega logo ali, mas o trem j√° partiu.  Isso acontece duas vezes por m√™s, independentemente da qualidade da Internet.  N√£o h√° necessidade de falar sobre a√ß√µes. <br><br><img src="https://habrastorage.org/webt/vk/cl/oz/vkclozwcg4inlgcwqn7equxs_hi.png"><br><br>  Neste momento voc√™ est√° pensando - talvez haja uma maneira mais simples?  Bem, para n√£o ter nenhuma vis√£o da web, bonita e nativa.  E sim, existe esse caminho.  Detalhes sob o corte. <br><a name="habracut"></a><br>  <b>tl; dr</b> Criamos uma interface para aceitar pagamentos via Apple Pay, Google Pay, banco m√≥vel Sberbank e Yandex.Money no iOS e Android.  N√£o, voc√™ n√£o precisa desenhar formas de pagamento.  Sim, tamb√©m est√° em c√≥digo aberto. <br><br>  Em geral, existem aproximadamente dois cen√°rios para aceitar pagamentos em aplicativos m√≥veis. <br><br>  A primeira √© atrav√©s de um WebView com uma p√°gina de pagamento.  Assim, voc√™ pode aceitar pagamentos por meio de uma carteira, cart√£o banc√°rio, celular ou qualquer outra coisa.  O problema √© que o WebView n√£o tem acesso aos cookies do navegador, o que significa que ele n√£o tem autoriza√ß√£o para algumas formas de pagamento, portanto, voc√™ n√£o poder√° pagar. <br><br>  No segundo cen√°rio, o comerciante passa os dados do cart√£o pelo back-end - para isso, voc√™ precisa estar em conformidade com o PCI DSS, que √© caro, longo e dif√≠cil. <br><br><h2>  SDK para celular </h2><br>  O SDK m√≥vel do Yandex.Kassi √© uma biblioteca para iOS e Android que criamos para simplificar a vida de comerciantes, desenvolvedores de aplicativos e aqueles que se preocupam com seus usu√°rios.  De fato, o SDK m√≥vel √© uma ferramenta para tokenizar cart√µes banc√°rios e outros instrumentos de pagamento.  Tokeniza√ß√£o √© a troca de dados necess√°ria para efetuar um pagamento por um identificador exclusivo - um token. <br><br>  Na primavera, lan√ßamos a primeira vers√£o do SDK - houve pagamento por cart√£o e pela carteira Yandex.Money.  Agora tudo est√° ainda melhor - no lan√ßamento de julho, eles adicionaram Google Pay, Apple Pay e pagamentos via Sberbank com confirma√ß√£o por SMS. <br><br><h2>  Sobre os benef√≠cios </h2><br><img src="https://habrastorage.org/webt/1v/pt/9y/1vpt9yly6mhhzyl8ncqv374pbki.gif" align="left">  O principal benef√≠cio √© que o comprador paga qualquer coisa, mas para um comerciante parece um s√≠mbolo que pode ser operado em vez de dados de pagamento. <br><br>  Ainda n√£o √© necess√°rio passar na certifica√ß√£o para conformidade com o PCI DSS - os dados do cart√£o ser√£o processados ‚Äã‚Äãem nosso per√≠metro.  Todos os anos, passamos pela certifica√ß√£o, cumprimos todas as regras dos reguladores e eliminamos as lojas conectadas ao Caixa.  Ent√£o √© poss√≠vel. <br><br>  Com o SDK, os pagamentos no Android e iOS parecem familiares para os usu√°rios e agora eles n√£o precisam sair do contexto do aplicativo no momento do pagamento.  Aqueles que pagam com uma carteira eletr√¥nica tamb√©m n√£o precisam fazer login - se o usu√°rio estiver conectado ao aplicativo Money, voc√™ s√≥ precisar√° selecionar a conta que precisa atrav√©s do Yandex.Passport. <br><br><h2>  Como come√ßar a usar em casa? </h2><br>  Se generalizar completamente, duas coisas precisam ser feitas: <br><br><ul><li>  Integre a API de pagamento Yandex.Cash - para receber pagamentos; </li><li>  Conecte o SDK m√≥vel - para tokeniza√ß√£o e interface nativa. </li></ul><br>  Para adicionar o Apple Pay, basta ativar a aceita√ß√£o de pagamentos com cart√£o banc√°rio e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">emitir chaves</a> na conta de desenvolvedor da Apple. <br><br>  O Google Pay √© um pouco diferente.  Necessidade: <br><br><ol><li>  Prepare uma compila√ß√£o de teste do APK. </li><li>  Preencha a lista de verifica√ß√£o de integra√ß√£o - confirme se seu aplicativo n√£o vai dominar o mundo e mais algumas coisas. </li><li>  Preencha a montagem para verifica√ß√£o no Google Pay. </li></ol><br>  O Google verificar√° tudo e permitir√° (ou n√£o permitir) publicar o aplicativo no Google Play. <br><br>  O SDK m√≥vel √© incorporado no aplicativo cliente para que os pagamentos nativos funcionem nele.  Funciona assim: os detalhes do cart√£o v√£o diretamente para o per√≠metro do PCI DSS, sem cair no back-end da loja.  Verificamos, processamos e devolvemos ao comerciante um token de pagamento com dura√ß√£o de 30 minutos - ele pode ser usado uma vez. <br><br><img src="https://habrastorage.org/webt/i_/ys/q7/i_ysq7ohb0g2qmlcpstlkjduzzu.png"><br>  <i>Esquema de intera√ß√£o do usu√°rio, comerciante, SDK m√≥vel e API Ya.Kassa</i> <br><br>  Com a participa√ß√£o do SDK, o pagamento consiste em tr√™s etapas: <br><br><ol><li>  In√≠cio do pagamento e recebimento de um token.  O aplicativo inicia um pagamento por meio do SDK e recebe um token de pagamento na sa√≠da. </li><li>  Crie um pagamento.  O token vai para o servidor, que inicia o pagamento por meio da API. </li><li>  Solicitar status de pagamento.  Isso √© necess√°rio para desenhar a janela correta com sucesso ou erros. </li></ol><br><h4>  Por que isso √© bom? </h4><br><ol><li>  A arquitetura √© homog√™nea em diferentes cen√°rios de pagamento. </li><li>  N√£o h√° necessidade de trabalhar com cart√£o de cr√©dito no back-end da loja. </li></ol><br><h2>  Sobre desenvolvimento e teste </h2><br>  Na vers√£o iOS, usamos VIPER e microsservi√ßos. <br><br>  O m√≥dulo de tokeniza√ß√£o √© a pedra angular do SDK m√≥vel - controla o processo para que o comerciante veja apenas o token da sa√≠da da API Yandex.Kassi, independentemente do valor pago pelo usu√°rio.  Outro m√≥dulo de tokeniza√ß√£o decide qual janela deve ser mostrada ao usu√°rio agora e faz solicita√ß√µes POST ao servidor.  N√≥s escrevemos nosso wrapper para a API para trabalhar com solicita√ß√µes HTTP / HTTPS para YandexMoneyCoreApi - isso tornou a vida mais f√°cil. <br><br>  Servi√ßos s√£o armazenamentos e objetos que funcionam com a API do cliente Yandex.Kassi. <br>  Seu c√≥digo acabou sendo limpo e conciso, sem um grande n√∫mero de filiais e sa√≠das antecipadas, porque o departamento de desenvolvimento conseguiu pensar em toda a arquitetura com anteced√™ncia.  Os servi√ßos SDK t√™m uma quantidade concentrada de programa√ß√£o funcional - aqui n√≥s revelamos seus recursos na √≠ntegra.  Onde tivemos que trabalhar com o Functor, a M√¥nada, o Functor Aplic√°vel, a Promise comum nos ajudou. <br><br><pre><code class="hljs pgsql">let <span class="hljs-keyword"><span class="hljs-keyword">method</span></span> = PaymentOptions.<span class="hljs-keyword"><span class="hljs-keyword">Method</span></span>(oauthToken: clientApplicationKey, passportAuthorization: passportToken, gatewayId: gatewayId, amount: amount, currency: currency) let paymentOptions = <span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">perform</span></span>(apiMethod: <span class="hljs-keyword"><span class="hljs-keyword">method</span></span>).responseApi() let allItems = getItems &lt;^&gt; paymentOptions let items = paymentMethodHandler.filterPaymentMethods &lt;^&gt; allItems let itemsWithEmptyError = items .recover(<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>: .<span class="hljs-keyword"><span class="hljs-keyword">global</span></span>(), mapError) .<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(makeErrors) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> itemsWithEmptyError</code> </pre> <br>  A √∫nica dificuldade surgiu com o VIPER - come√ßamos a adicionar novos tipos de pagamento e percebemos que o m√≥dulo central est√° crescendo rapidamente.  Quando havia cerca de 1000 linhas, decidimos que t√≠nhamos que fazer algo com isso e revisar a arquitetura. <br><br>  Gostamos da ideia de um m√≥dulo central para o processo e decidimos deix√°-lo.  Em outros projetos, usamos uma m√°quina determinista de estados finitos para descrever o processo, mas aqui ela n√£o resolveria os problemas, pois a implementa√ß√£o de muitas coisas permaneceria no mesmo m√≥dulo.  Por isso, decidimos aplicar o padr√£o de "estrat√©gia" para isolar os processos de cada instrumento de pagamento.  Depois que o usu√°rio seleciona uma forma de pagamento, criamos uma estrat√©gia para a forma de pagamento, que controla o cart√£o de transi√ß√£o e decide qual processo ser√° seguido. <br><br><h3>  Aplicativo de demonstra√ß√£o </h3><br><img src="https://habrastorage.org/webt/jq/dd/go/jqddgovdbutq7q1gijnex5do6ho.gif" align="left">  N√≥s conseguimos. <br><br>  Tudo come√ßou com o fato de que o departamento de testes precisava de algo para testar o SDK m√≥vel.  Sem um aplicativo de teste, os caras n√£o podiam verificar como o SDK funciona, e n√£o havia desenvolvedores para ambas as plataformas entre os testadores. <br><br>  No processo, descobriu-se que, al√©m de testar tarefas, um aplicativo de demonstra√ß√£o √© uma boa maneira de mostrar aos nossos parceiros o que √© um SDK m√≥vel.  Qualquer pessoa que n√£o saiba como programar no Swift ou no Kotlin (leia-se: qualquer pessoa) pode ver como o SDK funciona.  Portanto, carregamos o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aplicativo de demonstra√ß√£o no Google Play</a> e a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=http://itms-services//%3Faction%3Ddownload-manifest%26url%3D">vers√£o iOS no site Yandex.Cash.</a> <br><br>  Aconteceu algo em que voc√™ pode ver como diferentes m√©todos de pagamento funcionam, brincar com as configura√ß√µes ou mostr√°-lo a algu√©m respons√°vel por escolher um agregador de pagamento.  N√£o seja t√≠mido. <br><br><h2>  C√≥digo aberto </h2><br>  Alguns meses ap√≥s o lan√ßamento, distribu√≠mos a biblioteca muito desconfortavelmente - compartilhamos um link para o site ou enviamos arquivos por correio.  Os mocinhos n√£o fazem isso - eles publicam tudo no GitHub sob a licen√ßa MIT.  Ent√£o fizemos exatamente isso. <br><br>  Al√©m da m√°gica da tokeniza√ß√£o, os comerciantes podem personalizar cores, alterar logotipos ou fazer outras altera√ß√µes na biblioteca.  E, para torn√°-lo muito conveniente, publicamos um SDK m√≥vel no CocoaPods para desenvolvedores do iOS e no Maven para caras do Android. <br><br>  Se voc√™ j√° aceita pagamentos pelo Caixa, mas agora deseja faz√™-lo ainda melhor e com mais produtividade - conecte o SDK m√≥vel.  Se voc√™ est√° apenas abrindo uma loja, conecte o Caixa.  Estamos indo bem. <br><br><h2>  Links √∫teis </h2><br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Biblioteca para aplicativos m√≥veis</a> <br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o do SDK</a> <br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SDK para iOS</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Android</a> no GitHub. <br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Maven</a> <br><br>  Isso √© tudo.  Fa√ßa perguntas nos coment√°rios! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt416871/">https://habr.com/ru/post/pt416871/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt416857/index.html">Constru√≠mos templos - no c√≥digo e na vida. Minha experi√™ncia no desenvolvimento do meu segundo aplicativo Android</a></li>
<li><a href="../pt416859/index.html">Conhe√ßa Tudo de Uma Vez Reagir Boilerplate de Maximilian Stoiber v3.6.0</a></li>
<li><a href="../pt416863/index.html">Uma nova maneira de apresentar expositores</a></li>
<li><a href="../pt416865/index.html">Design retro para o primeiro console port√°til do distante 1979</a></li>
<li><a href="../pt416867/index.html">Pesquisadores criaram um dispositivo para ataques locais em sistemas SCADA</a></li>
<li><a href="../pt416877/index.html">Gerenciamento de infraestrutura de impress√£o</a></li>
<li><a href="../pt416879/index.html">Escrit√≥rio √Ågil: Onde Hospedar Mil Desenvolvedores?</a></li>
<li><a href="../pt416881/index.html">Introdu√ß√£o aos contratos inteligentes. Suas limita√ß√µes potenciais e reais</a></li>
<li><a href="../pt416883/index.html">Como escrevi meu Postcrossing</a></li>
<li><a href="../pt416885/index.html">Servi√ßo de condicionamento f√≠sico novamente ‚Äúrenunciou a todas as apar√™ncias‚Äù de governos, servi√ßos militares e especiais</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>