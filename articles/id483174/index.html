<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐃 💂🏼 📙 Rekam dan transfer suara dari perangkat ke perangkat menggunakan Konektivitas Multipeer 🐿️ 👨🏼‍💻 🧑🏿‍🤝‍🧑🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Selamat siang, pembaca yang budiman! Beberapa waktu lalu, saya memutuskan untuk mencoba merekam dan mentransfer rekaman suara dari satu perangkat ke p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Rekam dan transfer suara dari perangkat ke perangkat menggunakan Konektivitas Multipeer</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483174/"><img src="https://habrastorage.org/webt/eg/ah/sa/egahsainzphs5fo7hefrl3dlptm.png"><br>  Selamat siang, pembaca yang budiman!  Beberapa waktu lalu, saya memutuskan untuk mencoba merekam dan mentransfer rekaman suara dari satu perangkat ke perangkat lainnya.  Sebagai cara mentransmisikan suara yang direkam, pilihan jatuh pada kerangka kerja <b>MultipeerConnectivity</b> .  Pada artikel ini saya akan memberi tahu Anda cara melakukannya. <br><br>  Pertama-tama, kita membutuhkan dua perangkat untuk merekam dan memutar suara.  Oleh karena itu, kita perlu menulis kelas untuk melakukan tindakan ini. <br><br><h2>  Rekaman audio real-time dari perangkat </h2><br>  Untuk merekam audio, <b>AVAudioEngine</b> dan <b>AVAudioMixerNode</b> biasa <b>digunakan,</b> yang disertakan dengan kerangka kerja <b>AVFoundation</b> . <br><a name="habracut"></a><br>  Contoh rekaman audio: <br><br><pre><code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Recorder</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> engine = <span class="hljs-type"><span class="hljs-type">AVAudioEngine</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> mixer = <span class="hljs-type"><span class="hljs-type">AVAudioMixerNode</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> onRecordedAction: ((<span class="hljs-type"><span class="hljs-type">Data</span></span>) -&gt; <span class="hljs-type"><span class="hljs-type">Void</span></span>)? <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>() { setupAudioSession() } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setupAudioSession</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> audioSession = <span class="hljs-type"><span class="hljs-type">AVAudioSession</span></span>.sharedInstance() <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> audioSession.setCategory(.record) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> audioSession.setMode(.measurement) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> audioSession.setActive(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">debugPrint</span></span>(error.localizedDescription) } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startRecording</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> input = engine.inputNode <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> inputFormat = input.outputFormat(forBus: <span class="hljs-number"><span class="hljs-number">0</span></span>) engine.attach(mixer) engine.connect(input, to: mixer, format: inputFormat) mixer.installTap(onBus: <span class="hljs-number"><span class="hljs-number">0</span></span>, bufferSize: <span class="hljs-number"><span class="hljs-number">1024</span></span>, format: mixer.outputFormat(forBus: <span class="hljs-number"><span class="hljs-number">0</span></span>)) { [<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>] buffer, <span class="hljs-number"><span class="hljs-number">_</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>?.onRecordedAction?(buffer.data) } engine.prepare() <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> engine.start() } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">debugPrint</span></span>(error.localizedDescription) } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stopRecording</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { engine.stop() } }</code> </pre> <br>  Secara umum, tidak ada yang aneh, dengan bantuan mixer, kami mendapatkan data waktu nyata dan mengirimkannya ke fungsi onRecodedAction kami.  Untuk mentransfer audio yang kami rekam, kami perlu mengubahnya menjadi data.  Untuk ini, saya menyiapkan ekstensi berikutnya. <br><br>  Contoh mengkonversi <b>PCMBuffer</b> ke <b>Data</b> : <br><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AVAudioPCMBuffer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data: <span class="hljs-type"><span class="hljs-type">Data</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> channels = <span class="hljs-type"><span class="hljs-type">UnsafeBufferPointer</span></span>(start: floatChannelData, <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> data = <span class="hljs-type"><span class="hljs-type">Data</span></span>(bytes: channels[<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-type"><span class="hljs-type">Int</span></span>(frameCapacity * format.streamDescription.pointee.mBytesPerFrame)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> data } }</code> </pre><br><h2>  Putar ulang audio yang diterima </h2><br>  Kerangka kerja yang sama digunakan untuk memutar audio, sebagai hasilnya, tidak ada yang rumit, singkatnya, kami hanya membuat simpul dan menetapkannya ke mesin, kemudian mengonversi data kami kembali ke <b>PCMBuffer</b> dan memberikannya ke simpul kami untuk diputar. <br><br>  Contoh pemutaran: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Player</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> engine = <span class="hljs-type"><span class="hljs-type">AVAudioEngine</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> playerNode = <span class="hljs-type"><span class="hljs-type">AVAudioPlayerNode</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>() { setupAudioSession() } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setupAudioSession</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> audioSession = <span class="hljs-type"><span class="hljs-type">AVAudioSession</span></span>.sharedInstance() <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> audioSession.setCategory(.playback) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> audioSession.setActive(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">debugPrint</span></span>(error.localizedDescription) } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setupPlayer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(buffer: AVAudioPCMBuffer)</span></span></span></span> { engine.attach(playerNode) engine.connect(playerNode, to: engine.mainMixerNode, format: buffer.format) engine.prepare() } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tryStartEngine</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> engine.start() } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">debugPrint</span></span>(error.localizedDescription) } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addPacket</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(packet: Data)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">guard</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> format = <span class="hljs-type"><span class="hljs-type">AVAudioFormat</span></span>.common, <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> buffer = packet.pcmBuffer(format: format) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">debugPrint</span></span>(<span class="hljs-string"><span class="hljs-string">"Cannot convert buffer from Data"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> !engine.isRunning { setupPlayer(buffer: buffer) tryStartEngine() playerNode.play() } playerNode.volume = <span class="hljs-number"><span class="hljs-number">1</span></span> playerNode.scheduleBuffer(buffer, completionHandler: <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) } }</code> </pre><br>  Contoh ekstensi untuk menerjemahkan kembali <b>Data</b> ke <b>PCMBuffer</b> dan <b>AVAudioFormat</b> kami untuk memutar audio: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Data</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pcmBuffer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(format: AVAudioFormat)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">AVAudioPCMBuffer?</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> streamDesc = format.streamDescription.pointee <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> frameCapacity = <span class="hljs-type"><span class="hljs-type">UInt32</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>) / streamDesc.mBytesPerFrame <span class="hljs-keyword"><span class="hljs-keyword">guard</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> buffer = <span class="hljs-type"><span class="hljs-type">AVAudioPCMBuffer</span></span>(pcmFormat: format, frameCapacity: frameCapacity) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } buffer.frameLength = buffer.frameCapacity <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> audioBuffer = buffer.audioBufferList.pointee.mBuffers withUnsafeBytes { addr <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">guard</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> baseAddress = addr.baseAddress <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } audioBuffer.mData?.copyMemory(from: baseAddress, byteCount: <span class="hljs-type"><span class="hljs-type">Int</span></span>(audioBuffer.mDataByteSize)) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buffer } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AVAudioFormat</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> common = <span class="hljs-type"><span class="hljs-type">AVAudioFormat</span></span>(commonFormat: .pcmFormatFloat32, sampleRate: <span class="hljs-number"><span class="hljs-number">44100</span></span>, channels: <span class="hljs-number"><span class="hljs-number">1</span></span>, interleaved: <span class="hljs-literal"><span class="hljs-literal">false</span></span>) }</code> </pre><br><h2>  Transfer rekaman audio dari satu perangkat ke perangkat lainnya </h2><br>  Nah, akhirnya, kita sampai pada hal yang paling penting - transfer rekaman audio dari perangkat ke perangkat menggunakan <b>MultipeerConnectivity</b> .  Untuk melakukan ini, kita perlu membuat objek <b>MCPeerID</b> (Akan menentukan perangkat kita) dan dua contoh kelas <b>MCNearbyServiceAdvertiser</b> dan <b>MCNearbyServiceBrowser</b> , yang akan digunakan untuk mencari perangkat dan agar perangkat lain dapat menemukan kita (Juga menerima permintaan koneksi dari perangkat lain).  Kami juga membuat sesi dengan bantuan yang akan kami kirimkan audio yang direkam dan "memanipulasi" perangkat kami. <br><br>  Kelas contoh untuk mengirim dan menerima data: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Constants</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> serviceType = <span class="hljs-string"><span class="hljs-string">"bn-radio"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> timeOut: <span class="hljs-type"><span class="hljs-type">Double</span></span> = <span class="hljs-number"><span class="hljs-number">10</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Connectivity</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> advertiser: <span class="hljs-type"><span class="hljs-type">MCNearbyServiceAdvertiser?</span></span> = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> browser: <span class="hljs-type"><span class="hljs-type">MCNearbyServiceBrowser?</span></span> = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> peerID: <span class="hljs-type"><span class="hljs-type">MCPeerID</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> session: <span class="hljs-type"><span class="hljs-type">MCSession</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> invitationHandler: ((<span class="hljs-type"><span class="hljs-type">Bool</span></span>, <span class="hljs-type"><span class="hljs-type">MCSession</span></span>) -&gt; <span class="hljs-type"><span class="hljs-type">Void</span></span>)? = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> onDeviceFoundedAction: ((<span class="hljs-type"><span class="hljs-type">MCPeerID</span></span>) -&gt; <span class="hljs-type"><span class="hljs-type">Void</span></span>)? <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> onDeviceLostedAction: ((<span class="hljs-type"><span class="hljs-type">MCPeerID</span></span>) -&gt; <span class="hljs-type"><span class="hljs-type">Void</span></span>)? <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> onInviteAction: ((<span class="hljs-type"><span class="hljs-type">MCPeerID</span></span>) -&gt; <span class="hljs-type"><span class="hljs-type">Void</span></span>)? <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> onConnectingAction: (() -&gt; <span class="hljs-type"><span class="hljs-type">Void</span></span>)? <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> onConnectedAction: (() -&gt; <span class="hljs-type"><span class="hljs-type">Void</span></span>)? <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> onDisconnectedAction: (() -&gt; <span class="hljs-type"><span class="hljs-type">Void</span></span>)? <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> onPacketReceivedAction: ((<span class="hljs-type"><span class="hljs-type">Data</span></span>) -&gt; <span class="hljs-type"><span class="hljs-type">Void</span></span>)? <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(deviceID: <span class="hljs-type"><span class="hljs-type">String</span></span>) { peerID = <span class="hljs-type"><span class="hljs-type">MCPeerID</span></span>(displayName: deviceID) session = <span class="hljs-type"><span class="hljs-type">MCSession</span></span>(peer: peerID, securityIdentity: <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, encryptionPreference: .<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>() session.delegate = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startHosting</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { advertiser = <span class="hljs-type"><span class="hljs-type">MCNearbyServiceAdvertiser</span></span>(peer: peerID, discoveryInfo: <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, serviceType: <span class="hljs-type"><span class="hljs-type">Constants</span></span>.serviceType) advertiser?.delegate = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> advertiser?.startAdvertisingPeer() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findHost</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { browser = <span class="hljs-type"><span class="hljs-type">MCNearbyServiceBrowser</span></span>(peer: peerID, serviceType: <span class="hljs-type"><span class="hljs-type">Constants</span></span>.serviceType) browser?.delegate = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> browser?.startBrowsingForPeers() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { advertiser?.stopAdvertisingPeer() browser?.stopBrowsingForPeers() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invite</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(peerID: MCPeerID)</span></span></span></span> { browser?.invitePeer(peerID, to: session, withContext: <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, timeout: <span class="hljs-type"><span class="hljs-type">Constants</span></span>.timeOut) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleInvitation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(isAccepted: Bool)</span></span></span></span> { invitationHandler?(isAccepted, session) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data: Data)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>? <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.session.send(data, toPeers: session.connectedPeers, with: .unreliable) } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Connectivity</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MCSessionDelegate</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">session</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> session: MCSession, peer peerID: MCPeerID, didChange state: MCSessionState)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> state { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> .connecting: onConnectingAction?() <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> .connected: onConnectedAction?() <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> .notConnected: onDisconnectedAction?() @unknown <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">debugPrint</span></span>(<span class="hljs-string"><span class="hljs-string">"Error during session state changed on: \(state)"</span></span>) } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">session</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> session: MCSession, didReceive data: Data, fromPeer peerID: MCPeerID)</span></span></span></span> { onPacketReceivedAction?(data) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">session</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> session: MCSession, didReceive stream: InputStream, withName streamName: String, fromPeer peerID: MCPeerID)</span></span></span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">session</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> session: MCSession, didStartReceivingResourceWithName resourceName: String, fromPeer peerID: MCPeerID, with progress: Progress)</span></span></span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">session</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> session: MCSession, didFinishReceivingResourceWithName resourceName: String, fromPeer peerID: MCPeerID, at localURL: URL?, withError error: Error?)</span></span></span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">session</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> session: MCSession, didReceiveCertificate certificate: [</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">Any</span></span></span></span><span class="hljs-function"><span class="hljs-params">]?, fromPeer peerID: MCPeerID, certificateHandler: @escaping </span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(Bool)</span></span></span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Void</span></span>) { certificateHandler(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Connectivity</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MCNearbyServiceAdvertiserDelegate</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">advertiser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> advertiser: MCNearbyServiceAdvertiser, didReceiveInvitationFromPeer peerID: MCPeerID, withContext context: Data?, invitationHandler: @escaping </span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(Bool, MCSession?)</span></span></span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Void</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.invitationHandler = invitationHandler onInviteAction?(peerID) } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Connectivity</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MCNearbyServiceBrowserDelegate</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">browser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> browser: MCNearbyServiceBrowser, foundPeer peerID: MCPeerID, withDiscoveryInfo info: [String : String]?)</span></span></span></span> { onDeviceFoundedAction?(peerID) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">browser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> browser: MCNearbyServiceBrowser, lostPeer peerID: MCPeerID)</span></span></span></span> { onDeviceLostedAction?(peerID) } }</code> </pre><br>  Saya memutuskan untuk tidak mengunggah semua kode aplikasi saya, karena menurut saya esensi dari cara menggunakannya sudah cukup, seperti yang ditunjukkan dalam contoh.  Saya setuju bahwa ada beberapa hal yang dapat diimplementasikan secara berbeda, tetapi saya menggunakan pendekatan yang saya butuhkan dalam kasus ini. <br><br>  Selama penggunaan <b>MultipeerConnectivity</b> , beberapa aspek negatif diidentifikasi, misalnya, jarak koneksi, oleh karena itu saya tidak menyarankan menggunakan pendekatan transfer data ini jika Anda perlu mengirimkan sesuatu yang mirip dengan audio real-time secara berkelanjutan. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id483174/">https://habr.com/ru/post/id483174/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id483160/index.html">Ruang 2020: Mars, rasi bintang satelit dan roket baru</a></li>
<li><a href="../id483166/index.html">Secara otomatis mendeteksi penyandian teks</a></li>
<li><a href="../id483168/index.html">Cara membuat bot yang mengubah foto menjadi komik. Bagian Dua Pelatihan model</a></li>
<li><a href="../id483170/index.html">Database messenger (bagian 2): kami mempartisi "untung"</a></li>
<li><a href="../id483172/index.html">Bagaimana cara Melokalkan Aplikasi atau Game? Sepuluh Sumber E-learning Gratis</a></li>
<li><a href="../id483176/index.html">Database messenger (bagian 1): kami merancang bingkai dasar</a></li>
<li><a href="../id483178/index.html">Berikut adalah Pembaruan pada Flutter 1.9 Rilis Ditambah dengan Pemrograman Dart 2.5</a></li>
<li><a href="../id483182/index.html">Lima cara menarik untuk menggunakan Array.reduce () (dan satu cara membosankan)</a></li>
<li><a href="../id483184/index.html">Pemutakhiran kode otomatis ke TensorFlow 2</a></li>
<li><a href="../id483186/index.html">Memperkenalkan Java 13: Mari selami Ke Fitur Baru JDK</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>